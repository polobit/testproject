$(function(){var a=false;if(typeof console==="undefined"||typeof console.log==="undefined"){console={};if(a){console.log=function(b){alert(b)}}else{console.log=function(){}}}});var CONTACT=[];function contactsTypeAhead(b,a){$("#"+b,a).typeahead({source:function(c,d){$.getJSON("core/api/contacts/search/"+c,function(f){if(f!=null){var e=[];if(!isArray(f.contact)){f.contact=[f.contact]}$.each(f.contact,function(h,g){var i;$.each(g.properties,function(j,k){if(k.name=="first_name"){i=k.value}if(k.name=="last_name"){i=i.concat(" "+k.value)}});CONTACT[i]=g;e.push(i)});d(e)}})},updater:function(c){var d=true;$.each($("#contact-tags",a).children("li"),function(f,e){if($(e).attr("value")==CONTACT[c].id){d=false;return}});if(d){$("#contact-tags",a).append('<li class="contact_tags label label-warning" value='+CONTACT[c].id+" >"+c+'<a class="icon-remove" id="remove_tag"></a></li>')}},minLength:2})}$("#remove_tag").die().live("click",function(a){a.preventDefault();$(this).parent().remove()});$(function(){});var TAGS=[];function agile_type_ahead(d,b,c,a){$("#"+d,b).typeahead({source:function(e,f){$.getJSON("core/api/contacts/search/"+e,function(h){var g=[];if(c&&typeof(c)==="function"){g=c(h)}$.each(h,function(i,j){tag_name=g[i];TAGS[tag_name]=j.id});f(g)})},updater:function(e){var f=true;if(a&&typeof(a)==="function"){a(TAGS[e])}$.each($(".tags",b).children("li"),function(h,g){if($(g).attr("value")==TAGS[e]){f=false;return}});if(f){$(".tags",b).append('<li class="label label-warning"  style="display: inline-block; vertical-align: middle; margin-right:3px;" value="'+TAGS[e]+'">'+e+'<a class="icon-remove" id="remove_tag"></a></li>')}},minLength:2})}$("#remove_tag").die().live("click",function(a){a.preventDefault();$(this).parent().remove()});function contacts_typeahead(c){if(c!=null){var b=[];var a=[];if(!isArray(c)){c=[c]}$.each(c,function(e,d){var f;$.each(d.properties,function(g,h){if(h.name=="first_name"){f=h.value}if(h.name=="last_name"){f=f.concat(" "+h.value)}});a[f]=d;b.push(f)});return b}}function agile_crm_update_contact(b,d){var a=App_Contacts.contactDetailView.model;var c=a.toJSON()["properties"];if(agile_crm_get_contact_property(b)){$.each(c,function(e,f){if(f.name==b){f.value=d}})}else{c.push({name:b,value:d})}a.set("properties",c);a.url="core/api/contacts";a.save()}function agile_crm_add_note(b,c){var a=this.contactDetailView.model}function agile_crm_get_contact(){return App_Contacts.contactDetailView.model.toJSON()}function agile_crm_get_contact_property(b){var a=App_Contacts.contactDetailView.model;var c=a.get("properties");var d;$.each(c,function(e,f){if(f.name==b){d=f}});if(d){return d.value}}function agile_crm_get_plugin_id(b){var a=$("#"+b).data("model");return a.get("id")}function agile_crm_get_plugin_prefs(a){return $("#"+a).data("model").toJSON().prefs}function agile_crm_save_widget_prefs(d,a){var c=$("#"+d).data("model").toJSON();c.prefs=a;var b=new Backbone.Model();b.url="core/api/widgets";b.save(c)}function agile_crm_save_widget_property(b,d){var a=App_Contacts.contactDetailView.model;var c=a.get("widget_properties");if(!c){c={}}else{c=JSON.parse(c)}c[b]=d;a.set({widget_properties:JSON.stringify(c)},{silent:true});a.url="core/api/contacts";a.save()}function agile_crm_get_widget_property(b){var a=App_Contacts.contactDetailView.model;var c=a.get("widget_properties");if(!c){return}c=JSON.parse(c);return c[b]}function agile_crm_delete_widget_property(b){var a=App_Contacts.contactDetailView.model;var c=a.get("widget_properties");if(!c){return}c=JSON.parse(c);delete c[b];a.set({widget_properties:JSON.stringify(c)},{silent:true});a.url="core/api/contacts";a.save()}var BaseModel=Backbone.Model.extend({});var BaseCollection=Backbone.Collection.extend({model:BaseModel,initialize:function(b,a){this.restKey=a.restKey;if(a.sortKey){this.sortKey=a.sortKey}},comparator:function(a){if(this.sortKey){return a.get(this.sortKey)}return a.get("id")},parse:function(a){if(a&&a[this.restKey]){return a[this.restKey]}return a}});var Base_List_View=Backbone.View.extend({events:{"click .delete":"deleteItem","click .edit":"edit"},initialize:function(){_.bindAll(this,"render","deleteItem","edit");this.model.bind("destroy",this.close,this);this.model.bind("change",this.render,this)},deleteItem:function(){this.model.destroy();this.remove()},edit:function(a){},render:function(){$(this.el).html(getTemplate(this.options.template,this.model.toJSON()));return this}});var Base_Collection_View=Backbone.View.extend({initialize:function(){_.bindAll(this,"render","appendItem");this.collection=new BaseCollection([],{restKey:this.options.restKey,sortKey:this.options.sortKey});this.collection.url=this.options.url;this.collection.bind("sync",this.appendItem);var b=this;this.collection.bind("reset",function(){b.render(true)});this.render();if(this.options.cursor){var a=this.options.max;if(!a){a=20}console.log("Inifinite Scolling started");this.infiniScroll=new Backbone.InfiniScroll(this.collection,{success:this.appendItem,eparams:{max:20}})}},appendItem:function(a){if(this.options.modelData){a.set(this.options.modelData)}var b=new Base_List_View({model:a,template:(this.options.templateKey+"-model"),tagName:this.options.individual_tag_name});$(("#"+this.options.templateKey+"-model-list"),this.el).append(b.render().el)},render:function(a){if(a==undefined){$(this.el).html(LOADING_HTML);return this}$(this.el).empty();$(this.el).html(getTemplate((this.options.templateKey+"-collection"),{}));_(this.collection.models).each(function(b){this.appendItem(b)},this);return this}});
/*!JSCore*/
var Base_Model_View=Backbone.View.extend({events:{"click .save":"save","click .delete":"deleteItem"},initialize:function(){_.bindAll(this,"render","save","deleteItem");if(this.options.data!=undefined){this.model=new Backbone.Model(this.options.data)}else{if(this.options.model){this.model=this.options.model}else{this.model=new Backbone.Model({})}}this.model.bind("change",this.render,this);if(this.options.url){this.model.url=this.options.url}if(!this.options.isNew){var a=this;this.model.fetch({success:function(b){a.render(true)}})}},deleteItem:function(a){this.model.destroy({success:function(c,b){location.reload(true)}});a.preventDefault()},save:function(g){g.preventDefault();var h=$(this.el).find("form").attr("id");var a=$("#"+h);if(!isValidForm(a)){return}this.model.clear({silent:true});var b=serializeForm(h);this.model.set(b);var f=this.options.window;var d=this.options.reload;var c=this.options.modal;this.model.save([],{success:function(i,e){if(d){location.reload(true)}else{if(f){Backbone.history.navigate(f,{trigger:true});a.each(function(){this.reset()});if(c){$(c).modal("hide")}}else{$save_info=$('<div style="display:inline-block"><small><i>Saved Successfully</i></small></div>');$(".form-actions",this.el).append($save_info);$save_info.show().delay(3000).hide(1)}}}})},render:function(a){if(!this.model.isNew()||this.options.isNew||!$.isEmptyObject(this.model.toJSON())||a){$(this.el).html(getTemplate(this.options.template,this.model.toJSON()));var b=this.options.postRenderCallback;if(b&&typeof(b)==="function"){b($(this.el))}if(this.options.isNew!=true){deserializeForm(this.model.toJSON(),$(this.el).find("form"))}}else{$(this.el).html(LOADING_HTML)}return this}});function isArray(b){return Object.prototype.toString.apply(b)==="[object Array]"}function showCalendar(){$("#calendar").fullCalendar({events:function(c,a,b){$.getJSON("/core/api/events?start="+c.getTime()/1000+"&end="+a.getTime()/1000,function(d){if(d){$.each(d,function(f,e){d[f].allDay=(d[f].allDay=="true")});b(d)}})},header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},eventClick:function(a){window.open(a.url,"gcalevent","width=700,height=600");return false},loading:function(a){if(a){$("#loading").show()}else{$("#loading").hide()}},selectable:true,selectHelper:true,editable:true,theme:false,eventClick:function(a){console.log(a);$("#newactivityModal").modal("show")},select:function(d,b,c){$("#activityModal").modal("show");var a="mm-dd-yy";$("#task-date-1").val($.datepicker.formatDate(a,d));$("#event-date-1").val($.datepicker.formatDate(a,d));$("#event-date-2").val($.datepicker.formatDate(a,b));if((d.getHours()==0)&&(b.getHours()==0)&&(b.getMinutes()==0)){$("#event-time-1").val("");$("#event-time-2").val("")}else{$("#event-time-1").val((d.getHours()<10?"0":"")+d.getHours()+":"+(d.getMinutes()<10?"0":"")+d.getMinutes());$("#event-time-2").val((b.getHours()<10?"0":"")+b.getHours()+":"+(b.getMinutes()<10?"0":"")+b.getMinutes())}},eventDrop:function(c,b,a,g,e){console.log(c);if(!confirm("Are you sure about this change?")){e();return}var f=$.extend(true,{},c);f.start=new Date(f.start).getTime()/1000;f.end=new Date(f.end).getTime()/1000;if(f.end==null||f.end==0){f.end=f.start}var d=new Backbone.Model();d.url="core/api/events";d.save(f)},eventClick:function(b){deserializeForm(b,$("#updateActivityForm"));$("#update-event-time-1").val((b.start.getHours()<10?"0":"")+b.start.getHours()+":"+(b.start.getMinutes()<10?"0":"")+b.start.getMinutes());$("#update-event-time-2").val((b.end.getHours()<10?"0":"")+b.end.getHours()+":"+(b.end.getMinutes()<10?"0":"")+b.end.getMinutes());var a="mm-dd-yy";$("#update-event-date-1").val($.datepicker.formatDate(a,b.start));$("#update-event-date-2").val($.datepicker.formatDate(a,b.end));$("#updateActivityModal").modal("show");return false}})}function setupCharts(a){head.js("lib/flot/jquery.flot.min.js","lib/flot/jquery.flot.pie.min.js",function(){if(a&&typeof(a)==="function"){a()}})}function _pie(b,a){$.plot(a,b,{series:{pie:{show:true,label:{show:true}}},legend:{show:true}})}function pieMilestones(){setupCharts(function(){var a=1543842319;$.getJSON("/core/api/opportunity/stats/milestones",{min:0,max:a},function(b){var c=[];$.each(b,function(e,d){var f={};f.label=e;f.data=d;c.push(f)});_pie(c,$("#pie-deals-chart"))})})}function pieDetails(){setupCharts(function(){var a=1543842319;$.getJSON("/core/api/opportunity/stats/details",{min:0,max:a},function(d){var c={};c.data=[];var b={};b.data=[];$.each(d,function(g,f){c.data.push([g*1000,f.total]);b.data.push([g*1000,f.pipeline])});var e=[];e.push(c);e.push(b);e=[{label:"Total",data:c.data,bars:{show:true,barWidth:1000000000,align:"center"}},{label:"Pipeline (Total * Probability)",data:b.data,bars:{show:true,barWidth:1000000000,align:"center"},grid:{hoverable:true,clickable:true}}];$.plot($("#total-pipeline-chart"),e,{xaxis:{mode:"time",timeformat:"%b %y"}})})})}function pieTags(){setupCharts(function(){$.getJSON("/core/api/tags/stats",function(a){var b=[];$.each(a,function(d,c){var e={};e.label=d;e.data=c;b.push(e)});_pie(b,$("#pie-tags-chart"))})})}$(function(){$("#contact-add-task").live("click",function(b){b.preventDefault();highlightTask();var a=$("#taskForm");fillRelation(a);$("#activityModal").modal("show")});$("#contact-add-note").live("click",function(b){b.preventDefault();var a=$("#noteForm");fillRelation(a);$("#noteModal").modal("show")})});function fillRelation(c){var a=App_Contacts.contactDetailView.model.toJSON();var b=a.properties[0].value+" "+a.properties[1].value;$(".tags",c).html('<li class="label label-warning"  style="display: inline-block; vertical-align: middle; margin-right:3px;" value="'+a.id+'">'+b+"</li>")}$(function(){var a;$('#contactDetailsTab a[href="#notes"]').live("click",function(c){c.preventDefault();a=App_Contacts.contactDetailView.model.id;var b=new Base_Collection_View({url:"/core/api/contacts/"+a+"/notes",restKey:"note",templateKey:"notes",individual_tag_name:"tr"});b.collection.fetch();$("#notes",this.el).html(b.el)});$('#contactDetailsTab a[href="#deals"]').live("click",function(c){c.preventDefault();a=App_Contacts.contactDetailView.model.id;var b=new Base_Collection_View({url:"core/api/contacts/"+a+"/deals",restKey:"opportunity",templateKey:"deals",individual_tag_name:"tr"});b.collection.fetch();$("#deals",this.el).html(b.el)});$('#contactDetailsTab a[href="#events"]').live("click",function(c){c.preventDefault();var b=new Base_Collection_View({url:"core/api/events",restKey:"events",templateKey:"events",individual_tag_name:"tr"});b.collection.fetch();$("#events",this.el).html(b.el)});$('#contactDetailsTab a[href="#mail"]').live("click",function(c){c.preventDefault();var b=new Base_Collection_View({url:"core/api/email?e="+encodeURIComponent("manohar@invox.com")+"&c=10&o=0",templateKey:"email-social",individual_tag_name:"tr"});b.collection.fetch();$("#mail",this.el).html(b.el)});$('#contactDetailsTab a[href="#activities"]').live("click",function(c){c.preventDefault();var b=new Base_Collection_View({url:"core/api/stats?e="+encodeURIComponent("sam@invox.com"),templateKey:"stats",individual_tag_name:"tr"});b.collection.fetch();$("#activities",this.el).html(b.el)});$('#contactDetailsTab a[href="#campaigns"]').live("click",function(d){d.preventDefault();var c=new Base_Collection_View({url:"/core/api/campaigns/logs/contact/"+App_Contacts.contactDetailView.model.id,restKey:"logs",templateKey:"campaigns",individual_tag_name:"tr"});c.collection.fetch();$("#campaigns",this.el).html(c.el);var b="<option value='{{id}}'>{{name}}</option>";fillSelect("campaignSelect","/core/api/workflows","workflow","no-callback ",b)});$(".emailSelect").die().live("change",function(d){d.preventDefault();var f=$(".emailSelect option:selected").attr("value");var b=Backbone.Model.extend({url:"/core/api/email/templates/"+f,restKey:"emailTemplates"});var c=new b();c.fetch({success:function(k){var g=k.toJSON();var e=App_Contacts.contactDetailView.model;var i=e.toJSON();console.log(i);console.log(g);var i=getPropertyJSON(i);var j=Handlebars.compile(g.subject);var h=j(i);j=Handlebars.compile(g.text);var l=j(i);$("#emailForm").find('input[name="subject"]').val(h);$("#emailForm").find('textarea[name="body"]').val(l)}})});$("#sendEmail").die().live("click",function(d){d.preventDefault();var c=serializeForm("emailForm");var b="core/api/send-email?from="+encodeURIComponent(c.from)+"&to="+encodeURIComponent(c.to)+"&subject="+encodeURIComponent(c.subject)+"&body="+encodeURIComponent(c.body);$.post(b)});$("#helpEmail").die().live("click",function(d){d.preventDefault();var c=serializeForm("helpemailForm");var b="core/api/send-email?from="+encodeURIComponent(c.from)+"&to="+encodeURIComponent(c.to)+"&subject="+encodeURIComponent(c.subject)+"&body="+encodeURIComponent(c.body);$.post(b)});$("#campaignSelect").die().live("change",function(f){f.preventDefault();var c=$("#campaignSelect option:selected").attr("value");var d=App_Contacts.contactDetailView.model.id;var b="/core/api/campaigns/enroll/"+d+"/"+c;$.get(b,function(e){$(".enroll-success").html('<div class="alert alert-success"><a class="close" data-dismiss="alert" href="#">�</a>Enrolled successfully.</div>')})})});function getPropertyJSON(c){var b=c.properties;var a={};$.each(b,function(d,e){a[this.name]=this.value});return a}$(function(){$("#contact-actions-delete").live("click",function(a){a.preventDefault();App_Contacts.contactDetailView.model.url="core/api/contacts/"+App_Contacts.contactDetailView.model.id;App_Contacts.contactDetailView.model.destroy({success:function(c,b){Backbone.history.navigate("contacts",{trigger:true})}})})});function contactTableView(a){var d=new Base_List_View({model:a,template:"contacts-custom-view-model",tagName:this.options.individual_tag_name});var c=this.options.modelData;var e=c.fields_set;var b=a.toJSON();$("#contacts-custom-view-model-template").empty();$.each(e,function(f,g){$("#contacts-custom-view-model-template").append(getTemplate("contacts-custom-view-"+g,b))});$(("#contacts-custom-view-model-list"),this.el).append(d.render().el)}function setupViews(a){App_Contacts.customView=new Base_Collection_View({url:"core/api/contact-view",restKey:"contactView",templateKey:"contact-view",individual_tag_name:"li",id:"view-list"});App_Contacts.customView.collection.fetch({success:function(){$("#view-list",a).html(App_Contacts.customView.el)}})}$(function(){$(".ContactView").die().live("click",function(b){b.preventDefault();var c=$(this).attr("id");App_Contacts.contactViewModel=App_Contacts.customView.collection.get(c).toJSON();var a=new Base_Collection_View({url:"/core/api/contacts",restKey:"contact",modelData:App_Contacts.contactViewModel,templateKey:"contacts-custom-view",individual_tag_name:"tr"});a.appendItem=contactTableView;a.collection.fetch({success:function(){setupViews(a.el);setupTags(a.el);$("#content").html(a.el)}})})});$(function(){$("#contact-custom-view-model-list > tr").live("click",function(b){b.preventDefault();var a=$(this).find(".view").attr("view");if(a){Backbone.history.navigate("contact-custom-view-edit/"+a,{trigger:true})}})});$(function(){$("i.filter-contacts-multiple-add").die().live("click",function(a){var b=$(this).closest("tr").clone();$(b).find("i.filter-contacts-multiple-remove").css("display","block");$(this).parents("tbody").append(b)});$("i.filter-contacts-multiple-remove").die().live("click",function(a){$(this).closest("tr").remove()})});$(function(){$("#contacts-model-list > tr").live("click",function(b){b.preventDefault();var a=$(this).find(".data").attr("data");console.log(a);if(a){Backbone.history.navigate("contact/"+a,{trigger:true})}});$("#contacts-custom-view-model-list > tr").live("click",function(b){b.preventDefault();var a=$(this).find(".data").attr("data");console.log(a);if(a){Backbone.history.navigate("contact/"+a,{trigger:true})}})});function delete_contact_property(a,b){}function serializeAndSaveContinueContact(g,j,c){g.preventDefault();var m=$("#"+j);if(!isValidForm(m)){return}var h=[];var b=$("#"+j+" input[name=id]").val();var f={};var h=[];h.push(propertyJSON("first_name","fname"));h.push(propertyJSON("last_name","lname"));if(isValidField("organization")){h.push(propertyJSON("company","company"))}if(isValidField("job")){h.push(propertyJSON("title","title"))}if(isValidField("company")){h.push(propertyJSON("company","company"))}if(isValidField("email")){h.push(propertyJSON("email","email"))}if(isValidField("title")){h.push(propertyJSON("title","title"))}$("#"+j+" div.multiple-template").each(function(i,n){var o=$(n).find("input");var e=$(n).find("select");if(!$(n).find("input").parents("div.controls").hasClass("hide")){h.push({name:$(n).attr("data"),value:o.val(),subtype:e.val()})}});var l=[];l.push({name:"properties",value:h});for(var d=0;d<l.length;++d){f[l[d].name]=l[d].value}if(b!=null){f.id=b}var k=getTags("tags-new-person");if(k!=undefined){f.tags=k}var a=new Backbone.Model();a.url="core/api/contacts";a.save(f,{success:function(e){if(c){$("#personModal").modal("hide");deserializeContact(e.toJSON())}else{$("#personModal").modal("hide");App_Contacts.navigate("contact/"+e.id,{trigger:true})}$("#"+j).each(function(){this.reset()})},error:function(i,e){$("#personModal").find(".duplicate-email").html('<div class="alert alert-error" style="display:none"><a class="close" data-dismiss="alert" href="#">�</a>Please change email. A contact already exists with this email.</div>');$("#personModal").find(".alert").show()}});return f}function deserializeContact(a){var b=$("#content").html(getTemplate("continue-contact",a));$.each(a.properties,function(d,e){$($("#"+b.attr("id")+" div.multiple-template."+e.name).closest("div.controls.second")).remove();var c=$("#"+b.attr("id")+" div.multiple-template."+e.name);fillMultiOptions(c,e)})}function fillMultiOptions(a,b){var d=$(a).parents("div.control-group");var c=d.children().siblings("div.controls:first").clone().removeClass("hide");$(c).find("input").val(b.value).attr("name",b.value);$(c).find("select").val(b.subtype);c.appendTo(d)}function propertyJSON(a,d,c){var b={};if(c==undefined){b.type="SYSTEM"}else{b.type=c}b.name=a;b.value=$("#"+d).val();return b}$(function(){$("i.multiple-add").die().live("click",function(a){$(this).parents("div.control-group").append($(this).parents().siblings("div.controls:first").clone().removeClass("hide"))});$("i.multiple-remove").live("click",function(a){$(this).closest("div.multiple-template").remove()});$("#continue-contact").click(function(b){var a=serializeAndSaveContinueContact(b,"personForm",true)});$("#update").die().live("click",function(a){serializeAndSaveContinueContact(a,"continueform")});$("#continue-company").click(function(a){$("#companyModal").modal("hide");alert("test");App_Contacts.navigate("continue-company",{trigger:true})})});$(function(){$(".fieldmodal").die().live("click",function(a){a.preventDefault();var b=$(this).attr("id");var c=new Base_Model_View({url:"/core/api/custom-fields",template:"custom-field-"+b+"-modal",window:"custom-fields",modal:"#"+b+"Modal",isNew:true,postRenderCallback:function(d){$("#"+b+"Modal",d).modal("show")}});$("#custom-field-modal").html(c.render().el)})});$(function(){$("#show-activity").live("click",function(a){a.preventDefault();highlightEvent();$("#activityModal").modal("show")});$("#task_event_validate").die().live("click",function(c){c.preventDefault();if($("#hiddentask").val()=="task"){if(!isValidForm("#taskForm")){return false}var b=serializeForm("taskForm");b.due=new Date(b.due).getTime()/1000;$("#taskForm").each(function(){this.reset()});$("#activityModal").modal("hide");var a=new Backbone.Model();a.url="core/api/tasks";a.save(b)}else{saveEvent("activityForm","activityModal")}});$("#update_event_validate").die().live("click",function(a){a.preventDefault();saveEvent("updateActivityForm","updateActivityModal")});$("#task-date-1").datepicker({format:"mm-dd-yyyy"});$("#event-date-1").datepicker({format:"mm-dd-yyyy"});$("#event-date-2").datepicker({format:"mm-dd-yyyy"});$("#update-event-date-1").datepicker({format:"mm-dd-yyyy"});$("#update-event-date-2").datepicker({format:"mm-dd-yyyy"});$(".timepicker").timepicker({defaultTime:"current",showMeridian:false,template:"modal"});$("#activityModal").on("show",function(){$(".timepicker").val(getHHMM())});$("#task").click(function(b){highlightTask();var a=$("#taskForm");agile_type_ahead("task_related_to",a,contacts_typeahead)});$("#event").click(function(a){highlightEvent()});$(".tasks-select").live("change",function(){if($(this).is(":checked")){var a=$(this).attr("data");completeTask(a,$(this))}});$("#activityModal").on("hide",function(){$("#taskForm").find("li").remove()})});function highlightTask(){$("#hiddentask").val("task");$("#task").css("color","black");$("#event").css("color","#DD4814");$("#relatedEvent").css("display","none");$("#relatedTask").css("display","block")}function highlightEvent(){$("#hiddentask").val("event");$("#event").css("color","black");$("#task").css("color","#DD4814");$("#relatedTask").css("display","none");$("#relatedEvent").css("display","block")}function isValidRange(a,b){if(a<=b){return true}else{return false}}function saveEvent(f,c,d){if(!isValidForm("#"+f)){return false}var a=serializeForm(f);var g=(a.start_time).split(":");a.start=new Date(a.start).setHours(g[0],g[1])/1000;var e=(a.end_time).split(":");a.end=new Date(a.end).setHours(e[0],e[1])/1000;if(!isValidRange(a.start,a.end)){return}$("#"+c).modal("hide");$("#"+f).each(function(){this.reset()});delete a.start_time;delete a.end_time;var b=new Backbone.Model();b.url="core/api/events";b.save(a,{success:function(){$("#calendar").fullCalendar("refetchEvents")}})}function getHHMM(){var a=new Date().getHours();var b=new Date().getMinutes();if(b%15!=0){b=b-(b%15)}if(a<10){a="0"+a}if(b<10){b="0"+b}return a+":"+b}function serializeForm(b){var a=$("#"+b).serializeArray(),d={};a=a.concat($("#"+b+" input[type=checkbox]:not(:checked)").map(function(){return{name:this.name,value:false}}).get());a=a.concat($("#"+b+" input[type=date_input]").map(function(){return{name:this.name,value:new Date(this.value).getTime()/1000}}).get());a=a.concat($("#"+b+" .tags").map(function(){var e=[];if(!isArray($(this).children())){}$.each($(this).children(),function(f,g){e.push(($(g).val()).toString())});return{name:$(this).attr("name"),value:e}}).get());a=a.concat($("#"+b+" .multiSelect").map(function(){var e=[];$.each($(this).children("li"),function(f,g){e.push(($(g).attr("ms-value")))});return{name:$(this).attr("name"),value:e}}).get());for(var c=0;c<a.length;++c){d[a[c].name]=a[c].value}return d}function deserializeForm(b,a){$.each(b,function(e,g){var d=a.find('*[name="'+e+'"]'),f="",c="";if(d.length>0){c=d[0].tagName.toLowerCase();if(c=="select"||c=="textarea"){$(d).val(g)}else{if(c=="input"){f=$(d[0]).attr("type");if(f=="text"||f=="password"||f=="hidden"){d.val(g)}else{if(f=="checkbox"){if(g){if(g==true){d.attr("checked","checked")}d.val("true")}}else{if(f=="radio"){d.filter('[value="'+g+'"]').attr("checked","checked")}}}}else{if(d.hasClass("tags")&&c=="ul"){if(!isArray(g)){g=[g]}$.each(g,function(i,h){var k;var j=h.id;k=getPropertyValue(h.properties,"first_name")+getPropertyValue(h.properties,"last_name");$("."+d.attr("class"),a).append('<li class="label label-warning" value="'+j+'" style="display: inline-block; vertical-align: middle; margin-right:3px; ">'+k+'<a class="icon-remove" id="remove_tag"></a></li>')})}else{if(d.hasClass("multiSelect")&&c=="ul"){$.each(g,function(h,i){$("#multipleSelect",a).multiSelect("select",i)})}}}}}})}function isValidForm(a){console.log($(a).html());console.log("Validating form");$(a).validate({debug:true,errorElement:"span",errorClass:"help-inline",highlight:function(c,b){$(c).closest(".control-group").addClass("error")},unhighlight:function(c,b){$(c).closest(".control-group").removeClass("error")},invalidHandler:function(c,b){var d=b.numberOfInvalids()}});return $(a).valid()}function getTemplate(b,c,a){var e=$("#"+b+"-template").html();if(e){var d=Handlebars.compile(e);return d(c)}if(a=="no"){console.log("Not found "+b);return}var f="";if(b.indexOf("settings")==0){f=downloadSynchronously("tpl/min/settings.js")}if(b.indexOf("admin-settings")==0){f=downloadSynchronously("tpl/min/admin-settings.js")}if(b.indexOf("continue")==0){f=downloadSynchronously("tpl/min/continue.js")}if(f){$("body").append($(f))}return getTemplate(b,c,"no")}function downloadSynchronously(b){var a;jQuery.ajax({url:b,dataType:"html",success:function(c){a=c},async:false});return a}function getPropertyValue(b,c){if(b==undefined){return}for(var d=0,a=b.length;d<a;d++){if(b[d].name==c){return b[d].value}}}function ucfirst(a){return(a&&typeof a==="string")?(a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()):""}$(function(){Handlebars.registerHelper("getPropertyValue",function(a,b){return getPropertyValue(a,b)});Handlebars.registerHelper("urlEncode",function(b,c,e){var a="&";if(b.indexOf("?")!=-1){a="&"}var d=b+a+c+"="+escape(JSON.stringify(e));return d});Handlebars.registerHelper("gravatarurl",function(b,d){if(b==undefined){return}var e=getPropertyValue(b,"image");if(e){return e}var a="https://contactuswidget.appspot.com/images/pic.png";var c=getPropertyValue(b,"email");if(c){return"https://secure.gravatar.com/avatar/"+MD5(c)+".jpg?s="+d+"&d="+escape(a)}return a});Handlebars.registerHelper("icons",function(a){if(a=="email"){return"icon-envelope"}if(a=="phone"){return"icon-headphones"}if(a=="url"){return"icon-home"}});Handlebars.registerHelper("eachkeys",function(d,c){var e=c.fn,a=c.inverse;var b="";var f=true;for(key in d){f=false;break}if(!f){for(key in d){b=b+e({key:key,value:d[key]})}}else{b=a(this)}return b});Handlebars.registerHelper("ucfirst",function(a){return(a&&typeof a==="string")?(a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()):""});Handlebars.registerHelper("tagslist",function(j){var h={};for(var d=0,c=j.length;d<c;d++){var k=j[d].tag;var b=k.charAt(0);var f=new Array();if(h[b]!=undefined){f=h[b]}f.push(k);h[b]=f}var e="";for(var g in h){var f=h[g];e+="<div class='tag-element'><div class='tag-key'>"+g.toUpperCase()+"</div> ";e+="<div class='tag-values'>";for(var d=0,c=f.length;d<c;d++){var a="#tags/"+f[d];e+=("<a href="+a+" >"+f[d]+"</a> ")}e+="</div></div>"}return e});Handlebars.registerHelper("epochToHumanDate",function(b,a){var c=new Date(parseInt(a));return c.toLocaleDateString()});Handlebars.registerHelper("epochToTaskDate",function(a){var c=new Date(parseInt(a)*1000).getMonth();var d=new Date(parseInt(a)*1000).getDate();var b=["","Jan","Feb","March","April","May","July","Aug","Sept","Oct","Nov","Dec"];return(b[c]+" "+d)});Handlebars.registerHelper("calculatePipeline",function(b,c){var a=parseInt(b)*parseInt(c)/100;return a});Handlebars.registerHelper("getRequiredLog",function(d,c){var a=JSON.parse(d);if(c=="t"){var b=new Date(a[0][c]);return b}return a[0][c]});Handlebars.registerHelper("contactTableHeadings",function(b){var a="";$.each(App_Contacts.contactViewModel[b],function(c,d){d=d.replace("_"," ");a=a.concat("<th>"+ucfirst(d)+"</th>")});return new Handlebars.SafeString(a)})});$(function(){$("#import-contacts").die().live("click",function(c){var f=[];$(".fname-not-found-error").hide();$(".lname-not-found-error").hide();$(".fname-duplicate-error").hide();$(".lname-duplicate-error").hide();var d=$(".import-select").filter(function(){return $(this).val()=="first_name"});var b=$(".import-select").filter(function(){return $(this).val()=="last_name"});if(d.length==0){$(".fname-not-found-error").show();return false}else{if(b.length==0){$(".lname-not-found-error").show();return false}else{if(d.length>1){$(".fname-duplicate-error").show();return false}else{if(b.length>1){$(".lname-duplicate-error").show();return false}}}}$("#import-tbody tr").each(function(){var h=[];$(this).find("td").each(function(k){var n={};var j=$(this).parents("table").find("th").eq(k).find("select").val();console.log($(this));console.log("Name is "+j);if(j.indexOf("-")!=-1){var o=j.split("-");j=o[1];var l=o[0];n.sub_type=l}var m=$(this).html();n.value=m;n.name=j;h.push(n)});var g={};g.properties=h;g.type="PERSON";g.first_name="uploaded";g.last_name="uploaded";var e=getTags("tags-import");if(e!=undefined){g.tags=e}f.push(g)});var a={};a.contact=f;$.ajax({type:"POST",url:"/core/api/contacts/upload",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",success:function(e){App_Contacts.contactsListView.collection.add(e.contact)},dataType:"json"})})});function fileUploadInit(){var a=new qq.FileUploader({element:document.getElementById("file-upload-div"),action:"/core/api/contacts/upload",debug:true,onComplete:function(d,c,b){console.log(b);$("#content").html(getTemplate("import-contacts-2",b));setupTagsTypeAhead()}})}var MD5=function(s){function L(b,a){return(b<<a)|(b>>>(32-a))}function K(k,b){var F,a,d,x,c;d=(k&2147483648);x=(b&2147483648);F=(k&1073741824);a=(b&1073741824);c=(k&1073741823)+(b&1073741823);if(F&a){return(c^2147483648^d^x)}if(F|a){if(c&1073741824){return(c^3221225472^d^x)}else{return(c^1073741824^d^x)}}else{return(c^d^x)}}function r(a,c,b){return(a&c)|((~a)&b)}function q(a,c,b){return(a&b)|(c&(~b))}function p(a,c,b){return(a^c^b)}function n(a,c,b){return(c^(a|(~b)))}function u(G,F,aa,Z,k,H,I){G=K(G,K(K(r(F,aa,Z),k),I));return K(L(G,H),F)}function f(G,F,aa,Z,k,H,I){G=K(G,K(K(q(F,aa,Z),k),I));return K(L(G,H),F)}function D(G,F,aa,Z,k,H,I){G=K(G,K(K(p(F,aa,Z),k),I));return K(L(G,H),F)}function t(G,F,aa,Z,k,H,I){G=K(G,K(K(n(F,aa,Z),k),I));return K(L(G,H),F)}function e(k){var G;var d=k.length;var c=d+8;var b=(c-(c%64))/64;var F=(b+1)*16;var H=Array(F-1);var a=0;var x=0;while(x<d){G=(x-(x%4))/4;a=(x%4)*8;H[G]=(H[G]|(k.charCodeAt(x)<<a));x++}G=(x-(x%4))/4;a=(x%4)*8;H[G]=H[G]|(128<<a);H[F-2]=d<<3;H[F-1]=d>>>29;return H}function B(c){var b="",d="",k,a;for(a=0;a<=3;a++){k=(c>>>(a*8))&255;d="0"+k.toString(16);b=b+d.substr(d.length-2,2)}return b}function J(b){b=b.replace(/\r\n/g,"\n");var a="";for(var k=0;k<b.length;k++){var d=b.charCodeAt(k);if(d<128){a+=String.fromCharCode(d)}else{if((d>127)&&(d<2048)){a+=String.fromCharCode((d>>6)|192);a+=String.fromCharCode((d&63)|128)}else{a+=String.fromCharCode((d>>12)|224);a+=String.fromCharCode(((d>>6)&63)|128);a+=String.fromCharCode((d&63)|128)}}}return a}var C=Array();var P,h,E,v,g,Y,X,W,V;var S=7,Q=12,N=17,M=22;var A=5,z=9,y=14,w=20;var o=4,m=11,l=16,j=23;var U=6,T=10,R=15,O=21;s=J(s);C=e(s);Y=1732584193;X=4023233417;W=2562383102;V=271733878;for(P=0;P<C.length;P+=16){h=Y;E=X;v=W;g=V;Y=u(Y,X,W,V,C[P+0],S,3614090360);V=u(V,Y,X,W,C[P+1],Q,3905402710);W=u(W,V,Y,X,C[P+2],N,606105819);X=u(X,W,V,Y,C[P+3],M,3250441966);Y=u(Y,X,W,V,C[P+4],S,4118548399);V=u(V,Y,X,W,C[P+5],Q,1200080426);W=u(W,V,Y,X,C[P+6],N,2821735955);X=u(X,W,V,Y,C[P+7],M,4249261313);Y=u(Y,X,W,V,C[P+8],S,1770035416);V=u(V,Y,X,W,C[P+9],Q,2336552879);W=u(W,V,Y,X,C[P+10],N,4294925233);X=u(X,W,V,Y,C[P+11],M,2304563134);Y=u(Y,X,W,V,C[P+12],S,1804603682);V=u(V,Y,X,W,C[P+13],Q,4254626195);W=u(W,V,Y,X,C[P+14],N,2792965006);X=u(X,W,V,Y,C[P+15],M,1236535329);Y=f(Y,X,W,V,C[P+1],A,4129170786);V=f(V,Y,X,W,C[P+6],z,3225465664);W=f(W,V,Y,X,C[P+11],y,643717713);X=f(X,W,V,Y,C[P+0],w,3921069994);Y=f(Y,X,W,V,C[P+5],A,3593408605);V=f(V,Y,X,W,C[P+10],z,38016083);W=f(W,V,Y,X,C[P+15],y,3634488961);X=f(X,W,V,Y,C[P+4],w,3889429448);Y=f(Y,X,W,V,C[P+9],A,568446438);V=f(V,Y,X,W,C[P+14],z,3275163606);W=f(W,V,Y,X,C[P+3],y,4107603335);X=f(X,W,V,Y,C[P+8],w,1163531501);Y=f(Y,X,W,V,C[P+13],A,2850285829);V=f(V,Y,X,W,C[P+2],z,4243563512);W=f(W,V,Y,X,C[P+7],y,1735328473);X=f(X,W,V,Y,C[P+12],w,2368359562);Y=D(Y,X,W,V,C[P+5],o,4294588738);V=D(V,Y,X,W,C[P+8],m,2272392833);W=D(W,V,Y,X,C[P+11],l,1839030562);X=D(X,W,V,Y,C[P+14],j,4259657740);Y=D(Y,X,W,V,C[P+1],o,2763975236);V=D(V,Y,X,W,C[P+4],m,1272893353);W=D(W,V,Y,X,C[P+7],l,4139469664);X=D(X,W,V,Y,C[P+10],j,3200236656);Y=D(Y,X,W,V,C[P+13],o,681279174);V=D(V,Y,X,W,C[P+0],m,3936430074);W=D(W,V,Y,X,C[P+3],l,3572445317);X=D(X,W,V,Y,C[P+6],j,76029189);Y=D(Y,X,W,V,C[P+9],o,3654602809);V=D(V,Y,X,W,C[P+12],m,3873151461);W=D(W,V,Y,X,C[P+15],l,530742520);X=D(X,W,V,Y,C[P+2],j,3299628645);Y=t(Y,X,W,V,C[P+0],U,4096336452);V=t(V,Y,X,W,C[P+7],T,1126891415);W=t(W,V,Y,X,C[P+14],R,2878612391);X=t(X,W,V,Y,C[P+5],O,4237533241);Y=t(Y,X,W,V,C[P+12],U,1700485571);V=t(V,Y,X,W,C[P+3],T,2399980690);W=t(W,V,Y,X,C[P+10],R,4293915773);X=t(X,W,V,Y,C[P+1],O,2240044497);Y=t(Y,X,W,V,C[P+8],U,1873313359);V=t(V,Y,X,W,C[P+15],T,4264355552);W=t(W,V,Y,X,C[P+6],R,2734768916);X=t(X,W,V,Y,C[P+13],O,1309151649);Y=t(Y,X,W,V,C[P+4],U,4149444226);V=t(V,Y,X,W,C[P+11],T,3174756917);W=t(W,V,Y,X,C[P+2],R,718787259);X=t(X,W,V,Y,C[P+9],O,3951481745);Y=K(Y,h);X=K(X,E);W=K(W,v);V=K(V,g)}var i=B(Y)+B(X)+B(W)+B(V);return i.toLowerCase()};$(function(){$("#person_validate").live("click",function(a){if(!isValidForm("#personForm")){return false}serializeAndSaveContinueContact(a,"personForm")});$("#import-link").live("click",function(a){Backbone.history.navigate("import",{trigger:true})})});$(function(){$("#note_validate").live("click",function(b){b.preventDefault();$("#noteModal").modal("hide");var a=serializeForm("noteForm");$("#noteForm").each(function(){this.reset()});var c=new Backbone.Model();c.url="core/api/notes";c.save(a)});$("#show-note").live("click",function(b){$("#noteModal").modal("show");var a=$("#noteForm");agile_type_ahead("note_related_to",a,contacts_typeahead)})});var notification_prefs;var socket;function downloadAndRegisterForNotifications(){var b=Backbone.Model.extend({url:"core/api/notifications"});var a=new b();a.fetch({success:function(c){notification_prefs=c.toJSON();console.log(notification_prefs);registerForNotifications(notification_prefs)}})}function registerForNotifications(a){if(!a.contact_any_browsing||!a.contact_assigned_browsing||!a.contact_assigned_starred_browsing){}registerForSockets()}function registerForSockets(){var a="https";head.js(a+"://stats.agilecrm.com:443/socket.io/socket.io.js",function(){var c=Backbone.Model.extend({url:"core/api/api-key"});var b=new c();b.fetch({success:function(e){var d=e.get("api_key");_setupSockets(d)}})})}function _setupSockets(b){console.log("Connecting "+b);var a=b;socket=io.connect("https://stats.agilecrm.com:443");socket.on("connect",function(){console.log("socket connected");socket.emit("subscribe",{agile_id:a})});socket.on("browsing",function(d){console.log("browsing");console.log(d);var c="manohar@invox.com"})}function fetchContactAndNotify(c){var a=Backbone.Model.extend({url:function(){return"/core/api/contacts/search/email/"+encodeURIComponent(c)}});var b=new a();b.fetch({success:function(e){console.log(e);console.log(e.toJSON());var f=e.id;if(!f){return}var d=getTemplate("notify-html",e.toJSON());notify("success1",d,"bottom-right",true)}})}function _cancelSockets(){socket.disconnect()}function notify(c,d,a,b){head.js("lib/bootstrap-notifications-min.js",function(){$("."+a).notify({type:c,message:{html:d},closable:b,fadeOut:{enabled:true,delay:10000000},transition:"fade"}).show()})}$(function(){});$(function(){$("#opportunities-model-list > tr").live("click",function(b){b.preventDefault();var a=$(this).find(".leads").attr("leads");if(a){Backbone.history.navigate("deals/"+a,{trigger:true})}})});function populateUsers(c,a){var b=new Base_Collection_View({url:"/core/api/deal-owners",restKey:"userPrefs",templateKey:"owners",individual_tag_name:"option"});b.collection.fetch();$("#owner",a).html(b.el);return a}$("#editOpportunity").live("click",function(b){b.preventDefault();var a=new Base_Model_View({url:"core/api/opportunity",model:App_Deals.opportunityCollectionView.currentDeal,template:"opportunity-add",window:"deals",postRenderCallback:function(c){console.log(c);populateUsers("owner",c);populateMilestones(c);agile_type_ahead("relates_to",c,contacts_typeahead);$("#close_date",c).datepicker({format:"mm-dd-yyyy"})},});var a=a.render();$("#content").html(a.el)});function populateMilestones(c,d){var b=Backbone.Model.extend({url:"/core/api/milestone"});var a=new b();a.fetch({success:function(g){var e=g.toJSON();var f=e.milestones;var h=[];$.each(f.split(","),function(){h.push($.trim(this))});if(d){fillMilestones("move",h);return}fillTokenizedSelect("milestone",h)}})}$("#move li a").live("click",function(b){b.preventDefault();var a=App_Deals.opportunityCollectionView.currentDeal;a.set("milestone",this.id);a.url="core/api/opportunity";a.save();App_Deals.opportunityCollectionView.collection.add(a)});$(function(){agile_type_ahead("searchText",undefined,contacts_typeahead,function(a){App_Contacts.navigate("contact/"+a,{trigger:true})})});var SocialSearchCollection=Backbone.Collection.extend({parse:function(a){if(a&&a.socialSearchResult){return a.socialSearchResult}}});var SocialSearchesListView=Backbone.View.extend({template:"social-search",tagName:"li",initialize:function(){_.bindAll(this,"render","appendItem");this.collection=new SocialSearchCollection();this.collection.bind("sync",this.appendItem);this.collection.bind("reset",this.render)},appendItem:function(b){var a=new Note_List_View({model:b});$("#noteslist",this.el).append(a.render().el)},render:function(){$(this.el).empty();console.log(this.collection.toJSON());$(this.el).html(getTemplate(this.template,this.collection.toJSON()));if(localStorage&&JSON&&localStorage.getItem(this.key)==null&&this.collection.length!=0){localStorage.setItem(this.key,JSON.stringify(this.collection.toJSON()))}return this}});function setupTagsTypeAhead(b){var a=[];_(b).each(function(d){var c=d.get("tag");if($.inArray(c,a)==-1){a.push(c)}});$(".tags-typeahead").typeahead({source:a})}function setupTags(b){var c=Backbone.Collection.extend({url:"/core/api/tags",sortKey:"tag"});var a=new c();a.fetch({success:function(){var e=getTemplate("tagslist",a.toJSON());var d=$("#tagslist",b).length;$("#tagslist",b).html(e);setupTagsTypeAhead(a.models)}})}function getTags(b){if(isValidField(b)){var a=$("#"+b).val();a=a.replace(/ +(?= )/g,"");a=a.replace(", "," ");a=a.replace(","," ");return a.split(" ")}}$(function(){$(".tasks-select").live("change",function(){if($(this).is(":checked")){var a=$(this).attr("data");completeTask(a,$(this))}})});function getDue(b){var a=new Date();a.setHours(0,0,0,0);a=a.getTime()/1000;return Math.floor((b-a)/(24*3600))}function appendTasks(a){var b=new Base_List_View({model:a,view:"inline",template:"tasks-model",});var c=getDue(a.get("due"));if(c<0){$("#overdue",this.el).append(b.render().el);$("#overdue",this.el).show()}if(c==0){$("#today",this.el).append(b.render().el);$("#today",this.el).show()}if(c==1){$("#tomorrow",this.el).append(b.render().el);$("#tomorrow",this.el).show()}if(c>1){$("#next-week",this.el).append(b.render().el);$("#next-week",this.el).show()}}function completeTask(b,c){console.log("Deleting Task "+b);var d=App_Calendar.tasksListView.collection;var a=d.get(b);a.set("is_complete",true);a.url="/core/api/tasks";a.save({success:function(f,e){c.closest(".task-individual").slideUp("slow")}})}$(function(){$(".upload_s3").live("click",function(a){a.preventDefault();uploadImage("account_prefs")})});function uploadImage(b){var a=window.open("upload.jsp?id="+b,"name","height=310,width=500");if(window.focus){a.focus()}return false}function setImageURL(a){var b="account_prefs";$("#"+b).find(".imgholder").html("");$("#"+b).find(".imgholder").html('<img src="'+a+'" height="100" width="100"/>');$("#"+b+"_url").attr("value",a)}var LOADING_HTML='<img class="loading" style="padding-right:5px" src= "img/21-0.gif"></img>';function getUrlVars(){var d=[],c;var a=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");for(var b=0;b<a.length;b++){c=a[b].split("=");d.push(c[0]);d[c[0]]=c[1]}return d}function fillSelect(d,c,b,g,e){var a=Backbone.Collection.extend({url:c,parse:function(h){if(h&&h[b]){return h[b]}return h}});$loading=$(LOADING_HTML);$("#"+d).after($loading);var f=new a();f.fetch({success:function(){console.log(f.models);console.log(f.toJSON());$loading.remove();$("#"+d).empty().append("<option>Select...</option>");$.each(f.toJSON(),function(j,i){var k=Handlebars.compile(e);var h=k(i);$("#"+d).append(h);if(g&&typeof(g)==="function"){g()}})}})}function fillTokenizedSelect(a,b){$("#"+a).empty().append("<option>Select...</option>");$.each(b,function(c,d){$("#"+a).append('<option value="'+d+'">'+d+"</option>")})}function fillMilestones(b,a){$("#"+b).empty();$.each(a,function(c,d){$("#"+b).append('<a href="#"><li value="'+d+'">'+d+"</li></a>")})}function btnDropDown(b,a){}function delete_contact_property(a,b){for(var c=0;c<a.properties.length;c++){if(a.properties[c].name==b){a.properties.splice(c,1);--c}}return a}function delete_contact_tag(a,c){for(var b=0;b<a.tags.length;b++){if(a.tags[b]==c){a.tags.splice(b,1);break}}return a}function add_contact_tags(a,b){for(var c=0;c<b.length;c++){a.tags.push(b[c])}return a}var Catalog_Widgets_View=null;function pickWidget(){if(Catalog_Widgets_View==null){Catalog_Widgets_View=new Base_Collection_View({url:"/core/api/widgets/default",restKey:"widget",templateKey:"widgets-add",individual_tag_name:"div"});Catalog_Widgets_View.collection.fetch()}$("#content").html(Catalog_Widgets_View.el)}function loadWidgets(d,a,c){var e={contact:a,user:c};var b=new Base_Collection_View({url:"/core/api/widgets",restKey:"widget",templateKey:"widgets",individual_tag_name:"li",sortKey:"position",modelData:e});b.collection.fetch({success:function(){_(b.collection.models).each(function(h){var i=h.get("id");var g=h.get("url");$.get(g,"script");$("#"+h.get("name"),d).data("model",h)},this);$(".widget-sortable",f).sortable({update:function(g,h){var i=[];$(".widget-sortable li").each(function(l){var j=$(this).find(".widget").attr("id");var k=$("#"+j).data("model");i.push({id:k.get("id"),position:l})});$.ajax({type:"POST",url:"/core/api/widgets/positions",data:JSON.stringify(i),contentType:"application/json; charset=utf-8",success:function(j){},dataType:"json"})}});$(".widget-sortable",f).disableSelection()}});var f=b.render().el;$("#widgets",d).html(f)}$(function(){$(".add-widget").live("click",function(d){var c=$(this).attr("widget-name");if(Catalog_Widgets_View==null){alert("widgets are not loaded yet");return}alert("saving "+c);var f=Catalog_Widgets_View.collection.where({name:c});if(f.length==0){alert("Not found")}var b=f[0];var a=b.clone();a.url="/core/api/widgets";a.save();Backbone.history.navigate("contact/"+App_Contacts.contactDetailView.model.id,{trigger:true})})});function addSocial(b){var a=["TWITTER","LINKEDIN"];$.each(a,function(f,h){var e="/core/api/social/"+h+"/"+App_Contacts.contactDetailView.model.id;var c=new SocialSearchesListView();c.collection.url=e;var g=h+"-"+App_Contacts.contactDetailView.model.id;c.key=g;var d=localStorage.getItem(g);if(localStorage&&d!=null&&JSON.parse(d).length!=0){c.collection=new SocialSearchCollection(JSON.parse(d));c.render()}else{c.collection.fetch()}$("#social",b).append(c.el)})}$(function(){$("#saveWorkflow").live("click",function(){if(!isValidForm("#workflowform")){$("#workflowform").find("input").focus();return false}var c=window.frames.designer.serializePhoneSystem();var b=$("#workflow-name").val();if(isNotValid(b)){alert("Name not validd");return}var a={};if(App_Workflows.workflow_model!=undefined){a=App_Workflows.workflow_model;App_Workflows.workflow_model.set("name",b);App_Workflows.workflow_model.set("rules",c);App_Workflows.workflow_model.save()}else{a.name=b;a.rules=c;var d=new Backbone.Model(a);App_Workflows.workflowsListView.collection.create(d)}Backbone.history.navigate("workflows",{trigger:true})});$("#delete_campaign_logs").live("click",function(b){b.preventDefault();var a=$("#logs-table").find("input").val();if(!a){return}$.ajax({url:"core/api/campaigns/logs"+a,type:"DELETE",})})});function setupHTMLEditor(a){head.js("lib/wysihtml5-0.3.0-min.js","lib/bootstrap-wysihtml5-min.js",function(){console.log("setting up text");console.log(a.html());a.wysihtml5()})}$(function(){$(".merge-field").die().live("click",function(b){b.preventDefault();console.log("Merge field");var a=$(this).attr("name");var c=$("#email-template-html").val();var d=$("#email-template-html").data("wysihtml5");if(d){d.editor.composer.commands.exec("insertHTML","{{"+a+"}}")}})});var AdminSettingsRouter=Backbone.Router.extend({routes:{"account-prefs":"accountPrefs",users:"users","users-add":"usersAdd","custom-fields":"customFields","analytics-code":"analyticsCode",api:"api",admin:"adminSettings",milestones:"milestones"},adminSettings:function(){console.log("Admin Settings");this.adminView=new Base_Model_View({url:"/core/api/current-user",template:"admin-settings"});this.adminView.model.fetch();$("#content").html(this.adminView.render().el)},accountPrefs:function(){var a=new Base_Model_View({url:"/core/api/account-prefs",template:"admin-settings-account-prefs"});$("#content").html(a.render().el)},users:function(){this.usersListView=new Base_Collection_View({url:"/core/api/users",restKey:"domainUser",templateKey:"admin-settings-users",individual_tag_name:"tr"});this.usersListView.collection.fetch();$("#content").html(this.usersListView.el)},usersAdd:function(){var a=new Base_Model_View({url:"core/api/users",template:"admin-settings-user-add",isNew:true,window:"users"});$("#content").html(a.render().el)},customFields:function(){this.customFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields",restKey:"customFieldDefs",templateKey:"admin-settings-customfields",individual_tag_name:"tr"});this.customFieldsListView.collection.fetch();$("#content").html(this.customFieldsListView.el)},analyticsCode:function(){head.js("lib/prettify-min.js",function(){var a=new Base_Model_View({url:"/core/api/api-key",template:"admin-settings-api-key-model",postRenderCallback:function(b){prettyPrint()}});$("#content").html(a.el)})},api:function(){head.js("lib/prettify-min.js",function(){var a=new Base_Model_View({url:"/core/api/api-key",template:"admin-settings-api-model",postRenderCallback:function(b){prettyPrint()}});$("#content").html(a.el)})},milestones:function(){var a=new Base_Model_View({url:"/core/api/milestone",template:"admin-settings-milestones",reload:true});$("#content").html(a.render().el)},});var App_Contacts,App_Workflows,App_Deals,App_Admin_Settings,App_Calendar,App_Settings;$(function(){App_Contacts=new ContactsRouter();App_Workflows=new WorkflowsRouter();App_Deals=new DealsRouter();App_Admin_Settings=new AdminSettingsRouter();App_Calendar=new SettingsRouter();App_Settings=new CalendarRouter();App_Contacts.bind("all",currentRoute);App_Workflows.bind("all",currentRoute);App_Deals.bind("all",currentRoute);App_Admin_Settings.bind("all",currentRoute);App_Calendar.bind("all",currentRoute);App_Settings.bind("all",currentRoute);Backbone.history.start()});var Current_Route;function currentRoute(a){Current_Route=(a.split(":")[1])}var CalendarRouter=Backbone.Router.extend({routes:{calendar:"calendar"},calendar:function(){$(".active").removeClass("active");$("#calendarmenu").addClass("active");$("#content").html(getTemplate("calendar",{}));head.js("https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js","lib/fullcalendar.min.js",function(){showCalendar()});this.tasksListView=new Base_Collection_View({url:"/core/api/tasks",restKey:"task",templateKey:"tasks",individual_tag_name:"tr"});this.tasksListView.appendItem=appendTasks;this.tasksListView.collection.fetch();$("#tasks").html(this.tasksListView.el)}});var ContactsRouter=Backbone.Router.extend({routes:{"":"dashboard",contacts:"contacts","contact/:id":"contactDetails","import":"importContacts","add-widget":"addWidget","contact-edit":"editContact","contact-duplicate":"duplicateContact","tags/:tag":"contacts","contacts-filter":"filterContacts","send-email":"sendEmail","add-opportunity":"addOpportunityToContact","contact-view-add":"contactViewAdd","contact-views":"contactViews","contact-custom-view-edit/:id":"editContactView","continue-contact":"continueContact","continue-company":"continueCompany",gmail:"email",twitter:"socialPrefs",linkedin:"socialPrefs"},initialize:function(){},dashboard:function(){},contacts:function(g){var e=20;var a="/core/api/contacts/cursor/"+e;var c="contacts";if(g){a="/core/api/tags/"+g;c="contact"}console.log("Fetching from "+a);this.contactsListView=new Base_Collection_View({url:a,restKey:c,templateKey:"contacts",individual_tag_name:"tr",cursor:true,cursor_max:true});var d=this.contactsListView.el;var f=this.contactsListView.collection;this.contactsListView.collection.fetch({success:function(i,h){setupTags(d);pieTags(d);setupViews(d)}});var b=new Base_Collection_View({url:"core/api/contact-view",restKey:"contactView",templateKey:"contact-view",individual_tag_name:"li",});$("#content").html(this.contactsListView.render().el);$(".active").removeClass("active");$("#contactsmenu").addClass("active")},contactDetails:function(e,a){if(!a){if(!this.contactsListView||this.contactsListView.collection.length==0||this.contactsListView.collection.get(e)==null){console.log("Downloading contact");var d=Backbone.Model.extend({url:function(){return"/core/api/contacts/"+this.id}});var b=new d();b.id=e;b.fetch({success:function(f){App_Contacts.contactDetails(e,b)}});return}}if(!a){a=this.contactsListView.collection.get(e)}this.contactDetailView=new Base_Model_View({model:a,template:"contact-detail",postRenderCallback:function(f){loadWidgets(f,a.toJSON());head.js("lib/jquery.raty.min.js",function(){var g=App_Contacts.contactDetailView.model;g.url="core/api/contacts";$("#star",f).raty({click:function(i,h){g.set("star_value",i);g.save()},score:g.get("star_value")})})}});var c=this.contactDetailView.render().el;$("#content").html(c)},editContact:function(){if(!this.contactDetailView||!this.contactDetailView.model.id||!this.contactsListView||this.contactsListView.collection.length==0){this.navigate("contacts",{trigger:true});return}var a=this.contactsListView.collection.get(this.contactDetailView.model.id);deserializeContact(a.toJSON())},duplicateContact:function(){if(!this.contactDetailView||!this.contactDetailView.model.id||!this.contactsListView||this.contactsListView.collection.length==0){this.navigate("contacts",{trigger:true});return}var a=this.contactsListView.collection.get(this.contactDetailView.model.id);var c=a.toJSON();c=delete_contact_property(c,"email");delete c.id;var b=new Backbone.Model();b.url="core/api/contacts";b.save(c,{success:function(d){deserializeContact(d.toJSON())}})},continueContact:function(){$("#content").html(getTemplate("continue-contact",{}))},continueCompany:function(){$("#content").html(getTemplate("continue-company",{}))},importContacts:function(){$("#content").html(getTemplate("import-contacts",{}));head.js("lib/fileuploader-min.js",function(){fileUploadInit()})},addWidget:function(){pickWidget()},addOpportunityToContact:function(){this.opportunityView=new Base_Model_View({url:"core/api/opportunity",template:"opportunity-add",isNew:true,window:"deals",postRenderCallback:function(d){populateUsers("owner",d);var b=App_Contacts.contactDetailView.model.toJSON();var c=b.properties[0].value+" "+b.properties[1].value;$(".tags",d).append('<li class="label label-warning"  style="display: inline-block; vertical-align: middle; margin-right:3px;" value="'+b.id+'">'+c+"</li>");$("#close_date",d).datepicker({format:"mm-dd-yyyy"})}});var a=this.opportunityView.render();$("#content").html(a.el)},contactViewAdd:function(){var a=new Base_Model_View({url:"core/api/contact-view",isNew:true,window:"contact-views",template:"contact-view",postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.multi-select.js",function(){$("#multipleSelect",b).multiSelect();$(".ms-selection",b).children("ul").addClass("multiSelect").attr("name","fields_set").sortable()})}});$("#content").html(a.render().el)},contactViews:function(){this.contactViewListView=new Base_Collection_View({url:"/core/api/contact-view",restKey:"contactView",templateKey:"contact-custom-view",individual_tag_name:"tr"});this.contactViewListView.collection.fetch();$("#content").html(this.contactViewListView.el)},editContactView:function(c){if(!App_Contacts.contactViewListView||App_Contacts.contactViewListView.collection.length==0||App_Contacts.contactViewListView.collection.get(c)==null){this.navigate("contact-views",{trigger:true})}var a=App_Contacts.contactViewListView.collection.get(c);var b=new Base_Model_View({url:"core/api/contact-view/"+c,model:a,template:"contact-view",restKey:"contactView",window:"contact-views",postRenderCallback:function(d){head.js("lib/jquery.multi-select.js",function(){$("#multipleSelect",d).multiSelect();$(".ms-selection",d).children("ul").addClass("multiSelect").attr("name","fields_set").attr("id","fields_set").sortable()})}});$("#content").html(b.render().el)},sendEmail:function(){var c=this.contactDetailView.model;var a=new Base_Model_View({model:c,template:"send-email"});$("#content").html(a.render().el);var e=Backbone.Model.extend({url:"/core/api/current-user",restKey:"domainUser"});var d=new e();d.fetch({success:function(g){var f=g.toJSON();$("#emailForm").find('input[name="from"]').val(f.email)}});var b="<option value='{{id}}'> {{subject}}</option>";fillSelect("sendEmailSelect","/core/api/email/templates","emailTemplates",undefined,b)},filterContacts:function(){head.js("lib/jquery.chained.min.js",function(){$("#content").html(getTemplate("filter-contacts",{}));$("#secondSelect").chained("#firstSelect");$("#thirdSelect").chained("#secondSelect");$("#fourthSelect").remoteChained("#secondSelect","/core/api/tags/filter-tags")})},});var DealsRouter=Backbone.Router.extend({routes:{deals:"deals","deals-add":"dealsAdd","deals/:id":"dealsDetails"},deals:function(){this.opportunityCollectionView=new Base_Collection_View({url:"core/api/opportunity",restKey:"opportunity",templateKey:"opportunities",individual_tag_name:"tr"});this.opportunityCollectionView.collection.fetch({success:function(){pieMilestones();pieDetails()}});$("#content").html(this.opportunityCollectionView.render().el);$(".active").removeClass("active");$("#dealsmenu").addClass("active")},dealsAdd:function(){this.opportunityModelview=new Base_Model_View({url:"core/api/opportunity",template:"opportunity-add",isNew:true,window:"deals",postRenderCallback:function(b){populateUsers("owner",b);agile_type_ahead("relates_to",b,contacts_typeahead);populateMilestones(b);$("#close_date",b).datepicker({format:"mm-dd-yyyy"})}});var a=this.opportunityModelview.render();$("#content").html(a.el)},dealsDetails:function(b){if(!this.opportunityCollectionView||this.opportunityCollectionView.collection.length==0){this.navigate("deals",{trigger:true});return}this.opportunityCollectionView.collection.fetch();this.opportunityCollectionView.currentDeal=this.opportunityCollectionView.collection.get(b);this.dealsDetailView=new Base_Model_View({model:this.opportunityCollectionView.currentDeal,template:"opportunity-detail",postRenderCallback:function(c){populateMilestones(c,true)}});var a=this.dealsDetailView.render().el;$("#content").html(a)}});var SettingsRouter=Backbone.Router.extend({routes:{settings:"settings","user-prefs":"userPrefs","social-prefs":"socialPrefs","email-templates":"emailTemplates","email-template-add":"emailTemplateAdd",email:"email","notification-prefs":"notificationPrefs","contact-us":"contactUsEmail"},settings:function(){var a=getTemplate("settings",{});$("#content").html(a);$(".active").removeClass("active");$("#settingsmenu").addClass("active")},userPrefs:function(){var a=new Base_Model_View({url:"/core/api/user-prefs",template:"settings-user-prefs",reload:true,postRenderCallback:function(b){setupHTMLEditor($("#WYSItextarea"))}});$("#content").html(a.render().el)},socialPrefs:function(){var c={service:"linkedin"};var b=new Base_Model_View({url:"/core/api/social-prefs/LINKEDIN",template:"settings-social-prefs",data:c});$("#content").html(b.render().el);c={service:"twitter"};var a=new Base_Model_View({url:"/core/api/social-prefs/TWITTER",template:"settings-social-prefs",data:c});$("#content").append(a.render().el)},email:function(){var c={service:"gmail"};var b=new Base_Model_View({url:"/core/api/social-prefs/GMAIL",template:"settings-social-prefs",data:c});console.log(b.model.toJSON());$("#content").html(b.render().el);var a=new Base_Model_View({url:"/core/api/imap",template:"settings-imap-prefs"});$("#content").append(a.render().el)},emailTemplates:function(){var a=new Base_Collection_View({url:"/core/api/email/templates",restKey:"emailTemplates",templateKey:"settings-email-templates",individual_tag_name:"tr"});a.collection.fetch();$("#content").html(a.el)},emailTemplateAdd:function(){var a=new Base_Model_View({url:"/core/api/email/templates",template:"settings-email-template-add",window:"settings",postRenderCallback:function(b){setupHTMLEditor($("#email-template-html"))}});$("#content").html(a.render().el)},notificationPrefs:function(){var a=new Base_Model_View({url:"core/api/notifications",template:"settings-notification-prefs",});$("#content").html(a.render().el)},contactUsEmail:function(){$("#content").html(getTemplate("help-email-form"),{})}});var WorkflowsRouter=Backbone.Router.extend({routes:{workflows:"workflows","workflow-add":"workflowAdd","workflow/:id":"workflowEdit","workflows/logs/:id":"logsToCampaign",},workflows:function(){this.workflowsListView=new Base_Collection_View({url:"/core/api/workflows",restKey:"workflow",templateKey:"workflows",individual_tag_name:"tr"});this.workflowsListView.collection.fetch();$("#content").html(this.workflowsListView.el);$(".active").removeClass("active");$("#workflowsmenu").addClass("active")},workflowAdd:function(){if(!this.workflowsListView||!this.workflowsListView.collection){this.navigate("workflows",{trigger:true});return}this.workflow_json=undefined;this.workflow_model=undefined;$("#content").html(getTemplate("workflow-add",{}))},workflowEdit:function(a){if(!this.workflowsListView||this.workflowsListView.collection.length==0){this.navigate("workflows",{trigger:true});return}this.workflow_model=this.workflowsListView.collection.get(a);this.workflow_json=this.workflow_model.get("rules");$("#content").html(getTemplate("workflow-add",{}));$("#workflow-name").val(this.workflow_model.get("name"))},logsToCampaign:function(b){var a=new Base_Collection_View({url:"/core/api/campaigns/logs/"+b,restKey:"logs",templateKey:"campaign-logs",individual_tag_name:"tr"});a.collection.fetch();$("#content").html(a.el)}});function isNotValid(a){if(a==undefined){return true}if(a.length==0){return true}return false}function isValidField(b){var a=$("#"+b).val();return !isNotValid(a)}function propertyJSON(a,d,c){var b={};if(c==undefined){b.type="SYSTEM"}else{b.type=c}b.name=a;b.value=$("#"+d).val();return b}$("#ajax").hide().ajaxStart(function(){$(this).show()}).ajaxStop(function(){$(this).hide()}).ajaxError(function(){$(this).hide()});