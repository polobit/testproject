var _agile=_agile||[];var Is_Localhost=false;var Lib_Path="";var Ac_Email="";var Contacts_Json={};var Cache_Counter=0;function agile_init_gadget(){if(window.location.host.indexOf("localhost")!=-1){Is_Localhost=true;Lib_Path="http://localhost:8888/";Ac_Email="test@example.com";agile_download_scripts();head.js(Lib_Path+"misc/gmail/gadget-js-all/js/agile-gadget-ui.js");head.ready(function(){agile_generate_ui("51ekokl790t85b11ivhim9ep7i","localhost")})}else{Lib_Path="https://googleapps.agilecrm.com/";agile_login();gadgets.window.adjustHeight()}}function agile_login(){console.log("Logging in");var d=new gadgets.Prefs();var b=d.getString("agile_user_exists");if(b=="true"){var e=d.getString("agile_user_key");var c=d.getString("agile_user_domain");agile_download_scripts();head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-ui.min.js");head.ready(function(){agile_generate_ui(e,c)})}else{var g=d.getString("agile_user_popup");var a=parseInt(d.getString("agile_user_expire_at"));var f=new Date().getTime();if(f<a){agile_user_setup_load(g)}else{d.set("agile_user_expire_at","0");agile_send_auth(Lib_Path+"gmail",agile_handle_load_response)}}}function agile_send_auth(a,b){Cache_Counter+=1;var a=a+"?chachecounter="+Cache_Counter;console.log("Osapi from: "+a);osapi.http.get({href:a,format:"json",authz:"signed"}).execute(b)}function agile_handle_load_response(b){console.log("Auth response: "+b);var a=new gadgets.Prefs();if(b.content!=undefined){if(b.content.user_exists==true){b.content.user_exists="true";a.set("agile_user_key",b.content.api_key);a.set("agile_user_domain",b.content.domain);a.set("agile_user_email",b.content.email);a.set("agile_user_exists",b.content.user_exists);agile_login()}else{b.content.user_exists="false";a.set("agile_user_expire_at",b.content.expires_at.toString());a.set("agile_user_popup",b.content.popup);a.set("agile_user_exists",b.content.user_exists);agile_user_setup_load(b.content.popup)}}}function agile_user_setup_load(a){head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-setup.min.js",function(){agile_user_setup(a)})}function agile_download_scripts(){console.log("Downloading scripts");if(!Is_Localhost){head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-lib.min.js");head.js(Lib_Path+"misc/gmail/gadget-js-all/js/agile-gadget-email.min.js")}else{head.js(Lib_Path+"lib/handlebars-1.0.0.beta.6-min.js",Lib_Path+"jscore/handlebars/handlebars-agile.js",Lib_Path+"jscore/handlebars/handlebars-helpers.js",Lib_Path+"jscore/util.js",Lib_Path+"jscore/md5.js");head.js(Lib_Path+"stats/min/agile-min.js");head.js(Lib_Path+"lib/bootstrap.min.js");head.js(Lib_Path+"misc/gmail/gadget-js-all/js/agile-gadget-email.js")}}window.onload=agile_init_gadget;