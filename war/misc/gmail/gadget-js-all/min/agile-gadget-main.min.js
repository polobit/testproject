var _agile=_agile||[];var Is_Localhost=false;var Lib_Path="";var Ac_Email="";var Contacts_Json={};var Timestamp=0;function agile_init_gadget(){if(window.location.host.indexOf("localhost")!=-1){Is_Localhost=true;Lib_Path="http://localhost:8888/";Ac_Email="test@example.com";agile_download_scripts();head.js(Lib_Path+"misc/gmail/gadget-js-all/js/agile-gadget-ui.js");head.ready(function(){agile_generate_ui("51ekokl790t85b11ivhim9ep7i","localhost")})}else{Lib_Path="https://googleapps.agilecrm.com/";agile_login();gadgets.window.adjustHeight()}}function agile_login(){console.log("Logging in");var c=new gadgets.Prefs();var b=c.getString("agile_user_exists");if(b=="true"){var e=c.getString("agile_user_key");var d=c.getString("agile_user_domain");agile_download_scripts();head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-ui.min.js");head.ready(function(){agile_generate_ui(e,d)})}else{var g=c.getString("agile_user_popup");var a=parseInt(c.getString("agile_user_expire_at"));var f=new Date().getTime();if(f<a){agile_user_setup_load(g)}else{c.set("agile_user_expire_at","0");agile_send_auth(Lib_Path+"gmail",agile_handle_load_response)}}}function agile_send_auth(b,a){Timestamp+=1;var b=b+"?Timestamp="+Timestamp;console.log("Osapi from: "+b);osapi.http.get({href:b,format:"json",authz:"signed"}).execute(a)}function agile_handle_load_response(b){console.log("Auth response: ");console.log(b);var a=new gadgets.Prefs();if(b.content!=undefined){if(b.content.user_exists==true){b.content.user_exists="true";Gadget_Prefs.set("agile_user_key",b.content.api_key);Gadget_Prefs.set("agile_user_domain",b.content.domain);Gadget_Prefs.set("agile_user_email",b.content.email);Gadget_Prefs.set("agile_user_exists",b.content.user_exists);agile_login()}else{b.content.user_exists="false";Gadget_Prefs.set("agile_user_expire_at",b.content.expires_at.toString());Gadget_Prefs.set("agile_user_popup",b.content.popup);Gadget_Prefs.set("agile_user_exists",b.content.user_exists);agile_user_setup_load(b.content.popup)}}}function agile_user_setup_load(a){head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-setup.min.js",function(){agile_user_setup(a)})}function agile_download_scripts(){console.log("Downloading scripts");head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-lib.min.js");if(!Is_Localhost){head.js(Lib_Path+"misc/gmail/gadget-js-all/js/agile-gadget-email.min.js")}else{head.js(Lib_Path+"misc/gmail/gadget-js-all/js/agile-gadget-email.js")}}window.onload=agile_init_gadget;