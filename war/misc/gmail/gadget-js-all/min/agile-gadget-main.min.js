var _agile=_agile||[];var Is_Localhost=false;var Lib_Path="";var Ac_Email="";var Contacts_Json={};var Timestamp=0;function agile_init_gadget(){if(window.location.host.indexOf("localhost")!=-1){Is_Localhost=true;Lib_Path="http://localhost:8888/";Ac_Email="test@example.com";agile_download_scripts();head.js(Lib_Path+"misc/gmail/gadget-js-all/js/agile-gadget-ui.js");head.ready(function(){agile_generate_ui("51ekokl790t85b11ivhim9ep7i","localhost")})}else{Lib_Path="https://googleapps.agilecrm.com/";agile_login();gadgets.window.adjustHeight()}}function agile_login(){console.log("Logging in");function a(j,i){agile_download_scripts();head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-ui.min.js");head.ready(function(){agile_generate_ui(j,i)})}function f(j){var l=j.popup;var i=j.expires_at;var k=new Date().getTime();if(k<i){agile_user_setup_load(l)}else{agile_send_auth(Lib_Path+"gmail",agile_handle_load_response)}}var c=new gadgets.Prefs();var b=c.getString("agile_user_exists");var h=agile_gadget_read_cookie("agile_cookie");var e=JSON.parse(h);if(b=="true"){var g=c.getString("agile_user_key");var d=c.getString("agile_user_domain");a(g,d);agile_gadget_erase_cookie("agile_cookie")}else{if(h==null){agile_send_auth(Lib_Path+"gmail",agile_handle_load_response)}else{if(e.user_exists=="true"){c.set("agile_user_key",e.api_key);c.set("agile_user_domain",e.domain);c.set("agile_user_email",e.email);c.set("agile_user_exists",e.user_exists);a(e.api_key,e.domain)}else{f(e)}}}}function agile_send_auth(b,a){Timestamp+=1;var b=b+"?Timestamp="+Timestamp;console.log("Osapi from: "+b);osapi.http.get({href:b,format:"json",authz:"signed"}).execute(a)}function agile_handle_load_response(b){console.log("Auth response: ");console.log(b);var a=new gadgets.Prefs();if(b.content!=undefined){agile_gadget_erase_cookie("agile_cookie");if(b.content.user_exists==true){b.content.user_exists="true";agile_gadget_create_cookie("agile_cookie",JSON.stringify(b.content),0);agile_login()}else{b.content.user_exists="false";agile_gadget_create_cookie("agile_cookie",JSON.stringify(b.content),0);agile_user_setup_load(b.content.popup)}}}function agile_user_setup_load(a){head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-setup.min.js",function(){agile_user_setup(a)})}function agile_download_scripts(){console.log("Downloading scripts");head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-lib.min.js");if(!Is_Localhost){head.js(Lib_Path+"misc/gmail/gadget-js-all/js/agile-gadget-email.min.js")}else{head.js(Lib_Path+"misc/gmail/gadget-js-all/js/agile-gadget-email.js")}}window.onload=agile_init_gadget;function agile_gadget_create_cookie(c,d,e){if(e){var b=new Date();b.setTime(b.getTime()+(e*24*60*60*1000));var a="; expires="+b.toGMTString()}else{var a=""}document.cookie=c+"="+escape(d)+a+"; path=/"}function agile_gadget_read_cookie(b){var f=b+"=";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var e=a[d];while(e.charAt(0)==" "){e=e.substring(1,e.length)}if(e.indexOf(f)==0){return unescape(e.substring(f.length,e.length))}}return null}function agile_gadget_erase_cookie(a){agile_gadget_create_cookie(a,"",-1)};