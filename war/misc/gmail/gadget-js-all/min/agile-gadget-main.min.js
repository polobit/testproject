var _agile=_agile||[];var Is_Localhost=false;var Lib_Path;var Contacts_Json={};var Cache_Counter=0;function agile_init_gadget(){if(window.location.host.indexOf("localhost")!=-1){Is_Localhost=true;Lib_Path="http://localhost:8888/";agile_download_scripts();head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-ui.min.js");head.ready(function(){agile_generate_ui("3qpvaoo2s27ibehsu6kgc64nn","localhost")})}else{Lib_Path="https://googleapps.agilecrm.com/";agile_login();gadgets.window.adjustHeight()}}function agile_login(){var d=new gadgets.Prefs();var b=d.getString("agile_user_exists");if(b=="true"){var e=d.getString("agile_user_key");var c=d.getString("agile_user_domain");agile_download_scripts();head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-ui.min.js");head.ready(function(){agile_generate_ui(e,c)})}else{var g=d.getString("agile_user_popup");var a=d.getString("agile_user_expire_at");var f=new Date().getTime();if(f<a){agile_user_setup_load(g)}else{d.set("agile_user_expire_at",0);Agile_Send_Auth()}}}function Agile_Send_Auth(){Cache_Counter+=1;var a=Lib_Path+"gmail?chachecounter="+Cache_Counter;console.log("Osapi from "+a);osapi.http.get({href:a,format:"json",authz:"signed"}).execute(agile_handle_load_response)}function agile_handle_load_response(b){var a=new gadgets.Prefs();if(b.content!=undefined){if(b.content.user_exists==true){b.content.user_exists="true";a.set("agile_user_key",b.content.api_key);a.set("agile_user_domain",b.content.domain);a.set("agile_user_email",b.content.email);a.set("agile_user_exists",b.content.user_exists);agile_login()}else{b.content.user_exists="false";a.set("agile_user_expire_at",b.content.expires_at);a.set("agile_user_popup",b.content.popup);a.set("agile_user_exists",b.content.user_exists);agile_user_setup_load(b.content.popup)}}}function agile_user_setup_load(a){head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-setup.min.js",function(){agile_user_setup(a)})}function agile_download_scripts(){console.log("Downloading scripts");head.js(Lib_Path+"misc/gmail/gadget-js-all/min/agile-gadget-lib.min.js")}window.onload=agile_init_gadget;