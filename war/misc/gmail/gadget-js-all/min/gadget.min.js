function agile_user_show_association(){var a=agile_get_prefs(PREFS_POPUP_LINK);if(a){agile_user_setup();return}agile_send_auth(LIB_PATH+"gmail?command=validate")}function agile_send_auth(a){var b={};b[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;b[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.SIGNED;gadgets.io.makeRequest(a,agile_handle_load_response,b)}function agile_handle_load_response(a){console.log(a);if(a==undefined){return}agile_gadget_erase_cookie("agile_cookie");if(a.data.user_exists==true){agile_save_prefs(PREFS_DOMAIN,a.data.domain);agile_save_prefs(PREFS_EMAIL,a.data.email);agile_save_prefs(PREFS_API_KEY,a.data.api_key);agile_login();return}agile_save_prefs(PREFS_POPUP_LINK,a.data.popup);console.log("Setting up");agile_user_setup()}function agile_get_emails(){var a=[];if(Is_Localhost){a=[{email_from:"devika@faxdesk.com"},{name_from:"Devika Jakkannagari"},{email_to:"abhi@gashok.mygbiz.com;rahul@gashok.mygbiz.com;dheeraj@gashok.mygbiz.com;chandan@gashok.mygbiz.com;abhiranjan@gashok.mygbiz.com"},{name_to:"Abhi;;D j p;;"},{email_cc:"devikatest1@gmail.com;devikatest@gmail.com;teju@gmail.com"},{name_cc:"Dev T1;;Teju"},{email:"devikatest@gmail.com"},{email:"test1@gmail.com"},{email:"test2@gmail.com"},{email:"pbx.kumar@gmail.com"}];return parse_emails(a)}a=google.contentmatch.getContentMatches();console.log(a);console.log(JSON.stringify(a));return parse_emails(a)}function parse_emails(a){return $.merge(collate_emails(a,"from"),collate_emails(a,"to")).concat(collate_emails(a,"cc")).concat(agile_grep(a,"email"))}function collate_emails(d,b){var c=[];var a=agile_grep(d,"email_"+b);if(a.length>0){email_key_name_array=agile_grep(d,"name_"+b);$.each(a,function(f,g){var e={};e.key=b;e.email=g;if(email_key_name_array[f]){e.name=email_key_name_array[f].trim()}else{e.name=""}c.push(e)})}return c}function agile_grep(c,a){var b=jQuery.grep(c,function(d){if(d.hasOwnProperty(a)){return d}});if(b.length==1&&a!="email"){return b[0][a].split(";")}return b}function agile_is_valid_form(a){$(a).validate();return $(a).valid()}function agile_serialize_form(a){if(!agile_is_valid_form(a)){return}return a.serializeArray()}var _agile=_agile||[];var Is_Localhost=false;var Contacts_Json={};var DEFAULT_GRAVATAR_url="https://dpm72z3r2fvl4.cloudfront.net/css/images/user-default.png";function agile_init_gadget(){if(window.location.host.indexOf("localhost")!=-1){Is_Localhost=true;LIB_PATH="http://localhost:8888/";_agile.set_account("najgcc239kine9ungm8ip2ftj0","localhost");agile_user_associated();return}agile_login()}function agile_login(){var b=agile_get_prefs(PREFS_API_KEY);console.log("API Key from Prefs = "+b);if(b){var a=agile_get_prefs(PREFS_DOMAIN);console.log("Setting API key "+b+" "+a);_agile.set_account(b,a);agile_user_associated();agile_show_delete(true);return}agile_user_show_association();agile_show_delete(false)}function agile_show_delete(a){if(a){$("#delete-button").show()}else{$("#delete-button").hide()}$("#delete-button").click(agile_delete_all_prefs)}function agile_user_associated(){var a=agile_get_emails();Contacts_Json={};$.each(a,function(b,c){Contacts_Json[c.email]=c});console.log(Contacts_Json);head.js(LIB_PATH+"lib/bootstrap.min.js",LIB_PATH+"jscore/md5.js",function(){set_html($("#agile_content"),"search",a)})}var PREFS_API_KEY="agile_api_key";var PREFS_DOMAIN="agile_domain";var PREFS_EMAIL="agile_email";var PREFS_POPUP_LINK="agile_popup_link";function agile_save_prefs(b,c){var a=new gadgets.Prefs();a.set(b,c);agile_gadget_create_cookie(b,c,0)}function agile_get_prefs(b){var a=new gadgets.Prefs();var c=a.getString(b);if(!c){c=agile_gadget_read_cookie(b)}else{agile_gadget_erase_cookie(b)}return c}function agile_delete_prefs(b){var a=new gadgets.Prefs();a.set(b,"");agile_gadget_erase_cookie(b)}function agile_delete_all_prefs(){agile_delete_prefs(PREFS_API_KEY);agile_delete_prefs(PREFS_DOMAIN);agile_delete_prefs(PREFS_EMAIL);agile_delete_prefs(PREFS_POPUP_LINK);console.log("Deleted all prefs");var a={};a[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;a[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.SIGNED;gadgets.io.makeRequest(LIB_PATH+"gmail?command=delete",function(){agile_init_gadget()},a)}function agile_gadget_create_cookie(c,d,e){if(e){var b=new Date();b.setTime(b.getTime()+(e*24*60*60*1000));var a="; expires="+b.toGMTString()}else{var a=""}document.cookie=c+"="+escape(d)+a+"; path=/"}function agile_gadget_read_cookie(b){b=b+"=";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var e=a[d];while(e.charAt(0)==" "){e=e.substring(1,e.length)}if(e.indexOf(b)==0){return unescape(e.substring(b.length,e.length))}}return undefined}function agile_gadget_erase_cookie(a){agile_gadget_create_cookie(a,"",-1)}function agile_user_setup(){$("#loading").hide();set_html($("#agile_content"),"getting-started",{})}function agile_gadget_open_popup(b){$("#loading").show();gadgets.window.adjustHeight();var b=agile_get_prefs(PREFS_POPUP_LINK);var a=window.open(b,"Agile-Gadget-URL","height=400,width=400");var c=setInterval(function(){if(a.closed){clearInterval(c);agile_delete_prefs(PREFS_POPUP_LINK);agile_login()}},100)}var TPL_PATH="http://localhost:8888/misc/gmail/gadget-js-all/tpl/min/";function set_html(a,c,b,d){var c=getTemplate(c,b);if(!c){return}if(d){c=a.html()+c}a.html(c);if(!Is_Localhost){console.log("Adjusting height");gadgets.window.adjustHeight()}}function getTemplate(b,c,a){var d=Handlebars.templates[b];if(d){return d(c)}if(a=="no"){console.log("Not found "+b);return}downloadSynchronously(TPL_PATH+b+".js");return getTemplate(b,c,"no")}function downloadSynchronously(b){var a="script";console.log(b+" "+a);jQuery.ajax({url:b,dataType:a,success:function(c){console.log("Downloaded url "+b)},async:false});return""}function agile_build_form_template(c,e,a,f){var b=Contacts_Json[c.closest(".show-form").data("content")];var d=getTemplate(e,b,"no");c.closest(".gadget-contact-details-tab").find(a).html($(d));if(f&&typeof(f)==="function"){f()}}function agile_gadget_adjust_height(){if(!Is_Localhost){gadgets.window.adjustHeight()}}function agile_build_tag_ui(a,b){$(a).children("li:gt(0)").remove();for(Index=0;Index<b.tags.length;Index++){var c=$(a).children().eq(0).clone(true);$(c).css("display","inline-block");$(".tag-name",c).text(b.tags[Index]);c.appendTo(a)}}function agile_load_datepicker(a,b){head.js(LIB_PATH+"lib/bootstrap.min.js",LIB_PATH+"lib/bootstrap-datepicker-min.js",function(){a.datepicker({format:"mm/dd/yyyy"});if(b&&typeof(b)==="function"){b()}})}function getPropertyValue(b,c){if(b==undefined){return}for(var d=0,a=b.length;d<a;d++){if(b[d].name==c){return b[d].value}}}function getProperty(b,c){if(b==undefined){return}for(var d=0,a=b.length;d<a;d++){if(b[d].name==c){return b[d]}}}function ucfirst(a){return(a&&typeof a==="string")?(a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()):""}$(function(){$(".action-add-note").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");$(".gadget-notes-tab-list",a).hide();agile_build_form_template($(this),"gadget-note",".gadget-notes-tab-list",function(){$(".gadget-notes-tab a",a).tab("show");$(".gadget-notes-tab-list",a).show();agile_gadget_adjust_height()})});$(".action-add-task").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");$(".gadget-tasks-tab-list",a).hide();agile_build_form_template($(this),"gadget-task",".gadget-tasks-tab-list",function(){agile_load_datepicker($(".task-calender",a),function(){$(".gadget-tasks-tab a",a).tab("show");$(".gadget-tasks-tab-list",a).show();agile_gadget_adjust_height()})})});$(".action-add-deal").die().live("click",function(c){c.preventDefault();var b=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");var a=$(this);$(".gadget-deals-tab-list",b).hide();_agile.get_milestones({success:function(e){Milestone_Array=e.milestones.split(",");for(var g in Milestone_Array){Milestone_Array.splice(g,1,Milestone_Array[g].trim())}var d=Contacts_Json[b.closest(".show-form").data("content")];d.milestones=Milestone_Array;var f=getTemplate("gadget-deal",d,"no");a.closest(".gadget-contact-details-tab").find(".gadget-deals-tab-list").html($(f));$(".gadget-deals-tab a",b).tab("show");$(".gadget-deals-tab-list",b).show();agile_load_datepicker($(".deal-calender",b),function(){$(".gadget-deals-tab a",b).tab("show");$(".gadget-deals-tab-list",b).show();agile_gadget_adjust_height()});agile_gadget_adjust_height()},error:function(d){}})});$(".action-add-campaign").die().live("click",function(c){c.preventDefault();var b=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");var a=$(this);$(".gadget-campaigns-tab-list",b).hide();_agile.get_workflows({success:function(d){var e=getTemplate("gadget-campaign",d,"no");a.closest(".gadget-contact-details-tab").find(".gadget-campaigns-tab-list").html($(e));$(".gadget-campaigns-tab a",b).tab("show");$(".gadget-campaigns-tab-list",b).show();agile_gadget_adjust_height()},error:function(d){}})})});$(function(){$(".gadget-contact-validate").die().live("click",function(f){f.preventDefault();var d=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");var b=$(this);var a=[];var c={};a=agile_serialize_form(d.find(".gadget-contact-form"));$.each(a,function(e,g){c[g.name]=g.value});$(".contact-add-waiting",d).show();_agile.create_contact(c,{success:function(e){$(".contact-add-waiting",d).hide(1);agile_create_contact_ui(d,b,c.email,e)},error:function(e){$(".contact-add-waiting",d).hide(1);$(".contact-add-status",d).text(e.error).show().delay(5000).hide(1)}})});$(".gadget-note-validate").die().live("click",function(d){d.preventDefault();var c=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");var a=[];var b={};var f={};a=agile_serialize_form($(c).find(".gadget-note-form"));$.each(a,function(g,e){if(e.name=="email"){f[e.name]=e.value}else{b[e.name]=e.value}});$(".note-add-waiting",c).show();_agile.add_note(b,{success:function(e){$(".note-add-waiting",c).hide(1);$(".gadget-notes-tab",c).trigger("click")},error:function(e){}},f.email)});$(".gadget-task-validate").die().live("click",function(d){d.preventDefault();var c=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");var a=[];var b={};var f={};a=agile_serialize_form($(c).find(".gadget-task-form"));$.each(a,function(g,e){if(e.name=="email"){f[e.name]=e.value}else{b[e.name]=e.value}});b.due=new Date(b.due).getTime()/1000;$(".task-add-waiting",c).show();_agile.add_task(b,{success:function(e){$(".task-add-waiting",c).hide(1);$(".gadget-tasks-tab",c).trigger("click")},error:function(e){}},f.email)});$(".gadget-deal-validate").die().live("click",function(d){d.preventDefault();var c=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");var a=[];var b={};var f={};a=agile_serialize_form($(c).find(".gadget-deal-form"));$.each(a,function(g,e){if(e.name=="email"){f[e.name]=e.value}else{b[e.name]=e.value}});b.close_date=new Date(b.close_date).getTime()/1000;$(".deal-add-waiting",c).show();_agile.add_deal(b,{success:function(e){$(".deal-add-waiting",c).hide(1);$(".gadget-deals-tab",c).trigger("click")},error:function(e){}},f.email)});$(".gadget-campaign-validate").die().live("click",function(d){d.preventDefault();var c=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");var a=[];var b={};var f=$(c).data("content");a=agile_serialize_form($(c).find(".gadget-campaign-form"));$.each(a,function(g,e){if(e.name=="email"){f[e.name]=e.value}else{b[e.name]=e.value}});$(".campaign-add-waiting",c).show();_agile.add_campaign(b,{success:function(e){$(".campaign-add-waiting",c).hide(1);$(".gadget-campaigns-tab",c).trigger("click")},error:function(e){}},f)});$(".cancel").die().live("click",function(c){c.preventDefault();var a=$(this).data("tab-identity");$(".gadget-"+a+"-tab").trigger("click");var b=$(this).closest("div.gadget-contact-details-tab");$(".show-add-contact-form",b).toggle();agile_gadget_adjust_height()})});$(function(){$(".gadget-search-contact").die().live("click",function(c){c.preventDefault();var b=$(this).closest("div.gadget-contact-details-tab").find(".show-form");var a=$(this);var d="";if(!a.hasClass("search-mail-button")){d=$(b).data("content");agile_gadget_adjust_width(b,$(".contact-search-waiting",b),true);$(".contact-search-waiting",b).css("visibility","visible")}else{d=$(".agile-mail-dropdown option:selected").attr("data-content");console.log(d);console.log(Contacts_Json[d]);if(Contacts_Json[d].mail_exist==true){$("#agile_content .show-form").each(function(){if($(this).data("content")==d){$(this).find(".gadget-show-contact").trigger("click");return false}});console.log("Email is already in list");return}$(".contact-search-waiting",b).show()}_agile.get_contact(d,{success:function(e){$(".contact-search-waiting",b).hide();if(a.hasClass("search-mail-button")){agile_add_mail_to_list(e,d,b)}else{agile_create_contact_ui(b,a,d,e)}},error:function(e){e.id=null;$(".contact-search-waiting",b).hide();if(a.hasClass("search-mail-button")){$(".contact-search-status",b).fadeIn().delay(4000).fadeOut();agile_add_mail_to_list(e,d,b)}else{agile_create_contact_ui(b,a,d,e)}}})});$(".gadget-add-contact").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");agile_build_form_template($(this),"gadget-add-contact",".show-add-contact-form",function(){$(".show-add-contact-form",a).toggle();agile_gadget_adjust_height()})});$(".gadget-show-contact").die().live("click",function(c){c.preventDefault();var b=$(this).closest("div.gadget-contact-details-tab").find(".show-form");var a=$(this);agile_build_form_template(a,"gadget-contact-summary",".show-contact-summary",function(){var d=Contacts_Json[$(b).data("content")];agile_build_tag_ui($("#added_tags_ul",b),d);$(".display-toggle",b).addClass("hide-contact-summery").removeClass("gadget-show-contact");$(".display-toggle i",b).removeClass("icon-plus").addClass("icon-minus");$(".display-toggle span",b).text("Hide Details");$(".display-toggle",b).next().hide();agile_gadget_adjust_height();$(".show-contact-summary",b).toggle();agile_gadget_adjust_height();agile_build_form_template(a,"gadget-tabs",".option-tabs",function(){$(".gadget_tabs",b).tab();$(".option-tabs",b).toggle();agile_gadget_adjust_height();$(".gadget-notes-tab",b).trigger("click");$(".dropdown-toggle").dropdown()})})});$(".hide-contact-summery").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.gadget-contact-details-tab").find("div.show-form");$(".display-toggle",a).removeClass("hide-contact-summery").addClass("gadget-show-contact");$(".display-toggle i",a).removeClass("icon-minus").addClass("icon-plus");$(".display-toggle span",a).text("Show");$(".display-toggle",a).next().show();agile_gadget_adjust_height();$(".show-contact-summary",a).toggle();agile_gadget_adjust_height();$(".option-tabs",a).toggle();agile_gadget_adjust_height()})});function agile_gadget_adjust_width(d,a,f){if(f){var c=$(".agile-no-contact",d).width();var e=parseInt(a.width(),10)+parseInt(a.css("margin-left"),10)+10;var b=(((c-e)/c)*100)+"%";$(".contact-list-width",d).css("max-width",b)}else{$(".contact-list-width",d).css("max-width","95%")}}function agile_create_contact_ui(c,a,d,b){if(Is_Localhost){b.ac_path=LIB_PATH}else{b.ac_path="https://"+agile_id.namespace+".agilecrm.com/"}$.extend(Contacts_Json[d],b);agile_build_form_template(a,"gadget-contact-list",".contact-list",function(){if(b.id==null){agile_gadget_adjust_width(c,$(".contact-search-status",c),true);console.log(c);console.log(c.html());$(".contact-search-status",c).show().delay(4000).hide(1,function(){agile_gadget_adjust_width(c,$(".contact-search-status",c),false)})}else{$(".gadget-show-contact",c).trigger("click")}})}function agile_add_mail_to_list(e,g,d){if(Is_Localhost){e.ac_path=LIB_PATH}else{e.ac_path="https://"+agile_id.namespace+".agilecrm.com/"}var f={};f[g]=Contacts_Json[g];$.extend(Contacts_Json[g],e);Contacts_Json[g].mail_exist=true;var b=getTemplate("search",f,"no");$("#agile_content").append($(b));$("#agile_content").find(".contact-list:last").hide();var a=Contacts_Json[g];var c=getTemplate("gadget-contact-list",a,"no");$("#agile_content").find(".contact-list:last").html($(c));$("#agile_content").find(".contact-list:last").show();if(!Is_Localhost){gadgets.window.adjustHeight()}if(a.id!=null){$("#agile_content").find(".gadget-show-contact:last").trigger("click")}else{$("#agile_content").find(".contact-search-status:last").hide();$("#agile_content").find(".contact-list-width:last").css("max-width","95%")}}$(function(){$(".add-score").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.score-scope");var c=$('input[name="email"]',a).val();var d=parseInt($.trim($(".score-value",a).text()),10);$(".score-value",a).text(d+1);_agile.add_score(1,{success:function(e){$.extend(Contacts_Json[c],e)},error:function(e){}},c)});$(".subtract-score").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.score-scope");var c=$('input[name="email"]',a).val();var d=parseInt($.trim($(".score-value",a).text()),10);if(d>0){$(".score-value",a).text(d-1);_agile.add_score(-1,{success:function(e){$.extend(Contacts_Json[c],e)},error:function(e){}},c)}})});$(function(){$(".gadget-notes-tab").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.gadget-contact-details-tab").find(".show-form");$(".gadget-notes-tab-list",a).html("");var c=$(a).data("content");$(".tab-waiting",a).show();_agile.get_notes({success:function(d){head.js(LIB_PATH+"lib/date-formatter.js",LIB_PATH+"lib/jquery.timeago.js",function(){$(".tab-waiting",a).hide();$(".gadget-notes-tab-list",a).html(getTemplate("gadget-notes-list",d,"no"));agile_gadget_adjust_height();$("time",a).timeago()})},error:function(d){}},c)});$(".gadget-tasks-tab").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.gadget-contact-details-tab").find(".show-form");$(".gadget-tasks-tab-list",a).html("");var c=$(a).data("content");$(".tab-waiting",a).show();_agile.get_tasks({success:function(d){$(".tab-waiting",a).hide();$(".gadget-tasks-tab-list",a).html(getTemplate("gadget-tasks-list",d,"no"));$(".gadget-tasks-tab-list",a).show();agile_gadget_adjust_height();$("time",a).timeago()},error:function(d){}},c)});$(".gadget-deals-tab").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.gadget-contact-details-tab").find(".show-form");$(".gadget-deals-tab-list",a).html("");var c=$(a).data("content");$(".tab-waiting",a).show();_agile.get_deals({success:function(d){$(".tab-waiting",a).hide();$(".gadget-deals-tab-list",a).html(getTemplate("gadget-deals-list",d,"no"));$(".gadget-deals-tab-list",a).show();agile_gadget_adjust_height();$("time",a).timeago()},error:function(d){}},c)});$(".gadget-campaigns-tab").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.gadget-contact-details-tab").find(".show-form");$(".gadget-campaigns-tab-list",a).html("");var c=$(a).data("content");$(".tab-waiting",a).show();_agile.get_campaign_logs({success:function(d){$(".tab-waiting",a).hide();var e={};if(Is_Localhost){e.ac_path=LIB_PATH}else{e.ac_path="https://"+agile_id.namespace+".agilecrm.com/"}e.lib_path=LIB_PATH;e.response=d;$(".gadget-campaigns-tab-list",a).html(getTemplate("gadget-campaigns-list",e,"no"));$(".gadget-campaigns-tab-list",a).show();agile_gadget_adjust_height();$("time",a).timeago()},error:function(d){}},c)})});$(function(){$("#contact_add_tags").die().live("click",function(d){d.preventDefault();var c=$(this).closest("div.add-tag");var b=[];var a={};var f={};b=agile_serialize_form($("#add_tags_form",c));$.each(b,function(e,g){if(g.name=="email"){f[g.name]=g.value}else{a[g.name]=g.value}});if(a.tags.length!=0){$("#add_tags_form",c).hide();$(".tag-waiting",c).show("fast");_agile.add_tag(a.tags,{success:function(e){$(".tag-waiting",c).hide();$.extend(Contacts_Json[f.email],e);agile_build_tag_ui($("#added_tags_ul",c),e);$(".toggle-tag",c).show("medium");agile_gadget_adjust_height()},error:function(e){}},f.email)}else{$("#add_tags_form",c).hide();$(".toggle-tag",c).show("medium")}});$(".remove-tag").die().live("click",function(c){c.preventDefault();var a=$(this).closest("div.add-tag");var d=$(a).find('#add_tags_form input[name="email"]').val();var b=$(this).prev().text();$(".toggle-tag",a).hide("fast",function(){$(".tag-waiting",a).show()});_agile.remove_tag(b,{success:function(e){$(".tag-waiting",a).hide();$.extend(Contacts_Json[d],e);agile_build_tag_ui($("#added_tags_ul",a),e);$(".toggle-tag",a).show("medium");agile_gadget_adjust_height()},error:function(e){}},d)});$(".toggle-tag").die().live("click",function(b){b.preventDefault();var a=$(this).closest("div.add-tag");$(".toggle-tag",a).hide("fast",function(){$("#add_tags_form",a).show();$('form input[name="tags"]',a).val("").focus();agile_gadget_adjust_height()})});$("#tags").die().live("keypress",function(b){var b=(b)?b:((Event)?Event:null);var a=(b.target)?b.target:((b.srcElement)?b.srcElement:null);if(b.keyCode===13){b.preventDefault();$(this).next().trigger("click")}})});