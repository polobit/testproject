$(function(){Twilio_PLUGIN_NAME="Twilio";TWILIO_LOGS_LOAD_IMAGE='<center><img id="logs_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';var a=agile_crm_get_widget(Twilio_PLUGIN_NAME);console.log("In Twilio");console.log(a);Numbers=agile_crm_get_contact_properties_list("phone");console.log(Numbers);Twilio_Plugin_Id=a.id;console.log("Plugin prefs in Twilio: "+a.prefs);if(a.prefs==undefined||a.prefs=="{}"){setupTwilioOAuth();return}var b=JSON.parse(a.prefs);console.log(b);checkTwilioNumbersAndGenerateToken(b);$("#twilio_verify").die().live("click",function(d){d.preventDefault();if(!isValidForm($("#twilio_call_form"))){return}var c=$("#twilio_from").val();console.log("Twilio verify from number: "+c);verifyNumberFromTwilio(c,function(e){$("#Twilio").html(getTemplate("twilio-verify",e))})});$("#twilio_proceed").die().live("click",function(d){d.preventDefault();var c=agile_crm_get_widget_prefs(Twilio_PLUGIN_NAME);console.log("check_twilio_prefs : "+c);if(!c.verificaton_status||c.verificaton_status=="success"){checkTwilioNumbersAndGenerateToken(c)}else{if(check_prefs.verificaton_status=="failure"){$("#Twilio").html(getTemplate("twilio-initial",{}))}}})});function setupTwilioOAuth(){$("#Twilio").html(TWILIO_LOGS_LOAD_IMAGE);console.log("In Twilio Auth");$("#Twilio").html('<div class="widget_content"><p style="border-bottom:none">Call your contacts directly using your Twilio account.</p><a id="twilio-connect-button" class="btn" href="https://www.twilio.com/authorize/CNf63bca035414be121d517a116066a5f8?state='+encodeURIComponent(window.location.href)+'" style="margin-bottom: 10px;">Link Your Twilio</a></div>')}function getOutgoingNumbers(a){queueGetRequest("widget_queue","/core/api/widgets/twilio/numbers/"+Twilio_Plugin_Id,"json",function(b){if(!b){return}console.log("In getting twilio numbers");console.log(b);if(a&&typeof(a)==="function"){a(b)}},function(b){$("#twilio_profile_load").remove();twilioError(Twilio_PLUGIN_NAME,b.responseText)})}function verifyNumberFromTwilio(a,b){$("#Twilio").html('<div class="widget_content">Verifying........</div>');$.getJSON("/core/api/widgets/twilio/verify/numbers/"+Twilio_Plugin_Id+"/"+a,function(c){console.log("Twilio verified_data "+c);if(!c){return}if(b&&typeof(b)==="function"){b(c)}}).error(function(d){var c=Math.floor((Math.random()*10)+1);setUpError(Twilio_PLUGIN_NAME,"widget-settings-error",d.responseText,window.location.protocol+"//"+window.location.host+"/#Twilio/twilio"+c)})}function checkTwilioNumbersAndGenerateToken(a){getOutgoingNumbers(function(b){console.log("Twilio outgoing numbers: "+b[0].PhoneNumber);if(!b[0].PhoneNumber){$("#Twilio").html(getTemplate("twilio-initial",{}));return}if(a.verification_status&&a.verification_status=="success"&&a.verified_number){checkTwilioPrefsAndGenerateToken(a,a.verified_number);return}checkTwilioPrefsAndGenerateToken(a,b[0].PhoneNumber)})}function checkTwilioPrefsAndGenerateToken(a,b){if(a.account_sid){if(!a.app_sid){createApplicationInTwilio(function(c){a.app_sid=c;agile_crm_save_widget_prefs(Twilio_PLUGIN_NAME,JSON.stringify(a),function(d){checkTwilioPrefsAndGenerateToken(a,b)})});return}generateTokenInTwilio(b,function(c){showTwilioDetails(c,b);return})}}function createApplicationInTwilio(a){$.get("/core/api/widgets/twilio/appsid/"+Twilio_Plugin_Id,function(b){console.log("Twilio app_sid: "+b);if(a&&typeof(a)==="function"){a(b)}}).error(function(b){twilioError(Twilio_PLUGIN_NAME,b.responseText)})}function generateTokenInTwilio(a,b){$.get("/core/api/widgets/twilio/token/"+Twilio_Plugin_Id,function(c){console.log("Twilio generated token : "+c);if(b&&typeof(b)==="function"){b(c)}}).error(function(c){twilioError(Twilio_PLUGIN_NAME,c.responseText)})}function showTwilioDetails(b,c){$("#Twilio").html(TWILIO_LOGS_LOAD_IMAGE);if(Numbers.length==0){twilioError(Twilio_PLUGIN_NAME,"There is no phone number associated with this contact. <a href='#contact-edit'>Add phone number</a>");return}var a={};a.to=Numbers;$("#Twilio").html(getTemplate("twilio-profile",a));setUpTwilio(b,c);$("#twilio_note").hide();getTwilioLogs(Numbers[0].value);$("#contact_number").die().live("change",function(d){var f=$("#contact_number").val();getTwilioLogs(f)})}function getTwilioLogs(a){$("#twilio-logs-panel").html(TWILIO_LOGS_LOAD_IMAGE);$.get("/core/api/widgets/twilio/call/logs/"+Twilio_Plugin_Id+"/"+a,function(b){console.log("In Twilio logs ");console.log(b);var c=$(getTemplate("twilio-logs",JSON.parse(b)));$("#twilio-logs-panel").html(c);head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",c).timeago()});addLogsToTimeLine($.parseJSON(b))}).error(function(b){$("#logs_load").remove();twilioError("twilio-logs-panel",b.responseText)})}function setUpTwilio(b,c){var a=$("#contact_number").val();head.js("https://static.twilio.com/libs/twiliojs/1.1/twilio.min.js",function(){Twilio.Device.setup(b);Twilio.Device.ready(function(){console.log("ready");$("#twilio_call").show()});Twilio.Device.connect(function(d){console.log("Twilio call is connected");console.log(d);console.log(d._status);if(d._status=="open"){$("#twilio_hangup").show();$("#twilio_call").hide()}});Twilio.Device.disconnect(function(d){console.log("Twilio call is disconnected");console.log(d);if(d._status=="closed"){a=$("#contact_number").val();console.log("Twilio Number in disconect: "+a);getTwilioLogs(a);$("#twilio_note").show();$("#twilio_hangup").hide();$("#twilio_call").show()}});Twilio.Device.offline(function(){console.log("Twilio went offline")});Twilio.Device.incoming(function(d){console.log(d.parameters.From);console.log(d._status);d.accept();if(d._status=="open"){$("#twilio_hangup").show();$("#twilio_call").hide()}});Twilio.Device.cancel(function(d){console.log(d.parameters.From);$("#twilio_hangup").hide();$("#twilio_call").show()});Twilio.Device.presence(function(d){console.log(d.from);console.log(d.available)});Twilio.Device.error(function(d){console.log("Twilio error");console.log(d);$("#twilio_hangup").hide();$("#twilio_call").show()});registerClickEvents(c)})}function registerClickEvents(c){var a;var b="false";$("#twilio_hangup").die().live("click",function(d){d.preventDefault();console.log("Twilio call hang up");a=$("#contact_number").val();console.log("Twilio Number in hang up: "+a);getTwilioLogs(a);Twilio.Device.disconnectAll();$("#twilio_hangup").hide();$("#twilio_call").show()});$("#record_sound_play").die().live("click",function(f){f.preventDefault();var d="https://api.twilio.com"+$(this).attr("sound_url");console.log("Twilio sound URL: "+d);play_sound(d,"true")});$("#twilio_call").die().live("click",function(g){g.preventDefault();a=$("#contact_number").val();b="false";$("#twilio-record-modal").remove();var d={};d.to=a;d.name=agile_crm_get_contact_property("first_name")+" "+agile_crm_get_contact_property("last_name");var f=$(getTemplate("twilio-record",d));$("#content").append(f);$("#twilio-record-modal").modal("show")});$(".enable-call").die().live("click",function(f){f.preventDefault();$("#twilio-record-modal").modal("hide");var d=$(this).attr("make_call");if(d=="no"){return}if($("#enable-record").is(":checked")){b="true"}console.log("In Twilio call: "+b);Twilio.Device.connect({from:c,PhoneNumber:a,record:b,Url:"https://agile-crm-cloud.appspot.com/backend/voice?record="+b})})}function getIncomingNumbers(a){$.get("/core/api/widgets/twilio/incoming/numbers/"+Twilio_Plugin_Id,function(b){if(a&&typeof(a)==="function"){a(b)}},"json").error(function(b){$("#twilio_profile_load").remove();twilioError(Twilio_PLUGIN_NAME,b.responseText)})}function twilioError(c,b){console.log("In Twilio error template");var a={};a.message=b;$("#"+c).html(getTemplate("twilio-error",a))}function addLogsToTimeLine(e){var a;for(var d=0;d<e.length;d++){if(e[d].call.Status=="no-answer"){a="Call unaswered - "+e[d].call.Duration+" s"}else{a="Duration "+e[d].call.Duration+" s"}var c=new Date(e[d].call.StartTime);var b={id:"twilio"+(e.length-d),name:a,body:c.toDateString()+" "+c.toLocaleTimeString(),title:"Call",created_time:Date.parse(e[d].call.StartTime)/1000,entity_type:"twilio"};add_entity_to_timeline(new BaseModel(b))}};