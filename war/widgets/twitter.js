$(function(){TWITTER_PLUGIN_NAME="Twitter";TWITTER_UPDATE_LOAD_IMAGE='<div id="tweet_load"><center><img  src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center></div>';Twitter_current_profile_user_name="";Twitter_current_update_id="";Twitter_current_profile_screen_name="";console.log(a);console.log(b);var a=undefined;var b=undefined;search_string=undefined;search_data=undefined;Twitter_search_details={};web_url="";Twitter_id="";var c=agile_crm_get_widget(TWITTER_PLUGIN_NAME);console.log("In Twitter");console.log(a);console.log(b);console.log(c);Twitter_Plugin_Id=c.id;if(c.prefs==undefined){setupTwitterOAuth();return}web_url=agile_crm_get_contact_property_by_subtype("website","TWITTER");console.log(web_url);if(web_url){getTwitterIdByUrl(web_url,function(d){Twitter_id=d;showTwitterProfile(Twitter_id)})}else{getTwitterMatchingProfiles()}$("#Twitter_plugin_delete").die().live("click",function(d){d.preventDefault();agile_crm_delete_contact_property_by_subtype("website","TWITTER",web_url,function(e){console.log("In twitter delete callback");getTwitterMatchingProfiles()})});$("#twitter_message").die().live("click",function(d){d.preventDefault();sendTwitterMessage(Twitter_id)});$("#twitter_follow").die().live("click",function(d){d.preventDefault();if($(this).attr("disabled")){return}sendFollowRequest(Twitter_id)});$("#twitter_unfollow").die().live("click",function(d){d.preventDefault();sendUnfollowRequest(Twitter_id)});$("#twitter_unfollow").live("mouseenter",function(){$("#twitter_unfollow").text("Unfollow");$("#twitter_unfollow").addClass("btn-danger");$("#twitter_unfollow").removeClass("btn-primary")});$("#twitter_unfollow").live("mouseleave",function(){$("#twitter_unfollow").text("Following");$("#twitter_unfollow").addClass("btn-primary");$("#twitter_unfollow").removeClass("btn-danger")});$(".twitter_retweet").die().live("click",function(f){f.preventDefault();var d=$(this).attr("id");console.log(d);retweetTheTweet(d,"optional",this)});$("#twitter_tweet").die().live("click",function(d){d.preventDefault();tweetInTwitter(Twitter_id)});$(".twitter_modify_search").die().live("click",function(d){d.preventDefault();Twitter_search_details.plugin_id=Twitter_Plugin_Id;$("#Twitter").html(getTemplate("twitter-modified-search",Twitter_search_details))});$("#twitter_search_btn").die().live("click",function(d){d.preventDefault();getModifiedTwitterMatchingProfiles()});$("#twitter_search_close").die().live("click",function(d){d.preventDefault();if(search_data){showTwitterMatchingProfiles(search_data)}else{getTwitterMatchingProfiles()}});$("#twitter_followers").die().live("click",function(d){d.preventDefault();if(a&&a.length!=0){return}console.log("In twit folowers");console.log(a);a=[];$("#twitter_follower_panel").html(TWITTER_UPDATE_LOAD_IMAGE);getFollowerIdsInTwitter(Twitter_id,function(f){a=f;console.log(f);if(f.length==0){$("#twitter_follower_panel").html(Twitter_current_profile_user_name+" doesn't have any followers yet");return}var e=a.splice(0,20);console.log(e);getListOfProfilesByIDsinTwitter(e,function(g){$("#twitter_follower_panel").html(getTemplate("twitter-follower-following",g));$(".twitterImage").die().live("mouseover",function(){var h=$(this).attr("id");$("#"+h).popover({placement:"left"});$("#"+h).popover("show")})},function(g){a=undefined;$("#tweet_load").remove();tweetError("follower-error-panel",g.responseText)})})});$("#more_followers").die().live("click",function(e){e.preventDefault();if(!a){return}$("#spinner-followers").show();console.log(a);var d=a.splice(0,20);console.log(d);getListOfProfilesByIDsinTwitter(d,function(f){$("#spinner-followers").hide();$("#twitter_follower_panel").append(getTemplate("twitter-follower-following",f))},function(f){$("#spinner-followers").hide();tweetError("follower-error-panel",f.responseText)})});$("#twitter_following").die().live("click",function(d){d.preventDefault();if(b&&b.length!=0){return}b=[];$("#twitter_following_panel").html(TWITTER_UPDATE_LOAD_IMAGE);getFollowingIdsInTwitter(Twitter_id,function(f){b=f;console.log(f.length);if(f.length==0){$("#twitter_following_panel").html(Twitter_current_profile_user_name+" isn't following anyone yet");return}var e=b.splice(0,20);console.log(e);getListOfProfilesByIDsinTwitter(e,function(g){$("#twitter_following_panel").html(getTemplate("twitter-follower-following",g));$(".twitterImage").die().live("mouseover",function(){var h=$(this).attr("id");$("#"+h).popover({placement:"left"});$("#"+h).popover("show")})},function(g){b=undefined;$("#tweet_load").remove();tweetError("following-error-panel",g.responseText)})})});$("#more_following").die().live("click",function(e){e.preventDefault();if(!b){return}$("#spinner-following").show();var d=b.splice(0,20);console.log(d);getListOfProfilesByIDsinTwitter(d,function(f){$("#spinner-following").hide();$("#twitter_following_panel").append(getTemplate("twitter-follower-following",f))},function(f){$("#spinner-following").hide();tweetError("following-error-panel",f.responseText)})})});function setupTwitterOAuth(){$("#Twitter").html(TWITTER_UPDATE_LOAD_IMAGE);var a=window.location.href;var b="/scribe?service=twitter&return_url="+encodeURIComponent(a)+"&plugin_id="+encodeURIComponent(Twitter_Plugin_Id);$("#Twitter").html("<div class='widget_content' style='border-bottom:none;line-height: 160%;' >Engage with contacts in real time based on what they tweet.<p style='margin: 10px 0px 5px 0px;'><a class='btn' href=\""+b+"\" style='text-decoration:none;'>Link Your Twitter</a></p></div>")}function showTwitterMatchingProfiles(d){var c=agile_crm_get_contact_property("image");if(search_string){Twitter_search_details.keywords=search_string}else{var a="";if(agile_crm_get_contact_property("first_name")){a=a+agile_crm_get_contact_property("first_name")}if(agile_crm_get_contact_property("last_name")){a=a+" "+agile_crm_get_contact_property("last_name")}Twitter_search_details.keywords=a.trim()}if(d.length==0){if(Twitter_search_details.keywords&&Twitter_search_details.keywords!=""){twitterMainError(TWITTER_PLUGIN_NAME,"<p class='a-dotted' style='margin-bottom:0px;'>No matches found for <a href='#' class='twitter_modify_search'>"+Twitter_search_details.keywords+"</a>",true)}else{twitterMainError(TWITTER_PLUGIN_NAME,"<p class='a-dotted' style='margin-bottom:0px;'>No matches found. <a href='#' class='twitter_modify_search'>Modify search</a>",true)}return}var b;if(Twitter_search_details.keywords&&Twitter_search_details.keywords!=""){b="<div style='padding:10px'><p class='a-dotted'>Search results for <a href='#' class='twitter_modify_search'>"+Twitter_search_details.keywords+"</a></p>"}else{b="<div style='padding:10px'><p class='a-dotted'>Search results. <a href='#' class='twitter_modify_search'>Modify search</a></p>"}b=b.concat(getTemplate("twitter-search-result",d));b=b+"</div>";$("#Twitter").html(b);$(".twitterImage").die().live("mouseover",function(){Twitter_id=$(this).attr("id");$(this).popover({placement:"left"});$(this).popover("show");$("#"+Twitter_id).die().live("click",function(j){j.preventDefault();$(this).popover("hide");console.log("on click in search");var g="@"+$(this).attr("screen_name");web_url=g;console.log(g);var i=[{name:"website",value:g,subtype:"TWITTER"}];if(!c){var h=$(this).attr("src");i.push({name:"image",value:h})}if(!agile_crm_get_contact_property("title")){var f=$(this).attr("summary");i.push({name:"title",value:f})}console.log(i);agile_crm_update_contact_properties(i);showTwitterProfile(Twitter_id)})})}function getTwitterMatchingProfiles(){$("#Twitter").html(TWITTER_UPDATE_LOAD_IMAGE);var c=agile_crm_get_contact()["id"];var b=localStorage.getItem("Agile_twitter_matches_"+c);if(!b){queueGetRequest("widget_queue","core/api/widgets/social/match/"+Twitter_Plugin_Id+"/"+c,"json",function d(e){localStorage.setItem("Agile_twitter_matches_"+c,JSON.stringify(e));showTwitterMatchingProfiles(e)},function a(e){$("#tweet_load").remove();twitterMainError(TWITTER_PLUGIN_NAME,e.responseText)})}else{showTwitterMatchingProfiles(JSON.parse(b))}}function getModifiedTwitterMatchingProfiles(){if(!isValidForm($("#twitter-search_form"))){return}$("#spinner-twitter-search").show();search_string=$("#twitter_keywords").val();$.get("core/api/widgets/social/modified/match/twitter/"+Twitter_Plugin_Id+"/"+search_string,function(a){$("#spinner-twitter-search").hide();search_data=a;showTwitterMatchingProfiles(a)},"json").error(function(a){$("#spinner-twitter-search").remove();twitterMainError(TWITTER_PLUGIN_NAME,a.responseText)})}function getTwitterIdByUrl(a,d){var c;console.log("Twitter given URL "+a);getProperURL(a,function(e){c=e});console.log("Twitter URL "+c);var b={};b.web_url=c;fetchTwitterIdFromUrl(b,function(e){if(!e){alert("URL provided for Twitter is not valid ");getTwitterMatchingProfiles();agile_crm_delete_contact_property_by_subtype("website","TWITTER",a);return}if(d&&typeof(d)==="function"){d(e)}},function(f){var e="Sorry, that page doesn't exist!";console.log(f.responseText.substring(0,e.length));if(f.responseText.substring(0,e.length)===e){alert(f.responseText);console.log("Twitter URL "+a);agile_crm_delete_contact_property_by_subtype("website","TWITTER",a.toString());return}twitterMainError(TWITTER_PLUGIN_NAME,f.responseText)})}function getProperURL(a,c){var b;if(a.indexOf("https://twitter.com/")==-1&&a.indexOf("http://twitter.com/")==-1){if(a.indexOf("@")==0){b="https://twitter.com/"+a.substring(1)}else{b="https://twitter.com/"+a}}else{if(a.indexOf("http://twitter.com/")!=-1){b=a.replace("http://twitter.com/","https://twitter.com/")}else{b=a}}if(c&&typeof(c)==="function"){c(b)}}function fetchTwitterIdFromUrl(c,a,b){queuePostRequest("widget_queue","/core/api/widgets/social/getidbyurl/"+Twitter_Plugin_Id,c,function(d){if(a&&typeof(a)==="function"){a(d)}},function(d){if(b&&typeof(b)==="function"){b(d)}})}function showTwitterProfile(a){$("#Twitter").html(TWITTER_UPDATE_LOAD_IMAGE);var b;var c;$.get("/core/api/widgets/social/profile/"+Twitter_Plugin_Id+"/"+a,function(e){if(!e){return}$("#Twitter_plugin_delete").show();Twitter_current_profile_user_name=e.name;Twitter_current_profile_screen_name=e.screen_name;b=e.is_connected;Twitter_current_update_id=e.current_update_id;$("#Twitter").html(getTemplate("twitter-profile",e));if(e.is_connected){$("#twitter_unfollow").show()}else{if(!e.is_follow_request_sent){$("#twitter_follow").show()}else{$("#twitter_follow").text("Follow Request Sent").attr("disabled","disabled").show()}}if(e.updateStream&&e.updateStream.length!=0){$("#twitter_refresh_stream").show();c=e.updateStream;var d=$(getTemplate("twitter-update-stream",e.updateStream));head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",d).timeago()});$("#twitter_social_stream").append(d);return}$("#twitter_current_activity").show()},"json").error(function(d){$("#tweet_load").remove();twitterMainError(TWITTER_PLUGIN_NAME,d.responseText)});registerClickEventsInTwitter(a,b,c)}function registerClickEventsInTwitter(a,b,c){$(".twitter_stream").die().live("click",function(g){g.preventDefault();var d=$("ul#twitter_social_stream").find("li#twitter_status:last").attr("status_id");console.log(d);if(!Twitter_current_update_id){return}if(!d){if(b){tweetError("tweet-error-panel","This member doesn't share his/her tweets");return}tweetError("tweet-error-panel","Member does not share his/her tweets. Follow him/her and try");return}$("#spinner-tweets").show();var f=this;$(this).removeClass("twitter_stream");anyFiveNetworkUpdates(a,d,c,f)});$("#twitter_less").die().live("click",function(d){d.preventDefault();if($(this).attr("less")=="true"){$(this).attr("less","false");if($("ul#twitter_social_stream").find("div#twitter_update").length!=0){$("#twitter_current_activity").hide()}$(this).text("Show Less..");$("#twitter_refresh_stream").show()}else{$(this).attr("less","true");$(this).text("Show More..");$("#twitter_current_activity").show();$("#twitter_refresh_stream").hide()}});$("#twitter_refresh_stream").die().live("click",function(d){d.preventDefault();$("#twitter_social_stream").html(TWITTER_UPDATE_LOAD_IMAGE);allNetworkUpdates(a,c)})}function anyFiveNetworkUpdates(a,c,d,b){$.getJSON("/core/api/widgets/social/updates/more/"+Twitter_Plugin_Id+"/"+a+"/"+c+"/5",function(e){$("#spinner-tweets").hide();$(b).addClass("twitter_stream");$("#twitter_refresh_stream").show();if(e.length==0){tweetError("tweet-error-panel","No more updates available");if(d.length>3){$("#twitter_stream").hide();$("#twitter_less").show()}return}$("#twitter_social_stream").append(getTemplate("twitter-update-stream",e));$(".time-ago",$("#twitter_social_stream")).timeago();$("#twitter_current_activity").hide()}).error(function(e){$("#spinner-tweets").hide();$(b).addClass("twitter_stream");tweetError("tweet-error-panel",e.responseText)})}function getFirstFiveNetworkUpdates(a){$.getJSON("/core/api/widgets/social/updates/more/"+Twitter_Plugin_Id+"/"+a+"/"+Twitter_current_update_id+"/5",function(b){$("#twitter_social_stream").html(getTemplate("twitter-update-stream",b));$("#twitter_current_activity").hide();$("#twitter_refresh_stream").show();$(".time-ago",$("#twitter_social_stream")).timeago();if(b.length==0){$("#twitter_stream").hide();$("#twitter_current_activity").show();$("#twitter_less").show();return}}).error(function(b){$("#twitter_refresh_stream").show();tweetError("twitter-error-panel",b.responseText)})}function allNetworkUpdates(a,b){$.getJSON("/core/api/widgets/social/updates/"+Twitter_Plugin_Id+"/"+a,function(c){$("#tweet_load").remove();$("#twitter_social_stream").html(getTemplate("twitter-update-stream",c));$(".time-ago",$("#twitter_social_stream")).timeago();if(c.length==0){$("#twitter_stream").hide();$("#twitter_less").show();return}$("#twitter_stream").show();$("#twitter_less").hide();$("#twitter_current_activity").hide()}).error(function(c){$("#tweet_load").remove();$("#twitter_stream").show();$("#twitter_less").hide();if(b&&b.length!=0){$("#twitter_social_stream").html(getTemplate("twitter-update-stream",b))}$(".time-ago",$("#twitter_social_stream")).timeago();tweetError("tweet-error-panel",c.responseText)})}function sendFollowRequest(a){$.post("/core/api/widgets/social/connect/"+Twitter_Plugin_Id+"/"+a,function(b){if(b=="true"){$("#twitter_follow").hide();$("#twitter_unfollow").show()}else{$("#twitter_follow").text("Follow Request Sent").attr("disabled","disabled").show();return}if(!Twitter_current_update_id){return}getFirstFiveNetworkUpdates(a)}).error(function(b){if(b.responseText.indexOf("401:Authentication credentials")!=0){b.responseText="Only confirmed followers have access to "+Twitter_current_profile_user_name+' Tweets and complete profile. Click the "Follow" button to send a follow request.'}tweetError("twitter-error-panel",b.responseText)})}function sendUnfollowRequest(a){$.get("/core/api/widgets/social/disconnect/"+Twitter_Plugin_Id+"/"+a,function(b){$("#twitter_follow").show();$("#twitter_unfollow").hide()}).error(function(b){tweetError("twitter-error-panel",b.responseText)})}function sendTwitterMessage(a,c){var b={};b.headline="Direct Message";b.info="Send message to "+Twitter_current_profile_user_name.toUpperCase()+" on Twitter";$("#twitter_messageModal").remove();var d=getTemplate("twitter-message",b);$("#content").append(d);$("#twitter_messageModal").on("shown",function(){head.js(LIB_PATH+"lib/bootstrap-limit.js",function(){$(".twit-message-limit").limit({maxChars:125,counter:"#twitter-counter"});$("#twitter_messageModal").find("#twit-message").focus()})});$("#twitter_messageModal").modal("show");$("#send_request").click(function(f){f.preventDefault();if(!isValidForm($("#twitter_messageForm"))){return}$(this).text("Saving..");sendRequest("/core/api/widgets/social/message/"+Twitter_Plugin_Id+"/"+a,"twitter_messageForm","twitter_messageModal")})}function tweetInTwitter(a){var b={};b.headline="Tweet";b.info="Tweet to "+Twitter_current_profile_user_name.toUpperCase()+" on Twitter";b.description="@"+Twitter_current_profile_screen_name;$("#twitter_messageModal").remove();var c=getTemplate("twitter-message",b);$("#content").append(c);$("#twitter_messageModal").on("shown",function(){head.js(LIB_PATH+"lib/bootstrap-limit.js",function(){$(".twit-tweet-limit").limit({maxChars:125,counter:"#twitter-counter"});$("#twitter_messageModal").find("#twit-tweet").focus()})});$("#twitter_messageModal").modal("show");$("#send_request").click(function(d){d.preventDefault();if(!isValidForm($("#twitter_messageForm"))){return}$(this).text("Saving..");sendRequest("/core/api/widgets/social/tweet/"+Twitter_Plugin_Id,"twitter_messageForm","twitter_messageModal")})}function sendRequest(b,c,a){$.post(b,$("#"+c).serialize(),function(d){setTimeout(function(){$("#"+a).modal("hide")},2000)}).error(function(d){$("#"+a).remove();tweetError("twitter-error-panel",d.responseText)})}function retweetTheTweet(a,c,b){$.get("/core/api/widgets/social/reshare/"+Twitter_Plugin_Id+"/"+a+"/"+c,function(d){$(b).css("color","green")}).error(function(d){tweetError("tweet-error-panel",d.responseText)})}function getFollowerIdsInTwitter(a,b){$.getJSON("/core/api/widgets/social/followers/"+Twitter_Plugin_Id+"/"+a,function(c){if(!c){return}if(b&&typeof(b)==="function"){b(c)}}).error(function(d){$("#tweet_load").remove();if(d.responseText.indexOf("401:Authentication credentials")!=-1){var c="Only confirmed followers have access to "+Twitter_current_profile_user_name+' Tweets, Followers, Following and complete profile. Click the "Follow" button to send a follow request.';twitterMainError("twitter_follower_panel",c,true);$("#twitter_follower_panel").css("padding","0px");return}tweetError("follower-error-panel",d.responseText)})}function getFollowingIdsInTwitter(a,b){$.getJSON("/core/api/widgets/social/following/"+Twitter_Plugin_Id+"/"+a,function(c){if(!c){return}if(b&&typeof(b)==="function"){b(c)}}).error(function(d){$("#tweet_load").remove();if(d.responseText.indexOf("401:Authentication credentials")!=-1){var c="Only confirmed followers have access to "+Twitter_current_profile_user_name+' Tweets, Followers, Following and complete profile. Click the "Follow" button to send a follow request.';twitterMainError("twitter_following_panel",c,true);$("#twitter_following_panel").css("padding","0px");return}tweetError("following-error-panel",d.responseText)})}function getListOfProfilesByIDsinTwitter(a,d,b){var c={};c.twitter_ids=JSON.stringify(a);$.post("/core/api/widgets/social/profile/list/"+Twitter_Plugin_Id,c,function(e){if(!e){$("#tweet_load").remove();return}if(d&&typeof(d)==="function"){d(e)}},"json").error(function(e){if(b&&typeof(b)==="function"){b(e)}})}function tweetError(c,b,a){twitterMainError(c,b,a);$("#"+c).show();$("#"+c).fadeOut(10000)}function twitterMainError(d,c,b){var a={};a.message=c;a.disable_check=b;$("#"+d).html(getTemplate("twitter-error-panel",a))};