$(function(){Stripe_PLUGIN_NAME="Stripe";STRIPE_PROFILE_LOAD_IMAGE='<center><img id="stripe_profile_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';var b=agile_crm_get_widget(Stripe_PLUGIN_NAME);console.log("In Stripe");console.log(b);Stripe_Plugin_Id=b.id;if(b.prefs==undefined){setupStripeOAuth();return}var a=JSON.parse(b.prefs);console.log(a);var c=a.stripe_field_name;if(!c){setUpStripeCustomField(a);return}showStripeProfile(c)});function setupStripeOAuth(){$("#Stripe").html(STRIPE_PROFILE_LOAD_IMAGE);var a=window.location.href;console.log("In Stripe OAuth");var b="/scribe?service=stripe&return_url="+encodeURIComponent(a)+"&plugin_id="+encodeURIComponent(Stripe_Plugin_Id);$("#Stripe").html('<div class="widget_content" style="border-bottom:none;line-height: 160%;">See the contact\'s subscriptions history and payments from your Stripe account.<p style="margin: 10px 0px 5px 0px;"></p><a class="btn" href='+b+">Link Your Stripe</a></div>")}function setUpStripeCustomField(a){$.get("/core/api/custom-fields/type/scope?scope=CONTACT&type=TEXT",function(b){a.custom_fields=b;$("#Stripe").html(getTemplate("stripe-custom-field",a))},"json").error(function(b){stripeError(Stripe_PLUGIN_NAME,b.responseText)});$("#save_stripe_name").die().live("click",function(b){b.preventDefault();var c=$("#stripe_custom_field_name").val();if(!c){return}a.stripe_field_name=c;agile_crm_save_widget_prefs(Stripe_PLUGIN_NAME,JSON.stringify(a),function(d){showStripeProfile(c)})})}function showStripeProfile(b){$("#Stripe").html(STRIPE_PROFILE_LOAD_IMAGE);var a=agile_crm_get_contact_property(b);console.log("Stripe customer id "+a);if(!a){$("#stripe_contact_id_save").die().live("click",function(c){c.preventDefault();if(!isValidForm($("#stripe_contact_id_form"))){return}a=$("#stripe_contact_id").val();agile_crm_save_contact_property(b,"",a,"CUSTOM");showStripeProfile(b);return});$("#Stripe").html("<div><form class='widget_content' style='border-bottom:none;' id='stripe_contact_id_form' name='stripe_contact_id_form' method='post'><fieldset><p>Please provide the Stripe customer id for this contact</p><div class='control-group' style='margin-bottom:0px'><div class='controls'><input type='text' class='required' name='stripe_contact_id' style='width:90%' id='stripe_contact_id' placeholder='Stripe customer id' onkeydown='if (event.keyCode == 13) { event.preventDefault(); }'></input></div></div><a href='#' class='btn' id='stripe_contact_id_save'>Save</a></fieldset></form></div>");return}getStripeProfile(a,function(d){var c=$(getTemplate("stripe-profile",d));head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",c).timeago()});$("#Stripe").html(c)})}function getStripeProfile(b,d){queueGetRequest("widget_queue","/core/api/widgets/stripe/"+Stripe_Plugin_Id+"/"+b,"json",function c(e){console.log("In Stripe profile");console.log(e);if(d&&typeof(d)==="function"){d(e)}},function a(e){stripeError(Stripe_PLUGIN_NAME,e.responseText)})}function stripeError(c,b){var a={};a.message=b;$("#"+c).html(getTemplate("stripe-error",a))};