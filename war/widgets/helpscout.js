$(function(){HELPSCOUT_PLUGIN_NAME="HelpScout";HELPSCOUT_UPDATE_LOAD_IMAGE='<center><img id="conv_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';var a=agile_crm_get_widget(HELPSCOUT_PLUGIN_NAME);console.log("In HelpScout");console.log(a);HelpScout_Plugin_Id=a.id;Email=agile_crm_get_contact_property("email");console.log("Email: "+Email);customerId=0;showHelpScoutMails();$("#add_conv").die().live("click",function(b){b.preventDefault();addTicketToHelpScout()})});function showHelpScoutMails(){$("#HelpScout").html(HELPSCOUT_UPDATE_LOAD_IMAGE);if(!Email){helpscoutError(HELPSCOUT_PLUGIN_NAME,"Please provide email for this contact");return}getMailsFromHelpScout(function(a){console.log("HelpScout profile : "+a);if(a.hasOwnProperty("message")){helpscoutError(HELPSCOUT_PLUGIN_NAME,a.message)}else{$("#HelpScout").html(getTemplate("helpscout-profile",a));customerId=a.id;showMailsInHelpScout(a.id)}})}function getMailsFromHelpScout(c){queueGetRequest("widget_queue","/core/api/widgets/helpscout/get/"+HelpScout_Plugin_Id+"/"+Email,"json",function b(d){if(c&&typeof(c)==="function"){c(d)}},function a(d){helpscoutError(HELPSCOUT_PLUGIN_NAME,d.responseText)})}function showMailsInHelpScout(b){$("#all_conv_panel").html(HELPSCOUT_UPDATE_LOAD_IMAGE);queueGetRequest("widget_queue","/core/api/widgets/helpscout/get/"+HelpScout_Plugin_Id+"/customer/"+b,"json",function c(d){$("#all_conv_panel").html(getTemplate("helpscout-conversation",d));head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago").timeago()})},function a(d){helpscoutError(HELPSCOUT_PLUGIN_NAME,d.responseText)})}function addTicketToHelpScout(){$("#add_conv").toggle();$("#helpscout_loading").toggle();var b={};b.headline="Add Conversation to HelpScout";b.info="Add Conversation in HelpScout";b.customerId=customerId;b.email=Email;$("#helpscout_messageModal").remove();queueGetRequest("widget_queue","/core/api/widgets/helpscout/get/createform/"+HelpScout_Plugin_Id,"json",function c(d){if(d.hasOwnProperty("mailboxes")){b.mailboxes=d.mailboxes;b.assignees=d.assignees;console.log(b);var e=getTemplate("helpscout-message",b);$("#content").append(e);$("#helpscout_messageModal").modal("show");$("#helpscout_messageModal input[type='radio']").live("click",function(){$("#helpscout_messageModal label.btn").toggleClass("active")});$("#add_conv").toggle();$("#helpscout_loading").toggle()}},function a(d){$("#add_conv").toggle();$("#helpscout_loading").hide();$("#helpscout_error").show();setTimeout(function(){$("#helpscout_error").hide()},2000)});$("#helpscout_send_request").die().live("click",function(d){d.preventDefault();console.log("subbmitting the HelpScout form");if(!isValidForm($("#helpscout_messageForm"))){return}sendRequestToHelpScout("/core/api/widgets/helpscout/add/"+HelpScout_Plugin_Id,"helpscout_messageForm","helpscout_messageModal","add-conv-error-panel")})}function sendRequestToHelpScout(c,d,a,b){$.post(c,$("#"+d).serialize(),function(e){$("#"+a).find("span.save-status").html("sent");setTimeout(function(){$("#"+a).modal("hide");showMailsInHelpScout(customerId)},2000)}).error(function(e){$("#"+a).remove();helpscoutStreamError(b,e.responseText)})}function helpscoutError(c,b){var a={};a.message=b;$("#"+c).html(getTemplate("helpscout-error",a))}function helpscoutStreamError(b,a){helpscoutError(b,a);$("#"+b).show();$("#"+b).fadeOut(10000)};