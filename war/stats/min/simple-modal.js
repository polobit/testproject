var SimpleModal=new Class({Implements:[Options],request:null,buttons:[],lightbox:{},options:{onAppend:Function,offsetTop:40,overlayColor:"#000000",draggable:true,keyEsc:true,overlayClick:true,closeButton:true,hideHeader:false,hideFooter:false,lightboxExcessWidth:40,lightboxExcessHeight:120,btn_ok:"OK",btn_cancel:"Cancel",template:'<div id="agile-crm-popup-copyright"><a rel="nofollow" href="https://www.agilecrm.com?{_UTM_SOURCE_}" target="_blank">powered by Agile</a></div><div class="simple-modal-header">             <h1>{_TITLE_}</h1>           </div>           <div class="simple-modal-body">             <div class="contents"></div>           </div>           <div class="simple-modal-footer"></div>'},initialize:function(a){this.setOptions(a)},show:function(a){if(!a){a={}}a.draw=a.draw==undefined?true:a.draw;if(a.draw){this._overlay("show")}switch(a.model){case"confirm":this.addButton(this.options.btn_ok,"simple_modal_btn primary btn-margin",function(){try{a.callback()}catch(d){}this.hide()});this.addButton(this.options.btn_cancel,"simple_modal_btn secondary");var c=this._drawWindow(a);this._addEscBehaviour();break;case"modal":var c=this._drawWindow(a);this._addEscBehaviour();break;case"modal-ajax":var c=this._drawWindow(a);this._loadContents({url:a.param.url||"",onRequestComplete:a.param.onRequestComplete||Function});break;case"lightbox":a.arrows=true;this.lightbox.element=a.lightbox.element;this.lightbox.group=a.lightbox.group;this.lightbox.order=a.lightbox.order;var c=this._drawWindow(a);this._loadContents({url:a.param.url||"",order:this.lightbox.order,draw:a.draw,onRequestComplete:a.param.onRequestComplete||Function});break;default:this.addButton(this.options.btn_ok,"simple_modal_btn primary");var c=this._drawWindow(a);this._addEscBehaviour();break}c.setStyles({width:this.options.width});if(this.options.hideHeader){c.addClass("hide-header")}if(this.options.hideFooter){c.addClass("hide-footer")}if(this.options.closeButton){this._addCloseButton()}else{this._addCloseButtonImage()}if(this.options.draggable){var b=c.getElement(".simple-modal-header");new Drag(c,{handle:b});b.setStyle("cursor","move");c.addClass("draggable")}this._display()},hide:function(){try{if(typeof(this.request)=="object"){this.request.cancel()}}catch(a){}this._overlay("hide");return},_drawWindow:function(b){var f;if(b.draw){f=new Element("div#simple-modal",{"class":"simple-modal"});f.inject($$("body")[0])}else{f=document.getElement("#simple-modal.simple-modal")}var d=b.contents();var g=document.createElement("iframe");g.onload=function(){var h=(g.contentDocument||g.contentWindow.document);h.write(d);g.height=g.contentWindow.document.body.scrollHeight+"px";g.width=g.contentWindow.document.body.scrollWidth+"px";console.log("height "+g.contentWindow.document.body.scrollHeight+" width "+g.contentWindow.document.body.scrollWidth);g.contentWindow.document.body.style.background="rgba(0,0,0,0)";g.frameBorder=0;g.scrolling="no"};var a=document.location.hostname;a=a.replace(/\./g,"-");var e="utm_source=powered-by&utm_medium=widget&utm_campaign="+a;var c=this._template(this.options.template,{_TITLE_:b.title||"Untitled",_UTM_SOURCE_:e});f.set("html",c);f.getElementsByClassName("contents")[0].appendChild(g);this._injectAllButtons();if(b.arrows){this._addArrows()}this.options.onAppend();return f},addButton:function(c,d,a){var b=new Element("a",{title:c,text:c,"class":d,events:{click:(a||this.hide).bind(this)}});this.buttons.push(b);return b},_injectAllButtons:function(){this.buttons.each(function(b,a){b.inject(document.id("simple-modal").getElement(".simple-modal-footer"))});return},_addCloseButton:function(){var a=new Element("a",{"class":"close",href:"#",html:"x"});a.inject(document.id("simple-modal"),"top");a.addEvent("click",function(b){if(b){b.stop()}this.hide()}.bind(this));return a},_addCloseButtonImage:function(){var a=new Element("a",{"class":"close",href:"#",html:"<img src = 'https://agilegrabbers.appspot.com/demo/x.png'>"});a.inject(document.id("simple-modal"),"top");a.addEvent("click",function(b){if(b){b.stop()}this.hide()}.bind(this));return a},_addArrows:function(){var b=new Element("a",{"class":"next-image",style:"display:none",href:"#",html:"&raquo;"});b.inject(document.id("simple-modal"),"top");b.addEvent("click",function(c){if(c){c.stop()}this._viewNextElement()}.bind(this));var a=new Element("a",{"class":"previous-image",style:"display:none",href:"#",html:"&laquo;"});a.inject(document.id("simple-modal"),"top");a.addEvent("click",function(c){if(c){c.stop()}this._viewPreviousElement()}.bind(this));this._setArrowsVisibility()},_viewNextElement:function(){var b=this._getElementsByGroup(this.lightbox.group);this.lightbox.order++;var a=b[this.lightbox.order];this.show({model:"lightbox",title:a.get("title"),draw:false,param:{url:a.get("href"),onRequestComplete:function(){}},lightbox:{element:a,group:this.lightbox.group,order:this.lightbox.order}})},_viewPreviousElement:function(){var b=this._getElementsByGroup(this.lightbox.group);this.lightbox.order--;var a=b[this.lightbox.order];this.show({model:"lightbox",title:a.get("title"),draw:false,param:{url:a.get("href"),onRequestComplete:function(){}},lightbox:{element:a,group:this.lightbox.group,order:this.lightbox.order}})},_setArrowsVisibility:function(){var b=document.getElement(".simple-modal a.previous-image");var a=document.getElement(".simple-modal a.next-image");var c=this.getTotalByGroup(this.lightbox.group);if(this.lightbox.order==0){b.setStyle("display","none")}else{b.setStyle("display","inline")}if(c>0&&this.lightbox.order<c-1){a.setStyle("display","inline")}else{a.setStyle("display","none")}},_getElementsByGroup:function(b){var a=$$("a").filter(function(c){return c.rel&&c.rel.contains("simplemodal["+b+"]")});return a},getTotalByGroup:function(a){return this._getElementsByGroup(a).length},_overlay:function(b){switch(b){case"show":this._overlay("hide");var c=new Element("div",{id:"simple-modal-overlay"});c.inject($$("body")[0]);c.setStyle("background-color",this.options.overlayColor);c.fade("hide").fade(this.options.overlayOpacity);if(this.options.overlayClick){c.addEvent("click",function(f){if(f){f.stop()}this.hide()}.bind(this))}this.__resize=this._display.bind(this);window.addEvent("resize",this.__resize);break;case"hide":window.removeEvent("resize",this._display);if(this.options.keyEsc){var a=Browser.name!="ie"?"keydown":"onkeydown";window.removeEvent(a,this._removeSM)}try{document.id("simple-modal-overlay").destroy()}catch(d){}try{document.id("simple-modal").destroy()}catch(d){}break}return},_loadContents:function(param){document.id("simple-modal").addClass("loading");var re=new RegExp(/([^\/\\]+)\.(jpg|png|gif)$/i);if(param.url.match(re)){document.id("simple-modal").addClass("hide-footer");document.id("simple-modal-overlay").removeEvents();var images=[param.url];new Asset.images(images,{onProgress:function(i){immagine=this},onComplete:function(){try{document.id("simple-modal").removeClass("loading");var content=document.id("simple-modal").getElement(".simple-modal-body");var padding=content.getStyle("padding").split(" ");var width=immagine.get("width").toInt();var height=immagine.get("height").toInt();var ns=this._scaleImage(width,height);width=ns.width;height=ns.height;var myFx1=new Fx.Tween(document.id("simple-modal"),{duration:"normal",transition:"sine:out",link:"cancel",property:"width"}).start(document.id("simple-modal").getCoordinates().width,width+padding[1].toInt()+padding[3].toInt()+document.id("simple-modal").getStyle("border-left-width").toInt()+document.id("simple-modal").getStyle("border-right-width").toInt());var myFx2=new Fx.Tween(content,{duration:"normal",transition:"sine:out",link:"cancel",property:"height"}).start(content.getCoordinates().height,height).chain(function(){immagine.inject(document.id("simple-modal").getElement(".contents").empty()).fade("hide").setStyles({width:width,height:height}).fade("in");this._display();this._addEscBehaviour()}.bind(this));var myFx3=new Fx.Tween(document.id("simple-modal"),{duration:"normal",transition:"sine:out",link:"cancel",property:"left"}).start(document.id("simple-modal").getCoordinates().left,(window.getCoordinates().width-width)/2)}catch(err){}}.bind(this)})}else{this.request=new Request.HTML({evalScripts:false,url:param.url,method:"get",onRequest:function(){},onSuccess:function(responseTree,responseElements,responseHTML,responseJavaScript){document.id("simple-modal").removeClass("loading");document.id("simple-modal").getElement(".contents").set("html",responseHTML);param.onRequestComplete();eval(responseJavaScript);this._display();this._addEscBehaviour()}.bind(this),onFailure:function(){document.id("simple-modal").removeClass("loading");document.id("simple-modal").getElement(".contents").set("html","loading failed")}}).send()}},_scaleImage:function(c,f){var d=this.options.lightboxExcessHeight+this.options.offsetTop;var i=this.options.lightboxExcessWidth;var e=c;var a=f;var g=window.getSize().x-i;var b=window.getSize().y-d;ratio=(e<=a)?a/b:e/g;ratio=Math.max(ratio,1);c=parseInt(e/ratio);f=parseInt(a/ratio);return{width:c,height:f}},_display:function(){try{document.id("simple-modal-overlay").setStyles({height:window.getCoordinates().height})}catch(b){}try{var a=this.options.offsetTop||0;document.id("simple-modal").setStyles({top:a,left:((window.getCoordinates().width-document.id("simple-modal").getCoordinates().width)/2)})}catch(b){}return},_addEscBehaviour:function(){if(this.options.keyEsc){this._removeSM=function(b){if(b.key=="esc"){this.hide()}}.bind(this);if(this.options.keyEsc){var a=Browser.name!="ie"?"keydown":"onkeydown";window.addEvent(a,this._removeSM)}}},_template:function(a,c){for(var b in c){a=a.replace(new RegExp("{"+b+"}","g"),c[b])}return a}});SimpleModal.autoload=function(){var c=$$("a").filter(function(d){return d.rel&&d.rel.test(/^simplemodal/i)});var b=[];var a=new SimpleModal();$$(c).each(function(f){var g=f.rel.replace(/[[]|]/gi," ");var e=g.split(" ");b[e[1]]=b[e[1]]==null?0:b[e[1]]+1;var d=b[e[1]];f.addEvent("click",function(h){h.stop();a.show({model:"lightbox",title:this.get("title"),param:{url:this.get("href"),onRequestComplete:function(){}},lightbox:{element:this,group:e[1],order:d}})})})};window.addEvent("domready",SimpleModal.autoload);