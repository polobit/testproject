var ACLRestriction = Backbone.Router.extend({
	routes : {

		/* Deals/Opportunity */
		"not-allowed" : "notAllowed",
		},	
		notAllowed : function(obj){

			getTemplate('not-allowed', obj, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

		}
});/**
 * calendar.js is a script file having a route to show calendar
 * 
 * @module Activities
 */
var ActivitylogRouter = Backbone.Router.extend({

    routes: {
        /* Shows page */
        "activities": "activities",
        "contact-activities": "contactActivities",
        "contact-activities/:type": "contactActivities"
    },

    activities: function(id) {
        if (!tight_acl.checkPermission('ACTIVITY'))
            return;

        head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION, function() {

            $('#content').html("<div id='activities-listners'>&nbsp;</div>");
            getTemplate('activity-list-header', {}, undefined, function(template_ui) {

                if (!template_ui)
                    return;

                getTracksCount(function(count) {

                    DEAL_TRACKS_COUNT = count;

                    $('#activities-listners').html($(template_ui));

                    initActivitiesDateRange();

                    renderActivityView(getActivityFilterParameters(true));
                    
                    $(".activity-log-button").hide();

                    var activityFilters = JSON.parse(readCookie(ACTIVITY_FILTER));

                    var optionsTemplate = "<li><a  href='{{id}}'>{{name}}</li>";

                    // fill workflows
                    fillSelect('user-select', 'core/api/users', 'domainuser', function fillActivities() {
                        $('#activities-listners').find("#user-select").append("<li><a href=''>All Users</a></li>");
                        if (activityFilters && (activityFilters.user || activityFilters.entity)) {
                            $('ul#user-select li a').closest("ul").data("selected_item", activityFilters.userId);
                            $('ul#entity_type li a').closest("ul").data("selected_item", activityFilters.entityId);
                            $('#selectedusername').html(activityFilters.user);
                            $('#selectedentity_type').html(activityFilters.entity);
                            $('.activity-sub-heading').html(activityFilters.entity);

                        }

                        $(".activity-log-button").show();


                    }, optionsTemplate, true);



                });

            }, "#activities-listners");

            $(".active").removeClass("active");
            $("#activitiesmenu").addClass("active");
        })
    },
    contactActivities: function(id) { // begin contact activities

            head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION, function() {


                getTemplate('contact-activity-header', {}, undefined, function(template_ui) {
                    if (!template_ui)
                        return;
                    $('#content').html($(template_ui));

                    var urlPath = "core/api/campaigns/logs/ContactActivities";

                    var keyword = "";
                    var uiKeyword = "";
                    switch (id) {
                        case "all":
                            keyword = "?log_type=All_Activities";
                            uiKeyword = "All Activities";
                            break;
                        case "page-views":
                            keyword = "?log_type=Page_Views";
                            uiKeyword = "Page Views";
                            break;
                        case "email-opens":
                            keyword = "?log_type=Email_Opened";
                            uiKeyword = "Email Opens";
                            break;
                        case "email-clicks":
                            keyword = "?log_type=Email_Clicked";
                            uiKeyword = "Email Clicks";
                            break;
                        case "unsubscriptions":
                            keyword = "?log_type=Unsubscribed";
                            uiKeyword = "Unsubscriptions";
                            break;
                        case "spam-reports":
                            keyword = "?log_type=Email_Spam";
                            uiKeyword = "Spam Reports";
                            break;
                        case "hard-bounces":
                            keyword = "?log_type=Email_Hard_Bounced";
                            uiKeyword = "Hard Bounces";
                            break;
                        case "soft-bounces":
                            keyword = "?log_type=Email_Soft_Bounced";
                            uiKeyword = "Soft Bounces";
                            break;
                        default:
                            keyword = "?log_type=All_Activities";
                            uiKeyword = "All Activities";
                    }

                    urlPath = urlPath + keyword;
                    if (id != undefined && id != "all")
                        $('.contact-activity-sub-heading').text(uiKeyword);
                    $('#log-filter-title').text(uiKeyword);

                    /*
                     * if(IS_FLUID){
                     * $('#contact_activity_header').removeClass('row').addClass('row-fluid');
                     * $('#contact_activity_model').removeClass('row').addClass('row-fluid'); }
                     * else{
                     * $('#contact_activity_header').removeClass('row-fluid').addClass('row');
                     * $('#contact_activity_model').removeClass('row-fluid').addClass('row'); }
                     */
                    var collectionList = new Base_Collection_View({
                        url: urlPath,
                        templateKey: 'contact-activity-list-log',
                        individual_tag_name: 'li',
                        cursor: true,
                        scroll_symbol: 'scroll',
                        page_size: 20,
                        sort_collection: false,
                        postRenderCallback: function(el) {
                            // initDateRangePicker("contact_activities_date_range",el);
                            head.js(LIB_PATH + 'lib/jquery.timeago.js', function() {
                                $("time", el).timeago();
                                console.log(id);

                            });

                        },
                        appendItemCallback: function(el) {
                            includeTimeAgo(el);
                        }
                    });
                    collectionList.appendItem = append_contact_activities_log;
                    collectionList.collection.fetch();

                    $('#contact-activity-list-based-condition').html(collectionList.render().el);

                    console.log("========contact activities ==========");


                }, "#content");

            });

        } // end contact activities

});email = null;
/**
 * Creates a backbone router to perform admin activities (account preferences,
 * users management, custom fields, milestones and etc..).
 * 
 */
var AdminPanelRouter = Backbone.Router.extend({

	routes : {

	// from adminpanel these routers will be effected
	"domainSubscribe" : "domainSubscribeDetails",

	"domainSubscribe/:id" : "domainSubscribeDetails",

	// from admin panel subscription for particular domain will be
	// done
	"purchase-plan-formAdminPanel" : "purchasePlanFromAdminpanel",

	/* All Domain Users */
	"all-domain-users" : "allDomainUsers",

	// change password
	"change-password-admin/:id" : "changePasswordadmin",

	// get domain details

	"getDomainUserDetails/:id" : "getDomainUserDetails",

	// search domain

	"domainSearch" : "domainSearch"

	},

	// function will be called from getDomainDetails Navigation
	// todisplay get domain stats object for particular domain

	get_account_stats_for_domain_from_adminpanel : function(el, domainname)
	{
		console.log("in accountstats object");
		console.log(domainname);
		$.ajax({ url : 'core/api/admin_panel/getdomainstats?d=' + domainname, type : 'GET', success : function(data)
		{
			console.log(data);

			var emails = data.emailcount;
			data.emailcount = JSON.parse(data.emailcount);
			getTemplate("domain-info", data, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$(el).find('#account').html($(template_ui));

			}, $(el).find('#account'));

			getTemplate("email-stats", JSON.parse(emails), undefined, function(template_ui){
				if(!template_ui)
					  return;
				$(el).find('#emailcount').html($(template_ui));
				$(".delete-namespace").attr("data", domainname);

			}, $(el).find('#emailcount'));

		}, error : function(response)
		{

			console.log(response);
		} });

	},

	// function will be called from getDomainDetails Navigation
	// todisplay get subscription object for particular domain
	get_customerobject_for_domain_from_adminpanel : function(el, domainname)
	{
		var that = this;

		$.ajax({ url : 'core/api/admin_panel/getcustomer?d=' + domainname, type : 'GET', success : function(data)
		{

			getTemplate("plan-info", data, undefined, function(template_ui){
				if(!template_ui)
					  return;

				$(el).find('#planinfo').html($(template_ui));

				if (data == null || data == "" || data == undefined)
				{

					$("#login_id").attr("href", "https://" + domainname + ".agilecrm.com/login");
				}

				else
					that.get_collection_of_charges_for_customer_from_adminpanel(el, data.id);

			}, $(el).find('#planinfo'));

			
		} });

	},

	// function will be called from getDomainDetails Navigation
	// to display get collection of invoices for particular domain

	get_collection_of_invoices_for_domain_from_adminpanel : function(el, domainname)
	{
		this.invoicecollection = new Base_Collection_View({ url : "core/api/admin_panel/getinvoices?d=" + domainname, templateKey : "admin-invoice",

		individual_tag_name : 'tr' });
		this.invoicecollection.collection.fetch();

		$('.past-invoicecollection', el).html(this.invoicecollection.render().el);
	},

	// gets collection of charges of aa paricular customer based on
	get_collection_of_charges_for_customer_from_adminpanel : function(el, customerid)
	{
		this.chargecollection = new Base_Collection_View({ url : "core/api/admin_panel/getcharges?d=" + customerid, templateKey : "admin-charge",

		individual_tag_name : 'tr', sortKey : 'createdtime', descending : true });
		this.chargecollection.collection.fetch();

		$('.past-chargecollection', el).html(this.chargecollection.render().el);
	},

	// router to fill domain details template from admin panel
	getDomainUserDetails : function(id)
	{
		 $('#content').html("<div id='admin-panel-listners'>&nbsp;</div>");
		var self = this;
		var domainname;
		this.usersListViewCollection = new Base_Collection_View({ url : 'core/api/admin_panel/getParticularDomainUsers?d=' + id, templateKey : "all-domain",
			individual_tag_name : 'tr', postRenderCallback : function(el)
			{
				head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
				{
					$(".last-login-time", el).timeago();
				});

				var mod_collection = self.usersListViewCollection.collection.models;

				domainname = mod_collection[0].get('domain');
				email = mod_collection[0].get('email');
				self.get_customerobject_for_domain_from_adminpanel(el, domainname);
				$('#account').html("<img src='img/21-0.gif'>");
				self.get_account_stats_for_domain_from_adminpanel(el, domainname);

				initializeAdminpanelListner(el);

			},

		});
		this.usersListViewCollection.collection.fetch();

		$('#admin-panel-listners').html(this.usersListViewCollection.el);

	},

	// used to change password for particular user from admin panel
	changePasswordadmin : function(id)
	{

		getTemplate("settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			getTemplate("settings-change-password-adminpanel", {}, undefined, function(template_ui){

						$('#content').html($(template_ui));	

						// Save button action of change password form, If it is out of
						// this router wont navigate properly
						$("#saveNewPasswordFromAdmin").on(
								"click",
								function(e)
								{

									e.preventDefault();
									var saveBtn = $(this);

									// Returns, if the save button has disabled
									// attribute
									if ($(saveBtn).attr('disabled'))
										return;

									// Disables save button to prevent multiple
									// click
									// event issues
									disable_save_button($(saveBtn));

									var form_id = $(this).closest('form').attr("id");

									if (!isValidForm('#' + form_id))
									{

										// Removes disabled attribute of save
										// button
										enable_save_button($(saveBtn));
										return false;
									}

									// Show loading symbol until model get saved
									$('#changePasswordForm').find('span.save-status').html(getRandomLoadingImg());

									var json = serializeForm(form_id);

									$.ajax({
										url : '/core/api/admin_panel/changepassword/' + id,
										type : 'PUT',
										data : json,
										success : function()
										{
											add_password_change_info_as_note_to_owner(email);
											Backbone.history.navigate("all-domain-users", { trigger : true });
											showNotyPopUp("information", "password changed successfully", "top");
										},
										error : function(response)
										{
											$('#changePasswordForm').find('span.save-status').html("");
											$('#changePasswordForm').find('input[name="current_pswd"]').closest(".controls").append(
													"<span style='color:red;margin-left:10px;'>Incorrect Password</span>");
											$('#changePasswordForm').find('input[name="current_pswd"]').closest(".controls").find("span").fadeOut(5000);
											$('#changePasswordForm').find('input[name="current_pswd"]').focus();
											enable_save_button($(saveBtn));
										} });

								});
			});

		}, "#content");
	
	},

	/**
	 * Creates a Model to show All Domain Users.
	 */
	allDomainUsers : function()
	{
		allDomainUsersCollectionView = new Base_Collection_View({ url : 'core/api/admin_panel/getAllDomainUsers', templateKey : "all-domain-users",
			individual_tag_name : 'tr', cursor : true, page_size : 25, postRenderCallback : function(el)
			{
				initializeAdminpanelListner(el);

			} });

		allDomainUsersCollectionView.collection.fetch();
		$('#content').html(allDomainUsersCollectionView.el);
	},

	// subscription
	domainSubscribeDetails : function(id)
	{
		$("#content").html("<div id='subscribe_plan_change'></div>");

		var subscribe_plan = new Base_Model_View({ url : "core/api/admin_panel/subscriptionofparticulardomain?d=" + id,
			template : "all-domain-admin-subscribe-new", window : 'domainSubscribe',
			/*
			 * postRenderCallback : function(el) { // Setup account statistics
			 * set_up_account_stats(el); // Load date and year for card expiry
			 * card_expiry(el); // Load countries and respective states
			 * head.js(LIB_PATH + 'lib/countries.js', function() {
			 * print_country($("#country", el)); }); },
			 */
			postRenderCallback : function(el)
			{
				var data = subscribe_plan.model.toJSON();
				initializeSubscriptionListeners(el);

				// console.log(data.get('billing_data_json_string'));

				// Setup account statistics
				set_up_account_stats(el);

				if (!$.isEmptyObject(data))
				{
					USER_BILLING_PREFS = data;
					USER_CREDIRCARD_DETAILS = subscribe_plan.model.toJSON().billingData;
					console.log(USER_CREDIRCARD_DETAILS);
					element = setPriceTemplete(data.plan.plan_type, el);
				}

				else
					element = setPriceTemplete("free", el);

				// Show Coupon code input field
				id = (id && id == "coupon") ? id : "";
				showCouponCodeContainer(id);
				$("#user_quantity",el).prop("value", data.plan.quantity);
				price = update_price();
				$("#users_quantity",el).text(data.plan.quantity);
				$("#users_total_cost",el).text((data.plan.quantity * price).toFixed(2));

				head.load(CSS_PATH + "css/misc/agile-plan-upgrade.css", LIB_PATH + 'lib/jquery.slider.min.js', function()
				{
					if ($.isEmptyObject(data))
						setPlan("free");
					else
						setPlan(data);
					// load_slider(el);
				});

				
			} });
		$('#subscribe_plan_change').html(subscribe_plan.render().el);
	},

	purchasePlanFromAdminpanel : function()
	{
		/*// If plan is not defined i.e., reloaded, or plan not chosen
		// properly,
		// then page is navigated back to subcription/ choose plan page
		if (!plan_json.plan)
		{
			this.navigate("all-domain-users", { trigger : true });

			return;
		}*/

		var window = this;
		// Plan json is posted along with credit card details
		var plan = plan_json

		var upgrade_plan = new Base_Model_View({ url : "core/api/admin_panel/upgradesubscription", template : "admin-purchase-plan", isNew : true, data : plan,
			postRenderCallback : function(el)
			{
				// Discount
				showCouponDiscountAmount(plan_json, el);

				card_expiry(el);
				head.js(LIB_PATH + 'lib/countries.js', function()
				{
					print_country($("#country", el));
				});
			}, saveCallback : function(data)
			{
				window.navigate("domainSubscribe/" + plan.domain_name, { trigger : true });
				add_plan_change_info_as_note_to_owner(email, plan.plan_type, plan.plan_id, plan.quantity);
				showNotyPopUp("information", "You have been upgraded successfully. Please logout and login again for the new changes to apply.", "top");
			}

		});

		// Prepend Loading
		$('#content').html(upgrade_plan.render().el);
		$(".active").removeClass("active");
		// $("#fat-menu").addClass("active");
	},

	domainSearch : function()
	{
		$("#content").html("<div id='domain-search-listners'></div>");
		getTemplate('all-domain-search', {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$("#domain-search-listners").html($(template_ui));
			initializeDomainsearchListner();
			hideTransitionBar();

		}, "#domain-search-listners");

	}
});/**
 * Creates a backbone router to perform admin activities (account preferences,
 * users management, custom fields, milestones and etc..).
 * 
 */
var view = {};
var AdminSettingsRouter = Backbone.Router.extend({
	routes : {
	/* Admin-Settings */
	"admin" : "adminSettings",

	/* Account preferences */
	"account-prefs" : "accountPrefs",

	/* Users */
	"users" : "users", "users-add" : "usersAdd", "user-edit/:id" : "userEdit",

	/* Custom fields */
	"custom-fields" : "customFields",

	/* Api & Analytics */
	"analytics-code" : "analyticsCode", "analytics-code/:id" : "analyticsCode",

	/* Milestones */
	"milestones" : "milestones",
	
	/* Categories */
	"categories" : "categories",

	/* Menu settings - select modules on menu bar */
	"menu-settings" : "menu_settings",

	/* Mandrill Email Activity */
	/* "email-stats" : "emailStats", */

	/* Integrations Stats */
	"integrations-stats" : "integrationsStats",

	/* Web to Lead */
	"integrations" : "integrations",

	"tag-management" : "tagManagement",

	"email-gateways/:id" : "emailGateways",

	"sms-gateways/:id" : "smsGateways",

	"lost-reasons" : "lostReasons",

	"deal-sources" : "dealSources"


	},

	/**
	 * Show menu-settings modules selection ( calendar, cases, deals, campaign ) &
	 * saving option
	 * 
	 * @author Chandan
	 */
	menu_settings : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}

		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$('#content').html($(template_ui));	

			var view = new Base_Model_View({ url : '/core/api/menusetting', template : "admin-settings-menu-settings", reload : true });
			$('#content').find('#admin-prefs-tabs-content').html(view.render().el);
			$('#content').find('#AdminPrefsTab .select').removeClass('select');
			$('#content').find('.menu-settings-tab').addClass('select');

		}, "#content");

		$(".active").removeClass("active");
	},

	/**
	 * Loads a template to show account preferences, with "subscription" option
	 * to change the plan
	 */
	accountPrefs : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}
		
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	
			var view = new Base_Model_View({ url : '/core/api/account-prefs', template : "admin-settings-account-prefs", postRenderCallback : function()
			{
				ACCOUNT_DELETE_REASON_JSON = undefined;
			} });

			$('#content').find('#admin-prefs-tabs-content').html(view.render().el);
			$('#content').find('#AdminPrefsTab .select').removeClass('select');
			$('#content').find('.account-prefs-tab').addClass('select');
			$(".active").removeClass("active");

		}, "#content");

		
		
	},

	/**
	 * Shows list of all the users with an option to add new user
	 */
	users : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		} 

		var that = this;
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			that.usersListView = new Base_Collection_View({ url : '/core/api/users', restKey : "domainUser", templateKey : "admin-settings-users",
			individual_tag_name : 'tr', postRenderCallback : function(el)
			{

				head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
				{
					$(".last-login-time", el).timeago();
				});
			} });
			that.usersListView.collection.fetch();

			$('#content').find('#admin-prefs-tabs-content').html(that.usersListView.el);
			$('#content').find('#AdminPrefsTab .select').removeClass('select');
			$('#content').find('.users-tab').addClass('select');
			$(".active").removeClass("active");

		}, "#content");

	},

	/**
	 * Loads a template to add new user, navigates to users list on adding a
	 * user
	 */
	usersAdd : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}

		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			var view = new Base_Model_View({ url : 'core/api/users', template : "admin-settings-user-add", isNew : true, window : 'users', reload : false,
			postRenderCallback : function(el)
			{

				if (view.model.get("id"))
					addTagAgile("User invited");

				// Binds action
				bindAdminChangeAction(el, view.model.toJSON());
			}, saveCallback : function(response)
			{
				$.getJSON("core/api/users/current-owner", function(data)
				{
					if (data)
					{
						data["created_user_email"] = response.email;

						add_created_user_info_as_note_to_owner(data);
					}
				});
			} });

			$('#content').find('#admin-prefs-tabs-content').html(view.render().el);
			$('#content').find('#AdminPrefsTab .select').removeClass('select');
			$('#content').find('.users-tab').addClass('select');
			$(".active").removeClass("active");

		}, "#content");

		

	},

	/**
	 * Loads a template to add new user, to a particular domain user
	 */

	/**
	 * Edits the existing user by verifying whether the users list view is
	 * defined or not
	 */
	userEdit : function(id)
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}
		var that = this;
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			// If users list is not defined then take back to users template
			if (!that.usersListView || !that.usersListView.collection.get(id))
			{
				that.navigate("users", { trigger : true });
				return;
			}

			// Gets user from the collection based on id
			var user = that.usersListView.collection.get(id);

			var needLogout = false;
			if (CURRENT_DOMAIN_USER.email == user.attributes.email)
			{
				needLogout = true;
			}

			/*
			 * Creates a Model for users edit, navigates back to 'user' window on
			 * save success
			 */
			var view = new Base_Model_View({ url : 'core/api/users', model : user, template : "admin-settings-user-add", saveCallback : function(response)
			{
				// If user changed his own email, redirect it to the login page.
				if (needLogout && CURRENT_DOMAIN_USER.email != response.email)
				{
					console.log('Logging out...');
					showNotyPopUp("information", "You Email has been updated successfully. Logging out...", "top");
					var hash = window.location.hash;
					setTimeout(function()
					{
						window.location.href = window.location.protocol + "//" + window.location.host + "/login" + hash;
					}, 5000);
				}
				else
				{
					Backbone.history.navigate('users', { trigger : true });
				}

			}, postRenderCallback : function(el)
			{

				bindAdminChangeAction(el, view.model.toJSON());
			} });

			$('#content').find('#admin-prefs-tabs-content').html(view.render().el);
			$('#content').find('#AdminPrefsTab .select').removeClass('select');
			$('#content').find('.users-tab').addClass('select');
			$(".active").removeClass("active");

		}, "#content");

		

	},

	/**
	 * Shows list of custom fields with an option to add new custom field of
	 * desired type
	 * 
	 */
	/**
	 * Shows list of custom fields with an option to add new custom field of
	 * desired type
	 * 
	 */
	customFields : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}
		var that = this;
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			that.customFieldsListView = new Base_Collection_View({ url : '/core/api/custom-fields/allScopes', restKey : "customFieldDefs",
			templateKey : "admin-settings-customfields", individual_tag_name : 'tr', postRenderCallback : function(el)
			{
				initializeCustomFieldsListeners();

			} });

			that.customFieldsListView.appendItem = groupingCustomFields;

			that.customFieldsListView.collection.fetch();

			$('#content').find('#admin-prefs-tabs-content').html(that.customFieldsListView.el);
			$('#content').find('#AdminPrefsTab .select').removeClass('select');
			$('#content').find('.custom-fields-tab').addClass('select');
			$(".active").removeClass("active");

		}, "#content");

		
	},

	/**
	 * Loads java-script API to make the user able to track page views on users
	 * site, add/delete contacts from users website or blog directly. Loads
	 * minified prettify.js to prettify analytics code.
	 */
	analyticsCode : function(id)
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}

		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			head.js(LIB_PATH + 'lib/prettify-min.js', function()
			{
				var view = new Base_Model_View({ url : '/core/api/api-key', template : "admin-settings-api-key-model", postRenderCallback : function(el)
				{

					
					$('#content').find('#admin-prefs-tabs-content').html(view.el);

					$('#content').find('#AdminPrefsTab .select').removeClass('select');
					$('#content').find('.analytics-code-tab').addClass('select');
					// prettyPrint();
					if (id)
					{
						$(el).find('#APITab a[href="#' + id + '"]').trigger('click');
					}

					// initZeroClipboard("api_track_webrules_code_icon",
					// "api_track_webrules_code");
					// initZeroClipboard("api_key_code_icon", "api_key_code");
					// initZeroClipboard("api_track_code_icon", "api_track_code");

					try
					{
						if (ACCOUNT_PREFS.plan.plan_type.split("_")[0] == "PRO")
							$("#tracking-webrules, .tracking-webrules-tab").hide();
						else
							$("#tracking-webrules-whitelist, .tracking-webrules-whitelist-tab").hide();
					}
					catch (e)
					{
						$("#tracking-webrules-whitelist, .tracking-webrules-whitelist-tab").hide();
					}

					prettify_api_add_events();
					// initializeRegenerateKeysListeners();

				} });
			});

		}, "#content");

		
	},

	/**
	 * Shows API-KEY. Loads minified prettify.js to prettify the view
	 */
	api : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");
			return;
		}

		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			head.js(LIB_PATH + 'lib/prettify-min.js', function()
			{
				var view = new Base_Model_View({ url : '/core/api/api-key', template : "admin-settings-api-model", postRenderCallback : function(el)
				{

					initializeRegenerateKeysListeners();
					prettyPrint();
				} });
				$('#content').find('#admin-prefs-tabs-content').html(view.el);
				$('#content').find('#AdminPrefsTab .select').removeClass('select');
				$('#content').find('.analytics-code-tab').addClass('select');
				$(".active").removeClass("active");
			});
		}, "#content");

		
	},

	/**
	 * Creates a Model to show and edit milestones, reloads the page on save
	 * success
	 */
	milestones : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}
		
		var that = this;
		$('#content').html("<div id='milestone-listner'>&nbsp;</div>");
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#milestone-listner').html($(template_ui));
			$('#milestone-listner').find('#admin-prefs-tabs-content').html(getTemplate("settings-milestones-tab"), {});

			that.pipelineGridView = new Base_Collection_View({ url : '/core/api/milestone/pipelines', templateKey : "admin-settings-milestones",
			individual_tag_name : 'div', sortKey : "name", postRenderCallback : function(el)
			{
				setup_milestones(el);
				var tracks_length = App_Admin_Settings.pipelineGridView.collection.length;
				if (tracks_length == 1)
					$('#milestone-listner').find('#deal-tracks-accordion').find('.collapse').addClass('in');
				initializeMilestoneListners(el);
				milestone_util.init(el);
				//that.lostReasons();
				//that.dealSources();
			} });
			that.pipelineGridView.collection.fetch();

			$('#milestone-listner').find('#admin-prefs-tabs-content').find('#settings-milestones-tab-content').html(that.pipelineGridView.render().el);
			$('#milestone-listner').find('#AdminPrefsTab .select').removeClass('select');
			$('#milestone-listner').find('.milestones-tab').addClass('select');
			$(".active").removeClass("active");

		}, "#milestone-listner");
	
		$('.settings-milestones').addClass('active');
		$('#milestone-listner').find('#admin-prefs-tabs-content').parent().removeClass('bg-white');
	},
	
	/**
	 * Creates a Model to show and edit milestones, reloads the page on save
	 * success
	 */
	categories : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			$('#content').html(getTemplate('others-not-allowed',{}));
			return;
		}

		$("#content").html(getTemplate("admin-settings"), {});
		this.categoryGridView = new Base_Collection_View({ url : '/core/api/categories?entity_type=TASK', templateKey : "admin-settings-categories",
			individual_tag_name : 'tr', sortKey : "order", postRenderCallback : function(el)
			{
				console.log("loaded categories : ", el);
				categories.setup_categories(el);
				categories.init();
			} });
		this.categoryGridView.collection.fetch();
		$('#content').find('#admin-prefs-tabs-content').html(this.categoryGridView.render().el);
		$('#content').find('#AdminPrefsTab .select').removeClass('select');
		$('#content').find('.categories-tab').addClass('select');
		$(".active").removeClass("active");
	},

	/**
	 * Fetches Stats of integrations - usage info.
	 */
	integrationsStats : function()
	{
		/*
		 * if (!CURRENT_DOMAIN_USER.is_admin) { $('#content').html("You have no
		 * Admin Privileges"); return; }
		 * $("#content").html(getTemplate("admin-settings"), {}); var
		 * emailStatsModelView = new Base_Model_View({ url :
		 * 'core/api/emails/email-stats', template :
		 * 'admin-settings-email-stats', });
		 * 
		 * $('#content').find('#admin-prefs-tabs-content').html(emailStatsModelView.render().el);
		 * $('#content').find('#AdminPrefsTab .select').removeClass('select');
		 * $('#content').find('.stats-tab').addClass('select');
		 */

		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}

		$("#content").html("<div id='email-stats-listners'></div>");
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#email-stats-listners').html($(template_ui));

			$('#email-stats-listners').find('#AdminPrefsTab .select').removeClass('select');
			$('#email-stats-listners').find('.stats-tab').addClass('select');
			$(".active").removeClass("active");
			$('#email-stats-listners').find('#admin-prefs-tabs-content').html(getRandomLoadingImg());

			getTemplate('admin-settings-integrations-stats-new',{}, undefined, function(template_ui){
				if(!template_ui)
					  return;

				$('#email-stats-listners').find('#admin-prefs-tabs-content').html($(template_ui));
				$('#integration-stats a[href="#account-stats-new"]', $("#email-stats-listners")).tab('show');
				$('#email-stats-listners').find('#account-stats-new').html(LOADING_ON_CURSOR);
				account_stats_integrations.loadAccountStats($("#email-stats-listners"));
				initializeStatsListners($("#email-stats-listners"));
				hideTransitionBar();

			}, $('#email-stats-listners').find('#admin-prefs-tabs-content'));
		}, "#email-stats-listners");

	},

	/**
	 * Web to lead links to website pages
	 */
	integrations : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");
			return;
		}
		var that = this;
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$('#content').html($(template_ui));	

			that.integrations = new Base_Collection_View({ url : 'core/api/widgets/integrations', templateKey : 'admin-settings-web-to-lead',
			postRenderCallback : function()
			{
			} });

			that.integrations.collection.fetch();

			$('#content').find('#admin-prefs-tabs-content').html(that.integrations.render().el);
			$('#content').find('#AdminPrefsTab .select').removeClass('select');
			$('#content').find('.integrations-tab').addClass('select');
			$(".active").removeClass("active");

		}, "#content");
		
	},

	tagManagement : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}
		var that = this;
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$('#content').html($(template_ui));	

			that.tagsview1 = new Base_Collection_View({ url : 'core/api/tags/stats1', templateKey : "tag-management", individual_tag_name : 'li',
			sort_collection : true, sortKey : 'tag', postRenderCallback : function(el)
			{
				acl_util.initTagACL(el);
				initializeTagManagementListeners();
			} });
			that.tagsview1.appendItem = append_tag_management;

			// var tagsView = new Base_Model_View({ url : 'core/api/tags', template
			// : 'admin-settings-tags-model', });
			console.log(that.tagsview1);
			that.tagsview1.collection.fetch();

			$('#content').find('#admin-prefs-tabs-content').html(that.tagsview1.render().el);
		
			$('#content').find('#AdminPrefsTab .select').removeClass('select');
			$('#content').find('.tag-management-tab').addClass('select');
			$(".active").removeClass("active");

		}, "#admin-prefs-tabs-content");
		
	},

	emailGateways : function(id)
	{
		console.log(App_Admin_Settings.integrations.collection);
		var that = this;
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			// On Reload, navigate to integrations
			if (!that.integrations || that.integrations.collection == undefined)
			{
				that.navigate("integrations", { trigger : true });
				return;
			}

			var value = 'SEND_GRID';

			if (id == 'mandrill')
				value = 'MANDRILL';
			else if (id == 'ses')
                value = 'SES';

			var emailGateway;
			$.each(that.integrations.collection.where({name:"EmailGateway"}),function(key,value){
			
				emailGateway = JSON.parse(value.attributes.prefs);
			
			});
			
			// Allow only one Email gateway configured
			if(emailGateway && emailGateway["email_api"])//check if email gateway exist
			{
				if(emailGateway["email_api"].toUpperCase() != value)//checks if the current email gateway is the same as the clicked one
				{
				modalAlert("sms-integration-alert-modal","You have a Email Gateway already configured. Please disable that to configure a new one.","Email Gateway Configured");
				that.navigate("integrations", { trigger : true });
				return;	
				}
			}	

			// To show template according to api. Note: Widget and EmailGateway model is different
			if(!emailGateway)
				emailGateway = {"email_api":value, "api_user": "", "api_key":""}; 
					
			that.email_gateway = new Base_Model_View({ 
				data : emailGateway,
				url : 'core/api/email-gateway',
				template : 'settings-email-gateway', postRenderCallback : function(el)
				{
					if(id=="mandrill"){
						$("#integrations-image",el).attr("src","img/crm-plugins/mandrill_logo.png");
					}
					
					if(id=="sendgrid"){
						$("#integrations-image",el).attr("src","img/crm-plugins/sendgrid_logo.png");
					}

					if(id=="ses"){
						$("#integrations-image",el).attr("src","img/crm-plugins/ses_logo.png");
				    }
					
				}, saveCallback : function()
				{
					$('.ses-success-msg').show();
					
					// On saved, navigate to integrations
					Backbone.history.navigate("integrations", { trigger : true });

					if(value == 'SES')
 						return;

					data = App_Admin_Settings.email_gateway.model.toJSON();

					// Add webhook
					$.getJSON("core/api/email-gateway/add-webhook?api_user="+data.api_user+"&api_key=" + data.api_key + "&type=" + data.email_api, function(data)
					{
						console.log(data);
					});
				},
				errorCallback : function(response)
				{
					var $save = $('.save', '#email-gateway-integration-form');

					disable_save_button($save);

					var msg = response.responseText;

					if(msg.indexOf('SignatureDoesNotMatch') != -1)
                        msg = msg.replace('SignatureDoesNotMatch', 'Signature Mismatch');

                    if(msg.indexOf('InvalidClientTokenId') != -1)
                    	msg = msg.replace('InvalidClientTokenId', 'Invalid Access Key');

					// Show cause of error in saving
					var $save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'
												+ msg
												+ '</i></p></small></div>');

					// Appends error info to form actions
					// block.
					$save.closest(".form-actions", this.el).append(
							$save_info);

					// Hides the error message after 3
					// seconds
					if(response.status != 406)
						$save_info.show().delay(3000).hide(1, function(){

							enable_save_button($save);
						});
				}

			});

			$('#content').find('#admin-prefs-tabs-content').html(that.email_gateway.render().el);
			$('#content').find('.integrations-tab').addClass('select');
			$(".active").removeClass("active");

		}, "#content");

		
	},

	smsGateways : function(id)
	{
		console.log("inside sms gateways");
		var that = this;
		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			// On Reload, navigate to integrations
			if (!that.integrations || that.integrations.collection == undefined)
			{
				that.navigate("integrations", { trigger : true });
				return;
			}

			var value, accountID;
			if (id == "plivo")
			{
				value = 'PLIVO';
				accountID = "account_id";
			}
			if (id == "twilio")
			{
				value = 'TWILIO';
				accountID = "account_sid";
			}

			var smsGateway;
			$.each(that.integrations.collection.models, function(key, value)
			{
				var prefJSON = JSON.parse(value.attributes.prefs);
				if (prefJSON["sms_api"])
					smsGateway = prefJSON["sms_api"];
			});

			// allow one sms gateway configured at a time
			if (smsGateway != undefined)// check if sms gateway exist
			{
				if (smsGateway.toUpperCase() != value)// checks if the current sms
				// gateway is the same as
				// the clicked one
				{
					modalAlert("sms-integration-alert-modal", "You have a SMS Gateway already configured. Please disable that to configure a new one.",
							"SMS Gateway Configured");
					that.navigate("integrations", { trigger : true });
					return;
				}
			}

			view = new Base_Model_View({
				model : App_Admin_Settings.integrations.collection.where({ name : "SMS-Gateway" })[0],
				url : 'core/api/sms-gateway',
				template : 'settings-sms-gateway',
				prePersist : function(model)
				{
					if (id == "plivo")
						var prefJSON = { account_id : model.attributes.account_id, auth_token : model.attributes.auth_token, endpoint : model.attributes.endpoint,
							sms_api : value };
					if (id == "twilio")
						var prefJSON = { account_sid : model.attributes.account_sid, auth_token : model.attributes.auth_token,
							endpoint : model.attributes.endpoint, sms_api : value };
					model.set({ prefs : JSON.stringify(prefJSON) }, { silent : true });
				}, postRenderCallback : function(el)
				{

					if (id == "plivo")
					{
						$("#integrations-image", el).attr("src", "/img/plugins/plivo.png");
						$("#accoundID", el).attr("name", "account_id");
						$("#accoundID", el).attr("placeholder", "Auth ID");
						$("#integrations-label", el).text("You need a Paid Plivo account to be able to send SMS");
					}
					if (id == "twilio")
					{
						$("#integrations-image", el).attr("src", "/img/plugins/twilio.png");
						$("#accoundID", el).attr("name", "account_sid");
						$("#accoundID", el).attr("placeholder", "Account SID");
						$("#integrations-label", el).text("Please provide your account details");
					}
				}, saveCallback : function(data)
				{
					// On saved, navigate to integrations
					Backbone.history.navigate("integrations", { trigger : true });
				}, errorCallback : function(data)
				{
					if ($("#sms-gateway-error").is(":visible"))
						$("#sms-gateway-error").remove();

					$responceText = "<div style='color:#B94A48; font-size:14px' id='sms-gateway-error'><i>" + data.responseText + "</i></div>";
					$("#sms-integration-error", that.el).append($responceText);
				} });

			$('#content').find('#admin-prefs-tabs-content').html(view.render().el);
			$('#content').find('#AdminPrefsTab .select').removeClass('select');
			$('#content').find('.integrations-tab').addClass('select');
			$(".active").removeClass("active");


		}, "#content");
	},
	
	/**
	 * Fetch all lost reasons
	 */
	lostReasons : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			$('#content').html(getTemplate('others-not-allowed',{}));
			return;
		}
		$('#content').html("<div id='milestone-listner'>&nbsp;</div>");
		$("#milestone-listner").html(getTemplate("admin-settings"), {});
		$('#milestone-listner').find('#admin-prefs-tabs-content').html(getTemplate("settings-milestones-tab"), {});
		this.dealLostReasons = new Base_Collection_View({ url : '/core/api/categories?entity_type=DEAL_LOST_REASON', templateKey : "admin-settings-lost-reasons",
			individual_tag_name : 'tr', sortKey : "name", postRenderCallback : function(el)
			{
				initializeMilestoneListners(el);
			} });
		this.dealLostReasons.collection.fetch();
		$('#content').find('#admin-prefs-tabs-content').find('#settings-milestones-tab-content').html(this.dealLostReasons.render().el);
		$('#content').find('#AdminPrefsTab .select').removeClass('select');
		$('#content').find('.milestones-tab').addClass('select');
		$(".active").removeClass("active");
		$('.settings-lost-reasons').addClass('active');
		$('#milestone-listner').find('#admin-prefs-tabs-content').parent().removeClass('bg-white');
	},

	/**
	 * Fetch all deal sources
	 */
	dealSources : function()
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			$('#content').html(getTemplate('others-not-allowed',{}));
			return;
		}
		$('#content').html("<div id='milestone-listner'>&nbsp;</div>");
		$("#milestone-listner").html(getTemplate("admin-settings"), {});
		$('#milestone-listner').find('#admin-prefs-tabs-content').html(getTemplate("settings-milestones-tab"), {});
		this.dealSourcesView = new Base_Collection_View({ url : '/core/api/categories?entity_type=DEAL_SOURCE', templateKey : "admin-settings-deal-sources",
			individual_tag_name : 'tr', sortKey : "name", postRenderCallback : function(el)
			{
				initializeMilestoneListners(el);
			} });
		this.dealSourcesView.collection.fetch();
		$('#content').find('#admin-prefs-tabs-content').find('#settings-milestones-tab-content').html(this.dealSourcesView.render().el);
		$('#content').find('#AdminPrefsTab .select').removeClass('select');
		$('#content').find('.milestones-tab').addClass('select');
		$(".active").removeClass("active");
		$('.settings-deal-sources').addClass('active');
		$('#milestone-listner').find('#admin-prefs-tabs-content').parent().removeClass('bg-white');
	}

});
/**
 * Creates a backbone router to perform config activities (onboarding and etc..).
 * 
 */
var AgileConfigRouter = Backbone.Router.extend({

	routes : {
	/* Admin-Settings */
	"onboarding/:link" : "onBoarding",
	},
	
	onBoarding : function(link)
	{
		if (!CURRENT_DOMAIN_USER.is_admin)
		{
			getTemplate('others-not-allowed', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
			}, "#content");

			return;
		}

		getTemplate("admin-settings", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			head.js(LIB_PATH + 'lib/prettify-min.js','../lib/zeroclipboard/ZeroClipboard.js', function()
			{
				var view = new Base_Model_View({ url : '/core/api/api-key', template : "admin-settings-api-key-model", postRenderCallback : function(el)
				{
					prettyPrint();
					console.log(link+"link is");
					if(link)
					{
						$(el).find('#APITab a[href="#'+ link +'"]').trigger('click');
					}
					
					initZeroClipboard("saas_api_track_code_icon", "saas_api_track_code");
					

				} });
				$('#content').find('#admin-prefs-tabs-content').html(view.render().el);
				$('#content').find('#AdminPrefsTab .select').removeClass('select');
				$('#content').find('.analytics-code-tab').addClass('select');
				// $('#content').html(view.el);
			});
			
			$.getJSON("core/api/api-key", function(data)
		    {
				console.log(data);
				getTemplate("onboarding-"+ link, data, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	
				}, "#content");
		    });


		}, "#content");

	}
	
});/**
 * Initiates all the routers and assigns to global variable to access the routes
 * from any where in the code.
 */

// All Routers are global
var App_Contacts, App_Contact_Search, App_Contact_Bulk_Actions, App_Contact_Filters, App_Contact_Views, App_Workflows, App_Deals, App_Admin_Settings, App_Calendar, App_Settings, App_Reports, App_Cases, App_Subscription, App_Visitors, App_WebReports, App_Documents, App_Widgets, App_ShopifyApp, App_Portlets, App_VoiceMailRouter,App_Deal_Details, App_Forms, App_ACL, App_Webpages;
var Collection_View = {};
$(function()
{
	App_Contacts = new ContactsRouter();
	App_Contact_Views = new ContactViewsRouter();
	App_Contact_Filters = new ContactFiltersRouter();
	App_Contact_Bulk_Actions = new ContactBulkActionRouter();
	App_Contact_Search = new ContactSearchRouter();
	App_Workflows = new WorkflowsRouter();
	App_Deals = new DealsRouter();
	App_Admin_Settings = new AdminSettingsRouter();
	App_Settings = new SettingsRouter();
	App_Calendar = new CalendarRouter();
	App_Subscription = new SubscribeRouter();
	App_Reports = new ReportsRouter();
	App_Cases = new CasesRouter();
	App_Visitors = new VisitorsRouter();
	App_WebReports = new WebreportsRouter();
	App_Documents = new DocumentsRouter();
	App_Widgets = new WidgetsRouter();
	App_Configuration = new AgileConfigRouter();
	App_Adminpanel = new AdminPanelRouter();
	App_ReferelRouter = new ReferelRouter();
	App_Activity_log = new ActivitylogRouter();
	App_ShopifyApp = new ShopifyRouter();
	App_Deal_Details= new DealDetailsRouter();
	App_VoiceMailRouter = new VoiceMailRouter();
	App_Portlets = new PortletsRouter;
	App_Tasks = new TaskDetailsRouter();
	App_Forms = new FormsRouter();
	App_ACL = new ACLRestriction();
	App_FacebookPageTabRouter = new FacebookPageTabRouter();
	App_Companies = new CompaniesRouter();
	App_Datasync = new DataSyncRouter();

	// Binds an event to activate infinite page scrolling
	Backbone.history.bind("all", currentRoute)

	// Backbone.history.bind("change", routeChange)

	/*
	 * Start Backbone history a necessary step to begin monitoring hashchange
	 * events, and dispatching routes
	 */
	Backbone.history.start();
//	setup_our_domain_sync();
});

// Global variable to store current route
var Current_Route;

/**
 * Reads current route, from the url of the browser, splits at "#" ( current
 * route is after "#" ), and activates infinite scrolling
 * 
 * @param route
 */
function currentRoute(route)
{
	Current_Route = window.location.hash.split("#")[1];
	
	if(SCROLL_POSITION)
	{
		var temp = Current_Route;
		if(!temp.match("contact"))
			SCROLL_POSITION = 0;
	}
	
	activateInfiniScroll();
	// set_profile_noty();
	// Reset it to uncheck checkboxes for bulk actions on route change
	SELECT_ALL = false;
	SUBSCRIBERS_SELECT_ALL = false;
	if (tour)
	{
		tour.end();
		tour = null;
	}
	if (GLOBAL_WEBRULE_FLAG)
		executeWebRulesOnRoute();

	// disposeEvents();

	// load_clickdesk_code();
	 showUpgradeNoty();

	 // Check the user permission to view the current route.
	 if(CURRENT_DOMAIN_USER)
		 tight_acl.init_permissions();
}

/**
 * Clickdesk Widget
 */
function load_clickdesk_code()
{

	if (CLICKDESK_CODE_LOADED)
		return;

	console.log("loading clickdesk..");

	CLICKDESK_CODE_LOADED = true;

	var glcspt = document.createElement('script');
	glcspt.type = 'text/javascript';
	glcspt.async = true;
	glcspt.src = glcpath + 'livechat-new.js';
	var s = document.getElementsByTagName('script')[0];
	s.parentNode.insertBefore(glcspt, s);
}
_
function executeWebRulesOnRoute(){
 	  if(typeof _agile_execute_action == "function")
	  {
	        _agile_webrules();
	        return;
	  }
}
/**
 * calendar.js is a script file having a route to show calendar
 * 
 * @module Activities
 */

var eventCollectionView;
var googleEventCollectionView;
var googleNextPageToken;
var CalendarRouter = Backbone.Router.extend({

routes : {
/* Shows fullCalendar page */
"calendar" : "calendar", "tasks" : "tasks_new", "tasks-new" : "tasks_new" },
/**
 * Activates the calendar menu and loads minified fullcalendar and jquery-ui to
 * show calendar view. Also shows tasks list in separate section.
 */
calendar : function()
{
	eraseCookie("agile_calendar_view");
	// read cookie for view if list_view is there then rendar list view else
	// rendar default view
	

		$('#content').html("<div id='calendar-listers'>&nbsp;</div>");
		$('#calendar-listers').html(LOADING_ON_CURSOR);
		getTemplate("calendar", {}, undefined, function(template_ui){

		if(!template_ui)
			  return;

		getCalendarUsersDetails(function(users){

		$('#calendar-listers').html($(template_ui));

				getTemplate("event-left-filter", users, undefined, function(template_ui1){
					
						$('#calendar-listers').find("#calendar-filters").html($(template_ui1));

						buildCalendarLhsFilters();
						createRequestUrlBasedOnFilter();
						var view = readCookie("agile_calendar_view");

						if (view)
						{
							$("#list_event_time").removeClass('hide');
							$("#user_calendars").hide();
							loadGoogleEvents();
							loadAgileEvents();
							return;
						}
						
						$("#list_event_time").addClass('hide');
						$("#user_calendars").show();
						$('#calendar-view-button').show();

						$(".active").removeClass("active");
						$("#calendarmenu").addClass("active");
						$('#agile_event_list').addClass('hide');

						// Typahead also uses jqueryui - if you are changing the version
						// here,
						// change it there too
						head.js(LIB_PATH + 'lib/jquery-ui.min.js', LIB_PATH + 'lib/fullcalendar.min.js', function()
						{
							showCalendar(users);
							hideTransitionBar();
							initializeEventListners();
						});

						$('#grp_filter').css('display', 'none');
						$('#event_tab').css('display', 'none');
					

					}, $('#calendar-listers').find("#calendar-filters"));
		});	
	}, "#calendar-listers");


	
},

/* Show tasks list when All Tasks clicked under calendar page. */
tasks : function()
{

	getTemplate("tasks-list-header", {}, undefined, function(template_ui){
		if(!template_ui)
			  return;
		$('#content').html($(template_ui));	

		fillSelect("owner-tasks", '/core/api/users/current-user', 'domainUser', function fillOwner()
		{

			$('#content').find("#owner-tasks").prepend("<li><a href=''>All Tasks</a></li>");
			$('#content').find("#owner-tasks").append("<li><a href='my-pending-tasks'>My Pending Tasks</a></li>");

			// To Updated task list based on user selection of type and owner
			initOwnerslist();
		}, "<li><a href='{{id}}'>My Tasks</a></li>", true);

		$(".active").removeClass("active");
		$("#calendarmenu").addClass("active");

	}, "#content");
},

/* Show new view of tasks. */
tasks_new : function()
{
	$('#content').html("<div id='tasks-list-template'>&nbsp;</div>");

	getTemplate("new-tasks-list-header", {}, undefined, function(template_ui){
		if(!template_ui)
			  return;
		$('#tasks-list-template').html($(template_ui));

		fillSelect("new-owner-tasks", '/core/api/users/current-user', 'domainUser', function fillOwner()
		{
			$('#tasks-list-template').find("#new-owner-tasks").prepend("<li><a href=''>All Tasks</a></li>");
			$('#tasks-list-template').find("#new-owner-tasks").append("<li><a href='all-pending-tasks' class='hide-on-status'>All Pending Tasks</a></li>");
			$('#tasks-list-template').find("#new-owner-tasks").append("<li><a href='my-pending-tasks' class='hide-on-owner hide-on-status'>My Pending Tasks</a></li>");
			initializeTasksListeners();
			// Read stored selections from cookie and Creates nested collection
			readDetailsFromCookie();
			// Bind dropdown events
			bindDropdownEvents();

		}, "<li><a href='{{id}}' class='hide-on-owner'>My Tasks</a></li>", true);

		$('.loading').remove();

		$(".active").removeClass("active");
		$("#calendarmenu").addClass("active");

		// Hide owner's and status task selection options from dropdown
		$(".hide-on-pending").hide();

	}, "#tasks-list-template");

},

// list view of event

});


// append events in category base
function appendItem1(base_model)
{
	var itemView = new Base_List_View({ model : base_model, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'tr', });

	// add to the right box - overdue, today, tomorrow etc.
	console.log(base_model.get('title'));
	var createdtime = get_activity_created_time(base_model.get('start'));

	// Today
	// Today
	if (createdtime == 0)
	{

		var heading = $('#today-heading', this.el);

		$('#today-event', this.el).append(itemView.render().el);
		$('#today-event', this.el).parent('table').css("display", "block");
		$('#today-event', this.el).parent('table').removeClass('hide');
		$('#today-event', this.el).show();
		$('#today-heading', this.el).show();
	}
	// if create time is 1 then that events belongs to tomarrow
	else if (createdtime == 1)
	{

		var heading = $('#tomorrow-heading', this.el);

		$('#tomorrow-event', this.el).append(itemView.render().el);
		$('#tomorrow-event', this.el).parent('table').css("display", "block");
		$('#tomorrow-event', this.el).parent('table').removeClass('hide');
		$('#tomorrow-event', this.el).show();
		$('#tomorrow-heading', this.el).show();
	}
	else if (createdtime > 1)
	{

		var heading = $('#next-week-heading', this.el);

		$('#next-week-event', this.el).append(itemView.render().el);
		$('#next-week-event', this.el).parent('table').css("display", "block");
		$('#next-week-event', this.el).parent('table').removeClass('hide');
		$('#next-week-event', this.el).show();
		if ($('#tomorrow-event').children().length > 0 || $('#today-event').children().length > 0)
		{
			$('#next-week-heading', this.el).show();

		}
	}

	var jsonObject = $.parseJSON(readCookie('event-lhs-filters'));
	var owner = jsonObject ? jsonObject.owner_ids : null;// if no owner then
	// its all
	if (owner && owner.length == 1 && owner[0] == CURRENT_AGILE_USER.id)
	{
		$('.e_owner').addClass('hide');
	}
	else
	{
		if ($('.e_owner').hasClass('hide'))
			$('.e_owner').removeClass('hide');
	}

	$('.contact_text').children().last().text($('.contact_text').children().last().text().replace(",", "").trim());
}

// append all events
function appendItem2(base_model)
{
	var itemView = new Base_List_View({ model : base_model, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'tr', });

	// add to the right box - overdue, today, tomorrow etc.

	var heading = $('#event-heading', this.el);

	$('#eventAll', this.el).append(itemView.render().el);
	$('#eventAll', this.el).parent('table').css("display", "block");
	$('#eventAll', this.el).show();
	$('#event-heading', this.el).show();

	// check for all selected
	// on landing of page

	var jsonObject = $.parseJSON(readCookie('event-lhs-filters'));
	var owner = jsonObject ? jsonObject.owner_ids : null; // if no owner then
	// its all
	if (owner && owner.length == 1 && owner[0] == CURRENT_AGILE_USER.id)
	{
		$('.e_owner').addClass('hide');
	}
	else
	{
		if ($('.e_owner').hasClass('hide'))
			$('.e_owner').removeClass('hide');
	}

	$('.contact_text').children().last().text($('.contact_text').children().last().text().replace(",", "").trim());

}

// append all google events
function appendGoogleEvent(base_model)
{
	var itemView = new Base_List_View({ model : base_model, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'tr', });

	// add to the right box - overdue, today, tomorrow etc.

	$('#google_event', this.el).append(itemView.render().el);
	$('#google_event', this.el).parent('table').css("display", "block");
	$('#google_event', this.el).show();
	$('.contact_text').children().last().text($('.contact_text').children().last().text().replace(",", "").trim());

}

function appendGoogleEventCategorization(base_model)
{
	var itemView = new Base_List_View({ model : base_model, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'tr', });

	// add to the right box - overdue, today, tomorrow etc.
	console.log(base_model.get('title'));
	var eventStartDate = base_model.get('start');
	var d = new Date(eventStartDate);
	var createdtime = get_activity_created_time(d.getTime() / 1000);

	// Today
	// Today
	if (createdtime == 0)
	{
		$('#today-event', this.el).append(itemView.render().el);
		$('#today-event', this.el).parent('table').css("display", "block");
		$('#today-event', this.el).parent('table').removeClass('hide');
		$('#today-event', this.el).show();
		$('#today-heading', this.el).show();
	}
	// if create time is 1 then that events belongs to tomarrow
	else if (createdtime == 1)
	{

		$('#tomorrow-event', this.el).append(itemView.render().el);
		$('#tomorrow-event', this.el).parent('table').css("display", "block");
		$('#tomorrow-event', this.el).parent('table').removeClass('hide');
		$('#tomorrow-event', this.el).show();
		$('#tomorrow-heading', this.el).show();
	}
	else if (createdtime > 1)
	{

		$('#next-week-event', this.el).append(itemView.render().el);
		$('#next-week-event', this.el).parent('table').css("display", "block");
		$('#next-week-event', this.el).parent('table').removeClass('hide');
		$('#next-week-event', this.el).show();
		if ($('#tomorrow-event', this.el).children().length > 0 || $('#today-event', this.el).children().length > 0)
		{
			$('#next-week-heading', this.el).show();

		}
	}
	$('.contact_text').children().last().text($('.contact_text').children().last().text().replace(",", "").trim());

}

function show_model(id)
{

	if ($(window.event.target).is('a'))
	{
		window.event.stopPropagation();
	}
	else
	{
		$("#updateActivityModal").html(getTemplate("update-activity-modal")).modal('show');

		var event = eventCollectionView.collection.get(id).toJSON();
		console.log("clicked event " + event);

		var contactList = event.contacts;
		for (var i = 0; i < contactList.length; i++)

		{
			if (contactList[i].type == "COMPANY")
			{

				$('#updateActivityModal')
						.find("ul[name='contacts']")
						.append(
								'<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="' + contactList[i].id + '"><a href="#contact/' + contactList[i].id + '">' + getCompanyName(contactList[i].properties) + '</a><a class="close" id="remove_tag">x</a></li>');

			}
			else
			{
				$('#updateActivityModal')
						.find("ul[name='contacts']")
						.append(
								'<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="' + contactList[i].id + '"><a href="#contact/' + contactList[i].id + '">' + getName(contactList[i].properties) + '</a><a class="close" id="remove_tag">x</a></li>');
			}
		}

		var priority = event.color;

		$('#updateActivityModal').find("select").children().each(function()
		{
			if (this.value == priority)
				$(this).attr('selected', 'selected');
		});

		if (event.allDay)
		{
			$('#updateActivityModal').find("input[name='allDay']").attr('checked', 'checked');
		}
		else
		{
			$('#updateActivityModal').find("input[name='allDay']").removeAttr("checked");
		}
		$('#updateActivityModal').find("input[name='title']").val(event.title);
		highlight_event();

		start = getDate(event.start);
		end = getDate(event.end);
		// Set Date for Event

		$("#update-event-date-1").val(getDateInFormatFromEpoc(event.start));
		$("#update-event-date-2").val(getDateInFormatFromEpoc(event.end));

		// Set Time for Event
		if ((start.getHours() == 00) && (end.getHours() == 00) && (end.getMinutes() == 00))
		{
			$('#update-event-time-1').val('');
			$('#update-event-time-2').val('');
		}
		else
		{
			$('#update-event-time-1').val(
					(start.getHours() < 10 ? "0" : "") + start.getHours() + ":" + (start.getMinutes() < 10 ? "0" : "") + start.getMinutes());
			$('#update-event-time-2').val((end.getHours() < 10 ? "0" : "") + end.getHours() + ":" + (end.getMinutes() < 10 ? "0" : "") + end.getMinutes());
		}

		$('#updateActivityModal').find("input[name='id']").val(id);
		$('#updateActivityModal').find("input[name='type']").val(event.type);
		if (event.meeting_type)
			$('#updateActivityModal').find("input[name='meeting_type']").val(event.meeting_type);
		else
			$('#updateActivityModal').find("input[name='meeting_type']").val('');

		if (event.type == "WEB_APPOINTMENT" && parseInt(event.start) > parseInt(new Date().getTime() / 1000))
		{
			$("[id='event_delete']").attr("id", "delete_web_event");
			web_event_title = event.title;
			if (event.contacts.length > 0)
			{
				var firstname = getPropertyValue(event.contacts[0].properties, "first_name");
				if (firstname == undefined)
					firstname = "";
				var lastname = getPropertyValue(event.contacts[0].properties, "last_name");
				if (lastname == undefined)
					lastname = "";
				web_event_contact_name = firstname + " " + lastname;
			}
		}
		else
		{
			$("[id='delete_web_event']").attr("id", "event_delete");
		}
		if (event.description)
		{
			var description = '<label class="control-label"><b>Description </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="Add Description"></textarea></div>'
			$("#event_desc").html(description);
			$("textarea#description").val(event.description);
		}
		else
		{
			var desc = '<div class="row-fluid">' + '<div class="control-group form-group m-b-none">' + '<a href="#" id="add_event_desctiption"><i class="icon-plus"></i> Add Description </a>' + '<div class="controls event_discription hide">' + '<textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="Add Description"></textarea>' + '</div></div></div>'
			$("#event_desc").html(desc);
		}
		// Fills owner select element
		populateUsersInUpdateActivityModal(event);
	}
}

function getFormattedDate(date)
{
	var dateFormat = 'mm/dd/yyyy';
	if ((date / 100000000000) > 1)
	{
		var d = new Date(parseInt(date));
		return d.format(dateFormat);
	}
	else
	{
		var d = new Date(parseInt(date) * 1000);
		return d.format(dateFormat);
	}
}

function getDate(date)
{

	if ((date / 100000000000) > 1)
	{
		return new Date(parseInt(date));
	}
	else
	{
		return new Date(parseInt(date) * 1000);
	}
}

function getName(properties)
{
	var name;
	var firstName;
	var lastName;
	for (var i = 0; i < properties.length; i++)
	{
		if (properties[i].name == 'first_name')
			firstName = properties[i].value;
		if (properties[i].name == 'last_name')
			lastName = properties[i].value;

	}
	name = firstName + " " + lastName;

	return name.replace("undefined", "").trim();
}

function getCompanyName(properties)
{

	var name;
	for (var i = 0; i < properties.length; i++)
	{
		if (properties[i].name == 'name')
			name = properties[i].value;
	}
	return name;
}
function loadAgileEvents()
{
	var calEnable = false;

	accessUrlUsingAjax('core/api/calendar-prefs/get', function(response)
	{
		if (response)
			calEnable = true;

		var jsonObject = $.parseJSON(readCookie('event-lhs-filters'));
		var agile_event_owners = '';
		if (jsonObject)
		{
			var owners = jsonObject.owner_ids;
			if (owners && owners.length > 0)
			{
				$.each(owners, function(index, value)
				{
					if (index >= 1)
						agile_event_owners += ",";
					agile_event_owners += value;
				});
			}
		}
		var view = readCookie("agile_calendar_view");
		if (view == "calendar_list_view")
		{
			eventCollectionView = new Base_Collection_View({ url : 'core/api/events/list?ownerId=' + agile_event_owners + '', templateKey : "events",
				individual_tag_name : 'tr', sort_collection : true, sortKey : 'start', descending : false, cursor : true, page_size : 25 });
			eventCollectionView.appendItem = appendItem2;
			eventCollectionView.collection.fetch();
			if (calEnable)
			{
				$('#agile').html(this.eventCollectionView.render().el);
				$('#agile_event_list').addClass('hide');
			}
			else
				$('#agile_event').html(this.eventCollectionView.render().el);

		}
		else if (view == "calendar_list_view_future")
		{
			eventCollectionView = new Base_Collection_View({ url : 'core/api/events/future/list?ownerId=' + agile_event_owners, templateKey : "future",
				individual_tag_name : 'tr', sort_collection : true, sortKey : 'start', descending : false, cursor : true, page_size : 25 });
			eventCollectionView.appendItem = appendItem1;
			eventCollectionView.collection.fetch();
			if (calEnable)
			{
				$('#agile').html(this.eventCollectionView.render().el);
				$('#agile_event_list').addClass('hide');
			}
			else
				$('#agile_event').html(this.eventCollectionView.render().el);
		}

	 });
}

function loadGoogleEvents()
{

	$.getJSON('core/api/calendar-prefs/get', function(response)
	{
		console.log(response);
		if (response)
		{
			createCookie('google_event_token', response.access_token);

			head.js('https://apis.google.com/js/client.js', '/lib/calendar/gapi-helper.js', function()
			{
				setupGC(function()
				{

					gapi.auth.setToken({ access_token : response.access_token, state : "https://www.googleapis.com/auth/calendar" });

					// Retrieve the events from primary
					var view = readCookie("agile_calendar_view");
					if (view == "calendar_list_view")
					{
						var request = gapi.client.calendar.events
								.list({ 'calendarId' : 'primary', maxResults : 25, singleEvents : true, orderBy : 'startTime' });
						request.execute(function(resp)
						{
							var events = new Array();
							console.log(resp);
							for (var i = 0; i < resp.items.length; i++)
							{
								var fc_event = google2fcEvent(resp.items[i]);
								console.log(fc_event);
								events.push(fc_event);

							}
							googleNextPageToken = resp.nextPageToken;
							googleEventCollectionView = new Base_Collection_View({ data : events, templateKey : "google-event", individual_tag_name : 'tr',
								sort_collection : true, sortKey : 'start', descending : false });
							googleEventCollectionView.appendItem = appendGoogleEvent;
							$('#google').html(googleEventCollectionView.render(true).el);

						});

					}
					else
					{
						var startDate = new Date();
						var gDate = startDate.toISOString();
						var request = gapi.client.calendar.events.list({ 'calendarId' : 'primary', maxResults : 25, singleEvents : true, timeMin : gDate });
						request.execute(function(resp)
						{
							var events = new Array();
							console.log(resp);
							for (var i = 0; i < resp.items.length; i++)
							{
								var fc_event = google2fcEvent(resp.items[i]);
								console.log(fc_event);
								events.push(fc_event);

							}
							googleEventCollectionView = new Base_Collection_View({ data : events, templateKey : "googleEventCategorization",
								individual_tag_name : 'tr', sort_collection : true, sortKey : 'start', descending : false });
							googleEventCollectionView.appendItem = appendGoogleEventCategorization;
							$('#google').html(googleEventCollectionView.render(true).el);

						});

					}

				});
				return;
			});
			$('#agile_event_list').addClass('hide');
		}
		else
		{
			$('#event_tab').addClass('hide');
			$('#agile_event').removeClass('hide');
		}

	});
}

function loadMoreEventsFromGoogle()
{
	var accessToken = readCookie('google_event_token');
	if (googleNextPageToken)
	{
		if (accessToken)
		{

			gapi.auth.setToken({ access_token : accessToken, state : "https://www.googleapis.com/auth/calendar" });

			// Retrieve the events from primary
			var request = gapi.client.calendar.events.list({ 'calendarId' : 'primary', maxResults : 20, singleEvents : true, pageToken : googleNextPageToken,
				orderBy : 'startTime' });

			request.execute(function(resp)
			{
				var events = new Array();
				console.log(resp);
				for (var i = 0; i < resp.items.length; i++)
				{
					var fc_event = google2fcEvent(resp.items[i]);
					console.log(fc_event);
					events.push(fc_event);

				}
				googleNextPageToken = resp.nextPageToken;
				var view = readCookie("agile_calendar_view");
				if (view == "calendar_list_view")
				{
					googleEventCollectionView.collection.add(events);
					googleEventCollectionView.collection.sort();
				}
				else
				{
					googleEventCollectionView.collection.add(events);
					googleEventCollectionView.collection.sort();
				}

			})

		}
		else
		{

			$.getJSON('core/api/calendar-prefs/get', function(response)
			{

				gapi.auth.setToken({ access_token : response.access_token, state : "https://www.googleapis.com/auth/calendar" });

				// Retrieve the events from primary
				var request = gapi.client.calendar.events.list({ 'calendarId' : 'primary', maxResults : 1000, singleEvents : true,
					pageToken : googleNextPageToken });

				request.execute(function(resp)
				{
					var events = new Array();
					console.log(resp);
					for (var i = 0; i < resp.items.length; i++)
					{
						var fc_event = google2fcEvent(resp.items[i]);
						console.log(fc_event);
						events.push(fc_event);

					}
					googleNextPageToken = resp.nextSyncToken;
					var view = readCookie("agile_calendar_view");
					if (view == "calendar_list_view")
					{
						googleEventCollectionView.collection.add(events);
						googleEventCollectionView.collection.sort();
					}
					else
					{
						googleEventCollectionView.collection.add(events);
						googleEventCollectionView.collection.sort();
					}

				});
			});
		}
	}
}
/**
 * Creates backbone router for Case create, read and update operations
 */
var CasesRouter = Backbone.Router.extend({

	routes : { "cases" : "listCases", },

	/**
	 * Fetches all the case and shows them as a list.
	 * 
	 */
	listCases : function()
	{
		 $('#content').html("<div id='cases-listners'>&nbsp;</div>");
		this.casesCollectionView = new Base_Collection_View({ url : 'core/api/cases', sort_collection : false, restKey : "case", templateKey : "cases",
			cursor : true, page_size : 25, individual_tag_name : 'tr', postRenderCallback : function(el)
			{
				includeTimeAgo(el);
				initializeCasesListeners(el);
			}, appendItemCallback : function(el)
			{
				includeTimeAgo(el);
			} });

		this.casesCollectionView.collection.fetch();

		$('#cases-listners').html(this.casesCollectionView.render().el);

		$(".active").removeClass("active");
		$("#casesmenu").addClass("active");
	}

});
/**
 * Creates backbone router for companies management and filter (custom view)
 * operations.
 * 
 * @module Company management & filters
 */

COMPANIES_HARD_RELOAD = true;

var CompaniesRouter = Backbone.Router
.extend({
	
	routes : {
	
		/* Companies */
		"companies" : "companies",
	
		"company/:id" : "companyDetails",
		
		"company-edit" : "editCompany",
		
		"company-view-prefs" : "companyViewPrefs"
	},
	
	/**
	 * Fetches all the companies and shows as list, if tag_id
	 * and company_filter_id are not defined, if any one of them is defined then
	 * fetches the contacts related to that particular id (tag_id or
	 * company_filter_id) and shows as list. Adds tags, charts for tags and
	 * filter views to the contacts list from postRenderCallback of its
	 * Base_Collection_View. Initiates infiniScroll to fetch contacts
	 * (25 in count) step by step on scrolling down instead of fetching
	 * all at once.
	 */
	companies : function(tag_id, company_filter_id, grid_view, is_lhs_filter, view_data)
	{

		if (SCROLL_POSITION)
		{
			$('html, body').animate({ scrollTop : SCROLL_POSITION }, 1000);
			SCROLL_POSITION = 0;
		}
		else
		{
			$(window).scrollTop(0);
		}
		
		// If contacts are selected then un selects them
		SELECT_ALL = false;
		
		/**
		 * If collection is already defined and contacts are fetched the
		 * show results instead of initializing collection again
		 */
		if (COMPANIES_HARD_RELOAD == true)
		{
			this.companiesListView = undefined;
			COMPANIES_HARD_RELOAD = false;
			view_data = undefined;
			App_Companies.companyViewModel = undefined;
		}
		
		// If id is defined get the respective custom view object
		if (!view_data)
		{
			// Once view id fetched we use it without fetching it.
			if (!App_Companies.companyViewModel)
			{
				var view = new Backbone.Model();
				view.url = 'core/api/contact-view-prefs/company';
				view.fetch({ success : function(data)
				{
					// If custom view object is empty i.e., custom view
					// is deleted.
					// custom view cookie is eraised and default view is
					// shown
					if ($.isEmptyObject(data.toJSON()))
					{
						// Erase custom_view cookie, since
						// view object with given id is not available
						eraseCookie("contact_view");

						// Loads default contact view
						App_Companies.companies();
						return;
					}
					App_Companies.companyViewModel = data.toJSON();
					App_Companies.companies(tag_id, undefined, undefined, is_lhs_filter,App_Companies.companyViewModel);

				} });
				return;
			}

			view_data = App_Companies.companyViewModel;

		}

		var template_key = "companies-custom-view";
		var individual_tag_name = "tr";
		var sort_key = readCookie("company_sort_field");
		if (!sort_key || sort_key == null)
		{
			sort_key = '-created_time';
			// Saves Sort By in cookie
			createCookie('company_sort_field', sort_key);
		}

		// Checks if user is using custom view. It check for grid view
		/*if (grid_view || readCookie("agile_contact_view"))
		{
			template_key = "contacts-grid";
			individual_tag_name = "div";
		}*/

		// Default url for contacts route
		var url = '/core/api/contacts/companies/list';
		var collection_is_reverse = false;
		this.tag_id = tag_id;
		var postData;

		// Tags, Search & default browse comes to the same function
		if (tag_id)
		{
			tag_id = decodeURI(tag_id);

			tag_id = decodeURI(tag_id);

			// erase filter cookie
			//eraseCookie('contact_filter');
			eraseCookie('company_filter');
			//eraseCookie('contact_filter_type');
			//eraseData('dynamic_contact_filter');

			if (this.companiesListView && this.companiesListView.collection)
			{

				if (this.companiesListView.collection.url.indexOf('core/api/tags/list/' + tag_id) == -1)
				{
					this.companiesListView = undefined;
				}
			}

			this.customView(readCookie("contact_view"), undefined, 'core/api/tags/list/' + tag_id, tag_id);
			return;

		}
		else
		{
			if (this.companiesListView && this.companiesListView.collection)
			{

				if (this.companiesListView.collection.url.indexOf('core/api/tags/list') != -1)
				{
					console.log(window.location.hash = '#companies');
					this.companiesListView = undefined;
				}
			}
		}

		// If contact-filter cookie is defined set url to fetch
		// respective filter results
		if (company_filter_id || (company_filter_id = readCookie('company_filter')))
		{
			collection_is_reverse = false;
			url = "core/api/filters/query/list/" + company_filter_id;
		}

		console.log("while creating new base collection view : " + collection_is_reverse);

		if (this.companiesListView && this.companiesListView.collection.url == url)
		{
			this.companiesListView.collection.url = url;
			
			var el = this.companiesListView.render(true).el;

			$('#content').html(el);

			contactFiltersListeners("lhs_filters_conatiner");

			$(".active").removeClass("active");
			$("#companiesmenu").addClass("active");
			return;
		}
		if (readData('dynamic_company_filter'))
		{
			url = 'core/api/filters/filter/dynamic-filter';
			postData = readData('dynamic_company_filter');
		}

		var slateKey = getCompanyPadcontentKey(url);
		if (is_lhs_filter)
		{
			template_key = "companies-custom-view-table";
			/*if (grid_view || readCookie("agile_contact_view"))
			{
				template_key = "contacts-grid-table";
				individual_tag_name = "div";
			}*/
		}
		
		/*
		 * cursor and page_size options are taken to activate
		 * infiniScroll
		 */
		this.companiesListView = new Contacts_Events_Collection_View({ url : url, restKey : "contact", modelData : view_data, global_sort_key : sort_key,
			templateKey : template_key, individual_tag_name : 'tr', slateKey : slateKey, cursor : true, request_method : 'POST', post_data: {'filterJson': postData}, page_size : 25, sort_collection : false,
			postRenderCallback : function(el, collection)
			{
				// To set chats and view when contacts are fetch by
				// infiniscroll
				//setup_tags(el);

				company_list_view.init(el);
				
				if(is_lhs_filter) {
					var count = 0;
					if(collection.models.length > 0) {
						count = collection.models[0].attributes.count || collection.models.length;
					}
					var count_message;
					if (count > 9999 && (readCookie('company_filter') || readData('dynamic_company_filter')))
						count_message = "<small> (" + 10000 + "+ Total) </small>" + '<span style="vertical-align: text-top; margin-left: -5px">' + '<img border="0" src="/img/help.png"' + 'style="height: 10px; vertical-align: middle" rel="popover"' + 'data-placement="bottom" data-title="Lead Score"' + 'data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."' + 'id="element" data-trigger="hover">' + '</span>';
					else
						count_message = "<small> (" + count + " Total) </small>";
					$('#contacts-count').html(count_message);
				} else {					
					setupLhsFilters(el,true);
					contactFiltersListeners("lhs_filters_conatiner");
				}
			} });
		
		var _that = this;
		$.getJSON("core/api/custom-fields/type/scope?type=DATE&scope=COMPANY", function(customDatefields)
				{
					// Defines appendItem for custom view
					_that.companiesListView.appendItem = function(base_model){
						contactTableView(base_model,customDatefields,this);
					};
			
					// Fetch collection
					_that.companiesListView.collection.fetch();
					
				});

		if (!is_lhs_filter)
		{
			$('#content').html(this.companiesListView.el);
		}
		else
		{
			$('#content').find('.contacts-div').html(this.companiesListView.el);
			$('#bulk-actions').css('display', 'none');
			$('#bulk-select').css('display', 'none');
			COMPANIES_HARD_RELOAD = true;
		}

		$(".active").removeClass("active");
		$("#companiesmenu").addClass("active");
	
	},
	
	/**
	 * Shows a contact in its detail view by taking the contact from
	 * contacts list view, if list view is defined and contains the
	 * contact, otherwise downloads the contact from server side based
	 * on its id. Loads timeline, widgets, map and stars (to rate) from
	 * postRenderCallback of its Base_Model_View.
	 * 
	 */
	companyDetails : function(id, company){

		// For getting custom fields
		if (App_Companies.customFieldsList == null || App_Companies.customFieldsList == undefined)
		{
			App_Companies.customFieldsList = new Base_Collection_View({ url : '/core/api/custom-fields/position', sort_collection : false,
				restKey : "customFieldDefs", templateKey : "admin-settings-customfields", individual_tag_name : 'tr' });
			App_Companies.customFieldsList.collection.fetch();
		}

		var company_collection;

		if (!company && this.companyDetailView && this.companyDetailView.model != null)
		{
			// company_collection = this.contactDetailView;

			if (id == this.companyDetailView.model.toJSON()['id'])
			{
				App_Companies.companyDetails(id, this.companyDetailView.model);
				return;
			}
		}

		// If user refreshes the contacts detail view page directly - we
		// should load from the model
		if (!company)
			if (!this.companiesListView || this.companiesListView.collection.length == 0 || this.companiesListView.collection.get(id) == null)
			{

				console.log("Downloading contact");

				// Download
				var company_details_model = Backbone.Model.extend({ url : function()
				{
					return '/core/api/contacts/' + this.id;
				} });

				var model = new company_details_model();
				model.id = id;
				model.fetch({ success : function(data)
				{

					// Call Contact Details again
					App_Companies.companyDetails(id, model);

				}, error : function(data, response)
				{
					if (response && response.status == '403')
						$("#content").html("You do not have permission to view this Company.");
				} });

				return;
			}

		// If not downloaded fresh during refresh - read from collection
		if (!company)
		{
			// Set url to core/api/contacts/list (If filters are loaded
			// contacts url is changed so set it back)

			// this.companiesListView.collection.url =
			// "core/api/contacts/list";
			company = this.companiesListView.collection.get(id);
		}

		// Assigning contact collection
		if (this.companiesListView && this.companiesListView.collection)
			company_collection = this.companiesListView.collection;

		add_recent_view(company);

		// If contact is of type company , go to company details page
		this.companyDetailView = new Contact_Details_Model_Events({ model : company, isNew : true, template : "company-detail",
			postRenderCallback : function(el)
			{
				fill_company_related_contacts(id, 'company-contacts');
				// Clone contact model, to avoid render and
				// post-render fell in to
				// loop while changing attributes of contact
				var recentViewedTime = new Backbone.Model();
				recentViewedTime.url = "core/api/contacts/viewed-at/" + company.get('id');
				recentViewedTime.save();

				if (App_Companies.companiesListView && App_Companies.companiesListView.collection && App_Companies.companiesListView.collection.get(id))
					App_Companies.companiesListView.collection.get(id).attributes = company.attributes;

				company_util.starify(el);
				company_util.show_map(el);
				// fill_owners(el, contact.toJSON());
				// loadWidgets(el, contact.toJSON());

			} });

		var el = this.companyDetailView.render(true).el;
		$('#content').html(el);
		fill_company_related_contacts(id, 'company-contacts');
		// company_detail_tab.initEvents();
		return;
	},
	
	companyViewPrefs : function(){
		var companyView = new Base_Model_View({ url : 'core/api/contact-view-prefs/company', template : "company-view",change: false, 
			restKey : "companyView", window : "companies", postRenderCallback : function(el, modelData)
			{
				fillSelect("custom-fields-optgroup", "core/api/custom-fields/scope?scope=COMPANY", undefined, function(data)
				{
					head.js(LIB_PATH + 'lib/jquery-ui.min.js', LIB_PATH + 'lib/jquery.multi-select.js', function()
					{

						$('#multipleSelect', el).multiSelect();

						$('.ms-selection', el).children('ul').addClass('multiSelect').attr("name", "fields_set").attr("id", "fields_set").sortable();

						$.each(modelData['fields_set'], function(index, field)
						{
							$('#multipleSelect', el).multiSelect('select', field);
						});

					});

				}, '<option value="CUSTOM_{{field_label}}">{{field_label}}</option>', true, el);
			}, saveCallback : function(data)
			{
				COMPANIES_HARD_RELOAD = true;
				App_Companies.navigate("companies", { trigger : true });
			} });

		$("#content").html(companyView.render().el);
	},
	
	/**
	 * Takes the contact to continue contact form to edit it. If
	 * attempts to edit a contact without defining contact detail view,
	 * navigates to contacts page. Gets the contact to edit, from its
	 * list view or its custom view, if not found in both downloads from
	 * server side (Contact database).
	 */
	editCompany : function(contact)
	{
		var company = null;

		// Takes back to companies if companies detailview is not defined
		if (!this.companyDetailView || !this.companyDetailView.model.id)
		{
			this.navigate("companies", { trigger : true });
			return;
		}

		// If company detail view is defined the get current company
		// model id
		var id = this.companyDetailView.model.id;

		if (this.companyDetailView && this.companyDetailView.model.id)
		{
			company = this.companyDetailView.model.toJSON();
		}

		// If contact list is defined the get contact to edit from the
		// list
		else if (this.companiesListView && this.companiesListView.collection && this.companiesListView.collection.get(id))
		{
			company = this.companiesListView.collection.get(id).toJSON();
		}

		// If contact list view and custom view list is not defined then
		// download contact
		else if (!company)
		{
			// Download contact for edit since list is not defined
			var company_details_model = Backbone.Model.extend({ url : function()
			{
				return '/core/api/contacts/' + id;
			} });

			var model = new company_details_model();

			model.fetch({ success : function(contact)
			{

				// Call Contact edit again with downloaded contact
				// details
				App_Companies.editCompany(company.toJSON());
			} });

			return;
		}

		// Contact Edit - take him to continue-contact form
		add_custom_fields_to_form(company, function(company)
		{
				deserialize_contact(company, 'continue-company');
		}, company.type);
	},
});/**
 * Creates backbone router for contacts bulk actions management operations.
 */
var ContactBulkActionRouter = Backbone.Router.extend({
	
	routes : {
		
		/* Contact bulk actions */
		
		"bulk-owner" : "ownerBulk",
		
		"bulk-campaigns" : "campaignsBulk",
		
		"bulk-tags" : "tagsBulk",
		
		"bulk-tags-remove" : "tagsRemoveBulk",
		
		"bulk-email" : "emailBulk", 
		
		"company-bulk-owner" : "companyOwnerBulk",
		
		"company-bulk-email" : "companyEmailBulk"
		
	},

	/**
	 * Loads the owners template to subscribe the selected contacts to a
	 * campaign and triggers the custom event 'fill_owners' to fill the
	 * owners select drop down. This event is
	 */
	ownerBulk : function()
	{

		// On reloading redirecting to contacts/companies list
		if (!App_Contacts.contactsListView)
			Backbone.history.navigate("contacts", { trigger : true });
		else
		{
			getTemplate("bulk-actions-owner", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
				$('body').trigger('fill_owners');




			}, "#content");
			
		}
	},

	/**
	 * Loads the campaign template to subscribe the selected contacts to
	 * a campaign and triggers an event, which fills the campaigns
	 * select drop down. This event is binded to trigger on loading of
	 * the template
	 */
	campaignsBulk : function()
	{

		// On reloading redirecting to contacts list
		if (!App_Contacts.contactsListView)
			Backbone.history.navigate("contacts", { trigger : true });
		else
		{
			getTemplate("bulk-actions-campaign", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
				$('body').trigger('fill_campaigns');
			}, "#content");			
		}

	},

	/**
	 * Loads the tags template to add tags to the selected contacts
	 */
	tagsBulk : function()
	{
		// On reloading redirecting to contacts list
		if (!App_Contacts.contactsListView)
			Backbone.history.navigate("contacts", { trigger : true });
		else{

			getTemplate("bulk-actions-tags", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));
			}, "#content");	

		}
			
	},
	/**
	 * Loads the tags template to add tags to the selected contacts
	 */
	tagsRemoveBulk : function()
	{
		// On reloading redirecting to contacts list
		if (!App_Contacts.contactsListView)
			Backbone.history.navigate("contacts", { trigger : true });
		else
			getTemplate("bulk-actions-tags-remove", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));
			}, "#content");	
	},

	/**
	 * Loads the email template to send email to the selected contacts
	 * and triggers an event, which fills send email details. This event
	 * is binded to trigger on loading of the template
	 */
	emailBulk : function()
	{

		// On reloading redirecting to contacts list
		if (!App_Contacts.contactsListView)
			Backbone.history.navigate("contacts", { trigger : true });
		else
		{
			$("#content").html('<div id="send-email-listener-container"></div>');
			getTemplate("send-email", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#send-email-listener-container').html($(template_ui));
				$("#emailForm").find('.add-attachment-select').hide();
				$('body').trigger('fill_emails');
				initializeSendEmailListeners();
				sendEmailAttachmentListeners("send-email-listener-container");

			}, "#send-email-listener-container");			
		}
	},
	
	/**
	 * Loads the owners template to subscribe the selected contacts to a
	 * campaign and triggers the custom event 'fill_owners' to fill the
	 * owners select drop down. This event is
	 */
	companyOwnerBulk : function()
	{

		// On reloading redirecting to contacts/companies list
		if (!App_Companies.companiesListView)
			Backbone.history.navigate("companies", { trigger : true });
		else
		{
			getTemplate("bulk-actions-company-owner", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	
				$('body').trigger('fill_owners');
			}, "#content");
		}
	},

	/**
	 * Loads the email template to send email to the selected contacts
	 * and triggers an event, which fills send email details. This event
	 * is binded to trigger on loading of the template
	 */
	companyEmailBulk : function()
	{

		// On reloading redirecting to contacts list
		if (!App_Companies.companiesListView)
			Backbone.history.navigate("companies", { trigger : true });
		else
		{

			$("#content").html('<div id="send-email-listener-container"></div>');
			getTemplate("send-email-company", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
					
				$('#send-email-listener-container').html($(template_ui));	
				$("#emailForm").find('.add-attachment-select').hide();
				$('body').trigger('fill_emails');
				initializeSendEmailListeners();
				sendEmailAttachmentListeners("send-email-listener-container");

			}, "#send-email-listener-container");
		}
	}
	
});/**
 * Creates backbone router for contacts filters management operations.
 */
var ContactFiltersRouter = Backbone.Router.extend({
	
	routes : {
		

		/* Contact-Filters */
		
		"contact-filters" : "contactfilters",
		
		"contact-filter-add" : "contactFilterAdd",
		
		"contact-filter-edit/:id" : "contactFilterEdit",
		
		"contact-filter/:id" : "showFilterContacts"
		
	},
	
	/**
	 * Shows contact filters list
	 */
	contactfilters : function()
	{
		this.contactFiltersList = new Base_Collection_View({ url : '/core/api/filters', restKey : "ContactFilter", templateKey : "contact-filter",
			individual_tag_name : 'tr', sort_collection : false,
			postRenderCallback : function(el)
			{
							head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
							{
											$(".created_time", el).timeago();
							});

			}});

		this.contactFiltersList.collection.fetch();
		$("#content").html(this.contactFiltersList.render().el);
	},
	
	/**
	 * Adds new filter to get specific contacts
	 */
	contactFilterAdd : function()
	{

		var contacts_filter = new Base_Model_View({ url : 'core/api/filters', template : "filter-contacts", isNew : "true", window : "contact-filters",
			postRenderCallback : function(el)
			{
				head.js(LIB_PATH + 'lib/agile.jquery.chained.min.js', function()
				{
					chainFiltersForContactAndCompany(el, undefined, function()
					{
						$('#content').html(el);
						scramble_input_names($(el).find('#filter-settings'));
						$("#contact_type").trigger('change');
					});
				});				
			} });
		$("#content").html(LOADING_HTML);
		contacts_filter.render();		
	},
	
	/**
	 * Edits filter created
	 */
	contactFilterEdit : function(id)
	{
		if (!this.contactFiltersList || this.contactFiltersList.collection.length == 0 || this.contactFiltersList.collection.get(id) == null)
		{
			this.navigate("contact-filters", { trigger : true });
			return;
		}

		$("#content").html(LOADING_HTML);
		var contact_filter = this.contactFiltersList.collection.get(id);
		var ContactFilter = new Base_Model_View({ url : 'core/api/filters', model : contact_filter, template : "filter-contacts",
			window : 'contact-filters', postRenderCallback : function(el)
			{
				$(el).on('agile_model_loaded', function(e) {
					$("#contact_type").trigger('change');
				})
				$("#content").html(LOADING_HTML);
				head.js(LIB_PATH + 'lib/agile.jquery.chained.min.js', function()
				{
					$("#content").html(LOADING_HTML);
					// setTimeout(function(){
						chainFiltersForContactAndCompany(el, contact_filter.toJSON(), function()
						{
							$('#content').html(el);
						});
					scramble_input_names($(el).find('#filter-settings')); 						
					// }, 0);
					

				})
			}, saveCallback : function(data)
			{
				var filterValue = readCookie('contact_filter');
				if (filterValue && filterValue == data.id)
					CONTACTS_HARD_RELOAD = true;
			} });

		$("#content").html(LOADING_HTML);
		ContactFilter.render();

	},

	/**
	 * Fetches contacts based on filter_id
	 */
	showFilterContacts : function(filter_id)
	{
		if (App_Contacts)
			App_Contacts.contacts(undefined, filter_id);
	}
	
	
});/**
 * Creates backbone router for contacts search management operations.
 */
var ContactSearchRouter = Backbone.Router.extend({

	routes : {

	/* Search results */

	"contacts/search/:query" : "searchResults" 
		
	},

	/**
	 * search results
	 */
	searchResults : function(query)
	{
		var searchResultsView = new Base_Collection_View({ url : "core/api/search?q=" + encodeURIComponent(query), templateKey : "search", individual_tag_name : 'tr', cursor : true,
			data : QUERY_RESULTS, sort_collection : false, page_size : 15, postRenderCallback : function(el)
			{
				// Shows the query string as heading of search results
				if (searchResultsView.collection.length == 0)
					$("#search-query-heading", el).html('No matches found for "' + query + '"');
				else
					$("#search-query-heading", el).html('Search results for "' + query + '"');
			} });

		// If QUERY_RESULTS is defined which are set by agile_typeahead
		// istead of fetching again
		/*
		 * if(QUERY_RESULTS) { //Create collection with results
		 * searchResultsView.collection = new BaseCollection(QUERY_RESULTS, {
		 * restKey : searchResultsView.options.restKey, sortKey :
		 * searchResultsView.options.sortKey });
		 * 
		 * $('#content').html(searchResultsView.render(true).el);
		 * $('body').trigger('agile_collection_loaded'); return; }
		 */

		// If in case results in different page is clicked before
		// typeahead fetch results, then results are fetched here
		searchResultsView.collection.fetch();

		$('#content').html(searchResultsView.render().el);

	}

});
/**
 * Creates backbone router for contacts views management operations.
 */
var ContactViewsRouter = Backbone.Router.extend({
	
	routes : {
		"contact-view-prefs" : "editContactView",
	},	
	/**
	 * Edits contact view
	 */
	editContactView : function()
	{
		var contactView = new Base_Model_View({ url : 'core/api/contact-view-prefs', template : "contact-view",change: false, 
			restKey : "contactView", window : "contacts", postRenderCallback : function(el, modelData)
			{
				fillSelect("custom-fields-optgroup", "core/api/custom-fields/scope?scope=CONTACT", undefined, function(data)
				{
					head.js(LIB_PATH + 'lib/jquery-ui.min.js', LIB_PATH + 'lib/jquery.multi-select.js', function()
					{

						$('#multipleSelect', el).multiSelect();

						$('.ms-selection', el).children('ul').addClass('multiSelect').attr("name", "fields_set").attr("id", "fields_set").sortable();

						$.each(modelData['fields_set'], function(index, field)
						{
							$('#multipleSelect', el).multiSelect('select', field);
						});

					});

				}, '<option value="CUSTOM_{{field_label}}">{{field_label}}</option>', true, el);
			}, saveCallback : function(data)
			{
				CONTACTS_HARD_RELOAD = true;
				App_Contacts.navigate("contacts", { trigger : true });
			} });

		$("#content").html(contactView.render().el);

	}
	
});/**
 * Creates backbone router for contacts management and filter (custom view)
 * operations.
 * 
 * @module Contact management & filters
 */

CONTACTS_HARD_RELOAD = true;

var ContactsRouter = Backbone.Router.extend({

	routes : { 
		
		"" : "dashboard", 
		
		"dashboard" : "dashboard",
		
		// "dashboard-test": "dashboard",

		/* Contacts */
		"contacts" : "contacts",
		
		"contact/:id" : "contactDetails",
		
		"import" : "importContacts",

		//add contact when customfields are there
		"contact-edit" : "editContact",
		
		"contact-add" : "addContact",
		
		"contact-duplicate" : "duplicateContact",
		
		"duplicate-contacts/:id" : "duplicateContacts",

		"merge-contacts" : "mergeContacts",
		
		"tags/:tag" : "contacts", 
		
		"send-email" : "sendEmail",
		
		"send-email/:id" : "sendEmail",
		
		"add-campaign" : "addContactToCampaign",

		/* Return back from Scribe after oauth authorization */
		"gmail" : "email", "twitter" : "socialPrefs", "linkedin" : "socialPrefs",
		
		/* CALL */
		"contacts/call-lead/:first/:last" : "addLead",
			
			/* CALL-with mobile number */
			"contacts/call-lead/:first/:last/:mob" : "addLeadDirectly",
			"call-contacts" : "callcontacts"
	},
	
	initialize : function()
	{
		/*
		 * $(".active").removeClass("active");
		 * 
		 * $("#content").html(getTemplate('dashboard-timline', {}));
		 * setup_dashboardTimeline();
		 */
	},

	dashboard : function()
	{

		$(".active").removeClass("active");
		if(CURRENT_DOMAIN_USER.domain == "admin")
		{
			Backbone.history.navigate("domainSearch" , {
                trigger: true
            });
            return;
		}

		getTemplate('portlets', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;

				var el = $(template_ui);
				$("#content").html(el);

				$('[data-toggle="tooltip"]').tooltip();
				if ((navigator.userAgent.toLowerCase().indexOf('chrome') > -1&&navigator.userAgent.toLowerCase().indexOf('opr/') == -1) && !document.getElementById('agilecrm_extension'))
				{
					$("#chrome-extension-button").removeClass('hide');
				}

				loadPortlets(el);

		}, "#content");

	},
	
	/**
	 * Fetches all the contacts (persons) and shows as list, if tag_id
	 * and filter_id are not defined, if any one of them is defined then
	 * fetches the contacts related to that particular id (tag_id or
	 * filter_id) and shows as list. Adds tags, charts for tags and
	 * filter views to the contacts list from postRenderCallback of its
	 * Base_Collection_View. Initiates infiniScroll to fetch contacts
	 * (25 in count) step by step on scrolling down instead of fetching
	 * all at once.
	 */
	contacts : function(tag_id, filter_id, grid_view, is_lhs_filter)
	{
		
		if(SCROLL_POSITION)
		{
			$('html, body').animate({ scrollTop : SCROLL_POSITION  },1000);
			SCROLL_POSITION = 0;
		} else {
			$( window ).scrollTop( 0 );
		}
		
		// If contacts are selected then un selects them
		SELECT_ALL = false;
		
		//campaign filters are disabled for time being.
		/*if(readData('dynamic_contact_filter') &&readData('dynamic_contact_filter').indexOf('campaign_status') >= 0 ) {
			eraseData('dynamic_contact_filter');
		}*/
		//custom scroll element for grid view
		var custom_scrollable_element=null;
		var max_contacts_count = 20;
		var is_company = false;
		var template_key = "contacts";
		var individual_tag_name = "tr";
		var sort_key = readCookie("sort_by_name");
		if(!sort_key || sort_key == null) {
			sort_key = '-created_time';
			// Saves Sort By in cookie
			createCookie('sort_by_name', sort_key);
		}
		
		// Checks if user is using custom view. It check for grid view
		if (grid_view || readCookie("agile_contact_view"))
		{
			template_key = "contacts-grid";
			individual_tag_name = "div";
			custom_scrollable_element="#contacts-grid-model-list";
		}
		
		// Default url for contacts route
		var url = '/core/api/contacts/list';
		var collection_is_reverse = false;
		this.tag_id = tag_id;
		var postData;

		// Tags, Search & default browse comes to the same function
		if (tag_id)
		{
			tag_id = decodeURI(tag_id);

			tag_id = decodeURI(tag_id);

			
			// erase filter cookie
			eraseCookie('contact_filter');
			//eraseCookie('company_filter');
			//eraseCookie('contact_filter_type');
			eraseData('dynamic_contact_filter');

			if (this.contactsListView && this.contactsListView.collection)
			{

				if (this.contactsListView.collection.url.indexOf('core/api/tags/list/' + tag_id) == -1)
				{
					this.contactsListView = undefined;
				}
			}

			this.customView(readCookie("contact_view"), undefined, 'core/api/tags/list/' + tag_id, tag_id);
			return;
			
		}
		else
		{
			if (this.contactsListView && this.contactsListView.collection)
			{

				if (this.contactsListView.collection.url.indexOf('core/api/tags/list') != -1)
				{
					console.log(window.location.hash = '#contacts');
					this.contactsListView = undefined;
				}
			}
		}

		// If contact-filter cookie is defined set url to fetch
		// respective filter results
		if (filter_id || (filter_id = readCookie('contact_filter')))
		{
			collection_is_reverse = false;
			url = "core/api/filters/query/list/" + filter_id;
		}

		// If view is set to custom view, load the custom view
		if (!readCookie("agile_contact_view"))
		{
			if(readData('dynamic_contact_filter')) {
				// Then call customview function with filter url
				this.customView(readCookie("contact_view"), undefined, 'core/api/filters/filter/dynamic-filter', undefined,  is_lhs_filter, readData('dynamic_contact_filter'));
				return;
			}
			// If there is a filter saved in cookie then show filter
			// results in custom view saved
			if (readCookie('contact_filter'))
			{
				// Then call customview function with filter url
				this.customView(readCookie("contact_view"), undefined, "core/api/filters/query/list/" + readCookie('contact_filter'), tag_id);
				return;
			}

			// Else call customView function fetches results from
			// default url : "core/api/contacts/list"
			this.customView(readCookie("contact_view"), undefined, undefined, undefined, is_lhs_filter);
			return;
		}

		console.log("while creating new base collection view : " + collection_is_reverse);

		/**
		 * If collection is already defined and contacts are fetched the
		 * show results instead of initializing collection again
		 */
		if (CONTACTS_HARD_RELOAD == true)
		{
			this.contactsListView = undefined;
			CONTACTS_HARD_RELOAD = false;
		}
		
		if (this.contactsListView && this.contactsListView.collection)
		{
			this.contactsListView.collection.url = url;

			$('#content').html('<div id="contacts-listener-container"></div>');
			$('#contacts-listener-container').html(this.contactsListView.render(true).el);

			$(".active").removeClass("active");
			$("#contactsmenu").addClass("active");

			contactFiltersListeners();
			return;
		}
		if(readData('dynamic_contact_filter')) {
			url = 'core/api/filters/filter/dynamic-filter';
			postData = readData('dynamic_contact_filter');
		} 

		var slateKey = getContactPadcontentKey(url);
		
		if(is_lhs_filter) {
			template_key = "contacts-table";
			
			if (grid_view || readCookie("agile_contact_view"))
			{
				template_key = "contacts-grid-table";
				individual_tag_name = "div";
				custom_scrollable_element="#contacts-grid-table-model-list";
			}
		}

		/*
		 * cursor and page_size options are taken to activate
		 * infiniScroll
		 */
		this.contactsListView = new  Contacts_Events_Collection_View({ url : url,custom_scrollable_element:custom_scrollable_element, sort_collection : false, templateKey : template_key, individual_tag_name : individual_tag_name,
			cursor : true, page_size : 25, global_sort_key : sort_key, slateKey : slateKey, request_method : 'POST', post_data: {filterJson: postData}, postRenderCallback : function(el, collection)
			{
		
			$("#contacts-view-options").css( 'pointer-events', 'auto' );

				// Contacts are fetched when the app loads in
				// the initialize
				var cel = App_Contacts.contactsListView.el;
				var collection = App_Contacts.contactsListView.collection;

				// To set heading in template
				if(is_lhs_filter) {
					var count = 0;
					if(collection.models.length > 0) {
						count = collection.models[0].attributes.count || collection.models.length;
					}
					var count_message;
					if (count > 9999 && (readCookie('contact_filter') || readData('dynamic_contact_filter')))
						count_message = "<small> (" + 10000 + "+ Total) </small>" + '<span style="vertical-align: text-top; margin-left: -5px">' + '<img border="0" src="/img/help.png"' + 'style="height: 10px; vertical-align: middle" rel="popover"' + 'data-placement="bottom" data-title="Lead Score"' + 'data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."' + 'id="element" data-trigger="hover">' + '</span>';
					else
						count_message = "<small> (" + count + " Total) </small>";
					$('#contacts-count').html(count_message);
					setupViews();
					setupContactFilterList();
					//setUpContactView();
				} else {					
					setupLhsFilters(cel, is_company);
					setupViews(cel);
					setupContactFilterList(cel, tag_id);
					setUpContactView(cel);
				}
				$('[data-toggle="tooltip"]').tooltip();
				start_tour("contacts", el);
			} });

		// Contacts are fetched when the app loads in the initialize
		this.contactsListView.collection.fetch();
		if(!is_lhs_filter) {
			$('#content').html('<div id="contacts-listener-container"></div>');
			$('#contacts-listener-container').html(this.contactsListView.render().el);
			contactFiltersListeners();
		} else {
			$('#contacts-listener-container').find('.contacts-div').html(this.contactsListView.render().el);
			$('#bulk-actions').css('display', 'none');
			$('#bulk-select').css('display', 'none');
			CONTACTS_HARD_RELOAD = true;
		}
		$(".active").removeClass("active");
		$("#contactsmenu").addClass("active");
		$('[data-toggle="tooltip"]').tooltip();
	

	},
	
	/**
	 * Fetches all the duplicate contacts (persons) for the given
	 * contact and shows as list
	 */
	duplicateContacts : function(contact_id)
	{

		dup_contacts1_array.length = 0;
		var max_contacts_count = 20;
		var individual_tag_name = "tr";

		// Default url for contacts route
		this.contact_id = contact_id;
		var url = '/core/api/search/duplicate-contacts/' + contact_id;
		var collection_is_reverse = false;
		template_key = "duplicate-contacts";

		if (App_Contacts.contactDetailView === undefined)
		{
			Backbone.history.navigate("contact/" + contact_id, { trigger : true });
			return;
		}

		/*
		 * cursor and page_size options are taken to activate
		 * infiniScroll
		 */
		this.duplicateContactsListView = new Contacts_Events_Collection_View({ url : url, templateKey : template_key, individual_tag_name : 'tr', cursor : true,
			page_size : 25, sort_collection : collection_is_reverse, slateKey : null, postRenderCallback : function(el)
			{
				// this.duplicateContactsListView.collection.forEach(function(model,
				// index) {
				// model.set('master_id',contact_id);
				// });
			} });

		// Contacts are fetched when the app loads in the initialize
		this.duplicateContactsListView.collection.fetch();

		$('#content').html(this.duplicateContactsListView.render().el);

		$(".active").removeClass("active");
		$("#contactsmenu").addClass("active");

	},

	/**
	 * Merges duplicate contacts(persons) into a single master contact,
	 * at a time we can merge 3 contacts
	 */
	mergeContacts : function()
	{
		
		
		var id = dup_contacts1_array[0];

		var max_contacts_count = 20;
		var individual_tag_name = "table";

		var collection_is_reverse = false;
		template_key = "merge-contacts";

		if (App_Contacts.duplicateContactsListView == undefined || dup_contacts1_array.length<1)
		{
			Backbone.history.navigate("contacts", { trigger : true });
			return;
		}
		var contacts = [];
		for (var i = 0; i < dup_contacts1_array.length; i++)
		{
			var contact_id = Number(dup_contacts1_array[i]);
			var data = App_Contacts.duplicateContactsListView.collection.where({ id : contact_id });
			var temp = contacts.concat(data);
			contacts = temp;
		}
		var bigObject = {};
		var master_record = App_Contacts.contactDetailView.model.toJSON();
		console.log(master_record);
//		bigObject['custom_fields'] = get_custom_fields();
		var objects = []
		var length = 0;
		objects[0] = master_record;
		for (i = 0; i < contacts.length; i++)
		{
			objects[i + 1] = contacts[i].toJSON();
			length++;
		}
		bigObject["contacts"] = objects;
		bigObject["length"] = length;
		
		// Contact Edit - take him to continue-contact form
		add_custom_fields_to_form(bigObject, function(contact)
		{
			this.mergeContactsView = new Contact_Details_Model_Events({ template : template_key, data : bigObject, postRenderCallback : function(el)
			{
				// g_id_array.length = 0;
			} });

			$('#content').html(this.mergeContactsView.render(true).el);
			$( window ).scrollTop( 0 );
			$(".active").removeClass("active");
			$("#contactsmenu").addClass("active");

		}, master_record.type);	
	},

	/**
	 * Shows a contact in its detail view by taking the contact from
	 * contacts list view, if list view is defined and contains the
	 * contact, otherwise downloads the contact from server side based
	 * on its id. Loads timeline, widgets, map and stars (to rate) from
	 * postRenderCallback of its Base_Model_View.
	 * 
	 */
	contactDetails : function(id, contact)
	{
		$('[data-toggle="tooltip"]').tooltip();


		//If call campaign is running then show the campaign
		if(CALL_CAMPAIGN.last_clicked == "start-bulk-campaign"){
			startCallCampaign(CALL_CAMPAIGN.contact_id_list);
			CALL_CAMPAIGN.last_clicked = "";
		} 
		//Removed previous contact timeline nodes from the queue, if existed
		if(timeline_collection_view && timeline_collection_view.queue)
		{
			timeline_collection_view.queue.pop();
		}
		
		//For getting custom fields
		if(App_Contacts.customFieldsList == null || App_Contacts.customFieldsList == undefined){
			App_Contacts.customFieldsList = new Contacts_Events_Collection_View({ url : '/core/api/custom-fields/position', sort_collection : false, restKey : "customFieldDefs",
				templateKey : "admin-settings-customfields", individual_tag_name : 'tr' });
			App_Contacts.customFieldsList.collection.fetch();
		}

		var contact_collection;
		

		if (!contact && this.contactDetailView && this.contactDetailView.model != null)
		{
			//contact_collection = this.contactDetailView;

			if (id == this.contactDetailView.model.toJSON()['id'])
			{
				App_Contacts.contactDetails(id, this.contactDetailView.model);
				
				return;
			}
		}

		// If user refreshes the contacts detail view page directly - we
		// should load from the model
		if (!contact)
			if (!this.contactsListView || this.contactsListView.collection.length == 0 || this.contactsListView.collection.get(id) == null)
			{

				console.log("Downloading contact");

				// Download
				var contact_details_model = Backbone.Model.extend({ url : function()
				{
					return '/core/api/contacts/' + this.id;
				} });

				var model = new contact_details_model();
				model.id = id;
				model.fetch({ success : function(data)
				{
					if(data.type == 'COMPANY'){
						App_Companies.companyDetails(id);
						return;
					}
					// Call Contact Details again
					App_Contacts.contactDetails(id, model);

				}, 
				error: function(data, response)
				{
					if(response && response.status == '403')
						$("#content").html(response.responseText);
				}
				});
				
				return;
			}

		// If not downloaded fresh during refresh - read from collection
		if (!contact)
		{
			// Set url to core/api/contacts/list (If filters are loaded
			// contacts url is changed so set it back)

			//this.contactsListView.collection.url = "core/api/contacts/list";
			contact = this.contactsListView.collection.get(id);
		}
		
		// Assigning contact collection
		if(this.contactsListView && this.contactsListView.collection)
			contact_collection = this.contactsListView.collection;

		add_recent_view(contact);

		// If contact is of type company , go to company details page
		if (contact.get('type') == 'COMPANY')
		{			
			Backbone.history.navigate( "company/"+id, { trigger : true });
			return;
		}

		this.contactDetailView = new Contact_Details_Model_Events({ model : contact, isNew : true, template : "contact-detail", postRenderCallback : function(el)
		{
			
			$("#mobile-menu-settings").trigger('click');
			// Clone contact model, to avoid render and post-render fell
			// in to
			// loop while changing attributes of contact
			if(canEditCurrentContact())
			{
				var recentViewedTime = new Backbone.Model();
				recentViewedTime.url = "core/api/contacts/viewed-at/" + contact.get('id');
				recentViewedTime.save();
			}

			if (App_Contacts.contactsListView && App_Contacts.contactsListView.collection && App_Contacts.contactsListView.collection.get(id))
				App_Contacts.contactsListView.collection.get(id).attributes = contact.attributes;

			load_contact_tab(el, contact.toJSON());

			loadWidgets(el, contact.toJSON());
			
			
			
			/*
			 * // To get QR code and download Vcard
			 * $.get('/core/api/VCard/' + contact.toJSON().id,
			 * function(data){ console.log("Vcard string");
			 * console.log(data); var url =
			 * 'https://chart.googleapis.com/chart?cht=qr&chs=180x180&chld=0&choe=UTF-8&chl=' +
			 * encodeURIComponent(data); $("#qrcode", el).html('<img
			 * src="' + url + '" id="qr_code" alt="QR Code"/>');
			 * //$("#qrcode", el).html('<img
			 * style="display:inline-block!important;" src="' + url + '"
			 * id="qr_code" alt="QR Code" data="' + data + '"
			 * onload="qr_load();"/>'); $("#qrcode", el).prepend('<span
			 * style="padding: 8% 0%;margin-right: 2px;float:right;"
			 * id="downloadify"></span>'); });
			 */

			starify(el);

			show_map(el);

			// To navigate between contacts details
			if (contact_collection != null)
				contact_detail_view_navigation(id, App_Contacts.contactsListView, el);

			//fill_owners(el, contact.toJSON());
			start_tour("contact-details", el);
			

			// Sequence of calling option 1) BRIA 2) Twilio 3) SIP in contact phone option
			if(default_call_type == "Bria"){
				if(callFromBria == true){
					$(".contact-call-button",el).removeAttr('disabled');
					$(".contact-make-call",el).removeAttr("href");
					$(".contact-call-button",el).addClass('contact-make-bria-call');
					$(".contact-call-button-div",el).tooltip('hide')
					  .attr('data-original-title', "Call from Bria")
				    .tooltip('fixTitle');
					}
				}else{
					if(Twilio_Start == true)
						//else if (Twilio.Device.status() == "ready" || Twilio.Device.status() == "busy")			
						{
							$(".contact-call-button",el).removeAttr('disabled');
							$(".contact-make-call",el).removeAttr("href");
							$(".contact-call-button",el).addClass('contact-make-twilio-call');
							$(".contact-call-button-div",el).tooltip('hide')
							  .attr('data-original-title', "Call from Twilio")
						    .tooltip('fixTitle');

						}else if (Sip_Stack != undefined && Sip_Register_Session != undefined && Sip_Start == true)
							{
								$(".contact-call-button",el).removeAttr('disabled');
								$(".contact-make-call",el).removeAttr("href");
								$(".contact-call-button",el).addClass('contact-make-sip-call');
								$(".contact-call-button-div",el).tooltip('hide')
								  .attr('data-original-title', "Call from SIP")
							    .tooltip('fixTitle');
							}
				}

			} });

		var el = this.contactDetailView.render(true).el;

		$('#content').html(el);

		// Check updates in the contact.
		checkContactUpdated();

		if(localStorage.getItem('MAP_VIEW')=="disabled")
				$("#map_view_action").html("<i class='icon-plus text-sm c-p' title='Show map' id='enable_map_view'></i>");
		else
				$("#map_view_action").html("<i class='icon-minus text-sm c-p' title='Hide map' id='disable_map_view'></i>");


		//contactInnerTabsInvoke(el);

	},

	/**
	 * Takes the contact to continue contact form to edit it. If
	 * attempts to edit a contact without defining contact detail view,
	 * navigates to contacts page. Gets the contact to edit, from its
	 * list view or its custom view, if not found in both downloads from
	 * server side (Contact database).
	 */
	editContact : function(contact)
	{

		// Takes back to contacts if contacts detailview is not defined
		if (!this.contactDetailView || !this.contactDetailView.model.id)
		{
			this.navigate("contacts", { trigger : true });
			return;
		}

		// If contact detail view is defined the get current contact
		// model id
		var id = this.contactDetailView.model.id;

		if (this.contactDetailView && this.contactDetailView.model.id)
		{
			contact = this.contactDetailView.model.toJSON();
		}

		// If contact list is defined the get contact to edit from the
		// list
		else if (this.contactsListView && this.contactsListView.collection && this.contactsListView.collection.get(id))
		{
			contact = this.contactsListView.collection.get(id).toJSON();
		}

		// If contacts list view is not defined happens when in
		// custom-view route or in filter
		// then get contact from contact custom view
		else if (this.contact_custom_view && this.contact_custom_view.collection && this.contact_custom_view.collection.get(id))
		{
			contact = this.contact_custom_view.collection.get(id).toJSON();
		}

		// If contact list view and custom view list is not defined then
		// download contact
		else if (!contact)
		{
			// Download contact for edit since list is not defined
			var contact_details_model = Backbone.Model.extend({ url : function()
			{
				return '/core/api/contacts/' + id;
			} });

			var model = new contact_details_model();

			model.fetch({ success : function(contact)
			{

				// Call Contact edit again with downloaded contact
				// details
				App_Contacts.editContact(contact.toJSON());
			} });

			return;
		}

		// Contact Edit - take him to continue-contact form
		add_custom_fields_to_form(contact, function(contact)
		{

			if (contact.type == 'COMPANY')
				deserialize_contact(contact, 'continue-company');
			else
				deserialize_contact(contact, 'continue-contact');
		}, contact.type);
	},

	/**
	 * Creates a duplicate contact to the existing one. Deletes the
	 * email (as well as it has to be unique) and id (to create new one)
	 * of the existing contact and saves it. Also takes the duplicate
	 * contact to continue contact form to edit it.
	 */
	duplicateContact : function()
	{

		// Takes back to contacts if contacts detail view is not defined
		if (!this.contactDetailView || !this.contactDetailView.model.id || !this.contactsListView || this.contactsListView.collection.length == 0)
		{
			this.navigate("contacts", { trigger : true });
			return;
		}

		// Contact Duplicate
		var contact = this.contactDetailView.model
		var json = contact.toJSON();

		// Delete email as well as it has to be unique
		json = delete_contact_property(json, 'email');
		delete json.id;

		var contactDuplicate = new Backbone.Model();
		contactDuplicate.url = 'core/api/contacts';
		contactDuplicate.save(json, { success : function(data)
		{
			add_custom_fields_to_form(data.toJSON(), function(contact)
			{

				deserialize_contact(contact, 'continue-contact');

			});
		} });
	},

	/**
	 * Navigates the contact (of type company) to continue company form
	 */
	/*
	 * continueCompany: function () { // commented here to avoid the
	 * creation of multiple entities var model =
	 * serialize_and_save_continue_contact(undefined, 'companyForm',
	 * 'companyModal', true, false, '#continue-company'); },
	 */

	/**
	 * Imports contacts from a csv file and then uploads all the
	 * contacts to database
	 */
	importContacts : function()
	{
		$('#content').html('<div id="import-contacts-event-listener"></div>');
		getTemplate("import-contacts", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$('#import-contacts-event-listener').html($(template_ui));	
			initializeImportEvents('import-contacts-event-listener');

		}, "#import-contacts-event-listener");       
	},
	

	/**
	 * Subscribes a contact to a campaign. Loads the related template
	 * and triggers the custom event "fill_campaigns_contact" to show
	 * the campaigns drop down list.
	 */
	addContactToCampaign : function()
	{

		getTemplate("contact-detail-campaign", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$("#content").html($(template_ui));	
			$('body').trigger('fill_campaigns_contact');

		}, "#content"); 

		
	},

	/**
	 * Shows a send email form with some prefilled values (email - from,
	 * to and templates etc..). To prefill the fields the function
	 * populate_send_email_details is called from the
	 * postRenderCallback.
	 */
	sendEmail : function(id, subject, body, cc, bcc)
	{
		var model = {};
		
		if(!canSendEmails(1))
		{
			var pendingEmails = getPendingEmails();
			window.history.back();
			var title = "Emails limit";
			var yes = "";
			var no = "Ok"
			var upgrade_link =  'Please <a href="#subscribe" class="action" data-dismiss="modal" subscribe="subscribe" action="deny">upgarde your email subscription.</a>';
			var message = "You have used up all emails in your quota. " + upgrade_link;
			
			showModalConfirmation(title, 
					message, 
					""
				, function(element){
						
					// No callback
						Backbone.history.navigate( "subscribe", { trigger : true });
						return;
					},
					function(element){
						
					}, yes, no);
			return;
		}
		// Takes back to contacts if contacts detail view is not defined
		if (this.contactDetailView && !this.contactDetailView.model.get(id))
		{
			// Show the email form with the email prefilled from the curtrent contact
			model = this.contactDetailView.model.toJSON();
		}
		
		if(App_Companies.companyDetailView){
			var compEmailTemp = getPropertyValue(App_Companies.companyDetailView.model.toJSON().properties,'email');
			if(id && id == compEmailTemp){
				model = App_Companies.companyDetailView.model.toJSON();
			}
		}
		var el = $("#content").html('<div id="send-email-listener-container"></div>').find('#send-email-listener-container').html(getTemplate("send-email", model));
		
		// Call setupTypeAhead to get contacts
		agile_type_ahead("to", el, contacts_typeahead, null, null, "email-search", null, true, null, true);


		$("#content").html('<div id="send-email-listener-container"></div>');
		var that = this;
		getTemplate("send-email", model, undefined, function(template_ui){
			if(!template_ui)
				  return;

			var el = $("#send-email-listener-container").html($(template_ui));

			// Call setupTypeAhead to get contacts
			agile_type_ahead("to", el, contacts_typeahead, null, null, "email-search", null, true, null, true);

			agile_type_ahead("email_cc", el, contacts_typeahead, null, null, "email-search", null, true, null, true);

			agile_type_ahead("email_bcc", el, contacts_typeahead, null, null, "email-search", null, true, null, true);

			// To append name to email
			if (id)
			{
				var name;

				// For Reply all, id may contains multiple emails. If contains multiple, skip
				if (model && id.indexOf(',') == -1)
				{
					if (model.type == "PERSON")
					{

						var first_name = getPropertyValue(model.properties, "first_name");
						var last_name = getPropertyValue(model.properties, "last_name");

						if (first_name || last_name)
						{
							name = first_name ? first_name : "";
							name = (name + " " + (last_name ? last_name : "")).trim();
						}
					}
					else
					{
						var company_name = getPropertyValue(model.properties, "name");
						name = (company_name ? company_name : "").trim();
					}
				}

				if (name && name.length)
				{
					var data = id;

					// If already appended with name, skip
					if(id.indexOf('<') == -1 && id.indexOf('>') == -1)
						data = name + ' <' + id.trim() + '>';

					$('#to', el)
							.closest("div.controls")
							.find(".tags")
							.append(
									'<li class="tag  btn btn-xs btn-primary m-r-xs inline-block" data="' + data + '"><a href="#contact/' + model.id + '">' + name + '</a><a class="close" id="remove_tag">&times</a></li>');
				}
				else
					$("#emailForm", el).find('input[name="to"]').val(id);
			}
			else
				$("#emailForm", el).find('input[name="to"]').val('');

			// Checks Zoomifier tag for contact
			if (checkTagAgile("Zoomifier") && that.contactDetailView)
			{
				// Appends zoomifier link to attach their documents.
				head.js(LIB_PATH + 'lib/zoomifier.contentpicker.min.js', function()
				{
					$("#emailForm", el).find('textarea[name="body"]').closest(".controls")
							.append('<div><a style="cursor:pointer;" onclick="Javascript:loadZoomifierDocSelector();"><i class="icon-plus-sign"></i> Attach Zoomifier Doc</a></div>');
				});
			}

			// Populate from address and templates
			populate_send_email_details(el);
			
			if(subject)
				$("#emailForm",el).find('input[name="subject"]').val(subject);
			
			if(cc)
			{
				$("#emailForm",el).find('#email_cc').closest('.control-group').show();
				$("#emailForm",el).find('input[name="email_cc"]').val(cc);
			}
			
			if(bcc)
			{
				$("#emailForm",el).find('#email_bcc').closest('.control-group').show();
				$("#emailForm",el).find('input[name="email_bcc"]').val(bcc);
			}
			
			// Setup HTML Editor
			if(id)
			{		
				setupTinyMCEEditor('textarea#email-body', false, undefined, function(){
					
						if(!body)
							body = '';
					
						// Add tinymce content
						set_tinymce_content('email-body', body);
						
						// Register focus
						register_focus_on_tinymce('email-body');
				
					});
			}
			else
			{	
				setupTinyMCEEditor('textarea#email-body', true, undefined, function(){

						if(!body)
							body = '';
					
						// Add tinymce content
						set_tinymce_content('email-body', body);
						
						// Register focus
						register_focus_on_tinymce('email-body')
				});
			}
			
			initializeSendEmailListeners();
			sendEmailAttachmentListeners("send-email-listener-container");
			
			
		}, "#send-email-listener-container"); 
	
	},
	
	/**
	 * Custom views, its not called through router, but by cookies
	 */
	// Id = custom-view-id, view_data = custom view data if already
	// availabel, url = filter url if there is any filter
	customView : function(id, view_data, url, tag_id, is_lhs_filter, postData)
	{
		SELECT_ALL = false;
		App_Contacts.tag_id = tag_id;

		// If url is not defined set defult url to contacts
		if (!url)
		{
			url = "core/api/contacts/list";
		}
		

		if (CONTACTS_HARD_RELOAD == true)
		{
			this.contact_custom_view = undefined;
			CONTACTS_HARD_RELOAD = false;
			view_data = undefined;
			App_Contacts.contactViewModel = undefined;
		}

		// If id is defined get the respective custom view object
		if (!view_data)
		{
			// Once view id fetched we use it without fetching it.
			if (!App_Contacts.contactViewModel)
			{
				var view = new Backbone.Model();
				view.url = 'core/api/contact-view-prefs';
				view.fetch({ success : function(data)
				{
					// If custom view object is empty i.e., custom view
					// is deleted.
					// custom view cookie is eraised and default view is
					// shown
					if ($.isEmptyObject(data.toJSON()))
					{
						// Erase custom_view cookie, since
						// view object with given id is not available
						eraseCookie("contact_view");

						// Loads default contact view
						App_Contacts.contacts();
						return;
					}
					App_Contacts.contactViewModel = data.toJSON();
					App_Contacts.customView(undefined, App_Contacts.contactViewModel, url, tag_id, is_lhs_filter);

				} });
				return;
			}

			view_data = App_Contacts.contactViewModel;

		}
	

		// If defined
		if (this.contact_custom_view && this.contact_custom_view.collection.url == url)
		{
			var el = App_Contacts.contact_custom_view.render(true).el;
			$('#content').html('<div id="contacts-listener-container"></div>');
			$('#contacts-listener-container').html(el);
			$("#contacts-view-options").css( 'pointer-events', 'auto' );

			contactFiltersListeners();

			if (readCookie('company_filter'))
				$('#contact-heading', el).text('Companies');

			//setup_tags(el);
			//pieTags(el);
			setupViews(el, view_data.name);
			setupContactFilterList(el, tag_id);
			setUpContactView(el);

			$(".active").removeClass("active"); // Activate Contacts
												// Navbar tab
			$("#contactsmenu").addClass("active");
			return;
		}

		var slateKey = getContactPadcontentKey(url);
		var sort_key = readCookie("sort_by_name");
		if(!sort_key || sort_key == null) {
			sort_key = '-created_time';
			// Saves Sort By in cookie
			createCookie('sort_by_name', sort_key);
		}
		var template_key = "contacts-custom-view";
		var individual_tag_name='tr';
		var custom_scrollable_element=null;

		// Checks if user is using custom view. It check for grid view
		if (readCookie("agile_contact_view"))
		{
			template_key = "contacts-grid";
			individual_tag_name = "div";
			custom_scrollable_element="#contacts-grid-model-list";
		}
		//if directly called the method, i.e on click of custom view link, 
		//the url will be updated if any filter conditions are selected.
		if(readData('dynamic_contact_filter')) {
			url = 'core/api/filters/filter/dynamic-filter';
			postData=readData('dynamic_contact_filter');
		}
		if(is_lhs_filter) {
			template_key = "contacts-custom-view-table";

			if (readCookie("agile_contact_view"))
		    {
			template_key = "contacts-grid-table";
			individual_tag_name = "div";
			custom_scrollable_element="#contacts-grid-table-model-list";
		    }
		}	
		
		this.contact_custom_view = new Contacts_Events_Collection_View({ url : url, restKey : "contact", modelData : view_data, global_sort_key : sort_key,
			templateKey : template_key,custom_scrollable_element:custom_scrollable_element, individual_tag_name : individual_tag_name, slateKey : slateKey, cursor : true, request_method : 'POST', post_data: {'filterJson': postData}, page_size : 25, sort_collection : false,
			postRenderCallback : function(el, collection)
			{
				
				App_Contacts.contactsListView = App_Contacts.contact_custom_view;

				// To set chats and view when contacts are fetch by
				// infiniscroll
				//setup_tags(el);

				//pieTags(el);
				setupViews(el, view_data.name);
				$("#contacts-view-options").css( 'pointer-events', 'auto' );


				// show list of filters dropdown in contacts list
				setupContactFilterList(el, App_Contacts.tag_id);
				if(tag_id)
				setUpContactView(el,true);
			    else
				setUpContactView(el);
				if(is_lhs_filter) {
					var count = 0;
					if(collection.models.length > 0) {
						count = collection.models[0].attributes.count || collection.models.length;
					}
					var count_message;
					if (count > 9999 && (readCookie('contact_filter') || readData('dynamic_contact_filter')))
						count_message = "<small> (" + 10000 + "+ Total) </small>" + '<span style="vertical-align: text-top; margin-left: -5px">' + '<img border="0" src="/img/help.png"' + 'style="height: 10px; vertical-align: middle" rel="popover"' + 'data-placement="bottom" data-title="Lead Score"' + 'data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."' + 'id="element" data-trigger="hover">' + '</span>';
					else
						count_message = "<small> (" + count + " Total) </small>";
					$('#contacts-count').html(count_message);
				} else {					
					setupLhsFilters(el);
				}
			} });

		var _that = this;
		$.getJSON("core/api/custom-fields/type/scope?type=DATE&scope=CONTACT", function(customDatefields)
				{
					// Defines appendItem for custom view
					
					_that.contact_custom_view.appendItem = function(base_model){
						contactTableView(base_model,customDatefields,this);
					};
					// Fetch collection
					_that.contact_custom_view.collection.fetch();
					
				});
		
		if(!is_lhs_filter) {
			$('#content').html('<div id="contacts-listener-container"></div>');
			$('#contacts-listener-container').html(this.contact_custom_view.el);
			contactFiltersListeners();
		} else {
			$('#contacts-listener-container').find('.contacts-div').html(this.contact_custom_view.el);
			$('#bulk-actions').css('display', 'none');
			$('#bulk-select').css('display', 'none');
			CONTACTS_HARD_RELOAD = true;
		}
		
		// Activate Contacts Navbar tab
		$(".active").removeClass("active");
		$("#contactsmenu").addClass("active");
	
	},
	
	addLead : function(first, last){
		$("#personModal").on("shown", function(){
			$(this).find("#fname").val(first);
			$(this).find("#lname").val(last);
		});
		$("#personModal").modal();
	},
	
	addLeadDirectly : function(first, last,mob){
		$("#personModal").on("shown", function(){
			$(this).find("#fname").val(first);
			$(this).find("#lname").val(last);
			$(this).find("#phone").val(mob);
		});
		$("#personModal").modal();
	},

	addContact : function(){
		$.getJSON("core/api/custom-fields/scope?scope=CONTACT", function(data)
		{
			if(data.length > 0){
				var json = {custom_fields:data,properties:[]};
				getTemplate("continue-contact", json, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$("#content").html($(template_ui));	
					// Add placeholder and date picker to date custom fields
					$('.date_input').attr("placeholder", "Select Date");

					$('.date_input').datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY});

					// To set typeahead for tags
					setup_tags_typeahead();

					// Iterates through properties and ui clones
					
					var fxn_display_company = function(data, item)
					{
						$("#content [name='contact_company_id']")
								.html(
										'<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="' + data + '"><span><a class="text-white m-r-xs" href="#contact/' + data + '">' + item + '</a><a class="close" id="remove_tag">&times</a></span></li>');
						$("#content #contact_company").hide();
					}
					agile_type_ahead("contact_company", $('#content'), contacts_typeahead, fxn_display_company, 'type=COMPANY', '<b>No Results</b> <br/> Will add a new one');

				}, "#content"); 

					
			}else{
				Backbone.history.navigate("contacts" , {trigger: true});
				$("#personModal").modal("show");
			}		
					
		});

	},
	
		callcontacts : function()
	{
		
		$(".active").removeClass("active");
		var total_count = CALL_CAMPAIGN.total_count;
		var callSetting = {};
		callSetting['total_count'] = total_count;
		callSetting['time']=[10,20,30,40,50,60];
		
		getTemplate("call-campaign-setting", callSetting, undefined, function(template_ui){
			if(!template_ui)
				  return;
			  
			$(".butterbar").hide();
			$("#content").html($(template_ui));	
			$('[data-toggle="tooltip"]').tooltip();

		}, "#content"); 



	}
		
	});/**
 new DataSync router
 separated from widgets
*/



var DataSyncRouter = Backbone.Router.extend({

routes : {

            "sync": "dataSync",
            "sync/contacts": "google_contacts_sync",
            "sync/stripe-import": "stripe_sync",
            "sync/shopify": "shopify",
            "sync/salesforce": "salesforce",
            "sync/zoho-import": "zoho_sync",
            "sync/quickbook": "quickbook_import",
            "sync/xero": "xero_import",
            "sync/freshbooks": "freshbooks_sync",
            "sync/freshbooks/setting": "freshbooks_sync_setting"

 },

dataSync : function()
{
	 var that = this;
            getTemplate('settings', {}, undefined, function(template_ui) {
                if (!template_ui)
                    return;
                $('#content').html($(template_ui));

                $('#PrefsTab .select').removeClass('select');
                $('.contact-sync-tab').addClass('select');
               
                that.agile_sync_collection_view = new Base_Collection_View({
                    url: 'core/api/contactprefs/allPrefs',
                    type: 'GET',
                    individual_tag_name: 'div',
                    templateKey: 'data-sync',
                    postRenderCallback: function(el) {
                    	that.google_calendar(el);
                        initializeDataSyncListners();

                    }
                });

                that.agile_sync_collection_view.collection.fetch();
                that.agile_sync_collection_view.appendItem = organize_sync_widgets;
                $('#prefs-tabs-content').html(that.agile_sync_collection_view.render().el);


            }, "#content");
	
},


google_calendar:function(el){


	 this.calendar_sync_google = new GoogleCalendar_Event_Modal_View({
                            url: 'core/api/calendar-prefs/get',
                            template: 'import-google-calendar',
                            postRenderCallback: function(el) {
                                initializeImportListeners();
                            }
                        });
                        // console.log(getTemplate("import-google-contacts", {}));
                        $('#calendar-prefs').html(this.calendar_sync_google.render().el);
},

	 google_contacts_sync: function() {
	            var that = this;
	            getTemplate('settings', {}, undefined, function(template_ui) {
	                if (!template_ui)
	                    return;
	                $('#content').html($(template_ui));

	                $('#PrefsTab .select').removeClass('select');
	                $('.contact-sync-tab').addClass('select');


	                getSyncModelFromName("GOOGLE", function(model){

                   	var	url= 'core/api/contactprefs/GOOGLE',
			                  template= 'admin-settings-import-google-contacts-setup';
                  					renderInnerSyncView(url,template,model,function(model){
									showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                  					});
			               
			         });

	            }, "#content");

	        },


        stripe_sync: function() {
            var that = this;
            getTemplate('settings', {}, undefined, function(template_ui) {
                if (!template_ui)
                    return;
                $('#content').html($(template_ui));

                $('#PrefsTab .select').removeClass('select');
                $('.contact-sync-tab').addClass('select');

               
			       getSyncModelFromName("STRIPE", function(model){

                   	var	url= 'core/api/contactprefs/STRIPE',
			                  template= 'admin-settings-import-stripe-contact-sync-prefs';
                  					renderInnerSyncView(url,template,model,function(model){
									showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                  					});
			               
			    	     });
			          }, "#content");

        },


        shopify : function() {
            var that = this;
            getTemplate('settings', {}, undefined, function(template_ui) {
                if (!template_ui)
                    return;
                $('#content').html($(template_ui));
                $('#PrefsTab .select').removeClass('select');
                $('.contact-sync-tab').addClass('select');

                   getSyncModelFromName("SHOPIFY", function(model){

                   	var	url= 'core/api/contactprefs/SHOPIFY',
			                  template= 'admin-settings-import-shopify-prefs';
                  					renderInnerSyncView(url,template,model,function(model){
									showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                  					});
			               
			         });
               
            }, "#content");
        },

        freshbooks_sync: function() {
            var that = this;
            getTemplate('settings', {}, undefined, function(template_ui) {
                if (!template_ui)
                    return;
                $('#content').html($(template_ui));

                $('#PrefsTab .select').removeClass('select');
                $('.contact-sync-tab').addClass('select');
                getSyncModelFromName("FRESHBOOKS", function(model){

                    var url= 'core/api/contactprefs/FRESHBOOKS',
                              template= 'admin-settings-import-freshbooks-contacts-form';
                                    renderInnerSyncView(url,template,model,function(model){
                                    showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                                    });
                           
                     });
            
            }, "#content");
        },

        freshbooks_sync_setting: function() {
            var that = this;
            getTemplate('settings', {}, undefined, function(template_ui) {
                if (!template_ui)
                    return;
                $('#content').html($(template_ui));
                $('#PrefsTab .select').removeClass('select');
                $('.contact-sync-tab').addClass('select');
          
                  getSyncModelFromName("FRESHBOOKS", function(model){
                    var url= 'core/api/contactprefs/FRESHBOOKS',
                              template= 'admin-settings-import-freshbooks-settings';
                                    renderInnerSyncView(url,template,model,function(model){
                                    //initializes freshbooks listners which is present in 
                                    //import.js
                                    
                                    showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                                    });
                     });


            }, "#content");
        },

       
        quickbook_import: function() {
            var that = this;
            getTemplate('settings', {}, undefined, function(template_ui) {
                if (!template_ui)
                    return;
                $('#content').html($(template_ui));
                $('#PrefsTab .select').removeClass('select');
                $('.contact-sync-tab').addClass('select');

                  getSyncModelFromName("QUICKBOOK", function(model){

 							var	url= 'core/api/contactprefs/QUICKBOOK',
			                  template= 'admin-settings-import-quickbook-settings';
                  					renderInnerSyncView(url,template,model,function(model){
                                        
									showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                  					});
			         });

            }, "#content");
        },

        xero_import: function() {
            var that = this;
            getTemplate('settings', {}, undefined, function(template_ui) {
                if (!template_ui)
                    return;
                $('#content').html($(template_ui));

                $('#PrefsTab .select').removeClass('select');
                $('.contact-sync-tab').addClass('select');

                 getSyncModelFromName("XERO", function(model){

                   	var	url= 'core/api/contactprefs/XERO',
			                  template= 'admin-settings-import-xero-settings';
                  					renderInnerSyncView(url,template,model,function(model){
									showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                  					});
			               
			         });

            }, "#content");
        },
         zoho_sync: function() {
            var that = this;
            getTemplate('settings', {}, undefined, function(template_ui) {
                if (!template_ui)
                    return;
                $('#content').html($(template_ui));
                $('#PrefsTab .select').removeClass('select');
                $('.contact-sync-tab').addClass('select');


                 getSyncModelFromName("ZOHO", function(model){

                   	var	url= 'core/api/contactprefs/ZOHO',
			                  template= 'admin-settings-import-zoho-prefs';
                  					renderInnerSyncView(url,template,model,function(model){
									showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                  					});
			               
			         });

            }, "#content");
        }

});
/**
 * calendar.js is a script file having a route to show calendar
 * 
 * @module Activities
 */
var DEAL_TRACKS_COUNT;
var DealDetailsRouter = Backbone.Router.extend({

	routes : {
	/* Shows page */
	"deal/:id" : "dealdetails", "dealEdit/:id" : "dealEdit" },

	dealdetails : function(id)
	{
		$("#content").html("<div id='deal-detail-page'></div>")
		// For getting custom fields
		if (App_Deals.customFieldsList == null || App_Deals.customFieldsList == undefined)
		{
			App_Deals.customFieldsList = new Base_Collection_View({ url : '/core/api/custom-fields/scope/position?scope=DEAL', sort_collection : false,
				restKey : "customFieldDefs", templateKey : "admin-settings-customfields", individual_tag_name : 'tr' });
			App_Deals.customFieldsList.collection.fetch();
		}

		this.dealDetailView = new Deal_Modal_Event_View({ url : '/core/api/opportunity/' + id, template : "deal-detail", postRenderCallback : function(el)
		{
			/**
			 * gets the tracks count when user comes to deals page and stores in
			 * global variable
			 */
			if (!DEAL_TRACKS_COUNT){

				getTracksCount(function(count){
						DEAL_TRACKS_COUNT = count;
					initializeDealTabWithCount(id, el);
				});
			} else {
				initializeDealTabWithCount(id, el);
			}

		} });

		var ele = this.dealDetailView.render(true).el;
		$("#deal-detail-page").html(getRandomLoadingImg());
		$('#deal-detail-page').html(ele);

	},

	dealEdit : function(id, deal)
	{

		// If user refreshes the contacts detail view page directly - we
		// should load from the model
		if (!deal)
		{

			console.log("Downloading deal");

			// Download
			var deal_details_model = Backbone.Model.extend({ url : function()
			{
				return '/core/api/opportunity/' + this.id;
			} });

			var model = new deal_details_model();
			model.id = id;
			model.fetch({ success : function(data)
			{

				// Call deal Details again
				App_Deal_Details.dealEdit(id, data);

			}, error : function(data, response)
			{
				if (response && response.status == '403')
					$("#content").html(response.responseText);
			} });

			return;
		}

		add_custom_fields_to_form(deal, function(deal)
		{

			deserialize_deal(deal, 'deal-detail-edit');

		}, "DEAL");

	}

});


/**
 * Shows all the domain users names as ul drop down list to change the owner of
 * a contact
 */
function fill_deal_owners(el, data, callback)
{
	var optionsTemplate = "<li><a class='deal-owner-list' data='{{id}}'>{{name}}</a></li>";
	fillSelect('deal-detail-owner', '/core/api/users', 'domainUsers', callback, optionsTemplate, true);
}

/**
 * To show owner on change
 */
function show_deal_owner()
{
	$('#deal-owner').css('display', 'inline-block');
}

/**
 * To navigate from one deal detail view to other
 */
function deal_detail_view_navigation(id, deal_collection, el)
{
	console.log("collection >>>>>>>>>>>>>>>>");
	console.log(deal_collection);

	var collection_length = deal_collection.length;
	var current_index = deal_collection.indexOf(deal_collection.get(id));
	var previous_deal_id;
	var next_deal_id;

	if (collection_length > 1 && current_index < collection_length && deal_collection.at(current_index + 1) && deal_collection.at(current_index + 1).has("id"))
	{

		next_deal_id = deal_collection.at(current_index + 1).id
	}

	if (collection_length > 0 && current_index != 0 && deal_collection.at(current_index - 1) && deal_collection.at(current_index - 1).has("id"))
	{

		previous_deal_id = deal_collection.at(current_index - 1).id
	}

	if (previous_deal_id != null)
		$('.navigation', el).append('<a style="float:left;" href="#deal/' + previous_deal_id + '" class=""><i class="icon icon-chevron-left"></i></a>');
	if (next_deal_id != null)
		$('.navigation', el).append('<a style="float:right;" href="#deal/' + next_deal_id + '" class=""><i class="icon icon-chevron-right"></i></a>');

}

/**
 * Displays note modal, to add a note related to the contact in contact detail
 * view. Also prepends the contact name to related to field of activity modal.
 */

function fill_relation_deal(el)
{

	var json = App_Deal_Details.dealDetailView.model.toJSON();
	var deal_name = json.name;
	$('.tags', el).html('<li class="tag inline-block v-middle m-r-xs btn btn-xs btn-primary" data="' + json.id + '">' + deal_name + '</li>');

}

function deserialize_deal(value, template)
{
	value = value.toJSON();

	// Loads the form based on template value

	getTemplate(template, value, undefined, function(template_ui){
		if(!template_ui)
			  return;
		var dealForm = $('#content').html($(template_ui));	

		deserializeForm(value, dealForm);

		// Call setupTypeAhead to get contacts
		agile_type_ahead("relates_to", dealForm, contacts_typeahead);

		// Fills owner select element
		populateUsers("owners-list", dealForm, value, 'owner', function(data)
		{
			dealForm.find("#owners-list").html(data);
			if (value.owner)
			{
				$("#owners-list", dealForm).find('option[value=' + value['owner'].id + ']').attr("selected", "selected");
				$("#owners-list", dealForm).closest('div').find('.loading-img').hide();
			}
		});

		// Fills the pipelines list in the select menu.
		populateTracks(dealForm, undefined, value, function(pipelinesList)
		{

			// Fills milestone select element
			populateMilestones(dealForm, undefined, value.pipeline_id, value, function(data)
			{
				dealForm.find("#milestone").html(data);
				if (value.milestone)
				{
					$("#milestone", dealForm).find('option[value=\"' + value.milestone + '\"]').attr("selected", "selected");
				}
				$("#milestone", dealForm).closest('div').find('.loading-img').hide();
			});
		});

		// Enable the datepicker
		$('#close_date', dealForm).datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY});

		add_custom_fields_to_form(value, function(data)
		{
			var el = show_custom_fields_helper(data["custom_fields"], []);
			$("#custom-field-deals", dealForm).html(fill_custom_fields_values_generic($(el), value["custom_data"]));
			$('.date_input', dealForm).datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY});

		}, "DEAL")

	}, "#content");
}

/**
 * 
 * @returns due tasks count upto today
 */
function getTracksCount(callback)
{
	accessUrlUsingAjax('core/api/milestone/tracks/count', function(data){

			if (!isNaN(data))
			{
				return callback(data);
			}

			return callback(0);

	});
}

/**
*
*/
function initializeDealTabWithCount(id, el){
	
	load_deal_tab(el, "");
	var deal_collection;
	if (App_Deals.opportunityCollectionView && App_Deals.opportunityCollectionView.collection)
		deal_collection = App_Deals.opportunityCollectionView.collection;

	if (deal_collection != null && readCookie("agile_deal_view"))
		deal_detail_view_navigation(id, deal_collection, el);

}

/**
 * Displays task modal, to add a deal related to the task in deal detail
 * view. Also prepends the deal name to related deal to field of activity modal.
 */
function fill_relation_deal_task(el)
{

	var json = App_Deal_Details.dealDetailView.model.toJSON();
	var deal_name = json.name;
	$('.deal_tags', el).html('<li class="tag inline-block v-middle m-r-xs btn btn-xs btn-primary" data="' + json.id + '">' + deal_name + '</li>');

}
/**
 * Creates backbone router for Deals/Opportunities create, read and update
 * operations
 */
var DealsRouter = Backbone.Router.extend({

	routes : {

	/* Deals/Opportunity */
	"deals" : "deals", "import-deals" : "importDeals", },

	/**
	 * Fetches all the opportunities as list and also as milestone lists.
	 * Fetching both makes easy to add/get deal to the list rather than
	 * milestone lists. Based on deal_view cookie it show deals to user. Also
	 * fetches Milestones pie-chart and Details graph if deals exist.
	 */
	deals : function()
	{
		pipeline_id = 0;
		if (readCookie("agile_deal_track"))
			pipeline_id = readCookie("agile_deal_track");
		$('#content').html("<div id='opportunity-listners'>&nbsp;</div>");
		// Depending on cookie shows list or milestone view
		if (!readCookie("agile_deal_view"))
		{
			template_key = "opportunities-by-milestones";

			if (pipeline_id == 1)
				pipeline_id = 0;

			getTemplate("new-opportunity-header", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#opportunity-listners').html($(template_ui));

				// Add row-fluid if user prefs are set to fluid
				if (IS_FLUID)
				{
					$('#opportunity-listners').find('div.row').removeClass('row').addClass('row');
				}
				pipeline_count = 0;
				deal_fetching = false;
				DEALS_LIST_COLLECTION = null;
				setupDealsTracksList();
				setupDealFilters();
				initializeDealListners();

			}, "#opportunity-listners");
		}
		else
		{
			DEALS_LIST_COLLECTION = null;
			var query = ''
			if (readCookie('deal-filters'))
			{
				query = '&filters=' + encodeURIComponent(getDealFilters());
			}
			// Fetches deals as list
			this.opportunityCollectionView = new Base_Collection_View({ url : 'core/api/opportunity/based?pipeline_id=' + pipeline_id + query,
				templateKey : "opportunities", individual_tag_name : 'tr', sort_collection : false, cursor : true, page_size : 25,
				postRenderCallback : function(el)
				{
					if (pipeline_id == 1)
						pipeline_id = 0;
					var cel = App_Deals.opportunityCollectionView.el;
					appendCustomfieldsHeaders(el);
					appendCustomfields(el);
					// Showing time ago plugin for close date
					includeTimeAgo(el);
					// Shows Milestones Pie
					pieMilestonesByPipeline(pipeline_id);
					// Shows deals chart
					dealsLineChartByPipeline(pipeline_id);
					deal_bulk_actions.init_dom(el);
					setupDealsTracksList(cel);
					setupDealFilters(cel);
					initializeDealListners(el);
				}, appendItemCallback : function(el)
				{
					appendCustomfields(el);

					// To show timeago for models appended by infini scroll
					includeTimeAgo(el);

				} });
			this.opportunityCollectionView.collection.fetch();

			$('#opportunity-listners').html(this.opportunityCollectionView.render().el);
		}

		$(".active").removeClass("active");
		$("#dealsmenu").addClass("active");
		setTimeout(function()
		{
			$('a.deal-notes').tooltip();
			$('.deal_won_date').tooltip();
		}, 2000);
	},

	/**
	 * import deals from a csv file and then upload all deals to databse
	 */
	importDeals : function()
	{
		$('#content').html("<div id='import-deals-listener'></div>");
		getTemplate("import-deals", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#import-deals-listener').html($(template_ui));
			initializeImportEvents("import-deals-listener");	
		}, "#import-deals-listener");
		
	},

});
/**
 * Creates backbone router for Documents create, read and update operations
 */
var DocumentsRouter = Backbone.Router.extend({

	routes : {

	/* Documents */
	"documents" : "documents", },

	/**
	 * Fetches all the documents as list. Fetching makes easy to add/get
	 * document to the list.
	 */
	documents : function()
	{
		 // Fetches documents as list
		this.DocumentCollectionView = new Document_Collection_Events({ url : 'core/api/documents', templateKey : "documents", cursor : true, page_size : 20,
			individual_tag_name : 'tr', postRenderCallback : function(el)
			{
				includeTimeAgo(el);
				
			}, appendItemCallback : function(el)
			{
				// To show timeago for models appended by infini scroll
				includeTimeAgo(el);
			} });

		this.DocumentCollectionView.collection.fetch();

		// Shows deals as list view
		$('#content').html(this.DocumentCollectionView.render().el);

		$(".active").removeClass("active");
		$("#documentsmenu").addClass("active");
	} });
var FacebookPageTabRouter = Backbone.Router.extend({

	routes : {
	"fbpagetab" : "fbPageTab"
	},

	fbPageTab : function(){

			$('#content').html("<div id='fbPageTab-listners'>&nbsp;</div>");
			getTemplate("admin-settings", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;

				$('#fbPageTab-listners').html($(template_ui));	
				
				accessUrlUsingAjax("fbpage?action=GET_DETAILS", function(data){

					var dataObj = data;
					accessUrlUsingAjax("core/api/forms", function(response){

							dataObj["forms"] = response;
							
							getTemplate('fbpagetab', dataObj, undefined, function(template_ui){
						 		if(!template_ui)
						    		return;
								$('#admin-prefs-tabs-content').html($(template_ui));
								$('#fbPageTab-listners').find('#AdminPrefsTab .select').removeClass('select');
								$('#fbPageTab-listners').find('.integrations-tab').addClass('select');
								$(".active").removeClass("active");
								initializeFbPageTabListners();
							}, "#admin-prefs-tabs-content");
					});
				});
			}, "#fbPageTab-listners");
		
	}
	
});


function accessUrlUsingAjax(url, callback, error_callback){
	$.ajax({ 
		url : url, 
		dataType : 'json',
		success : function(response){

		   try{
		   	  response = $.parseJSON(response);
		   }catch(err){}

			if(callback)
				 callback(response);
		}, error : function(response){

			if(error_callback)
					 error_callback(response);
		}
	});
}var FormsRouter = Backbone.Router.extend({
	routes : { "forms" : "formSettings" },
	formSettings : function()
	{
		console.log("forms collection template");
		
		this.formsListView = new Base_Collection_View({ url : '/core/api/forms', restKey : "forms", templateKey : "forms",
			individual_tag_name : 'tr', postRenderCallback : function(el){
				head.js(LIB_PATH + 'lib/jquery.timeago.js', function(el)
						{
							$("time.form-modified-time", el).timeago();
						});
			} })
		this.formsListView.collection.fetch();
		$("#content").html(this.formsListView.el);
	} });
/**
 * Creates backbone router to access preferences of the user
 */
var PortletsRouter = Backbone.Router
		.extend({

			routes : {
				"add-dashlet" : "adddashlet"
			},

			adddashlet : function() {

				// Back to dashboard if gridster not initalized
				if (!gridster) {
					App_Portlets.navigate("dashboard", {
						trigger : true
					});
					return;
				}

				$('#content').html("<div id='portlets-add-listener'></div>");

				// Load portlets
				this.Catalog_Portlets_View = new Base_Collection_View(
						{
							url : '/core/api/portlets/default',
							templateKey : "portlets-add",
							sort_collection : false,
							individual_tag_name : 'div',
							postRenderCallback : function(el) {

								// Hide activity/Deals/tasks tab if no deals
								// portlets are there
								// (Previliges not allowing to show)
								var array = [ "deals", "taksAndEvents",
										"userActivity" ];
								$.each(array, function(i, item) {
									if ($('#' + item).children().length == 0)
										$('#' + item).parents('.wrapper-md')
												.hide();
								});

								// Preload images (Images are not showing while
								// popover if they are not preloaded)
								preloadImages([
										'img/dashboard_images/Mini-Calendar.jpg',
										'img/dashboard_images/stats.png',
										'img/dashboard_images/Leaderboard.png',
										'img/dashboard_images/account-information.png',
										'img/dashboard_images/Activities.png',
										'img/dashboard_images/Agile-Blog.png',
										'img/dashboard_images/Calls.png',
										'img/dashboard_images/Deals-Funnel.png',
										'img/dashboard_images/Email-opened.png',
										'img/dashboard_images/Events.png',
										'img/dashboard_images/Milestone.png',
										'img/dashboard_images/My-contacts.png',
										'img/dashboard_images/Pending-Deals.png',
										'img/dashboard_images/Revenue-graph.png',
										'img/dashboard_images/Tag-Graph.png',
										'img/dashboard_images/Task-report.png',
										'img/dashboard_images/Task.png',
										'img/dashboard_images/User-Activities.png',
										'img/dashboard_images/Campaign-stats.jpg',

								]);
								// Event initializers
								initializeAddPortletsListeners();
							}
						});

				// Override append Item to show our custom view
				this.Catalog_Portlets_View.appendItem = organize_portlets;

				// 
				this.Catalog_Portlets_View.collection.fetch();

				$('#portlets-add-listener').html(
						this.Catalog_Portlets_View.render().el);

			}
		});

/*
 * Append the dashbaord images to body.
 */
function preloadImages(arrayOfImages) {
	$(arrayOfImages).each(function() {
		$('<img />').attr('src', this).appendTo('body').css('display', 'none');
	});
}

/*
 * Delete pop up modal sholud be open for deleting portlet.
 */
function deletePortlet(el) {

	var p_id = el.id.split("-close")[0];
	var $modal = $('#portletDeleteModal');

	$modal.modal('show');
	$modal.find('.save-modal').attr('id', p_id);

	var model = Portlets_View.collection.get(p_id);
	var header_text = $('#' + p_id).parent()
			.find('.portlet_header > h4 > span').text();
	var header_sub_text = $('#' + p_id).parent().find(
			'.portlet_header > h4 > small').text();

	var deleteWarnHTML = "";

	if (header_text && header_text.trim() != "Getting started")
		deleteWarnHTML = "Are you sure you want to delete Dashlet - "
				+ header_text.trim() + " " + header_sub_text.trim() + "?";

	else if (header_text && header_text.trim() == "Getting started")
		deleteWarnHTML = "Are you sure you want to delete Dashlet - "
				+ header_text.trim()
				+ "?<br/>This dashlet can't be added back again.";

	else if (model.get("name") == "Leaderboard")
		deleteWarnHTML = "Are you sure you want to delete Dashlet - Leaderboard "
				+ portlet_utility.getDurationForPortlets(
						model.get("settings").duration, function(duration) {
							return duration;
						}) + "?";

	else if (model.get("name") == "Mini Calendar")
		deleteWarnHTML = "Are you sure you want to delete Dashlet - Mini Calendar?";

	else
		deleteWarnHTML = "Are you sure you want to delete Dashlet - Activity Overview "
				+ portlet_utility.getDurationForPortlets(
						model.get("settings").duration, function(duration) {
							return duration;
						}) + "?";

	$modal.find(".modal-body").html(deleteWarnHTML);
}

/**
 * Hiding all errors related to tag graph settings.
 */
function hidePortletErrors(ele) {
	if ($('#' + ele.id).next().is(':visible'))
		$('#' + ele.id).next().hide();
}

/**
 * Convert time in human readable format.
 */
function displayTimeAgo(elmnt)
{
	head.js('lib/jquery.timeago.js', function()
	{
		$(".time-ago", elmnt).timeago();
	});
	
	console.log($("article.stream-item").parent());
	
	$("article.stream-item").parent().addClass("social-striped");
}
var ReferelRouter = Backbone.Router.extend({

	routes : {

	"referrals" : "referrelprogram"

	},

	referrelprogram : function()
	{

		head.js(LIB_PATH + '../lib/zeroclipboard/ZeroClipboard.js', function()
		{
			referelsview = new Base_Collection_View({ url : '/core/api/users/getreferedbyme?reference_domain=' + CURRENT_DOMAIN_USER.domain,
				templateKey : "referrals", individual_tag_name : 'tr', postRenderCallback : function(el)
				{

					initZeroClipboard("url_clip_button", "referral_url");

				} });

			referelsview.collection.fetch();

			$('#content').html(referelsview.render().el);
		});

	} });
/**
 * Creates a backbone router to create, read and update reports
 * 
 * @module Reports
 */
var ReportsRouter = Backbone.Router
		.extend({

			routes : {

			/* Reports */
			"reports" : "reports", "email-reports" : "emailReportTypes", "activity-reports" : "activityReports", "activity-report-add" : "activityReportAdd",
				"activity-report-edit/:id" : "activityReportEdit", "acivity-report-results/:id" : "activityReportInstantResults",
				"contact-reports" : "emailReports", "report-add" : "reportAdd", "report-edit/:id" : "reportEdit",
				"report-results/:id" : "reportInstantResults", "report-charts/:type" : "reportCharts", "report-funnel/:tags" : "showFunnelReport",
				"report-growth/:tags" : "showGrowthReport", "report-cohorts/:tag1/:tag2" : "showCohortsReport", "report-ratio/:tag1/:tag2" : "showRatioReport","report-deals":"showIncomingDeals","report-calls/:type" : "showCallsReport" },

			/**
			 * Shows reports categories
			 */
			reports : function()
			{
				if (!tight_acl.checkPermission('REPORT'))
					return;

				$("#content").html("<div id='reports-listerners-container'></div>");
				getTemplate('report-categories', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#reports-listerners-container').html($(template_ui));

					initializeReportsListeners();
					hideTransitionBar();
					$(".active").removeClass("active");
					$("#reportsmenu").addClass("active");

					$('[data-toggle="tooltip"]').tooltip();	

				}, "#reports-listerners-container");
				
			},

	/**
	 * Shows email-reports categories
	 */
	emailReportTypes : function()
	{
		getTemplate('email-report-categories', {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			$(".active").removeClass("active");
			$("#reportsmenu").addClass("active");

		}, "#content");

		
	},
	
	activityReports : function()
	{
		$("#content").html("<div id='reports-listerners-container'></div>");
		$("#reports-listerners-container").html(getRandomLoadingImg());
		this.activityReports = new Base_Collection_View({ url : '/core/api/activity-reports', restKey : "activityReports", templateKey : "activity-report", individual_tag_name : 'tr', 
			postRenderCallback: function(){
				initializeActivityReportsListeners();
			} });
		this.activityReports.collection.fetch();
		$("#reports-listerners-container").html(this.activityReports.render().el);

		$(".active").removeClass("active");
		$("#reportsmenu").addClass("active");
	},
	
	activityReportAdd : function(){
		
		if(!tight_acl.checkPermission('REPORT'))
			return;
		
		if(!tight_acl.checkPermission('ACTIVITY'))
			return;

		$("#content").html("<div id='reports-listerners-container'></div>");
		$("#reports-listerners-container").html(getRandomLoadingImg());
		
		var count = 0;
		var activity_report_add = new Base_Model_View({ url : 'core/api/activity-reports', template : "activity-reports-add", window : "activity-reports", isNew : true,
			postRenderCallback : function(el)
			{

				initializeActivityReportsListeners();
				initializeReportsListeners();
				if (count != 0)
					return;
								
				// Fills owner select element
				fillSelect("users-list", '/core/api/users', 'domainUser', function()
				{
					head.js(LIB_PATH + 'lib/jquery.multi-select.js',CSS_PATH + 'css/businesshours/jquerytimepicker.css', LIB_PATH + 'lib/businesshours/jquerytimepicker.js', function()
					{
						$('#activity-type-list, #users-list',el).multiSelect();
						$('#ms-activity-type-list .ms-selection', el).children('ul').addClass('multiSelect').attr("name", "activity").attr("id", "activity_type");
						$('#ms-users-list .ms-selection', el).children('ul').addClass('multiSelect').attr("name", "user_ids").attr("id", "user_ids");
						++count;
						if (count > 0)
							$("#reports-listerners-container").html(el);
							
							$('.activity_time_timepicker', el).timepicker({ 'timeFormat': 'H:i ' ,'step': 30});
							$(".activity_time_timepicker", el).val("09:00");
							$("#report_timezone", el).val(ACCOUNT_PREFS.timezone);
					});
				}, '<option value="{{id}}">{{name}}</option>', true, el);
				
				} });

		$("#reports-listerners-container").html(getRandomLoadingImg());
		activity_report_add.render();

	},
	
	/**
	 * Edits a report by de-serializing the existing report into its saving
	 * form, from there it can be edited and saved. Populates users and loads
	 * agile.jquery.chained.min.js to match the conditions with the values of
	 * input fields.
	 */
	activityReportEdit : function(id)
	{

		if(!tight_acl.checkPermission('REPORT'))
			return;
		
		if(!tight_acl.checkPermission('ACTIVITY'))
			return;
		$("#content").html("<div id='reports-listerners-container'></div>");
		$("#reports-listerners-container").html(getRandomLoadingImg());
		// Counter to set when script is loaded. Used to avoid flash in page
		var count = 0;

		// If reports view is not defined, navigates to reports
		if (!this.activityReports || !this.activityReports.collection || this.activityReports.collection.length == 0 || this.activityReports.collection.get(id) == null)
		{
			this.navigate("activity-reports", { trigger : true });
			return;
		}

		// Gets a report to edit, from reports collection, based on id
		var activityReport = this.activityReports.collection.get(id);
		var report_model = new Base_Model_View({ url : 'core/api/activity-reports', change : false, model : activityReport, template : "activity-reports-add", window : "activity-reports",
		postRenderCallback : function(el)
			{
				initializeActivityReportsListeners();
				initializeReportsListeners();
				if (count != 0)
					return;
				fillSelect("users-list", '/core/api/users', 'domainUser', function()
						{
							var json = activityReport.toJSON();
							var time=json.activity_start_time;
							
							var frequency=json.frequency;
							
							deserializeForm(json,$('#activityReportsForm',el));
							
							
							head.js(LIB_PATH + 'lib/jquery.multi-select.js',CSS_PATH + 'css/businesshours/jquerytimepicker.css', LIB_PATH + 'lib/businesshours/jquerytimepicker.js', function()
							{

								$('#activity-type-list, #users-list',el).multiSelect();
								$('#ms-activity-type-list .ms-selection', el).children('ul').addClass('multiSelect').attr("name", "activity").attr("id", "activity_type");
								$('#ms-users-list .ms-selection', el).children('ul').addClass('multiSelect').attr("name", "user_ids").attr("id", "user_ids");
								
								$("#reports-listerners-container").html(el)
								$.each(json.user_ids,function(i,user_id){
									$('#users-list').multiSelect('select',user_id);
									console.log('select user---',user_id);
								});
								$.each(json.activity,function(i,activity){
									$('#activity-type-list').multiSelect('select',activity);
									console.log('select activity-------',activity);
								});
								$('#ms-activity-type-list .ms-selection').children('ul').addClass('multiSelect').attr("name", "activity").attr("id", "activity_type");
								$('#ms-users-list .ms-selection').children('ul').addClass('multiSelect').attr("name", "user_ids").attr("id", "user_ids");
								
								if(json.report_timezone==null){
									$("#report_timezone").val(ACCOUNT_PREFS.timezone);
								}
								// based on frequency we are showing and hideing the time and date and month fields
								if (frequency == "DAILY")
								{
									$("#activity_report_weekday").css("display", "none");
									$("#activity_report_day").css("display", "none");
									$("#activity_report_time").css("display", "block");

								}
								else if (frequency == "WEEKLY")
								{
									$("#activity_report_day").css("display", "none");
									$("#activity_report_time").css("display", "block");
									$("#activity_report_weekday").css("display", "block");

								}
								else if (frequency == "MONTHLY")
								{
									$("#activity_report_weekday").css("display", "none");
									$("#activity_report_time").css("display", "block");
									$("#activity_report_day").css("display", "block");

								}
								$('.activity_time_timepicker').timepicker({ 'timeFormat': 'H:i ' ,'step': 30});
								
							});
						}, '<option value="{{id}}">{{name}}</option>', true, el);
				
			} });

		$("#reports-listerners-container").html(getRandomLoadingImg());
		report_model.render();


	},
	
	/**
	 * Shows list of reports, with an option to add new report
	 */
	emailReports : function()
	{
			$("#content").html("<div id='reports-listerners-container'></div>");
			this.reports = new Base_Collection_View({ url : '/core/api/reports', restKey : "reports", templateKey : "report", individual_tag_name : 'tr', 
				postRenderCallback: function(){
					initializeReportsListeners();
				}});

			this.reports.collection.fetch();
			$("#reports-listerners-container").html(this.reports.render().el);

	},

	/**
	 * Loads a template to add new report. Populates users drop down list and
	 * loads agile.jquery.chained.min.js to chain conditions and values of input
	 * fields, from postRenderCallback of its Base_Model_View.
	 */
	reportAdd : function()
	{
		var count = 0;
		$("#content").html("<div id='reports-listerners-container'></div>");
		$("#reports-listerners-container").html(getRandomLoadingImg());
		SEARCHABLE_CONTACT_CUSTOM_FIELDS = undefined;
		var report_add = new Report_Filters_Event_View({ url : 'core/api/reports', template : "reports-add", window : "contact-reports", isNew : true,
			postRenderCallback : function(el)
			{
				initializeReportsListeners();
				// Counter to set when script is loaded. Used to avoid flash in
				// page
				if (count != 0)
					return;
				fillSelect("custom-fields-optgroup", "core/api/custom-fields/scope?scope=CONTACT", undefined, function()
				{

					head.js(LIB_PATH + 'lib/jquery.multi-select.js' ,CSS_PATH + 'css/businesshours/jquerytimepicker.css', LIB_PATH + 'lib/businesshours/jquerytimepicker.js', function()
					{

						$('#multipleSelect', el).multiSelect({ selectableOptgroup : true });

						$('.ms-selection', el).children('ul').addClass('multiSelect').attr("name", "fields_set").attr("id", "fields_set").sortable();

						++count;
						if (count > 1)
							$("#reports-listerners-container").html(el);

						$('.report_time_timepicker', el).timepicker({ 'timeFormat': 'H:i ' ,'step': 30});
						$(".report_time_timepicker", el).val("09:00");
						$("#report_timezone", el).val(ACCOUNT_PREFS.timezone);
					});
				}, '<option value="custom_{{field_label}}">{{field_label}}</option>', true, el);

				head.js(LIB_PATH + 'lib/jquery-ui.min.js', LIB_PATH + 'lib/agile.jquery.chained.min.js', function()
				{
					scramble_input_names($(el).find('div#report-settings'));
					chainFiltersForContact(el, undefined, function()
					{
						++count;
						if (count > 1)
							$("#reports-listerners-container").html(el)
					});
				});

			} });

		$("#reports-listerners-container").html(getRandomLoadingImg());
		report_add.render();
	},
				
	/**
	 * Edits a report by de-serializing the existing report into its saving
	 * form, from there it can be edited and saved. Populates users and loads
	 * agile.jquery.chained.min.js to match the conditions with the values of
	 * input fields.
	 */
	reportEdit : function(id)
	{
		$("#content").html("<div id='reports-listerners-container'></div>");
		$("#reports-listerners-container").html(getRandomLoadingImg());
		// Counter to set when script is loaded. Used to avoid flash in page
		var count = 0;

		// Gets a report to edit, from reports collection, based on id
		var report = this.reports.collection.get(id);
		var report_model = new Report_Filters_Event_View({ url : 'core/api/reports', change : false, model : report, template : "reports-add", window : "contact-reports", id : "reports-listerners-container",
			postRenderCallback : function(el)
			{
				initializeReportsListeners();
				if (count != 0)
					return;
				
				// Gets a report to edit, from reports collection, based on id
				
					fillSelect("custom-fields-optgroup", "core/api/custom-fields/scope?scope=CONTACT", undefined, function()
						{

							head.js(LIB_PATH + 'lib/jquery.multi-select.js', CSS_PATH + 'css/businesshours/jquerytimepicker.css',
									LIB_PATH + 'lib/businesshours/jquerytimepicker.js', function()
									{
										console.log(el);
										console.log(report.toJSON());
										$('#multipleSelect', el).multiSelect({ selectableOptgroup : true });
										++count;
										if (count > 1)
											deserialize_multiselect(report.toJSON(), el);

										setTimeout(function()
										{
											$('.report_time_timepicker').timepicker({ 'timeFormat' : 'H:i ', 'step' : 30 });

											var frequency = report.toJSON().duration;

											if (frequency == "DAILY")
											{
												$("#contact_report_weekday").css("display", "none");
												$("#contact_report_day").css("display", "none");
												$("#contact_report_time").css("display", "block");

											}
											else if (frequency == "WEEKLY")
											{
												$("#contact_report_day").css("display", "none");
												$("#contact_report_time").css("display", "block");
												$("#contact_report_weekday").css("display", "block");

											}
											else if (frequency == "MONTHLY")
											{
												$("#contact_report_weekday").css("display", "none");
												$("#contact_report_time").css("display", "block");
												$("#contact_report_day").css("display", "block");

											}

											if (report.toJSON().report_timezone == null)
											{
												$("#report_timezone").val(ACCOUNT_PREFS.timezone);
											}
										}, 1000);
									});

						}, '<option value="custom_{{field_label}}">{{field_label}}</option>', true, el);

						head.js(LIB_PATH + 'lib/jquery-ui.min.js', LIB_PATH + 'lib/agile.jquery.chained.min.js', LIB_PATH + 'lib/jquery.multi-select.js',
								function()
								{

									chainFiltersForContact(el, report.toJSON(), function()
									{
										++count
										if (count > 1)
											deserialize_multiselect(report.toJSON(), el);
									});
									scramble_input_names($(el).find('div#report-settings'));
								});

					} });

				$("#reports-listerners-container").html(getRandomLoadingImg());
				report_model.render();

			},

			/**
			 * Shows report results. It gets report object from reports list, if
			 * it is list is not available then it fetches report based on
			 * report id, send request to process results, and shows them
			 */
			reportInstantResults : function(id, report)
			{

				if (!report)
					// If reports view is not defined, navigates to reports
					if (!this.reports || !this.reports.collection || this.reports.collection.length == 0 || this.reports.collection.get(id) == null)
					{

						// Shows loading while report is being fetched
						$("#content").html(getRandomLoadingImg());
						var reportModel = new Backbone.Model();
						reportModel.url = "core/api/reports/" + id;
						reportModel.fetch({ success : function(data)
						{
							// Fetches reports and call to show instant results
							App_Reports.reportInstantResults(id, data.toJSON());
						} });
						return;

					}
					else
					{
						report = this.reports.collection.get(id).toJSON();
					}

				// Stores in global variable, as it is required to build custom
				// table
				// headings
				REPORT = report;

				var report_results_view = new Base_Collection_View({ url : "core/api/reports/show-results/" + id, modelData : report,
					templateKey : "report-search", individual_tag_name : 'tr', cursor : true, sort_collection : false, page_size : 15, });// Collection
				var _that = this;
				$.getJSON("core/api/custom-fields/type/scope?type=DATE&scope=CONTACT", function(customDatefields)
				{
					// Report built with custom table, as reports should be
					// shown with
					// custom order selected by user
					report_results_view.appendItem = function(base_model)
					{
						reportsContactTableView(base_model, customDatefields, this);
					};

					report_results_view.collection.fetch();
				});
				$("#content").html(report_results_view.render().el);
			},

			/**
			 * Returns Funnel reports based on tags
			 * 
			 * @param tags -
			 *            workflow id
			 */
			showFunnelReport : function(tags)
			{

				head.load(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION, function()
				{
					getTemplate("report-funnel", {}, undefined, function(template_ui){
						if(!template_ui)
							  return;

						// Load Reports Template
						$('#content').html($(template_ui));
						// Set the name
						$('#reports-funnel-tags').text(tags);

						initFunnelCharts(function()
						{
							showFunnelGraphs(tags);
						});

						$(".active").removeClass("active");
						$("#reportsmenu").addClass("active");
						
						highlightDatepickerOption();

					}, "#content");

				});
			},

			/**
			 * Returns growth report based on the tags
			 * 
			 * @param tags -
			 *            comma separated tags
			 */
			showGrowthReport : function(tags)
			{

				head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION, function()
				{

					// Load Reports Template
					getTemplate("report-growth", {}, undefined, function(template_ui){
						if(!template_ui)
							  return;
						$('#content').html($(template_ui));	

						// Set the name
						$('#reports-growth-tags').text(tags);

						initFunnelCharts(function()
						{
							showGrowthGraphs(tags);
						});

					}, "#content");
					
				});

				$(".active").removeClass("active");
				$("#reportsmenu").addClass("active");
				highlightDatepickerOption();
			},
			
			
				
		/**
			 * Returns calls report
			 * 
			 * @param tags -
			 *            comma separated tags
			 */
			showCallsReport : function(reportType)
			{

				head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js', function()
				{
					
					/** Default dropdown value to be considered*/ 
					var graphOn='number-of-calls';
					
					/**Default template id to be loaded*/
					var templateId="report-calls";
					
					/**when it is a call outcome selection*/
					if(reportType == 'pie-graph'){
						//templateId="report-calls-piechart";
						templateId=templateId+"-piechart";
						
					}
					
					getTemplate(templateId, {}, undefined, function(template_ui){
						if(!template_ui)
							  return;

						// Load Reports Template
						$('#content').html($(template_ui));
					
					/**Reinitialize the variable which holds the user preference abt report type*/
	               if(reportType == 'average-calls'){
						graphOn='average-calls';
						$('select[id="typeCall"]').find('option[value="average-calls"]').attr("selected",true);
						
					}else{
						$('select[id="typeCall"]').find('option[value="number-of-calls"]').attr("selected",true);
					}
	               
	               initReportsForCalls(function()
							{
	            	   
	            	   /** Get date range selected for every call back call */
	            	   
	            		var options = "?";

						var range = $('#range').html().split("-");
						var start_time=new Date(range[0]).getTime() / 1000;

						var end_value = $.trim(range[1]);

						
						if (end_value)
							end_value = end_value + " 23:59:59";

						var end_time=new Date(end_value).getTime() / 1000;
						options += ("start-date=" + start_time + "&end-date=" + end_time);
						
						var url='core/api/portlets/portletCallsPerPerson/' + options;
						
						graphOn=$("#typeCall option:selected").val();
					    
					    var userDropDown=$('#users option:selected').val();
					    
					    if(userDropDown != undefined){
					    	if(userDropDown != 'All' && userDropDown != ""){
								var usersUrl=url;
								url=url+'&user=["'+userDropDown+'"]';
							}
					    	
					    }
					    prepareNewReport(url);
					    
					    /**Function block to be executed for every call back*/
							
							function prepareNewReport(url){
							
								 
			                        var selector="email-reports";
									
									var answeredCallsCountList=[];
									var busyCallsCountList=[];
									var failedCallsCountList=[];
									var voiceMailCallsCountList=[];
									var callsDurationList=[];
									var totalCallsCountList=[];
									var domainUsersList=[];
									var domainUserImgList=[];
									var averageCallList=[];
									var sizey = parseInt($('#'+selector).parent().attr("data-sizey"));
									var topPos = 50*sizey;
									if(sizey==2 || sizey==3)
										topPos += 50;
									$('#'+selector).html("<div class='text-center v-middle opa-half' style='margin-top:"+topPos+"px'><img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");
									
									portlet_graph_data_utility.fetchPortletsGraphData(url,function(data){
										if(data.status==403){
											$('#'+selector).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
											return;
										}
										answeredCallsCountList=data["answeredCallsCountList"];
										busyCallsCountList=data["busyCallsCountList"];
										failedCallsCountList=data["failedCallsCountList"];
										voiceMailCallsCountList=data["voiceMailCallsCountList"];
										callsDurationList=data["callsDurationList"];
										totalCallsCountList=data["totalCallsCountList"];
										domainUsersList=data["domainUsersList"];
										domainUserImgList=data["domainUserImgList"];
										pieGraphRegions=['Answered Calls','Busy Calls','Failed Calls','Voice Mail Calls'];
										
										var series=[];
										var text='';
										var colors;
										
										/**This executes for plotting pie chart*/
										
										if(reportType == 'pie-graph'){ /**When it is a pie graph and dropdown is Number of calls */
											
											var answeredCallCount=0;
											var CompleteCallsCount=[];
											$.each(answeredCallsCountList,function(index,answeredCall){
												answeredCallCount +=answeredCall;
											});
											CompleteCallsCount.push(answeredCallCount);
											var busyCallCount=0;
											$.each(busyCallsCountList,function(index,busyCall){
												busyCallCount +=busyCall;
											});
											CompleteCallsCount.push(busyCallCount);
											var failedCallCount=0;
											$.each(failedCallsCountList,function(index,failedCall){
												failedCallCount +=failedCall;
											});
											CompleteCallsCount.push(failedCallCount);
											var voicemailCallCount=0;
											$.each(voiceMailCallsCountList,function(index,voicemailCall){
												voicemailCallCount +=voicemailCall;
											});
											CompleteCallsCount.push(voicemailCallCount);
											
											
											portlet_graph_utility.callsByPersonPieGraph(selector,pieGraphRegions,CompleteCallsCount);
											return;
											
										}
										
										/**This executes for plotting the Bar graph*/ 
										if(graphOn == "number-of-calls"){
											var tempData={};
											tempData.name="Answered";
											tempData.data=answeredCallsCountList;
											series[0]=tempData;
											
											tempData={};
											tempData.name="Busy";
											tempData.data=busyCallsCountList;
											series[1]=tempData;
											
											tempData={};
											tempData.name="Failed";
											tempData.data=failedCallsCountList;
											series[2]=tempData;
											
											tempData={};
											tempData.name="Voicemail";
											tempData.data=voiceMailCallsCountList;
											series[3]=tempData;
											text="Total Calls";
											colors=['green','blue','red','violet'];
										}else if(graphOn == "average-calls"){
											
												var tempData={};
												tempData.name="Average Call Duration";
											    $.each(callsDurationList,function(index,duration){
											    if(duration > 0){
											    	
													var callsDurationAvg=duration/answeredCallsCountList[index];
													averageCallList.push(callsDurationAvg);
											    	
											    }else{
											    	averageCallList.push(0);
											    }
												
											    });
											    tempData.data=averageCallList;
											    tempData.showInLegend=false;
											    series[0]=tempData;
											    text="Average Call Duration (Mins)";
											    colors=['green'];
										}
										else{
											var tempData={};
											tempData.name="Total Call Duration";
											var callsDurationInMinsList = [];
											$.each(callsDurationList,function(index,duration){
												if(duration > 0){
													callsDurationInMinsList[index] = duration;
												}else{
													callsDurationInMinsList[index] = 0;
												}
												
											});
											tempData.data=callsDurationInMinsList;
											tempData.showInLegend=false;
											series[0]=tempData;
											text="Calls Duration (Mins)";
											colors=['green'];
										}
										
										portlet_graph_utility.callsPerPersonBarGraph(selector,domainUsersList,series,totalCallsCountList,callsDurationList,text,colors,domainUserImgList);
							});
						
							return;
						}
							
							});

					}, "#content");
				});
				
			},


			/**
			 * Returns Cohorts Graphs with two tag1
			 * 
			 * @param id -
			 *            workflow id
			 */
			showCohortsReport : function(tag1, tag2)
			{

				head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION, function()
				{

					// Load Reports Template
					getTemplate("report-cohorts", {}, undefined, function(template_ui){
						if(!template_ui)
							  return;
						$('#content').html($(template_ui));	

						// Set the name
						$('#reports-cohorts-tags').text(tag1 + " versus " + tag2);

						initFunnelCharts(function()
						{
							showCohortsGraphs(tag1, tag2);
						});

					}, "#content");
					
					
				});

				$(".active").removeClass("active");
				$("#reportsmenu").addClass("active");
				highlightDatepickerOption();
			},
			/**
			 * Returns Cohorts Graphs with two tag1
			 * 
			 * @param id -
			 *            workflow id
			 */
			showRatioReport : function(tag1, tag2)
			{

				head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION, function()
				{

					// Load Reports Template
					getTemplate("report-ratio", {}, undefined, function(template_ui){
						if(!template_ui)
							  return;
						$('#content').html($(template_ui));	

						// Set the name
						$('#reports-ratio-tags').text(tag1 + " versus " + tag2);

						initFunnelCharts(function()
						{
							showRatioGraphs(tag1, tag2);
						});

						$(".active").removeClass("active");
						$("#reportsmenu").addClass("active");

						highlightDatepickerOption();

					}, "#content");
					
				});


			},

			/**
			 * Shows reports charts of growth or funnel
			 */
			reportCharts : function(type)
			{
				var template_name = "report-growth";

				if (type)
					template_name = "report-" + type + "-form";

				$("#content").html("<div id='reports-listerners-container'></div>");
				getTemplate(template_name, {}, undefined, function(template_ui){
					if(!template_ui)
						  return;

							var el = $(template_ui);
				$("#reports-listerners-container").html(el);
				initializeChartReportsListeners();

				if (type && (type == 'growth' || type == 'funnel'))
				{
					setup_tags_typeahead();
					return;
				}
				$.each($("[id=tags-reports]", el), function(i, element)
				{
					console.log(element);
					addTagsDefaultTypeahead(element);
				});


				}, "#reports-listerners-container");
			},
			showIncomingDeals : function(){
				hideTransitionBar();
				head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js',function()
						{

							// Load Reports Template
						getTemplate("report-deals", {}, undefined, function(template_ui){
						if(!template_ui)
							  return;
						$('#content').html($(template_ui));	

							initFunnelCharts(function()
							{
								showDealsGrowthReport();
							});
						}, "#content");
					});
			}
			
	});
/**
 * Creates backbone router to access preferences of the user (email templates,
 * email (gmail/IMAP), notifications and etc..).
 */

var HAS_EMAIL_ACCOUNT_LIMIT_REACHED = false;

var EMAIL_PREFS_WIDGET_SIZE = 0;

var SettingsRouter = Backbone.Router
		.extend({
			routes : {

			/* Settings */
			"settings" : "settings",

			/* User preferences */
			"user-prefs" : "userPrefs",

			/* Change Password */
			"change-password" : "changePassword",

			/* Email (Gmail / IMAP) */
			"email" : "email",

			/* IMAP add prefs */
			"imap" : "imapAdd",

			/* IMAP edit prefs */
			"imap/:id" : "imapEdit",

			/* Office add prefs */
			"office" : "officeAdd",

			/* Office edit prefs */
			"office/:id" : "officeEdit",

			/* Social preferences */
			"social-prefs" : "socialPrefs",

			/* Gmail share preferences */
			"gmail/:id" : "gmailShare",

			/* Email templates */
			"email-templates" : "emailTemplates", "email-template-add" : "emailTemplateAdd", "email-template/:id" : "emailTemplateEdit",

			/* Notifications */
			"notification-prefs" : "notificationPrefs",

			/* scheduling */
			"scheduler-prefs" : "scheduler",

			/* support page */
			"help" : "support",

			/* contact-us help email */
			"contact-us" : "contactUsEmail",

			/* Theme & Layout page */
			"themeandlayout" : "themeandlayout" },

			/**
			 * Shows all the options to access user's Preferences
			 */
			/*
			 * settings : function() { var html = getTemplate("settings", {});
			 * $('#content').html(html); // Update Menu
			 * $(".select").removeClass("select");
			 * $("#settingsmenu").addClass("select"); },
			 */

			/**
			 * Creates a Model to show and edit Personal Preferences, and sets
			 * HTML Editor. Reloads the page on save success.
			 */
			userPrefs : function()
			{
				//var data;
				var that =this;
				getTemplate("settings", {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	
					getTemplate("settings-user-prefs-tab", {}, undefined, function(template_ui1){
						if(!template_ui1)
							  return;
						$('#prefs-tabs-content').html($(template_ui1));
					
						/* $('#prefs-tabs-content').html(getRandomLoadingImg()); */

						$.getJSON("/core/api/user-prefs", function(data){

							var prefsData = new BaseModel(data);
							that.userPrefsProfile(prefsData);
							$('#prefs-tabs-content a[href="#settings-user-prefs"]').on('click', function(e) {
								e.preventDefault();
								that.userPrefsProfile(prefsData);
								
							});

							$('#prefs-tabs-content a[href="#settings-reminders"]').on('click', function(e) {
								e.preventDefault();
								that.userPrefsReminders(prefsData);
								
							});
							$('#prefs-tabs-content a[href="#settings-advanced"]').on('click', function(e) {
								e.preventDefault();
								that.userPrefsAdvanced(prefsData);
								
							});

						}).done(function(){
							hideTransitionBar();
						}).fail(function(){
							hideTransitionBar();
						});
							
						$('#PrefsTab .select').removeClass('select');
						$('.user-prefs-tab').addClass('select');
						$(".active").removeClass("active");
						$("#prefs-tabs-content .prefs-profile").addClass("active");
						// $('#content').html(view.render().el);
					}, null);	
				}, "#content");
			},

			/**
			 * Creates a Model to show and edit Personal Preferences, and sets
			 * HTML Editor. Reloads the page on save success.
			 */
			changePassword : function()
			{

				getTemplate("settings", {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	
					getTemplate('settings-change-password', {}, undefined, function(template_ui1){
						if(!template_ui1)
							  return;

						$('#prefs-tabs-content').html($(template_ui1));	
						$('#PrefsTab .select').removeClass('select');
						$('.user-prefs-tab').addClass('select');
						$(".active").removeClass("active");

						// Save button action of change password form, If it is out of
						// this router wont navigate properly
						$("#saveNewPassword").on(
								"click",
								function(e)
								{

									e.preventDefault();
									var saveBtn = $(this);

									// Returns, if the save button has disabled
									// attribute
									if ($(saveBtn).attr('disabled'))
										return;

									// Disables save button to prevent multiple click
									// event issues
									disable_save_button($(saveBtn));

									var form_id = $(this).closest('form').attr("id");

									if (!isValidForm('#' + form_id))
									{

										// Removes disabled attribute of save button
										enable_save_button($(saveBtn));
										return false;
									}
									// Returns if same password is given
									if ($("#current_pswd").val() == $("#new_pswd").val())
									{
										$('#changePasswordForm').find('span.save-status').html(
												"<span style='color:red;margin-left:10px;'>Current and New Password can not be the same</span>");
										$('#changePasswordForm').find('span.save-status').find("span").fadeOut(5000);
										enable_save_button($(saveBtn));
										return false;
									}

									// Show loading symbol until model get saved
									$('#changePasswordForm').find('span.save-status').html(getRandomLoadingImg());

									var json = serializeForm(form_id);

									$.ajax({
										url : '/core/api/user-prefs/changePassword',
										type : 'PUT',
										data : json,
										success : function()
										{
											$('#changePasswordForm').find('span.save-status').html(
													"<span style='color:green;margin-left:10px;'>Password changed successfully</span>").fadeOut(5000);
											enable_save_button($(saveBtn));
											$('#' + form_id).each(function()
											{
												this.reset();
											});
											history.back(-1);
										},
										error : function(response)
										{
											$('#changePasswordForm').find('span.save-status').html("");
											$('#changePasswordForm').find('input[name="current_pswd"]').closest(".controls").append(
													"<span style='color:red;margin-left:10px;'>Incorrect Password</span>");
											$('#changePasswordForm').find('input[name="current_pswd"]').closest(".controls").find("span").fadeOut(5000);
											$('#changePasswordForm').find('input[name="current_pswd"]').focus();
											enable_save_button($(saveBtn));
										} });

								});

					}, "#prefs-tabs-content");

				}, "#content");
			},

			/**
			 * Shows social preferences (LinkedIn and Twitter) to get access.
			 * Loads linkedIn and then appends Twitter to the view
			 */
			socialPrefs : function()
			{
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));

					var data = { "service" : "linkedin" };
					var itemView = new Settings_Modal_Events({ url : '/core/api/social-prefs/LINKEDIN', template : "settings-social-prefs", data : data, postRenderCallback : function(el){
					} });

					$('#prefs-tabs-content').html(itemView.render().el);

					data = { "service" : "twitter" };
					var itemView2 = new Settings_Modal_Events({ url : '/core/api/social-prefs/TWITTER', template : "settings-social-prefs", data : data , postRenderCallback : function(el){
					} });

					$('#prefs-tabs-content').append(itemView2.render().el);
					$('#PrefsTab .select').removeClass('select');
					$('.social-prefs-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");
			},

			/**
			 * Shows Gmail and IMAP preferences to get access. Allows to get the
			 * communicated mails between contact and logged in preference.
			 */
			/**
			 * Shows Gmail and IMAP preferences to get access. Allows to get the
			 * communicated mails between contact and logged in preference.
			 */
			email : function()
			{
				var that = this;
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
						
					$('#content').html($(template_ui));	

					getTemplate('settings-email-prefs', {}, undefined, function(template_ui1){
							if(!template_ui1)
								  return;
							$('#prefs-tabs-content').html($(template_ui1));	
							that.imapListView = {};
							that.officeListView = {};
							that.gmailListView = {};

							$('#PrefsTab .select').removeClass('select');
							$('.email-tab').addClass('select');
							$(".active").removeClass("active");

					}, "#prefs-tabs-content");

					var socialHeight = 0;
					$.getJSON("/core/api/emails/synced-accounts", function(data)
					{
						if (typeof data !== undefined && data.hasOwnProperty('emailAccountsLimitReached') && data.emailAccountsLimitReached)
							HAS_EMAIL_ACCOUNT_LIMIT_REACHED = true;
						else
							HAS_EMAIL_ACCOUNT_LIMIT_REACHED = false;

						var limit = data.emailAccountsLimit;

						load_gmail_widgets(limit);
						load_imap_widgets(limit);
						load_office365_widgets(limit);

					});

				}, "#content");
			},

			/**
			 * Imap Update settings
			 */
			imapEdit : function(imap_id)
			{
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));
					if (App_Settings.imapListView === undefined)
					{
						App_Settings.navigate("email", { trigger : true });
						return;
					}

					var imapmodel = App_Settings.imapListView.collection.get(imap_id);
					// Gets IMAP Prefs
					var itemView2 = new Settings_Modal_Events({ url : '/core/api/imap/', model : imapmodel, template : "settings-imap-prefs", change : false,
						postRenderCallback : function(el)
						{
							var model = itemView2.model;
							var id = model.id;
							itemView2.model.set("password", "");
							load_imap_properties(model, el);
						}, saveCallback : function()
						{
							App_Settings.navigate("email", { trigger : true });
							return;
						} });
					// Appends IMAP
					$('#prefs-tabs-content').html(itemView2.render().el);
					$('#PrefsTab .select').removeClass('select');
					$('.email-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");
			},

			/**
			 * Imap Add settings
			 */
			imapAdd : function()
			{
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	
					// Gets IMAP Prefs
					var itemView2 = new Settings_Modal_Events({ url : '/core/api/imap/', template : "settings-imap-prefs", change : false, isNew : true,
						postRenderCallback : function(el)
						{
						}, saveCallback : function()
						{
							var model = itemView2.model;
							var json = model.toJSON();
							if (typeof json.isUpdated !== 'undefined' && json.hasOwnProperty('isUpdated') && json.isUpdated)
								App_Settings.navigate("email", { trigger : true });
							else
							{
								itemView2.render(true);
								var el = itemView2.el;
								var model = itemView2.model;
								load_imap_folders(el, model);
							}
						} });
					// Appends IMAP
					$('#prefs-tabs-content').html(itemView2.render().el);
					$('#PrefsTab .select').removeClass('select');
					$('.email-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");
			},

			/**
			 * Office Add settings
			 */
			officeAdd : function()
			{
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	

					// Gets Office Prefs
					var itemView3 = new Settings_Modal_Events({ url : '/core/api/office', template : "settings-office-prefs", isNew : true, change : false,
						postRenderCallback : function(el)
						{
							itemView3.model.set("password", "");
						}, saveCallback : function()
						{
							// $("#office-prefs-form").find("#office-password").val("");
							App_Settings.navigate("email", { trigger : true });
							return;
						} });
					// Appends Office
					$('#prefs-tabs-content').html(itemView3.render().el);
					$('#PrefsTab .select').removeClass('select');
					$('.email-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");
			},

			/**
			 * Office Update settings
			 */
			officeEdit : function(id)
			{
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	

					if (App_Settings.officeListView === undefined)
					{
						App_Settings.navigate("email", { trigger : true });
						return;
					}

					var office_model = App_Settings.officeListView.collection.get(id);

					// Gets Office Prefs
					var itemView3 = new Settings_Modal_Events({ url : '/core/api/office/', model : office_model, template : "settings-office-prefs",
						postRenderCallback : function(el)
						{
							itemView3.model.set("password", "");
						}, saveCallback : function()
						{
							// $("#office-prefs-form").find("#office-password").val("");
							App_Settings.navigate("email", { trigger : true });
							return;
						} });

					// Appends Office
					$('#prefs-tabs-content').html(itemView3.render().el);
					$('#PrefsTab .active').removeClass('select');
					$('.email-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");
			},

			/**
			 * Gmail sharing settings
			 */
			gmailShare : function(id)
			{
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	

					if (App_Settings.gmailListView === undefined)
					{
						App_Settings.navigate("email", { trigger : true });
						return;
					}
					var gmail_model = App_Settings.gmailListView.collection.get(id);
					// Gets GMAIL Prefs
					var gmailShareView = new Settings_Modal_Events({ url : 'core/api/social-prefs/share/' + id, model : gmail_model,
						template : "settings-gmail-prefs-share", postRenderCallback : function(el)
						{
							
						}, saveCallback : function()
						{
							App_Settings.navigate("email", { trigger : true });
							return;
						} });

					// Appends Gmail
					$('#prefs-tabs-content').html(gmailShareView.render().el);
					$('#PrefsTab .select').removeClass('select');
					$('.email-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");
			},

			/**
			 * Shows list of email templates, with an option to add new template
			 */
			emailTemplates : function()
			{
				var that = this;
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	
					that.emailTemplatesListView = new Base_Collection_View({ url : '/core/api/email/templates', restKey : "emailTemplates",
					templateKey : "settings-email-templates", individual_tag_name : 'tr', postRenderCallback : function(el)
					{
						head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
						{
							console.log("In email tmplt postrender");
							$(".created_time", el).timeago();
						});
					} });

					that.emailTemplatesListView.collection.fetch();
					$('#prefs-tabs-content').html(that.emailTemplatesListView.el);
					$('#PrefsTab .select').removeClass('select');
					$('.email-templates-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");

			},

			/**
			 * Loads a form to add new email-template. Sets HTMLEditor for the
			 * form. Navigates to list of email templates on save success.
			 */
			emailTemplateAdd : function()
			{

				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));
					var view = new Email_Template_Events({ url : '/core/api/email/templates', isNew : true, template : "settings-email-template-add",
					window : 'email-templates', postRenderCallback : function()
					{
					} });

					$('#prefs-tabs-content').html(view.render().el);

					// set up TinyMCE Editor
					setupTinyMCEEditor('textarea#email-template-html', false, undefined, function()
					{

						// Reset tinymce
						set_tinymce_content('email-template-html', '');

						// Register focus
						register_focus_on_tinymce('email-template-html');
					});

					$('#PrefsTab .select').removeClass('select');
					$('.email-templates-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");
			},

			/**
			 * Updates existing email-template. On updation navigates the page
			 * to email-templates list
			 * 
			 * @param id
			 *            EmailTemplate Id
			 */
			emailTemplateEdit : function(id)
			{
				var that = this;
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	

					// Navigates to list of email templates, if it is not defined
					if (!that.emailTemplatesListView || that.emailTemplatesListView.collection.length == 0)
					{
						that.navigate("email-templates", { trigger : true });
						return;
					}

					// Gets the template form its collection
					var currentTemplate = that.emailTemplatesListView.collection.get(id);

					var view = new Email_Template_Events({ url : '/core/api/email/templates', model : currentTemplate, template : "settings-email-template-add",
						window : 'email-templates', postRenderCallback : function()
						{
						} });

					$('#prefs-tabs-content').html(view.render().el);

					/** TinyMCE * */

					// set up TinyMCE Editor
					setupTinyMCEEditor('textarea#email-template-html', false, undefined, function()
					{

						// Insert content into tinymce
						set_tinymce_content('email-template-html', currentTemplate.toJSON().text);

						// Register focus
						register_focus_on_tinymce('email-template-html');
					});

					/** End of TinyMCE* */

					$('#PrefsTab .select').removeClass('select');
					$('.email-templates-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");
				if ($('#attachment_id').val())
				{
					var el = $('#tpl-attachment-select').closest("div");
					$('#tpl-attachment-select').hide();
					el.find(".attachment-document-select").css("display", "inline");
					var optionsTemplate = "<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}' url='{{url}}'>{{name}}</option>";
        			fillSelect('attachment-select','core/api/documents', 'documents',  function fillNew()
					{
						el.find("#attachment-select option:first").after("<option value='new'>Upload new doc</option>");
						$('#attachment-select').find('option[value='+$('#attachment_id').val()+']').attr("selected","selected");
						$('.add-tpl-attachment-confirm').trigger("click");
						$('#tpl-attachment-select').hide();
						$('#tpl-attachment-name').show();
					}, optionsTemplate, false, el);
				}
			},

			/**
			 * Creates a Model to show and edit notification preferences.
			 * Reloads the page on save success.
			 */
			notificationPrefs : function()
			{

				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	

					var view = new Settings_Modal_Events({
					url : 'core/api/notifications',
					template : 'settings-notification-prefs',
					reload : true,
					postRenderCallback : function(el)
					{
						// Update Notification prefs
						notification_prefs = view.model.toJSON();

						console.log("updated notification prefs are...");
						console.log(notification_prefs);

						head.load(CSS_PATH + 'css/bootstrap_switch.css', LIB_PATH + 'lib/bootstrapSwitch.js', function()
								{
									showSwitchChanges(el);
									check_browser_notification_settings(el);
								});
						try
						{
							$('#notification-switch', el).bootstrapSwitch();
						}
						catch (err)
						{
							console.log(err);
						}

						// plays notification sounds
						notification_play_button()

						// to show notification-switch in safari properly
						if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1)
							$('#notification-switch').parent().css('margin-top', '-32px');
					} });

					$('#prefs-tabs-content').html(view.render().el);
					$('#PrefsTab .select').removeClass('select');
					$('.notification-prefs-tab').addClass('select');
					$(".active").removeClass("active");

				}, "#content");
			},

			/**
			 * Support page
			 */
			support : function()
			{
				load_clickdesk_code();

				getTemplate('support-form', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	
					$(".active").removeClass("active");
					$("#helpView").addClass("active");

					try
					{
						CLICKDESK_Live_Chat
								.onStatus(function(status)
								{

									if (status == "online")
										$("#clickdesk_status")
												.html(
														'Chat with our support representative.<br/> <a class="text-info c-p" onclick="CLICKDESK_LIVECHAT.show();">Start chat</a>.');
									else
										$("#clickdesk_status")
												.html(
														'No chat support representative is available at the moment. Please<br/> <a href="#contact-us" id="show_support">leave a message</a>.');
								});

					}
					catch (e)
					{

						setTimeout(
								function()
								{

									CLICKDESK_Live_Chat
											.onStatus(function(status)
											{

												if (status == "online")
													$("#clickdesk_status")
															.html(
																	'Chat with our support representative.<br/> <a class="text-info c-p" onclick="CLICKDESK_LIVECHAT.show();">Start chat</a>.');
												else
													$("#clickdesk_status")
															.html(
																	'No chat support representative is available at the moment. Please<br/> <a href="#contact-us" id="show_support">leave a message</a>.');
											});

								}, 5000);

					}

					hideTransitionBar();


				}, "#content");
			},

			scheduler : function()
			{
				$('#content').html("<div id='online-cal-listners'>&nbsp;</div>");
				getTemplate('settings', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#online-cal-listners').html($(template_ui));

					var view = new Base_Model_View({
					url : 'core/api/scheduleprefs',
					type : 'GET',
					template : 'settings-online-calendar-new',
					postRenderCallback : function(el)
					{
						$('#online-calendar a[href="#calendar-tab"]', el).tab('show');
						//online_calendar_tabs.loadScheduleUrlTab("#online-cal-listners");

						var onlineschedulingURL = "https://" + CURRENT_DOMAIN_USER.domain + ".agilecrm.com/calendar/" + view.model.get('schedule_id');

						$("#scheduleurl").attr("href", onlineschedulingURL);
						$("#scheduleurl").text(onlineschedulingURL);

						$("#scheduleurl").removeClass("nounderline");

						head.js(CSS_PATH + 'css/businesshours/businesshours.css', CSS_PATH + 'css/businesshours/jquerytimepicker.css',
								LIB_PATH + 'lib/businesshours/businesshours.js', LIB_PATH + 'lib/businesshours/jquerytimepicker.js',LIB_PATH+'lib/summer-note/summernote.js',CSS_PATH+'css/summernote/summernote.css', function()
								{
									var json = JSON.parse(view.model.get('business_hours'));
									console.log();
									businessHoursManager = $("#define-business-hours").businessHours({ operationTime : json,

									postInit : function()
									{
										$('.operationTimeFrom, .operationTimeTill').timepicker({ 'timeFormat' : 'H:i', 'step' : 30 });
									}, });

									$(".mini-time").keydown(false).addClass("form-control");
									
									
									$(".online_summer_note")
								     .summernote({
	
									      toolbar : [
									        [
									          'style',
									          [ 'bold', 'italic', 'underline',
									            'clear' ] ],
									        [ 'fontsize', [ 'fontsize' ] ],
									        [ 'insert', [ 'link' ] ] ],
									        height:'100'
									     });
										 
										 $(".online_summer_note").code(view.model.get('user_calendar_title'));

								});
						
						initializeOnlineCalendarListners(el);

					} });
				$('#prefs-tabs-content').html(view.render().el);
				$('#PrefsTab .select').removeClass('select');
				$('.scheduler-prefs-tab').addClass('select');
				$(".active").removeClass("active");

				}, "#online-cal-listners");
			},

			/**
			 * Contact us email
			 */
			contactUsEmail : function()
			{
				getTemplate('help-mail-form', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	
					$(".active").removeClass("active");
					$("#helpView").addClass("active");

				}, "#content");
			},

			/* theme and layout */

			themeandlayout : function()
			{
				// $("#content").html(getTemplate("theme-layout-form"), {});
				showTransitionBar();
				$
						.ajax({
							url : '/core/api/user-prefs',
							type : 'GET',
							dataType : "json",
							success : function(data)
							{
								getTemplate('theme-layout-form', {}, undefined, function(template_ui){
									if(!template_ui)
										  return;
									$('#content').html($(template_ui));	
									initializeThemeSettingsListeners();
									$("#menuPosition").val(CURRENT_USER_PREFS.menuPosition);
									$("#layout").val(CURRENT_USER_PREFS.layout);
									if (CURRENT_USER_PREFS.animations == true)
										$("#animations").attr('checked', true);
									$('.magicMenu  input:radio[name="theme"]').filter('[value=' + CURRENT_USER_PREFS.theme + ']').attr('checked', true);
									if (data.menuPosition != CURRENT_USER_PREFS.menuPosition || data.layout != CURRENT_USER_PREFS.layout || data.theme != CURRENT_USER_PREFS.theme || data.animations != CURRENT_USER_PREFS.animations)
										$(".theme-save-status").css("display", "inline");
									hideTransitionBar();

								}, "#content");

								
							}, error : function()
							{
								hideTransitionBar();
								showNotyPopUp("information", "error occured please try again", "top");
							} });

				/*
				 * var view = new Base_Model_View({ url :
				 * '/core/api/user-prefs', template : "theme-layout-form",
				 * postRenderCallback: function(el){} });
				 * $('#content').html(view.render().el); var data =
				 * view.model.toJSON();
				 * $("#menuPosition").val(CURRENT_USER_PREFS.menuPosition);
				 * $("#layout").val(CURRENT_USER_PREFS.layout); $('.magicMenu
				 * input:radio[name="theme"]').filter('[value='+CURRENT_USER_PREFS.theme+']').attr('checked',
				 * true); if(data.menuPosition !=
				 * CURRENT_USER_PREFS.menuPosition || data.layout !=
				 * CURRENT_USER_PREFS.layout || data.theme !=
				 * CURRENT_USER_PREFS.theme)
				 * $(".theme-save-status").css("display","inline");
				 */

				// $(".active").removeClass("active");
			},

			//preferences profile tab
			userPrefsProfile : function(data)
			{
				var prefs_profile_view = new Base_Model_View({ url : "core/api/user-prefs", model : data, template : "settings-user-prefs", change : false, reload : true,
					postRenderCallback : function(el)
					{	


						setupTinyMCEEditor('textarea#WYSItextarea', true, ["textcolor link image preview code"], function()
								{

									// Register focus
									register_focus_on_tinymce('WYSItextarea');
								});
						
					}});
					$("#settings-user-prefs-tab-content").html(prefs_profile_view.render(true).el);
				
			},

			//preferences reminders tab
			userPrefsReminders : function(data)
			{
				var prefs_reminders_view = new Base_Model_View({ url : 'core/api/user-prefs', model : data, template : 'settings-reminders', change : false, reload : true,
				postRenderCallback : function(el){
						
					}
				});
				$("#settings-user-prefs-tab-content").html(prefs_reminders_view.render(true).el);
			},

			//preferences advanced tab
			userPrefsAdvanced : function(data)
			{
				var prefs_advanced_view = new Base_Model_View({ url : 'core/api/user-prefs', model : data, template : 'settings-advanced', change : false, reload : true, 
					postRenderCallback : function(el){
						
					}
				});
				$("#settings-user-prefs-tab-content").html(prefs_advanced_view.render(true).el);
			}

		});
var ShopifyRouter = Backbone.Router.extend({
	routes: {
		"shopify/:shopurl" : "shopify","shopify":"shopify"
	},
	shopify: function(shopurl){
		var t_url = "core/shopifyapp?shop=" + shopurl;
		var response = {}; response["shopurl"] = shopurl;
		
		$.ajax({
			type : "GET",
			url : t_url,
			success: function(data){
				if(data){
					response["installed"] = true;

					getTemplate("shopifyboxes", response, undefined, function(template_ui){
						if(!template_ui)
							  return;
						$('#content').html($(template_ui));	
					}, "#content");

					return;
				}
				else{
					$.ajax({
						type : "POST",
						url : t_url,
						success: function(data){
							response["installed"] = false;
							getTemplate("shopifyboxes", response, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$('#content').html($(template_ui));	
							}, "#content");

							return;
						}
					});
				}
			}
		});
		
	}
});// Social suites stream and tweets.
var Streams_List_View;

// Scheduled updates.
var Scheduled_Updates_View;

// Stores tweets on scroll down in stream.
var Past_Tweets = [];

// Base-model to display data in Message modal and save in DB.
var Message_Model;

// Object of pubnub.
var Pubnub = null;

/**
 * Creates backbone router to create and access streams of the user.
 */
var SocialSuiteRouter = Backbone.Router.extend({

	routes : {
	
	// First function on click of tab
	"social" : "socialsuite",

	// Streams tab with collection
	"streams" : "streams",

	// Scheduled updates on new page
	"scheduledmessages" : "scheduledmessages" },

	before : 
	{	
		'*any': function(fragment, args, next) {
			// Gets template to display.
		getTemplate('socialsuite-show-streams', {}, undefined, function(template_ui){
			next();

		}, "#content");
			
		}
	},
	/**
	 * On click on social tab this function is called, to initialize social
	 * suite, it will include js files.
	 */
	socialsuite : function()
	{
		if(!tight_acl.checkPermission('SOCIAL'))
			return;
		
		initializeSocialSuite();

		// Makes tab active
		$(".active").removeClass("active");
		$("#socialsuitemenu").addClass("active");

		// Gets template to display.
		getTemplate('socialsuite-show-streams', {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			/* Creates pubnub object and channel dedicated for new user or relogin */
            initToPubNub(function() {
                if (!Pubnub.is_connected_call) {
                    return
                }
                Pubnub.is_connected_call = false;
                socialsuitecall.streams()
            });

			// Display added streams
			socialsuitecall.streams();

		}, "#content");
		
	}, // socialsuite end

	/**
	 * This will create collection and store social suite in that, all streams
	 * and tweets are displayed from this function and publish msg to register.
	 * 
	 * Format : Streams_List_View [streamView (tweetListView [tweet] ) ]
	 */
	streams : function(stream)
	{
		// If current location is social then only show streams
		var currentLocation = document.location.href;
		if(currentLocation.search("social") != -1)
		{
			var tab_content_elements = $('#content').find("#socialsuite-tabs-content");
			
			if(tab_content_elements && tab_content_elements.length > 0)
				console.log("do nothing");
			else{
				getTemplate('socialsuite-show-streams', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	
				}, "#content");

			}	
		}

		// Check scheduled updates.
		checkScheduledUpdates();

		if (!Streams_List_View) // Streams not collected from dB
		{
			console.log("Creating Collection First Time.");
			Streams_List_View = new Base_Collection_View({ url : "/core/social", restKey : "stream", templateKey : "socialsuite-streams",
				individual_tag_name : 'div', className : 'social-app-content  clearfix', id : 'stream_container',

				postRenderCallback : function(el)
				{
					// User have streams so register all of them on server
					registerAll(0);
				} });

			// Creates new default function of collection
			Streams_List_View.appendItem = this.socialSuiteAppendItem;

			Streams_List_View.collection.fetch();

			$('#socialsuite-tabs-content').append(Streams_List_View.render().el);			

			return;
		}// if end

		if (Streams_List_View) // Streams already collected in collection
		{
			console.log("Collection already defined.");

			// New stream to add in collection.
			if (stream)
				Streams_List_View.collection.add(stream);

			$('#socialsuite-tabs-content').append(Streams_List_View.render(true).el);

			// Creates normal time.
			displayTimeAgo($(".chirp-container"));

			// Check for new tweets and show notification.
			showNotification(null);
		}

		// Remove deleted tweet element from ui
		$('.deleted').remove();

		// Remove waiting icon.
		removeWaiting();
		
	}, // streams end

	/**
	 * Append Model and Collection with Models in Collection.
	 */
	socialSuiteAppendItem : function(base_model)
	{
		console.log("base_model in append.");

		// Stream model in main collection
		var streamView = new Base_List_View({ model : base_model, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'li',
			className : 'ui-state-default col-md-4 col-sm-6 col-xs-12 ' + base_model.get("id"), id : base_model.get("id"), name : base_model.get("column_index"), });

		// Tweet collection in stream model
		var tweetListView = new Base_Collection_View({ data : [], templateKey : 'Column', individual_tag_name : 'div', });

		// Comparator to sort tweets in tweet collection
		tweetListView.collection.comparator = function(model)
		{
			if (model.get('id'))
				return -model.get('id');
		};

		// If model has tweets, need to save them, when user change tab from
		// social
		if (base_model.has("tweetListView"))
		{
			tweetListView.collection.add(base_model.get("tweetListView").toJSON());
			tweetListView.collection.sort();
		}

		// Add new tweetList View as collection in stream model
		base_model.set('tweetListView', tweetListView.collection);

		var el = streamView.render().el;
		$('#stream', el).html(tweetListView.render(true).el);
		$('#socialsuite-streams-model-list', this.el).append(el);

		
	}, // socialSuiteAppendItem end

	/**
	 * On click on scheduled update time button in socialsuite will display
	 * scheduled updates if user have any.
	 */
	scheduledmessages : function()
	{		
		Scheduled_Updates_View = new Base_Collection_View({ url : "/core/scheduledupdate", restKey : "scheduledUpdate",
			templateKey : "socialsuite-scheduled-updates", individual_tag_name : 'tr', postRenderCallback : function(el)
			{
				// Creates normal time.
				displayTimeAgo($(".is-actionable"));
			}});

		Scheduled_Updates_View.collection.fetch();

		console.log(Scheduled_Updates_View.collection);
		
		$('#content').html(Scheduled_Updates_View.render(true).el);

		// Makes tab active
		$(".active").removeClass("active");
	} // scheduledmessages end
});

// Global variable to call function from Router.
var socialsuitecall = new SocialSuiteRouter();
/**
 * Creates Backbone Router for subscription operations, defines routes for
 * subscribe, updating creditcard/plan, invoice, invoice detailed view
 * 
 * @module Subscription
 * @author Yaswanth
 */
var _data = null;
_IS_EMAIL_PLAN_ACTIVE = false;
var SubscribeRouter = Backbone.Router
		.extend({

			routes : {

			/* Subscription page */

			"subscribe" : "subscribe",

			"subscribe/:id/:plan" : "subscribe",

			"subscribe-plan" : "subscribePlan",

			"subscribe-plan/:id" : "subscribePlan",

			/* billing settings */

			"billing-settings" : "billingSettings",

			"account-details" : "accountDetails",

			"invoice-details" : "invoiceDetailsList",

			/* Updating subscription details */

			"updateplan" : "updatePlan",

			"purchase-plan" : "purchasePlan",

			"purchase-email" : "purchaseEmail",

			"updateCreditCard" : "cardUpdation",

			/* Invoices */

			"invoice" : "invoice",

			"invoice/:id" : "invoiceDetails",

			"getInvoiceDetails/:id" : "getInvoiceDetails",

			},

			subscribePlan : function()
			{
				Backbone.history.navigate("subscribe", { trigger : true });
			},

			cardUpdation : function()
			{

				var card_details = new Base_Model_View({ url : "core/api/subscription", template : "creditcard-update", window : 'subscribe',
					saveCallback : function()
					{
						showNotyPopUp("information", "Card has been updated successfully.", "top");
					}, errorCallback : function(data)
					{
						showNotyPopUp("warning", data.responseText, "top");
					}, postRenderCallback : function(el)
					{

						// Load date and year for card expiry
						card_expiry(el);

						// To deserialize
						var card_detail_form = el.find('form.card_details'), card_data = card_details.model.toJSON().billingData;

						USER_CREDIRCARD_DETAILS = card_data;
						plan_json.customer = JSON.parse(USER_CREDIRCARD_DETAILS);

						var activeCard = getActiveCard(plan_json.customer);

						// Load countries and respective states
						// Deserialize card details
						if (!$.isEmptyObject(card_data))
						{
							// Deserialize method defined in
							// agile_billing.js
							deserialize_card_details(activeCard, $(card_detail_form));
						}

					} });
				$("#content").html(card_details.render().el);
			},

			billingSettings : function()
			{
				getTemplate('billing-settings', {}, undefined, function(template_ui)
				{
					if (!template_ui)
						return;
					$('#content').html($(template_ui));

					var view = new Base_Model_View({ url : '/core/api/subscription', template : "account-details", postRenderCallback : function()
					{
					} });
					$('#content').find('#billing-settings-tab-content').html(view.render().el);
					$('#content').find('#BillingSettingsTab .select').removeClass('select');
					$('#content').find('.account-details-tab').addClass('select');

				}, "#content");

				$(".active").removeClass("active");

			},

			accountDetails : function()
			{
				getTemplate('billing-settings', {}, undefined, function(template_ui)
				{
					if (!template_ui)
						return;
					$('#content').html($(template_ui));
					
					
				}, "#content");
				var view = new Base_Model_View({ url : '/core/api/subscription', template : "account-details", postRenderCallback : function()
				{
				} });
				$('#content').find('#billing-settings-tab-content').html(view.render().el);
				$('#content').find('#BillingSettingsTab .select').removeClass('select');
				$('#content').find('.account-details-tab').addClass('select');
				$(".active").removeClass("active");

			},

			invoiceDetailsList : function()
			{
				var that = this;
				getTemplate('billing-settings', {}, undefined, function(template_ui)
				{
					if (!template_ui)
						return;
					$('#content').html($(template_ui));
					
					getTemplate('invoice-details', {}, undefined, function(template_ui)
					{
						if (!template_ui)
							return;
						$('#billing-settings-tab-content').html($(template_ui));
						$("#invoice-details-holder").html(getRandomLoadingImg());
						
					}, "#billing-settings-tab-content");
					
					var subscribe_plan = new Base_Model_View({ url : "core/api/subscription?reload=true", template : "subscribe-new", window : 'subscribe',

					postRenderCallback : function(el)
					{

						var data = subscribe_plan.model.toJSON();
						var subscription_model = new BaseModel(data);
						that.recent_invoice(subscription_model);

					} });
					
				}, "#content");
				
				
				

			},

			purchaseEmail : function()
			{

				if (!email_json.quantity)
				{
					this.navigate("subscribe", { trigger : true });

					return;
				}
				var plan = email_json;
				var update_email = new Base_Model_View({ url : "core/api/subscription", data : email_json, template : "purchase-emails", window : 'subscribe',

				saveCallback : function()
				{
					showNotyPopUp("information", "Emails have been purchased successfully.", "top");
				}, postRenderCallback : function(el)
				{
					_IS_EMAIL_PLAN_ACTIVE = true;
					card_expiry(el);
					head.js(LIB_PATH + 'lib/countries.js', function()
					{
						print_country($("#country", el));
					});

				}, errorCallback : function(data)
				{
					showNotyPopUp("warning", data.responseText, "top");
				}
				/*
				 * prePersist : function(el) { console.log(el); }
				 */
				});

				$('#content').html(update_email.render().el);
				$(".active").removeClass("active");
				$("#planView").addClass("active");

			},
			/**
			 * Shows the subscription details(If subscribed ) of subscription
			 * form, this function also sets account statistics in the
			 * subscription page, using post render callback of the
			 * Base_Model_View
			 */
			subscribe : function(id, plan)
			{

				IS_HAVING_MANDRILL = false;
				$("#content").html("<div id='subscribe_plan_change'></div>");

				if (IS_NEW_USER && _plan_on_signup && _plan_on_signup.plan_type && _plan_on_signup.plan_type == "FREE")
				{
					 _plan_on_signup = null;
					Backbone.history.navigate("dashboard", { trigger : true });
					return;
				}
				
				if (!$.isEmptyObject(USER_CREDIRCARD_DETAILS))
				{

					plan_json.customer = JSON.parse(USER_CREDIRCARD_DETAILS);
				}
				var that = this;
				var counter = 0;
				showTransitionBar();
				var planDetails;

				this.subscribe_plan = new Base_Model_View({ url : "core/api/subscription?reload=true", template : "subscribe-new", window : 'subscribe',

				postRenderCallback : function(el)
				{
					var data = that.subscribe_plan.model.toJSON();
					_data = that.subscribe_plan.model.toJSON();

					initializeSubscriptionListeners()

					var _window = window;
					// Setup account statistics
					set_up_account_stats(el);

					USER_BILLING_PREFS = data;

					USER_CREDIRCARD_DETAILS = that.subscribe_plan.model.toJSON().billingData;

					if (data && data.billingData)
					{
						var billing_data = JSON.parse(data.billingData);
						var stripe_subscription = getSubscription(data.billingData, data.plan);
					}

					var planType = "";

					var quantity;
					if (stripe_subscription == null)
					{
						quantity = "2";
						planType = "FREE";
					}
					else
					{
						quantity = data.plan.quantity;
						planType = data.plan.plan_type.toUpperCase();
//						if("PRO_MONTHLY" == planType)
//							planType = "ENTERPRISE_MONTHLY";
//						else if("PRO_YEARLY" == planType)
//							planType = "ENTERPRISE_YEARLY";
					}
					planDetails = "<span class='text-head-black'>Current Plan</span></br><span class='text-head-black'>" + quantity + " Users</span>";
					if (planType.indexOf('STARTER') == 0)
					{
						id = $('#starter_plan');
					}
					else if (planType.indexOf('REGULAR') == 0)
					{
						id = $('#regular_plan');
					}
					else if (planType.indexOf('ENTERPRISE') == 0 || planType.indexOf('PRO') == 0)
					{
						id = $('#pro_plan');
					}

					if (id)
					{
						$("#plan_type").val(id.attr("id").split("_")[0]);
					}
					element = setPriceTemplete(data.plan.plan_type, el);
					addStyleForAPlan(id, planDetails);
					// Show Coupon code input field
					id = (id && id == "coupon") ? id : "";
					showCouponCodeContainer(id);
					price = update_price();
					$("#user_quantity").val(quantity);
					$("#users_quantity").text(quantity);
					(quantity && quantity > 1) ? $("#users_quantity_text").text("Users") : $("#users_quantity_text").text("User");
					$("#users_total_cost").text((quantity * price).toFixed(2));
					if ($.isEmptyObject(data))
						setPlan("free");
					else
						setPlan(data);

					data = _data;
					_billing_restriction = _data.cachedData;
					init_acl_restriction();

					var subscription_model = new BaseModel(data);

					that.setup_email_plan(subscription_model);

					that.show_card_details(subscription_model);

					that.invoice_latest(subscription_model);

					hideTransitionBar();
					document.getElementById('email-quantity').value = "";
					$('.selected-plan', el).trigger('click');
					if (_IS_EMAIL_PLAN_ACTIVE)
					{
						$(".nav-tabs li").removeClass("active");
						$("#users-content").removeClass("active");
						$("#emailtab").addClass("active");
						$("#email-content").addClass("active");
					}

				} });

				addStyleForAPlan(id, planDetails);
				$('#subscribe_plan_change').html(that.subscribe_plan.render().el);
				$(".active").removeClass("active");
				$("#planView").addClass("active");

			},

			getInvoiceDetails : function(invoice_id)
			{
				var invoicedata;
				var companydata;
				var obj;

				if (!invoice_id)
					return;

				accessUrlUsingAjax('core/api/subscription/getinvoice?d=' + invoice_id, function(data)
				{
					console.log("Invoice object");
					console.log(data);
					invoicedata = data;

					accessUrlUsingAjax('/core/api/account-prefs', function(data)
					{
						console.log("Account prefs");
						console.log(data);
						companydata = data;

						obj = { "invoice" : invoicedata, "company" : companydata }
						console.log("xxxxxxxxxxxxxxx");
						console.log(obj);
						head.js(LIB_PATH + 'jscore/handlebars/handlebars-helpers.js', function()
						{
							getTemplate('invoice-detail', obj, undefined, function(template_ui)
							{
								if (!template_ui)
									return;
								$('#content').html($(template_ui));
							}, "#content");
						});

					}, function(response)
					{
						showNotyPopUp("information", "error occured please try again", "top");
					});

				}, function(response)
				{
					showNotyPopUp("information", "error occured please try again", "top");
				});

			},

			/**
			 * Shows form the update plan, uses the same url used to create new
			 * subscription/update credit card of plan, deserializes the current
			 * plan
			 */
			updatePlan : function()
			{
				var update_plan = new Base_Model_View({
					url : "core/api/subscription-addon/subscribe",
					template : "purchase-email-plan",

					saveCallback : function()
					{
						window.navigate("subscribe", { trigger : true });
						showNotyPopUp("information", "Your plan has been updated successfully. Please logout and login again for the new changes to apply.",
								"top");
					}, postRenderCallback : function(el)
					{
						initializeSubscriptionListeners();
						card_expiry(el);
						head.js(LIB_PATH + 'lib/countries.js', function()
						{
							print_country($("#country", el));
						});
					}

				});

				$('#content').html(update_plan.render().el);
				$(".active").removeClass("active");
				$("#planView").addClass("active");
			},

			/**
			 * Fetches the invoices and displays as list.
			 */
			invoice : function()
			{
				Backbone.history.navigate("invoice-details", { trigger : true });
				this.invoice = new Base_Collection_View({ url : "core/api/subscription/invoices", templateKey : "invoice", window : 'subscribe',
					individual_tag_name : 'tr' })

				// Fetches the invoice payments
				this.invoice.collection.fetch();

				$('#content').html(this.invoice.el);
			},

			/**
			 * Displays detailed invoice, when selected from the invoice list
			 */
			invoiceDetails : function(id)
			{

				// Checks whether invoice list is defined, if list is not
				// defined get the list of invoices

				if (!this.invoice || !this.invoice.collection || this.invoice.collection == 0 || !this.invoice.collection.get(id))
				{
					this.navigate("invoice", { trigger : true });
					return;
				}
				if (id)
				{
					// Gets invoice item from the collection
					var model = this.invoice.collection.get(id);

					// Displays detailed invoice
					var invoice_detail_model = new Base_Model_View({ url : "core/api/subscription/getinvoice", model : model, template : "invoice-detail",
						postRenderCallback : function(el)
						{
						} });
					$("#billing-settings-tab-content").html("");
					$("#billing-settings-tab-content").html(invoice_detail_model.render().el);
				}
				else
					return;
			},

			/**
			 * After selecting plan, page is navigated to purchase plan where
			 * user enter his credit card details. It shows a form with
			 * countries and states and fields to enter credit card details
			 */
			purchasePlan : function()
			{

				// If plan is not defined i.e., reloaded, or plan not chosen
				// properly,
				// then page is navigated back to subscription/ choose plan page
				if (!plan_json.plan)
				{
					this.navigate("subscribe", { trigger : true });

					return;
				}

				_plan_on_signup = null;

				var window = this;
				// Plan json is posted along with credit card details
				var plan = plan_json
				var upgrade_plan = new Base_Model_View(
						{
							url : "core/api/subscription",
							template : "purchase-plan",
							isNew : true,
							data : plan,
							postRenderCallback : function(el)
							{
								initializeSubscriptionListeners();
								_IS_EMAIL_PLAN_ACTIVE = false;
								// Discount
								showCouponDiscountAmount(plan_json, el);
								card_expiry(el);
							},
							saveCallback : function(data)
							{
								window.navigate("subscribe", { trigger : true });
								showNotyPopUp("information", "Your plan has been updated successfully", "top");

								try
								{
									push_actual_plan(data.plan)
								}
								catch (err)
								{
									console.log(err);
								}

							},
							errorCallback : function(data)
							{
								if (data.responseText)
									showNotyPopUp("warning", data.responseText, "top");
							}

						});

				// Prepend Loading
				$('#content').html(upgrade_plan.render().el);
				$(".active").removeClass("active");
				$("#planView").addClass("active");
			},

			setup_email_plan : function(subscription)
			{
				var counter = 0;
				var that = this;
				IS_HAVING_MANDRILL = false;
				$.ajax({ url : "core/api/email-gateway", type : "GET", success : function(data)
				{
					if (data && data.email_api == "MANDRILL")
						IS_HAVING_MANDRILL = true;

				}

				});

				/*
				 * Creates new view with a render callback to setup expiry dates
				 * field(show dropdown of month and year), countries list and
				 * respective states list using countries.js plugin account
				 * stats in subscription page
				 */
				var subscribe_email_plan = new Base_Model_View({ url : "core/api/subscription", template : "email-update", model : subscription,
					window : 'subscribe',

					postRenderCallback : function(el)
					{

					} });

				$('#purchase-email').html(subscribe_email_plan.render(true).el);
			},

			show_card_details : function(subscription)
			{
				var that = this;
				var counter = 0;
				/*
				 * Creates new view with a render callback to setup expiry dates
				 * field(show dropdown of month and year), countries list and
				 * respective states list using countries.js plugin account
				 * stats in subscription page
				 */
				var stripe_customer_details = new Base_Model_View({ url : "core/api/subscription", model : subscription, template : "customer-details-block",

				postRenderCallback : function(el)
				{
				} });

				$('#customer-details-holder').html(stripe_customer_details.render(true).el);
			},

			invoice_latest : function(subscription)
			{
				$('#recent_invoice').html(getRandomLoadingImg());
				if (!subscription.get("billingData"))
				{
					$("#invoice-details-holder").html("");
					$('#invoice-details-holder').append("<div class='text-lg p-l-sm p-t-sm'>No invoices</div>");
					return;
				}

				// Send an ajax request

				$.get("core/api/subscription/invoices", {}, function(invoice)
				{

					if (!invoice || invoice.length <= 0)
						return;

					// Sort invoice
					invoice = new BaseCollection(invoice, { sortKey : "created", descending : true }).toJSON();
//					var object = JSON.parse(JSON.stringify(invoice[0]));
					// Send data to a template
					getTemplate('latest-invoice', invoice[0] , undefined, function(template_ui)
					{
						if (!template_ui)
							return;
						$('#recent_invoice').html(template_ui);
						
					}, "#recent_invoice");
					
				})
				.fail(function() {
					$('#recent_invoice').html("You do not have any invoices yet.");
				});

			},

			// gets collection of charges of aa paricular customer based on
			recent_invoice : function(subscription)
			{
				if (!subscription.get("billingData"))
				{
					$("#invoice-details-holder").html("");
					$('#invoice-details-holder')
							.append(
									"<div class='text-lg p-l-sm p-t-sm'>Invoices</div><hr><div class='text-center p-b-lg'><p class='m-b-none' style='font-size: 18px;'>You do not have any invoices yet</p><p>Generated invoices will be shown here.</p></div>");
					return;
				}

				this.invoice = new Base_Collection_View({ url : "core/api/subscription/invoices" + "?page_size=20", templateKey : "invoice",
					window : 'subscribe', individual_tag_name : 'tr', sortKey : 'created', descending : true });

				// Fetches the invoice payments
				this.invoice.collection.fetch();

				$("#invoice-details-holder").html(this.invoice.render().el);

			},

		});

function getPendingEmails()
{
	var count = _billing_restriction.one_time_emails_count;

	var max = getMaxEmailsLimit();

	// if max is greater than zero, we consider user is subscrbed to email plan
	if (max > 0)
	{
		// In case of count is less than zero we return 0;
		if (count < 0)
			return 0;

		return count;
	}

	// If max is zero then it is free plan
	if (max == 0)
	{
		// Count comes as a negavie value here
		var remaining = 5000 + count;
		if (remaining < 0)
			return 0;

		return remaining;
	}

	return count;
}

function getMaxEmailsLimit()
{
	var max = _billing_restriction.max_emails_count;

	if (max == undefined)
		max = 0;

	return max;
}
function canSendEmails(emails_to_send)
{
	var pending = getPendingEmails();
	if (pending >= emails_to_send)
		return true;

	return false;
}

function is_free_plan()
{
	return _IS_FREE_PLAN;
}

/**
 * This function is used to add the style for price panels.
 * 
 * @param id
 * @param description
 */
function addStyleForAPlan(id, planDetails)
{
	if (id)
	{

		if (($('selected-plan')) != ($('#email-div')))
		{
			$(".plan-collection-in").removeClass('selected-plan');
			id.find('.plan-collection-in').addClass('selected-plan');
		}
		else
		{
			$('#email-div').addClass('selected-plan');
		}

	}
}

function removeStyleForAPlan(id)
{
	var id = $('#plans-panel');

	id.find(".plan-collection-bot").css("opacity", "0.5");

	if (($('selected-plan')) != ($('#email-div')))
		$(".plan-collection-in").removeClass('selected-plan');

}/**
 * task timeline plugin
 * 
 * @auther jitendra
 */
// global task details model
var taskDetailView;
var task_tab_position_cookie_name = "task_tab_position";
var TaskDetailsRouter = Backbone.Router.extend({ routes : { 'task/:id' : 'taskDetailView' },

taskDetailView : function(id)
{

	if (id)
	{
		if (App_Calendar.allTasksListView)
		{
			var task = App_Calendar.allTasksListView.collection.get(id);
			taskDetailView = task;
			getTemplate("task-detail", task.toJSON(), undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('#content').html($(template_ui));	

				initializeTaskDetailListeners();
				task_details_tab.loadActivitiesView();

			}, "#content");
			

		}
		else if (App_Calendar.tasksListView)
		{
			var task = App_Calendar.tasksListView.collection.get(id);
			if (task)
			{
				taskDetailView = task;
				getTemplate("task-detail", task.toJSON(), undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	

					initializeTaskDetailListeners();
					task_details_tab.loadActivitiesView();
				}, "#content");
			}
			else
			{
				var taskModel = Backbone.Model.extend({});
				$.ajax({ url : "core/api/tasks/getTaskObject/" + id, success : function(response)
				{
					taskDetailView = new taskModel(response);
					getTemplate("task-detail", taskDetailView.toJSON(), undefined, function(template_ui){
						if(!template_ui)
							  return;
						$('#content').html($(template_ui));	

						initializeTaskDetailListeners();
						task_details_tab.loadActivitiesView();
					}, "#content");					
				} });
			}
		}
		else
		{
			var taskModel = Backbone.Model.extend({});
			$.ajax({ url : "core/api/tasks/getTaskObject/" + id, success : function(response)
			{
				taskDetailView = new taskModel(response);

				getTemplate("task-detail", taskDetailView.toJSON(), undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	

					initializeTaskDetailListeners();
					task_details_tab.loadActivitiesView();
				}, "#content");				
			} });

		}
	}

}

});

function initializeTaskDetailListeners(){

	var id;

	/**
	 * Activates the Timeline tab-content to show the time-line with all
	 * details, which are already added to time-line, when the task is getting
	 * to its detail view.
	 */
	$('#task-tab-container-header #taskDetailsTab a[href="#timeline"]').off();
	$('#task-tab-container-header').on('click', '#taskDetailsTab a[href="#timeline"]', function(e) 
	{
		e.preventDefault();

		save_task_tab_position_in_cookie("timeline");

		task_details_tab.load_timeline();
	});

	/**
	 * Fetches all the notes related to the task and shows the notes collection
	 * as a table in its tab-content, when "Notes" tab is clicked.
	 */
	$('#task-tab-container-header #taskDetailsTab a[href="#notes"]').off();
	$('#task-tab-container-header').on('click', '#taskDetailsTab a[href="#notes"]', function(e) 
	{
		e.preventDefault();
		save_task_tab_position_in_cookie("notes");
		task_details_tab.load_notes();
	});

	$('#task-tab-container-header #taskDetailsTab a[href="#contacts"]').off();
	$('#task-tab-container-header').on('click', '#taskDetailsTab a[href="#contacts"]', function(e)
	{
		e.preventDefault();
		save_task_tab_position_in_cookie("contacts");
		task_details_tab.loadTaskRelatedContactsView();
	});

	$('#task-tab-container-header #taskDetailsTab a[href="#activity"]').off();
    $('#task-tab-container-header').on('click', '#taskDetailsTab a[href="#activity"]', function(e) 
	{
		e.preventDefault();
		save_task_tab_position_in_cookie("activity");
		task_details_tab.loadActivitiesView();
	});

	$('#task-tab-container-header #taskDetailsTab a[href="#deals"]').off();
	$('#task-tab-container-header').on('click', '#taskDetailsTab a[href="#deals"]', function(e)
	{
		e.preventDefault();
		save_task_tab_position_in_cookie("deals");
		task_details_tab.loadTaskRelatedDealsView();
	});
	
	$('#change-owner-element .task-owner-list').off();
	$('#change-owner-element').on('click', '.task-owner-list', function(e) 
	{

		$('#change-task-owner-ul').css('display', 'none');

		// Reads the owner id from the selected option
		var new_owner_id = $(this).attr('data');
		var new_owner_name = $(this).text();
		var current_owner_id = $('#task-owner').attr('data');
		// Returns, if same owner is selected again
		if (new_owner_id == current_owner_id)
		{
			// Showing updated owner
			show_task_owner();
			return;
		}

		var taskModel = new BaseModel();
		taskModel.url = '/core/api/tasks/change-owner/' + new_owner_id + "/" + taskDetailView.get('id');
		taskModel.save(taskDetailView.toJSON(), { success : function(model)
		{

			$('#task-owner').text(new_owner_name);
			$('#task-owner').attr('data', new_owner_id);

			// Showing updated owner
			show_task_owner();
			taskDetailView = model;
			task_details_tab.loadActivitiesView();

		} });
	});

	$('#change-owner-element .task-owner-add').off();
	$('#change-owner-element').on('click', '.task-owner-add', function(e)
	{
		e.preventDefault();
		fill_task_owners(undefined, undefined, function()
		{

			$('.task-owner-add').css('display', 'none');

			$('#change-task-owner-ul').css('display', 'inline-block');
			$('#change-task-owner-ul').addClass("open");

			if ($('#change-owner-element > #change-task-owner-ul').css('display') == 'inline-block')
				$("#change-owner-element").find(".loading").remove();

		});

	});

	$('#change-owner-element #task-owner').off();
	$('#change-owner-element').on('click', '#task-owner', function(e)
	{
		e.preventDefault();
		fill_task_owners(undefined, undefined, function()
		{

			$('#task-owner').css('display', 'none');

			$('#change-task-owner-ul').css('display', 'inline-block');

			if ($('#change-task-owner-ul').css('display') == 'inline-block')
				$("#change-owner-element").find(".loading").remove();

		});

	});

	/**
	 * task note update
	 */
	$('#task_tab_detail .task-note-edit').off();
	$('#task_tab_detail').on('click', '.task-note-edit', function(e) 
	{

		e.preventDefault();
		var note = notesView.collection.get($(this).attr('data'));
		console.log(note);
		deserializeForm(note.toJSON(), $("#tasknoteUpdateForm", $('#tasknoteupdatemodal')));
		fill_relation_task($('#tasknoteUpdateForm'));
		$('#tasknoteupdatemodal').modal('show');

	})

	/**
	 * * update task related notes /
	 */

	$('#tasknoteupdatemodal #task_note_update').off();
	$('#tasknoteupdatemodal').on('click', '#task_note_update', function(e)
	{
		e.preventDefault();

		// Returns, if the save button has disabled attribute
		if ($(this).attr('disabled'))
			return;

		// Disables save button to prevent multiple click event issues
		disable_save_button($(this));// $(this).attr('disabled', 'disabled');

		if (!isValidForm('#tasknoteUpdateForm'))
		{

			// Removes disabled attribute of save button
			enable_save_button($(this));
			return;
		}

		// Shows loading symbol until model get saved
		// $('#noteUpdateModal').find('span.save-status').html(getRandomLoadingImg());

		var json = serializeForm("tasknoteUpdateForm");

		saveTaskNote($("#tasknoteUpdateForm"), $("#tasknoteupdatemodal"), this, json);
	})

	$('#task-detail-lhs .delete_task').off();
    $('#task-detail-lhs').on('click', '.delete_task', function(e)
	{
		var id = $('.delete_task').attr('data');
		e.preventDefault();
		if (!confirm("Are you sure you want to delete?"))
			return false;
		$.ajax({ url : 'core/api/tasks/' + id, type : 'DELETE', success : function(response)
		{
			document.location.href = document.location.origin + "#/tasks";
			getDueTasksCount(function(count){
				var due_task_count = count;
				if(due_task_count !=0)
					$('#due_tasks_count').html(due_task_count);
				else
					$('#due_tasks_count').html("");
			});
			
		} })
	});

	/**
 * task note validate
 */
/**
 * Saves note model using "Bcakbone.Model" object, and adds saved data to
 * time-line if necessary.
 */
$('#new-task-modal').on('click', '#tasknote_validate', function(e) 
{
	e.preventDefault();

	// Returns, if the save button has disabled attribute
	if ($(this).attr('disabled'))
		return;

	if (!isValidForm('#tasknoteForm'))
	{
		return;
	}

	disable_save_button($(this));
	var json = serializeForm("tasknoteForm");

	console.log(json);

	saveTaskNote($("#tasknoteForm"), $("#new-task-modal"), this, json);
});


}


$(function(){

	$('#content #task_edit').off('click');
    $('#content').on('click', '#task_edit', function(e) 
	{
		e.preventDefault();
		var id = $(this).attr('data');
		var task
		if (App_Calendar.allTasksListView)
		{
			task = App_Calendar.allTasksListView.collection.get(id);
		}
		else if (App_Calendar.tasksListView)
		{
			task = App_Calendar.tasksListView.collection.get(id);
			if (!task)
			{
				task = taskDetailView;
			}
		}
		else
		{
			task = taskDetailView;

		}
		if (task)
			update_task(task.toJSON());

	});

    $('#content .task-add-contact').off('click');
	$('#content').on('click', '.task-add-contact', function(e) 
	{
		e.preventDefault();
		update_task(taskDetailView.toJSON());
	});

	$('#content .task-add-deal').off('click');
	$('#content').on('click', '.task-add-deal', function(e) 
	{
		e.preventDefault();
		update_task(taskDetailView.toJSON());
		setTimeout(function(){
			$('#update_task_relates_to_deals').focus();
		},1000);
	});

});


/**
 * Activates "Timeline" tab and its tab-content in contact details and also
 * deactivates the other activated tabs.
 * 
 * @method activate_timeline_tab
 * 
 * Changed to activate first tab in the list ( on contact-details page , works
 * even on company-details page
 * @modified Chandan
 */
function activate_timeline_tab()
{
	$('#contactDetailsTab').find('li.active').removeClass('active');
	$('#contactDetailsTab li:first-child').addClass('active');

	$('div.tab-content').find('div.active').removeClass('active');
	$('div.tab-content > div:first-child').addClass('active');

	// $('#time-line').addClass('active'); //old original code for flicking
	// timeline

	if (App_Contacts.contactDetailView.model.get('type') == 'COMPANY')
	{
		fill_company_related_contacts(App_Contacts.contactDetailView.model.id, 'company-contacts');
	}
}

function save_task_tab_position_in_cookie(tab_href)
{

	var position = '';

	if (readCookie(task_tab_position_cookie_name))
		position = readCookie(task_tab_position_cookie_name);

	if (position == tab_href)
		return;

	createCookie(task_tab_position_cookie_name, tab_href);
}


// update task
function update_task(value)
{

	deserializeForm(value, $("#updateTaskForm"));
	$("#updateTaskModal").modal('show');
	categories.getCategoriesHtml(value,function(catsHtml){
		$('#type',$("#updateTaskForm")).html(catsHtml);
		// Fills owner select element
		populateUsers("owners-list", $("#updateTaskForm"), value, 'taskOwner', function(data)
		{
			$("#updateTaskForm").find("#owners-list").html(data);
			if (value.taskOwner)
			{
				$("#owners-list", $("#updateTaskForm")).find('option[value=' + value['taskOwner'].id + ']').attr("selected", "selected");
			}
			$("#owners-list", $("#updateTaskForm")).closest('div').find('.loading-img').hide();
		});
	});

    activateSliderAndTimerToTaskModal();

	// Add notes in task modal
	showNoteOnForm("updateTaskForm", value.notes);
}

/**
 * Shows all the domain users names as ul drop down list to change the owner of
 * a contact
 */
function fill_task_owners(el, data, callback)
{
	var optionsTemplate = "<li><a class='task-owner-list' data='{{id}}'>{{name}}</a></li>";
	fillSelect('task-detail-owner', '/core/api/users', 'domainUsers', callback, optionsTemplate, true);
}

/**
 * To show owner on change
 */
function show_task_owner()
{
	$('#task-owner').css('display', 'inline-block');
}

/**
 * Displays note modal, to add a note related to the task in task detail view.
 * Also prepends the task name to related to field of activity modal.
 */

function fill_relation_task(el)
{

	var json = taskDetailView.toJSON();
	var task_name = json.name;
	$('.tags', el).html('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="' + json.id + '">' + task_name + '</li>');

}


function saveTaskNote(form, noteModal, element, note)
{

	var noteModel = new Backbone.Model();
	noteModel.url = 'core/api/notes';
	noteModel.save(note, { success : function(data)
	{

		// Removes disabled attribute of save button
		enable_save_button($(element));// $(element).removeAttr('disabled');

		form.each(function()
		{
			this.reset();
		});

		// Removes loading symbol and hides the modal
		// modal.find('span.save-status img').remove();
		noteModal.modal('hide');

		var note = data.toJSON();

		console.log(note);
		// Add model to collection. Disabled sort while adding and called
		// sort explicitly, as sort is not working when it is called by add
		// function
		if (!notesView)
		{
			notesView = new Base_Collection_View(data);
		}
		if (notesView && notesView.collection)
		{
			if (notesView.collection.get(note.id))
			{
				notesView.collection.get(note.id).set(new BaseModel(note));
			}
			else
			{

				// Replace contacts object with contact ids
				var taskJSON = taskDetailView.toJSON();
				var contacts = [];
				$.each(taskJSON.contacts, function(index, contact)
				{
					contacts.push(contact.id);
				});

				// Replace notes object with note ids
				var notes = [];
				$.each(taskJSON.notes, function(index, n)
				{
					notes.push(n.id);
				});

				notes.push(note.id);

				taskJSON.contacts = contacts;
				taskJSON.notes = notes;

				if (taskJSON.taskOwner)
					taskJSON.owner_id = taskJSON.taskOwner.id;
				var newTaskModel = new Backbone.Model();

				newTaskModel.url = 'core/api/tasks';
				newTaskModel.save(taskJSON, { success : function(data)
				{

					notesView.collection.add(new BaseModel(note), { sort : false });
					notesView.collection.sort();
					taskDetailView = data;
					

				} });

			}
		}

	} });
}
var VisitorsRouter = Backbone.Router.extend({

routes : { "visitors" : "loadGmap" },

initialize : function()
{

},

loadGmap : function()
{
	head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION,LIB_PATH + 'lib/markerclusterer.js', function()
	{

		var view = new Base_Model_View({ model : new BaseModel(), template : "gmap-html-page",
		// gmap main template id path
		isNew : true, postRenderCallback : function(el)
		{

			try
			{
				if (google.maps)
				{
					gmap_initialize(el);
				}
			}
			catch (err)
			{

				gmap_load_script(el);
			}
		} });

		$('#content').html(view.render().el);
	});

}

});
var VoiceMailRouter = Backbone.Router.extend({

	routes : {
	"voicemail" : "voicemail"
	},

	voicemail : function(){
		var that = this;
		getTemplate('settings', {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#content').html($(template_ui));	

			$('#PrefsTab .select').removeClass('select');
			$('.add-widget-prefs-tab').addClass('select');
			
			that.VoiceMailCollectionView = new Base_Collection_View({ url : 'core/api/voicemails', templateKey : "voice-mail", cursor : true, page_size : 20,
				individual_tag_name : 'tr', postRenderCallback : function(el)
				{
					includeTimeAgo(el);
				},
				appendItemCallback : function(el)
				{ 
					// To show time ago for models appended by infinite scroll
					includeTimeAgo(el);
				} });
			
			that.VoiceMailCollectionView.collection.fetch();
			console.log(that.VoiceMailCollectionView);
			$('#prefs-tabs-content').html(that.VoiceMailCollectionView.render().el);

		}, "#content");
	}
});
/**
 * workflows.js is a script file having routes for CRU operations of workflows
 * and triggers.
 * 
 * @module Webpages
 * 
 */
var WebpagesRouter = Backbone.Router
		.extend({
			routes : {

				/* webpages */
				"webpages" : "webpages",
				"webpage-add" : "webpageAdd",
				"webpage/:id" : "webpageEdit",

			},

			/**
			 * 
			 * Gets workflows list.Sets page-size to 10, so that initially
			 * workflows are 10. Cursor is true, when scrolls down , the
			 * workflows list increases.
			 */
			webpages : function() {

				this.webpages_list_view = new Base_Collection_View({
					url : '/core/api/webpages',
					restKey : "webpage",
					sort_collection : false,
					templateKey : "webpages",
					individual_tag_name : 'tr',
					cursor : true,
					page_size : 20,
					postRenderCallback : function(el) {
						head.js(LIB_PATH + 'lib/jquery.timeago.js', function() {
							$("time.webpage-created-time", el).timeago();

						});

						start_tour(undefined, el);

					},
					appendItemCallback : function(el) {
						$("time.webpage-created-time", el).timeago();

					}
				});

				this.webpages_list_view.collection.fetch();

				$('#content').html(this.webpages_list_view.el);

				$(".active").removeClass("active");
				$("#webpagesmenu").addClass("active");
			},

			/**
			 * Saves new workflow.After workflow saved,the page should navigate
			 * to workflows list.
			 */
			webpageAdd : function() {
				if (!this.webpages_list_view
						|| !this.webpages_list_view.collection) {
					this.navigate("webpages", {
						trigger : true
					});
					return;
				}

				/* Reset the designer JSON */
				this.webpage_json = undefined;
				this.webpage_model = undefined;

				getTemplate('webpage-add', {"is_new" : true}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	
					initiate_tour("webpages-add", $('#content'));
				}, "#content");
			},

			/**
			 * Updates existing workflow. After workflow updated, the page
			 * navigates to workflows list
			 * 
			 * @param id
			 *            Workflow Id
			 */
			webpageEdit : function(id, webpage) {

				if (!this.webpages_list_view
						|| this.webpages_list_view.collection.length == 0) {
					this.navigate("webpages", {
						trigger : true
					});
					return;
				}

				/* Set the designer JSON. This will be deserialized */
				if (webpage)
					this.webpage_model = webpage;
				else
					this.webpage_model = this.webpages_list_view.collection
							.get(id);

				// Download new one if undefined
				if (this.webpage_model === undefined) {
					console.log("Downloading webpage.");

					// get count value from first attribute count
					var total_count = this.webpages_list_view.collection.at(0).attributes.count;

					if (this.webpages_list_view.collection.length !== total_count) {
						// if not in the collection, download new one.
						var new_webpage_model = Backbone.Model.extend({
							url : '/core/api/webpages/' + id
						});

						var model = new new_webpage_model();
						model.id = id;

						model.fetch({
							success : function(data) {
								// Call workflowEdit again if not Empty
								if (!$.isEmptyObject(data.toJSON())) {
									App_Webpages.webpageEdit(id, model);
									return;
								}
							}
						});
					}
				}

				if (this.webpage_model === undefined)
					return;

				this.webpage_json = this.webpage_model.get("rules");
				var that = this;
				getTemplate('webpage-add', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					var el = $('#content').html($(template_ui));	
					// Set the name
					$('#name').val(that.webpage_model.get("name"));
				}, "#content");
			},

		});
/**
 * Creates backbone router to access preferences of the user (email templates,
 * email (gmail/IMAP), notifications and etc..).
 */
var WebreportsRouter = Backbone.Router.extend({

	routes : {
	/* Settings */
	"web-rules" : "webrules", "webrules-add" : "web_reports_add", "webrule-edit/:id" : "web_reports_edit" },
	webrules : function()
	{
		var that = this;
		this.webrules = new Base_Collection_View({ url : '/core/api/webrule', restKey : "webrule", templateKey : "webrule", individual_tag_name : 'tr',
			sortKey : 'position', postRenderCallback : function(el)
			{
				if (that.webrules.collection && that.webrules.collection.length == 0)
				{
					head.js(LIB_PATH + 'lib/prettify-min.js', function()
					{
						$.ajax({ url : 'core/api/api-key', type : 'GET', dataType : 'json', success : function(data)
						{
							getTemplate("webrule-collection", data, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$('#content').html($(template_ui));	
								if(ACCOUNT_PREFS.plan.plan_type.split("_")[0] == "PRO")
								{
									$("#whitelist-disabled").addClass("hide");
									$("#whitelist-enabled").removeClass("hide");
								}
								prettyPrint();

							}, "#content");

							
						} });

					});
				}
				else
				{
					enableWebrulesSorting(el);
				}
			} });

		this.webrules.collection.fetch();
		$("#content").html(this.webrules.render().el);
		$(".active").removeClass("active");
		$("#web-rules-menu").addClass("active");

	},
	web_reports_add : function()
	{
		if(!tight_acl.checkPermission('WEBRULE'))
			return;
		var web_reports_add = new Web_Rules_Event_View({ url : 'core/api/webrule', template : "webrules-add", window : "web-rules", isNew : true,
			postRenderCallback : function(el)
			{
				head.js('lib/agile.jquery.chained.min.js', function()
				{

					chainFilters(el, undefined, function()
					{
						chainWebRules(el, undefined, true);
						$("#content").html(el);
					}, true);

				})
			} });

		$("#content").html(getRandomLoadingImg());
		web_reports_add.render();
	},

	web_reports_edit : function(id)
	{
		if(!tight_acl.checkPermission('WEBRULE'))
			return;

		// If reports view is not defined, navigates to reports
		if (!this.webrules || !this.webrules.collection || this.webrules.collection.length == 0 || this.webrules.collection.get(id) == null)
		{
			this.navigate("web-rules", { trigger : true });
			return;
		}

		var count = 0;

		// Gets a report to edit, from reports collection, based on id
		var webrule = this.webrules.collection.get(id);

		// Default template is webrule-add. If rule is of type shopify template is changed accordingly
		var template = "webrules-add";
		var web_reports_add = new Web_Rules_Event_View({ url : 'core/api/webrule', model : webrule, template : template, window : "web-rules",
			postRenderCallback : function(el)
			{
				if (count > 0)
					return;
				head.js('lib/agile.jquery.chained.min.js', function()
				{
					chainFilters(el, webrule.toJSON(), function()
					{
						chainWebRules(el, webrule.toJSON(), false, webrule.toJSON()["actions"]);
						$("#content").html(el);
					}, true);

				})
				count++;
			} });

		$("#content").html(getRandomLoadingImg());
		web_reports_add.render();
	} });
/**
 * Creates backbone router to access preferences of the user widgets
 */
var WidgetsRouter = Backbone.Router
        .extend({
            routes : {
                // Add widgets main route
                "add-widget" : "addWidget",
                // Social widgets
                "Twitter" : "Twitter",
                "Twitter/:id" : "Twitter",
                "GooglePlus" : "GooglePlus",
                "GooglePlus/:id" : "GooglePlus",
                "Rapleaf" : "Rapleaf",
                "Rapleaf/:id" : "Rapleaf",
                "Facebook" : "Facebook",
                "Facebook/:id" : "Facebook",
                // Support widgets
                "ClickDesk" : "ClickDesk",
                "ClickDesk/:id" : "ClickDesk",
                "HelpScout" : "HelpScout",
                "HelpScout/:id" : "HelpScout",
                "Zendesk" : "Zendesk",
                "Zendesk/:id" : "Zendesk",
                // Calling widgets
                "Sip" : "Sip",
                "Sip/:id" : "Sip",
                "Twilio" : "Twilio",
                "Twilio/:id" : "Twilio",
                "TwilioIO" : "TwilioIO",
                "TwilioIO/:id" : "TwilioIO",
                "callscript/rules" : "CallScriptShow",
                "callscript/add-rules" : "CallScriptAdd",
                "callscript/editrules/:id" : "CallScriptEdit",
                "callscript" : "CallScript",
                "callscript/:id" : "CallScript",
                // Billing widgets
                "FreshBooks" : "FreshBooks",
                "FreshBooks/:id" : "FreshBooks",
                "Stripe" : "Stripe",
                "Stripe/:id" : "Stripe",
                "Xero" : "Xero",
                "Xero/:id" : "Xero",
                "QuickBooks" : "QuickBooks",
                "QuickBooks/:id" : "QuickBooks",
                // Ecommerce widgets
                "Shopify" : "Shopify",
                "Shopify/:id" : "Shopify",
                // Custom widget
                "Custom-widget" : "Custom",
                "Custom-widget/:id" : "Custom",
                "Bria" : "Bria", "Bria/:id" : "Bria"
                	
            },

            /**
             * Adds the configured and configurable widgets on widgets add
             * route.
             */
            addWidget : function() {

                var that = this;
                loadSettingsUI(function() {

                    that.Catalog_Widgets_View = new Base_Collection_View({
                        url : '/core/api/widgets/default',
                        restKey : "widget",
                        templateKey : "widgets-add",
                        sort_collection : false,
                        individual_tag_name : 'div',
                        postRenderCallback : function(el) {
                            initializeWidgetSettingsListeners();

                            build_custom_widget_form(el);
                            setTimeout(function() {
                                var socialHeight = 0;
                                $('#social > div', el).each(function() {
                                    if ($(that).height() > socialHeight)
                                        socialHeight = $(that).height();
                                });
                                $('#social > div', el).each(function() {
                                    $(that).height(socialHeight);
                                });
                            }, 1000);
                            $('[data-toggle="tooltip"]').tooltip();
                        }
                    });

                    // Append widgets into view by organizing them
                    that.Catalog_Widgets_View.appendItem = organize_widgets;
                    
                    // Fetch the list of widgets
                    that.Catalog_Widgets_View.collection.fetch({
                        success : function(data) {
                            console.log(data.where({
                                "is_added" : true
                            }));
                            _plan_restrictions.process_widgets(data);
                            console.log(data);
                            console.log("****");
                        }
                    });

                    // Shows available widgets in the content
                    $('#prefs-tabs-content').html(that.Catalog_Widgets_View.el);

                });

            },

            /**
             * Manages FreshBooks widget
             */
            FreshBooks : function(id) {
                addConfigurableWidget(id, "FreshBooks", 'freshbooks-login');
            },

            /**
             * Manages TwilioIo widget
             */
            TwilioIO : function(id) {
                addConfigurableWidget(id, "TwilioIO", 'twilioio-login');
            },
            
			/**
			 * Manages Bria widget
			 */
			// Bria : function(id) {
			// 	addConfigurableWidget(id, "Bria", 'bria-login');
			// },

            /**
             * Manages Rapleaf widget
             */
            Rapleaf : function(id) {
                addConfigurableWidget(id, "Rapleaf", "rapleaf-login");
            },

            /**
             * Manages ClickDesk widget
             */
            ClickDesk : function(id) {
                addConfigurableWidget(id, "ClickDesk", "clickdesk-login");
            },

            /**
             * Manages Zendesk widget
             */
            Zendesk : function(id) {
                addConfigurableWidget(id, "Zendesk", "zendesk-login");
            },

            /**
             * Manages HelpScout widget
             */
            HelpScout : function(id) {
                addConfigurableWidget(id, "HelpScout", "helpscout-login");
            },

            /**
             * Manages Sip widget
             */
            Sip : function(id) {
                addConfigurableWidget(id, "Sip", "sip-login");
            },

            /**
             * Manages Twitter widget
             */
            Twitter : function(id) {
                if (!id) {
                    addOAuthWidget(
                            "Twitter",
                            "twitter-login",
                            ('/scribe?service=twitter&linkType=widget&isForAll=' + isForAll
                                    + '&return_url='
                                    + encodeURIComponent(window.location.href)));
                } else {
                    addWidgetProfile(id, "Twitter", "twitter-revoke-access",
                            "core/api/widgets/social/profile/"+id);
                }

            },

            /**
             * Manages Facebook widget
             */
            Facebook : function(id) {
                if (!id) {
                    addOAuthWidget(
                            "Facebook",
                            "facebook-login",
                            ('/scribe?service=facebook&linkType=widget&isForAll=' + isForAll
                                    + '&return_url='
                                    + encodeURIComponent(window.location.href)));
                } else {
                    addWidgetProfile(id, "Facebook", "facebook-revoke-access",
                            "/core/api/widgets/facebook/currentUserProfile/"+id);
                }

            },

            /**
             * Manages Facebook widget
             */
            Xero : function(id) {
                if (!id) {
                    addOAuthWidget(
                            "Xero",
                            "xero-login",
                            ("http://integrations.clickdesk.com:8080/ClickdeskPlugins/agile-xero-oauth?callbackUrl=" + encodeURIComponent(window.location.protocol
                                    + "//"
                                    + window.location.host
                                    + "/XeroServlet?isForAll="
                                    + isForAll
                                    + "&linkType=widget&data=")));
                } else {
                    addWidgetProfile(id, "Xero", "xero-revoke-access",
                            "core/api/widgets/Xero");
                }

            },

            /**
             * Manages Quickbooks widget
             */
            QuickBooks : function(id) {
                if (!id) {
                    addOAuthWidget(
                            "QuickBooks",
                            "quickbooks-login",
                            ('/OAuthServlet?service=quickbooks&linkType=widget&isForAll='
                                    + isForAll + '&return_url='
                                    + encodeURIComponent(window.location.href)));
                } else {
                    addWidgetProfile(id, "QuickBooks",
                            "quickbooks-revoke-access",
                            "core/api/widgets/QuickBooks");
                }

            },

            /**
             * Manages Shopify widget
             */
            Shopify : function(id) {
                if (!id) {
                    addOAuthWidget("Shopify", "shopify-login", "");
                } else {
                    addWidgetProfile(id, "Shopify", "shopify-revoke-access",
                            "/core/api/widgets/default");
                }
                // addConfigurableWidget(id, "Shopify", "shopify-login");
            },

            /**
             * Manages GooglePlus widget
             */
            GooglePlus : function(id) {
                if (!id) {
                    addOAuthWidget(
                            "GooglePlus",
                            "googleplus-login",
                            ('/scribe?service=googleplus&linkType=widget&isForAll=' + isForAll
                                    + '&return_url='
                                    + encodeURIComponent(window.location.href)));
                } else {
                    addWidgetProfile(id, "GooglePlus",
                            "googleplus-revoke-access",
                            "core/api/widgets/GooglePlus");
                }

            },

            /**
             * Manages Stripe widget
             */
            Stripe : function(id) {
                if (!id) {
                    addOAuthWidget(
                            "Stripe",
                            "stripe-login",
                            ('/scribe?service=stripe&linkType=widget&isForAll=' + isForAll
                                    + '&return_url='
                                    + encodeURIComponent(window.location.href)));
                } else {
                    addWidgetProfile(id, "Stripe", "stripe-revoke-access",
                            "core/api/widgets/Stripe");
                }

            },

            /**
             * Manages CallScript widget
             */
            CallScript : function(id)
            {
                addConfigurableWidget(id, "CallScript", "callscript-login");
                if(id){
                    adjust_form();
                }
            },
            
            /**
             * Show CallScript rules
             */
            CallScriptShow : function()
            {   
                showCallScriptRule();
            },
            
            /**
             * Add CallScript rules
             */
            CallScriptAdd : function()
            {
                addCallScriptRule();
            },
            
            /**
             * Edit CallScript rules
             */
            CallScriptEdit : function(id)
            {
                editCallScriptRule(id);
            }
});

function getAgileConfiguredWidgetCollection(callback) {

    if (App_Widgets.Catalog_Widgets_View
            && App_Widgets.Catalog_Widgets_View.collection) {

        callback(App_Widgets.Catalog_Widgets_View.collection);
        return;
    }

    App_Widgets.Catalog_Widgets_View = new Base_Collection_View({
        url : '/core/api/widgets/default'
    });

    // Fetch the list of widgets
    App_Widgets.Catalog_Widgets_View.collection.fetch({
        success : function() {

            getAgileConfiguredWidgetCollection(callback);

        }
    });
}

function renderWidgetView(templateName, url, model, renderEle){

    var widgetModel = new Widget_Model_Events({
        template : templateName,
        url : url,
        isNew : true,
        data : model,
        postRenderCallback : function(el) {
            deserializeWidget(model, el);
        }
    });

    $(renderEle).html(widgetModel.render().el);
}/**
 * workflows.js is a script file having routes for CRU operations of workflows
 * and triggers.
 * 
 * @module Campaigns
 * 
 */
var WorkflowsRouter = Backbone.Router
		.extend({
			routes : {

			/* workflows */
			"workflows" : "workflows", "workflow-add" : "workflowAdd", "workflow/:id" : "workflowEdit",

			/* workflow templates */
			"workflow-templates" : "workflowTemplates", "workflow-add/:c/:t" : "workflowAddTemplate",

			/* Logs */
			"workflows/logs/:id" : "logsToCampaign",

			/* Campaign Stats */
			"campaign-stats" : "campaignStats", "email-reports/:id" : "emailReports",

			/* Triggers */
			"triggers" : "triggers",

			// Appends campaign-id to show selected campaign-name in add trigger
			// form.
			"trigger-add/:id" : "triggerAdd",

			"trigger-add" : "triggerAdd", "trigger/:id" : "triggerEdit",

			/* Subscribers */
			"workflow/all-subscribers/:id" : "allSubscribers", "workflow/active-subscribers/:id" : "activeSubscribers",
			"workflow/completed-subscribers/:id" : "completedSubscribers", "workflow/removed-subscribers/:id" : "removedSubscribers",

			"workflow/unsubscribed-subscribers/:id" : "unsubscribedSubscribers", "workflow/hardbounced-subscribers/:id" : "hardBouncedSubscribers",
			"workflow/softbounced-subscribers/:id" : "softBouncedSubscribers", "workflow/spam-reported-subscribers/:id" : "spamReportedSubscribers"

			},

			/**
			 * Gets workflows list.Sets page-size to 10, so that initially
			 * workflows are 10. Cursor is true, when scrolls down , the
			 * workflows list increases.
			 */
			workflows : function()
			{

				this.workflow_list_view = new Base_Collection_View({ url : '/core/api/workflows', restKey : "workflow", sort_collection : false,
					templateKey : "workflows", individual_tag_name : 'tr', cursor : true, page_size : 20, postRenderCallback : function(el)
					{
						head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
						{
							$("time.campaign-created-time", el).timeago();

						});

						start_tour(undefined, el);

						// If workflows not empty, show triggers
						if (App_Workflows.workflow_list_view && !(App_Workflows.workflow_list_view.collection.length === 0))
							show_triggers_of_each_workflow(el);

					}, appendItemCallback : function(el)
					{
						$("time.campaign-created-time", el).timeago();

						// Shows triggers to workflows appended on scroll
						show_triggers_of_each_workflow(el);

					} });

				this.workflow_list_view.collection.fetch();

				$("#content").html(this.workflow_list_view.el);
				$(".active").removeClass("active");
				$("#workflowsmenu").addClass("active");
			},

			/**
			 * Saves new workflow.After workflow saved,the page should navigate
			 * to workflows list.
			 */
			workflowAdd : function()
			{
				if (!this.workflow_list_view || !this.workflow_list_view.collection)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				/* Reset the designer JSON */
				this.workflow_json = undefined;
				this.workflow_model = undefined;

				var workflowModal = new Workflow_Model_Events({
					url : 'core/api/workflow', 
					template : 'workflow-add',
					isNew : 'true',
					data : {  "is_new" : true, "is_disabled" : "false", "was_disabled" : "false" },
					postRenderCallback : function(el){
						initiate_tour("workflows-add", $('#content'));						
						// Init SendVerify Email
						send_verify_email(el);
					}

				});

				$("#content").html(workflowModal.render().el);
			},

			/**
			 * Updates existing workflow. After workflow updated, the page
			 * navigates to workflows list
			 * 
			 * @param id
			 *            Workflow Id
			 */
			workflowEdit : function(id, workflow)
			{

				if (!this.workflow_list_view || this.workflow_list_view.collection.length == 0)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				/* Set the designer JSON. This will be deserialized */
				if (workflow)
					this.workflow_model = workflow;
				else
					this.workflow_model = this.workflow_list_view.collection.get(id);

				// Download new one if undefined
				if (this.workflow_model === undefined)
				{
					console.log("Downloading workflow.");

					// get count value from first attribute count
					var total_count = this.workflow_list_view.collection.at(0).attributes.count;

					if (this.workflow_list_view.collection.length !== total_count)
					{
						// if not in the collection, download new one.
						var new_workflow_model = Backbone.Model.extend({ url : '/core/api/workflows/' + id });

						var model = new new_workflow_model();
						model.id = id;

						model.fetch({ success : function(data)
						{
							// Call workflowEdit again if not Empty
							if (!$.isEmptyObject(data.toJSON()))
							{
								App_Workflows.workflowEdit(id, model);
								return;
							}
						} });
					}
				}

				if (this.workflow_model === undefined)
					return;

				this.workflow_json = this.workflow_model.get("rules");
				this.is_disabled = this.workflow_model.get("is_disabled");
				var that = this;

				var workflowModal = new Workflow_Model_Events({
					url : 'core/api/workflow', 
					template : 'workflow-add',
					isNew : 'true',
					data :  {"is_disabled" : ""+that.is_disabled},
					postRenderCallback : function(el){
						// Set the name
						$('#workflow-name', el).val(that.workflow_model.get("name"));

						var unsubscribe = that.workflow_model.get("unsubscribe");

						$('#unsubscribe-email', el).val(unsubscribe.unsubscribe_email);
						$('#unsubscribe-tag', el).val(unsubscribe.tag);
						$('#unsubscribe-action', el).val(unsubscribe.action);
						$('#unsubscribe-action', el).trigger('change');

						if(that.is_disabled)
								$('#designer-tour').addClass("blur").removeClass("anti-blur");

						// Init SendVerify Email
						send_verify_email(el);
					}

				});

				$("#content").html(workflowModal.render().el);

			},

			/**
			 * Fetches various default workflow template jsons such as
			 * newsletter etc and build UI to show various templates to select
			 * workflow template.
			 * 
			 */
			workflowTemplates : function()
			{
				if (!this.workflow_list_view || !this.workflow_list_view.collection)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				getTemplate('workflow-categories', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$("#content").html($(template_ui));
				}, "#content");
			},

			/**
			 * Shows constructed workflow that matches with the template_name.
			 * 
			 * @param template_name -
			 *            template name.
			 */
			workflowAddTemplate : function(category, template_name)
			{
				if (!this.workflow_list_view || !this.workflow_list_view.collection)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				/* Reset the designer JSON */
				this.workflow_json = undefined;
				this.workflow_model = undefined;

				// Get workflow template based on category and template name
				var workflow_template_model = Backbone.Model.extend({

				url : 'misc/campaign-templates/' + category + '/' + template_name+'_template.jsp' });

				var model = new workflow_template_model();

				var that = this;

				model.fetch({ success : function(data)
				{
					that.workflow_json = JSON.stringify(data);
				} });

				var workflowModal = new Workflow_Model_Events({
					url : 'core/api/workflow', 
					template : 'workflow-add',
					isNew : 'true',
					data : { "is_new" : true, "is_disabled" : false, "was_disabled" : false  },
					postRenderCallback : function(el){
						// Init SendVerify Email
						send_verify_email(el);
					}

				});

				$("#content").html(workflowModal.render().el);

			},

			/**
			 * Gets list of logs with respect to campaign.
			 * 
			 * @param id
			 *            Workflow Id
			 * 
			 * @param log_type -
			 *            log-filter type
			 * 
			 * @param log_filter_title -
			 *            selected title to show on button.
			 */
			logsToCampaign : function(id, log_type, log_filter_title)
			{

				getTemplate("campaign-analysis-tabs", { "id" : id }, undefined, function(template_ui){
					if(!template_ui)
						  return;

					// Render tabs
					$('#campaign-analysis-tabs').html($(template_ui));	

					if (log_type == undefined || log_type == "ALL")
					log_type = "";
					else
						log_type = '?log-type=' + log_type;

					var logsListView = new Workflow_Reports_Events({ url : '/core/api/campaigns/logs/' + id + log_type, templateKey : "campaign-logs",
						cursor : true,page_size :20, individual_tag_name : 'tr', sort_collection :false, postRenderCallback : function(el)
						{
							initializeTriggersListeners();
							head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
							{
								$("time.log-created-time", el).timeago();
							});

							$('#log-filter-title').html(log_filter_title);
							
						},appendItemCallback : function(el)
						{
							includeTimeAgo(el);
						}  
						});

					logsListView.collection.fetch({ success : function(collection)
					{
						if (collection.length === 0)
							fill_logs_slate('logs-slate', log_type.split('=')[1]);
					} });

					$('#campaign-analysis-tabs-content').html(logsListView.el);

					$('#campaign-tabs .select').removeClass('select');
					$('.campaign-logs-tab').addClass('select');

				}, "#campaign-analysis-tabs");
			},

			/** Gets list of campaign-stats * */
			campaignStats : function()
			{

				// Load Reports Template
				getTemplate("campaign-stats-chart", {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#content').html($(template_ui));	

					// Show bar graph for campaign stats
					showBar('/core/api/campaign-stats/stats/', 'campaign-stats-chart', 'Campaigns Comparison', 'Email Stats', null);

					$(".active").removeClass("active");
					$("#workflowsmenu").addClass("active");
				}, "#content");
			},

			/**
			 * Returns campaign stats graphs data for given campaign-id.
			 * 
			 * @param id -
			 *            workflow id
			 */
			emailReports : function(id)
			{
				showTransitionBar();

				// Fetches workflows if not filled
				if ($('#campaign-reports-select').html() === null || $('#campaign-reports-select').html() === undefined)
				{
					getTemplate('campaign-analysis', {}, undefined, function(template_ui){
				 		if(!template_ui)
				    		return;

						$('#content').html($(template_ui)); 
						var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";

						// fill workflows
						fillSelect('campaign-reports-select', '/core/api/workflows', 'workflow', function fillCampaign()
						{
							$('#campaign-reports-select').find('option[value=' + id + ']').attr('selected', 'selected');

						}, optionsTemplate);

						initializeLogReportHandlers();
					}, "#content");
						
				}

				getTemplate("campaign-analysis-tabs", { "id" : id }, undefined, function(template_ui){
					if(!template_ui)
						  return;

					// Render tabs with id
					$('#campaign-analysis-tabs').html($(template_ui));
					// Hide bulk subscribers block
					$('#subscribers-block').hide();

					head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION, function()
					{
						// Load Reports Template
						getTemplate('campaign-email-reports', {}, undefined, function(template_ui1){
					 		if(!template_ui1)
					    		return;
							$('#campaign-analysis-tabs-content').html($(template_ui1)); 
							// Set the name
							// $('#reports-campaign-name').text(workflowName);
							initChartsUI(id);

						}, "#campaign-analysis-tabs-content");
					});

					$(".active").removeClass("active");
					$("#workflowsmenu").addClass("active");

					$('#campaign-tabs .select').removeClass('select');
					$('.campaign-stats-tab').addClass('select');
					
					hideTransitionBar();

				}, "#campaign-analysis-tabs");
			},

			/** Gets list of triggers */
			triggers : function()
			{
				this.triggersCollectionView = new Base_Collection_View({

				url : '/core/api/triggers', restKey : "triggers", templateKey : "triggers", individual_tag_name : 'tr', postRenderCallback : function(){} });

				this.triggersCollectionView.collection.fetch();

				$('#content').html(this.triggersCollectionView.el);

				$(".active").removeClass("active");
				$("#workflowsmenu").addClass("active");
			},

			/**
			 * Saves new trigger. Loads jquery.chained.js to link Conditions and
			 * Value of input field.Fills campaign list using fillSelect
			 * function. When + Add is clicked in workflows, fill with selected
			 * campaign-name
			 */
			triggerAdd : function(campaign_id)
			{
				this.triggerModelview = new Base_Model_View({ url : 'core/api/triggers', template : "trigger-add", isNew : true, window : 'triggers',
				/**
				 * Callback after page rendered.
				 * 
				 * @param el
				 *            el property of Backbone.js
				 */
				postRenderCallback : function(el)
				{
					
					// Loads jquery.chained.min.js
					head.js(LIB_PATH + 'lib/agile.jquery.chained.min.js', function()
					{
						var LHS, RHS;

						// Assigning elements with ids LHS
						// and RHS
						// in trigger-add.html
						LHS = $("#LHS", el);
						RHS = $("#RHS", el);

						CALL = $('#CALL', el);
						
						// Chaining dependencies of input
						// fields
						// with jquery.chained.js
						RHS.chained(LHS);
						
						// Chain Call trigger options
						CALL.chained(LHS);

					});

					var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";

					// fill the selected campaign-id
					if (campaign_id)
					{
						fillSelect('campaign-select', '/core/api/workflows', 'workflow', function(id)
						{
							$('#campaign-select', el).find('option[value=' + campaign_id + ']').attr('selected', 'selected');
						}, optionsTemplate, false, el);

					}
					else
					{
						/**
						 * Fills campaign select with existing Campaigns.
						 * 
						 * @param campaign-select -
						 *            Id of select element of Campaign
						 * @param /core/api/workflows -
						 *            Url to get workflows
						 * @param 'workflow' -
						 *            parse key
						 * @param no-callback -
						 *            No callback
						 * @param optionsTemplate-
						 *            to fill options with workflows
						 */
						fillSelect('campaign-select', '/core/api/workflows', 'workflow', 'no-callback', optionsTemplate, false, el);
					}
				},

				saveCallback : function()
				{

					// To get newly added trigger in triggers list
					App_Workflows.triggersCollectionView = undefined;
				}

				});

				var view = this.triggerModelview.render();

				$('#content').html(view.el);
			},

			/**
			 * Updates trigger.
			 * 
			 * @param id -
			 *            trigger id
			 */
			triggerEdit : function(id)
			{

				// Send to triggers if the user refreshes it directly
				if (!this.triggersCollectionView || this.triggersCollectionView.collection.length == 0)
				{
					this.navigate("triggers", { trigger : true });
					return;
				}

				// Gets trigger with respect to id
				var currentTrigger = this.triggersCollectionView.collection.get(id);

				var view = new Base_Model_View({ url : 'core/api/triggers', model : currentTrigger, template : "trigger-add", window : 'triggers',
					postRenderCallback : function(el)
					{
						initializeTriggersListeners();
						// Loads jquery.chained.min.js
						head.js(LIB_PATH + 'lib/agile.jquery.chained.min.js', function()
						{
							var LHS, RHS;

							LHS = $("#LHS", el);
							RHS = $("#RHS", el);

							CALL = $('#CALL', el);
							
							// Chaining dependencies of input
							// fields
							// with jquery.chained.js
							RHS.chained(LHS);
							
							// Chain Call Trigger options
							CALL.chained(LHS);

						});

						/**
						 * Shows given values when trigger selected
						 */

						// To get the input values
						var type = currentTrigger.toJSON()['type'];

						// Shows the Value field with given value
						$('#trigger-type', el).val(type).attr("selected", "selected").trigger('change');

						// Populate milestones list and make obtained milestone
						// selected.
						if (type === 'DEAL_MILESTONE_IS_CHANGED')
						{

							var trigger_deal_milestone_value = currentTrigger.toJSON()['trigger_deal_milestone'];
							populate_milestones_in_trigger($('form#addTriggerForm', el), 'trigger-deal-milestone', trigger_deal_milestone_value);

						}

						if (type == 'FORM_SUBMIT')
						{
							var trigger_form_id = currentTrigger.toJSON()['trigger_form_event'];
							var trigger_run_on_new_contacts = currentTrigger.toJSON()['trigger_run_on_new_contacts'];
							populate_forms_in_trigger($('form#addTriggerForm', el), 'trigger-form-event', trigger_form_id, trigger_run_on_new_contacts);
						}

						// Populate contact filters list and make obtained
						// contact filter
						// selected
						if (type == 'RUNS_DAILY' || type == 'RUNS_WEEKLY' || type == 'RUNS_MONTHLY')
						{
							var trigger_filter_value = currentTrigger.toJSON()['contact_filter_id'];
							populate_contact_filters_in_trigger($('form#addTriggerForm', el), 'contact-filter', trigger_filter_value);
						}

						// Calls TagsTypeAhead on focus event.
						if (type == 'TAG_IS_ADDED' || type == 'TAG_IS_DELETED')
						{

							// Show custom tags textbox
							$('#trigger-custom-tags', el).closest('div.control-group').css('display', '');

							$('.trigger-tags', el).on("focus", function(e)
							{
								e.preventDefault();
								addTagsDefaultTypeahead($('form#addTriggerForm').find('div#RHS'));
							});
						}

						if (type == 'ADD_SCORE')
							$('#trigger-custom-score', el).closest('div.control-group').css('display', '');

						if (type == 'STRIPE_CHARGE_EVENT')
						{
							var stripe_charge_event_type = currentTrigger.toJSON()['trigger_stripe_event'];
							var trigger_run_on_new_contacts = currentTrigger.toJSON()['trigger_run_on_new_contacts'];
							populate_stripe_events_in_trigger($('form#addTriggerForm', el), 'trigger-stripe-event', stripe_charge_event_type, trigger_run_on_new_contacts);
						}

						if (type == 'SHOPIFY_EVENT')
						{
							var shopify_event_type = currentTrigger.toJSON()['trigger_shopify_event'];
							var trigger_run_on_new_contacts = currentTrigger.toJSON()['trigger_run_on_new_contacts'];
							populate_shopify_events_in_trigger($('form#addTriggerForm', el), 'trigger-shopify-event', shopify_event_type, trigger_run_on_new_contacts);
						}

						if(type == 'INBOUND_MAIL_EVENT')
						{
							var new_email_trigger_run_on_new_contacts = currentTrigger.toJSON()['new_email_trigger_run_on_new_contacts'];
							populate_inbound_mail_events_in_trigger($('form#addTriggerForm', el), 'trigger-inbound-mail-event', new_email_trigger_run_on_new_contacts);
						}
						
						if(type == 'EMAIL_OPENED' || type == 'EMAIL_LINK_CLICKED' || type == 'UNSUBSCRIBED')
						{
							if(type !== 'UNSUBSCRIBED'){
								// Show custom tags textbox
								$('#email-tracking-type', el).closest('div.control-group').css('display', '');
							
								$('#email-tracking-type', el).find('option[value=' + currentTrigger.toJSON()["email_tracking_type"] + ']').attr('selected', 'selected').trigger('change');
							}
							
							if(currentTrigger.toJSON()["email_tracking_type"] == "CAMPAIGNS" || type == 'UNSUBSCRIBED')
							{
								$('#email-tracking-campaign-id',el).closest('div.control-group').css('display', '');
								
								var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";

								/**
								 * Fills campaign select drop down with existing
								 * Campaigns and shows previous option as selected.
								 * 
								 * @param campaign-select -
								 *            Id of select element of Campaign
								 * @param /core/api/workflows -
								 *            Url to get workflows
								 * @param 'workflow' -
								 *            parse key
								 * @param callback-function -
								 *            Shows previous option selected
								 * @param optionsTemplate-
								 *            to fill options with workflows
								 */
								fillSelect('email-tracking-campaign-id', '/core/api/workflows', 'workflow', function fillCampaign()
								{
									$('#email-tracking-campaign-id option:first').after('<option value="0">All</option>');
									
									var value = currentTrigger.toJSON();
									if (value)
									{
										$('#email-tracking-campaign-id', el).find('option[value=' + value.email_tracking_campaign_id + ']').attr('selected', 'selected');
									}
									
									// Remove loading image
									$('.loading', el).remove();
									
								}, optionsTemplate, false, el);
							}
							
							if(type == 'EMAIL_LINK_CLICKED')
							{
								// Show custom tags textbox
								$('#custom-link-clicked', el).closest('div.control-group').css('display', '');
							}
							
						}
						
						if(type == 'EVENT_IS_ADDED')
						{
							$('form#addTriggerForm', el).find('select#event-type').closest('div.control-group').css('display', '');
							
							$('#email-type', el).find('option[value=' + currentTrigger.toJSON()["email_type"] + ']').attr('selected', 'selected').trigger('change');
							
							populate_owners_in_trigger($('form#addTriggerForm', el), 'event-owner-id', currentTrigger.toJSON()["event_owner_id"]);
						}
						
						//Inbound of Outbound call
						if(type == 'INBOUND_CALL' || type == 'OUTBOUND_CALL')
						{
							populate_call_trigger_options($('form#addTriggerForm', el), currentTrigger.toJSON());	
						}

						var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";

						/**
						 * Fills campaign select drop down with existing
						 * Campaigns and shows previous option as selected.
						 * 
						 * @param campaign-select -
						 *            Id of select element of Campaign
						 * @param /core/api/workflows -
						 *            Url to get workflows
						 * @param 'workflow' -
						 *            parse key
						 * @param callback-function -
						 *            Shows previous option selected
						 * @param optionsTemplate-
						 *            to fill options with workflows
						 */
						fillSelect('campaign-select', '/core/api/workflows', 'workflow', function fillCampaign()
						{
							var value = currentTrigger.toJSON();
							if (value)
							{
								$('#campaign-select', el).find('option[value=' + value.campaign_id + ']').attr('selected', 'selected');
							}
						}, optionsTemplate, false, el);
					},

					saveCallback : function()
					{

						// To get newly added trigger in triggers list
						App_Workflows.triggersCollectionView = undefined;
					}

				});

				$("#content").html(view.render().el);
			},

			/**
			 * Saves new automation. Loads jquery.chained.js to link Conditions
			 * and Value of input field.Fills campaign list and contact filter
			 * list using fillSelect function.
			 */
			automationAdd : function()
			{
				this.automationModelview = new Base_Model_View({ url : '/core/api/automations', template : "automation-add", isNew : true,
					window : 'automations',
					/**
					 * Callback after page rendered.
					 * 
					 * @param el
					 *            el property of Backbone.js
					 */
					postRenderCallback : function(el)
					{

						var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";

						/**
						 * Fills campaign select with existing Campaigns.
						 * 
						 * @param campaign-select -
						 *            Id of select element of Campaign
						 * @param /core/api/workflows -
						 *            Url to get workflows
						 * @param 'workflow' -
						 *            parse key
						 * @param no-callback -
						 *            No callback
						 * @param optionsTemplate-
						 *            to fill options with workflows
						 */
						fillSelect('campaign-select', '/core/api/workflows', 'workflow', 'no-callback', optionsTemplate, false, el);

						fillSelect('filter-select', '/core/api/filters', 'workflow', 'no-callback', optionsTemplate, false, el);
					}

				});

				var view = this.automationModelview.render();

				$('#content').html(view.el);
			},

			/** Gets list of automations */
			automations : function()
			{
				this.automationsCollectionView = new Base_Collection_View({

				url : '/core/api/automations', restKey : "automations", templateKey : "automations", individual_tag_name : 'tr' });

				this.automationsCollectionView.collection.fetch();

				$('#content').html(this.automationsCollectionView.el);

				$(".active").removeClass("active");
				$("#workflowsmenu").addClass("active");
			},

			/**
			 * Updates automation.
			 * 
			 * @param id -
			 *            automation id
			 */
			automationEdit : function(id)
			{

				// Send to triggers if the user refreshes it directly
				if (!this.automationsCollectionView || this.automationsCollectionView.collection.length == 0)
				{
					this.navigate("automations", { trigger : true });
					return;
				}

				// Gets automation with respect to id
				var currentAutomation = this.automationsCollectionView.collection.get(id);

				var view = new Base_Model_View({ url : 'core/api/automations', model : currentAutomation, template : "automation-add", window : 'automations',
					postRenderCallback : function(el)
					{

						/**
						 * Shows given values when automation selected
						 */

						// To get the input values
						var durationType = currentAutomation.toJSON()['durationType'];

						// Shows the Value field with given value
						$('#period-type', el).val(durationType).attr("selected", "selected").trigger('change');

						var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
						/**
						 * Fills campaign select drop down with existing
						 * Campaigns and shows previous option as selected.
						 * 
						 * @param campaign-select -
						 *            Id of select element of Campaign
						 * @param /core/api/workflows -
						 *            Url to get workflows
						 * @param 'workflow' -
						 *            parse key
						 * @param callback-function -
						 *            Shows previous option selected
						 * @param optionsTemplate-
						 *            to fill options with workflows
						 */
						fillSelect('campaign-select', '/core/api/workflows', 'workflow', function fillCampaign()
						{
							var value = currentAutomation.toJSON();
							if (value)
							{
								$('#campaign-select', el).find('option[value=' + value.campaign_id + ']').attr('selected', 'selected');
							}
						}, optionsTemplate, false, el);

						/**
						 * Fills contact filer select drop down with existing
						 * Contact filters and shows previous option as
						 * selected.
						 * 
						 * @param campaign-select -
						 *            Id of select element of Campaign
						 * @param /core/api/workflows -
						 *            Url to get workflows
						 * @param 'workflow' -
						 *            parse key
						 * @param callback-function -
						 *            Shows previous option selected
						 * @param optionsTemplate-
						 *            to fill options with workflows
						 */
						fillSelect('filter-select', '/core/api/filters', 'workflow', function fillContactFilter()
						{
							var value = currentAutomation.toJSON();
							if (value)
							{
								$('#filter-select', el).find('option[value=' + value.contactFilter_id + ']').attr('selected', 'selected');

							}
						}, optionsTemplate, false, el);

					},

				});

				$("#content").html(view.render().el);
			},

			/**
			 * Returns all subscribers including active, completed and removed.
			 * 
			 * @param id -
			 *            workflow id.
			 */
			allSubscribers : function(id)
			{
				// Render tabs
				getTemplate("campaign-analysis-tabs", { "id" : id }, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#campaign-analysis-tabs').html($(template_ui));
					var all_subscribers_collection = get_campaign_subscribers_collection(id, 'core/api/workflows/all-subscribers/' + id,
						'workflow-other-subscribers');
					all_subscribers_collection.collection.fetch({ success : function(collection)
					{
						if (collection.length === 0)
							fill_subscribers_slate('subscribers-slate', "all-subscribers");
					} });
					$("#campaign-analysis-tabs-content").html(all_subscribers_collection.el);
					// Hide bulk subscribers block
					$('#subscribers-block').hide();

					$('#campaign-tabs .select').removeClass('select');
					$('.campaign-subscribers-tab').addClass('select');	
					}, "#campaign-analysis-tabs");
			},

			/**
			 * Returns list of subscribers having campaignStatus
			 * campaignId-ACTIVE
			 * 
			 * @param id -
			 *            workflow id.
			 */
			activeSubscribers : function(id)
			{

				if (!this.workflow_list_view || this.workflow_list_view.collection.length == 0)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				this.active_subscribers_collection = get_campaign_subscribers_collection(id, 'core/api/workflows/active-subscribers/' + id,
						'workflow-active-contacts');

				this.active_subscribers_collection.collection.fetch({ success : function(collection)
				{

					// show pad content
					if (collection.length === 0)
						fill_subscribers_slate('subscribers-slate', "active-subscribers");
				} });

				$("#campaign-analysis-tabs-content").html(this.active_subscribers_collection.el);

				// Hide bulk subscribers block
				$('#subscribers-block').hide();

				$('#campaign-tabs .select').removeClass('select');
				$('.campaign-subscribers-tab').addClass('select');

			},

			/**
			 * Returns list of completed subscribers of given campaign-id having
			 * campaignStatus campaignId-DONE
			 * 
			 * @param id -
			 *            workflow id.
			 * 
			 */
			completedSubscribers : function(id)
			{

				if (!this.workflow_list_view || this.workflow_list_view.collection.length == 0)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				var completed_subscribers_collection = get_campaign_subscribers_collection(id, 'core/api/workflows/completed-subscribers/' + id,
						'workflow-other-subscribers');

				completed_subscribers_collection.collection.fetch({ success : function(collection)
				{

					// show pad content
					if (collection.length === 0)
						fill_subscribers_slate('subscribers-slate', "completed-subscribers");
				} });
				$("#campaign-analysis-tabs-content").html(completed_subscribers_collection.el);

				// Hide bulk subscribers block
				$('#subscribers-block').hide();

				$('#campaign-tabs .select').removeClass('select');
				$('.campaign-subscribers-tab').addClass('select');
			},

			/**
			 * Returns list of subscribers removed from a campaign.
			 * 
			 * @param id -
			 *            workflow id.
			 */
			removedSubscribers : function(id)
			{

				if (!this.workflow_list_view || this.workflow_list_view.collection.length == 0)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				var removed_subscribers_collection = get_campaign_subscribers_collection(id, 'core/api/workflows/removed-subscribers/' + id,
						'workflow-other-subscribers');

				removed_subscribers_collection.collection.fetch({ success : function(collection)
				{

					// show pad content
					if (collection.length === 0)
						fill_subscribers_slate('subscribers-slate', "removed-subscribers");
				} });

				$("#campaign-analysis-tabs-content").html(removed_subscribers_collection.el);

				// Hide bulk subscribers block
				$('#subscribers-block').hide();

				$('#campaign-tabs .select').removeClass('select');
				$('.campaign-subscribers-tab').addClass('select');
			},
			unsubscribedSubscribers : function(id)
			{

				if (!this.workflow_list_view || this.workflow_list_view.collection.length == 0)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				var unsubscribed_subscribers_collection = get_campaign_subscribers_collection(id, 'core/api/workflows/unsubscribed-subscribers/' + id,
						'workflow-other-subscribers');

				unsubscribed_subscribers_collection.collection.fetch({ success : function(collection)
				{

					// show pad content
					if (collection.length === 0)
						fill_subscribers_slate('subscribers-slate', "unsubscribe-subscribers");
				} });

				$("#campaign-analysis-tabs-content").html(unsubscribed_subscribers_collection.el);

				// Hide bulk subscribers block
				$('#subscribers-block').hide();

				$('#campaign-tabs .select').removeClass('select');
				$('.campaign-subscribers-tab').addClass('select');
			},

			hardBouncedSubscribers : function(id)
			{

				if (!this.workflow_list_view || this.workflow_list_view.collection.length == 0)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				var hardbounced_subscribers_collection = get_campaign_subscribers_collection(id, 'core/api/workflows/hardbounced-subscribers/' + id,
						'workflow-other-subscribers');

				hardbounced_subscribers_collection.collection.fetch({ success : function(collection)
				{

					// show pad content
					if (collection.length === 0)
						fill_subscribers_slate('subscribers-slate', "hardbounced-subscribers");
				} });

				$("#campaign-analysis-tabs-content").html(hardbounced_subscribers_collection.el);
				// Hide bulk subscribers block
				$('#subscribers-block').hide();

				$('#campaign-tabs .select').removeClass('select');
				$('.campaign-subscribers-tab').addClass('select');
			},

			softBouncedSubscribers : function(id)
			{

				if (!this.workflow_list_view || this.workflow_list_view.collection.length == 0)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				var softbounced_subscribers_collection = get_campaign_subscribers_collection(id, 'core/api/workflows/softbounced-subscribers/' + id,
						'workflow-other-subscribers');

				softbounced_subscribers_collection.collection.fetch({ success : function(collection)
				{

					// show pad content
					if (collection.length === 0)
						fill_subscribers_slate('subscribers-slate', "softbounced-subscribers");
				} });

				$("#campaign-analysis-tabs-content").html(softbounced_subscribers_collection.el);
				// Hide bulk subscribers block
				$('#subscribers-block').hide();

				$('#campaign-tabs .select').removeClass('select');
				$('.campaign-subscribers-tab').addClass('select');
			},

			spamReportedSubscribers : function(id)
			{

				if (!this.workflow_list_view || this.workflow_list_view.collection.length == 0)
				{
					this.navigate("workflows", { trigger : true });
					return;
				}

				var spam_reported_subscribers_collection = get_campaign_subscribers_collection(id, 'core/api/workflows/spam-reported-subscribers/' + id,
						'workflow-other-subscribers');

				spam_reported_subscribers_collection.collection.fetch({ success : function(collection)
				{

					// show pad content
					if (collection.length === 0)
						fill_subscribers_slate('subscribers-slate', "spam-reported-subscribers");
				} });

				$("#campaign-analysis-tabs-content").html(spam_reported_subscribers_collection.el);
				// Hide bulk subscribers block
				$('#subscribers-block').hide();

				$('#campaign-tabs .select').removeClass('select');
				$('.campaign-subscribers-tab').addClass('select');
			} });
// To Enable Console in IE - MC
$(function(){
	var alertFallback = false;
	
	if (typeof console === "undefined" || typeof console.log === "undefined") {
		console = {};
		if (alertFallback) {
			console.log = function(msg) {
            alert(msg);
         };
		} else {
         console.log = function() {};
		}
	}
	
	// Disable console.logging if disabled
	if(!IS_CONSOLE_ENABLED)
	{
		//console.log("disabling");		
		console.log = function(){};
		if(console.warn)
			console.warn = function(){};
	}
});   /**
 * Initializes the date-range-picker. Calls the callback when the date range is
 * selected.
 * 
 * @param campaign_id -
 *            to show charts w.r.t campaign-id.
 * @param callback -
 *            callback method if any.
 */
function initFunnelCharts(callback)
{
	head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION, function()
	{
		$('.daterangepicker').remove();
		// Bootstrap date range picker.
		$('#reportrange').daterangepicker({ ranges : { 'Today' : [
				'today', 'today'
		], 'Yesterday' : [
				'yesterday', 'yesterday'
		], 'Last 7 Days' : [
				Date.today().add({ days : -6 }), 'today'
		], 'Last 30 Days' : [
				Date.today().add({ days : -29 }), 'today'
		], 'This Month' : [
				Date.today().moveToFirstDayOfMonth(), Date.today().moveToLastDayOfMonth()
		], 'Last Month' : [
				Date.today().moveToFirstDayOfMonth().add({ months : -1 }), Date.today().moveToFirstDayOfMonth().add({ days : -1 })
		], 'This Quarter' : [
				Date.today().getMonth() < 3 ? new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth() : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth() : new Date(Date.today().setMonth(9)).moveToFirstDayOfMonth(), 
				Date.today().getMonth() < 3 ? new Date(Date.today().setMonth(2).moveToLastDayOfMonth()) : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(5)).moveToLastDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(8)).moveToLastDayOfMonth() : new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()
		], 'Last Quarter' : [
				Date.today().getMonth() < 3 ? new Date(Date.today().add({ years : -1 }).setMonth(9)).moveToFirstDayOfMonth() : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth() : new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth(), 
				Date.today().getMonth() < 3 ? new Date(Date.today().add({ years : -1 }).setMonth(11)).moveToLastDayOfMonth() : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(2)).moveToLastDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(5)).moveToLastDayOfMonth() : new Date(Date.today().setMonth(8)).moveToLastDayOfMonth()
		], 'This Year' : [
				new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth(), new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()
		], 'Last Year' : [
				new Date(Date.today().setMonth(0)).add({ years : -1 }).moveToFirstDayOfMonth(), new Date(Date.today().setMonth(11)).add({ years : -1 }).moveToLastDayOfMonth()
		] }, locale : { applyLabel : 'Apply', cancelLabel : 'Cancel', customRangeLabel : 'Custom', daysOfWeek : [
				'Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'
		], monthNames : [
				'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'
		], firstDay : parseInt(CALENDAR_WEEK_START_DAY) } }, function(start, end)
		{
			var months_diff = Math.abs(start.getMonth() - end.getMonth() + (12 * (start.getFullYear() - end.getFullYear())));
			$('#reportrange span').html(start.toString('MMMM d, yyyy') + ' - ' + end.toString('MMMM d, yyyy'));
			$("#week-range").html(end.add({ days : -6 }).toString('MMMM d, yyyy') + ' - ' + end.add({ days : 6 }).toString('MMMM d, yyyy'));
			
			callback();
		});
		$('.daterangepicker > .ranges > ul').on("click", "li", function(e)
		{
			$('.daterangepicker > .ranges > ul > li').each(function(){
				$(this).removeClass("active");
			});
			$(this).addClass("active");
		});
	});

	// Init the callback when the frequency selector changes too
	if ($('#frequency').length > 0)
	{
		// Get Frequency
		
		$('#frequency').change(function()
		{
			callback();
		});
	}

	fillSelect("filter", "core/api/filters", undefined, function()
	{
		$('#filter').change(function()
		{
			callback();
		});

	}, '<option class="default-select" value="{{id}}">{{name}}</option>', false, undefined, "All Contacts");

	if ($('#type').length > 0)
	{
		// Get Frequency
		
		$('#type').change(function()
		{
			callback();
		});
	}
	fillSelect("owner", "core/api/users", undefined, function()
			{
				$('#owner').change(function()
				{

					callback();
				});

	}, '<option class="default-select" value="{{id}}">{{name}}</option>', false, undefined, "All Owners");

	callback();
}


/** .
* 
* @param callback -
*            callback method if any.
*/
function initReportsForCalls(callback){
	

	head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js', function()
	{

		// Bootstrap date range picker.
		$('#reportrange').daterangepicker({ ranges : { 'Today' : [
				'today', 'today'
		], 'Yesterday' : [
				'yesterday', 'yesterday'
		], 'Last 7 Days' : [
				Date.today().add({ days : -6 }), 'today'
		], 'Last 30 Days' : [
				Date.today().add({ days : -29 }), 'today'
		], 'This Month' : [
				Date.today().moveToFirstDayOfMonth(), Date.today().moveToLastDayOfMonth()
		], 'Last Month' : [
				Date.today().moveToFirstDayOfMonth().add({ months : -1 }), Date.today().moveToFirstDayOfMonth().add({ days : -1 })
		] }, locale : { applyLabel : 'Apply', cancelLabel : 'Cancel', fromLabel : 'From', toLabel : 'To', customRangeLabel : 'Custom', daysOfWeek : [
				'Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'
		], monthNames : [
				'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'
		], firstDay : parseInt(CALENDAR_WEEK_START_DAY) } }, function(start, end)
		{
			var months_diff = Math.abs(start.getMonth() - end.getMonth() + (12 * (start.getFullYear() - end.getFullYear())));
			$('#reportrange span').html(start.toString('MMMM d, yyyy') + ' - ' + end.toString('MMMM d, yyyy'));
			$("#week-range").html(end.add({ days : -6 }).toString('MMMM d, yyyy') + ' - ' + end.add({ days : 6 }).toString('MMMM d, yyyy'));

			callback();
		});
	});
	
	callback();
	
	$('#typeCall').change(function()
		{
			callback();
		});
	
	fillSelect("users", "core/api/users", undefined, function()
			{
				$('#users').change(function()
				{

					callback();
				});

			}, '<option class="default-select" value="{{id}}">{{name}}</option>', false, undefined, "All Users");
	
}

/**
 * Shows Funnel Graphs based on the tags
 */
function showFunnelGraphs(tags)
{
	console.log("Showing funnel logs");
	showFunnel('core/api/reports/funnel/' + tags + getOptions(), 'funnel-chart', 'Funnel Reports', true);
}

/**
 * Shows Grwoth Graphs based on the tags
 */
function showGrowthGraphs(tags)
{
	showAreaSpline('core/api/reports/growth/' + tags + getOptions(), 'growth-chart', '', '', true);
}

/**
 * Shows Grwoth Graphs based on the tags
 */
function showCohortsGraphs(tag1, tag2)
{
	showCohorts('core/api/reports/cohorts/' + tag1 + "/" + tag2 + "/" + getOptions(), 'cohorts-chart', 'Cohort Analysis', tag1 + ' vs ' + tag2, true);
}

/**
 * Shows Ratio Graphs based on the tags
 */
function showRatioGraphs(tag1, tag2)
{
	showLine('core/api/reports/ratio/' + tag1 + "/" + tag2 + "/" + getOptions(), 'ratio-chart', 'Ratio Analysis', tag1 + ' vs ' + tag2, true);
}
  function showDealsGrowthReport()
{
// Options
    var options = "";

    // Get Date Range January 22, 2015 - January 28, 2015
    var range = $('#range').html().split("-");
    /*
     * var temp = "January 22, 2015 - January 28, 2015"; var range =
     * temp.split("-");
     */
    // Returns milliseconds from start date. For e.g., August 6, 2013 converts
    // to 1375727400000
    //var start_time = Date.parse($.trim(range[0])).valueOf();
    //Get the GMT start time
    var start_time = getUTCMidNightEpochFromDate(new Date(range[0]));
    var d = new Date();
    start_time=start_time+(d.getTimezoneOffset()*60*1000);
    start_time=start_time/1000;
    var end_value = $.trim(range[1]);

    // To make end value as end time of day
    if (end_value)
        end_value = end_value + " 23:59:59";

    // Returns milliseconds from end date.
    //var end_time = Date.parse(end_value).valueOf();
    //Get the GMT end time
    var end_time = getUTCMidNightEpochFromDate(new Date(end_value));

    end_time += (((23*60*60)+(59*60)+59)*1000);
    end_time=end_time+(d.getTimezoneOffset()*60*1000);
    end_time=end_time/1000;

    if ($('#owner').length > 0)
	{
		// Get User
		var owner_id=0;
		if ($("#owner").val() != "" && $("#owner").val() != "All Owners")
			owner_id=$("#owner").val();
			options += owner_id;
	}
    // Adds start_time, end_time to params.
    options += ("?min=" + start_time + "&max=" + end_time);
        if ($('#frequency').length > 0)
    {
        // Get Frequency
        var frequency = $("#frequency").val();
        options += ("&frequency=" + frequency);
    }
        if ($('#type').length > 0)
        {
            // Get Frequency
            var type = $("#type").val();
            options += ("&type=" + type);
        }


    showDealsGrowthgraph('core/api/opportunity/details/' + options, 'deals-chart', '', '',true);

}
/**
 * Highlight the default option in date picker
 */
function highlightDatepickerOption()
{
	var hasActive = false;
	$('.daterangepicker > .ranges > ul').each(function()
	{
		if ($(this).hasClass("active"))
		{
			hasActive = true;
		}
	});
	if (!hasActive)
	{
		$('.daterangepicker > .ranges > ul > li').eq(2).addClass("active");
	}
}


 function push_signup_plan(plan)
 {
 	try
 	{
 		if(!window.ga)
 		{
 			setTimeout(function(){
 				push_signup_plan(plan);
 			}, 2000);
 		}
 		ga('send', 'event', 'Dashboard', 'Signup', _plan_on_signup["plan_type"], _plan_on_signup["quantity"]);	
 	}
 	catch(err)
 	{
 		console.error(err);
 	}
	
	
 }

 function push_actual_plan(plan)
 {
	try
	{
		if(!window.ga)
 		{
 			setTimeout(function(){
 				push_actual_plan(plan);
 			}, 2000);
 		}

		ga('send', 'event', 'Dashboard', 'Paid', plan["plan_type"], plan["quantity"]);
	}
 	catch(err)
 	{
 		console.error(err);
 	}
 }

 $(function(){
 	try
 	{
 		if(IS_NEW_USER && _plan_on_signup)
 		push_signup_plan(_plan_on_signup)	
 	
 	}catch(err)
 	{
 		console.log(err);
 	}
 	
 })/**
 * Tags
 */
var CANCELED = "Canceled";
var SIGN_UP = "Signup";
var CAMPAIGN_TAG = "Campaigns";
var CODE_SETUP_TAG = "Code setup";
var IMPORT_TAG = "Import";
var SOCIAL_TAG = "Social";
var WIDGET_TAG = "Widgets";
var DOMAIN_COOKIE_FOR_WEBSITE = "_agile_login_domain"

// Subject for account cancellation note
var ACCOUNT_CANCELED_NOTE_SUBJECT = "Account Canceled";

// Account cancellation cusom field
var ACCOUNT_CANCELED_CUSTOM_FIELD_NAME = "Cancel Reason";

function our_domain_set_account() {
	// If it is local server then add contacts to local domain instead of
	// our domain
	if (LOCAL_SERVER)
		_agile.set_account('7n7762stfek4hj61jnpce7uedi', 'local');

	else
		_agile.set_account('td2h2iv4njd4mbalruce18q7n4', 'our');

	_agile.set_email(CURRENT_DOMAIN_USER['email']);

	// Track page view code
	_agile.track_page_view();
}


/**
 * Adds domain and loggedin date in contact in our domain
 */
function add_custom_fields_to_our_domain(callback) {
	add_init_tags(function() {
		get_new_custom_properties_to_add();
		add_referrar_info_as_note();
	});
}

/**
 * Creates custom field for domain field
 * @returns {___anonymous6182_6183}
 */
function getDomainCustomField() {
	// Gets domain property from contact
	var domain_custom_field = getProperty(Agile_Contact.properties, 'Domain');

	if (!domain_custom_field
			|| domain_custom_field.value != CURRENT_DOMAIN_USER["domain"]) {
		return create_contact_custom_field("Domain",
				CURRENT_DOMAIN_USER["domain"], "CUSTOM");
	}
}

/**
 * Creates loggedin time and domain fields
 * @param callback
 */
function get_new_custom_properties_to_add(callback) {
		addLoggedInTime(function(){
			addDomain(callback);
		});
}

/**
 * Creates domain
 * @param callback
 */
function addDomain(callback) {
	var domainField = getDomainCustomField();
	if (!domainField) {
		if (callback && typeof callback === "function")
			callback();
		return;
	}
	property_request(domainField, callback);
}

function addLoggedInTime(callback) {
	var timeField = new_current_loggedin_time();
	if (!timeField) {
		
		processCallback(callback);
		return;
	}

	property_request(timeField, callback);
}

/**
 * Processes callback
 * @param callback
 */
function processCallback(callback)
{
	if (callback && typeof callback === "function")
		callback();
}

function property_request(property, callback)
{
	_agile.add_property(property,
			function(data) {
				Agile_Contact = data;
				_agile_contact = data;

				processCallback(callback)
			});	
}

/**
 * Adds all tags in single reqeust
 * @param callback
 */
function add_init_tags(callback) {
	var tag = "";
	tag = SIGN_UP;
	if (CURRENT_DOMAIN_USER['is_account_owner']) {
		tag += "," + "Domain Owner";
	}

	add_miltiple_tags(tag, callback);
}

function add_miltiple_tags(tags, callback) {
	var tags_array = tags.split(",");

	var finalizedTags = "";

	for (var i = 0; i < tags_array.length; i++) {
		if (hasTagInContact(tags_array[i]))
			continue;

		if (finalizedTags.length > 0)
			finalizedTags += "," + tags_array[i];
		else
			finalizedTags += tags_array[i];
	}

	if (finalizedTags.length == 0) {
		if (callback && typeof (callback) === "function") {
			callback();
		}

		return;
	}
	add_multiple_tags_request(finalizedTags.trim(), callback)
}

function add_multiple_tags_request(finalizedTags, callback) {
	_agile.add_tag(finalizedTags, function(data) {
		Agile_Contact = data;

		if (callback && typeof (callback) === "function") {
			callback(data);
		}
	});
}

/***************************************/

function new_current_loggedin_time() {
	// Gets current time, and updates the last loggedin time.
	var current_date_object = new Date();
	var current_date_string = current_date_object.getUTCMonth() + 1 + "/"
			+ current_date_object.getUTCDate() + "/"
			+ current_date_object.getUTCFullYear();

	console.log(parseInt(current_date_object.getTime() / 1000));

	// Gets logged in time property.
	var loggedin_time_property = getProperty(Agile_Contact.properties,
			'Last login');
	var existing_date_string = "";

	// To whether custom is new or old.
	var is_new_customer = true;
	if (loggedin_time_property) {
		var existing_date_object = new Date(
				parseFloat(loggedin_time_property.value) * 1000);
		existing_date_string = existing_date_object.getUTCMonth() + 1 + "/"
				+ existing_date_object.getUTCDate() + "/"
				+ existing_date_object.getUTCFullYear();
		is_new_customer = false;
	}

	// If loggedin time is defined and it is not equal to current date then it
	// is updated
	if (existing_date_string && existing_date_string == current_date_string)
		return;

	loggedin_time_property = create_contact_custom_field("Last login",
			parseInt(current_date_object.getTime() / 1000), 'CUSTOM');

	return loggedin_time_property;
}


function create_contact_custom_field(name, value, type, subtype) {
	if (!name)
		return;

	var json = {};
	json["name"] = name;
	json["value"] = value;
	json["subtype"] = type;

	console.log(value);
	return json;

}

function add_account_canceled_info(info, callback) {
	var custom_field = create_contact_custom_field(
			ACCOUNT_CANCELED_CUSTOM_FIELD_NAME, info["reason"], 'CUSTOM');
	_agile.add_property(custom_field, function(data) {
		add_tag_our_domain(CANCELED, function(data) {

			if (info["reason_info"]) {
				var note = {};
				note.subject = ACCOUNT_CANCELED_NOTE_SUBJECT;
				note.description = info["reason_info"];

				_agile.add_note(note, function(data) {
					console.log(data);
					Agile_Contact = data;

					if (callback && typeof (callback) === "function") {
						callback();
					}

				});
				return;
			}

			if (callback && typeof (callback) === "function") {
				callback();
			}

		});
	});
}

/**
 * adds referral info as a note while adding contact as a note in our domain
 */

function add_referrar_info_as_note() {
	var utmsource = readCookie("_agile_utm_source");
	var utmcampaign = readCookie("_agile_utm_campaign");
	var utmmedium = readCookie("_agile_utm_medium");
	var utmreferencedomain = readCookie("agile_reference_domain");
	if (utmsource && utmcampaign && utmmedium && utmreferencedomain) {
		var note = {};
		note.subject = "Referrer";
		note.description = "Source - " + utmsource + "\n Campaign -  "
				+ utmcampaign + "\n Medium - " + utmmedium
				+ "\n Reference Domain -" + utmreferencedomain;

		_agile.add_note(note, function(data) {
			console.log(data);
			eraseCookie("agile_reference_domain");

		});
	}
}

// add GMT tag for user who is in between 4am to 6pm GMT
function add_timezone_tag() {
	var date = new Date();
	var startTime = date.getUTCHours();
	if (startTime >= 3 && startTime <= 15) {
		add_tag_our_domain("GMT");
	}
}


function our_domain_sync() {

	try {

		our_domain_set_account();

		var domain = readCookie(DOMAIN_COOKIE_FOR_WEBSITE);

		// Sets different cookie if user logs into different domain
		if (!domain || domain != CURRENT_DOMAIN_USER["domain"])
			createCookieInAllAgileSubdomains(DOMAIN_COOKIE_FOR_WEBSITE,
					CURRENT_DOMAIN_USER["domain"],365);

		get_contact_from_our_domain(function(data) {
			// Shows noty
			// set_profile_noty();
			Agile_Contact = data;

			// Adds signup tag, if it is not added previously.
			// set_profile_noty();
			add_custom_fields_to_our_domain();

			;
			initWebrules();

		}, function(data) {
			var name = CURRENT_DOMAIN_USER['name'];

			// var first_name = name, last_name = name;
			name = name.trim();
			var first_name = name.split(" ")[0].trim();
			var last_name = (first_name.length < name.length) ? name.substring(
					first_name.length + 1).trim() : '';

			// Creates a new contact and assigns it to global value
			_agile.create_contact({
				"email" : CURRENT_DOMAIN_USER['email'],
				"first_name" : first_name,
				"last_name" : last_name
			}, function(data) {
				Agile_Contact = data;
				// Shows noty
				// set_profile_noty();
				add_custom_fields_to_our_domain();

				initWebrules();
			});

		})
		// Gets contact based on the the email of the user logged in

	} catch (err) {

	}
}

function get_contact_from_our_domain(successCallback, errorCallback) {

	// Gets contact based on the the email of the user logged in
	agile_getContact(CURRENT_DOMAIN_USER['email'], {
		success : function(data) {
			Agile_Contact = data;
			if (successCallback && typeof (successCallback) === "function")
				successCallback(data);
		},
		error : function(data) {
			if (errorCallback && typeof (errorCallback) === "function")
				errorCallback(data);
		}
	})

}

function add_signup_tag(callback) {
	if (!Agile_Contact.tags || Agile_Contact.tags.indexOf(SIGN_UP) < 0) {
		add_tag_our_domain(SIGN_UP, function(data) {
			// Calling to add custom fields here so avoid data loss
			// due to asyn
			// requests
			add_custom_fields_to_our_domain();

			if (callback && typeof (callback) === "function") {
				callback();
			}
		})
		return;
	}

	// Calling to add custom fields here so avoid data loss due to asyn requests
	add_custom_fields_to_our_domain();
}


function setup_our_domain_sync() {
	our_domain_sync();
}



// Checks if tag exists
function checkTagAgile(tag) {

	console.log(Agile_Contact);
	if (Agile_Contact && Agile_Contact.tags)
		return Agile_Contact.tags.indexOf(tag) > -1;

	return false;
}

function hasTagInContact(tag) {
	if (!tag)
		return false;

	if (Agile_Contact
			&& (!Agile_Contact.tags || Agile_Contact.tags.indexOf(tag) < 0))
		return false;

	return true;

}

function add_tag_our_domain(tag, callback) {
	if (hasTagInContact(tag)) {
		if (callback && typeof (callback) === "function") {
			callback(Agile_Contact);
		}
		return;
	}

	_agile.add_tag(tag, function(data) {
		Agile_Contact = data;

		if (callback && typeof (callback) === "function") {
			callback(data);
		}
	});
}

/**
 * Adds tag to 'OUR' domain.
 * 
 * @param tag
 */
function addTagAgile(tag) {

	try{
		// Checks if tag is already available.
		if (checkTagAgile(tag))
			return;

		// Adds tag
		_agile.add_tag(tag, function(data) {
			Agile_Contact = data;
			if (!checkTagAgile(tag))
				Agile_Contact.tags.push(tag)
				// set_profile_noty();
		});
		
	}catch(err){}
	
}

function add_property(name, value, type, callback) {
	// alert(Agile_Contact.properties);
	var property = getProperty(Agile_Contact.properties, name);
	if (property && property.value == value && type == property.type) {
		callback(Agile_Contact);
		return false;

	}
	_agile.add_property(create_contact_custom_field(name, value, type),
			function(data) {
				Agile_Contact = data;
				_agile_contact = data;

				if (callback && typeof callback == "function")
					callback(data);
			});
}

var GLOBAL_WEBRULE_FLAG;
function initWebrules() {
	_agile_execute_web_rules();
	GLOBAL_WEBRULE_FLAG = true;
}


function add_properties_from_popup(phone_number, company_size) {
	_agile.add_property(create_contact_custom_field("Company Size",
			company_size, "CUSTOM"), function(data) {
		_agile.add_property(create_contact_custom_field("phone", phone_number,
				"SYSTEM", "home"), function(data) {

			console.log(data);
			_agile_contact = data;
			console.log(_agile_contact);
			window.setTimeout(initWebrules, 4000);

		});
	});
}

/**
 * adds user info as a note to account owner when user created called from
 * user-add route
 */
function add_created_user_info_as_note_to_owner(owner, callback) {
	var note = {};
	note.subject = "User created";
	note.description = " Domain - " + owner['domain'] + "\n User Email -  "
			+ owner['created_user_email'];
	_agile.add_note(note, function(data) {
		if (callback && typeof callback == "function")
			callback(data);

	}, owner['email']);

}

// add note to owner when subscription is cancelled
function add_cancel_subscription_info_as_note_to_owner(cus_email, callback) {
	var note = {};
	note.subject = "Subscription Cancelled";
	note.description = " Subscription cancelled by "
			+ CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data) {
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);
}
function add_delete_user_info_as_note_to_owner(cus_email, callback) {
	var note = {};
	note.subject = "User Deleted ";
	note.description = " One user deleted by " + CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data) {
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);

}
function add_refunded_info_as_note_to_owner(cus_email, amount, callback) {
	var note = {};
	note.subject = "Amount Refunded ";
	note.description = "Amount $" + amount + " refunded by "
			+ CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data) {
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);

}
function add_password_change_info_as_note_to_owner(cus_email, callback) {
	var note = {};
	note.subject = "Password Changed ";
	note.description = " Password changed by " + CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data) {
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);

}

/**
 * Adds plan changed info as a note
 * @param cus_email
 * @param plan_type
 * @param plan_id
 * @param quantity
 * @param callback
 */
function add_plan_change_info_as_note_to_owner(cus_email, plan_type, plan_id,
		quantity, callback) {
	var note = {};
	note.subject = "Plan Changed ";
	note.description = " Plan changed to " + plan_type + " (" + plan_id + "*"
			+ quantity + ") by " + CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data) {
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);

}

$(function(){
	
	
});

function initialize_agile_domain_sync(){

	try
	{
		if(_agile)
		{
			setup_our_domain_sync();
			return;
		}
		head.js("stats/min/agile-min.js", function(){
			setup_our_domain_sync();
		})
		
	}
	catch(err)
	{
		console.log();
	}
	
}

// add note to owner when subscription is cancelled
function add_cancel_subscription_info_as_note_to_owner(cus_email, callback)
{
	var note = {};
	note.subject = "Subscription Cancelled";
	note.description = " Subscription cancelled by "+CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data)
	{
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);
}
function add_delete_user_info_as_note_to_owner(cus_email, callback)
{
	var note = {};
	note.subject = "User Deleted ";
	note.description = " One user deleted by "+CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data)
		{
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);

}
function add_refunded_info_as_note_to_owner(cus_email, amount, callback)
{
	var note = {};
	note.subject = "Amount Refunded ";
	note.description = "Amount $"+amount+" refunded by "+CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data)
		{
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);

}
function add_password_change_info_as_note_to_owner(cus_email, callback)
{
	var note = {};
	note.subject = "Password Changed ";
	note.description = " Password changed by "+CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data)
		{
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);

}
function add_plan_change_info_as_note_to_owner(cus_email, plan_type, plan_id, quantity, callback)
{
	var note = {};
	note.subject = "Plan Changed ";
	note.description = " Plan changed to "+plan_type+" ("+plan_id+"*"+quantity+") by "+CURRENT_DOMAIN_USER.email;
	_agile.add_note(note, function(data)
		{
		if (callback && typeof callback == "function")
			callback(data);

	}, cus_email);

}
var Agile_Tour = {};

/**
 * Returns Agile_tour steps JSON
 * 
 * @param el
 */
function create_tour_steps(el)
{

	Agile_Tour["contacts"] = [
			{ "element" : "#contacts", "title" : "Contact & Account Management",
				"content" : "View your contacts, leads and accounts (companies) all at one place.<br/>", "placement" : "bottom", "el" : el, "backdrop" : true },
			{ "element" : "#filters-tour-step", "title" : "Companies (Accounts)",
				"content" : "Accounts are stored as Companies in Agile.<br/><br/> You can switch between contacts and companies  here.<br/>",
				"placement" : "bottom", "el" : el, "backdrop" : true },
			{
				"element" : "#tags",
				"title" : "Tags",
				"content" : "Tags help you effectively manage your contacts and companies.<br/><br/> For eg: you can add a lead tag to your contacts for leads.<br/>",
				"placement" : "right", "el" : el, "backdrop" : true }
	]

	/**
	 * Contacts details
	 */
	Agile_Tour["contact-details"] = [
			{ "element" : "#contact-tab-content", "title" : "Facebook-Style Timeline",
				"content" : "Notice the awesome timeline with dates, emails exchanged, social messages & site visits.<br/>", "placement" : "right", "el" : el,
				"backdrop" : true },
			{
				"element" : "#score",
				"container" : "#score",
				"title" : "Score your leads",
				"content" : "Assign lead scores for every contact to keep high quality leads swimming on top. <br/><br/> Use workflows to automate the process based on user behavior.<br/>",
				"placement" : "bottom", "el" : el, "backdrop" : true },
			{ "element" : "#widgets", "title" : "Widgets & Integrations",
				"content" : "Get more information about the contact from social media, helpdesk tickets, chats, and from billing systems.<br/>",
				"placement" : "left", "el" : el, "backdrop" : true, },
	];

	/**
	 * Calendar
	 */
	Agile_Tour["calendar"] = [
			{ "element" : "#calendar_event", "title" : "Calendar Events", "content" : "Events are time based such as meetings.<br/> They show up in calendar.<br/>",
				"placement" : "left",
				// "el": el,
				"backdrop" : true, },
			{ "element" : ".todo-block", "title" : "To Do Tasks",
				"content" : "Tasks are like to-dos. Result oriented.<br/><br/> You can assign a category such as call, email.<br/>", "placement" : "right",
				// "el": el,
				"backdrop" : true, },
			{ "element" : "#subscribe-ical", "title" : "Calendar Sync",
				"content" : "You can sync your Agile calendar with  Outlook, Google calendar or your mobile phone.<br/>", "placement" : "top",
				// "el": el,
				"backdrop" : true, },

	];

	Agile_Tour["workflows"] = [
			{
				"element" : "#learn-workflows",
				"title" : "Learn about Campaigns",
				"content" : "Our customers love campaign workflows. You would too!<br/><br/>  <p class='text-error'><strong>Take a few mins and learn more about campaigns.</strong></p>",
				"placement" : "left", "el" : el, "backdrop" : true, },
			{
				"element" : "#add-trigger",
				"title" : "Triggers",
				"content" : "Create conditions to trigger your campaigns automatically. <br/><br/> <strong>Eg:</strong> when a tag is added or when a contact reaches a score.<br/>",
				"placement" : "bottom", "el" : el, "backdrop" : true, }
	]
/*	Agile_Tour["workflows-add"] = [
		{ "element" : "#workflowform", "title" : "Visual Campaigns",
			"content" : "Create your campaigns and workflows visually.<br/> Just drag and drop the nodes. Connect them to the workflow.<br/>",
			"placement" : "top", "el" : el, "backdrop" : true, }
	]*/

}

var tour;

/**
 * gets the key and initializes the tour with steps from the JSON Object
 * 
 * @param key
 * @param el
 */
function start_tour(key, el)
{
	if((1 + 1) == 2)
		return;
	
	if (!key)
		key = Current_Route;

	console.log(tour);

	// If tour is defined and tour name is not equal to current route/key, then
	// tour should be ended
	if (tour && tour._options)
	{
		var step = tour._current;
		console.log(step);
		console.log(tour._options.name);
		console.log(key + "-tour");

		if (tour._options.name != key + "-tour")
		{
			tour.end();
			tour = undefined;
		}
		else
		{
			// if user hits a button in the page, it reloads. On reload, current
			// tour is stoped and reinitialized
			tour.end();
			tour.setCurrentStep(step);
			tour.start(true);
			return;
		}
	}

	tour = undefined;
	var tour_flag = false;

	if (!el)
	{
		if (tour_flag)
			return;

		// Initializes the tour and sets tour flag to ensure tour won't load
		// again
		initiate_tour(key, el);
		tour_flag = true;
	}

	// Tour should be initialized only after page is loaded
	$("body").on('agile_collection_loaded', 'body', function(event, element)
	{
		if (tour_flag)
			return;

		// Initializes the tour and sets tour flag to ensure tour won't load
		// again
		initiate_tour(key, element);
		tour_flag = true;
	});
}

/**
 * Initializes the tour with based fetched from JSON object defined. key can
 * either be sent explicitly or it takes them from current route
 * 
 * @param key
 * @param el
 */
function initiate_tour(key, el)
{
	// Reads cookie which is set in Homeservlet when new user is created
	var tour_status_cookie = readCookie("agile_tour");

	// If cookies is not preset it returns back
	if (!tour_status_cookie)
		return;

	// If is undefined the current route is assigned to tour
	if (!key)
	{
		if (!Current_Route)
			return;

		key = Current_Route;
	}

	// Parses cookie. It is parsed 2 times or it is returing string instead of
	// JSON object
	tour_status_cookie = JSON.parse(JSON.parse(tour_status_cookie));

	// Reads whether tour is ended on current route
	tourStatus = tour_status_cookie[key];

	// If tour is not there on current page then it is returned back
	if (!tourStatus)
		return;

	// If JSON Object is empty, then creates new JSON Object
	if ($.isEmptyObject(Agile_Tour))
		create_tour_steps(el);

	if (Agile_Tour[key])
		head.load(CSS_PATH+'css/bootstrap-tour.min.css', 'lib/bootstrap-tour-agile.min.js', function()
		{
			// Uses bootstrap tour
			tour = new Tour({ name : key + "-tour", debug : true, useLocalStorage : true, endOnLast : true, onEnd : function(tour)
			{

				// Remove from cookie on ending tour
				$("." + key + "-tour").remove();
				delete tour_status_cookie[key];

				if ($.isEmptyObject(tour_status_cookie))
				{
					eraseCookie("agile_tour");
					return;
				}

				/*
				 * Stringified it twice to maintain consistency with the cookie
				 * set from backend. Creates JSON with current step removed.
				 */
				createCookie("agile_tour", JSON.stringify(JSON.stringify(tour_status_cookie)));
			} });

			tour.addSteps(Agile_Tour[key]);

			// Set current step to first step
			tour.setCurrentStep(0);
			tour.start(true);

		})

}

/**
 * Creates a tour cookie and initializes tour on current page.
 */
function reinitialize_tour_on_current_route()
{

	console.log(tour);

	// Return of tour is already enabled on that route
	var tour_status_cookie = readCookie("agile_tour");
	var key = Current_Route;

	// If current view is contact details page we cannot initialize
	// tour based on route name, so we should be changing it to
	// "contact-details"
	if (Current_Route.indexOf("contact/") != -1)
		key = "contact-details";

	// If cookie exists, checks the state of tour in curent route.
	if (tour_status_cookie)
	{
		tour_status_cookie = JSON.parse(JSON.parse(tour_status_cookie));

		if (tour_status_cookie[key] == true)
			return;
		localStorage.removeItem(key + "-tour_current_step");
	}

	else
		tour_status_cookie = {};

	// Set tour back to true and save in cookie.
	tour_status_cookie[key] = true;

	console.log(JSON.stringify(tour_status_cookie));

	// Removes the current step from localstorage, it is set by bootstrap tour
	localStorage.removeItem(key + "-tour_current_step");

	// Creates a new tour cookie
	createCookie("agile_tour", JSON.stringify(JSON.stringify(tour_status_cookie)));

	// Initialize tour
	initiate_tour(key);
}

$(function()
{
	/**
	 * Selecting tour enables tour again.
	 */
	$('#agile-page-tour').click(function(e)
	{
		e.preventDefault();
		reinitialize_tour_on_current_route();
	});
});
$(function()
{
	// Collapses the menu on a mobile device
	// Without this, the user has to click the collapsible button to remove the menu
	$('.agile-menu > li').click(function(e){
	    
		console.log("Collapsing before ul");
		$nav_collapse = $(this).closest('.nav-collapse');
		console.log($nav_collapse.attr('class'));
		if($nav_collapse.hasClass('collapse'))
		{
			console.log("Collapsing");
			$nav_collapse.collapse('hide');
		}
	});

	// Scroll to top
	$(window).load(function() {
		$("#top").click(function () {
			$("body, html").animate({
				scrollTop: 0
			}, 300);
			return false;
		}); 
	});
});	

		/**
 * Loads scripts from url only if there are not active ajax requests. If there
 * are any active ajax requests, current function with all arguments will be
 * called after 5 seconds timeout
 * 
 * @param url
 * @param callback
 */
function load_urls_on_ajax_stop(url, callback) { 
	if (!isActive()) {
		setTimeout(function() {
			load_urls_on_ajax_stop(url, callback);
		}, 5000);
		return;
	}

	head.js(url, function() {
		if (callback && typeof callback == "function")
			callback();
	});

}

function loadMiscScriptsWithTimeOut() {
	if (loadMiscScripts) {
		// Load User voice then
		setTimeout(loadMiscScripts, 10000);
		return;
	}

	try {
		setTimeout(loadMiscScriptsWithTimeOut, 3000);
	} catch (err) {
		console.log(err);
	}

}

function loadMiscScripts() {

    // Load Google Analytics code
    load_analytics_code();

    // Load agile web stats
    load_urls_on_ajax_stop('stats/min/agile-min.js?_=' + _AGILE_VERSION, function(){

    		initialize_agile_domain_sync();
    		_agile_execute_web_rules();
    });

	// load_urls_on_ajax_stop('lib/user-voice.js');

	// load_clickdesk_code();

	// Clicky code
	/*load_urls_on_ajax_stop('//static.getclicky.com/js', function() {

		try {
			clicky.init(100729733);
		} catch (e) {

		}
	});*/

	/**
	 * Sets timeout for registering notifications.Waits for 2secs after page
	 * loads and calls downloadAndRegisterForNotifications function
	 */
	downloadAndRegisterForNotifications();
	
} 

/**
 * Clickdesk Widget
 */
/*
 * function load_clickdesk_code() { return;
 * 
 * if (CLICKDESK_CODE_LOADED) return;
 * 
 * console.log("loading clickdesk..");
 * 
 * CLICKDESK_CODE_LOADED = true;
 * 
 * load_urls_on_ajax_stop(glcpath + 'livechat-new.js', function(){
 * CLICKDESK_CODE_LOADED = true; }) }
 */

$(function() {
	setTimeout(loadMiscScriptsWithTimeOut, 10000);
})

/**
 * Checks if there are any active ajax requests
 * 
 * @returns {Boolean}
 */
function isActive() {
	if ($.active > 0)
		return false;
	return true;
}

/** Google analytics code **/
function load_analytics_code(){

	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	  ga('create', 'UA-44894190-1', 'auto');
	  ga('send', 'pageview');
}/**
 * Loads highcharts.js and highcharts-exporting.js plugins used to show graphs,
 * after loading graphs callback function sent is called i.e., actions to be
 * performed after loading plugin scripts
 * 
 * @param callback
 *            Function to be called after loading highcharts.js and
 *            exporting.js, it gives functionalities to
 */
function setupCharts(callback)
{

	head.js(LIB_PATH + 'lib/flot/highcharts-3.js', LIB_PATH + 'lib/flot/highcharts-exporting.js', LIB_PATH + 'lib/flot/funnel.js',LIB_PATH + 'lib/flot/highcharts-grid.js', function()
	{

		// Checks if callback is available, if available calls the callback
		if (callback && typeof (callback) === "function")
		{

			// Execute the callback
			callback();
		}
	});
}

/**
 * Sets pie chart with the data obtained by accessing url in the selector
 * element with given name as title of the chart.
 * 
 * @param url -
 *            to fetch json data inorder to render graph. 
 * @param selector -
 *            id or class of an element where charts render.
 * @param name - 
 *            title of the chart.
 */
function pie(url, selector, name)
{

	// Show loading
	// $('#' + selector).html(getRandomLoadingImg());

	var chart;
	setupCharts(function()
	{
		// Fetches data from to get tags informations
		// i.e., {"tags1" :" number of contacts with 'tags1', "tags2" : "number
		// of contacts with tags2"}
		fetchReportData(
						url,
						function(data)
						{
							// Convert into labels and data as required by
							// Highcharts
							var pieData = [];
							var total = 0;
							var count = 0;

							// Iterates through data and calculate total number
							$.each(data, function(k, v)
							{
								total += v;
								count ++;
							});

							console.log(data,total);
							// Iterates through data, gets each tag, count and
							// calculate
							// percentage of each tag
							$.each(data, function(k, v)
							{
								var item = [];

								
								// Push tag name in to array
								item.push(k);

								// Push percentage of current tag in to array
								item.push(v / total * 100);
								pieData.push(item);
							})
							console.log(pieData);
							var animation = count > 20 ? false : true;
							
							// Initializes Highcharts,
							chart = new Highcharts.Chart(
									{
										chart : { renderTo : selector, type : 'pie', plotBackgroundColor : null, plotBorderWidth : null, plotShadow : false,
											marginTop : 50 },
										colors: ['#7266ba','#23b7e5','#27c24c','#fad733','#f05050'],
										title : { text : name },
										tooltip : {
											backgroundColor : null,
											borderWidth : 0,
											borderRadius : 0,
											headerFormat : '',
											useHTML : true,
											enabled : true,
											shadow : false,
											formatter : function()
											{
												var s = '<div class="highcharts-tool-tip"><div class="tooltip-title" style="color:#333333!important;">' + this.point.name + '</div><div style="text-align:center;margin-top:7px;margin-left:-3px;color:#333333!important;"><b>' + (this.point.percentage)
														.toFixed(2) + '%<b></div></div>';
												return s;
											}, message : "Hover over chart slices<br>for more information.", positioner : function()
											{
												return { x : 15, y : 23 };
											}, },
										legend : { itemWidth : 75, },
										plotOptions : {
											pie : {
												 animation: animation,
												allowPointSelect : true,
												cursor : 'pointer',
												borderWidth : 0,
												dataLabels : { enabled : true, color : '#000000', connectorColor : '#000000', connectorWidth : 0,
													formatter : function()
													{
														return "";
														if (this.percentage <= 2)
															return "";
														return (this.percentage).toFixed(2) + ' %';
													}, distance : 2 }, showInLegend : false, innerSize : '60%', size : '90%', shadow : false, borderWidth : 0 },
											series : { events : { mouseOver : function()
											{
												$('.tooltip-default-message').hide();
											}, mouseOut : function(e)
											{
												$('.tooltip-default-message').show();
											} },
											borderWidth : 0 } },

										series : [
											{ type : 'pie', name : 'Tag', data : pieData, startAngle : 90 }
										], exporting : { enabled : false } }, function(chart)
									{ // on complete

										chart.renderer.image('img/donut-tooltip-frame.png', 14, 5, 200, 80).add();
										chart.renderer.text(this.options.tooltip.message, 50, 40).attr("class", 'tooltip-default-message').add();

									});
						});
	});
}

/**
 * Function to build either stacked graph or bar graph using highcharts. Inorder
 * to show bar graph, initialize stacked parameter as null.
 * <p>
 * Data of categories in the bar graph should be as follows: categories: ['Aug
 * 1', 'Aug 2', 'Aug 3', 'Aug 4', 'Aug 5']
 * </p>
 * 
 * <p>
 * Data of series in the bar graph should be as follows: series: [{ name: 'Email
 * Sent', data: [5, 3, 4, 7, 2] }, { name: 'Email Opened', data: [2, 2, 3, 2, 1] }, {
 * name: 'Email Clicked', data: [3, 4, 4, 2, 5] }, { name: 'Total Clicks', data:
 * [3, 4, 4, 2, 5] }]
 * </p>
 * 
 * @param url -
 *            to fetch json data inorder to render graph.
 * @param selector -
 *            id or class of an element where charts should render.
 * @param name -
 *            title of the chart.
 * @param yaxis_name -
 *            name for y-axis.
 * @param stacked -
 *            is stacked graph or bar graph? If bar graph, stacked is null.
 */
function showBar(url, selector, name, yaxis_name, stacked)
{
	var chart;

	// Shows loading image
	$('#' + selector).html(getRandomLoadingImg());

	// Builds graph with the obtained json data.
	setupCharts(function()
	{

		// Loads statistics details from backend
		fetchReportData(url, function(data)
		{

			// Names on X-axis
			var categories = [];

			// Data to map with X-axis and Y-axis.
			var series;

			// Iterates through data and add all keys as categories
			$.each(data, function(k, v)
			{
				categories.push(k);

				// Initializes series with names with the first
				// data point
				if (series == undefined)
				{
					var index = 0;
					series = [];
					$.each(v, function(k1, v1)
					{
						var series_data = {};
						series_data.name = k1;
						series_data.data = [];
						series[index++] = series_data;
					});
				}

				// Fill Data Values with series data
				$.each(v, function(k1, v1)
				{

					// Find series with the name k1 and to that,
					// push v1
					var series_data = find_series_with_name(series, k1);
					series_data.data.push(v1);
				});

			});

			// Draw the graph
			chart = new Highcharts.Chart({
			    chart: {
			        renderTo: selector,
			        type: 'column'
			    },
			   /* colors: [
			        '#4365AD',
			        '#D52A3E',
			        'gray',
			        '#1E995C'
			    ],*/
			    title: {
			        text: name
			    },
			    xAxis: {
			        categories: categories,
			        tickPositioner:function()
		            {
		                // to overcome x-axis labels overlapping
			        	if(this.options.categories.length > 30)
		                {
		                    this.options.minTickInterval = 5;
		                }
		            },
			        labels:
			        {
			        	overflow:'justify'
			        }
			    },
			    yAxis: {
			        min: 0,
			        title: {
			            text: yaxis_name
			        },
			        stackLabels: {
			            enabled: true,
			            style: {
			                fontWeight: 'bold',
			                color: (Highcharts.theme&&Highcharts.theme.textColor)||'gray'
			            }
			        }
			    },
			    legend: {
			        align: 'right',
			        x: -100,
			        verticalAlign: 'top',
			        y: 20,
			        floating: true,
			        backgroundColor: (Highcharts.theme&&Highcharts.theme.legendBackgroundColorSolid)||'white',
			        borderColor: '#CCC',
			        borderWidth: 1,
			        shadow: false
			    },
			    tooltip: {
			        formatter: function(){
			            return'<b>'+this.x+'</b><br/>'+this.series.name+': '+this.y;
			        }
			    },
			    plotOptions: {
			        column: {
			            stacking: stacked,
			            dataLabels: {
			                enabled: true,
			                color: (Highcharts.theme&&Highcharts.theme.dataLabelsColor)||'white'
			            }
			        }
			    },
			    series: series
			});
			});
	});
}

/**
 * Small utility function to search series with a given name. Returns series
 * with index if given name matches. It provides way to enter values within
 * the data array of given name.
 * 
 * @param series -
 *              chart series data.
 * @param name - 
 *              series name.
 */
function find_series_with_name(series, name)
{
	for ( var i = 0; i < series.length; i++)
	{
		if (series[i].name == name)
			return series[i];
	}
}

/**
 * Function to build deal's line chart to compare total value and pipeline value.
 * <p>
 * Data obtained to render deal's line chart will be:
 * [{closed-date:{total:value, pipeline: value},...]
 * </p>
 * 
 * @param url - 
 *            to fetch json data inorder to render graph.
 * @param selector - 
 *            id or class of an element where charts should render.
 * @param name - 
 *            title of the chart.
 * @param yaxis_name - 
 *            name for y-axis
 * @param show_loading
 * 				shows loading image
 */
function showLine(url, selector, name, yaxis_name, show_loading)
{
	
	// Show loading image if required
	if(typeof show_loading === 'undefined')
	{
		// Old calls were not showing loading image..
	}
	else
		$('#' + selector).html(getRandomLoadingImg());
	
	
	var chart;

	// Loads Highcharts plugin using setupCharts and sets up line chart in the
	// callback
	setupCharts(function()
	{
		if (reportDataRequest && reportDataRequest.readyState==1 && reportDataRequest.state()=="pending")
		{
			reportDataRequest.abort();
		}

		// Loads statistics details from backend i.e.,[{closed
		// date:{total:value, pipeline: value},...]
		fetchReportData(url, function(data)
		{

			// Categories are closed dates
			var categories = [];
			var tempcategories = [];
			var dataLength = 0;
			var min_tick_interval = 1;
			var frequency = $( "#frequency:visible").val();
			
			// Data with total and pipeline values
			var series;
			
			var sortedKeys = [];
			$.each(data,function(k,v){
				sortedKeys.push(k);
			});
			sortedKeys.sort();
			var sortedData = {};
			$.each(sortedKeys,function(index,value){
				sortedData[''+value] = data[''+value];
			});

			// Iterates through data and adds keys into
			// categories
			$.each(sortedData, function(k, v)
			{

				// Initializes series with names with the first
				// data point
				if (series == undefined)
				{
					var index = 0;
					series = [];
					$.each(v, function(k1, v1)
					{
						var series_data = {};
						series_data.name = k1;
						series_data.data = [];
						series[index++] = series_data;
					});
				}

				// Fill Data Values with series data
				$.each(v, function(k1, v1)
				{

					// Find series with the name k1 and to that,
					// push v1
					var series_data = find_series_with_name(series, k1);
					series_data.data.push(v1);
				});
				tempcategories.push(k*1000);
				dataLength++;

			});

			var cnt = 0;
			if(Math.ceil(dataLength/10)>0)
			{
				min_tick_interval = Math.ceil(dataLength/10);
				if(min_tick_interval==3)
				{
					min_tick_interval = 4;
				}
			}
			$.each(sortedData, function(k, v)
			{
				var dte = new Date(tempcategories[cnt]);
				if(frequency!=undefined)
				{
					if(frequency=="daily")
					{
						categories.push(Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()))+'');
					}
					else if(frequency=="weekly")
					{
						if(cnt!=dataLength-1)
						{
							var next_dte = new Date(tempcategories[cnt+1]);
							categories.push(Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()))+' - '+Highcharts.dateFormat('%e.%b', Date.UTC(next_dte.getUTCFullYear(), next_dte.getUTCMonth(), next_dte.getUTCDate()-1)));
						}
						else
						{
							var end_date = new Date(Date.parse($.trim($('#range').html().split("-")[1])).valueOf());
							categories.push(Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()))+' - '+Highcharts.dateFormat('%e.%b', Date.UTC(end_date.getFullYear(), end_date.getMonth(), end_date.getDate())));
						}
					}
					else if(frequency=="monthly")
					{
						if(cnt!=dataLength-1)
						{
							var next_dte = new Date(tempcategories[cnt+1]);
							var current_date = new Date();
							var from_date = '';
							var to_date = '';
							if(cnt!=0)
							{
								if(current_date.getUTCFullYear()!=dte.getUTCFullYear())
								{
									from_date = Highcharts.dateFormat('%b.%Y', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								}
								else
								{
									from_date = Highcharts.dateFormat('%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								
								}
								categories.push(from_date);
							}
							else
							{
								if(current_date.getUTCFullYear()!=dte.getUTCFullYear())
								{
									from_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								}
								else
								{
									from_date = Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								
								}
								if(current_date.getUTCFullYear()!=next_dte.getUTCFullYear())
								{
									to_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(next_dte.getUTCFullYear(), next_dte.getUTCMonth(), next_dte.getUTCDate()-1));
								}
								else
								{
									to_date = Highcharts.dateFormat('%e.%b', Date.UTC(next_dte.getUTCFullYear(), next_dte.getUTCMonth(), next_dte.getUTCDate()-1));
								}
								categories.push(from_date+' - '+to_date);
							}
						}
						else
						{
							var current_date = new Date();
							var from_date = '';
							var to_date = '';
							var end_date = new Date(Date.parse($.trim($('#range').html().split("-")[1])).valueOf());
							if(current_date.getUTCFullYear()!=dte.getUTCFullYear())
							{
								from_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								to_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(end_date.getFullYear(), end_date.getMonth(), end_date.getDate()));
							}
							else
							{
								from_date = Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								to_date = Highcharts.dateFormat('%e.%b', Date.UTC(end_date.getFullYear(), end_date.getMonth(), end_date.getDate()));
								
							}
							categories.push(from_date+' - '+to_date);
						}
					}
					cnt++;
				}

			});

			// After loading and processing all data, highcharts are initialized
			// setting preferences and data to show
			chart = new Highcharts.Chart({
			    chart: {
			        renderTo: selector,
			        type: 'line',
			        marginRight: 130,
			        marginBottom: 50
			    },
			    title: {
			        text: name,
			        x: -20//center
			    },
			    xAxis: {
			        /*type: 'datetime',
			        dateTimeLabelFormats: {
			            //don't display the dummy year  month: '%e.%b',
			            year: '%b',
			            month: '%e.%b \'%y',
			        },
			        minTickInterval: min_interval,
			        startOfWeek: startOfWeek*/
			        categories: categories,
			        tickmarkPlacement: 'on',
			        minTickInterval: min_tick_interval,
			        tickWidth: 1
			    },
			    yAxis: {
			        title: {
			            text: yaxis_name
			        },
			        plotLines: [
			            {
			                value: 0,
			                width: 1,
			                color: '#808080'
			            }
			        ],
			        min: 0
			    },
			    //Tooltip to show details,
			    /*ongraphtooltip: {
			        formatter: function(){
			            return'<b>'+this.series.name+'</b><br/>'+Highcharts.dateFormat('%e.%b',
			            this.x)+': '+this.y.toFixed(2);
			        }
			    },*/
			    legend: {
			        layout: 'vertical',
			        align: 'right',
			        verticalAlign: 'top',
			        x: -10,
			        y: 100,
			        borderWidth: 0
			    },
			    //Sets the series of data to be shown in the graph,shows total 
			    //and pipeline
			    series: series,
			    exporting: {
			        enabled: false
			    }
			});
		});
	});
}

/**
 * Function to show funnel bsed on the data
 * <p>
 * Shows funnel
 * </p>
 * 
 * @param url - 
 *            to fetch json data inorder to render graph.
 * @param selector - 
 *            id or class of an element where charts should render.
 * @param name - 
 *            title of the chart.
 * @param show_loading
 * 				shows loading image
 */
function showFunnel(url, selector, name, show_loading)
{
	// Show loading image if required
	if(typeof show_loading === 'undefined')
	{
		// Old calls were not showing loading image..
	}
	else
		$('#' + selector).html(getRandomLoadingImg());

	var chart;

	// Loads Highcharts plugin using setupCharts and sets up line chart in the
	// callback
	setupCharts(function()
	{

		// Loads statistics details from backend i.e.,[{closed
		// date:{total:value, pipeline: value},...]
		fetchReportData(url, function(data)
		{
			
			var funnel_data = [];
			
			$.each(data, function(i,v){
				
				// iterate through each data
				$.each(v, function(k1,v1){
					var each_data = [];
					each_data.push(k1, v1);
					funnel_data.push(each_data);
				});
				
			});
			
			console.log(funnel_data);
			
			chart = new Highcharts.Chart({
		        chart: {
		            type: 'funnel',
		            marginRight: 100,
		            renderTo: selector
		        },
		        title: {
		            text: name,
		            x: -50
		        },
		        plotOptions: {
		            series: {
		                dataLabels: {
		                    enabled: true,
		                    format: '<b>{point.name}</b> ({point.y:,.0f})',
		                    color: '#ccc',
		                    softConnector: true
		                },
		                neckWidth: '30%',
		                neckHeight: '25%',
		                
		                //-- Other available options
		                // height: pixels or percent
		                // width: pixels or percent
		                borderWidth: 0
		            }
		        },
		        legend: {
		            enabled: false
		        },
		        series: [{
		            name: 'Contacts',
		            data: funnel_data
		        }]
		    });
			
		});
	});
}


/**
 * Function to build Cohorts
 * <p>
 * The data is not manipulated and the server sends it the required format. We do not use showBar code to decode as some of the data in the cohorts are not sent back 
 * </p>
 * 
 * @param url - 
 *            to fetch json data inorder to render graph.
 * @param selector - 
 *            id or class of an element where charts should render.
 * @param name - 
 *            title of the chart.
 * @param yaxis_name - 
 *            name for y-axis
 * @param show_loading
 * 				shows loading image
 */
function showCohorts(url, selector, name, yaxis_name, show_loading)
{
	
	// Show loading image if required
	if(typeof show_loading === 'undefined')
	{
		// Old calls were not showing loading image..
	}
	else
		$('#' + selector).html(getRandomLoadingImg());
	
	
	var chart;

	// Loads Highcharts plugin using setupCharts and sets up line chart in the
	// callback
	setupCharts(function()
	{

		// Loads statistics details from backend i.e.,[{closed
		// date:{total:value, pipeline: value},...]
		fetchReportData(url, function(data)
		{

			// Categories are closed dates
			var categories = data.categories;
			
			// Data with total and pipeline values
			var series = data.series;

			// After loading and processing all data, highcharts are initialized
			// setting preferences and data to show
			chart = new Highcharts.Chart({
			    chart: {
			        renderTo: selector,
			        type: 'line',
			        marginRight: 130,
			        marginBottom: 25,
			        zoomType: 'x'
			    },
			    title: {
			        text: name,
			        x: -20//center
			    },
			    xAxis: {
			       categories: categories,
			       tickmarkPlacement: 'on'
			    },
			    yAxis: {
			        title: {
			            text: yaxis_name
			        },
			        plotLines: [
			            {
			                value: 0,
			                width: 1,
			                color: '#808080'
			            }
			        ],
			        min: 0
			    },
			    //Tooltip to show details,
			    ongraphtooltip: {
			        formatter: function(){
			            return'<b>'+this.series.name+'</b><br/>'+Highcharts.dateFormat('%e.%b',
			            this.x)+': '+this.y.toFixed(2);
			        }
			    },
			    legend: {
			        layout: 'vertical',
			        align: 'right',
			        verticalAlign: 'top',
			        x: -10,
			        y: 100,
			        borderWidth: 0
			    },
			    //Sets the series of data to be shown in the graph,shows total 
			    //and pipeline
			    series: series,
			    exporting: {
			        enabled: false
			    }
			});
		});
	});
}


/**
 * Shows Pie chart for tags of contacts,
 */
function pieTags(el, force_reload)
{
	var url = '/core/api/tags/stats';
	if(force_reload)
		url = url + '?reload=true';
	
	$("#pie-tags-chart", el).html(getRandomLoadingImg());
	
	pie(url, 'pie-tags-chart', '');
}

/**
 * Shows pie chart of milestones using high charts, called from deals controller
 * when deals collection is loaded.
 */
function pieMilestones()
{
	pie('/core/api/opportunity/stats/milestones?min=0&max=1543842319', 'pie-deals-chart', '');
}

/**
 * Shows pie chart of milestones using high charts, called from deals controller
 * when deals collection is loaded.
 */
function pieMilestonesByPipeline(pipeline_id)
{
	pie('/core/api/opportunity/stats/milestones/'+pipeline_id+'?min=0&max=1543842319', 'pie-deals-chart', '');
}

/**
 * Shows pie chart of tasks split by Type
 * @param params - params e.g. owner=<owner-id>, directly sent with url as GET request
 */
function pieTasks(params)
{
	pie('core/api/tasks/stats'+params,'pie-tasks-chart','');
}

/**
 * Shows line chart for deal statistics. Compares deal totals and pipeline with respect to 
 * time
 */
function dealsLineChart()
{
	showDealAreaSpline('core/api/opportunity/stats/details?min=0&max=1543842319', 'total-pipeline-chart', 'Monthly Deals', 'Total Value');
}

/**
 * Shows line chart for deal statistics. Compares deal totals and pipeline with respect to 
 * time
 */
function dealsLineChartByPipeline(pipeline_id)
{
	showDealAreaSpline('core/api/opportunity/stats/details/'+pipeline_id+'?min=0&max=1543842319', 'total-pipeline-chart', 'Monthly Revenue - All Deals', 'Total Value');
}

/**
 * Generic function to fetch data for graphs and act accordingly on plan limit error
 * @param url
 * @param successCallback
 */
 var reportDataRequest;
function fetchReportData(url, successCallback)
{
	// Hides error message
	$("#plan-limit-error").hide();
	
	// Fetches data
	reportDataRequest = $.getJSON(url, function(data)
			{	
				// Sends data to callback
				if(successCallback && typeof (successCallback) === "function")
					successCallback(data);
			}).error(function(response){
				
				// If error is not billing exception then it is returned
				if(response.status != 406)
					return;
				
				// If it is billing exception, then empty set is sent so page will not be showing loading on error message
				if(successCallback && typeof (successCallback) === "function")
					successCallback([]);
				
				// Show cause of error in saving
				$save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'
						+ response.responseText
						+ '</i></p></small></div>');
				
				$("#plan-limit-error").html($save_info).show();
			});
}
/**
 * Function to build deal's line chart to compare total value and pipeline value.
 * <p>
 * Data obtained to render deal's line chart will be:
 * [{closed-date:{total:value, pipeline: value},...]
 * </p>
 * 
 * @param url - 
 *            to fetch json data inorder to render graph.
 * @param selector - 
 *            id or class of an element where charts should render.
 * @param name - 
 *            title of the chart.
 * @param yaxis_name - 
 *            name for y-axis
 * @param show_loading
 * 				shows loading image
 */
function showAreaSpline(url, selector, name, yaxis_name, show_loading)
{
	
	// Show loading image if required
	if(typeof show_loading === 'undefined')
	{
		// Old calls were not showing loading image..
	}
	else
		$('#' + selector).html(getRandomLoadingImg());
	
	
	var chart;

	// Loads Highcharts plugin using setupCharts and sets up line chart in the
	// callback
	setupCharts(function()
	{
		if (reportDataRequest && reportDataRequest.readyState==1 && reportDataRequest.state()=="pending")
		{
			reportDataRequest.abort();
		}

		// Loads statistics details from backend i.e.,[{closed
		// date:{total:value, pipeline: value},...]
		fetchReportData(url, function(data)
		{

			// Categories are closed dates
			var categories = [];
			var tempcategories = [];
			var dataLength = 0;
			var min_tick_interval = 1;
			var frequency = $( "#frequency:visible").val();
			
			// Data with total and pipeline values
			var series;
			
			var sortedKeys = [];
			$.each(data,function(k,v){
				sortedKeys.push(k);
			});
			sortedKeys.sort();
			var sortedData = {};
			$.each(sortedKeys,function(index,value){
				sortedData[''+value] = data[''+value];
			});

			// Iterates through data and adds keys into
			// categories
			$.each(sortedData, function(k, v)
			{

				// Initializes series with names with the first
				// data point
				if (series == undefined)
				{
					var index = 0;
					series = [];
					$.each(v, function(k1, v1)
					{
						var series_data = {};
						series_data.name = k1;
						series_data.data = [];
						series[index++] = series_data;
					});
				}

				// Fill Data Values with series data
				$.each(v, function(k1, v1)
				{

					// Find series with the name k1 and to that,
					// push v1
					var series_data = find_series_with_name(series, k1);
					series_data.data.push(v1);
				});
				tempcategories.push(k*1000);
				dataLength++;

			});

			var cnt = 0;
			if(Math.ceil(dataLength/10)>0)
			{
				min_tick_interval = Math.ceil(dataLength/10);
				if(min_tick_interval==3)
				{
					min_tick_interval = 4;
				}
			}
			$.each(sortedData, function(k, v)
			{
				var dte = new Date(tempcategories[cnt]);
				if(frequency!=undefined)
				{
					if(frequency=="daily")
					{
						categories.push(Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()))+'');
					}
					else if(frequency=="weekly")
					{
						if(cnt!=dataLength-1)
						{
							var next_dte = new Date(tempcategories[cnt+1]);
							categories.push(Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()))+' - '+Highcharts.dateFormat('%e.%b', Date.UTC(next_dte.getUTCFullYear(), next_dte.getUTCMonth(), next_dte.getUTCDate()-1)));
						}
						else
						{
							var end_date = new Date(Date.parse($.trim($('#range').html().split("-")[1])).valueOf());
							categories.push(Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()))+' - '+Highcharts.dateFormat('%e.%b', Date.UTC(end_date.getFullYear(), end_date.getMonth(), end_date.getDate())));
						}
					}
					else if(frequency=="monthly")
					{
						if(cnt!=dataLength-1)
						{
							var next_dte = new Date(tempcategories[cnt+1]);
							var current_date = new Date();
							var from_date = '';
							var to_date = '';
							if(cnt!=0)
							{
								if(current_date.getUTCFullYear()!=dte.getUTCFullYear())
								{
									from_date = Highcharts.dateFormat('%b.%Y', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								}
								else
								{
									from_date = Highcharts.dateFormat('%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								
								}
								categories.push(from_date);
							}
							else
							{
								if(current_date.getUTCFullYear()!=dte.getUTCFullYear())
								{
									from_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								}
								else
								{
									from_date = Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								
								}
								if(current_date.getUTCFullYear()!=next_dte.getUTCFullYear())
								{
									to_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(next_dte.getUTCFullYear(), next_dte.getUTCMonth(), next_dte.getUTCDate()-1));
								}
								else
								{
									to_date = Highcharts.dateFormat('%e.%b', Date.UTC(next_dte.getUTCFullYear(), next_dte.getUTCMonth(), next_dte.getUTCDate()-1));
								}
								categories.push(from_date+' - '+to_date);
							}
						}
						else
						{
							var current_date = new Date();
							var from_date = '';
							var to_date = '';
							var end_date = new Date(Date.parse($.trim($('#range').html().split("-")[1])).valueOf());
							if(current_date.getUTCFullYear()!=dte.getUTCFullYear())
							{
								from_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								to_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(end_date.getFullYear(), end_date.getMonth(), end_date.getDate()));
							}
							else
							{
								from_date = Highcharts.dateFormat('%e.%b', Date.UTC(dte.getUTCFullYear(), dte.getUTCMonth(), dte.getUTCDate()));
								to_date = Highcharts.dateFormat('%e.%b', Date.UTC(end_date.getFullYear(), end_date.getMonth(), end_date.getDate()));
								
							}
							categories.push(from_date+' - '+to_date);
						}
					}
					cnt++;
				}

			});

			// After loading and processing all data, highcharts are initialized
			// setting preferences and data to show
			chart = new Highcharts.Chart({
			    chart: {
			        renderTo: selector,
			        type: 'areaspline',
			        marginRight: 130,
			        marginBottom: 50
			    },
			    title: {
			        text: name,
			        x: -20//center
			    },
			    xAxis: {
			        /*type: 'datetime',
			        dateTimeLabelFormats: {
			            //don't display the dummy year  month: '%e.%b',
			            year: '%b',
			            month: '%e.%b \'%y',
			        },
			        minTickInterval: min_interval,
			        startOfWeek: startOfWeek*/
			        categories: categories,
			        tickmarkPlacement: 'on',
			        minTickInterval: min_tick_interval,
			        tickWidth: 1
			    },
			    yAxis: {
			        title: {
			            text: yaxis_name
			        },
			        plotLines: [
			            {
			                value: 0,
			                width: 1,
			                color: '#808080'
			            }
			        ],
			        min: 0
			    },
			    //Tooltip to show details,
			    /*ongraphtooltip: {
			        formatter: function(){
			            return'<b>'+this.series.name+'</b><br/>'+Highcharts.dateFormat('%e.%b',
			            this.x)+': '+this.y.toFixed(2);
			        }
			    },*/
			    legend: {
			        layout: 'vertical',
			        align: 'right',
			        verticalAlign: 'top',
			        x: -10,
			        y: 100,
			        borderWidth: 0
			    },
			    //Sets the series of data to be shown in the graph,shows total 
			    //and pipeline
			    series: series,
			    exporting: {
			        enabled: false
			    }
			});
		});
	});
}
/**
 * Function to build deal's line chart to compare total value and pipeline value.
 * <p>
 * Data obtained to render deal's line chart will be:
 * [{closed-date:{total:value, pipeline: value},...]
 * </p>
 * 
 * @param url - 
 *            to fetch json data inorder to render graph.
 * @param selector - 
 *            id or class of an element where charts should render.
 * @param name - 
 *            title of the chart.
 * @param yaxis_name - 
 *            name for y-axis
 * @param show_loading
 * 				shows loading image
 */
function showDealAreaSpline(url, selector, name, yaxis_name, show_loading)
{
	
	// Show loading image if required
	if(typeof show_loading === 'undefined')
	{
		// Old calls were not showing loading image..
	}
	else
		$('#' + selector).html(getRandomLoadingImg());
	
	
	var chart;

	// Loads Highcharts plugin using setupCharts and sets up line chart in the
	// callback
	setupCharts(function()
	{

		// Loads statistics details from backend i.e.,[{closed
		// date:{total:value, pipeline: value},...]
		fetchReportData(url, function(data)
		{

			// Categories are closed dates
			var categories = [];
			
			// Data with total and pipeline values
			var series;
			
			var sortedKeys = [];
			$.each(data,function(k,v){
				sortedKeys.push(k);
			});
			sortedKeys.sort();
			var sortedData = {};
			$.each(sortedKeys,function(index,value){
				sortedData[''+value] = data[''+value];
			});

			var min_tick_interval = 1;
			var dataLength = 0;
			// Iterates through data and adds keys into
			// categories
			$.each(sortedData, function(k, v)
			{

				// Initializes series with names with the first
				// data point
				if (series == undefined)
				{
					var index = 0;
					series = [];
					$.each(v, function(k1, v1)
					{
						var series_data = {};
						series_data.name = k1;
						series_data.data = [];
						series[index++] = series_data;
					});
				}

				// Fill Data Values with series data
				$.each(v, function(k1, v1)
				{

					// Find series with the name k1 and to that,
					// push v1
					var series_data = find_series_with_name(series, k1);
					series_data.data.push(v1);
				});
				var dt = new Date(k * 1000);
				categories.push(Highcharts.dateFormat('%b.%Y',Date.UTC(dt.getFullYear(), dt.getMonth(), dt.getDate()))+'');
				dataLength++;
			});

			if(Math.ceil((dataLength-1)/10)>0)
			{
				min_tick_interval = Math.ceil(dataLength/10);
				if(min_tick_interval==3)
				{
					min_tick_interval = 4;
				}
			}

			// After loading and processing all data, highcharts are initialized
			// setting preferences and data to show
			chart = new Highcharts.Chart({
			    chart: {
			        renderTo: selector,
			        type: 'areaspline',
			        marginRight: 130,
			        marginBottom: 25
			    },
			    title: {
			        text: name,
			        x: -20,//center
			        style : {
						textTransform : 'normal'
					}
			    },
			    xAxis: {
			        //type: 'datetime',
			        /*dateTimeLabelFormats: {
			            //don't display the dummy year  month: '%e.%b',
			            year: '%b'
			        },*/
			        //minTickInterval: 24 * 3600 * 1000
			        categories: categories,
			        tickmarkPlacement: 'on',
			        minTickInterval : min_tick_interval
			    },
			    yAxis: {
			        title: {
			            text: yaxis_name
			        },
			        plotLines: [
			            {
			                value: 0,
			                width: 1,
			                color: '#808080'
			            }
			        ],
			        min: 0
			    },
			    //Tooltip to show details,
			    tooltip: {
	    			formatter: function(){
		        		return '<div>' + 
		        		        '<div class="p-n">'+this.x+'</div>' + 
		        		        '<div class="p-n"><font color='+this.series.color+'>'+this.series.name+'</font> : '+getCurrencySymbolForCharts()+''+getNumberWithCommasForCharts(this.y)+'</div>' +
		        		        '</div>';
		        	},
		        	useHTML: true
	        	},
			    legend: {
			        layout: 'vertical',
			        align: 'right',
			        verticalAlign: 'top',
			        x: -10,
			        y: 100,
			        borderWidth: 0
			    },
			    //Sets the series of data to be shown in the graph,shows total 
			    //and pipeline
			    series: series,
			    exporting: {
			        enabled: false
			    }
			});
		});
	});
}
function getCurrencySymbolForCharts(){
	var value = ((CURRENT_USER_PREFS.currency != null) ? CURRENT_USER_PREFS.currency : "USD-$");
	var symbol = ((value.length < 4) ? "$" : value.substring(4, value.length));
	return symbol;
}
function getNumberWithCommasForCharts(value){
	value = parseFloat(value);
	value = Math.round(value);
	if(value==0)
		return value;

	if (value)
		return value.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g, ",").replace('.00', '');
}
function showDealsGrowthgraph(url, selector, name, yaxis_name, show_loading)
{
    
    // Show loading image if required
    if(typeof show_loading === 'undefined')
    {
        // Old calls were not showing loading image..
    }
    else
        $('#' + selector).html(getRandomLoadingImg());
    
    
    var chart;

    // Loads Highcharts plugin using setupCharts and sets up line chart in the
    // callback
    setupCharts(function()
    {

        // Loads statistics details from backend 
        fetchReportData(url, function(data)
        {

            // Categories are created time
            var categories = [];
            var tempcategories=[];
            var type = $( "#type:visible").val();
            var frequency= $("#frequency:visible").val();
            // Data with deals
            var series;
            var AllData=[];
            var sortedKeys = [];
            $.each(data,function(k,v){
                sortedKeys.push(k);
            });
            sortedKeys.sort();
            var sortedData = {};
            $.each(sortedKeys,function(index,value){
                sortedData[''+value] = data[''+value];
            });

            var min_tick_interval = 1;
            var dataLength = 0;
            // Iterates through data and adds keys into
            // categories
            $.each(sortedData, function(k, v)
            {
            	var totalData=[];
            	totalData.push(k);
            	var total=0;
                // Initializes series with names with the first
                // data point
                if (series == undefined)
                {
                    var index = 0;
                    series = []; 
                    $.each(v, function(k1, v1)
                    {
                    	
                        var series_data = {};
                        series_data.name = k1;
                        series_data.data = [];
                        series[index++] = series_data;
                        //totalData.push(total);
                    });
                
                }


                // Fill Data Values with series data
                $.each(v, function(k1, v1)
                {
                	total=total+v1;
                    // Find series with the name k1 and to that,
                    // push v1
                    var series_data = find_series_with_name(series, k1);
                    series_data.data.push(v1);
                });
                     totalData.push(total);
                tempcategories.push(k*1000);
				dataLength++;
				AllData.push(totalData);
			});
				
				var cnt=0;
				$.each(sortedData, function(k, v)
			{
                var dt = new Date(k * 1000);
                var dte = new Date(tempcategories[cnt]);
                if(frequency=="daily")
					{
						categories.push(Highcharts.dateFormat('%e.%b',Date.UTC(dte.getFullYear(), dte.getMonth(), dte.getDate()))+'');
					}
				else if(frequency=="weekly")
					{
						if(cnt!=dataLength-1)
						{
							var next_dte = new Date(tempcategories[cnt+1]);
							categories.push(Highcharts.dateFormat('%e.%b', Date.UTC(dte.getFullYear(), dte.getMonth(), dte.getDate()))+' - '+Highcharts.dateFormat('%e.%b', Date.UTC(next_dte.getFullYear(), next_dte.getMonth(), next_dte.getDate()-1)));
						}
						else
						{
							var end_date = new Date(Date.parse($.trim($('#range').html().split("-")[1])).valueOf());
							categories.push(Highcharts.dateFormat('%e.%b', Date.UTC(dte.getFullYear(), dte.getMonth(), dte.getDate()))+' - '+Highcharts.dateFormat('%e.%b', Date.UTC(end_date.getFullYear(), end_date.getMonth(), end_date.getDate())));
						}
					}
				else if(frequency=="monthly")
					{
						if(cnt!=dataLength-1)
						{
							var next_dte = new Date(tempcategories[cnt+1]);
							var current_date = new Date();
							var from_date = '';
							var to_date = '';
							if(cnt!=0)
							{
								if(current_date.getFullYear()!=dte.getFullYear())
								{
									from_date = Highcharts.dateFormat('%b.%Y', Date.UTC(dte.getFullYear(), dte.getMonth(), dte.getDate()));
								}
								else
								{
									from_date = Highcharts.dateFormat('%b', Date.UTC(dte.getFullYear(), dte.getMonth(), dte.getDate()));
								
								}
							
								categories.push(from_date);
							}
							else
							{
								var start_date=new Date(Date.parse($.trim($('#range').html().split("-")[0])).valueOf());
								if(current_date.getFullYear()!=dte.getFullYear())
								{
									from_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(start_date.getFullYear(), start_date.getMonth(), start_date.getDate()));
								}
								else
								{
									from_date = Highcharts.dateFormat('%e.%b', Date.UTC(start_date.getFullYear(), start_date.getMonth(), start_date.getDate()));
								
								}
								//if(current_date.getFullYear()!=next_dte.getFullYear())
								
									to_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(next_dte.getFullYear(), next_dte.getMonth(), next_dte.getDate()-1));
								
								categories.push(from_date+' - '+to_date);
							}
						}
						else
						{
							var current_date = new Date();
							var from_date ='';
							var start_date=new Date(Date.parse($.trim($('#range').html().split("-")[0])).valueOf());
							var to_date = '';
							var end_date = new Date(Date.parse($.trim($('#range').html().split("-")[1])).valueOf());
							if(current_date.getFullYear()!=dte.getFullYear())
							{
								if(cnt==0)
									from_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(start_date.getFullYear(), start_date.getMonth(), start_date.getDate()));
								else
									from_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(dte.getFullYear(), dte.getMonth(), dte.getDate()));
							
								to_date = Highcharts.dateFormat('%e.%b.%Y', Date.UTC(end_date.getFullYear(), end_date.getMonth(), end_date.getDate()));
							}
							else
							{
								if(cnt==0)
								  from_date = Highcharts.dateFormat('%e.%b', Date.UTC(start_date.getFullYear(), start_date.getMonth(), start_date.getDate()));
								else
									from_date = Highcharts.dateFormat('%e.%b', Date.UTC(dte.getFullYear(), dte.getMonth(), dte.getDate()));
								
								to_date = Highcharts.dateFormat('%e.%b', Date.UTC(end_date.getFullYear(), end_date.getMonth(), end_date.getDate()));
								
							}
							categories.push(from_date+' - '+to_date);
						}
					}
                 cnt++;
            });

            if(Math.ceil((dataLength-1)/10)>0)
            {
                min_tick_interval = Math.ceil(dataLength/10);
                if(min_tick_interval==3)
                {
                    min_tick_interval = 4;
                }
            }
            if(series==undefined)
            	 chartRenderforIncoming(selector,categories,name,yaxis_name,min_tick_interval,type,series,AllData);
            else
            {
            $.ajax({ type : 'GET', url : '/core/api/categories?entity_type=DEAL_SOURCE', dataType : 'json',
            success: function(data){
                $.each(data,function(index,deals){
                    for(var i=0;i<series.length;i++){
                        if(series[i].name=="0")
                                series[i].name="Unknown";
                        else if(deals.id==series[i].name){
                            series[i].name=deals.label;
                        }
                            
                    }
                });
                chartRenderforIncoming(selector,categories,name,yaxis_name,min_tick_interval,type,series,AllData);
                } 
            });
        	}


            // After loading and processing all data, highcharts are initialized
            // setting preferences and data to show
            
        });
    });
}

function chartRenderforIncoming(selector,categories,name,yaxis_name,min_tick_interval,type,series,AllData){
	chart = new Highcharts.Chart({
                chart: {
                    renderTo: selector,
                    type: 'area',
                    marginRight: 130,
                    marginBottom: 50
                },
                colors: ['#7266ba','#23b7e5','#27c24c','#fad733','#f05050','#6E6658','#611680','#167F80','#801634','#D3E6C7'],
                title: {
                    text: name,
                    x: -20,//center
                    style : {
                        textTransform : 'normal'
                    }
                },
                xAxis: {
                    categories: categories,
                    tickmarkPlacement: 'on',
                    minTickInterval : min_tick_interval
                },
                yAxis: {
                    title: {
                        text: yaxis_name
                    },
                    plotLines: [
                        {
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }
                    ],
                    min: 0
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'top',
                    x: -10,
                    y: 100,
                    borderWidth: 0
                },
                 plotOptions: {
                    area: {
                stacking: 'normal',
                lineColor: '#666666',
                lineWidth: 1,
                marker: {
                    lineWidth: 1,
                    lineColor: '#666666',
                    fillColor: null
                  }
                 }
                  },
                //Tooltip to show details,
                tooltip: {
                    formatter: function(){
                        if(type=="deals")
                                {
                        return '<div>' + 
                                '<div class="p-n">'+this.x+'</div>' + 
                                '<div class="p-n"><font color='+this.series.color+'>'+this.series.name+'</font> : '+getNumberWithCommasForCharts(this.y)+'</div>' +
                                '</div>'+
                                '<div class="p-n">Total : '+getNumberWithCommasForCharts(AllData[this.point.x][1])+'</div>';
                            }
                        else
                        {
                        return '<div>' + 
                                '<div class="p-n">'+this.x+'</div>' + 
                                '<div class="p-n"><font color='+this.series.color+'>'+this.series.name+'</font> : '+getCurrencySymbolForCharts()+''+getNumberWithCommasForCharts(this.y)+'</div>' +
                                '</div>'+
                                 '<div class="p-n">Total : '+getCurrencySymbolForCharts()+''+getNumberWithCommasForCharts(AllData[this.point.x][1])+'</div>';;
                            }
                    },
                    useHTML: true
                },
               
                //Sets the series of data to be shown in the graph,shows total 
                //and pipeline
                series: series,
                exporting: {
                    enabled: false
                }
            });
}$(function(){
	
   $("#choose-avatar-modal").on('click', 'table td a', function(e) {
	
			e.preventDefault();
	
			var modalId = $(this).closest('.modal').attr("id");
	
			var source = $(this).find("img").attr("src");
	
			$(this).closest(".modal-body").find("input[type='hidden']").val(source);
	
			$(this).closest('.modal').modal('hide');
			$(this).trigger('choose-image')
	});
	
	$("#choose-avatar-modal").on('choose-image', 'table td a', function(e) {
	
			var selectedSource = $(this).closest('tbody').find("input[type='hidden']").val();
			
			if(selectedSource)
			{
				$("input[name='custom_image']").val(selectedSource);
				
				setImageURL(selectedSource);
				
				/*var modalId = $(this).attr("id");
				$("a[href='#" + modalId + "']").find("img").attr('src', selectedSource);*/
				//$(".preview-avatar").attr("src", selectedSource);
			}
	});
	$("#content").on('choose-image', '#choose-avatar-test', function(e) {
		$("#choose-avatar-modal").closest('.modal').modal('hide');
		var selectedSource = $(this).find('tbody').find("input[type='hidden']").val();
		
		if(selectedSource)
		{
			$("input[name='custom_image']").val(selectedSource);
			
			setImageURL(selectedSource);
			
			/*var modalId = $(this).attr("id");
			$("a[href='#" + modalId + "']").find("img").attr('src', selectedSource);*/
			//$(".preview-avatar").attr("src", selectedSource);
		}
});
	
	$('#choose-avatar-modal').on('show.bs.modal',function (e) {
		$('#choose-avatar-modal').html($('#choose-avatar-test').html());
	});

})

// selects default avatars randomly
function choose_random_avatar()
{
	var avatar = ["https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/86.png",
	              "https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/72.png",
	              "https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/17.png",
	              "https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/5.png",
	              "https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/3.png"];

	var random = Math.floor((Math.random() * avatar.length));

	return avatar[random];
}
$("body").on('click', '.agent-popup-alert-dismiss', function(event)
{
	createCookie('CHORME_EXTENSION_DOWNLOAD', false);
	$("#chrome_extension").remove();
});

/**
 * Chrome extension id
 */
/*
 * var Chrome_Extension_Id = "eofoblinhpjfhkjlfckmeidagfogclib";
 * 
 *//**
	 * Chrome extension resource path to detect extension
	 */
/*
 * var Chrome_Extension_Accesible_Resource = "/js/xhr_override.js";
 * 
 *//**
	 * Chrome extension webstore url
	 */
/*
 * var Chrome_Extension_Webstore_Url =
 * "https://chrome.google.com/webstore/detail/" + Chrome_Extension_Id;
 * 
 *//**
	 * Detect chrome extension on load
	 */

/*
 * $(function() { console.log("**chrome extension**");
 * 
 * var chrome = window.chrome || {}; console.log("chrome: " + chrome); // Check
 * chrome browser if (!chrome.app || !chrome.webstore) { console.log("***Its not
 * chrome***") return false; } else { // Check forincognito mode var fs =
 * window.RequestFileSystem || window.webkitRequestFileSystem; if (!fs) {
 * console.log("check failed?"); return false; } else { fs(window.TEMPORARY,
 * 100, function(fs) { console.log("it does not seem like you are in incognito
 * mode"); // After clicking on logout, erase cookie to show notification //
 * after // // re-login about chrome extension if not install.
 * $('a').click(function(event) { var herfLogout = $(this).attr("href"); if
 * (herfLogout == "/login") { // erasefield
 * 
 * eraseCookie("agile_chrome_extension"); } });
 * 
 * console.log("readCookie: " + readCookie("agile_chrome_extension") + " " +
 * readCookie("prevent_extension_request")); // Read cookie to notify once per
 * session if (readCookie("agile_chrome_extension") ||
 * readCookie("prevent_extension_request")) { console.log("return now"); return; } //
 * Detect extension Detect_Chrome_Extension(Toggle_Extension_Request_Ui); },
 * function(err) { console.log("it seems like you are in incognito mode");
 * return false; }); } } });
 * 
 *//**
	 * Detect chrome extension by chechking element added in page from extension
	 */
/*
 * 
 * function Detect_Chrome_Extension(callback) { console.log("In
 * Detect_Chrome_Extension");
 * 
 * if (document.getElementById('agilecrm_extension')) { console.log("crome
 * extension installed."); if (callback) callback(true); } else {
 * console.log("crome extension is not installed."); // Create visit type cookie
 * to notify once per session // createCookie("agile_chrome_extension",
 * "notified");
 * 
 * if (callback) callback(false);
 * 
 * Initialize_Chrome_Webstore_events(); } }
 * 
 *//**
	 * Toggle extension installer UI
	 * 
	 * @param hide
	 */
/*
 * 
 * function Toggle_Extension_Request_Ui(hide) { console.log("in
 * Toggle_Extension_Request_Ui:" + hide);
 * 
 * if ($("#chrome_extension").length >= 1) { $("#chrome_extension").remove(); //
 * toggle_navbar_position("slide_up"); } // true, extension installed if (hide)
 * return;
 * 
 * $("body").append(getTemplate("chrome-extension", {})); //
 * toggle_navbar_position("slide_down"); }
 * 
 * function toggle_navbar_position(positionToChange) {
 * console.log("intoggle_navbar_position: " + positionToChange);
 * 
 * if (positionToChange == "slide_up")
 * $(".navbar-fixed-top").removeClass("navbar-slide-down"); else if
 * (positionToChange == "slide_down")
 * $(".navbar-fixed-top").addClass("navbar-slide-down"); }
 */

/**
 * Initilaize webstore events to install the extension
 */
/*
 * function Initialize_Chrome_Webstore_events() {
 * 
 * console.log("in Initialize_Chrome_Webstore_events");
 * 
 *//**
	 * To dismiss chrome extension popup
	 *//*
	$('#chrome_extension #dismiss').live('click', function(e)
	{
		e.stopPropagation();

		// To prevent notify user permanantly
		createCookie("prevent_extension_request", "true");

		Toggle_Extension_Request_Ui(true);
	});

	*//**
	 * To prevent notify user on each session
	 *//*
	$("#chrome_extension #prevent_extension_request").live('click', function()
	{

		// To prevent notify user permanantly
		createCookie("prevent_extension_request", "true");

		Toggle_Extension_Request_Ui(true);
	});

	*//**
	 * Install extension
	 *//*
	$('#chrome_extension #chrome_install_button').live('click', function(e)
	{

		e.stopPropagation();

		var $this = $(this);

		Toggle_Extension_Loader("inline");

		try
		{
			chrome.webstore.install(Chrome_Extension_Webstore_Url, function(success)
			{

				console.log(success);
				Toggle_Extension_Request_Ui(true);

			}, function(error)
			{
				console.log(error);
				Toggle_Extension_Loader("none");
				//OpenInNewTab();
			});
		}
		catch (e)
		{
			console.log(e);
			Toggle_Extension_Loader("none");
			//OpenInNewTab();
		}
		return false;
	});
}

*//**
 * Toggle loader image
 * 
 * e.stopPropagation();
 * 
 * var $this = $(this);
 * 
 * Toggle_Extension_Loader("inline");
 * 
 * try { chrome.webstore.install(Chrome_Extension_Webstore_Url,
 * function(success) {
 * 
 * console.log(success); Toggle_Extension_Request_Ui(true); }, function(error) {
 * console.log(error); Toggle_Extension_Loader("none"); //OpenInNewTab(); }); }
 * catch (e) { console.log(e); Toggle_Extension_Loader("none");
 * //OpenInNewTab(); } return false; }); }
 * 
 *//**
	 * Toggle loader image
	 * 
	 * @param type
	 */
/*
 * function Toggle_Extension_Loader(type) {
 * 
 * console.log("In Toggle_Extension_Loader: " + type);
 * 
 * if (!type) return;
 * 
 * $("#chrome_extension").find("#loading").css('display', type); } // Open
 * extension installation in new window function OpenInNewTab() { var url =
 * "https://chrome.google.com/webstore/detail/agile-crm/eofoblinhpjfhkjlfckmeidagfogclib?utm_source=chrome-ntp-icon";
 * var win = window.open(url, '_blank'); win.focus(); }
 *//**
 * Cookie.js deals with functions used to create, read and erase a cookie.
 * @module jscore
 */

/**
 * Creates a cookie variable with the given name, value and expire time in days
 * 
 * @param name
 *            name of the variable example : agile-email etc.
 * @param value
 *            value of the variable example: agilecrm@example.com
 * @param days
 *            time in days before the variable expires example : 15*365
 * @returns cookie
 */
function createCookie(name, value, days)
{
	// If days is not equal to null, undefined or ""
	if (days)
	{
		var date = new Date();

		// Set cookie variable's updated expire time in milliseconds
		date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
		var expires = "; expires=" + date.toGMTString();
	}
	else
		// If days is null, undefined or "" set expires as ""
		var expires = "";
	document.cookie = name + "=" + escape(value) + expires + "; path=/";
}

function createCookieInAllAgileSubdomains(name, value, days)
{
	// If days is not equal to null, undefined or ""
	if (days)
	{
		var date = new Date();

		// Set cookie variable's updated expire time in milliseconds
		date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
		var expires = "; expires=" + date.toGMTString();
	}
	else
		// If days is null, undefined or "" set expires as ""
		var expires = "";
	document.cookie = name + "=" + escape(value) + expires + "; path=/; domain=agilecrm.com";
}

/**
 * Used to read a particular variable's value from document.cookie
 * 
 * @param name
 *            the name of the cookie variable to read example :
 *            agile-crm-session_start_time
 * @returns value of the cookie variable else it returns null
 */
function readCookie(name)
{
	var nameEQ = name + "=";

	// Split document.cookie into array at each ";" and iterate through it
	var ca = document.cookie.split(';');
	for ( var i = 0; i < ca.length; i++)
	{
		var c = ca[i];

		// Check for ' ' and remove to get string from c
		while (c.charAt(0) == ' ')
			c = c.substring(1, c.length);

		// check if nameEQ starts with c, if yes unescape and return its value
		if (c.indexOf(nameEQ) == 0)
			return unescape(c.substring(nameEQ.length, c.length));
	}
	return null;
}

/**
 * Used to delete a variable from document.cookie
 * 
 * @param name
 *            name of the variable to be removed from the cookie
 * @returns cookie without the variable
 */
function eraseCookie(name)
{
	createCookie(name, "", -1);
}
function initZeroClipboard(id, source) {

	 try {
	
		  ZeroClipboard.setDefaults({
		   moviePath : '/lib/zeroclipboard/ZeroClipboard.swf',
		   allowScriptAccess : "always"
		  });
		
	 } catch (e) {
		  // TODO: handle exception
		  console.log(e);
		  return false;
	 }
	
	 // Script code
	 var scriptCode = $('#' + source).text();
	
	 var clip = new ZeroClipboard();
	 clip.glue(document.getElementById(id));
	
	 clip.setText(scriptCode);
	
	 // Set id
	 clip.options.id = id;
	
	 // Set data to clickable element
	 $("#" + id).attr("data-clipboard-text", scriptCode);
	
	 clip.on('complete', function(client, args) {
		 
		  var id = $(this).attr("id");
		  
		  var script_tooltip_timing = function() {
			  $("#" + id).tooltip('hide').removeAttr('data-original-title');
		  };
		  
		  var timeOutHandler = setTimeout(script_tooltip_timing, 500);
		  
		  window.clearTimeout(timeOutHandler);
		  if (!id) {
		   return false;
		  }
		
		  var title = getTitleForClip(id);
		
		  // Show tooltip on complete
		  $("#" + id).attr({
		   "data-placement" : 'right',
		   "data-original-title" : title
		  });
		
		  $("#" + id).tooltip('show').off('mouseenter mouseleave');
		
		  timeOutHandler = setTimeout(script_tooltip_timing, 2000);
	
	 });

}

function getTitleForClip(id) {

 var title = "Code copied to clipboard";
 switch (id) {
 case "copy_email_to_clip_button":
  title = "Email id copied to clipboard";
  break;
 case "api_key_code_icon":
  title = "Key copied to clipboard";
  break;
 case "popup_clip_button":
  title = "Code copied to clipboard";
  break;
 case "url_clip_button":
  title = "URl copied to clipboard";
  break;
 }

 return title;

}
/**
 * email-charts.js - It handles campaign's hourly, weekly or date email-charts. It
 * initializes the date-range-picker and HighChart's bar graphs. It also handles
 * to fetch timezone offset.
 */

/**
 * Initializes the date-range-picker. Calls showEmailGraphs based on the date
 * range seleted.
 * 
 * @param campaign_id -
 *            to show charts w.r.t campaign-id.
 * @param callback -
 *            callback method if any.
 */
function initChartsUI(campaign_id, callback)
{
	head.js(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js' + '?_=' + _AGILE_VERSION, function()
	{
		
		// Bootstrap date range picker.
		$('#reportrange').daterangepicker({ ranges : { 'Today' : [
				'today', 'today'
		], 'Yesterday' : [
				'yesterday', 'yesterday'
		], 'Last 7 Days' : [
				Date.today().add({ days : -6 }), 'today'
		], 'Last 30 Days' : [
				Date.today().add({ days : -29 }), 'today'
		], 'This Month' : [
				Date.today().moveToFirstDayOfMonth(), Date.today().moveToLastDayOfMonth()
		], 'Last Month' : [
				Date.today().moveToFirstDayOfMonth().add({ months : -1 }), Date.today().moveToFirstDayOfMonth().add({ days : -1 })
		], 'This Quarter' : [
				Date.today().getMonth() < 3 ? new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth() : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth() : new Date(Date.today().setMonth(9)).moveToFirstDayOfMonth(), 
				Date.today().getMonth() < 3 ? new Date(Date.today().setMonth(2).moveToLastDayOfMonth()) : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(5)).moveToLastDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(8)).moveToLastDayOfMonth() : new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()
		], 'Last Quarter' : [
				Date.today().getMonth() < 3 ? new Date(Date.today().add({ years : -1 }).setMonth(9)).moveToFirstDayOfMonth() : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth() : new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth(), 
				Date.today().getMonth() < 3 ? new Date(Date.today().add({ years : -1 }).setMonth(11)).moveToLastDayOfMonth() : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(2)).moveToLastDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(5)).moveToLastDayOfMonth() : new Date(Date.today().setMonth(8)).moveToLastDayOfMonth()
		], 'This Year' : [
				new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth(), new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()
		], 'Last Year' : [
				new Date(Date.today().setMonth(0)).add({ years : -1 }).moveToFirstDayOfMonth(), new Date(Date.today().setMonth(11)).add({ years : -1 }).moveToLastDayOfMonth()
		] }, locale : { applyLabel : 'Apply', cancelLabel : 'Cancel', fromLabel : 'From', toLabel : 'To', customRangeLabel : 'Custom', daysOfWeek : [
				'Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'
		], monthNames : [
				'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'
		], firstDay : parseInt(CALENDAR_WEEK_START_DAY) } }, function(start, end)
		{
			var months_diff = Math.abs(start.getMonth() - end.getMonth() + (12 * (start.getFullYear() - end.getFullYear())));
			$('#reportrange span').html(start.toString('MMMM d, yyyy') + ' - ' + end.toString('MMMM d, yyyy'));
			$("#week-range").html(end.add({ days : -6 }).toString('MMMM d, yyyy') + ' - ' + end.add({ days : 6 }).toString('MMMM d, yyyy'));

			// Updates table data
			get_email_table_reports(campaign_id);

			// Updates bar graphs on date change.
			showEmailGraphs(campaign_id);

		});
		$('.daterangepicker > .ranges > ul').on("click", "li", function(e)
		{
			$('.daterangepicker > .ranges > ul > li').each(function(){
				$(this).removeClass("active");
			});
			$(this).addClass("active");
		});
	});

	// Updates table data
	get_email_table_reports(campaign_id);

	// shows graphs by default week date range.
	showEmailGraphs(campaign_id);
}

/**
 * Shows date-wise, hourly and weekly reports of a campaign. Calls showBar
 * function which uses HighCharts plugin to show bar charts.
 */
function showEmailGraphs(campaign_id)
{

	// Daily
	showBar('core/api/campaign-stats/email/reports/' + campaign_id + getOptions() + "&type=date", 'line-daily-chart', 'Daily Reports', 'Count', null);

	// Hourly
	showBar('core/api/campaign-stats/email/reports/' + campaign_id + getOptions() + "&type=hour", 'line-hourly-chart', 'Hourly Reports', 'Count', null);

	// Weekly
	showBar('core/api/campaign-stats/email/reports/' + campaign_id + getOptions() + "&type=day", 'line-weekly-chart', 'Weekly Reports', 'Count', null);
}

/**
 * Returns start_time, end_time and time_zone (timezone offset like -330) as
 * query params. Splits date range based on '-' to get start and end time in
 * milliseconds. Fetches timezone offset using Date function.
 */
function getOptions()
{
	// Options
	var options = "?";

	// Get Date Range January 22, 2015 - January 28, 2015
	var range = $('#range').html().split("-");
	/*
	 * var temp = "January 22, 2015 - January 28, 2015"; var range =
	 * temp.split("-");
	 */
	// Returns milliseconds from start date. For e.g., August 6, 2013 converts
	// to 1375727400000
	//var start_time = Date.parse($.trim(range[0])).valueOf();
	//Get the GMT start time
	var start_time = getUTCMidNightEpochFromDate(new Date(range[0]));

	var end_value = $.trim(range[1]);

	// To make end value as end time of day
	if (end_value)
		end_value = end_value + " 23:59:59";

	// Returns milliseconds from end date.
	//var end_time = Date.parse(end_value).valueOf();
	//Get the GMT end time
	var end_time = getUTCMidNightEpochFromDate(new Date(end_value));

	end_time += (((23*60*60)+(59*60)+59)*1000);

	// Adds start_time, end_time and timezone offset to params.
	options += ("start_time=" + start_time + "&end_time=" + end_time);

	// Add Timezone offset
	var d = new Date();
	options += ("&time_zone=" + d.getTimezoneOffset());

	// If Frequency is present - send frequency too
	if ($('#frequency').length > 0)
	{
		// Get Frequency
		var frequency = $("#frequency").val();
		options += ("&frequency=" + frequency);
	}

	// If Frequency is present - send frequency too
	if ($('#filter').length > 0)
	{
		// Get Frequency
		var filter_id = $("#filter").val();
		if (filter_id != "" && filter_id != "ALL")
			options += ("&filter=" + filter_id);
	}

	// console.log("options " + options);
	return options;
}

/**
 * Returns data required for table
 */
function get_email_table_reports(campaign_id)
{
	$("#email-table-reports").html(getRandomLoadingImg());

	$.getJSON('core/api/campaign-stats/email/table-reports/' + campaign_id + getOptions(), function(data)
	{

		console.log(data);

		// Load Reports Template
		getTemplate("campaign-email-table-reports", data, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$("#email-table-reports").html($(template_ui));	
		}, "#email-table-reports");

	});
}
/**
 * email-pic.js contains functions which fetch the picture
 * if its a valid email and get the picture by the email
 * 
 * @module jscore
 */
$(function()
{
	
	/*// Using initials as image 
	$('body').live('agile_collection_loaded', function(event, element)
	{
		$(".img-inital").closest("img").error(function()
		{
			$(this).initial({charCount: 2});
		});

	});*/
	
	//prevent default focusout of email
	$("#content").on('focusout', '#email', function(e)
	{
		e.preventDefault();

		// If length of email is 0, do not display picture
		var val = $("#email").val();
		if (val.length == 0)
		{
			$('#pic').css("display", "none");
			changeProperty();
			return;
		}
		
		// If picture is not null and undefined, display it by given width, else display none
		var pic = getPicByEmail(val, 45);
		if (pic != undefined && pic != null)
		{
			var el = $('<img class="imgholder thumbnail person-img" onload="changeProperty()" style="display: inline;"  src="' + pic + '"></img>');
			$('#pic').html(el).show();
			$("img").error(function()
			{
				$('#pic').css("display", "none");
				changeProperty();
				
			});
		}
	});
});

function getPicByEmail(email, width)
{
	//get picture by email from gravatar.com
	if (email)
	{
		return 'https://secure.gravatar.com/avatar/' + Agile_MD5(email) + '.jpg?s=' + width + '&d=404';
	}
}
$(function(){
	
	
});

function initializeFbPageTabListners(el){

	$("#fbPageTab-listners").on('click', '#facebookPageTabSave', function(e){
		e.preventDefault();
		
		// Checks whether all input fields are given
		if (!isValidForm($("#facebookPageTabSettingForm"))){
			return;
		}
		
		var facebookPageId = $("#facebookTabPage").val();
		var AgileFacebookAppId = $("#AgileFacebookAppId").val();
		
		var formData = "facebookPageID=" + facebookPageId;
		formData += "&facebookPageName=" + $("#facebookTabPage").find('option:selected').text();
		formData += "&facebookPageToken=" + $("#facebookTabPage").find('option:selected').attr("data-token");
		formData += "&formID=" + $("#formToUse").val();
		formData += "&formName=" + $("#formToUse").find('option:selected').text();
		
		$.ajax({
		    url : "fbpage?action=SAVE_DETAILS",
		    type: "POST",
		    data : formData,
		    success: function(data, textStatus, jqXHR){
		       if(data == "true") {
		    	   $('#formToUse').prop('selectedIndex',0);
		    	   $('#facebookTabPage').prop('selectedIndex',0);
		    	   $("#statusMessageHolder").html("Done. Form added to <a target=\"_blank\" href=\"https://www.facebook.com/pages/null/"+facebookPageId+"?sk=app_"+AgileFacebookAppId+"\">your Facebook page.</a><br>");
		       } else {
		    	   $("#statusMessageHolder").html("Something went wrong, please try again.");
		       }
		    },
		    error: function (jqXHR, textStatus, errorThrown){
		    }
		    });		
	});
	
	$("#fbPageTab-listners").on('click', '.deleteFacebookLinkedpage', function(e){
		e.preventDefault();
		var agree = confirm("Are you sure you want to remove Agile form tab ?");
		if(agree) {
			var pageId = $(this).attr("data-pageid");
			var pageToken = $("#facebookTabPage option[value='"+pageId+"']").attr("data-token");
			if(typeof pageToken == "undefined") {
				var isAgreed = confirm("Link your facebook account before removing this form from your facebook page tab.");
				if(isAgreed) {
					var fbLoginLink = $("#AddFormLinkFacebookAccount").attr("href");
					if(typeof fbLoginLink != "undefined") {
						window.location.href = fbLoginLink;
					}
				}
			} else {
				
				var formData = "facebookPageID=" + pageId;
				formData += "&facebookPageToken=" + pageToken;
				
				$.ajax({
				    url : "fbpage?action=DELETE_TAB",
				    type: "POST",
				    data : formData,
				    success: function(data, textStatus, jqXHR){
				       if(data == "true") {
				    	   $("#connectedFormHolder_"+pageId).remove();
				    	   $("#delStatusMessageHolder").html("Done. Removed successfully.<br>");
				       } else {
				    	   $("#delStatusMessageHolder").html("Something went wrong, please try again.");
				       }
				    },
				    error: function (jqXHR, textStatus, errorThrown){
				    }
				    });
			}
		}		
	});
	
	$("#fbPageTab-listners").on('change', '#formToUse', function(e){
		var preSelectedFormId = $("#connectedForm_"+$(this).val()).attr("data-pageid");
		if(typeof preSelectedFormId != "undefined") {
			$("#facebookTabPage").val(preSelectedFormId);
		}
	});
}(function($) {
	
    // To show top button at the bottom of page
	addScrollTopAnimation(); 
	
	// Starts scroll
	function addScrollTopAnimation() {

		var $scrolltop_link = $('#scroll-top');

		// When click event is fired scrolls the page to top
		$scrolltop_link.on('click', function(ev) {

			ev.preventDefault();

			$('html, body').animate({ scrollTop : 0	}, 700);

		})

		// Hides the link initially
		.data('hidden', 1).hide();

		var scroll_event_fired = false;

		$(window).on('scroll', function() {

			scroll_event_fired = true;

		});

		/*
		 * Checks every 300 ms if a scroll event has been fired.
		 */
		setInterval(function() {

			if (scroll_event_fired) {

				/*
				 * Stop code below from being executed until the next scroll
				 * event.
				 */
				scroll_event_fired = false;

				var is_hidden = $scrolltop_link.data('hidden');

				/*
				 * Display the scroll top link when the page is scrolled down
				 * the height of half a viewport from top, Hide it otherwise.
				 */
				if ($(this).scrollTop() > $(this).height() / 2) {
					if (is_hidden) {
						$scrolltop_link.fadeIn(600).data('hidden', 0);
					}
				}
				else {
					if (!is_hidden) {
						$scrolltop_link.slideUp().data('hidden', 1);
					}
				}
			}
		}, 300);
	}
	
	/* For toggling help modal popup */
	$("body").on('click', '#help-page', function(e){
		
		getTemplate("show-help", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			var helpModal = $(template_ui);
			helpModal.modal('show');
		
			// Hides help only when clicked on close button.
		    $('.hide-modal', helpModal).click(function(){
		    		helpModal.modal('hide');
		    });

		}, null);
   
	});
	
	/* For opening the footer icons in seperate popup window */
	$("body").on('click', '.email-share', function(e){
		e.preventDefault();
		var x = 500;
		var title = $(this).closest("a").attr('data');
		if(title == "Linkedin") x=700;
		var url = $(this).closest("a").attr('href');
		window.open(url, title, "width=" + x + ",height=500,left=200%,top=100%");
	});
	
	/* For sharing agile to friends */
	$("body").on('click', '#share-email', function(e){
		e.preventDefault();
		
		// If modal is already present removing it to submit new form
        if ($('#share-by-email').size() != 0)
        {
        	$('#share-by-email').remove();
        }

        getTemplate("share-by-email", CURRENT_DOMAIN_USER, undefined, function(template_ui){
			if(!template_ui)
				  return;

			var emailModal = $(template_ui);
			// Replacing text area break lines
			var description = $(emailModal).find('textarea').val();
			description = description.replace( /<br\/>/g,"\r\n");
			$(emailModal).find('textarea').val(description);
	
			emailModal.modal('show');
			// When send button is clicked form is validated
			$("body").on('click', '#shareMail', function(e){
					e.preventDefault();
					
					if(!isValidForm($('#sharemailForm')))
				      {	
				      	return;
				      }
					
					var json = serializeForm("sharemailForm");
					
					json.body = json.body.replace(/\r\n/g,"<br/>");
					
					// Constructs URL to send mail
					var url =  'core/api/emails/send-email?from=' + encodeURIComponent(json.from) + '&to=' + 
					 encodeURIComponent(json.to) + '&subject=' + encodeURIComponent(json.subject) + '&body=' + 
						 encodeURIComponent(json.body);
					
					// Shows message 
				    $save_info = $('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><p class="text-success" style="color:#008000; font-size:15px; display:inline-block"> <i>Sending mail...</i></p></span>');
				    $("#msg", this.el).append($save_info);
					$save_info.show().delay(2000).fadeOut("slow");
					
					// Navigates to previous page on sending email
					$.post(url, function(){
						emailModal.modal('hide');
					});
			});

		}, "#content");
	});
	
})(jQuery);/** Image loader while template render */
var Template_Render_Image_Loader = '<img class="loading" style="padding-right:5px;opacity:0.5;" src= "/img/ajax-loader-cursor.gif"></img>';/**
 * help-mail.js deals with functions like building url by parsing form data,
 * showing message while sending mail, resetting form data after sending mail.
 * 
 * @module jscore
 */

/**
 * Serialize form data, build url, show message, reset form fields.
 * 
 * @param #helpmailForm
 */
$(function() {
	
/*	// To toggle the contact us email
	$("#show_support").live("click", function(e){
		  e.preventDefault();
		  $("#content").html(getTemplate("help-mail-form"), {});
		 // $("#helpmailForm").toggle();
		 // $('html, body').animate({ scrollTop : 360  },1000);
	});*/

	// Prevent default on click
	$("body").on('click', '#helpMail', function(e){
		e.preventDefault();

		if($(this).attr('disabled'))
	   	     return;
		
		// If not a valid form return else serialize form data to parse
		if(!isValidForm($("#helpmailForm")))
			return;
		
		// Disables send button and change text to Sending...
		disable_send_button($(this));
		
		var json = serializeForm("helpmailForm");

		json.from = CURRENT_DOMAIN_USER.email;
		
		// Replace \r\n with <br> tags as email is sent as text/html
		json.body = json.body.replace(/\r\n/g,"<br/>");
        

        $.ajax({
		
				type : 'POST',
				data : json,
				url : 'core/api/emails/contact-us',
				success : function()
						{

							// Reset form fields after sending email
							$("#helpmailForm").each(function () {
								this.reset();
							});
			
							// Show message and gif while sending mail and fadeout
							$save_info = $('<span class="text-success" style="color:#008000; font-size:15px; display:inline-block"><i> Email Sent</i></span>');
							$('#msg').append($save_info);
							$save_info.show().delay(1000).fadeOut("slow", function(){
				
								// Enables Send Email button.
			    				enable_send_button($('#helpMail'));
				
								//$("#helpmailForm").hide();
								
								window.history.back();
								});
						},
						error : function(response)
								{
									enable_send_button($('#helpMail'));

									// Show cause of error in saving
									$save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>' + response.responseText + '</i></p></small></div>');

									// Appends error info to form actions
									// block.
									$($('#helpMail')).closest(".form-actions", this.el).append($save_info);

									// Hides the error message after 3
									// seconds
									if (response.status != 406)
										$save_info.show().delay(10000).hide(1);
								}
				});
	});
});/**
 * ical.js is a script file that runs when user clicks on subscribe iCal feed.
 * It fetches apikey and domain name of current user. It appends apikey and
 * domain name to url.
 * 
 * author: Naresh
 */
$("#content").on('click', '#subscribe-ical', function(event)
{
	event.preventDefault();
	set_api_key();
});

/**
 * Fetches APIKey of current user
 * 
 * @method set_api_key
 */
function set_api_key()
{
	var api_key_model = Backbone.Model.extend({ url : 'core/api/api-key' });

	var model = new api_key_model();
	var data = model.fetch({ success : function(data)
	{
		var api_key = data.get('api_key');
		set_url_domain(api_key);
	} });
}
/**
 * 
 * Gets domain of current user using Backbone.
 * 
 * @method set_url_domain
 * @param apiKey -
 *            apiKey of current user.
 */
function set_url_domain(apiKey)
{
	var domain = window.location.hostname.split(".")[0];
	set_url(apiKey, domain);
}

/**
 * 
 * Sets url with domain and apiKey
 * 
 * @method set_url
 * @param apiKey -
 *            apiKey of current user.
 * 
 * @param domain -
 *            domain of current user.
 */
function set_url(apiKey, domain)
{
	var url = "webcal://" + domain + ".agilecrm.com/ical/" + apiKey;
	$('#ical-feed').attr('href', url);
	$('#ical-feed').text(url);
	console.log(url);
}

/**
 * Sends email with ical data to current-user email.
 * 
 * @method send_ical_info_email
 * @param emailModal -
 *            ical-email-modal
 */
function send_ical_info_email(emailModal)
{
	// When Send Clicked, validate the form and send email.
	emailModal.on("shown.bs.modal", function(e){

	$("#share-ical-by-email")
			.on(
					'click',
					'#shareIcalMail',
					function(e)
					{
						e.preventDefault();

						// if not valid
						if (!isValidForm($('#shareIcalMailForm')))
							return;

						var json = serializeForm("shareIcalMailForm");
						json.body = json.body.replace(/\r\n/g, "<br/>");

						var url = 'core/api/emails/send-email?from=' + encodeURIComponent(json.from) + '&to=' + encodeURIComponent(json.to) + '&subject=' + encodeURIComponent(json.subject) + '&body=' + encodeURIComponent(json.body);

						// Shows message
						$save_info = $('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><p class="text-success" style="color:#008000; font-size:15px; display:inline-block"> <i>Sending mail...</i></p></span>');
						$("#msg", this.el).append($save_info);
						$save_info.show().delay(2000).fadeOut("slow");

						// Navigates to previous page on sending email
						$.post(url, function()
						{
							emailModal.modal('hide');
						});

					});
		});
}

$(function()
{

	$('#scheduleModal').on('hidden.bs.modal', function(e)
	{
		$("#edit").show();
		$('#charlength').hide();
		$('#specialchar').hide();

	})

	/*
	 * $("body").on('click', '#show-schedule-url', function(e) {
	 * e.preventDefault(); $('#scheduleModal').modal('show'); });
	 */

	$('#scheduleModal').on('show.bs.modal', function()
	{

		var updatedCurrentUser = Backbone.Model.extend({ url : '/core/api/users/current-user', restKey : "domainUser" });

		var updateduserModel = new updatedCurrentUser();

		updateduserModel.fetch({ success : function(data)
		{
			var model = data.toJSON();

			if ($("#scheduleModal").size() > 1)
			{
				$('#scheduleModal').modal('hide').remove();

			}

			var onlineschedulingURL = "https://" + model.domain + ".agilecrm.com/calendar/" + model.schedule_id;
			var hrefvalue = "https://" + model.domain + ".agilecrm.com/calendar/";
			$("#scheduleurl").attr("href", onlineschedulingURL);
			$("#hrefvalue").html(hrefvalue);
			$("#schedule_id").html(model.schedule_id);

			$("#scheduleurl").removeClass("nounderline");

		} });
	});

});

/*
 * $("body").on('click', '#send-schedule-url-email', function(e) {
 * e.preventDefault();
 * 
 * $("#scheduleModal").modal('hide'); // Removes previous modals if exist. if
 * ($('#scheduleModal').size() != 0) $('#scheduleModal').remove();
 * 
 * var emailModal = $(getTemplate("share-schedule-url-by-email", {}));
 * 
 * var description = $(emailModal).find('textarea').val();
 * 
 * description = description.replace(/<br\/>/g, "\r\n");
 * 
 * $(emailModal).find('textarea').val(description);
 * 
 * emailModal.modal('show'); // Send schedule url by email //
 * send_schedule_url_email(emailModal);
 * 
 * });
 */

/**
 * Sends email with ical data to current-user email.
 * 
 * @method send_ical_info_email
 * @param emailModal -
 *            ical-email-modal
 */
/*
 * function send_schedule_url_email(emailModal) { // When Send Clicked, validate
 * the form and send email. $("#icalModal") .on( 'click', '#share-url-email',
 * function(e) { e.preventDefault();
 *  // if not valid if (!isValidForm($('#sharescheduleurlmailForm'))) return;
 * 
 * var json = serializeForm("sharescheduleurlmailForm"); json.body =
 * json.body.replace(/\r\n/g, "<br/>");
 * 
 * var url = 'core/api/emails/send-email?from=' + encodeURIComponent(json.from) +
 * '&to=' + encodeURIComponent(json.to) + '&subject=' +
 * encodeURIComponent(json.subject) + '&body=' + encodeURIComponent(json.body);
 *  // Shows message $save_info = $('<img src="img/1-0.gif" height="18px"
 * width="18px"></img>&nbsp;&nbsp;<span><p class="text-success" style="color:#008000; font-size:15px; display:inline-block">
 * <i>Sending mail...</i></p></span>'); $("#msg",
 * this.el).append($save_info); $save_info.show().delay(2000).fadeOut("slow");
 *  // Navigates to previous page on sending email $.post(url, function() {
 * emailModal.modal('hide'); });
 * 
 * }); }
 */
/** 
 * Check if route is the current route of the app.
 * @param route
 * @returns {Boolean}
 */
function isRoute(route)
{
	if(!Current_Route)return false;
	return (Current_Route.indexOf(route)==0);
}

/**
 * Checks if any modal is visible.
 * @returns
 */
function isModalVisible()
{
	return $(".modal").is(":visible");
}

$(function(){
	
	/* To enable or disable the keyboard shortcuts	 */
	if(CURRENT_USER_PREFS.keyboard_shotcuts){
		enableKeyboardShotcuts();
		$(".show_shortcuts .shortcuts").addClass("enable");
	}
	/* For toggling keyboard shortcuts modal popup */
    $("body").on('click', '#keyboard-shortcuts', function(e){
		e.preventDefault();

		getTemplate("shortcut-keys", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$(template_ui).modal('show');
		}, null);
	});
});

/**
 * Enables keyboard shortcuts based on user prefs.
 */
function enableKeyboardShotcuts()
{
	head.js(LIB_PATH+'lib/mousetrap.min.js',function(){
	
		
		// New contact
		Mousetrap.bind('shift+n',function(){
			if(!isModalVisible())
				addContactBasedOnCustomfields(); 
		});

		// New company
		Mousetrap.bind('shift+c',function(){
			if(!isModalVisible())
				$('#companyModal').modal('show'); 
		});

		// New event
		Mousetrap.bind('shift+v',function(){
			if(!isModalVisible()){
				$('#activityModal').html(getTemplate("new-event-modal")).modal('show');
				highlight_event();
			}
		});
		
		// New Task
		Mousetrap.bind('shift+t',function(){
			if(!isModalVisible())
				showTaskModal("");
		});

		// New deal
		Mousetrap.bind('shift+d',function(){
			if(!isModalVisible())
				show_deal(); 
		});

		// New note
		Mousetrap.bind('shift+o',function(){
			if(!isModalVisible()){
				$('#noteModal').modal('show'); 
				var el = $("#noteForm");
				agile_type_ahead("note_related_to", el, contacts_typeahead);
			}
		});

		// New email
		/*Mousetrap.bind('shift+l',function(){
			if(!isRoute("send-email") && !isModalVisible())
				App_Contacts.navigate("send-email",{trigger:true});
		});*/




		// Preferences
		Mousetrap.bind('shift+p',function(){
			if(!isRoute("user-prefs") && !isModalVisible())
				App_Settings.navigate("user-prefs",{trigger:true});
		});

		// Admin settings
		Mousetrap.bind('shift+a',function(){
			if(!isRoute("account-prefs") && !isModalVisible() && CURRENT_DOMAIN_USER.is_admin)
				App_Settings.navigate("account-prefs",{trigger:true});
		});

		// Theme and layout
		Mousetrap.bind('shift+l',function(){
			if(!isRoute("themeandlayout") && !isModalVisible())
				App_Settings.navigate("themeandlayout",{trigger:true});
		});

		// upgrade
		Mousetrap.bind('shift+u',function(){
			if(!isRoute("subscribe") && !isModalVisible())
				App_Settings.navigate("subscribe",{trigger:true});
		});

		// Product updates
		Mousetrap.bind('shift+r',function(){
			if(!isModalVisible())
				window.open("https://www.agilecrm.com/product-updates", true);
		});

		// Help
		Mousetrap.bind('shift+h',function(){
			if(!isRoute("help") && !isModalVisible())
				App_Settings.navigate("help",{trigger:true});
		});

		// Logout
		Mousetrap.bind('shift+g',function(){
			if(!isModalVisible())
				window.location.href = "/login?sur=true";
		});



		
		// Edit the current contact
		Mousetrap.bind('shift+e',function(){
			if(isRoute("contact/") && !isModalVisible())
				App_Contacts.navigate("contact-edit",{trigger:true});
		});
		
		// Send mail to current contact
		Mousetrap.bind('shift+m',function(){
			if(isModalVisible())
				return;
			if(isRoute("contact/"))
				App_Contacts.navigate("send-email/"+ getCurrentContactProperty("email"),{trigger:true});
			else
				App_Contacts.navigate("send-email",{trigger:true});
		});
		
		// Focus on search box in main menu
		Mousetrap.bind('/',function(e){
			if(isModalVisible())return;
			document.getElementById('searchText').focus();
			
			if(e.preventDefault)
		        e.preventDefault();
		    else
		        e.returnValue = false; // internet explorer
		});
		
		// New of current entity type
		Mousetrap.bind('n',function(){
			
			if(isModalVisible())return;
			
			if(isRoute('contact'))
				addContactBasedOnCustomfields();
			else if(isRoute('cases'))
				showCases();
			else if(isRoute('deals'))
				show_deal();
			else if(isRoute('workflow'))
				App_Workflows.navigate("workflow-add",{trigger:true});
			else if(isRoute('report'))
				App_Reports.navigate("report-add",{trigger:true});
			else if(isRoute('tasks'))
				showTaskModal("");
			else if(isRoute('calendar'))
				{
				  $('#activityModal').html(getTemplate("new-event-modal")).modal('show');
				  highlight_event();
				}
		});
	});
}

/** OLD CODE Below - Without any library, just native js.
 * 	Performance not tested, so don't know if this or the one with Mousetrap Library is faster.
 *

// keyCode value of keys used in shortcut.
var CodeASCII={
E:"E".charCodeAt(0),
M:"M".charCodeAt(0),
N:"N".charCodeAt(0),
P:"P".charCodeAt(0),
T:"T".charCodeAt(0),
Slash:191
};



/**
 * Check if tg is any input tag
 * @param tg - tag name to test.
 * @returns
 *
function isInputTag(tg)
{
	var tagList=[ "INPUT", "TEXTAREA" ];
	
	for(var i=0;i<tagList.length;++i)
		if(tg==tagList[i])return true;
	
	return false;
}

/**
 * Handler function fired when any key is pressed.
 * @param e
 *
function keyHandler(e)
{
	if((e.target && isInputTag(e.target.tagName)) || isModalVisible())return;
	// focussed on input, so return default, as user is typing text.
	
	if(e.shiftKey)
	{
		if(e.keyCode==CodeASCII.P)
			App_Settings.navigate("user-prefs",{trigger:true}); 	// Shift+P : preferences
		else if(e.keyCode==CodeASCII.N)
			$('#personModal').modal('show');                    	// Shift+N : new contact person
		else if(e.keyCode==CodeASCII.T)
			$('#activityModal').modal('show');						// Shift+T : new task
		else if(isRoute("contact/"))
		{
			if(e.keyCode==CodeASCII.E)
				App_Contacts.navigate("contact-edit",{trigger:true});	// Shift+E : edit current contact
			else if(e.keyCode==CodeASCII.M)	
				App_Contacts.navigate("send-email",{trigger:true});		// Shift+M : send mail to current contact
		}
		else return;												// Let default happen.
		
		e.preventDefault();
	}
	else
	{
		if(e.keyCode==CodeASCII.Slash)
		{
			document.getElementById('searchText').focus(); 			// / : search
			e.preventDefault();
		}
		else if(e.keyCode==CodeASCII.N)								// N : new current thing
		{
			if(isRoute('contact'))
				$('#personModal').modal('show');
			else if(isRoute('cases'))
				showCases();
			else if(isRoute('deals'))
				show_deal();
			else if(isRoute('workflow'))
				App_Workflows.navigate("workflow-add",{trigger:true});
			else if(isRoute('report'))
				App_Reports.navigate("report-add",{trigger:true});
			else if(isRoute('task') || isRoute('calendar'))
				$('#activityModal').modal('show');	
			e.preventDefault();
		}
	}	
}

window.onkeydown = keyHandler;
*/
/**
 * local-storage.js deals with functions used to store data in the client side.
 * Stores in localstorage if available otherwise usrs cookies.
 * @module jscore
 */

/**
 * stores data with given name in local storage or cookies.
 * 
 * @param name
 *            name of the variable example : agile-email etc.
 * @param value
 *            value of the variable example: agilecrm@example.com
 * @param days
 *            time in days before the variable expires example : 15*365
 * @returns cookie
 */
function storeData(name, value, days)
{
	if(typeof(Storage) !== "undefined") {
		if(islocalStorageHasSpace()){
			localStorage.setItem(name, value);
		}
	} else {
	    createCookie(name, value, days);
	}
}

/**
 * Used to read a particular variable's value from local storage
 * 
 * @param name
 *            the name of the cookie variable to read example :
 *            agile-crm-session_start_time
 * @returns value of the cookie variable else it returns null
 */
function readData(name)
{
	if(typeof(Storage) !== "undefined") {
		return localStorage.getItem(name);
	} else {
	    return raedCookie(name);
	}
}

/**
 * Used to delete a variable from storage
 * 
 * @param name
 *            name of the variable to be removed from the cookie
 */
function eraseData(name)
{

	if(typeof(Storage) !== "undefined") {
		return localStorage.removeItem(name);
	} else {
	    return eraseCookie(name);
	}
}

/**
 * This Function will clear the data for every 30days.
 */
function clearLocalStorage() {
	var currentDate = new Date();	
	var setExprDate = false;
	
    var localStorageSize = 1024 * 1024 * 5 - unescape(encodeURIComponent(JSON.stringify(localStorage))).length;
    if(localStorageSize < 1242597){
    	localStorage.clear();
    	setExprDate = true;
    }else{
    	//Getting the local Storage expire date.
    	var exprDate = localStorage.getItem('localStorageExpireDate');
    	//Check the expire date has value/not.
        if(exprDate){
        	exprDate = new Date(Date.parse(exprDate));
        	if(currentDate >= exprDate){
        		localStorage.clear();
        		setExprDate = true;
        	}
        }else{    	
        	setExprDate = true; 	
        }
    }
	
    //Set the expire date.
    if(setExprDate){
    	var updateDate = currentDate.getDate()+30;
    	currentDate.setDate(updateDate);
    	localStorage.setItem('localStorageExpireDate',currentDate);
    }
}

/**
 * This function will check the space is available in the local storage.
 */
function islocalStorageHasSpace(){
	var hasSpace = false;
	var fixedLimit = 1242597;
	var localStorageSize = 1024 * 1024 * 5 - unescape(encodeURIComponent(JSON.stringify(localStorage))).length;
	if(localStorageSize){
		if(localStorageSize > fixedLimit){
			hasSpace = true;
		}
	}else{
		hasSpace = true;
	}
	return hasSpace;
}

(function($) {
	clearLocalStorage();
})(jQuery);/**
 * md5.js deals with implementing the md5 cryptographic hash function 
 * which takes arbitrary-sized data and output a fixed-length (16) hash value.
 */
var Agile_MD5 = function (string) {

        function RotateLeft(lValue, iShiftBits) {
            return (lValue << iShiftBits) | (lValue >>> (32 - iShiftBits));
        }

        function AddUnsigned(lX, lY) {
            var lX4, lY4, lX8, lY8, lResult;
            lX8 = (lX & 0x80000000);
            lY8 = (lY & 0x80000000);
            lX4 = (lX & 0x40000000);
            lY4 = (lY & 0x40000000);
            lResult = (lX & 0x3FFFFFFF) + (lY & 0x3FFFFFFF);
            if (lX4 & lY4) {
                return (lResult ^ 0x80000000 ^ lX8 ^ lY8);
            }
            if (lX4 | lY4) {
                if (lResult & 0x40000000) {
                    return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);
                } else {
                    return (lResult ^ 0x40000000 ^ lX8 ^ lY8);
                }
            } else {
                return (lResult ^ lX8 ^ lY8);
            }
        }

        function F(x, y, z) {
            return (x & y) | ((~x) & z);
        }

        function G(x, y, z) {
            return (x & z) | (y & (~z));
        }

        function H(x, y, z) {
            return (x ^ y ^ z);
        }

        function I(x, y, z) {
            return (y ^ (x | (~z)));
        }

        function FF(a, b, c, d, x, s, ac) {
            a = AddUnsigned(a, AddUnsigned(AddUnsigned(F(b, c, d), x), ac));
            return AddUnsigned(RotateLeft(a, s), b);
        };

        function GG(a, b, c, d, x, s, ac) {
            a = AddUnsigned(a, AddUnsigned(AddUnsigned(G(b, c, d), x), ac));
            return AddUnsigned(RotateLeft(a, s), b);
        };

        function HH(a, b, c, d, x, s, ac) {
            a = AddUnsigned(a, AddUnsigned(AddUnsigned(H(b, c, d), x), ac));
            return AddUnsigned(RotateLeft(a, s), b);
        };

        function II(a, b, c, d, x, s, ac) {
            a = AddUnsigned(a, AddUnsigned(AddUnsigned(I(b, c, d), x), ac));
            return AddUnsigned(RotateLeft(a, s), b);
        };

        function ConvertToWordArray(string) {
            var lWordCount;
            var lMessageLength = string.length;
            var lNumberOfWords_temp1 = lMessageLength + 8;
            var lNumberOfWords_temp2 = (lNumberOfWords_temp1 - (lNumberOfWords_temp1 % 64)) / 64;
            var lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
            var lWordArray = Array(lNumberOfWords - 1);
            var lBytePosition = 0;
            var lByteCount = 0;
            while (lByteCount < lMessageLength) {
                lWordCount = (lByteCount - (lByteCount % 4)) / 4;
                lBytePosition = (lByteCount % 4) * 8;
                lWordArray[lWordCount] = (lWordArray[lWordCount] | (string.charCodeAt(lByteCount) << lBytePosition));
                lByteCount++;
            }
            lWordCount = (lByteCount - (lByteCount % 4)) / 4;
            lBytePosition = (lByteCount % 4) * 8;
            lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80 << lBytePosition);
            lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
            lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;
            return lWordArray;
        };

        function WordToHex(lValue) {
            var WordToHexValue = "",
                WordToHexValue_temp = "",
                lByte, lCount;
            for (lCount = 0; lCount <= 3; lCount++) {
                lByte = (lValue >>> (lCount * 8)) & 255;
                WordToHexValue_temp = "0" + lByte.toString(16);
                WordToHexValue = WordToHexValue + WordToHexValue_temp.substr(WordToHexValue_temp.length - 2, 2);
            }
            return WordToHexValue;
        };

        function Utf8Encode(string) {
            string = string.replace(/\r\n/g, "\n");
            var utftext = "";

            for (var n = 0; n < string.length; n++) {

                var c = string.charCodeAt(n);

                if (c < 128) {
                    utftext += String.fromCharCode(c);
                } else if ((c > 127) && (c < 2048)) {
                    utftext += String.fromCharCode((c >> 6) | 192);
                    utftext += String.fromCharCode((c & 63) | 128);
                } else {
                    utftext += String.fromCharCode((c >> 12) | 224);
                    utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                    utftext += String.fromCharCode((c & 63) | 128);
                }

            }

            return utftext;
        };

        var x = Array();
        var k, AA, BB, CC, DD, a, b, c, d;
        var S11 = 7,
            S12 = 12,
            S13 = 17,
            S14 = 22;
        var S21 = 5,
            S22 = 9,
            S23 = 14,
            S24 = 20;
        var S31 = 4,
            S32 = 11,
            S33 = 16,
            S34 = 23;
        var S41 = 6,
            S42 = 10,
            S43 = 15,
            S44 = 21;

        string = Utf8Encode(string);

        x = ConvertToWordArray(string);

        a = 0x67452301;
        b = 0xEFCDAB89;
        c = 0x98BADCFE;
        d = 0x10325476;

        for (k = 0; k < x.length; k += 16) {
            AA = a;
            BB = b;
            CC = c;
            DD = d;
            a = FF(a, b, c, d, x[k + 0], S11, 0xD76AA478);
            d = FF(d, a, b, c, x[k + 1], S12, 0xE8C7B756);
            c = FF(c, d, a, b, x[k + 2], S13, 0x242070DB);
            b = FF(b, c, d, a, x[k + 3], S14, 0xC1BDCEEE);
            a = FF(a, b, c, d, x[k + 4], S11, 0xF57C0FAF);
            d = FF(d, a, b, c, x[k + 5], S12, 0x4787C62A);
            c = FF(c, d, a, b, x[k + 6], S13, 0xA8304613);
            b = FF(b, c, d, a, x[k + 7], S14, 0xFD469501);
            a = FF(a, b, c, d, x[k + 8], S11, 0x698098D8);
            d = FF(d, a, b, c, x[k + 9], S12, 0x8B44F7AF);
            c = FF(c, d, a, b, x[k + 10], S13, 0xFFFF5BB1);
            b = FF(b, c, d, a, x[k + 11], S14, 0x895CD7BE);
            a = FF(a, b, c, d, x[k + 12], S11, 0x6B901122);
            d = FF(d, a, b, c, x[k + 13], S12, 0xFD987193);
            c = FF(c, d, a, b, x[k + 14], S13, 0xA679438E);
            b = FF(b, c, d, a, x[k + 15], S14, 0x49B40821);
            a = GG(a, b, c, d, x[k + 1], S21, 0xF61E2562);
            d = GG(d, a, b, c, x[k + 6], S22, 0xC040B340);
            c = GG(c, d, a, b, x[k + 11], S23, 0x265E5A51);
            b = GG(b, c, d, a, x[k + 0], S24, 0xE9B6C7AA);
            a = GG(a, b, c, d, x[k + 5], S21, 0xD62F105D);
            d = GG(d, a, b, c, x[k + 10], S22, 0x2441453);
            c = GG(c, d, a, b, x[k + 15], S23, 0xD8A1E681);
            b = GG(b, c, d, a, x[k + 4], S24, 0xE7D3FBC8);
            a = GG(a, b, c, d, x[k + 9], S21, 0x21E1CDE6);
            d = GG(d, a, b, c, x[k + 14], S22, 0xC33707D6);
            c = GG(c, d, a, b, x[k + 3], S23, 0xF4D50D87);
            b = GG(b, c, d, a, x[k + 8], S24, 0x455A14ED);
            a = GG(a, b, c, d, x[k + 13], S21, 0xA9E3E905);
            d = GG(d, a, b, c, x[k + 2], S22, 0xFCEFA3F8);
            c = GG(c, d, a, b, x[k + 7], S23, 0x676F02D9);
            b = GG(b, c, d, a, x[k + 12], S24, 0x8D2A4C8A);
            a = HH(a, b, c, d, x[k + 5], S31, 0xFFFA3942);
            d = HH(d, a, b, c, x[k + 8], S32, 0x8771F681);
            c = HH(c, d, a, b, x[k + 11], S33, 0x6D9D6122);
            b = HH(b, c, d, a, x[k + 14], S34, 0xFDE5380C);
            a = HH(a, b, c, d, x[k + 1], S31, 0xA4BEEA44);
            d = HH(d, a, b, c, x[k + 4], S32, 0x4BDECFA9);
            c = HH(c, d, a, b, x[k + 7], S33, 0xF6BB4B60);
            b = HH(b, c, d, a, x[k + 10], S34, 0xBEBFBC70);
            a = HH(a, b, c, d, x[k + 13], S31, 0x289B7EC6);
            d = HH(d, a, b, c, x[k + 0], S32, 0xEAA127FA);
            c = HH(c, d, a, b, x[k + 3], S33, 0xD4EF3085);
            b = HH(b, c, d, a, x[k + 6], S34, 0x4881D05);
            a = HH(a, b, c, d, x[k + 9], S31, 0xD9D4D039);
            d = HH(d, a, b, c, x[k + 12], S32, 0xE6DB99E5);
            c = HH(c, d, a, b, x[k + 15], S33, 0x1FA27CF8);
            b = HH(b, c, d, a, x[k + 2], S34, 0xC4AC5665);
            a = II(a, b, c, d, x[k + 0], S41, 0xF4292244);
            d = II(d, a, b, c, x[k + 7], S42, 0x432AFF97);
            c = II(c, d, a, b, x[k + 14], S43, 0xAB9423A7);
            b = II(b, c, d, a, x[k + 5], S44, 0xFC93A039);
            a = II(a, b, c, d, x[k + 12], S41, 0x655B59C3);
            d = II(d, a, b, c, x[k + 3], S42, 0x8F0CCC92);
            c = II(c, d, a, b, x[k + 10], S43, 0xFFEFF47D);
            b = II(b, c, d, a, x[k + 1], S44, 0x85845DD1);
            a = II(a, b, c, d, x[k + 8], S41, 0x6FA87E4F);
            d = II(d, a, b, c, x[k + 15], S42, 0xFE2CE6E0);
            c = II(c, d, a, b, x[k + 6], S43, 0xA3014314);
            b = II(b, c, d, a, x[k + 13], S44, 0x4E0811A1);
            a = II(a, b, c, d, x[k + 4], S41, 0xF7537E82);
            d = II(d, a, b, c, x[k + 11], S42, 0xBD3AF235);
            c = II(c, d, a, b, x[k + 2], S43, 0x2AD7D2BB);
            b = II(b, c, d, a, x[k + 9], S44, 0xEB86D391);
            a = AddUnsigned(a, AA);
            b = AddUnsigned(b, BB);
            c = AddUnsigned(c, CC);
            d = AddUnsigned(d, DD);
        }

        var temp = WordToHex(a) + WordToHex(b) + WordToHex(c) + WordToHex(d);

        return temp.toLowerCase();
    };/** The function is commented inorder to implement later. It shows Upgrade message to free users**/

var Nagger_Noty;
function showUpgradeNoty()
{

	// Returns if account if paid account
	if(!_billing_restriction.currentLimits.freePlan)
		return;
	
	// If route is subscribe, it will remove existing noty and returns. If there is not existy nagger noty, it will just return
	if(Current_Route == "subscribe" || Current_Route == "subscribe-plan" || Current_Route == "purchase-plan")
	{
		if(Nagger_Noty)
			$.noty.close(Nagger_Noty);
		return;
	}
	
	// If Noty is present already, then noty is initiated again
	if(Nagger_Noty && $("#" +Nagger_Noty).length > 0)
		return;
	
	
		// Show the first one after 3 secs
	showNotyPopUp("warning", get_random_message(), "topCenter", "none", function(){
			Nagger_Noty = null;
			Backbone.history.navigate('subscribe', {
				 trigger : true
				 });
		});
}

var CONTACTS_HARD_RELOAD = false;

/**
 * Shows noty popup for bulk actions like bulk contacts deletion, 
 * adding bulk contacts to campaign etc.
 * 
 * @param type - 
 *             type of noty. For e.g. noty of information type is blue.
 * @param message -
 *             message to be shown on noty.
 * @param position -
 *             position of noty like bottomRight, top etc.            
 *                     
 */
function bulkActivitiesNoty(type, message, position) {
	CONTACTS_HARD_RELOAD = true;
	
	// if no position, default bottomRight
	if(!position)
	{
		showNotyPopUp(type, message.message, "bottomRight")
		return;
	}
		
	// shows noty in given position
	showNotyPopUp(type, message.message, position)
}

/**
 * Loads files required for noty and calls notySetup to show 
 * noty with the given options.
 *
 * @param type - 
 *             type of noty. For e.g. noty of information type is blue.
 * @param message -
 *             message to be shown on noty.
 * @param position -
 *             position of noty like bottomRight, top etc.
 */
function showNotyPopUp(type, message, position, timeout, clickCallback) {
	if(type != 'null' && message !=  'null'){
		// for top position
		if(position == "top")
			head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH
			+ 'lib/noty/layouts/top.js', LIB_PATH
			+ 'lib/noty/themes/default.js', function(){
				notySetup(type, message, position, timeout, clickCallback)
			});
		
		//for topCenter position
		if(position == "topCenter")
			head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH
					+ 'lib/noty/layouts/topCenter.js', LIB_PATH
					+ 'lib/noty/themes/default.js', function(){
				          notySetup(type,message,position,timeout,clickCallback)
			});
		
		// for bottomRight position
		if(position == "bottomRight")
			head.js(LIB_PATH + 'lib/noty/jquery.noty.js',  LIB_PATH
					+ 'lib/noty/layouts/bottom.js', LIB_PATH
					+ 'lib/noty/layouts/bottomRight.js', LIB_PATH
					+ 'lib/noty/themes/default.js', function(){
						notySetup(type, message, position, timeout, clickCallback)
					});
		
		// for bottomLeft position
		if(position == "bottomLeft")
			head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH
					+ 'lib/noty/layouts/bottomLeft.js', LIB_PATH
					+ 'lib/noty/themes/default.js', function(){
							notySetup(type, message, position, timeout, clickCallback)
					});	
		
		//for bottomCenter position
		if(position == "bottomCenter")
			head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH
					+ 'lib/noty/layouts/bottomCenter.js', LIB_PATH
					+ 'lib/noty/themes/default.js', function(){
				          notySetup(type,message,position,timeout,clickCallback)
			});

		//for topCenter position
		if(position == "topCenter")
			head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH
					+ 'lib/noty/layouts/topCenter.js', LIB_PATH
					+ 'lib/noty/themes/default.js', function(){
				          notySetup(type,message,position,timeout,clickCallback)
			});
		
		// for bottomLeft position
		if(position == "bottom")
			head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH + 'lib/noty/layouts/bottom.js', LIB_PATH
					+ 'lib/noty/themes/default.js', function(){
							notySetup(type, message, position, timeout, clickCallback)
					});	
	}
}

/**
 * Sets noty popup to show message in the given position and type.
 * 
 * @param type - 
 *             type of noty. For e.g. noty of information type is blue.
 * @param message -
 *             message to be shown on noty.
 * @param position -
 *             position of noty like bottomRight, top etc.*/
function notySetup(type, message, position, noty_timeout, clickCallback) {
		
	    // close all other noty before showing current
	    $.noty.closeAll()

		var n = noty({
			text : message,
			layout : position,
			type : type,
			animation : {
				open : {
					height : 'toggle'
				},
				close : {
					height : 'toggle'
				},
				easing : 'swing',
				speed : 500
				// opening & closing animation speed
			},
			
			timeout : noty_timeout != undefined ? (noty_timeout == "none" ? undefined : noty_timeout) : 20000, // delay for closing event. Set false for sticky
							// notifications
					
		});
	    
	    if(clickCallback && typeof clickCallback == "function" && n.options.id)
	    {
	    	Nagger_Noty = n.options.id;
	    	$("#" + n.options.id).on('click', function(e){
	    		clickCallback();
	    	})
	    }
	}

function get_random_message() {
	
	
/*	var trail_expiry_message;
	if(getPendingdaysIntrail() == 0)
		trail_expiry_message = "Your trail expired";
	else
		trail_expiry_message = "Your trial will expire in "+getPendingdaysIntrail()+" days";*/
	
	
	var messages = ["You are using FREE limited version of Agile CRM. <span> Upgrade Now </span> "];

	var random = Math.floor((Math.random() * messages.length));
	// console.log(random + messages[random]);

	return messages[random];
}

var TRAIL_PENDING_DAYS;
var _TRAIL_DAYS = 14; 

function getPendingdaysIntrail()
{
	if(TRAIL_PENDING_DAYS)
		return TRAIL_PENDING_DAYS;
	
	if(!_billing_restriction || !_billing_restriction.createdtime)
		return (TRAIL_PENDING_DAYS = 14)
		
	var time = (new Date().getTime()/1000) - _billing_restriction.createdtime;
	
	var days = time / (24 * 60 *60)
	
	var TRAIL_PENDING_DAYS = _TRAIL_DAYS - days;
	
	if(TRAIL_PENDING_DAYS < 0)
	{
		TRAIL_PENDING_DAYS = 0;
	}
	
	TRAIL_PENDING_DAYS = Math.round(TRAIL_PENDING_DAYS);
	return TRAIL_PENDING_DAYS;
}$(function(){
	
	$("body_removed_event").on("click", "#track_visitors", function(e) {
		e.preventDefault();
		$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/CWMelsl70H4" frameborder="0" allowfullscreen></iframe></p>');
	});
	$("body_removed_event").on("click", "#sync_new_signups", function(e) {
		e.preventDefault();
		$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/CWMelsl70H4" frameborder="0" allowfullscreen></iframe></p>');
	});
	$("body_removed_event").on("click", "#automate_email", function(e) {
		e.preventDefault();
		$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/RXOqougExkM" frameborder="0" allowfullscreen></iframe></p>');
	});
	$("body_removed_event").on("click", "#app_messages_popups", function(e) {
		e.preventDefault();
		$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/XGouq0B_7G8" frameborder="0" allowfullscreen></iframe></p>');
	});
	
});/**
 * Defines a JSON of content to be shown in the respective route when collection
 * is empty. The content respective to each route is used to fill the slate
 * template which is shown when collection is empty, called from
 * base_collection.
 * 
 * Each current route key contacts title, description, learn_more, button_text,
 * route, modal_id, image
 * 
 * <P>
 * "KEY SHOULD BE CURRENT ROUTE"
 * </p>
 */
var CONTENT_JSON = {
	"contacts" : {
		"title" : "You do not have any contacts currently.",
		"description" : "Contacts are your customers or prospects that you interact with using Agile.",
		//"learn_more" : "click here to learn more",
		"button_text" : "Add Contacts",
		"route" : "#",
		"modal_id" : "personModal",
		"image" : "/img/clipboard.png"
	},
	"filter_results" : {
		"title" : "No contacts matching this criteria.",
		//"learn_more" : "click here to learn more",
		//"button_text" : "Add Contacts",
		"route" : "#",
		//"modal_id" : "personModal",
		"image" : "/img/clipboard.png"
	},
	"filter_results_companies" : {
		"title" : "No companies matching this criteria.",
		//"learn_more" : "click here to learn more",
		//"button_text" : "Add Contacts",
		"route" : "#",
		//"modal_id" : "personModal",
		"image" : "/img/clipboard.png"
	},
	"tag_results" : {
		"title" : "No contacts available with this tag.",
		//"learn_more" : "click here to learn more",
		//"button_text" : "Add Contacts",
		"route" : "#",
		//"modal_id" : "personModal",
		"image" : "/img/clipboard.png"
	},
	"companies" : {
		"title" : "You do not have any companies currently.",
		"description" : "companies are prospects that you interact with using Agile.",
		//"learn_more" : "click here to learn more",
		"button_text" : "Add Companies",
		"route" : "#",
		"modal_id" : "companyModal",
		"image" : "/img/clipboard.png"
	},
	"workflows" : {
		"title" : "You do not have any Campaigns currently.",
		"description" : "Campaign or workflow is an intelligent sales and marketing automation process for sending your contacts relevant information at the right time.",
		//"learn_more" : "click here to learn more",
		"button_text" : "Add Campaign",
		"route" : "#workflow-templates",
		"image" : "/img/clipboard.png"
	},
	"deals" : {
		"title" : "No deals found.",
		"description" : "You either do not have any deals currently, or there are none matching the filter conditions. <br/>Deals are sales opportunities you track continuously throughout its lifecycle.",
		//"learn_more" : "click here to learn more",
		"button_text" : "Add Deal",
		"route" : "#",
		"modal_id" : "opportunityModal",
		"image" : "/img/clipboard.png"
	},
	"reports" : {
		"title" : "You do not have any reports currently.",
		"description" : "Reports are based on a variety of tags and filters and receive them periodically to constantly be in touch with your sales cycle and pipeline.",
		//"learn_more" : "click here to learn more",
		"button_text" : "Add Report",
		"route" : "#report-add",
		"image" : "/img/clipboard.png"
	},
	"activity-reports" : {
		"title" : "You do not have any activity reports currently.",
		"description" : "Get a periodic  email digest of various activities by users in Agile.",
		//"learn_more" : "click here to learn more",
		"button_text" : "Add Report",
		"route" : "#activity-report-add",
		"image" : "/img/clipboard.png"
	},
	"contact-filters" : {
		"title" : "You do not have any filters currently.",
		"description" : "Filters are used to sort contacts with a specific criteria to find patterns.",
		//"learn_more" : "click here to learn more",
		"button_text" : "Add Filter",
		"route" : "#contact-filter-add",
		"image" : "/img/clipboard.png"
	},
	"contact-views": {
		"title" : "You do not have any custom views currently.",
		"description" : "View is collection of different fields and the order in which you would like them to appear.",
		//"learn_more" : "click here to learn more",
		"button_text" : "Add View",
		"route" : "#contact-view-add",
		"image" : "/img/clipboard.png"
	},
	"dashboard" : {
		"contacts" : {
			"title" : "There is no recent activity",
			"description" : "Perhaps, you may want to create a <a href='#' modal_id='personModal' class='modal-form'>new contact</a>.",
			"icon" : "icon-group icon-3x"
		},
		"tasks" : {
			"title" : "You have no tasks due",
			"icon" : "icon-edit icon-3x"
		},
		"deals" : {
			"title" : "No ongoing deals for you",
			"icon" : "icon-money icon-3x"
		},
		"workflows" : {
			"title" : "No campaign activity yet",
			"description" : "Campaigns help you automate your communication with your customers.<br/>You can create a <a href='#workflow-add'>new campaign</a>.",
			"icon" : "icon-sitemap icon-3x"
		}
	},
	"email-templates" : {
		"title" : "You do not have any Email templates currently.",
		"description" : "Personalize and customize email templates for every scenario in the sales cycle.",
		"button_text" : "Add Email Template",
		"route" : "#email-template-add",
		"image" : "/img/clipboard.png"
	},
	"contact-activities" : {
		"title" : "No Contact activity recorded yet.",
		"description" : "Web and Campaign activity of your contacts is shown here.",
		"image" : "/img/clipboard.png"
	},
	"contact-activities/All_Activities" : {
		"title" : "No Contact activity recorded yet.",
		"description" : "Web and Campaign activity of your contacts is shown here.",
		"image" : "/img/clipboard.png"
	},
	"contact-activities/Page_Views" : {
		"title" : "No web activity recorded yet.",
		"image" : "/img/clipboard.png"
	},
	"contact-activities/Email_Opened" : {
		"title" : "No email opens recorded yet.",
		"image" : "/img/clipboard.png"
	},
	"contact-activities/Email_Clicked" : {
		"title" : "No email clicks recorded yet.",
		"image" : "/img/clipboard.png"
	},
	"contact-activities/Unsubscribed" : {
		"title" : "No unsubscriptions recorded yet.",
		"image" : "/img/clipboard.png"
	},
	"contact-activities/Spam_Reports" : {
		"title" : "No spam reports recorded yet.",
		"image" : "/img/clipboard.png"
	},
	"contact-activities/Email_Hard_Bounced" : {
		"title" : "No hard bouces recorded yet.",
		"image" : "/img/clipboard.png"
	},
	"contact-activities/Email_Soft_Bounced" : {
		"title" : "No soft bounces recorded yet.",
		"image" : "/img/clipboard.png"
	},
	"webpages" : {
		"title" : "You do not have any Webpages currently.",
		"description" : "You can create a page easily by using our smart builder.",
		"button_text" : "Add Webpage",
		"route" : "#webpage-add",
		"image" : "/img/clipboard.png"
	}
	/*"web-rules" : {/All_Activities
		
		"title" : "Engage visitors on website",
		"description" : "Define web rules and enagage your website visitors with smart popups, or perform automatic actions when contacts do (or don't do) something in your application or website. Checkout the <a href='https://github.com/agilecrm/agile-popups'>documentation</a>",
		"button_text" : "Add Web Rule",
		"route" : "#webrules-add",
		"image" : "/img/clipboard.png"
	}*/
	
};

/**
 * Fills the slate with the content respective to the current route in the
 * CONTENT_JSON
 */
function fill_slate(id, el, key) {
	var route_path = key;
	
	if(!route_path)
	{
		route_path = window.location.hash.split("#")[1];
	}

	// If content for current route is available in the CONTENT_JSON, slate
	// template is made with the content related to current route
	if (CONTENT_JSON[route_path]){

		var template_name = "", json = {};

		if((route_path == "contacts") && readCookie('company_filter')){
			template_name = "empty-collection-model";
			json = CONTENT_JSON["companies"];
		} 	
		else if((route_path == "filter_results") && company_util.isCompany()){
			template_name = "empty-collection-model";
			json = CONTENT_JSON["filter_results_companies"];
		}
			
		else{
			template_name = "empty-collection-model";
			json = CONTENT_JSON[route_path];
		}
		
		getTemplate(template_name, json, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$("#" + id, el).html($(template_ui));	
		}, $("#" + id, el));
		
	}
}

function getContactPadcontentKey(url)
{
	if(!url)
		return;
	
	if(url.indexOf('tag') > 0)
		return "tag_results";
	
	if(url.indexOf('filter') > 0)
		return "filter_results";
	
	return "contacts";
		
}

function getCompanyPadcontentKey(url)
{
	if(!url)
		return;
	
	if(url.indexOf('tag') > 0)
		return "tag_results";
	
	if(url.indexOf('filter') > 0)
		return "filter_results";
	
	return "companies";
		
}

/**
 * Show modal if add entity form is modal, it is used for contacts (adding new contact)
 */
$(function() {
	
	// Show activity modal
	$("body").on("click", ".modal-form", function(e) {
		e.preventDefault();
		var id = $(this).attr('modal_id');
		if(id == "opportunityModal")
			show_deal();
		else
			$("#" + id).modal('show');
	});
});/**
 * Global variable 'Is_Profile_Guider_Closed' is used to check whether user has
 * closed noty bar.
 */
var Is_Profile_Guider_Closed = false;

/*
 * Global values of each step.
 */
var Profile_Settings = {
	"Email" : "",
// "User_invited" : "#users",
// "Widgets" : 10
// "Share" : "#",
}

/**
 * Holds messages to be shown on each step ex: welcome, configuring email,
 * inviting users, sharing
 */
var Profile_Setup_Messages = {};

Profile_Setup_Messages.Welcome = "Welcome to Agile - the next generation CRM. I will be your tour guide.<a href='#' id='noty-welcome-user' style='text-decoration: none;'> Let's get you started."
Profile_Setup_Messages.Email = "Shake Hands. <a href='#email' style='text-decoration: none;'> Let's sync your emails first</a>. It's simple and secure.";
Profile_Setup_Messages.User_invited = "Emails will show up in the awesome timeline. It's time to invite your colleague";
Profile_Setup_Messages.Share = "Are you liking Agile? Spread the love.";

// Initial percentage after first time login
var Initial_Total = 65;

var Profile_Info = {
	"Welcome" : false,
	"Email" : false,
	// "User_invited" : false,
	// "Widgets" : false,
	"total" : Initial_Total
};

// Calculate based on tags added in 'OUR' domain
function calculate_profile() {

	// Get tags from global contact fetched from 'OUR' domain.
	var tags = Agile_Contact.tags;

	// If tags are not empty then return profile_info with basic information
	if (!tags || tags.length == 0)
		return Profile_Info;

	// Gets the initial count to calculate completed percentage (Percentage is
	// not show now)
	var total = Initial_Total;

	// Check to show welcome message or not
	var is_first_time_user = true;

	// Iterates thought each field in Profile_Settings and finds whether tag is
	// available in contact
	$.each(Profile_Settings, function(key, value) {
		// Replaces "_" with space, that is how tag is saved in 'our' domain
		var temp_key = key.indexOf("_") != -1 ? key.replace("_", " ") : key;

		// Checks if tag is available in contact. Sets true in JSON object if
		// tag is available, which indicates that step can be excluded from
		// showing in noty.
		if (tags.indexOf(temp_key) != -1) {
			Profile_Info[key] = true;

			// Calculates complete percentage
			total = total + value;
			is_first_time_user = false;
			return;
		}
	});

	// If user has tags (email, user invited etc) then welcome message is not
	// shown
	if (!is_first_time_user)
		Profile_Info["Welcome"] = !is_first_time_user;

	// Assigns percentage completeness or profile
	Profile_Info["total"] = total;

	return Profile_Info

}

function set_profile_noty() {

}

/**
 * Sets up noty message to be shown. It iterates though profile stats calculated
 * in calculate_profile() method and creates noty template with appropriate
 * message
 */
function set_profile_noty1() {
	console.log(Agile_Contact);
	if (jQuery.isEmptyObject(Agile_Contact))
		return;

	// Gets profile stats
	var profile_stats = calculate_profile();

	// Removes noty before building
	remove_profile_noty();

	$.each(profile_stats, function(key, value) {
		console.log(profile_stats);
		// If value is false, then noty is built with that respective message
		if (value == false) {
			var json = {};
			json.message = Profile_Setup_Messages[key];
			json.route = Profile_Settings[key];
			show_noty_on_top_of_panel(json);
			return false;
		}
	});

}

/**
 * Show noty and arranges home dashbord to adjust accordingly
 * 
 * @param content
 */
function show_noty_on_top_of_panel(content) {
	if (Is_Profile_Guider_Closed)
		return;

	$('body').find('#wrap').find('#notify-container').remove();
	$('body').find('#wrap').find('.navbar-fixed-top').css('margin-top', '0px');
	$('body').find('#wrap').find('#agilecrm-container').css('padding-top',
			'60px');

	$('body').find('#wrap').find('#notify-container').remove();
	
	getTemplate("sticky-noty", content, undefined, function(template_ui){
		if(!template_ui)
			  return;
		$('body').find('#wrap').prepend($(template_ui));
		$('body').find('#wrap').find('.navbar-fixed-top').css('margin-top', '34px');
		$('body').find('#wrap').find('#agilecrm-container').css('padding-top',
				'96px');

	}, null);
}

/**
 * Removes noty and re-arranges the navbar layout by removing 60px padding which
 * is added to show naoty
 */
function remove_profile_noty() {
	$('body').find('#wrap').find('#notify-container').remove();
	$('body').find('#wrap').find('.navbar-fixed-top').css('margin-top', '0px');
	$('body').find('#wrap').find('#agilecrm-container').css('padding-top',
			'60px');
}

$(function() {
	/**
	 * User can exlicitly disable noty in current session. Along with removing
	 * the noty a flag is set, which is checked before showing noty
	 */
	$("#content").on("click", "span.notify-close", function(e) {
				// Flat which indicates user has disables
				Is_Profile_Guider_Closed = true;
				$(this).parent().slideUp(
						"slow",
						function() {
							$('body').find('#wrap').find('.navbar-fixed-top')
									.css('margin-top', '0px');
							$('body').find('#wrap').find('#agilecrm-container')
									.css('padding-top', '60px');
						});
			});

	/**
	 * Removes welcome message and shows next step
	 */
	 $("#content").on("click", "#noty-welcome-user", function(e) {
		e.preventDefault();
		delete Profile_Info["Welcome"];
		set_profile_noty();

	})
});
/**
 * Creates Pubnub object and subscribe client channel as well as publish on
 * agile_CRM_Channel.
 * 
 */
function initToPubNub(callback)
{
	//console.log(Pubnub);
	// Pubnub already defined.
	if(Pubnub != undefined)
	 if (Pubnub != null){
		 if(callback)
			 callback();
	 	 return;
}

	// Pubnub not defined.
	var protocol = 'https';

	head.js(protocol + '://pubnub.a.ssl.fastly.net/pubnub-3.4.min.js', function()
	{
		// CREATE A PUBNUB OBJECT
		Pubnub = PUBNUB.init({ 'publish_key' : 'pub-c-e4c8fdc2-40b1-443d-8bb0-2a9c8facd274', 'subscribe_key' : 'sub-c-118f8482-92c3-11e2-9b69-12313f022c90',
			ssl : true, origin : 'pubsub.pubnub.com', });
		// Get compatibility with all browsers.
		// Pubnub.ready();

		// Subscribe to client channel. Receive tweet from social server.
		subscribeClientChannel(callback);
	});
}

/**
 * Subscribe client channel.
 */
function subscribeClientChannel(callback)
{
	Pubnub.subscribe({ channel : CURRENT_DOMAIN_USER.id + "_Channel", restore : true, message : function(message, env, channel)
	{
		//console.log(message);

		// Display message in stream.
			if((message || {}).type  == "BRIA_CALL"){
				showBriaCallNoty(message);
				return;
		}
		handleMessage(message);

	}, // RECEIVED A MESSAGE.
	presence : function(message, env, channel)
	{
		console.log(message);
	}, // OTHER USERS JOIN/LEFT CHANNEL.
	connect : function()
	{
		console.log("Agile crm Connected");
		Pubnub.is_connected_call = true;
		
		if(callback)
			callback();
	
	}, // CONNECTION ESTABLISHED.
	disconnect : function(channel)
	{
		console.log(channel + " Disconnected");
	}, // LOST CONNECTION (OFFLINE).
	reconnect : function(channel)
	{
		console.log(channel + " Reconnected")
	}, // CONNECTION BACK ONLINE!
	error : function(channel)
	{
		console.log(channel + " Network Error")
	}, });
}

/**
 * Publish message (action of user) on agile_crm_Channel.
 */
function sendMessage(publishJSON)
{
	console.log("publish_message publishJSON: ");
	console.log(publishJSON);

	// Message to publish is empty.
	if (publishJSON == null)
		return;

	// Message has data.
	Pubnub.publish({ channel : "agile_crm_Channel", message : publishJSON, callback : function(info)
	{
		if (info[0])
			console.log("publish_message Successfully Sent!");
		else
		// The internet is gone. // TRY SENDING AGAIN!
		{
			console.log("publish_message unsuccessfull to Sent!");
			showNotyPopUp('information', "You are not connected with Twitter server or you have problem with connection!", "top", 5000);
			displayErrorInStream(publishJSON.stream);
			
			// How many streams are register.			
			Register_Counter++;
			
			// Register next stream.
			registerAll(Register_Counter);
			
			// sendMessage(publishJSON);
		}
	} });
}
function initializeRegenerateKeysListeners() {
    $(".prettyprint").css({
            "padding": "0px",
            "border": "none"
    });

    $("#api_key_code").off('click').on("click", "#api_key_generate_icon", function(e) {
        e.preventDefault();
        regenerate_api_key('core/api/api-key/key');
    });
    $("#jsapi_key_code").off('click').on("click", "#jsapi_key_generate_icon", function(e) {
        e.preventDefault();
        regenerate_api_key('core/api/api-key/jskey');
    });
}

function update_admin_settings_api_key_template(){
	$.ajax({
		url : 'core/api/api-key',
		type : 'GET',
		dataType : 'json', 
		success : function(data){

			getTemplate("admin-settings-api-key-model", data, undefined, function(template_ui){
				if(!template_ui)
					  return;

				$("#admin-prefs-tabs-content").html($(template_ui));
				 prettify_api_add_events();
			}, null);
		}
	})
}

function regenerate_api_key(url) {
    if (confirm("Resetting the API Key will break all existing integrations you may have setup using the current key. Are you sure you want to reset the API key?")) {
        $.ajax({
            url: url,
            type: 'POST',
            success: function() {
                update_admin_settings_api_key_template();
            }
        })
    } else return;
}

function prettify_api_add_events() {
    prettyPrint();

    initializeRegenerateKeysListeners();
    $("#update_allowed_domains").off('click');
    $("#update_allowed_domains").on('click', function(e) {
        e.preventDefault();
        $(this).attr("disabled", "disabled");
        var allowed_domains = get_allowed_domains();
        var new_allowed_domain = $("#new_allowed_domain").val();
        if (!new_allowed_domain || is_duplicate_allowed_domain(new_allowed_domain, allowed_domains)) {
            $(this).removeAttr("disabled");
            return;
        }
        allowed_domains = allowed_domains ? allowed_domains + ", " + new_allowed_domain : new_allowed_domain;
        put_allowed_domains(allowed_domains);
    });

    $(".allowed-domain-delete").off('click');
    $(".allowed-domain-delete").on('click', function(e) {
        e.preventDefault();
        $(this).closest("tr").remove();
        var allowed_domains = get_allowed_domains();
        put_allowed_domains(allowed_domains);
    });

    $("#update_blocked_ips").off('click');
    $("#update_blocked_ips").on('click', function(e) {
        e.preventDefault();
        $(this).attr("disabled", "disabled");
        var blocked_ips = get_blocked_ips();
        var new_blocked_ip = $("#new_blocked_ip").val();
        if (!new_blocked_ip || is_duplicate_blocked_ip(new_blocked_ip, blocked_ips) || !is_valid_ip(new_blocked_ip)) {
            $(this).removeAttr("disabled");
            return;
        }
        blocked_ips = blocked_ips ? blocked_ips + ", " + new_blocked_ip : new_blocked_ip;
        put_blocked_ips(blocked_ips);
    });

    $(".blocked-ip-delete").off('click');
    $(".blocked-ip-delete").on('click', function(e) {
        e.preventDefault();
        $(this).closest("tr").remove();
        var blocked_ips = get_blocked_ips();
        put_blocked_ips(blocked_ips);
    });
    try {
        if (ACCOUNT_PREFS.plan.plan_type.split("_")[0] == "PRO")
            $("#tracking-webrules, .tracking-webrules-tab").hide();
        else
            $("#tracking-webrules-whitelist, .tracking-webrules-whitelist-tab").hide();
    } catch (e) {
        $("#tracking-webrules-whitelist, .tracking-webrules-whitelist-tab").hide();
    }
}var businessHoursManager;



function initializeOnlineCalendarListners(el){
	
	 $("#online-cal-listners").off();
	 
	 $("#online-cal-listners #btnSerialize").off("click");
	 $("#online-cal-listners").on("click","#btnSerialize", function(e){
			e.preventDefault();

			var saveBtn = $(this);
			disable_save_button($(saveBtn));
			if (!$.trim($("#15mins").val()) && !$.trim($("#30mins").val()) && !$.trim($("#60mins").val()))
			{
				enable_save_button($(saveBtn));
				$('#meeting_duration_message').fadeIn('slow');
				setTimeout(function()
				{
					$('#meeting_duration_message').fadeOut('slow');
				}, 5000);
				return;
			}

			if ($("#15mins").val().charCodeAt(0) == ' ' && $("#30mins").val().charCodeAt(0) == ' ' && $("#60mins").val().charCodeAt(0) == ' ')
			{
				enable_save_button($(saveBtn));
				$('#meeting_duration_message').fadeIn('slow');
				setTimeout(function()
				{
					$('#meeting_duration_message').fadeOut('slow');
				}, 5000);
				return;
			}
			var data = $('#scheduleurl').text();
			var scheduling_id = data.substr(data.lastIndexOf("/") + 1);
			var url = data.substr(0, data.lastIndexOf("/") + 1);
			var json = serializeForm("scheduleform");
			var meeting_durations = formToJSON();
			console.log(meeting_durations);

			var business_hours = JSON.stringify(businessHoursManager.serialize());

				json['business_hours'] = business_hours;
				json['meeting_durations'] = meeting_durations;
				json['schedule_id'] = scheduling_id;
				json['bufferTime'] = $("#bufferTime").val();
				json['bufferTimeUnit'] = $("#bufferTimeUnit").val();
				json['user_calendar_title']=$(".online_summer_note").code();
				console.log(business_hours);

			// $("#schedule-preferences").html(getRandomLoadingImg());
				$.ajax({ url : '/core/api/scheduleprefs', type : 'PUT', contentType : 'application/json', data : JSON.stringify(json),
					success : function()
					{
						setTimeout(function()
						{
							enable_save_button($(saveBtn));
						}, 2000);
						$('#error_message').empty();
					}, error : function(error)
					{
						$('#error_message').html("There was an error in saving your settings. Please try again in a minute.");
						enable_save_button($(saveBtn));
						
					} });
		});

$("#online-cal-listners #edit-schedule-id").off("click");
$("#online-cal-listners").on("click","#edit-schedule-id", function(e){
					e.preventDefault();
					var data = $('#scheduleurl').text();
					var scheduling_id = data.substr(data.lastIndexOf("/") + 1);
					var url = data.substr(0, data.lastIndexOf("/") + 1);
					console.log(url + "   " + scheduling_id);
					$("#edit").hide();
					$("#scheduleurl").removeAttr("href");
					$('#scheduleurl')
							.html(
									url + "<input class='input-sm inline-block form-control' style='width:140px' type='text'  name='url' id='url' value='" + scheduling_id + "'/><buttion class='btn btn-primary btn-sm inline-block m-l-sm' id='save-scheduleurl'>Save</button>");

					$("#scheduleurl").addClass("nounderline");
					$('#scheduleModal').data('modal', null);

				});

$("#online-cal-listners #save-scheduleurl").off("click");
$("#online-cal-listners").on("click","#save-scheduleurl", function(e){
			e.preventDefault();
			var data = $("#url").val();
			if (data.length < 4)
			{
				$('#charlength').fadeIn('slow');
				setTimeout(function()
				{
					$('#charlength').fadeOut('slow');
				}, 2000);
				return;
			}

			var regex = /^[0-9a-zA-Z\_]+$/
			if (!(regex.test(data)))
			{
				$('#specialchar').fadeIn('slow');
				setTimeout(function()
				{
					$('#specialchar').fadeOut('slow');
				}, 2000);
				return;
			}

			var saveBtn = $(this);
			disable_save_button($(saveBtn));
			$.ajax({
				url : '/core/api/scheduleprefs/updateId?scheduleid=' + data + '&domainId=' + CURRENT_DOMAIN_USER.id,
				type : 'GET',
				datatype : "json",
				success : function(user)
				{
					var onlineschedulingURL = "https://" + CURRENT_DOMAIN_USER.domain + ".agilecrm.com/calendar/" + user.schedule_id;
					$("#scheduleurl").attr("href", onlineschedulingURL);
					$("#scheduleurl").text(onlineschedulingURL);

					$("#scheduleurl").removeClass("nounderline");
					enable_save_button($(saveBtn));
					$("#edit").show();
					$("#specialchar").hide();
					$("#charlength").hide();
					$("#scheduleurl").removeClass("nounderline");

				},
				error : function(error)
				{

					console.log(error);
					$('#schedule_error_message').html(
							'Something went wrong as your schedule url was not updated. Please try again in few hours. Error: ' + error.statusText);
					$('#schedule_error_message').fadeIn('slow');
					setTimeout(function()
					{
						$('#schedule_error_message').fadeOut('slow');
					}, 2000);
					enable_save_button($(saveBtn));
					return;
				} });

		});
	
	$("#online-cal-listners #calendar_advanced").off("click");
	$("#online-cal-listners").on("click","#calendar_advanced", function(e)
	{
		e.preventDefault();
		$("#calendar_advanced span i").toggleClass("fa-minus");
		$("#calendar_advanced span i").toggleClass("fa-plus");

	});

	$("#online-cal-listners #calendar_advanced_block").off("shown");
	$("#online-cal-listners").on("shown","#calendar_advanced_block", function(e)
	{
		$('#calendar_advanced').html('<span><i class="icon-minus"></i></span> Advanced');

	});

	$("#online-cal-listners #calendar_advanced_block").off("hidden");
	$("#online-cal-listners").on("hidden","#calendar_advanced_block", function(e)
	{
		$('#calendar_advanced').html('<span><i class="icon-plus"></i></span> Advanced');
	});

	$("#online-cal-listners #bufferTime").off("keypress");
	$("#online-cal-listners").on("keypress","#bufferTime", function(e){
		// if the letter is not digit then display error and don't type anything
		if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57))
		{
			// display error message
			$("#errmsg").html("Digits Only").show().fadeOut(3000);
			return false;
		}
	});

	$("#online-cal-listners .onlineCalendarAddToSite").off("click");
	$("#online-cal-listners").on("click",".onlineCalendarAddToSite", function(e)
	{
		e.preventDefault();

        console.log("asadfas");

        $("body #onlineCalendarAddToSite").remove();

		getTemplate('online-calendar-addtosite', {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			onlineCalendarModel = $(template_ui);
			onlineCalendarModel.modal('show');	
		}, null);	

	});
/*
     $("#online-cal-listners a[href='#calendar-tab']").unbind("click");
	 $('#online-cal-listners a[href="#calendar-tab"]').on('click', function(e) {
			e.preventDefault();
			$(el).find('#calendar-tab').html(LOADING_ON_CURSOR);
			online_calendar_tabs.loadScheduleUrlTab(el);
	  });
	 $("#online-cal-listners a[href='#businesshours-tab']").unbind("click");
	$('#online-cal-listners a[href="#businesshours-tab"]').on('click', function(e) {
		e.preventDefault();
		$(el).find('#businesshours-tab').html(LOADING_ON_CURSOR);
		online_calendar_tabs.loadBusinessHoursTab(el);
	  });
	 $("#online-cal-listners a[href='#meeting-types-tab']").unbind("click");
	$('#online-cal-listners a[href="#meeting-types-tab"]').on('click', function(e) {
		e.preventDefault();
		$(el).find('#meeting-types-tab').html(LOADING_ON_CURSOR);
		online_calendar_tabs.loadMeetingtypesTab(el);
	  });
	$("#online-cal-listners a[href='#advanced-tab']").unbind("click");
	$('#online-cal-listners a[href="#advanced-tab"]').on('click', function(e) {
		e.preventDefault();
		$(el).find('#advanced-tab').html(LOADING_ON_CURSOR);
		online_calendar_tabs.loadAdvancedTab(el);
	  });*/


	// $("#onlineCalendarAddToSite .getStartedToAddToSite").off("click");	
}

$("body").on("click",".getStartedToAddToSite", function(e)
		{

			e.preventDefault();
			Backbone.history.navigate("webrules-add", { trigger : true });
			if (onlineCalendarModel)
				onlineCalendarModel.modal('hide');
			onlineCalendarModel = null;

			getHtmlContent(function(html_content)
			{
				setTimeout(function()
				{
					tinyMCECallBack("tinyMCEhtml_email", html_content);
				}, 1000);
			});

		});


function getHtmlContent(callback)
{
	$.get("/misc/modal-templates/schedule/popout/pop-out.html", function(data)
	{
		return callback(data);
	});
}

/**
 * meeting duration form will be serialized manually becoz to trim spaces
 * 
 * @returns serialized meeting duration form.
 */

function formToJSON()
{
	return JSON.stringify({ "15mins" : $('#15mins').val().trim(), "30mins" : $('#30mins').val().trim(), "60mins" : $('#60mins').val().trim() });
}
/**
 * sound.js plays sounds within the browser. It uses HTML5 Audio to play sounds.
 * @param sound - sound name.
 **/
// Global variable to use in twilio.js
audio = null;

function play_sound(sound, is_web_url)
{
	var sound_url;

	if(sound)
		sound_url = '../res/' + sound + '.mp3';
	else
		sound_url = '../res/sound.wav';
	
	if(is_web_url)
		sound_url = sound
	try
	{
		// If browser supports html5 audio
		audio = new Audio(sound_url);
		audio.play();
	}
	catch (err)
	{
		console.log("Error occured while playing sound " + err);
	}
}


/**
 * Set image URL in tinymce upload editor
 * @param url
 */
function setTinyMCEImageUploadURL(url){
	
	var elem = $(".mce-abs-layout").find("input")[0];
    $(elem).val(url).trigger("change");
    
}/**
 * TinyMCE is a platform independent web based Javascript HTML WYSIWYG editor.
 * TinyMCE has the ability to convert HTML TEXTAREA fields or other HTML
 * elements to editor instances.
 * 
 * @author Naresh
 */

var CONTACT_CUSTOM_FIELDS = undefined;

/**
 * Sets up tinymce HTML Editor on given selector
 * 
 * @param selector -
 *            id of HTML element e.g., textarea#email-body
 * 
 */
function setupTinyMCEEditor(selector, noAgileContactFields, plugins, callback)
{
	
	// Id undefined
	if (selector === undefined)
	{
		console.log("selector is undefined...");
		return;
	}
	
	// Show loading image instead of textarea
	$('#loading-editor').html(getRandomLoadingImg());
	
	var toolbar_2 = "bullist numlist | outdent indent blockquote | forecolor backcolor | merge_fields | preview | code";
	
	// Remove Agile Contact fields button
	if(noAgileContactFields)
		toolbar_2 = "bullist numlist | outdent indent blockquote | forecolor backcolor | preview | code";
	
	var default_plugins = ["textcolor link image preview code fullpage"];
	
	// If no plugins, assign default
	if(!plugins)
		plugins = default_plugins;
	
	// Init tinymce first time
	if (typeof (tinymce) === "undefined")
	{
		head.js('/js/designer/tinymce/tinymce.min.js', function()
		{
			get_custom_fields(function(data){

				// If loading src script fails
				if(typeof (tinymce) === "undefined")
				{
					console.log("Reloading script...");
					
					// Show confirmation for reload
					if(confirm("Unable to load editor. Click OK to Reload."))
					  location.reload();
					
					return;
				}
				
				// Show textarea and remove loading img
				$(selector).css('display', '');
				$('#loading-editor').html("");
				
				tinymce.init({ mode : "exact", selector : selector, plugins : plugins,
				    menubar : false,
					toolbar1 : "bold italic underline | alignleft aligncenter alignright alignjustify | link image | formatselect | fontselect | fontsizeselect",
					toolbar2 : toolbar_2, valid_elements : "*[*]",
					toolbar_items_size: 'small',
					browser_spellcheck : true,
					relative_urls : false,
					convert_urls : false,
			        gecko_spellcheck: true,
			        forced_root_block : false,
					extended_valid_elements : "*[*]", setup : function(editor)
					{
						editor.addButton('merge_fields', { type : 'menubutton', text : 'Agile Contact Fields', icon : false, menu : set_up_merge_fields(editor) });
					}
					});
				
				// callback after tinymce initialised
		    	setTimeout(function(){
		    		if(callback != undefined && typeof (callback) === "function")
		    		callback();
		    		},500);

			});

			
		});
    	
		return;
	}

	// if tinymce instance exists, reinitialize tinymce on given selector
	if (selector.indexOf('#') !== -1)
		selector = selector.split('#')[1];

	// Add custom toolbar
	tinymce.settings.toolbar2 = toolbar_2;
	
	// Add required plugins
	tinymce.settings.plugins = plugins;
	
	// reinitialize tinymce
	reinitialize_tinymce_editor_instance(selector, callback);
		
}

/**
 * Sets given content in tinymce.
 * 
 * @param selector -
 *            id of an element without '#' e.g., email-body
 * @param content -
 *            content to be inserted
 * 
 */
function set_tinymce_content(selector, content)
{
	try
	{
		if(typeof (tinymce) !== "undefined")
		{
			tinymce.get(selector).setContent(content);
		}
	}
	catch (err)
	{
		console.log("error occured while setting content...");
		console.log(err);
	}
}

/**
 * Saves tinymce content back to textarea.
 * 
 * @param selector -
 *            id of an element without '#'
 */
function save_content_to_textarea(selector)
{
	try
	{
		if(typeof (tinymce) !== "undefined")
			tinymce.get(selector).save();
	}
	catch (err)
	{
		console.log("error occured while saving content to textarea...");
		console.log(err)
	}
}

/**
 * 
 * Triggers all tinymce editors save. It is used in base-modal to save
 * content back to textarea before form serialization.
 * 
 **/
function trigger_tinymce_save()
{
	try
	{
		if(typeof (tinymce) !== "undefined")
			tinymce.triggerSave();
	}
	catch(err)
	{
		console.log("error occured while triggering tiny save...");
		console.log(err);
	}
}
/**
 * Re-initialize HTML Editor on given selector using existing tinymce.
 * 
 * @param selector -
 *            id of an element without '#'
 */
function reinitialize_tinymce_editor_instance(selector, callback)
{
	try
	{
		// Calling duplicate instances won't setup tinymce. So remove previous
		// instance
		remove_tinymce_editor_instance(selector);

		// Surrounded within timeout to work in Firefox
	    setTimeout(function(){

	    	// Show textarea and remove loading img
	    	$('#loading-editor').html("");
	    	$('#'+ selector).css('display', '');
			
	    	tinymce.EditorManager.execCommand('mceAddEditor', true, selector);
	    	
	    	// callback after tinymce re-initialised
	    	if(callback != undefined && typeof (callback) === "function")
	    		callback();
	    		
	    	// Show hidden tinymce
	    	$('.mce-tinymce').css('display', '');

	    }, 100);
	
	}
	catch (err)
	{
		console.log("error occured while reinitializing tinymce...");
		console.log(err)
	}
}

/**
 * Removes tinymce instance on given selector
 * 
 * @param selector -
 *            id of an element without '#'
 */
function remove_tinymce_editor_instance(selector)
{
	try
	{
		// Removes all tinymce editors 
		for(var i=0; i < tinymce.editors.length; i++)
		{
			tinyMCE.remove(tinyMCE.editors[i]);
		}
		
		//tinymce.EditorManager.execCommand("mceRemoveEditor", false, selector);
	}
	catch (err)
	{
		console.log("error occured while removing tinymce editor instance...");
		console.log(err);
	}

}

/**
 * Set up merge fields as menu button in Editor
 * 
 * @param editor -
 *            editor instance
 */
function set_up_merge_fields(editor)
{
	var menu = [];

	var contact_json;

	// Get Current Contact json for merge fields
	if (App_Contacts.contactDetailView != undefined && App_Contacts.contactDetailView.model != undefined)
		contact_json = get_contact_json_for_merge_fields();

	// Iterates over merge fields and builds merge fields menu
	$.each(get_merge_fields(), function(key, value)
	{

		var menu_item = {};

		menu_item["text"] = key;
		menu_item["onclick"] = function()
		{

			// Insert value without compiling
			if (Current_Route === "bulk-email" || Current_Route === "send-email" || Current_Route.indexOf('email-template') != -1)
			{
				editor.insertContent(value);
			}
			else
			{
				var template = Handlebars.compile(value);
				var compiled_template;

				try
				{
					compiled_template = template(contact_json);
				}
				catch(err)
				{
					console.log("error.....");
					
					// Handlebars need [] if json keys have spaces
					value = '{{['+key+']}}';
					
					template = Handlebars.compile(value);
					compiled_template = template(contact_json);
				}
				
				editor.insertContent(compiled_template + '');
			}
		};

		menu.push(menu_item);

	});

	return menu;
}

/**
 * Returns merge fields that includes custom fields
 * 
 */
function get_merge_fields()
{
	var options = {
	"First Name": "{{first_name}}",
	"Last Name": "{{last_name}}",
	"Score": "{{score}}",
	"Email": "{{email}}",
	"Company": "{{company}}",
	"Title": "{{title}}",
	"Address": "{{location.address}}",
	"City": "{{location.city}}",
	"State":"{{location.state}}",
	"Country":"{{location.country}}",
	"Owner Name":"{{owner.name}}",
	"Owner Email":"{{owner.email}}", 
	"Calendar URL":"{{owner.calendar_url}}"
	
	}

	// Get Custom Fields in template format
	var custom_fields = get_custom_merge_fields();

	// Merges options json and custom fields json
	var merged_json = merge_jsons({}, options, custom_fields);

	return merged_json;
}

/**
 * Returns custom fields data in JSON
 */
function get_custom_fields(callback)
{
	// If already fetched, return
	if(CONTACT_CUSTOM_FIELDS != undefined){
		if(callback)
			  return callback(CONTACT_CUSTOM_FIELDS)

		return CONTACT_CUSTOM_FIELDS;
	}
		
	
	// Sends GET request for customfields.
	accessUrlUsingAjax('/core/api/custom-fields/scope?scope=CONTACT', function(data){

		// Parse stringify json
		CONTACT_CUSTOM_FIELDS = data;
		
		if(callback)
			  return callback(CONTACT_CUSTOM_FIELDS)

		return CONTACT_CUSTOM_FIELDS;

	});

}

/**
 * Returns custom fields in format required for merge fields. E.g., Nick
 * Name:{{[Nick Name]}}. Handlebars need to have square brackets for json keys
 * having space
 */
function get_custom_merge_fields()
{
	var customfields = {};

	// Iterate over data and get field labels of each custom field
	$.each(get_custom_fields(), function(index, obj)
	{
		customfields[obj['field_label']] = "{{" + obj['field_label'] + "}}"
	});

	return customfields;
}
/**
 * Returns merged json of two json objects
 */
function merge_jsons(target, object1, object2)
{
	return $.extend(target, object1, object2);
}


/**
 * Returns json required for merge fields in Editor
 */
function get_contact_json_for_merge_fields()
{
	// Compile templates immediately in Send email but not for bulk contacts
	if (App_Contacts.contactDetailView != undefined && App_Contacts.contactDetailView.model != undefined)
	{

		// Get Current Contact
		var contact_json = App_Contacts.contactDetailView.model.toJSON();
		var contact_property_json = get_property_JSON(contact_json);
		
		try
		{
			contact_property_json["score"]= contact_json["lead_score"];
			
			// Replace epoch times with formatted date values in property json
			var arr = get_custom_field_labels_by_type(get_custom_fields(), 'DATE');
			
			// Format each epochtime to Date
			for(var i in arr)
				contact_property_json[arr[i]]= get_formatted_date(contact_property_json[arr[i]]);
			
			contact_property_json["id"] = contact_json["id"];
			
			if(contact_property_json["address"])
				contact_property_json["location"] = JSON.parse(contact_property_json["address"]);
		}
		catch(err)
		{
			console.log("Error occured while parsing json");
			console.log(err);
		}
		
		return merge_jsons({}, {"owner":contact_json.owner}, contact_property_json);
		
	}  
}

/**
 * Replaces {{}} with {{[]}} to allow spaces in keys
 * 
 * @param text - text to replace
 * 
 **/
function add_square_brackets_to_merge_fields(text)
{
	// Matches all strings within {{}}. e.g., {{first_name}}, {{New Note}}
	var t = text.match(/{{[a-zA-Z0-9 ]*[a-zA-Z0-9 ]}}/g);
	
	if(t)
	{
		// Change {{New Note}}  to {{[New Note]}}. 
		// Handlebars allow keys having spaces, 
		// within square brackets
		for(var i=0; i < t.length;i++)
		{
			text = text.replace(t[i], '{{['+t[i].match(/{{(.*?)}}/)[1]+']}}');
		}
	};
	
	return text;
}

/**
 * Returns array of custom field labels that matches
 * with given field_type
 * 
 * @param custom_data - Custom fields
 * 
 * @param field_type - field type
 **/
function get_custom_field_labels_by_type(custom_data, field_type)
{
	var field_labels = [];
	
	// Iterate over data and get field labels of each custom field
	$.each(custom_data, function(index, obj)
	{
		
		if(obj['field_type'] == field_type)
			field_labels.push(obj['field_label']);
		
	});
	
	return field_labels;
}

/**
 * Returns formatted date from epoch time
 * 
 * @param epoch_time - Epoch time in milliseconds
 *                     
 **/
function get_formatted_date(epoch_time, format)
{
	if (!epoch_time)
	    return;

	var d = undefined;
	
	if ((epoch_time / 100000000000) > 1)
	   d = new Date(parseInt(epoch_time));
	else
	   d = new Date(parseInt(epoch_time) * 1000);
	
	var month_names = new Array("Jan", "Feb", "Mar", 
			"Apr", "May", "Jun", "Jul", "Aug", "Sep", 
			"Oct", "Nov", "Dec");

	var date = d.getDate();
	var month = d.getMonth();
	var year = d.getFullYear();
	
	return date + " " + month_names[month] 
			+ " " + year;
}

function register_focus_on_tinymce(selector)
{
	var document = $("iframe#"+selector+"_ifr").contents()[0];
	
	if(!document)
		return;
	
	$(document).on('click', function(e){
		
		e.preventDefault();
		
		$(this).find('body').focus();
		
	});
}

$(function(){ 

	$("body").on('click', ".upload_s3", function(e){
		e.preventDefault();
		uploadImage("upload-container");
	});

	//Upload contact image
	$("body").on('click', ".upload_pic", function(e){
		e.preventDefault();
		uploadImage("contact-container");
	});
	
	//Upload personal prefs
	$("body").on('click', ".upload_prefs_s3", function(e){
		e.preventDefault();
		uploadImage("upload-in-modal");
	});
	
});	

function uploadImage(id)
{
	var newwindow = window.open("upload-flatfull.jsp?id=" + id,'name','height=310,width=500');
	if (window.focus)
	{
		newwindow.focus();
	}
	return false;
}

function setImageURLInModal(url)
{
	var id = "upload-in-modal";
	// Set the media stream
	$('#' + id).find('.imgholder').html('');
	$('#' + id).find('.imgholder').html('<img class="m-b-none avatar-thumb" src="' + url + '" style="height:58px;width:58px;"/>');
	
	var  modalId = $('#' + id).closest(".modal").attr("id");
	
	// Set the value of selector for input
	$("#" + modalId).find(".modal-body input[type='hidden']").val(url);
	
	$("#" + modalId).closest('.modal').modal('hide');
	$("#" + modalId).trigger('choose-image');
	
}

function setImageURL(url)
{
	var id = "upload-container";
	// Set the media stream
	$('#' + id).find('.imgholder').html('');
	$('#' + id).find('.imgholder').html('<img class="w-full" src="' + url + '"/>');
	
	// Set the value of selector for input
	$('#' + id).find('#upload_url').val(url);
}

//Saving contact image
function setContactImageURL(url)
{
	var id = "contact-container";
	// Set the media stream
	$('#' + id).find('.imgholder').html('');
	$('#' + id).find('.imgholder').html('<img src="' + url + '" height="50" width="50"/>');
	
	// Set the value of selector for input
	$('#' + id).find('#upload_url').val(url);
	agile_crm_update_contact("image", url);
}
/**
 * Loading spinner shown while loading
 */
var LOADING_HTML = '<img class="loading" style="padding-right:5px;opacity:0.5;" src= "/img/ajax-loader-cursor.gif"></img>';

/**
 * Set of loading images
 */
LOADING_HTML_IMAGES = [
	LOADING_HTML
]

/**
 * Loading images shown which contacts are being fetched on page scroll
 */
var LOADING_ON_CURSOR = '<img class="loading" style="padding-right:5px" src= "img/ajax-loader-cursor.gif"></img>';

/**
 * Default image shown for contacts if image is not available
 */

var DEFAULT_GRAVATAR_url = window.location.origin + "/" + FLAT_FULL_PATH + "images/user-default.jpg";

var ONBOARDING_SCHEDULE_URL = "https://our.agilecrm.com/calendar/Haaris_Farooqi,Sandeep";

var SALES_SCHEDULE_URL = "https://our.agilecrm.com/calendar/Shravi_Sharma,stephen";

var SUPPORT_SCHEDULE_URL = "https://our.agilecrm.com/calendar/Raja_Shekar,Natesh,Abhishek_Pandey";

var CALENDAR_WEEK_START_DAY = CURRENT_USER_PREFS.calendar_wk_start_day;
/**
 * Returns random loading images
 * 
 * @returns
 */
function getRandomLoadingImg()
{
	var length = LOADING_HTML_IMAGES.length;
	return LOADING_HTML_IMAGES[Math.round(Math.random() * (LOADING_HTML_IMAGES.length - 1))]
}

// Read a page's GET URL variables and return them as an associative array.
function getUrlVars()
{
	var vars = [], hash;
	var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
	for (var i = 0; i < hashes.length; i++)
	{
		hash = hashes[i].split('=');
		vars.push(hash[0]);
		vars[hash[0]] = hash[1];
	}

	return vars;
}

/**
 * Creates a select fields with the options fetched from the url specified,
 * fetches the collection from the url and creates a select element and appends
 * to the selectId sent, it takes the template to fill the values and also takes
 * a callback to deserialize the select field if form is being edited
 * 
 * @param selectId
 *            to append the options
 * @param url
 *            To fetch collection
 * @param parseKey
 *            parses the collection
 * @param callback
 *            to process select field after being created
 * @param template
 *            Template to create options
 */
function fillSelect(selectId, url, parseKey, callback, template, isUlDropdown, el, defaultSelectOption)
{
	// Fetch Collection from URL
	var collection_def = Backbone.Collection.extend({ url : url,
	/*
	 * parse : function(response) {
	 * 
	 * if (response && response[parseKey]) return response[parseKey];
	 * 
	 * return response; }
	 */
	});

	// Prepend Loading
	$loading = '<img class="loading" style="padding-right:5px;opacity:0.5;" src= "../img/ajax-loader-cursor.gif"></img>';
	if ($("#" + selectId, el).next().hasClass("select-loading"))
		$("#" + selectId, el).next().html($loading);
	else
		$("#" + selectId, el).after($loading);
	// Creates a collection and fetches the data from the url set in collection
	var collection = new collection_def();

	// On successful fetch of collection loading symbol is removed and options
	// template is populated and appended in the selectId sent to the function
	collection.fetch({ success : function()
	{

		// Remove loading
		if ($("#" + selectId, el).next().hasClass("select-loading"))
			$("#" + selectId, el).next().html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
		else
			$("#" + selectId, el).next().remove();

		// Delete prev options if any by verifying whether ul drop down or
		// select drop down
		if (isUlDropdown)
			$("#" + selectId, el).empty();
		else
		{
			if (!defaultSelectOption)
				defaultSelectOption = "Select...";

			$("#" + selectId, el).empty().append('<option class="default-select" value="">' + defaultSelectOption + '</option>');
		}
		var data = collection.toJSON();
		data.sort(function(a, b)
		{
			if (a.name < b.name)
				return -1;
			if (b.name < a.name)
				return 1;
			return 0;
		});
		// Convert template into HTML
		var modelTemplate = Handlebars.compile(template);
		// Iterates though each model in the collection and
		// populates the template using handlebars
		$.each(data, function(index, model)
		{
			var optionsHTML = modelTemplate(model);
			$("#" + selectId, el).append(optionsHTML);
		});

		// If callback is present, it is called to deserialize
		// the select field
		if (callback && typeof (callback) === "function")
		{
			// execute the callback, passing parameters as
			// necessary
			callback();
		}
	}

	});
}

// Fill selects with tokenized data
/**
 * fillTokenizedSelect if similar to fillSelect, but data is not fetched it is
 * sent to the function which creates options based on the array of values sent.
 * It also includes callback function to deseriazlie
 * 
 * @param selectId
 *            to To append options
 * @param array
 *            list of values to be used to create options
 * @param callback
 *            function to be called after select if created
 */
function fillTokenizedSelect(selectId, array, callback, defaultSelectOption)
{
	if (!defaultSelectOption)
		defaultSelectOption = "Select...";

	$("#" + selectId).empty().append('<option value="">' + defaultSelectOption + '</option>');

	// Iterates though each element in array and creates a options to select
	// field and
	// appends to the id sent
	$.each(array, function(index, element)
	{
		$("#" + selectId).append('<option value=' + '"' + element + '">' + element + '</option>');
	});

	// If callback exists it is called after select field is created
	if (callback && typeof (callback) === "function")
	{
		// execute the callback, passing parameters as necessary
		callback();
	}
}

/**
 * Fills milestore in to dorpdown
 * 
 * @param ulId
 * @param array
 */
function fillMilestones(ulId, array)
{
	$("#" + ulId).empty();
	$.each(array, function(index, element)
	{
		$("#" + ulId).append('<a href="#"><li value=' + '"' + element + '">' + element + '</li></a>');
	});
}
function btnDropDown(contact_id, workflow_id)
{

}

/**
 * Removes the specified property from the contact
 */
function delete_contact_property(contact, propertyName)
{

	// Iterates through the properties of the contact, finds the property with
	// the name specified and removes the property from the contact
	for (var index = 0; index < contact.properties.length; index++)
	{
		if (contact.properties[index].name == propertyName)
		{
			contact.properties.splice(index, 1);
			--index;
		}
	}
	return contact;
}

// Delete contact tag
/**
 * Removes a tag from the contact, tag name is to be specified to remove the tag
 */
function delete_contact_tag(contact, tagName)
{

	// Iterates though tags in the contact and removes the tag which matches the
	// tag name parameter of the function
	$.each(contact.tagsWithTime, function(index, tagObject)
	{
		if (tagObject.tag == tagName)
		{
			// Tag should be removed from tags also,
			// or deleted tag will be added again
			contact.tags.splice(index, 1);
			contact.tagsWithTime.splice(index, 1);
			return false;
		}
		contact.tags.push(tagObject.tag);
	});

	return contact;
}

/**
 * Adds a new tag to contact
 */
function add_contact_tags(contact, newTags)
{
	for (var index = 0; index < newTags.length; index++)
	{
		contact.tags.push(newTags[index])
	}
	return contact;
}

/**
 * Creates a property json object
 * 
 * @param name
 * @param id
 * @param type
 */
function property_JSON(name, id, type)
{
	var json = {};

	if (type == undefined)
		json.type = "SYSTEM";
	else
		json.type = type;

	json.name = name;

	var elem = $('#' + id), elem_type = elem.attr('type'), elem_value;

	if (elem_type == 'checkbox')
		elem_value = elem.is(':checked') ? 'on' : 'off';
	else
		elem_value = elem.val();

	json.value = elem_value;
	return json;
}

// Sends post request using backbone model to given url. It is a generic
// function, can be called to save entity to database
function saveEntity(object, url, callback, errorCallback)
{
	var model = new Backbone.Model();
	model.url = url;
	model.save(object, { success : function(data)
	{
		if (callback && typeof (callback) === "function")
		{
			// execute the callback, passing parameters as necessary
			callback(data);
		}
	}, error: function(model,response){
			console.log(response);
			if(errorCallback)
   			errorCallback(model,response);
   		}});
}

/**
 * Returns GMT time.
 * 
 * @param date
 * @returns
 */
function getGMTEpochFromDate(date)
{
	var current_sys_date = new Date();
	console.log(new Date().getHours());
	console.log(new Date().getMinutes());
	console.log(new Date().getSeconds());
	console.log(date.getYear() + "," + date.getMonth() + "," + date.getDate())
	date = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);

	// Adding offset to date returns GMT time
	return date.getTime() + (date.getTimezoneOffset() * 60 * 1000);
}

/**
 * Returns local epoch time based form GMT time
 * 
 * @param time_in_milliseconds
 * @returns {Number}
 */
function getLocalTimeFromGMTMilliseconds(time_in_milliseconds)
{
	var date = new Date(parseInt(time_in_milliseconds));

	// Subtracting epoch offset from epoch time;
	return date.getTime() - (date.getTimezoneOffset() * 60 * 1000);
}

function showTextGravatar(selector, element)
{
	var el = $(selector, $(element));
	$(el).closest('img').error(function()
	{
		var name = $(this).attr("_data-name");

		if (!name)
			return;

		$(this).attr("data-name", name);
		$(this).initial({ charCount : 2 });
	});
}

function text_gravatar_initials(items)
{
	if (items == undefined)
		return;

	var name = "";

	var first_name;
	var last_name;

	var name = "";

	if (getPropertyValue(items, "first_name"))
	{

		first_name = getPropertyValue(items, "first_name");

	}

	if (getPropertyValue(items, "last_name"))
	{
		last_name = getPropertyValue(items, "last_name");
	}

	if (first_name && last_name)
	{
		name = first_name.substr(0, 1);
		name += last_name.substr(0, 1);
	}
	else
	{
		if (first_name)
		{
			var first_name_length = first_name.length;
			if (first_name_length > 1)
				name = first_name.substr(0, 2);
			else
				name = first_name.substr(0, 1);
		}
		else if (last_name)
		{
			var last_name_length = last_name.length;
			if (last_name_length > 1)
				name = last_name.substr(0, 2);
			else
				name = last_name.substr(0, 1);
		}
	}
	if (name.length == 0)
	{
		var email = getPropertyValue(items, "email");
		if (email)
		{
			if (email.length > 1)
				name = email.substr(0, 2);
		}
	}

	if (name.length == 0)
		name = "X";

	return name;
}

function buildFacebookProfileURL(URL)
{
	URL = URL.replace('@', '');
	var hasScheme = (URL.indexOf('http://') === 0 || URL.indexOf('https://') === 0);
	var isFBURL = (URL.indexOf('facebook.com') !== -1);
	if (URL && !hasScheme && !isFBURL)
	{
		URL = 'https://www.facebook.com/' + URL;
	}
	else if (URL && isFBURL && URL.indexOf('www.facebook.com') === -1)
	{
		URL = URL.replace('facebook.com', 'www.facebook.com');
	}
	else if (URL && !hasScheme)
	{
		URL = 'http://' + URL;
	}
	return URL;
}

function visibleFilter()
{
	return $(this).css('display') != 'none';
}
function showTransitionBar()
{
	if ($('.butterbar').hasClass('hide'))
		$('.butterbar').removeClass('hide');
	if (!$('.butterbar').hasClass('animation-active'))
		$('.butterbar').addClass('animation-active');
}
function hideTransitionBar()
{
	setTimeout(function()
	{
		if ($('.butterbar').hasClass('animation-active'))
			$('.butterbar').removeClass('animation-active');
		if (!$('.butterbar').hasClass('hide'))
			$('.butterbar').addClass('hide');
	}, 10);
}
$('body').on('shown.bs.modal', '.modal:visible', function (e) 
{
	setTimeout(function()
	{
		if ($('.modal-backdrop', $('.modal:visible')).height() <= $('.modal-dialog', $('.modal:visible')).height())
			$('.modal-backdrop', $('.modal:visible')).height($('.modal-dialog', $('.modal:visible')).height() + 70);
	}, 500);
});
/**
 * Returns UTC mid night time.
 * 
 * @param date
 * @returns
 */
function getUTCMidNightEpochFromDate(date)
{
	date = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0));

	// returns UTC mid night time
	return date.getTime();
}

/*
 function to get the date in user selected format in useprefs page. Will take epoc time  as input
*/

function getDateInFormatFromEpoc(date)
{
	if(!date)
		return;
	if ((date / 100000000000) > 1)
	{1
		return en.dateFormatter({raw: getGlobalizeFormat()})(new Date(parseInt(date)));
	}
	return en.dateFormatter({raw: getGlobalizeFormat()})(new Date(parseInt(date) * 1000));

}

/*
 function to get the date in user selected format in useprefs page. Will takes date object as input
*/

function getDateInFormat(date)
{
	if(!date)
		return;
	return en.dateFormatter({raw: getGlobalizeFormat()})(date);

}

function getGlobalizeFormat()
{
	var format = CURRENT_USER_PREFS.dateFormat;
	
	if(format.search("MM") != -1)
		format = format.replace(/MM/g, "MMMM");
	else if(format.search("M") != -1)
		format = format.replace(/M/g, "MMM");
	if(format.search("DD") != -1)
		format = format.replace(/DD/g, "EEEE");
	else if(format.search("D") != -1)
		format = format.replace(/D/g, "EEE");
	format = format.replace(/m/g, "M");
	return format;
}


/* To convert UK formatted date to US formatted date
   ukDate should be in dd/mm/yyyy format
*/
function convertDateFromUKtoUS(ukDate)
{
	if(!ukDate)
		return "";
	var date;
	if(ukDate.search("/") != -1)
		date = ukDate.split("/");
	else
		date = ukDate.split(".");
	if(date.length == 3)
	{	
		var returnDate = new Date(date[1]+"/"+date[0]+"/"+date[2]);
		if(!/Invalid|NaN/.test(returnDate))
			return returnDate.format("mm/dd/yyyy");
		else
			return "";
	}
	else 
		return "";
}


/**
 * wysihtml.js is used to embed beautiful html editors to email body. Inserts
 * merge fields into email body. wysihtml makes use of wysihtml5 which is a
 * javascript plugin that makes it easy to create simple, beautiful wysiwyg
 * editors with the help of wysihtml5 and Twitter Bootstrap.
 */
function initializeEmailTemplateAddListeners(){

	// Code for Merge fields in Email Template
	$('#prefs-tabs-content').on('click', '.merge-field', function (e) {
				e.preventDefault();
				// console.log("Merge field");

				// Get Selected Value
				var fieldContent = $(this).attr("name");

				// Get Current HTML
				var val = $('#email-template-html').val();

				// Set New HTML
				var wysihtml5 = $('#email-template-html').data('wysihtml5');
				if (wysihtml5) {
					// console.log("Setting content ");
					// console.log(fieldContent);

					// wysihtml5.editor.setValue(fieldcontent + " " + val,
					// true);
				    editor.focus();
					wysihtml5.editor.composer.commands.exec("insertHTML", '{{'
							+ fieldContent + '}}');
				}
			});

	$('#prefs-tabs-content').on('click', '.add-attachment-select', function(e){
		e.preventDefault();
		var el = $(this).closest("div");
		$(this).css("display", "none");
		el.find(".attachment-document-select").css("display", "inline");
		var optionsTemplate = "<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}'>{{name}}</option>";
        fillSelect('attachment-select','core/api/documents', 'documents',  function fillNew()
		{
			el.find("#attachment-select option:first").after("<option value='new'>Upload new doc</option>");

		}, optionsTemplate, false, el);
        $('#enable_tracking').css("margin-top", "-7px");
	});
	
	/**
	 * For adding existing document to current contact
	 */
	$('#prefs-tabs-content').on('click', '.add-attachment-confirm', function(e){
		e.preventDefault();		
		var network_type = $('#attachment-select').find(":selected").attr('network_type');
		var document_size = $('#attachment-select').find(":selected").attr('size');
		if(typeof network_type !=='undefined' && network_type.toUpperCase() === 'GOOGLE')
		{
			$(this).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>Can not attach Google Drive doc to email. You can add a link instead in the email.</span>");
			$(this).css({'border': '1px solid #df382c','outline': 'none'   });				             	            
		}
		else if(document_size >= 5242880){
			$(this).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>Document size exceeds the 5MB limit.</span>");
			$(this).css({'border': '1px solid #df382c','outline': 'none'   });
		}
		else
		{
			$('#attachment-select').closest("span").find('.attachment-status').find("span").fadeOut(0);
			$('#attachment-select').css({"border":"1px solid #bbb"});
		    var document_id = $(this).closest(".attachment-document-select").find("#attachment-select").val();
		    var saveBtn = $(this);
			
	  		// To check whether the document is selected or not
		    if(document_id == "")
		    {
		    	saveBtn.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>This field is required.</span>");
		    	saveBtn.closest("span").find('span.save-status').find("span").fadeOut(5000);
		    	return;
		    }	    	
		    else if(document_id == "new")
		    {	
		    	e.preventDefault();
				$(this).closest('form').find('#error').html("");
				var form_id = $(this).closest('form').attr("id");
				var id = $(this).find("a").attr("id");
				
				var newwindow = window.open("upload-attachment.jsp?id="+ form_id +"&t=" + CURRENT_USER_PREFS.template +"&d=" + CURRENT_DOMAIN_USER.domain, 'name','height=310,width=500');
				
				if (window.focus)
				{
					newwindow.focus();
				}
		    }
		    else if(document_id != undefined && document_id != null)
		    {
		    	var docName = $( "#attachment-select option:selected").text();
		    	$('#emailForm').find('#eattachment').css('display','block');
		    	$('#emailForm').find('#attachment_id').find("#attachment_fname").text(docName);
		    	$('#emailForm').find(".attachment-document-select").css('display','none');
		    	$('#emailForm').find('#eattachment_key').attr('name',"document_key");
		    	$('#emailForm').find('#eattachment_key').attr('value',document_id);
		    }
	    }
		$('#enable_tracking').css("margin-top", "-47px");
	});
	
	/**
	 * To cancel the add attachment request in send-email form
	 */
	$('#prefs-tabs-content').on('click', '.add-attachment-cancel', function(e){
		e.preventDefault();
		var blobKey = $('#emailForm').find('#attachment_id').attr('name');
		if(typeof blobKey !== typeof undefined)
	    {
			if(blobKey.toLowerCase() === 'blob_key')
			{
				var blobKeyValue = $('#emailForm').find('#eattachment_key').attr("value");
				deleteBlob(blobKeyValue);
			}
	    }
		$('#attachment-select').closest("span").find('.attachment-status').find("span").fadeOut(0);
		$('#attachment-select').css({"border":"1px solid #bbb"});	 
		$('#attachment-select').find('option:first').attr('selected', 'selected');
		var el = $(this).closest("div");
		$('#emailForm').find('.attachment-document-select').css('display','none');
		$('#emailForm').find('#eattachment').css('display','none');
		$('#emailForm').find(".add-attachment-select").css("display", "inline");
		$('#emailForm').find('#eattachment_key').attr("name","name");
    	$('#emailForm').find('#eattachment_key').attr("value","value");
    	$('#enable_tracking').css("margin-top", "-7px");
	});

	$('#prefs-tabs-content').on("click", ".add-tpl-attachment-confirm", function(e){
		e.preventDefault();
		if($(this).parent().find('select').val()=="new"){
			$('#uploadDocumentModal').modal('show');
			$('#GOOGLE',$('#uploadDocumentModal')).parent().hide();
		}else if($(this).parent().find('select').val()!=""){
			$('#tpl-attachment-select').hide();
			$('#tpl-attachment-name').show();
			$('#attachment_id',$('#tpl-attachment-name')).val($(this).parent().find('select').val());
			//$('#tpl_attachment_fname',$('#tpl-attachment-name')).text($(this).parent().find('option:selected').text());
			$('#tpl_attachment_fname',$('#tpl-attachment-name')).html('<a href='+$(this).parent().find('option:selected').attr('url')+'>'+$(this).parent().find('option:selected').text()+'</a>');
		}else if($(this).parent().find('select').val()==""){
			$('#attachment-select-required').show();
		}
	});

	$('#prefs-tabs-content').on("click", ".add-tpl-attachment-cancel", function(e){
		e.preventDefault();
		$('#tpl-attachment-select').show();
		$('#tpl-attachment-name').hide();
		$('.add-attachment-select').show();
		$('.attachment-document-select').hide();
		$('#attachment_id',$('#tpl-attachment-name')).val("");
	});

	$('#prefs-tabs-content').on("change", "#attachment-select", function(e){
		e.preventDefault();
		if($(this).val()==""){
			$('#attachment-select-required').show();
		}else{
			$('#attachment-select-required').hide();
		}
	});

	$('#uploadDocumentModal').on('hidden.bs.modal', function(e){
		$('#GOOGLE',$('#uploadDocumentModal')).parent().show();
	});
}

/**
 * Sets HTML Editor for UserPrefs, EmailTemplates etc.
 **/
function setupHTMLEditor(selector, data) {
	head.js(LIB_PATH + 'lib/wysihtml5-0.3.0-min.js', LIB_PATH + 'lib/bootstrap-wysihtml5-min.js',
			function() {
				console.log('setting up text');
				console.log(selector.html());
				
				if(!$(selector).data('wysihtml5'))
					selector.wysihtml5();
				
				if(data)
					selector.data("wysihtml5").editor.setValue(data, false);
				
			});
}/**
 * Zoomifier code to show their template in send email template
 */
 function loadZoomifierDocSelector() {
	 var loggedInUser = CURRENT_DOMAIN_USER.email;
	 var selectedContact = getPropertyValue(App_Contacts.contactDetailView.model.attributes.properties, "email");
	 var picker = new Zoomifier.PickerBuilder().
				setPartnerKey('dwqs4rxjksqpldwqklnpes8hs=').
				setCallback(zoomifierDocSelectionCallback).
				setSalesUser(loggedInUser).
				setTargetCustomer(selectedContact).
				build();
  }
 
 /**
  * Appends the data or template fetched from zoomifier
  * @param data
  */
  function zoomifierDocSelectionCallback(data) {
		data = "</br>" + data + "</br>";
		//Fill html editor with template body
		var wysihtml5 = $('#body').data('wysihtml5');
		
		if(wysihtml5){
			editor.focus();
			wysihtml5.editor.composer.commands.exec("insertHTML",data);
		}
  }function hasScope(scope)
{
	var scopes = CURRENT_DOMAIN_USER.scopes;
	
	if(!scopes)
		return true;
	
	return jQuery.inArray(scope, scopes) > -1;
}


function showContactsImportAccessDeniedMessage(el)
{
   $(el).html("<h4>Access denied to sync contacts. Please contact Admin</h4>");	
}

function hasScope(scope_constant)
{
	return (CURRENT_DOMAIN_USER.scopes && $.inArray(scope_constant, CURRENT_DOMAIN_USER.scopes) != -1);
}

function canEditContacts()
{
	return hasScope("DELETE_CONTACTS");
}

function canEditContacts()
{
	return hasScope("VIEW_CONTACTS");
}

function canCreateContacts()
{
	return hasScope("CREATE_CONTACT");
}

function canImportContacts()
{
	if(!hasScope("CREATE_CONTACT"))
		return false; 
	return hasScope("IMPORT_CONTACTS");
}

function canExportContacts()
{
	return hasScope("EXPORT_CONTACTS");
}

function canEditContact(owner_id)
{
	if((hasScope('UPDATE_CONTACTS') || hasScope('DELETE_CONTACTS')) || CURRENT_DOMAIN_USER.id == owner_id)
		return true;
	
	return false;
}

function canEditCurrentContact()
{
	var contact_model = App_Contacts.contactDetailView.model;
	
	if(!contact_model)
		return;
	var contact = contact_model.toJSON();
	
	if(!contact.owner)
		return true;
	
	return canEditContact(contact.owner.id);
}

function canRunBulkOperations()
{
	if(!hasScope('VIEW_CONTACTS'))
		return true;
	
	if(!(hasScope('UPDATE_CONTACTS') || hasScope('DELETE_CONTACTS')))
		return false;
	
	return true;
}/**
 * To implement ACL for all the modules.
 */
(function(tight_acl, $, undefined) {
	
	//Contants to denote the permission
	tight_acl.DEAL_PER = false;
	tight_acl.REPORTS_PER = false;
	tight_acl.ACTIVITY_PER = false;
	var obj = {};

	/*
	 * Initialize the permissions when user changes the route using the menu scopes in the current domain user object.
	 */
	tight_acl.init_permissions = function(){

		if(!Current_Route)
			return;
		
		if(Current_Route.indexOf('deal') > -1 && !(CURRENT_DOMAIN_USER.menu_scopes.indexOf('DEALS') > -1))
			{
				obj.entity = 'Deals';
				tight_acl.DEAL_PER = true;
				App_ACL.notAllowed(obj);
			}
		if(Current_Route.indexOf('activit') > -1 && !(CURRENT_DOMAIN_USER.menu_scopes.indexOf('ACTIVITY') > -1))
		{
			obj.entity = 'Acivities';
			tight_acl.ACTIVITY_PER = true;
			App_ACL.notAllowed(obj);
		}
		if(Current_Route.indexOf('report') > -1 && !(CURRENT_DOMAIN_USER.menu_scopes.indexOf('REPORT') > -1))
		{
			obj.entity = 'Reports';
			tight_acl.REPORTS_PER = true;
			App_ACL.notAllowed(obj);
		}
		if((Current_Route.indexOf('web-rules') > -1 || Current_Route.indexOf('webrule') > -1) && !(CURRENT_DOMAIN_USER.menu_scopes.indexOf('WEBRULE') > -1))
		{
			obj.entity = 'Webrules';
			tight_acl.REPORTS_PER = true;
			App_ACL.notAllowed(obj);
		}
		
		if(Current_Route.indexOf('social') > -1 && !(CURRENT_DOMAIN_USER.menu_scopes.indexOf('SOCIAL') > -1))
		{
			obj.entity = 'Social';
			tight_acl.REPORTS_PER = true;
			App_ACL.notAllowed(obj);
		}
		
		if(Current_Route.indexOf('documents') > -1 && !(CURRENT_DOMAIN_USER.menu_scopes.indexOf('DOCUMENT') > -1))
		{
			obj.entity = 'Documents';
			tight_acl.REPORTS_PER = true;
			App_ACL.notAllowed(obj);
		}
		
		if(Current_Route.indexOf('cases') > -1 && !(CURRENT_DOMAIN_USER.menu_scopes.indexOf('CASES') > -1))
		{
			obj.entity = 'Cases';
			tight_acl.REPORTS_PER = true;
			App_ACL.notAllowed(obj);
		}
		
		if((Current_Route.indexOf('workflow') > -1 || Current_Route.indexOf('trigger') > -1) && !(CURRENT_DOMAIN_USER.menu_scopes.indexOf('CAMPAIGN') > -1))
		{
			obj.entity = 'Campaigns';
			tight_acl.REPORTS_PER = true;
			App_ACL.notAllowed(obj);
		}
	}
	
	/*
	 * Check the permission based up on the given scope.
	 */
	tight_acl.checkPermission = function(scope){
		return CURRENT_DOMAIN_USER.menu_scopes.indexOf(scope) > -1;
	}
}(window.tight_acl = window.tight_acl || {}, $));

(function(acl_util, $, undefined) {

	acl_util.canAddTag = function(tag,callback,errorCallback){
		
		if(CURRENT_DOMAIN_USER.is_admin || ACCOUNT_PREFS.tagsPermission){
			if(callback)
				callback(true);
			else
				return true;
			return;
		}
		
		if(tagsCollectionView){
			if(tag.indexOf('[') < 0){
				if(tagsCollectionView.collection.where({"tag":tag}).length == 0){
					alert("Tag '" + tag + "' does not exist. You don't have permissions to create a new Tag.");
					if(errorCallback)
						errorCallback("Tag '" + tag + "' does not exist. You don't have permissions to create a new Tag.");
				}
				else if(callback)
					callback(tagsCollectionView.collection.where({"tag":tag}).length > 0);
			} else {
				var tagArray = JSON.parse(tag);
				var newTags = '';
				$.each(tagArray,function(i,tagStr){
					if(tagsCollectionView.collection.where({"tag":tagStr}).length == 0)
						if(newTags.length == 0)
							newTags = tagStr;
						else
							newTags += ", "+tagStr;
				});
				
				if(newTags.length > 0){
					alert("Tag '" + newTags + "' does not exist. You don't have permissions to create a new Tag.");
					if(errorCallback)
						errorCallback("Tag '" + newTags + "' does not exist. You don't have permissions to create a new Tag.");
				}
				else if(callback)
					callback(true);
				
			}
		} else {
			$.ajax({
				url: 'core/api/tags/can_add_tag?tag='+tag,
				type: 'GET',
				success: function(result){
					if(callback)
						callback(result);
					else
						return result;
				}, error: function(response){
					alert(response.responseText);
					if(errorCallback)
						errorCallback(response.responseText);
				}
			});
		}
	};
	
	var setTagACL = function(el){
		if(ACCOUNT_PREFS){
			if(ACCOUNT_PREFS.tagsPermission)
				$('#new_tag_acl',el).attr('checked','checked');
		}else {
			$.ajax({ type : 'GET', url : '/core/api/account-prefs', async : false, dataType : 'json',
				success: function(data){
					
					if(isCheck)
						$('#new_tag_acl',el).attr('checked','checked');
				} });
		}
		
	};
	
	var updateTagAcl = function(isEnable){
		var input = {};
		input.is_enable = isEnable;
		queuePostRequest('tag_acl', "/core/api/account-prefs/allow-new-tag", input, function(){
			if(ACCOUNT_PREFS){
				ACCOUNT_PREFS.tagsPermission = isEnable;
			}
		}, function(){});
	};
	
	acl_util.initTagACL = function(el){
		$('#new_tag_acl',el).off('change').on('change',function(){
			updateTagAcl($(this).is(':checked'));
		});
		setTagACL(el);
	}
}(window.acl_util = window.acl_util || {}, $));
function initializeActivitiesListner(el){


	$("#activities-listners").off();
	// Click events to agents dropdown and department
	$("#activities-listners").on("click", "ul#user-select li a, ul#entity_type li a", function(e)
	{
		e.preventDefault();

		// Show selected name
		var name = $(this).html(), id = $(this).attr("href");

		$(this).closest("ul").data("selected_item", id);
		$(this).closest(".btn-group").find(".selected_name").text(name);
		var url = getActivityFilterParameters();

		renderActivityView(url);

	});
	$("#activities-listners").on("click", "ul#entity_type li a", function(e)
	{
		var entitytype = $(this).html();

		var entity_attribute = $(this).attr("href");

		buildActivityFilters(entitytype,entity_attribute,"entityDropDown");
		$('.activity-sub-heading').html(entitytype);

	});
	$("#activities-listners").on("click", "ul#user-select li a", function(e)
	{

		var user = $(this).html();
		var user_attribute = $(this).attr("href");

		buildActivityFilters(user,user_attribute,"userDropDown");

	});



	$("#activities-listners").on('click', '.activity-event-edit', function(e)
	{
	e.preventDefault();
	var data = $(this).closest('a').attr("data");

	var currentevent = getEventObject(data);

	update_event_activity(currentevent);

});



	$("#activities-listners").on('click', '.email-details', function(e) 
{
	e.preventDefault();
	var data = $(this).closest('a').attr("data");

	var obj = getActivityObject(data);
	console.log(obj);

	getTemplate("infoModal", JSON.parse(obj), undefined, function(template_ui){
		if(!template_ui)
			  return;
		var emailinfo = $(template_ui);
		emailinfo.modal('show');
	}, null);

});

}
function getDealObject(id)
{

	return $.ajax({ type : "GET", url : 'core/api/opportunity/' + id, async : true }).responseText;

}

function getEventObject(id)
{

	return $.ajax({ type : "GET", url : 'core/api/events/getEventObject/' + id, async : false }).responseText;

}

function getTaskObject(id)
{

	return $.ajax({ type : "GET", url : 'core/api/tasks/getTaskObject/' + id, async : false }).responseText;

}

function getNoteObject(id)
{

	return $.ajax({ type : "GET", url : 'core/api/notes/' + id, async : false }).responseText;

}

function getActivityObject(id)
{

	return $.ajax({ type : "GET", url : 'core/api/activitylog/' + id, async : false }).responseText;

}

function update_event_activity(ele)
{
	$("#updateActivityModal").html(getTemplate("update-activity-modal"));
	
	var value = JSON.parse(ele);
	deserializeForm(value, $("#updateActivityForm"));
	$("#updateActivityModal").modal('show');

	$('.update-start-timepicker').val(fillTimePicker(value.start));

	$('.update-end-timepicker').val(fillTimePicker(value.end));

	if (value.type == "WEB_APPOINTMENT" && parseInt(value.start) > parseInt(new Date().getTime() / 1000))
	{
		$("[id='event_delete']").attr("id", "delete_web_event");
		web_event_title = value.title;
		if (value.contacts.length > 0)
		{
			var firstname = getPropertyValue(value.contacts[0].properties, "first_name");
			if (firstname == undefined)
				firstname = "";
			var lastname = getPropertyValue(value.contacts[0].properties, "last_name");
			if (lastname == undefined)
				lastname = "";
			web_event_contact_name = firstname + " " + lastname;
		}
	}
	else
	{
		$("[id='delete_web_event']").attr("id", "event_delete");
	}
	if (value.description)
	{
		var description = '<label class="control-label"><b>Description </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="Add Description"></textarea></div>'
		$("#event_desc").html(description);
		$("textarea#description").val(value.description);
	}
	else
	{
		var desc = '<div class="row-fluid">' + '<div class="control-group form-group m-b-none">' + '<a href="#" id="add_event_desctiption"><i class="icon-plus"></i> Add Description </a>' + '<div class="controls event_discription hide">' + '<textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="Add Description"></textarea>' + '</div></div></div>'
		$("#event_desc").html(desc);
	}
	// Fills owner select element
	populateUsersInUpdateActivityModal(value);
}

function getModal()
{
	var activity_object = App_Activity_log.activitiesview.collection.models[this];
	alert(activity_object);
	console.log(activity_object);
}

function updateactivity__task(ele)
{
	var value = JSON.parse(ele);
	deserializeForm(value, $("#updateTaskForm"));
	$("#updateTaskModal").modal('show');
	// Fills owner select element
	populateUsers("owners-list", $("#updateTaskForm"), value, 'taskOwner', function(data)
	{
		$("#updateTaskForm").find("#owners-list").html(data);
		if (value.taskOwner)
		{
			$("#owners-list", $("#updateTaskForm")).find('option[value=' + value['taskOwner'].id + ']').attr("selected", "selected");
		}
		$("#owners-list", $("#updateTaskForm")).closest('div').find('.loading-img').hide();
	});

	// Add notes in task modal
	showNoteOnForm("updateTaskForm", value.notes);
}

function updatedeals(ele)
{

	var value = JSON.parse(ele);
	console.log(value);

	add_recent_view(new BaseModel(value));

	var dealForm = $("#opportunityUpdateForm");

	$("#opportunityUpdateForm")[0].reset();

	deserializeForm(value, $("#opportunityUpdateForm"));

	$("#opportunityUpdateModal").modal('show');

	// Call setupTypeAhead to get contacts
	agile_type_ahead("relates_to", dealForm, contacts_typeahead);

	// Fills owner select element
	populateUsers("owners-list", dealForm, value, 'owner', function(data)
	{
		dealForm.find("#owners-list").html(data);
		if (value.owner)
		{
			$("#owners-list", dealForm).find('option[value=' + value['owner'].id + ']').attr("selected", "selected");
			$("#owners-list", $("#opportunityUpdateForm")).closest('div').find('.loading-img').hide();
		}
	});

	// Fills the pipelines list in the select menu.
	populateTracks(dealForm, undefined, value, function(pipelinesList)
	{

		// Fills milestone select element
		populateMilestones(dealForm, undefined, value.pipeline_id, value, function(data)
		{
			dealForm.find("#milestone").html(data);
			if (value.milestone)
			{
				$("#milestone", dealForm).find('option[value=\"' + value.milestone + '\"]').attr("selected", "selected");
			}
			$("#milestone", dealForm).closest('div').find('.loading-img').hide();
		});
	});

	// Add notes in deal modal
	showNoteOnForm("opportunityUpdateForm", value.notes);

	add_custom_fields_to_form(value, function(data)
	{
		var el = show_custom_fields_helper(data["custom_fields"], []);
		// if(!value["custom_data"]) value["custom_data"] = [];
		$("#custom-field-deals", dealForm).html(fill_custom_fields_values_generic($(el), value["custom_data"]));

	}, "DEAL")
}

function get_activity_created_time(due)
{
	// Get Todays Date
	var date = new Date();
	date.setHours(0, 0, 0, 0);

	date = date.getTime() / 1000;
	// console.log("Today " + date + " Due " + due);
	return Math.floor((due - date) / (24 * 3600));
}

/**
 * 
 * Based on created date arranges the activities UI
 * 
 * @method append_tasks
 * @param {Object}
 *            base_model task model
 * 
 */
function append_activity_log(base_model)
{

	var itemView = new Base_List_View({ model : base_model, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'li', });

	// add to the right box - overdue, today, tomorrow etc.
	var createdtime = get_activity_created_time(base_model.get('time'));

	// Today
	if (createdtime == 0)
	{
		$('#earllier').show();
		$('#next-week-heading').addClass("ref-head");

		var heading = $('#today-heading', this.el);

		$('#today-activity', this.el).append(itemView.render().el);
		$('#today-activity', this.el).parent('table').css("display", "block");
		$('#today-activity', this.el).show();
		$('#today-heading', this.el).show();
	}

	if (createdtime == -1)
	{
		$('#earllier').show();
		$('#next-week-heading').addClass("ref-head");

		var heading = $('#tomorrow-heading', this.el);

		$('#tomorrow-activity', this.el).append(itemView.render().el);
		$('#tomorrow-activity', this.el).parent('table').css("display", "block");
		$('#tomorrow-activity', this.el).show();
		$('#tomorrow-heading', this.el).show();
	}
	if (createdtime < -1)
	{

		var heading = $('#next-week-heading', this.el);

		$('#next-week-activity', this.el).append(itemView.render().el);
		$('#next-week-activity', this.el).parent('table').css("display", "block");
		$('#next-week-activity', this.el).show();
		$('#next-week-heading', this.el).show();
	}

}

var ACTIVITY_FILTER="activity-filters-cookie";

var ACTIVITY_FILTER_JSON={};

function includeTimeAgo(element)
{
	head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
	{
		$("time", element).timeago();
	});
}


function buildActivityFilters(name,valueid,clickedFrom){
   
		if(clickedFrom=='entityDropDown'){
		ACTIVITY_FILTER_JSON.entity=name;
		ACTIVITY_FILTER_JSON.entityId=valueid;
		}
		else if(clickedFrom=='userDropDown'){
		ACTIVITY_FILTER_JSON.user=name;
		ACTIVITY_FILTER_JSON.userId=valueid;
		}

		createCookie(ACTIVITY_FILTER,JSON.stringify(ACTIVITY_FILTER_JSON));


}
/**
 * To show the dates or time in words of time-ago plugin.
 * 
 * @param element
 * 
 * 
 * 
 * updateData() method updates chat sessions on page for different query's from
 * user
 * 
 * @param params
 *            query string contains date, agentId & widgetId
 */
function renderActivityView(params)
{
	// Creates backbone collection view
	this.activitiesview = new Base_Collection_View({ url : '/core/api/activitylog/getActivitiesOnSelectedCondition' + params, sortKey : 'time',
		descending : true, templateKey : "activity-list-log", sort_collection : false, cursor : true, scroll_symbol : 'scroll', page_size : 20,
		individual_tag_name : 'li', postRenderCallback : function(el)
		{
			includeTimeAgo(el);
			initializeActivitiesListner(el);
			initializeEventListners(el);
		}, appendItemCallback : function(el)
		{
			includeTimeAgo(el);
		}

	});
	activitiesview.appendItem = append_activity_log;
	// Fetches data from server
	this.activitiesview.collection.fetch();

	// Renders data to activity list page.
	$('#activity-list-based-condition').html(this.activitiesview.render().el);

}

/**
 * getParameters() method returns a string(used as query param string) contains
 * user selected type and entity type
 * 
 * @returns {String} query string
 */
function getActivityFilterParameters(loadingFirstTime)
{
	var params = "?";

	var user =null;
	var entitytype=null;
	// Get Date Range
	var range = $('#activities_date_range #range').html().split("-");

	if (range)
	{
		//var start_time = Date.parse($.trim(range[0])).valueOf();
		//Get the GMT start time
		var start_time = getUTCMidNightEpochFromDate(new Date($.trim(range[0])));

		var end_value = $.trim(range[1]);

		// To make end value as end time of day
		if (end_value)
			end_value = end_value + " 23:59:59";

		// Returns milliseconds from end date.
		//var end_time = Date.parse(end_value).valueOf();
		var end_time = getUTCMidNightEpochFromDate(new Date(end_value));
		
		end_time += (((23*60*60)+(59*60)+59)*1000);

		// Adds start_time, end_time and timezone offset to params.
		params += ("start_time=" + start_time + "&end_time=" + end_time);
	}
	

	if(loadingFirstTime){
		var activityFilters=JSON.parse(readCookie(ACTIVITY_FILTER));
		if(activityFilters){
			user=activityFilters.userId;
			if(activityFilters.entityId)
				entitytype=activityFilters.entityId;
			else
				entitytype='ALL';
		}
		else{
			entitytype="ALL";
		}
		if(user)
		params += ("&user_id=" + user);
		params += ("&entity_type=" + entitytype);
		return params;
	}

	// Returns milliseconds from start date. For e.g., August 6, 2013 converts
	// to 1375727400000

	// Get task type and append it to params
	 user = $('#user-select').data("selected_item");

	 entitytype = $('#entity_type').data("selected_item");
	if (user)
		params += ("&user_id=" + user);
	// Get owner name and append it to params

	
	if (entitytype == 'TASK')
	{
		params += ("&entity_type=" + entitytype);
		return params;
	}

	else if (entitytype == 'DEAL')
	{
		params += ("&entity_type=" + entitytype);
		return params;
	}

	else if (entitytype == 'EVENT')
	{
		params += ("&entity_type=" + entitytype);
		return params;
	}
	else if (entitytype == 'CONTACT')
	{
		params += ("&entity_type=" + entitytype);
		return params;
	}
	else if (entitytype == 'DOCUMENT')
	{
		params += ("&entity_type=" + entitytype);
		return params;
	}
	else if (entitytype == 'CALL')
	{
		params += ("&entity_type=" + entitytype);
		return params;
	}
	else
	{
		params += ("&entity_type=ALL");
		return params;
	}

	return params;
}

function initActivitiesDateRange()
{
	$('#activities_date_range').daterangepicker({ ranges : { 'Today' : [
			'today', 'today'
	], 'Yesterday' : [
			'yesterday', 'yesterday'
	], 'Last 7 Days' : [
			Date.today().add({ days : -6 }), 'today'
	], 'Last 30 Days' : [
			Date.today().add({ days : -29 }), 'today'
	], 'This Month' : [
			Date.today().moveToFirstDayOfMonth(), Date.today().moveToLastDayOfMonth()
	], 'Last Month' : [
			Date.today().moveToFirstDayOfMonth().add({ months : -1 }), Date.today().moveToFirstDayOfMonth().add({ days : -1 })
	], 'This Quarter' : [
			Date.today().getMonth() < 3 ? new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth() : 
			(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth() :
			(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth() : new Date(Date.today().setMonth(9)).moveToFirstDayOfMonth(), 
			Date.today().getMonth() < 3 ? new Date(Date.today().setMonth(2).moveToLastDayOfMonth()) : 
			(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(5)).moveToLastDayOfMonth() :
			(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(8)).moveToLastDayOfMonth() : new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()
	], 'Last Quarter' : [
			Date.today().getMonth() < 3 ? new Date(Date.today().add({ years : -1 }).setMonth(9)).moveToFirstDayOfMonth() : 
			(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth() :
			(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth() : new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth(), 
			Date.today().getMonth() < 3 ? new Date(Date.today().add({ years : -1 }).setMonth(11)).moveToLastDayOfMonth() : 
			(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(2)).moveToLastDayOfMonth() :
			(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(5)).moveToLastDayOfMonth() : new Date(Date.today().setMonth(8)).moveToLastDayOfMonth()
	], 'This Year' : [
			new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth(), new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()
	], 'Last Year' : [
			new Date(Date.today().setMonth(0)).add({ years : -1 }).moveToFirstDayOfMonth(), new Date(Date.today().setMonth(11)).add({ years : -1 }).moveToLastDayOfMonth()
	] }, locale : { applyLabel : 'Apply', cancelLabel : 'Cancel', fromLabel : 'From', toLabel : 'To', customRangeLabel : 'Custom', daysOfWeek : [
			'Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'
	], monthNames : [
			'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'
	], firstDay : parseInt(CALENDAR_WEEK_START_DAY) } }, function(start, end)
	{
		if (start && end)
		{
			$('#activities_date_range #range').html(start.toString('MMMM d, yyyy') + ' - ' + end.toString('MMMM d, yyyy'));

			renderActivityView(getActivityFilterParameters());
		}
		else
		{
			var from_date = Date.parse('today');
			var to_date = Date.today().add({ days : parseInt(-6) });
			$('#activities_date_range #range').html(to_date.toString('MMMM d, yyyy') + " - " + from_date.toString('MMMM d, yyyy'));
			renderActivityView(getActivityFilterParameters);
			updateActivty(getActivityFilterParameters());
		}
	});
	$('.daterangepicker > .ranges > ul').on("click", "li", function(e)
	{
		$('.daterangepicker > .ranges > ul > li').each(function(){
			$(this).removeClass("active");
		});
		$(this).addClass("active");
	});
}// UI Handlers for activities - event & task
/**
 * activity-modal.js is a script file to deal with common UI Handlers for
 * activities - event & task from client side.
 * 
 * @module Activities  
 * 
 * author: Rammohan
 */
$(function() {

	$("#activityTaskModal,#activityModal").on("click", "#activityForm #allDay, #updateActivityForm #allDay", function(e){

			if($(this).is(':checked'))
			{	
				$('#activityForm #event-time-1').closest('.control-group').hide();
				$('#activityForm #event-date-2').closest('.row').hide();
			}
			else 
			{
				$('#activityForm #event-time-1').closest('.control-group').show();
				$('#activityForm #event-date-2').closest('.row').show();
			}
			
			if($(this).is(':checked'))
			{
				$('#updateActivityForm #update-event-time-1').closest('.control-group').hide();
				$('#updateActivityForm #update-event-date-2').closest('.row').hide();
			}
			else 
			{
				$('#updateActivityForm #update-event-time-1').closest('.control-group').show();
				$('#updateActivityForm #update-event-date-2').closest('.row').show();
			}
	});

	/**
	 * Saves the content of activity modal by verifying whether it is a task or
	 * event
	 */
	$("#activityTaskModal,#activityModal").on('click', '#task_event_validate', function(e) {
		e.preventDefault();

		console.log(this);
		// Save functionality for task by checking task or not
		if ($("#hiddentask").val() == "task") {

			save_task('taskForm', 'activityTaskModal', false, this);
		} else {

			// Save functionality for event
			save_event('activityForm', 'activityModal', false, this,function(data){
						//	eventCollectionView.collection.comparator ='start';
									eventCollectionView.collection.add(data.toJSON());
									eventCollectionView.collection.sort();
							
			});
		}
	}); // End of Task and Event Validation function

});/**
 * 
 * Describes the given object is an array or not
 * 
 * @param {Object}
 *            a to verify array or not
 * @returns {Boolean} true if given param is array else false
 */
function isArray(a)
{
	return Object.prototype.toString.apply(a) === '[object Array]';
}

/**
 * Loads events from google calendar using tokens either from cookies or token
 * from backend when token in cookie is epired
 * 
 * @param callback
 */
function load_events_from_google(callback)
{

	var eventFilters = JSON.parse(readCookie('event-lhs-filters'));
	var agile_event = false;
	if (eventFilters)
	{
		var type_of_cal = eventFilters.cal_type;
		var owners = eventFilters.owner_ids;
		if (owners && owners.length > 0)
		{
			$.each(owners, function(index, value)
			{
				if (value)
				{
					if (value.id == CURRENT_AGILE_USER.id)
						agile_event = true;
				}
			});
		}
		if(type_of_cal){
			var typelength = type_of_cal.length;										
			if(typelength > 0){
				//Google
				var inArray = type_of_cal.indexOf("google");
				if(inArray >= 0){
					//continue
				}else{
					return
				}
			}
			else{
				return;
			}
		}
		else{
				return;
			}
//		if ((type_of_cal && type_of_cal.length != 2 && type_of_cal[0] == 'agile') || type_of_cal.length == 0)
//		{
//			return;
//		}
	}

	// Name of the cookie to store/ calendar prefs. Current user id is set
	// in cookie name to avoid
	// showing tasks in different users calendar if logged in same browser
	var google_calendar_cookie_name = "_agile_google_calendar_prefs_" + CURRENT_DOMAIN_USER.id;

	// Reads existing cookie
	var _agile_calendar_prefs_cookie = readCookie(google_calendar_cookie_name);

	// If cookie is not null, then it check it token is still valid; checks
	// based on expiry time.
	if (_agile_calendar_prefs_cookie && _agile_calendar_prefs_cookie != "null")
	{
		var prefs = JSON.parse(_agile_calendar_prefs_cookie);

		// Checks if token expired. It considers expire before 2 minutes window
		// of actual expiry time.
		if (prefs.expires_at - (2 * 60 * 1000) >= new Date().getTime())
		{
			// Returns token to the callback accoring to specification of gcal
			get_google_calendar_event_source(prefs, callback);
			return;
		}

		// Erases cookie if token is expired and sends request to backend to
		// acquire new token
		erase_google_calendar_prefs_cookie()

	}

	// Fetch new token from backen, saves in cookie, and token is returned to
	// gcal
	$.getJSON('/core/api/calendar-prefs/refresh-token', function(prefs)
	{
		if (!prefs)
			return;

		// Creates cookie
		createCookie(google_calendar_cookie_name, JSON.stringify(prefs));
		get_google_calendar_event_source(prefs, callback);
	});
}

/**
 * Erases calendar cookie
 */
function erase_google_calendar_prefs_cookie()
{
	var google_calendar_cookie_name = "_agile_google_calendar_prefs_" + CURRENT_DOMAIN_USER.id;
	eraseCookie(google_calendar_cookie_name);
}

// Returns token in to gcal callback in specified format
function get_google_calendar_event_source(data, callback)
{

	if (callback && typeof (callback) === "function")
		callback({ token : data.access_token, dataType : 'agile-gcal', className : "agile-gcal" });
}

/**
 * Shows the calendar
 */
var fullCal;
function showCalendar(users)
{

	_init_gcal_options(users);
	putGoogleCalendarLink();
	putOfficeCalendarLink();
	
	var calendarView = (!readCookie('calendarDefaultView')) ? 'month' : readCookie('calendarDefaultView');
	$('#' + calendarView).addClass('bg-light');
	var contentHeight = 400;
	if (calendarView == "agendaDay" || calendarView == "agendaWeek")
	{
		contentHeight = 575;
	}
	fullCal = $('#calendar_event')
			.fullCalendar(
					{

						/**
						 * Renders the events displaying currently on
						 * fullCalendar
						 * 
						 * @method events
						 * @param {Object}
						 *            start fullCalendar current section start
						 *            day date object
						 * @param {Object}
						 *            end fullCalendar current section end day
						 *            date object
						 * @param {function}
						 *            callback displays the events on
						 *            fullCalendar
						 * 
						 */

						eventSources : [
								{ events : function(start, end, callback)
								{

									var eventFilters = JSON.parse(readCookie('event-lhs-filters'));
									var agile_event_owners = '';
									if (eventFilters)
									{
										var type_of_cal = eventFilters.cal_type;
										var owners = eventFilters.owner_ids;

										$.each(type_of_cal, function(index, value)
										{
											if (value == 'agile')
												owners.push(CURRENT_AGILE_USER.id);
										});

										if (owners && owners.length > 0)
										{
											$.each(owners, function(index, value)
											{

												if (index >= 1)
													agile_event_owners += ",";
												agile_event_owners += value;
											});
										}
											
										var typelength = type_of_cal.length;										
										if(typelength > 0){
											//Google
											var inArray = type_of_cal.indexOf("google");
											if(inArray >= 0){
												//contiune
											}
											
											//Office
											var inArray = type_of_cal.indexOf("office");
											if(inArray >= 0){
												loadOfficeEvents(start.getTime(), end.getTime());
											}
											
											$("#loading_calendar_events").hide();
											
											//Agile
											var inArray = type_of_cal.indexOf("agile");
											if(inArray >= 0){
												//continue
											}else{
												return;
											}
										}
										
//										if ((type_of_cal.length == 1 && type_of_cal[0] == 'google' && owners.length == 1 && owners[0] == CURRENT_AGILE_USER.id) || type_of_cal.length == 0 && owners.length == 0)
//										{
//											$("#loading_calendar_events").hide();
//											return;
//										}
									}

									/*
									 * if (readCookie('event-filters') &&
									 * eventFilters.type == 'google') {
									 * $("#loading_calendar_events").hide();
									 * return; }
									 */
									var start_end_array = {};
									start_end_array.startTime = start.getTime() / 1000;
									start_end_array.endTime = end.getTime() / 1000;
									console.log(start_end_array.startTime+" : "+start_end_array.endTime);
									createCookie('fullcalendar_start_end_time', JSON.stringify(start_end_array));

									var eventsURL = '/core/api/events?start=' + start.getTime() / 1000 + "&end=" + end.getTime() / 1000;
									
									eventsURL += '&owner_id=' + agile_event_owners;
									console.log('-----------------', eventsURL);
									
									$.getJSON(eventsURL, function(doc)
									{
										try{
										$.each(doc, function(index, data)
										{
											// decides the color of event based
											// on owner id
											console.log(data);
											data = renderEventBasedOnOwner(data);
										});

										if (doc)
										{

											callback(doc);

										}
										}
										catch(err){
												$("#loading_calendar_events").hide();
										}
									});
								} }, { dataType : 'agile-gcal' }
						],
						header : { left : 'prev', center : 'title', right : 'next' },
						defaultView : calendarView,
						slotEventOverlap : false,
						viewDisplay : function(view)
						{
							createCookie('calendarDefaultView', view.name, 90);
							$(".fc-agenda-axis").addClass('bg-light lter');
						},
						loading : function(bool)
						{
							if (bool)
							{

								$("#loading_calendar_events").remove();
								$('.fc-header-left')
										.append(
												'<span id="loading_calendar_events" style="margin-left:5px;vertical-align:middle;padding-top: 5px;position: absolute;">loading...</span>')
										.show();
								$('.fc-header-left').show();

							}
							else
							{
								// $('#loading').hide();
								$("#loading_calendar_events").hide();
								start_tour('calendar');
							}
							$(".fc-agenda-axis").addClass('bg-light lter');
							$(".ui-resizable-handle").hide();
						},
						selectable : true,
						selectHelper : true,
						editable : true,
						theme : false,
						contentHeight : contentHeight,
						firstDay : CALENDAR_WEEK_START_DAY,
						firstHour : 7,
						themeButtonIcons : { prev : 'fc-icon-left-single-arrow', next : 'fc-icon-right-single-arrow' },
						eventMouseover : function(event, jsEvent, view)
						{

							calendarView = (!readCookie('calendarDefaultView')) ? 'month' : readCookie('calendarDefaultView');
							var reletedContacts = '';
							var meeting_type = '';
							 	
								if(event.contacts != null){
									if (event.contacts.length > 0){
										reletedContacts += '<i class="icon-user text-muted m-r-xs"></i>';
									}
									for (var i = 0; i < event.contacts.length; i++)
									{
										if (event.contacts[i].entity_type == "contact_entity")
										{
											var last_name = getPropertyValue(event.contacts[i].properties, "last_name");
											if (last_name == undefined)
												last_name = "";
											if(event.contacts[i].type == 'COMPANY')
												reletedContacts += '<a class="text-info" href="#company/' + event.contacts[i].id + '">' + getPropertyValue(
													event.contacts[i].properties, "name") + '</a>';
											else
												reletedContacts += '<a class="text-info" href="#contact/' + event.contacts[i].id + '">' + getPropertyValue(
														event.contacts[i].properties, "first_name") + ' ' + last_name + '</a>';
										}else{
											reletedContacts += '<a class="text-info" href="#contact/' + event.contacts[i].id + '">' + getPropertyValue(
													event.contacts[i].properties, "name") + '</a>';
										}
										if (i != event.contacts.length - 1){
											reletedContacts += ', ';
										}
									}
								}
								
								var leftorright = 'left';	
								var pullupornot = '';
								var popoverElement = '';
								var popover_min_width = 300;
									
									if (event.meeting_type && event.description){
										meeting_type = '<i class="icon-comment-alt text-muted m-r-xs"></i><span>Meeting Type - ' + event.meeting_type + '</span><br/><span title=' + event.description + '>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + addDotsAtEnd(event.description) + '</span>';
									}else if (event.description){
										meeting_type = '<i class="icon-comment-alt text-muted m-r-xs"></i><span title=' + event.description + '>' + addDotsAtEnd(event.description) + '</span>';
									}
											
									if (calendarView == "month")
									{
										popover_min_width = $('.fc-view-month').find('.fc-widget-content').eq(0).width() * 2;
										var left = jsEvent.currentTarget.offsetLeft + jsEvent.currentTarget.offsetWidth + 10;
										var top = jsEvent.currentTarget.offsetTop;
										if ($('.fc-border-separate:visible').width() - left < popover_min_width)
										{
											left = jsEvent.currentTarget.offsetLeft - popover_min_width - 10;
											leftorright = 'right';
										}
										if ($('.fc-border-separate:visible').width() - popover_min_width - 20 < jsEvent.currentTarget.offsetWidth)
										{
											left = ((jsEvent.currentTarget.offsetLeft + jsEvent.currentTarget.offsetWidth + 10) / 2) - (popover_min_width / 2);
											top = jsEvent.currentTarget.offsetTop + jsEvent.currentTarget.offsetHeight + 10;
											leftorright = 'top';
										}
										if(event.type == "officeCalendar"){
											var popoverElement = '<div class="fc-overlayw ' + leftorright + '" style="min-width:' + popover_min_width + 'px;max-width:' + popover_min_width + 'px;left:' + left + 'px;top:' + top + 'px;position:absolute;z-index:10;display:none;">' + 
																 '<div class="panel bg-white b-a pos-rlt p-sm">' + 
																 '<span class="arrow ' + leftorright + ' ' + pullupornot + '" style="top:11px;"></span>' + 
																 '<div class="m-b-sm"><div class="pull-left text-flow-ellipsis p-b-xs" style="width:100%;">' + event.title + '</div></div>' +
																 '<div><i class="icon-clock text-muted m-r-xs"></i>' + event.start.format('dd-mmm-yyyy HH:MM') + '</div>' + 
																 '<div class="text-ellipsis">' + reletedContacts + '</div>' + 
																 '<div class="text-ellipsis">' + meeting_type + '</div>' + 
																 '</div>' + '</div>';
											$(this).after(popoverElement);
										}else{
											var popoverElement = '<div class="fc-overlayw ' + leftorright + '" style="width:100%;min-width:' + popover_min_width + 'px;max-width:' + popover_min_width + 'px;left:' + left + 'px;top:' + top + 'px;position:absolute;z-index:10;display:none;">' + '<div class="panel bg-white b-a pos-rlt p-sm">' + '<span class="arrow ' + leftorright + ' ' + pullupornot + '" style="top:11px;"></span>' + '<div class="h4 font-thin m-b-sm"><div class="pull-left text-ellipsis p-b-xs" style="width:100%;">' + event.title + '</div></div>' + '<div class="line b-b b-light"></div>' + '<div><i class="icon-clock text-muted m-r-xs"></i>' + event.start
													.format('dd-mmm-yyyy HH:MM') + '<div class="pull-right" style="width:10%;"><img class="r-2x" src="' + event.ownerPic + '" height="20px" width="20px" title="' + event.owner.name + '"/></div></div>' + '<div class="text-ellipsis">' + reletedContacts + '</div>' + '<div class="text-ellipsis">' + meeting_type + '</div>' + '</div>' + '</div>';
											$(this).after(popoverElement);
										}
										
										if ($('.fc-border-separate:visible').height() - jsEvent.currentTarget.offsetTop < $(this).parent().find('.fc-overlayw')
												.height())
										{
											$(this).parent().find('.fc-overlayw').css("top",
													top - $(this).parent().find('.fc-overlayw').height() + jsEvent.currentTarget.offsetHeight + 20 + "px");
											$(this).parent().find('.fc-overlayw').find('.arrow').css("top", $(this).parent().find('.fc-overlayw').height() - 31 + "px");
										}
										if ($('.fc-border-separate:visible').width() - popover_min_width - 20 < jsEvent.currentTarget.offsetWidth)
										{
											$(this).parent().find('.fc-overlayw').find('.arrow').css("top", "-9px");
										}
										if (($('.fc-border-separate:visible').height() - jsEvent.currentTarget.offsetTop - jsEvent.currentTarget.offsetHeight - 10 < $(
												this).parent().find('.fc-overlayw').height() + 10) && ($('.fc-border-separate:visible').width() - popover_min_width - 20 < jsEvent.currentTarget.offsetWidth))
										{
											$(this).parent().find('.fc-overlayw').find('.arrow').removeClass('top').addClass('bottom');
											left = ((jsEvent.currentTarget.offsetLeft + jsEvent.currentTarget.offsetWidth + 10) / 2) - (popover_min_width / 2);
											top = jsEvent.currentTarget.offsetTop - $(this).parent().find('.fc-overlayw').height() + 10;
											$(this).parent().find('.fc-overlayw').css({ "top" : top + "px", "lef" : left + "px" });
											$(this).parent().find('.fc-overlayw').find('.arrow').css("top", $(this).parent().find('.fc-overlayw').height() - 22 + "px");
										}
									}
									else if (calendarView == "agendaWeek")
									{
										popover_min_width = $('.fc-view-agendaWeek').find('.fc-widget-content').eq(0).width() * 2;
										var left = jsEvent.currentTarget.offsetLeft + jsEvent.currentTarget.offsetWidth + 10;
										var top = jsEvent.currentTarget.offsetTop;
										if ($('.fc-agenda-slots:visible').width() - left < popover_min_width)
										{
											left = jsEvent.currentTarget.offsetLeft - popover_min_width - 10;
											leftorright = 'right';
										}
										
										if(event.type == "officeCalendar"){
											var popoverElement = '<div class="fc-overlayw ' + leftorright + '" style="min-width:' + popover_min_width + 'px;max-width:' + popover_min_width + 'px;left:' + left + 'px;top:' + top + 'px;position:absolute;z-index:10;display:none;">' + 
																 '<div class="panel bg-white b-a pos-rlt p-sm">' + 
																 '<span class="arrow ' + leftorright + ' ' + pullupornot + '" style="top:11px;"></span>' + 
																 '<div class="m-b-sm"><div class="pull-left text-flow-ellipsis p-b-xs" style="width:100%;">' + event.title + '</div></div>' +
																 '<div><i class="icon-clock text-muted m-r-xs"></i>' + event.start.format('dd-mmm-yyyy HH:MM') + '</div>' + 
																 '<div class="text-ellipsis">' + reletedContacts + '</div>' + 
																 '<div class="text-ellipsis">' + meeting_type + '</div>' + 
																 '</div>' + '</div>';
											$(this).after(popoverElement);
										}else{
											// var event_width =
											// jsEvent.currentTarget.offsetWidth;
											var popoverElement = '<div class="fc-overlayw ' + leftorright + '" style="width:100%;min-width:' + popover_min_width + 'px;max-width:' + popover_min_width + 'px;left:' + left + 'px;top:' + top + 'px;position:absolute;z-index:10;display:none;">' + '<div class="panel bg-white b-a pos-rlt p-sm">' + '<span class="arrow ' + leftorright + ' ' + pullupornot + '" style="top:11px;"></span>' + '<div class="h4 font-thin m-b-sm"><div class="pull-left text-ellipsis p-b-xs" style="width:100%;">' + event.title + '</div></div>' + '<div class="line b-b b-light"></div>' + '<div><i class="icon-clock text-muted m-r-xs"></i>' + event.start
													.format('dd-mmm-yyyy HH:MM') + '<div class="pull-right" style="width:10%;"><img class="r-2x" src="' + event.ownerPic + '" height="20px" width="20px" title="' + event.owner.name + '"/></div></div>' + '<div class="text-ellipsis">' + reletedContacts + '</div>' + '<div class="text-ellipsis">' + meeting_type + '</div>' + '</div>' + '</div>';
											$(this).after(popoverElement);									
										}
										
										if ($('.fc-agenda-slots:visible').height() - jsEvent.currentTarget.offsetTop < $(this).parent().find('.fc-overlayw').height())
										{
											$(this).parent().find('.fc-overlayw').css("top",
													top - $(this).parent().find('.fc-overlayw').height() + jsEvent.currentTarget.offsetHeight + 20 + "px");
											$(this).parent().find('.fc-overlayw').find('.arrow').css("top", $(this).parent().find('.fc-overlayw').height() - 31 + "px");
										}
									}
									else if (calendarView == "agendaDay")
									{
										var left = jsEvent.currentTarget.offsetLeft;
										var top = jsEvent.currentTarget.offsetTop + jsEvent.currentTarget.offsetHeight + 10;
										leftorright = 'top';
										if ($('.fc-agenda-slots:visible').width() - jsEvent.currentTarget.offsetLeft < popover_min_width)
										{
											left = jsEvent.currentTarget.offsetLeft - jsEvent.currentTarget.offsetWidth - ($('.fc-agenda-slots:visible').width() - jsEvent.currentTarget.offsetLeft - jsEvent.currentTarget.offsetWidth);
										}
										
										if(event.type == "officeCalendar"){
											var popoverElement = '<div class="fc-overlayw ' + leftorright + '" style="min-width:' + popover_min_width + 'px;max-width:' + popover_min_width + 'px;left:' + left + 'px;top:' + top + 'px;position:absolute;z-index:10;display:none;">' + 
																 '<div class="panel bg-white b-a pos-rlt p-sm">' + 
																 '<span class="arrow ' + leftorright + ' ' + pullupornot + '" style="top:11px;"></span>' + 
																 '<div class="m-b-sm"><div class="pull-left text-flow-ellipsis p-b-xs" style="width:100%;">' + event.title + '</div></div>' +
																 '<div><i class="icon-clock text-muted m-r-xs"></i>' + event.start.format('dd-mmm-yyyy HH:MM') + '</div>' + 
																 '<div class="text-ellipsis">' + reletedContacts + '</div>' + 
																 '<div class="text-ellipsis">' + meeting_type + '</div>' + 
																 '</div>' + '</div>';
											$(this).after(popoverElement);
										}else{
											var popoverElement = '<div class="fc-overlayw ' + leftorright + '" style="width:100%;min-width:' + popover_min_width + 'px;max-width:' + popover_min_width + 'px;left:' + left + 'px;top:' + top + 'px;position:absolute;z-index:10;display:none;">' + '<div class="panel bg-white b-a pos-rlt p-sm">' + '<span class="arrow ' + leftorright + ' ' + pullupornot + '" style="top:11px;"></span>' + '<div class="h4 font-thin m-b-sm"><div class="pull-left text-ellipsis p-b-xs" style="width:100%;">' + event.title + '</div></div>' + '<div class="line b-b b-light"></div>' + '<div><i class="icon-clock text-muted m-r-xs"></i>' + event.start
													.format('dd-mmm-yyyy HH:MM') + '<div class="pull-right" style="width:10%;"><img class="r-2x" src="' + event.ownerPic + '" height="20px" width="20px" title="' + event.owner.name + '"/></div></div>' + '<div class="text-ellipsis">' + reletedContacts + '</div>' + '<div class="text-ellipsis">' + meeting_type + '</div>' + '</div>' + '</div>';
											$(this).after(popoverElement);
										}
										
										$(this).parent().find('.fc-overlayw').find('.arrow').css({ "top" : "-9px", "left" : "11px" });
										if ($('.fc-agenda-slots:visible').width() - jsEvent.currentTarget.offsetLeft < popover_min_width)
										{
											$(this).parent().find('.fc-overlayw').find('.arrow').css({ "top" : "-9px", "left" : popover_min_width - 15 + "px" });
										}
										if ((jsEvent.currentTarget.offsetTop < $(this).parent().find('.fc-overlayw').height() + 10) && ($('.fc-agenda-slots:visible')
												.height() - jsEvent.currentTarget.offsetHeight < $(this).parent().find('.fc-overlayw').height() + 10))
										{
											$(this).parent().find('.fc-overlayw').css("top", jsEvent.currentTarget.offsetTop + 40 + "px");
										}
										if ((jsEvent.currentTarget.offsetTop > $(this).parent().find('.fc-overlayw').height() + 10) && ($('.fc-agenda-slots:visible')
												.height() - (jsEvent.currentTarget.offsetHeight + jsEvent.currentTarget.offsetTop) < $(this).parent().find(
												'.fc-overlayw').height() + 10))
										{
											$(this).parent().find('.fc-overlayw').find('.arrow').removeClass('top').addClass('bottom');
											$(this).parent().find('.fc-overlayw').find('.arrow').css("top", $(this).parent().find('.fc-overlayw').height() - 22 + "px");
											$(this).parent().find('.fc-overlayw').css(
													"top",
													$('.fc-agenda-slots:visible').height() - jsEvent.currentTarget.offsetHeight - $(this).parent().find('.fc-overlayw')
															.height() + 7 + "px");
											if ($('.fc-agenda-slots:visible').width() - jsEvent.currentTarget.offsetLeft < popover_min_width)
											{
												$(this).parent().find('.fc-overlayw')
														.css(
																"left",
																jsEvent.currentTarget.offsetLeft - jsEvent.currentTarget.offsetWidth - ($('.fc-agenda-slots:visible')
																		.width() - jsEvent.currentTarget.offsetLeft - jsEvent.currentTarget.offsetWidth) + "px");
											}
										}
									}
							$(jsEvent.currentTarget).css('z-index', 9);
							if (event.allDay){
								$(jsEvent.currentTarget.parentElement).css('z-index', 9);
							}
							$(this).parent().find('.fc-overlayw').show();
							$(this).find(".ui-resizable-handle").show();
						},
						eventMouseout : function(event, jsEvent, view)
						{
							$(this).parent().find('.fc-overlayw').hide();
							$(this).parent().find('.fc-overlayw').remove();
							$(this).find(".ui-resizable-handle").hide();
							$(jsEvent.currentTarget).css('z-index', 8);
							if (event.allDay)
							{
								$(jsEvent.currentTarget.parentElement).css('z-index', 8);
							}
						},
						eventAfterRender : function(event, element, view)
						{
							$(".ui-resizable-handle").hide();
							event = renderEventBasedOnOwner(event);
							var start_event = new Date(event.start).getTime() / 1000;
							var end_event = new Date(event.end).getTime() / 1000;
							if (end_event - start_event == 3600)
							{
								$(element).height('');
							}
							
							if(event.type == "officeCalendar"){
								$(element).height('');
							}
						},

						/**
						 * Shows event pop-up modal with pre-filled date and
						 * time values, when we select a day or multiple days of
						 * the fullCalendar
						 * 
						 * @method select
						 * @param {Object}
						 *            start start-date of the event
						 * @param {Object}
						 *            end end-date of the event
						 * @param {Boolean}
						 *            allDay
						 */
						select : function(start, end, allDay)
						{
							// Show a new event
							$('#activityModal').html(getTemplate("new-event-modal")).modal('show');
							highlight_event();

							// Set Date for Event
							//var dateFormat = 'mm/dd/yyyy';
							$('#task-date-1').val(getDateInFormat(start));
							$("#event-date-1").val(getDateInFormat(start));
							$("#event-date-2").val(getDateInFormat(end));

							// Set Time for Event
							if ((start.getHours() == 00) && (end.getHours() == 00) && (end.getMinutes() == 00))
							{
								$('#event-time-1').val('');
								$('#event-time-2').val('');
							}
							else
							{
								$('#event-time-1')
										.val(
												(start.getHours() < 10 ? "0" : "") + start.getHours() + ":" + (start.getMinutes() < 10 ? "0" : "") + start
														.getMinutes());
								$('#event-time-2').val(
										(end.getHours() < 10 ? "0" : "") + end.getHours() + ":" + (end.getMinutes() < 10 ? "0" : "") + end.getMinutes());
							}

						},
						/**
						 * Updates the event by changing start and end date,
						 * when it is dragged to another location on
						 * fullCalendar.
						 * 
						 * @method eventDrop
						 * @param {Object}
						 *            event1 event with new start and end date
						 * @param {Number}
						 *            dayDelta holds the number of days the
						 *            event was moved forward
						 * @param {Number}
						 *            minuteDelta holds the number of minutes
						 *            the event was moved forward
						 * @param {Boolean}
						 *            allDay weather the event has been dropped
						 *            on a day in month view or not
						 * @param {Function}
						 *            revertFunc sets the event back to it's
						 *            original position
						 */
						eventDrop : function(event1, dayDelta, minuteDelta, allDay, revertFunc)
						{

							// Confirm from the user about the change
							if (!confirm("Are you sure about this change?"))
							{
								revertFunc();
								return;
							}
							event1 = revertEventColorBasedOnPriority(event1);
							var event = $.extend(true, {}, event1);

							// Update event if the user changes it in the
							// calendar
							event.start = new Date(event.start).getTime() / 1000;
							event.end = new Date(event.end).getTime() / 1000;
							if (event.end == null || event.end == 0)
								event.end = event.start;

							var jsoncontacts = event.contacts;
							var _contacts = [];
							for ( var i in jsoncontacts)
							{
								_contacts.push(jsoncontacts[i].id);

							}
							delete event.contacts;
							delete event.owner;
							event.contacts = _contacts;
							var eventModel = new Backbone.Model();
							eventModel.url = 'core/api/events';

							eventModel.save(event);
						},
						/**
						 * Updates or deletes an event by clicking on it
						 * 
						 * @method eventClick
						 * @param {Object}
						 *            event to update or delete
						 */
						eventClick : function(event)
						{
							event = revertEventColorBasedOnPriority(event);

							if (isNaN(event.id))
								return;
							// Deserialize
							deserializeForm(event, $("#updateActivityForm"));

							// Set time for update Event
							$('#update-event-time-1')
									.val(
											(event.start.getHours() < 10 ? "0" : "") + event.start.getHours() + ":" + (event.start.getMinutes() < 10 ? "0" : "") + event.start
													.getMinutes());
							$('#update-event-time-2').val(
									(event.end.getHours() < 10 ? "0" : "") + event.end.getHours() + ":" + (event.end.getMinutes() < 10 ? "0" : "") + event.end
											.getMinutes());

							// Set date for update Event
							var dateFormat = 'mm/dd/yyyy';
							$("#update-event-date-1").val(getDateInFormat(event.start));
							$("#update-event-date-2").val(getDateInFormat(event.end));

							// hide end date & time for all day events
							if (event.allDay)
							{
								$("#update-event-date-2").closest('.row').hide();
								$('#update-event-time-1').closest('.control-group').hide();
							}
							else
							{
								$('#update-event-time-1').closest('.control-group').show();
								$("#update-event-date-2").closest('.row').show();
							}

							if (event.type == "WEB_APPOINTMENT" && parseInt(new Date(event.start).getTime() / 1000) > parseInt(new Date().getTime() / 1000))
							{
								$("[id='event_delete']").attr("id", "delete_web_event");
								web_event_title = event.title;
								if (event.contacts.length > 0)
								{
									var firstname = getPropertyValue(event.contacts[0].properties, "first_name");
									if (firstname == undefined)
										firstname = "";
									var lastname = getPropertyValue(event.contacts[0].properties, "last_name");
									if (lastname == undefined)
										lastname = "";
									web_event_contact_name = firstname + " " + lastname;
								}
							}
							else
							{
								$("[id='delete_web_event']").attr("id", "event_delete");
							}
							if (event.description)
							{
								var description = '<label class="control-label"><b>Description </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="Add Description"></textarea></div>'
								$("#event_desc").html(description);
								$("textarea#description").val(event.description);
							}
							else
							{
								var desc = '<div class="row-fluid">' + '<div class="control-group form-group m-b-none " id="addEventDescription">' + '<a href="#" id="add_event_desctiption"><i class="icon-plus"></i> Add Description </a>' + '<div class="controls event_discription hide">' + '<textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="Add Description"></textarea>' + '</div></div></div>'
								$("#event_desc").html(desc);
							}
							// Show edit modal for the event
							$("#updateActivityModal").modal('show');
							
							agile_type_ahead("event_relates_to_deals", $('#updateActivityModal'), deals_typeahead, false,null,null,"core/api/search/deals",false, true);

							// Fills owner select element
							populateUsersInUpdateActivityModal(event);

							// initializeEventModelEvents();
							return false;
						}

					});
}

function showEventFilters()
{
	$('#filter_options').show();

	if (readCookie("agile_calendar_view"))
		$('#filter_options .calendar-view').hide();
	else
		$('#filter_options .list-view').hide();

	if (readCookie('event-filters'))
	{
		var eventFilters = JSON.parse(readCookie('event-filters'));
		$('#event-owner').val(eventFilters.owner_id);
		$('#event_type').val(eventFilters.type);
	}

}

function buildEventFilters()
{
	$.getJSON('/core/api/users/agileusers', function(users)
	{
		var html = '', html1 = '';
		if (users)
		{
			$.each(users, function(i, user)
			{
				if (CURRENT_DOMAIN_USER.id == user.domain_user_id)
					html1 = '<option value=' + user.id + '>Me</option>';
				else
				{
					if (user.domainUser)
						html += '<option value=' + user.id + '>' + user.domainUser.name + '</option>';
				}
			});
			html += '<option value="">Any</option>';
		}
		$('#event-owner').html(html1 + html);
	});
}

function loadDefaultFilters(callback)
{
	// Create a cookie with default option, if there is no cookie related to
	// event filter.
	if (!readCookie('event-filters'))
	{
		$.getJSON('/core/api/users/agileusers', function(users)
		{
			if (users)
			{
				$.each(users, function(i, user)
				{
					if (CURRENT_DOMAIN_USER.id == user.domain_user_id)
					{
						var json = {};
						json.owner_id = user.id.toString();
						json.type = '';
						createCookie('event-filters', JSON.stringify(json));
					}
				});
			}

			if (callback)
				callback();
		});
	}
}

$(function(){
	/**
	 * Hide the filters window when click on out side of the filters pop up.
	 */
	$(document).mouseup(function(e)
	{
		var container = $("#filter_options");

		if (!container.is(e.target) // if the target of the click isn't the
				// container...
				&& container.has(e.target).length === 0) // ... nor a
		// descendant of the
		// container
		{
			container.hide();
		}
	});

	// loadDefaultFilters();
	
});
function changeView(view)
{
	currentView = view;
	fullCal.fullCalendar('changeView', view);
};
function today()
{
	fullCal.fullCalendar('today');
}


/**
 * gets the agileusers to build calendar filters
 * @returns {Array}
 */
function getCalendarUsersDetails(callback)
{

	accessUrlUsingAjax('/core/api/users/agileusers', function(data){

		if(!data)
			 return callback(data);

		var json_users = [];
		$.each(data, function(i, user)
		{

			if (CURRENT_DOMAIN_USER.id == user.domain_user_id)
			{
				CURRENT_AGILE_USER = user;
				return;
			}
			
			if (user.domainUser)
			{
				var json_user = {};
				json_user.id = user.id;
				json_user.name = user.domainUser.name;
				json_user.domain_user_id = user.domainUser.id;
				json_users.push(json_user);
			}
		});
		return callback(json_users);

	});
}
function append_contact_activities_log(base_model)
{

	var itemView = new Base_List_View({ model : base_model, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'li', });

	// add to the right box - overdue, today, tomorrow etc.
	var createdtime = get_activity_created_time(base_model.get('time'));

	// Today
	if (createdtime == 0)
	{
		$('#earllier').show();
		$('#earlier-heading').addClass("ref-head");

		var heading = $('#today-heading', this.el);

		$('#contact-activity-today-list-log-model-list', this.el).append(itemView.render().el);
		$('#contact-activity-today-list-log-model-list', this.el).parent('table').css("display", "block");
		$('#contact-activity-today-list-log-model-list', this.el).show();
		$('#today-heading', this.el).show();
	}

	if (createdtime == -1)
	{ 
		$('#earllier').show();
		$('#earlier-heading').addClass("ref-head");

		var heading = $('#tomorrow-heading', this.el);

		$('#contact-activity-yesterday-list-log-model-list', this.el).append(itemView.render().el);
		$('#contact-activity-yesterday-list-log-model-list', this.el).parent('table').css("display", "block");
		$('#contact-activity-yesterday-list-log-model-list', this.el).show();
		$('#yesterday-heading', this.el).show();
	}
	if (createdtime < -1)
	{

		var heading = $('#next-week-heading', this.el);

		$('#contact-activity-earlier-list-log-model-list', this.el).append(itemView.render().el);
		$('#contact-activity-earlier-list-log-model-list', this.el).parent('table').css("display", "block");
		$('#contact-activity-earlier-list-log-model-list', this.el).show();
		$('#earlier-heading', this.el).show();
	}

}/**
 * creates request url based on values selected from calenar LHS filters
 */

function createRequestUrlBasedOnFilter()
{
	var calendars_val = [];
	var calendars_user_val = [];
	var calendars_domain_user_ids = [];
	var event_list_type = '';

	$('.calendar_check').each(function()
	{
		if (this.checked)
			calendars_val.push($(this).val());

	});

	$('.calendar_user_check').each(function()
	{
		if (this.checked)
		{
			calendars_user_val.push($(this).val());
			calendars_domain_user_ids.push($(this).attr("data"));
		}

	});
	if (readCookie("agile_calendar_view"))
	{

		event_list_type = $("#event_time").val();
	}

	var uniqueNames = [];
	$.each(calendars_user_val, function(i, el)
	{
		if ($.inArray(el, uniqueNames) === -1)
			uniqueNames.push(el);
	});
	calendars_user_val = uniqueNames;
	var json_obj = {};
	json_obj.cal_type = calendars_val;
	json_obj.owner_ids = calendars_user_val;
	json_obj.domain_user_ids = calendars_domain_user_ids;
	/*
	 * if (event_list_type) json_obj.event_type = event_list_type;
	 */
	createCookie('event-lhs-filters', JSON.stringify(json_obj));

}

// this function will be called to read filters from cookie if not found creates
// cookie with default values
function buildCalendarLhsFilters()
{
	var eventFilters = JSON.parse(readCookie('event-lhs-filters'));
	if (eventFilters)
	{
		var type_of_cal = eventFilters.cal_type;
		var owners = eventFilters.owner_ids;
		var event_time = eventFilters.events_time;
		var list_event_type = eventFilters.event_type;

		if (type_of_cal)
		{
			$.each(type_of_cal, function(index, value)
			{
				$('.calendar_check').each(function()
				{ // loop through each checkbox
					if ($(this).val() == value)
						this.checked = true;
				});

			});
		}

		if (owners && owners.length > 0)
		{
			$.each(owners, function(index, value)
			{
				$('.calendar_user_check').each(function()
				{ // loop through each checkbox
					if ($(this).val() == value)
						this.checked = true;
				});

			});
		}

		/*
		 * if (readCookie("agile_calendar_view")) {
		 * 
		 * if (list_event_type) $("#event_time").val(list_event_type); }
		 */
	}
	else
	{
		/*
		 * $('.calendar_user_check').each(function() { // loop through each
		 * checkbox if ($(this).val() == CURRENT_AGILE_USER.id) this.checked =
		 * true; });
		 */
		$('.calendar_check').each(function()
		{ // loop through each checkbox
			this.checked = true;
		});

		/*
		 * if (readCookie("agile_calendar_view")) { $("#event_time").val(""); }
		 */
	}

}

// this function will be called to load full calendar based on filters
function loadFullCalednarOrListView()
{
	if (readCookie("agile_calendar_view"))
	{
		var eventFilters = JSON.parse(readCookie('event-lhs-filters'));
		if (eventFilters)
		{
			if (eventFilters.event_type == "future")
			{
				createCookie("agile_calendar_view", "calendar_list_view_future");
			}
			else
			{
				createCookie("agile_calendar_view", "calendar_list_view");
			}
		}
		else
			createCookie("agile_calendar_view", "calendar_list_view");

	}

	// if list view
	if (!readCookie("agile_calendar_view"))
	{
		$('#calendar_event').html('');
		showCalendar();
	}
	else
	{

		loadAgileEvents();
		loadGoogleEvents();

	}
}

/**
 * when  no calenar selected i.e agile /google it enables checkboxes for both
 */
function checkBothCalWhenNoCalSelected()
{
	var selectedCal = [];
	$('.calendar_check').each(function()
	{
		if (this.checked)
			selectedCal.push($(this).val());

	});
	if (selectedCal && selectedCal.length == 0)
	{
		$('.calendar_check').each(function()
		{
			this.checked = true;

		});
		createRequestUrlBasedOnFilter();
		loadFullCalednarOrListView();
	}

}


/**
 * 
 * if google calendar sync is enabled then disappears link addtocalednar in lhs filters
 */
function putGoogleCalendarLink()
{
	$.ajax({ url : 'core/api/calendar-prefs/get', success : function(response)
	{
		if (response)
		{
			$("#google_cal").removeClass('hide');
			$("#google_cal_link").addClass('hide');
		}
		else
		{
			$("#google_cal").addClass('hide');
			$("#google_cal_link").removeClass('hide');
		}

	} });
}

function putOfficeCalendarLink()
{
	var calEnable = false;

	$.ajax({ url : 'core/api/officecalendar', async : false, success : function(response)
	{
		if (response)
			calEnable = true;

	} });

	if (calEnable)
	{
		$("#office_cal").removeClass('hide');
		$("#office_cal_link").addClass('hide');
	}

	else
	{
		$("#office_cal").addClass('hide');
		$("#office_cal_link").removeClass('hide');
	}
}

/**
 * fetches and renders events in full calendar
 * @param ownerid
 */
function renderFullCalenarEvents(ownerid)
{
	var start_end_time = JSON.parse(readCookie('fullcalendar_start_end_time'));

	var eventsURL = '/core/api/events?start=' + start_end_time.startTime + "&end=" + start_end_time.endTime;

	eventsURL += '&owner_id=' + ownerid;
	console.log('-----------------', eventsURL);
	$.getJSON(eventsURL, function(doc)
	{
		$.each(doc, function(index, data)
		{
			data = renderEventBasedOnOwner(data);
		});

		// Add event
		$('#calendar_event').fullCalendar('addEventSource', doc);

		showLoadingOnCalendar(false);

	});

}

/**
 * removed full calendar events based on ids
 * @param ownerid
 */
function removeFullCalendarEvents(ownerid)
{
	var start_end_time = JSON.parse(readCookie('fullcalendar_start_end_time'));

	var eventsURL = '/core/api/events?start=' + start_end_time.startTime + "&end=" + start_end_time.endTime;

	eventsURL += '&owner_id=' + ownerid;
	console.log('-----------------', eventsURL);
	$.getJSON(eventsURL, function(doc)
	{
		var ids = [];
		$.each(doc, function(index, data)
		{
			ids.push(data);	
		});

		// Removes all events at once
		$('#calendar_event').fullCalendar('removeEvents', ids);
		showLoadingOnCalendar(false);
	});
}


/**
 * if agile calenar is unchecked then from cookie it removes all userids and puts only current userid
 * @param uncheckedagile
 * @returns {String}
 */
function getOwnerIdsFromCookie(uncheckedagile)
{
	var eventFilters = JSON.parse(readCookie('event-lhs-filters'));
	var agile_event_owners = '';
	if (eventFilters)
	{
		var type_of_cal = eventFilters.cal_type;

		var owners = eventFilters.owner_ids;

		if (uncheckedagile && owners.length >= 1)
			owners = [];
		owners.push(CURRENT_AGILE_USER.id);
		if (owners && owners.length > 0)
		{
			$.each(owners, function(index, value)
			{
				if (index >= 1)
					agile_event_owners += ",";
				agile_event_owners += value;
			});
		}
	}
	return agile_event_owners;
}


/**
 * fetches google events
 */
function loadGoogleEventsandRender()
{
	var start_end_time = JSON.parse(readCookie('fullcalendar_start_end_time'));
	$.getJSON('core/api/calendar-prefs/get', function(response)
	{
		console.log(response);
		if (response)
		{
			createCookie('google_event_token', response.access_token);

			head.js('https://apis.google.com/js/client.js', '/lib/calendar/gapi-helper.js',
					function()
					{
						setupGC(function()
						{

							gapi.auth.setToken({ access_token : response.access_token, state : "https://www.googleapis.com/auth/calendar" });

							var startDate = new Date(start_end_time.startTime * 1000);
							var gDateStart = startDate.toISOString();
							var endDate = new Date(start_end_time.endTime * 1000);
							var gDateEnd = endDate.toISOString();
							var request = gapi.client.calendar.events.list({ 'calendarId' : 'primary', singleEvents : true, timeMin : gDateStart,
								timeMax : gDateEnd });
							request.execute(function(resp)
							{

								if (resp)
								{
									for (var i = 0; i < resp.items.length; i++)
									{
										var fc_event = google2fcEvent(resp.items[i]);

										if (fc_event)
											$('#calendar_event').fullCalendar('renderEvent', fc_event);

									}
								}

							});

						});

					});
		}

	});
}


/**
 * renders event to fullcalednar by changing color based on Owner id
 * @param data
 */
function renderAddedEventToFullCalenarBasedOnCookie(data)
{
	try
	{
		var renderEvent = false;
		var current_user_checked = false;
		var eventFilters = JSON.parse(readCookie('event-lhs-filters'));

		if (eventFilters)
		{
			var type_of_cal = eventFilters.cal_type;
			for ( var cal in type_of_cal)
			{
				if (type_of_cal[cal] == "agile")
					current_user_checked = true;
			}
		}
		if (data.owner.id == CURRENT_DOMAIN_USER.id && current_user_checked)
		{
			renderEvent = true;
		}

		if (eventFilters && !renderEvent)
		{
			var domain_users = eventFilters.domain_user_ids;
			if (domain_users && domain_users.length > 0)
			{
				$.each(domain_users, function(index, value)
				{
					if (value == data.owner.id)
						renderEvent = true;
				});
			}
		}
		if (renderEvent)
		{
			$('#calendar_event').fullCalendar('renderEvent', data);
		}
	}
	catch (err)
	{
		console.log("error");
	}
}


/**
 * sets color to event based on owner id
 * @param data
 * @returns {___anonymous8560_8563}
 */
function renderEventBasedOnOwner(data)
{
	try
	{
		if (data.owner)
		{
			if (data.owner.id == CURRENT_DOMAIN_USER.id)
			{
				if (data.color == 'red' || data.color == '#f05050')
					data.className = 'fc-b-l fc-b-2x fc-b-danger fc-border-height fc-event-month';
				else if (data.color == 'green' || data.color == '#bbb')
					data.className = 'fc-b-l fc-b-2x fc-b-info fc-border-height fc-event-month';
				else if (data.color == '#36C' || data.color == '#23b7e5' || data.color == 'blue')
					data.className = 'fc-b-l fc-b-2x fc-b-warning fc-border-height fc-event-month';
				data.color = '';
				data.backgroundColor = '#fff';
			}

			else
			{
				if (data.color == 'red' || data.color == '#f05050')
					data.className = 'high fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month';
				else if (data.color == 'green' || data.color == '#bbb')
					data.className = 'low fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month';
				else if (data.color == '#36C' || data.color == '#23b7e5' || data.color == 'blue')
					data.className = 'normal fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month';
				data.color = '';
				data.backgroundColor = '#fff';
			}
		}

	}
	catch (err)
	{
		console.log("error");
	}
	return data;
}


/**
 * while editing event in full calendar its priority will be set based on color of event
 * @param event
 * @returns {___anonymous10119_10123}
 */
function revertEventColorBasedOnPriority(event)
{
	if (event.className == "fc-b-l,fc-b-2x,fc-b-danger,fc-border-height,fc-event-month" || event.className == "high,fc-b-l,fc-b-2x,fc-b-light,fc-border-height,fc-event-month" || event.className == "fc-b-l fc-b-2x fc-b-danger fc-border-height fc-event-month" || event.className == "high fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month")
		event.color = "red";
	else if (event.className == "fc-b-l,fc-b-2x,fc-b-info,fc-border-height,fc-event-month" || event.className == "low,fc-b-l,fc-b-2x,fc-b-light,fc-border-height,fc-event-month" || event.className == "fc-b-l fc-b-2x fc-b-info fc-border-height fc-event-month" || event.className == "low fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month")
		event.color = "green";
	else if (event.className == "fc-b-l,fc-b-2x,fc-b-warning,fc-border-height,fc-event-month" || event.className == "normal,fc-b-l,fc-b-2x,fc-b-light,fc-border-height,fc-event-month" || event.className == "fc-b-l fc-b-2x fc-b-warning fc-border-height fc-event-month" || event.className == "normal fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month")
		event.color = "#36C";
	return event;

}

/**
 * shows loading symbol while fetching events
 * @param loading
 */
function showLoadingOnCalendar(loading)
{
	if (loading)
	{
		$("#loading_calendar_events").remove();
		$('.fc-header-left').append(
				'<span id="loading_calendar_events" style="margin-left:5px;vertical-align:middle;padding-top: 5px;position: absolute;">loading...</span>')
				.show();
		$('.fc-header-left').show();
	}
	else
	{
		$("#loading_calendar_events").hide();
	}
}
/**
 * 
 * event.js is a script file to deal with the actions like creation, update and
 * deletion of events from client side.
 * 
 * @module Activities
 * 
 * author: Rammohan
 */

$(function(){

/**
	 * shows description field in new event model
	 */
	$("#updateActivityModal").on('click', '#add_event_desctiption', function(e)
	{
		e.preventDefault();
		$(".event_discription").removeClass("hide");
		$(this).hide();
		return;
	});


	$("#activityModal").on('click', '#add_event_desctiption', function(e)
	{
		e.preventDefault();
		$(".event_discription").removeClass("hide");
		$(this).hide();
		return;
	});

/**
	 * When clicked on update button of event-update-modal, the event will get
	 * updated by calling save_event function
	 * 
	 */
	$("#updateActivityModal").on('click', '#update_event_validate', function(e)
	{
		e.preventDefault();
		var eventId = $('#updateActivityModal').find("input[type='hidden']").val();
		save_event('updateActivityForm', 'updateActivityModal', true, this, function(data)
		{
			console.log(data);
			var eventModel = eventCollectionView.collection.get(eventId);
			eventModel.set(data.toJSON(), { merge : true });
			eventCollectionView.render(true);
		});

	});



$("#updateActivityModal").on('click', '#delete_web_event', function(e)
	{
		e.preventDefault();

		var event_id = $('#updateActivityForm input[name=id]').val();
		$("#updateActivityModal").modal('hide');
		$("#webEventCancelModel").modal('show');
		$("#cancel_event_title").html("Delete event &#39" + web_event_title + "&#39?");
		$("#event_id_hidden").html("<input type='hidden' name='event_id' id='event_id' value='" + event_id + "'/>");

	});


$("#updateActivityModal").on(
					'click',
					'#event_delete',
					function(e)
					{
						e.preventDefault();

						if ($(this).attr('disabled') == 'disabled')
							return;

						/**
						 * Confirmation alert to delete an event
						 */
						if (!confirm("Are you sure you want to delete?"))
							return;

						var event_id = $('#updateActivityForm input[name=id]').val();
						var save_button = $(this);

						disable_save_button(save_button);
						/**
						 * Shows loading symbol until model get saved
						 */
						// $('#updateActivityModal').find('span.save-status').html(getRandomLoadingImg());
						$
								.ajax({
									url : 'core/api/events/' + event_id,
									type : 'DELETE',
									success : function()
									{
										// if event deleted from today events
										// portlet, we removed that event from
										// portlet events collection
										if (App_Portlets.currentPosition && App_Portlets.todayEventsCollection && App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)] && (Current_Route == undefined || Current_Route == 'dashboard'))
										{
											App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection
													.remove(App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.get(event_id));

											App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].render(true);

										}	
										else if (App_Portlets.currentPortletName && App_Portlets.currentPortletName == 'Mini Calendar')
									      {
												var a=new Date(parseInt($('.minical-portlet-event').attr('data-date')));	
												a.setHours(0,0,0,0);
												createCookie("current_date_calendar",a);
										       $('#calendar_container').fullCalendar( 'refetchEvents' );
										       App_Portlets.refetchEvents = true;
										       //eraseCookie('current_date_calendar');
									      }
										else if (App_Deal_Details.dealDetailView && Current_Route == "deal/" + App_Deal_Details.dealDetailView.model.get('id'))
										{

											if (dealEventsView && dealEventsView.collection)
											{
												if (dealEventsView.collection.get(event_id))
												{
													dealEventsView.collection.remove(event_id);
													dealEventsView.render(true);
												}
											}
										}

										// $('#updateActivityModal').find('span.save-status
										// img').remove();
										enable_save_button(save_button);
										$("#updateActivityModal").modal('hide');

										var eventId = $('#updateActivityModal').find("input[type='hidden']").val();
										$('#calendar_event').fullCalendar('removeEvents', eventId);
									} });
						if (readCookie("agile_calendar_view"))
						{
							var eventModel = eventCollectionView.collection.get(event_id);
							eventModel.set(eventModel, { remove : true });
							document.location.reload();

						}

					});

	

/**
	 * Highlights the event features (Shows event form and hides task form,
	 * changing color and font-weight)
	 */
		/**
	 * when web appointment event is deleted this event will be fired out
	 */
	$("#webEventCancelModel")
			.on(
					'click',
					'#cancel_delete',
					function(e)
					{
						e.preventDefault();

						var event_id = $('#webEventCancelForm input[name=event_id]').val();

						var parameter_value = $(this).attr("action_parameter");

						if (parameter_value == "donotdelete")
						{
							$("#webEventCancelModel").modal('hide');
							return;
						}
						var cancel_reason = $('#webEventCancelForm textarea[name=appointment_cancel_reason]').val();
						// variable
						var save_button = $(this);

						disable_save_button(save_button);
						$
								.ajax({
									url : 'core/api/events/cancelwebevent/?eventid=' + event_id + '&cancelreason=' + cancel_reason + '&action_parameter=' + parameter_value,
									type : 'DELETE',
									success : function()
									{
										// if event deleted from today events
										// portlet, we removed that event from
										// portlet events collection
										if (App_Portlets.currentPosition && App_Portlets.todayEventsCollection && App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)] && (Current_Route == undefined || Current_Route == 'dashboard'))
										{
											App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection
													.remove(App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.get(event_id));

											App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].render(true);

										}
										else if (App_Contacts.contactDetailView && Current_Route == "contact/" + App_Contacts.contactDetailView.model.get('id'))
										{
											var eventModel = eventsView.collection.get(event_id);
											eventsView.collection.remove(eventModel);
											enable_save_button(save_button);

											$("#webEventCancelModel").modal('hide');
											contact_details_tab.load_events();
											return;
										}

										// $('#updateActivityModal').find('span.save-status
										// img').remove();
										enable_save_button(save_button);

										$("#webEventCancelModel").modal('hide');

										$('#calendar_event').fullCalendar('removeEvents', event_id);
									} });
						if (readCookie("agile_calendar_view"))
						{
							var eventModel = eventCollectionView.collection.get(event_id);
							eventModel.set(eventModel, { remove : true });
							document.location.reload();

						}

					});


	

});


function initializeEventListners(el)
{

/**
 * When Send Mail is clicked from Ical Modal, it hides the ical modal and shows
 * the ical-send email modal.
 */
$("#icalModal").off('click');
$("#icalModal").on('click', '#send-ical-email', function(event)
{
	event.preventDefault();

	$("#icalModal").modal('hide');


	// Removes previous modals if exist.
	if ($('#share-ical-by-email').size() != 0)
		$('#share-ical-by-email').remove();

	// Gets current user
	var CurrentuserModel = Backbone.Model.extend({ url : '/core/api/users/current-user', restKey : "domainUser" });

	var currentuserModel = new CurrentuserModel();

	currentuserModel.fetch({ success : function(data)
	{

		var model = data.toJSON();

		// Insert ical-url into model
		var icalURL = $('#icalModal').find('#ical-feed').text();
		model.ical_url = icalURL;

		getTemplate("share-ical-by-email", model, undefined, function(template_ui){
			if(!template_ui)
				  return;
			
			var emailModal = $(template_ui);
			var description = $(emailModal).find('textarea').val();
			description = description.replace(/<br\/>/g, "\r\n");
			$(emailModal).find('textarea').val(description);
			emailModal.modal('show');

			// Send ical info email
			send_ical_info_email(emailModal);
		}, null);

	} });
});


$("#calendar-listers").on('click', '.agendaDayWeekMonth', function()
{
	currentView = $(this).attr('id');
	fullCal.fullCalendar('changeView', currentView);
	$(this).parent().find('button').each(function()
	{
		if ($(this).attr('id') == currentView)
			$(this).addClass('bg-light');
		else
			$(this).removeClass('bg-light');
	});
	if (currentView == "agendaDay" || currentView == "agendaWeek")
	{
		fullCal.fullCalendar('option', 'contentHeight', 575);
	}
	else
	{
		fullCal.fullCalendar('option', 'contentHeight', 400);
	}

});

	$('#calendar-listers').on('click', '.agendaDayWeekMonth', function()
	{
		currentView = $(this).attr('id');
		fullCal.fullCalendar('changeView', currentView);
		$(this).parent().find('button').each(function()
		{
			if ($(this).attr('id') == currentView)
				$(this).addClass('bg-light');
			else
				$(this).removeClass('bg-light');
		});

	});

	/**
	 * Shows the event form fields in activity modal
	 */
	$("#calendar-listers").on('click', '.add-event', function(e)
	{
		e.preventDefault();

		$('#activityModal').html(getTemplate("new-event-modal")).modal('show');

		agile_type_ahead("event_relates_to_deals", $('#activityModal'), deals_typeahead, false,null,null,"core/api/search/deals",false, true);
		highlight_event();
		return;
	});

	
	

	// evnet filters

	$("#calendar-listers").on('click', '.calendar_check', function(e)
	{
		showLoadingOnCalendar(true);
		createRequestUrlBasedOnFilter();
		var calendar = $(this).val();
		var ownerids = '';
		if (calendar == "agile")
		{
			if (this.checked == true)
			{
				ownerids = getOwnerIdsFromCookie(true);
				renderFullCalenarEvents(ownerids);
			}

			else
			{
				ownerids = getOwnerIdsFromCookie(true);
				removeFullCalendarEvents(ownerids);
			}

		}

		if (calendar == "google")
			loadFullCalednarOrListView();

	});

	$("#calendar-listers").on('click', '.calendar_user_check', function(e)
	{
		showLoadingOnCalendar(true);
		// checkBothCalWhenNoCalSelected();
		createRequestUrlBasedOnFilter();
		// loadFullCalednarOrListView();
		var user_id = $(this).val();
		if (this.checked == true)
		{
			renderFullCalenarEvents(user_id);
		}
		else
		{
			removeFullCalendarEvents(user_id);
		}

		// $('.select_all_users').removeAttr("checked");

	});

	$("#calendar-listers").on('click', '.select_all_users', function(event)
	{ // on click
		if (this.checked)
		{ // check select status
			$('.calendar_user_check').each(function()
			{
				this.checked = true;
			});
		}
		else
		{
			$('.calendar_user_check').each(function()
			{ // loop through each checkbox
				if ($(this).val() != CURRENT_AGILE_USER.id)
					this.checked = false;
			});
		}
		createRequestUrlBasedOnFilter();
		loadFullCalednarOrListView();
	});




}






$(function()
{
	/**
	 * Shows activity modal, and highlights the event form features (Shows event
	 * form and hides task form, changes color and font-weight)
	 * 
	 */
	
	  $("body").on('click', '#show-activity', function(e) { 
	  		e.preventDefault();

	 		highlight_event();
	  		$('#activityModal').html(getTemplate("new-event-modal")).modal('show');
	  });

	/**
	 * Sets the start time with current time and end time half an hour more than
	 * start time, when they have no values by the time the modal is shown.
	 */
	$('#activityModal, #activityTaskModal').on('shown.bs.modal', function()
	{
		// Show related to contacts list
		var el = $("#activityForm");
		agile_type_ahead("event_related_to", el, contacts_typeahead);

		agile_type_ahead("event_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);

		/**
		 * Fills current time only when there is no time in the fields
		 */
		if ($('.start-timepicker').val() == '')
			$('.start-timepicker').val(get_hh_mm());

		if ($('.end-timepicker').val() == '')
			$('.end-timepicker').val(get_hh_mm(true));
		// sets the time in time picker if it is empty
		if ($('.new-task-timepicker').val() == '')
			$('.new-task-timepicker').val("12:00");

		// Update will highlight the date of in date picker
		$("input.date").datepicker('update');

	});

	/**
	 * To avoid showing previous errors of the modal.
	 */
	$('#updateActivityModal').on('show.bs.modal', function()
	{
		// Show related to contacts list
		var el = $("#updateActivityForm");
		agile_type_ahead("event_related_to", el, contacts_typeahead);
		
		agile_type_ahead("event_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);

		if ($('#updateActivityModal #allDay').is(':checked'))
		{
			$('#update-event-time-1').closest('.control-group').hide();
			$('#update-event-date-2').closest('.row').hide();
		}

		// Removes alert message of error related date and time.
		$('#' + this.id).find('.alert').css('display', 'none');

		// Removes error class of input fields
		$('#' + this.id).find('.error').removeClass('error');

		$("input.date").datepicker('update');

	});

	/**
	 * To avoid showing previous errors of the modal.
	 */
	$('#activityModal, #activityTaskModal').on('show.bs.modal', function(e)
	{
		$(".event_discription").addClass("hide");
		$("textarea#description").val('');
		// Removes alert message of error related date and time.
		$('#' + this.id).find('.alert').css('display', 'none');

		// Removes error class of input fields
		$('#' + this.id).find('.error').removeClass('error');

		var isOwnerListUploded = $("#event-owners-list", $("#activityForm")).val();
		if (isOwnerListUploded == null)
		{
			// Fills owner select element
			populateUsers("event-owners-list", $("#activityForm"), undefined, undefined, function(data)
			{
				$("#activityForm").find("#event-owners-list").html(data);
				$("#event-owners-list", $("#activityForm")).find('option[value=' + CURRENT_DOMAIN_USER.id + ']').attr("selected", "selected");
				$("#event-owners-list", $("#activityForm")).closest('div').find('.loading-img').hide();
			});
		}

		/**
		 * Activates the date picker to the corresponding fields in activity modal
		 * and activity-update modal
		 */

		var eventDate = $('#event-date-1').datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY }).on('changeDate', function(ev)
		{
			// If event start date is changed and end date is less than start date,
			// change the value of the end date to start date.
			var eventDate2;
			if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
				eventDate2 = new Date(convertDateFromUKtoUS($('#event-date-2').val()));
			else
			 	eventDate2 = new Date($('#event-date-2').val());
			if (ev.date.valueOf() > eventDate2.valueOf())
			{
				$('#event-date-2').val($('#event-date-1').val());
			}

		});


		$('#event-date-2').datepicker({ format : CURRENT_USER_PREFS.dateFormat , weekStart : CALENDAR_WEEK_START_DAY});
		$('#update-event-date-1').datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY }).on('changeDate', function(ev)

		{
			// If event start date is changed and end date is less than start date,
			// change the value of the end date to start date.
			var eventDate2;
			if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
				eventDate2 = new Date(convertDateFromUKtoUS($('#update-event-date-2').val()));
			else
			 	eventDate2 = new Date($('#update-event-date-2').val());
			if (ev.date.valueOf() > eventDate2.valueOf())
			{
				$('#update-event-date-2').val($('#update-event-date-1').val());
			}

		});

		$('#update-event-date-2').datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY });


		/**
		 * Activates time picker for start time to the fields with class
		 * start-timepicker
		 */
		$('.start-timepicker').timepicker({ defaultTime : 'current', showMeridian : false }).on('hide.timepicker', function(e)
		{
			if ($('#activityModal #allDay').is(':checked'))
			{
				$('#event-time-1').closest('.control-group').hide();
				$('#event-date-2').closest('.row').hide();
			}

			// ChangeTime event is not working, so need to invoke user method.
			var endTime = changeEndTime($('.start-timepicker').val().split(":"), $('.end-timepicker').val().split(":"));
			$('.end-timepicker').val(endTime);

			e.stopImmediatePropagation();
			return false;
		});
		$('.start-timepicker').timepicker().on('show.timepicker', function(e)
		{
			if ($('.start-timepicker').prop('value') != "" && $('.start-timepicker').prop('value') != undefined)
			{
				if ($('.start-timepicker').prop('value').split(":")[0] != undefined)
					e.time.hours = $('.start-timepicker').prop('value').split(":")[0];
				if ($('.start-timepicker').prop('value').split(":")[0] != undefined)
					e.time.minutes = $('.start-timepicker').prop('value').split(":")[1];
			}
			$('.bootstrap-timepicker-hour').val(e.time.hours);
			$('.bootstrap-timepicker-minute').val(e.time.minutes);
		});

		/**
		 * Activates time picker for end time to the fields with class
		 * end-timepicker
		 */
		$('.end-timepicker').timepicker({ defaultTime : get_hh_mm(true), showMeridian : false });
		console.log(get_hh_mm(true));
		$('.end-timepicker').timepicker().on('show.timepicker', function(e)
		{
			if ($('.end-timepicker').prop('value') != "" && $('.end-timepicker').prop('value') != undefined)
			{
				if ($('.end-timepicker').prop('value').split(":")[0] != undefined)
					e.time.hours = $('.end-timepicker').prop('value').split(":")[0];
				if ($('.end-timepicker').prop('value').split(":")[0] != undefined)
					e.time.minutes = $('.end-timepicker').prop('value').split(":")[1];
			}
			$('.bootstrap-timepicker-hour').val(e.time.hours);
			$('.bootstrap-timepicker-minute').val(e.time.minutes);
		});

		/**
		 * Activates time picker for start time to the fields with class
		 * update-start-timepicker
		 */
		$('.update-start-timepicker').timepicker({ defaultTime : 'current', showMeridian : false }).on('hide.timepicker', function(e)
		{
			// ChangeTime event is not working, so need to invoke user method.
			var endTime = changeEndTime($('.update-start-timepicker').val().split(":"), $('.update-end-timepicker').val().split(":"));
			$('.update-end-timepicker').val(endTime); 
		});
		$('.update-start-timepicker').timepicker().on('show.timepicker', function(e)
		{
			if ($('.update-start-timepicker').prop('value') != "" && $('.update-start-timepicker').prop('value') != undefined)
			{
				if ($('.update-start-timepicker').prop('value').split(":")[0] != undefined)
					e.time.hours = $('.update-start-timepicker').prop('value').split(":")[0];
				if ($('.update-start-timepicker').prop('value').split(":")[0] != undefined)
					e.time.minutes = $('.update-start-timepicker').prop('value').split(":")[1];
			}
			$('.bootstrap-timepicker-hour').val(e.time.hours);
			$('.bootstrap-timepicker-minute').val(e.time.minutes);
		});

		/**
		 * Activates time picker for end time to the fields with class
		 * update-end-timepicker
		 */
		$('.update-end-timepicker').timepicker({ defaultTime : get_hh_mm(true), showMeridian : false });
		$('.update-end-timepicker').timepicker().on('show.timepicker', function(e)
		{
			if ($('.update-end-timepicker').prop('value') != "" && $('.update-end-timepicker').prop('value') != undefined)
			{
				if ($('.update-end-timepicker').prop('value').split(":")[0] != undefined)
					e.time.hours = $('.update-end-timepicker').prop('value').split(":")[0];
				if ($('.update-end-timepicker').prop('value').split(":")[0] != undefined)
					e.time.minutes = $('.update-end-timepicker').prop('value').split(":")[1];
			}
			$('.bootstrap-timepicker-hour').val(e.time.hours);
			$('.bootstrap-timepicker-minute').val(e.time.minutes);
		});

	});

	/**
	 * Hide event of update task modal. Removes the relatedTo field elements if
	 * any, when the modal is hidden in order to not to show them again when the
	 * modal is shown next
	 * 
	 */
	$('#updateActivityModal').on('hidden.bs.modal', function()
	{

		if ($(this).hasClass('in'))
		{
			return;
		}

		$("#updateActivityForm").each(function()
		{
			this.reset();
		});

		$("#updateActivityForm").find("li").remove();
		$('#update-event-time-1').closest('.control-group').show();
		$('#update-event-date-2').closest('.row').show();
	});
	
	$('#webEventCancelModel').on('hidden.bs.modal', function()
	{
		$("#webEventCancelForm").each(function()
		{
			this.reset();
		});
	});

});




/**
 * Highlights the event portion of activity modal (Shows event form and hides
 * task form, changes color and font-weight)
 */
function highlight_event()
{
	$("#hiddentask").val("event");
	$("#event").css({ "color" : "black" });
	$("#task").css({ "color" : "red" });
	$("#relatedTask").css("display", "none");
	$("#relatedEvent").css("display", "block");

	if ($("#taskForm").find("#task_related_to").closest(".controls").find("ul").children())
		$("#activityForm").find("#event_related_to").closest(".controls").find("ul").html(
				$("#taskForm").find("#task_related_to").closest(".controls").find("ul").children());

	// Date().format('mm/dd/yyyy'));
	$('input.date').val(getDateInFormat(new Date()));
}

/**
 * 
 * Validates the start time and end time of an event (start time should be less
 * than end time)
 * 
 * @method is_valid_range
 * @param {Number}
 *            startDate start date of an event
 * @param {Number}
 *            endDate end date of an event
 * @param {Number}
 *            startTime start time of an event
 * @param {Number}
 *            endTime end time of an event
 * @param {String}
 *            modalId the unique id for the modal to identify it
 */
function is_valid_range(startDate, endDate, startTime, endTime, modalName)
{
	if (endDate - startDate >= 86400000)
	{
		return true;
	}
	else if (startDate > endDate)
	{
		$('#' + modalName)
				.find(".invalid-range")
				.html(
						'<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times</a>Start date should not be greater than end date. Please change.</div>');

		return false;
	}
	else if (parseInt(startTime[0]) > parseInt(endTime[0]))
	{
		$('#' + modalName)
				.find(".invalid-range")
				.html(
						'<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times</a>Start time should not be greater than end time. Please change.</div>');

		return false;
	}
	else if (parseInt(startTime[0]) == parseInt(endTime[0]) && parseInt(startTime[1]) >= parseInt(endTime[1]))
	{
		$('#' + modalName)
				.find(".invalid-range")
				.html(
						'<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times</a>Start time should not be greater or equal to end time. Please change.</div>');

		return false;
	}
	else
		return true;
}

// Save event

/**
 * Creates or updates an event and renders the saved object by verifying if the
 * event is updated or saved as new one.
 * 
 * @method save_event
 * @param {String}
 *            formId the unique id for the form to identify it
 * @param {String}
 *            modalId the unique id for the modal to identify it
 * @param {Boolean}
 *            isUpdate the boolean value to identify weather saving the new one
 *            or updating the existing one
 * 
 */
function save_event(formId, modalName, isUpdate, saveBtn, callback)
{

	// Returns, if the save button has disabled attribute
	if ($(saveBtn).attr('disabled'))
		return;

	// Disables save button to prevent multiple click event issues
	disable_save_button($(saveBtn));

	// Save functionality for event
	if (!isValidForm('#' + formId))
	{

		// Removes disabled attribute of save button
		enable_save_button($(saveBtn));
		return false;

	}

	var json = serializeForm(formId);

	if (json.allDay)
	{
		json.end = json.start;
		json.start_time = "00:00";
		json.end_time = "23:45";
	}// for all day, assume ending in last of that day.

	// For validation
	if (!is_valid_range(json.start * 1000, json.end * 1000, (json.start_time).split(":"), (json.end_time).split(":"), modalName))
	{

		// Removes disabled attribute of save button
		enable_save_button($(saveBtn));
		return;
	}

	// Show loading symbol until model get saved
	// $('#' + modalName).find('span.save-status').html(getRandomLoadingImg());

	// Appending start time to start date
	var startarray = (json.start_time).split(":");
	json.start = new Date(json.start * 1000).setHours(startarray[0], startarray[1]) / 1000.0;

	// Appending end time to end date
	var endarray = (json.end_time).split(":");
	json.end = new Date(json.end * 1000).setHours(endarray[0], endarray[1]) / 1000.0;

	$('#' + modalName).modal('hide');

	$('#' + formId).each(function()
	{
		this.reset();
	});

	// Deleting start_time and end_time from json
	delete json.start_time;
	delete json.end_time;

	var eventModel = new Backbone.Model();
	eventModel.url = 'core/api/events';
	eventModel
			.save(
					json,
					{ success : function(data)
					{

						// Removes disabled attribute of save button
						enable_save_button($(saveBtn));// $(saveBtn).removeAttr('disabled');

						$('#' + formId).each(function()
						{
							this.reset();
						});

						// $('#' + modalName).find('span.save-status
						// img').remove();
						$('#' + modalName).modal('hide');

						// $('#calendar').fullCalendar( 'refetchEvents' );
						var event = data.toJSON();
						event = renderEventBasedOnOwner(event);
						if (Current_Route == 'calendar' && !readCookie("agile_calendar_view"))
						{

							// When updating an event remove the old event from
							// fullCalendar
							if (isUpdate)

								$('#calendar_event').fullCalendar('removeEvents', json.id);

							// renders Event to full calendar based on Owner
							// checked or unchecked
							renderAddedEventToFullCalenarBasedOnCookie(event);
						}
						// Updates data to temeline
						else if (App_Contacts.contactDetailView && Current_Route == "contact/" + App_Contacts.contactDetailView.model.get('id'))
						{

							/*
							 * Verifies whether the added task is related to the
							 * contact in contact detail view or not
							 */
							$.each(event.contacts, function(index, contact)
							{
								if (contact.id == App_Contacts.contactDetailView.model.get('id'))
								{

									// Add model to collection. Disabled sort
									// while adding and
									// called
									// sort explicitly, as sort is not working
									// when it is called
									// by add
									// function
									if (eventsView && eventsView.collection)
									{
										if (eventsView.collection.get(data.id))
										{
											eventsView.collection.get(data.id).set(new BaseModel(data));
										}
										else
										{
											eventsView.collection.add(new BaseModel(data), { sort : false });
											eventsView.collection.sort();
										}
									}

									// Activates "Timeline" tab and its tab
									// content in
									// contact detail view
									// activate_timeline_tab();
									// add_entity_to_timeline(data);

									return false;
								}

							});
						}
						else if (App_Portlets.currentPosition && App_Portlets.todayEventsCollection && App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)] && (Current_Route == undefined || Current_Route == 'dashboard'))
						{
							if (isUpdate)
								App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.remove(json);

							// Updates events list view
							App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.add(data);

							App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].render(true);

						}
						else if (App_Portlets.currentPortletName && App_Portlets.currentPortletName == 'Mini Calendar')
					      {
							if($('.minical-portlet-event').attr('data-date')!=undefined){
								var a=new Date(parseInt($('.minical-portlet-event').attr('data-date')));	
								a.setHours(0,0,0,0);
								createCookie("current_date_calendar",a);
							}
							else{
								var a=new Date(parseInt($('.minical-portlet-event-add').attr('data-date')));	
								a.setHours(0,0,0,0);
								createCookie("current_date_calendar",a);
							}
							$('#calendar_container').fullCalendar( 'refetchEvents' );
						       App_Portlets.refetchEvents = true;
						       //eraseCookie('current_date_calendar');
					      }
						else if (App_Deal_Details.dealDetailView && Current_Route == "deal/" + App_Deal_Details.dealDetailView.model.get('id'))
						{

							/*
							 * Verifies whether the added task is related to the
							 * contact in contact detail view or not
							 */
							$.each(event.deal_ids, function(index, deal_id)
							{
								if (deal_id == App_Deal_Details.dealDetailView.model.get('id'))
								{

									// Add model to collection. Disabled sort
									// while adding and
									// called
									// sort explicitly, as sort is not working
									// when it is called
									// by add
									// function
									if (dealEventsView && dealEventsView.collection)
									{
										if (dealEventsView.collection.get(data.id))
										{
											dealEventsView.collection.get(data.id).set(new BaseModel(data));
										}
										else
										{
											dealEventsView.collection.add(new BaseModel(data), { sort : false });
											dealEventsView.collection.sort();
										}
									}
									dealEventsView.render(true);
									return false;
								}

							});
						}
						
						else
							App_Calendar.navigate("calendar", { trigger : true });

						if (callback && typeof callback === 'function')
							callback(data);
					} });
}

/**
 * Get Hours and Minutes for the current time. It will be padded for 15 minutes
 * 
 * @method get_hh_mm
 * @param {Boolean}
 *            end_time to make end time 30 minutes more than start time
 * 
 */
function get_hh_mm(end_time, editFromContactPage)
{

	var hours = new Date().getHours();
	var minutes = new Date().getMinutes();

	if (minutes % 15 != 0)
		minutes = minutes - (minutes % 15);

	// Make end time 30 minutes more than start time
	if (end_time)
	{
		if (minutes == "30")
		{
			hours = hours + 1;
			minutes = 0;
		}
		else if (minutes == "45")
		{
			hours = hours + 1;
			minutes = 15;
		}
		else
			minutes = minutes + 30;
	}

	if (hours < 10)
	{
		hours = "0" + hours;
	}
	if (minutes < 10)
	{
		minutes = "0" + minutes;
	}

	return hours + ':' + minutes;
}

function fillTimePicker(end_time)
{
	if (end_time)
	{
		var hours = new Date(end_time * 1000).getHours();
		var minutes = new Date(end_time * 1000).getMinutes();
		if (hours < 10)
		{
			hours = "0" + hours;
		}
		if (minutes < 10)
		{
			minutes = "0" + minutes;
		}

		return hours + ':' + minutes;
	}
}

// Fills owner select element in update activity modal form
function populateUsersInUpdateActivityModal(event)
{

	// Fills owner select element
	populateUsers("event-owners-list", $("#updateActivityForm"), event, 'eventOwner', function(data)
	{
		$("#updateActivityForm").find("#event-owners-list").html(data);
		if (event.owner)
		{
			$("#event-owners-list", $("#updateActivityForm")).find('option[value="' + event['owner'].id + '"]').attr("selected", "selected");
		}
		$("#event-owners-list", $("#updateActivityForm")).closest('div').find('.loading-img').hide();
	});
}

// Checks start time > end time and will update end time. Adds 30min to end time
// if its < start time.
function changeEndTime(startTime, endTime)
{
	console.log("In changeEndTime");
	console.log(startTime);
	console.log(endTime);

	if (startTime[0] > endTime[0] || (startTime[0] == endTime[0] && startTime[1] >= endTime[1]))
	{
		var hours = Number(startTime[0]);
		var minutes = Number(startTime[1]);

		if (minutes % 15 != 0)
			minutes = minutes - (minutes % 15);

		// Make end time 30 minutes more than start time
		if (minutes == "30")
		{
			if (hours == 23)
				hours = 0;
			else
				hours = hours + 1;
			minutes = 0;
		}
		else if (minutes == "45")
		{
			if (hours == 23)
				hours = 0;
			else
				hours = hours + 1;
			minutes = 15;
		}
		else
			minutes = minutes + 30;

		if (hours < 10)
		{
			hours = "0" + hours;
		}
		if (minutes < 10)
		{
			minutes = "0" + minutes;
		}

		console.log(hours + ':' + minutes);
		return hours + ':' + minutes;
	}
	else
		return endTime[0] + ':' + endTime[1];
}
/*!
 * FullCalendar v1.6.4 Google Calendar Plugin
 * Docs & License: http://arshaw.com/fullcalendar/
 * (c) 2013 Adam Shaw
 */

// or better


function loadUserEventsfromGoogle(users, start, end){

		load_events_from_google(function(data)
						{
							if (!data)
								return;

							return agile_transform_options(data, start, end);
						});
}

function isDefined(x)
{
	var undefined;
	return typeof x !== undefined;
}

function _init_gcal_options(users)
{
	var fc = $.fullCalendar;
	fc.sourceFetchers = [];
	// Transforms the event sources to Google Calendar Events
	fc.sourceFetchers.push(function(sourceOptions, start, end)
	{
		if (sourceOptions.dataType == 'agile-gcal')
		{

			if(users){

				loadUserEventsfromGoogle(users, start, end);
				return;

			}
			// Check whether to show the google calendar events or not.

			$.getJSON('/core/api/users/agileusers', function(users)
				{
					loadUserEventsfromGoogle(users, start, end);
				});

		}
	});

}

// Tranform agile
function agile_transform_options(sourceOptions, start, end)
{
	// Setup GC for First time
	// console.log(gapi.client.calendar);

	if (typeof gapi != "undefined" && isDefined(gapi) && isDefined(gapi.client) && isDefined(gapi.client.calendar))
	{
		_fetchGCAndAddEvents(sourceOptions, start, end);
		return;
	}

	head.js('https://apis.google.com/js/client.js', '/lib/calendar/gapi-helper.js', function()
	{
		setupGC(function()
		{
			_fetchGCAndAddEvents(sourceOptions, start, end);
		});
		return;
	});
}

// Setup Google Calendar
function setupGC(callback)
{
	console.log("Set up GC");

	// Configure Calendar
	gapi_helper.configure({ scopes : 'https://www.googleapis.com/auth/calendar', services : { calendar : 'v3' } });

	gapi_helper.when('calendarLoaded', callback);
}

function _fetchGCAndAddEvents(sourceOptions, start, end)
{
	// Set the access token
	gapi.auth.setToken({ access_token : sourceOptions.token, state : "https://www.googleapis.com/auth/calendar" });

	// Retrieve the events from primary
	var request = gapi.client.calendar.events.list({ 'calendarId' : 'primary', timeMin : ts2googleDate(start), timeMax : ts2googleDate(end),
		maxResults : 10000, // max results causes problems: http://goo.gl/FqwIFh
		singleEvents : true });

	request.execute(function(resp)
	{
		var google_events = [];
		for (var i = 0; i < resp.items.length; i++)
		{
			var fc_event = google2fcEvent(resp.items[i]);

			if (fc_event)
				google_events.push(fc_event);
				
		}

		// Add event
		$('#calendar_event').fullCalendar('addEventSource', google_events);
	});
}

// Convert a timestamp into google date format
function ts2googleDate(ts)
{
	return $.fullCalendar.formatDate($.fullCalendar.parseDate(ts), 'u');
}

// Convert Google Event to Full Calendar Event
function google2fcEvent(google)
{
	var fc = { title : google.summary || "No title", start : google.start.date || google.start.dateTime, end : google.end.date || google.end.dateTime,
		allDay : google.start.date ? true : false, google : google, // keep a
		// reference
		// to the
		// original,
		// color: 'orange',
		className : 'b-l b-2x b-dark b-b-l-r-2x b-t-l-r-2x fc_border_height', backgroundColor : '#fff', editable : false // To
	// make
	// the
	// google
	// cal
	// events
	// uneditable.
	};
	if (fc.allDay)
	{
		// subtract 1 from end date: Google all-day end dates are exclusive
		// FullCalendar's are inclusive
		var end;
		if (fc.end.length > 10)
		{
			end = $.fullCalendar.parseDate(fc.end);
			fc.end = $.fullCalendar.formatDate(end, 'yyyy-MM-dd');
		}
		else
		{
			end = new Date(fc.end);
		}
		end.setDate(end.getDate() - 1);
		fc.end = end.format('yyyy-MM-dd');

	}
	return fc;
}

// https://groups.google.com/forum/#!msg/google-api-javascript-client/ZFcvHvh3dJQ/-zKhUD5NtKgJ
/**
 * To show the dates or time in words of time-ago plugin.
 * @param element
 */
function includeTimeAgo(element){
	head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
			{
				$("time", element).timeago();
			});
}

/**
 * To fill the tasklist ordered by default 
 */
function initOwnerslist() {
	
	// Click events to agents dropdown and department
	$("body").on("click", 'ul#owner-tasks li a, ul#type-tasks li a', function(e) {
				e.preventDefault();

				// Show selected name
				var name = $(this).html(), id = $(this).attr("href");

				$(this).closest("ul").data("selected_item", id);
				$(this).closest(".btn-group").find(".selected_name")
						.text(name);
				var url = getParams();
				updateData(url);
				
	});
	$("body").on("click", 'ul#owner-tasks li a', function(e) {
		
		$('.task-heading').html($(this).html() +'&nbsp<small class="tasks-count"></small> <span style="font-size: small;color: #525252;  background-color: rgb(255,255,204);  border: 1px solid rgb(211,211,211);border-radius: 3px;padding: 3px 5px 3px 5px;">Try our <a href="#tasks-new">new look</a></span>');
		//$('.task-heading').text($(this).html());
		pieTasks(getParams()); // Show tasks only when user changes My Tasks vs All Tasks
	});
	updateData(getParams() + "&owner=" + CURRENT_DOMAIN_USER.id + "&pending=" + true);
	pieTasks(getParams() + "&owner=" + CURRENT_DOMAIN_USER.id + "&pending=" + true);
}

var allTasksListView;

/**
 * updateData() method updates chat sessions on page for different query's from
 * user
 * 
 * @param params
 *            query string contains date, agentId & widgetId
 */
function updateData(params) {
	
	// Shows loading image untill data gets ready for displaying
	$('#task-list-based-condition').html(LOADING_HTML);
	
	// Creates backbone collection view
		this.App_Calendar.allTasksListView = new Base_Collection_View({
		url : '/core/api/tasks/based' + params,
		restKey : "task",
		sort_collection : false,
		//sortKey :'due',
		templateKey : "tasks-list",
		cursor : true, page_size : 25,
		individual_tag_name : 'tr',
		postRenderCallback : function(el) {
			$('.tasks-count').html(getCount(this.App_Calendar.allTasksListView.collection.toJSON()));
			includeTimeAgo(el);
		},
		appendItemCallback : function(el)
		{
			includeTimeAgo(el);
		}

	});

	// Fetches data from server
	this.App_Calendar.allTasksListView.collection.fetch();

	// Renders data to tasks list page.
	$('#task-list-based-condition').html(this.App_Calendar.allTasksListView.render().el);

}

/**
 * getParams() method returns a string(used as query param string) contains user
 * selected type and owners
 * 
 * @returns {String} query string
 */
function getParams() {

	var params = "?";

	// Get task type and append it to params
	var type = $('#type-tasks').data("selected_item");
	if (type)
		params += ("&type=" + type);
	// Get owner name and append it to params
	var owner = $('#owner-tasks').data("selected_item");
	if(owner == 'my-pending-tasks')
	{
		params += ("&pending=" + true);
		params += ("&owner=" + CURRENT_DOMAIN_USER.id);
		return params;
	}
	if (owner)
		params += ("&owner=" + owner);
	else if(owner == undefined)
		params += ("&owner=" + CURRENT_DOMAIN_USER.id);
	
	return params;
}

/**
 * Completes the selected row related entities from the database based on the url 
 * attribute of the table and fades out the rows from the table
 * 
 * @module Bulk operation for completed task
 * ---------------------------------------------
 * 
 */

$(function(){	
   /**
    * Validates the checkbox status of each row in table body
    * Customizes the delete operation
    * Deletes the entities
    */	
	$("body").on("click", '#bulk-complete', function(event) {
		event.preventDefault();
		var index_array = [];
		var data_array = [];
		var checked = false;
		var table = $('body').find('.showCheckboxes');

		$(table).find('tr .tbody_check').each(function(index, element){
			
			// If element is checked store it's id in an array 
			if($(element).is(':checked')){
				
				// Disables mouseenter once checked for delete(To avoid popover in deals when model is checked)
				$(element).closest('tr').on("mouseenter", false);
				index_array.push(index);
				data_array.push($(element).closest('tr').data().toJSON());
				checked = true;
			}
		});
		if(checked){
			$(this).after('<img class="bulk-complete-loading" style="padding-right:5px;margin-bottom:15px" src= "img/21-0.gif"></img>');
			bulk_complete_operation('/core/api/tasks/bulk/complete', index_array, table, data_array);
		}	
		else
            $('body').find(".select-none").html('<div class="alert alert-danger"><a class="close" data-dismiss="alert" href="#">&times;</a>You have not selected any records to complete. Please select at least one record to continue.</div>').show().delay(3000).hide(1);
	
		getDueTasksCount(function(count){

			var due_task_count= count;
			if(due_task_count != 0)
				$('#due_tasks_count').html(due_task_count);
			else
				$('#due_tasks_count').html("");
		});
		
	});
	
});

/**
 * Bulk operations - delete function
 * Deletes the entities by sending their ids as form data of ajax POST request 
 * and then fades out the rows from the table
 * @method bulk_delete_operation
 * @param {Steing} url to which the request has to be sent
 * @param {Array} id_array holds array of ids of the entities to be deleted
 * @param {Array} index_array holds array of row indexes to be faded out
 * @param {Object} table content as html object
 * @param {Array} data_array holds array of entities 
 */
function bulk_complete_operation(url, index_array, table, data_array){
	
	var tasks = [];
	$.each(data_array, function(index, task){
		var contacts = task.contacts;
		task.contacts = [];
		$.each(contacts, function(i, contact){
			task.contacts.push(contact.id);
			tasks.push(task);
		});
		task.is_complete = true;
		task.owner_id = task.taskOwner.id;
	});
	$.ajax({
		url: url,
		type: 'POST',
		data: JSON.stringify(tasks),
		contentType : 'application/json',
		success: function() {
			$(".bulk-complete-loading").remove();
			
			var tbody = $(table).find('tbody');
			// To remove table rows on delete 
			for(var i = 0; i < index_array.length; i++) 
				$(tbody).find('tr:eq(' + index_array[i] + ')').find("div:lt(3)").css("text-decoration","line-through");
		}
	});
}
		/**
 * task.js is a script file to deal with all the actions (CRUD) of tasks from
 * client side.
 * 
 * @module Activities
 * 
 * author: Rammohan
 */

$( document ).ready(function() {
	/**
	 * Makes the pending task as completed by calling complete_task function
	 */
	$("body").on("click", '.tasks-select', function(e)
	{
		e.stopPropagation();
		if ($(this).is(':checked'))
		{
			// Complete
			var taskId = $(this).attr('data');
			// complete_task(taskId, $(this));
			complete_task(taskId, App_Calendar.tasksListView.collection, $(this).closest('tr'))
		}
	});

	/**
	 * Shows activity modal with all the task create fields.
	 */
	$("body").on("click", '.add-task', function(e)
	{
		e.preventDefault();

		// Show task modal with owners list.
		showTaskModal(this);
	});
	/**
	 * Show event of update task modal Activates typeahead for task-update-modal
	 */
	$('#updateTaskModal').on('shown.bs.modal', function()
	{

		var el = $("#updateTaskForm");
		agile_type_ahead("update_task_related_to", el, contacts_typeahead);

		agile_type_ahead("update_task_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);

		// Fill details in form
		setForm(el);

		

	});

	

});


function activateSliderAndTimerToTaskModal(){

	$('.update-task-timepicker').timepicker({ defaultTime : get_hh_mm(true), showMeridian : false });
	$('.update-task-timepicker').timepicker().on('show.timepicker', function(e)
	{
		if ($('.update-task-timepicker').prop('value') != "" && $('.update-task-timepicker').prop('value') != undefined)
		{
			if ($('.update-task-timepicker').prop('value').split(":")[0] != undefined)
				e.time.hours = $('.update-task-timepicker').prop('value').split(":")[0];
			if ($('.update-task-timepicker').prop('value').split(":")[0] != undefined)
				e.time.minutes = $('.update-task-timepicker').prop('value').split(":")[1];
		}
		$('.bootstrap-timepicker-hour').val(e.time.hours);
		$('.bootstrap-timepicker-minute').val(e.time.minutes);
	});
	$('.new-task-timepicker').timepicker({ defaultTime : '12:00', showMeridian : false });
	$('.new-task-timepicker').timepicker().on('show.timepicker', function(e)
	{
		if ($('.new-task-timepicker').prop('value') != "" && $('.new-task-timepicker').prop('value') != undefined)
		{
			if ($('.new-task-timepicker').prop('value').split(":")[0] != undefined)
				e.time.hours = $('.new-task-timepicker').prop('value').split(":")[0];
			if ($('.new-task-timepicker').prop('value').split(":")[0] != undefined)
				e.time.minutes = $('.new-task-timepicker').prop('value').split(":")[1];
		}
		$('.bootstrap-timepicker-hour').val(e.time.hours);
		$('.bootstrap-timepicker-minute').val(e.time.minutes);
	});

	// Loads progress slider in add task / update modal.
	loadProgressSlider($("#taskForm"));
	loadProgressSlider($("#updateTaskForm"));

	/**
	 * Date Picker Activates datepicker for task due element
	 */

	$('#task-date-1').datepicker({ format : CURRENT_USER_PREFS.dateFormat , weekStart : CALENDAR_WEEK_START_DAY});
	$('#update-task-date-1').datepicker({ format : CURRENT_USER_PREFS.dateFormat , weekStart : CALENDAR_WEEK_START_DAY});


	/**
	 * When clicked on update button of task-update-modal, the task will get
	 * updated by calling save_task function
	 */
	$('#updateTaskModal #update_task_validate').off('click');
	$("#updateTaskModal").on("click", '#update_task_validate', function(e)
	{
		e.preventDefault();
		save_task('updateTaskForm', 'updateTaskModal', true, this);
	});

	/**
	 * initialises task time picker
	 */
	$('#updateTaskModal').off('hidden.bs.modal');
	$('#updateTaskModal').on('hidden.bs.modal', function()
	{

		if ($(this).hasClass('in'))
		{
			return;
		}

		$("#updateTaskForm").find("li").remove();

		resetForm($("#updateTaskForm"));

		// Removes note from from task form
		$('#updateTaskForm #forNoteForm').html("");

		// Hide + Add note link
		$(".task-add-note", $("#updateTaskForm")).show();
	});

}

function initializeTasksListeners(){
		
	activateSliderAndTimerToTaskModal();

	/**
	 * All completed and pending tasks will be shown in separate section
	 */
	/*
	 * $('#tasks-list').on('click', function(e) { this.tasksListView = new
	 * Base_Collection_View({ url : '/core/api/tasks/all', restKey : "task",
	 * templateKey : "tasks-list", individual_tag_name : 'tr' });
	 * this.tasksListView.collection.fetch();
	 * 
	 * $('#content').html(this.tasksListView.el);
	 * 
	 * });
	 */

	 $('#tasks-list-template').on('mouseenter', '.listed-task', function(e)
	{
		$(this).find(".task-actions").css("display", "block");
		$(this).find(".task-note-action").hide();
	});

	// Hide task actions
	$('#tasks-list-template').on('mouseleave', '.listed-task', function(e)
	{
		$(this).find(".task-actions").css("display", "none");
		$(this).find(".task-note-action").show();
	});

	/*
	 * Task Action: Delete task from UI as well as DB. Need to do this manually
	 * because nested collection can not perform default functions.
	 */
	$('#tasks-list-template').on('click', '.delete-task', function(event)
	{
		if (!confirm("Are you sure you want to delete?"))
			return;

		// Delete Task.
		deleteTask(getTaskId(this), getTaskListId(this), getTaskListOwnerId(this));
	});

	// Task Action: Mark task complete, make changes in DB.
	$('#tasks-list-template').on('click', '.is-task-complete', function(event)
	{
		event.preventDefault();

		// make task completed.
		completeTask(getTaskId(this), getTaskListId(this), getTaskListOwnerId(this));
	});

	// Task Action: Open Task Edit Modal and display details in it.
	$('#tasks-list-template').on('click', '.edit-task', function(event)
	{
		event.preventDefault();

		// Show and Fill details in Task Edit modal
		editTask(getTaskId(this), getTaskListId(this), parseInt(getTaskListOwnerId(this)));
	});
	
	

	/*
	 * In new/update task modal, on selection of status, show progress slider
	 * and change %
	 */
		
	$('#tasks-list-template').on('click', '.group-view', function(event)
	{
		event.preventDefault();
		console.log("group-view event");
				
		// Change UI and input field
		applyDetailsFromGroupView();
	});	

	
}

$("body").on("change", '.status', function()
	{
		console.log("status change event");
		
		// Change status UI and input field
		changeStatus($(this).val(), $(this).closest("form"));
	});	


/**
 * Highlights the task portion of activity modal (Shows task form and hides
 * event form, changes color and font-weight)
 */
function highlight_task()
{
	$("#hiddentask").val("task");
	$("#task").css({ "color" : "black" });
	$("#event").css({ "color" : "red" });
	$("#relatedEvent").css("display", "none");
	$("#relatedTask").css("display", "block");

	if ($("#activityForm").find("#event_related_to").closest(".controls").find("ul").children())
		$("#taskForm").find("#task_related_to").closest(".controls").find("ul").html(
				$("#activityForm").find("#event_related_to").closest(".controls").find("ul").children());

	// Date().format('mm/dd/yyyy'));
	$('input.date').val(getDateInFormat(new Date())).datepicker('update');
}

/**
 * Creates or updates a task and adds the saved object to the suitable
 * collection by verifying the current window location.
 * 
 * @protected
 * @method save_task
 * @param {String}
 *            formId the unique id for the form to identify it
 * @param {String}
 *            modalId the unique id for the modal to identify it
 * @param {Boolean}
 *            isUpdate the boolean value to identify weather saving the new one
 *            or updating the existing one
 * 
 */
function save_task(formId, modalId, isUpdate, saveBtn)
{

	// Returns, if the save button has disabled attribute
	if ($(saveBtn).attr('disabled'))
		return;

	// Disables save button to prevent multiple click event issues
	disable_save_button($(saveBtn));// $(saveBtn).attr('disabled', 'disabled');

	if (!isValidForm('#' + formId))
	{

		// Removes disabled attribute of save button
		enable_save_button($(saveBtn));// $(saveBtn).removeAttr('disabled');
		return false;
	}

	// Show loading symbol until model get saved
	// $('#' + modalId).find('span.save-status').html(LOADING_HTML);

	var json = serializeForm(formId);

	if (!isUpdate)
		json.due = new Date(json.due).getTime();
	
	if(isUpdate){
		
		if($('#'+formId).find('ul#notes').length>0){
			var notes = [];
			$('#'+formId+' li.task-note').each(function()
			{
				notes.push($(this).attr('data'));
			});

			console.log(notes);

			json.notes = notes;
		}
	}
	var startarray = (json.task_ending_time).split(":");
	json.due = new Date((json.due) * 1000).setHours(startarray[0], startarray[1]) / 1000.0;

	var newTask = new Backbone.Model();
	newTask.url = 'core/api/tasks';
	newTask
			.save(
					json,
					{ success : function(data)
					{

						// Removes disabled attribute of save button
						enable_save_button($(saveBtn));// $(saveBtn).removeAttr('disabled');

						$('#' + formId).each(function()
						{
							this.reset();
						});

						// $('#' + modalId).find('span.save-status
						// img').remove();
						$('#' + modalId).modal('hide');

						var task = data.toJSON();

						getDueTasksCount(function(count){

								var due_task_count = count;

								if (due_task_count == 0)
									$(".navbar_due_tasks").css("display", "none");
								else
									$(".navbar_due_tasks").css("display", "inline-block");
								if(due_task_count !=0)
									$('#due_tasks_count').html(due_task_count);
								else
									$('#due_tasks_count').html("");

						});
						

						if (Current_Route == 'calendar')
						{
							if (isUpdate)
								App_Calendar.tasksListView.collection.remove(json);

							// Updates task list view
							if (!data.toJSON().is_complete && data.toJSON().owner_id == CURRENT_DOMAIN_USER.id)
								App_Calendar.tasksListView.collection.add(data);

							App_Calendar.tasksListView.render(true);

						}
						else if (Current_Route == 'tasks-old')
						{

							/*
							 * To do without reloading the page should check the
							 * condition of (Owner and Category)
							 */

							var old_owner_id = $('#content').find('.type-task-button').find(".selected_name").text();
							var old_type = $('#content').find('.owner-task-button').find(".selected_name").text();

							if (isUpdate)
								App_Calendar.allTasksListView.collection.remove(json);

							if ((old_owner_id == "All Categories" || old_owner_id.toUpperCase() == json.type) && (old_type == "All Tasks" || json.owner_id == CURRENT_DOMAIN_USER.id))
								App_Calendar.allTasksListView.collection.add(data);

							App_Calendar.allTasksListView.render(true);
						}
						else if (Current_Route == 'tasks')
						{
							var criteria = getCriteria();

							if (criteria == "LIST")
							{
								if (isUpdate)
									App_Calendar.allTasksListView.collection.remove(json);

								App_Calendar.allTasksListView.collection.add(data);
								App_Calendar.allTasksListView.render(true);
								return;
							}

							updateTask(isUpdate, data, json);
						}
						// Updates data to temeline
						else if (App_Contacts.contactDetailView && Current_Route == "contact/" + App_Contacts.contactDetailView.model.get('id'))
						{

							/*
							 * Verifies whether the added task is related to the
							 * contact in contact detail view or not
							 */
							$.each(task.contacts, function(index, contact)
							{
								if (contact.id == App_Contacts.contactDetailView.model.get('id'))
								{

									// Add model to collection. Disabled sort
									// while adding and called
									// sort explicitly, as sort is not working
									// when it is called by add
									// function
									if (tasksView && tasksView.collection)
									{
										if (tasksView.collection.get(data.id))
										{
											tasksView.collection.get(data.id).set(new BaseModel(data));
										}
										else
										{
											tasksView.collection.add(new BaseModel(data), { sort : false });
											tasksView.collection.sort();
										}
									}

									// Activates "Timeline" tab and its tab
									// content in
									// contact detail view
									// activate_timeline_tab();
									add_entity_to_timeline(data);

									return false;
								}
							});
						}
						else if (App_Portlets.currentPosition && App_Portlets.tasksCollection && App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)] && (Current_Route == undefined || Current_Route == 'dashboard'))
						{
							if (isUpdate)
								App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)].collection.remove(json);

							// Updates task list view
							App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)].collection.add(data);

							App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)].render(true);

						}
						else if (App_Deal_Details.dealDetailView && Current_Route == "deal/" + App_Deal_Details.dealDetailView.model.get('id'))
						{

							/*
							 * Verifies whether the added task is related to the
							 * deal in deal detail view or not
							 */
							$.each(task.deal_ids, function(index, deal_id)
							{
								if (deal_id == App_Deal_Details.dealDetailView.model.get('id'))
								{

									// Add model to collection. Disabled sort
									// while adding and called
									// sort explicitly, as sort is not working
									// when it is called by add
									// function
									if (dealTasksView && dealTasksView.collection)
									{
										if (dealTasksView.collection.get(data.id))
										{
											dealTasksView.collection.get(data.id).set(new BaseModel(data));
										}
										else
										{
											dealTasksView.collection.add(new BaseModel(data), { sort : false });
											dealTasksView.collection.sort();
										}
									}
									dealTasksView.render(true);
									return false;
								}
							});
						}
						else
						{

							if (App_Calendar.allTasksListView)
							{
								App_Calendar.allTasksListView.collection.remove(data.toJSON());
								App_Calendar.allTasksListView.collection.add(data.toJSON());
								App_Calendar.allTasksListView.render(true);
							}
							else if (App_Calendar.tasksListView)
							{
								App_Calendar.tasksListView.collection.remove(data.toJSON());
								App_Calendar.tasksListView.collection.add(data.toJSON());
								App_Calendar.tasksListView.render(true);
							}
							else
								App_Tasks.navigate("task/" + task.id, { trigger : true });
							taskDetailView = data;

							getTemplate("task-detail", data.toJSON(), undefined, function(template_ui){
								if(!template_ui)
									  return;
								$('#content').html($(template_ui));	
								task_details_tab.loadActivitiesView();
								initializeTaskDetailListeners();
							}, "#content");
						}
						
					} });
}

/**
 * Get due date of the task to categorize as overdue, today etc..
 * 
 * @method get_due
 * @param {Number}
 *            due of the task
 * 
 */
function get_due(due)
{
	// Get Todays Date
	var date = new Date();
	date.setHours(0, 0, 0, 0);

	date = date.getTime() / 1000;
	// console.log("Today " + date + " Due " + due);
	return Math.floor((due - date) / (24 * 3600));
}

function increaseCount(heading)
{
	var count = heading.find('.count').attr('count');

	count = count ? parseInt(count) + 1 : 1;
	heading.find('.count').attr('count', count);
	heading.find('.count').text("(" + count + ")");
	return count;
}
/**
 * Based on due date arranges the tasks UI
 * 
 * @method append_tasks
 * @param {Object}
 *            base_model task model
 * 
 */
function append_tasks(base_model)
{

	var itemView = new Base_List_View({ model : base_model, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'tr', });

	// add to the right box - overdue, today, tomorrow etc.
	var due = get_due(base_model.get('due'));
	if (due < 0)
	{

		var heading = $('#overdue-heading', this.el);
		var count = increaseCount(heading)

		if (count > 5)
		{
			return;
		}
		$('#overdue', this.el).append(itemView.render().el);
		if (count == 5)
			$('#overdue', this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>');
		$('#overdue', this.el).find('tr:last').data(base_model);
		$('#overdue', this.el).parent('table').css("display", "block");
		heading.show();
		$('#overdue', this.el).show();
	}

	// Today
	if (due == 0)
	{

		var heading = $('#today-heading', this.el);
		var count = increaseCount(heading);
		if (count > 5)
		{
			return;
		}
		if ($('#today > tr', this.el).length > 4)
			return;

		$('#today', this.el).append(itemView.render().el);
		if (count == 5)
			$('#today', this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>');
		$('#today', this.el).find('tr:last').data(base_model);
		$('#today', this.el).parent('table').css("display", "block");
		$('#today', this.el).show();
		$('#today-heading', this.el).show();
	}

	// Tomorrow
	if (due == 1)
	{
		var heading = $('#tomorrow-heading', this.el);
		var count = increaseCount(heading);
		if (count > 5)
		{
			return;
		}

		$('#tomorrow', this.el).append(itemView.render().el);
		if (count == 5)
			$('#tomorrow', this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>');
		$('#tomorrow', this.el).find('tr:last').data(base_model);
		$('#tomorrow', this.el).parent('table').css("display", "block");
		$('#tomorrow', this.el).show();
		$('#tomorrow-heading', this.el).show();
	}

	// Next Week
	if (due > 1)
	{
		var heading = $('#next-week-heading', this.el);
		var count = increaseCount(heading);
		if (count > 5)
		{
			return;
		}

		$('#next-week', this.el).append(itemView.render().el);
		if (count == 5)
			$('#next-week', this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>');
		$('#next-week', this.el).find('tr:last').data(base_model);
		$('#next-week', this.el).parent('table').css("display", "block");
		$('#next-week', this.el).show();
		$('#next-week-heading', this.el).show();
	}

}

// dash board tasks based on conditions..
function append_tasks_dashboard(base_model)
{

	var itemView = new Base_List_View({ model : base_model, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'tr',

	});

	var due = get_due(base_model.get('due'));

	var pendingTask = base_model.get("is_complete");

	if (pendingTask == false && due <= 0)
		$('#dashboard1-tasks-model-list', this.el).append(itemView.render().el);

}

/**
 * 
 * Turns the pending task as completed
 * 
 * @method complete_task
 * @param {Number}
 *            taskId to get the task from the collection
 * @param {Object}
 *            ui html Object to remove on success of the deletion
 * 
 */
function complete_task(taskId, collection, ui, callback)
{

	var taskJSON = collection.get(taskId).toJSON();
	// Replace contacts object with contact ids
	var contacts = [];
	$.each(taskJSON.contacts, function(index, contact)
	{
		contacts.push(contact.id);
	});

	console.log(taskJSON.notes);

	// Replace notes object with note ids
	var notes = [];
	$.each(taskJSON.notes, function(index, note)
	{
		notes.push(note.id);
	});

	console.log(notes);

	taskJSON.notes = notes;
	taskJSON.note_description = "";
	taskJSON.contacts = contacts;
	taskJSON.is_complete = true;
	taskJSON.status = "COMPLETED";
	taskJSON.progress = 100;
	taskJSON.owner_id = taskJSON.taskOwner.id;

	var new_task = new Backbone.Model();
	new_task.url = '/core/api/tasks';
	new_task.save(taskJSON, { success : function(model, response)
	{
		if(!Current_Route)
			  Current_Route = "/";

		if (Current_Route.indexOf("contact/") > -1)
		{
			collection.get(taskId).set(model);
		}
		else
		{
			collection.remove(model);
		}

		getDueTasksCount(function(due_task_count){

			if (due_task_count == 0)
			$(".navbar_due_tasks").css("display", "none");
			else
				$(".navbar_due_tasks").css("display", "inline-block");
			if(due_task_count !=0)
				$('#due_tasks_count').html(due_task_count);
			else
				$('#due_tasks_count').html("");
		
		});

		
		if (ui)
			ui.fadeOut(500);

		if (callback && typeof (callback) === "function")
		{
			// execute the callback, passing parameters as necessary
			callback(model);
		}
	} });

	// Set is complete flag to be true
	/*
	 * model.url = '/core/api/tasks'; model.set({'is_complete': true}, {silent:
	 * true}); // Destroy and hide the task model.save([],{success:
	 * function(model, response) { // Remove model from the collection
	 * App_Calendar.tasksListView.collection.remove(model);
	 * 
	 * //ui.closest('tr').slideUp('slow');
	 * 
	 * ui.fadeOut(2000); }} );
	 */

}

/**
 * 
 * @returns due tasks count upto today
 */
function getDueTasksCount(callback)
{
	accessUrlUsingAjax('core/api/tasks/overdue/uptotoday', function(response){
			if (!isNaN(response))
			{
				return callback(response);
			}
			return callback(0);

	});
}

/**
 * Show task modal with owners list and typeahead event.
 */
function showTaskModal(forAddTask)
{

	$('#activityTaskModal').html(getTemplate("new-task-modal")).modal('show');

	var el = $("#taskForm");

	agile_type_ahead("task_related_to", el, contacts_typeahead);
	// Deals type-ahead
	agile_type_ahead("task_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);
	
	highlight_task();
	categories.getCategoriesHtml(undefined,function(catsHtml){
		$('#type',el).html(catsHtml);
		// Fills owner select element
		populateUsers("owners-list", $("#taskForm"), undefined, undefined, function(data)
		{
			$("#taskForm").find("#owners-list").html(data);
			$("#owners-list", el).find('option[value=' + CURRENT_DOMAIN_USER.id + ']').attr("selected", "selected");
			$("#owners-list", $("#taskForm")).closest('div').find('.loading-img').hide();
	
			// Add selected task list details in add task modal
			addTasklListDetails(forAddTask);
		});
	});
}
var notesView;
var contactRelatedView;
var taskActivitiesView;
var dealRelatedView;
var task_details_tab = {
				load_timeline : function()
				{
								$('div.tab-content', App_Tasks.taskDetailView.el).find('div.active').removeClass('active');

								$('#time-line', App_Tasks.taskDetailView.el).addClass('active');
								if ($("#timeline", App_Tasks.taskDetailView.el).hasClass('isotope'))
								{
												$("#timeline", App_Task.taskDetailView.el).isotope('reLayout', function()
												{
												})
												return;
								}
								load_timeline_details(App_Tasks.taskDetailView.el, App_Tasks.taskDetailView.model.get('id'));
				},

				// loades notes on time line
				load_notes : function()
				{
								var id = taskDetailView.id;
								notesView = new Base_Collection_View({ url : '/core/api/tasks/' + id + "/notes", restKey : "note", templateKey : "task_notes",
												individual_tag_name : 'li', sortKey : "created_time", descending : true, postRenderCallback : function(el)
												{
																head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
																{
																				$(".note-created-time", el).timeago();
																})
												} });
								notesView.collection.fetch();
								$('#task_tab_detail').find('#notes').html(notesView.el);
				},

				loadTaskRelatedContactsView : function()
				{
								var id = taskDetailView.id;
								contactRelatedView = new Base_Collection_View({ url : '/core/api/tasks/' + id + "/contacts", templateKey : "task-related", individual_tag_name : 'tr',
												sortKey : "created_time", descending : true, postRenderCallback : function(el)
												{

												} });
								contactRelatedView.collection.fetch();
								$('#task_tab_detail').find('#contacts').html(contactRelatedView.el);
				},

				loadActivitiesView : function()
				{
								var taskJSON = taskDetailView.toJSON();
								var domainUserId = taskJSON.domain
								taskActivitiesView = new Base_Collection_View({ url : '/core/api/activitylog/getActivityByEntityId?entity_id='+taskJSON.id+'', templateKey : "task-related-activity",
												individual_tag_name : 'li',sortKey : "time", descending : true,cursor : true, page_size : 25, postRenderCallback : function(el)
												{
																head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
																{
																				$(".event-created-time", el).timeago();
																})
												} });
								taskActivitiesView.collection.fetch();
								$('#task_tab_detail').find('#activity').html(taskActivitiesView.el);

				},

				loadTaskRelatedDealsView : function()
				{
								var id = taskDetailView.id;
								dealRelatedView = new Base_Collection_View({ url : '/core/api/tasks/' + id + "/deals", templateKey : "task-related-deals", individual_tag_name : 'tr',
												sortKey : "created_time", descending : true, postRenderCallback : function(el)
												{

												} });
								dealRelatedView.collection.fetch();
								$('#task_tab_detail').find('#deals').html(dealRelatedView.el);
				}, };

function initializeDomainsearchListner(el){
	
	$("#domain-search-listners").on("click", '#domain-search-results2', function(e) {
		e.preventDefault(e);
		
		var email = $('#domainSearchText2').val();
		console.log(" in all -domain users.js "+email);
		$("#domainSearchText").val(email);
		
			Backbone.history.navigate("getDomainUserDetails/"+email , {
                trigger: true
            });
	
	});
	
	
	$( "#domainSearchForm" ).submit(function( e ) 	{
		e.preventDefault(e);
		
		var email = $('#domainSearchText').val();
		console.log(" in all -domain users.js "+email);
		
			Backbone.history.navigate("getDomainUserDetails/"+email , {
                trigger: true
            });
	
	});

}


function initializeAdminpanelListner(el){
// takes searchbox value and navigate this to router
	
	
	// deltes user from domain from admin panel
	$("#admin-panel-listners").on("click", '.delete_user', function(e) {
		
		e.preventDefault();
		if (!confirm("Are you sure you want to delete ?" ))
			return;
		var id = $(this).closest('a').attr("data");
		$.ajax({
			url: '/core/api/admin_panel/deleteuser?id='+id, 
			type : 'DELETE',
			success : function(data)
			{
				add_delete_user_info_as_note_to_owner(email);
				alert("user deleted" );
				location.reload(true);
					           
			},
			error : function(response)
			{
				alert("error in deletion ");
			} });
		
	});
	
	// navigates to domain details from all domain users
	$("#admin-panel-listners").on("click", '#all-domain-users-model-list > tr', function(e) 
			{
				e.preventDefault();

				// Reads the id
				var domainname = $(this).find('.data').attr('data');

				Backbone.history.navigate("getDomainUserDetails/"+domainname , {
	                trigger: true
	            });
				// App_Subscription.invoiceDetails(data);
			});
		/**
		 * If user clicks on delete, delete request is sent to
		 * "core/api/admin/delete/namespace"
		 */
	$("#admin-panel-listners").on("click", '.delete-namespace', function(e) {
			
					e.preventDefault();
					
				
					var namespace = $(this).closest('a').attr("data");
					
					if(namespace != "")
					{
							if (!confirm("Are you sure you want to delete ?" ))
								return;
							
							// Show loading in content
							$("#content").html(getRandomLoadingImg());
							/**
							 * Sends delete request to delete namespace
							 */
							$.ajax({
								type : "DELETE",
								url : "core/api/admin_panel/deletedomain/" + namespace,
								success : function(data)
								{
									alert("account deleted");
									Backbone.history.navigate("all-domain-users", { trigger : true });
								}
							});
						
					
				   }
		});
	$("#admin-panel-listners").on("click", '.refundpopup', function(e) {
			e.preventDefault();
			
			var chargeid = $(this).attr("chargeid");
			var totalamount = $(this).attr("totalamount");
			var refundedAmount = $(this).attr("refundedAmount");
			$("#errormsg").html("");
			$("#amount").val(totalamount - refundedAmount);
			$("#hchargeid").val(chargeid);
			$("#totamount").val(totalamount);
			$("#partialrefund").button('reset');
			$("#refundModal").modal("show");
	        
	    });



		$("#partial-refund-footer").off('click').on("click", '#partialrefund', function(e) { 
			
			e.preventDefault();
			if (!isValidForm($("#admin-partial-refund")))
			{
			    return;
			}
			$(this).button('loading');
			var amount = $("#amount").val();
			var totalamount = $(".totamount").val();
			var chargeid=$("#hchargeid").val();
			if(parseFloat(amount) <= 0)
			{
				
				$("#errormsg").html("Amount should be > 0").show().delay(1500).hide(1);
				$("#partialrefund").button('reset');
				return;
			}
			
			if(parseFloat(amount)>parseFloat(totalamount))
			{
				$("#errormsg").html("Amount Should not exceed "+totalamount).show().delay(1500).hide(1);
				$("#partialrefund").button('reset');
				return;
			}
			
			amount = 100*amount;
			amount = parseInt(amount.toPrecision(12));	
			$.ajax({
				url: '/core/api/admin_panel/applypartialrefund?chargeid='+chargeid+'&amount='+amount, 
				type : 'GET',
				success : function(data)
				{	
					alert("successfully applied for refund");
					location.reload(true);
				},
				error : function(response)
				{
					$("#partialrefund").button('reset');
					showNotyPopUp("information", "error occured please try again", "top");
				}
			});
		
		});
		
		
		$("#admin-panel-listners").on("click", '#delete_userplan', function(e) { 
			e.preventDefault();
			if (!confirm("Are you sure you want to cancel this subscription ?" ))
				return;
			var sub_id = $("#delete_userplan").attr("sub_id");
			var cus_id = $("#delete_userplan").attr("cus_id");
			$.ajax({url : 'core/api/admin_panel/deletesubscription?subscription_id='+sub_id+'&cus_id='+cus_id,
				type : 'DELETE',
				
				success: function()
			{
				add_cancel_subscription_info_as_note_to_owner(email);
				location.reload(true);
			},error : function(response)
			{

				console.log(response);
			}
			
		});
		});
		$("#admin-panel-listners").on("click", '#delete_emailplan', function(e) { 
			e.preventDefault();
			if (!confirm("Are you sure you want to cancel this subscription ?" ))
				return;
			var sub_id = $("#delete_emailplan").attr("sub_id");
			var cus_id = $("#delete_emailplan").attr("cus_id");
			$.ajax({url : 'core/api/admin_panel/deletesubscription?subscription_id='+sub_id+'&cus_id='+cus_id,
				type : 'DELETE',
				
				success: function()
			{
					add_cancel_subscription_info_as_note_to_owner(email);
					location.reload(true);
			},error : function(response)
			{

				console.log(response);
			}
			
		});
			
		});
		
		$("#admin-panel-listners").on("click", '#unpause_mandrill', function(e)
		{
			e.preventDefault();
			if (!confirm("Are you sure you want to UnPause Mandrill?" ))
				return;
			var domain = $(this).attr('domain');
			$.ajax({
				url : 'core/api/admin_panel/resumeMandrill?domain='+domain,
				type : 'PUT',
				success : function(){
					location.reload(true);
				},
				error : function(response){
					console.log(response);
					showNotyPopUp("information", "Error occured please try again", "top");
				}
			});
		});
}
/**
 * Fetches account prefs and render the template.
 * 
 * @param $account_activity -
 *            settings-account-activity template
 */
function load_admin_account_prefs($account_activity)
{
	var view = new Base_Model_View({ url : '/core/api/account-prefs', template : "admin-settings-account-prefs" });

	$account_activity.find('#admin-account-prefs').html(view.render().el);

}

/**
 * Fetches mandrill subaccount info and render them email activity template.
 * 
 * @param $account_activity -
 *            settings-account-activity template
 */
function load_account_email_activity($account_activity)
{
	// Email Activity
	var emailActivityModelView = new Base_Model_View({ url : 'core/api/emails/email-activity', template : 'admin-settings-email-activity', });

	$account_activity.find('#account-email-activity').html(emailActivityModelView.render().el);

}
var account_stats_integrations = {

	loadAccountStats : function(el) {

		$.ajax({
			url : 'core/api/namespace-stats/getdomainstats',
			type : 'GET',
			success : function(data) {
				console.log(data);

				getTemplate("account-stats-new", data, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$(el).find('#account-stats-new').html($(template_ui));	
				}, $(el).find('#account-stats-new'));
			},
			error : function(response) {
				console.log("error");
				console.log(response);
			}
		});
	},
	loadEmailStats : function(el) {

		$.ajax({
			url : 'core/api/emails/email-stats',
			type : 'GET',
			success : function(data) {
				console.log(data);
				getTemplate("email-stats-new", data, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$(el).find('#email-stats-new').html($(template_ui));	
				}, $(el).find('#email-stats-new'));
			},
			error : function(response) {
				console.log("error");
				console.log(response);
			}
		});
	},

	loadSMSStats : function(el) {
		$.ajax({
			url : 'core/api/sms-gateway/SMSlogs',
			type : 'GET',
			success : function(data) {
				console.log(data);
				if(data){
					data=JSON.parse(data);
				}
				getTemplate("sms-stats-new", data, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$(el).find('#sms-stats-new').html($(template_ui));	
				}, $(el).find('#sms-stats-new'));				
			},
			error : function(response) {
				console.log("error");
				console.log(response);
			}
		});

	}
};

function initializeStatsListners(el){
$('#email-stats-listners a[href="#account-stats-new"]').on('click', function(e) {
	e.preventDefault();
	$(el).find('#account-stats-new').html(LOADING_ON_CURSOR);
	account_stats_integrations.loadAccountStats(el);
});
$('#email-stats-listners a[href="#email-stats-new"]').on('click', function(e) {
	e.preventDefault();
	$(el).find('#email-stats-new').html(LOADING_ON_CURSOR);
	account_stats_integrations.loadEmailStats(el);
});
$('#email-stats-listners a[href="#sms-stats-new"]').on('click', function(e) {
	e.preventDefault();
	$(el).find('#sms-stats-new').html(LOADING_ON_CURSOR);
	account_stats_integrations.loadSMSStats(el);
});
}function bindAdminChangeAction(el, data)
{
	$('input[name="is_admin"]', el).on('change', function(e){
	var is_admin = $(this).is(":checked");
	if(is_admin == false)
		$("input[type=checkbox]", $('div[name="newscopes"]', el)).removeAttr("disabled");
	else
		$("input[type=checkbox]", $('div[name="newscopes"]', el)).attr("checked", "checked" ).attr("disabled", "disabled");
	})
	
	$("input[type=checkbox]", $('div[name="newscopes"]', el)).on('change', function(e){
		if(!this.checked){
			$(this).removeAttr("checked");
		}
	});
	
	var import_field = $('input[value="IMPORT_CONTACTS"]', el);
	
	if(!import_field)
		return;
	
	if(data && data.scopes)
		{
			if(jQuery.inArray("IMPORT_CONTACTS", data.scopes) >=0)
				$('input[value="CREATE_CONTACT"]', el).attr("checked", "checked" ).attr("disabled", "disabled");
		}
			
	import_field.on('change', function(e){
		var is_import_enabled = $(this).is(":checked");
		if(is_import_enabled == true)
			{
				$('input[value="CREATE_CONTACT"]', el).attr("checked", "checked" ).attr("disabled", "disabled");
			}
			
		else
			$('input[value="CREATE_CONTACT"]', el).removeAttr("disabled");
	})
	
}function get_allowed_domains()
{
	var allowed_domains_array = $("#allowed_domains_list").children();
	var allowed_domains = "";
	for ( var i = 0; i < allowed_domains_array.length; i++)
	{
		allowed_domains = allowed_domains ? allowed_domains + ", " + $(allowed_domains_array[i]).attr("data") : $(allowed_domains_array[i]).attr("data");
	}
	return allowed_domains;
}

function put_allowed_domains(allowed_domains)
{
	$.ajax({ url : "/core/api/api-key/allowed-domains?allowed_domains=" + encodeURIComponent(allowed_domains), method : "PUT", async : true,
		success : function(data)
		{
			$("#allowed_domains_list").empty();
			var domains_to_append = Handlebars.helpers.allowed_domain_list(data.allowed_domains);
			$("#allowed_domains_list").append(domains_to_append);
			$(".allowed-domain-delete").on('click', function(e) {
        e.preventDefault();
        $(this).closest("tr").remove();
        var allowed_domains = get_allowed_domains();
        put_allowed_domains(allowed_domains);
      });
			$("#update_allowed_domains").removeAttr("disabled");
			$("#new_allowed_domain").val("");
		} });
}

function is_duplicate_allowed_domain(new_allowed_domain, allowed_domains)
{
	allowed_domains = allowed_domains.split(",");
	for ( var i in allowed_domains)
	{
		allowed_domains[i] = allowed_domains[i].trim();
		if (allowed_domains[i] == new_allowed_domain)
			return true;
	}
	return false;
}
function get_blocked_ips()
{
	var blocked_ips_array = $("#blocked_ips_list").children();
	var blocked_ips = "";
	for ( var i = 0; i < blocked_ips_array.length; i++)
	{
		blocked_ips = blocked_ips ? blocked_ips + ", " + $(blocked_ips_array[i]).attr("data") : $(blocked_ips_array[i]).attr("data");
	}
	return blocked_ips;
}

function put_blocked_ips(blocked_ips)
{
	$.ajax({ url : "/core/api/api-key/blocked-ips?blocked_ips=" + encodeURIComponent(blocked_ips), method : "PUT", async : true,
		success : function(data)
		{
			$("#blocked_ips_list").empty();
			var ips_to_append = Handlebars.helpers.blocked_ips_list(data.blocked_ips);
			$("#blocked_ips_list").append(ips_to_append);
			$(".blocked-ip-delete").on('click', function(e) {
        e.preventDefault();
        $(this).closest("tr").remove();
        var blocked_ips = get_blocked_ips();
        put_blocked_ips(blocked_ips);
    });
			$("#update_blocked_ips").removeAttr("disabled");
			$("#new_blocked_ip").val("");
		} });
}

function is_duplicate_blocked_ip(new_blocked_ip, blocked_ips)
{
	blocked_ips = blocked_ips.split(",");
	for ( var i in blocked_ips)
	{
		blocked_ips[i] = blocked_ips[i].trim();
		if (blocked_ips[i] == new_blocked_ip)
			return true;
	}
	return false;
}

function is_valid_ip(blocked_ip)
{
	blocked_ip = blocked_ip.replace(/\*/g, "0");
	var ip_regex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
	return ip_regex.test(blocked_ip);
}
(function(categories, $, undefined) {
	
	categories.CATEGORIES = {};
	
	/**
	 * Check if the value of the given category is valid or not.
	 */
	categories.isValid = function(value, showAlert) {
		
		var r = '\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA793\uA7A0-\uA7AA\uA7F8-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC';
		var regexString = '^['+r+']['+r+' 0-9_-]*$';
		var is_valid = new RegExp(regexString).test(value);
		if (showAlert && !is_valid)
			alert("Category name should start with an alphabet and can not contain special characters other than underscore, space and hyphen");
		return is_valid;
	}
	
	/**
	 * Get the categories select box html string. Preselect the value if the value i given.
	 */
	categories.getCategoriesHtml = function(value, callback){
		var type = '';
		if(value!= undefined && value.type != undefined)
			type = value.type;
		categories.getCategories(function(cats){
			var html = '';
			$.each(cats, function(index,cat){
				//console.log(customfield);
				if(type == cat.name)
					html += '<option value="'+cat.name+'" selected="selected">'+cat.label+'</option>';
				else
					html += '<option value="'+cat.name+'">'+cat.label+'</option>';
			});
			if (callback && typeof (callback) === "function")
				callback(html);
		});
	};
	
	/**
	 * Gives the categories map required for the Group by categories view in the tasks.
	 */
	categories.getGroupingMap = function(callback){
		categories.getCategories(function(cats){
			var map = {};
			map.searchKey = "type";
			var array = [];
			$.each(cats,function(index,cat){
				array.push(cat.name);
			});
			map.type = array;
			if (callback && typeof (callback) === "function")
				callback(map);
		});
	};
	
	/**
	 * Gives the list of categories.
	 */
	categories.getCategories = function(callback){
		$.ajax({
			url: 'core/api/categories?entity_type=TASK',
			type: 'GET',
			dataType: 'json',
			success: function(cats){
				var obj = {};
				$.each(cats,function(index,cat){
					obj[cat.name] = cat.label;
				});
				
				categories.CATEGORIES = obj;
				
				if (callback && typeof (callback) === "function")
					callback(cats);
				
				return cats
			}
		});
	};
	
	/**
	 * Sends all the request related to categories, in queue.
	 */
	var sendReuestInQueue = function(url,data,successCallback,errorCallback){
		queuePostRequest("task_categories", url, data, function(data)
				{
					// If defined, execute the callback function
					if (successCallback && typeof (successCallback) === "function")
						successCallback(data);

				}, function(data)
				{
					// If defined, execute the callback function
					if (errorCallback && typeof (errorCallback) === "function")
						errorCallback(data);
				});
	};
	
	/**
	 * Save the category.
	 */
    var saveCategory = function(that){
    	
    	var label = $('#add_new_task_category').val();
    	// Returns, if the save button has disabled attribute
    	if ($(that).attr('disabled'))
    		return;
    	// Disables save button to prevent multiple click event issues
    	disable_save_button($(that));//$(saveBtn).attr('disabled', 'disabled');
    	
    	if (!categories.isValid(label)) {
    		if(label.length === 0)
    			$(that).parent().find('.save-status').html('<span style="color:red;">This field is required.</span>');
    		else
    			$(that).parent().find('.save-status').html('<span style="color:red;">Category name should start with an alphabet and can not contain special characters other than underscore, space and hyphen</span>');
    		setTimeout(function(){ 
    			$(that).parent().find('.save-status').html();
    			}, 3000);
    		// Removes disabled attribute of save button
    		enable_save_button($(that));//$(saveBtn).removeAttr('disabled');
    		return false;
    	}
    	
    	var cat = {};
    	cat.label = label;
    	cat.order = $('#admin-settings-categories-model-list').find('tr').length;
    	cat.entity_type='TASK';
    	console.log(cat);
    	// Saving that pipeline object
    	var category = new Backbone.Model();
    	category.url = '/core/api/categories';
    	category.save(cat, {
    		// If the milestone is changed, to show that change in edit popup if opened without reloading the app.
    		success : function(model, response) {
    			// Removes disabled attribute of save button
    			enable_save_button($(that));
    			App_Admin_Settings.categories();
    		},
			error: function(data,response){
				console.log(response,data);
				$(that).parent().find('.save-status').html('<span style="color:red;">'+response.responseText+'</span>');
				enable_save_button($(that));
			}
    	});
    	
    };
    
    /**
     * Delete the category with given id.
     */
    deleteCategory = function(id){
    	var url = '/core/api/categories/delete';
    	var data = {};
		data.id = id;
		console.log('------------',data);
		sendReuestInQueue(url,data,function(){
			App_Admin_Settings.categoryGridView.collection.remove(App_Admin_Settings.categoryGridView.collection.get(id));
	    	$('#category-delete-modal').modal('hide');
	    	$('#'+id).closest('tr').remove();
		});
    };
	
    /**
     * Save the order of the category when the user reodered the list.
     */
	categories.saveCategoryOrder = function(){
		var url = '/core/api/categories/order';
		var catIds = [];
		
		$('#admin-settings-categories-model-list').find('tr').each(function(index){
			catIds[index] = $(this).find('input[name="id"]').val();
		});
		var data = {};
		data.ids = JSON.stringify(catIds);
		console.log('------------',data);
		sendReuestInQueue(url,data);
	};
	
	/**
	 * For UI setup of categories tab.
	 */
	categories.setup_categories = function(el){
		head.js(LIB_PATH + 'lib/jquery-ui.min.js', function() {
			$(el).find('tbody').each(function(index){
				$(this).sortable({
				      containment : "#admin-settings-categories-model-list",
				      items:'tr',
				      helper: function(e, tr){
				          var $originals = tr.children();
				          var $helper = tr.clone();
				          $helper.children().each(function(index)
				          {
				            // Set helper cell sizes to match the original sizes
				            $(this).width($originals.eq(index).width());
				            $(this).css("background","#f5f5f5");
				            $(this).css("border-bottom","1px solid #ddd");
				          });
				          return $helper;
				      },
				     start: function(event, ui){
				    	  $.each(ui.item.children(),function(index,ele){
				    		  ui.helper.children().eq(index).width(ui.helper.children().eq(index).width()-$(this).width());
				    	  });
				    	  ui.helper.width(ui.helper.width());
				      },
				      sort: function(event, ui){
				    	  ui.helper.css("top",(ui.helper.offset().top+ui.item.offset().top)+"px");
				      },
				      forceHelperSize:true,
				      placeholder:'<tr><td></td></tr>',
				      forcePlaceholderSize:true,
				      handle: ".icon-move",
				      cursor: "move",
				      tolerance: "intersect",
				      
				      // When milestone is dropped its input value is changed 
				      update : function(event, ui) {
				    	  console.log($(ui.item).attr('data'));
				    	  categories.saveCategoryOrder();
				    	 // fill_ordered_milestone($(ui.item).closest('form').attr('id'));
				        }
			    });
			});
		});
	};
	
	/**
	 * Init all the category related click events. Call this only when the category page is opened.
	 */
	categories.init = function(){
		$('#category-tracks-accordion').on('click','.show_task_category_field',function(e){
		//$('.show_task_category_field').die().live('click',function(e){
			e.preventDefault();
			$(this).parent().hide();
			$('#task-category').find('.show_field').show();
			$('#add_new_task_category').focus();
		});
		
		$('#category-tracks-accordion').on('click','#add_task_category',function(e){
	    //$("#add_task_category").die().live('click', function(e){
	    	e.preventDefault();
	    	saveCategory(this);
	    });
	    
		$('#category-tracks-accordion').on('click','.category-delete',function(e){
	    //$('.category-delete').die().live('click',function(e){
	    	e.preventDefault();
	    	$('#delete-category-confirm-dialog input').val($(this).attr('id'));
	    	$('#category-name').text($(this).attr('data'));
	    	$('#category-delete-modal').modal('show');
	    });
	    
		$('body').on('click','#category-delete-confirm',function(e){
	   // $('#category-delete-confirm').die().live('click',function(e){
	    	e.preventDefault();
	    	var id = $('#delete-category-confirm-dialog input').val();
	    	deleteCategory(id);
	    });
	    
		$('#category-tracks-accordion').on('keypress','#add_new_task_category',function(e){
	    //$("#add_new_task_category").die().live("keypress",function(e){
	    	if(e.keyCode == 13)
	    	{
	    		$("#add_task_category").click();
	    	}
	    });
	    
	};
	
	
}(window.categories = window.categories || {}, $));function modalAlert(templateName,message,title){
	
	if(templateName == undefined || message == undefined || title == undefined)
		return;
	var alertJSON = {};
	alertJSON["title"] = title;
	alertJSON["message"] = message;
	
	getTemplate(templateName,alertJSON, undefined, function(template_ui){
		if(!template_ui)
			  return;
		var template = $(template_ui);
		template.modal('show');
	}, null);

	return;
}Backbone.View.prototype.close = function()
{
	this.remove();
	this.unbind();
	if (this.onClose)
	{
		this.onClose();
	}
}

var BaseModel = Backbone.Model.extend({});

/**
 * Defines a backbone collection, which sorts the collection based on the
 * sortkey and parses based on the restKey
 */
var BaseCollection = Backbone.Collection.extend({ model : BaseModel,
/*
 * Initializes the collection sets restKey and sortKey
 */
initialize : function(models, options)
{
	this.restKey = options.restKey;
	if (options.sortKey)
		this.sortKey = options.sortKey;
	if (options.descending)
		this.descending = options.descending;

	// Set false if sorting is not required. Used when order returned
	// from server is to be preserved.
	this.sort_collection = options.sort_collection;
	if (this.sort_collection == false)
		this.comparator = false;
},
/*
 * Sorts the order of the collection based on the sortKey. When models are
 * fetched then comparator gets the value of the softKey in the model and sorts
 * according to it
 */
comparator : function(item)
{
	if (this.sortKey)
	{
		if (this.descending == true)
			return -item.get(this.sortKey);
		// console.log("Sorting on " + this.sortKey);
		return item.get(this.sortKey);
	}
	return item.get('id');
},
/*
 * Gets the corresponding objects based on the key from the response object
 */
parse : function(response)
{
	// console.log("parsing " + this.restKey + " " +
	// response[this.restKey]);

	if (response && response[this.restKey])
		return response[this.restKey];

	return response;
} });

/*
 * Creates an view object on the model, with events click on .delete, .edit,
 * .agile_delete and respective funtionalities are defined and binds to current
 * view.
 */
var Base_List_View = Backbone.View.extend({ events : { "click .delete" : "deleteItem", "click .edit" : "edit", "delete-checked .agile_delete" : "deleteItem",
	"click .delete-model" : "deleteModel"

},
/*
 * Binds events on the model
 */
initialize : function()
{
	_.bindAll(this, 'render', 'deleteItem', 'edit', 'deleteModel'); // every function
	// that uses 'this'
	// as the current
	// object should be
	// in here
	this.model.bind("destroy", this.close, this);

	this.model.bind("change", this.render, this);
},
/*
 * On click on ".delete" model representing the view is deleted, and removed
 * from the collection
 */
deleteItem : function(e)
{
	
	e.preventDefault();
	this.model.destroy();
	this.remove();
}, 
deleteModel : function(e)
{
	e.preventDefault();
	if(!confirm("Are you sure you want to delete?"))
		return false;
	$.ajax({ type: 'DELETE', url: this.model.url(),success : function() {
		location.reload(true);
	}
        });
},
edit : function(e)
{
	/*
	 * console.log(this.model); console.log("Editing " +
	 * this.model.get("edit_template")); // Edit
	 * if(this.model.get("edit_template")) { console.log("Moving to edit"); var
	 * editView = new Base_Model_View({ model: this.model, isNew: true,
	 * template: this.model.get("edit_template") }); var el =
	 * editView.render().el; $('#content').html(el); }
	 */
}, render : function(callback)
{
	var async = false;
	// if(callback && typeof (callback) == "function")
	// async = true;
	if (async)
	{
		var that = this
		// console.log(this.model.toJSON());
		getTemplate(that.options.template, that.model.toJSON(), undefined, function(el)
		{
			$(that.el).html(el);
			$(that.el).data(that.model);
			console.log($(that.el));
			callback(that.el);
		});
		return this;
	}

	$(this.el).html(getTemplate(this.options.template, this.model.toJSON()));
	$(this.el).data(this.model);
	// Add model as data to it's corresponding row

	return this;
} });

/**
 * Base_Collection_view class defines a Backbone view, which binds the list of
 * models (Collections, backbone collection) i.e, defines view for the
 * collection.
 * <p>
 * Adds view to collection and binds sync (calls every time it attempts to read
 * or save a model to the server),
 * <p>
 * Whenever whenever save model operation is done, appendItem method in the
 * Base_Collection_view class is called on current view, since then sync is
 * binded with appendItem method. It appends the new model created to collection
 * and adds in the view
 * <p>
 * In View initialize function, new collection is created based on the options
 * (url, restkey, sortkey), passed while creating a new view. The collection
 * created in initialize is based on the BaseCollection (in base-colleciton.js),
 * which define the comparator and parse based on the restKey (to parse the
 * response) and sortKey (to sort the collection) passed to Base_Collection_View
 * <p>
 * Options to Base_collection_View are :
 * 
 * <pre>
 * 		resetKey :  Used to parse the response.
 * 		sortKey  : 	Used to sort the collection based in the sortkey value
 * 		url		 :	To fetch the collection and to perform CRUD operations on models 
 * 		cursor 	 :  To initialize the infiniscroll
 * </pre>
 */
var Base_Collection_View = Backbone.View
		.extend({

			/*
			 * Events defined on the view and related function(defines action to
			 * be performed on event). ".save" and ".delete" represents html
			 * elements in current view
			 */
			events : {
				"click .temp_collection_event" : "tempEvent"
			},

			/**
			 * Initializes the view, creates an empty BaseCollection and options
			 * restKey, sortKey, url and binds sync, reset, error to collection.
			 * Also checks if the collection in this view needs infiniscroll
			 * (checks for cursor option).
			 */
			initialize : function()
			{
				showTransitionBar();
				// Binds functions to view
				_.bindAll(this, 'render', 'appendItem', 'appendItemOnAddEvent', 'buildCollectionUI');

				if (this.options.data)
				{
					// Initializes the collection with restKey and sortkey
					this.collection = new BaseCollection(this.options.data, { restKey : this.options.restKey, sortKey : this.options.sortKey,
						descending : this.options.descending, sort_collection : this.options.sort_collection });
				}
				else
				{
					// Initializes the collection with restKey and sortkey
					this.collection = new BaseCollection([], { restKey : this.options.restKey, sortKey : this.options.sortKey,
						descending : this.options.descending, sort_collection : this.options.sort_collection });
				}

				/*
				 * Sets url to the collection to perform CRUD operations on the
				 * collection
				 */
				this.collection.url = this.options.url;

				this.model_list_template = $('<div class="model-list"></div>');

				/*
				 * Binds appendItem function to sync event of the collection
				 * i.e., Gets called every time it attempts to read or save a
				 * model to the server
				 */
				this.collection.bind('sync', this.appendItem);
				this.collection.bind('add', this.appendItemOnAddEvent);

				var that = this;

				/*
				 * Calls render when collection is reset
				 */
				this.collection.bind('reset', function()
				{
					that.render(true)
				});

				/*
				 * Binds error event to collection, so when error occurs the
				 * render is called with parameters force render and error
				 * response text to show in the template
				 */
				this.collection.bind('error', function(collection, response)
				{
					if (response.status == 401)
					{
						var hash = window.location.hash;

						// Unregister all streams on server.
						unregisterAll();

						// Unregister on SIP server.
						sipUnRegister();

						// Firefox do not support window.location.origin, so
						// protocol is explicitly added to host
						window.location.href = window.location.protocol + "//" + window.location.host + "/login" + hash;
						return;
					}
					that.render(true, response.responseText);
				});

				// Commented as it was creating a ripple effect
				// this.collection.bind('add', function(){that.render(true)});

				/*
				 * Calls render before fetching the collection to show loading
				 * image while collection is being fetched.
				 */
				this.render();

				/*
				 * If cursor options are passed when creating a view then
				 * inifiscroll (infiniscroll.js plug in) is initialized on the
				 * collection
				 */
				if (this.options.cursor)
				{
					/*
					 * If page size is not defined then sets page size to 20.
					 */
					this.page_size = this.options.page_size;
					this.global_sort_key = this.options.global_sort_key;
					this.request_method = this.options.request_method;
					this.post_data = this.options.post_data;
					if (!this.page_size)
						this.page_size = 20;

					/*
					 * stores current view object in temp variable, can be used
					 * to call render in infiniscroll, on successful fetch on
					 * scrolling
					 */
					var that = this;

					/**
					 * Initiazlizes the infiniscroll on the collection created
					 * in the view,
					 */
					this.infiniScroll = new Backbone.InfiniScroll(this.collection, { success : function()
					{
						/*
						 * If fetch is success then render is called, so
						 * addition models fetched in collection are show in the
						 * view
						 */
						$(".scroll-loading", that.el).remove();
					}, untilAttr : 'cursor', param : 'cursor', strict : true, pageSize : this.page_size,

					/*
					 * Shows loading on fetch, at the bottom of the table
					 */
					onFetch : function()
					{
						var element="table"; 
						if (that.options.scroll_symbol)
							element="section";
						if(that.options.custom_scrollable_element)
							element=that.options.custom_scrollable_element;
						$(element, that.el).after('<div class="scroll-loading" style="margin-left:50%">' + LOADING_ON_CURSOR + '</div>');
					} });

					/*
					 * Adds infiniscroll objects in to a map with current route
					 * as key, to manage the infiniscroll if view changes i.e.,
					 * to disable infiniscroll on different view if not
					 * necessary.
					 */
					addInfiniScrollToRoute(this.infiniScroll);

					// disposePreviousView(this.options.templateKey +
					// '-collection', this);

					// Store in a variable for us to access in the custom fetch
					// as this is different
					var page_size = this.page_size;
					var global_sort_key = this.global_sort_key;
					var request_method = this.request_method;
					var post_data = this.post_data;

					// Set the URL
					this.collection.fetch = function(options)
					{
						options || (options = {})
						options.data || (options.data = {});
						options.data['page_size'] = page_size;
						if(global_sort_key && global_sort_key != null)
							options.data['global_sort_key'] = global_sort_key;
						if(request_method && request_method != null) {
							options.type = request_method;
							if(request_method.toLowerCase()=='post' && post_data && post_data != null) {
								$.each(post_data, function(key, value) {
									options.data[key] = value;
								});
							}
						}
						return Backbone.Collection.prototype.fetch.call(this, options);
					};

					// this.collection.url = this.collection.url + "?page_size="
					// + this.page_size;
				}

			},

			tempEvent: function(){
				console.log("tempEvent");
			},

			/**
			 * Takes each model and creates a view for each model using model
			 * template and appends it to model-list, This method is called
			 * whenever a model is added or deleted from the collection, since
			 * this method is binded with sync event of collection
			 * 
			 * @param base_model
			 *            backbone model object
			 */
			appendItem : function(base_model, append)
			{

				// This is required when add event is raised, in that case
				// updating document fragment does not update view. And on the
				// other hand, append item should definitely be called from
				// appendItemOnAddEvent because there are many places where
				// appenditem is overridden and that needs to be called on newly
				// added model
				if (append)
				{
					$(this.model_list_element).append(this.createListView(base_model).render().el);
					return;
				}

				this.model_list_element_fragment.appendChild(this.createListView(base_model).render().el);
			},
			createListView : function(base_model)
			{
				// If modelData is set in options of the view then custom data
				// is added to model.
				if (this.options.modelData)
				{
					// console.log("Adding custom data");
					base_model.set(this.options.modelData);
				}

				/*
				 * Creates Base_List_View i.e., view is created for the model in
				 * the collection.
				 */
				var itemView = new Base_List_View({ model : base_model, template : (this.options.templateKey + '-model'),
					tagName : this.options.individual_tag_name });

				return itemView
			}, appendItemOnAddEvent : function(base_model)
			{
				this.appendItem(base_model, true);
				/*
				 * if(this.collection && this.collection.length) {
				 * if(this.collection.at(0).attributes.count)
				 * this.collection.at(0).attributes.count+=1; }
				 */

				// callback for newly added models
				var appendItemCallback = this.options.appendItemCallback;

				if (appendItemCallback && typeof (appendItemCallback) === "function")
					appendItemCallback($(this.el));

				if ($('table', this.el).hasClass('onlySorting'))
					return;

				append_checkboxes(this.model_list_element);

			},
			/**
			 * Renders the collection to a template specified in options, uses
			 * handlebars to populate collection data in to vew
			 * <p>
			 * To use this render, naming of the handlebars template script tags
			 * should be followed
			 * <p>
			 * 
			 * <pre>
			 * 	template-name + model-list :  To append all the models in to list
			 *  template-name + collection :	appends populated model-list to this template
			 *  template-name + model 	 :  Represent each model which is appended to model-list 
			 * </pre>
			 * 
			 * @param force_render
			 *            boolean forces the render to execute, unless it is
			 *            true view is not show and loading image is shown
			 *            instead
			 */
			render : function(force_render, error_message)
			{

				// If collection in not reset then show loading in the content,
				// once collection is fetched, loading is removed by render and
				// view gets populated with fetched collection.
				if (force_render == undefined)
				{
					$(this.el).html("");
					return this;
				}

				// Remove loading
				if ($(this.el).html() == getRandomLoadingImg())
					$(this.el).empty();

				// If error message is defined the append error message to el
				// and return
				if (error_message)
				{
					$(this.el).html('<div style="padding:10px;font-size:14px"><b>' + error_message + '<b></div>');
					return;
				}

				var _this = this;
				var ui_function = this.buildCollectionUI;
				// Populate template with collection and view element is created
				// with content, is used to fill heading of the table
				getTemplate((this.options.templateKey + '-collection'), this.collection.toJSON(), "yes", ui_function);

				if (this.page_size && (this.collection.length < this.page_size))
				{
					console.log("Disabling infini scroll");
					this.infiniScroll.destroy();
				}

				this.delegateEvents();
				return this;
			}, buildCollectionUI : function(result)
			{
				$(this.el).html(result);
				// If collection is Empty show some help slate
				if (this.collection.models.length == 0)
				{
					// Add element slate element in collection template send
					// collection template to show slate pad
					fill_slate("slate", this.el, this.options.slateKey);
				}

				// Add row-fluid if user prefs are set to fluid (deprecated in BS3 Version its been commented)
				/*if (IS_FLUID)
				{
					$(this.el).find('div.row').removeClass('row').addClass('row');
				}*/

				// Used to store all elements as document fragment
				this.model_list_element_fragment = document.createDocumentFragment();

				this.model_list_element = $('#' + this.options.templateKey + '-model-list', $(this.el));

				var fragment = document.createDocumentFragment();

				/*
				 * Iterates through each model in the collection and creates a
				 * view for each model and adds it to model-list
				 */
				_(this.collection.models).each(function(item)
				{ // in case collection is not empty

					this.appendItem(item);
				}, this);

				$(this.model_list_element).append(this.model_list_element_fragment);

				/*
				 * Few operations on the view after rendering the view,
				 * operations like adding some alerts, graphs etc after the view
				 * is rendered, so to perform these operations callback is
				 * provided as option when creating an model.
				 */
				var callback = this.options.postRenderCallback;

				/*
				 * If callback is available for the view, callback functions is
				 * called by sending el(current view html element) as parameters
				 */
				if (callback && typeof (callback) === "function")
				{
					
					// execute the callback, passing parameters as necessary
					callback($(this.el), this.collection);
				}
				
				hideTransitionBar();

				// Add checkboxes to specified tables by triggering view event
				$('body').trigger('agile_collection_loaded', [
					this.el
				]);

				// $(this.el).trigger('agile_collection_loaded', [this.el]);

				// For the first time fetch, disable Scroll bar if results are
				// lesser

				return this;
			}, });
/**
*  Extended View of Base_Collection. It combines parent events to extended view events.
*/
Base_Collection_View.extend = function(child) {
	var view = Backbone.View.extend.apply(this, arguments);
	view.prototype.events = _.extend({}, this.prototype.events, child.events);
	return view;
};
/* !JSCore */
/**
 * Base_Model_View represents view specified by backbone js
 * (http://backbonejs.org/#View), It is view backed by a models, Base_Model_View
 * binds events(click on ".save" and ".delete" html elements) which represents
 * view with logical actions i.e., actions can defined to perform on an event.
 * This binds a view backbone model to view's render function on change event of
 * model, model data is show in the view (used handlebars js to fill model data
 * to template), whenever there is a change in model data, view is updated with
 * new data, since change on model is binded to render function of the view.
 * <p>
 * While creating new Base_Model_View options can be passed, so view is
 * initialized based on the options. Options processed are
 * <p>
 * data : Data should be sent in JSON format (backbone model is created based on
 * data sent).
 * <p>
 * <p>
 * model : Backbone model should be sent.
 * <p>
 * <p>
 * url : Represents url property of the model.
 * <p>
 * <p>
 * isNew : To specify model model needs to be downloaded or not.
 * <p>
 * <p>
 * Window : Specifies which window to navigate after saving the form
 * <p>
 * <p>
 * reload : Boolean value, to specify whether to reload the page after save
 * <p>
 * $el represents the html element of view
 * </p>
 */
var Base_Model_View = Backbone.View
		.extend({

			/*
			 * Events defined on the view and related function(defines action to
			 * be performed on event). ".save" and ".delete" represents html
			 * elements in current view
			 */
			events : {
				"click .save" : "save",
				"click .delete" : "deleteItem"
			},

			/**
			 * Sets options to view object(this.options), these options are
			 * passed when creating a view, in initialize function options are
			 * set to current view object. Also binds functions and model data
			 * to views.
			 */
			initialize : function() {
				showTransitionBar();
				/*
				 * Binds functions to current view object, every function that
				 * uses current view "this" should be bind to view
				 * object("this").
				 */
				_.bindAll(this, 'render', 'save', 'deleteItem', 'buildModelViewUI');

				/*
				 * If data is passed as an option to create a view, then
				 * backbone model object is created with data sent, data is
				 * represented as backbone model and bind to view.
				 */
				if (this.options.data != undefined)
					this.model = new Backbone.Model(this.options.data);
				/*
				 * If backbone model is passed as option the model is set to
				 * view
				 */
				else if (this.options.model)
					this.model = this.options.model;
				else
					this.model = new Backbone.Model({});

				/*
				 * Binds render function to change event on the view object
				 * which includes model object, whenever model is changed render
				 * is called to update the view.
				 */
				this.model.bind("change", this.onChange, this);
				
				this.model.bind('error', function(model, response){

					if(response.status == 401)
					{
						var hash = window.location.hash;

						// Unregister all streams on server.
						unregisterAll();
						
						// Unregister on SIP server.
						sipUnRegister();
						
						// Firefox do not support window.location.origin, so protocol is explicitly added to host
						window.location.href = window.location.protocol + "//" + window.location.host+"/login"+hash;
						return;
					}
				});

				/*
				 * Sets URL to backbone model, if url is passed when creating a
				 * view. URL specified is used to fetch, save the model
				 */
				if (this.options.url) {
					this.model.url = this.options.url;
				}

				/*
				 * If "isNew" in options is true, model is not downloaded. which
				 * represents no model data needs to be shown in the view, but
				 * can be used to save data in url set for model. If isNew is
				 * not true and model is empty data needs to be fetched
				 */
				if ((!this.options.isNew)
						&& $.isEmptyObject(this.model.toJSON())) {
					console.log("to fetch");
					/*
					 * Stores view object in temp variable, to be used in
					 * success back for fetch to call render
					 */
					var that = this;

					/*
					 * Fetches model from the url property set, on success
					 * forces render to execute to show the data fetched in
					 * view.
					 */
					this.model.fetch({
						success : function(data) {
							/*
							 * Used true argument to render (forcing render to
							 * execute and show view.), which represent data is
							 * downloaded from server, If render called out
							 * "true" argument then loading image is show
							 * instead of showing data (because Showing view
							 * without downloading data causes flash effect on
							 * page, since on change in model i.e., data fetched
							 * render is called again)
							 */
							that.render(true);
						}
					});
				}
			},

			/**
			 * Defines action for click event on html element with class
			 * ".delete" in current view object, which sends delete request to
			 * server(to URL set to model in initialize function)
			 */
			deleteItem : function(e) {
				e.preventDefault();
				
				var deleteCallback = this.options.deleteCallback;
				
				if(!confirm("Are you sure you want to delete?"))
		    		return false;
				
				/*
				 * Sends delete request, and reloads view on success
				 */
				this.model.destroy({
					success : function(model, response) {
						
						// Delete callback
						if (deleteCallback && typeof (deleteCallback) === "function") {
							
							console.log(response)
							
							// execute the callback, passing parameters as necessary
							deleteCallback(model, response);
						}
						
						location.reload(true);
					}
				});
				
			},
			/**
			 * Defines action to be performed for click event on HTML element
			 * with class ".save" in current view/template, this can be used to
			 * save the model data in the view representing a form i.e., saveS
			 * the data in form, to the URL set in model.
			 */
			save : function(e) {
				e.preventDefault();
				
				// Saves tinymce content back to 
				// textarea before form serialization
				trigger_tinymce_save();

				
				/*
				 * Gets the form id from the view, this.el represents html
				 * element of the view.
				 */
				var formId = $(this.el).find('form').attr('id');
				
				var saveCallback = this.options.saveCallback;
				
				var errorCallback = this.options.errorCallback;
				
				// Represents form element
				var $form = $('#' + formId);
				console.log($form.find('.save'));
				// Returns, if the save button has disabled attribute 
				if($(e.currentTarget).attr('disabled'))
					return;
				
								
				// Disables save button to prevent multiple click event issues
				disable_save_button($(e.currentTarget));
				
				
				// Represents validations result of the form, and json
				// represents serialized data in the form
				var isValid, json;

				/**
				 * If view contains multiple forms, then data are all the forms
				 * in the view are serialized in to a JSON object, each form
				 * data is added to json object with key name attribute of the
				 * form as follows
				 * 
				 * <pre>
				 * 		{
				 * 			primary : {key:value ....} // Data of form with name &quot;primary&quot;
				 * 			secondary : {key : value} // Data for 2nd for with name secondary
				 * 			key1 : value1 // For forms with out a name, values 
				 * 						  //are set directly in JSON with field name
				 * 		}
				 * </pre>
				 */
				if ($(this.el).find('form').length > 1) {
					
					
					// Initialize variable json as a map
					json = {};

					/*
					 * Iterates through the forms in the view (this.el), each
					 * form is validated, if a form is not valid, isValid
					 * variable is set and returned. If form is valid then form
					 * data is serialized, and set in the JSON object with key
					 * as name of the form
					 */
					$.each($(this.el).find('form'),
							function(index, formelement) {

								/*
								 * If any form in multiple forms are not valid
								 * then returns, setting a flag form data is
								 * invalid
								 */
								if (!isValidForm($(formelement))) {
									isValid = false;
									return;
								}

								/*
								 * Form id and Mame of the form is read,
								 * required to serialize and set in JSON
								 */
								var form_id = $(formelement).attr('id');
								var name = $(formelement).attr('name');

								/*
								 * If name of the form is defined, set the
								 * serialized data in to JSON object with form
								 * name as key
								 */
								if (name) {
									json[name] = serializeForm(form_id);
								}
								/*
								 * If form name is not defined the set the
								 * serialized values to json, with filed names
								 * as key for the value
								 */
								else {
									$.each(serializeForm(form_id), function(
											key, value) {
										json[key] = value;
									});
								}
							});
				}

				/*
				 * Check isValid flag for validity(which is set in processing
				 * multiple forms), or checks validity of single form
				 */
				if (isValid == false || !isValidForm($form)) {
					
					// Removes disabled attribute of save button
					enable_save_button($(e.currentTarget));
					
					return;
				}

				// Clears all the fields in the form before saving
				this.model.clear({
					silent : true
				});

				/*
				 * If variable json is not defined i.e., view does not contacts
				 * multiple forms, so read data from single form
				 */
				if (!json)
					json = serializeForm(formId);

				/*
				 * Saves model data, (silent : true} as argument do not trigger
				 * change view so view is not reset.
				 */
				this.model.set(json, {
					silent : true
				});

				var window = this.options.window;
				var reload = this.options.reload;

				// Store Modal Id
				var modal = this.options.modal;

				var prePersist = this.options.prePersist;
				
				if (prePersist && typeof (prePersist) === "function") {
				    
				     prePersist(this.model);
				    }
				// Loading while saving
				//$save_info = $('<div style="display:inline-block"><img src="img/1-0.gif" height="15px" width="15px"></img></div>');
				//$(".form-actions", this.el).append($save_info);
				//$save_info.show();

				// Calls save on the model
				this.model
						.save(
								[],
								{
									/*
									 * Wait for the server before setting the
									 * new attributes on the model, to trigger
									 * change
									 */
									wait : true,
									/*
									 * On save success, performs the actions as
									 * specified in the options set when
									 * creating an view
									 */
									success : function(model, response) 
									{	
										// Removes disabled attribute of save button
										enable_save_button($(e.currentTarget));
										
										if (saveCallback && typeof (saveCallback) === "function") {
											console.log(response)
											// execute the callback, passing parameters as necessary
											saveCallback(response);
										}
										// Reload the current page
										if (reload)
											location.reload(true);
										else if (window) 
										{
											/*
											 * If window option is 'back'
											 * navigate to previews page
											 */
											if (window == 'back') history.back(-1);
											
											// Else navigate to page set in
											// window attribute
											else Backbone.history.navigate( window, { trigger : true });
											

											// Reset each element
											$form.each(function() {
												this.reset();
											});

											// Hide modal if enabled
											if (modal) $(modal).modal('hide');
										}
										else {
											/* Hide loading on error
											if($save_info)
												$save_info.hide();

											/*
											 * Appends success message to form
											 * actions block in form, if window
											 * option is not set for view
											 *
											 *
											$save_info = $('<div style="display:inline-block"><small><p class="text-success"><i>Saved Successfully</i></p></small></div>');
											$(".form-actions", this.el).append($save_info);
											$save_info.show().delay(3000).hide(1);	
											*/
										}
									},

									/*
									 * If error occurs in saving a model, error
									 * message in response object is shown in
									 * the form
									 */
									error : function(model, response) {
										
										// Removes disabled attribute of save button
										enable_save_button($(e.currentTarget));
										console.log(response);
										
										if (errorCallback && typeof (errorCallback) === "function") {
											errorCallback(response);
										     return;
										    }
										// Hide loading on error
										//$save_info.hide();

										// Show cause of error in saving
										$save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'
												+ response.responseText
												+ '</i></p></small></div>');

										// Appends error info to form actions
										// block.
										$(e.currentTarget).closest(".form-actions", this.el).append(
												$save_info);

										// Hides the error message after 3
										// seconds
										if(response.status != 406)
											$save_info.show().delay(3000).hide(1);
									}
								}, { silent : true });
			},
			/**
			 * Render function, renders the view object with the model binded
			 * and show the view with model data filled in it. Render function
			 * shows loading image in the page if model is not download(if
			 * download is required). It is called whenever attributes of the
			 * model are changed, of when fetch is called on the model binded
			 * with current view.
			 * <p>
			 * And there are other cases when render should show to view in
			 * page.
			 * <p>
			 * 
			 * @param isFetched
			 *            Boolean, force render to show the view called with
			 *            'true' when model is download
			 */
			render : function(isFetched) {

				
				/**
				 * Renders and returns the html element of view with model data,
				 * few conditions are checked render the view according to
				 * requirement and to avoid unwanted rendering of view.
				 * conditions are
				 * <p>
				 * !this.model.isNew() = model is fetched from the server/ Sent
				 * to edit the model
				 * <p>
				 * <p>
				 * this.options.isNew = If model download form the server is not
				 * required
				 * <p>
				 * <p>
				 * !$.isEmptyObject(this.model.toJSON()) = if model is empty
				 * <p>
				 * isFetched = Force call to execute render(when fetch is
				 * success full render is called successfully)
				 * <p>
				 */
				if (!this.model.isNew() || this.options.isNew
						|| !$.isEmptyObject(this.model.toJSON()) || isFetched) {

					$(this.el).html(getRandomLoadingImg());
					/*
					 * Uses handlebars js to fill the model data in the template
					 */
					getTemplate(this.options.template, this.model
							.toJSON(), "yes", this.buildModelViewUI);
					
				}
				// Shows loading in the view, if render conditions are
				// satisfied
				else {
					if (this.options.template == "portlets-leader-board-body-model")
					{
						var sizey = this.options.portletSizeY;
	    				var topPos = 50*sizey;
	    				if(sizey==2 || sizey==3)
	    					topPos += 50;
	        			$(this.el).html("<div class='text-center v-middle opa-half' style='margin-top:"+topPos+"px'><img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");
					}
					else
					{
						$(this.el).html(getRandomLoadingImg());
					}
				}

				// Returns view object
				return this;
			}, 
			onChange: function()
			{
				if(this.options.change == false)
					return;
				

				this.render(true);
			}, 
			buildModelViewUI : function(content)
			{
				hideTransitionBar();
				$(this.el).on('DOMNodeInserted', function(e) {
					//alert("triggered");
					//$('form', this).focus_first();
					$(this).trigger('view_loaded');
				 });
			
				$(this.el).html(content);
				
				/*
				 * Few operations on the view after rendering the view,
				 * operations like adding some alerts, graphs etc after the
				 * view is rendered, so to perform these operations callback
				 * is provided as option when creating an model.
				 */
				var callback = this.options.postRenderCallback;
				
				/*
				 * If callback is available for the view, callback functions
				 * is called by sending el(current view html element) as
				 * parameters
				 */
				
				if (callback && typeof (callback) === "function") {
					
					// execute the callback, passing parameters as necessary
					callback($(this.el),this.model.toJSON());
				}

				
				// If isNew is not true, then serialize the form data
				if (this.options.isNew != true) {
					// If el have more than 1 form de serialize all forms
					if ($(this.el).find('form').length > 1)
						deserializeMultipleForms(this.model.toJSON(), $(
								this.el).find('form'));

					// If el have one form
					else if ($(this.el).find('form').length == 1)
						deserializeForm(this.model.toJSON(), $(this.el)
								.find('form'));
				}
				
				
				
				// Add row-fluid if user prefs are set to fluid (deprecated in BS3 so that commented)
			/*	if (IS_FLUID)
				{
					$(this.el).find('div.row').removeClass('row').addClass(
							'row-fluid');
				}
				*/
				$(this.el).trigger('agile_model_loaded');
			}
		});

/**
 * Functions Which take JQuery button elements and enable disable them.
 * 
 * Disable by setting original text in data-save-text attribute and adding disabled:disabled attribute,
 * Also set min width to current width so button can't collapse, but can expand if necessary
 * 
 * Enable by reverse of the above
 * 
 * @param elem - jQuery element corresponding to the button.
 */
function disable_save_button(elem)
{

	var loadingText = elem.attr("data-loading-text");
if(!loadingText)
	   loadingText = "Saving...";
	
	elem.css('min-width',elem.width()+'px')
		.attr('disabled', 'disabled')
		.attr('data-save-text',elem.html())
		.text(loadingText);
}

/**
 * Enables save button.
 * @param elem
 */
function enable_save_button(elem)
{
	elem.html(elem.attr('data-save-text')).removeAttr('disabled data-save-text');
}

/**
*  Extended View of Base_Model. It combines parent events to extended view events.
*/
Base_Model_View.extend = function(child) {
	var view = Backbone.View.extend.apply(this, arguments);
	view.prototype.events = _.extend({}, this.prototype.events, child.events);
	return view;
};/**
 * Infini scroll utility to control the scroll on all routes,
 * Called from base-collection when page requires infiniscroll function and from app.js when route is initialized
 */

/**
 * Map to store infini scroll object with route name as a key
 */
var INFINI_SCROLL_JSON = {};

/**
 * Adds infini_scroll object to JSON Object with current route as key. Destroys
 * infini scroll if already exists in map and sets new infini scroll object to
 * current route
 * 
 * @param inifni_scroll
 *            infiniscroll object
 */
function addInfiniScrollToRoute(infini_scroll) {
	var current_route = window.location.hash.split("#")[1];

	// Destroys infini scroll
	if (INFINI_SCROLL_JSON[current_route])
		INFINI_SCROLL_JSON[current_route].destroy();

	// Sets new infini scroll object w.r.t current route
	INFINI_SCROLL_JSON[current_route] = infini_scroll;
}

// Activates infiniScroll for routes
/**
 * Activates infiniScroll for current route(if required) and disables scroll in
 * other routes, to solve unnecessary requests on scroll. This method is called
 * when routes are initialized
 */
function activateInfiniScroll() {

	// Gets the current route from the url of the browser, splits at "#" (
	// current route is after "#" ).
	var current_route = window.location.hash.split("#")[1];

	// Disables all infini scrolls in the map
	$.each(INFINI_SCROLL_JSON, function(key, value) {
		value.disableFetch();
	});

	// Enables fetch if current route exists in INFINI_SCROLL_JSON map
	if (INFINI_SCROLL_JSON[current_route])
		INFINI_SCROLL_JSON[current_route].enableFetch();
}/**
 * Deletes the selected row related entities from the database based on the url 
 * attribute of the table and fades out the rows from the table
 * 
 * @module Bulk operations
 * ---------------------------------------------
 * author: Rammohan 
 */

$(function(){	
   /**
    * Validates the checkbox status of each row in table body
    * Customizes the delete operation
    * Deletes the entities
    */	
	$("body").on("click", "#delete-checked, .delete-checked-contacts", function(event){
		event.preventDefault();
		var id_array = [];
		var index_array = [];
		var data_array = [];
		var checked = false;
		var table = $('body').find('.showCheckboxes');

		$(table).find('tr .tbody_check').each(function(index, element){
			
			// If element is checked store it's id in an array 
			if($(element).is(':checked')){
				// Disables mouseenter once checked for delete(To avoid popover in deals when model is checked)
				$(element).closest('tr').on("mouseenter", false);
				index_array.push(index);
				if(!$(element).closest('tr').hasClass("pseduo-row"))
				{
					id_array.push($(element).closest('tr').data().get('id'));
					data_array.push($(element).closest('tr').data().toJSON());
					checked = true;
				}
			}
		});
		if(checked){
			
			if(!canRunBulkOperations())
			{
				showModalConfirmation("Bulk Delete", 
						"You may not have permission to delete some of the contacts selected. Proceeding with this operation will delete only the contacts that you are permitted to delete.<br/><br/> Do you want to proceed?", 
						function (){
					
					// Customize the bulk delete operations
					if(!customize_bulk_delete(id_array, data_array))
						return;
					
					
					$(this).after('<img class="bulk-delete-loading" style="padding-right:5px;margin-bottom:15px" src= "img/21-0.gif"></img>');
					
					var url = $(table).attr('url');
					if(SELECT_ALL == true)
					{
						if($(table).attr('id') == "contacts-table" || $(table).attr('id') == "companies" ) {
							var dynamic_filter = getDynamicFilters();
							if(dynamic_filter == null) {								
								url = url + "&filter=" + encodeURIComponent(getSelectionCriteria());
							}
						}
					}
					
					// For Active Subscribers table
					if(SUBSCRIBERS_SELECT_ALL == true){	
						if($(table).attr('id') == "active-campaign")
							url = url + "&filter=all-active-subscribers";
					}
					
					bulk_delete_operation(url, id_array, index_array, table, undefined, data_array);
						}, 
						function(){
							
							return;
						},
						function() {
							
						});
			}
			else
			{
				// customize delete confirmation message
				if(!customize_delete_message(table))
					return;
				
				// Customize the bulk delete operations
				if(!customize_bulk_delete(id_array, data_array))
					return;
				
				
				$(this).after('<img class="bulk-delete-loading" style="padding-right:5px;margin-bottom:15px" src= "img/21-0.gif"></img>');
				
				var url = $(table).attr('url');
				if(SELECT_ALL && SELECT_ALL == true)
				{
					if($(table).attr('id') == "contacts-table" || $(table).attr('id') == "companies" ) {
						var dynamic_filter = getDynamicFilters();
						if(dynamic_filter == null) {								
							url = url + "&filter=" + encodeURIComponent(getSelectionCriteria());
						}
					}
				}
				
				// For Active Subscribers table
				if(SUBSCRIBERS_SELECT_ALL && SUBSCRIBERS_SELECT_ALL == true){
					if($(table).attr('id') == "active-campaign")
						url = url + "&filter=all-active-subscribers";
				}
				
				bulk_delete_operation(url, id_array, index_array, table, undefined, data_array);
			}
						
		}	
		else
		{
			// if disabled return
			if($(this).attr('disabled') === "disabled")
				return;
			
			$('body').find(".select-none").html('<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>You have not selected any records to delete. Please select at least one record to continue.</div>').show().delay(3000).hide(1);
		}
			
	});
	
	
	
	/**
	    * Validates the checkbox status of each row in table body
	    * Customizes the delete operation
	    * Deletes the entities
	    */	
		$("body").on("click", "#delete-checked-grid", function(event){
			event.preventDefault();
			var id_array = [];
			var index_array = [];
			var data_array = [];
			var checked = false;
			var table = $('body').find('.showCheckboxes');

			$(table).find('.tbody_check').each(function(index, element){
				
				// If element is checked store it's id in an array 
				if($(element).is(':checked')){
					
					console.log($(element).parent('div').attr('id'));
					index_array.push(index);
					console.log(index_array);
					if($(".grid-view").length!=0){
						id_array.push($(element).parent().parent().parent('div').attr('id'));
					}
					else
					id_array.push($(element).parent('div').attr('id'));
					//data_array.push($(element).parent('div').data().toJSON());
					checked = true;
				}
			});
			if(checked){
				
				if(!canRunBulkOperations())
				{
					showModalConfirmation("Bulk Delete", 
							"You may not have permission to delete some of the contacts selected. Proceeding with this operation will delete only the contacts that you are permitted to delete.<br/><br/> Do you want to proceed?",
							function (){
								// Customize the bulk delete operations
								if(!customize_bulk_delete(id_array, data_array))
										return;
				
								bulk_delete_operation($(table).attr('url'), id_array, index_array, table, true, data_array);
							}
							, function(){
								// No callback
								return;
								},
								function(){
					
								});
				}
			else
				{
					if(!confirm("Are you sure you want to delete?"))
		    		return;
					
					// Customize the bulk delete operations
						if(!customize_bulk_delete(id_array, data_array))
							return;
				
						bulk_delete_operation($(table).attr('url'), id_array, index_array, table, true, data_array);
				}
				
				
			}	
			else
	            $('body').find(".select-none").html('<div class="alert alert-danger"><a class="close" data-dismiss="alert" href="#">&times;</a>You have not selected any records to delete. Please select at least one record to continue.</div>').show().delay(3000).hide(1);
				
		});
	
});

/**
 * Customizes the bulk delete operation of certain tables. For example,
 * in case of users table, this code verifies if each user is an admin or not before deleting them. 
 * Doesn't delete admins.
 * 
 * @method customize_bulk_delete
 * @param {Array} id_array holds the array of ids
 * @param {Array} data_array holds the array of entities
 * @returns {Boolean} 
 */
function customize_bulk_delete(id_array, data_array){
	if(Current_Route == 'users'){
		$.each(data_array, function(index, model){
			if(model.is_admin){
				id_array.splice(id_array.indexOf(model.id), 1);
			}	
		});
		if(id_array.length == 0){
			$('body').find(".select-none").html('<div class="alert alert-danger"><a class="close" data-dismiss="alert" href="#">&times;</a>Sorry, can not delete user having <i>admin</i> privilege.</div>').show().delay(5000).hide(1);
			return false;
		}
	}
	return true;
}

/**
 * Bulk operations - delete function
 * Deletes the entities by sending their ids as form data of ajax POST request 
 * and then fades out the rows from the table
 * @method bulk_delete_operation
 * @param {Steing} url to which the request has to be sent
 * @param {Array} id_array holds array of ids of the entities to be deleted
 * @param {Array} index_array holds array of row indexes to be faded out
 * @param {Object} table content as html object
 * @param {Array} data_array holds array of entities 
 */
function bulk_delete_operation(url, id_array, index_array, table, is_grid_view, data_array){
	var json = {};
	var count = id_array.length;
	if(!SELECT_ALL)
		json.ids = JSON.stringify(id_array);
	var dynamic_filter = getDynamicFilters();
	if(dynamic_filter != null) {
		json.dynamic_filter = dynamic_filter;
	}
		
	$.ajax({
		url: url,
		type: 'POST',
		data: json,
		contentType : "application/x-www-form-urlencoded",
		success: function() {
			
			if(url=='core/api/tasks/bulk'){
				getDueTasksCount(function(count){
					var due_task_count= count;

					if(due_task_count==0)
						$(".navbar_due_tasks").css("display", "none");
					else
						$(".navbar_due_tasks").css("display", "block");
					if(due_task_count !=0)
						$('#due_tasks_count').html(due_task_count);
					else
						$('#due_tasks_count').html("");
				
				});
				
			}
			
			$(".bulk-delete-loading").remove();	
			if(count > 20 || count == 0)
			{
				if($(table).attr('id') == "contacts-table")
					showNotyPopUp('information', "Your contacts deletion will be processed shortly", "top", 5000);
				if($(table).attr('id') == "companies"){
					showNotyPopUp('information', "Your companies deletion will be processed shortly", "top", 5000);
					COMPANIES_HARD_RELOAD = true;
				}
			}
			
			if(!is_grid_view)
			{
				var tbody = $(table).find('tbody');
				
				// To remove table rows on delete 
				for(var i = 0; i < index_array.length; i++) 
					$(tbody).find('tr:eq(' + index_array[i] + ')').fadeOut(300, function() { $(this).remove(); });				
			}
			else
			{
				// To remove table rows on delete 
				for(var i = 0; i < id_array.length; i++) 
					$("."+id_array[i]).fadeOut(300, function() { $(this).remove(); });				
			}
			
			$('.thead_check').attr("checked", false);
			
			// Show bulk operations only when thead check box is checked
			toggle_contacts_bulk_actions_dropdown(undefined, true,$('.thead_check').parents('table').attr('id'));
			
			// Removes the entities from timeline, if they are deleted from contact detail view
			if(App_Contacts.contactDetailView && Current_Route == "contact/"
				+ App_Contacts.contactDetailView.model.get('id')){
				
				// Activates "Timeline" tab and its tab content in contact detail view 
				activate_timeline_tab();
				
				$.each(data_array, function(index, data){
					var $removeItem = $( '#' + data.id );
					$('#timeline').isotope('remove', $removeItem);
				});
			}	
			
		}
	});
}

/**
 * Returns boolean value based on user action on confirmation message.
 * If OK is clicked returns true, otherwise false.
 * 
 * @param table - table object
 **/
function customize_delete_message(table)
{
	
	// Default message for all tables
	var confirm_msg = "Are you sure you want to delete?";
	
	// Appends campaign-name for active subscribers
	if($(table).attr('id') === "active-campaign")
		confirm_msg = "Delete selected contacts from " +$('#subscribers-campaign-name').text()+" Campaign?";

	// Shows confirm alert, if Cancel clicked, return false
	if(!confirm(confirm_msg))
		return false;
	
	// if OK clicked return true
	return true;
	
}/**
 * Performs operations like changing owner, adding tags and etc.. on contacts
 * bulk
 * 
 * @module Bulk operations
 * 
 * author: Rammohan
 */
var _BULK_CONTACTS = undefined;
var current_view_contacts_count = 0;
var SELECT_ALL = false;
var _BULKACTION_FILTER = undefined;

/** 
* Bulk actions collection view
*/
var Contacts_Events_Collection_View = Base_Collection_View.extend({
    events: {
    	/** Contacts bulk actions */
    	'click #bulk-owner' : 'bulkActionAddOwner',
    	'click #bulk-campaigns' : 'bulkActionAssignToCampaign',
    	'click #bulk-tags' : 'bulkActionAddTags',
    	'click #bulk-tags-remove' : 'bulkActionRemoveTags',
    	'click #bulk-email' : 'bulkActionSendEmail',
    	'click #bulk-contacts-export' : 'bulkActionExportContacts',
    	'click #bulk-companies-export' : 'bulkActionExportCompanies',
    	'click #select-all-available-contacts' : 'bulkActionSelectAvailContacts',
    	'click #select-all-revert' : 'bulkActionRevertAvailContacts',

    	/** Company bulk actions */
    	'click .default_company_filter' : 'bulkActionCompanyDefaultFilter',
    	'click #companies-filter' : 'bulkActionCompaniesFilter',
    	'click .company_static_filter' : 'bulkActionCompaniesStaticFilter',
    	'click #comp-sort-by-created_time-desc' : 'bulkActionCompaniesSortonTimeDesc',
    	'click #comp-sort-by-created_time-asc' : 'bulkActionCompaniesSortonTimeAsec',
    	
    },

	/*
	 * If default filter is selected, removes filter cookies an load contacts
	 * with out any query condition
	 */
	bulkActionCompanyDefaultFilter :  function(e)
	{
		e.preventDefault();
		revertToDefaultCompanies();
	},
	
	bulkActionCompaniesFilter : function(e)
	{

		e.preventDefault();
		eraseCookie('company_filter');
		//eraseCookie('contact_filter_type');

		//createCookie('company_filter', "Companies");
		COMPANIES_HARD_RELOAD = true;
		App_Companies.companies(); // /Show Companies list, explicitly hard
		// reload
		return;
	},

	bulkActionCompaniesStaticFilter :  function(e)
	{

		e.preventDefault();
		eraseCookie('company_filter');
		//eraseData('dynamic_contact_filter');
		eraseData('dynamic_company_filter');

		var filter_id = $(e.currentTarget).attr('id');
		var filter_type = $(e.currentTarget).attr('filter_type');

		// Saves Filter in cookie
		createCookie('company_filter', filter_id)
		//createCookie('company_filter_type', filter_type)

		// Gets name of the filter, which is set as data
		// attribute in filter
		filter_name = $(e.currentTarget).attr('data');

		COMPANIES_HARD_RELOAD=true;
		App_Companies.companies();
		return;
		// /removed old code from below,
		// now filters will work only on contact, not company
	},
	
	bulkActionCompaniesSortonTimeDesc : function(e)
	{
		e.preventDefault();
		createCookie('company_sort_field',$(e.currentTarget).attr('data'));
		COMPANIES_HARD_RELOAD=true;
		App_Companies.companies();
	},
	
	bulkActionCompaniesSortonTimeAsec : function(e){
		e.preventDefault();
		createCookie('company_sort_field',$(e.currentTarget).attr('data'));
		COMPANIES_HARD_RELOAD=true;
		App_Companies.companies();
	},

    bulkActionAddOwner : function(e){
    	e.preventDefault();
    	contacts_bulk_actions.change_owner(e);
    },

    bulkActionAssignToCampaign : function(e){
    	e.preventDefault();
    	contacts_bulk_actions.assign_to_campaigns(e);
    },

    bulkActionAddTags :  function(e){
    	e.preventDefault();
    	contacts_bulk_actions.add_tags(e);
    },

    bulkActionRemoveTags :  function(e){
    	e.preventDefault();
    	contacts_bulk_actions.remove_tags(e);
    },
    bulkActionSendEmail : function(e){
    	e.preventDefault();
    	contacts_bulk_actions.send_email(e);
    },

    bulkActionExportContacts : function(e){
    	e.preventDefault();
    	contacts_bulk_actions.export_contacts(e);
    },

    bulkActionExportCompanies : function(e){
    	e.preventDefault();
    	contacts_bulk_actions.export_companies(e);
    },

    bulkActionSelectAvailContacts : function(e){
    	e.preventDefault();
    	contacts_bulk_actions.select_contacts(e);
    },

    bulkActionRevertAvailContacts : function(e){
    	e.preventDefault();

    	SELECT_ALL = false;
		_BULK_CONTACTS = undefined;
		
		var html = '';
		
		if(company_util.isCompany())
			html = "Selected " + App_Companies.companiesListView.collection.length + " companies. <a href='#'  id='select-all-available-contacts' class='c-p text-info'>Select all " + getAvailableContacts() + " companies</a>";
		else
			html = "Selected " + App_Contacts.contactsListView.collection.length + " contacts. <a href='#'  id='select-all-available-contacts' class='c-p text-info'>Select all " + getAvailableContacts() + " contacts</a>";

		$('body').find('#bulk-select').html(html);
    }   

   
});

var contacts_bulk_actions = {

	/**
	 * Bulk operations - Change owner Shows all the users as drop down list to
	 * select one of them as the owner for the selected contacts.
	 */
	change_owner : function(e){
			load_bulk_operations_template(function(){

					if (!canRunBulkOperations())
					{
						showModalConfirmation(
								"Bulk Change Owner",
								"You may not have permission to update some of the contacts selected. " + "Proceeding with this operation will change the owner for only the contacts " + "you are allowed to update.<br/><br/> Do you want to proceed?",
								show_bulk_owner_change_page, function()
								{
									// No callback
									return;
								}, function()
								{

								});
					}
					else
					{
						show_bulk_owner_change_page();
					}

			});
	},

	/**
	 * Bulk operations - Adds to campaign Shows all the workflows as drop down
	 * list to select one of them to subscribe the selected contacts
	 */
	assign_to_campaigns : function(e){
		// Selected Contact ids
		var id_array = get_contacts_bulk_ids();

		// when SELECT_ALL is true i.e., all contacts are
		// selected.
		if (id_array.length === 0)
			count = getAvailableContacts();
		else
			count = id_array.length;

		var continueAction = true;
		if (!canRunBulkOperations())
		{
			continueAction = false;
			showModalConfirmation(
					"Bulk Assign Campaign",
					"You may not have permission to update some of the contacts selected. Proceeding with this operation will add only your contacts to the campaign.<br/><br/>Do you want to proceed?",
					show_bulk_campaign_assign_page, function()
					{
						// No callback
					}, function()
					{
						return;
					});
		}
		if (is_free_plan() && has_more_than_limit())
		{
			continueAction = false;
			showModalConfirmation(
					"Add to Campaign",
					"You can apply this bulk action only on 25 contacts in the FREE Plan. Please choose lesser number of contacts or upgrade your account.",
					function()
					{
						Backbone.history.navigate("subscribe", { trigger : true });
					}, function()
					{
						// No callback
						return;
					}, function()
					{
						return;
					}, "Upgrade", "Close");
		}
		if (!canSendEmails(count))
		{
			continueAction = false;
			var pendingEmails = getPendingEmails();

			var yes = "Yes";
			var no = "No"

			var message = "";
			var upgrade_link = ' You may <a href="#subscribe" class="action" data-dismiss="modal" subscribe="subscribe" action="deny">purchase more emails </a> if this does not suffice your bulk action.';
			var title = "Low on emails"
			if (pendingEmails <= 0)
			{
				title = "Low on emails";
				yes = "";
				no = "Ok"
				message = "You have used up all emails in your quota. " + upgrade_link;
			}
			else
				message = "You have only " + pendingEmails + " emails left as per your quota. " + upgrade_link + " Continuing with this operation will stop sending emails once it crosses the quota.<br/><br/>" + "Do you want to proceed?";

			showModalConfirmation(title, message, show_bulk_campaign_assign_page, function(element)
			{

				// No callback
				if (!element)
					return;

				if ($(element).attr('subscribe'))
					Backbone.history.navigate("subscribe", { trigger : true });
				return;
			}, function(element)
			{
			}, yes, no);
			return;
		}
		else if (continueAction)
		{
			show_bulk_campaign_assign_page()
		}
	},

	/**
	 * Bulk operations - Adds tags' Shows the existing tags with help of
	 * typeahead to add tags to the selected contacts. Also we can add new tags.
	 */
	add_tags : function(e){

		load_bulk_operations_template(function(){

						if (!canRunBulkOperations())
						{
							showModalConfirmation(
									"Bulk Add Tag",
									"You may not have permission to update some of the contacts selected. Proceeding with this operation will add tag to only the contacts you are allowed to update.<br/><br/> Do you want to proceed?",

									show_add_tag_bulkaction_form, function()
									{
										// No callback
										return;
									}, function()
									{
										return;
									});
						}
						if (is_free_plan() && has_more_than_limit())
						{
							continueAction = false;
							showModalConfirmation(
									"Add tags",
									"You can apply this bulk action only on 25 contacts in the FREE Plan. Please choose lesser number of contacts or upgrade your account.",
									function()
									{
										Backbone.history.navigate("subscribe", { trigger : true });
									}, function()
									{
										// No callback
										return;
									}, function()
									{
										return;
									}, "Upgrade", "Close");
						}
						else
						{
							show_add_tag_bulkaction_form()
						}
					});
	},

	/**
	 * Bulk operations - Adds tags' Shows the existing tags with help of
	 * typeahead to add tags to the selected contacts. Also we can add new tags.
	 */
     remove_tags : function(e){
     	load_bulk_operations_template(function(){

					if (!canRunBulkOperations())
					{
						showModalConfirmation(
								"Bulk Remove Tag",
								"You may not have permission to update some of the contacts selected. Proceeding with this operation will delete tag to only the contacts you are allowed to update.<br/><br/> Do you want to proceed?",

								show_remove_tag_bulkaction_form, function()
								{
									// No callback
									return;
								}, function()
								{
									return;
								});
					}
					if (is_free_plan() && has_more_than_limit())
					{
						continueAction = false;
						showModalConfirmation(
								"Remove tags",
								"You can apply this bulk action only on 25 contacts in the FREE Plan. Please choose lesser number of contacts or upgrade your account.",
								function()
								{
									Backbone.history.navigate("subscribe", { trigger : true });
								}, function()
								{
									// No callback
									return;
								}, function()
								{
									return;
								}, "Upgrade", "Close");
					}
					else
					{
						show_remove_tag_bulkaction_form()
					}
				});
     },

     /**
	 * Bulk operations - Sends email to the bulk of contacts by filling up the
	 * send email details like from, subject and body.
	 */
     send_email : function(e){
     		load_bulk_operations_template(function(){

						// Selected Contact ids
						var id_array = get_contacts_bulk_ids();

						if (!canRunBulkOperations())
						{
							showModalConfirmation(
									"Bulk Email",
									"You may not be the owner for some of the contacts selected. Proceeding with this operation will send email to only your contacts.<br/><br/> Do you want to proceed?",
									function()
									{
										show_bulk_email_form(id_array)
									},
									function()
									{
										// No callback
										return;
									}, function()
									{
										return;
									});
						}
						if (is_free_plan() && has_more_than_limit())
						{
							showModalConfirmation(
									"Send Email",
									"You can apply this bulk action only on 25 contacts in the FREE Plan. Please choose lesser number of contacts or upgrade your account.",
									function()
									{
										Backbone.history.navigate("subscribe", { trigger : true });
									}, function()
									{
										// No callback
										return;
									}, function()
									{
										return;
									}, "Upgrade", "Close");
						}
						else
						{

							// when SELECT_ALL is true i.e., all contacts are
							// selected.
							if (id_array.length === 0)
								count = getAvailableContacts();
							else
								count = id_array.length;

							if (!canSendEmails(count))
							{
								var pendingEmails = getPendingEmails();

								var yes = "Yes";
								var no = "No"

								var message = "";
								var upgrade_link = 'Please <a href="#subscribe" class="action" data-dismiss="modal" subscribe="subscribe" action="deny">upgarde your email subscription.</a>';
								var title = "Not enough emails left"
								if (pendingEmails <= 0)
								{
									title = "Emails limit";
									yes = "";
									no = "Ok"
									message = "You have used up all emails in your quota. " + upgrade_link;
								}
								else
									message = "You have only " + pendingEmails + " emails remaining as per your quota. " + upgrade_link + " Continuing with this operation may not send the email to some contacts. <br/><br/>" + "Do you want to proceed?";

								showModalConfirmation(title, message, show_bulk_email_form, function(element)
								{

									// No callback
									if (!element)
										return;

									if ($(element).attr('subscribe'))
										Backbone.history.navigate("subscribe", { trigger : true });
								}, function(element)
								{
								}, yes, no);
								return;
							}

							show_bulk_email_form(id_array)
						}
					});
     },


	/**
	 * Bulk Operations - Exports selected contacts in a CSV file as an
	 * attachment to email of current domain user.
	 */
     export_contacts : function(e){

						// Removes if previous modals exist.
						if ($('#contacts-export-csv-modal').size() != 0)
						{
							$('#contacts-export-csv-modal').remove();
						}

						// Selected Contact ids
						var id_array = get_contacts_bulk_ids();

						var count = 0;

						// when SELECT_ALL is true i.e., all contacts are
						// selected.
						if (id_array.length === 0)
							count = getAvailableContacts();
						else
							count = id_array.length;


						getTemplate('contacts-export-csv-modal', {}, undefined, function(template_ui){
							if(!template_ui)
								  return;
							var contacts_csv_modal = $(template_ui);
							contacts_csv_modal.modal('show');

							contacts_csv_modal.on('shown.bs.modal', function(){
									// If Yes clicked
									$("#contacts-export-csv-modal").on("click",'#contacts-export-csv-confirm', function(e)
									{
										e.preventDefault();

										if ($(this).attr('disabled'))
											return;

										$(this).attr('disabled', 'disabled');

										// Shows message
										$save_info = $('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>Email will be sent shortly.</i></small></span>');
										$(this).parent('.modal-footer').find('.contacts-export-csv-message').append($save_info);
										$save_info.show();

										var url = '/core/api/bulk/update?action_type=EXPORT_CONTACTS_CSV';

										var json = {};
										json.contact_ids = id_array;
										json.data = JSON.stringify(CURRENT_DOMAIN_USER);
										postBulkOperationData(url, json, undefined, undefined, function()
										{

											// hide modal after 3 secs
											setTimeout(function()
											{
												contacts_csv_modal.modal('hide');
											}, 3000);

											// Uncheck contacts table and
											// hide bulk actions button.
											$('body').find('#bulk-actions').css('display', 'none');
											$('body').find('#bulk-select').css('display', 'none');
											$('table#contacts-table').find('.thead_check').removeAttr('checked');
											$('table#contacts-table').find('.tbody_check').removeAttr('checked');
											$(".grid-checkboxes").find(".thead_check").removeAttr("checked");
                                            $(".contacts-grid-view-temp").find(".tbody_check").removeAttr("checked");

										}, "no_noty");
									});
							});			


						}, null);
     },

     /**
	 * Bulk Operations - Exports selected contacts in a CSV file as an
	 * attachment to email of current domain user.
	 */
	export_companies : function(e)
			{
				e.preventDefault();

				// Removes if previous modals exist.
				if ($('#companies-export-csv-modal').size() != 0)
				{
					$('#companies-export-csv-modal').remove();
				}

				// Selected Contact ids
				var id_array = get_contacts_bulk_ids();

				var count = 0;

				// when SELECT_ALL is true i.e., all contacts are
				// selected.
				if (id_array.length === 0)
					count = getAvailableContacts();
				else
					count = id_array.length;

				
				getTemplate('companies-export-csv-modal', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					var companies_csv_modal = $(template_ui);
					companies_csv_modal.modal('show');

					companies_csv_modal.on('shown.bs.modal', function(){
						// If Yes clicked
						$("#companies-export-csv-modal").on("click", '#companies-export-csv-confirm', function(e)
										{
											e.preventDefault();

											if ($(this).attr('disabled'))
												return;

											$(this).attr('disabled', 'disabled');

											// Shows message
											$save_info = $('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>Email will be sent shortly.</i></small></span>');
											$(this).parent('.modal-footer').find('.companies-export-csv-message').append($save_info);
											$save_info.show();

											var url = '/core/api/bulk/update?action_type=EXPORT_COMPANIES_CSV';

											var json = {};
											json.contact_ids = id_array;
											json.data = JSON.stringify(CURRENT_DOMAIN_USER);
											postBulkOperationData(url, json, undefined, undefined, function()
											{

												// hide modal after 3 secs
												setTimeout(function()
												{
													companies_csv_modal.modal('hide');
												}, 3000);

												// Uncheck contacts table and
												// hide bulk actions button.
												$('body').find('#bulk-actions').css('display', 'none');
												$('body').find('#bulk-select').css('display', 'none');
												$('table#companies,table#contacts-table').find('.thead_check').removeAttr('checked');
												$('table#companies,table#contacts-table').find('.tbody_check').removeAttr('checked');

											}, "no_noty");
										});
						});
				}, null);
			},


select_contacts :  function(e)
			{
				e.preventDefault();
				SELECT_ALL = true;
				_BULK_CONTACTS = window.location.hash;
				
				var html = '';
				
				if(company_util.isCompany())
					html = ' Selected All ' + getAvailableContacts() + ' companies. <a hrer="#" id="select-all-revert" class="c-p text-info">Select chosen companies only</a>';
				else
					html = ' Selected All ' + getAvailableContacts() + ' contacts. <a hrer="#" id="select-all-revert" class="c-p text-info">Select chosen contacts only</a>';

				
				$('body')
						.find('#bulk-select')
						.css('display', 'inline-block')
						.html(html);

				// On choosing select all option, all the visible
				// checkboxes in the table should be checked
				$.each($('.tbody_check'), function(index, element)
				{
					$(element).attr('checked', "checked");
				});
			},

};


function show_bulk_owner_change_page()
	{
		var filter, id_array = [];
		if (SELECT_ALL == true)
			filter = getSelectionCriteria();
		else
			id_array = get_contacts_bulk_ids();

		// Yes callback
		// Bind a custom event to trigger on loading the form
		$("body").off('fill_owners').on("fill_owners", function(event)
		{
			var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
			fillSelect('ownerBulkSelect', '/core/api/users', 'domainUsers', 'no-callback ', optionsTemplate);
		});

		// Navigate to show form
		if(company_util.isCompany())
			Backbone.history.navigate("company-bulk-owner", { trigger : true });
		else
			Backbone.history.navigate("bulk-owner", { trigger : true });

		/**
		 * Changes the owner by sending the new owner name as path parameter and
		 * contact ids as form data of post request
		 */
		$("#changeOwnerToBulk").click(function(e)
		{
			e.preventDefault();

			var $form = $('#ownerBulkForm');

			// Button Disabled or Validate Form failed
			if ($(this).attr('disabled') == 'disabled' || !isValidForm($form))
			{
				return;
			}

			var saveButton = $(this);

			disable_save_button(saveButton);
			// Show loading symbol until model get saved
			// $('#ownerBulkForm').find('span.save-status').html(getRandomLoadingImg());

			var url;

			var new_owner = $('#ownerBulkSelect option:selected').prop('value');
			url = '/core/api/bulk/update?action_type=CHANGE_OWNER&owner=' + new_owner;
			var json = {};
			json.contact_ids = id_array;
			postBulkOperationData(url, json, $form, undefined, function(data)
			{
				enable_save_button(saveButton);
			}, 'Contacts owner change scheduled')
		});

	}

	function show_bulk_campaign_assign_page()
	{

		load_bulk_operations_template(function(){

			var id_array = [];
			var filter;
			if (SELECT_ALL == true)
				filter = getSelectionCriteria();
			else
				id_array = get_contacts_bulk_ids();

			console.log(filter);

	        $("body").off('fill_campaigns').on("fill_campaigns", function(event)
			{
				var optionsTemplate = "<option value='{{id}}'{{#if is_disabled}}disabled=disabled>{{name}} (disabled){{else}}>{{name}}{{/if}}</option>";
 				fillSelect('campaignBulkSelect', '/core/api/workflows', 'workflow', 'no-callback ', optionsTemplate);
			});

			// Navigate to show form
			Backbone.history.navigate("bulk-campaigns", { trigger : true });

			/**
			 * Subscribes the selected contacts to a campaign by sending the
			 * workflow id and selected contacts' ids.
			 */
			$("#addBulkTocampaign").click(function(e)
			{
				e.preventDefault();

				var $form = $('#campaignsBulkForm');

				// Button Disabled or Validate Form Failed
				if ($(this).attr('disabled') == 'disabled' || !isValidForm($form))
				{
					return;
				}

				var saveButton = $(this);

				disable_save_button(saveButton);
				// Show loading symbol until model get saved
				// $('#campaignsBulkForm').find('span.save-status').html(getRandomLoadingImg());

				var workflow_id = $('#campaignBulkSelect option:selected').prop('value');
				var url = '/core/api/bulk/update?workflow_id=' + workflow_id + "&action_type=ASIGN_WORKFLOW";

				var json = {};
				json.contact_ids = id_array;
				postBulkOperationData(url, json, $form, undefined, function(data)
				{
					enable_save_button(saveButton);
				}, 'Campaign assigning scheduled');
			});
		});
		
	}

	function show_add_tag_bulkaction_form()
	{
		var id_array = get_contacts_bulk_ids();

		// var tags = get_tags('tagsBulkForm');

		Backbone.history.navigate("bulk-tags", { trigger : true });

		setup_tags_typeahead();

		$('#addBulkTags')
				.on(
						"focusout",
						function(e)
						{
							e.preventDefault();
							var tag_input = $(this).val().trim();
							$(this).val("");
							if (tag_input && tag_input.length >= 0 && !(/^\s*$/).test(tag_input))
							{
								$('#addBulkTags')
										.closest(".control-group")
										.find('ul.tags')
										.append(
												'<li class="tag" style="display: inline-block;" data="' + tag_input + '">' + tag_input + '<a class="close" id="remove_tag" tag="' + tag_input + '">&times</a></li>');
							}

						});
		/**
		 * Add the tags to the selected contacts by sending the contact ids and
		 * tags through post request to the appropriate url
		 */
		 $("#addTagsToContactsBulk").click(function(e)
		{
			e.preventDefault();

			var tags = get_tags('tagsBulkForm');

			// To add input field value as tags
			var tag_input = $('#addBulkTags').val().trim();
			$('#addBulkTags').val("");
			
			if(tag_input && tag_input.length>=0 && !(/^\s*$/).test(tag_input))
			{
				$('#addBulkTags').closest(".control-group").find('ul.tags').append('<li class="tag" style="display: inline-block;" data="'+tag_input+'">'+tag_input+'<a class="close" id="remove_tag" tag="'+tag_input+'">&times</a></li>');
			}
			
		//	$('#addBulkTags').closest(".control-group").find('ul.tags').append('<li class="tag" style="display: inline-block;" data="'+tag_input+'">'+tag_input+'<a class="close" id="remove_tag" tag="'+tag_input+'">&times</a></li>');
			
			
			
			if(tag_input != "")
				tags[0].value.push(tag_input);

			if (tags[0].value.length > 0)
			{
				var tags_valid = true;
				$.each(tags[0].value, function(index, value)
					{
						if(!isValidTag(value, false)) {
							tags_valid = false;
							return false;
						}
					});
				if(!tags_valid) {
					$('.invalid-tags').show().delay(6000).hide(1);
					return false;
				}
				// Show loading symbol until model get saved
				var saveButton=$(this);

				disable_save_button(saveButton);
				
				//$('#tagsBulkForm').find('span.save-status').html(getRandomLoadingImg());

				var url = '/core/api/bulk/update?action_type=ADD_TAG';
				var json = {};
				json.data = JSON.stringify(tags[0].value);
				json.contact_ids = id_array;

				acl_util.canAddTag(json.data,function(result){
					postBulkOperationData(url, json, $('#tagsBulkForm'), undefined, function(data)
							{
								enable_save_button(saveButton);
								// Add the added tags to the collection of tags
								$.each(tags[0].value, function(index, tag)
								{
									tagsCollection.add({ "tag" : tag });
								});
							}, 'Tags add scheduled');
				}, function(error){
					enable_save_button(saveButton);
				});
			}
			else 
			{
				$('#addBulkTags').focus();
				$('.error-tags').show().delay(3000).hide(1);
				return;
			}
		});
	}

	function show_remove_tag_bulkaction_form()
	{
		var id_array = get_contacts_bulk_ids();

		// var tags = get_tags('tagsBulkForm');

		Backbone.history.navigate("bulk-tags-remove", { trigger : true });

		setup_tags_typeahead();

		$('#removeBulkTags')
				.on(
						"focusout",
						function(e)
						{
							e.preventDefault();
							var tag_input = $(this).val().trim();
							$(this).val("");
							if (tag_input && tag_input.length >= 0 && !(/^\s*$/).test(tag_input))
							{
								$(this)
										.closest(".control-group")
										.find('ul.tags')
										.append(
												'<li class="tag" style="display: inline-block;" data="' + tag_input + '">' + tag_input + '<a class="close" id="remove_tag" tag="' + tag_input + '">&times</a></li>');
							}

						});
		/**
		 * Add the tags to the selected contacts by sending the contact ids and
		 * tags through post request to the appropriate url
		 */
		$("#removeTagsToContactsBulk").click(function(e)
						{
							e.preventDefault();

							var tags = get_tags('tagsRemoveBulkForm');

							// To add input field value as tags
							var tag_input = $('#removeBulkTags').val().trim();
							$('#removeBulkTags').val("");

							if (tag_input && tag_input.length >= 0 && !(/^\s*$/).test(tag_input))
							{
								$('#removeBulkTags')
										.closest(".control-group")
										.find('ul.tags')
										.append(
												'<li class="tag" style="display: inline-block;" data="' + tag_input + '">' + tag_input + '<a class="close" id="remove_tag" tag="' + tag_input + '">&times</a></li>');
							}

							// $('#addBulkTags').closest(".control-group").find('ul.tags').append('<li
							// class="tag" style="display: inline-block;"
							// data="'+tag_input+'">'+tag_input+'<a
							// class="close" id="remove_tag"
							// tag="'+tag_input+'">&times</a></li>');

							if (tag_input != "")
								tags[0].value.push(tag_input);

							if (tags[0].value.length > 0)
							{
								// Show loading symbol until model get saved
								var saveButton = $(this);

								disable_save_button(saveButton);

								// $('#tagsBulkForm').find('span.save-status').html(getRandomLoadingImg());

								var url = '/core/api/bulk/update?action_type=REMOVE_TAG';
								var json = {};
								json.data = JSON.stringify(tags[0].value);
								json.contact_ids = id_array;

								postBulkOperationData(url, json, $('#tagsRemoveBulkForm'), undefined, function(data)
								{
									enable_save_button(saveButton);
									// Add the added tags to the collection of
									// tags
									$.each(tags[0].value, function(index, tag)
									{
										tagsCollection.add({ "tag" : tag });
									});
								}, 'Tags delete scheduled');
							}
							else
							{
								$('#removeBulkTags').focus();
								$('.error-tags').show().delay(3000).hide(1);
								return;
							}
						});
	}


	function show_bulk_email_form(id_array)
	{
		var count = 0;

		// Selected Contact ids
		if(id_array && id_array.length == 0)
		id_array = get_contacts_bulk_ids();

        $("body").off('fill_emails').on("fill_emails", function(event)
		{

			var $emailForm = $('#emailForm');

			// Populate from address and templates
			populate_send_email_details();

			// Setup HTML Editor
			setupTinyMCEEditor('textarea#email-body', false, undefined, function()
			{

				// Reset tinymce content
				set_tinymce_content('email-body', '');
			});

			// when SELECT_ALL is true i.e., all contacts are selected.
			if (id_array.length === 0)
				count = getAvailableContacts();
			else
				count = id_array.length;

			// Shows selected contacts count in Send-email page.
			$emailForm.find('div#bulk-count').css('display', 'inline-block');
			
			if(company_util.isCompany())
				$emailForm.find('div#bulk-count p').html("Selected <b>" + count + " Companie(s)</b> for sending email.");
			else
				$emailForm.find('div#bulk-count p').html("Selected <b>" + count + " Contact(s)</b> for sending email.");

			// Hide to,cc and bcc
			$emailForm.find('input[name="to"]').closest('.control-group').attr('class', 'hidden');
			$emailForm.find('a#cc-link').closest('.control-group').attr('class', 'hidden');

			// Change ids of Send and Close button, to avoid normal send-email
			// actions.
			$emailForm.find('.form-actions a#sendEmail').removeAttr('id').attr('id', 'bulk-send-email');
			$emailForm.find('.form-actions a#send-email-close').removeAttr('id');

		});

		if(company_util.isCompany())
			Backbone.history.navigate("company-bulk-email", { trigger : true });
		else
			Backbone.history.navigate("bulk-email", { trigger : true });

		$("body #bulk-send-email").off("click");
		$("#bulk-send-email").click(function(e)
		{
			e.preventDefault();

			if ($(this).attr('disabled'))
				return;

			var $form = $('#emailForm');

			// Is valid
			if (!isValidForm($form))
				return;

			// Disables send button and change text to Sending...
			disable_send_button($(this));

			// Saves tinymce content to textarea
			save_content_to_textarea('email-body');

			// serialize form.
			var form_json = serializeForm("emailForm");
			if (form_json.from_email != CURRENT_DOMAIN_USER.email && form_json.from_name == CURRENT_DOMAIN_USER.name)
			{
				form_json.from_name = "";
			}
			var url = '/core/api/bulk/update?action_type=SEND_EMAIL';

			var json = {};
			json.contact_ids = id_array;
			json.data = JSON.stringify(form_json);
			
			var msg = "Emails have been queued for " + count + " contacts. They will be sent shortly.";
			if(company_util.isCompany())
				msg = "Emails have been queued for " + count + " companies. They will be sent shortly.";

			postBulkOperationData(url, json, $form, null, function()
			{
				enable_send_button($('#bulk-send-email'));
			}, msg);
		});
	}

/**
 * Gets an array of contact ids to perform bulk operations
 * 
 * @method get_contacts_bulk_ids
 * @returns {Array} id_array of contact ids
 */
function get_contacts_bulk_ids()
{
	var id_array = [];
	if (SELECT_ALL == true)
		return id_array;

	var table = $('body').find('.showCheckboxes');

	if ($(".grid-view").length != 0)
	{
		$(table).find('.tbody_check').each(function(index, element)
		{
			// If element is checked add store it's id in an array
			if ($(element).is(':checked'))
			{
				id_array.push($(element).parent('div').attr('id'));
			}
		});

		return id_array;
	}

	$(table).find('tr .tbody_check').each(function(index, element)
	{

		// If element is checked add store it's id in an array
		if ($(element).is(':checked'))
		{
			id_array.push($(element).closest('tr').data().get('id'));
		}
	});
	return id_array;
}

/**
 * Shows bulk actions drop down menu (of contacts table) only when any of the
 * check box is enabled.
 * 
 * @method toggle_contacts_bulk_actions_dropdown
 * @param {Object}
 *            clicked_ele clicked check-box element
 */
function toggle_contacts_bulk_actions_dropdown(clicked_ele, isBulk, isCampaign)
{
	SELECT_ALL = false;
	_BULK_CONTACTS = undefined;

	// For Active Subscribers table
	if (isCampaign === "active-campaign")
	{
		toggle_active_contacts_bulk_actions_dropdown(clicked_ele, isBulk);
		return;
	}

	var total_available_contacts = getAvailableContacts();

	console.log(readCookie('contact_filter'));
	$('body').find('#bulk-select').css('display', 'none')
	if ($(clicked_ele).is(':checked'))
	{
		$('body').find('#bulk-actions').css('display', 'inline-block');
		
		if(company_util.isCompany()){
			if (isBulk && total_available_contacts != App_Companies.companiesListView.collection.length)
			{
			$('body')
					.find('#bulk-select')
					.css('display', 'block')
					.html(
							"Selected " + App_Companies.companiesListView.collection.length + " companies. <a id='select-all-available-contacts' class='c-p text-info' href='#'>Select all " + total_available_contacts + " companies</a>");
			$('#bulk-select').css("display","inline");
			}
		} else {
			if (isBulk && total_available_contacts != App_Contacts.contactsListView.collection.length)
			{
			$('body')
					.find('#bulk-select')
					.css('display', 'block')
					.html(
							"Selected " + App_Contacts.contactsListView.collection.length + " contacts. <a id='select-all-available-contacts' class='c-p text-info' href='#'>Select all " + total_available_contacts + " contacts</a>");
			$('#bulk-select').css("display","inline");
			}
		}

		
	}
	else
	{
		if (isBulk)
		{
			$('#bulk-actions').css('display', 'none');
			return;
		}

		var check_count = 0
		$.each($('.tbody_check'), function(index, element)
		{
			if ($(element).is(':checked'))
			{
				check_count++;
				return false;
			}
			// return;
		});

		if (check_count == 0)
		{
			$('#bulk-actions').css('display', 'none');
		}
	}
}

/**
 * Returns number of available contacts, which is read from count field in first
 * contact in the collection. If count variable in not available in first
 * contact then collection length is returned
 * 
 * @returns
 */
function getAvailableContacts()
{
		if (company_util.isCompany() && App_Companies.companiesListView.collection.toJSON()[0] && App_Companies.companiesListView.collection.toJSON()[0].count)
		{
			//
			current_view_contacts_count = App_Companies.companiesListView.collection.toJSON()[0].count;
			return current_view_contacts_count;
		} else if (App_Contacts.contactsListView.collection.toJSON()[0] && App_Contacts.contactsListView.collection.toJSON()[0].count)
		{
			//
			current_view_contacts_count = App_Contacts.contactsListView.collection.toJSON()[0].count;
			return current_view_contacts_count;
		}
	 
	return App_Contacts.contactsListView.collection.toJSON().length;
}

/**
 * Returns selection criteria. Reads filter cookie, if filter cookie is not
 * available, it returns window hash(to check whether tag filter is applied on
 * it)
 * 
 * @returns
 */
function getSelectionCriteria()
{
	// Reads filter cookie$('.filter-criteria'

	var filter_id = undefined;
	
	if(company_util.isCompany())
		filter_id = $('.filter-criteria', $(App_Companies.companiesListView.el)).attr("_filter");
	else
		filter_id = $('.filter-criteria', $(App_Contacts.contactsListView.el)).attr("_filter");

	if (filter_id && _BULK_CONTACTS == "#contacts")
	{
		return filter_id;
	}
	
	if(_BULK_CONTACTS == "#companies"){
		if(filter_id)
			return filter_id;
		else
			return 'Companies';
	}

	// If filter cookie is not available then it returns either '#contacts' of
	// '#tags/{tag}' according to current window hash
	if (_BULK_CONTACTS)
	{
		return _BULK_CONTACTS;
	}
}

/**
 * Posts filter id. It takes url to post, the data
 * 
 * @param url
 * @param data
 * @param form
 * @param contentType
 * @param callback
 */
function postBulkOperationData(url, data, form, contentType, callback, error_message)
{
	var count = data.contact_ids.length;
	var dynamic_filter = getDynamicFilters();
	if (dynamic_filter != null)
	{
		data.dynamic_filter = dynamic_filter;
	}
	if (data.contact_ids && data.contact_ids.length == 0)
	{
		console.log(data.contact_ids);
		console.log(getSelectionCriteria());
		if (dynamic_filter == null)
		{
			url = url + "&filter=" + encodeURIComponent(getSelectionCriteria());
		}
		console.log(url);
	}
	else
		data.contact_ids = JSON.stringify(data.contact_ids);

	data.tracker = Math.floor(Math.random() * (10000 - 1)) + 1;
	contentType = contentType != undefined ? contentType : "application/x-www-form-urlencoded";
	
	// Ajax request to post data
	$.ajax({ url : url, type : 'POST', data : data, contentType : contentType, success : function(data)
	{

		$save_info = $('<div style="display:inline-block"><small><p class="text-success"><i>Task Scheduled.</i></p></small></div>');

		if (form !== undefined)
		{
			var save_msg = $(form).find('.form-actions');

			if (save_msg.find('.text-success'))
				save_msg.find('.text-success').parent().parent().remove(); // erase
																			// previous
																			// message.

			save_msg.append($save_info);
		}

		if (callback && typeof (callback) === "function")
			callback(data);

		if(!company_util.isCompany())
			// On save back to contacts list
			Backbone.history.navigate("contacts", { trigger : true });
		else
			Backbone.history.navigate("companies", { trigger : true });

		// If no_noty is given as error message, neglect noty
		if (error_message === "no_noty")
			return;

		if (!error_message)
		{
			showNotyPopUp('information', "Task scheduled", "top", 5000);
			return;
		}
		if(count > 20 || count == 0)
			showNotyPopUp('information', error_message, "top", 5000);
	} });
}

function getDynamicFilters()
{
	var dynamic_filter = null;
	
	if (company_util.isCompany())
	{
		if(!App_Companies.companiesListView || !App_Companies.companiesListView.post_data)
		{
			return null;
		}
		
		dynamic_filter = App_Companies.companiesListView.post_data.filterJson;
	}
	else
	{
		if(!App_Contacts.contactsListView || !App_Contacts.contactsListView.post_data)
		{
			return null;
		}
		
		dynamic_filter = App_Contacts.contactsListView.post_data.filterJson;;
	}

	if (!dynamic_filter || dynamic_filter == null)
	{
		return null;
	}
	else
	{
		if (JSON.parse(dynamic_filter).rules.length > 0)
		{
			return dynamic_filter;
		}
		else
		{
			return null;
		}
	}
}

function bulkOperationContactsCount()
{
	if (SELECT_ALL == true)
	{
		return getAvailableContacts();
	}

	else
	{
		var id_array = get_contacts_bulk_ids();
		return id_array.length;
	}
}

/**
 * Limit on free user bulk operations
 */
function has_more_than_limit()
{
	if (bulkOperationContactsCount() > 25)
		return true;

	return false;
}


function load_bulk_operations_template(callback){

	getTemplate("bulk-actions-company-owner", {}, undefined, function(template_ui){
				if(callback)
				   callback();

	}, null);

}/**
 * table-checkboxes.js Prepends check-boxes to each row of desired tables (which are 
 * having showCheckboxes class), in order to perform bulk operations (Delete, Change owner etc..)
 * 
 * @module Bulk operations
 * ---------------------------------------------
 * author: Rammohan
 *  
 */
$(function(){	
	
   /**
    * Custom event to add check-boxes to specified tables
    * Prepends check-boxes to the tables which are having the class showCheckboxes, 
    * by triggering the event agile_collection_loaded from base-collection render event, while loading the collection.
    */ 	
	$('body').on('agile_collection_loaded', function(event, el) {
		//use class ignore-collection if any other table needs to be used inside the template.
		var table_element = $('table:not(.ignore-collection)', el);
		
		  // Adds class to tbody to edit the table by validating the route attribute 
		if($(table_element).find('tbody').attr('route'))
			$(table_element).find('tbody').addClass('agile-edit-row');
		
		if($(table_element).hasClass('onlySorting'))
		{	
		    sort_tables(table_element);
		    return;
		}
		
		if($('.grid-view', el).hasClass('showCheckboxes'))
		{
			if($(this).find('#delete-checked-grid').length == 0)
					var element = $('.showCheckboxes').after('<div class="row"><div class="span6 select-none"></div></div><a href="#" class="btn btn-danger left" id="delete-checked-grid" style="margin-bottom: 15px"> Delete</a>');		
			console.log(element);
			return;
		}
		
		
		var table = $(el).find('table.showCheckboxes');
		$(table).removeClass('table-bordered');
		$(table).closest('div.data-block').removeClass('data-block');
		
	
		//$(table).setAttribute('id', 'sort-table');

		var table_body_row = $(table).find('tbody tr');
		var table_header_row = $(table).find('thead tr');

		var table_headers = $(table_header_row).find('.thead_check');
		var table_cell = $(table_body_row).find('.tbody_check');

		
		// Remove, if rendere of a collection is called multiple times 
		if(table_headers.length == 0)
			$(table_header_row).prepend('<th style="width:5%;"><label class="i-checks i-checks-sm m-b-none"><input type="checkbox" class="thead_check" value=""><i></i></label></th>');
		
		if(table_cell.length == 0)
			$(table_body_row).prepend('<td class="v-middle checkbox" style="cursor:default;"><label class="i-checks i-checks-sm"><input type="checkbox" class="tbody_check" value=""><i></i></label></td>');	  
		
		$(el).find('#delete-checked').remove();
		
		if(!$(table_element).hasClass('noDelete')){
			
			$(table).after('<div><div class="select-none"></div></div><footer class="panel-footer"><a href="#" class="btn btn-danger btn-sm" id="delete-checked"> Delete</a></footer>');
			
		}
			
		if($(table_element).hasClass('no-sorting'))
		{	
		    console.log(table_element);
		    return;
		}

		// Sorts the tables based on their column values
		sort_tables(table_element);
	});

   /**
    * Select all - Enables/Disables all check-boxes of table body when table head check-box is clicked 
    * Changes the checking status of table body check-boxes according to 
    * the status of table head check-box
    */	
	$('body').on('click', '.thead_check', function(event){
		console.log( $(this).is(':checked'));
		if(!$(this).is(':checked'))
		{
			$('.tbody_check').prop('checked',false);
			
			if (Current_Route == 'deals')
				deal_bulk_actions.toggle_deals_bulk_actions_dropdown(undefined, true,$(this).parents('table').attr('id'));
			else
				toggle_contacts_bulk_actions_dropdown(undefined, true,$(this).parents('table').attr('id'));
			
		}
		else
			$('.tbody_check').prop('checked',true);
	
		console.log($(this).is(':checked'));
		
		// Show bulk operations only when thead check box is checked
		if (Current_Route == 'deals')
			deal_bulk_actions.toggle_deals_bulk_actions_dropdown(this, true,$(this).parents('table').attr('id'));
		else
			toggle_contacts_bulk_actions_dropdown(this, true,$(this).parents('table').attr('id'));
		
	});
	
   /**
    * Stops the propagation of default functionality (editing the entity) of parent to the check-box (tr)
    * and shows the bulk-actions drop down of contacts only when 
    * there is at least one check-box checked.
    */	
	$('body').on('click', '.tbody_check', function(event){
		event.stopPropagation();
		
		if (Current_Route == 'deals')
			deal_bulk_actions.toggle_deals_bulk_actions_dropdown(this,false,$(this).parents('table').attr("id"));
		/*else if(Current_Route=='contacts' && readCookie("agile_contact_view"))
			toggle_contacts_bulk_actions_dropdown(this,true,$(this).parents('table').attr("id"));*/
		else
			toggle_contacts_bulk_actions_dropdown(this,false,$(this).parents('table').attr("id"));
	});
});

function append_checkboxes(el)
{
	var checkbox_element = $('tr:last > td.select_checkbox', el);
	if(checkbox_element.length != 0)
	{
		if(SELECT_ALL == true || (Current_Route == 'deals' && deal_bulk_actions.SELECT_ALL_DEALS==true) || SUBSCRIBERS_SELECT_ALL == true)
		$('.tbody_check', checkbox_element).attr('checked', 'checked');
		
		return;
	}

	// If select all is chosen then all the upcomming models with in table should have checked checkboxes
	if(SELECT_ALL == true || (Current_Route == 'deals' && deal_bulk_actions.SELECT_ALL_DEALS==true) || SUBSCRIBERS_SELECT_ALL == true)
	{
		$('tr:last', el).prepend('<td><label class="i-checks i-checks-sm"><input class="tbody_check" type="checkbox" checked="checked"/><i></i></label></td>');
		var grid_view_element = $(".grid-view-checkbox", el);
		  if(grid_view_element.length != 0)
		      grid_view_element.prop("checked", "checked");
	}	

	else
		$('tr:last', el).prepend('<td><label class="i-checks i-checks-sm"><input class="tbody_check" type="checkbox"/><i></i></label></td>');	
}/**
 * Handles the click event of any row of any table (whose 'tbody' has the class
 * 'agile-edit-row').
 * 
 * The class 'agile-edit-row' is added to the tbody (in the custom event
 * 'agile_collection_loaded', which is triggered while loading the collection),
 * when only the tbody has an attribute 'route' (specifies the path where to
 * navigate on clicking the row)
 * 
 */

// For scrolling to recently edited contact in the list
var SCROLL_POSITION;

$(function() {

	$("body").on('click', '.agile-edit-row > tr > td:not(":first-child")',
			function(e) {
		e.preventDefault();
		
		var route = $('.agile-edit-row').attr('route');
		
		// Newly added code for displaying contacts and companies in same table with different routes.
		if($(this).closest('tr').find('[route]').length != 0)
			route = $(this).closest('tr').find('[route]').attr('route');
		
		var data = $(this).closest('tr').find('.data').attr('data');

		if(route == "contact/" || route == "company/")
			SCROLL_POSITION = window.pageYOffset;

				if (route == "contact/")
					SCROLL_POSITION = window.pageYOffset;

				console.log(data);

				if (data) {
					Backbone.history.navigate(route + data, {
						trigger : true
					});
				}
			});
});
/**
 * Sorts the table based on its column values. For each table the sort_tables
 * function is called from the custom event 'agile_collection_loaded', which is
 * triggered form base-collection render function.
 * 
 * When the table is loaded, it is in its default order and no arrow marks
 * appeared at column headings. When the mouse is hovered on any heading of the
 * column an arrow mark (bright color) will be shown to indicate that the table
 * can be sorted on that column values. When the heading is clicked, the table
 * will get sorted on that particular column values and a permanent arrow mark
 * (shaded color) will be shown to indicate, the table is sorted on that
 * particular column values (up-arrow -> ascending order, down-arrow ->
 * descending order)
 * 
 * @method sort_tables
 * @param {Object}
 *            table as html object
 */
function sort_tables(table) {
	
	head.js(LIB_PATH + "lib/jquery.tablesorter.min.js", function() {

	    // add parser through the tablesorter addParser method to sort tasks based on priority
	    $.tablesorter.addParser({ 
	        // set a unique id 
	        id: 'priority', 
	        is: function(s) { 
	            // return false so this parser is not auto detected 
	            return false; 
	        }, 
	        format: function(s) { 
	            // format your data for normalization 
	            return s.toLowerCase().replace(/high/,2).replace(/normal/,1).replace(/low/,0); 
	        }, 
	        // set type, either numeric or text 
	        type: 'numeric' 
	    }); 
	    
	    // add parser through the tablesorter addParser method to sort based on date
	    $.tablesorter.addParser({ 
	        // set a unique id 
	        id: 'time-ago', 
	        is: function(s) { 
	            // return false so this parser is not auto detected 
	            return false; 
	        }, 
	        format: function(s, table, cell, cellIndex) { 
	        	// format your data for normalization
	        	var time = cell.getElementsByTagName("time");
	        	if(time)
	              return $(time).attr("value"); 
	        }, 
	        // set type, either numeric or text 
	        type: 'numeric' 
	    });
	    
	    // add parser through the tablesorter addParser method to sort deal based on value
	    $.tablesorter.addParser({ 
	        // set a unique id 
	        id: 'money', 
	        is: function(s) { 
	            // return false so this parser is not auto detected 
	            return false; 
	        }, 
	        format: function(s, table, cell) { 
	            // format your data for normalization 
	            return cell.getAttribute("value"); 
	        }, 
	        // set type, either numeric or text 
	        type: 'numeric' 
	    }); 
	 
		
	    var table_id = $(table).attr('id');
	    if(table_id == 'deal-list')
	    	{
	    		sort_deals(table);
	    		return;
	    	}
/*	    if(table_id == "task-list")
	    	{
	    		sort_tasks(table);
	    		return;
	    	}*/
	    if(table_id == "document-list")
    	{
    		sort_documents(table);
    		return;
    	}
	    if(table_id == "case-list")
    	{
    		sort_cases (table);
    		return;
    	}
	    if(table_id == "schedule-updates")
    	{
    		sort_schedule_updates(table);
    		return;
    	} 
	    if(table_id == "contact-filter-list")
    	{
	    	sort_filters(table);
    		return;
    	}
	    
    	basic_table_sort(table);

	});
}

function basic_table_sort(table)
{
	   
	$(table).tablesorter({
		// Disable the sorting property to the first column of the table
		// (first colon contains check-boxes)
		// pass the headers argument and assign a object
		headers : {
			0 : {
				// disable it by setting the property sorter to false
				sorter : false
			}
		}
	});
}

function sort_tasks(table)
{
	$(table).tablesorter({ 
        headers: {
        	0 : {sorter : false},
        	1 : {sorter : false},
        	2 : {sorter : 'text'},
        	3 : {sorter : 'text'},
            4: {sorter:'priority'},
			5 : {sorter : 'time-ago'},
			6 : {sorter : false}
        } 
    }); 
}

function sort_deals(table)
{
	$(table).tablesorter({ 
        headers: { 
        	0 : {sorter : false	},
        	1 : {sorter : 'text'},
        	2 : {sorter : false},
        	3 : {sorter : 'money'},
        	4 : {sorter : 'text'},
			5 : {sorter : 'time-ago'},
        	6 : {sorter : false}
        }
    });
}

function sort_documents(table)
{
	$(table).tablesorter({ 
        headers: { 
        	0 : {sorter : false	},
        	1 : {sorter : 'text'},
        	2 : {sorter : false},
			3 : {sorter : 'time-ago'},
			4 : {sorter : false	}
        }
    });
}

function sort_cases(table)
{
	$(table).tablesorter({ 
        headers: { 
        	0 : {sorter : false	},
        	1 : {sorter : false},
        	2 : {sorter : 'text'},
			3 : {sorter : 'time-ago'},
			4 : {sorter : false	},
			5 : {sorter : 'text'}
        }
    });
}

function sort_schedule_updates(table)
{
	$(table).tablesorter({ 
        headers: {
        	0 : {sorter : false},
        	1 : {sorter : 'text'},
        	2 : {sorter : 'text'},
        	3 : {sorter : 'time-ago'},
            4 : {sorter:'text'}			
        } 
    }); 
}

function sort_filters(table)
{
	$(table).tablesorter({ 
        headers: {
        	0 : {sorter : false},
        	1 : {sorter : 'text'},
        	2 : {sorter : false},        	    	
        } 
    }); 
}
/**
 * Case is modelled along the lines of Deals. So functionality and coding style
 * are very similar.
 * 
 * @author Chandan
 */
$(function(){

	$('#casesModal, #casesUpdateModal').on("shown.bs.modal", function()
	{
		// Add placeholder and date picker to date custom fields
		$('.date_input').attr("placeholder","Select Date");
    	$('.date_input').datepicker({
			format: CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY
		});

		// Enable the datepicker
		$('#close_date', el).datepicker({
			format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY
		});
	
	});
	
	$('#casesModal,#casesUpdateModal').on('click', '#cases_validate', function(e) 
	{
		e.preventDefault();

		// To know updated or added cases form names
		var modal_id = $(this).closest('.cases-modal').attr("id");
		var form_id = $(this).closest('.cases-modal').find('form').attr("id");
		var json = serializeForm(form_id);
		savecases(form_id, modal_id, this, json);
	});

});


// show add case modal
function initializeCasesListeners(el){
	
	$('#cases-listners').off();
	// $("#cases-listners #cases-model-list > tr").off('mouseenter');
	$("#cases-listners").on('mouseenter','#cases-model-list > tr', function(){

		var data = $(this).find('.data').attr('data');
		var currentCase = App_Cases.casesCollectionView.collection.get(data);
		var that = this;
		getTemplate('cases-detail-popover', currentCase.toJSON(), undefined, function(template_ui){
	 		if(!template_ui)
	    		return;
	    	var ele = $(template_ui);
			$(that).popover(
					{ "rel" : "popover", "trigger" : "hover", "placement" : 'right', "original-title" : currentCase.toJSON().name, "content" : ele,
						"html" : true, });
			$(that).popover('show');
		}, null);

	});

	/**
	 * On mouse out on the row hides the popover.
	 */
	 $("#cases-listners #cases-model-list > tr").off('mouseleave');
	 $('#cases-listners').on('mouseleave', '#cases-model-list > tr', function()
	{
		$(this).popover('hide');
	});

	$("#cases-listners .cases-add").off('click');
	$('#cases-listners').on('click', '.cases-add', function(e)
	{
		e.preventDefault();
		showCases();
	});

	
	$("#cases-listners #cases-model-list > tr > td:not(':first-child')").off('click');
	$('#cases-listners').on('click', '#cases-model-list > tr > td:not(":first-child")', function(e) 
	{
		e.preventDefault();
		updatecases($(this).closest('tr').data());
	});
}

/**
 * Show cases popup for editing
 * 
 * @param ele
 */
function updatecases(ele)
{	
	$("#casesUpdateModal").html(getTemplate("cases-update-modal", {})).modal("show");
	var value = ele.toJSON();

	add_recent_view(new BaseModel(value));

	var casesForm = $("#casesUpdateForm");
	deserializeForm(value, casesForm);

	// Call setupTypeAhead to get contacts
	agile_type_ahead("contacts-typeahead-input", casesForm, contacts_typeahead);

	add_custom_fields_to_form(value, function(data)
	{
		var el_custom_fields = show_custom_fields_helper(data["custom_fields"], [
			"modal"
		]);
		fill_custom_fields_values_generic($(el_custom_fields), value["custom_data"])
		$("#custom-field-case", casesForm).html(fill_custom_fields_values_generic($(el_custom_fields), value["custom_data"]));

	}, "CASE");

	// Fills owner select element
	populateUsers("owners-list", casesForm, value, 'owner', function(data)
	{
		casesForm.find("#owners-list").html(data);
		if (value.owner)
		{
			$("#owners-list", casesForm).find('option[value=' + value['owner'].id + ']').attr("selected", "selected");
		}

	});
}

// Show new cases popup
function showCases()
{

	$("#casesModal").html(getTemplate("cases-new-modal", {})).modal("show");
	var el = $("#casesForm");

	add_custom_fields_to_form({}, function(data)
	{
		var el_custom_fields = show_custom_fields_helper(data["custom_fields"], []);
		$("#custom-field-case", $("#casesModal")).html($(el_custom_fields));

	}, "CASE");

	// Contacts type-ahead
	agile_type_ahead("contacts-typeahead-input", el, contacts_typeahead);

	// Fills owner select element
	populateUsers("owners-list", el, undefined, undefined, function(data)
	{

		$("#casesForm").find("#owners-list").html(data);
		$("#owners-list", $("#casesForm")).find('option[value=' + CURRENT_DOMAIN_USER.id + ']').attr("selected", "selected");
		
	});

	
}

// Updates or Saves a cases
function savecases(formId, modalId, saveBtn, json)
{
	// Returns, if the save button has disabled attribute
	if ($(saveBtn).attr('disabled'))
		return;

	// Disables save button to prevent multiple click event issues
	disable_save_button($(saveBtn));// $(saveBtn).attr('disabled', 'disabled');

	if (!isValidForm('#' + formId))
	{
		enable_save_button($(saveBtn));// $(saveBtn).removeAttr('disabled'); //
		// Removes disabled attribute of save
		// button
		return false;
	}

	// Shows loading symbol until model get saved
	// $('#' + modalId).find('span.save-status').html(getRandomLoadingImg());

	var newEntry = false; // test if this model is new, true => new model
	if (json.id === undefined)
		newEntry = true;

	json["custom_data"] = serialize_custom_fields(formId);

	var newcases = new Backbone.Model();
	newcases.url = 'core/api/cases';
	newcases.save(json, { success : function(data)
	{
		// Removes disabled attribute of save button
		enable_save_button($(saveBtn));// $(saveBtn).removeAttr('disabled');

		// $('#' + modalId).find('span.save-status img').remove();
		$('#' + modalId).modal('hide');

		$('#' + formId).each(function()
		{
			this.reset();
		});

		var cases = data.toJSON();

		add_recent_view(new BaseModel(cases));

		// Updates data to timeline
		/* If(Contact-Details) page - then adjust timeline */
		if (App_Contacts.contactDetailView && Current_Route == "contact/" + App_Contacts.contactDetailView.model.get('id'))
		{
			// Add model to collection. Disabled sort while adding and called
			// sort explicitly, as sort is not working when it is called by add
			// function
			if (casesView && casesView.collection)
			{
				if (casesView.collection.get(cases.id))
				{
					casesView.collection.get(cases.id).set(new BaseModel(cases));
				}
				else
				{
					casesView.collection.add(new BaseModel(cases), { sort : false });
					casesView.collection.sort();
				}
			}

			if (App_Contacts.contactDetailView.model.get('type') == 'COMPANY')
			{
				activate_timeline_tab(); // if this contact is of type
				// COMPANY, simply activate first
				// tab & fill details
				fill_company_related_contacts(App_Contacts.contactDetailView.model.id, 'company-contacts');
				return;
			}
			// / Now Only models which have type 'PERSON' will through below.

			// activate_timeline_tab(); // switch to first tab in Contact-Detail
			// View

			// Verifies whether the added case is related to the contact in
			// contact detail view or not

			/**
			 * Code to add Info of Case to timeline Not Fully Done, it was
			 * directly copied from Deals module.
			 * 
			 * If you wanna add Case to timeline, edit below
			 */
			$.each(cases.contacts, function(index, contact)
			{

				if (contact.id == App_Contacts.contactDetailView.model.get('id'))
				{

					// Activates "Timeline" tab and its tab content in
					// contact detail view
					// activate_timeline_tab();
					add_entity_to_timeline(data);
					/*
					 * If timeline is not defined yet, initiates with the data
					 * else inserts
					 */
					return false;
				}// end if
			}); // end each

			/*
			 * End of Adding data to timeline.
			 */
		}// end if
		/* end-if(Contact-Details) */
		/*
		 * If(Company-Details)
		 */
		else if (company_util.isCompany()) {
			company_util.updateCasesList(cases,true);
		}
		/*end-if(Company-Details) */
		else if (Current_Route == 'cases')
		{
			// On cases page.. adjust current model
			if (newEntry == true)
				App_Cases.casesCollectionView.collection.add(data);
			else
			{
				App_Cases.casesCollectionView.collection.remove(json);
				App_Cases.casesCollectionView.collection.add(data);
			}
			App_Cases.casesCollectionView.render(true);
		}
		else
			App_Calendar.navigate("cases", { trigger : true });
	}, error : function(data, response)
	{
		enable_save_button($(saveBtn));
	} });
}(function(company_util, $, undefined) {
	
	
	company_util.isCompany = function(){
		
		if(App_Companies.companyDetailView && Current_Route == "company/" + App_Companies.companyDetailView.model.get('id'))
			return true;
		if(App_Companies.companies && Current_Route == "companies")
			return true;
		if(Current_Route && Current_Route.indexOf('company')>-1)
			return true;
		
		return false;
	};
	
	company_util.updateDocumentsList = function(document, isCompany){

		// Add model to collection. Disabled sort while adding and called
		// sort explicitly, as sort is not working when it is called by add
		// function
		
		$.each(document.contacts, function(index, contact) {
			
			if (contact.id == App_Companies.companyDetailView.model.get('id'))
			{
				if (documentsView && documentsView.collection)
				{
					if(documentsView.collection.get(document.id))
					{
						documentsView.collection.get(document.id).set(new BaseModel(document));
					}
					else
					{
						documentsView.collection.add(new BaseModel(document), { sort : false });
						documentsView.collection.sort();
					}
				}
				
				return false;
			}
		});
	};
	
	company_util.updateCasesList = function(cases,isCompany){

		// Add model to collection. Disabled sort while adding and called
		// sort explicitly, as sort is not working when it is called by add
		// function
		if (casesView && casesView.collection)
		{
			if(casesView.collection.get(cases.id))
			{
				casesView.collection.get(cases.id).set(new BaseModel(cases));
			}
			else
			{
				casesView.collection.add(new BaseModel(cases), { sort : false });
				casesView.collection.sort();
			}
		}
		
		/*if(App_Companies.companyDetailView.model.get('type')=='COMPANY')
		{
			activate_timeline_tab();  // if this contact is of type COMPANY, simply activate first tab & fill details
			fill_company_related_contacts(App_Companies.companyDetailView.model.id,'company-contacts'); 
			return;
		}*/
	};
	
	company_util.updateDealsList = function(deal,isCompany){
		// Add model to collection. Disabled sort while adding and called
		// sort explicitly, as sort is not working when it is called by add
		// function
		var current = App_Companies.companyDetailView.model.toJSON();

		/*
		 * Verifies whether the added deal is related to the contact in
		 * contact detail view or not
		 */
		$.each(deal.contacts, function(index, contact) {
			
			if (contact.id == current.id) {
				
				

				if (dealsView && dealsView.collection)
				{
					if(deal.archived == true)
					{
						dealsView.collection.remove(deal.id);
						dealsView.collection.sort();
					}
					else if(dealsView.collection.get(deal.id))
					{
						dealsView.collection.get(deal.id).set(new BaseModel(deal));
					}
					else
					{
						dealsView.collection.add(new BaseModel(deal), { sort : false });
						dealsView.collection.sort();
					}
				}
				
				return false;
			}
		});
	};
	
	company_util.displayGoogleMap = function(contact){
		
		if(contact == undefined)
			contact = App_Companies.companyDetailView.model.toJSON();

			var address = JSON.parse(getPropertyValue(contact.properties, "address"));
	
			// Gets the location (latitude and longitude) from the address
			var geocoder = new google.maps.Geocoder();
	
			// Latitude and longitude were not saved to the contact (chances to update the address)
			
			if(!address.address)address.address="";
			if(!address.city)address.city="";
			if(!address.state)address.state="";
			if(!address.country)address.country="";
			if(!address.zip)address.zip="";
			
			geocoder.geocode({
				'address' : '"'+ address.city + ', '
				+ address.state + ', ' + getNormalCountryNameFromShortName(address.country) + ', ' + address.zip + '"'
			}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					console.log(results);
					displayTimeZone(results);
	
					// Displays map portion
					$("#map").css('display', 'block');
					
					var myOptions = {
						zoom : 4,
						center : results[0].geometry.location,
						mapTypeId : google.maps.MapTypeId.ROADMAP
					}
	
					var map = new google.maps.Map(document.getElementById("map"),
							myOptions);
					
					var marker = new google.maps.Marker({
						map : map,
						position : results[0].geometry.location
					});
				}
			});
	};

	/**
	 * Searches the property fields in current contact with given property name, if
	 * property with given property name exists, then returns its value in a array
	 * 
	 * <p>
	 * This method is used when contact property has multiple values like email,
	 * phone, website etc
	 * </p>
	 * 
	 * @param propertyName
	 *            name of the property
	 * @returns {Array}
	 */
	company_util.agile_crm_get_company_properties_list = function(propertyName)
	{
		// Reads current contact model form the contactDetailView
		var company_model = App_Companies.companyDetailView.model;
	
		// Gets properties list field from contact
		var properties = company_model.get('properties');
		var property_list = [];
	
		/*
		 * Iterates through each property in contact properties and checks for the
		 * match in it for the given property name and retrieves value of the
		 * property if it matches
		 */
		$.each(properties, function(index, property)
		{
			if (property.name == propertyName)
			{
				property_list.push(property);
			}
		});
	
		// If property is defined then return property value list
		return property_list;
	
	};

	company_util.show_map = function(el){
	
		var company = App_Companies.companyDetailView.model.toJSON();
		var address = getPropertyValue(company.properties, "address");
	
		// Return, if no address is found 
		if (!address) 
			return;
		
		try
		{
			address = JSON.parse(address);
		}
		catch (err)
		{
			return;
		}
		
		
	
		// If all the address fields are empty, just return.
		if (!address.address && !address.city && !address.state
				&& !address.country)
			return;
		
		//reads the value from cookie or local store if the value is no it will return from here
		
		var map_view=localStorage.getItem('MAP_VIEW');
		if(map_view=="disabled"){
			$("#map_view_action",el).html("<i class='icon-plus text-sm c-p' title='Show map' id='enable_map_view'></i>");
			return;
		}
			
	
		// If google map is already loaded display the map else load the
		// "google maps api"
		try {
			if (google.maps) {
				displayGoogleMap(company);
			}
		} catch (err) {
	
			var script = document.createElement("script");
			script.type = "text/javascript";
			script.src = "https://maps.googleapis.com/maps/api/js?&sensor=false&callback=company_util.displayGoogleMap";
			document.body.appendChild(script);
		}
	
	};
	
	company_util.starify = function(el){
	    head.js(LIB_PATH + 'lib/jquery.raty.min.js', function(){
	    	
	    	var company_model  =  App_Companies.companyDetailView.model;
	    	
	    	// If contact update is not allowed then start rating does not allow user to change it
	    	if(App_Companies.companyDetailView.model.get('owner') && !canEditContact(App_Companies.companyDetailView.model.get('owner').id))
	    	{
	    			$('#star', el).raty({
	    			 'readOnly': true,
	    			  score: App_Companies.companyDetailView.model.get('star_value')
	    			 });
	    		 return;
	    	}
	    	
	    	
	    	// Set URL - is this required?
	    	// contact_model.url = 'core/api/contacts';
	    	
	    	$('#star', el).raty({
	    		
	    		/**
	    		 * When a star is clicked, the position of the star is set as star_value of
	    		 * the contact and saved.    
	    		 */
	        	click: function(score, evt) {
	        	   
	        		/*// (commented- reloading as silent:true is not effecting) 
	        		  // alert('ID: ' + $(this).attr('id') + '\nscore: ' + score + '\nevent: ' + evt);
	        		contact_model.set('star_value', score, {silent: true});
	        	
	        		// Save model
	           		contact_model.save();*/
	           		
	        		App_Companies.companyDetailView.model.set({'star_value': score}, {silent : true});
	        		company_model =  App_Companies.companyDetailView.model.toJSON();
	        		var new_model = new Backbone.Model();
	        		new_model.url = 'core/api/contacts';
	        		new_model.save(company_model, {
	        			success: function(model){
	        			}
	        		});
	
	        	},
	        	
	        	/**
	        	 * Highlights the stars based on star_value of the contact
	        	 */
	        	score: company_model.get('star_value')
	            
	        });
	    });
	    
	};

}(window.company_util = window.company_util || {}, $));

/*****Companies List view******/

(function(company_list_view, $, undefined) {
	
	/**
	 * Gets the list of custom fields saved by the user, and shown in the Html
	 * element with "view-list" in the Html element sent to this method. It fetches
	 * the list of custom fields and on rendering the collection unordered list of
	 * created and appended in view-list element in contacts page. If custom view
	 * selected from the list, this function is called with button name from the
	 * customView function, which is set on the list button.
	 * 
	 * @param cel
	 *            html element
	 * @param button_name
	 *            name of the button (name of the view)
	 */
	function setupCompanyViews(cel, button_name) {

		// Creates a view for custom views
		getTemplate("company-view-collection", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
				
			var el = $(template_ui);
			$("#view-list", cel).html(el);
			updateSelectedSortKey($("#view-list", cel));

		}, $("#view-list", cel));
			
	}
	
	var updateSelectedSortKey = function(el) {
		var sort_key = readCookie("company_sort_field");
		if(sort_key && sort_key != null) {
			var idSuffix = '-asc';
			if(sort_key.indexOf('-') == 0) {
				sort_key = sort_key.substring(1);
				idSuffix = '-desc'
			}
			var elementId = 'comp-sort-by-'+sort_key+idSuffix;
			$(el).find('#'+elementId).addClass('bold-text');
		}
	};
	
	/**
	 * Sets up contact filters list in contacts list page, also whether cookie is
	 * save with filter name to load filter results instead of all contacts
	 * 
	 * @method setupContactFilterList
	 * @param cel
	 *            Html form element to append filters list,
	 */
	var companyFiltersListView
	var setupCompanyFilterList = function(cel, tag_id)
	{
		if (tag_id)
			$('.filter-criteria', cel)
					.html(
							'<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li  class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="m-l-xs pull-left">' + decodeURI(tag_id) + '</span><a class="close default_contact_remove_tag m-l-xs pull-left">&times</a></li></ul>').attr("_filter", tag_id);
							

		var filter_id = null;
			companyFiltersListView = new Base_Collection_View(
				{
					url : '/core/api/filters?type=COMPANY',
					sort_collection : false,
					restKey : "ContactFilter",
					templateKey : "company-filter-list",
					individual_tag_name : 'li',
					sort_collection : false,
					postRenderCallback : function(el)
					{
						var filter_name;
						// Set saved filter name on dropdown button
						if (filter_name = readCookie('company_filter'))
						{
							// If is not system type get the name of the filter from
							// id(from cookie)
								filter_id = filter_name;
								if(companyFiltersListView.collection.get(filter_name))
										filter_name = companyFiltersListView.collection.get(filter_name).toJSON().name;
								

							el.find('.filter-dropdown').append(filter_name);
						}

						if (!filter_name)
							return;

						$('.filter-criteria', cel)
						.html(
								'<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="inline-block m-r-xs v-middle">' + filter_name + '</span><a class="close default_company_filter">&times</a></li></ul>');
						
						if(filter_id)
							$('.filter-criteria', cel).attr("_filter", filter_id);
						else
							$('.filter-criteria', cel).attr("_filter", filter_name);
							
					} });

				// Fetchs filters
				companyFiltersListView.collection.fetch();
			
				var filter_dropdown_element = companyFiltersListView.render().el;
			
				// Shows in contacts list
				$('#filter-list', cel).html(companyFiltersListView.render().el);
				
	}
	
	var revertToDefaultCompanies = function(){
		// Erase filter cookie. Erases both contact and company filter
		//eraseCookie('contact_filter');
		//eraseCookie('contact_filter_type');
		eraseCookie('company_filter');
		eraseData('dynamic_filter');
	
		if (App_Companies.companiesListView)
			App_Companies.companiesListView = undefined;
		//if (App_Contacts.contact_custom_view)
			//App_Contacts.contact_custom_view = undefined;
	
		// Loads contacts
		App_Companies.companies();
	};
	
	
	company_list_view.init = function(cel){
		setupCompanyFilterList(cel);
		setupCompanyViews(cel);
	};

}(window.company_list_view = window.company_list_view || {}, $));

/*****Company Details view******/

(function(company_detail_tab, $, undefined) {
	
	company_detail_tab.activateCurrentTab = function(ele){
		$('#contact-tab-content .tab-pane').removeClass('active');
		ele.addClass('active');
	};
	
	/**
	 * Changes, owner of the contact, when an option of change owner drop down
	 * is selected.   
	 */
	company_detail_tab.changeOwner = function(that){
		
		// Reads the owner id from the selected option
		var new_owner_id = that.attr('data');
		var new_owner_name = that.text();
		var current_owner_id = $('#contact-owner').attr('data');
		
		// Returns, if same owner is selected again 
		if(new_owner_id == current_owner_id)
			{
			  // Showing updated owner
			  show_owner();
			  return;
			}
		
		  var contactModel = new BaseModel();
		    contactModel.url = '/core/api/contacts/change-owner/' + new_owner_id + "/" + App_Companies.companyDetailView.model.get('id');
		    contactModel.save(App_Companies.companyDetailView.model.toJSON(), {success: function(model){

		    	// Replaces old owner details with changed one
				$('#contact-owner').text(new_owner_name);
				$('#contact-owner').attr('data', new_owner_id);
				
				// Showing updated owner
				show_owner(); 
				App_Companies.companyDetailView.model = model;
				
		    }});
   	};
	
	// Deletes a contact from database
	company_detail_tab.deleteCurrentCompany = function(){
		
		if(!confirm("Do you want to delete the company?"))
    		return;
		
		App_Companies.companyDetailView.model.url = "core/api/contacts/" + App_Companies.companyDetailView.model.id;
		App_Companies.companyDetailView.model.destroy({success: function(model, response) {
			  Backbone.history.navigate("companies",{trigger: true});
		}});
	};
	
	
	company_detail_tab.addTagsToCompany = function(){
		 // Add Tags
		var new_tags = get_new_tags('companyAddTags');
		if(new_tags)new_tags=new_tags.trim();
		
		if(!new_tags || new_tags.length<=0 || (/^\s*$/).test(new_tags))
		{
			console.log(new_tags);
			return;
		}
		if (!isValidTag(new_tags, true)) {
			return;
		}
		$('#add-tags').css("display", "block");
		$("#addTagsForm").css("display", "none");
		console.log(new_tags);
		
		if(new_tags) {
			var json = App_Companies.companyDetailView.model.toJSON();
	    		
	    	
	    	// Reset form
	    	$('#addTagsForm input').each (function(){
   		  	  	$(this).val("");
   		  	});
	    	
	    	// Checks if tag already exists in contact
			if($.inArray(new_tags, json.tags) >= 0)
				return;
			//Check tag acl before adding tag.
			acl_util.canAddTag(new_tags.toString(),function(respnse){
		    	json.tagsWithTime.push({"tag" : new_tags.toString()});
	   			
		    	// Save the contact with added tags
		    	var contact = new Backbone.Model();
		        contact.url = 'core/api/contacts';
		        contact.save(json,{
		       		success: function(data){
		       			
		       			addTagToTimelineDynamically(new_tags, data.get("tagsWithTime"));
		       			
		       			// Get all existing tags of the contact to compare with the added tags
		       			var old_tags = [];
		       			$.each($('#added-tags-ul').children(), function(index, element){
		       				old_tags.push($(element).attr('data'));
	       				});
		       			
		       			// Updates to both model and collection
		       			App_Companies.companyDetailView.model.set(data.toJSON(), {silent : true});
		       			
		       			// Append to the list, when no match is found 
		       			if ($.inArray(new_tags, old_tags) == -1) 
		       				$('#added-tags-ul').append('<li  class="tag inline-block btn btn-xs btn-default m-r-xs" style="color:#363f44" data="' + new_tags + '"><span><a class="anchor m-r-xs custom-color" style="color:#363f44" href="#tags/'+ new_tags + '" >'+ new_tags + '</a><a class="close remove-company-tags" id="' + new_tags + '" tag="'+new_tags+'">&times</a></span></li>');
		       			
		       			console.log(new_tags);
		       			// Adds the added tags (if new) to tags collection
		       			tagsCollection.add(new BaseModel({"tag" : new_tags}));
		       		}
		        });
			});
		}
	};
	
	company_detail_tab.load_company_deals = function ()
	{
		id = App_Companies.companyDetailView.model.id;
		dealsView = new Base_Collection_View({
			url: 'core/api/contacts/'+ id + "/deals" ,
            restKey: "opportunity",
            templateKey: "deals",
            individual_tag_name: 'li',
            sortKey:"created_time",
            descending: true,
            postRenderCallback: function(el) {
            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
            		 $(".deal-created-time", el).timeago();
            	})
            }
        });
        dealsView.collection.fetch();
        $('#deals', App_Companies.companyDetailView.el).html(dealsView.el);
        company_detail_tab.activateCurrentTab($('#deals'));
        
	};
	company_detail_tab.load_company_cases = function()
	{
		id = App_Companies.companyDetailView.model.id;
		casesView = new Base_Collection_View({
			url: 'core/api/contacts/'+ id + "/cases" ,
            restKey: "cases",
            templateKey: "cases-contact",
            individual_tag_name: 'li',
            sortKey:"created_time",
            descending: true,
            postRenderCallback: function(el) {
            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
            		 $(".deal-created-time", el).timeago();
            	})
            }
        });
		casesView.collection.fetch();
        $('#cases', App_Companies.companyDetailView.el).html(casesView.el);
        company_detail_tab.activateCurrentTab($('#cases'));
	};
	
	company_detail_tab.load_company_notes = function()
	{
	    var id = App_Companies.companyDetailView.model.id;
	    notesView = new Base_Collection_View({
            url: '/core/api/contacts/' + id + "/notes",
            restKey: "note",
            templateKey: "notes",
            individual_tag_name: 'li',
            sortKey:"created_time",
            descending: true,
            postRenderCallback: function(el) {
            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
            		 $(".note-created-time", el).timeago();
              	})
            }
        });
        notesView.collection.fetch();
        $('#notes', App_Companies.companyDetailView.el).html(notesView.el);
        company_detail_tab.activateCurrentTab($('#notes'));
	};
	
	company_detail_tab.load_company_documents = function()
	{
		 id = App_Companies.companyDetailView.model.id;
		 documentsView = new Base_Collection_View({
	            url: '/core/api/documents/contact/' + id + "/docs",
	            restKey: "document",
	            templateKey: "contact-documents",
	            individual_tag_name: 'li',
	            sortKey:"uploaded_time",
	            descending: true,
	            postRenderCallback: function(el) {
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
	            		 $(".document-created-time", el).timeago();
	              	});
	            
	            }
	        });
		    documentsView.collection.fetch();
	        $('#documents', App_Companies.companyDetailView.el).html(documentsView.el);
	        company_detail_tab.activateCurrentTab($('#documents'));
	};
	

}(window.company_detail_tab = window.company_detail_tab || {}, $));




var existingDocumentsView;

// Documents actions
var contact_details_documentandtasks_actions = {

	    // Edit task
        edit_task : function(e){
        	var targetEl = $(e.currentTarget);

        	var id = $(targetEl).attr('data');
			var value = tasksView.collection.get(id).toJSON();

			deserializeForm(value, $("#updateTaskForm"));

			$("#updateTaskModal").modal('show');

			$('.update-task-timepicker').val(fillTimePicker(value.due));
			categories.getCategoriesHtml(value,function(catsHtml){
				$('#type',$("#updateTaskForm")).html(catsHtml);
				// Fills owner select element
				populateUsers("owners-list", $("#updateTaskForm"), value, 'taskOwner', function(data)
				{
					$("#updateTaskForm").find("#owners-list").html(data);
					if (value.taskOwner)
						$("#owners-list", $("#updateTaskForm")).find('option[value=' + value['taskOwner'].id + ']').attr("selected", "selected");
		
					$("#owners-list", $("#updateTaskForm")).closest('div').find('.loading-img').hide();
				});
			});

			// Add notes in task modal
			showNoteOnForm("updateTaskForm", value.notes);

			activateSliderAndTimerToTaskModal();
        },

        // Event edit in contact details tab
        edit_event : function(e){
        	var targetEl = $(e.currentTarget);

        	$("#updateActivityModal").html(getTemplate("update-activity-modal"));
        	
        	var id = $(targetEl).attr('data');
			var value = eventsView.collection.get(id).toJSON();
			deserializeForm(value, $("#updateActivityForm"));
			$("#updateActivityModal").modal('show');

			$('.update-start-timepicker').val(fillTimePicker(value.start));
			$('.update-end-timepicker').val(fillTimePicker(value.end));

			if (value.type == "WEB_APPOINTMENT" && parseInt(value.start) > parseInt(new Date().getTime() / 1000))
			{
				$("[id='event_delete']").attr("id", "delete_web_event");
				web_event_title = value.title;
				if (value.contacts.length > 0)
				{
					var firstname = getPropertyValue(value.contacts[0].properties, "first_name");
					if (firstname == undefined)
						firstname = "";
					var lastname = getPropertyValue(value.contacts[0].properties, "last_name");
					if (lastname == undefined)
						lastname = "";
					web_event_contact_name = firstname + " " + lastname;
				}
			}
			else
			{
				$("[id='delete_web_event']").attr("id", "event_delete");
			}
			if (value.description)
			{
				var description = '<label class="control-label"><b>Description </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="Add Description"></textarea></div>'
				$("#event_desc").html(description);
				$("textarea#description").val(value.description);
			}
			else
			{
				var desc = '<div class="row-fluid">' + '<div class="control-group form-group m-b-none">' + '<a href="#" id="add_event_desctiption"><i class="icon-plus"></i> Add Description </a>' + '<div class="controls event_discription hide">' + '<textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="Add Description"></textarea>' + '</div></div></div>'
				$("#event_desc").html(desc);
			}
			// Fills owner select element
			populateUsersInUpdateActivityModal(value);
        },

        complete_task : function(e){
        	var targetEl = $(e.currentTarget);

        	if ($(targetEl).is(':checked'))
			{
				var id = $(targetEl).attr('data');
				var that = targetEl;
				complete_task(id, tasksView.collection, undefined, function(data)
				{
					$(that).parent().siblings(".task-subject").css("text-decoration", "line-through");
					console.log($(that).parents('.activity-text-block').css("background-color", "#FFFAFA"));
					$(that).parent().replaceWith('<span style="margin-right:9px;"><i class="fa fa-check"></i></span>');
					tasksView.collection.add(data, { silent : true });
				});
			}
        },

        // For adding new deal from contact-details
        add_deal : function(e){
        		var targetEl = $(e.currentTarget);

        		var el = $("#opportunityForm");
				$("#opportunityModal").modal('show');

				add_custom_fields_to_form({}, function(data)
				{
					var el_custom_fields = show_custom_fields_helper(data["custom_fields"], [
						"modal"
					]);
					$("#custom-field-deals", $("#opportunityModal")).html($(el_custom_fields));

				}, "DEAL");

				// Fills owner select element
				populateUsers("owners-list", el, undefined, undefined, function(data)
				{

					$("#opportunityForm").find("#owners-list").html(data);
					$("#owners-list", $("#opportunityForm")).find('option[value=' + CURRENT_DOMAIN_USER.id + ']').attr("selected", "selected");
					$("#owners-list", $("#opportunityForm")).closest('div').find('.loading-img').hide();
				});
				// Contacts type-ahead
				agile_type_ahead("relates_to", el, contacts_typeahead);

				// Fills the pipelines list in select box.
				populateTrackMilestones(el, undefined, undefined, function(pipelinesList)
				{
					console.log(pipelinesList);
					$.each(pipelinesList, function(index, pipe)
					{
						if (pipe.isDefault)
						{
							var val = pipe.id + '_';
							if (pipe.milestones.length > 0)
							{
								val += pipe.milestones.split(',')[0];
								$('#pipeline_milestone', el).val(val);
								$('#pipeline', el).val(pipe.id);
								$('#milestone', el).val(pipe.milestones.split(',')[0]);
							}

						}
					});
				});

				populateLostReasons(el, undefined);

				populateDealSources(el, undefined);

				// Enable the datepicker

				$('#close_date', el).datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY});


				var json = null;
				if(company_util.isCompany()){
					json = App_Companies.companyDetailView.model.toJSON();
				} else {
					json = App_Contacts.contactDetailView.model.toJSON();
				}
				var contact_name = getContactName(json);
				$('.tags', el).append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="' + json.id + '">' + contact_name + '</li>');

        },

       add_case : function(e){
       		var targetEl = $(e.currentTarget);

       		$("#casesModal").html(getTemplate("cases-new-modal", {}));
			var el = $("#casesForm");

			// Fills owner select element
			populateUsers("owners-list", el, undefined, undefined, function(data)
			{

				$("#casesForm").find("#owners-list").html(data);
				$("#owners-list", $("#casesForm")).find('option[value=' + CURRENT_DOMAIN_USER.id + ']').attr("selected", "selected");
				// Contacts type-ahead
				agile_type_ahead("contacts-typeahead-input", el, contacts_typeahead);

				var json = null;
				if(company_util.isCompany()){
					json = App_Companies.companyDetailView.model.toJSON();
				} else {
					json = App_Contacts.contactDetailView.model.toJSON();
				}
				var contact_name = getContactName(json);
				$('.tags', el).append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="' + json.id + '">' + contact_name + '</li>');

				$("#casesModal").modal('show');
			});
       },

       add_contact : function(e){
       		// This is a hacky method. ( See jscore/contact-management/modals.js for
			// its use )
			// 'forceCompany' is a global variable. It is used to enforce Company
			// name on Add Contact modal.
			// Prevents user from removing this company from the modal that is
			// shown.
			// Disables typeahead, as it won't be needed as there will be no Company
			// input text box.
			var json = {};

			if(Current_Route.indexOf("company") > -1)
				 json = App_Companies.companyDetailView.model.toJSON();
			else 
				 json = App_Contacts.contactDetailView.model.toJSON();

			forceCompany.name = getContactName(json); // name of Company
			forceCompany.id = json.id; // id of Company
			forceCompany.doit = true; // yes force it. If this is false the
			// Company won't be forced.
			// Also after showing modal, it is set to false internally, so
			// Company is not forced otherwise.
			//$('#personModal').modal('show');
			$.ajax({
				url : 'core/api/custom-fields/scope?scope=CONTACT',
				type : 'GET',
				dataType : 'json',
				success : function(data){
					if(data.length > 0)
					{
						Backbone.history.navigate("contact-add" , {trigger: true});
						setTimeout(function(){ 
						$("#continueform").find("ul[name=contact_company_id]").html('<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="'+forceCompany.id+'"><span><a class="text-white m-r-xs" href="#contact/'+forceCompany.id+'">'+forceCompany.name+'</a><a class="close text-white" id="remove_tag">×</a></span></li>')
						}, 800);
					}
					else
						$("#personModal").modal("show");
				}
			});
       },

       add_document : function(e){

       		$('#uploadDocumentModal').html(getTemplate("upload-document-modal", {})).modal('show');
		
			var el = $("#uploadDocumentForm");
			// Contacts type-ahead
			agile_type_ahead("document_relates_to_contacts", el, contacts_typeahead);

			// Deals type-ahead
			agile_type_ahead("document_relates_to_deals", el, deals_typeahead, false, null, null, "core/api/search/deals", false, true);

			var json = null;
			if(company_util.isCompany()){
				json = App_Companies.companyDetailView.model.toJSON();
			} else {
				json = App_Contacts.contactDetailView.model.toJSON();
			}
			var contact_name = getContactName(json);
			$('.tags', el).append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="' + json.id + '">' + contact_name + '</li>');
       },

       document_unlink : function(e){
       		var targetEl = $(e.currentTarget);

       		var id = $(targetEl).attr('data');
			var json = documentsView.collection.get(id).toJSON();

			// To get the contact id and converting into string
			var contact_id = "";
			
			if(company_util.isCompany())
				contact_id = App_Companies.companyDetailView.model.id + "";
			else
				contact_id = App_Contacts.contactDetailView.model.id + "";

			// Removes the contact id from related to contacts
			json.contact_ids.splice(json.contact_ids.indexOf(contact_id), 1);

			// Updates the document object and hides
			var newDocument = new Backbone.Model();
			newDocument.url = 'core/api/documents';
			newDocument.save(json, { success : function(data)
			{
				documentsView.collection.remove(json);
				documentsView.render(true);
			} });
       },

       show_document_list : function(e){
       		var targetEl = $(e.currentTarget);

       		var el = $(targetEl).closest("div");
			$(targetEl).css("display", "none");
			el.find(".contact-document-select").css("display", "inline");
			var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
			fillSelect('document-select', 'core/api/documents', 'documents', function fillNew()
			{
				el.find("#document-select").append("<option value='new'>Add New Doc</option>");

			}, optionsTemplate, false, el);
	    },

       add_selected_document : function(e){
       		var targetEl = $(e.currentTarget);

       		var document_id = $(targetEl).closest(".contact-document-select").find("#document-select").val();

			var saveBtn = $(targetEl);

			// To check whether the document is selected or not
			if (document_id == "")
			{
				saveBtn.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>This field is required.</span>");
				saveBtn.closest("span").find('span.save-status').find("span").fadeOut(5000);
				return;
			}
			else if (document_id == "new")
			{
				$('#uploadDocumentModal').html(getTemplate("upload-document-modal", {})).modal('show');
				var el = $("#uploadDocumentForm");
				
				// Contacts type-ahead
				agile_type_ahead("document_relates_to_contacts", el, contacts_typeahead);

				// Deals type-ahead
				agile_type_ahead("document_relates_to_deals", el, deals_typeahead, false, null, null, "core/api/search/deals", false, true);

				var json = null;
				if(company_util.isCompany()){
					json = App_Companies.companyDetailView.model.toJSON();
				} else {
					json = App_Contacts.contactDetailView.model.toJSON();
				}
				var contact_name = getContactName(json);
				$('.tags', el).append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="' + json.id + '">' + contact_name + '</li>');
			}
			else if (document_id != undefined && document_id != null)
			{
				if (!existingDocumentsView)
				{
					existingDocumentsView = new Base_Collection_View({ url : 'core/api/documents', restKey : "documents", });
					existingDocumentsView.collection.fetch({ success : function(data)
					{
						existing_document_attach(document_id, saveBtn);
					} });
				}
				else
					existing_document_attach(document_id, saveBtn);
			}

       },

};

/**
 * To attach the document to a contact
 * 
 * @param document_id
 * @param saveBtn
 */
function existing_document_attach(document_id, saveBtn)
{
	var json = existingDocumentsView.collection.get(document_id).toJSON();

	// To get the contact id and converting into string
	var contact_id = null;
	
	if(company_util.isCompany()){
		contact_id = App_Companies.companyDetailView.model.id + "";
	} else {
		contact_id = App_Contacts.contactDetailView.model.id + "";
	}

	// Checks whether the selected document is already attached to that contact
	if ((json.contact_ids).indexOf(contact_id) < 0)
	{
		json.contact_ids.push(contact_id);
		saveDocument(null, null, saveBtn, false, json);
	}
	else
	{
		saveBtn.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>Linked Already</span>");
		saveBtn.closest("span").find('span.save-status').find("span").fadeOut(5000);
		hideTransitionBar();
		return;
	}
}
/**
 * contact-details-actions.js defines some of the functionalities (add note, task and 
 * campaign to a contact) of actions drop down menu of a contact in its detail view.
 * The remaining functionalities are defined through controller.
 * 
 * @module Contact management
 * @author Rammohan
 */
 var contact_detail_tab_actions = {
    /**
     * Displays activity modal with all task features,  to add a task 
     * related to the contact in contact detail view. Also prepends the 
     * contact name to related to field of activity modal.
     */ 
      add_task : function(e){

            
            $('#activityTaskModal').html(getTemplate("new-task-modal")).modal('show');

            var el = $("#taskForm");
            highlight_task();
            // Displays contact name, to indicate the task is related to the contact
            fill_relation(el);
            agile_type_ahead("task_related_to", el, contacts_typeahead);
            
            agile_type_ahead("task_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);

            categories.getCategoriesHtml(undefined,function(catsHtml){
                $('#type',el).html(catsHtml);
                // Fills owner select element
                populateUsers("owners-list", $("#taskForm"), undefined, undefined,
                        function(data) {
                            $("#taskForm").find("#owners-list").html(data);
                            $("#owners-list", el).find('option[value='+ CURRENT_DOMAIN_USER.id +']').attr("selected", "selected");
                            $("#owners-list", $("#taskForm")).closest('div').find('.loading-img').hide();                   
                });
            });

           activateSliderAndTimerToTaskModal();
      },

      /**
     * Displays activity modal with all event features,  to add a event 
     * related to the contact in contact detail view. Also prepends the 
     * contact name to related to field of activity modal.
     */ 
      add_event : function(e){

            
            $('#activityModal').html(getTemplate("new-event-modal")).modal('show');

            var el = $("#activityForm");
            highlight_event();

            // Displays contact name, to indicate the task is related to the contact
            fill_relation(el);
            agile_type_ahead("event_related_to", el, contacts_typeahead);
            agile_type_ahead("task_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);
      },

      /**
     * Displays note modal, to add a note related to the contact in contact 
     * detail view. Also prepends the contact name to related to field of 
     * activity modal.  
     */ 
      add_note : function(e){
            console.log("execution");
            var targetEl = $(e.currentTarget);
            
            var el = $("#noteForm");
            
            // Displays contact name, to indicate the note is related to the contact
            fill_relation(el);

            if(!$(targetEl).attr("data-toggle"))
                 $('#noteModal').modal('show');
             
            agile_type_ahead("note_related_to", el, contacts_typeahead);
      },


    /**
     * Subscribes contact to a campaign. First loads a form with campaigns select 
     * option and then fills the select drop down with all the campaigns by triggering
     * a custom event (fill_campaigns_contact).
     */
      add_to_campaign : function(e){
            var targetEl = $(e.currentTarget);

            var contact_id = App_Contacts.contactDetailView.model.id;
            
            // Navigate to Add Campaigns page
            if($(targetEl).hasClass('contact-add-campaign'))
            {
            
                /*
                 * Custom event to fill campaigns. This is triggered from the controller
                 * on loading of the form. 
                 * This event is died to avoid execution of its functionality multiple
                 * times, if it is clicked multiple times (when it is clicked first time 
                 * it executes once, if again it is clicked it executes twice and so on).  
                 */
            
                $('body').off('fill_campaigns_contact').on('fill_campaigns_contact', function(event){
                    var optionsTemplate = "<option value='{{id}}'{{#if is_disabled}}disabled=disabled>{{name}} (disabled){{else}}>{{name}}{{/if}}</option>";
                    fillSelect('campaign-select','/core/api/workflows', 'workflow', 'no-callback ', optionsTemplate); 
          
                });
                
                // Navigate to controller to show the form and then to trigger the custom event
                Backbone.history.navigate("add-campaign", {
                    trigger: true
                });
                
            }
            
            // If link clicked is within Campaigns tab, hide link and show form.
            if($(targetEl).hasClass('add-to-campaign'))
            {
                $(targetEl).css('display','none');
                
                $('.show_campaigns_list').css('display','inline-block');
                
                var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
                
                fillSelect('campaign-select','/core/api/workflows', 'workflow', 'no-callback ', optionsTemplate); 
            }

            /*
             * Subscribes the contact to selected campaign from the drop down, when
             * the Add button is clicked
             */
            $('#subscribe-contact-campaign, #add-to-campaign').click(function(e){
                e.preventDefault();

                var $form;
                
                // Add Campaigns form in another page.
                if($(this).attr('id') === 'subscribe-contact-campaign')
                    $form = $('#contactCampaignForm');
                
                // For within Campaigns tab, campaigns list form
                if($(this).attr('id') === 'add-to-campaign')
                    $form = $('#add-to-campaign-form');
                
                // Verify form validation
                if(!isValidForm($form))
                    return;

                // Button disabled || Validate Form fails
                if($(this).attr('disabled') == 'disabled')
                    return;
                
                var saveButton=$(this);
                disable_save_button(saveButton);
                
                // Temporary variable to hide Campaigns list form within
                // Campaigns tab.
                var $add_to_campaign = $(this).attr('id');
                
                // Show loading symbol until model get saved
                //$('#contactCampaignForm').find('span.save-status').html(getRandomLoadingImg());
                
                var workflow_id = $('#campaign-select option:selected').prop('value');
                var workflow_name = $('#campaign-select option:selected').text();
                
                // If Active, don't add to campaign
                if(is_subscriber_active(workflow_id))
                {
                    var properties = App_Contacts.contactDetailView.model.get('properties');
                    
                    var name = "Contact";
                    
                    if(properties)
                        name = getPropertyValue(properties, "first_name");
                    
                    var message = name + " is already active in Campaign '" + workflow_name+"'.";
                    
                    showNotyPopUp("information", message, "top", 10000);
                    
                    enable_save_button(saveButton);
                    
                    return;
                }
                            
                var url = '/core/api/campaigns/enroll/' + agile_crm_get_contact()['id'] + '/' + workflow_id;
                
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function(){
                
                        // Remove loading image
                        //$('#contactCampaignForm').find('span.save-status img').remove();
                        enable_save_button(saveButton);
                        
                        // Hides form and shows link within Campaigns tab.
                        if($add_to_campaign === 'add-to-campaign')
                        {
                            // Temp Flag inorder to show Active campaigns immediately.
                            // if true, downloads contact rather than fetching from collection
                            CONTACT_ASSIGNED_TO_CAMPAIGN = true;
                            
                            $('.show_campaigns_list').css('display','none');
                            
                            $('.add-to-campaign').css('display','inline-block');
                            
                            // Triggers Campaigns tab click, to update contact model
                            $('#contactDetailsTab a[href="#campaigns"]').trigger('click');
                            
                            return;
                            
                        }
                        
                        // Navigate back to contact detail view
                        Backbone.history.navigate("contact/" + agile_crm_get_contact()['id'], {
                            trigger: true
                        });
                    }
               });
            }); // End of Add button of form Event Handler

            // Click event of campaigns form close button
            $('#contact-close-campaign, #cancel-to-add-campaign').click(function(e){
                e.preventDefault();
                
                // Campaigns tab form
                if($(this).attr('id') === 'cancel-to-add-campaign')
                {
                    var $form = $('#add-to-campaign-form');
                    
                    // Reset form if any errors
                    var validator = $('form#add-to-campaign-form').validate();
                    validator.resetForm();
                    $form.find('div.controls').removeClass('single-error');
                    
                    // Hides form and show link
                    $('.show_campaigns_list').css('display','none');
                    $('.add-to-campaign').css('display','inline-block');
                    
                    return;
                }
                
                // Navigate back to contact detail view
                Backbone.history.navigate("contact/" + contact_id, {
                    trigger: true
                });
                
            }); // End of Close button of form Event Handler
      },

 };


/**
 * Prepends the name of the contact (which is in contact detail view),
 * to the pop-up modal's (task and note) related to field.
 * 
 * @method fill_relation
 * @param {Object} el
 * 			html object of the task or note form
 */
function fill_relation(el){
	var json = null;
	if(company_util.isCompany()){
		json = App_Companies.companyDetailView.model.toJSON();
	} else {
		json = App_Contacts.contactDetailView.model.toJSON();
	}
 	var contact_name = getContactName(json);//getPropertyValue(json.properties, "first_name")+ " " + getPropertyValue(json.properties, "last_name");
 	
 	// Adds contact name to tags ul as li element
 	$('.tags',el).html('').html('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="'+ json.id +'">'+contact_name+'</li>');

}

function is_subscriber_active(workflow_id)
{
	var model = App_Contacts.contactDetailView.model;
	
	if(!model)
		return false;
	
	var contact = App_Contacts.contactDetailView.model.toJSON();
	
	var campaign_statuses = contact.campaignStatus;
	
	if(!campaign_statuses)
		return false;
	
	for(var i=0; i < campaign_statuses.length; i++)
	{
		if(campaign_statuses[i].status == workflow_id+"-ACTIVE")
			return true;
	}
	
	return false;
	
}var notesView;
var dealsView; 
var eventsView;
var tasksView;
var casesView;
var documentsView;
var campaignsView;
var mailsView;
var mailAccountsView;
var email_errors_divs = [];
var email_requests = [];

var contact_details_tab = {
		load_timeline : function()
		{
			$('div.tab-content', App_Contacts.contactDetailView.el).find('div.active').removeClass('active');
			
			$('#time-line', App_Contacts.contactDetailView.el).addClass('active');
			if($("#timeline", App_Contacts.contactDetailView.el).hasClass('isotope'))
			{
				$("#timeline", App_Contacts.contactDetailView.el).isotope( 'reLayout', function(){} )
				return;
			}
				load_timeline_details(App_Contacts.contactDetailView.el, App_Contacts.contactDetailView.model.get('id'));
		},
		load_notes : function()
		{
		    var id = App_Contacts.contactDetailView.model.id;
		    notesView = new Base_Collection_View({
	            url: '/core/api/contacts/' + id + "/notes",
	            restKey: "note",
	            templateKey: "notes",
	            individual_tag_name: 'li',
	            sortKey:"created_time",
	            descending: true,
	            postRenderCallback: function(el) {
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
	            		 $(".note-created-time", el).timeago();
	              	})
	              	contact_detail_page_infi_scroll($('#contact-dtl', App_Contacts.contactDetailView.el), notesView);
	            }
	        });
	        notesView.collection.fetch();
	        $('#notes', App_Contacts.contactDetailView.el).html(notesView.el);
		},
		load_events : function()
		{
			var id = App_Contacts.contactDetailView.model.id;
			eventsView = new Base_Collection_View({
	            url: '/core/api/contacts/' + id + "/events",
	            restKey: "event",
	            templateKey: "contact-events",
	            individual_tag_name: 'li',
	            sortKey:"created_time",
	            descending: true,
	            postRenderCallback: function(el) {
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
	            		 $(".event-created-time", el).timeago();
	              	});
	            	$('li',el).each(function(){
	            	if($(this).find('.priority_type').text().trim() == "High") {
            			$(this).css("border-left","3px solid #f05050");
            		}else if($(this).find('.priority_type').text().trim() == "Normal"){
            			$(this).css("border-left","3px solid #7266ba");
            		}else if($(this).find('.priority_type').text().trim() == "Low") {
            			$(this).css("border-left","3px solid #fad733");
            		}
	            	});
	            }
	        });
			eventsView.collection.fetch();
	        $('#events', App_Contacts.contactDetailView.el).html(eventsView.el);
		},
		load_documents : function()
		{
			 id = App_Contacts.contactDetailView.model.id;
			 documentsView = new Base_Collection_View({
		            url: '/core/api/documents/contact/' + id + "/docs",
		            restKey: "document",
		            templateKey: "contact-documents",
		            individual_tag_name: 'li',
		            sortKey:"uploaded_time",
		            descending: true,
		            postRenderCallback: function(el) {
		            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
		            		 $(".document-created-time", el).timeago();
		              	});
		            
		            }
		        });
			    documentsView.collection.fetch();
		        $('#documents', App_Contacts.contactDetailView.el).html(documentsView.el);
		},
		load_tasks : function()
		{
			   id = App_Contacts.contactDetailView.model.id;
				tasksView = new Base_Collection_View({
		            url: '/core/api/contacts/' + id + "/tasks",
		            restKey: "task",
		            templateKey: "contact-tasks",
		            individual_tag_name: 'li',
		            sortKey:"created_time",
		            descending: true,
		            postRenderCallback: function(el) {
		            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
		            		 $(".task-created-time", el).timeago();
		              	});
		            	$('li',el).each(function(){
		            		if($(this).find('.priority_type').text().trim()== "HIGH") {
		            			$(this).css("border-left","3px solid #f05050");
		            		}else if($(this).find('.priority_type').text().trim() == "NORMAL"){
		            			$(this).css("border-left","3px solid #7266ba");
		            		}else if($(this).find('.priority_type').text().trim() == "LOW") {
		            			$(this).css("border-left","3px solid #fad733");
		            		}
		            	});
		            }
		            
		        });
				tasksView.collection.fetch();
		        $('#tasks', App_Contacts.contactDetailView.el).html(tasksView.el);
		},
		load_deals : function ()
		{
			id = App_Contacts.contactDetailView.model.id;
			dealsView = new Base_Collection_View({
				url: 'core/api/contacts/'+ id + "/deals" ,
	            restKey: "opportunity",
	            templateKey: "deals",
	            individual_tag_name: 'li',
	            sortKey:"created_time",
	            descending: true,
	            postRenderCallback: function(el) {
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
	            		 $(".deal-created-time", el).timeago();
	            	})
	            }
	        });
	        dealsView.collection.fetch();
	        $('#deals', App_Contacts.contactDetailView.el).html(dealsView.el);
		},
		load_cases : function()
		{
			id = App_Contacts.contactDetailView.model.id;
			casesView = new Base_Collection_View({
				url: 'core/api/contacts/'+ id + "/cases" ,
	            restKey: "cases",
	            templateKey: "cases-contact",
	            individual_tag_name: 'li',
	            sortKey:"created_time",
	            descending: true,
	            postRenderCallback: function(el) {
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
	            		 $(".deal-created-time", el).timeago();
	            	})
	            }
	        });
			casesView.collection.fetch();
	        $('#cases', App_Contacts.contactDetailView.el).html(casesView.el);
		},
		load_mail : function(mail_server_url,email_server)
		{	
			killAllPreviousRequests();
			$('#mail #mails-span', App_Contacts.contactDetailView.el).remove();
			$('#mails', App_Contacts.contactDetailView.el).html("");
			if(typeof mailsView !== 'undefined')
			{
				mailsView.render = null;
				mailsView.collection = null;
			}
			var contact = App_Contacts.contactDetailView.model;
			var json = contact.toJSON();
			// Get email of the contact in contact detail
			var email = getAllPropertyValuesByName(json.properties, "email", ",");			
			// Shows an error alert, when there is no email to the contact
			if (!email)
			{
				show_no_email_alert();
				return;
			}
			var contact_details_tab_scope = this;
			var has_email_configured = true;
			var has_shared_email_configured = true;			
			if(email_server && mail_server_url)
			{
				if($('#has_email_configured', App_Contacts.contactDetailView.el).html() === 'true')
					has_email_configured = true;
				else
					has_email_configured = false;
				if(email_server !== 'all')
					fetchMails(contact_details_tab_scope,has_email_configured,mail_server_url,email_server,email);
				else
				{
					var email_accounts_model = mailAccountsView.model.toJSON();
					fetchAllMails(contact_details_tab_scope,has_email_configured,email_accounts_model,email);
				}
			}
			else
			{
				loadMailTabView(contact_details_tab_scope,email_server,mail_server_url,email);
			}		
		},
		load_stats : function()
		{
			var contact = App_Contacts.contactDetailView.model;
			var json = contact.toJSON();
			 
			// Get email of the contact in contact detail
			var email = getAllPropertyValuesByName(json.properties, "email", ",");
			
			// Shows an error alert, when there is no email to the contact 
			if(!email){
				$('#stats', App_Contacts.contactDetailView.el).html('<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>Sorry! this contact has no email to get the stats.</div>');
				return;	
			}
			
			// To avoid unnecessary JSAPI count, first verify in cookie
			if(!(readCookie('_agile_jsapi') != null && readCookie('_agile_jsapi') == "true") && (NO_WEB_STATS_SETUP && get_web_stats_count_for_domain() == '0'))
			{
				$('#stats', App_Contacts.contactDetailView.el).html('<h4><p>You have not yet setup the Javascript API on your website.</p><p>Please <a href="#analytics-code">set it up</a> to see the contact\'s site visits here.</p></h4>');
				return;
			}
				
			
			// Add tag if data is not 0
	        addTagAgile(CODE_SETUP_TAG);

				var statsView = new Base_Collection_View({
				url: 'core/api/web-stats?e=' + encodeURIComponent(email),
			//	data: statsCollection.toJSON(),
				templateKey: "stats",
	            individual_tag_name: 'li',
	            postRenderCallback: function(el)
	            {
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function() { 
	        			$(".stats-created-time", el).each(function(index, element) {
	        				$(element).timeago();
	        			});
	    			});
	            	
	            	var first_model_element = $('#stats-model-list').find('li')[0];
	            	
	            	// Expand first li by default
	            	if(first_model_element)
	            		$(first_model_element).find('#show-page-views').trigger('click');
	            	
	            }
	        });
			
	        statsView.collection.fetch();
	        
	        // Organises collection based on created_time in decreasing order
	        statsView.collection.comparator = function(model)
	        {
	        	if (model.get('created_time'))
		            return -model.get('created_time');
		                                      
	        }
	        console.log($('#stats', App_Contacts.contactDetailView.el));
	        $('#stats', App_Contacts.contactDetailView.el).html(statsView.render().el);
		},
		load_campaigns : function()
		{
			campaignsView = new Base_Collection_View({
				url: '/core/api/campaigns/logs/contact/' + App_Contacts.contactDetailView.model.id,
	            restKey: "logs",
	            templateKey: "campaigns",
	            individual_tag_name: 'li',
	            cursor : true,
	            page_size : 20,
	            sort_collection:false,
	            postRenderCallback: function(el) {            	
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
	              		 $("time.log-created-time", el).timeago();
	              	});
	            	contact_detail_page_infi_scroll($('#contact-dtl', App_Contacts.contactDetailView.el), campaignsView);
	            },
	            appendItemCallback : function(el)
				{
					includeTimeAgo(el);
				} 
	        });

			campaignsView.collection.fetch({
				success: function(){

					// Verify whether contact updated or not
					checkContactUpdated();
				}

			});	

	        $('#campaigns', App_Contacts.contactDetailView.el).html(campaignsView.el);
		}
};
/**
 * This method responsible for building mail tab UI in contact-details page.
 * First it loads configured email accounts and then loads emails from selected
 * email account. It has an option of showing all emails in one shot also.
 */
function loadMailTabView(contact_details_tab_scope,email_server,mail_server_url,email)
{
	var has_email_configured = true;
	var has_shared_email_configured = true;
	var model = "";
	var email_dropdown_html = "";
	var from_email = "";
    mailAccountsView = new Base_Model_View({ url : 'core/api/emails/synced-accounts', template : "email-account-types",change:false,
		postRenderCallback : function(el)
		{	
			model = mailAccountsView.model.toJSON();
			if(model.hasEmailAccountsConfigured)
				has_email_configured = true;
			else
				has_email_configured = false;
			if(model.hasSharedEmailAccounts)
				has_shared_email_configured = true;
			else
				has_shared_email_configured = false;
			//Reading cookie info, fetches mail server type and email from cookie 
			var cookie_info = fetch_mailserverurl_from_cookie(model);
			if(cookie_info && cookie_info.length == 4)
			{
				mail_server_url = cookie_info[0];
				email_dropdown_html = cookie_info[1];
				email_server = cookie_info[2];
				from_email = cookie_info[3];
				if(from_email)
					email_server_type = from_email;
			}
			//By default loads mails from Agile server
			if(!email_server || !mail_server_url || !from_email || (!has_email_configured && !has_shared_email_configured))
			{
				email_server = "agile";
				email_dropdown_html = '<i class="icon-cloud" style="margin-right:4px;font-size: 1.2em"></i>'+'Agile';
				email_server_type = "agilecrm";
			}
			//Fetching emails from All registered email accounts
			if(email_server ==='all' || mail_server_url === 'all')
				fetchAllMails(contact_details_tab_scope,has_email_configured,model,email)
			else
				fetchMails(contact_details_tab_scope,has_email_configured,mail_server_url,email_server,email);
			if(has_email_configured || has_shared_email_configured)
			{
				if(email_dropdown_html)
					$('#email-type-select',App_Contacts.contactDetailView.el).html(email_dropdown_html);	 
				$('#mail-account-types', App_Contacts.contactDetailView.el).css('display','block');
			} 						
		}
	});
	$('#mail-account-types', App_Contacts.contactDetailView.el).html(mailAccountsView.render().el);	 
}

/**
 * This function is used to get mails from specified server and email, 
 * if server or email is not specified then it fetches 
 * mails sent through Agile.
 */
function fetchMails(contact_details_tab_scope,has_email_configured,mail_server_url,email_server,email)
{	
	$('#mail', App_Contacts.contactDetailView.el).append('<span id="mails-span"> <img class="mails-loading p-r-xs m-b m-l-sm pull-left"  src= "/img/ajax-loader-cursor.gif"></img></span>');
	this.configured_sync_email = "";
	var cursor = true;

	// By default showing Agile emails
	if(email_server === 'agile')
	{
		mail_server_url = 'core/api/emails/agile-emails?e='+encodeURIComponent(email);
		email_server_type = "agilecrm";
		cursor = false;
	}
	else
		mail_server_url = mail_server_url + '&search_email='+encodeURIComponent(email);

	// Fetches mails collection
	mailsView = new Base_Collection_View({ url : mail_server_url , cursor : cursor, page_size : 10,
	templateKey : "email-social", sort_collection : true, sortKey : "date_secs", descending : true, individual_tag_name : "li",
	postRenderCallback : function(el)
	{
		$('#mail', App_Contacts.contactDetailView.el).find("#no-email").css('display','block');
		head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
		{
			$(".email-sent-time", el).each(function(index, element)
			{
				$(element).timeago();
			});
		});
		
		if(email_server_type!="agilecrm")
			contact_details_tab_scope.configured_sync_email = email_server_type;
	
		if(!has_email_configured)
			$('#email-prefs-verification',App_Contacts.contactDetailView.el).css('display', 'block');
		contact_detail_page_infi_scroll($('#contact-dtl', App_Contacts.contactDetailView.el), mailsView);
		$('#mail #mails-span', App_Contacts.contactDetailView.el).remove();
	}});
	mailsView.collection.fetch();
	$('#mails', App_Contacts.contactDetailView.el).html(mailsView.render().el);
}

function fetchAllMails(contact_details_tab_scope,has_email_configured,email_accounts_model,email)
{	
	var all_emails = [];
	var fetch_urls = email_accounts_model['fetchUrls'];
	$('#contact-dtl', App_Contacts.contactDetailView.el).unbind("scroll");
	loadAllMailsView(contact_details_tab_scope,has_email_configured,all_emails);
    fetchMailsFromAllAccounts(contact_details_tab_scope,has_email_configured,fetch_urls,email);
}

/**
 * 
 * This function is used to fetch mails from all configured email
 * accounts. It calls emails servers in asynchronous fashion.
 * After getting response from each server call, view automatically
 * gets sorted and rendered with new items
 
 * @param contact_details_tab_scope
 * @param has_email_configured
 * @param fetch_urls
 * @param email
 */
function fetchMailsFromAllAccounts(contact_details_tab_scope,has_email_configured,fetch_urls,email)
{
	var response_count = 0;
	if(fetch_urls)
	{
		if(fetch_urls.length > 0)
		{
			$('#mail-account-types', App_Contacts.contactDetailView.el).prepend('<span id="mails-span"> <img class="all-mails-loading p-r-xs m-b m-l-sm pull-left"  src= "/img/ajax-loader-cursor.gif"></img></span>');
			$('#mail-account-types', App_Contacts.contactDetailView.el).find('.all-mails-loading').css("display","block");
		}
		for(var i=0;i<fetch_urls.length;i++)
		{
			var xhr = $.ajax({ url : fetch_urls[i]+'&search_email='+encodeURIComponent(email),
				async : true, 
				success : function(emails)
				{	
					response_count++;
					if(emails)
					{	if(ifNoError(emails[0]))
						{
							if(!mailsView)
							{				
								setTimeout(function(){
									mailsView.collection.add(emails);
									mailsView.render(true);
									showTransitionBar();
								},5000);
							}
							else
							{
								mailsView.collection.add(emails);
								mailsView.render(true);				
							}
						}
						if(response_count === fetch_urls.length)
						{
							showMailsInfoMessages();
						}
				    }
				},
			    error : function(response)
			    {
			    	response_count++;
			    	if(response_count === fetch_urls.length)
			    	{
			    		showMailsInfoMessages(response);
			    	}
			    }
			});
			email_requests.push(xhr);
		}
	}
}
/**
 * /**
 * This function is responsible for building mailsView.
 * Mails view consists mails fetched from emails servers.
 
 * @param contact_details_tab_scope
 * @param has_email_configured
 * @param fetched_emails
 * 
 */
function loadAllMailsView(contact_details_tab_scope,has_email_configured,fetched_emails)
{
	if(typeof mailsView !== 'undefined')
	{
		mailsView.render = null;
		mailsView = null;
	}
	this.configured_sync_email = "";
	mailsView = new Base_Collection_View({data : fetched_emails,
	templateKey : "email-social", sort_collection : true, sortKey : "date_secs", descending : true, individual_tag_name : "li",
	postRenderCallback : function(el)
	{
		head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
		{
			$(".email-sent-time", el).each(function(index, element)
			{
				$(element).timeago();
			});
		});
		
		if(email_server_type!="agilecrm")
			contact_details_tab_scope.configured_sync_email = email_server_type;
	
		if(!has_email_configured)
			$('#email-prefs-verification',App_Contacts.contactDetailView.el).css('display', 'block');
		//$('#mail #mails-span', App_Contacts.contactDetailView.el).remove();
	}});
	$('#mails', App_Contacts.contactDetailView.el).html(mailsView.render(true).el);
}

/**
 * This method is used read email_type_select cookie , parses cookie value
 * and evalutes if cookie informations has vaild now or not.
 * This cookie stores information about selected mail type and mail under mail tab.
 * @param model
 * @returns {Array}
 */
function fetch_mailserverurl_from_cookie(model)
{
	var cookie_value = readCookie(email_server_type_cookie_name);
	var final_url = "";
	var cookie_info = [];
	if(cookie_value)
	{
		var values = cookie_value.split("|");
		if(values)
		{
			if(values.length === 2)
			{
				var email = values[0];
				var email_server = values[1];
				var html = "";
				var shared = false;
				if(email && email_server)
				{
					if(email_server.toLowerCase()==='all')
					{
						cookie_info[0] = 'all'
						cookie_info[1] = 'All Mail';
						cookie_info[2] = 'all';
						cookie_info[3] = 'all';
					}
					else if(email_server.toLowerCase()==='google')
					{
						var hasGmail = false;
						if(typeof model.gmailUserNames !== 'undefined' && model.hasOwnProperty('gmailUserNames'))
						{
							for(var i=0;i<model.gmailUserNames.length;i++)
							{
								if(model.gmailUserNames[i] === email)
								{
									hasGmail = true;
									break;
								}
							}
						}
						if(typeof model.sharedGmailUserNames !== 'undefined' && model.hasOwnProperty('sharedGmailUserNames'))
						{
							for(var i=0;i<model.sharedGmailUserNames.length;i++)
							{
								if(model.sharedGmailUserNames[i] === email)
								{
									hasGmail = true;
									shared = true;
									break;
								}
							}
						}
						if(hasGmail)
						{
							final_url = 'core/api/social-prefs/google-emails?from_email='+email;
							html = '<i class="icon-google-plus" style="margin-right:4px;font-size: 1.2em"></i>'+email;
							if(shared)
								html = html+ ' (Shared)';
						}
					}
					else if(email_server.toLowerCase()==='imap')
					{
						var hasImap = false;
						if(typeof model.imapUserNames !== 'undefined' && model.hasOwnProperty('imapUserNames'))
						{
							for(var i=0;i<model.imapUserNames.length;i++)
							{
								if(model.imapUserNames[i] === email)
								{
									hasImap = true;
									break;
								}
							}
						}
						if(typeof model.sharedImapUserNames !== 'undefined' && model.hasOwnProperty('sharedImapUserNames'))
						{
							for(var i=0;i<model.sharedImapUserNames.length;i++)
							{
								if(model.sharedImapUserNames[i] === email)
								{
									hasImap = true;
									shared = true;
									break;
								}
							}
						}
						if(hasImap)
						{
							final_url = 'core/api/imap/imap-emails?from_email='+email;
							html = '<i class="icon-envelope-alt" style="margin-right:4px;font-size: 1.2em"></i>'+email;
							if(shared)
								html = html+ ' (Shared)';
						}
					}
					else if(email_server.toLowerCase()==='exchange')
					{
						var hasExchange = false;
						if(typeof model.exchangeUserNames !== 'undefined' && model.hasOwnProperty('exchangeUserNames'))
						{
							for(var i=0;i<model.exchangeUserNames.length;i++)
							{
								if(model.exchangeUserNames[i] === email)
								{
									hasExchange = true;
									break;
								}
							}
						}
						if(typeof model.sharedExchangeUserNames !== 'undefined' && model.hasOwnProperty('sharedExchangeUserNames'))
						{
							for(var i=0;i<model.sharedExchangeUserNames.length;i++)
							{
								if(model.sharedExchangeUserNames[i] === email)
								{
									hasExchange = true;
									shared = true;
									break;
								}
							}
						}
						if(hasExchange)
						{
							final_url = 'core/api/office/office365-emails?from_email='+email;
							html = '<i class="icon-windows" style="margin-right:4px;font-size: 1.2em"></i>'+email;
							if(shared)
								html = html+ ' (Shared)';
						}
					}
					if(final_url)
					{
						cookie_info[0] = final_url
						cookie_info[1] = html;
						cookie_info[2] = email_server;
						cookie_info[3] = email;
					}
				}
			}// end of if cookie values == 2
		}
	}
	return cookie_info;
}

function contact_detail_page_infi_scroll(element_id, targetCollection)
{
	console.log("initialize_infinite_scrollbar",element_id);
	
	element_id.unbind("scroll");

	if (element_id == undefined || element_id == null)
	{
		console.log("no elmnt");
		return;
	}
	console.log(targetCollection);
	targetCollection.infiniScroll = new Backbone.InfiniScroll(targetCollection.collection, {
		target : element_id,
		untilAttr : 'cursor',
		param : 'cursor',
		strict : false,
		pageSize : targetCollection.page_size,
		success : function(colleciton, response)
		{
			console.log('in success');
			if (!colleciton.last().get("cursor"))
			{
				this.strict = true;
				targetCollection.infiniScroll.disableFetch();
			}
			// Remove loading icon
			$(targetCollection.infiniScroll.options.target).find('.scroll-loading').remove();
		},
		onFetch : function()
		{
			console.log('in fetch');
			// Add loading icon
			$(targetCollection.infiniScroll.options.target).append(
					'<div class="scroll-loading"> <img src="/img/ajax-loader-cursor.gif" style="margin-left: 44%;"> </div>');
		}
		});
}
function showMailsInfoMessages()
{
	showMailsErrorMessages();
	if(mailsView.collection.length > 0)
	{
		if(($('#all-emails-info',App_Contacts.contactDetailView.el).length === 0))
		{
			$('#mails',App_Contacts.contactDetailView.el).append('<div id="all-emails-info" class="alert alert-info">Showing relevant messages from all accounts. Maximum of 20 messages from each account </div>');
		}
	}
	$('#mail-account-types', App_Contacts.contactDetailView.el).find('.all-mails-loading').remove();
	$('#mail', App_Contacts.contactDetailView.el).find("#no-email").css('display','block');
}
function showMailsErrorMessages()
{
	for(var i=0;i<email_errors_divs.length;i++)
		$('#mails',App_Contacts.contactDetailView.el).prepend(email_errors_divs[i]);
	email_errors_divs = [];
}
function ifNoError(email)
{
	if(email && 'errormssg' in email && 'owner_email' in email)
	{
		var email_error_div = '<div class="alert alert-danger" > <a href="#" class="close" data-dismiss="alert">&times;</a><span class="text-dark">Unable to fetch emails from account "'+email.owner_email+'" Error:'+ email.errormssg+'</span>';
		email_errors_divs.push(email_error_div);
		return false;
	}
	return true;
}
function killAllPreviousRequests()
{
	for(var i=0;i<email_requests.length;i++)
	{
		var xhr = email_requests[i];
		xhr.abort();
	}
	email_requests = [];
}
function show_no_email_alert()
{
	$('#mail', App_Contacts.contactDetailView.el).html('<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>Sorry! this contact has no email to get the mails.</div>');
}
	/**
 * contact-details-tabs.js fetches the contact (which is in contact detail view)
 * related details (notes, tasks, deals, campaigns and mails etc..) and presents
 * in tab content as specified, when the corresponding tab is clicked. Timeline
 * tab is activated by default to show all the details as vertical time-line.
 * 
 * @module Contact management
 * @author Rammohan
 */

var contact_tab_position_cookie_name = "contact_tab_position_" + CURRENT_DOMAIN_USER.id;

var CONTACT_ASSIGNED_TO_CAMPAIGN = false;

var NO_WEB_STATS_SETUP = true;

var email_server_type = "agilecrm";

var email_server_type_cookie_name = "email_server_type_" + CURRENT_DOMAIN_USER.id;

function fill_company_related_contacts(companyId, htmlId)
{
	$('#' + htmlId).html(LOADING_HTML);

	var companyContactsView = new Base_Collection_View({ url : 'core/api/contacts/related/' + companyId, templateKey : 'company-contacts',
		individual_tag_name : 'tr', cursor : true, page_size : 25, sort_collection : false, postRenderCallback : function(el)
		{
			// var cel = App_Contacts.contactsListView.el;
			// var collection = App_Contacts.contactsListView.collection;
		} });

	companyContactsView.collection.fetch();

	$('#' + htmlId).html(companyContactsView.render().el);
}

var Contact_Details_Tab_Actions = {

	 /**
	 * Activates the Timeline tab-content to show the time-line with all
	 * details, which are already added to time-line, when the contact is
	 * getting to its detail view.
	 */
	  openTimeLine : function(e){
	  		
			save_contact_tab_position_in_cookie("timeline");

			contact_details_tab.load_timeline();
	  },

	  onEmailSubjectClick : function(e){
	  		
	  		var targetEl = $(e.currentTarget);

			var href = $(targetEl).attr("href");
			var id = $(targetEl).attr('id');
			$(".collapse-" + id).hide();
			$(href).collapse('toggle');

			$(href).on("hidden.bs.collapse", function()
			{
				$(".collapse-" + id).show();
			})
	  },

	  // Hide More link and truncated webstats and show complete web stats.
	  showPageViews : function(e){
		   $(e.currentTarget).closest('.activity-text-block').find('#complete-webstats').toggle();	  	
	  },

	  // to remove contact from active campaign.
	  removeActiveCampaigns : function(e){
	  	var targetEl = $(e.currentTarget);

  		if (!confirm("Are you sure to remove " + $(targetEl).attr("contact_name") + " from " + $(targetEl).attr("campaign_name") + " campaign?"))
		return;

		var $active_campaign = $(targetEl).closest('span#active-campaign');
		var campaign_id = $active_campaign.attr('data');
		var contact_id;

		// Fetch contact id from model
		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model)
			contact_id = App_Contacts.contactDetailView.model.get('id');

		// Url to delete
		var deleteUrl = 'core/api/workflows/remove-active-subscriber/' + campaign_id + '/' + contact_id;

		$.ajax({ url : deleteUrl, type : 'DELETE', success : function(data)
		{

			var contact_json = App_Contacts.contactDetailView.model.toJSON();
			var campaign_status = contact_json.campaignStatus;

			// On success callback, remove from both UI and backbone contact
			// model.
			if (campaign_status !== undefined)
			{
				for (var i = 0, len = campaign_status.length; i < len; i++)
				{
					if (campaign_id === campaign_status[i].campaign_id)
					{
						// Remove from campaignStatus array of contact model
						campaign_status.splice(i, 1);
						break;
					}
				}
			}

			// Remove li
			$active_campaign.remove();

		} });
	  },

	  /**
	 * Fetches all the notes related to the contact and shows the notes
	 * collection as a table in its tab-content, when "Notes" tab is clicked.
	 */
	  showNotes : function(e){
		   save_contact_tab_position_in_cookie("notes");
		   contact_details_tab.load_notes();
	  
	  },

	  /**
	 * Fetches all the events related to the contact and shows the events
	 * collection as a table in its tab-content, when "Events" tab is clicked.
	 */
	  showEvents : function(e){
		   save_contact_tab_position_in_cookie("events");
		contact_details_tab.load_events();
	  },

	   replyToEmail : function(e){
		   
		   var targetEl = $(e.currentTarget);

				var from = $(targetEl).data('from');

				var $parent_element = $(targetEl).closest('#email-reply-div');

				var to_emails = $parent_element.find('.to-emails').data('to');
				var cc_emails = $parent_element.find('.cc-emails').data('cc');
				var bcc_emails = $parent_element.find('.bcc-emails').data('bcc');

				var email_sync_configured = contact_details_tab.configured_sync_email;

				var configured_email;

				if (email_sync_configured)
				{
					configured_email = email_sync_configured;
				}

				if (configured_email && to_emails)
				{
					// Merge both from and to removing configured email
					to_emails = get_emails_to_reply(from + ', ' + to_emails, configured_email);
				}

				if (configured_email && cc_emails)
				{

					cc_emails = get_emails_to_reply(cc_emails, configured_email);
				}

				if (configured_email && bcc_emails)
				{

					bcc_emails = get_emails_to_reply(bcc_emails, configured_email);
				}

				// Change url only without triggerring function
				App_Contacts.navigate('send-email');

				// Reply all emails
				reply_email = to_emails;

				// Removes leading and trailing commas
				reply_email = reply_email.replace(/(, $)/g, "");

				if (cc_emails)
					cc_emails = cc_emails.replace(/(, $)/g, "");

				if (bcc_emails)
					bcc_emails = bcc_emails.replace(/(, $)/g, "");

				// Trigger route callback
				App_Contacts.sendEmail(reply_email, "Re: " + $parent_element.find('.email-subject').text(),
						'<p></p><blockquote style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex;">' + $parent_element.find('.email-body')
								.html() + '</blockquote>', cc_emails, bcc_emails);

	  },

	  /**
	 * Delete functionality for activity blocks in contact details
	 */
	   deleteActivity : function(e){
		  	
		  	var targetEl = $(e.currentTarget);

		  	var model = $(targetEl).parents('li').data();

			if (model && model.toJSON().type != "WEB_APPOINTMENT")
			{
				if (!confirm("Are you sure you want to delete?"))
					return;
			}
			else if (model && model.toJSON().type == "WEB_APPOINTMENT" && parseInt(model.toJSON().start) < parseInt(new Date().getTime() / 1000))
			{
				if (!confirm("Are you sure you want to delete?"))
					return;
			}

			if (model && model.collection)
			{
				model.collection.remove(model);
			}

			// Gets the id of the entity
			var entity_id = $(targetEl).attr('id');

			if (model && model.toJSON().type == "WEB_APPOINTMENT" && parseInt(model.toJSON().start) > parseInt(new Date().getTime() / 1000))
			{
				web_event_title = model.toJSON().title;
				if (model.toJSON().contacts.length > 0)
				{
					var firstname = getPropertyValue(model.toJSON().contacts[0].properties, "first_name");
					if (firstname == undefined)
						firstname = "";
					var lastname = getPropertyValue(model.toJSON().contacts[0].properties, "last_name");
					if (lastname == undefined)
						lastname = "";
					web_event_contact_name = firstname + " " + lastname;
				}
				$("#webEventCancelModel").modal('show');
				$("#cancel_event_title").html("Delete event &#39" + web_event_title + "&#39");
				$("#event_id_hidden").html("<input type='hidden' name='event_id' id='event_id' value='" + entity_id + "'/>");
				return;
			}

			// Gets the url to which delete request is to be sent
			var entity_url = $(targetEl).attr('url');

			if (!entity_url)
				return;

			var id_array = [];
			var id_json = {};

			// Create array with entity id.
			id_array.push(entity_id);

			// Set entity id array in to json object with key ids,
			// where ids are read using form param
			id_json.ids = JSON.stringify(id_array);
			var that = targetEl;

			// Add loading. Adds loading only if there is no loaded image added
			// already i.e.,
			// to avoid multiple loading images on hitting delete multiple times
			if ($(targetEl).find('.loading').length == 0)
				$(targetEl).prepend($(LOADING_HTML).addClass('pull-left').css('width', "20px"));

			$.ajax({ url : entity_url, type : 'POST', data : id_json, success : function()
			{
				// Removes activity from list
				$(that).parents(".activity").fadeOut(400, function()
				{
					$(targetEl).remove();
				});
				removeItemFromTimeline($("#" + entity_id, $("#timeline")));
			} });
	  },

	 
};

/**
 * Returns contact properties in a json
 * 
 * @method get_property_JSON
 * @param {Object}
 *            contactJSON contact as json object
 */
function get_property_JSON(contactJSON)
{
	var properties = contactJSON.properties;
	var json = {};
	$.each(properties, function(i, val)
	{
		json[this.name] = this.value;
	});
	console.log(json);
	return json;
}

/**
 * Populates send email details (from address, to address, signature and email
 * templates)
 * 
 * @method populate_send_email_details
 * @param {Object}
 *            el html object of send email form
 */
function populate_send_email_details(el)
{

	$("#emailForm", el).find('input[name="from_name"]').val(CURRENT_DOMAIN_USER.name);
	$("#emailForm", el).find('input[name="from_email"]').val(CURRENT_DOMAIN_USER.email);

	// Fill hidden signature field using userprefs
	// $("#emailForm").find( 'input[name="signature"]'
	// ).val(CURRENT_USER_PREFS.signature);

	// Prefill the templates
	var optionsTemplate = "<option value='{{id}}'> {{#if name}}{{name}}{{else}}{{subject}}{{/if}}</option>";
	fillSelect('sendEmailSelect', '/core/api/email/templates', 'emailTemplates', undefined, optionsTemplate, false, el, '- Fill from Template -');
}

/**
 * Activates "Timeline" tab and its tab-content in contact details and also
 * deactivates the other activated tabs.
 * 
 * @method activate_timeline_tab
 * 
 * Changed to activate first tab in the list ( on contact-details page , works
 * even on company-details page
 * @modified Chandan
 */
function activate_timeline_tab()
{
	$('#contactDetailsTab').find('li.active').removeClass('active');
	$('#contactDetailsTab li:first-child').addClass('active');

	$('div.tab-content').find('div.active').removeClass('active');
	$('div.tab-content > div:first-child').addClass('active');

	// $('#time-line').addClass('active'); //old original code for flicking
	// timeline

	if (App_Contacts.contactDetailView.model.get('type') == 'COMPANY')
	{
		fill_company_related_contacts(App_Contacts.contactDetailView.model.id, 'company-contacts');
	}
}

/**
 * Disables Send button of SendEmail and change text from Send to Sending...
 * 
 * @param elem -
 *            element to be disabled.
 * 
 */
function disable_send_button(elem)
{
	elem.css('min-width', elem.width() + 'px').attr('disabled', 'disabled').attr('data-send-text', elem.text()).text('Sending...');
}

/**
 * Enables disabled Send button and keep old text
 * 
 * @param elem -
 *            element to be enabled.
 * 
 */
function enable_send_button(elem)
{
	elem.text(elem.attr('data-send-text')).removeAttr('disabled data-send-text');
}

/**
 * Returns webstats count w.r.t domain
 */
function get_web_stats_count_for_domain()
{
	// Returns web-stats count
	return $.ajax({ type : "GET", url : 'core/api/web-stats/JSAPI-status', async : false }).responseText;
}

function save_contact_tab_position_in_cookie(tab_href)
{

	var position = readCookie(contact_tab_position_cookie_name);

	if (position == tab_href)
		return;

	createCookie(contact_tab_position_cookie_name, tab_href);
}

function load_contact_tab(el, contactJSON)
{
	timeline_collection_view = null;
	var position = readCookie(contact_tab_position_cookie_name);
	if (position == null || position == undefined || position == "")
		position = "timeline";

	$('#contactDetailsTab a[href="#' + position + '"]', el).tab('show');

	if (!position || position == "timeline")
	{
		activate_timeline_tab()
		contact_details_tab.load_timeline();
		return;
	}

	if (contact_details_tab["load_" + position])
	{

		// Should add active class, tab is not enough as content might not be
		// shown in view.
		$(".tab-content", el).find("#" + position).addClass("active");
		contact_details_tab["load_" + position]();
	}

}

function get_emails_to_reply(emails, configured_email)
{
	var emails_array = emails.split(',');

	emails = "";

	for (var i = 0, len = emails_array.length; i < len; i++)
	{

		var email = emails_array[i].match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)[0];

		// Skip configured email
		if (configured_email && email == configured_email)
			continue;

		// Skip current user email
		if (email == CURRENT_DOMAIN_USER.email)
			continue;

		emails += email;

		// Append comma without trailing
		if (i < len - 1)
			emails += ', ';

	}

	return emails;
}
function save_email_server_type_in_cookie(cookie_value)
{
	if (cookie_value)
	{
		var previous_cookie_value = readCookie(email_server_type_cookie_name);
		if (previous_cookie_value === cookie_value)
			return;
		createCookie(email_server_type_cookie_name, cookie_value, 30);
	}
}

function initializeSendEmailListeners(){

/**
	 * Populates subject and description using email templates, on select option
	 * change of "Fill From Templates" field.
	 */
	$('#send-email-listener-container').on('change', '.emailSelect', function(e)
	{
		e.preventDefault();

		// To remove previous errors
		$('#emailForm').find('.error').removeClass('error');
		$('#emailForm').find('.help-inline').css('display', 'none');

		var model_id = $('.emailSelect option:selected').prop('value');

		// When default option selected make subject and body empty
		if (!model_id)
		{
			// Fill subject and body of send email form
			$("#emailForm").find('input[name="subject"]').val("");

			set_tinymce_content('email-body', '');

			$("#emailForm").find('textarea[name="body"]').val("");
			
			$('.add-attachment-cancel').trigger("click");

			$('#eattachment_error').hide();
			return;
		}

		var emailTemplatesModel = Backbone.Model.extend({ url : '/core/api/email/templates/' + model_id, restKey : "emailTemplates" });
		var templateModel = new emailTemplatesModel();
		templateModel.fetch({ success : function(data)
		{
			var model = data.toJSON();

			var subject = model.subject;
			var text = model.text;

			// Apply handlebars template on send-email route
			if (Current_Route !== 'bulk-email' && Current_Route !== 'send-email')
			{

				// Get Current Contact
				/*
				 * var contact = App_Contacts.contactDetailView.model; var json =
				 * contact.toJSON();
				 */

				/*
				 * Get Contact properties json to fill the templates using
				 * handlebars
				 */
				var json = get_contact_json_for_merge_fields();
				var template;

				// Templatize it
				try
				{
					template = Handlebars.compile(subject);
					subject = template(json);
				}
				catch (err)
				{
					subject = add_square_brackets_to_merge_fields(subject);

					template = Handlebars.compile(subject);
					subject = template(json);
				}

				try
				{
					template = Handlebars.compile(text);
					text = template(json);
				}
				catch (err)
				{
					text = add_square_brackets_to_merge_fields(text);

					template = Handlebars.compile(text);
					text = template(json);
				}
			}

			// Fill subject and body of send email form
			$("#emailForm").find('input[name="subject"]').val(subject);

			// Insert content into tinymce
			set_tinymce_content('email-body', text);
			
			if (model.attachment_id && Current_Route != 'bulk-email' && Current_Route != 'company-bulk-email')
			{
				var el = $('.add-attachment-select').closest("div");
				$('.add-attachment-select').hide();
				el.find(".attachment-document-select").css("display", "inline");
				var optionsTemplate = "<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}' url='{{url}}'>{{name}}</option>";
        		fillSelect('attachment-select','core/api/documents', 'documents',  function fillNew()
				{
					el.find("#attachment-select option:first").after("<option value='new'>Upload new doc</option>");
					$('#attachment-select').find('option[value='+model.attachment_id+']').attr("selected","selected");
					$('.add-attachment-confirm').trigger("click");

				}, optionsTemplate, false, el);
			}
			else if (model.attachment_id && (Current_Route == 'bulk-email' || Current_Route == 'company-bulk-email'))
			{
				$('.add-attachment-select').hide();
				$('#eattachment_error').show();
			}
			else if(!model.attachment_id && (Current_Route == 'bulk-email' || Current_Route == 'company-bulk-email'))
			{
				$('.add-attachment-select').hide();
				$('#eattachment_error').hide();
			}
			else if(!model.attachment_id)
			{
				$('.add-attachment-cancel').trigger("click");
				$('#eattachment_error').hide();
			}
		} });

	});

	/**
	 * Sends email to the target email. Before sending, validates and serializes
	 * email form.
	 */
	$('#send-email-listener-container').on('click', '#sendEmail', function(e)
					{
						e.preventDefault();

						if ($(this).attr('disabled'))
							return;
						var $form = $('#emailForm');
						// Is valid
						if (!isValidForm($form))
							return;
						var network_type = $('#attachment-select').find(":selected").attr('network_type');
						// checking email attachment type , email doesn't allow
						// google drive documents as attachments
						if (network_type)
						{
							if (network_type.toUpperCase() === 'GOOGLE')
								return;
						}

						// Saves tinymce content to textarea
						save_content_to_textarea('email-body');

						// serialize form.
						var json = serializeForm("emailForm");
						if ((json.contact_to_ids).join())
							json.to += ((json.to != "") ? "," : "") + (json.contact_to_ids).join();

						if ((json.contact_cc_ids).join())
							json.email_cc += ((json.email_cc != "") ? "," : "") + (json.contact_cc_ids).join();

						if ((json.contact_bcc_ids).join())
							json.email_bcc += ((json.email_bcc != "") ? "," : "") + (json.contact_bcc_ids).join();

						if (json.to == "" || json.to == null || json.to == undefined)
						{
							// Appends error info to form actions block.
							$save_info = $('<span style="display:inline-block;color:#df382c;">This field is required.</span>');
							$('#emailForm').find("#to").closest(".controls > div").append($save_info);
							$('#emailForm').find("#to").focus();
							// Hides the error message after 3 seconds
							$save_info.show().delay(3000).hide(1);

							enable_send_button($('#sendEmail'));
							return;
						}

						// Is valid
						if (!isValidForm($('#emailForm')))
							return;

						// Disables send button and change text to Sending...
						disable_send_button($(this));

						// Navigates to previous page on sending email
						$
								.ajax({
									type : 'POST',
									data : json,
									url : 'core/api/emails/contact/send-email',
									success : function()
									{

										// Enables Send Email button.
										enable_send_button($('#sendEmail'));

										window.history.back();

									},
									error : function(response)
									{
										enable_send_button($('#sendEmail'));

										// Show cause of error in saving
										$save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>' + response.responseText + '</i></p></small></div>');

										// Appends error info to form actions
										// block.
										$($('#sendEmail')).closest(".form-actions", this.el).append($save_info);

										// Hides the error message after 3
										// seconds
										if (response.status != 406)
											$save_info.show().delay(10000).hide(1);
									} });

					});

	/**
	 * Close button click event of send email form. Navigates to contact detail
	 * view.
	 */
	$('#send-email-listener-container').on('click', '#send-email-close', function(e)
	{
		e.preventDefault();

		window.history.back();
	});


$('#send-email-listener-container').on('click', '#cc-link, #bcc-link', function(e)
	{
		e.preventDefault();

		// Hide link
		$(this).hide();

		if ($(this).attr('id') === 'cc-link')
		{
			$('#email_cc').closest('.control-group').show();

			// Hide div.control-group to reduce space between subject
			if ($(this).parent().find('#bcc-link').css('display') === 'none')
				$(this).closest('.control-group').hide();

			return;
		}

		if ($(this).parent().find('#cc-link').css('display') === 'none')
			$(this).closest('.control-group').hide();

		$('#email_bcc').closest('.control-group').show();
	});

	$('#send-email-listener-container').on('click', '#from_email_link', function(e)
	{
		e.preventDefault();
		$(this).closest('.control-group').hide();
		$('#from_email').closest('.control-group').show();
		$('#from_name').closest('.control-group').show();
		return;
	});

}/*var noAnimationBruteForce = true;
var timeline_collection_view;
var MONTH_YEARS;
var month_years = [];

var timeline_view = Backbone.View.extend({ initialize : function()
{
	// Binds functions to view
	_.bindAll(this, 'render', 'appendItem', 'addItems');

	this.options.data = App_Contacts.contactDetailView.model.toJSON().tagsWithTime;
	this.options.data.push(App_Contacts.contactDetailView.model.toJSON());
	// this.options.data.push(App_Contacts.contactDetailView.model.toJSON().tagsWithTime);

	this.collection = new BaseCollection([], {});
	this.month_year_marker = [];
	this.month_year_marker_objects = [];
	configure_timeline_comparator(this.collection);
	this.collection.add(this.options.data, { silent : true });

	load_other_timline_entities();
	this.queue = new Queue;
	this.collection.bind('add', this.appendItem);

}, appendItem : function(model)
{
	if (model.get("entity_type"))
		if (model.get("entity_type") == "year-marker")
		{
			getTemplate("year-marker", model.toJSON(), "yes", function(template)
			{
				$('#timeline', App_Contacts.contactDetailView.el).isotope('insert', $(template));
			});
			return;
		}

	this.collection.add(model, { silent : true });
	var temp = [];
	temp.push(model.toJSON());
	var elements = getTemplate("timeline1", temp, undefined, function(result)
	{
		$('#timeline', App_Contacts.contactDetailView.el).isotope("insert", $(result));
	});

}, addItems : function(models)
{

	this.collection.add(models, { silent : true });
	// this.collection.add(this.month_year_marker_objects, {merge : true})
	this.buildTimlinePosts(models);

	// $("#timeline").append(getTemplate("timeline1", models));
	// $("#timeline").append($(getTemplate("timeline1", models)));
	
	 * getTemplate("timeline1", models, undefined, function(result){
	 * console.log($(result)); $("#timeline",
	 * App_Contacts.contactDetailView.el).isotope('insert', $(result),
	 * function(){ $("#timeline").isotope('reLayout'); }); })
	 * 
	 
}, render : function()
{
	// this.collection.add(this.month_year_marker_objects, {merge : true})
	this.buildTimlinePosts(this.collection.toJSON());
	
	 * if(this.collection.length > 20) { var i = 0; var length =
	 * this.collection.length; while(i < length) { var end = i + 20;
	 * 
	 * end = end > length ? length - 1 : end; if(end == i) break;
	 * console.log(this.collection); console.log(end + ", " + i);
	 * console.log(this.collection.toJSON().slice(i, end)); var _this = this;
	 * //console.log(getTemplate("timeline1", this.collection.toJSON()));
	 * getTemplate("timeline1", this.collection.toJSON().slice(i, end),
	 * undefined, function(result){
	 * 
	 * if(i == 0) { //var _this = this; $("#timeline",
	 * App_Contacts.contactDetailView.el).append(result);
	 * 
	 * //configure_timeline(); } else { var $newEls = $(result);
	 * //$("#timeline").append($newEls).isotope( 'appended', $newEls);
	 * $("#timeline",App_Contacts.contactDetailView.el).isotope('insert',
	 * $(result)); }
	 * 
	 * 
	 * 
	 * _this.queue.add_function(function(models){ alert(models); // return true; },
	 * _this.collection.toJSON().slice(i, end))
	 * 
	 * 
	 * 
	 * }); i += 20; } }
	 * 
	 * 
	 * 
	 * //configure_timeline();
	 * 
	 * 
	 * 
	 * 
	 * 
	 * 
	 * //create_month_marker(MONTH_YEARS, true,
	 * App_Contacts.contactDetailView.model.el);
	 * 
	 * 
	 * 
	 * //$("#timeline").isotope('reLayout'); // Resizes the line height based on
	 * entities overall height /* $('#timeline').resize(function(){
	 * adjust_line(); alert("test"); });
	 
}, buildTimlinePosts : function(models)
{
	var length = models.length;
	if (!length)
		return;

	this.addToQueue(models)
	return;

	var i = 0;
	while (i < length)
	{
		var end = i + 50;

		end = end > length ? length : end;
		if (end == i)
			break;
		this.addToQueue(models.slice(i, end));
		i += 50;
	}
}, addToQueue : function(models)
{
	this.queue.add_function(quedfunction, models);
}

});

function quedfunction(models)
{
	var is_empty_queue;
	// timeline_collection_view.queue.running = true;
	getTemplate("timeline1", models, undefined, function(result)
	{
		$("#timeline").isotope('insert', $(result), function(ele)
		{
			timeline_collection_view.queue.running = false;
			timeline_collection_view.queue.next();
		});
	});
}

function load_timeline_details(el, contactId, callback1, noAnimation)
{
	noAnimationBruteForce = true;
	init_timeline();

}

function init_timeline()
{
	MONTH_YEARS = [];
	// Load plugins for timeline
	head.load("/lib/isotope.pkgd.js", LIB_PATH + "lib/jquery.event.resize.js", "css/misc/agile-timline.css", function()
	{

		configure_timeline();
		timeline_collection_view = new timeline_view();
		timeline_collection_view.render();
		remove_loading_img(App_Contacts.contactDetailView.el);
	});

}

function configure_timeline_comparator(collection)
{

	// Override comparator to sort models on time base
	collection.comparator = function(item)
	{
		var month_year = entity_created_month_year(item.toJSON());

		if (month_year)
			if (timeline_collection_view && timeline_collection_view.month_year_marker.indexOf(month_year) == -1)
			{

				timeline_collection_view.month_year_marker.push(month_year);

				var monthYear = month_year.split('-');
				var timestamp = getTimestamp(monthYear[0], monthYear[1]) / 1000;
				console.log("(((((((((((((((((((((((((((((((((((((" + monthArray[monthYear[0]].split(' ')[0]);
				var context = { year : monthArray[monthYear[0]].split(' ')[0], timestamp : timestamp, "entity_type" : "year-marker" };
				if (!collection.where({ "year" : monthArray[monthYear[0]].split(' ')[0] })[0])
					;
				collection.add(context);

				console.log(context);
				timeline_collection_view.month_year_marker_objects.push(context);
			}

		if (item.get('created_time'))
		{
			return item.get('created_time');
		}
		else if (item.get('createdTime'))
		{
			return item.get('createdTime') / 1000;
		}
		else if (item.get('time'))
		{
			return item.get('time') / 1000;
		}
		else if (item.get('date_secs'))
		{
			return item.get('date_secs') / 1000;
		}
		else if (item.get('timestamp'))
		{
			return timestamp;
		}

		return item.get('id');
	}
}

function configure_timeline()
{
	customize_isotope();

	var $container = $("#timeline", App_Contacts.contactDetailView.el);

	// Initializes isotope with options (sorts the data based on created time)
	$container.isotope({ itemSelector : ".item", transformsEnabled : true, layoutMode : 'spineAlign', spineAlign : { gutterWidth : 56 },
		getSortData : { timestamp : function($elem)
		{
			var time = parseFloat($elem.find('.timestamp').text());

			if (!time)
				return 0;
			// If time is in milliseconds then return time in seconds
			if ((time / 100000000000) > 1)
				return time / 1000;

			return time
		} }, sortBy : 'timestamp', sortAscending : false, itemPositionDataEnabled : true });
}

function load_other_timline_entities()
{
	var contact = App_Contacts.contactDetailView.model.toJSON();
	var contactId = contact['id'];
	
	load_related_entities(contactId);
	load_stats(contact);
	load_campaign_logs(contactId);

}

function load_campaign_logs(contactId)
{
	var url = '/core/api/campaigns/logs/contact/' + contactId;
	$
			.getJSON(
					url,
					function(data)
					{
						if (data.length == 0)
							return;
						var log_models = [];

						$
								.each(
										data,
										function(index, model)
										{

											// Add these log-types in timeline
											if (model.log_type == 'EMAIL_SENT' || model.log_type == 'EMAIL_OPENED' || model.log_type == 'EMAIL_CLICKED' || model.log_type == 'SET_OWNER' || model.log_type == 'SCORE' || model.log_type == 'ADD_DEAL' || model.log_type == 'TWEET')
											{
												log_models.push(model);
											}

										});

						timeline_collection_view.addItems(log_models);
					})
}

function load_stats(contact)
{
	
	 * Stores all urls (notes, deals and tasks) in an array to fetch data using
	 * same collection by changing its url.
	 

	var email = getPropertyValue(contact.properties, "email");


	// Go for mails when only the contact has an email
	if (email)
	{
		get_stats('core/api/emails/imap-email?e=' + encodeURIComponent(email) + '&c=10&o=0', contact, App_Contacts.contactDetailView.el, function(stats)
		{
			// Clone emails Array to not affect original emails

			var stats_processed = [];
			if (stats && stats.length > 0)
			{
				for(var i = 0; i < stats.length; i ++)
				{
					// if error occurs in imap (model is obtained with the error msg along with contact-email models),
					// ignore that model
					if(('errormssg' in stats[i]) || stats[i].status === "error")
						continue;
					
					stats_processed.push(stats[i]);
				}
				
				
				// Addes opened emails into timeline
				var opened_emails = getOpenedEmailsFromEmails(stats_processed);
				if (opened_emails.length > 0)
					stats_processed.push(opened_emails);

				timeline_collection_view.addItems(stats_processed);
			}
		})
	}
}

function load_related_entities(contactId)
{
	var entity_types = ["deals", "notes", "cases", "tasks"];

	$.getJSON('core/api/contacts/related-entities/' + contactId, function(data)
	{
		var entities = [];

		for ( var index in entity_types)
		{
			if (data[entity_types[index]].length == 0)
				continue;

			entities = entities.concat(data[entity_types[index]]);

		}

		timeline_collection_view.addItems(entities);
	});
}

function getOpenedEmailsFromEmails(emails)
{
	var opened_emails = [];
	$.each(emails, function(index, model)
	{
		if (model.email_opened_at && model.email_opened_at !== 0)
		{
			// Need createdTime key to sort in timeline.
			model.createdTime = (model.email_opened_at) * 1000;

			// Temporary entity to identify timeline template
			model.agile_email = "agile_email";

			// To avoid merging with emails template having date entity
			model.date = undefined;

			opened_emails.push(model);
		}
		
	});

	return opened_emails;
}

function getTimlineTemplate(models)
{

}

function add_entity_to_timeline(model)
{
	var list = [];
	list.push(model.toJSON())

	// console.log(model.get('id'));

	if (!timeline_collection_view.collection.get(model.get('id')))
	{
		timeline_collection_view.addItems(list);
		return;
	}

	update_entity_template(model);

}

function update_entity_template(model)
{
	$("#" + model.get("id"), $('#timeline', App_Contacts.contactDetailView.el)).html(getTemplate('timeline1', [
		model.toJSON()
	]));
}

function get_stats(email, contact, el)
{
	// If there are no web-stats - return
	if(!(readCookie('_agile_jsapi') != null && readCookie('_agile_jsapi') == "true") && (NO_WEB_STATS_SETUP && get_web_stats_count_for_domain() == '0'))
	{
		// Remove loading image of mails
		$('#time-line', el).find('.loading-img-stats').remove();
		
		return;
	}
	
	// Made global variable false and set cookie
	NO_WEB_STATS_SETUP = false;
	createCookie('_agile_jsapi',true, 500);
	
	var StatsCollection = Backbone.Collection.extend({
		                        url:'core/api/web-stats?e='+ encodeURIComponent(email)
		                                             });
	
	this.statsCollection = new StatsCollection();
	statsCollection.fetch({
		success:function(data){
			
			is_mails_fetched = true;
			is_logs_fetched = false;
			is_array_urls_fetched = false;
			
			show_timeline_padcontent(is_logs_fetched, is_mails_fetched, is_array_urls_fetched);
			
         	$('#time-line', el).find('.loading-img-stats').remove();
			
			// Checks whether data is empty or not.
			if (data.toJSON() && data.toJSON().length > 0) {
				
				// Gets address of the contact from its browsing history
				var address = getPropertyValue(contact.properties, "address");
				
				if(!address)
				{
				var addressJSON = {};
				
				if(data.toJSON()[0].city != "")
				{
				    addressJSON.city = ucfirst(data.toJSON()[0].city);
				    addressJSON.state = ucfirst(data.toJSON()[0].region);
				    addressJSON.country = getCode(data.toJSON()[0].country);
				
					// If contact has no address property push the new one
					contact.properties.push({
					"name" : "address",
					"value" : JSON.stringify(addressJSON)
				                       });
					
					// Update contact with the browsing address
					var contactModel = new Backbone.Model();
					contactModel.url = 'core/api/contacts';
					contactModel.save(contact, {
						success : function(obj) {
						                        }
					                  });
				  }
				}
								
				timeline_collection_view.addItems(data);
				
				
				addTagAgile(CODE_SETUP_TAG);	
			}
			
		},
		error: function(){
			is_mails_fetched = true;
			show_timeline_padcontent(is_logs_fetched, is_mails_fetched, is_array_urls_fetched);
			
			// Remove loading image of mails
			$('#time-line', el).find('.loading-img-stats').remove();
		}
	});
	}

*//**
 * Removes an element from timeline
 * 
 * @param element
 *//*
function removeItemFromTimeline(element)
{
	console.log(element);
	$('#timeline').isotope('remove', element, function()
	{
		$("#timeline").isotope('reLayout')
	});
}

function addTagToTimelineDynamically(tags)
{	
	timeline_collection_view.addItems([tag]);
}*//**
 * Fetches all the entities (notes, deals, tasks, logs and mails) simultaneously, 
 * which are related to a contact (in contactDetailView) and initiates isotope 
 * with the first fetched details (to show in time-line) and inserts the next 
 * fetched data into time-line.
 *  
 * @method load_timeline_details 
 * @param {Object} el
 * 				html object of contact detail view
 * @param contactId
 * 				id of a contact in contact detail view
 *//*


 * Taken as global to verify whether timeline is defined or not while adding
 * entities (notes, tasks and etc..) related to a contact.
   
var timelineView;
function load_timeline_details1(el, contactId, callback1)
{
	// Sets to true, if the associated entity is fetched 
	var is_logs_fetched = false, is_mails_fetched = false, is_array_urls_fetched = false;
	
		*//**
		 * An empty collection (length zero) is created to add first fetched 
		 * details and then initializes isotope with this data 
		 *//* 
		timelineView =  new Base_Collection_View({
			templateKey: 'timeline',
			individual_tag_name: 'li',
		});
	
		
		*//**
		 * Another empty collection is created to add other data (apart from first fetched)
		 * which is fetched while the isotope is getting initialized with the first fetched 
		 * data, because it can not be inserted with out complete initialization of isotope.  
		 * 
		 *//*
		var timelineViewMore =  new Base_Collection_View({
			templateKey: 'timeline',
			individual_tag_name: 'li',
		});
		
		// Override comparator to sort models on time base
		timelineView.collection.comparator = function(item){
			if (item.get('created_time')) {
	            return item.get('created_time');
	        }
			if (item.get('createdTime')) {
				return item.get('createdTime')/1000;
		    }
	        if (item.get('time')) {
	        	return item.get('time')/1000;
	        }
	        if (item.get('date_secs')) {
	        	return item.get('date_secs')/1000;
	        }
	        return item.get('id');
		}
		
		var contact = App_Contacts.contactDetailView.model.toJSON();
		
		addTagsToTimeline(App_Contacts.contactDetailView.model, el);
		
		// Fetches logs related to the contact
		var LogsCollection = Backbone.Collection.extend({
			url: '/core/api/campaigns/logs/contact/' + contactId,
		});
		var logsCollection = new LogsCollection();
		logsCollection .fetch({
			success: function(){
				is_logs_fetched = true;
				show_timeline_padcontent(is_logs_fetched, is_mails_fetched, is_array_urls_fetched);
				
				// Remove logs related loading image
				$('#time-line', el).find('.loading-img-log').remove();
				if(logsCollection.length == 0)
					return;
	
				// If timeline is not defined yet, calls setup_timeline for the first time
				if(timelineView.collection.length == 0){
					$.each(logsCollection.toJSON(), function(index, model){
						
						// Add these log-types in timeline
						if(model.log_type == 'EMAIL_SENT' || model.log_type == 'EMAIL_OPENED' || model.log_type == 'EMAIL_CLICKED' 
							 || model.log_type == 'SET_OWNER' || model.log_type == 'SCORE'
								|| model.log_type == 'ADD_DEAL' || model.log_type == 'TWEET')
						{
							timelineView.collection.add(model, {silent : true});
						}
						
					});
								
					
					 * Calls setup_timeline with a callback function to insert other models 
					 * (fetched while initializing the isotope) if available.
					 
					setup_timeline(timelineView.collection.toJSON(), el, function(el){
						$.each(timelineViewMore.collection.toJSON(), function(index,data){
							var newItem = $(getTemplate("timeline", data));
							newItem.find('.inner').append('<a href="#" class="open-close"></a>');
							$('#timeline', el).isotope( 'insert', newItem);
						});
					});
				}else{
					var logs_array = [];	
					
					 * Already setup_timeline is called with the first fetched data. Adds all the
					 * logs of each campaign to an array and then inserts the array values 
					 * (avoids calling insertion and month marker multiple times).
					 * Inserts the data into timeline or adds to other collection (timelineViewMore) 
					 * by validating the status of isotope initialization.
					    
					$.each(logsCollection.toJSON(), function(index, model) {						
						
						// Add these log-types in timeline.
						if(model.log_type == 'EMAIL_SENT' || model.log_type == 'EMAIL_OPENED' || model.log_type == 'EMAIL_CLICKED' 
							 || model.log_type == 'SET_OWNER' || model.log_type == 'SCORE'
									|| model.log_type == 'ADD_DEAL' || model.log_type == 'TWEET')
						{
							logs_array.push(model);			
						    timelineView.collection.add(model, {silent : true});
						}
						
						//validate_insertion(JSON.parse(model.logs), timelineViewMore);
					});
					validate_insertion(logs_array, timelineViewMore);
				}
			
			}
		});
		
		*//** Emails Collection Starts**//*
		var contact = App_Contacts.contactDetailView.model;
		var json = contact.toJSON();
		 
		// Get email of the contact in contact detail
		var email = getPropertyValue(json.properties, "email");
		
		// Go for mails when only the contact has an email
		if(email){
			
			var EmailsCollection = Backbone.Collection.extend({
				url: 'core/api/emails/imap-email?e=' + encodeURIComponent(email) + '&c=10&o=0',
			});
			var emailsCollection = new EmailsCollection();
			emailsCollection .fetch({
				success: function(){
					is_mails_fetched = true;
					show_timeline_padcontent(is_logs_fetched, is_mails_fetched, is_array_urls_fetched);
					
					$('#time-line', el).find('.loading-img-email').remove();
					
					
					
					if(emailsCollection.toJSON()[0] && emailsCollection.toJSON()[0]['emails'] && emailsCollection.toJSON()[0]['emails'].length > 0){
					
						// Adds Personal Email Opened Track Data to timeline.
						add_personal_email_opened_to_timeline(emailsCollection.toJSON()[0]['emails'],el);

						// If timeline is not defined yet, calls setup_timeline for the first time
						if(timelineView.collection.length == 0 && emailsCollection.toJSON()[0]){

							// No callback function is taken as the email takes more time to fetch
							setup_timeline(timelineView.collection.toJSON(), el, function(el) {

								$.each(timelineViewMore.collection.toJSON(), function(index,data){
									
									// if error occurs in imap (model is obtained with the error msg along with contact-email models),
									// ignore that model
									if(('errormssg' in data) || data.status === "error")
										return true;
									
									var newItem = $(getTemplate("timeline", data));
									newItem.find('.inner').append('<a href="#" class="open-close"></a>');
									$('#timeline', el).isotope( 'insert', newItem);
								});
							});
						}else{
							    var emailsArray = [];
							    
								$.each(emailsCollection.toJSON()[0]['emails'], function(index, model){
									
									// if error occurs in imap (model is obtained with the error msg along with contact-email models),
									// ignore that model
									if(('errormssg' in model) || model.status === "error")
										return true;
									
									emailsArray.push(model);
								});
								
							validate_insertion(emailsArray, timelineViewMore);
							}
					}
				},
				error: function(){
					is_mails_fetched = true;
					show_timeline_padcontent(is_logs_fetched, is_mails_fetched, is_array_urls_fetched);
					
					// Remove loading image of mails
					$('#time-line', el).find('.loading-img-email').remove();
				}
			});
			
			// Gets address of the contact from its browsing history
			var address = getPropertyValue(json.properties, "address");
           
			//if(!address)
				//get_address_from_browsing_history(email, json,el);
			
			// Gets address from stats and save to contact
			get_stats(email,json,el);
		}else{
			is_mails_fetched = true;
			
			// Removes loading image of mails, if there is no email to contact  
			$('#time-line', el).find('.loading-img-email').remove();
			$('#time-line',el).find('.loading-img-stats').remove();
		}
		*//**End of Emails Collection**//*
		
		*//**
		 * Defines a collection to store the response of all the request urls (notes, deals 
		 * and tasks) in the array (fetchContactDetails).
		 *//* 
		
		var entity_types = ["deals", "notes", "cases", "tasks"]
		$.getJSON('core/api/contacts/related-entities/' + contactId, function(data){
			var entities = [];
			
			for(var index in entity_types)
			{
				entities = entities.concat(data[entity_types[index]]);
				
			}
			
			remove_loading_img(el);
			
			
			timelineView.collection.add(entities , {silent : true});
			
		
				// If timeline is not defined yet, calls setup_timeline for the first time
				if(timelineView.collection.length == 0){

					
					 * Calls setup_timeline with a callback function to insert other models 
					 * (fetched while initializing the isotope) if available.
					 
					setup_timeline(timelineView.collection.toJSON(), el, function(el) {
						
						$.each(timelineViewMore.collection.toJSON(), function(index,data){
							var newItem = $(getTemplate("timeline", data));
							newItem.find('.inner').append('<a href="#" class="open-close"></a>');
							$('#timeline', el).isotope( 'insert', newItem);
						});
					})
				}else{
					
					
					 * Already setup_timeline is called with the first fetched data.
					 * 
					 * Inserts the data into timeline or adds to other collection (timelineViewMore) 
					 * by validating the status of isotope initialization.
					 							
					validate_insertion(entities, timelineViewMore);
				}
		})
}	

*//**
 * Inserts the models into timeline, if isotope is defined (initialized 
 * completely) otherwise adds to a collection (timelineViewMore) to insert
 * them on complete initialization of isotope from setupTimelin callback
 * function.
 * 
 * @method validate_insertion
 * @param models
 * 			collection of models to add timeline
 * @param timelineViewMore
 * 			collection to add models
 * 			
 *//*
function validate_insertion(models, timelineViewMore){
	
	
	 * If isotope is not defined an exception will be raised, then
	 * it goes to catch block and adds the data to the collection
	 
	try{
		head.load(LIB_PATH + "lib/jquery.isotope.min.js", LIB_PATH + "lib/jquery.event.resize.js", "css/misc/agile-timline.css", function(){
		

			if($('#timeline').isotope()) {
				var month_years = [];
				$.each(models, function(index, model){
					var month_year = entity_created_month_year(model);

					if (month_years.indexOf(month_year) < 0 && MONTH_YEARS.indexOf(month_year) < 0){
						month_years[month_years.length] = month_year;
						MONTH_YEARS[MONTH_YEARS.length] = month_year;
					}	
					var newItem = $(getTemplate("timeline", model));
					newItem.find('.inner').append('<a href="#" class="open-close"></a>');
					$('#timeline').isotope( 'insert', newItem);
				});

				// add a month marker for each month that has a post
				create_month_marker(month_years, true, App_Contacts.contactDetailView.el);
			}
		});
		
	}catch(err){
		console.log(err);
		timelineViewMore.collection.add(models);
	}
}

*//**
 * Shows "no entities present" pad content for timeline by verifying
 * whether all the entities are fetched or not.
 *  
 * @param is_logs_fetched
 * @param is_mails_fetched
 * @param is_array_urls_fetched
 *//*
function show_timeline_padcontent(is_logs_fetched, is_mails_fetched, is_array_urls_fetched){
	if(!is_logs_fetched || !is_mails_fetched || !is_array_urls_fetched )
		return;
	
	if (timelineView.collection.length == 0)
		$("#timeline-slate").css('display', 'block');
}

// Stores month names with their maximum days to get time stamp (milliseconds)
var monthArray = ['January 31', 'February 28', 'March 31', 'April 30', 'May 31', 'June 30',
                  'July 31', 'August 31', 'September 30', 'October 31', 'November 30', 'December 31'];

// Stores "monthIndex-year" of timeline initiating entities
var MONTH_YEARS;

*//**
 * Get the timestamp (milliseconds) given month of the year.
 *//*
function getTimestamp(month_index, year){
	if((year % 4) == 0)
		monthArray[1] = 'February 29';
	return Date.parse(monthArray[month_index] + ', ' + year) + 86400000 - 1; 
}

*//**
 * Returns month index and full year of the given entity as "-" separated.
 * @param model
 * @returns {String}
 *//*
function entity_created_month_year(model){
	if(model.created_time)
		return month_year = new Date(model.created_time * 1000).getMonth() + '-' + new Date(model.created_time * 1000).getFullYear();
	if(model.createdTime)
		return month_year = new Date(model.createdTime).getMonth() + '-' + new Date(model.createdTime).getFullYear();
	else if(model.time)
		return month_year = new Date(model.time * 1000).getMonth() + '-' + new Date(model.time * 1000).getFullYear();
	else if(model.date_secs)
		return month_year = new Date(model.date_secs).getMonth() + '-' + new Date(model.date_secs).getFullYear();
}

*//**
 * Inserts or appends month marker to the timeline
 * @param month_years
 * @param is_insert
 *//*
function create_month_marker(month_years, is_insert, el){
	// add a year marker for each year that has a post
	$.each(month_years, function(i, val){
		var monthYear = val.split('-');
		var timestamp = getTimestamp(monthYear[0], monthYear[1]) / 1000;
		var context = {year: monthArray[monthYear[0]].split(' ')[0], timestamp: timestamp};
		if(is_insert){
			$('#timeline', el).isotope( 'insert', $(getTemplate("year-marker", context)));
		}	
		else{
			$('#timeline', el).append(getTemplate("year-marker", context));
		}	
	});
	$("#timline").isotope('reloadItems');
}


function add_entity_to_timeline(model)
{
	var list = [];
	list.push(model.toJSON())

	// console.log(model.get('id'));

	if (!timelineView.collection.get(model.get('id')))
	{
		timelineView.collection.add(model,  {silent : true})
		validate_insertion(list);
		return;
	}


	update_entity_template(model);

}

function update_entity_template(model)
{
	$("#" + model.get("id"), $('#timeline', App_Contacts.contactDetailView.el)).html(getTemplate('timeline', model.toJSON()));
}


*//**
 * Loads minified jquery.isotope plug-in and jquery.event.resize plug-in to 
 * initialize the isotope and appends the given models to the timeline, by 
 * loading their corresponding templates using handlebars
 * 
 * @method setup_timeline 
 * @param models
 * 			models to append timeline
 * @param el
 * 			html object of the contact detail view
 * @param callback
 * 			function to insert models into timeline on its initialization
 *//*
function setup_timeline(models, el, callback) {
	
	// Removes pad content of no data presents
	 $("#timeline-slate").css('display', 'none');
	 
	 MONTH_YEARS = [];
	
	// Load plugins for timeline	
	
		
	 head.load(LIB_PATH + "lib/jquery.isotope.min.js", LIB_PATH + "lib/jquery.event.resize.js", "css/misc/agile-timline.css", function(){
		
		 
		 * Defines the layout and its dimensions, container size and
		 * arrangement of data position added to timeline etc..
		  
		customize_isotope();
		
		
		 * Appends each model to timeline, by loading their corresponding
		 * templates using handlebars
		 
		$.each(models, function(index, model) {
			
			// saves the month and years so we can create month markers
			var month_year = entity_created_month_year(model);
			
					
			if (MONTH_YEARS.indexOf(month_year) < 0)
				MONTH_YEARS[MONTH_YEARS.length] = month_year;
			
			//console.log(MONTH_YEARS);
			
			// combine data & template
			$('#timeline', el).append(getTemplate("timeline", model));
		}); //each

		// add a month marker for each month that has a post
		create_month_marker(MONTH_YEARS, false, el);

		var $container = $("#timeline", el);
		
		// Initializes isotope with options (sorts the data based on created time)
		$('#timeline', el).imagesLoaded(function(){
			$container.isotope({
				itemSelector : '.item',
				transformsEnabled: true,
				layoutMode: 'spineAlign',
				spineAlign:{
					gutterWidth: 56
				},
				getSortData: {
					timestamp: function($elem){
						var time = parseFloat($elem.find('.timestamp').text());
						
						// If time is in milliseconds then return time in seconds
						if ((time / 100000000000) > 1)
							return time/1000;
						
						return time
					}
				},
				sortBy: 'timestamp',
				sortAscending: false,
				itemPositionDataEnabled: true
			});
		});
		
		// Using autoellipsis for showing 3 lines of message
		head.js(LIB_PATH + 'lib/jquery.autoellipsis.min.js', function(){
			$('#timeline', el).find("#autoellipsis").ellipsis();
			$('#timeline', el).isotope('reLayout');
		});
		
		// add open/close buttons to each post
		$('#timeline .item.post', el).each(function(){
			$(this).find('.inner').append('<a href="#" class="open-close"></a>');
		});
		// Resizes the line height based on entities overall height
		$('#timeline', el).resize(function(){
			adjust_line();
		});
		
		
		 * Calls the callback function to insert the data into timeline, which
		 * is not inserted due to initialization issues. 
		  
		if(callback && typeof(callback) === "function"){
			callback(el);
		}
		
	}); // head js
	
}


 * Keep the actual line from extending beyond the last item's date tab
 
function adjust_line(){
	var $lastItem = $('.item.last');
	var itemPosition = $lastItem.data('isotope-item-position');
	var dateHeight = $lastItem.find('.date').height();
	var dateOffset = $lastItem.find('.date').position();
	var innerMargin = parseInt($lastItem.find('.inner').css('marginTop'));
	var lineHeight = itemPosition.y + innerMargin + dateOffset.top + (dateHeight / 2);
	$('#line').height(lineHeight);
}

*//**
 * Defines the layout and its dimensions, container size and
 * arrangement of data position added to timeline etc..
 * 
 * @method customize_isotope
 *//*
function customize_isotope()
{
	// Resets the layout based on items 
	$.Isotope.prototype._spineAlignReset = function() {
		this.spineAlign = {
			colA: 0,
			colB: 0,
			lastY: -60
		};
	};

	
	 * Defines the dimentions of layout, and alters the position of data.
	 * It executes every tiem, when a modal is added or deleted from timeline.
	  
	$.Isotope.prototype._spineAlignLayout = function( $elems ) {
		var	instance = this,
			props = this.spineAlign,
			gutterWidth = Math.round( this.options.spineAlign && this.options.spineAlign.gutterWidth ) || 0,
			centerX = Math.round(this.element.width() / 2);

		$elems.each(function(i, val){
			var $this = $(this);
			$this.removeClass('last').removeClass('top');
			if (i == $elems.length - 1)
				$this.addClass('last');
			var x, y;
			if ($this.hasClass('year-marker')){
				var width = $this.width();
				x = centerX - (width / 2);
				if (props.colA >= props.colB){
					y = props.colA;
					if (y == 0) $this.addClass('top');
					props.colA += $this.outerHeight(true);
					props.colB = props.colA;
				}
				else{
					y = props.colB;
					if (y == 0) $this.addClass('top');
					props.colB += $this.outerHeight(true);
					props.colA = props.colB;
				}
			}
			else{
				$this.removeClass('left').removeClass('right');
				var isColA = props.colB >= props.colA;
				if (isColA)
					$this.addClass('left');
				else
					$this.addClass('right');
				x = isColA ?
						centerX - ( $this.outerWidth(true) + gutterWidth / 2 ) : // left side
						centerX + (gutterWidth / 2); // right side
				y = isColA ? props.colA : props.colB;
				if (y - props.lastY <= 60){
					var extraSpacing = 60 - Math.abs(y - props.lastY);
					$this.find('.inner').css('marginTop', extraSpacing);
					props.lastY = y + extraSpacing;
				}
				else{
					$this.find('.inner').css('marginTop', 0);
					props.lastY = y;
				}
				props[( isColA ? 'colA' : 'colB' )] += $this.outerHeight(true);
			}
			instance._pushPosition( $this, x, y );
		});
	};
	
	// Sets the container size based on spinAlignLayout function resulrs
	$.Isotope.prototype._spineAlignGetContainerSize = function() {
		var size = {};
		size.height = this.spineAlign[( this.spineAlign.colB > this.spineAlign.colA ? 'colB' : 'colA' )];
		return size;
	};
	$.Isotope.prototype._spineAlignResizeChanged = function() {
		return true;
	};
}	

*//**
 * Removes loading image from timeline view
 * 
 * @param el
 * 			html object of contact detail view
 *//*
function loading_img(el){
	$('#time-line', el).find('.loading-img').remove();
}

*//**
 * When contact has no address, based on its email, traces address from its
 * browsing history and stores as address property of the contact.
 * 
 * To get address of a contact with its email, you should run the java script
 * api provided at api & analytics (admin settings) by pushing the email of the
 * contact
 * 
 * @param {String}
 *            email of the contact
 * @param {Object}
 *            contact present in contact detail view
 * @param {Object}
 *            backbone element.
 *//*function get_stats(email, contact, el)
{
	// If there are no web-stats - return
	if(!(readCookie('_agile_jsapi') != null && readCookie('_agile_jsapi') == "true") && (NO_WEB_STATS_SETUP && get_web_stats_count_for_domain() == '0'))
	{
		is_mails_fetched = true;
		is_logs_fetched = false;
		is_array_urls_fetched = false;
		show_timeline_padcontent(is_logs_fetched, is_mails_fetched, is_array_urls_fetched);
		
		// Remove loading image of mails
		$('#time-line', el).find('.loading-img-stats').remove();
		
		return;
	}
	
	// Made global variable false and set cookie
	NO_WEB_STATS_SETUP = false;
	createCookie('_agile_jsapi',true, 500);
	
	var StatsCollection = Backbone.Collection.extend({
		                        url:'core/api/web-stats?e='+ encodeURIComponent(email)
		                                             });
	
	this.statsCollection = new StatsCollection();
	statsCollection.fetch({
		success:function(data){
			
			is_mails_fetched = true;
			is_logs_fetched = false;
			is_array_urls_fetched = false;
			
			show_timeline_padcontent(is_logs_fetched, is_mails_fetched, is_array_urls_fetched);
			
         	$('#time-line', el).find('.loading-img-stats').remove();
			
			// Checks whether data is empty or not.
			if (data.toJSON() && data.toJSON().length > 0) {
				
				// Gets address of the contact from its browsing history
				var address = getPropertyValue(contact.properties, "address");
				
				if(!address)
				{
				var addressJSON = {};
				
				if(data.toJSON()[0].city != "")
				{
				    addressJSON.city = ucfirst(data.toJSON()[0].city);
				    addressJSON.state = ucfirst(data.toJSON()[0].region);
				    addressJSON.country = getCode(data.toJSON()[0].country);
				
					// If contact has no address property push the new one
					contact.properties.push({
					"name" : "address",
					"value" : JSON.stringify(addressJSON)
				                       });
					
					// Update contact with the browsing address
					var contactModel = new Backbone.Model();
					contactModel.url = 'core/api/contacts';
					contactModel.save(contact, {
						success : function(obj) {
						                        }
					                  });
				  }
				}
								
				// If timeline is not defined yet, calls setup_timeline for the first time
				if(timelineView.collection.length == 0)
				{					
					$.each(data.toJSON(),function(index,model){					
						timelineView.collection.add(model,  {silent : true});
					});					
					
					// No callback function is taken as the stats takes more time to fetch
					setup_timeline(timelineView.collection.toJSON(), el);							
				}
				else
				{					
						$.each(data.toJSON(),function(index,model){
						var newItem = $(getTemplate("timeline", model));
						newItem.find('.inner').append('<a href="#" class="open-close"></a>');
						
						
						 * Inserts mails to timeline with out validating the isotope status,
						 * as it takes more time to fetch.
						   
						$('#timeline', el).isotope( 'insert', newItem);
						});
				}
				
				addTagAgile(CODE_SETUP_TAG);	
			}
			
		},
		error: function(){
			is_mails_fetched = true;
			show_timeline_padcontent(is_logs_fetched, is_mails_fetched, is_array_urls_fetched);
			
			// Remove loading image of mails
			$('#time-line', el).find('.loading-img-stats').remove();
		}
	});
	}
 
 function addTagsToTimeline(contact, el)
 {
 	if (timelineView.collection.length == 0)
 	{
 		timelineView.collection.add(contact, {silent : true});

 		// Add tags in timeline
 		$.each(contact.get('tagsWithTime'), function(index, tag)
 		{
 			// console.log(tag);
 			timelineView.collection.add(tag, {silent : true});
 		})
 		setup_timeline(timelineView.collection.toJSON(), el);

 	}
 	else
 	{
 		var newItem = $(getTemplate("timeline", contact));
 		var newItem = $(getTemplate("timeline", contact));

 		newItem.find('.inner').append('<a href="#" class="open-close"></a>');
 		
 		 * Inserts mails to timeline with out validating the isotope status, as
 		 * it takes more time to fetch.
 		 
 		$('#timeline', el).isotope('insert', newItem);
 	}
 }

 function addTagToTimelineDynamically(tags)
 {
	 alert("tags tag");
	 if(!timelineView || !timelineView.collection)
		 return;
	 
 	if (timelineView.collection.length == 0)
 	{
 		$.each(tags, function(index, tag)
 		{
 			timelineView.collection.add(tag, {silent : true});
 		});

 		setup_timeline(timelineView.collection.toJSON(), el);
 		return;
 	}

 	var tags_to_add = [];
 	$.each(tags, function(index, tag)
 	{
 		if (!timelineView.collection.where(tag).length == 0)
 			return;

 		timelineView.collection.add(tag, {silent : true});
 		tags_to_add.push(tag);
 	});

 	validate_insertion(tags_to_add);

 	
 	 * var newItem = $(getTemplate("timeline", tag));
 	 * 
 	 * newItem.find('.inner').append('<a href="#" class="open-close"></a>');
 	 * 
 	 * Inserts mails to timeline with out validating the isotope status, as it
 	 * takes more time to fetch.
 	 * 
 	 * $('#timeline', el).isotope( 'insert', newItem);
 	 

 }
 
 *//**
  * Adds Email Opened data having email opened time to timeline.
  * 
  * @param emails - Emails JSON.
  * 
  * @param el - Backbone el.
  **//*
 function add_personal_email_opened_to_timeline(emails,el)
 {
	// Temporary array to clone emails
	var emails_clone = [];
	
	// Clone emails Array to not affect original emails
	$.extend(true, emails_clone, emails);
	
	var emails_opened = [];
	 
	 if (timelineView.collection.length == 0)
	 	{
			 $.each(emails_clone,function(index, model){
				if(model.email_opened_at && model.email_opened_at !== 0)
			 	{
				 	// Need createdTime key to sort in timeline.
					model.createdTime = (model.email_opened_at) * 1000;
					
				 	// Temporary entity to identify timeline template
					model.agile_email = "agile_email";
				 	
					// To avoid merging with emails template having date entity
					model.date = undefined;
					
				 	timelineView.collection.add(model, {silent : true});
			 	}
			 });
			 
			 setup_timeline(timelineView.collection.toJSON(), el);
	 	}
	 else
		 {
		 $.each(emails_clone, function(index, model){
				if(model.email_opened_at && model.email_opened_at !== 0)
			 	{
					// Need createdTime key to sort in timeline.
					model.createdTime = (model.email_opened_at) * 1000;
				 	
					// Temporary entity to identify timeline template
					model.agile_email = "agile_email";
				 	
					// To avoid merging with emails template having date entity
					model.date = undefined;
				 	
					emails_opened.push(model);
			 	}
			 });
		 
		 validate_insertion(emails_opened);
		 }
 }

 *//**
  * Removes an element from timeline
  * 
  * @param element
  *//*
 function removeItemFromTimeline(element)
 {
 
	 try
	 {
		 var element = $('#timeline');
		 if(element.length == 0)
			 return;
		 $(element).isotope('remove', element, function()
				 {
			 		$("#timeline").isotope( 'reLayout')
				 });
	 }
	 catch(err)
	 {
		 console.log(err);
	 }
 }

*//**
 * Handles the events (click and mouseenter) of mail and log entities of 
 * tiemline 
 *//*
$(function () {
	
	 * Shows the mail details in detail on a popup modal, when '+'
	 * symbol is clicked 
	   
	$("#tl-mail-popover").live('click',function(e){
		e.preventDefault();
		
		var htmlstring = $(this).closest('div').attr("data");
		// var htmlstring = $(this).closest('div.text').html();
		// htmlstring = htmlstring.replace("icon-plus", "");

		$("#mail-in-detail").html("<div style='background:none;border:none;'>" + htmlstring + "</div>");
		
		$("#timelineMailModal").modal("show");
        
    });
	
	
	 * Shows the campaign log details on a popup modal
	  
	$("#tl-log-popover").live('click',function(e){
		e.preventDefault();
		
		var string = $(this).closest('div').attr("data");

		// Add div tag to the string to consider white spaces
		$("#log-in-detail").html("<div style='background:none;border:none;'>" + string + "</div>");
		
		$("#timelineLogModal").modal("show");
    });
	
	*//**
	 * Shows analytics popup modal with full details.
	 **//*
	$("#tl-analytics-popover").live('click',function(e){
		e.preventDefault();
		
		var string = $(this).closest('div.body').html();
		var pageViews = $(string).find('div.ellipsis-multi-line');

		$("#analytics-in-detail").html("<div'>" + $(pageViews).html() + "</div>");
		
		$("#timelineAnalyticsModal").modal("show");
	});
	
	
	 * Shows the list of mails(mail sent to) as popover, when mouse is entered on
	 * to address of the email
	   
	$("#tl-mail-to-popover").live('mouseenter',function(e){
		
		$(this).popover({
        	template:'<div class="popover"><div class="arrow"></div><div class="popover-inner" style="padding:1px;width:340px;border-radius:2px"><div class="popover-content"><p></p></div></div></div>'
        });
		
		var string = $(this).text();
		var html = new Handlebars.SafeString(string.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/,/g, ",</br>").replace("To:","To:</br>").replace("read more", ""));
		$(this).attr("data-content", html);
        $(this).popover('show');
    });
	
	// Resizes the item height and open close effect for timeline elements
	$('#timeline .item a.open-close').live("click", function(e){
		$(this).siblings('.body').slideToggle(function(){
			$('#timeline').isotope('reLayout');
		});
		$(this).parents('.post').toggleClass('closed');
		$('#expand-collapse-buttons a').removeClass('active');
		e.preventDefault();
	});
	
});*//**
 * Loads, minified jquery.raty plug-in to show stars to rate a contact in its  
 * detail view and highlights the (no.of) stars based on star_value of the contact.
 * 
 * @method starify 
 * @param {Object} el
 * 			html object of contact detail view
 */
function starify(el) {
    head.js(LIB_PATH + 'lib/jquery.raty.min.js', function(){
    	
    	var contact_model  =  App_Contacts.contactDetailView.model;
    	
    	// If contact update is not allowed then start rating does not allow user to change it
    	if(App_Contacts.contactDetailView.model.get('owner') && !canEditContact(App_Contacts.contactDetailView.model.get('owner').id))
    	{
    			$('#star', el).raty({
    			 'readOnly': true,
    			  score: App_Contacts.contactDetailView.model.get('star_value')
    			 });
    		 return;
    	}
    	
    	
    	// Set URL - is this required?
    	// contact_model.url = 'core/api/contacts';
    	
    	$('#star', el).raty({
    		
    		/**
    		 * When a star is clicked, the position of the star is set as star_value of
    		 * the contact and saved.    
    		 */
        	click: function(score, evt) {
        	         		
           		
        		App_Contacts.contactDetailView.model.set({'star_value': score}, {silent : true});
        		contact_model =  App_Contacts.contactDetailView.model.toJSON();
        		var new_model = new Backbone.Model();
        		new_model.url = 'core/api/contacts';
        		new_model.save(contact_model, {
        			success: function(model){
        			}
        		});

        	},
        	
        	/**
        	 * Highlights the stars based on star_value of the contact
        	 */
        	score: contact_model.get('star_value')
            
        });
    });
    
}

/**
 * Check whether there are any updates in the displaying contact.
 * If there are any updates, show the refresh contact button.
 */
function checkContactUpdated(){
	var contact_model  =  App_Contacts.contactDetailView.model;
	
	var contact_id = contact_model.id;
	var updated_time = contact_model.attributes.updated_time;

		queueGetRequest("contact_queue" + contact_id, "/core/api/contacts/" + contact_id + "/isUpdated?updated_time=" + updated_time, "", function success(data)
		{
			// If true show refresh contact button.
			if (data == 'true')
			{
				// Download
				var contact_details_model = Backbone.Model.extend({ 
					url : function(){
							return '/core/api/contacts/' + contact_id;
					}
				});
                
				var model = new contact_details_model();
				model.id = id;
				model.fetch({ success : function(data){
					
					var old_updated_time = contact_model.attributes.updated_time;
					
					var new_updated_time = model.attributes.updated_time;
					
					// Update Model
					if(old_updated_time != new_updated_time)
					{
						App_Contacts.contactDetailView.model.set(model);
//						$('#refresh_contact').hide();
					}

				    }
				});
				
				$('#refresh_contact').show();
			}
				
			
			
		}, function error(data)
		{
			// Error message is shown
			
		});
}

/**
 * Shows all the domain users names as ul drop down list 
 * to change the owner of a contact 
 */
function fill_owners(el, data, callback){
	var optionsTemplate = "<li><a class='contact-owner-list' data='{{id}}'>{{name}}</a></li>";
	if(company_util.isCompany())
		optionsTemplate = "<li><a class='company-owner-list' data='{{id}}'>{{name}}</a></li>";
	
    fillSelect('contact-detail-owner','/core/api/users', 'domainUsers', callback, optionsTemplate, true); 
}

/**
 * To show owner on change
 */
function show_owner(){
	$('.contact-owner-pic').css('visibility', 'visible');
	$('#contact-owner').css('display', 'inline-block');
}

/**
 * To download vcard
 */
function qr_load(){
	head.js(LIB_PATH + 'lib/downloadify.min.js', LIB_PATH + 'lib/swfobject.js',  function(){
		  Downloadify.create('downloadify',{
		    filename: function(){
		      return agile_crm_get_contact_property("first_name") + ".vcf";
		    },
		    data: function(){
		      return $('#qr_code').attr('data');
		    },
		    /*onComplete: function(){ 
		      alert('Your File Has Been Saved!'); 
		    },
		    onCancel: function(){ 
		      alert('You have cancelled the saving of this file.');
		    },*/
		    onError: function(){ 
		      alert('Error downloading a file!'); 
		    },
		    transparent: false,
		    swf: 'media/downloadify.swf',
		    downloadImage: 'img/download.png',
		    width: 36,
		    height: 30,
		    transparent: true,
		    append: false
		  });
		});
}

/**
 * To navigate from one contact detail view to other
 */
function contact_detail_view_navigation(id, contact_list_view, el){
	console.log("collection >>>>>>>>>>>>>>>>");
	console.log(contact_collection);
	var contact_collection = contact_list_view.collection;
	var collection_length = contact_collection.length;
    var current_index = contact_collection.indexOf(contact_collection.get(id));
    var previous_contact_id;
    var next_contact_id;
    //fetch next set so that next link will work further.
    if(collection_length <= current_index+5) {
    	contact_list_view.infiniScroll.fetchNext();
    }
    if (collection_length > 1 && current_index < collection_length && contact_collection.at(current_index + 1) && contact_collection.at(current_index + 1).has("id")) {
     
    	next_contact_id = contact_collection.at(current_index + 1).id
    }

    if (collection_length > 0 && current_index != 0 && contact_collection.at(current_index - 1) && contact_collection.at(current_index - 1).has("id")) {

    	previous_contact_id = contact_collection.at(current_index - 1).id
    }

    if(previous_contact_id != null)
    	$('.navigation', el).append('<a style="float:left;" href="#contact/' + previous_contact_id + '" class="" onclick="clearContactWidetQueues(' + id + ')"><i class="icon icon-chevron-left"></i></a>');
    if(next_contact_id != null)
    	$('.navigation', el).append('<a style="float:right;" href="#contact/'+ next_contact_id + '" class="" onclick="clearContactWidetQueues(' + id + ')"><i class="icon icon-chevron-right"></i></a>');
	
}


/**
* Clear all contact related widget queue requests
*/
function clearContactWidetQueues(contactId){

	if(!contactId || !document.ajaxq)
		  return;
		
	queueClear("_widgets_" + contactId);
	queueClear("widgets_" + contactId);
	queueClear("widget_queue_"+contactId);

}

$(function(){
   $('body').on('mouseenter', '.tooltip_info', function(e){
		 $(this).tooltip({
			 html : true
		 });
		 $(this).tooltip('show');
	});

   // Makes the score section unselectable, when clicked on it
	$('#score').children().attr('unselectable', 'on');
	
});

/**
*  Contact detailed view event listeners
*/
var Contact_Details_Model_Events = Base_Model_View.extend({
   
    events: {
    	'click #change-owner-element>#contact-owner' : 'onChangeOwner',
    	'click .contact-owner-list' : 'onChangeOwnerSelected',
    	'click #change-owner-element>.contact-owner-add' : 'onAddContactOwner',
    	'click #contact-actions-delete' : 'onContactDelete',
    	'click .remove-tags' : 'onRemoveContactTag',
    	'click #add-tags' : 'onAddContactTag',
    	'click #contact-add-tags' : 'onAddContactTags',
    	'click #disable_map_view' : 'onDisableMapView',
    	'click #enable_map_view' : 'onEnableMapView',
    	'click #add' : 'onAddScore',
    	'click #minus' : 'onRemoveScore',
    	'mouseenter #element': 'onElementPopover',
    	'mouseenter #element-title' : 'onElementTitlePopover',

    	
    	'click .email-subject' : 'onEmailSubjectClick',
    	'click #show-page-views' : 'openPageViews',
    	'click .remove-active-campaign' : 'onRemoveCampaigns',
    	'click #contactDetailsTab a[href="#timeline"]' : 'onTimeLineOpen',
    	'click #contactDetailsTab a[href="#notes"]' : 'openNotes',
    	'click #contactDetailsTab a[href="#events"]' : 'openEvents',
    	'click #contactDetailsTab a[href="#documents"]' : 'openDocuments',
    	'click #contactDetailsTab a[href="#tasks"]' : 'openTasks',
    	'click #contactDetailsTab a[href="#deals"]' : 'openDeals',
    	'click #contactDetailsTab a[href="#cases"]' : 'openCases',
    	'click #contactDetailsTab a[href="#mail"]' : 'openMails',
    	'click #contactDetailsTab a[href="#stats"]' : 'openWebStats',
    	'click #contactDetailsTab a[href="#campaigns"]' : 'openCampaigns',
    	'click .agile-emails' : 'openEmails',
    	'click #email-reply' : 'repltToEmails',
    	'click .activity-delete' : 'deleteActivity',
    	'click #action_refresh_contact' : 'reloadContact',

    	'click .contact-add-task' : 'addTask',
    	'click .contact-add-event' : 'addEvent',
    	'click .contact-add-note' : 'addNote',
    	'click .contact-add-campaign,.add-to-campaign' : 'addToCampaign',

    	'click .task-edit-contact-tab' : 'editTask',
    	'click .event-edit-contact-tab' : 'editEvent',
    	'click .complete-task' : 'completeTask',
    	'click .contact-add-deal' : 'addDeal',
    	'click .deal-edit-contact-tab' : 'editDeal',
    	'click .contact-add-case' : 'addCase',
    	'click .cases-edit-contact-tab' : 'editCase',
    	'click .contact-add-contact' : 'addContact',
    	'click .contact-add-document' : 'addDocument',
    	'click .document-edit-contact-tab' : 'editDocument',
    	'click .document-unlink-contact-tab' : 'unlinkDocument',
    	'click .add-document-select' : 'listDocuments',
    	'click .add-document-cancel' : 'cancelDocuments',
    	'click .add-document-confirm' : 'addSelectedDocument',

    	'click #contacts-inner-tabs #next' : 'tabViewNext',
    	'click #contacts-inner-tabs #prev' : 'tabViewPrev',

    	/** Company events **/
    	'click #contactDetailsTab a[href="#company-contacts"]' : 'listCompanyContacts',
    	'click #contactDetailsTab a[href="#company-deals"]' : 'listCompanyDeals',
    	'click #contactDetailsTab a[href="#company-cases"]' : 'listCompanyCases',
    	'click #contactDetailsTab a[href="#company-notes"]' : 'listCompanyNotes',
    	'click #contactDetailsTab a[href="#company-documents"]' : 'listCompanyDocuments',
    	'click #company-add-tags' : 'addCompanytags',
    	'keydown #companyAddTags' : 'companyAddTags',
    	'click #company-actions-delete' : 'companyDelete',
    	'click .company-owner-list' : 'companyOwnerList',
    	'click .remove-company-tags' : 'removeCmpanyTags',

    	'click #contact-actions-grid-delete' : 'contactActionsGridDelete',
    },


	contactActionsGridDelete: function(e){
		
		e.preventDefault();
		var contact_id=$(e.currentTarget).attr('con_id');
    	var model=App_Contacts.contactsListView.collection.get(contact_id);
		$('#deleteGridContactModal').modal('show');

		$('#deleteGridContactModal').on("shown.bs.modal", function(){

				// If Yes clicked
		   $('#deleteGridContactModal').on('click', '#delete_grid_contact_yes', function(e) {
				e.preventDefault();
				// Delete Contact.
				$.ajax({
    					url: 'core/api/contacts/' + contact_id,
       					type: 'DELETE',
       					success: function()
       					{
       						$('#deleteGridContactModal').modal('hide');
       						App_Contacts.contactsListView.collection.remove(model);
       						if(App_Contacts.contact_custom_view)
       						App_Contacts.contact_custom_view.collection.remove(model);
       						CONTACTS_HARD_RELOAD=true;
       						App_Contacts.contacts();
       					}
       				});
			});


		   $('#deleteGridContactModal').on('click', '#delete_grid_contact_no', function(e) {
				e.preventDefault();
				if($(this).attr('disabled'))
			   	     return;
				$('#deleteGridContactModal').modal('hide');
			});

		});

    		
	},

	/**
	 * Get the updated details of the contact and update the model.
	 */
	reloadContact :  function(e){
			var id =  App_Contacts.contactDetailView.model.id;
		var contact_details_model = Backbone.Model.extend({ url : function()
			{
				return '/core/api/contacts/' + this.id;
			} });

			var model = new contact_details_model();
			model.id = id;
			model.fetch({ success : function(data)
			{
				
				// Call Contact Details again
				App_Contacts.contactDetails(id, model);
				$('#refresh_contact').hide();

			} });
	},

   	/**
	 * Sets cookie when user changes email dropdown under mail tab. Cookie
	 * contains email server, email name from next time application loads from
	 * emails from this email server and email
	 */
	openEmails :  function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var email_server = $(targetEl).attr('email-server');
		var url = $(targetEl).attr('data-url');
		$('#email-type-select', App_Contacts.contactDetailView.el).html($(targetEl).html());
		// Here email_server_type means email/username of mail account
		email_server_type = $(targetEl).attr('email-server-type');
		if (email_server && url && (email_server != 'agile'))
			url = url.concat(email_server_type);

		var cookie_value = email_server_type + '|' + email_server;
		save_email_server_type_in_cookie(cookie_value);
		contact_details_tab.load_mail(url, email_server);
	},

	

    repltToEmails :  function(e)
			{
				e.preventDefault();
				Contact_Details_Tab_Actions.replyToEmail(e);
			},

	
	deleteActivity : function(e)
	{
		e.preventDefault();

		Contact_Details_Tab_Actions.deleteActivity(e);
	},


	/**
	 * Gets every conversation of the contact (if it has email) with the
	 * associated email (gmail or imap) in Email-preferences of this CRM, when
	 * "Mail" tab is clicked.
	 */
	openMails : function(e)
	{
		e.preventDefault();
		email_server_type = "agilecrm"
		save_contact_tab_position_in_cookie("mail");
		contact_details_tab.load_mail();
	},

	/**
	 * Gets the activities of a contact from browsing history, using its email.
	 * To do so the email should be run in analytics script provided by
	 * agileCRM.
	 */
	 openWebStats : function(e)
	{
		e.preventDefault();
		save_contact_tab_position_in_cookie("stats");
		contact_details_tab.load_stats();

	},

	/**
	 * Fetches all the logs of the campaigns that the contact is subscribed to
	 * and shows them in a table. Also shows a campaigns drop down list to
	 * subscribe the contact to the selected campaign.
	 */
	openCampaigns : function(e)
	{
		e.preventDefault();
		save_contact_tab_position_in_cookie("campaigns");
		contact_details_tab.load_campaigns();
	},


	/**
	 * Fetches all the deals related to the contact and shows the deals
	 * collection as a table in its tab-content, when "Deals" tab is clicked.
	 */
	openDeals : function(e)
	{
		e.preventDefault();
		save_contact_tab_position_in_cookie("deals");
		contact_details_tab.load_deals();
	},

	/**
	 * Fetches all the cases related to the contact and shows the collection.
	 */
	openCases :  function(e)
	{
		e.preventDefault();
		save_contact_tab_position_in_cookie("cases");

		contact_details_tab.load_cases();
	},

	/**
	 * Fetches all the notes related to the contact and shows the tasks
	 * collection as a table in its tab-content, when "Tasks" tab is clicked.
	 */
	openTasks :  function(e)
	{
		e.preventDefault();
		save_contact_tab_position_in_cookie("tasks");
		contact_details_tab.load_tasks();
	},


	/**
	 * Fetches all the documents related to the contact and shows the documents
	 * collection as a table in its tab-content, when "Documents" tab is
	 * clicked.
	 */
	openDocuments : function(e){
		e.preventDefault();
		save_contact_tab_position_in_cookie("documents");
		contact_details_tab.load_documents();
	},

	onTimeLineOpen : function(e){
		e.preventDefault();
		Contact_Details_Tab_Actions.openTimeLine(e);
	},
	onEmailSubjectClick : function(e){
		e.preventDefault();
		Contact_Details_Tab_Actions.onEmailSubjectClick(e);	
	},
	openPageViews : function(e){
		e.preventDefault();
		Contact_Details_Tab_Actions.showPageViews(e);	
	},
	onRemoveCampaigns : function(e){
		e.preventDefault();
		Contact_Details_Tab_Actions.removeActiveCampaigns(e);		

	},
	openNotes : function(e){
		e.preventDefault();
		Contact_Details_Tab_Actions.showNotes(e);	
	},
	openEvents : function(e){
		e.preventDefault();
		Contact_Details_Tab_Actions.showEvents(e);
	},

    // Change owner of the contact
    onChangeOwner : function(e){
         e.preventDefault();
         fill_owners(undefined, undefined, function(){

	    	$('#contact-owner').css('display', 'none');

	    	$('#change-owner-ul').css('display', 'inline-block');
	    	if($('#change-owner-element > #change-owner-ul').css('display') == 'inline-block')
	             $("#change-owner-element").find(".loading").remove();
		});
    },

    /**
	 * Changes, owner of the contact, when an option of change owner drop down
	 * is selected.   
	 */
    onChangeOwnerSelected : function(e){
      	e.preventDefault();
    	var targetEl = $(e.currentTarget);

    	$('#change-owner-ul').css('display', 'none');
		
		// Reads the owner id from the selected option
		var new_owner_id = $(targetEl).attr('data');
		var new_owner_name = $(targetEl).text();
		var current_owner_id = $('#contact-owner').attr('data');
		
		// Returns, if same owner is selected again 
		if(new_owner_id == current_owner_id)
			{
			  // Showing updated owner
			  show_owner();
			  return;
			}
		
		  var contactModel = new BaseModel();
		    contactModel.url = '/core/api/contacts/change-owner/' + new_owner_id + "/" + App_Contacts.contactDetailView.model.get('id');
		    contactModel.save(App_Contacts.contactDetailView.model.toJSON(), {success: function(model){

		    	// Replaces old owner details with changed one
				$('#contact-owner').text(new_owner_name);
				$('#contact-owner').attr('data', new_owner_id);
				
				// Showing updated owner
				show_owner(); 
				App_Contacts.contactDetailView.model = model;
				
		    }});
    	   
    },

    // Deletes a contact from database
    onContactDelete : function(e){

    	e.preventDefault();
		if(!confirm("Do you want to delete the contact?"))
    		return;
		
		App_Contacts.contactDetailView.model.url = "core/api/contacts/" + App_Contacts.contactDetailView.model.id;
		App_Contacts.contactDetailView.model.destroy({success: function(model, response) {
			  Backbone.history.navigate("contacts",{trigger: true});
		}});
    },

    /**
	 * Deletes a tag of a contact (removes the tag from the contact and saves the contact)
	 */ 
    onRemoveContactTag : function(e){

    	e.preventDefault();
    	var targetEl = $(e.currentTarget);

		var tag = $(targetEl).attr("tag");
		removeItemFromTimeline($("#" +  tag.replace(/ +/g, '') + '-tag-timeline-element', $('#timeline')).parent('.inner'))
		console.log($(targetEl).closest("li").parent('ul').append(getRandomLoadingImg()));
		
     	var json = App_Contacts.contactDetailView.model.toJSON();
     	
     	// Returns contact with deleted tag value
     	json = delete_contact_tag(json, tag);
     	var that = targetEl;
     	
     	// Unbinds click so user cannot select delete again
     	$(targetEl).unbind("click");
     	
        var contact = new Backbone.Model();
        contact.url = 'core/api/contacts';
        contact.save(json, {
       		success: function(data)
       			{ 	      		
       				$(that).closest("li").parent('ul').find('.loading').remove();
       				$(that).closest("li").remove();
       				
       			// Updates to both model and collection
	       			App_Contacts.contactDetailView.model.set(data.toJSON(), {silent : true});
	       			
	       		//	App_Contacts.contactDetailView.model.set({'tags' : data.get('tags')}, {silent : true}, {merge:false});
       				
       				// Also deletes from Tag class if no more contacts are found with this tag
       				$.ajax({
       					url: 'core/api/tags/' + tag,
       					type: 'DELETE',
       					success: function()
       					{
       						if(tagsCollection)
       							tagsCollection.remove(tagsCollection.where({'tag': tag})[0]);
       					}
       				});
       			}
        });
	
    },

    /**
	 * Shows a form to add tags with typeahead option
	 */ 
    onAddContactTag : function(e){
    	e.preventDefault();

		$(e.currentTarget).css("display", "none");
		$("#addTagsForm").css("display", "block");
		$("#addTags").focus();
		setup_tags_typeahead();
	
    },

    /**
	 * "click" event of add button of tags form in contact detail view
	 * Pushes the added tags into tags array attribute of the contact and saves it
	 */ 
	 onAddContactTags : function(e){
	 	e.preventDefault();
		
	    // Add Tags
		var new_tags = get_new_tags('addTags');
		if(new_tags)new_tags=new_tags.trim();
		
		if(!new_tags || new_tags.length<=0 || (/^\s*$/).test(new_tags))
		{
			console.log(new_tags);
			return;
		}
		if (!isValidTag(new_tags, true)) {
			return;
		}
		$('#add-tags').css("display", "block");
		$("#addTagsForm").css("display", "none");
		console.log(new_tags);
		
		if(new_tags) {
			var json = App_Contacts.contactDetailView.model.toJSON();
	    		
	    	
	    	// Reset form
	    	$('#addTagsForm input').each (function(){
   		  	  	$(e.currentTarget).val("");
   		  	});
	    	
	    	// Checks if tag already exists in contact
			if($.inArray(new_tags, json.tags) >= 0)
				return;
			acl_util.canAddTag(new_tags.toString(),function(respnse){
		    	json.tagsWithTime.push({"tag" : new_tags.toString()});
	   			
		    	// Save the contact with added tags
		    	var contact = new Backbone.Model();
		        contact.url = 'core/api/contacts';
		        contact.save(json,{
		       		success: function(data){
		       			
		       			addTagToTimelineDynamically(new_tags, data.get("tagsWithTime"));
		       			
		       			// Get all existing tags of the contact to compare with the added tags
		       			var old_tags = [];
		       			$.each($('#added-tags-ul').children(), function(index, element){
		       				old_tags.push($(element).attr('data'));
	       				});
		       			
		       			// Updates to both model and collection
		       			App_Contacts.contactDetailView.model.set(data.toJSON(), {silent : true});
		       			
		       			// Append to the list, when no match is found 
		       			if ($.inArray(new_tags, old_tags) == -1) 
		       				$('#added-tags-ul').append('<li  class="tag inline-block btn btn-xs btn-default m-r-xs m-b-xs" style="color:#363f44" data="' + new_tags + '"><span><a class="anchor m-r-xs custom-color" style="color:#363f44" href="#tags/'+ new_tags + '" >'+ new_tags + '</a><a class="close remove-tags" id="' + new_tags + '" tag="'+new_tags+'">&times</a></span></li>');
		       			
		       			console.log(new_tags);
		       			// Adds the added tags (if new) to tags collection
		       			tagsCollection.add(new BaseModel({"tag" : new_tags}));
		       		},
		       		error: function(model,response){
		       			console.log(response);
		       			alert(response.responseText);
		       		}
		        });
			});
		}
	 },

	 onAddContactOwner :  function(e){
         e.preventDefault();

    	fill_owners(undefined, undefined, function(){

        	$('.contact-owner-add').css('display', 'none');

        	$('#change-owner-ul').css('display', 'inline-block');
        	$('#change-owner-ul').addClass("open");
        	
        	if($('#change-owner-element > #change-owner-ul').css('display') == 'inline-block')
        		 $("#change-owner-element").find(".loading").remove();
    	});
    },

    onDisableMapView : function(e){
		e.preventDefault();
		if(islocalStorageHasSpace()){
			localStorage.setItem('MAP_VIEW','disabled');
		}
		$("#map").css('display', 'none');
		$("#contacts-local-time").hide();
		$("#map_view_action").html("<i class='icon-plus text-sm c-p' title='Show map' id='enable_map_view'></i>");
		
    },

	onEnableMapView :  function(e){
		e.preventDefault();
		if(islocalStorageHasSpace()){
			localStorage.setItem('MAP_VIEW','enabled');
		}
		if(company_util.isCompany())
			company_util.show_map();
		else
			show_map();
		
		
	},

	/**
	 * Adds score to a contact (both in UI and back end)
	 * When '+' symbol is clicked in contact detail view score section, the score
	 * gets increased by one, both in UI and back end
	 * 
	 */  
	onAddScore :  function(e){
	    e.preventDefault();
	    
	    // Convert string type to int
	    var add_score = parseInt($('#lead-score').text());
	    
	    add_score = add_score + 1;
	    
	    // Changes score in UI
	    $('#lead-score').text(add_score);
       
	    App_Contacts.contactDetailView.model.set({'lead_score': add_score}, {silent: true});
		var contact_model =  App_Contacts.contactDetailView.model.toJSON();
	    
	  /* // Refreshing the view ({silent: true} not working)
	    contact_model.url = 'core/api/contacts';
	    contact_model.set('lead_score', add_score, {silent: true});
	
	    // Save model
	    contact_model.save();*/
	    
		var new_model = new Backbone.Model();
		new_model.url = 'core/api/contacts';
		new_model.save(contact_model,{
			success: function(model){

			}
		});
		          
	},
	
	   
	/**
	 * Subtracts score of a contact (both in UI and back end)
	 * When '-' symbol is clicked in contact detail view score section, the score
	 * gets decreased by one, both in UI and back end
	 * 
	 */
	onRemoveScore :  function(e){
		e.preventDefault();
		
		// Converts string type to Int
		var sub_score = parseInt($('#lead-score').text());
		
		if(sub_score <= 0)
			return;
		
		sub_score = sub_score - 1;
		
		// Changes score in UI
		$('#lead-score').text(sub_score);
		
		// Changes lead_score of the contact and save it.
		App_Contacts.contactDetailView.model.set({'lead_score': sub_score}, {silent: true});
		var contact_model =  App_Contacts.contactDetailView.model.toJSON();
		
		var new_model = new Backbone.Model();
		new_model.url = 'core/api/contacts';
		new_model.save(contact_model,{
			success: function(model){

			}
		});
	},
	
	
	// Popover for help in contacts,tasks etc
	onElementPopover :  function(e){
    	e.preventDefault();
        $(e.currentTarget).popover({
        	template:'<div class="popover" style="width:400px"><div class="arrow"></div><div class="popover-inner"><div class="popover-content"><p></p></div></div></div>'
        });
        $(e.currentTarget).popover('show');
    },
	onElementTitlePopover : function(e){
    	e.preventDefault();
        $(e.currentTarget).popover('show');
    },

    addTask : function(e){
    	e.preventDefault();
        contact_detail_tab_actions.add_task(e);
    },
    addEvent : function(e){
    	e.preventDefault();
        contact_detail_tab_actions.add_event(e);
    }, 
    addNote :  function(e){
    	e.preventDefault();
         contact_detail_tab_actions.add_note(e);       
    }, 
    addToCampaign :  function(e){
    	e.preventDefault();
         contact_detail_tab_actions.add_to_campaign(e);
    }, 

    editTask : function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.edit_task(e);
	},

	editEvent : function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.edit_event(e);
		
	},

	completeTask :  function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.complete_task(e);
		
	},
	
	addDeal : function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.add_deal(e);

	},

	// For updating a deal from contact-details
	editDeal :  function(e)
	{
		e.preventDefault();
		var id = $(e.currentTarget).attr('data');
		updateDeal(dealsView.collection.get(id));
	},

	// For Adding new case from contacts/cases
	addCase :  function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.add_case(e);
	},

	// For updating a case from contact-details
	editCase : function(e)
	{
		e.preventDefault();
		var id = $(e.currentTarget).attr('data');
		updatecases(casesView.collection.get(id));
	},

	// Adding contact when user clicks Add contact button under Contacts tab in
	// Company Page
	addContact : function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.add_contact(e);
		
	},

	// For adding new document from contact-details
	addDocument :  function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.add_document(e);
	},

	// For updating document from contact-details
	editDocument : function(e)
	{
		e.preventDefault();
		var id = $(e.currentTarget).attr('data');
		updateDocument(documentsView.collection.get(id));
	},

	// For unlinking document from contact-details
	unlinkDocument :  function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.document_unlink(e);
		
	},

	/**
	 * For showing new/existing documents
	 */
	listDocuments :  function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.show_document_list(e);
	},

	/**
	 * To cancel the add documents request
	 */
	cancelDocuments :  function(e)
	{
		e.preventDefault();
		var el = $("#documents");
		el.find(".contact-document-select").css("display", "none");
		el.find(".add-document-select").css("display", "inline-block");
	},

	/**
	 * For adding existing document to current contact
	 */
	addSelectedDocument : function(e)
	{
		e.preventDefault();
		contact_details_documentandtasks_actions.add_selected_document(e);

	},

	tabViewNext :  function(e){
	  console.log("next clicked");
	    var target = $("#contactDetailsTab");
	    target.animate({ scrollLeft : (target.scrollLeft() + 270)},1000);
	  },
	  
	  tabViewPrev :  function(e){
		   console.log("prev clicked");
	    var target = $("#contactDetailsTab");
	    target.animate({ scrollLeft : (target.scrollLeft() - 270)},1000);
	  },

	  listCompanyContacts :  function(e)
	{
		e.preventDefault();
		fill_company_related_contacts(App_Companies.companyDetailView.model.id, 'company-contacts');
	},

	/**
	 * Fetches all the deals related to the contact and shows the deals
	 * collection as a table in its tab-content, when "Deals" tab is clicked.
	 */
	listCompanyDeals : function(e)
	{
		e.preventDefault();
		save_contact_tab_position_in_cookie("deals");
		company_detail_tab.load_company_deals();
	},

	/**
	 * Fetches all the cases related to the contact and shows the collection.
	 */
	listCompanyCases :  function(e)
	{
		e.preventDefault();
		save_contact_tab_position_in_cookie("cases");

		company_detail_tab.load_company_cases();
	},
		
	/**
	 * Fetches all the notes related to the contact and shows the notes
	 * collection as a table in its tab-content, when "Notes" tab is clicked.
	 */
	listCompanyNotes :  function(e)
	{
		e.preventDefault();
		save_contact_tab_position_in_cookie("notes");
		company_detail_tab.load_company_notes();
	},
	
	/**
	 * Fetches all the documents related to the contact and shows the documents
	 * collection as a table in its tab-content, when "Documents" tab is
	 * clicked.
	 */
	listCompanyDocuments : function(e)
	{
		e.preventDefault();
		save_contact_tab_position_in_cookie("documents");
		company_detail_tab.load_company_documents();
	},
	
	/**
	 * "click" event of add button of tags form in contact detail view
	 * Pushes the added tags into tags array attribute of the contact and saves it
	 */ 
	addCompanytags :  function(e)
	{	e.preventDefault();
		
	   company_detail_tab.addTagsToCompany();
	},
	
	companyAddTags : function(e) {
	 	if(e.which == 13 && !isTagsTypeaheadActive){
    		company_detail_tab.addTagsToCompany();
    		}
    	},
	
	// Deletes a contact from database
	companyDelete :  function(e)
	{	
		e.preventDefault();
		company_detail_tab.deleteCurrentCompany();
	},
	
	/**
	 * Changes, owner of the contact, when an option of change owner drop down
	 * is selected.   
	 */
	companyOwnerList :  function(e){
		var targetEl = $(e.currentTarget);

		$('#change-owner-ul').css('display', 'none');
		
		company_detail_tab.changeOwner($(targetEl));
	},
	
	/**
	 * Deletes a tag of a contact (removes the tag from the contact and saves the contact)
	 */ 
	removeCmpanyTags :  function(e){
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var tag = $(targetEl).attr("tag");
		//removeItemFromTimeline($("#" +  tag.replace(/ +/g, '') + '-tag-timeline-element', $('#timeline')).parent('.inner'))
		console.log($(targetEl).closest("li").parent('ul').append(getRandomLoadingImg()));
		
     	var json = App_Companies.companyDetailView.model.toJSON();
     	
     	// Returns contact with deleted tag value
     	json = delete_contact_tag(json, tag);
     	var that = targetEl;
     	
     	// Unbinds click so user cannot select delete again
     	$(targetEl).unbind("click");
     	
        var contact = new Backbone.Model();
        contact.url = 'core/api/contacts';
        contact.save(json, {
       		success: function(data)
       			{ 	      		
       				$(that).closest("li").parent('ul').find('.loading').remove();
       				$(that).closest("li").remove();
       				
       			// Updates to both model and collection
       				App_Companies.companyDetailView.model.set(data.toJSON(), {silent : true});
	       			
	       		//	App_Contacts.contactDetailView.model.set({'tags' : data.get('tags')}, {silent : true}, {merge:false});
       				
       				// Also deletes from Tag class if no more contacts are found with this tag
       				$.ajax({
       					url: 'core/api/tags/' + tag,
       					type: 'DELETE',
       					success: function()
       					{
       						if(tagsCollection)
       							tagsCollection.remove(tagsCollection.where({'tag': tag})[0]);
       					}
       				});
       			}
        });
	},
});/**
 * Shows error text, providing support for custom validation. Shows error
 * message in .errorClass, filling it with htmlText
 * 
 * @param modalId -
 *            id of modal, won't be used if modal hidden
 * @param formId -
 *            id of form,
 * @param htmlText -
 *            error message to display
 * @param errorClass -
 *            class in which to fill error text, i.e. htmlText
 */
function show_error(modalId, formId, errorClass, htmlText)
{
	var modal_elem = $('#' + modalId);
	var form_elem = $('#' + formId);

	if (modal_elem.css('display') !== 'none')
	{
		modal_elem.find('.' + errorClass).html(
				'<div class="alert alert-danger m-b-none" ><a class="close" data-dismiss="alert" href="#">&times</a>' + htmlText + '</div>').show();
	}
	else if (form_elem.css('display') !== 'none')
	{
		form_elem.find('.' + errorClass).html(
				'<div class="alert alert-danger m-b-none" ><a class="close" data-dismiss="alert" href="#">&times</a>' + htmlText + '</div>').show();
	}
}

function show_error_in_formactions(modalId, formId, errorClass, htmlText)
{
	var modal_elem = $('#' + modalId);
	var form_elem = $('#' + formId);

	// Show cause of error in saving
	var save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>' + htmlText + '</i></p></small></div>');

	// Hides the error message after 3
	// seconds

	if (modal_elem.css('display') !== 'none')
	{
		modal_elem.find('.' + errorClass).html(save_info).show().delay(3000).hide(1);
	}
	else if (form_elem.css('display') !== 'none')
	{
		form_elem.find('.' + errorClass).html(save_info).show().delay(3000).hide(1);
	}
}

/**
 * Serializes both contact (person or company) modal form (with basic
 * information) and its continue editing form (with detailed information) and
 * saves the serialized data into Contacts data base.
 * <p>
 * Each field (except tags field) value of the form is created as json object
 * (with name, type and value attributes) and pushed into "properties" array, if
 * any tags are exist, pushes them into tags array. Finally the object with
 * properties and tags is sent to save.
 * </p>
 * 
 * @method serialize_and_save_continue_contact
 * @param {Object}
 *            e default event to prevent
 * @param {String}
 *            form_id form to serialize the data
 * @param {String}
 *            modal_id modal to hide on save
 * @param {Boolean}
 *            continueContact verifies to show continue editing form
 * @param {Boolean}
 *            is_person verifies whether person or company
 * @param {String}
 *            id within which to search for tags, if ignored tags will be
 *            searched in form_id
 * @returns object get saved
 */
function serialize_and_save_continue_contact(e, form_id, modal_id, continueContact, is_person, saveBtn, tagsSourceId)
{

	// Prevents the default event, if any
	e.preventDefault();

	var $form = $('#' + form_id);

	// Returns, if the save button has disabled attribute, or form is invalid
	if ($(saveBtn).attr('disabled') || !isValidForm($form))
	{
		var ele = $(saveBtn).closest('form').find('.single-error').first();
		var container = $form;
		$('body').scrollTop(ele.offset().top - container.offset().top + container.scrollTop());
		return;
	}
	// Disables save button to prevent multiple click event issues
	disable_save_button($(saveBtn));

	// Read multiple values from contact form
	var properties = [];

	// Reads id, to update the contact
	var id = $('#' + form_id + ' input[name=id]').val();

	// Makes created time constant
	var created_time = $('#' + form_id + ' input[name=created_time]').val();

	// Object to save
	var obj = {};

	// Stores all the property objects
	var properties = [];

	// Contact should be fetched based on id from any of the following views. It
	// is required so other properties saved are not lost.
	if (id)
	{

		// If user refreshes in contact details page, then none of the list
		// views are defined so, contact will be fetched from detailed view
		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model != null && App_Contacts.contactDetailView.model.get('id') == id)
			obj = App_Contacts.contactDetailView.model.toJSON();

		// If contact list view is defined, then contact is fetched from list.
		else if (App_Contacts.contactsListView && App_Contacts.contactsListView.collection.get(id) != null)
			obj = App_Contacts.contactsListView.collection.get(id).toJSON();

		// If contact list is under a selected custom view, then contact is
		// fetched from the custom view list.
		else if (App_Contacts.contact_custom_view && App_Contacts.contact_custom_view.collection.get(id) != null)
			obj = App_Contacts.contact_custom_view.collection.get(id).toJSON();

	}
	
	if (company_util.isCompany() && id)
	{


		// If user refreshes in company details page, then none of the list
		// views are defined so, company will be fetched from detailed view
		if (App_Companies.companyDetailView && App_Companies.companyDetailView.model != null && App_Companies.companyDetailView.model.get('id') == id)
			obj = App_Companies.companyDetailView.model.toJSON();


		// If company list view is defined, then company is fetched from list.
		else if (App_Companies.companiesListView && App_Companies.companiesListView.collection.get(id) != null)
			obj = App_Companies.companiesListView.collection.get(id).toJSON();

	}

	// Loads continue editing form
	var template;

	// Reads custom fields and pushes into properties
	var custom_field_elements = $('#' + form_id).find('.custom_field');
	var custom_fields_in_template = [];

	$.each(custom_field_elements, function(index, element)
	{
		var id = $(element).attr('id'), name = $(element).attr('name');
		custom_fields_in_template.push(name);
		if (isValidField(id))
			properties.push(custom_Property_JSON(name, 'CUSTOM', form_id));
	});

	if (is_person)
	{

		// Stores person's continue editing form template key
		template = 'continue-contact';
		obj.type = 'PERSON';

		// Creates properties of contact (person)
		if (isValidField(form_id + ' #fname'))
			properties.push(property_JSON('first_name', form_id + ' #fname'));

		if (isValidField(form_id + ' #lname'))
			properties.push(property_JSON('last_name', form_id + ' #lname'));

		// Add profile_img from both forms.
		// if(form_id == "personForm")
		if (isValidField(form_id + ' #image'))
			properties.push(property_JSON('image', form_id + ' #image'));

		// /give preference to autofilled company, ignore any text in textfield
		// for filling company name
		var company_el = $("#" + form_id + " [name='contact_company_id']").find('li');
		if (company_el && company_el.length)
		{
			var company_id = $(company_el.get(0)).attr('data');
			var company_name = $(company_el.get(0)).find('a:first').text();

			obj.contact_company_id = company_id;
			properties.push({ type : "SYSTEM", name : "company", value : company_name });
		}
		else if (isValidField(form_id + ' #contact_company'))
		{
			if ($form.find('#contact_company').prop('value').length > 100)
			{
				show_error(modal_id, form_id, 'duplicate-email', 'Company name too long. Please restrict upto 100 characters.');
				enable_save_button($(saveBtn));// Remove loading image
				return;
			}
			obj.contact_company_id = null;
			properties.push(property_JSON('company', form_id + ' #contact_company'));
		}
		else
			obj.contact_company_id = null;

		if (isValidField(form_id + ' #email'))
			properties.push(property_JSON('email', form_id + ' #email'));

		if (isValidField(form_id + ' #phone'))
			properties.push(property_JSON('phone', form_id + ' #phone'));

		if (isValidField(form_id + ' #job_title'))
			properties.push(property_JSON('title', form_id + ' #job_title'));

		if (tagsSourceId === undefined || !tagsSourceId || tagsSourceId.length <= 0)
			tagsSourceId = form_id;

		var tags = get_tags(tagsSourceId);

		if (tags != undefined && tags.length != 0)
		{
			obj.tags = [];

			var tags_valid = true;
			if (!obj['tagsWithTime'] || obj['tagsWithTime'].length == 0)
			{
				$.each(tags[0].value, function(index, value)
				{
					if (!isValidTag(value, false))
					{
						tags_valid = false;
						return false;
					}
				});
				obj['tagsWithTime'] = [];
				$.each(tags[0].value, function(index, value)
				{
					obj.tagsWithTime.push({ "tag" : value });
				});
			}
			else
			{
				var tag_objects_temp = [];
				$.each(tags[0].value, function(index, value)
				{
					var is_new = true;
					$.each(obj['tagsWithTime'], function(index, tagObject)
					{
						if (value == tagObject.tag)
						{
							tag_objects_temp.push(tagObject);
							is_new = false
							return false;
						}
					});

					if (is_new)
					{
						tag_objects_temp.push({ "tag" : value });
						// check if tags are valid if they are newly adding to
						// the contact.
						if (!isValidTag(value, false))
						{
							tags_valid = false;
							return false;
						}
					}
				});
				obj['tagsWithTime'] = tag_objects_temp;
			}
			if (!tags_valid)
			{
				$('.invalid-tags-person').show().delay(6000).hide(1);
				enable_save_button($(saveBtn));
				return false;
			}
		}

	}
	else
	{

		// Stores company's continue editing form template key
		template = 'continue-company';
		obj.type = 'COMPANY';
		// Creates properties of contact (company)

		if (isValidField('company_name'))
		{
			var companyName = $form.find('#company_name').prop('value');
			if (companyName.length > 100)
			{
				// Company name too long, show error and return;
				show_error(modal_id, form_id, 'duplicate-email', 'Company name too long. Please restrict upto 100 characters.');

				enable_save_button($(saveBtn));// Remove loading image
				return;
			}
			if (!id)
			{
				var status = isCompanyExist(companyName);
				if (status)
				{
					show_error(modal_id, form_id, 'duplicate-email', 'Company name already exist.');

					enable_save_button($(saveBtn));// Remove loading image
					return;
				}
				else
				{
					properties.push(property_JSON('name', form_id + ' #company_name'));
				}
			}
			else
			{
				properties.push(property_JSON('name', form_id + ' #company_name'));
			}
		}

		if (isValidField(form_id + ' #company_url'))
			properties.push(property_JSON('url', form_id + ' #company_url'));
		
		if (tagsSourceId === undefined || !tagsSourceId || tagsSourceId.length <= 0)
			tagsSourceId = form_id;

		var tags = get_tags(tagsSourceId);
		if (tags != undefined && tags.length != 0)
		{
			obj.tags = [];

			var tags_valid = true;
			if (!obj['tagsWithTime'] || obj['tagsWithTime'].length == 0)
			{
				$.each(tags[0].value, function(index, value)
				{
					if(!isValidTag(value, false)) {
						tags_valid = false;
						return false;
					}
				});
				obj['tagsWithTime'] = [];
				$.each(tags[0].value, function(index, value)
				{
					obj.tagsWithTime.push({ "tag" : value });
				});
			}
			else
			{
				var tag_objects_temp = [];
				$.each(tags[0].value, function(index, value)
				{
					var is_new = true;
					$.each(obj['tagsWithTime'], function(index, tagObject)
					{
						if (value == tagObject.tag)
						{
							tag_objects_temp.push(tagObject);
							is_new = false
							return false;
						}
					});

					if (is_new) {
						tag_objects_temp.push({ "tag" : value });
						//check if tags are valid if they are newly adding to the contact.
						if(!isValidTag(value, false)) {
							tags_valid = false;
							return false;
						}
					}
				});
				obj['tagsWithTime'] = tag_objects_temp;
			}
			if(!tags_valid) {
				$('.invalid-tags-person').show().delay(6000).hide(1);
				enable_save_button($(saveBtn));
				return false;
			}
		}
	}

	/*
	 * Reads the values of multiple-template fields from continue editing form
	 * of both person and company and pushes into properties
	 */
	$('#' + form_id + ' div.multiple-template').each(function(index, element)
	{

		/*
		 * Reads each field (city, state, country and etc..) as a json object
		 * and pushes into 'addressJSON' and then it is pushed into properties.
		 */
		if ($(element).attr('data') == 'address')
		{
			var addressJSON = {};
			var subtype;
			$.each($(element).find(":input,select"), function(index, subelement)
			{

				if ($(subelement).val() == undefined || $(subelement).val().length == 0)
					return;

				if ($(subelement).attr('name') == 'address-type')
					subtype = $(subelement).val();
				else
					addressJSON[$(subelement).attr('name')] = $(subelement).val();
			});

			if ($.isEmptyObject(addressJSON))
				return;

			properties.push({ "name" : $(element).attr('data'), "value" : JSON.stringify(addressJSON), "subtype" : subtype })
		}
		else
		{
			var inputElement = $(element).find('input');
			var selectElement = $(element).find('select');

			// If element has no value, don't push into properties
			if (inputElement.val() == undefined || inputElement.val().trim().length == 0)
				return;

			// Checks whether fields for hidden fields (Used for clone do not
			// save them)
			if (!$(element).find('input').parents('div.controls').hasClass('hide'))
				properties.push({ "name" : $(element).attr('data'), "value" : inputElement.val(), "subtype" : selectElement.val() })
		}
	});

	/*
	 * Check whether there are any properties in existing contact, which can get
	 * lost in contact update form. There are chances user adds a property(may
	 * be stripe id..) using developers API, in order not to loose them
	 * following verification is done
	 */

	if (obj.properties)
	{
		var properties_temp = properties;
		$
				.each(obj.properties,
						function(contact_property_index, contact_property)
						{
							$
									.each(properties_temp,
											function(new_property_index, new_property)
											{

												// If property name exists in
												// new property, no changes are
												// made considering property is
												// updated.
												if (new_property.name == contact_property.name)
												{

													return false;
												}

												// If property name is missing
												// in new properties then
												// preserving them.
												else if (new_property_index == (properties_temp.length - 1) && custom_fields_in_template
														.indexOf(contact_property.name) == -1 && contact_property.type == "CUSTOM")
												{
													properties.push(contact_property);
												}
											});
						});
	}

	// Stores json object with "properties" as value
	var propertiesList = [];
	propertiesList.push({ "name" : "properties", "value" : properties });

	// Convert array into JSON
	for (var i = 0; i < propertiesList.length; ++i)
	{
		obj[propertiesList[i].name] = propertiesList[i].value;
	}

	// Updates the old contact
	if (id != null)
		obj['id'] = id;


	obj["created_time"] = created_time;

	// Saves contact
	var contactModel = new BaseModel();
	contactModel.url = 'core/api/contacts';
	contactModel.save(obj, { success : function(data)
	{

		// Remove social search results from local storage after editing a
		// contact
		localStorage.removeItem("Agile_linkedin_matches_" + data.get('id'));
		localStorage.removeItem("Agile_twitter_matches_" + data.get('id'));

		// Removes disabled attribute of save button
		enable_save_button($(saveBtn));

		if(is_person)
			add_contact_to_view(App_Contacts.contactsListView, data, obj.id);
		else
			add_contact_to_view(App_Companies.companiesListView, data, obj.id);

		// Adds the tags to tags collection
		if (tags != undefined && tags.length != 0)
		{
			$.each(tags[0].value, function(index, tag)
			{
				console.log(tagsCollection);
				tagsCollection.add(new BaseModel({ "tag" : tag }));
			});
		}

		// Removes person image form new-person-modal
		$('#' + modal_id).find('img.person-img').remove();

		// Loads continue editing form along with custom fields if any
		if (continueContact)
		{

			add_custom_fields_to_form(data.toJSON(), function(contact)
			{
				console.log(contact);
				deserialize_contact(contact, template);

			}, data.toJSON()["type"]);

		}
		else
		{
			if(is_person){
				// update contacts-details view
				if (App_Contacts.contactDetailView)
								App_Contacts.contactDetailView.model = data;

				// App_Contacts.contactDetails(data.id,data);
				// App_Contacts.navigate("contact/"+data.id);
				if(!CALL_CAMPAIGN.start)
				App_Contacts.navigate("contact/" + data.id, { trigger : true });
			} else {
				// update contacts-details view
				if (App_Companies.companyDetailView)
					App_Companies.companyDetailView.model = data;

				App_Companies.navigate("company/" + data.id, { trigger : true });
			}
		}

		// Hides the modal
		$('#' + modal_id).modal('hide');

		// Resets each element
		$('#' + form_id).each(function()
		{
			this.reset();
		});

		// Removes tags list(remove them from new person modal)
		$('.tagsinput', $("#" + modal_id)).empty();
		//added for call campaign - functionality after updating fom call campaign
			if(CALL_CAMPAIGN.start ){
				var id = $('#continueform input[name=id]').val();
				if(CALL_CAMPAIGN.contact_update){
					CALL_CAMPAIGN.current_count = CALL_CAMPAIGN.current_count - 1;
					CALL_CAMPAIGN.contact_update = false;
					dialNextCallAutomatically();
					Backbone.history.loadUrl("contact/" + id);
					$( window ).scrollTop( 0 );
					return;
				}else{
					var currentCampaignId = CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count];
					if(id == currentCampaignId ){
						CALL_CAMPAIGN.current_count = CALL_CAMPAIGN.current_count-1;
						dialNextCallAutomatically();
					}
					
				}
				
				Backbone.history.navigate("contact/" + id, { trigger : true });	
				$( window ).scrollTop( 0 );
				
				
			}
	}, error : function(model, response)
	{

		// Removes disabled attribute of save button
		enable_save_button($(saveBtn));

		// Shows error alert of duplicate contacts
		if (response.status == 400)
		{
			// 400 is our custom code, thrown when duplicate email detected.
			var dupEmail = response.responseText.split('|')[1];
			if (!dupEmail)
				dupEmail = "";
			// get the already existing email from response text.
			show_error(modal_id, form_id, 'duplicate-email', response.responseText);
		}
		else if (response.status == 403)
		{
			if(form_id == 'companyForm')
				show_error_in_formactions(modal_id, form_id, 'form-action-error', "You do not have permission to create Companies.");
			else if(form_id == 'continueCompanyForm')
				show_error_in_formactions(modal_id, form_id, 'form-action-error', "You do not have permission to update Companies.");
			else
				show_error_in_formactions(modal_id, form_id, 'form-action-error', response.responseText);
		}
		else
			show_error(modal_id, form_id, 'duplicate-email', response.responseText);
	} });

	return obj;

}

/**
 * Deserializes the contact to edit it. Loads the editing form using handlebars.
 * Fills the matched values, by iterating the properties.
 * 
 * @param {Object}
 *            contact contact object to edit
 * @param {String}
 *            template template key to load the form
 */
function deserialize_contact(contact, template)
{

	// Loads the form based on template value
	getTemplate(template, contact, undefined, function(template_ui){
		if(!template_ui)
			  return;
			
		var form = $('#content').html($(template_ui));	
		// Add placeholder and date picker to date custom fields
		$('.date_input').attr("placeholder", "Select Date");

		$('.date_input').datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY});

		// To set typeahead for tags
		setup_tags_typeahead();

		// Iterates through properties and ui clones
		$.each(contact.properties, function(index, element)
		{

			if (element.type == "CUSTOM" && element.name != "website")
				return;
			// Removes first input field
			$($('#' + form.attr('id') + ' div.multiple-template.' + element.name).closest('div.controls.second')).remove();
			var field_element = $('#' + form.attr('id') + ' div.multiple-template.' + element.name);

			// Generate and populate multiple fields
			fill_multi_options(field_element, element);
		});

		var fxn_display_company = function(data, item)
		{
			$("#content [name='contact_company_id']")
					.html(
							'<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="' + data + '"><span><a class="text-white m-r-xs" href="#contact/' + data + '">' + item + '</a><a class="close" id="remove_tag">&times</a></span></li>');
			$("#content #contact_company").hide();
		}
		agile_type_ahead("contact_company", $('#content'), contacts_typeahead, fxn_display_company, 'type=COMPANY', '<b>No Results</b> <br/> Will add a new one');

		if (contact.contact_company_id && contact.contact_company_id.length > 0)
		{
			for (var i = 0; i < contact.properties.length; ++i)
			{
				if (contact.properties[i].name == 'company')
				{
					$("#content #contact_company").hide();
					$("#content [name='contact_company_id']")
							.html(
									'<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="' + contact.contact_company_id + '"><span><a class="text-white m-r-xs" href="#contact/' + contact.contact_company_id + '">' + contact.properties[i].value + '</a><a class="close" id="remove_tag">&times</a></span></li>');
				}
			}
		}

		// If contact is added from social suite, need to add website.
		// socialsuite_add_website();

	}, "#content");

	
	
}

/**
 * Generates new field for each value in properties (especially for email, phone
 * and website)
 * 
 * @method fill_multi_options
 * @param {Object}
 *            field_element Html element having property name as class name
 * @param {Object}
 *            element property object
 * 
 */
function fill_multi_options(field_element, element)
{

	if (element.type == "CUSTOM" && element.name != "website")
		return;

	// Fills address fields
	if (element.name == 'address')
	{
		var json = JSON.parse(element.value);

		$.each($(field_element).find(":input,select"), function(index, sub_field_element)
		{
			var name = $(sub_field_element).attr('name');
			if (name == 'address-type')
				$(sub_field_element).val(element.subtype);
			else if (name == 'country')
			{
				if (json[name] && json[name].length > 2)
				{
					$("#country").remove();
					$(field_element).append('<input type="text" name="country" id="country" class="form-control m-b-sm" placeholder="country">');
					$("#country").val(json[name]);
				}
				else
					$(sub_field_element).val(json[name]);
			}
			else
				$(sub_field_element).val(json[name]);
		});
	}
	else
	{

		/*
		 * Fills other multiple-template fields (email, phone and website)
		 * Clones the fields into control-group and fills with associated values
		 */
		var append_to = $(field_element).parents('div.control-group');

		var html_element = append_to.children().siblings("div.controls:first").clone().removeClass('hide');

		$(html_element).find('input').val(element.value).attr('name', element.value);
		$(html_element).find('select').val(element.subtype);

		html_element.appendTo(append_to);
	}
}

/**
 * Creates json object for each custom field in contact form with name, type and
 * value as attributes.
 * 
 * @method custom_Property_JSON
 * @param name
 *            name of the field
 * @param form_id
 *            id of the form
 * @param type
 *            type of the element
 * @returns property json object
 */
function custom_Property_JSON(name, type, form_id)
{
	var json = {};

	// assign value after checking type, its different for checkbox
	json.name = name;
	json.type = type;

	var elem = $('#' + form_id).find('*[name="' + name + '"]');

	var elem_type = elem.attr('type'), elem_value;

	console.log(elem_type);


	if (elem_type == 'checkbox')
		elem_value = elem.is(':checked') ? 'on' : 'off';
	else if (elem.hasClass("date_input"))
		{
			if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
				elem_value = new Date(convertDateFromUKtoUS(elem.val())).getTime() / 1000;
			else
				elem_value = new Date(elem.val()).getTime() / 1000;
		}
		else
			elem_value = elem.val();


	json.value = elem_value;

	return json;
}

// UI Handlers for Continue-contact and continue-company
$(function()
{

	$('body').on('click', '#content [name="contact_company_id"] a.close', function(e)
	{
		$("#content #contact_company").show();
		$("#content [name='contact_company_id']").html('');
	})

	// Clones multiple fields
	$('body').on('click', 'a.multiple-add', function(e)
	{
		e.preventDefault();

		// Clone the template
		$(this).parents("div.control-group").append($(this).parents().siblings("div.controls:first").clone().removeClass('hide'));
	});

	// Removes multiple fields
	$('body').on('click', 'a.multiple-remove', function(e)
	{
		e.preventDefault();

		// Get closest template and remove from the container
		$(this).closest("div.multiple-template").remove();
	});

	// Continue editing of new-person-modal
	$('#continue-contact').click(function(e)
	{
		serialize_and_save_continue_contact(e, 'personForm', 'personModal', true, true, this, 'tags_source_person_modal');
	});

	// Update button click event in continue-contact form
	$('body').on('click', '#update', function(e)
	{
		serialize_and_save_continue_contact(e, 'continueform', 'personModal', false, true, this, "tags_source_continue_contact");
	});

	// Close button click event in continue-contact form
	$('body').on('click', '#close', function(e)
	{
		e.preventDefault();
		var id = $('#continueform input[name=id]').val();
		//added for call campaign - functionality after updating fom call campaign
		if(CALL_CAMPAIGN.start && CALL_CAMPAIGN.contact_update){
			CALL_CAMPAIGN.contact_update = false;
			Backbone.history.loadUrl("#contact/" + id);
			$( window ).scrollTop( 0 );
			return;
		}
		if (id)
		{
			Backbone.history.navigate("contact/" + id, { trigger : true });
		}
	});

	// Continue editing in the new-company-modal (to avoid changing the route
	// event to be prevented.)
	$('#continue-company').click(function(e)
	{
		serialize_and_save_continue_contact(e, 'companyForm', 'companyModal', true, false, this);
	});

	// Update button click event in continue-company
	$('body').on('click', '#company-update', function(e)
	{
		serialize_and_save_continue_contact(e, 'continueCompanyForm', 'companyModal', false, false, this,'tags_source_continue_company');
	});
});

/**
 * Adds conatct to view, takes care of if its a COMPANY or PERSON.
 * 
 * @param appView -
 *            view whose collection to update
 * @param model -
 *            the model contact to add
 * @param isUpdate -
 *            if undefined, implies that its new one, else an update
 */
function add_contact_to_view(appView, model, isUpdate)
{
	if (!appView)
		return;

	if (model.get('type') == 'COMPANY')
	{
		if (appView.collection.get(model.id) != null) // update existing model
			appView.collection.get(model.id).set(model);
		else if (company_util.isCompany()) // add model only if its in
			// company view
			add_model_cursor(appView.collection, model);
		else if (isUpdate)
			COMPANIES_HARD_RELOAD = true; // reload contacts next time,
		// because we may have updated
		// Company, so reflect in Contact
	}
	else
	{
		if (!readCookie('company_filter')) // check if in contacts view
		{
			if (!readCookie('contact_filter')) // add model only if its in
			// plain contact view, otherwise
			// always hard reload
			{
				if (appView.collection.get(model.id) != null) // update
					// existing
					// model
					appView.collection.get(model.id).set(model);
				else
					add_model_cursor(appView.collection, model);
			}
			else
				CONTACTS_HARD_RELOAD = true; // custom filter active, make
			// sure to reload from server
		}
	}
}

/**
 * Adds model to collection at second last position, so cursor is preserved.
 * 
 * @param app_collection -
 *            the collection to add to, must exist
 * @param mdl -
 *            the new model to be added
 */
function add_model_cursor(app_collection, mdl)
{
	if (app_collection.models.length >= 1)
		app_collection.add(mdl, { at : app_collection.models.length - 1 });
	else
		app_collection.add(mdl);

	if (app_collection.at(0).attributes.count)
		app_collection.at(0).attributes.count += 1;
}

/**
 * check for duplicated company
 */
function isCompanyExist(company)
{
	var status = false;
	$.ajax({ url : 'core/api/contacts/company/validate/' + company, async : false, success : function(response)
	{
		if (response === "true")
			status = true;

	} });
	return status;
}
/**
 * modals.js script file defines the functionality of click events of some
 * buttons and "show" and "hide" events of person and company modals
 * 
 * @module Contact management
 * @author Rammohan
 */


var forceCompany={}; /* to force company on personModal,
						Should contain - 
							doit - true to force
							name - name of company
							id - id of company
						*/
$(function(){
	   
		/**
		 * "show" event of modal - 
		 * To handle UI before its drawn on screen, even before rolling onto screen.
		 * Clean modal.
		 * If forceCompany - hide company input & show non-cancellable company name tag.
		 * Else - enable things by default
		 */
		$("#personModal").off('show.bs.modal');
		$("#personModal").on('show.bs.modal',function(data)
		{
			if(forceCompany.doit==true)
			{
				$("#personForm [name='contact_company_id']")
					.html('<li class="tag"  style="display: inline-block;" data="' + forceCompany.id + 
						'"><a href="#contact/' + forceCompany.id +'" id="contact_company_autofilled">' + forceCompany.name + 
						'</a></li>');
				$("#personForm #contact_company").hide();
				//Force Company, disable input box so user can't enter a new Company.
				
				forceCompany.doit=false; // prevent forcing company next time
			}
			else
			{
				//default clean model
				$("#personForm [name='contact_company_id']").html('');
				$("#personForm #contact_company").show();
				$("#personForm #contact_company").val('');
				$("#personForm input").val('');
			}	
		});
		
		
		$("#companyModal").on('show.bs.modal', function(data) {
			var target = data.target;
			add_custom_fields_to_form({}, function(data){
				var el = show_custom_fields_helper(data["custom_fields"], ["modal"]);
			//	if(!value["custom_data"])  value["custom_data"] = [];
				
				$("#custom-field-deals", $(target)).html(el);
				// Add placeholder and date picker to date custom fields
				$('.date_input', $(target)).attr("placeholder","Select Date");
		    
				$('.date_input', $(target)).datepicker({
					format: CURRENT_USER_PREFS.dateFormat
				});
				
			}, "COMPANY")
			
			

		});
	
		/**
		 * "Shown" event of person modal 
		 * Activates tags typeahead to tags field, company typeahead too
		 */
		$("#personModal").on('shown.bs.modal', function(data){
			setup_tags_typeahead();

			var stat=$("#personForm #contact_company").css('display');
			if( stat!='none')
			{
				/**
				 * Activate company-typeahead only if required, i.e. there's a Company Input field
				 * Custom function for typeahead results, 
				 * show at contact_company_id, data=id-of-company-contact and data=company-name
				 */
				var fxn_display_company=function(data,item)
				{
					$("#personForm [name='contact_company_id']")
						.html('<li class="tag"  style="display: inline-block;" data="' + data + 
							'"><a href="#contact/' + data +'" id="contact_company_autofilled">' + item + 
							'</a><a class="close" id="remove_tag">&times</a></li>');
					$("#personForm #contact_company").hide();
				}
				agile_type_ahead("contact_company",$('#personForm'), contacts_typeahead,fxn_display_company,'type=COMPANY','<b>No Results</b> <br/> Will add a new one');
			}
		});
		
		/**
		 * Close clicked of company entered, this brings back text input field of company to fill again
		 */
		$('body').on('click', '#personForm [name="contact_company_id"] a.close', function(e){
			$("#personForm #contact_company").show();
		});
	
		/**
		 * Click event of "Save Changes" button in person modal
		 * Saves the contact using the function "serialize_and_save_continue_contact"
		 */
		$('body').on('click', '#person_validate', function(e){
	    	serialize_and_save_continue_contact(e, 'personForm', 'personModal', false, true, this, 'tags_source_person_modal');
	    });
	    
	    /**
		 * Navigates to controller to import contacts from a file
		 */
		$('body').on('click', '#import-link', function(e){
	    	Backbone.history.navigate("import",{trigger: true});	        
	    });
	    
	    /**
		 * Click event of "Save Changes" button in company modal
		 * Saves the contact using the function "serialize_and_save_continue_contact"
		 */
		$('body').on('click', '#company_validate', function(e){
	    	serialize_and_save_continue_contact(e, 'companyForm', 'companyModal', false, false, this);
	    });
	    
	    /**
	     * "Hidden" event of person modal
	     * Hides email alert error and removes validation errors
	     */ 
	    $('#personModal').on('hidden.bs.modal', function () {
	    	
	    	// Hides email error message
	    	$('#personModal').find(".alert").hide();
	    	
	    	// Removes validation error messages
	    	remove_validation_errors('personModal');
	    	$('#personModal input').val('');
	    });
	    
	    /**
	     * "Hidden" event of company modal
	     * Removes validation errors
	     */
	    $('#companyModal').on('hidden.bs.modal', function () {
	    	remove_validation_errors('companyModal');
	    	$('#companyModal input').val('');
	    });

	    //hide modal when click on upgrade
		$('body').on('click', '.hideCurrentModal', function(e){
	    	$(this).closest(".modal").hide();
	    	if($("body").hasClass("modal-open"))
	    		$("body").removeClass("modal-open");
	    });

	    $('#tutorialModal').on("hidden.bs.modal", function(e){
			var parent = $("#tutorialModal iframe").parent();
			var $iframe = parent.html();
			parent.html(" ");
			parent.html($iframe);

		});
});

/**
 * Removes validation messages (error or success) from any modal 
 * based on its id attribute
 * 
 * @method remove_validation_errors
 * @param modalId
 * 			specifies a modal
 */
function remove_validation_errors(modalId){
	$('#' + modalId).find("div.control-group").removeClass("error");
	$('#' + modalId).find("div.control-group").removeClass("success");
	$('#' + modalId).find("span.help-inline").remove();
}
/**
 * note.js script file defines the functionality of saving a note in Note
 * database. If note is related to a contact, which is in contact detail view
 * then the note model is inserted into time-line.
 * 
 * @module Contact management
 * @author Rammohan
 */
$(function()
{

	$('body').on('click', '.edit-note', function(e)
	{
		e.preventDefault();
		console.log($(this).attr('data'));
		var note = notesView.collection.get($(this).attr('data'));
		console.log(note);

		// Clone modal, so we dont have to create a update modal.
		// we can clone add change ids and use it as different modal

		$('#noteUpdateModal').remove();

		var noteModal = $("#noteModal").clone();

		$("#noteForm > fieldset", noteModal).prepend('<input name="id" type="hidden"/>');
		$("#noteForm > fieldset", noteModal).prepend('<input name="created_time" type="hidden"/>');
		$("#noteForm", noteModal).parent().parent().find(".modal-header > h3").html('<i class="icon-edit"></i>&nbsp;Edit Note');
		$("#noteForm", noteModal).attr('id', "noteUpdateForm");
		noteModal.attr('id', "noteUpdateModal");
		agile_type_ahead("note_related_to", $("#noteUpdateForm", noteModal), contacts_typeahead);
		$("#note_validate", noteModal).attr("id", "note_update");
		deserializeForm(note.toJSON(), $("#noteUpdateForm", noteModal));

		noteModal.modal('show');
		// noteModal.modal('show');
	});

    $('body').on('click', '#note_update', function(e)
	{
		e.preventDefault();

		// Returns, if the save button has disabled attribute
		if ($(this).attr('disabled'))
			return;

		// Disables save button to prevent multiple click event issues
		disable_save_button($(this));//$(this).attr('disabled', 'disabled');

		if (!isValidForm('#noteUpdateForm'))
		{

			// Removes disabled attribute of save button
			enable_save_button($(this));
			return;
		}
		if($("#noteUpdateForm #note_relatedto_tag").children().length==0)
		{
			$("#noteUpdateForm #note_relatedto_error").show().delay(5000).hide(1);
			enable_save_button($(this));
			return;
		}

		// Shows loading symbol until model get saved
		//$('#noteUpdateModal').find('span.save-status').html(getRandomLoadingImg());

		var json = serializeForm("noteUpdateForm");
		
		
/*		if(json.id)
			{
				if(notesView && notesView.collection && notesView.collection.get(json.id))
					{
						notesView.collection.get(json.id).set(json, {silent:true});
					}
			}*/

		saveNote($("#noteUpdateForm"), $("#noteUpdateModal"), this, json);
	});
	/**
	 * Saves note model using "Bcakbone.Model" object, and adds saved data to
	 * time-line if necessary.
	 */
	$('body').on('click', '#note_validate', function(e)
	{
		e.preventDefault();

		// Returns, if the save button has disabled attribute
		if ($(this).attr('disabled'))
			return;
		
		if (!isValidForm('#noteForm'))
		{
			return;
		}
		if($("#noteForm #note_relatedto_tag").children().length==0)
		{
			$("#noteForm #note_relatedto_error").show().delay(5000).hide(1);
			return;
		}
		disable_save_button($(this));
		
		// Shows loading symbol until model get saved
		//$('#noteModal').find('span.save-status').html(getRandomLoadingImg());

		var json = serializeForm("noteForm");

		console.log(json.from_task);
		
		if(json.from_task == "true")
			saveNoteOfTask($("#noteForm"), $("#noteModal"), this, json);
		else		
		    saveNote($("#noteForm"), $("#noteModal"), this, json);
	});

	/**
	 * Shows note modal and activates contacts typeahead to its related to field
	 */
	$('body').on('click', '#show-note', function(e)
	{
		e.preventDefault();
		$("#noteModal").modal('show');

		var el = $("#noteForm");
		agile_type_ahead("note_related_to", el, contacts_typeahead);
	});

	/**
	 * "Hide" event of note modal to remove contacts appended to related to
	 * field and validation errors
	 */
	$('#noteModal').on('hidden.bs.modal', function()
	{
		// Removes appended contacts from related-to field
		$("#noteForm").find("li").remove();

		// Remove value of input field
		$("#from_task", "#noteForm").val("");
		$("#task_form", "#noteForm").val("");
		
		// Removes validation error messages
		remove_validation_errors('noteModal');
	});

	function saveNote(form, modal, element, note)
	{

		console.log(note);
		var noteModel = new Backbone.Model();
		noteModel.url = 'core/api/notes';
		noteModel.save(note, { success : function(data)
		{

			// Removes disabled attribute of save button
			enable_save_button($(element));//$(element).removeAttr('disabled');

			form.each(function()
			{
				this.reset();
			});

			// Removes loading symbol and hides the modal
			//modal.find('span.save-status img').remove();
			modal.modal('hide');

			var note = data.toJSON();

			console.log(note);
			console.log(notesView.collection.toJSON());
			// Add model to collection. Disabled sort while adding and called
			// sort explicitly, as sort is not working when it is called by add
			// function
			if (notesView && notesView.collection)
			{
				if(notesView.collection.get(note.id))
				{
					notesView.collection.get(note.id).set(new BaseModel(note));
				}
				else
				{
					notesView.collection.add(new BaseModel(note), { sort : false });
					notesView.collection.sort();
				}
			}
			/*
			 * Updates data (saved note) to time-line, when contact detail view
			 * is defined and the note is related to the contact which is in
			 * detail view.
			 */
			if (App_Contacts.contactDetailView && Current_Route == "contact/" + App_Contacts.contactDetailView.model.get('id'))
			{
				$.each(note.contacts, function(index, contact)
				{
					if (contact.id == App_Contacts.contactDetailView.model.get('id'))
					{

						// Activates "Timeline" tab and its tab content in
						// contact detail view
						// activate_timeline_tab();
						add_entity_to_timeline(data);
						/*
						 * If timeline is not defined yet, initiates with the
						 * data else inserts
						 */
						return false;
					}

				});
			}
		} });
	}
});
/**
 * author:Ramesh
 */
	/**
	 * For showing existing documents and Add new doc option
	 * to attach in send-email form 
	 */
	function sendEmailAttachmentListeners(listener_container_id){
     	
	if(!listener_container_id)
		  listener_container_id = "send-email-listener-container";

	$('#' + listener_container_id).on('click', '.add-attachment-select', function(e){
		e.preventDefault();
		var el = $(this).closest("div");
		$(this).css("display", "none");
		el.find(".attachment-document-select").css("display", "inline");
		var optionsTemplate = "<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}' url='{{url}}'>{{name}}</option>";
        fillSelect('attachment-select','core/api/documents', 'documents',  function fillNew()
		{
			el.find("#attachment-select option:first").after("<option value='new'>Upload new doc</option>");

		}, optionsTemplate, false, el); 
	});
	
	/**
	 * For adding existing document to current contact
	 */
	$('#' + listener_container_id).on('click', '.add-attachment-confirm', function(e){
		e.preventDefault();		
		var network_type = $('#attachment-select').find(":selected").attr('network_type');
		var document_size = $('#attachment-select').find(":selected").attr('size');
		if(typeof network_type !=='undefined' && network_type.toUpperCase() === 'GOOGLE')
		{
			$(this).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>Can not attach Google Drive doc to email. You can add a link instead in the email.</span>");
			//$(this).css({'border': '1px solid #df382c','outline': 'none'   });				             	            
		}
		else if(document_size >= 5242880){
			$(this).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>Document size exceeds the 5MB limit.</span>");
			//$(this).css({'border': '1px solid #df382c','outline': 'none'   });
		}
		else
		{
			$('#attachment-select').closest("span").find('.attachment-status').find("span").fadeOut(0);
			$('#attachment-select').css({"border":"1px solid #bbb"});
		    var document_id = $(this).closest(".attachment-document-select").find("#attachment-select").val();
		    var saveBtn = $(this);
			
	  		// To check whether the document is selected or not
		    if(document_id == "")
		    {
		    	saveBtn.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>This field is required.</span>");
		    	saveBtn.closest("span").find('span.save-status').find("span").fadeOut(5000);
		    	return;
		    }	    	
		    else if(document_id == "new")
		    {	
		    	e.preventDefault();
				$(this).closest('form').find('#error').html("");
				var form_id = $(this).closest('form').attr("id");
				var id = $(this).find("a").attr("id");
				
				var newwindow = window.open("upload-attachment.jsp?id="+ form_id +"&t=" + CURRENT_USER_PREFS.template +"&d=" + CURRENT_DOMAIN_USER.domain, 'name','height=310,width=500');
				
				if (window.focus)
				{
					newwindow.focus();
				}
		    }
		    else if(document_id != undefined && document_id != null)
		    {
		    	var docName = $( "#attachment-select option:selected").text();
		    	$('#emailForm').find('#eattachment').css('display','block');
		    	$('#emailForm').find('#attachment_id').find("#attachment_fname").html('<a href='+$( "#attachment-select option:selected").attr('url')+'>'+docName+'</a>');
		    	$('#emailForm').find(".attachment-document-select").css('display','none');
		    	$('#emailForm').find('#eattachment_key').attr('name',"document_key");
		    	$('#emailForm').find('#eattachment_key').attr('value',document_id);
		    }
	    }
	});
	
	/**
	 * To cancel the add attachment request in send-email form
	 */
	$('#' + listener_container_id).on('click', '.add-attachment-cancel', function(e){
		e.preventDefault();
		var blobKey = $('#emailForm').find('#attachment_id').attr('name');
		if(typeof blobKey !== typeof undefined)
	    {
			if(blobKey.toLowerCase() === 'blob_key')
			{
				var blobKeyValue = $('#emailForm').find('#eattachment_key').attr("value");
				deleteBlob(blobKeyValue);
			}
	    }
		$('#attachment-select').closest("span").find('.attachment-status').find("span").fadeOut(0);
		$('#attachment-select').css({"border":"1px solid #bbb"});	 
		$('#attachment-select').find('option:first').attr('selected', 'selected');
		var el = $(this).closest("div");
		$('#emailForm').find('.attachment-document-select').css('display','none');
		$('#emailForm').find('#eattachment').css('display','none');
		$('#emailForm').find(".add-attachment-select").css("display", "inline");
		$('#emailForm').find('#eattachment_key').attr("name","name");
    	$('#emailForm').find('#eattachment_key').attr("value","value");
	});
	
	}
    
    function deleteBlob(blob_key)
    {
    	$.ajax({url : '/core/api/emails/send-email/delete-blob/'+blob_key,
    		type : 'GET',
    		async : false,
    		success : function()
    		{
    		},
    		error : function(response)
    		{
    		} 
    	});
    }

	

function load_timeline_details(el, contactId, callback1, noAnimation)
{
	noAnimationBruteForce = true;
	timeline_entity_loader.init(App_Contacts.contactDetailView.model.toJSON());

}


function add_entity_to_timeline(model)
{
	var list = [];
	list.push(model.toJSON())

	if(!timeline_collection_view)
		return;

	if (!timeline_collection_view.collection.get(model.get('id')))
	{
		timeline_collection_view.addItems(list);
		return;
	}

	update_entity_template(model);

}

function update_entity_template(model)
{
	getTemplate('timeline1', [model.toJSON()], undefined, function(template_ui){
 		if(!template_ui)
    		return;
		$("#" + model.get("id"), $('#timeline', App_Contacts.contactDetailView.el)).html($(template_ui)); 
	}, "#" + model.get("id"), $('#timeline', App_Contacts.contactDetailView.el));

}

/**
 * Removes an element from timeline
 * 
 * @param element
 */
function removeItemFromTimeline(element)
{
	try
	{
		$('#timeline').isotope('remove', element, function()
				{
					$("#timeline").isotope('reLayout')
				});
	}
	catch(err)
	{
		
	}
}

function addTagToTimelineDynamically(tag, collection)
{
	if(!timeline_collection_view || !timeline_collection_view.collection)
		return;
	
	$.each(collection, function(index, tagObject){
		if(tagObject.tag == tag)
			{
				timeline_collection_view.collection.add(new BaseModel(tagObject));
			}
	})
	console.log(collection);
	
}

function timline_fetch_data(url, callback)
{
	
}
var timeline_entity_loader = {

	init : function(contact)
	{
		this.active_connections = 0;
		MONTH_YEARS = [];
		var _this = this;
		// Load plugins for timeline
		head.load(FLAT_FULL_PATH + "lib/isotope.pkgd.js", FLAT_FULL_PATH + "lib/jquery.event.resize.js", FLAT_FULL_PATH + "css/misc/agile-timline.css", function()
		{
			// customize_isotope()
			configure_timeline();
			timeline_collection_view = new timeline_view();
			console.log(_this);
			_this.load_other_timline_entities(contact);

			timeline_collection_view.render();
			// timeline_collection_view.render();

		});
	},
	load_other_timline_entities : function(contact)
	{
		var contactId = contact['id'];

		this.load_related_entites(contactId);
		this.load_stats(contact);
		this.load_campaign_logs(contactId);
		
		this.get_stats(getPropertyValue(contact.properties, "email"), contact, App_Contacts.contactDetailView.el);
	},
	load_related_entites : function(contactId)
	{
		var entity_types = [
				"deals", "notes", "cases", "tasks","calls","events"
		];

		var url = 'core/api/contacts/related-entities/' + contactId;
		this.timline_fetch_data(url, function(data)
		{
			var entities = [];

			for ( var index in entity_types)
			{
				if (data[entity_types[index]].length == 0)
					continue;

				entities = entities.concat(data[entity_types[index]]);

			}
			
			if(App_Contacts.contactDetailView.model.get('id') == contactId)
			timeline_collection_view.addItems(entities);
		});
	},
	load_stats : function(contact)
	{
		/*
		 * Stores all urls (notes, deals and tasks) in an array to fetch data
		 * using same collection by changing its url.
		 */

		var email = getAllPropertyValuesByName(contact.properties, "email", ",");

		// Go for mails when only the contact has an email
		if (email)
		{
			this.timline_fetch_data('core/api/emails/imap-email?e=' + encodeURIComponent(email) + '&c=10&o=0', function(stats)
			{
				console.log(stats);
				
				if(stats && stats["emails"])
				{
					var array = [];
					$.each(stats["emails"], function(index,data){
						// if error occurs in imap (model is obtained with the
						// error msg along with contact-email models),
						// ignore that model
						if(('errormssg' in data) || data.status === "error")
						return;
						
						array.push(data);
						
						});
					if(App_Contacts.contactDetailView.model.get('id') == contact.id)
					timeline_collection_view.addItems(array);
				}
			})
		}
	},
	load_campaign_logs : function(contactId)
	{
		var url = '/core/api/campaigns/logs/contact/' + contactId + '?cursor=0&page_size=100';
		this
				.timline_fetch_data(
						url,
						function(data)
						{
							if (!data || data.length == 0)
								return;
							var log_models = [];

							$
									.each(
											data,
											function(index, model)
											{

												// Add these log-types in
												// timeline
												if (model.log_type == 'EMAIL_SENT' || model.log_type == 'EMAIL_OPENED' || model.log_type == 'EMAIL_CLICKED' || model.log_type == 'SET_OWNER' || model.log_type == 'SCORE' || model.log_type == 'ADD_DEAL' || model.log_type == 'TWEET')
												{
													log_models.push(model);
												}

											});
							if(App_Contacts.contactDetailView.model.get('id') == contactId)
							timeline_collection_view.addItems(log_models);
						})
	}, timline_fetch_data : function(url, callback)
	{
		//$("#timeline-loading-img", App_Contacts.contactDetailView.el).show();
		showTransitionBar();

		console.log(this.active_connections);
		// this.active_connections = true;
		++this.active_connections;
		var _this = this;
		$.getJSON(url, function(data)
		{
			
			console.log("success : " + _this.active_connections)
			--_this.active_connections;
			console.log("success : " + _this.active_connections)
			if (callback && typeof callback === "function")
				callback(data);
			
			if(!_this.active_connections)
				//$(".timeline-loading-img", App_Contacts.contactDetailView.el).hide();
				hideTransitionBar();
		}).error(function()
		{
			-- _this.active_connections;
			
			if(!_this.active_connections)
				//$(".timeline-loading-img", App_Contacts.contactDetailView.el).hide();
				hideTransitionBar();
		});
	}, getOpenedEmailsFromEmails : function(emails)
	{
		var opened_emails = [];
		$.each(emails, function(index, model)
		{
			if (model.email_opened_at && model.email_opened_at !== 0)
			{
				// Need createdTime key to sort in timeline.
				model.createdTime = (model.email_opened_at) * 1000;

				// Temporary entity to identify timeline template
				model.agile_email = "agile_email";

				// To avoid merging with emails template having date entity
				model.date = undefined;

				opened_emails.push(model);
			}

		});

		return opened_emails;
	},

	get_stats : function(email, contact, el)
	{
		// If there are no web-stats - return
		if (!(readCookie('_agile_jsapi') != null && readCookie('_agile_jsapi') == "true") && (NO_WEB_STATS_SETUP && get_web_stats_count_for_domain() == '0'))
		{
			// Remove loading image of mails
			$('#time-line', el).find('.loading-img-stats').remove();

			return;
		}

		// Made global variable false and set cookie
		NO_WEB_STATS_SETUP = false;
		createCookie('_agile_jsapi', true, 500);

		var StatsCollection = Backbone.Collection.extend({});

		this.timline_fetch_data('core/api/web-stats?e=' + encodeURIComponent(email), function(data)
		{

			this.statsCollection = new StatsCollection(data);
			data = statsCollection;

			is_mails_fetched = true;
			is_logs_fetched = false;
			is_array_urls_fetched = false;

			// show_timeline_padcontent(is_logs_fetched, is_mails_fetched,
			// is_array_urls_fetched);

			$('#time-line', el).find('.loading-img-stats').remove();

			// Checks whether data is empty or not.
			if (data.toJSON() && data.toJSON().length > 0)
			{

				// Gets address of the contact from its browsing history
				var address = getPropertyValue(contact.properties, "address");

				if (!address)
				{
					var addressJSON = {};

					if (data.toJSON()[0].city != "")
					{
						addressJSON.city = ucfirst(data.toJSON()[0].city);
						addressJSON.state = ucfirst(data.toJSON()[0].region);
						addressJSON.country = getCode(data.toJSON()[0].country);

						// If contact has no address property push the new one
						contact.properties.push({ "name" : "address", "value" : JSON.stringify(addressJSON) });

						// Update contact with the browsing address
						var contactModel = new Backbone.Model();
						contactModel.url = 'core/api/contacts';
						contactModel.save(contact, { success : function(obj)
						{
						} });
					}
				}
				if(App_Contacts.contactDetailView.model.get('id') == contact.id)
				timeline_collection_view.addItems(data.toJSON());

				addTagAgile(CODE_SETUP_TAG);
			}
		});
	}

}
// Stores month names with their maximum days to get time stamp (milliseconds)
var monthArray = [
		'January 31', 'February 28', 'March 31', 'April 30', 'May 31', 'June 30', 'July 31', 'August 31', 'September 30', 'October 31', 'November 30',
		'December 31'
];

// Stores "monthIndex-year" of timeline initiating entities
var MONTH_YEARS;

/**
 * Removes loading image from timeline view
 * 
 * @param el
 *            html object of contact detail view
 */
function remove_loading_img(el)
{
	$('#time-line', el).find('.loading-img').remove();
}

/**
 * Returns month index and full year of the given entity as "-" separated.
 * 
 * @param model
 * @returns {String}
 */
function entity_created_month_year(model)
{
	if (model.entity_type == "event" && model.start)
		return month_year = new Date(model.start * 1000).getMonth() + '-' + new Date(model.start * 1000).getFullYear();
	if (model.created_time)
		return month_year = new Date(model.created_time * 1000).getMonth() + '-' + new Date(model.created_time * 1000).getFullYear();
	if (model.createdTime)
		return month_year = new Date(model.createdTime).getMonth() + '-' + new Date(model.createdTime).getFullYear();
	else if (model.time)
		return month_year = new Date(model.time * 1000).getMonth() + '-' + new Date(model.time * 1000).getFullYear();
	else if (model.date_secs)
		return month_year = new Date(model.date_secs).getMonth() + '-' + new Date(model.date_secs).getFullYear();
}

/**
 * Get the timestamp (milliseconds) given month of the year.
 */
function getTimestamp(month_index, year)
{
	if ((year % 4) == 0)
		monthArray[1] = 'February 29';
	return Date.parse(monthArray[month_index] + ', ' + year) + 86400000 - 1;
}
/**
 * Defines the layout and its dimensions, container size and
 * arrangement of data position added to timeline etc..
 * 
 * @method customize_isotope
 */

function customize_isotope()
{
	// Resets the layout based on items 
	$.Isotope.prototype._spineAlignReset = function() {
		this.spineAlign = {
			colA: 0,
			colB: 0,
			lastY: -60
		};
	};

	/*
	 * Defines the dimentions of layout, and alters the position of data.
	 * It executes every tiem, when a modal is added or deleted from timeline.
	 */ 
	$.Isotope.prototype._spineAlignLayout = function( $elems ) {
		var	instance = this,
			props = this.spineAlign,
			gutterWidth = Math.round( this.options.spineAlign && this.options.spineAlign.gutterWidth ) || 0,
			centerX = Math.round(this.element.width() / 2);
		
		Date.prototype.monthNames = [ "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ];

		Date.prototype.getMonthName = function() {
            return this.monthNames[this.getMonth()];
        };
        var currentDate = new Date();
        
		$elems.each(function(i, val){
			var $this = $(this);
			$this.removeClass('last').removeClass('top');
			if (i == $elems.length - 1)
				$this.addClass('last');
			var x, y;
			if ($this.hasClass('year-marker')){
				var width = $this.width();
				x = centerX - (width / 2);
				if (props.colA >= props.colB){
					y = props.colA;
					if (y == 0){
						$this.addClass('top');
						if($this.find('.year').text()==currentDate.getMonthName()){
							$this.find('.inner2').addClass('inner2-top');
							$this.find('.inner2').removeClass('inner2');
							$this.find('.year').text('Now');
						}
					}
					props.colA += $this.outerHeight(true);
					props.colB = props.colA;
				}
				else{
					y = props.colB;
					if (y == 0){
						$this.addClass('top');
						if($this.find('.year').text()==currentDate.getMonthName()){
							$this.find('.inner2').addClass('inner2-top');
							$this.find('.inner2').removeClass('inner2');
							$this.find('.year').text('Now');
						}
					}
					props.colB += $this.outerHeight(true);
					props.colA = props.colB;
				}
			}
			else{
				var colorNumber = ((i+1)%4) + 1;
				$this.removeClass('color1').removeClass('color2').removeClass('color3').removeClass('color4');
				$this.addClass('color'+colorNumber);
					
				$this.removeClass('left').removeClass('right');
				var isColA = props.colB >= props.colB;
				if (isColA)
					$this.addClass('right');
				else
					$this.addClass('right');
				x = isColA ?
						centerX + (gutterWidth / 2): // right side
						centerX + (gutterWidth / 2); // right side
				y = isColA ? props.colB : props.colB;
				if (y - props.lastY <= 60){
					var extraSpacing = 60 - Math.abs(y - props.lastY);
					$this.find('.inner').css('marginTop', 0);
					props.lastY = y + extraSpacing;
				}
				else{
					$this.find('.inner').css('marginTop', 0);
					props.lastY = y;
				}
				props[( isColA ? 'colB' : 'colB' )] += $this.outerHeight(true);
				/*alert("$this.attr('id')---"+$this.attr('id'));
				alert("$this.height()---"+$this.height());*/
				/*if($this.attr('id')!=""){
					$("<style type='text/css' id='"+$this.attr('id')+"' />").appendTo("head");
					$("#"+$this.attr('id')).text(".post.right.color"+colorNumber+":before{padding-bottom: "+($this.height())+"px;}");
				}else{
					$this.attr('id','color'+i);
					$("<style type='text/css' id='"+$this.attr('id')+"' />").appendTo("head");
					$("#"+$this.attr('id')).text(".post.right.color"+colorNumber+":before{padding-bottom: "+($this.height())+"px;}");
					$this.attr('id','');
					alert("$this.height()-----"+$this.height());
				}*/
			}
			instance._pushPosition( $this, x, y );
		});
	};
	
	// Sets the container size based on spinAlignLayout function resulrs
	$.Isotope.prototype._spineAlignGetContainerSize = function() {
		var size = {};
		size.height = this.spineAlign[( this.spineAlign.colB > this.spineAlign.colA ? 'colB' : 'colB' )];
		return size;
	};
	$.Isotope.prototype._spineAlignResizeChanged = function() {
		return true;
	};
}	

function configure_timeline()
{
	var cnt = 0;
	customize_isotope();

	var $container = $("#timeline", App_Contacts.contactDetailView.el);
	var elemen="";

	// Initializes isotope with options (sorts the data based on created time)
	$container.isotope({ itemSelector : ".item", transformsEnabled : true, layoutMode : 'spineAlign', spineAlign : { gutterWidth : 56 },
		getSortData : { timestamp : function($elem)
		{
			elemen = parseFloat($elem.find('.timestamp').text());
			var time = parseFloat($elem.find('.timestamp').text());

			if (!time)
				return 0;
			// If time is in milliseconds then return time in seconds
			if ((time / 100000000000) > 1)
				return time / 1000;

			return time
		} }, sortBy : 'timestamp', sortAscending : false, itemPositionDataEnabled : true, onLayout: function($elem){
			$elem.removeClass('special');
			setTimeout(function(){
				$elem.addClass('special');
				$elem.addClass($elem.attr('id')+'');
				if($elem.attr('id')!=undefined){
					$elem.addClass('special');
					$elem.addClass($elem.attr('id')+'');
					var eleHeight = parseInt($elem.height())+10;
					if($elem.hasClass('color1'))
						$('head').append('<style>.post.right.color1.special:before{padding-bottom:'+eleHeight+'px;}</style>');
					if($elem.hasClass('color2'))
						$('head').append('<style>.post.right.color2.special:before{padding-bottom:'+eleHeight+'px;}</style>');
					if($elem.hasClass('color3'))
						$('head').append('<style>.post.right.color3.special:before{padding-bottom:'+eleHeight+'px;}</style>');
					if($elem.hasClass('color4'))
						$('head').append('<style>.post.right.color4.special:before{padding-bottom:'+eleHeight+'px;}</style>');
				}
			},1000);
		} });
}
/**
 * Handles the events (click and mouseenter) of mail and log entities of 
 * tiemline 
 */
$(function () {
	/*
	 * Shows the mail details in detail on a popup modal, when '+'
	 * symbol is clicked 
	 */ 
	$('body').on('click', '#tl-mail-popover', function(e){
		e.preventDefault();
		
		var htmlstring = $(this).closest('div').attr("data");
		// var htmlstring = $(this).closest('div.text').html();
		// htmlstring = htmlstring.replace("icon-plus", "");

		$("#mail-in-detail").html("<div style='background:none;border:none;'>" + htmlstring + "</div>");
		
		$("#timelineMailModal").modal("show");
        
    });
	
	/*
	 * Shows the campaign log details on a popup modal
	 */
	$('body').on('click', '#tl-log-popover', function(e){
		e.preventDefault();
		
		var string = $(this).closest('div').attr("data");

		// Add div tag to the string to consider white spaces
		$("#log-in-detail").html("<div style='background:none;border:none;'>" + string + "</div>");
		
		$("#timelineLogModal").modal("show");
    });
	
	/**
	 * Shows analytics popup modal with full details.
	 **/
	$('body').on('click', '#tl-analytics-popover', function(e){
		e.preventDefault();
		
		var string = $(this).closest('div.body').html();
		var pageViews = $(string).find('div.ellipsis-multi-line');

		$("#analytics-in-detail").html("<div'>" + $(pageViews).html() + "</div>");
		
		$("#timelineAnalyticsModal").modal("show");
	});
	
	/*
	 * Shows the list of mails(mail sent to) as popover, when mouse is entered on
	 * to address of the email
	 */ 
	$('body').on('mouseenter', '#tl-mail-to-popover', function(e){
		
		$(this).popover({
        	template:'<div class="popover"><div class="arrow"></div><div class="popover-inner" style="padding:1px;width:340px;border-radius:2px"><div class="popover-content"><p></p></div></div></div>'
        });
		
		var string = $(this).text();
		//var html = new Handlebars.SafeString(string.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/,/g, ",</br>").replace("To:","To:</br>").replace("read more", ""));
		$(this).attr("data-content", string);
        $(this).popover('show');
    });
	
	// Resizes the item height and open close effect for timeline elements
	$('body').on('click', '#timeline .item a.open-close', function(e){
		$(this).siblings('.body').slideToggle(function(){
			$('#timeline').isotope('reLayout');
		});
		$(this).parents('.post').toggleClass('closed');
		$('#expand-collapse-buttons a').removeClass('active');
		e.preventDefault();
	});
	
});
var noAnimationBruteForce = true;
var timeline_collection_view;
var MONTH_YEARS;
var month_years = [];

var timeline_view = Backbone.View.extend({ initialize : function()
{
	// Binds functions to view
	_.bindAll(this, 'render', 'appendItem', 'addItems');

	this.options.data = [];
	// this.options.data.concat();
	this.options.data.push(App_Contacts.contactDetailView.model.toJSON());

	console.log(App_Contacts.contactDetailView.model.toJSON().tagsWithTime);
	console.log(this.options.data);
	// this.options.data.push(App_Contacts.contactDetailView.model.toJSON().tagsWithTime);

	this.collection = new BaseCollection([], {});
	this.month_year_marker = [];
	this.month_year_marker_objects = [];
	configure_timeline_comparator(this.collection);

	this.collection.add(App_Contacts.contactDetailView.model.toJSON().tagsWithTime, { silent : true });
	this.collection.add(this.options.data, { silent : true });

	// load_other_timline_entities();
	this.queue = new Queue;
	// this.render();
	this.collection.bind('add', this.appendItem);

}, appendItem : function(model)
{
	if (model.get("entity_type"))
		if (model.get("entity_type") == "year-marker")
		{
			getTemplate("year-marker", model.toJSON(), "yes", function(template)
			{
				$('#timeline', App_Contacts.contactDetailView.el).isotope('insert', $(template));
			});
			return;
		}

	this.collection.add(model, { silent : true });
	var temp = [];
	temp.push(model.toJSON());
	var elements = getTemplate("timeline1", temp, undefined, function(result)
	{
		$('#timeline', App_Contacts.contactDetailView.el).isotope("insert", $(result));
	});

}, addItems : function(models)
{
	this.collection.add(models, { silent : true });
	this.buildTimlinePosts(models);

}, render : function()
{
	this.buildTimlinePosts(this.collection.toJSON());

}, buildTimlinePosts : function(models)
{
	var length = models.length;
	if (!length)
		return;

	this.addToQueue(models)
	return;

	var i = 0;
	while (i < length)
	{
		var end = i + 50;

		end = end > length ? length : end;
		if (end == i)
			break;
		this.addToQueue(models.slice(i, end));
		i += 50;
	}
}, addToQueue : function(models)
{
	this.queue.add_function(quedfunction, models);
}

});

function quedfunction(models)
{
	var is_empty_queue;
	// timeline_collection_view.queue.running = true;
	getTemplate("timeline1", models, undefined, function(result)
	{
		$("#timeline", $(App_Contacts.contactDetailView.el)).isotope('insert', $(result), function(ele)
		{
			timeline_collection_view.queue.running = false;
			timeline_collection_view.queue.next();
		});
	});
}

function configure_timeline_comparator(collection)
{

	// Override comparator to sort models on time base
	collection.comparator = function(item)
	{
		var month_year = entity_created_month_year(item.toJSON());

		if (month_year)
			if (timeline_collection_view && timeline_collection_view.month_year_marker.indexOf(month_year) == -1)
			{

				timeline_collection_view.month_year_marker.push(month_year);

				var monthYear = month_year.split('-');
				var timestamp = getTimestamp(monthYear[0], monthYear[1]) / 1000;
				var context = { year : monthArray[monthYear[0]].split(' ')[0], timestamp : timestamp, "entity_type" : "year-marker" };
				if (!collection.where({ "year" : monthArray[monthYear[0]].split(' ')[0] })[0])
					;
				collection.add(context);

				console.log(context);
				timeline_collection_view.month_year_marker_objects.push(context);
			}

		if (item.get('created_time') && item.get('entity_type') != "event")
		{
			return item.get('created_time');
		}
		if (item.get('entity_type') == "event")
		{
			return item.get('start');
		}
		else if (item.get('createdTime'))
		{
			return item.get('createdTime') / 1000;
		}
		else if (item.get('time'))
		{
			return item.get('time') / 1000;
		}
		else if (item.get('date_secs'))
		{
			return item.get('date_secs') / 1000;
		}
		else if (item.get('timestamp'))
		{
			return timestamp;
		}

		return item.get('id');
	}
}
var Queue = (function(){

    function Queue() {};

    Queue.prototype.running = false;

    Queue.prototype.queue = [];
    Queue.prototype.running = false;

    Queue.prototype.add_function = function(callback, models) { 
        var _this = this;
        
        //add callback to the queue
        this.queue.push(function(){
            callback(models);
        });
        
        
        if(!this.running)
        {
        	this.next();
        }

        return this; // for chaining fun!
    }
    

    Queue.prototype.next = function() {
       // this.running = false;
        //get the first element off the queue
        var shift = this.queue.shift();
        
        if(shift) {
           this.running = true;
            shift(); 
        }
    }

    Queue.prototype.pop = function() {

       this.queue.pop();
    }

    return Queue;

})();/**
 * custom-field.js is a script file to deal with the UI of the custom fields,
 * and also contains a function which adds custom_fields attribute to the
 * desired entity with all the custom fields as values.
 * 
 * @module Custom fields
 * 
 * author: Yaswanth
 */
function initializeCustomFieldsListeners(){
	/**
	 * Loads the respective modal (Text or Date or List or Check-box modal) based
	 * on the id attribute of the clicked link to save the custom fields.
	 */
	$('#custom-fields-accordion').on('click', '.fieldmodal', function(event){
		event.preventDefault();
		var type = $(this).attr("type");
		
		showCustomFieldModel({"scope" : type, "position" : $(this).parent().parent().find('table > tbody > tr').length+1});
		
	});
	
	
	$('#custom-fields-accordion').on('change', '#admin-settings-customfields-model-list > tr > td:not(":first-child")', function(e){
		e.preventDefault();
		var custom_field = $(this).closest('tr').data();
		console.log(custom_field);
		showCustomFieldModel(custom_field.toJSON());
	});
	$('#custom-fields-accordion').on('click', '#edit-custom-field', function(e){
		e.preventDefault();
		var custom_field = $(this).closest('tr').data();
		console.log(custom_field);
		showCustomFieldModel(custom_field.toJSON());
	});
	$('#custom-fields-accordion').on('click', '#delete-custom-field', function(e){
		if(confirm("Are you sure you want to delete?")){
			e.preventDefault();
			var custom_field = $(this).closest('tr').data();
			console.log(custom_field);
			var currentElement=$(this);
			$.ajax({ type : 'DELETE', url : '/core/api/custom-fields/' + custom_field.id, contentType : "application/json; charset=utf-8",
				success : function(data){
					if(custom_field.get("scope")=="CONTACT")
						App_Admin_Settings.contactCustomFieldsListView.collection.remove(custom_field.id);
					else if(custom_field.get("scope")=="COMPANY")
						App_Admin_Settings.companyCustomFieldsListView.collection.remove(custom_field.id);
					else if(custom_field.get("scope")=="DEAL")
						App_Admin_Settings.dealCustomFieldsListView.collection.remove(custom_field.id);
					else if(custom_field.get("scope")=="CASE")
						App_Admin_Settings.caseCustomFieldsListView.collection.remove(custom_field.id);
					currentElement.closest('tr').remove();
				}, dataType : 'json' });
		}
	});
}

function showCustomFieldModel(data)
{
	var isNew = false;
	isNew = !data.id;
	// Creating model for bootstrap-modal
	var modelView = new Base_Model_View({
		url : '/core/api/custom-fields',
		template : 'custom-field-add-modal',
	//	window : 'custom-fields',
		data : data,
		//reload : true,
		modal : "#custom-field-add-modal",
		isNew : isNew,
		postRenderCallback : function(el) {
			console.log($("#custom-field-add-modal", el));
			//This code will scroll to top to see the modal.
			
			$("#custom-field-add-modal", el).modal('show');
			
			//Customizing the style to display the custom field modal in center for screen.
			var modalWidth = $('#custom-field-add-modal').width();
		     $('#custom-field-add-modal').css("left", "50%");
		     $('#custom-field-add-modal').css("width", modalWidth);
		     $('#custom-field-add-modal').css("margin", (modalWidth/2)*-1);
		     bindCustomFiledChangeEvent(el);
		},
		saveCallback : function(model)
		{
			console.log(model);
			//var custom_field_model_json = App_Admin_Settings.customFieldsListView.collection.get(model.id);
			var custom_field_model_json;
			if(model.scope=="CONTACT")
				custom_field_model_json = App_Admin_Settings.contactCustomFieldsListView.collection.get(model.id);
			else if(model.scope=="COMPANY")
				custom_field_model_json = App_Admin_Settings.companyCustomFieldsListView.collection.get(model.id);
			else if(model.scope=="DEAL")
				custom_field_model_json = App_Admin_Settings.dealCustomFieldsListView.collection.get(model.id);
			else if(model.scope=="CASE")
				custom_field_model_json = App_Admin_Settings.caseCustomFieldsListView.collection.get(model.id);
			
			
			if(custom_field_model_json)
			{
				//App_Admin_Settings.customFieldsListView.collection.remove(custom_field_model_json);
				custom_field_model_json.set(new BaseModel(model),{silent:true});
				if(model.scope=="CONTACT")
					App_Admin_Settings.contactCustomFieldsListView.render(true);
				else if(model.scope=="COMPANY")
					App_Admin_Settings.companyCustomFieldsListView.render(true);
				else if(model.scope=="DEAL")
					App_Admin_Settings.dealCustomFieldsListView.render(true);
				else if(model.scope=="CASE")
					App_Admin_Settings.caseCustomFieldsListView.render(true);
			}
			
			else
			{
				if(model.scope=="CONTACT"){
					App_Admin_Settings.contactCustomFieldsListView.collection.add(model);
					App_Admin_Settings.contactCustomFieldsListView.render(true);
				}else if(model.scope=="COMPANY"){
					App_Admin_Settings.companyCustomFieldsListView.collection.add(model);
					App_Admin_Settings.companyCustomFieldsListView.render(true);
				}else if(model.scope=="DEAL"){
					App_Admin_Settings.dealCustomFieldsListView.collection.add(model);
					App_Admin_Settings.dealCustomFieldsListView.render(true);
				}else if(model.scope=="CASE"){
					App_Admin_Settings.caseCustomFieldsListView.collection.add(model);
					App_Admin_Settings.caseCustomFieldsListView.render(true);
				}
				/*App_Admin_Settings.customFieldsListView.collection.add(model);
				if(App_Admin_Settings.customFieldsListView.collection.length == 1)
					App_Admin_Settings.customFieldsListView.render(true);*/
			}
			$("#custom-field-add-modal").modal('hide');
			$("#custom-field-add-modal").modal('hide');
		}
	});

	$('#custom-field-modal').html(modelView.render(true).el);
	$("#custom-field-type").trigger("change");
}


function bindCustomFiledChangeEvent(el){
	$('#custom-field-add-modal',el).on('change', '#custom-field-type', function(e){
		e.preventDefault();
		var value = $(this).val();
		if(value == "LIST")
		{
			$("#custom-field-data").hide();
			$("input",  $("#custom-field-data")).removeAttr("name");
			$("#custom-field-list-values").show();
			$("input",  $("#custom-field-list-values")).attr("name", "field_data");
			$("#custom-field-formula-data").hide();
			$("textarea",  $("#custom-field-formula-data")).removeAttr("name");
		}
		else if(value == "TEXTAREA")
		{
			$("#custom-field-data").show();
			$("input",  $("#custom-field-data")).attr("name", "field_data");
			$("#custom-field-list-values").hide();
			$("input",  $("#custom-field-list-values")).removeAttr("name");
			$("#custom-field-formula-data").hide();
			$("textarea",  $("#custom-field-formula-data")).removeAttr("name");
		}
		else if(value == "FORMULA")
		{
			$("#custom-field-data").hide();
			$("input",  $("#custom-field-data")).removeAttr("name");
			$("#custom-field-list-values").hide();
			$("input",  $("#custom-field-list-values")).removeAttr("name");
			$("#custom-field-formula-data").show();
			$("textarea",  $("#custom-field-formula-data")).attr("name", "field_data");
		}
		else
		{
			$("#custom-field-data").hide();
			$("#custom-field-list-values").hide();
			$("#custom-field-formula-data").hide();
		}
		
	});
}

/**
 * Adds custom fields to the the desired entity and then calls the callback to
 * update the custom fields to that entity.
 * 
 * @method add_custom_fields_to_form
 * @param context
 *            entity to fill up with the custom fields
 * @param callback
 *            will be called with the modified entity as parameter, when it is a
 *            function
 * 
 */
function add_custom_fields_to_form(context, callback, scope) {

	if(scope == undefined || scope == "CONTACT")
		$("#content").html(LOADING_HTML);
	var url = "core/api/custom-fields/scope?scope=" + (scope == undefined ? "CONTACT" : scope);
	var custom_fields = Backbone.Model.extend({
		url : url
	});

	new custom_fields().fetch({
		success : function(custom_field_data) {

			var custom_fields_list = [];

			$.each(custom_field_data.toJSON(), function(index, value) {
				custom_fields_list.push(value);
			});
			
			App_Contacts.custom_fields = custom_fields_list;
			// var contact = contact.toJSON();
			context['custom_fields'] = custom_fields_list;
			
			if (callback && typeof (callback) === "function") {
				// execute the callback, passing parameters as necessary
				callback(context);
			}

		}
	});

}

/**
 * Called from handlebars
 * Generates suitable html string for each custom field entity depending upon it's type 
 * and does concatenation. For example, if the type of the field is list then a 'select drop down' 
 * is generated. Similarly, html strings are generated based on other filed types.
 * If the custom field has the attribute is_required as true, then it's associated html
 * string also contains the "required" class. 
 * 
 * @method show_custom_fields_helper
 * @param custom_fields
 * @param properties
 * @returns {String}
 */
function show_custom_fields_helper(custom_fields, properties){

	var el = "";
	var isModal = false;
	if(properties.length > 0){
		if(properties[0] && properties[0] == 'modal'){
			isModal = true;
		}
	}
	
	// Text as default
	var field_type = "text";
		
	// Create Field for each custom field  to insert into the desired form 
	$.each(custom_fields, function(index, field)
	{
		if(!field.field_type)
			return;
		
		var label_style = "";
		var field_style = "";
		var div_col9_style = "";
		var div_col3_style = "";
		var checkbox_style ="";
		var max_len = 500;
		if(field.scope == "CONTACT"){
			label_style = "col-sm-3 word-break-all";
			field_style = "col-sm-10";
			div_col9_style = "col-sm-9";
			div_col3_style = "col-sm-3";
		}else if(field.scope == "COMPANY" || field.scope == "DEAL" || field.scope == "CASE"){
			label_style = "control-label col-sm-3 word-break-all";
			checkbox_style = "col-sm-3";
		}
		
		// If field type is list create a select dropdown
		if(field.field_type.toLowerCase() == "list")
		{
			var list_values = [],list_options = '<option value="">Select</option>';
			
			// Split values at ";" to separate values of field_data (list options)
			if(field.field_data)
					list_values = field.field_data.split(";");
				
				// Create options based on list values
				$.each(list_values,function(index, value){
					if(value != "")
						list_options = list_options.concat('<option value="'+value+'">'+value+'</option>');
				});
				
				// Create select drop down by checking it's required nature
				if(field.is_required){
					
					if(isModal){
						el = el.concat('<div class="control-group form-group "><label class="control-label word-break-all"><b>'
								+field.field_label
								+'</b><span class="field_req">*</span></label><div class="controls"><span><select class="'
								+field.field_type.toLowerCase()
								+' custom_field required form-control '+field_style+'" id='
								+field.id
								+' name="'
								+field.field_label
								+'">'
								+list_options
								+'</select></span></div></div>');											
					}else{
						el = el.concat('<div class="control-group form-group "><label class="control-label '+label_style+'">'
								+field.field_label
								+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+div_col9_style+'"><select class="'
								+field.field_type.toLowerCase()
								+' custom_field required form-control '+field_style+'" id='
								+field.id
								+' name="'
								+field.field_label
								+'">'
								+list_options
								+'</select></div></div>');
					}
					
				}else{
					if(isModal){
						el = el.concat('<div class="control-group form-group "><label class="control-label word-break-all"><b>'
								+field.field_label
								+'</b></label><div class="controls"><select class="'
								+field.field_type.toLowerCase()
								+' custom_field form-control '+field_style+'" id='
								+field.id
								+' name="'
								+field.field_label+'">'
								+list_options+'</select></div></div>');
					}else{
						el = el.concat('<div class="control-group form-group ">	<label class="control-label '+label_style+'">'
									+field.field_label
									+'</label><div class="controls col-sm-9 '+div_col9_style+'"><select class="'
									+field.field_type.toLowerCase()
									+' custom_field form-control '+field_style+'" id='
									+field.id
									+' name="'
									+field.field_label+'">'
									+list_options+'</select></div></div>');
					}
				}
				
			return;
		}
		else if(field.field_type.toLowerCase() == "checkbox")
			{
				field_type = "checkbox";
				
				if(field.scope=="DEAL"){
					if(field.is_required){
						if(isModal){
							el = el.concat('<div class="control-group form-group "><label class="i-checks i-checks-sm">'
									+'<input type="'
									+field_type
									+'" class="'
									+field.field_type.toLowerCase()
									+'_input custom_field required" id='
									+field.id+' name="'
									+field.field_label
									+'" style="margin: 0px 5px;"><i></i><div class="field_req inline-block">*</div><b>'+field.field_label+'</b></label></div>');
						}else{
							el = el.concat('<div class="control-group form-group ">	<label class="i-checks i-checks-sm '+label_style+'">'
									+'<span class="field_req">*</span><input type="'
									+field_type
									+'" class="'
									+field.field_type.toLowerCase()
									+'_input custom_field required" id='
									+field.id+' name="'
									+field.field_label
									+'" style="margin: 0px 5px;"><i></i>'+field.field_label+'</label></div>');
						}
					}else{
						if(isModal){
							el = el.concat('<div class="control-group form-group "><label class="i-checks i-checks-sm">'
									+'<input type="'
									+field_type
									+'" class="'
									+field.field_type.toLowerCase()
									+'_input custom_field" id='
									+field.id+' name="'
									+field.field_label
									+'" style="margin: 0px 5px;"><i></i><b>'+field.field_label+'</b></label></div>');
						}else{
							el = el.concat('<div class="control-group form-group "><label class="i-checks i-checks-sm '+label_style+'">'
									+'<input type="'
									+field_type
									+'" class="'
									+field.field_type.toLowerCase()
									+'_input custom_field" id='
									+field.id+' name="'
									+field.field_label
									+'" style="margin: 0px 5px;"><i></i>'+field.field_label+'</label></div>');
						}
					}
					return;
				}
				
				if(field.is_required){
					if(isModal){
						el = el.concat('<div class="control-group form-group ">'
								+'<label class="i-checks i-checks-sm"><input type="'
								+field_type
								+'" class="'
								+field.field_type.toLowerCase()
								+'_input custom_field required" id='
								+field.id+' name="'
								+field.field_label
								+'"><i></i><div class="field_req inline-block">*</div><b>'+field.field_label+'</b></label></div>');
					}else{
						el = el.concat('<div class="control-group form-group ">	<label class="control-label '+checkbox_style+" "+label_style+'">'
								+field.field_label
								+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+div_col3_style+' m-t-xs"><label class="i-checks i-checks-sm"><input type="'
								+field_type
								+'" class="'
								+field.field_type.toLowerCase()
								+'_input custom_field required" id='
								+field.id+' name="'
								+field.field_label
								+'"><i></i></label></div></div>');
					}
				}
				else{
					if(isModal){
						el = el.concat('<div class="control-group form-group "><label class="i-checks i-checks-sm">'
								+'<input type="'
								+field_type
								+'" class="'
								+field.field_type.toLowerCase()
								+'_input custom_field" id='
								+field.id+' name="'
								+field.field_label
								+'"><i></i><b>'+field.field_label+'</b></label></label></div>');
					}else{
						el = el.concat('<div class="control-group form-group "><label class="control-label '+checkbox_style+" "+label_style+'">'
								+field.field_label
								+'</label><div class="controls col-sm-9 '+div_col3_style+' m-t-xs"><label class="i-checks i-checks-sm"><input type="'
								+field_type
								+'" class="'
								+field.field_type.toLowerCase()
								+'_input custom_field" id='
								+field.id+' name="'
								+field.field_label
								+'"><i></i></label></div></div>');
					}
				}
				return;
			}
		else if(field.field_type.toLowerCase() == "textarea")
		{
			field_type = "textarea";
			var rows = 3;
			
			if(field.field_data)
				rows = parseInt(field.field_data);
				
			if(field.is_required){
				if(isModal){
					el = el.concat('<div class="control-group form-group "><label class="control-label word-break-all"><b>'
							+field.field_label
							+'</b><span class="field_req">*</span></label><div class="controls"><textarea rows="'
							+rows+'" class="'
							+field.field_type.toLowerCase()
							+'_input custom_field required form-control resize-vertical field_length" id='
							+field.id+' name="'
							+field.field_label
							+'" max_len="'+max_len+'"></textarea></div></div>');
				}else{
					el = el.concat('<div class="control-group form-group "><label class="control-label '+label_style+'">'
							+field.field_label
							+'<span class="field_req">*</span></label><div class="controls col-sm-9 '+div_col9_style+'"><textarea rows="'
							+rows+'" class="'
							+field.field_type.toLowerCase()
							+'_input custom_field required form-control resize-vertical field_length" id='
							+field.id+' name="'
							+field.field_label
							+'"  max_len="'+max_len+'"></textarea></div></div>');
				}
			}else{
				if(isModal){
					el = el.concat('<div class="control-group form-group "><label class="control-label word-break-all"><b>'
							+field.field_label
							+'</b></label><div class="controls"><textarea rows="'
							+rows+'" class="'
							+field.field_type.toLowerCase()
							+'_input custom_field form-control resize-vertical field_length" id='
							+field.id+' name="'
							+field.field_label
							+'"  max_len="'+max_len+'"></textarea></div></div>');
				}else{
					el = el.concat('<div class="control-group form-group "><label class="control-label '+label_style+'">'
							+field.field_label
							+'</label><div class="controls col-sm-9 '+div_col9_style+'"><textarea rows="'
							+rows+'" class="'
							+field.field_type.toLowerCase()
							+'_input custom_field form-control resize-vertical field_length" id='
							+field.id+' name="'
							+field.field_label
							+'"  max_len="'+max_len+'"></textarea></div></div>');
				}
			}
			return;
		}
		else if(field.field_type.toLowerCase() == "number")
		{
			field_type = "number";
			if(field.is_required){
				if(isModal){
					el = el.concat('<div class="control-group form-group "><label class="control-label word-break-all"><b>'
						+field.field_label
						+'</b><span class="field_req">*</span></label><div class="controls custom-number-controls"><input type="number" class="'
						+field.field_type.toLowerCase()
						+'_input custom_field required form-control field_length" id="'
						+field.id+'" name="'
						+field.field_label
						+'" value="0" max_len="'+max_len+'"></input>'
						+'</div></div>');
				}else{
					el = el.concat('<div class="control-group form-group ">	<label class="control-label '+label_style+'">'
							+field.field_label
							+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+div_col3_style+' custom-number-controls"><input type="number" class="'
							+field.field_type.toLowerCase()
							+'_input custom_field required form-control field_length" id="'
							+field.id+'" name="'
							+field.field_label
							+'" value="0" max_len="'+max_len+'"></input>'
							+'</div></div>');
				}
			}else{
				if(isModal){
					el = el.concat('<div class="control-group form-group "><label class="control-label word-break-all"><b>'
						+field.field_label
						+'</label><div class="controls custom-number-controls"><input type="number" class="'
						+field.field_type.toLowerCase()
						+'_input custom_field form-control field_length" id="'
						+field.id+'" name="'
						+field.field_label
						+'" value="0" max_len="'+max_len+'"></input>'
						+'</div></div>');
				}else{
					el = el.concat('<div class="control-group form-group ">	<label class="control-label '+label_style+'">'
							+field.field_label
							+'</label><div class="controls col-sm-9 '+div_col3_style+' custom-number-controls"><input type="number" class="'
							+field.field_type.toLowerCase()
							+'_input custom_field form-control field_length" id="'
							+field.id+'" name="'
							+field.field_label
							+'" value="0" max_len="'+max_len+'"></input>'
							+'</div></div>');
				}
			}
				
			return;
		}
		else if(field.field_type.toLowerCase() == "formula")
		{
			//If custom field is formula we return without appending anything	
			return;
		}
		
		// If the field is not of type list or checkbox, create text field (plain text field or date field)
		if(field.is_required){
			if(isModal){
				el = el.concat('<div class="control-group form-group "><label class="control-label word-break-all"><b>'
							+field.field_label
							+'</b><span class="field_req">*</span></label><div class="controls"><input type="text" class="'
							+field.field_type.toLowerCase()
							+'_input custom_field required form-control field_length" id='
							+field.id+' name="'+field.field_label
							+'" max_len="'+max_len+'"></div></div>');
			}else{
				el = el.concat('<div class="control-group form-group ">	<label class="control-label '+label_style+'">'
						+field.field_label
						+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+div_col9_style+'"><input type="text" class="'
						+field.field_type.toLowerCase()
						+'_input custom_field required form-control field_length" id='
						+field.id+' name="'+field.field_label
						+'" max_len="'+max_len+'"></div></div>');
			}
		}else{
			if(isModal){
				el = el.concat('<div class="control-group form-group "><label class="control-label word-break-all"><b>'
							+field.field_label
							+'</b></label><div class="controls"><input type="text" class="'
							+field.field_type.toLowerCase()
							+'_input custom_field form-control field_length" id='
							+field.id+' name="'
							+field.field_label
							+'" max_len="'+max_len+'"></div></div>');
			}else{
				el = el.concat('<div class="control-group form-group "><label class="control-label '+label_style+'">'
						+field.field_label
						+'</label><div class="controls col-sm-9 '+div_col9_style+'"><input type="text" class="'
						+field.field_type.toLowerCase()
						+'_input custom_field form-control field_length" id='
						+field.id+' name="'
						+field.field_label
						+'" max_len="'+max_len+'"></div></div>');
			}
		}
	});

	return el;
}


/**
 * It builds UI for showing custom fields in the contacts-merge feature
 */
function show_custom_fields_helper_for_merge(custom_fields, contacts) {
	var el = "";
	$.each(custom_fields,function(index, field) {
		var elements = [];
		for (var i = 0; i < contacts.length; i++) {
			if(i===0){
				var checked = false;
				elements.push('<tr><td style="background-color:#f3f3f3">'
						+ field.field_label + '</td>');
			}
			var contact_field = contacts[i];
			for (var j = 0; j < contact_field.properties.length; j++) {
				var property = contact_field.properties[j];
				if (property.type == "CUSTOM"
					&& property.name == field.field_label) {
					var value = property.value;
					if (value) {
						checked = true;
						if (field.field_type.toLowerCase() == "date") {
							try {
								value = new Date(
										property.value * 1000)
								.format('mm/dd/yyyy');

							} catch (err) {
							}
						}
						if (i === 0) {
							var ele = '<td>'
								+ '<input type="radio" name="'
								+ field.field_label
								+ '" class="'
								+ field.field_type
								.toLowerCase()
								+ '" checked="checked" fieldtype="custom" oid="'
								+ contact_field.id
								+ '" id="'
								+ field.id
								+ '" field="'
								+ field.field_label
								+ '" data="'
								+ value + '">'
								+ value + '</td>';
							elements.push(ele);
							break;
						} else {
							var ele = '<td>'
								+ '<input type="radio" name="'
								+ field.field_label
								+ '" class="'
								+ field.field_type
								.toLowerCase()
								+ '" fieldtype="custom" oid="'
								+ contact_field.id
								+ '" id="'
								+ field.id
								+ '" field="'
								+ field.field_label
								+ '" data="'
								+ value + '">'
								+ value + '</td>';
							elements.push(ele);
							break;
						}
					}// end of if loop checking value is null or not
				}
				else if (j === contact_field.properties.length - 1) {
					var ele = '<td></td>';
					elements.push(ele);
				}
			} // end of contact properties for loop
			if(i===contacts.length-1){
				if(checked){
					for(var i=0;i<elements.length;i++){
						el = el.concat(elements[i]);
					}
					el = el.concat('</tr>');
				}
				elements.length = 0;
			}
		}// end of contacts for loop
	});
	return el;
}

/**
 * De-serializes custom fields (fills the matched custom field values of the entity 
 * (for list and check-box fields) to the generated html string above) and return 
 * string to handlebars register helper to return as handlebars safestring.
 * 
 * @method fill_custom_field_values
 * @param {String} form 
 * 				html string of custom field values
 * @param {Object} content json object including custom fields
 * @returns {String} prefilled html string with matched custom field values
 */
function fill_custom_field_values(form, content)
{
	console.log(content);
	$.each(content, function(index , property){
		if(property.type == "CUSTOM")
			{
				fill_custom_data(property, form);
			}
			
	});
	return $('<div>').append(form).html();
}

function fill_custom_fields_values_generic(form, content)
{
	$.each(content, function(index , property){
		fill_custom_data(property, form);
	});
	
	return $('<div>').append(form).html();
}

function fill_custom_data(property, form)
{
	if(!property.value)
		return;
	var element = $(form).find('*[name="' + property.name + '"]');
	console.log(element);
	// If custom field is deleted or not found with property name return
	if(!element[0])
		{
			return;
		}
	console.log($(element[0]).hasClass("date_input"))
		var tagName = element[0].tagName.toLowerCase();
		var type = element.attr("type");
		 console.log(property.value)
		 console.log($(element[0]));
	if(tagName == "input")
		{
			if(type == "checkbox" && property.value == "on")
				{
					element.attr("checked", "checked"); 
					return;
				}
			else if($(element[0]).hasClass("date_input"))
				{
				try {
					var dateString = new Date(property.value);
					if(dateString == "Invalid Date")
						element.attr("value", getDateInFormatFromEpoc(property.value));
					else
						element.attr("value", getDateInFormat(dateString));
					return;
				} catch (err) {

				}
				}
			
			element.attr("value", property.value);
			console.log(element.val());
		}
	if(tagName == "textarea")
		{
			element.html(property.value);							
		}
	if(tagName == "select")
		{
			if(property.value)
			element.find('option[value="'+property.value.trim()+'"]').attr("selected", "selected");
		}	
}

function serialize_custom_fields(form)
{
	var custom_field_elements =  $("#" + form).find('.custom_field');
	
	console.log(custom_field_elements.length);
   var arr = [];
    $.each(custom_field_elements, function(index, element){
    	name = $(element).attr('name');
    	
    	var json = {};
    	json.name = name;
    	var elem_type = $(element).attr('type')
    	json.value =  $(element).val();
    	
    	if(elem_type=='checkbox')json.value = $(element).is(':checked')?'on':'off';
    	if($(element).hasClass("date_input") && ($(element).val() !=undefined && $(element).val().trim() !=""))
    		if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
    			json.value = en.dateFormatter({raw: "MM/dd/yyyy"})(new Date(convertDateFromUKtoUS(this.value)));
    		else
    			json.value = en.dateFormatter({raw: "MM/dd/yyyy"})(new Date(this.value));
    	
    	
    	if(!json.value)
    		return;
        arr.push(json);
    });
   return arr;
}
function groupingCustomFields(base_model){
	var templateKey = "admin-settings-customfields-"+base_model.get("scope").toLowerCase();
	if(base_model.get("scope")=="CONTACT"){
		App_Admin_Settings.contactCustomFieldsListView = new Base_Collection_View({ url : '/core/api/custom-fields/scope/position?scope='+base_model.get("scope"), sortKey : "position", restKey : "customFieldDefs",
			templateKey : templateKey, individual_tag_name : 'tr',
			postRenderCallback : function(custom_el){
				enableCustomFieldsSorting(custom_el,'custom-fields-'+base_model.get("scope").toLowerCase()+'-tbody','admin-settings-customfields-'+base_model.get("scope").toLowerCase()+'-model-list');
			}});
		App_Admin_Settings.contactCustomFieldsListView.collection.fetch();
		$('#customfields-contacts-accordion', this.el).append($(App_Admin_Settings.contactCustomFieldsListView.render().el));
	}else if(base_model.get("scope")=="COMPANY"){
		App_Admin_Settings.companyCustomFieldsListView = new Base_Collection_View({ url : '/core/api/custom-fields/scope/position?scope='+base_model.get("scope"), sortKey : "position", restKey : "customFieldDefs",
			templateKey : templateKey, individual_tag_name : 'tr',
			postRenderCallback : function(custom_el){
				enableCustomFieldsSorting(custom_el,'custom-fields-'+base_model.get("scope").toLowerCase()+'-tbody','admin-settings-customfields-'+base_model.get("scope").toLowerCase()+'-model-list');
			}});
		App_Admin_Settings.companyCustomFieldsListView.collection.fetch();
		$('#customfields-companies-accordion', this.el).append($(App_Admin_Settings.companyCustomFieldsListView.render().el));
	}else if(base_model.get("scope")=="DEAL"){
		App_Admin_Settings.dealCustomFieldsListView = new Base_Collection_View({ url : '/core/api/custom-fields/scope/position?scope='+base_model.get("scope"), sortKey : "position", restKey : "customFieldDefs",
			templateKey : templateKey, individual_tag_name : 'tr',
			postRenderCallback : function(custom_el){
				enableCustomFieldsSorting(custom_el,'custom-fields-'+base_model.get("scope").toLowerCase()+'-tbody','admin-settings-customfields-'+base_model.get("scope").toLowerCase()+'-model-list');
			}});
		App_Admin_Settings.dealCustomFieldsListView.collection.fetch();
		$('#customfields-deals-accordion', this.el).append($(App_Admin_Settings.dealCustomFieldsListView.render().el));
	}else if(base_model.get("scope")=="CASE"){
		App_Admin_Settings.caseCustomFieldsListView = new Base_Collection_View({ url : '/core/api/custom-fields/scope/position?scope='+base_model.get("scope"), sortKey : "position", restKey : "customFieldDefs",
			templateKey : templateKey, individual_tag_name : 'tr',
			postRenderCallback : function(custom_el){
				enableCustomFieldsSorting(custom_el,'custom-fields-'+base_model.get("scope").toLowerCase()+'-tbody','admin-settings-customfields-'+base_model.get("scope").toLowerCase()+'-model-list');
			}});
		App_Admin_Settings.caseCustomFieldsListView.collection.fetch();
		$('#customfields-cases-accordion', this.el).append($(App_Admin_Settings.caseCustomFieldsListView.render().el));
	}
}
function enableCustomFieldsSorting(el,connClass,connId){
	head.js(LIB_PATH + 'lib/jquery-ui.min.js', function(){
		$('.'+connClass).sortable({
			axis: "y" ,
			containment: '.'+connClass,
			scroll: false,
			items:'tr',
			helper: function(e, tr){
			    var $originals = tr.children();
			    var $helper = tr.clone();
			    $helper.children().each(function(index)
			    {
			      // Set helper cell sizes to match the original sizes
			      $(this).width($originals.eq(index).width()+50);
			      $(this).css("background","#f5f5f5");
			      $(this).css("border-bottom","1px solid #ddd");
			      $(this).css("max-width",($originals.eq(index).width()+50)+"px");
			    });
			    return $helper;
			},
			/*start: function(event, ui){
				//alert(ui.width());
				$.each(ui.item.children(),function(index,ele){
					ui.helper.children().eq(index).width(ui.helper.children().eq(index).width()-$(this).width());
				});
				ui.helper.width(ui.helper.width());
			},*/
			sort: function(event, ui){
				ui.helper.css("top",(ui.helper.offset().top+ui.item.offset().top)+"px");
			},
			forceHelperSize:true,
			placeholder:'<tr><td></td></tr>',
			forcePlaceholderSize:true,
			handle: ".icon-move",
			cursor: "move",
			tolerance: "intersect"
		});
		
		/*
		 * This event is called after sorting stops to save new positions of
		 * custom fields
		 */
		$('.'+connClass,el).on("sortstop",function(event, ui){
			var models=[];
			$('#'+connId+' > tr').each(function(column){
				var model_id = $(this).data().id;
				
				models.push({ id : model_id, position : column+1 });
			});
			// Saves new positions in server
			$.ajax({ type : 'POST', url : '/core/api/custom-fields/positions', data : JSON.stringify(models),
				contentType : "application/json; charset=utf-8", dataType : 'json' });
		});
	});
}
/*$('#formulaData').live("change",function(e){
	var source = $(this).val();
	var tpl;
	var compiled=true;
	try{
		tpl = Handlebars.precompile(source);
	}catch(err){
		err.message;
		compiled=false;
		return false;
	}
});*/BLOB_KEY = undefined;
function initializeImportEvents(id){

if(!id)
	  id = "content";

$('#' + id  + " .upload").off('click');
$('#' + id).on('click', '.upload', function(e)
	{

		// get hidden value file type
		var type = $(this).parents('form').children("#type").val();

		e.preventDefault();
		var newwindow = window.open("upload-contacts.jsp?type=" + type + "", 'name', 'height=310,width=500');

		if (window.focus)
		{
			newwindow.focus();
		}
		return false;
	});


// Cancels import, removes the contacts uploaded in to
	// table, still calls
	// fileUploadInit,
	// so user can uploadimport-comp again if required
	$('#' + id  + " #import-cancel").off('click');
	$('#' + id).on('click', '#import-cancel', function(e){

		// Sends empty JSON to remove
		// contact uploaded
		var $firstDiv = $('#content').children().first();
		getTemplate('import-contacts', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$firstDiv.html($(template_ui));	
					initializeImportEvents($firstDiv.attr('id'));

				}, $firstDiv);
		
	});
	
	// cancel option for deals import
	$('#' + id  + " #deal-cancel").off('click');
	$('#' + id).on('click', '#deal-cancel', function(e){

				// Sends empty JSON to remove
				// contact uploaded
				var $firstDiv = $('#content').children().first();

				getTemplate('import-deals', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$firstDiv.html($(template_ui));	
					initializeImportEvents($firstDiv.attr('id'));

				}, $firstDiv);				
			});

$('#' + id  + " #import-contacts").off('click');
$('#' + id).on('click', '#import-contacts', function(e)
					{

						if ($(this).attr('disabled'))
							return;

						var upload_valudation_errors = {
							"first_name_missing" : { "error_message" : "First Name is mandatory. Please select first name." },
							"last_name_missing" : { "error_message" : "Last Name is mandatory. Please select last name." },
							"email_missing" : { "error_message" : "Email is mandatory. Please select Email." },
							"first_name_duplicate" : { "error_message" : " You have assigned First Name to more than one element. Please ensure that first name is assigned to only one element. " },
							"last_name_duplicate" : { "error_message" : "You have assigned Last Name to more than one element. Please ensure that last name is assigned to only one element." },
							"company_duplicate" : { "error_message" : "You have assigned Company to more than one element. Please ensure that company is assigned to only one element." },
							"job_title_duplicate" : { "error_message" : "You have assigned job description to more than one element. Please ensure that job description is assigned to only one element." },
							"invalid_tag" : { "error_message" : "Tag name should start with an alphabet and can not contain special characters other than underscore and space." },
							}

						var models = [];

						// Hide the alerts
						$(".import_contact_error").hide();

						// Headings validation Rammohan: 10-09-12
						/*
						 * Reads all the table heading set after importing
						 * contacts list from CSV and ensures that first_name
						 * and last_name fields are set, which are mandatory
						 * fields. Checks if duplicate table headings are set.
						 * If validations failed the error alerts a explaining
						 * the cause are shown
						 */

						var fist_name_count = 0, last_name_count = 0, emails_count = 0, company_count = 0, job_title_count = 0;
						$(".import-select").each(function(index, element)
						{
							var value = $(element).val()
							if (value == "properties_first_name")
								fist_name_count += 1;
							else if (value == "properties_last_name")
								last_name_count += 1;
							else if (value == "properties_company")
								company_count += 0;
							else if (value.indexOf("-email") != -1)
								emails_count += 1;
							else if (value == "properties_title")
								job_title_count += 1;
						})

						if (fist_name_count == 0)
						{
							getTemplate("import-contacts-validation-message", upload_valudation_errors.first_name_missing, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));	
								initializeImportEvents($firstDiv.attr('id'));

							}, "#import-validation-error");
							
							return false;
						}
						else if (emails_count == 0)
						{
							getTemplate("import-contacts-validation-message", upload_valudation_errors.email_missing, undefined, function(template_ui){
								if(!template_ui)
									  return;

								$('#import-validation-error').html($(template_ui));	
							}, "#import-validation-error");

							return false;
						}
						/*
						 * else if(lastNameCount.length == 0) {
						 * $("#import-validation-error").html(getTemplate("import-contacts-validation-message",
						 * upload_valudation_errors.last_name_missing)); return
						 * false; }
						 */
						else if (fist_name_count > 1)
						{
							getTemplate("import-contacts-validation-message", upload_valudation_errors.first_name_duplicate, undefined, function(template_ui){
								if(!template_ui)
									  return;
									
								$('#import-validation-error').html($(template_ui));	
							}, "#import-validation-error");

							return false;
						}
						else if (last_name_count > 1)
						{
							getTemplate("import-contacts-validation-message", upload_valudation_errors.last_name_duplicate, undefined, function(template_ui){
								if(!template_ui)
									  return;
									
								$('#import-validation-error').html($(template_ui));	
							}, "#import-validation-error");

							return false;
						}
						else if (company_count > 1)
						{
							getTemplate("import-contacts-validation-message", upload_valudation_errors.company_duplicate, undefined, function(template_ui){
								if(!template_ui)
									  return;
									
								$('#import-validation-error').html($(template_ui));	
							}, "#import-validation-error");

							return false;
						}
						else if (job_title_count > 1)
						{
							getTemplate("import-contacts-validation-message", upload_valudation_errors.job_title_duplicate, undefined, function(template_ui){
								if(!template_ui)
									  return;
									
								$('#import-validation-error').html($(template_ui));	
							}, "#import-validation-error");

							return false;
						}

						

						var properties = [];

						/*
						 * Iterates through all tbody tr's and reads the table
						 * heading from the table, push the table name as
						 * property name and value as property value as
						 * ContactField properties.
						 */
						var model = {};

						// Add Tags
						var tags = get_tags('import-contact-tags');
						console.log(tags);
						var tags_valid = true;
						if (tags != undefined)
						{
							$.each(tags[0].value, function(index, value)
							{
								if(!isValidTag(value, false)) {
									tags_valid = false;
									return false;
								}
								if (!model.tags)
									model.tags = [];

								console.log(model);

								model.tags.push(value);
							});
						}
						if(!tags_valid) {
							getTemplate("import-contacts-validation-message", upload_valudation_errors.invalid_tag, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$('#import-validation-error').html($(template_ui));	
							}, "#import-validation-error");

							return false;
						}
						
						$(this).attr('disabled', true);

						/*
						 * After validation checks are passed then loading is
						 * shown
						 */
						$waiting = $('<div style="display:inline-block;padding-left:5px"><small><p class="text-success"><i><span id="status-message">Please wait</span></i></p></small></div>');
						$waiting.insertAfter($('#import-cancel'));

						$('td.import-contact-fields').each(function(index, element)
						{

							console.log(this);
							console.log(index);
							// Empty property map (Represents
							// ContactField in contact.java)

							var property = {};

							// Read the name of the property from
							// table heading
							var select = $(this).find('select');
							console.log(select);
							var name = $(select).val();
							var type = $(select).find(":selected").attr('class') == 'CUSTOM' ? 'CUSTOM' : 'SYSTEM';
							console.log("name :" + name + ", type" + type);

							if (name.indexOf("properties_") != -1)
							{
								name = name.split("properties_")[1];
								property["type"] = type;
								if (name.indexOf('address-') != -1)
								{
									var splits = name.split("-");
									name = "address";
									property["subtype"] = "home";
									property["type"] = type;
									console.log(splits);
									// Set the value and name fields
									property["value"] = splits[1];
								}

								// Reads the sub type of the fields
								else if (name.indexOf("-") != -1)
								{
									var splits = name.split("-");
									name = splits[1];
									var subType = splits[0];
									if(subType=="GOOGLE"){
										property["subtype"] = "GOOGLE-PLUS";
									}else{
									property["subtype"] = subType;
									console.log($(select).attr('class'));
									property["type"] = type;
									}
								}

								// Set the value and name fields
								if (!property["value"])
									property["value"] = name;

								property["name"] = name;
								console.log(property);
								if (name.indexOf("_ignore_") != -1)
									property = {};
							}
							else
							{
								property["name"] = name;
							}

							// Push in to properties array (represents
							// ContactField array)
							properties.push(property);

						});

						model.properties = properties;
						model.type = "PERSON";

						// Shows Updating
						/*$waiting.find('#status-message').html(getRandomLoadingImg());*/

						// Represents prototype of contact, which specifies the
						// order of properties
						var contact = model;

						console.log(contact);

						// Sends request to save the contacts uploaded from csv,
						// present in the blobstore. Contact is sent to save
						// each row in csv file in to a contact
						$.ajax({ type : 'POST', url : "/core/api/upload/save?type=Contacts&key=" + BLOB_KEY, data : JSON.stringify(contact),
							contentType : "application/json", success : function(data)
							{
								// Navigate to contacts page
								// Sends empty JSON to remove
								// contact uploaded
								var $firstDiv = $('#content').first();

								getTemplate("import-contacts", {}, undefined, function(template_ui){
									if(!template_ui)
										  return;
									$firstDiv.html($(template_ui));

									initializeImportEvents($firstDiv.attr('id'));
									showNotyPopUp('information', "Contacts are now being imported. You will be notified on email when it is done", "top", 5000);
									addTagAgile(IMPORT_TAG);

								}, $firstDiv);

								
							}, });

					})


/**
 * validation for csv import companies
 */
$('#' + id  + " #import-comp").off('click');
$('#' + id).on('click', '#import-comp', function(e)
				{

					if ($(this).attr('disabled'))
						return;

					var upload_valudation_errors = { "company_name_missing" : { "error_message" : "Company Name is mandatory. Please select Company name." },
						"company_name_duplicated" : { "error_message" : "Company Name is Duplicated." }

					}
					var models = [];

					// Hide the alerts
					$(".import_contact_error").hide();

					// Headings validation jitendra: 28-08-14
					/*
					 * Reads all the table heading set after importing contacts
					 * list from CSV and ensures that company_name which are
					 * mandatory fields. Checks if duplicate table headings are
					 * set. If validations failed the error alerts a explaining
					 * the cause are shown
					 */
					company_count = 0;
					$(".import-select").each(function(index, element)
					{
						var value = $(element).val()
						if (value == "properties_name")
							company_count += 1;

					})

					if (company_count == 0)
					{
						getTemplate("import-company-validation-message", upload_valudation_errors.company_name_missing, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");						
						return false;
					}

					else if (company_count > 1)
					{
						getTemplate("import-company-validation-message", upload_valudation_errors.company_name_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");	

						return false;
					}

					$(this).attr('disabled', true);

					/*
					 * After validation checks are passed then loading is shown
					 */
					$waiting = $('<div style="display:inline-block;padding-left:5px"><small><p class="text-success"><i><span id="status-message">Please wait</span></i></p></small></div>');
					$waiting.insertAfter($('#import-cancel'));

					var properties = [];

					/*
					 * Iterates through all tbody tr's and reads the table
					 * heading from the table, push the table name as property
					 * name and value as property value as ContactField
					 * properties.
					 */
					var model = {};

					// Add Tags

					$('td.import-contact-fields').each(function(index, element)
					{

						console.log(this);
						console.log(index);
						// Empty property map (Represents
						// ContactField in contact.java)

						var property = {};

						// Read the name of the property from
						// table heading
						var select = $(this).find('select');
						console.log(select);
						var name = $(select).val();
						var type = $(select).find(":selected").attr('class') == 'CUSTOM' ? 'CUSTOM' : 'SYSTEM';
						console.log("name :" + name + ", type" + type);

						if (name.indexOf("properties_") != -1)
						{
							name = name.split("properties_")[1];
							property["type"] = type;
							if (name.indexOf('address-') != -1)
							{
								var splits = name.split("-");
								name = "address";
								property["subtype"] = "office";
								property["type"] = type;
								console.log(splits);
								// Set the value and name fields
								property["value"] = splits[1];
							}

							// Reads the sub type of the fields
							else if (name.indexOf("-") != -1)
							{
								var splits = name.split("-");
								
								name = splits[1];
								var subType = splits[0];
								if(subType=="GOOGLE"){
									property["subtype"] = "GOOGLE-PLUS";
								}else{
								property["subtype"] = subType;
								console.log($(select).attr('class'));
								property["type"] = type;
								}
							}

							// Set the value and name fields
							if (!property["value"])
								property["value"] = name;

							property["name"] = name;
							console.log(property);
							if (name.indexOf("_ignore_") != -1)
								property = {};
						}
						else
						{
							property["name"] = name;
						}

						// Push in to properties array (represents
						// ContactField array)
						properties.push(property);

					});

					model.properties = properties;
					model.type = "COMPANY";

					// Shows Updating
					/*$waiting.find('#status-message').html(getRandomLoadingImg());*/

					// Represents prototype of contact, which specifies the
					// order of properties
					var contact = model;

					console.log(contact);

					// Sends request to save the contacts uploaded from csv,
					// present in the blobstore. Contact is sent to save
					// each row in csv file in to a contact
					$.ajax({ type : 'POST', url : "/core/api/upload/save?type=Companies&key=" + BLOB_KEY, data : JSON.stringify(contact),
						contentType : "application/json", success : function(data)
						{
							// Navigate to contacts page
							// Sends empty JSON to remove
							// contact uploaded
							var $firstDiv = $('#content').first();

							getTemplate("import-contacts", {}, undefined, function(template_ui){
									if(!template_ui)
										  return;
									$firstDiv.html($(template_ui));
									initializeImportEvents($firstDiv.attr('id'));
									showNotyPopUp('information', "Companies are now being imported. You will be notified on email when it is done", "top", 5000);
							}, $firstDiv);	

						}, });

				});

/**
 * import deals validations
 */
$('#' + id  + " #import-deals").off('click');
$('#' + id).on('click', '#import-deals', function(e)
				{

					if ($(this).attr('disabled'))
						return;

					var upload_valudation_errors = {
							"deal_name_missing" : { "error_message" : "Deal Name is mandatory. Please select deal name." },
							"deal_duplicated" : { "error_message" : "Deal Name field is duplicated" },
							"deal_value_duplicated" : { "error_message" : "Deal value field is duplicated" },
							"deal_track_duplicated" : { "error_message" : "Deal track field is duplicated" },
							"deal_milestone_duplicated" : {"error_message" : "Milestone field is duplicated."},
							"deal_related_contact_duplicated" : {"error_message" : "Deal relatsTo field duplicated" },
							"deal_probability_duplicated" : {"error_message" : "Deal probability field is duplicated"},
							"deal_close_date_duplicated" : {"error_message" : "Deal close date field is duplicated"},
							"deal_note_duplicated" : {"error_message" : "Deal Note field duplicated"},
							"deal_description_duplicated" : {"error_message":"Deal descriptions field is duplicated"},
					}
					var models = [];

					// Hide the alerts
					$(".import_contact_error").hide();

					// Headings validation jitendra: 28-08-14
					/*
					 * Reads all the table heading set after importing contacts
					 * list from CSV and ensures that company_name which are
					 * mandatory fields. Checks if duplicate table headings are
					 * set. If validations failed the error alerts a explaining
					 * the cause are shown
					 */
					deal_count = 0, value_count = 0, probability_count = 0, milestone_count = 0, track_count = 0,	close_date_count=0,related_count=0,note_count=0,description_count = 0;
					$(".import-select").each(function(index, element)
					{
						var value = $(element).val();
						if (value == "properties_name")
							deal_count += 1;
						if (value == "properties_value")
							value_count += 1;
						if (value == "properties_probability")
							probability_count += 1;
						if (value == "properties_milestone")
							milestone_count += 1;
						if (value == "properties_track")
							track_count += 1;
						if(value == "properties_closeDate")
										close_date_count +=1;
						if(value == "properties_relatedTo")
										related_count +=1;
						if(value == "properties_note")
										note_count +=1;
						if(value == "properties_description")
										description_count +=1;
										

					});

					if (deal_count == 0)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_name_missing, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");

						return false;
					}
			

					else if (deal_count > 1)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");
						return false;
					}

					else if (value_count > 1)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_value_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");

						return false;
					}

					else if (track_count > 1)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_track_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");

						return false;
					}

					else if (milestone_count > 1)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_milestone_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");

						return false;
					}
					
					else if (related_count > 1)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_related_contact_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");

						return false;
					}

					else if (probability_count > 1)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_probability_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");

						return false;
					}
					
					else if (close_date_count > 1)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_close_date_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");

						return false;
					}
					
					else if (note_count > 1)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_note_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");

						return false;
					}
					
					else if (description_count > 1)
					{
						getTemplate("import-deal-validation-message", upload_valudation_errors.deal_description_duplicated, undefined, function(template_ui){
								if(!template_ui)
									  return;
								$("#import-validation-error").html($(template_ui));
						}, "#import-validation-error");

						return false;
					}

					$(this).attr('disabled', true);

					/*
					 * After validation checks are passed then loading is shown
					 */
					$waiting = $('<div style="display:inline-block;padding-left:5px"><small><p class="text-success"><i><span id="status-message">Please wait</span></i></p></small></div>');
					$waiting.insertAfter($('#import-cancel'));

					var properties = [];

					/*
					 * Iterates through all tbody tr's and reads the table
					 * heading from the table, push the table name as property
					 * name and value as property value as ContactField
					 * properties.
					 */
					var model = {};

					// Add Tags

					$('td.import-contact-fields').each(function(index, element)
					{

						console.log(this);
						console.log(index);
						// Empty property map (Represents
						// ContactField in contact.java)

						var property = {};

						// Read the name of the property from
						// table heading
						var select = $(this).find('select');
						console.log(select);
						var name = $(select).val();
						var type = $(select).find(":selected").attr('class') == 'CUSTOM' ? 'CUSTOM' : 'SYSTEM';
						console.log("name :" + name + ", type" + type);

						if (name.indexOf("properties_") != -1)
						{
							name = name.split("properties_")[1];
							property["type"] = type;

							// Set the value and name fields
							if (!property["value"])
								property["value"] = name;

							property["name"] = name;
							console.log(property);
							if (name.indexOf("_ignore_") != -1)
								property = {};
						}
						else
						{
							property["name"] = name;
						}

						// Push in to properties array (represents
						// ContactField array)
						properties.push(property);

					});

					model.properties = properties;

					// Shows Updating
					$waiting.find('#status-message').html(getRandomLoadingImg());

					// Represents prototype of contact, which specifies the
					// order of properties
					var Opportunity = model;

					console.log(Opportunity);

					// Sends request to save the contacts uploaded from csv,
					// present in the blobstore. Contact is sent to save
					// each row in csv file in to a contact
					$.ajax({ type : 'POST', url : "/core/api/upload/save?type=Deals&key=" + BLOB_KEY, data : JSON.stringify(Opportunity),
						contentType : "application/json", success : function(data)
						{
							// Navigate to contacts page
							// Sends empty JSON to remove
							// contact uploaded

							showNotyPopUp('information', "Deals are now being imported. You will be notified on email when it is done", "top", 5000);
							location.href = window.location.origin + "#deals";
							// Calls vefiryUploadStatus with data returned
							// from the url i.e., key of the memcache
							// verifyUploadStatus(data);
						}, });

				});

}



/**
 * Receives blobkey from the CSV upload popup after storing in blobstore, and
 * request is set to process the CSV and return first 10 contacts where user can
 * set the fields
 * 
 * @param key
 */
function parseCSV(key, type)
{

	BLOB_KEY = key;
	$("#upload_contacts").after(getRandomLoadingImg());

	$.getJSON('core/api/upload/process?blob-key=' + key, function(data)
			{
				var template;
				console.log(data);
				if (data == undefined)
					return;
				constructCustomfieldOptions(type, function(fields, el)
				{
					/*
					 * $('#custom_fields', template).each(function(index,
					 * element) { $(element).html(el); });
					 */
					data["custom_fields"] = fields.toJSON();
					var template_name = "";

					if (type == "contacts")
						  template_name = "import-contacts-2";
					else if(type == "company")
					  	  template_name = "import-companies";
					else if(type == "deals")
					  	  template_name = "import-deals2";

					
					var $firstDiv = $('#content').children().first();
					getTemplate(template_name, data, undefined, function(template_ui){
						if(!template_ui)
							  return;
						$firstDiv.html($(template_ui));
						initializeImportEvents($firstDiv.attr('id'));
						setup_tags_typeahead();

					}, $firstDiv);					
				})

			})
			.error(
					function(response)
					{
						// Show cause of error in saving
						$save_info = $('<div style="display:inline-block;margin-left:5px"><small><p style="color:#B94A48; font-size:14px"><i>' + response.responseText + '</i></p></small></div>');

						$(".loading").remove();
						// block.
						$("#upload_contacts").after($save_info);

						// Hides the error message after 3
						// seconds
						$save_info.show().delay(3500).hide(1);
					})
}

/**
 * Loads custom fields available and creates options
 * 
 * @param callback
 */
function constructCustomfieldOptions(type, callback)
{

	var custom_fields;
	if (type == "contacts")
	{
		custom_fields = Backbone.Collection.extend({ url : 'core/api/custom-fields/byscope?scope=CONTACT' });
	}
	else if (type == "company")
	{
		custom_fields = Backbone.Collection.extend({ url : 'core/api/custom-fields/byscope?scope=COMPANY' });
	}
	else if (type == "deals")
	{
		custom_fields = Backbone.Collection.extend({ url : 'core/api/custom-fields/byscope?scope=DEAL' });
	}

	new custom_fields().fetch({ success : function(data)
	{
		var el = "";
		$.each(data.toJSON(), function(index, field)
		{
			el = el + '<option value ="' + field.field_label + '" id="' + field.field_type + '">' + field.field_label + '</option>'
		})
		if (callback && typeof (callback) === "function")
			callback(data, el);
	} });

}
/**
 * Defines actions on events on imports contacts element, which does validation
 * on the import template, whether contact have first_name last_name which are
 * mandatory fields. If first naRme and last name are not specified or specified
 * same label for different fields then error message is shown and will not send
 * request to save.
 */







function initializeImportListeners(){

	$('#prefs-tabs-content #xero_sync_prefs').off();
	$('#prefs-tabs-content').on('click', '#xero_sync_prefs', function(e){
		e.preventDefault();
		var disable = $(this).attr('disabled');
		if(disable)
			return false;
		$(this).attr("disabled", "disabled");
		$(this).text("Syncing");
		
		var xeroPrefs = serializeForm("quickbook-form");
		xeroPrefs['inProgress'] = true;
		
		App_Widgets.xero_import_settings.model.set(xeroPrefs, {silent:true});
		var url = App_Widgets.xero_import_settings.model.url;

		$(this).after(getRandomLoadingImg());
		App_Widgets.xero_import_settings.model.url = url + "?sync=true"
		App_Widgets.xero_import_settings.model.save({}, {success : function(data){
		
			App_Widgets.xero_import_settings.render(true);
			App_Widgets.xero_import_settings.model.url = url;	
				show_success_message_after_save_button("Sync Initiated", App_Widgets.xero_import_settings.el);
				showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
			}});
		
	});
	

	//oauth request for xero
$('#prefs-tabs-content #xeroconnect').off();
$('#prefs-tabs-content').on('click', '#xeroconnect', function(e){
	var callbackURL = window.location.href;
	console.log(callbackURL);

	// For every request of import, it will ask to grant access
	window.location = "/scribe?service=xero&return_url=" + encodeURIComponent(callbackURL);
	return false;
});
}

function show_success_message_after_save_button(message, el)
{
	
	/*
	 * Appends success message to form
	 * actions block in form, if window
	 * option is not set for view
	 *
	 */
	$save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px" class="text-success"><i>'+message+'</i></p></small></div>');
	$(".form-actions", el).append($save_info);
	$save_info.show().delay(3000).hide(1);	
		
}




//Compute the edit distance between the two given strings
function getEditDistance(a, b) {
  if(a.length === 0) return b.length; 
  if(b.length === 0) return a.length; 
 
  var matrix = [];
 
  // increment along the first column of each row
  var i;
  for(i = 0; i <= b.length; i++){
    matrix[i] = [i];
  }
 
  // increment each column in the first row
  var j;
  for(j = 0; j <= a.length; j++){
    matrix[0][j] = j;
  }
 
  // Fill in the rest of the matrix
  for(i = 1; i <= b.length; i++){
    for(j = 1; j <= a.length; j++){
      if(b.charAt(i-1) == a.charAt(j-1)){
        matrix[i][j] = matrix[i-1][j-1];
      } else {
        matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, // substitution
                                Math.min(matrix[i][j-1] + 1, // insertion
                                         matrix[i-1][j] + 1)); // deletion
      }
    }
  }
 
  return matrix[b.length][a.length];
};/**
 * This file is used for filters shown in lhs of contacts page.
 */

var scrambled_index = 0;
function scramble_filter_input_names(el)
{
	$(el).find("input[type=text],input[type=number]").each(function()
	{
		$(this).attr('name', 'temp-' + scrambled_index);
		$(this).attr('id', 'temp-' + scrambled_index);
		scrambled_index += 1;
	});
}

function setupLhsFilters(cel, is_company)
{
	var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
	if (is_company)
	{
		getTemplate("companies-lhs-filters", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$('#lhs_filters_conatiner', cel).html($(template_ui));

			fillSelect('owner_select', '/core/api/users', undefined, function()
			{
				if (!COMPANY_CUSTOM_FIELDS)
				{
					$.getJSON("core/api/custom-fields/searchable/scope?scope=COMPANY", function(fields)
					{
						COMPANY_CUSTOM_FIELDS = fields;
						loadCustomFiledsFilters(fields, cel, is_company);
						return;
					})
				}
				else
				{
					loadCustomFiledsFilters(COMPANY_CUSTOM_FIELDS, cel, is_company);
				}
			
			}, optionsTemplate, false, $('#lhs_filters_conatiner', cel));

		}, $('#lhs_filters_conatiner', cel));

		

	}
	else
	{

		getTemplate("contacts-lhs-filters", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$('#lhs_filters_conatiner', cel).html($(template_ui));
			
			fillSelect('owner_select', '/core/api/users', undefined, function()
			{
				fillSelect('campaign_select_master', '/core/api/workflows', undefined, function()
				{
					// loading image is added to hidden select by fillselect
					// remove it manually.
					$('#campaign_select_master').next('.loading').remove();
					$('#campaign_select').html($('#campaign_select_master').html());
					if (!SEARCHABLE_CONTACT_CUSTOM_FIELDS)
					{
						$.getJSON("core/api/custom-fields/searchable/scope?scope=CONTACT", function(fields)
						{
							SEARCHABLE_CONTACT_CUSTOM_FIELDS = fields;
							loadCustomFiledsFilters(fields, cel, is_company);
							return;
						})
					}
					else
					{
						loadCustomFiledsFilters(SEARCHABLE_CONTACT_CUSTOM_FIELDS, cel, is_company);
					}
					$('[data-toggle="tooltip"]').tooltip();
					//showDynamicFilters();
				}, optionsTemplate, false, $('#lhs_filters_conatiner', cel));
			}, optionsTemplate, false, $('#lhs_filters_conatiner', cel));

		}, $('#lhs_filters_conatiner', cel));

		

	}

}

function loadCustomFiledsFilters(fields, cel, is_company)
{
	getTemplate("contacts-lhs-filters-custom", fields, undefined, function(template_ui){
		if(!template_ui)
			  return;
		$('#custom-filter-fields', cel).html($(template_ui));

		// $('#custom-filter-fields', cel).find("input.date").datepicker({ format :
		// 'mm/dd/yyyy'});
		addTagsTypeaheadLhs($('#tags-lhs-filter-table', cel).find("div.lhs-contact-filter-row").find('#RHS'));
		$("input.date", cel).datepicker({ format :CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY, autoclose : true });
		// $('#custom-filter-fields', cel).find("input.date").datepicker({ format :
		// 'mm/dd/yyyy'});

		scramble_filter_input_names(cel);
		if (is_company && readData('dynamic_company_filter'))
		{
			deserializeLhsFilters($('#lhs-contact-filter-form'), readData('dynamic_company_filter'));
		}
		if (!is_company && readData('dynamic_contact_filter'))
		{
			deserializeLhsFilters($('#lhs-contact-filter-form'), readData('dynamic_contact_filter'));
		}

	}, $('#custom-filter-fields', cel));
	
}

function submitLhsFilter()
{
	$("#contacts-view-options").css( 'pointer-events', 'none' );
	var formData = serializeLhsFilters($('#lhs-contact-filter-form'))
	// erase filter cookies
	var contact_type = formData.contact_type;
	if(contact_type == 'COMPANY') {
		eraseCookie('company_filter');
		eraseData('dynamic_company_filter');
		if (formData != null && formData.rules.length > 0)
		{
			storeData('dynamic_company_filter', JSON.stringify(formData));
			//createCookie('company_filter', "Companies");
		}
		COMPANIES_HARD_RELOAD=true;
		App_Companies.companies(undefined, undefined, undefined, true);
	} else {
		eraseCookie('contact_filter');
		eraseCookie('contact_filter_type');
		eraseData('dynamic_contact_filter');
		if (formData != null && formData.rules.length > 0)
			storeData('dynamic_contact_filter', JSON.stringify(formData));
		CONTACTS_HARD_RELOAD=true;
		App_Contacts.contacts(undefined, undefined, undefined, true);
	}
}


function contactFiltersListeners(container_id){

if(!container_id)
	  container_id = 'contacts-listener-container';

$('#' + container_id).on('click', 'a.filter-multiple-add-lhs', function(e)
{
	e.preventDefault();
	var fieldName = $(this).data('name');
	var htmlContent = $('#' + fieldName + '-lhs-filter-table').find("div.hide.master-" + fieldName + "-add-div").clone();
	htmlContent.removeClass('hide').addClass("lhs-contact-filter-row");
	if (fieldName == 'tags')
	{
		addTagsTypeaheadLhs(htmlContent);
	}
	scramble_filter_input_names(htmlContent);
	$(htmlContent).appendTo('#' + fieldName + '-lhs-filter-table');
	$('#' + fieldName + '-lhs-filter-table').find("div.lhs-contact-filter-row:last").find('#RHS:visible').find(':not(input.date)').focus();
});

// Filter Contacts- Remove Multiple
$('#' + container_id).on('click', 'i.filter-tags-multiple-remove-lhs', function(e)
{
	var container = $(this).parents('.lhs-contact-filter-row');
	$(container).find('#RHS').children().val("").trigger('blur').trigger('custom_blur').trigger('change').trigger('custom_change');
	$(this).closest('div.lhs-contact-filter-row').remove();

});

// Filter Contacts- Remove Multiple
$('#' + container_id).on('click', 'a.clear-filter-condition-lhs', function(e)
{
	
	$(this).addClass('hide');
	var container = $(this).parents('.lhs-row-filter');
	$(container).find('#RHS').children().val("").attr('prev-val', "");
	$(container).find('#RHS_NEW').filter(visibleFilter).children().val("").attr('prev-val', "");
	$(container).find('select[name="CONDITION"]').val($(container).find('select[name="CONDITION"] option:first').val()).attr('prev-val', "");
	$(container).find('select[name="CONDITION"]').trigger('change');
	$(container).find('a#lhs-filters-header').find('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o');
	$(container).find('a#lhs-filters-header').next().addClass('hide');
	submitLhsFilter();
});

$('#' + container_id).on('click', '#clear-lhs-contact-filters', function(e)
{
	e.preventDefault();
	eraseData('dynamic_contact_filter');
	CONTACTS_HARD_RELOAD = true;
	App_Contacts.contacts();
});

$('#' + container_id).on('click', '#clear-lhs-company-filters', function(e)
{
	e.preventDefault();
	eraseData('dynamic_company_filter');
	COMPANIES_HARD_RELOAD=true;
	App_Companies.companies();
});

$('#' + container_id).on('click', '#lhs-filters-header', function(e)
{
	e.preventDefault();
	$(this).find('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o');
	$(this).next().toggleClass('hide');
	$(this).next().find('.lhs-contact-filter-row:visible').find('#RHS').filter(visibleFilter).find(':not(input.date)').focus();
});

$('#' + container_id).on('change', '#lhs-contact-filter-form select[name="CONDITION"]', function(e)
{
	var selected = $(this).val();
	$(this).parent().find('div.condition_container').addClass('hide');
	$(this).parent().find('div.condition_container.' + selected).removeClass('hide');
	$(this).parent().find('div.condition_container.' + selected).find('#RHS :not(input.date)').focus();
	var rhs = $(this).parent().find('div.condition_container.' + selected).find('#RHS').children().first().val();
	var rhs_new_exist = false;
	var rhs_new = "";
	if ($(this).parent().find('div.condition_container.' + selected).find('#RHS_NEW') != undefined)
	{
		rhs_new_exist = true;
		rhs_new = $(this).parent().find('div.condition_container.' + selected).find('#RHS_NEW').children().first().val();
	}
	if (rhs != "" && (!rhs_new_exist || rhs_new != ""))
	{
		submitLhsFilter();
	}
});


$('#' + container_id).on('custom_blur keyup', '#lhs-contact-filter-form #RHS input.filters-tags-typeahead:not(.date)', function(e)
{
	console.log("I am in blur " + $(this).val());
	if (e.type == 'custom_blur' || e.type == 'focusout' || e.keyCode == '13')
	{
		var prevVal = $(this).attr('prev-val');
		var currVal = $(this).val().trim();
		if (prevVal == currVal)
		{
			return;
		}
		else
		{
			$(this).attr('prev-val', currVal);
		}
		if ($(this).parent().next().attr("id") == "RHS_NEW")
		{
			if ($(this).parent().next().find('input').val() != "" && currVal != "")
			{
				submitLhsFilter();
				$(this).blur();
			}
		}
		else
		{
			if (currVal == "")
			{
				var container = $(this).parents('.lhs-contact-filter-row');
				$(container).find('a.clear-filter-condition-lhs').addClass('hide');
			}
			submitLhsFilter();
			$(this).blur();
		}
	}
});

$('#' + container_id).on('blur keyup', '#lhs-contact-filter-form #RHS input:not(.date,.filters-tags-typeahead)', function(e)
{
	console.log("I am in blur " + $(this).val());
	if (e.type == 'focusout' || e.keyCode == '13')
	{
		var prevVal = $(this).attr('prev-val');
		var currVal = $(this).val().trim();
		if (prevVal == currVal)
		{
			return;
		}
		else
		{
			$(this).attr('prev-val', currVal);
		}
		if ($(this).parent().next().attr("id") == "RHS_NEW")
		{
			if ($(this).parent().next().find('input').val() != "" && currVal != "")
			{
				submitLhsFilter();
				$(this).blur();
			}
		}
		else
		{
			if (currVal == "")
			{
				var container = $(this).parents('.lhs-contact-filter-row');
				$(container).find('a.clear-filter-condition-lhs').addClass('hide');
			}
			submitLhsFilter();
			$(this).blur();
		}
	}
});

$('#' + container_id).on('change keyup', '#lhs-contact-filter-form #RHS input.date', function(e)
{
	if (e.type == 'change' || e.keyCode == '13')
	{
		var prevVal = $(this).attr('prev-val');
		var currVal = $(this).val().trim();
		if (prevVal == currVal)
		{
			return;
		}
		else
		{
			$(this).attr('prev-val', currVal);
		}
		if ($(this).parent().next().attr("id") == "RHS_NEW")
		{
			if ($(this).parent().next().find('input').val() != "" && currVal != "")
			{
				submitLhsFilter();
				$(this).blur();
			}
		}
		else
		{
			if (currVal == "")
			{
				var container = $(this).parents('.lhs-contact-filter-row');
				$(container).find('a.clear-filter-condition-lhs').addClass('hide');
			}
			submitLhsFilter();
			$(this).blur();
		}
	}
});

$('#' + container_id).on('change', '#lhs-contact-filter-form #RHS select', function(e)
{
	if ($(this).parent().next().attr("id") == "RHS_NEW")
	{
		if ($(this).val() != "" && $(this).parent().next().children().val() != "")
		{
			submitLhsFilter();
		}
		if ($(this).val() == "" && $(this).parent().next().children().val() == "")
		{
			var container = $(this).parents('.lhs-contact-filter-row');
			$(container).find('a.clear-filter-condition-lhs').addClass('hide');
			submitLhsFilter();
		}
	}
	else
	{
		var prevVal = $(this).attr('prev-val');
		var currVal = $(this).val().trim();
		if (prevVal == currVal)
		{
			return;
		}
		else
		{
			$(this).attr('prev-val', currVal);
		}
		if ($(this).val() == "")
		{
			var container = $(this).parents('.lhs-contact-filter-row');
			$(container).find('a.clear-filter-condition-lhs').addClass('hide');
		}
		submitLhsFilter();
	}
	$(this).blur();
});

$('#' + container_id).on('change', '#lhs-contact-filter-form #RHS_NEW select', function(e)
{
	if ($(this).parent().prev().attr("id") == "RHS")
	{
		if ($(this).val() != "" && $(this).parent().prev().children().val() != "")
		{
			submitLhsFilter();
		}
		if ($(this).val() == "" && $(this).parent().prev().children().val() == "")
		{
			submitLhsFilter();
		}
	}
	else
	{
		submitLhsFilter();
	}
	$(this).blur();
});

$('#' + container_id).on('blur keyup', '#lhs-contact-filter-form #RHS_NEW input:not(.date)', function(e)
{
	if (e.type == 'focusout' || e.keyCode == '13')
	{
		var prevVal = $(this).attr('prev-val');
		var currVal = $(this).val().trim();
		if (prevVal == currVal)
		{
			return;
		}
		else
		{
			$(this).attr('prev-val', currVal);
		}
		if ($(this).parent().prev().attr("id") == "RHS")
		{
			if ($(this).parent().prev().find('input').val() != "")
			{
				submitLhsFilter();
				$(this).blur();
			}
		}
		else
		{
			if (currVal != "")
			{
				submitLhsFilter();
				$(this).blur();
			}
		}
	}
});

$('#' + container_id).on('change keyup', '#lhs-contact-filter-form #RHS_NEW input.date', function(e)
{
	if (e.type == 'change' || e.keyCode == '13')
	{
		var prevVal = $(this).attr('prev-val');
		var currVal = $(this).val().trim();
		if (prevVal == currVal)
		{
			return;
		}
		else
		{
			$(this).attr('prev-val', currVal);
		}
		if ($(this).parent().prev().attr("id") == "RHS")
		{
			if ($(this).parent().prev().find('input').val() != "")
			{
				submitLhsFilter();
				$(this).blur();
			}
		}
		else
		{
			if (currVal != "")
			{
				submitLhsFilter();
				$(this).blur();
			}
		}
	}
});


     $('#' + container_id).on('click', '#contacts-left-filters-toggle', function(e)
		{
			e.preventDefault();

			if ($('#contacts-lhs-filters-toggle').is(':visible'))
			{
				$('#contacts-lhs-filters-toggle').hide();
				createCookie(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS, "hide");
			}
			else
			{
				$('#contacts-lhs-filters-toggle').show();
				createCookie(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS, "show");
			}

		});


      $('#' + container_id).on('click', '.contacts-view', function(e)
    		{
				e.preventDefault();

    				var data=$(this).attr("data");
    				if(data=="list"){
    					CONTACTS_HARD_RELOAD=true;
    					eraseCookie("agile_contact_view");
    				}
    				else if(data=="grid"){
    					createCookie("agile_contact_view","grid-view");
    					CONTACTS_HARD_RELOAD=true;
    				}
    				if(window.location.hash.indexOf("tags")==1){
    					App_Contacts.contacts(window.location.hash.substr(window.location.hash.lastIndexOf("/")+1));
    					return;
    				}
    				App_Contacts.contacts();
    	   });

}
/**
 * Added tags typeahead on fields
 * 
 * @param element
 */
function addTagsTypeaheadLhs(element)
{
	var tags_array = [];

	// 'TAGS' are saved in global variable when they are fetched to show stats
	// in contacts page. If it is undefined, tags are fetched from DB an then
	// type ahead is built
	if (!TAGS)
	{
		var TagsCollection = Backbone.Collection.extend({ url : '/core/api/tags', sortKey : 'tag' });

		tagsCollection = new TagsCollection();

		tagsCollection.fetch({ success : function(data)
		{
			TAGS = tagsCollection.models;
			addTagsTypeaheadLhsFilters(tagsCollection.toJSON(), element);

		} });
		return;
	}

	// Adds typeahead to given element
	addTagsTypeaheadLhsFilters(tagsCollection.toJSON(), element);
}

// With tags JSON sent type ahead is built on input fields
function addTagsTypeaheadLhsFilters(tagsJSON, element)
{
	var tags_array = [];

	$.each(tagsJSON, function(index, element)
	{
		tags_array.push(element.tag.toString());
	});

	// $("input", element).attr("data-provide","typeahead");
	$("input", element).typeahead({ "source" : tags_array, updater : function(item)
	{
		console.log("I am in updater " + item);
		this.$element.val(item);
		this.$element.trigger('custom_blur');
		this.hide();
		return item;
	} }).attr('placeholder', "Enter Tag");
}

function bindChangeEvent(ele){

	console.log("I am in change " + $(ele).val());
	var prevVal = $(ele).attr('prev-val');
	var currVal = $(ele).val().trim();
	if (prevVal == currVal)
	{
		return;
	}
	else
	{
		$(ele).attr('prev-val', currVal);
	}
	if ($(ele).parent().next().attr("id") == "RHS_NEW")
	{
		if ($(ele).parent().next().find('input').val() != "" && currVal != "")
		{
			submitLhsFilter();
			// $(ele).blur();
		}
	}
	else
	{
		if (currVal == "")
		{
			var container = $(ele).parents('.lhs-contact-filter-row');
			$(container).find('a.clear-filter-condition-lhs').addClass('hide');
		}
		submitLhsFilter();
		// $(ele).blur();
	}


}function displayTimeZone(results)
{
	console.log("In displayTimeZone");
		
	var latitude;
	var longitude;
	var i = 0;
	$.each(results[0].geometry.location, function(idx, obj) {
		console.log(obj);
		if(i==0)
		  latitude = obj;
		else if(i==1) 
		  longitude = obj;
		i++;
	});

	if(!latitude || !longitude)
		return;
	
	$.ajax({ 
		url : "/core/api/contacts/gettz/" + latitude + "/" + longitude, 
		type : 'GET', 
		dataType : 'text', 
		success : function(data)
	   {
		if (data == null || data == "")
			return;

		$(".contacts-time").html("Local time: "+data);
		$("#contacts-local-time").show();
		$("#map_view_action").html("<i class='icon-minus text-sm c-p' title='Hide map' id='disable_map_view'></i>");

	   }, error : function(jqXHR, textStatus, errorThrown)
	   {
		console.log("jqXHR: " + jqXHR.status + "\ntextStatus: " + textStatus + "\nerrorThrown: " + errorThrown);
	   } 
	   });
}
/**
 * contactTableView is customized function (customization of appendedItem

 * function in Base_Collection_View), when custom view is selected, this
 * function is called whenever a new contact is added or contact list is fetched
 * (called on each contact model from Base_collection_View render function) .
 * when a custom view is selected then collection view is initialized with
 * modelData option for view is "custom view" object, since model data is custom
 * view object, it includes fields_set which defines the order of the files
 * (first_name, last_name, job title, organization..etc). This function iterates
 * through fields_set in CustomView object and loads the template according to
 * the field (Template are set for each field with name 'contacts-custom-view-' +
 * field name) and creates a view model template which is appended to collection
 * template.
 * 
 * @param base_model
 */
var CURRENT_VIEW_OBJECT;

function contactTableView(base_model,customDatefields,view) {
	
	var templateKey = 'contacts-custom-view-model';
	var gridViewEl = readCookie("agile_contact_view");
	if (gridViewEl) {
		templateKey = 'contacts-grid';
	}

	// Creates list view for
	var itemView = new Base_List_View({
		model : base_model,
		template : templateKey,
		tagName : view.options.individual_tag_name
	});

	// Reads the modelData (customView object)
	var modelData = view.options.modelData;

	// Reads fields_set from modelData
	var fields = modelData['fields_set'];

	// Converts base_model (contact) in to JSON
	var contact = base_model.toJSON();
	var el = itemView.el;

	if (!gridViewEl || window.location.hash=="#companies") {
	
		// Clears the template, because all the fields are appended, has to be reset
		// for each contact
		// $('#contacts-custom-view-model-template').empty();
		
		// Iterates through, each field name and appends the field according to
		// order of the fields
		$.each(fields, function(index, field_name) {
			if(field_name.indexOf("CUSTOM_") != -1)
			{
				field_name = field_name.split("CUSTOM_")[1]; 			
				var property = getProperty(contact.properties, field_name);
				var json = {};
				if(!property)
				{
					json.id = contact.id;
					getTemplate('contacts-custom-view-custom', json, undefined, function(template_ui){
						if(!template_ui)
							  return;
						$(el).append($(template_ui));
					}, null);
					return;
				}
				if(isDateCustomField(customDatefields,property)){
					console.log('got true');
					json = property;
					json.id = contact.id;
					getTemplate('contacts-custom-view-custom-date', json, undefined, function(template_ui){
						if(!template_ui)
							  return;
						$(el).append($(template_ui));
					}, null);
				}
				else
				{
					json = property;
					json.id = contact.id;
					getTemplate('contacts-custom-view-custom', json, undefined, function(template_ui){
						if(!template_ui)
							  return;
						$(el).append($(template_ui));
					}, null);
					
				}
				return;
			}
			
			getTemplate('contacts-custom-view-' + field_name, contact, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$(el).append($(template_ui));
			}, null);
		});

	} else  {
		getTemplate('contacts-grid-model', contact, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$(el).append($(template_ui));
			}, null);
	}
				
	// Appends model to model-list template in collection template
	$(('#'+view.options.templateKey+'-model-list'), view.el).append(el);

	// Sets data to tr
	$(('#'+view.options.templateKey+'-model-list'), view.el).find('tr:last').data(
			base_model);
}

// Check whether the given fields list has the property name.
function isDateCustomField(customDatefields,property){
	var count = 0;
	$.each(customDatefields,function(index,field){
		if(field.field_label==property.name)
			count++;
	});
	return count>0;
}

/**
 * Gets the list of custom fields saved by the user, and shown in the Html
 * element with "view-list" in the Html element sent to this method. It fetches
 * the list of custom fields and on rendering the collection unordered list of
 * created and appended in view-list element in contacts page. If custom view
 * selected from the list, this function is called with button name from the
 * customView function, which is set on the list button.
 * 
 * @param cel
 *            html element
 * @param button_name
 *            name of the button (name of the view)
 */
function setupViews(cel, button_name) {

	// Creates a view for custom views
	/*head.load(CSS_PATH + 'css/bootstrap_submenu.css',  function()
	{*/
		getTemplate("contact-view-collection", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			
			var el = $(template_ui);
			$("#view-list", cel).html(el);
			
			// If button_name is defined, then view is selected then the name of
			// the view is show in the custom view button.
			if (button_name)
				$("#view-list", cel).find('.custom_view').append(button_name);
			//updates the selected sort item to bold
			updateSelectedSortKey($("#view-list", cel));
			addClickEventsForSorting($("#view-list", cel));
			if(readCookie('company_filter') || readCookie('contact_filter_type') == 'COMPANY')
			{
				$('#contact-view-model-list>li').css('display','none');
				$('#contact-view-model-list>li:first').css('display','list-item');
			}

		}, $("#view-list", cel));
	// });
}

function updateSelectedSortKey(el) {
	var sort_key = readCookie("sort_by_name");
	if(sort_key && sort_key != null) {
		var idSuffix = '-asc';
		if(sort_key.indexOf('-') == 0) {
			sort_key = sort_key.substring(1);
			idSuffix = '-desc'
		}
		var elementId = 'sort-by-'+sort_key+idSuffix;
		$(el).find('#'+elementId).addClass('bold-text');
	}
}

	function addClickEventsForSorting(el) {
		// Fetch sort result without changing route on click
		$(el).find('.sort').on("click", function(e)
		{

			e.preventDefault();
			eraseCookie('sort_by_name');

			// Gets name of the attribut to sort, which is set as data
			// attribute in the link
			sort_by = $(this).attr('data');
			
			// Saves Sort By in cookie
			createCookie('sort_by_name', sort_by);
			$('.sort').removeClass('bold-text');
			$(this).addClass('bold-text');

			CONTACTS_HARD_RELOAD=true;
			// If filter is not set then show view on the default contacts
			// list
			if(!App_Contacts.tag_id)
			{
				App_Contacts.contacts(undefined, undefined, undefined, true);
				return;
			}
			
			// If tag filter is applied send tags fetch url and tag_id, which is tobe shown on contacts table.
			App_Contacts.contacts(App_Contacts.tag_id, undefined, undefined, true);
			return;
		});

	}

/**
 * Init function to define actions on events on the custom view list
 * 
 */
$(function() {

	/*
	 * If any custom view is selected, sets the cookie saves the id of the
	 * custom view, to show custom view even after refreshing. Also Load the
	 * contacts with custom view by reading the custom view id from the element
	 * which is selected and calls customView function is called to to custom
	 * view of contacts
	 */
	$('body').on('click', '.ContactView', function(e){

				e.preventDefault();
				
				if(App_Contacts.contactViewModel)
					App_Contacts.contactViewModel = undefined;

				if(App_Contacts.contact_custom_view)
					App_Contacts.contact_custom_view = undefined;
				
				// Gets id of the view
				var id = $(this).attr('id');

				// Saves contact_view id as cookie, so on refreshing shows the
				// custom view based on the cookie, and cookie deleted if
				// default view is selected
				createCookie("contact_view", id);

				/*
				 * Even when custom view is selected, have to check if user sets
				 * any filter so custom view should be shown on the filter
				 * results instead of showing view on default contacts, so if
				 * contact_filter cookie is set the sets the url to filter with
				 * filter id from cookie, then results are fetched from custom
				 * views
				 */
				if (filter_id = readCookie('contact_filter')) {
					App_Contacts.customView(id, undefined,
							'core/api/filters/query/' + filter_id);
					return;
				}
				
				if(readCookie('company_filter'))
      			{
					//App_Contacts.customView(readCookie("contact_view"), undefined, "core/api/contacts/companies")
      				App_Contacts.contacts();
					return;
      			}

				// If filter is not set then show view on the default contacts
				// list
				if(!App_Contacts.tag_id)
				{
					App_Contacts.customView(id);
					return;
				}
				
				// If tag filter is applied send tags fetch url and tag_id, which is tobe shown on contacts table.
				App_Contacts.customView(id, undefined, 'core/api/tags/' + App_Contacts.tag_id, App_Contacts.tag_id);
				
			});

	// If default view is selected, contacts are loaded with default view and
	// removes the view cookie set when view is selected
	$('body').on('click', '.DefaultView', function(e){
		e.preventDefault();
		
		if(company_util.isCompany())
			return;

		// Erases the cookie
		eraseCookie("contact_view");
		eraseCookie("agile_contact_view");
		
		// Undefines current global view object
		if(App_Contacts.contactViewModel)
		App_Contacts.contactViewModel = undefined;

		if(App_Contacts.contactsListView)
			App_Contacts.contactsListView = undefined;
		
		// If filter is not set then show view on the default contacts
		// list
		if(!App_Contacts.tag_id)
		{
			App_Contacts.contacts();
			return;
		}
		
		// If tag filter is applied send tags fetch url and tag_id, which is tobe shown on contacts table.
		App_Contacts.contacts(App_Contacts.tag_id);

	});
	
	// If grid view is selected, contacts are loaded with grid view and
	// creates the grid view cookie 
	$('body').on('click', '.GridView', function(e){
		e.preventDefault();
		
		// Erases the cookie
		eraseCookie("contact_view");
		// Creates the cookie
		createCookie("agile_contact_view", "grid_view");
		
		if(App_Contacts.contactsListView)
			App_Contacts.contactsListView = undefined;

		// Loads the contacts
		App_Contacts.contacts(undefined, undefined, true);

	});
});
$(function()
{
				$('body').on('click', '#freshbooks', function(e)
				{
								e.preventDefault();
								var url = $('#freshbooks_url').val();
								var token = $('#freshbooks_apiKey').val();
								if (isBlank(url))
								{
												// alert("Please Enter Freshbooks Domain Name");
												$("#domainerror").removeClass('hide');
												$("#freshbooks_url").focus();
												$("#freshbooks_url").keypress(function(){
																$("#domainerror").addClass('hide');
												});
												return false;
								}
								else if (new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/.*)?").test(url))
								{
												alert("Please Enter Domain Name only");
												$("#domainerror").removeClass('hide');
												$("#freshbooks_url").focus();
												$("#freshbooks_url").keypress(function(){
																$("#domainerror").addClass('hide');
												});
												return false;
								}

								if (isBlank(token))
								{
												$("#apierror").removeClass('hide');
												$('#freshbooks_apiKey').focus();
												$("#freshbooks_apiKey").keypress(function(){
																$("#apierror").addClass('hide');
												});
												return false;
								}else if(token.length !=32){
												$("#apierror").removeClass('hide');
												$('#freshbooks_apiKey').focus();
												$("#freshbooks_apiKey").keypress(function(){
																$("#apierror").addClass('hide');
												});
												return false;
								}
								$.ajax({ url : 'core/api/freshbooks/save/' + token + '/' + url + '', async : false, success : function(data)
								{
												if (data)
												{
																console.log(data);

												}

								} });
								var location = window.location.hash;
								if (location == "#sync/freshbooks/setting")
								{
												window.location.reload();
								}
								else if (location == "#sync/freshbooks")
								{
										DATA_SYNC_FORCE_FETCH=true;
												window.location = window.location.origin + "#sync/freshbooks/setting";
								}
								else
								{
									DATA_SYNC_FORCE_FETCH=true;
												window.location = window.location.origin + "#sync";
								}
				});
				
	 function isBlank(str) {
				    return (!str || /^\s*$/.test(str));
				}

				function isBlank(str)
				{
								return (!str || /^\s*$/.test(str));
				}

});
$(function()
{
	$('body').on('click', '#import_salesforce', function(e)
			{
				e.preventDefault();
				var newwindow = window.open("import_salesforce.jsp?id=import_from_salesforce", 'name', 'height=420,width=500');
				if (window.focus)
				{
					newwindow.focus();
				}
				return false;
			})

});$(function()
{
	
			

});$(function()
{
	

});
$(function(){
	
	$('body').on('click', '#zoho-import', function(e)
			{
				e.preventDefault();
				var newwindow = window.open("import_zoho.jsp", 'name', 'height=420,width=500');
				if (window.focus)
				{
					newwindow.focus();
				}
				return false;
			});
	

	

	$('body').on('click', '#zoho-prefs-delete', function(e)
	{
		e.preventDefault();
		var disable = $(this).attr("disabled");
		if (disable)
			return;
		$(this).attr("disabled", "disabled");
		$(this).after(getRandomLoadingImg());
		console.log(App_Widgets.zoho_sync.model.destroy({ success : function()
		{
			App_Widgets.stripe_sync.model.clear();
			App_Widgets.stripe_sync.render(true);
		} }));

	});
	

	
});/**
 * Loads the "google map API" by appending the url as script to html document
 * body and displays the map (using callback of url) based on the address of the
 * contact. If the google map is already loaded, just displays the map.
 * 
 * Geocoder is used to get the latitude and longitude of the given address
 * 
 * @method show_map
 * @param {object}
 *            el html object of the contact detail view
 * @param {Object}
 *            contact going to be shown in detail
 */
function show_map(el) {
	var contact = App_Contacts.contactDetailView.model.toJSON();
	var address = getPropertyValue(contact.properties, "address");

	// Return, if no address is found 
	if (!address) 
		return;
	
	try
	{
		address = JSON.parse(address);
	}
	catch (err)
	{
		return;
	}
	
	

	// If all the address fields are empty, just return.
	if (!address.address && !address.city && !address.state
			&& !address.country)
		return;
	
	//reads the value from cookie or local store if the value is no it will return from here
	
	var map_view=localStorage.getItem('MAP_VIEW');
	if(map_view=="disabled"){
		$("#map_view_action").html("<i class='icon-plus text-sm c-p' title='Show map' id='enable_map_view'></i>");
		return;
	}
		

	// If google map is already loaded display the map else load the
	// "google maps api"
	try {
		if (google.maps) {
			display_google_map();
		}
	} catch (err) {

		load_gmap_script();
	}
}

/**
 * Loads "google maps api", by appending the related url (with a callback
 * function to display map) as script element to html document body
 */
function load_gmap_script() {
	
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.src = "https://maps.googleapis.com/maps/api/js?&sensor=false&callback=display_google_map";
	document.body.appendChild(script);
}

/**
 * Displays related map of the given contact address.
 * 
 * Validates the status code returned by the geocoder, if it is ok proceeds
 * further to display the map using latitude and longitude of results object.
 * 
 */
function display_google_map() {

	var contact = App_Contacts.contactDetailView.model.toJSON();
	var address = JSON.parse(getPropertyValue(contact.properties, "address"));

	// Gets the location (latitude and longitude) from the address
	var geocoder = new google.maps.Geocoder();

	// Latitude and longitude were not saved to the contact (chances to update the address)
	
	if(!address.address)address.address="";
	if(!address.city)address.city="";
	if(!address.state)address.state="";
	if(!address.country)address.country="";
	if(!address.zip)address.zip="";
	
	geocoder.geocode({
		'address' : '"'+ address.address + ', '+ address.city + ', '
		+ address.state + ', ' + getNormalCountryNameFromShortName(address.country) + ', ' + address.zip + '"'
	}, function(results, status) {
		if (status == google.maps.GeocoderStatus.OK) {
			console.log(results);
			displayTimeZone(results);

			// Displays map portion
			$("#map").css('display', 'block');
			
			var myOptions = {
				zoom : 4,
				center : results[0].geometry.location,
				mapTypeId : google.maps.MapTypeId.ROADMAP
			}

			var map = new google.maps.Map(document.getElementById("map"),
					myOptions);
			
			var marker = new google.maps.Marker({
				map : map,
				position : results[0].geometry.location
			});
		}
	});
}

function getNormalCountryNameFromShortName(name){
	if (!name)
		return;

	var name_json = {  "AF" : "Afghanistan",
		    "AX" : "Aland Islands",
		    "AL" : "Albania",
		    "DZ" : "Algeria",
		    "AS" : "American Samoa",
		    "AD" : "Andorra",
		    "AO" : "Angola",
		    "AI" : "Anguilla",
		    "AQ" : "Antarctica",
		    "AG" : "Antigua And Barbuda",
		    "AR" : "Argentina",
		    "AM" : "Armenia",
		    "AW" : "Aruba",
		    "AU" : "Australia",
		    "AT" : "Austria",
		    "AZ" : "Azerbaijan",
		    "BS" : "Bahamas",
		    "BH" : "Bahrain",
		    "BD" : "Bangladesh",
		    "BB" : "Barbados",
		    "BY" : "Belarus",
		    "BE" : "Belgium",
		    "BZ" : "Belize",
		    "BJ" : "Benin",
		    "BM" : "Bermuda",
		    "BT" : "Bhutan",
		    "BO" : "Bolivia",
		    "BA" : "Bosnia And Herzegovina",
		    "BW" : "Botswana",
		    "BV" : "Bouvet Island",
		    "BR" : "Brazil",
		    "IO" : "British Indian Ocean Territory",
		    "BN" : "Brunei Darussalam",
		    "BG" : "Bulgaria",
		    "BF" : "Burkina Faso",
		    "BI" : "Burundi",
		    "KH" : "Cambodia",
		    "CM" : "Cameroon",
		    "CA" : "Canada",
		    "CV" : "Cape Verde",
		    "KY" : "Cayman Islands",
		    "CF" : "Central African Republic",
		    "TD" : "Chad",
		    "CL" : "Chile",
		    "CN" : "China",
		    "CX" : "Christmas Island",
		    "CC" : "Cocos (Keeling) Islands",
		    "CO" : "Colombia",
		    "KM" : "Comoros",
		    "CG" : "Congo",
		    "CD" : "Congo, Democratic Republic",
		    "CK" : "Cook Islands",
		    "CR" : "Costa Rica",
		    "CI" : "Cote D\"Ivoire",
		    "HR" : "Croatia",
		    "CU" : "Cuba",
		    "CY" : "Cyprus",
		    "CZ" : "Czech Republic",
		    "DK" : "Denmark",
		    "DJ" : "Djibouti",
		    "DM" : "Dominica",
		    "DO" : "Dominican Republic",
		    "EC" : "Ecuador",
		    "EG" : "Egypt",
		    "SV" : "El Salvador",
		    "GQ" : "Equatorial Guinea",
		    "ER" : "Eritrea",
		    "EE" : "Estonia",
		    "ET" : "Ethiopia",
		    "FK" : "Falkland Islands (Malvinas)",
		    "FO" : "Faroe Islands",
		    "FJ" : "Fiji",
		    "FI" : "Finland",
		    "FR" : "France",
		    "GF" : "French Guiana",
		    "PF" : "French Polynesia",
		    "TF" : "French Southern Territories",
		    "GA" : "Gabon",
		    "GM" : "Gambia",
		    "GE" : "Georgia",
		    "DE" : "Germany",
		    "GH" : "Ghana",
		    "GI" : "Gibraltar",
		    "GR" : "Greece",
		    "GL" : "Greenland",
		    "GD" : "Grenada",
		    "GP" : "Guadeloupe",
		    "GU" : "Guam",
		    "GT" : "Guatemala",
		    "GG" : "Guernsey",
		    "GN" : "Guinea",
		    "GW" : "Guinea-Bissau",
		    "GY" : "Guyana",
		    "HT" : "Haiti",
		    "HM" : "Heard Island & Mcdonald Islands",
		    "VA" : "Holy See (Vatican City State)",
		    "HN" : "Honduras",
		    "HK" : "Hong Kong",
		    "HU" : "Hungary",
		    "IS" : "Iceland",
		    "IN" : "India",
		    "ID" : "Indonesia",
		    "IR" : "Iran, Islamic Republic Of",
		    "IQ" : "Iraq",
		    "IE" : "Ireland",
		    "IM" : "Isle Of Man",
		    "IL" : "Israel",
		    "IT" : "Italy",
		    "JM" : "Jamaica",
		    "JP" : "Japan",
		    "JE" : "Jersey",
		    "JO" : "Jordan",
		    "KZ" : "Kazakhstan",
		    "KE" : "Kenya",
		    "KI" : "Kiribati",
		    "KR" : "Korea",
		    "KW" : "Kuwait",
		    "KG" : "Kyrgyzstan",
		    "LA" : "Lao People\"s Democratic Republic",
		    "LV" : "Latvia",
		    "LB" : "Lebanon",
		    "LS" : "Lesotho",
		    "LR" : "Liberia",
		    "LY" : "Libyan Arab Jamahiriya",
		    "LI" : "Liechtenstein",
		    "LT" : "Lithuania",
		    "LU" : "Luxembourg",
		    "MO" : "Macao",
		    "MK" : "Macedonia",
		    "MG" : "Madagascar",
		    "MW" : "Malawi",
		    "MY" : "Malaysia",
		    "MV" : "Maldives",
		    "ML" : "Mali",
		    "MT" : "Malta",
		    "MH" : "Marshall Islands",
		    "MQ" : "Martinique",
		    "MR" : "Mauritania",
		    "MU" : "Mauritius",
		    "YT" : "Mayotte",
		    "MX" : "Mexico",
		    "FM" : "Micronesia, Federated States Of",
		    "MD" : "Moldova",
		    "MC" : "Monaco",
		    "MN" : "Mongolia",
		    "ME" : "Montenegro",
		    "MS" : "Montserrat",
		    "MA" : "Morocco",
		    "MZ" : "Mozambique",
		    "MM" : "Myanmar",
		    "NA" : "Namibia",
		    "NR" : "Nauru",
		    "NP" : "Nepal",
		    "NL" : "Netherlands",
		    "AN" : "Netherlands Antilles",
		    "NC" : "New Caledonia",
		    "NZ" : "New Zealand",
		    "NI" : "Nicaragua",
		    "NE" : "Niger",
		    "NG" : "Nigeria",
		    "NU" : "Niue",
		    "NF" : "Norfolk Island",
		    "MP" : "Northern Mariana Islands",
		    "NO" : "Norway",
		    "OM" : "Oman",
		    "PK" : "Pakistan",
		    "PW" : "Palau",
		    "PS" : "Palestinian Territory, Occupied",
		    "PA" : "Panama",
		    "PG" : "Papua New Guinea",
		    "PY" : "Paraguay",
		    "PE" : "Peru",
		    "PH" : "Philippines",
		    "PN" : "Pitcairn",
		    "PL" : "Poland",
		    "PT" : "Portugal",
		    "PR" : "Puerto Rico",
		    "QA" : "Qatar",
		    "RE" : "Reunion",
		    "RO" : "Romania",
		    "RU" : "Russian Federation",
		    "RW" : "Rwanda",
		    "BL" : "Saint Barthelemy",
		    "SH" : "Saint Helena",
		    "KN" : "Saint Kitts And Nevis",
		    "LC" : "Saint Lucia",
		    "MF" : "Saint Martin",
		    "PM" : "Saint Pierre And Miquelon",
		    "VC" : "Saint Vincent And Grenadines",
		    "WS" : "Samoa",
		    "SM" : "San Marino",
		    "ST" : "Sao Tome And Principe",
		    "SA" : "Saudi Arabia",
		    "SN" : "Senegal",
		    "RS" : "Serbia",
		    "SC" : "Seychelles",
		    "SL" : "Sierra Leone",
		    "SG" : "Singapore",
		    "SK" : "Slovakia",
		    "SI" : "Slovenia",
		    "SB" : "Solomon Islands",
		    "SO" : "Somalia",
		    "ZA" : "South Africa",
		    "GS" : "South Georgia And Sandwich Isl.",
		    "ES" : "Spain",
		    "LK" : "Sri Lanka",
		    "SD" : "Sudan",
		    "SR" : "Suriname",
		    "SJ" : "Svalbard And Jan Mayen",
		    "SZ" : "Swaziland",
		    "SE" : "Sweden",
		    "CH" : "Switzerland",
		    "SY" : "Syrian Arab Republic",
		    "TW" : "Taiwan",
		    "TJ" : "Tajikistan",
		    "TZ" : "Tanzania",
		    "TH" : "Thailand",
		    "TL" : "Timor-Leste",
		    "TG" : "Togo",
		    "TK" : "Tokelau",
		    "TO" : "Tonga",
		    "TT" : "Trinidad And Tobago",
		    "TN" : "Tunisia",
		    "TR" : "Turkey",
		    "TM" : "Turkmenistan",
		    "TC" : "Turks And Caicos Islands",
		    "TV" : "Tuvalu",
		    "UG" : "Uganda",
		    "UA" : "Ukraine",
		    "AE" : "United Arab Emirates",
		    "GB" : "United Kingdom",
		    "US" : "United States",
		    "UM" : "United States Outlying Islands",
		    "UY" : "Uruguay",
		    "UZ" : "Uzbekistan",
		    "VU" : "Vanuatu",
		    "VE" : "Venezuela",
		    "VN" : "Viet Nam",
		    "VG" : "Virgin Islands, British",
		    "VI" : "Virgin Islands, U.S.",
		    "WF" : "Wallis And Futuna",
		    "EH" : "Western Sahara",
		    "YE" : "Yemen",
		    "ZM" : "Zambia",
		    "ZW" : "Zimbabwe"};

	name = name.trim();

	if (name_json[name])
		return name_json[name];

	return name;

}
/**
 * Deletes the selected row related entities from the database based on the url
 * attribute of the table and fades out the rows from the table
 * 
 * author: Ramesh
 * 
 */

var dup_contacts1_array = [];

$(function()
{
				$('body').on('click', '#duplicate-contacts-cancel', function(event)
				{
								event.preventDefault();
								dup_contacts1_array.length = 0;
								var master_record = App_Contacts.contactDetailView.model.toJSON();
								Backbone.history.navigate("contact/" + master_record.id, { trigger : true });
				});

				$('body').on('click', '#contact-merge-cancel', function(event)
				{
								event.preventDefault();
								dup_contacts1_array.length = 0;
								var master_record = App_Contacts.contactDetailView.model.toJSON();
								Backbone.history.navigate("duplicate-contacts/" + master_record.id, { trigger : true });
								// Backbone.history.navigate("contacts", {
								// trigger : true
								// });
				});

				/**
				 * Validates the checkbox status of each row in duplicate contacts table and
				 * sends these contacts to merge contacts page
				 * 
				 */
				$('body').on('click', '#duplicate-contacts-checked-grid', function(event)
																				{
																								event.preventDefault();
																								var index_array = [];
																								var data_array = [];
																								var checked = false;
																								var table = $('body').find('.showCheckboxes');
																								$(table).find('.tbody_check').each(function(index, element)
																								{
																												// If element is checked store it's id in an
																												// array
																												if ($(element).is(':checked'))
																												{
																																dup_contacts1_array.push($(element).closest('tr').find('td.data').attr('data'));
																																checked = true;
																												}
																								});
																								if (checked)
																								{
																												if (dup_contacts1_array.length > 2)
																												{
																																alert('You can merge maximum of 2 records at a time with master record.');
																																dup_contacts1_array.length = 0;
																																return;
																												}
																												Backbone.history.navigate("merge-contacts", { trigger : true });
																								}
																								else
																												$('body')
																																				.find(".select-none")
																																				.html(
																																												'<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>You have not selected any records to merge. Please select at least one record to continue.</div>')
																																				.show().delay(3000).hide(1);
																				});

				/**
				 * Merges the selected duplicate contacts properties with the Master contact
				 * object and deletes the duplicate contact objects from the datastore
				 * 
				 */
				$('body').on('click', '#merge-contacts-model', function(event)
				{
								event.preventDefault();
								if (dup_contacts1_array.length > 1)
								{
												if (!confirm(" Delete " + dup_contacts1_array.length + " duplicate contacts and merge data to master record?"))
																return;
								}
								else if (!confirm(" Delete 1 duplicate contact and merge data to master record?"))
												return;
								$(this).attr('disabled', 'disabled');
								$('#contact-merge-cancel').attr('disabled', 'disabled');
								$('#contact-merge-cancel').after('<img class="contact-merge-loading p-r-xs m-b"  src= "img/21-0.gif"></img>');
								var checked = false;
								var selected_fields = [];
								var table = $('body').find('#merge-contacts-table');
								var tbody = $(table).find('tbody');
								var phones = [];
								var emails = [];
								var websites = [];
								var tags = [];
								var custom_fields = [];
								var remove_fields = [];
								var master_record = App_Contacts.contactDetailView.model;
								var master_record_dup = JSON.parse(JSON.stringify(master_record.toJSON()));
								var master_id = master_record.id;
								console.log(master_record.toJSON());

								tbody.children().each(function(index, element)
								{
												$(element).find("[type=radio]:checked").each(function(index, element)
												{
																if ($(element).attr("oid") != master_id)
																{
																				var fieldName = $(element).attr("field");
																				var fieldValue = $(element).attr("data");
																				var fieldType = $(element).attr("fieldtype");
																				if (typeof fieldType !== typeof undefined && fieldType !== false)
																				{
																								if (fieldValue)
																								{
																												custom_field = {};
																												custom_field['name'] = fieldName;
																												custom_field['value'] = fieldValue;
																												custom_field['type'] = 'CUSTOM';
																												custom_fields.push(custom_field);
																								}
																								else
																								{
																												remove_field = {};
																												remove_field['name'] = fieldName;
																												remove_field['type'] = 'CUSTOM';
																												remove_fields.push(remove_field);
																								}
																				}
																				else
																				{
																								if (fieldValue)
																								{
																												selected_field = {};
																												selected_field['name'] = fieldName;
																												selected_field['value'] = fieldValue;
																												selected_fields.push(selected_field);
																												if (fieldName.toLowerCase() == 'company')
																												{
																																var company_id = $(element).attr("company_id");
																																master_record.set({ "contact_company_id" : company_id });
																												}
																								}
																								else
																								{
																												remove_field = {};
																												remove_field['name'] = fieldName;
																												remove_field['type'] = 'SYSTEM';
																												remove_fields.push(remove_field);
																								}
																				}
																}
												});
												$(element).find("[type=checkbox]:checked").each(function(index, element)
												{
																var fieldName = $(element).attr("field");
																var fieldValue = $(element).attr("data");
																var fieldType = $(element).attr("fieldtype");
																if (fieldName === "email")
																{
																				var subtype = $(element).attr("subtype");
																				email = {};
																				email['value'] = fieldValue;
																				if (subtype)
																								email['subtype'] = subtype;
																				emails.push(email);
																}
																else if (fieldName === "website")
																{
																				var subtype = $(element).attr("subtype");
																				website = {};
																				website['value'] = fieldValue;
																				if (subtype)
																								website['subtype'] = subtype;
																				websites.push(website);
																}
																else if (fieldName === "phone")
																{
																				var subtype = $(element).attr("subtype");
																				phone = {};
																				phone['value'] = fieldValue;
																				if (subtype)
																								phone['subtype'] = subtype;
																				phones.push(phone);
																}
																else if (fieldName === "tags")
																{
																				tags.push(fieldValue);
																}
												});
								});
								var properties = master_record_dup.properties;
								master_record.set({ "tags" : tags });
								merge_duplicate_contacts(master_record, properties, selected_fields, custom_fields, remove_fields, websites, emails, phones);
				});
});

function merge_duplicate_contacts(master_record, properties, selected_fields, custom_fields, remove_fields, websites, emails, phones)
{
				for (var i = properties.length - 1; i >= 0; i--)
				{
								if (properties[i].name.toLowerCase() === 'email' || properties[i].name.toLowerCase() === 'website' || properties[i].name.toLowerCase() === 'phone')
								{
												properties.splice(i, 1);
								}
				}
				for (var i = 0; i < remove_fields.length; i++)
				{
								for (var j = 0; j < properties.length; j++)
								{
												var property = properties[j];
												if (property.name.toLowerCase() === remove_fields[i].name.toLowerCase() && property.type.toLowerCase() === remove_fields[i].type.toLowerCase())
												{
																properties.splice(j, 1);
																break;
												}
								}
				}
				for (var j = 0; j < selected_fields.length; j++)
				{
								var element = selected_fields[j];
								for (var k = 0; k < properties.length; k++)
								{
												if (properties[k].name.toLowerCase() === element['name'].toLowerCase())
												{
																properties[k].value = element['value'];
																break;
												}
												else if (k == properties.length - 1)
												{
																var object = {};
																object['name'] = element['name'];
																object['value'] = element['value'];
																object['type'] = 'SYSTEM';
																properties.push(object);
																break;
												}
								}
				}
				if (custom_fields.length > 0)
				{
								for (var i = 0; i < custom_fields.length; i++)
								{
												var element = custom_fields[i];
												for (var j = 0; j < properties.length; j++)
												{
																if (properties[j].name.toLowerCase() === element['name'].toLowerCase() && properties[j].type === 'CUSTOM')
																{
																				properties[j].value = element['value'];
																				break;
																}
																else if (j == properties.length - 1)
																{
																				if (custom_fields[i].value)
																				{
																								var object = {};
																								object['name'] = custom_fields[i].name;
																								object['value'] = custom_fields[i].value;
																								object['type'] = 'CUSTOM';
																								properties.push(object);
																								break;
																				}
																}
												}
								}
				}
				if (emails.length > 0)
				{
								for (var i = 0; i < emails.length; i++)
								{
												var object = {};
												object['name'] = 'email';
												object['value'] = emails[i].value;
												object['type'] = 'SYSTEM';
												if (emails[i].subtype)
																object['subtype'] = emails[i].subtype;
												properties.push(object);
								}
				}
				if (phones.length > 0)
				{
								for (var i = 0; i < phones.length; i++)
								{
												var object = {};
												object['name'] = 'phone';
												object['value'] = phones[i].value;
												object['type'] = 'SYSTEM';
												if (phones[i].subtype)
																object['subtype'] = phones[i].subtype;
												properties.push(object);
								}
				}
				if (websites.length > 0)
				{
								for (var i = 0; i < websites.length; i++)
								{
												var object = {};
												object['name'] = 'website';
												object['value'] = websites[i].value;
												object['type'] = 'SYSTEM';
												if (websites[i].subtype)
																object['subtype'] = websites[i].subtype;
												properties.push(object);
								}
				}
				master_record.set({ "properties" : properties });
				merge_related_entity_in_master_record(master_record,dup_contacts1_array);
}


function merge_related_entity_in_master_record(master_record,duplicate_contacts){
				master_record.save({}, { url : '/core/api/contacts/merge/'+duplicate_contacts.toString(), success : function()
								{
												$(".contact-merge-loading").remove();
												CONTACTS_HARD_RELOAD = true;
												var id = master_record.toJSON().id;
												Backbone.history.navigate("contact/" + id, { trigger : true });
								} });
}
/**
 * Sets dashboard. call methods to fetch contact, deals, tasks, workflows and
 * subscription details
 * 
 * @param el
 */
function setup_dashboard(el)
{
	// Sets up subscription details
	show_dashboard_subscription_details(el);

	// Show recently view contacts by current user
	show_dashboard_contacts(el);

	// Shows deals, tasks, workflows
	show_dashboard_tasks(el);
	show_dashboard_deals(el);
	show_dashboard_workflows(el);
	initBlogSync();
}

/*
 * Gets the Blog posts
 */
function initBlogSync()
{
	head
			.js(
					LIB_PATH + 'lib/jquery.feeds.min.js',
					function()
					{

						$('#blog_sync_container')
								.feeds(
										{
											feeds : { blog : "https://www.agilecrm.com/blog/feed/" },
											max : 3,
											entryTemplate : function(entry)
											{
												return '<strong>' + '<a href="' + entry.link + '" title = "' + entry.title + '" target="_blank" >' + entry.title + '</a></strong><div class="text-xs l-h-xs m-b-xs text-light">' 
												+ new Date(entry.publishedDate).format('mmm d, yyyy') + '</div><p class="p-t-xs m-b">' 
												+ entry.contentSnippet.replace('<a', '<a target="_blank"') + '</p>';
											} });
					});

}

/**
 * Fetches recently viewed contacts bu current user. It fetches last viewed 5
 * contacts
 * 
 * @param el
 */
function show_dashboard_contacts(el)
{
	var my_recent_contacts = new Base_Collection_View({ url : 'core/api/contacts/recent?page_size=5', restKey : "contacts", templateKey : "dashboard-contacts",
		individual_tag_name : 'tr', sort_collection : false, });
	my_recent_contacts.collection.fetch();

	$('#recent-contacts', el).html(my_recent_contacts.render().el);
}

/**
 * Fetches tasks due tasks
 * 
 * @param el
 */
function show_dashboard_tasks(el)
{
	var task_dashboard_list_view = new Base_Collection_View({ url : '/core/api/tasks/my/dashboardtasks', restKey : "task", sortKey : "due",
		templateKey : "dashboard1-tasks", individual_tag_name : 'tr', postRenderCallback : function(el)
		{
			head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
			{
				$(".task-due-time", el).timeago();
			});
		} });

	task_dashboard_list_view.appendItem = append_tasks_dashboard;
	task_dashboard_list_view.collection.fetch();
	$('#my-tasks').html(task_dashboard_list_view.el);
}

/**
 * Fetches upcomming deals related to current user
 * 
 * @param el
 */
function show_dashboard_deals(el)
{
	var my_deals = new Base_Collection_View({ url : 'core/api/opportunity/my/upcoming-deals', restKey : "opportunity", templateKey : "dashboard-opportunities",
		individual_tag_name : 'tr', page_size : 5, sortKey : "created_time", descending : true, postRenderCallback : function(el)
		{
			head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
			{
				$(".deal-close-time", el).timeago();
			})
		} });
	my_deals.collection.fetch();
	$('#my-deals').html(my_deals.el);
}

/**
 * Fetches recent workflow logs
 * 
 * @param el
 */
function show_dashboard_workflows(el)
{
	var workflow_list_view = new Base_Collection_View({ url : '/core/api/campaigns/logs/recent?page_size=5', restKey : "workflow",
		templateKey : "dashboard-campaign-logs", individual_tag_name : 'tr', page_size : 10, sortKey : 'time', descending : true,
		postRenderCallback : function(el)
		{
			head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
			{
				$("time.log-created-time", el).timeago();
			});
		} });

	workflow_list_view.collection.fetch();
	$('#my-logs').html(workflow_list_view.el);
}

/**
 * Shows subscription details. It fetches subscription object, checks number of
 * users registered and number of users allowed according to subscription and
 * shows message accordingly
 * 
 * @param el
 */

function show_dashboard_subscription_details(el)
{
	/**
	 * Fetches subscription object
	 */
	var view = new Base_Model_View({ url : 'core/api/subscription', template : "dashboard-account-info", });

	view.model.fetch({ success : function(data)
	{
		if (!$.isEmptyObject(data.toJSON()))
		{
			$("#subscription-stats").html(view.render(true).el);
			return;
		}

		/**
		 * Fetches number of users present in current domain
		 */
		$.get('core/api/users/count', function(count)
		{
			var plandata = {};
			plandata.users_count = count;
			plandata.plan = "free";

			console.log(plandata);
			getTemplate('user-billing', plandata, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$("#subscription-stats").html($(template_ui));	
			}, "#subscription-stats");

		});
	} })
}

$(function()
{
	$('body').on('click', '#dashboard-contacts-model-list > tr, #dashboard-campaign-logs-model-list > tr', function(e)
	{

		var id = $(this).find(".data").attr("data");

		App_Contacts.navigate("contact/" + id, { trigger : true });
	});

});
    
function setup_dashboardTimeline(url)
{
	if(!url)
		url = "core/api/timeline/contact";
head.js(LIB_PATH + 'lib/storyjs-embed.js', function(){
createStoryJS({
       	type:       'default',
        width:      '1170',
        height:     '350',
      //  source:     'https://docs.google.com/spreadsheet/pub?key=0AqHV0BeH8amcdGxyS0cxS0NNandSaV9oTXRhWTdEbmc&output=html',
        source : url,
        embed_id:   'my-timeline' ,    // ID of the DIV you want to load the timeline into
        js :	'lib/timeline-min.js',
        css : 	'css/dashboard-timeline.css'
		});
	});
}
/**
 *  DataSync inner model view events
 */

var DATA_SYNC_URL="core/api/contactprefs"
var DataSync_Event_Modal_View = Base_Model_View.extend({

    events: {
        'click #import_shopify': 'importShopify',
        'change #sync-type': 'googleContactsSyncTypeChange',
        'click .save-contact-prefs': 'syncGoogleContacts',
        'click #stripe-import-prefs-delete': 'importStripePrefsDelete',
        'click #stripe_sync_prefs': 'syncStripePrefs',
        'click #shopify-setting': 'syncShopify',
        'click #quickbook_sync_prefs': 'syncQuickbooks',
        'click #freshbooks_sync_prefs': 'syncFreshbooks',
        'click #data-sync-type':'enableDataSyncWidget',
    },

    /**
     * For adding new case
     */
    importShopify: function(e) {
        e.preventDefault();
        var ele = $(e.currentTarget);

        var shopName = $('#shop').val();
        if (shopName == "") {
            alert("Enter Shop name");
            $('#shop').focus();
            return false;
        }
        var domain = window.location.origin;

        e.preventDefault();
        var callbackURL = window.location.href;
        var url = "/scribe?service_type=shopify&url=sync&window_opened=true&shop=" + shopName + "&domain=" + domain + "";

        // For every request of import, it will ask to grant access
        window.open(url + "&return_url=" + encodeURIComponent(callbackURL), 'dataSync', 'height=1000,width=500');
    },

     enableDataSyncWidget: function(e) {
        e.preventDefault();
        var ele = $(e.currentTarget);

        var sync_type=$(ele).attr('sync_type');
        if(sync_type=='STRIPE'){

        var callbackURL = window.location.origin + "/#sync/stripe-import";
        // For every request of import, it will ask to grant access
        window.open( "/scribe?service=stripe_import&window_opened=true&return_url=" + encodeURIComponent(callbackURL),'dataSync','height=1000,width=500');
        return false;

        }
        else if(sync_type=='QUICKBOOK'){

          window.open('/OAuthServlet?service=quickbook-import&window_opened=true&return_url=' + encodeURIComponent(window.location.href) + 'quickbooks','dataSync','height=1000,width=500');
          return;
        }
    },

    syncShopify: function(e) {

        e.preventDefault();
        var ele = $(e.currentTarget);
        var disabled = $(this).attr("disabled");
        if (disabled) {
            return false;
        } else {
            $(ele).attr("disabled", "disabled");
            $(ele).text("Syncing");
        }


        var syncPrefs = serializeForm("shopify-contact-import-form");
        syncPrefs["inProgress"] = true;

        getSyncModelFromName('SHOPIFY', function(mod) {

            var model = new Backbone.Model(mod);
            model.set(syncPrefs, {
                silent: true
            });

            var url = DATA_SYNC_URL + "/SHOPIFY";

          //  $(ele).after(getRandomLoadingImg());
            model.url = url + "?sync=true"
            model.save({}, {
                success: function(data) {
                    show_success_message_after_save_button("Sync Initiated", App_Datasync.dataSync.el);
                    showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                }
            });
        });


    },

    /**
     * For adding new case
     */
        googleContactsSyncTypeChange: function(e) {
        e.preventDefault();
        var ele = $(e.currentTarget);

        var value = $(ele).val();
        if (value == "AGILE_TO_CLIENT" || value == "TWO_WAY") {
            $("#sync_to_group_controlgroup").show();
            $("#my_contacts_sync_group").show();
            if (value == "AGILE_TO_CLIENT") {
                $("#sync_from_group_controlgroup").hide();
                return;
            }

            $("#sync_from_group_controlgroup").show();
        } else {
            $("#sync_from_group_controlgroup").show();
            $("#sync_to_group_controlgroup").hide();
            $("#my_contacts_sync_group").hide();
        }
    },
    syncGoogleContacts: function(e) {

        var ele = $(e.currentTarget);
        var disabled = $(ele).attr("disabled");
        if (disabled)
            return;

        if (!isValidForm("#google-contacts-import-form")) {
            return;
        };

        $(ele).attr("disabled", "disabled");
        $(ele).text("Syncing");

        //	return;

        var syncPrefs = serializeForm("google-contacts-import-form");
        syncPrefs["inProgress"] = true;



        getSyncModelFromName('GOOGLE', function(mod) {

            var model = new Backbone.Model(mod);
            model.set(syncPrefs, {
                silent: true
            });

            var url = DATA_SYNC_URL + "/GOOGLE";
          //  $(ele).after(getRandomLoadingImg());
            model.url = url + "?sync=true"
            model.save({}, {
                success: function(data) {
                    show_success_message_after_save_button("Sync Initiated", App_Datasync.dataSync.el);
                    showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                }
            });
        });



    },

    importStripePrefsDelete: function(e) {

        e.preventDefault();

        var ele = $(e.currentTarget);
        var disable = $(ele).attr("disabled");
        if (disable)
            return;
        $(ele).attr("disabled", "disabled");
       // $(ele).after(getRandomLoadingImg());

        getTemplate('admin-settings-import-stripe-contact-sync', {}, undefined, function(template_) {
            if (!template_)
                return;
            $('#prefs-tabs-content').find('#stripe').html($(template_));
        });


    },

    syncStripePrefs: function(e) {
        e.preventDefault();
        var ele = $(e.currentTarget);
        var disabled = $(ele).attr("disabled");
        if (disabled) {
            return false;
        } else {
            $(ele).attr("disabled", "disabled");
            $(ele).text("Syncing");
        }


        var syncPrefs = serializeForm("stripe-prefs-form");
        syncPrefs["inProgress"] = true;
        getSyncModelFromName('STRIPE', function(mod) {

            var model = new Backbone.Model(mod);
            model.set(syncPrefs, {
                silent: true
            });

            var url = DATA_SYNC_URL + "/STRIPE";

           // $(ele).after(getRandomLoadingImg());
            model.url = url + "?sync=true"
            model.save({}, {
                success: function(data) {
                    show_success_message_after_save_button("Sync Initiated", App_Datasync.dataSync.el);
                    showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                }
            });
        });


    },

    syncQuickbooks: function(e) {
        e.preventDefault();
        var ele = $(e.currentTarget);

       var disable = $(ele).attr('disabled');
        if(disable)
            return false;
        $(ele).attr("disabled", "disabled");
        $(ele).text("Syncing");
        
        var quickbookPrefs = serializeForm("quickbook-form");
        quickbookPrefs['inProgress'] = true;

          getSyncModelFromName('QUICKBOOK', function(mod) {

            var model = new Backbone.Model(mod);
            model.set(quickbookPrefs, {
                silent: true
            });

            var url = DATA_SYNC_URL + "/QUICKBOOK";

         //   $(ele).after(getRandomLoadingImg());
            model.url = url + "?sync=true"
            model.save({}, {
                success: function(data) {
                    show_success_message_after_save_button("Sync Initiated", App_Datasync.dataSync.el);
                    showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                }
            });
        });

    },


     syncFreshbooks: function(e) {
        e.preventDefault();
        var ele = $(e.currentTarget);

                var disable = $(ele).attr('disabled');
                    if(disable)
                    return false;
                    $(ele).attr("disabled", "disabled");
                    $(ele).text("Syncing");
                    
                    var freshbooks_prefs = serializeForm("freshbooks-form");
                    freshbooks_prefs['inProgress'] = true;
                     getSyncModelFromName('FRESHBOOKS', function(mod) {

                        var model = new Backbone.Model(mod);
                        model.set(freshbooks_prefs, {
                            silent: true
                        });

                        var url = DATA_SYNC_URL + "/FRESHBOOKS";

                       // $(ele).after(getRandomLoadingImg());
                        model.url = url + "?sync=true"
                        model.save({}, {
                            success: function(data) {
                                show_success_message_after_save_button("Sync Initiated", App_Datasync.dataSync.el);
                                showNotyPopUp("information", "Contacts sync initiated", "top", 1000);
                            }
                        });
                    });
                    
    }

});




/**
binds all click events  for google calendar model
*/

	var GoogleCalendar_Event_Modal_View = Base_Model_View.extend({

    events: {
        'click #sync-google-calendar': 'syncGoogleCalendarEnable',
        'click #sync-google-calendar-delete': 'deleteGoogleCalendarPrefs',
       
    },

      syncGoogleCalendarEnable: function(e) {

        e.preventDefault();

       // URL to return, after fetching token and secret key from LinkedIn
		var callbackURL = window.location.href;

		// For every request of import, it will ask to grant access
		window.open("/scribe?service=google_calendar&window_opened=true&return_url=" + encodeURIComponent(callbackURL),'dataSync','height=1000,width=500');

    },


     deleteGoogleCalendarPrefs: function(e) {

     	e.preventDefault();

     	if (!confirm("Are you sure you want to delete?"))
    			return false;
       var ele = $(e.currentTarget);

		var disabled = $(this).attr("disabled");
		if (disabled)
			return;

		$(ele).attr("disabled", "disabled");

		$(ele).after(getRandomLoadingImg());
		App_Datasync.calendar_sync_google.model.url = "/core/api/calendar-prefs"
		App_Datasync.calendar_sync_google.model.destroy({ success : function()
		{

			App_Datasync.calendar_sync_google.model.clear();
			App_Datasync.calendar_sync_google.model.url = "/core/api/calendar-prefs/get"
			App_Datasync.calendar_sync_google.render(true);
			erase_google_calendar_prefs_cookie();

		} });

    }



});var dealrelatedView;
var dealNotesView;
var dealActivitiesView;
var existingDealDocumentsView;
var dealTasksView;
var dealEventsView;

var deal_details_tab = {
		
		
		
		loadDealRelatedContactsView : function()
		{
			 var id = App_Deal_Details.dealDetailView.model.id;
			 if(id){
			dealrelatedView = new Base_Collection_View({
	            url: '/core/api/opportunity/' + id + "/related_to",
	            templateKey: "deal-related",
	            individual_tag_name: 'tr',
	            sortKey:"created_time",
	            cursor : true,
	            descending: true,
	            postRenderCallback: function(el) {
	            	
	            }
	        });
			dealrelatedView.collection.fetch();
	        $('#dealrelated').html(dealrelatedView.el);
			 }
		},
		load_deal_notes : function()
		{
		    var id = App_Deal_Details.dealDetailView.model.id;
		    if(id){
		    dealNotesView = new Base_Collection_View({
	            url: '/core/api/opportunity/' + id + "/notes",
	            restKey: "note",
	            templateKey: "deal-notes",
	            individual_tag_name: 'li',
	            sortKey:"created_time",
	            descending: true,
	            postRenderCallback: function(el) {
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
	            		 $(".note-created-time", el).timeago();
	              	})
	            }
	        });
		    dealNotesView.collection.fetch();
	        $('#dealnotes').html(dealNotesView.el);
		    }
		},
		
		load_deal_docs : function()
		{
			 var id = App_Deal_Details.dealDetailView.model.id;
			 if(id){
			 dealDocsView = new Base_Collection_View({
		            url: '/core/api/documents/opportunity/' + id + "/docs",
		            restKey: "document",
		            templateKey: "deal-docs",
		            individual_tag_name: 'li',
		            sortKey:"uploaded_time",
		            descending: true,
		            postRenderCallback: function(el) {
		            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
		            		 $(".document-created-time", el).timeago();
		              	})
		            }
		        });
			 dealDocsView.collection.fetch();
		        $('#dealdocs').html(dealDocsView.el);
			 }
		},
		
		load_deal_activities : function()
		{
		    var id = App_Deal_Details.dealDetailView.model.id;
		    if(id){
		    dealActivitiesView = new Base_Collection_View({
	            url: '/core/api/opportunity/' + id + "/activities",
	            templateKey: "deal-detail-activities",
	            individual_tag_name: 'li',
	            scroll_symbol:'scroll',
	            sortKey:"time",
	            descending: true,
	            cursor : true,
	            page_size : 20,
	            postRenderCallback: function(el) {
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
	            		 $(".note-created-time", el).timeago();
	              	})
	            }
	        });
		    dealActivitiesView.collection.fetch();
	        $('#dealactivities').html(dealActivitiesView.el);
		    }
		},

		load_deal_tasks : function()
		{
			 var id = App_Deal_Details.dealDetailView.model.id;
			 if(id){
			 dealTasksView = new Base_Collection_View({
		            url: '/core/api/opportunity/' + id + "/tasks",
		            restKey: "task",
		            templateKey: "deal-tasks",
		            individual_tag_name: 'li',
		            sortKey:"id",
		            descending: true,
		            postRenderCallback: function(el) {
		            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
		            		 $(".task-created-time", el).timeago();
		              	})
		              	$('li',el).each(function(){
		            		if($(this).find('.priority_type').text().trim()== "HIGH") {
		            			$(this).css("border-left","3px solid #f05050");
		            		}else if($(this).find('.priority_type').text().trim() == "NORMAL"){
		            			$(this).css("border-left","3px solid #7266ba");
		            		}else if($(this).find('.priority_type').text().trim() == "LOW") {
		            			$(this).css("border-left","3px solid #fad733");
		            		}
		            	});
		            }
		        });
			 dealTasksView.collection.fetch();
			 $('#dealtasks').html(dealTasksView.el);
			 }
		},

		load_deal_events : function()
		{
			var id = App_Deal_Details.dealDetailView.model.id;
			if(id){
			dealEventsView = new Base_Collection_View({
	            url: '/core/api/opportunity/' + id + "/events",
	            restKey: "event",
	            templateKey: "deal-events",
	            individual_tag_name: 'li',
	            sortKey:"created_time",
	            descending: true,
	            postRenderCallback: function(el) {
	            	head.js(LIB_PATH + 'lib/jquery.timeago.js', function(){
	            		 $(".event-created-time", el).timeago();
	              	});
	            	$('li',el).each(function(){
	            	if($(this).find('.priority_type').text().trim() == "High") {
            			$(this).css("border-left","3px solid #f05050");
            		}else if($(this).find('.priority_type').text().trim() == "Normal"){
            			$(this).css("border-left","3px solid #7266ba");
            		}else if($(this).find('.priority_type').text().trim() == "Low") {
            			$(this).css("border-left","3px solid #fad733");
            		}
	            	});
	            }
	        });
			dealEventsView.collection.fetch();
	        $('#dealevents').html(dealEventsView.el);
			}
		},
		
};



/** 
 * To attach the document to a contact
 * @param document_id
 * @param saveBtn
 */
function existing_deal_document_attach(document_id, saveBtn)
{
    var json = existingDealDocumentsView.collection.get(document_id).toJSON();
	
	// To get the contact id and converting into string
	var deal_id = App_Deal_Details.dealDetailView.model.id + "";
    
    // Checks whether the selected document is already attached to that contact
    if((json.deal_ids).indexOf(deal_id) < 0)
    {
    	json.deal_ids.push(deal_id);
    	saveDocument(null, null, saveBtn, false, json);
    }
    else
    {
    	saveBtn.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>Linked Already</span>");
    	saveBtn.closest("span").find('span.save-status').find("span").fadeOut(5000);
    	return;
    }
}
/**
 * contact-details-tabs.js fetches the contact (which is in contact detail view)
 * related details (notes, tasks, deals, campaigns and mails etc..) and presents
 * in tab content as specified, when the corresponding tab is clicked. Timeline
 * tab is activated by default to show all the details as vertical time-line.
 * 
 * @module deal management
 * @author jagadeesh
 */

var deal_tab_position_cookie_name = "deal_tab_position";
var id;

/**
* Deal modal actions
*/
var Deal_Modal_Event_View = Base_Model_View.extend({
    events: {
    	'click #deal-details-tab a[href="#dealnotes"]' : 'openDealNotes',
    	'click #deal-details-tab a[href="#dealrelated"]' : 'openDealContacts',
    	'click #deal-details-tab a[href="#dealactivities"]' : 'openDealActivities',
    	'click #deal-details-tab a[href="#dealdocs"]' : 'openDealDocs',
    	'click #deal-details-tab a[href="#dealtasks"]' : 'openDealTasks',
    	'click #deal-details-tab a[href="#dealevents"]' : 'openDealEvents',
    	'click #deal-owner' : 'showOwnerList',

    	'click #opportunity-actions-delete' : 'opportunityDelete',
    	'click .deal-edit-note' : 'dealNoteEdit',
    	'click #dealshow-note' : 'dealShowNoteModal',
    	'click .deal-owner-list' : 'openDealOwnersList',
    	'click .deal-add-contact' : 'addDealContact',
    	'click .deal-detail-edit-deal' : 'editDeal',
    	'click .deal-note' : 'showDealNote',
    	'click #dealdetail-archive' : 'dealArchive',
    	'click .deal-restore-detail-view' : 'dealRestoreView',
    	'click .document-edit-deal-tab' : 'dealDocumentEdit',
    	'click .document-unlink-deal-tab' : 'dealUnlinkDocument',
    	'click .add-deal-document-select' : 'dealDocumentsList',
    	'click .add-deal-document-confirm' : 'dealAddDocumentConfirm',
    	'click .add-deal-document-cancel' : 'dealAddDocumentCancel',
    	'click .deal-add-task' : 'dealAddtask',
    	'click .task-edit-deal-tab' : 'dealEditTask',
    	'click .deal-task-delete' : 'dealDeleteTask',
    	'click .complete-deal-task' : 'dealCompleteTask',
    	'click .deal-add-event' : 'dealAddEvent',
    	'click .event-edit-deal-tab' : 'dealEditEvent',
		'click .deal-event-delete' : 'dealEditDelete',   	
    	
    },

	/**
	 * Fetches all the notes related to the deal and shows the notes collection
	 * as a table in its tab-content, when "Notes" tab is clicked.
	 */
	openDealNotes :  function(e)
	{
		e.preventDefault();

		save_deal_tab_position_in_cookie("dealnotes");
		deal_details_tab.load_deal_notes();
	},

	/**
	 * Fetches all the contacts related to the deal and shows the contacts
	 * collection as a table in its tab-content, when "contacts" tab is clicked.
	 */
	openDealContacts : function(e)
	{
		e.preventDefault();
		save_deal_tab_position_in_cookie("dealrelated");
		deal_details_tab.loadDealRelatedContactsView();
	},

	/**
	 * Fetches all the notes related to the contact and shows the tasks
	 * collection as a table in its tab-content, when "Tasks" tab is clicked.
	 */
	openDealActivities : function(e)
	{
		e.preventDefault();

		save_deal_tab_position_in_cookie("dealactivities");
		deal_details_tab.load_deal_activities();
	},

	/**
	 * Fetches all the docs related to the deal and shows the docs collection as
	 * a table in its tab-content, when "Documents" tab is clicked.
	 */
	openDealDocs : function(e)
	{		e.preventDefault();
		save_deal_tab_position_in_cookie("dealdocs");
		deal_details_tab.load_deal_docs();
	},
	
	/**
	 * Fetches all the tasks related to the deal and shows the docs collection as
	 * a table in its tab-content, when "Tasks" tab is clicked.
	 */
	openDealTasks: function(e)
	{
		e.preventDefault();
		save_deal_tab_position_in_cookie("dealtasks");
		deal_details_tab.load_deal_tasks();
	},

	/**
	 * Fetches all the events related to the deal and shows the docs collection as
	 * a table in its tab-content, when "Events" tab is clicked.
	 */
	openDealEvents : function(e)
	{
		e.preventDefault();
		save_deal_tab_position_in_cookie("dealevents");
		deal_details_tab.load_deal_events();
	},


	showOwnerList: function(e)
	{
		e.preventDefault();
		fill_deal_owners(undefined, undefined, function()
		{

			$('#deal-owner').css('display', 'none');
			$('#change-deal-owner-ul').css('display', 'inline-block');

			if ($('#change-deal-owner-ul').css('display') == 'inline-block')
				$("#change-owner-element").find(".loading").remove();

		});

	},


	opportunityDelete : function(e)
	{
		e.preventDefault();

		if (!confirm("Are you sure you want to delete?"))
			return;

		var targetEl = $(e.currentTarget);
		var id = $(targetEl).closest('.deal_detail_delete').attr('data');

		$.ajax({ url : 'core/api/opportunity/' + id, type : 'DELETE', success : function(data)
		{
			Backbone.history.navigate("#deals", { trigger : true });
		}, error : function(response)
		{
			alert("some exception occured please try again");
		} });
	},

	dealNoteEdit:  function(e)
	{

		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var note = dealNotesView.collection.get($(targetEl).attr('data'));
		console.log(note);
		deserializeForm(note.toJSON(), $("#dealnoteUpdateForm", $('#dealnoteupdatemodal')));
		fill_relation_deal($('#dealnoteUpdateForm'));
		$('#dealnoteupdatemodal').modal('show');

	},
	

	/**
	 * Shows note modal and activates contacts typeahead to its related to field
	 */
	dealShowNoteModal: function(e)
	{
		if (App_Deal_Details.dealDetailView.model.get('archived') == true)
			return;

		e.preventDefault();
		$("#deal-note-modal").modal('show');

	},

	/**
	 * Changes, owner of the contact, when an option of change owner drop down
	 * is selected.
	 */
	openDealOwnersList: function(e)
	{

		$('#change-deal-owner-ul').css('display', 'none');
		var targetEl = $(e.currentTarget);

		// Reads the owner id from the selected option
		var new_owner_id = $(targetEl).attr('data');
		var new_owner_name = $(targetEl).text();
		var current_owner_id = $('#deal-owner').attr('data');
		// Returns, if same owner is selected again
		if (new_owner_id == current_owner_id)
		{
			// Showing updated owner
			show_deal_owner();
			return;
		}

		var dealModel = new BaseModel();
		dealModel.url = '/core/api/opportunity/change-owner/' + new_owner_id + "/" + App_Deal_Details.dealDetailView.model.get('id');
		dealModel.save(App_Deal_Details.dealDetailView.model.toJSON(), { success : function(model)
		{

			$('#deal-owner').text(new_owner_name);
			$('#deal-owner').attr('data', new_owner_id);

			// Showing updated owner
			show_deal_owner();
			App_Deal_Details.dealDetailView.model = model;
			App_Deal_Details.dealDetailView.render(true)
			Backbone.history.navigate("deal/" + model.toJSON().id, { trigger : true });

		} });

	},

	addDealContact: function(e)
	{
		e.preventDefault();
		console.log(App_Deal_Details.dealDetailView.model.toJSON());
		var currentdeal = App_Deal_Details.dealDetailView.model;
		updateDeal(currentdeal);

		setTimeout(function()
		{
			$('#opportunityUpdateForm').find("input[name='relates_to']").focus();
		}, 800);

	},

	editDeal:  function(e)
	{
		e.preventDefault();
		console.log(App_Deal_Details.dealDetailView.model.toJSON());
		var currentdeal = App_Deal_Details.dealDetailView.model;
		updateDeal(currentdeal);

	},

	showDealNote: function(e)
	{
		e.preventDefault();

		var el1 = $("#dealnoteForm");

		// Displays contact name, to indicate the note is related to the contact
		fill_relation_deal(el1);
		$('#deal-note-modal').modal('show');
	},

	dealArchive: function(e)
	{
		e.preventDefault();

		var currentDeal = App_Deal_Details.dealDetailView.model.toJSON();
		$("#archived-deal-id", $("#deal_archive_confirm_modal")).val(currentDeal.id);
		$("#archived-deal-milestone", $("#deal_archive_confirm_modal")).val(currentDeal.milestone);
		$("#deal_archive_confirm_modal").modal('show');

	},

	dealRestoreView: function(e)
	{
		e.preventDefault();

		var currentDeal = App_Deal_Details.dealDetailView.model.toJSON();

		$("#restored-deal-id", $("#deal_restore_confirm_modal")).val(currentDeal.id);
		$("#restored-deal-milestone", $("#deal_restore_confirm_modal")).val(currentDeal.milestone);
		$("#deal_restore_confirm_modal").modal('show');

	},

	//For updating document from contact-details
	dealDocumentEdit: function(e){
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var id = $(targetEl).attr('data');
		updateDocument(dealDocsView.collection.get(id));
	},

	// For unlinking document from contact-details
	dealUnlinkDocument: function(e){
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var id = $(targetEl).attr('data');
		var json = dealDocsView.collection.get(id).toJSON();
		
		// To get the contact id and converting into string
		var deal_id = App_Deal_Details.dealDetailView.model.id + "";
		
	    // Removes the contact id from related to contacts
		json.deal_ids.splice(json.deal_ids.indexOf(deal_id),1);
		
		// Updates the document object and hides 
		var newDocument = new Backbone.Model();
		newDocument.url = 'core/api/documents';
		newDocument.save(json, {
			success : function(data) {
				dealDocsView.collection.remove(json);
				dealDocsView.render(true);
			}
		});
	},

	/**
	 * For showing new/existing documents
	 */
	dealDocumentsList: function(e){
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var el = $(targetEl).closest("div");
		$(targetEl).css("display", "none");
		el.find(".deal-document-select").css("display", "inline");
		var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
	    fillSelect('document-select','core/api/documents', 'documents',  function fillNew()
		{
			el.find("#document-select").append("<option value='new'>Add New Doc</option>");

		}, optionsTemplate, false, el); 
	},

	/**
	 * For adding existing document to current contact
	 */
	dealAddDocumentConfirm: function(e){
		e.preventDefault();
		var targetEl = $(e.currentTarget);

	    var document_id = $(targetEl).closest(".deal-document-select").find("#document-select").val();
		var saveBtn = $(targetEl);
		
			// To check whether the document is selected or not
	    if(document_id == "")
	    {
	    	saveBtn.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>This field is required.</span>");
	    	saveBtn.closest("span").find('span.save-status').find("span").fadeOut(5000);
	    	return;
	    }	    	
	    else if(document_id == "new")
	    {
	    	
	    	$('#uploadDocumentModal').html(getTemplate("upload-document-modal", {})).modal('show');
			
			var el = $("#uploadDocumentForm");
			// Contacts type-ahead
			agile_type_ahead("document_relates_to_contacts", el, contacts_typeahead);
			
			// Deals type-ahead
			agile_type_ahead("document_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);

	    	var deal_json = App_Deal_Details.dealDetailView.model.toJSON();
	    	var deal_name = deal_json.name;
	    	$('.deal_tags',el).append('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+ deal_json.id +'">'+deal_name+'</li>');
	    }
	    else if(document_id != undefined && document_id != null)
	    {
			if(!existingDealDocumentsView)
			{
				existingDealDocumentsView = new Base_Collection_View({ 
					url : 'core/api/documents',
					restKey : "documents",
				});
				existingDealDocumentsView.collection.fetch({
				    success: function(data){
				    		existing_deal_document_attach(document_id, saveBtn);
				    	}
			        });
			}
			else
				existing_deal_document_attach(document_id, saveBtn);
	    }

	},

	/**
	 * To cancel the add documents request
	 */
	dealAddDocumentCancel: function(e){
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var el = $(targetEl).closest("div");
		el.find(".deal-document-select").css("display", "none");
		el.find(".add-deal-document-select").css("display", "inline");
	},

	dealAddtask:  function(e){ 
    	e.preventDefault();
    	$('#activityTaskModal').html(getTemplate("new-task-modal")).modal('show');

		var	el = $("#taskForm");
		highlight_task();
		// Displays contact name, to indicate the task is related to the contact
		fill_relation_deal_task(el);

		agile_type_ahead("task_related_to", el, contacts_typeahead);

        agile_type_ahead("task_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);

		// Fills owner select element
		populateUsers("owners-list", $("#taskForm"), undefined, undefined,
				function(data) {
					$("#taskForm").find("#owners-list").html(data);
					$("#owners-list", el).find('option[value='+ CURRENT_DOMAIN_USER.id +']').attr("selected", "selected");
					$("#owners-list", $("#taskForm")).closest('div').find('.loading-img').hide();					
		});

       activateSliderAndTimerToTaskModal();
    },

    dealEditTask: function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var id = $(targetEl).attr('data');
		var value = dealTasksView.collection.get(id).toJSON();

		deserializeForm(value, $("#updateTaskForm"));

		$("#updateTaskModal").modal('show');

		$('.update-task-timepicker').val(fillTimePicker(value.due));
		// Fills owner select element
		populateUsers("owners-list", $("#updateTaskForm"), value, 'taskOwner', function(data)
		{
			$("#updateTaskForm").find("#owners-list").html(data);
			if (value.taskOwner)
				$("#owners-list", $("#updateTaskForm")).find('option[value=' + value['taskOwner'].id + ']').attr("selected", "selected");

			$("#owners-list", $("#updateTaskForm")).closest('div').find('.loading-img').hide();
		});

		// Add notes in task modal
		showNoteOnForm("updateTaskForm", value.notes);

		activateSliderAndTimerToTaskModal();

	},

	/**
	 * Delete functionality for tasks blocks in deal details
	 */
	dealDeleteTask: function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var model = $(targetEl).parents('li').data();

		if (model && model.toJSON().type != "WEB_APPOINTMENT")
		{
			if (!confirm("Are you sure you want to delete?"))
				return;
		}
		else if (model && model.toJSON().type == "WEB_APPOINTMENT" && parseInt(model.toJSON().start) < parseInt(new Date().getTime() / 1000))
		{
			if (!confirm("Are you sure you want to delete?"))
				return;
		}

		if (model && model.collection)
		{
			model.collection.remove(model);
		}

		// Gets the id of the entity
		var entity_id = $(targetEl).attr('id');

		if (model && model.toJSON().type == "WEB_APPOINTMENT" && parseInt(model.toJSON().start) > parseInt(new Date().getTime() / 1000))
		{
			web_event_title = model.toJSON().title;
			if (model.toJSON().contacts.length > 0)
			{
				var firstname = getPropertyValue(model.toJSON().contacts[0].properties, "first_name");
				if (firstname == undefined)
					firstname = "";
				var lastname = getPropertyValue(model.toJSON().contacts[0].properties, "last_name");
				if (lastname == undefined)
					lastname = "";
				web_event_contact_name = firstname + " " + lastname;
			}
			$("#webEventCancelModel").modal('show');
			$("#cancel_event_title").html("Delete event &#39" + web_event_title + "&#39");
			$("#event_id_hidden").html("<input type='hidden' name='event_id' id='event_id' value='" + entity_id + "'/>");
			return;
		}

		// Gets the url to which delete request is to be sent
		var entity_url = $(targetEl).attr('url');

		if (!entity_url)
			return;

		var id_array = [];
		var id_json = {};

		// Create array with entity id.
		id_array.push(entity_id);

		// Set entity id array in to json object with key ids,
		// where ids are read using form param
		id_json.ids = JSON.stringify(id_array);
		var that = targetEl;

		// Add loading. Adds loading only if there is no loaded image added
		// already i.e.,
		// to avoid multiple loading images on hitting delete multiple times
		if ($(targetEl).find('.loading').length == 0)
			$(targetEl).prepend($(LOADING_HTML).addClass('pull-left').css('width', "20px"));

		$.ajax({ url : entity_url, type : 'POST', data : id_json, success : function()
		{
			// Removes activity from list
			$(that).parents(".activity").parent().fadeOut(400, function()
			{
				$(targetEl).remove();
			});
			if(dealTasksView && dealTasksView.collection.length==0)
			{
				$('#dealtasks').html(dealTasksView.render(true).el);
			}
		} });
	},

	dealCompleteTask: function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		if ($(targetEl).is(':checked'))
		{
			var id = $(targetEl).attr('data');
			var that = targetEl;
			complete_task(id, dealTasksView.collection, undefined, function(data)
			{
				$(that).parent().siblings(".task-subject").css("text-decoration", "line-through");
				console.log($(that).parents('.activity-text-block').css("background-color", "#FFFAFA"));
				$(that).parent().replaceWith('<span style="margin-right:9px;"><i class="fa fa-check"></i></span>');
				dealTasksView.collection.add(data, { silent : true });
			});
		}
	},

	/**
	 * Displays activity modal with all event features,  to add a event 
	 * related to the deal in deal detail view. Also prepends the 
	 * deal name to related to field of activity modal.
	 */ 
    dealAddEvent: function(e){ 
    	e.preventDefault();

    	$('#activityModal').html(getTemplate("new-event-modal")).modal('show');

    	var	el = $("#activityForm");

		highlight_event();
		// Displays contact name, to indicate the task is related to the contact
		fill_relation_deal_task(el);
		agile_type_ahead("event_related_to", el, contacts_typeahead);
        agile_type_ahead("task_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);

    },

    // Event edit in contact details tab
	dealEditEvent: function(e)
					{
						e.preventDefault();
						var targetEl = $(e.currentTarget);

						$("#updateActivityModal").html(getTemplate("update-activity-modal"));
						
						var id = $(targetEl).attr('data');
						var value = dealEventsView.collection.get(id).toJSON();
						deserializeForm(value, $("#updateActivityForm"));
						$("#updateActivityModal").modal('show');

						$('.update-start-timepicker').val(fillTimePicker(value.start));
						$('.update-end-timepicker').val(fillTimePicker(value.end));

		if (value.type == "WEB_APPOINTMENT" && parseInt(value.start) > parseInt(new Date().getTime() / 1000))
		{
			$("[id='event_delete']").attr("id", "delete_web_event");
			web_event_title = value.title;
			if (value.contacts.length > 0)
			{
				var firstname = getPropertyValue(value.contacts[0].properties, "first_name");
				if (firstname == undefined)
					firstname = "";
				var lastname = getPropertyValue(value.contacts[0].properties, "last_name");
				if (lastname == undefined)
					lastname = "";
				web_event_contact_name = firstname + " " + lastname;
			}
		}
		else
		{
			$("[id='delete_web_event']").attr("id", "event_delete");
		}
		if (value.description)
		{
			var description = '<label class="control-label"><b>Description </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="Add Description"></textarea></div>'
			$("#event_desc").html(description);
			$("textarea#description").val(value.description);
		}
		else
		{
			var desc = '<div class="row-fluid">' + '<div class="control-group form-group m-b-none">' + '<a href="#" id="add_event_desctiption"><i class="icon-plus"></i> Add Description </a>' + '<div class="controls event_discription hide">' + '<textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="Add Description"></textarea>' + '</div></div></div>'
			$("#event_desc").html(desc);
		}
		// Fills owner select element
		populateUsersInUpdateActivityModal(value);
	},

	/**
	 * Delete functionality for events blocks in deal details
	 */
	dealEditDelete: function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget)

		var model = $(targetEl).parents('li').data();

		if (model && model.toJSON().type != "WEB_APPOINTMENT")
		{
			if (!confirm("Are you sure you want to delete?"))
				return;
		}
		else if (model && model.toJSON().type == "WEB_APPOINTMENT" && parseInt(model.toJSON().start) < parseInt(new Date().getTime() / 1000))
		{
			if (!confirm("Are you sure you want to delete?"))
				return;
		}

		if (model && model.collection)
		{
			model.collection.remove(model);
		}

		// Gets the id of the entity
		var entity_id = $(targetEl).attr('id');

		if (model && model.toJSON().type == "WEB_APPOINTMENT" && parseInt(model.toJSON().start) > parseInt(new Date().getTime() / 1000))
		{
			web_event_title = model.toJSON().title;
			if (model.toJSON().contacts.length > 0)
			{
				var firstname = getPropertyValue(model.toJSON().contacts[0].properties, "first_name");
				if (firstname == undefined)
					firstname = "";
				var lastname = getPropertyValue(model.toJSON().contacts[0].properties, "last_name");
				if (lastname == undefined)
					lastname = "";
				web_event_contact_name = firstname + " " + lastname;
			}
			$("#webEventCancelModel").modal('show');
			$("#cancel_event_title").html("Delete event &#39" + web_event_title + "&#39");
			$("#event_id_hidden").html("<input type='hidden' name='event_id' id='event_id' value='" + entity_id + "'/>");
			return;
		}

		// Gets the url to which delete request is to be sent
		var entity_url = $(targetEl).attr('url');

		if (!entity_url)
			return;

		var id_array = [];
		var id_json = {};

		// Create array with entity id.
		id_array.push(entity_id);

		// Set entity id array in to json object with key ids,
		// where ids are read using form param
		id_json.ids = JSON.stringify(id_array);
		var that = targetEl;

		// Add loading. Adds loading only if there is no loaded image added
		// already i.e.,
		// to avoid multiple loading images on hitting delete multiple times
		if ($(targetEl).find('.loading').length == 0)
			$(targetEl).prepend($(LOADING_HTML).addClass('pull-left').css('width', "20px"));

		$.ajax({ url : entity_url, type : 'POST', data : id_json, success : function()
		{
			// Removes activity from list
			$(that).parents(".activity").parent().fadeOut(400, function()
			{
				$(targetEl).remove();
			});
			if(dealEventsView && dealEventsView.collection.length==0)
			{
				$('#dealevents').html(dealEventsView.render(true).el);
			}
		} });
	},

});

function save_deal_tab_position_in_cookie(tab_href)
{

	var position = readCookie(deal_tab_position_cookie_name);

	if (position == tab_href)
		return;

	createCookie(deal_tab_position_cookie_name, tab_href);
}

function load_deal_tab(el, dealJSON)
{
	// timeline_collection_view = null;
	var position = readCookie(deal_tab_position_cookie_name);
	if (position)
	{
		if (position == "dealactivities")
		{
			$('#deal-details-tab a[href="#dealactivities"]', el).tab('show');

			deal_details_tab.load_deal_activities();
		}
		else if (position == "dealrelated")
		{
			$('#deal-details-tab a[href="#dealrelated"]', el).tab('show');

			deal_details_tab.loadDealRelatedContactsView();
		}
		else if (position == "dealnotes")
		{
			$('#deal-details-tab a[href="#dealnotes"]', el).tab('show');

			deal_details_tab.load_deal_notes();
		}
		else if (position == "dealdocs")
		{
			$('#deal-details-tab a[href="#dealdocs"]', el).tab('show');

			deal_details_tab.load_deal_docs();
		}
		else if (position == "dealtasks")
		{
			$('#deal-details-tab a[href="#dealtasks"]', el).tab('show');

			deal_details_tab.load_deal_tasks();
		}
		else if (position == "dealevents")
		{
			$('#deal-details-tab a[href="#dealevents"]', el).tab('show');

			deal_details_tab.load_deal_events();
		}
	}
	else
	{

		$('#deal-details-tab a[href="#dealactivities"]', el).tab('show');

		deal_details_tab.load_deal_activities();
	}

}


$(function(){
 	/**
	 * Saves note model using "Bcakbone.Model" object, and adds saved data to
	 * time-line if necessary.
	 */
	$('#deal-note-modal').on('click', '#dealnote_validate', function(e)
	{

		e.preventDefault();

		// Returns, if the save button has disabled attribute
		if ($(this).attr('disabled'))
			return;

		if (!isValidForm('#dealnoteForm'))
		{
			return;
		}

		disable_save_button($(this));

		// Shows loading symbol until model get saved
		// $('#noteModal').find('span.save-status').html(getRandomLoadingImg());

		var json = serializeForm("dealnoteForm");

		console.log(json);

		saveDealNote($("#dealnoteForm"), $("#deal-note-modal"), this, json);
	});

	$('#dealnoteupdatemodal').on('click', '#dealnote_update', function(e)
	{

		e.preventDefault();

		// Returns, if the save button has disabled attribute
		if ($(this).attr('disabled'))
			return;

		// Disables save button to prevent multiple click event issues
		disable_save_button($(this));// $(this).attr('disabled', 'disabled');

		if (!isValidForm('#dealnoteUpdateForm'))
		{

			// Removes disabled attribute of save button
			enable_save_button($(this));
			return;
		}

		// Shows loading symbol until model get saved
		// $('#noteUpdateModal').find('span.save-status').html(getRandomLoadingImg());

		var json = serializeForm("dealnoteUpdateForm");

		saveDealUpdateNote($("#dealnoteUpdateForm"), $("#dealnoteupdatemodal"), this, json);

	});

});
	
		/**
		 * "Hide" event of note modal to remove contacts appended to related to
		 * field and validation errors
		 */
		$('#deal-note-modal').on('hidden.bs.modal', function()
		{
			// Removes appended contacts from related-to field
			$("#dealnoteForm").find("li").remove();

			// Remove value of input field
			$("#from_task", "#dealnoteForm").val("");
			$("#task_form", "#dealnoteForm").val("");
			
			// Removes validation error messages
			remove_validation_errors('dealnoteModal');
		});


	
		function saveDealNote(form, modal, element, note)
		{

			console.log(note);
			var noteModel = new Backbone.Model();
			noteModel.url = 'core/api/opportunity/deals/notes';
			noteModel.save(note, { success : function(data)
			{

				// Removes disabled attribute of save button
				enable_save_button($(element));//$(element).removeAttr('disabled');

				form.each(function()
				{
					this.reset();
				});

				// Removes loading symbol and hides the modal
				//modal.find('span.save-status img').remove();
				modal.modal('hide');


				App_Deal_Details.dealDetailView.model = data;
				App_Deal_Details.dealDetailView.render(true)
				Backbone.history.navigate("deal/"+data.toJSON().id , {
		            trigger: true
		        });
				
			
				
			} });
		}
		
		function saveDealUpdateNote(form, modal, element, note)
		{

			console.log(note);
			var noteModel = new Backbone.Model();
			noteModel.url = 'core/api/opportunity/deals/notes';
			noteModel.save(note, { success : function(data)
			{

				// Removes disabled attribute of save button
				enable_save_button($(element));//$(element).removeAttr('disabled');

				form.each(function()
				{
					this.reset();
				});

				// Removes loading symbol and hides the modal
				//modal.find('span.save-status img').remove();
				modal.modal('hide');


				App_Deal_Details.dealDetailView.model = data;
				App_Deal_Details.dealDetailView.render(true)
				Backbone.history.navigate("deal/"+data.toJSON().id , {
		            trigger: true
		        });
				
			
				
			} });
		}

// Magic Menu JavaScript Document

function initializeThemeSettingsListeners(){
	$('#theme-and-layout').on('click', '#saveTheme', function(e)
	{
		e.preventDefault();
		$(".theme-save-status").css("display","none");
		var saveBtn = $(this);

		// Returns, if the save button has disabled
		// attribute
		if ($(saveBtn).attr('disabled'))
			return;

		// Disables save button to prevent multiple click
		// event issues
		disable_save_button($(saveBtn));
		var form_id = $(this).closest('form').attr("id");

		if (!isValidForm('#' + form_id)) {
			// Removes disabled attribute of save button
			enable_save_button($(saveBtn));
			return false;
		}
		var json = serializeForm(form_id);
		console.log("theme_info" + json);
		$.ajax({
			url : '/core/api/user-prefs/saveTheme',
			type : 'PUT',
			data : json,
			success : function() {
				enable_save_button($(saveBtn));
			},
			error : function() {
				enable_save_button($(saveBtn));
			}
		});
	});

	$('#theme-and-layout').on('change', '#menuPosition', function(e){
	CURRENT_USER_PREFS.menuPosition = $(this).val();
	$(".theme-save-status").css("display","inline");
	if($(this).val() == 'top')
	{
		$(".app").addClass("app-aside-dock");
		$(".fixedicons#planView,.fixedicons#helpView").removeClass('fixedicons').addClass('dockedicons');
		
	}
	else
	{
		$(".app").removeClass("app-aside-dock");
		$(".dockedicons#planView,.dockedicons#helpView").removeClass('dockedicons').addClass('fixedicons');
		var pos = $("#aside").offset();
		$(".fixedicons#planView,.fixedicons#helpView").css("left",pos.left);
		if($(this).val() == 'left')
			$("#wrap").removeClass("app-aside-folded");
		else if($(this).val() == 'leftcol')
			$("#wrap").addClass("app-aside-folded");
	}
});

$('#theme-and-layout').on('change', '#layout', function(e){
	CURRENT_USER_PREFS.layout = $(this).val();
	$(".theme-save-status").css("display","inline");
	if($(this).val() == 'fluid')
	{
		$(".app").removeClass("container");
		var pos = $("#aside").offset();
		$(".fixedicons#planView,.fixedicons#helpView").css("left",pos.left);
	}
	else if($(this).val() == 'fixed')
	{
		$(".app").addClass("container");
		var pos = $("#aside").offset();
		$(".fixedicons#planView,.fixedicons#helpView").css("left",pos.left);
	}
});

$('#theme-and-layout').on('change', '#animations', function(e){
	CURRENT_USER_PREFS.animations = $(this).is(':checked');
	$(".theme-save-status").css("display","inline");
	if($(this).is(':checked'))
	{
		$("body").removeClass("disable-anim");
		$("#theme-and-layout").removeClass("custom-animated");
	}
	else
	{
		$("body").addClass("disable-anim");

	}
});

//retrieve the current radio button value	
$('#theme-and-layout').on('change', '.magicMenu input:radio', function(e){
		CURRENT_USER_PREFS.theme = $(this).val();
		$(".theme-save-status").css("display","inline");
		var asideClassName = $(this).attr("target-aside-class");
		var logoClassName = $(this).attr("target-logo-class");
		var topBarClassName = $(this).attr("target-topbar-class");
		
		
		$(".app-aside,#navbar,.navbar-header").removeClassPrefix("bg-").removeClass("dk").removeClass("dker").removeClass("b-r");
		$(".app-aside").addClass(asideClassName);
		$(".navbar-header").addClass(logoClassName);
		$("#navbar").addClass(topBarClassName);
	});

	
}

$(function(){

// window options funda

	
/*	
$("#check-fix-head").on('click',function(){
	if( ($("#check-fix-aside").is(":checked"))  &&  ($("#check-dock-aside").is(":checked")) ) {
		$("#check-fix-head").attr("checked",true);
		return false;
	}
	if ( $(this).is(":checked") ) {
	$(".app").addClass("app-header-fixed");
	}
	else {
	$(".app").removeClass("app-header-fixed");
    }
	
	});

$("#check-fix-aside").on('click',function(){
	if ( $(this).is(":checked") ) {
	$(".app").addClass("app-aside-fixed");
	}
	else {
	$(".app").removeClass("app-aside-fixed");
    }
	if( ($(this).is(":checked"))  &&  ($("#check-dock-aside").is(":checked")) ) {
		$("#check-fix-aside").attr("checked",true);
		$("#check-fix-head").attr("checked",true);
		$(".app").addClass("app-header-fixed");
	}
	});

$("#check-dock-aside").on('click',function(){
	if ( $("#check-fix-aside").is(":checked")) {
		$("#check-fix-head").attr("checked",true);
		$(".app").addClass("app-header-fixed");
	}
	if ( $(this).is(":checked") ) {
	$(".app").addClass("app-aside-dock");
	$(".fixedicons#planView,.fixedicons#helpView").removeClass('fixedicons').addClass('dockedicons');
	}
    else {
    $(".app").removeClass("app-aside-dock");
	$(".dockedicons#planView,.dockedicons#helpView").removeClass('dockedicons').addClass('fixedicons');
	var pos = $("#aside").offset();
	$(".fixedicons#planView,.fixedicons#helpView").css("left",pos.left);
    }
});



$("#check-box-layout").live('click',function(){
	if ( $(this).is(":checked") ) {
	$(".app").addClass("container");
	var pos = $("#aside").offset();
	$(".fixedicons#planView,.fixedicons#helpView").css("left",pos.left);
	

	}
	else {
	$(".app").removeClass("container");
	var pos = $("#aside").offset();
	$(".fixedicons#planView,.fixedicons#helpView").css("left",pos.left);
	
	}
    });

// Rainbow menu funda
	
	$(".toggle-inactive").on('click',function(){
		$(this).toggleClass("active");
		$(this).parent().toggleClass("active");
		$(".magicMenu span.text-center").addClass("active");
	});
	
	*/



$.fn.removeClassPrefix = function(prefix) {
    this.each(function(i, el) {
        var classes = el.className.split(" ").filter(function(c) {
            return c.trim().lastIndexOf(prefix, 0) !== 0;
        });
        el.className = $.trim(classes.join(" "));
    });
    return this;
};



});
	 


$("#mobile-menu").on("click",function(){
	$("#aside").toggleClass("off-screen");
});

$("#mobile-menu-settings").on("click",function(){
	$("#navbar").toggleClass("show");
});
	

	 
	

$('#app-aside-folded').on('click', function(e) {
	e.preventDefault();
	/*$('.app-aside-folded-inactive .hidden-folded ,.app-aside-folded .navi > ul > li > a span').css('display','none');
	
	if ($('#wrap').hasClass("app-aside-folded") ) {
	
		setTimeout(function(){
	$(".app-aside-folded-inactive .hidden-folded,.app-aside-folded .navi > ul > li > a span").fadeIn();
	
		},600);
    
	}*/
	$('#wrap').toggleClass('app-aside-folded');
    if( $('#wrap').hasClass('app-aside-folded')) {
		console.log("folded");
		$("#app-aside-folded i").removeClass("fa-dedent");
		$("#app-aside-folded i").addClass("fa-indent");
		$(".app-aside-folded:not(.app-aside-dock) .navi > ul > li#documentsmenu > a span").text("Docs");
	}
	else {
		$("#app-aside-folded i").removeClass("fa-indent");
		$("#app-aside-folded i").addClass("fa-dedent");
		$(".navi > ul > li#documentsmenu > a span").text("Documents");
	}
	
	//contactInnerTabsInvoke();
	
    
	});
	
$(document).ready(function(){

	$(".person").on("click", function(e){
		e.preventDefault();
		addContactBasedOnCustomfields();
		
	});


    $("#contact-results li").click(function(){
   $("#mobile-menu-settings").trigger('click');
   });
 

	if(( $(window).width() ) < 768 ) {
	
	$(".nav li a").click(function(){
	  $("#mobile-menu").delay(2000).trigger("click");
	});
	

   $("#mobile-menu-settings").on("click",function(){
   if( $("#aside").hasClass("off-screen") ) {
   $("#aside").removeClass("off-screen");
   }
   });

  

   $("#searchText").keyup(function(e){
    if(e.which == 13) {
   	$("#mobile-menu-settings").trigger('click');
   }
   });


   $("#mobile-menu").on("click",function(){
   if( $("#navbar").hasClass("show")) {
   	$("#navbar").removeClass("show");
   }
   });

   $("#navbar li a").on("click" , function(){
   if($(this).hasClass("dropdown-toggle")) {
	
    }
   else {
   	$("#navbar").removeClass("show");
   }
   });
   
   }



   });

//checks if there are any custom fields and if if present navigates to contact-add page otherwise opens person-modal
function addContactBasedOnCustomfields(){
 	$.ajax({
				url : 'core/api/custom-fields/required/scope?scope=CONTACT',
				type : 'GET',
				dataType : 'json',
				success : function(data){
					if(data.length > 0)
					{
						Backbone.history.navigate("contact-add" , {trigger: true});
						
					}
					else
						$("#personModal").modal("show");
				}
			});
 }









	
	
	
	
	/**
 * Deserialize.js It deserializes the form with the data, it is used while
 * editing data, it pre fills the form with the data to be edited.
 * 
 * deserializeForm(data, form) function iterates through data and finds the
 * element with respect to the name attribute of the field to fill the basic
 * fields i.e., input field, check box, select filed. This function includes
 * functionalities to deserialize the fields designed with custom functionality.
 * 
 * @param data
 *            data to be filled in form
 * @param form
 *            html form element
 */
function deserializeForm(data, form)
{

	// Iterates through the data(which is to be populated in the form) and finds
	// field elements in the form based on the name of the field and populates
	// it. i represents key of the map, el is the value corresponding to key

	// Reset tags html
    // $(form).find(".contacts.tags").html("");

	$
			.each(
					data,

					function(i, el)
					{

						// Finds the element with name attribute same as the key
						// in the JSON data
						var fel = form.find('*[name="' + i + '"]'), type = "", tag = "";

						// If Fields exist with the field name, process the
						// fields to fill the data in the form
						if (fel.length > 0)
						{

							// Reads the tag name of the field
							tag = fel[0].tagName.toLowerCase();

							// If tag of the element is of type select of
							// textarea fills the data
							if (tag == "select" || tag == "textarea")
							{ // ...
								$(fel).val(el);
							}

							/*
							 * If tag of the field is input type, checks whether
							 * input field is a date field, to generate date
							 * based on epoch time and fills in the input
							 * field(date fields uses bootstrap datepicker in
							 * the fileds)
							 */
							else if (tag == "input")
							{
								type = $(fel[0]).attr("type");

								/*
								 * If field has class date, calculates the date
								 * and fills in the input field, formats with
								 * datepicker
								 */
								if (fel.hasClass('date'))
								{
									try
									{
										fel.val(getDateInFormatFromEpoc(el));
									}
									catch (err)
									{

									}

									fel.datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY});

								}

								/*
								 * If type of the field is text of password or
								 * hidden fills the data
								 */
								else if (type == "text" || type == "password" || type == "hidden" || type == "number" || type == "url")
								{
									fel.val(el);
								}
								else if (tag == "select")
								{
									fel.val(el).trigger('change');
								}

								// Checks the checkbox if value of the filed is
								// true
								else if (type == "checkbox")
								{
									if (el)
									{
										if (el == true)
											fel.attr("checked", "checked");
									}
									else
									{
										fel.removeAttr("checked");
									}
								}

								/*
								 * If type of the field is "radio", then filters
								 * the field based on the value and checks it
								 * accordingly
								 */
								else if (type == "radio")
								{
									fel.filter('[value="' + el + '"]').attr("checked", "checked");
								}
							}

							/*
							 * Deserialize multiselect, select box to select
							 * multiple values, used for contact custom views.
							 * This is for the fields which uses
							 * jquery.multi-select.js, it provides multiSelect()
							 * function to fill the select
							 */
							else if (fel.hasClass('multiSelect') && tag == 'ul')
							{

								/*
								 * Iterates through options of the select and
								 * call multiSelect function to select the
								 * option
								 */
								$.each(el, function(index, option)
								{
									$('#multipleSelect', form).multiSelect('select', option);
								});
							}

							/*
							 * Deserialize tags, tags are represented by list
							 * elements prepended the respective input field. If
							 * field has class tagsinput and tag is ul and
							 * attribute of the field is contacts, then is field
							 * is considered as the tags field, it de-serializes
							 * the contact tags
							 */
							else if (fel.hasClass('tagsinput') && tag == "ul" && fel.hasClass('contacts'))
							{
								// Iterates through contacts to create a tag
								// element for each contact
								$
										.each(
												data.contacts,

												function(index, contact)
												{
													var tag_name;

													/*
													 * tag_id represents
													 * contact.id, values of the
													 * tags(li) are contact ids
													 */
													var tag_id = contact.id;

													/*
													 * tag_name represent the
													 * name of the contact
													 * first_name and last_name
													 */
													tag_name = getContactName(contact);
													
													var hrefLink = '#contact/'+contact.id;
													if(contact.type == 'COMPANY')
														hrefLink = '#company/'+contact.id;

													/*
													 * Creates a tag for each
													 * contact and appends to
													 * tags input field with
													 * class "tagsinput", tag
													 * value is contact id and
													 * name of li element is
													 * contact full name
													 */													
													fel.append(
																	'<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="' + tag_id + '"  style="display: inline-block; "><a class="text-white v-middle" href="' + hrefLink + '">' + tag_name + '</a><a class="close m-l-xs" id="remove_tag">&times</a></li>');
												});
							}

							/*
							 * Deserialize related deals, related deals are
							 * represented by list deals prepended the
							 * respective input field. If field has class
							 * dealtagsinput and deal_tag is ul and attribute of
							 * the field in an entity, then this field is
							 * considered as the tags field, it de-serializes
							 * the related deals.
							 */
							else if (fel.hasClass('tagsinput') && tag == "ul" && fel.hasClass('deals'))
							{
								// Iterates through contacts to create a tag
								// element for each contact
								$
										.each(
												data.deals,

												function(index, deal)
												{
													var tag_name;

													/*
													 * tag_id represents
													 * contact.id, values of the
													 * tags(li) are contact ids
													 */
													var tag_id = deal.id;

													/*
													 * tag_name represent the
													 * name of the contact
													 * first_name and last_name
													 */
													tag_name = deal.name.split(" ").join("");

													/*
													 * Creates a tag for each
													 * contact and appends to
													 * tags input field with
													 * class "tagsinput", tag
													 * value is contact id and
													 * name of li element is
													 * contact full name
													 */
													fel
															.append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="' + tag_id + '"><a href="#deal/' + deal.id + '" class="text-white v-middle">' + tag_name + '</a><a class="close m-l-xs" id="remove_tag">&times</a></li>');
												});
							}

							/*
							 * Deserialize multiselect, select box to select
							 * multiple values, used for contact custom views.
							 * This is for the fields which uses
							 * jquery.multi-select.js, it provides multiSelect()
							 * function to fill the select
							 */
							else if (fel.hasClass('multiSelect') && tag == 'ul')
							{

								/*
								 * Iterates through options of the select and
								 * call multiSelect function to select the
								 * option
								 */
								$.each(el, function(index, option)
								{
									$('#multipleSelect', form).multiSelect('select', option);
								});
							}

							/**
							 * Deserialize multiple checkboxes.
							 */
							else if (fel.hasClass('multiple-checkbox'))
							{

								/*
								 * Iterates through options of the select and
								 * call multiSelect function to select the
								 * option
								 */
								for (var i = 0; i < el.length; i++)
								{
									$('input:checkbox[value="' + el[i] + '"]', fel).attr("checked", "checked");
								}
							}

							/*
							 * Deserialize chained select, chained select is
							 * used for creating filters. It is logical chaining
							 * of the input fields, If form contains an element
							 * with class "chainedSelect" the deserializes the
							 * chained select. Chained select fields can be
							 * multiple, if value include multiple rules a
							 * chained select field should is added to the form
							 * and populates with the value
							 */
							else if (fel.hasClass('chainedSelect'))
							{

								// deserializeChainedSelect(form, el);
							}
						}

					});
}

// To deserialize multiple forms in content
/**
 * Desrializes the multiple forms, It calls deserializeForm for each form in the
 * element passed. Called from base-model when there are multiple forms with
 * single save option.
 * 
 * @param data
 *            data to be filled in forms
 * @param form
 *            html element with multiple forms
 */
function deserializeMultipleForms(data, form)
{
	// Iterates through each form element in the form and calls
	// deseriazlie of each form with respective data element
	// based on key(i.e., name of the form)
	$.each(form, function(index, form_element)
	{
		// Reads the name of the form element
		var key = $(form_element).attr('name');

		// If form have attribute name deserializes with particular object
		if (key && data[key])
		{
			deserializeForm(data[key], $(form_element));
		}

		// If data with the key is not available then calls
		// deserialize on the data directly, since form values
		// can be directly available in the JSON object
		else
			deserializeForm(data, $(form_element));
	});
}

function deserializeChainedSelect(form, el, el_self)
{

	// Iterates through JSON array of rules, to fill
	// a chained select
	$.each(el, function(index, data)
	{

		// Finds the rule html element
		var rule_element = ($(form).find('.chained'))[0];

		/*
		 * If more than one rule clones the fields and relate with
		 * jquery.chained.js
		 */
		if (index > 0)
		{
			var parent_element = $(rule_element).parent();

			/*
			 * Gets the Template for input and select fields
			 */
			rule_element = $($(el_self).clone().find('.chained'))[0];

			// Add remove icon for rule
			$(rule_element).find("i.filter-contacts-multiple-remove").css("display", "inline-block");

			var remove_icon = $(rule_element).find("i.filter-contacts-multiple-remove").css("display", "inline-block");

			// Loads jquery chained plugin for chaining
			// the input fields
			// head.js(LIB_PATH + 'lib/agile.jquery.chained.min.js',

			// function ()
			// {

			/*
			 * Chains dependencies of input fields with jquery.chained.js based
			 * on the rule element
			 */
			chainFilters(rule_element);

			$(parent_element).append(rule_element);
			deserializeChainedElement(data, rule_element);

			// });

			return;
		}

		deserializeChainedElement(data, rule_element);
	})
}

function deserializeChainedElement(data, rule_element)
{
	$(rule_element).removeClass('hide');
	// hide campaign status filter.
	/*
	 * if(data && data.LHS && data.LHS != 'campaign_status') {
	 * $(rule_element).find('#LHS
	 * select').find("optgroup[label='Activities']").remove(); }
	 */
	$.each(data, function(i, value)
	{
		var input_element = ($(rule_element).find('*[name="' + i + '"]').children())[0];
		if (!input_element)
			return;

		// If input field set is value for input field, checks it chained select
		// elements
		// date fields should be filled with date
		if (input_element.tagName.toLowerCase() == "input")
		{

			// Fills date in to fields and initialize datepicker on the field
			if ($(input_element).hasClass('date'))
			{
				value = getLocalTimeFromGMTMilliseconds(value);

				$(input_element).val(getDateInFormatFromEpoc(value));


				$(input_element).datepicker({ format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY });


				$(input_element).datepicker('update');

				return;
			}
			$(input_element).val(value);
			return;
		}

		// Gets related select field
		var option_element = $("option", input_element);

		// Iterates through options in select field
		$.each(option_element, function(index, element)
		{
			// Selects the option
			if ($(element).prop('value') == value)
			{
				$(element).attr("selected", "selected");
				var url = $(element).attr("url");
				if (url)
				{
					$(element).attr("data", data.RHS);
					console.log($(element));
				}
				$(input_element).trigger("change");
				return;
			}
		});
	});

}

function deserializeChainedElementWebrule(data, rule_element)
{
	$.each(data, function(i, value)
	{
		if (value.value)
			value = value.value;
		var input_element_set = $(rule_element).find('*[name="' + i + '"]').children();

		var input_element = input_element_set[0];
		if (!input_element)
			return;

		var tag_name = input_element.tagName.toLowerCase();
		if (tag_name != "input" && tag_name != "textarea" && tag_name != "select" && input_element_set.length > 1)
			$.each(input_element_set, function(index, input)
			{
				if (index == 0)
					return;
				tag_name = input.tagName.toLowerCase();
				if (tag_name == "input" || tag_name == "textarea" || tag_name == "select")
				{
					input_element = input;
					return false;
				}

			})

		if (!input_element)
			return;

		// If input field set is value for input field, checks it chained select
		// elements
		// date fields should be filled with date
		if (input_element.tagName.toLowerCase() == "input" || input_element.tagName.toLowerCase() == "textarea")
		{
			$(input_element).val(value);
			if ($(input_element).hasClass('custom_html'))
			{

				if (value.value)
				{
					$(input_element).val(value.value);
				}
				// setupHTMLEditor($(input_element), value.value);
				// }
				// else
				// setupHTMLEditor($(input_element), value);
			}

			return;
		}

		// Gets related select field
		var option_element = $("option", input_element);

		// Iterates through options in select field
		$.each(option_element, function(index, element)
		{
			// Selects the option
			if ($(element).prop('value') == value)
			{
				if ((value == "UNSUBSCRIBE_CAMPAIGN" || value == "ASSIGN_CAMPAIGN") && data['RHS'])
				{
					$(element).attr('data', data['RHS']);
				}
				$(element).attr("selected", "selected");
				$(input_element).trigger("change");
				return;
			}
		});
	});
}

function deserializeChainedSelect1(form, el, element)
{

	var self = $(element).find('.webrule-actions')[0];

	var rule_element_default = $(self).html();

	// Finds the rule html element
	var rule_element = ($(form).find('.webrule-actions'))[0];

	// Iterates through JSON array of rules, to fill
	// a chained select
	$.each(el, function(index, data)
	{

		/*
		 * If more than one rule clones the fields and relate with
		 * jquery.chained.js
		 */
		if (index > 0)
		{

			/*
			 * Gets the Template for input and select fields
			 */

			// Loads jquery chained plugin for chaining
			// the input fields
			// head.js('lib/agile.jquery.chained.min.js',
			// function ()
			// {
			var new_rule_element = $(rule_element_default).clone();

			// Add remove icon for rule
			$(new_rule_element).find("i.webrule-multiple-remove").css("display", "inline-block");

			var actions = [];
			actions.push(data);
			/*
			 * Chains dependencies of input fields with jquery.chained.js based
			 * on the rule element
			 */
			chainWebRules(new_rule_element, el, false, actions);

			deserializeChainedElementWebrule(data, new_rule_element);

			$(rule_element).append(new_rule_element);

			// });
			// return;
			return;
		}

		deserializeChainedElementWebrule(data, rule_element);
	})
}

function deserializeLhsFilters(element, data)
{
	var json_object = JSON.parse(data);
	var tagsConditionsCount = 0;
	var campaignConditionsCount = 0;
	$.each(json_object.rules, function(index, filter)
	{
		var LHS = filter.LHS;
		var CONDITION = filter.CONDITION;
		var RHS_VALUE = filter.RHS;
		var RHS_NEW_VALUE = filter.RHS_NEW;
		var fieldName = LHS.replace(/ +/g, '_');
		fieldName = fieldName.replace(/#/g, '\\#').replace(/@/g, '\\@');
		var currentElemnt = $(element).find('#' + fieldName + '_div');
		if (LHS == 'tags' || LHS == 'campaign_status')
		{
			$('#' + LHS + '_div').parent().find('a').addClass('bold-text');
			$('#' + LHS + '_div').removeClass('hide');
			if ((tagsConditionsCount == 0 && LHS == 'tags') || (campaignConditionsCount == 0 && LHS == 'campaign_status'))
			{
				currentElemnt = $('#' + LHS + '-lhs-filter-table').find("div.lhs-contact-filter-row:last")
				$('#' + LHS + '_div').prev().find('i').toggleClass('fa-plus').toggleClass('fa-minus');
			}
			else
			{
				var htmlContent = $('#' + LHS + '-lhs-filter-table').find("div.hide.master-" + LHS + "-add-div").clone();
				htmlContent.removeClass('hide').addClass('lhs-contact-filter-row');
				addTagsDefaultTypeahead(htmlContent);
				$(htmlContent).appendTo('#' + LHS + '-lhs-filter-table');
				currentElemnt = $('#' + LHS + '-lhs-filter-table').find("div.lhs-contact-filter-row:last");
			}
			if (LHS == 'tags')
			{
				tagsConditionsCount++;
			}
			if (LHS == 'campaign_status')
			{
				campaignConditionsCount++;
			}
		}
		else
		{
			$(currentElemnt).prev().find('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o');
		}
		$(currentElemnt).parent().find("a#lhs-filters-header").addClass('bold-text');
		$(currentElemnt).find('a.clear-filter-condition-lhs').removeClass('hide');
		$(currentElemnt).removeClass('hide');
		$(currentElemnt).find('[name="CONDITION"]').val(CONDITION);
		$(currentElemnt).find('[name="CONDITION"]').trigger('change');
		var RHS_ELEMENT = $(currentElemnt).find('.' + CONDITION).find('#RHS').children();
		var RHS_NEW_ELEMENT = $(currentElemnt).find('.' + CONDITION).find('#RHS_NEW').children();
		if ($(RHS_ELEMENT).hasClass("date"))
		{
			RHS_VALUE = getLocalTimeFromGMTMilliseconds(RHS_VALUE);

			$(RHS_ELEMENT).val(getDateInFormatFromEpoc(RHS_VALUE));
			$(RHS_ELEMENT).attr('prev-val', getDateInFormatFromEpoc(RHS_VALUE));
		} else {

			$(RHS_ELEMENT).val(RHS_VALUE);
			$(RHS_ELEMENT).attr('prev-val', RHS_VALUE);
		}
		if (RHS_NEW_ELEMENT)
		{
			if ($(RHS_NEW_ELEMENT).hasClass("date"))
			{
				RHS_NEW_VALUE = getLocalTimeFromGMTMilliseconds(RHS_NEW_VALUE);

				$(RHS_NEW_ELEMENT).val(getDateInFormatFromEpoc(RHS_NEW_VALUE));
				$(RHS_NEW_ELEMENT).attr('prev-val', getDateInFormatFromEpoc(RHS_NEW_VALUE));
			} else {

				$(RHS_NEW_ELEMENT).val(RHS_NEW_VALUE);
				$(RHS_NEW_ELEMENT).attr('prev-val', RHS_NEW_VALUE);
			}
		}

	});
}
/**
 * Serialize.js is used to serialize the forms, It returns a map, with field
 * values in form mapped against field names in the form as keys. It uses jquery
 * serializeArray method to serialize field value, and also provides custom
 * serializations for fields, to get custom values form the fields.
 * 
 * @param form_id
 *            Sends form id to be serialized
 * @returns JSON returns serialized form values
 */

function serializeForm(form_id) {
	var arr = $('#' + form_id).serializeArray(), obj = {};

	/*
	 * Serializes check box, though serialization for check box is available in
	 * SerializeArray which return "on", if checked. Since it is required to
	 * return true, if check box field is checked, so serialization is
	 * customized for checkbox.
	 */
	arr = arr.concat($('#' + form_id + ' input[type=checkbox]').map(function() {
		return {
			"name" : this.name,
			"value" : $(this).is(':checked')
		}
	}).get());

	// Change the dates properly from human readable strings to epoch
	/*
	 * Date fields, fields html elements with class "date" are serialized
	 * returns epoch time.
	 */
	arr = arr.concat($('#' + form_id + ' input.date').map(function() {
		if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
			return {
				"name" : this.name,
				"value" : new Date(convertDateFromUKtoUS(this.value)).getTime() / 1000
			};
		else
			return {
				"name" : this.name,
				"value" : new Date(this.value).getTime() / 1000
			};
	}).get());
	
	arr = arr.concat($('#' + form_id + ' select.multi-select').map(function() {
		console.log($(this).val());
		return {
			"name" : this.name,
			"value" : $(this).val()
		};
	}).get());
	console.log(arr);
	

	// Serialize tags
	arr = arr.concat(get_tags(form_id));

	// Serialize notes
	arr = arr.concat(get_notes(form_id));
	
	// Serialize tags
	arr = arr.concat(get_related_deals(form_id));
	
	/*
	 * Multiple select, If field is of type muti select then this returns set of
	 * values selected with the name of the field. To use this multi select,
	 * field element should have a class "multiSelect" and value in ms-value/
	 * Multi select is used for creating a custom view, it uses
	 * jquery.multiselect
	 */
	arr = arr.concat($('#' + form_id + ' .multiSelect').map(function() {
		var fields_set = [];

		// Gets list of options, selected and pushes the field values in to an
		// array fields_set
		$.each($(this).children('li'), function(index, data) {
			fields_set.push(($(data).attr('ms-value')))
		});

		// The array of selected values are mapped with the field name and
		// returned as a key value pair
		return {
			"name" : $(this).attr('name'),
			"value" : fields_set
		};
	}).get());
	
	arr = arr.concat($('#' + form_id + ' .multiple-checkbox').map(function() {
		var fields_set = [];

		$('input:checkbox:checked', this).each(function(index, element_checkbox){
			fields_set.push($(element_checkbox).val());
		});
		
		console.log(fields_set);

		// The array of selected values are mapped with the field name and
		// returned as a key value pair
		return {
			"name" : $(this).attr('name'),
			"value" : fields_set
		};
	}).get());

	/*
	 * Chained select, Chained select is used for filters, which uses logical
	 * input relation, field show have a class name "chained". Iterates through
	 * fields under element with class "chained", finds "div" element in it
	 */
	// Stores build rules based on chained select
	
	var chained_selects = $('#' + form_id + ' .chained-table:visible');
	$.each(chained_selects, function(index, element){
		var json_array = [];
	arr = arr.concat($(element).find('.chained:visible').map(function() {
		
		var json_object = serializeChainedElement(this);
		json_array.push(json_object);
	
		// Maps json array with name "rules"
		return {
			"name" : $(this).attr('name'),
			"value" : json_array
		};

	}).get());
	});

	// Converts array built from the form fields into JSON
	for ( var i = 0; i < arr.length; ++i) {
		obj[arr[i].name] = arr[i].value;
	}

	// obj[ $('#' + form_id + ' select').attr('name') ] = $('#' + form_id + '
	// select').val();
	return obj;
}

function serializeChainedElement(element)
{
	var json_object = {};
	$.each($(element).find('div').children(), function(index, data) {
		
		var tagName = $(data)[0].tagName;
		
		if(!(tagName == "TEXTAREA" || tagName == "INPUT" || tagName == "SELECT"))
			return;
		// Gets the name of the tr
		var name = $(data).parent().attr('name');
		var value;

		// If type of the field is "date" then return epoch time
		if ($(data).hasClass("date")) {
			var date;
			if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
				date = new Date(convertDateFromUKtoUS($(data).val()));
			else
				date = new Date($(data).val());
			value = getGMTEpochFromDate(date);
		}

		// Value of input/select
		else
			{
			if(!json_object[name])
				value = $(data).val();
			}

		// Set if value of input/select is valid
		if (value != null && value != "")
			json_object[name] = value;
		// Pushes each rule built from chained select in to an JSON array
	});
	return json_object;
}


$(function(){
	//Focus first element
	$.fn.focus_first = function() {
		
		var elem = $(this).find('input:visible').not('.hide').get(0);
		var textarea = $('textarea:visible', this).get(0);
		if (textarea && elem) {
			if (textarea.offsetTop < elem.offsetTop) {
				elem = textarea;
			}
		}
  
		if (elem) {
			$(elem).focus();
		}
		return this;
	}
	
	$('.modal').on('shown.bs.modal', function(event){
		$('form', this).focus_first();
	});
});

function serializeLhsFilters(element)
{
	var json_array = [];
	var filters = {};
	$(element).find('a#lhs-filters-header').removeClass('bold-text');
	$.each($(element).find('.lhs-contact-filter-row'), function(index, data) {
		var json_object = {};
		var currentElement = $(data)[0];
		var RHS_VALUE, RHS_NEW_VALUE;
		var CONDITION = $(currentElement).find('[name="CONDITION"]').val();
		
		var RHS_ELEMENT = $(currentElement).find('.'+CONDITION).find('#RHS').children();
		var RHS_NEW_ELEMENT = $(currentElement).find('.'+CONDITION).find('#RHS_NEW').children();
		if($(RHS_ELEMENT).val() != undefined) {			
			RHS_VALUE = $(RHS_ELEMENT).val().trim();
		}
		if ($(RHS_ELEMENT).hasClass("date") && RHS_VALUE && RHS_VALUE != "") {
			var date;
			if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
				date = new Date(convertDateFromUKtoUS($(RHS_ELEMENT).val()));
			else
				date = new Date($(RHS_ELEMENT).val());
			RHS_VALUE = getGMTEpochFromDate(date);
		}
		RHS_NEW_VALUE = $(RHS_NEW_ELEMENT).val();
		if ($(RHS_NEW_ELEMENT).hasClass("date") && RHS_NEW_VALUE && RHS_NEW_VALUE !="") {
			var date;
			if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
				date = new Date(convertDateFromUKtoUS($(RHS_NEW_ELEMENT).val()));
			else
				date = new Date($(RHS_NEW_ELEMENT).val());
			RHS_NEW_VALUE = getGMTEpochFromDate(date);
		}
		if(RHS_NEW_VALUE && typeof RHS_NEW_VALUE == "string") {
			RHS_NEW_VALUE = RHS_NEW_VALUE.trim();
		}
		
		// Set if value of input/select is valid
		if ((RHS_VALUE && RHS_VALUE != null && RHS_VALUE != "") || CONDITION =="DEFINED" || CONDITION =="NOT_DEFINED") {
			//if rhs_new exists and is empty dont consider this condition.
			if(RHS_NEW_ELEMENT && RHS_NEW_ELEMENT.length > 0 ) {
				if(!RHS_NEW_VALUE || RHS_NEW_VALUE == null || RHS_NEW_VALUE == "") {
					//in jquery each return is equivalent to continue.
					return;
				}
			}
			var LHS = $(currentElement).find('[name="LHS"]').val();
			json_object["LHS"] = LHS;
			json_object["CONDITION"] = CONDITION;
			json_object["RHS"] = RHS_VALUE;
			json_object["RHS_NEW"] = RHS_NEW_VALUE;
			json_array.push(json_object);
			var fieldName = LHS.replace(/ +/g, '_');
			fieldName = fieldName.replace(/#/g, '\\#').replace(/@/g, '\\@').replace(/[\/]/g,'\\/');
			var currentElemnt = $(element).find('#'+fieldName+'_div');
			$(currentElemnt).parent().find("a#lhs-filters-header").addClass('bold-text');
			$(currentElemnt).find('a.clear-filter-condition-lhs').removeClass('hide');
		}
		// Pushes each rule built from chained select in to an JSON array
	});
	filters["rules"] = json_array;
	filters["contact_type"] = $(element).find('#contact_type').val();
	return filters;
}
/**
 * validate.js is used to validate the forms in the application, isValidFom
 * method validates the form element
 * 
 * @param form
 * @returns
 */
function isValidForm(form) {
	

	// Credit card validation to check card is valid for next 3 months
	jQuery.validator.addMethod("atleastThreeMonths", function(value, element) {

			// Gets the exp_month field because expiry should be
			// checked both on month and year
			var month = $(element).siblings('select.exp_month')
					.val(), year = value;

			// date selected
			var date = new Date().setFullYear(year, month - 1);

			// Get number of milliseconds per day
			var one_day = 1000 * 60 * 60 * 24;

			// Calculates number of days left from the current date,
			// if number of days are greater than 90 then returns
			// true
			return this.optional(element)
					|| (((date - new Date().getTime()) / one_day) > 90);
		}, "Card should be atleast 3 months valid");
	
	// Validates multiple emails separated by comma entered in textbox
	jQuery.validator.addMethod("multipleEmails", function(value, element) {
        
		if (this.optional(element)) // return true on optional element
            return true;
        
        var emails = value.split(/[,]+/); // split element by , 
        valid = true;
        
        for (var i in emails) {
            value = emails[i];
            valid = valid &&
                    jQuery.validator.methods.email.call(this, $.trim(value), element);
        }
        
        return valid;
    }, "Please enter valid email each separated by comma.");

	
	jQuery.validator.addMethod("noSpecialChars", function(value, element) {
		return isAlphaNumeric(value);
	//	console.log(params);
		
	}, "Should start with an alphabet and special characters are not allowed.");

	// Internal regex of jQuery validator allows for special characters in e-mails.
	// This regex solves that, overriding 'email'
	jQuery.validator.addMethod("email", function(value, element){
		
		if(this.optional(element))
			return true;
		
		return /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/i.test(value);
	}," Please enter a valid email.");
	
	// Phone number validation
	jQuery.validator.addMethod("phone", function(value, element){
		
		if(this.optional(element))
			return true;
		
		//return /^(\()?(\d{3})([\)-\. ])?(\d{3})([-\. ])?(\d{4})$/.test(value);
		return /^[^a-zA-Z]+$/.test(value);
	}," Please enter a valid phone number.");
	
	jQuery.validator.addMethod("multi-tags", function(value, element){
		
		var	tag_input = $(element).val()
		$(element).val("");
		if(tag_input && tag_input.length>=0 && !(/^\s*$/).test(tag_input))
		{
			$(element).closest(".control-group").find('ul.tags').append('<li class="tag" style="display: inline-block;" data="'+tag_input+'">'+tag_input+'<a class="close" id="remove_tag" tag="'+tag_input+'">&times</a></li>');
		}
		
		return $(element).closest(".control-group").find('ul.tags > li').length > 0 ? true : false;
	}," This field is required.");
	
	jQuery.validator.addMethod("formulaData", function(value, element){
		var source = $(element).val();
		var tpl;
		var compiled=true;
		try{
			tpl = Handlebars.precompile(source);
		}catch(err){
			err.message;
			compiled=false;
		}
		return compiled ? true : false;
	}," Please enter a valid formula.");
	
	//Number validation
	jQuery.validator.addMethod("number_input", function(value, element){
		
		if(value=="")
			return false;
		
		return /^[0-9\-]+$/.test(value);
	}," Please enter a valid number.");
	
	jQuery.validator.addMethod("multi-select", function(value, element){
		var counter = 0;
		$(element).find(':selected').each( function( i, selected ) {
			counter++;
		});
		var limit = $(element).attr('limit');
		if(counter>limit)
			return false;
		return true;
	}," You can select maximum 3 folders only.");

	jQuery.validator.addMethod("date", function(value, element){
		if(value=="")
			return true;
		if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
		{
			return !/Invalid|NaN/.test(new Date(convertDateFromUKtoUS(value))); 
		}else
			return !/Invalid|NaN/.test(new Date(value));
	}," Please enter a valid date.");

	jQuery.validator.addMethod("date_input", function(value, element){
		if(value=="")
			return true;
		if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1)
		{
			return !/Invalid|NaN/.test(new Date(convertDateFromUKtoUS(value))); 
		}else
			return !/Invalid|NaN/.test(new Date(value));
	}," Please enter a valid date.");

	jQuery.validator.addMethod("field_length", function(value, element){
		if(value=="")
			return true;
		var counter = 0;
		var max_len = $(element).attr('max_len');
		if(max_len == "")
			return true;
		if(value.length > max_len)
			return false;
		return true;
	}, function(params, element) {
		  return 'Maximum length is ' + $(element).attr("max_len") + ' chars only.'
		}
	);
	$(form).validate({
		rules : {
			atleastThreeMonths : true,
			multipleEmails: true,
			email: true,
			phone: true
		},
		debug : true,
		errorElement : 'span',
		errorClass : 'help-inline',

		// Higlights the field and addsClass error if validation failed
		highlight : function(element, errorClass) {
			$(element).closest('.controls').addClass('single-error');
		},

		// Unhiglights and remove error field if validation check passes
		unhighlight : function(element, errorClass) {
			$(element).closest('.controls').removeClass('single-error');
		},
		invalidHandler : function(form, validator) {
			var errors = validator.numberOfInvalids();
		}
	});

	// Return valid of invalid, to stop from saving the data
	return $(form).valid();
}

function isNotValid(value) {
    if (value == undefined) return true;
    if (value.length == 0) return true;
    return false;
}


function isValidField(id) {
    var value = $('#' + id).val();
    return !isNotValid(value);
}


function isAlphaNumeric(subdomain) {
	subdomain = subdomain.toString();
  
  var regularExpression  = new RegExp(/^[A-Za-z][a-zA-Z0-9]{3,20}$/);
  if(!regularExpression.test(subdomain)) {
        error = "Domain should start with an alphabet and special characters are not allowed.";
		return false;
    }
  return true;
}

function isAlphaNumeric(subdomain) {
	subdomain = subdomain.toString();
	
  var regularExpression  = new RegExp(/^[A-Za-z#@][A-Za-z0-9_:&@;/\s/g]*$/);
  if(!regularExpression.test(subdomain)) {
		return false;
    }
  return true;
}
var isDateChanged=false;
function gmap_date_range(el, callback){
	
	  
		// Bootstrap date range picker.
	   var date = new Date();
	   date.setDate(date.getDate()-1);
		$('#gmap_date_range', el).daterangepicker({ranges : { 'Today' : [
				'today', 'today'
		], 'Yesterday' : [
				'yesterday', 'yesterday'
		], 'Last 7 Days' : [
				Date.today().add({ days : -6 }), 'today'
		], 'Last 30 Days' : [
				Date.today().add({ days : -29 }), 'today'
		], 'This Month' : [
				Date.today().moveToFirstDayOfMonth(), Date.today().moveToLastDayOfMonth()
		], 'Last Month' : [
				Date.today().moveToFirstDayOfMonth().add({ months : -1 }), Date.today().moveToFirstDayOfMonth().add({ days : -1 })
		], 'This Quarter' : [
				Date.today().getMonth() < 3 ? new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth() : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth() : new Date(Date.today().setMonth(9)).moveToFirstDayOfMonth(), 
				Date.today().getMonth() < 3 ? new Date(Date.today().setMonth(2).moveToLastDayOfMonth()) : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(5)).moveToLastDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(8)).moveToLastDayOfMonth() : new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()
		], 'Last Quarter' : [
				Date.today().getMonth() < 3 ? new Date(Date.today().add({ years : -1 }).setMonth(9)).moveToFirstDayOfMonth() : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth() : new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth(), 
				Date.today().getMonth() < 3 ? new Date(Date.today().add({ years : -1 }).setMonth(11)).moveToLastDayOfMonth() : 
				(Date.today().getMonth() >= 3 && Date.today().getMonth() < 6) ? new Date(Date.today().setMonth(2)).moveToLastDayOfMonth() :
				(Date.today().getMonth() >= 6 && Date.today().getMonth() < 9) ? new Date(Date.today().setMonth(5)).moveToLastDayOfMonth() : new Date(Date.today().setMonth(8)).moveToLastDayOfMonth()
		], 'This Year' : [
				new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth(), new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()
		], 'Last Year' : [
				new Date(Date.today().setMonth(0)).add({ years : -1 }).moveToFirstDayOfMonth(), new Date(Date.today().setMonth(11)).add({ years : -1 }).moveToLastDayOfMonth()
		] } }, function(start, end)
		{
			window.toDate=start;
			window.fromDate=end;
			$('#gmap_date_range span').html(start.toString('MMMM d, yyyy') + ' - ' + end.toString('MMMM d, yyyy'));
			gmap_search_by_date($('#gmap_date_range span').text());
		});
		
		if(callback && typeof(callback) == "function"){
			callback();
		}
		$('.daterangepicker > .ranges > ul').on("click", "li", function(e)
		{
			$('.daterangepicker > .ranges > ul > li').each(function(){
				$(this).removeClass("active");
			});
			$(this).addClass("active");
		});
}

function gmap_search_by_date(DateRange){
	isDateChanged=true;
	console.clear();
	
    var User_Domain = CURRENT_DOMAIN_USER.domain;
	//var User_Domain = "our";
	var options = "&";
	
	// Get Date Range
	var range = DateRange.split("-");

	// Returns milliseconds from start date. For e.g., August 6, 2013 converts
	// to 1375727400000
	var start_date = Date.parse($.trim(range[0])).valueOf();
	start_date=convertToUTCTime(start_date,'start');

	// Returns milliseconds from end date.
	var end_date = Date.parse($.trim(range[1])).valueOf();
	end_date=convertToUTCTime(end_date,'end');
	
	
	
	// Adds start_time, end_time and timezone offset to params.
	options += ("start_date=" + start_date + "&end_date=" + end_date);

	// Add Timezone offset
	var d = new Date();
	options += ("&time_zone=" + d.getTimezoneOffset());
	//var DateRangeUrl = "core/api/gmap/daterange?user_domain=" + encodeURIComponent(User_Domain) + options;
	var visitorBySessionUrl="core/api/gmap/daterangebysession?user_domain=" + encodeURIComponent(User_Domain) + options;
	var DateRangeUrl="core/api/gmap/daterangebysession?user_domain=" + encodeURIComponent(User_Domain) + options;
	
	//Check which tab is active and make a respective call
	if($('ul.nav-tabs li.active').attr('id') == 'gmap-map-tab'){
		map.setZoom(2);
		$("#map-tab-waiting").fadeIn();
		setTimeout(function(){
			gmap_add_marker(DateRangeUrl);
        },1000)
        
	}else{
		gmap_create_table_view(visitorBySessionUrl);
	}
	
	$("li#gmap-table-tab").off().on("click", function(){
		window.pauseMap=true;
		
		if((! $(this).closest('ul').parent('div').find('div.tab-content').find('div#gmap-table-view').find('tbody').length || isDateChanged) &&  ! $(this).hasClass('active')){
			isDateChanged=false;
			gmap_create_table_view(visitorBySessionUrl);
		}
	     
	  });
$("li#gmap-map-tab").off().on("click", function(){
	    window.pauseMap=false;
	    
		if(isDateChanged && ! $(this).hasClass('active')){
			isDateChanged=false;
			map.setZoom(2);
			setTimeout(function(){
				gmap_add_marker(DateRangeUrl);
	        },1000)
		}else{
			$("#map-tab-waiting").fadeIn();
			getMarkers();
		}
			
		
	  });
	
	

}

function convertToUTCTime(localTime,whatTime){
	try{
		
		var time = new Date(localTime);
		if(whatTime == 'start')
		time.setHours(0,0,0,0);
		else if(whatTime == 'end')
		time.setHours(23,59,59,999);
		var utc_start = new Date(time.getUTCFullYear(), time.getUTCMonth(), time.getUTCDate(),  time.getUTCHours(), time.getUTCMinutes(), time.getUTCSeconds(), time.getUTCMilliseconds());
		return utc_start.getTime();
	}catch(err){
		console.log("Error converting local  time to utc"+err);
	}
}


function gmap_initialize(el)
		{
			console.log("Map API has been loaded.");
			var script = document.createElement("script");
			script.type = "text/javascript";
			script.src = "https://jawj.github.io/OverlappingMarkerSpiderfier/bin/oms.min.js";
			document.body.appendChild(script);
			// Enable the visual refresh
			google.maps.visualRefresh = true;
			
			var mapProp = {
				center:new google.maps.LatLng(39.0000, 22.0000),
				zoom:7,
				mapTypeId:google.maps.MapTypeId.ROADMAP
			};
			
			window.map=new google.maps.Map(document.getElementById("google_map"),mapProp);
			window.map.setZoom(2);
			window.gmap_marker_list = [];
			
			gmap_date_range(el, function(){
				var $today = new Date();
				var $yesterday = new Date($today);
				$yesterday.setDate($today.getDate() - 1);
				var from_date = $yesterday;
				var to_date = $yesterday;
				if(window.toDate != undefined && window.toDate != '')
					to_date=window.toDate;
				else
					window.toDate=to_date;
				if(window.fromDate != undefined && window.fromDate != '')
					from_date=window.fromDate;
				else
				window.fromDate=from_date;
				
				$('#gmap_date_range span').html(to_date.toString('MMMM d, yyyy') + " - " + from_date.toString('MMMM d, yyyy'));
				gmap_search_by_date($('#gmap_date_range span').text());
			});
//			if(window.map != undefined){
//				document.getElementById("add_marker").disabled = false;
//			}
		}
		
// DOM listener to call initialize function after window load.
//google.maps.event.addDomListener(window, 'load', initialize);

// another way of calling initialize function and loading Google Maps API script.
function gmap_load_script(el)
{
	var script = document.createElement("script");
	script.type = "text/javascript";
	script.src = "https://maps.googleapis.com/maps/api/js?v=3&sensor=false&callback=gmap_initialize";
	document.body.appendChild(script);
}
	
		
/**Global variable holds the time interval to make rest call */
var INTERVAL=2000;
/** Global variable holds the latitudes and longitudes,used by the marker to plot a location */
var myLatlng = [];

/**Global variable to hold markers */
var marker = [];

/** It holds the unique sid's : just to have a unique visits as mysql query doesnot group sid's*/
var markerStore={};

var offSet=0; 
var limit=200;

/** Global variable to hold REST API call url*/
var url;
/**Global variable to hold clusterer object */
var markerCluster;
/**Single instance will be used for all the marker infowindow's
*/
var infowindow;


 /**spiderifier object */
var oms;
 
 
/** Function to retrieve visitors data with offset: called on every 5 seconds */
function getMarkers() {
	console.log(window.pauseMap);
	if(! window.pauseMap){
		
	$.getJSON( url+'&cursor='+offSet+'&page_size='+limit, function( res ) {
			
			if(res != ""){
				/** Call a function to plot the markers with recieved marker data*/
				plotMarkers(res);
				offSet=offSet+limit;
		        setTimeout(getMarkers,INTERVAL);
			}else
				$("#map-tab-waiting").fadeOut();
			
		});
		
	}else
		$("#map-tab-waiting").fadeOut();
	
		
	}

/** Function which takes response from server and create a marker,infowindow adds it to Clusterer and Spiderifier */
function plotMarkers(Locations){

	                  for (var i=0;i < Locations.length;i++)
	                  {   
	                	  
	                	  /**Check if we have duplicate markers : markers with same sid is pretend to be a duplicate marker here */
	                	  if(! markerStore.hasOwnProperty(Locations[i].sid)) {
	                	    var User_Location = (Locations[i].city_lat_long).split(",");
	                        myLatlng[i] = new google.maps.LatLng(User_Location[0],User_Location[1]);
	                        var parsedString = Locations[i].parsedUserAgent.replace(/\\/g, '');
	                        var machine;
	                        try
	                		{
	                        	machine=JSON.parse(parsedString);
	                		}
	                		catch (err)
	                		{
	                			console.log("Error in parsing json");
	                			continue;
	                		}
	                        var parsedOS=normalize_os(machine.os);
	                        var email=Locations[i].email;
	                        var markerImageUrl=gmap_set_icons(email,30);
	                        
	                        var icon = {
	                        	     url: markerImageUrl
	                        	 };
	                        
	                         if(email == undefined || email == "")
	                        	 email="Unknown Visitor";
	                         var strVar="";
	                         strVar += "<div style=\"width:230px;min-height: 61px;background-color: #fff;\">";
	                         strVar += "  <div style=\"float:left;\">";
	                         strVar += "    ";
	                         strVar += "  <img alt=\"null\" class=\"photo\" src='"+markerImageUrl+"' style=\"width: 61px;border-radius:8px\">";
	                         strVar += "  <\/div>";
	                         strVar += "  <div style=\"width: 230px;padding-left: 70px;\">";
	                         strVar += "    <div class=\"emailLink\" emailAttr="+email+" style=\"";
	                         strVar += "    margin: 7px 0px 0;";
	                         strVar += "    font-size: 14px;";
	                         strVar += "    white-space: nowrap;";
	                         strVar += "    text-overflow: ellipsis;";
	                         strVar += "    width: 100%;";
	                         strVar += "    overflow: hidden;";
	                         strVar += "    color: #363f44;";
	                         strVar += "\"><a>"+email+"</a><br>"+timeSince(Locations[i].visit_time)+"<br>"+capitalizeFirstLetter(Locations[i].city)+" , "+Locations[i].country+"<\/div>";
	                         strVar += "    <p style=\"";
	                         strVar += "    margin: 3px 0 0px;float:right"; 
	                         strVar += "\"><a href=\"#\" style=\"";
	                         strVar += "    text-decoration: none;";
	                         strVar += "    color: #23b7e5;";
	                         strVar += "\"><img class='inline m-r-xs r r-2x' style='width:12px;' src='../../../img/web-stats/devices/"+machine.device_type+".png'><img class='inline m-r-xs r r-2x' style='width:12px;' src='../../../img/web-stats/os/"+parsedOS+".png'><img class='inline m-r-xs r r-2x' style='width:12px;' src='../../../img/web-stats/browsers/"+machine.browser_name+".png'><\/a>";
	                         strVar += "    <\/p>";
	                         strVar += "  <\/div>";
	                         strVar += "  <\/div>";
	                         
	                         marker[i] = new google.maps.Marker({
	                              position: myLatlng[i],
	                              map: map,
	                              draggable:false,
	                              icon:icon,
	                              content:strVar
	                          });
	                         
	                         markerStore[Locations[i].sid] = marker[i];
	                         
	                         oms.addMarker(marker[i]);
	                          
	                          /**Marker click event*/ 
	                          google.maps.event.addListener(marker[i], 'click', function() {
	                        	    infowindow.setContent(this.content);
	                        	    infowindow.open(map,this);
	                        	});

	                  }
	                  }
	                  
	                  /**If the marker cluster is not  yet initialized then do it once with existing markers */
	                  if(markerCluster == undefined){
	                	  
	                	  
	                      /**Initializing marker clusterer*/ 
	  	      		    markerCluster = new MarkerClusterer(map,marker,{maxZoom:15});
	  	      		    
	  	      		    
	  	      		    /**Listener to show the spiderify markers on clicking the clusterer count directly*/ 
	  	      		    google.maps.event.addListener(markerCluster, 'click', function(cluster) {

	  	      		        var markers = cluster.getMarkers();

	  	      		        if(prepareMarkers(markers)){
	  	      		             //to wait for map update
	  	      		            setTimeout(function(){
	  	      		                google.maps.event.trigger(markers[markers.length-1], 'click');
	  	      		            },1000)
	  	      		        }
	  	      		        return true;
	  	      		    });
	  	      		    

	  	      		    function prepareMarkers(markers){
	  	      		    var cont=0;
	  	      		    var latitudMaster=markers[0].getPosition().lat();
	  	      		    var longitudMaster=markers[0].getPosition().lng();
	  	      		    for(var i=0;i<markers.length;i++){
	  	      		        if(markers[i].getPosition().lat() === latitudMaster & markers[i].getPosition().lng() === longitudMaster ){
	  	      		            cont++;
	  	      		        }else{
	  	      		            return false;
	  	      		        }
	  	      		    }
	  	      		    if(cont==markers.length){
	  	      		        return true;
	  	      		    }else if(cont<markers.length){
	  	      		        return false;
	  	      		    }
	  	      		}
	                	  
	                  }else{
	                	  markerCluster.addMarkers(marker,false);
	                	  
	                  }
	              
	                  
	                  /**Listener to close the infowindow if opened on clicking a map*/ 
	                  google.maps.event.addListener(map, 'click', function(){
	                	  if(infowindow){
	                		  infowindow.close();
	                	  }
	                  });
	
	
	
}

$(document).on('click','div.emailLink',function(){
	var emailToSend=$(this).attr('emailAttr');
	if(emailToSend != '' && emailToSend != undefined){
		var visitorBySessionUrl="core/api/contacts/search/email/"+emailToSend;
		$.getJSON(visitorBySessionUrl,function(res){
			if(res != '' && res != undefined){
				var contactId=res.id;
				window.location.href='#contact/'+contactId;
			}else{
				console.log("Response is empty");
				$('#noContactMessage').fadeIn();
				setTimeout(function(){
					$('#noContactMessage').fadeOut();
		            },5000)
			}
		});
	}
	
	
});

/**
 This method is being called from gmap-date-sort.js as soon as map object created
*/   
function gmap_add_marker(DateRangeUrl){
	
	
	google.maps.visualRefresh = true;
	
	var mapProp = {
		center:new google.maps.LatLng(39.0000, 22.0000),
		zoom:2,
		mapTypeId:google.maps.MapTypeId.ROADMAP
	};
	
	
	/**Creating a new instance everytime the date were modified ,this is required to reresh the markers and clusters*/
	window.map=new google.maps.Map(document.getElementById("google_map"),mapProp);
	map.setOptions({ minZoom: 2});
	
	/**Reset all the global variables */
	offSet=0;
	myLatlng = [];
	marker = [];
	markerStore={};
	markerCluster=undefined;
	infowindow=undefined;
	oms=undefined;
	
	
	
	/**Single instance will be used for all the marker infowindow's
	*/
	infowindow = new google.maps.InfoWindow({maxWidth: 230});
	
    /** Spiderify intialization*/
	oms= new OverlappingMarkerSpiderfier(map, {keepSpiderfied:true,nearbyDistance:40,legWeight:0});
	url=DateRangeUrl;
	
	
	/**Initiate the Rest call to get the data from server */
	getMarkers(url);
	
	
}


$(document).on('click','.agile-row > tr > td', function(e) {
	if($(this).hasClass('referer')){
		var refererUrl=$(this).find('a').attr('href');
		window.open(refererUrl);
		
	}else{
		var route = $('.agile-edit-row').attr('route');
		// Newly added code for displaying contacts and companies in same table with different routes.
		if($(this).closest('tr').find('[route]').length != 0)
		route = $(this).closest('tr').find('[route]').attr('route');
		var data = $(this).closest('tr').find('.data-contact').attr('data');
		if(route == "contact/" || route == "company/")
		SCROLL_POSITION = window.pageYOffset;
		console.log(data);
		if (data) {
		Backbone.history.navigate(route + data, {
		trigger : true
		});
		}
	}

	}); 

/**It just formats the first letter of a string with capital letter ,Only used here for city.*/ 
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}

/**Function which returns either a default image or an SVG image based on the email*/
function gmap_set_icons(email,width){
	
	if (email == undefined || email == "")
		return LIB_PATH_FLATFULL + 'images/anonymous_visitor.png';
	return prepareLettergravatar(email);
	
}

/**Formats the device,OS and Browser to a required format*/ 
function normalize_os(data){
	
	if (data === undefined || data.indexOf('_') === -1)
		return data;

	// if '_' exists splits
	return data.split('_')[0];
}


/**This is a slight modification to the existing "initial" plugin used in the application ,could not reuse that but had to use as an another function*/
function prepareLettergravatar(email){

	var colors = ["#1abc9c", "#16a085", "#f1c40f", "#f39c12", "#2ecc71", "#27ae60", "#e67e22", "#d35400", "#3498db", "#2980b9", "#e74c3c", "#c0392b", "#9b59b6", "#8e44ad", "#bdc3c7", "#34495e", "#2c3e50", "#95a5a6", "#7f8c8d", "#ec87bf", "#d870ad", "#f69785", "#9ba37e", "#b49255", "#b49255", "#a94136"];
	try{
		 var settings = {
			        // Default settings
			        "name":email,
			        "charCount": 1,
			        "textColor": "#ffffff",
			        "height": 32,
			        "width": 32,
			        "fontSize": 18,
			        "fontWeight": 170,
			        "fontFamily": "HelveticaNeue-Light,Helvetica Neue Light,Helvetica Neue,Helvetica, Arial,Lucida Grande, sans-serif"
			    };

			    settings.name = "" + settings.name;
			    var c = settings.name.substr(0, settings.charCount).toUpperCase();
			    var cobj = $('<text text-anchor="middle"></text>').attr({
			        'y': '50%',
			        'x': '50%',
			        'dy' : '0.35em',
			        'pointer-events':'auto',
			        'fill': settings.textColor,
			        'font-family': settings.fontFamily
			    }).html(c).css({
			        'font-weight': settings.fontWeight,
			        'font-size': settings.fontSize+'px',
			    });

			    var colorIndex = null;
			    if(c.length > 1)
			    	colorIndex = Math.abs(Math.floor((((c.charCodeAt(0) - 65) + (c.charCodeAt(1) - 65))/2)  % colors.length));
			    else
			    	colorIndex = Math.abs(Math.floor((c.charCodeAt(0) - 65) % colors.length));

			    var svg = $('<svg></svg>').attr({
			        'xmlns': 'http://www.w3.org/2000/svg',
			        'pointer-events':'none',
			        'width': settings.width,
			        'height': settings.height
			    }).css({
			        'background-color': colors[colorIndex],
			        'width': settings.width+'px',
			        'height': settings.height+'px'
			    });

			    svg.append(cobj);
			   // svg.append(group);
			    var svgHtml = window.btoa(unescape(encodeURIComponent($('<div>').append(svg.clone()).html())));
			    return 'data:image/svg+xml;base64,' + svgHtml;
		
	}catch(e){
		
		console.log("Error in letter gravatar function"+e);
	}
}

/**Formats the given  date to "time Ago"*/
function timeSince(dateStr) {
	var date=new Date();
	 try
		{
		 var find = '-';
		 var re = new RegExp(find, 'g');
		 dateStr = dateStr.replace(re, '/');
		 dateStr = dateStr.match(/[^:]+(\:[^:]+)?/g);
		 date = new Date(dateStr[0]+' UTC');
		}
		catch (err)
		{
			console.log("Error in parsing date");
		}

    var seconds = Math.floor((new Date() - date) / 1000);

    var interval = Math.floor(seconds / 31536000);

    if (interval > 1) {
        return interval + " years ago";
    }
    interval = Math.floor(seconds / 2592000);
    if (interval > 1) {
        return interval + " months ago";
    }
    interval = Math.floor(seconds / 86400);
    if (interval > 1) {
        return interval + " days ago";
    }
    interval = Math.floor(seconds / 3600);
    if (interval > 1) {
        return interval + " hours ago";
    }
    interval = Math.floor(seconds / 60);
    if (interval > 1) {
        return interval + " minutes ago";
    }
    return Math.floor(seconds) + " seconds ago";
}


		


function gmap_create_table_view(Search_Url){
	
	 var gmapContactsListView = new Base_Collection_View({ 
		url : Search_Url,	// ""
		templateKey : "gmap-table", 
		individual_tag_name : "tr",
		cursor : true, page_size : 25,
		sort_collection:false,
		postRenderCallback : function(el)
		{
			console.log("post callback");
		} });
	 gmapContactsListView.collection.fetch();
	$('#gmap-table-view').html(gmapContactsListView.el);
}
var TEMPLATE_LIB_PATH = "";

/**
 * Downloads the template synchronously (stops other browsing actions) from the
 * given url and returns it
 * 
 * @param {String}
 *            url location to download the template
 * @returns down-loaded template content
 */
function downloadTemplate(url, callback)
{

	var dataType = 'html', template_url = CLOUDFRONT_PATH;


	// If Precompiled is enabled, we change the directory to precompiled. If
	// pre-compiled flat is set true then template path is sent accordingly
	if (HANDLEBARS_PRECOMPILATION)
	{
		url = "tpl/min/precompiled/" + FLAT_FULL_UI +  url;
	}
	else
		url = "tpl/min/" + FLAT_FULL_UI +  url;

	// If JS
	if (url.endsWith("js") && HANDLEBARS_PRECOMPILATION)
	{
		dataType = 'script';
		template_url = template_url.replace("flatfull/", "");
		url = template_url + url;
	}

	url += "?_=" + _AGILE_VERSION;
	
	// If callback is sent to this method then template is fetched synchronously
	var is_async = false;
	if (callback && typeof (callback) === "function")
		is_async = true;

	console.log(url + " " + dataType + " " + is_async);

	var is_cached = !LOCAL_SERVER;

	jQuery.ajax({ url : url, dataType : dataType, cache:is_cached, success : function(result)
	{
		// If HTMl, add to body
		if (dataType == 'html')
			$('body').append((result));

		if (is_async)
			callback(result);
	}, async : is_async });

	return "";
}
// We store one template compiled - if repetitive templates are called, we save time on compilations
var Handlebars_Compiled_Templates = {};

/**
 * Loads the template (script element with its id attribute as templateName
 * appended with "-template". For example if the templateName is "tasks", then
 * the script element id should be as "tasks-template") from html document body.
 * 
 * Compiles the loaded template using handlebars and replaces the context
 * related property names (which are under mustache like {{name}}) in the
 * template, with their associated values, on calling the context with the
 * compiled template.
 * 
 * @method getTemplate
 * @param {String}
 *            templateName name of the tempate to be loaded
 * @param {Object}
 *            context json object to call with the compiled template
 * @param {String}
 *            download verifies whether the template is found or not
 * 
 * @param {callback}
 *            To decide whether templates should be downloaded synchronously or
 *            asynchronously.
 * 
 * @returns compiled html with the context
 */
function getTemplate(templateName, context, download, callback, loading_place_holder)
{
	var is_async = callback && typeof (callback) == "function";

	// Check if it is (compiled template) present in templates
	if (Handlebars_Compiled_Templates[templateName])
	{
		if (callback)
			return callback(Handlebars_Compiled_Templates[templateName](context));
		else
			return Handlebars_Compiled_Templates[templateName](context);
	}
	else
		Handlebars_Compiled_Templates = {};

	// Check if source is available in body
	if (HANDLEBARS_PRECOMPILATION)
	{
		var template = Handlebars.templates[templateName + "-template"];

		// If teplate is found
		if (template)
		{
			// If callback is sent then template is downloaded asynchronously
			// and content is sent in callback
			if (is_async)
			{
				callback(template(context));
				return;
			}

			// console.log("Template " + templateName + " found");
			return template(context);
		}
	}
	else
	{
		var source = $('#' + templateName + "-template").html();
		if (source)
		{
			var template = Handlebars.compile(source);
			Handlebars_Compiled_Templates[templateName] = template;

			// If callback is sent then template is downloaded asynchronously
			// and content is sent
			if (is_async)
			{
				callback(template(context));
				return;
			}
			return template(context);
		}
	}

	// Check if the download is explicitly set to no
	if (download == 'no')
	{
		console.log("Not found " + templateName);
		return;
	}

	// Shows loader icon if there is a loader placeholder
	if(loading_place_holder)
	{
		try{
			var loaderEl = $(getRandomLoadingImg());
			$(loading_place_holder).html(loaderEl.css("margin", "10px"));
		}catch(err){}
	}
		   

	// Stores urls of templates to be downloaded.
	var template_relative_urls = getTemplateUrls(templateName);

	if (is_async)
	{
		load_templates_async(templateName, context, template_relative_urls, callback);
		return;
	}

	load_templates_sync(template_relative_urls);

	return getTemplate(templateName, context, 'no');
}

/**
 * If the template is not found in document body, then template paths are built
 * based on template name and download requests are sent. if it is down-loaded
 * append it to the document body. And call the function (getTemplate) again by
 * setting the download parameter to "no"
 */
function getTemplateUrls(templateName)
{
	// Stores template URLS
	var template_relative_urls = [];

	if (templateName.indexOf("settings") == 0)
	{
		template_relative_urls.push("settings.js");
	}
	if (templateName.indexOf("admin-settings") == 0)
	{
		template_relative_urls.push("admin-settings.js");
	}
	if (templateName.indexOf("continue") == 0)
	{
		template_relative_urls.push("continue.js");
	}
	if (templateName.indexOf("all-domain") == 0)
	{
		template_relative_urls.push("admin.js");
	}
	if (templateName.indexOf("contact-detail") == 0 || templateName.indexOf("timeline") == 0 || templateName.indexOf("company-detail") == 0)
	{
		template_relative_urls.push("contact-detail.js");
		if (HANDLEBARS_PRECOMPILATION)
			template_relative_urls.push("contact-detail.html");
	}
	if (templateName.indexOf("contact-filter") == 0 || templateName.indexOf("filter-contacts") == 0)
	{
		template_relative_urls.push("contact-filter.js");
	}
	if (templateName.indexOf("contact-view") == 0 || templateName.indexOf("contact-custom") == 0 || templateName.indexOf("contacts-custom") == 0 || templateName
			.indexOf("contacts-grid") == 0 || templateName.indexOf("company-view") == 0 || templateName.indexOf("companies-custom") == 0)
	{
		template_relative_urls.push("contact-view.js");
	}
	if (templateName.indexOf("bulk-actions") == 0)
	{
		template_relative_urls.push("bulk-actions.js");
	}
	if (templateName.indexOf("case") == 0)
	{
		template_relative_urls.push("case.js");
	}
	if (templateName.indexOf("document") == 0)
	{
		template_relative_urls.push("document.js");
	}	
	if (templateName.indexOf("voice-mail") == 0)
	{
		template_relative_urls.push("voice-mail.js");
	}
	if (templateName.indexOf("gmap") == 0)
	{
		template_relative_urls.push("gmap.js");
	}
	if (templateName.indexOf("report") == 0)
	{
		template_relative_urls.push("report.js");
	}
	if (templateName.indexOf("webrule") == 0)
	{
		template_relative_urls.push("web-rules.js");
	}
	if (templateName.indexOf("workflow") == 0 || templateName.indexOf("campaign") == 0 || templateName.indexOf("trigger") == 0 || templateName
			.indexOf("automation") == 0)
	{
		template_relative_urls.push("workflow.js");
	}
	if (templateName.indexOf("purchase") == 0 || templateName.indexOf("subscription") == 0 || templateName.indexOf("subscribe") == 0 || templateName
			.indexOf("invoice") == 0)
	{
		template_relative_urls.push("billing.js");
	}

	if (templateName.indexOf("widget") == 0)
	{
		template_relative_urls.push("widget.js");
	}
	if (templateName.indexOf("helpscout") == 0)
	{
		template_relative_urls.push("helpscout.js");
	}
	else if (templateName.indexOf("clickdesk") == 0)
	{
		template_relative_urls.push("clickdesk.js");
	}
	else if (templateName.indexOf("zendesk") == 0)
	{
		template_relative_urls.push("zendesk.js");
	}
	else if (templateName.indexOf("freshbooks") == 0)
	{
		template_relative_urls.push("freshbooks.js");
	}
	else if (templateName.indexOf("linkedin") == 0)
	{
		template_relative_urls.push("linkedin.js");
	}
	else if (templateName.indexOf("rapleaf") == 0)
	{
		template_relative_urls.push("rapleaf.js");
	}
	else if (templateName.indexOf("stripe") == 0)
	{
		template_relative_urls.push("stripe.js");
	}
	else if (templateName.indexOf("twilioio") == 0)
	{
	template_relative_urls.push("twilioio.js");
	}
	else if (templateName.indexOf("twilio") == 0)
	{
		template_relative_urls.push("twilio.js");
	}	
	else if (templateName.indexOf("sip") == 0)
	{
	template_relative_urls.push("sip.js");
	}
	else if (templateName.indexOf("twitter") == 0)
	{
		template_relative_urls.push("twitter.js");
	}
	else if (templateName.indexOf("googleplus") == 0)
	{
		template_relative_urls.push("googleplus.js");
	}	
	else if (templateName.indexOf("xero") == 0)
	{
		template_relative_urls.push("xero.js");
	}
	else if (templateName.indexOf("quickbooks") == 0)
	{
		template_relative_urls.push("quickbooks.js");
	}
	else if (templateName.indexOf("facebook") == 0)
	{
		template_relative_urls.push("facebook.js");
	}
	else if (templateName.indexOf("callscript") == 0)
	{
	template_relative_urls.push("callscript.js");
	}
	if (templateName.indexOf("chargify") == 0)
	{
		template_relative_urls.push("chargify.js");
	}
	if (templateName.indexOf("shopify") == 0)
	{
		template_relative_urls.push("shopify.js");
	}
	if (templateName.indexOf("socialsuite") == 0)
	{
		if(HANDLEBARS_PRECOMPILATION)
			template_relative_urls.push("socialsuite-all.js");
		else
		{
			template_relative_urls.push("socialsuite.js");
		}

		if (HANDLEBARS_PRECOMPILATION)
			template_relative_urls.push("socialsuite.html");
	}


	if (templateName.indexOf("portlet") == 0)
	{
		template_relative_urls.push("portlets.js");
	}
	if (templateName.indexOf("deal-detail") == 0)
	{
		template_relative_urls.push("deal-detail.js");
	}
	if (templateName.indexOf("fbpagetab") == 0)
	{
		template_relative_urls.push("facebookpage.js");
	}
	if (templateName.indexOf("webpages") == 0)
	{
		template_relative_urls.push("webpages.js");
	}
	if (templateName.indexOf("billing-settings") == 0 || templateName.indexOf("creditcard-update") == 0)
	{
		template_relative_urls.push("settings.js");
	}
	if (templateName.indexOf("bria") == 0)
	{
		template_relative_urls.push("bria.js");
	}
	return template_relative_urls;
}

/**
 * Takes list of templates to downloaded and pops URL from list and sends
 * request to download asynchronously. After last URL in list is removed and
 * download request is sent, on callback of downloaded URL, new request is sent
 * to fetch next template URL in the list. Continues sending requests till list
 * is empty.
 * 
 * @param templateName
 * @param context
 * @param template_relative_urls
 * @param callback
 */
function load_templates_async(templateName, context, template_relative_urls, callback)
{
	// Removes last url from the list to fetch template.
	var url = template_relative_urls.pop();

	// URL is undefined when list is empty which means all templates specified
	// in array are downloaded. As list is empty get template is called with
	// download parameter 'no' which fills and sends template in callback
	if (!url)
	{
		getTemplate(templateName, context, 'no', callback);
		return;
	}

	// Fetches template and call current method in recursion to download other
	// templates in list
	downloadTemplate(url, function()
	{
		{
			// Recursion call to download other templates
			load_templates_async(templateName, context, template_relative_urls, callback);
		}
	});
}

/**
 * Sends request to download template synchronously
 * 
 * @param template_relative_urls
 */
function load_templates_sync(template_relative_urls)
{
	for ( var index in template_relative_urls)
		downloadTemplate(template_relative_urls[index]);
}

String.prototype.endsWith = function(suffix)
{
	return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

/**
 * Iterates the given "items", to find a match with the given "name", if found
 * returns the value of its value attribute
 * 
 * @param {Object}
 *            items array of json objects
 * @param {String}
 *            name to get the value (of value atribute)
 * @returns value of the matched object
 */
function getPropertyValue(items, name)
{
	if (items == undefined)
		return;

	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name == name)
			return items[i].value;
	}
}


/**
 * appends , between contact fields
 * @param items
 * @param name
 * @returns {String}
 */

function getPropertyValueByCheckingExistance(items, companyname,jobtitle)
{
	if (items == undefined)
		return;

	var companyExists=false;
	var jobTitleExists=false;
	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name == companyname){
			if(items[i].value){
				companyExists=true;
			}
			
		}
		else if (items[i].name == jobtitle){
			if(items[i].value){
				jobTitleExists=true;
			}
			
		}
	}
	if(companyExists&&jobTitleExists)
		return ',';
}



function getMarginLength(items, companyname)
{
	if (items == undefined)
		return;

	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name == companyname)
			return '3px';
	}
	return '0px';
}


/**
 * checks the contact properties existance
 * @param items
 * @param name
 * @param name1
 * @returns {String}
 */
function checkPropertyValueExistance(items,name,name1){

	if (items == undefined)
		return "none";

	var valueExists=false;
	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name == name || items[i].name == name1){
			if(items[i].value){
				valueExists=true;
			}
			
		}
	}
	if(valueExists==true)
		return 'block';
	else
		return 'none';
}

/**
 * Iterates the given "items", to find all matches with the given "name" and
 * concats each matched value by given separator
 * 
 * @param {Object}
 *            items array of json objects
 * @param {String}
 *            name to get the value (of value atribute)
 * @param {String}
 *            separator to combine matched values like ,(comma) etc
 * 
 * @returns matched values combined by separator or undefined
 */
function getAllPropertyValuesByName(items, name, separator)
{
	if (items == undefined)
		return;

	var val = "";

	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name == name)
		{
			var va = items[i].value;
			val += va + separator;
		}
	}

	// Removes trailing separators
	var regex = new RegExp("(^" + separator + ")|(" + separator + "$)", "g");
	val = val.replace(regex, "");

	console.log(val);
	return val;
}

/**
 * Returns contact property based on the name of the property
 * 
 * @param items :
 *            porperties in contact object
 * @param name :
 *            name of the property
 * @returns
 */
function getProperty(items, name)
{
	if (items == undefined)
		return;

	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name == name)
			return items[i];
	}
}

/**
 * Returns contact property based on its property name and subtype
 */
function getPropertyValueBySubtype(items, name, subtype)
{
	if (items == undefined)
		return;

	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name == name && items[i].subtype == subtype)
			return items[i].value;
	}
}

/**
 * Returns contact property based on the sub type (LINKEDIN, TWITTER, URL, SKYPE
 * etc..) of the property
 * 
 * @param items :
 *            properties list
 * @param name :
 *            name of the property
 * @param type :
 *            type of the property
 * @param subtype :
 *            subtype of property
 * @returns
 */
function getPropertyValueBytype(items, name, type, subtype)
{
	if (items == undefined)
		return;

	// Iterates though each property object and compares each property by name
	// and its type
	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name == name)
		{
			if (type && type == items[i].type)
			{
				if (subtype && subtype == items[i].subtype)
					return items[i].value;
			}

			if (subtype && subtype == items[i].subtype)
			{
				return items[i].value;
			}
		}
	}
}

function getPropertyValueInCheckbox(items, name, id, checked)
{
	if (items == undefined)
		return;
	var el = "";
	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name === name)
		{		
			if(name === "website"){
			  if(checked === 'checked'){			  
				  el = el.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+name+ '" subtype="'+get_subtype_value(items[i])+ '" data="'+items[i].value+ '" oid="'+id+ '" checked="'+checked+ '"><i></i></label>' + items[i].value);
			  }
			  else{
				  el = el.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+name+ '" subtype="'+get_subtype_value(items[i])+ '" data="'+items[i].value+ '" oid="'+id+ '"><i></i></label>' + items[i].value);
			  }
			  el = el.concat(get_website_icon(items[i]));
			}
			else if(name === "phone"){
				 if(checked === 'checked'){			  
					  el = el.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+name+ '" subtype="'+get_subtype_value(items[i])+ '" data="'+items[i].value+ '" oid="'+id+ '" checked="'+checked+ '"><i></i></label>' + items[i].value );
				 }
				 else{
					  el = el.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+name+ '" subtype="'+get_subtype_value(items[i])+ '" data="'+items[i].value+ '" oid="'+id+ '"><i></i></label>' + items[i].value );
				 }
			 el = el.concat(get_subtype(items[i]));
			}
			else if(name === "email"){
				if(checked === 'checked')
					el = el.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+name+ '" subtype="'+get_subtype_value(items[i])+ '" data="'+items[i].value+ '" oid="'+ id + '" checked="'+checked+ '"><i></i></label>' + items[i].value);
				else{
					el = el.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+name+ '" subtype="'+get_subtype_value(items[i])+ '" data="'+items[i].value+ '" oid="'+ id + '"><i></i></label>' + items[i].value);
				}
				el = el.concat(get_subtype(items[i]));
			}
		}
	}
	return el;
}

function get_website_icon(item){
	var icon = get_social_icon(item.subtype);
	var str = "<i class=\"".concat(icon).concat("\"").concat(" style=\"font-size: 1.3em !important; margin-left:10px \"></i> <br>");
	return str;
}

function get_social_icon(name){
	if (!name)
	return "fa fa-globe";

    var icon_json = { "TWITTER" : "fa fa-twitter", "LINKEDIN" : "fa fa-linkedin-square", "URL" : "fa fa-globe", "GOOGLE-PLUS" : "fa fa-google-plus-square",
	"FACEBOOK" : "fa fa-facebook-square", "GITHUB" : "fa fa-github", "FEED" : "icon-rss", "XING" : "fa fa-xing-square", "SKYPE" : "icon-skype",
	"YOUTUBE" : "fa fa-youtube-square", "FLICKR" : "fa fa-flickr" };

    name = name.trim();

    if (icon_json[name])
	return icon_json[name];

    return "fa fa-globe";
}

function get_subtype(item){
	
	if(item.subtype!=undefined && item.subtype!=""){
		var str = "<span style=\"margin:3px 0px 3px 10px\">".concat(item.subtype).concat("</span> <br>");
		return str;
	}
	else
		return "<br>";
}

function get_subtype_value(item){
	
	if(item.subtype!=undefined && item.subtype!=""){
		var str = item.subtype;
		return str;
	}
	else
	   return "";
}


/**
 * Returns list of custom properties. used to fill custom data in fields in
 * continue contact
 * 
 * @param items
 * @returns
 */
function getContactCustomProperties(items)
{
	if (items == undefined)
		return items;

	var fields = [];
	var fieldName='';
	var datajson={};
	for (var i = 0; i < items.length; i++)
	{
		if (items[i].type == "CUSTOM" && items[i].name != "image")
		{
			if(fieldName=='')
				fieldName=items[i].name;
			fields.push(items[i]);
			datajson[''+items[i].name]=items[i].value;
		}
	}
	
	//Added for formula type custom field
	var type='';
	if(App_Contacts.customFieldsList!=undefined && App_Contacts.customFieldsList!=null){
		for(var i=0;i<App_Contacts.customFieldsList.collection.models.length;i++){
			if(App_Contacts.customFieldsList.collection.models[i].get("field_label")==fieldName){
				type = App_Contacts.customFieldsList.collection.models[i].get("scope");
				break;
			}
		}
	}
	
	var formulaFields=[];
	var allCustomFields=[];
	var finalFields=[];
	
	if(App_Contacts.customFieldsList!=undefined && App_Contacts.customFieldsList!=null){
		if(type=='')
			type='CONTACT';
		for(var i=0;i<App_Contacts.customFieldsList.collection.models.length;i++){
			var json={};
			if(App_Contacts.customFieldsList.collection.models[i].get("scope")==type && App_Contacts.customFieldsList.collection.models[i].get("field_type")=="FORMULA"){
				var tplEleData = Mustache.render(App_Contacts.customFieldsList.collection.models[i].get("field_data"),datajson);
				var evalFlag = true;
				var tplEleDataAftEval;
				try{
					tplEleDataAftEval = eval(tplEleData)
				}catch(err){
					console.log(err.message);
					evalFlag = false;
				}
				if(!evalFlag)
					tplEleDataAftEval = tplEleData;
				if(evalFlag && tplEleDataAftEval!=undefined && tplEleDataAftEval!=null){
					json.name=App_Contacts.customFieldsList.collection.models[i].get("field_label");
					json.type="CUSTOM";
					json.position=App_Contacts.customFieldsList.collection.models[i].get("position");
					json.value=tplEleDataAftEval;
					json.field_type=App_Contacts.customFieldsList.collection.models[i].get("field_type");
					allCustomFields.push(json);
					
					formulaFields.push(json);
				}
			}else if(App_Contacts.customFieldsList.collection.models[i].get("scope")==type){
				json.name=App_Contacts.customFieldsList.collection.models[i].get("field_label");
				json.type="CUSTOM";
				json.position=App_Contacts.customFieldsList.collection.models[i].get("position");
				json.field_type=App_Contacts.customFieldsList.collection.models[i].get("field_type");
				allCustomFields.push(json);
			}
		}
	}
	if(fields.length>0){
		if(allCustomFields.length>0){
			for(var i=0;i<allCustomFields.length;i++){
				var isFieldExist = false;
				if(allCustomFields[i].field_type=="FORMULA"){
					if($.inArray(allCustomFields[i], finalFields)==-1)
						finalFields.push(allCustomFields[i]);
				}else{
					for(var j=0;j<fields.length;j++){
						if(allCustomFields[i].name==fields[j].name){
							if($.inArray(fields[j], finalFields)==-1)
								finalFields.push(fields[j]);
							isFieldExist = true;
							break;
						}
						if(!isFieldExist){
							if($.inArray(fields[j], finalFields)==-1)
								finalFields.push(fields[j]);
						}
					}
				}
			}
		}else{
			for(var k=0;k<fields.length;k++){
				if($.inArray(fields[k], finalFields)==-1)
					finalFields.push(fields[k]);	
			}
		}
		
	}else{
		for(var k=0;k<formulaFields.length;k++){
			if($.inArray(formulaFields[k], finalFields)==-1)
				finalFields.push(formulaFields[k]);	
		}
	}
	
	return finalFields;
}


/**
 * Returns list of custom properties. used to fill custom data in fields in
 * continue contact
 * 
 * @param items
 * @returns
 */
function getCompanyCustomProperties(items)
{
	if (items == undefined)
		return items;

	var fields = [];
	var fieldName='';
	var datajson={};
	for (var i = 0; i < items.length; i++)
	{
		if (items[i].type == "CUSTOM" && items[i].name != "image")
		{
			if(fieldName=='')
				fieldName=items[i].name;
			fields.push(items[i]);
			datajson[''+items[i].name]=items[i].value;
		}
	}
	
	//Added for formula type custom field
	var type='';
	if(App_Companies.customFieldsList!=undefined && App_Companies.customFieldsList!=null){
		for(var i=0;i<App_Companies.customFieldsList.collection.models.length;i++){
			if(App_Companies.customFieldsList.collection.models[i].get("field_label")==fieldName){
				type = App_Companies.customFieldsList.collection.models[i].get("scope");
				break;
			}
		}
	}
	
	var formulaFields=[];
	var allCustomFields=[];
	var finalFields=[];
	
	if(App_Companies.customFieldsList!=undefined && App_Companies.customFieldsList!=null){
		if(type=='')
			type='CONTACT';
		for(var i=0;i<App_Companies.customFieldsList.collection.models.length;i++){
			var json={};
			if(App_Companies.customFieldsList.collection.models[i].get("scope")==type && App_Companies.customFieldsList.collection.models[i].get("field_type")=="FORMULA"){
				var tplEleData = Mustache.render(App_Companies.customFieldsList.collection.models[i].get("field_data"),datajson);
				var evalFlag = true;
				var tplEleDataAftEval;
				try{
					tplEleDataAftEval = eval(tplEleData)
				}catch(err){
					console.log(err.message);
					evalFlag = false;
				}
				if(!evalFlag)
					tplEleDataAftEval = tplEleData;
				if(evalFlag && tplEleDataAftEval!=undefined && tplEleDataAftEval!=null){
					json.name=App_Companies.customFieldsList.collection.models[i].get("field_label");
					json.type="CUSTOM";
					json.position=App_Companies.customFieldsList.collection.models[i].get("position");
					json.value=tplEleDataAftEval;
					json.field_type=App_Companies.customFieldsList.collection.models[i].get("field_type");
					allCustomFields.push(json);
					
					formulaFields.push(json);
				}
			}else if(App_Companies.customFieldsList.collection.models[i].get("scope")==type){
				json.name=App_Companies.customFieldsList.collection.models[i].get("field_label");
				json.type="CUSTOM";
				json.position=App_Companies.customFieldsList.collection.models[i].get("position");
				json.field_type=App_Companies.customFieldsList.collection.models[i].get("field_type");
				allCustomFields.push(json);
			}
		}
	}
	if(fields.length>0){
		if(allCustomFields.length>0){
			for(var i=0;i<allCustomFields.length;i++){
				if(allCustomFields[i].field_type=="FORMULA"){
					finalFields.push(allCustomFields[i]);
				}else{
					for(var j=0;j<fields.length;j++){
						if(allCustomFields[i].name==fields[j].name){
							finalFields.push(fields[j]);
							break;
						}
					}
				}
			}
		}else{
			for(var k=0;k<fields.length;k++){
				finalFields.push(fields[k]);	
			}
		}
		
	}else{
		for(var k=0;k<formulaFields.length;k++){
			finalFields.push(formulaFields[k]);	
		}
	}
	
	return finalFields;
}

/**
 * Turns the first letter of the given string to upper-case and the remaining to
 * lower-case (EMaiL to Email).
 * 
 * @param {String}
 *            value to convert as ucfirst
 * @returns converted string
 */
function ucfirst(value)
{
	return (value && typeof value === 'string') ? (value.charAt(0).toUpperCase() + value.slice(1).toLowerCase()) : '';

}

/**
 * Creates titles from strings. Replaces underscore with spaces and capitalize
 * first word of string.
 * 
 * @param value
 * @returns
 */
function titleFromEnums(value)
{
	if (!value)
		return;

	var str = value.replace(/_/g, ' ');

	return ucfirst(str.toLowerCase());
}

/**
 * Counts total number of attributes in a json object
 * 
 * @param obj
 * @returns {Number}
 */
function countJsonProperties(obj)
{
	var prop;
	var propCount = 0;

	for (prop in obj)
	{
		propCount++;
	}
	return propCount;
}

/**
 * Get the current contact property
 * 
 * @param value
 * @returns {String}
 */
function getCurrentContactProperty(value)
{
	if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model)
	{
		var contact_properties = App_Contacts.contactDetailView.model.get('properties')
		return getPropertyValue(contact_properties, value);
	}
}

function getCount(collection)
{
	if (collection[0] && collection[0].count && (collection[0].count != -1))
		return "(" + collection[0].count + " Total)";
	else
		return "(" + collection.length + " Total)";
}

/**
 * Returns id from hash. Id must be last in hash.
 */
function getIdFromHash()
{

	// Returns "workflows" from "#workflows"
	var hash = window.location.hash.substr(1);

	// remove trailing slash '/'
	if (hash.substr(-1) === "/")
	{
		hash = hash.replace(/\/$/, "");
	}

	// Returns campaign_id from "workflow/all-contacts/campaign_id".
	var id = hash.split('/').pop();

	return id;
}

function updateCustomData(el)
{
	$(".custom-data", App_Contacts.contactDetailView.el).html(el)
}

function updateCompanyCustomData(el)
{
	$(".custom-data", App_Companies.companyDetailView.el).html(el)
}

/**
 * Returns list of custom properties. used to fill custom data in fields in
 * deal details
 * 
 * @param items
 * @returns
 */
function getDealCustomProperties(items)
{
	if (items == undefined)
		return items;

	var fields = [];
	var datajson={};
	for (var i = 0; i < items.length; i++)
	{
		fields.push(items[i]);
		datajson[''+items[i].name]=items[i].value;
	}
	
	var formulaFields=[];
	var allCustomFields=[];
	var finalFields=[];
	
	if(App_Deals.customFieldsList!=undefined && App_Deals.customFieldsList!=null)
	{
		for(var i=0;i<App_Deals.customFieldsList.collection.models.length;i++)
		{
			var json={};
			if(App_Deals.customFieldsList.collection.models[i].get("field_type")=="FORMULA"){
				var tplEleData = Mustache.render(App_Deals.customFieldsList.collection.models[i].get("field_data"),datajson);
				var evalFlag = true;
				var tplEleDataAftEval;
				try
				{
					tplEleDataAftEval = eval(tplEleData)
				}catch(err)
				{
					console.log(err.message);
					evalFlag = false;
				}
				if(!evalFlag)
					tplEleDataAftEval = tplEleData;
				if(evalFlag && tplEleDataAftEval!=undefined && tplEleDataAftEval!=null)
				{
					json.name=App_Deals.customFieldsList.collection.models[i].get("field_label");
					json.position=App_Deals.customFieldsList.collection.models[i].get("position");
					json.value=tplEleDataAftEval;
					json.field_type=App_Deals.customFieldsList.collection.models[i].get("field_type");
					allCustomFields.push(json);
					
					formulaFields.push(json);
				}
			}
			else
			{
				json.name=App_Deals.customFieldsList.collection.models[i].get("field_label");
				json.position=App_Deals.customFieldsList.collection.models[i].get("position");
				json.field_type=App_Deals.customFieldsList.collection.models[i].get("field_type");
				allCustomFields.push(json);
			}
		}
	}
	
	if(fields.length>0)
	{
		if(allCustomFields.length>0)
		{
			for(var i=0;i<allCustomFields.length;i++)
			{
				if(allCustomFields[i].field_type=="FORMULA")
				{
					finalFields.push(allCustomFields[i]);
				}
				else if(allCustomFields[i].field_type=="DATE")
				{
					for(var j=0;j<fields.length;j++)
					{
						if(allCustomFields[i].name==fields[j].name)
						{
							if(!fields[j].value)
								return '';
							if(fields[j].index && (CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy") != -1 || CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy") != -1))
								fields[j].value = convertDateFromUKtoUS(fields[j].value);
							var dateString = new Date(fields[j].value);
							if(dateString == "Invalid Date")
								fields[j].value = getDateInFormatFromEpoc(fields[j].value);
							else
								fields[j].value = en.dateFormatter({raw: getGlobalizeFormat()})(dateString);

							finalFields.push(fields[j]);
							break;
						}
					}
				}
				else
				{
					for(var j=0;j<fields.length;j++)
					{
						if(allCustomFields[i].name==fields[j].name)
						{
							finalFields.push(fields[j]);
							break;
						}
					}
				}
			}
		}
		else
		{
			for(var k=0;k<fields.length;k++)
			{
				finalFields.push(fields[k]);	
			}
		}
		
	}
	else
	{
		for(var k=0;k<formulaFields.length;k++)
		{
			finalFields.push(formulaFields[k]);	
		}
	}
	
	return finalFields;
}$(function()
{

	/**
	 * Helper function to return the value of a property matched with the given
	 * name from the array of properties
	 * 
	 * @method getPropertyValue
	 * @param {Object}
	 *            items array of objects
	 * @param {String}
	 *            name to get matched object value
	 * @returns value of the matched object
	 */
	Handlebars.registerHelper('getPropertyValue', function(items, name)
	{
		return getPropertyValue(items, name);
	});


	
	/**
	 * displays , in between 2 conatct fields.
	 */
	Handlebars.registerHelper('getPropertyValueExists', function(items, companyname,jobtitle)
	{
		return getPropertyValueByCheckingExistance(items, companyname,jobtitle);
	});

	
	/**
	 * checks for the contact property value existance to display div none or block
	 */
	Handlebars.registerHelper('checkPropertyValueExistance', function(items, name,name1)
	{
		return checkPropertyValueExistance(items, name,name1);
	});
	
	
	
	/**
	 * checks for the contact property value existance to display div none or block
	 */
	Handlebars.registerHelper('getMarginLength', function(items, name)
	{
		return getMarginLength(items, name);
	});

	/**
	 * Helper function to return the checkbox html element with value of a
	 * property matched with the given name from the array of properties
	 * 
	 * @method getPropertyValue
	 * @param {Object}
	 *            items array of objects
	 * @param {String}
	 *            name to get matched object value
	 * @returns heckbox html element with value of the matched object
	 */
	Handlebars.registerHelper('getPropertyValueInCheckbox', function(items, name, separator, checked)
	{
		return getPropertyValueInCheckbox(items, name, separator, checked);
	});

	Handlebars.registerHelper('get_correct_count', function(count)
	{
		return count - 1;
	});

	/**
	 * Helper function to return the value of property based on sub-type of the
	 * property
	 */
	Handlebars.registerHelper('getPropertyValueBySubtype', function(items, name, subtype)
	{
		return getPropertyValueBySubtype(items, name, subtype);
	});

	/**
	 * Helper function to return the value of property based on type of the
	 * property
	 */
	Handlebars.registerHelper('getPropertyValueBytype', function(items, name, type, subtype)
	{
		return getPropertyValueBytype(items, name, type, subtype);
	});

	/**
	 * Returns twitter handle based on the twitter url of the profile. Accepts
	 * string URL and splits at last "/" and returns handle.
	 */
	Handlebars.registerHelper('getTwitterHandleByURL', function(value)
	{

		// if (value.indexOf("https://twitter.com/") != -1)
		// return value;

		value = value.substring(value.lastIndexOf("/") + 1);
		console.log(value);

		return value;
	});

	/**
	 * 
	 */
	Handlebars.registerHelper('getContactCustomProperties', function(items, options)
	{
		var fields = getContactCustomProperties(items);
		if (fields.length == 0)
			return options.inverse(fields);

		return options.fn(fields);

	});

	/**
	 * Returns custom fields without few fields like LINKEDIN or TWITTER or
	 * title fields
	 */
	Handlebars.registerHelper('getContactCustomPropertiesExclusively', function(items, options)
	{

		var exclude_by_subtype = [
				"LINKEDIN", "TWITTER"
		];
		var exclude_by_name = [
			"title"
		];

		var fields = getContactCustomProperties(items);

		var exclusive_fields = [];
		for (var i = 0; i < fields.length; i++)
		{
			if (jQuery.inArray(fields[i].name, exclude_by_name) != -1 || (fields[i].subtype && jQuery.inArray(fields[i].subtype, exclude_by_subtype) != -1))
			{
				continue;
			}

			exclusive_fields.push(jQuery.extend(true, {}, fields[i]));
		}
		if (exclusive_fields.length == 0)
			return options.inverse(exclusive_fields);

		$.getJSON("core/api/custom-fields/type/DATE", function(data)
		{

			if (data.length == 0)
				return;

			for (var j = 0; j < data.length; j++)
			{
				for (var i = 0; i < exclusive_fields.length; i++)
				{
					if (exclusive_fields[i].name == data[j].field_label)
						try
						{
							var value = exclusive_fields[i].value;

							if (!isNaN(value))
							{
								exclusive_fields[i].value = value;
								exclusive_fields[i]["subtype"] = data[j].field_type;
							}

						}
						catch (err)
						{
							exclusive_fields[i].value = exclusive_fields[i].value;
						}
				}
			}
			updateCustomData(options.fn(exclusive_fields));
		});

		return options.fn(exclusive_fields)

	});
	
	/**
	 * Returns custom fields without few fields like LINKEDIN or TWITTER or
	 * title fields
	 */
	Handlebars.registerHelper('getCompanyCustomPropertiesExclusively', function(items, options)
	{

		var exclude_by_subtype = [
				"LINKEDIN", "TWITTER"
		];
		var exclude_by_name = [
			"title"
		];

		var fields = getCompanyCustomProperties(items);
		
		var exclusive_fields = [];
		for (var i = 0; i < fields.length; i++)
		{
			if (jQuery.inArray(fields[i].name, exclude_by_name) != -1 || (fields[i].subtype && jQuery.inArray(fields[i].subtype, exclude_by_subtype) != -1))
			{
				continue;
			}

			exclusive_fields.push(jQuery.extend(true, {}, fields[i]));
		}
		if (exclusive_fields.length == 0)
			return options.inverse(exclusive_fields);

		$.getJSON("core/api/custom-fields/type/DATE", function(data)
		{

			if (data.length == 0)
				return;

			for (var j = 0; j < data.length; j++)
			{
				for (var i = 0; i < exclusive_fields.length; i++)
				{
					if (exclusive_fields[i].name == data[j].field_label)
						try
						{
							var value = exclusive_fields[i].value;

							if (!isNaN(value))
							{
								exclusive_fields[i].value = value;
								exclusive_fields[i]["subtype"] = data[j].field_type;
							}

						}
						catch (err)
						{
							exclusive_fields[i].value = exclusive_fields[i].value;
						}
				}
			}
			updateCompanyCustomData(options.fn(exclusive_fields));
		});

		return options.fn(exclusive_fields)

	});

	Handlebars.registerHelper('urlEncode', function(url, key, data)
	{

		var startChar = "&";
		if (url.indexOf("?") != -1)
			startChar = "&";

		var encodedUrl = url + startChar + key + "=" + escape(JSON.stringify(data));
		// console.log(encodedUrl.length + " " + encodedUrl);
		return encodedUrl;
	});

	Handlebars.registerHelper('encodeString', function(url)
	{
		return encodeURIComponent(url);
	});

	/**
	 * Helper function to return image for an entity (contact). Checks for
	 * existing image, if not found checks for an image using the email of the
	 * entity, if again failed to found returns a default image link.
	 * 
	 * @method gravatarurl
	 * @param {Object}
	 *            items array of objects
	 * @param {Number}
	 *            width to specify the width of the image
	 * @returns image link
	 * 
	 */
	Handlebars.registerHelper('gravatarurl', function(items, width)
	{

		if (items == undefined)
			return;

		// Checks if properties already has an image, to return it
		var agent_image = getPropertyValue(items, "image");
		if (agent_image)
			return agent_image;

		// Default image
		var img = DEFAULT_GRAVATAR_url;
		var backup_image = "&d=404\" ";
		// backup_image="";
		var initials = '';
		try
		{
			// initials = text_gravatar_initials(items)
		}
		catch (e)
		{
			console.log(e);
		}

		if (initials.length == 0)
			backup_image = "&d=" + DEFAULT_GRAVATAR_url + "\" ";
		var data_name = '';
		// "onLoad=\"image_load(this)\" onError=\"image_error(this)\"
		// _data-name=\"" + initials;
		var email = getPropertyValue(items, "email");
		if (email)
		{
			return new Handlebars.SafeString('https://secure.gravatar.com/avatar/' + Agile_MD5(email) + '.jpg?s=' + width + backup_image + data_name);
		}

		return new Handlebars.SafeString('https://secure.gravatar.com/avatar/' + Agile_MD5("") + '.jpg?s=' + width + '' + backup_image + data_name);

	});

	Handlebars.registerHelper('defaultGravatarurl', function(width)
	{
		// Default image
		var img = DEFAULT_GRAVATAR_url;

		return 'https://secure.gravatar.com/avatar/' + Agile_MD5("") + '.jpg?s=' + width + "&d=" + escape(img);
	});

	Handlebars.registerHelper('emailGravatarurl', function(width, email)
	{
		// Default image
		var img = DEFAULT_GRAVATAR_url;

		if (email)
		{
			return 'https://secure.gravatar.com/avatar/' + Agile_MD5(email) + '.jpg?s=' + width + "&d=" + escape(img);
		}

		return 'https://secure.gravatar.com/avatar/' + Agile_MD5("") + '.jpg?s=' + width + "&d=" + escape(img);
	});

	/**
	 * CSS text avatars
	 */
	Handlebars.registerHelper('nameAvatar', function(items, width)
	{

		if (items == undefined)
			return;

		// Checks if properties already has an image, to return it
		var agent_image = getPropertyValue(items, "image");
		if (agent_image)
			return agent_image;

		var email = getPropertyValue(items, "email");
		if (email)
		{
			return 'https://secure.gravatar.com/avatar/' + Agile_MD5(email) + '.jpg?s=' + width + '&d=404';
		}

		return 'https://secure.gravatar.com/avatar/' + Agile_MD5("") + '.jpg?s=' + width + '&d=404';

	});

	/**
	 * To add data-name attribute to image tags
	 */
	Handlebars.registerHelper('dataNameAvatar', function(items)
	{

		if (items == undefined)
			return;

		return text_gravatar_initials(items);

	});

	/**
	 * Helper function to return icons based on given name
	 * 
	 * @method icons
	 * @param {String}
	 *            item name to get icon
	 * @returns icon name
	 */
	Handlebars.registerHelper('icons', function(item)
	{

		item = item.toLowerCase().trim();
		console.log(item);
		if (item == "email")
						return "fa-envelope-o";
		if (item == "phone")
						return "fa-headphones";
		if (item == "url")
						return "fa-home";
		if (item == "call")
						return "fa-phone";
		if (item == "follow_up")
						return "fa-sign-out";
		if (item == "meeting")
						return "fa-group";
		if (item == "milestone")
						return "fa-cog";
		if (item == "send")
						return "fa-reply";
		if (item == "tweet")
						return "fa-share-square-o";
		if (item == "other")
						return "fa-tasks";
		if (item == "twitter")
						return "fa-twitter";
		if (item == "facebook")
						return "fa-facebook";

	});

	Handlebars.registerHelper('eachkeys', function(context, options)
	{
		var fn = options.fn, inverse = options.inverse;
		var ret = "";

		var empty = true;
		for (key in context)
		{
			empty = false;
			break;
		}

		if (!empty)
		{
			for (key in context)
			{
				ret = ret + fn({ 'key' : key, 'value' : context[key] });
			}
		}
		else
		{
			ret = inverse(this);
		}
		return ret;
	});

	/**
	 * Turns the first letter of the given string to upper-case and the
	 * remaining to lower-case (EMaiL to Email).
	 * 
	 * @method ucfirst
	 * @param {String}
	 *            value to convert as ucfirst
	 * @returns converted string
	 */
	Handlebars.registerHelper('ucfirst', function(value)
	{
		return (value && typeof value === 'string') ? (value.charAt(0).toUpperCase() + value.slice(1).toLowerCase()) : '';
	});

	/**
	 * Returns Contact short name
	 */
	Handlebars.registerHelper('contactShortName', function()
	{
		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model && !company_util.isCompany())
		{

			var contact_properties = App_Contacts.contactDetailView.model.get('properties');

			if (App_Contacts.contactDetailView.model.get('type') == 'PERSON')
			{
				var last_name;
				for (var i = 0; i < contact_properties.length; i++)
				{

					if (contact_properties[i].name == "last_name")
						last_name = contact_properties[i].value;
					else if (contact_properties[i].name == "first_name")
						return contact_properties[i].value;
				}
				if (last_name && last_name != null)
				{
					return last_name;
				}
				return "Contact";
			}
			else
			{
				for (var i = 0; i < contact_properties.length; i++)
				{
					if (contact_properties[i].name == "name")
						return contact_properties[i].value;
				}
				return "Company";
			}
		} else if (App_Companies.companyDetailView && App_Companies.companyDetailView.model)
		{
			var contact_properties = App_Companies.companyDetailView.model.get('properties');

			for (var i = 0; i < contact_properties.length; i++)
			{
				if (contact_properties[i].name == "name")
					return contact_properties[i].value;
			}
			return "Company";
		}
	});
	
	Handlebars.registerHelper("isCompany", function(options)
			{
				if (company_util.isCompany())
					return options.fn(this);

				return options.inverse(this);
			});

	/**
	 * Returns workflow name surrounded by quotations if exists, otherwise this
	 */
	Handlebars.registerHelper('workflowName', function()
	{
		if (App_Workflows.workflow_model)
		{
			var workflowName = App_Workflows.workflow_model.get("name");
			return "\'" + workflowName + "\'";
		}

		return "this";
	});

	/**
	 * 
	 * @method task_property
	 * @param {String}
	 *            change property value in view
	 * @returns converted string
	 */
	Handlebars.registerHelper('task_property', function(value)
	{

		if (value == "FOLLOW_UP")
			return "Follow Up";
		else
			return ucfirst(value);

	});

	/**
	 * Adds Custom Fields to contact merge form, where this helper function is
	 * called
	 */
	Handlebars.registerHelper('show_custom_fields_for_merge', function(custom_fields, contacts)
	{

		var el = show_custom_fields_helper_for_merge(custom_fields, contacts);
		return new Handlebars.SafeString(el);

	});

	/**
	 * this is useful in activity when note characters exceeds abouve 50 simply
	 * show dots
	 */
	Handlebars.registerHelper('add_dots_end', function(value)
	{

		if (value)
		{
			if (value.length > 100)
			{
				var subst = value.substr(0, 100);
				subst = subst + "....";
				return subst;
			}
		}
		return value;

	});

	// Tip on using Gravar with JS:
	// http://www.deluxeblogtips.com/2010/04/get-gravatar-using-only-javascript.html
	/**
	 * Helper function to generate a html string as desired to show-up the
	 * tags-view
	 * 
	 * @method tagslist
	 * @param {Object}
	 *            tags array containing all tags
	 */
	Handlebars.registerHelper('tagslist', function(tags)
	{

		console.log(tags);
		var json = {};

		// Store tags in a json, starting letter as key
		for (var i = 0; i < tags.length; i++)
		{

			var tag = tags[i].tag;
			// console.log(tag);
			var start = tag.charAt(0).toUpperCase();

			var array = new Array();

			// see if it is already present
			if (json[start] != undefined)
			{
				array = json[start];
			}

			array.push(tag);
			json[start] = array;

		}

		// To sort tags in case-insensitive order i.e. keys in json object
		var keys = Object.keys(json);
		keys.sort();

		// Sorts it based on characters and then draws it
		var html = "";

		for ( var i in keys)
		{

			var array = json[keys[i]];

			html += "<div class='tag-element'><div class='tag-key'>" + keys[i] + "</div> ";

			html += "<div class='tag-values'>";

			for (var i = 0; i < array.length; i++)
			{
				console.log("************************");
				console.log(array[i]);
				var hrefTag = "#tags/" + encodeURIComponent(array[i]);

				html += ('<a href=\"' + hrefTag + '\" >' + array[i] + '</a> ');
			}
			html += "</div></div>";

		}

		return html;
	});

	Handlebars
			.registerHelper(
					'setupTags',
					function(tags)
					{

						console.log(tags);
						var json = {};

						var keys = [];
						// Store tags in a json, starting letter as key
						for (var i = 0; i < tags.length; i++)
						{
							var tag = tags[i].tag;
							var key = tag.charAt(0).toUpperCase();
							// console.log(tag);
							if (jQuery.inArray(key, keys) == -1)
								keys.push(key);
						}

						// To sort tags in case-insensitive order i.e. keys in
						// json object
						keys.sort();
						console.log(keys);
						var html = "";
						for (var i = 0; i < keys.length; i++)
						{
							html += "<div class='tag-element' style='margin-right:10px;'><div class='tag-key'>" + keys[i] + "</div><div class='tag-values' tag-alphabet=\"" + encodeURI(keys[i]) + "\"></div></div>";
						}
						return new Handlebars.SafeString(html);
					});

	// To show milestones as columns in deals
	Handlebars
			.registerHelper(
					'deals_by_milestones',
					function(data)
					{
						var html = "";
						var count = Object.keys(data).length;
						$
								.each(
										data,
										function(key, value)
										{
											if (count == 1 && key == "")
											{
												html += '<div class="alert-info alert"><div class="slate-content"><div class="box-left pull-left m-r-md"><img alt="Clipboard" src="/img/clipboard.png"></div><div class="box-right pull-left"><h4 class="m-t-none">You have no milestones defined</h4><br><a href="#milestones" class="btn btn-default btn-sm m-t-xs"><i class="icon icon-plus-sign"></i> Add Milestones</a></div><div class="clearfix"></div></div></div>';
											}
											else
											{
												html += "<div class='milestone-column'><div class='dealtitle-angular'><p class='milestone-heading'>" + key + "</p><span></span></div><ul class='milestones' milestone='" + key + "'>";
												for ( var i in value)
												{
													if (value[i].id)
														html += "<li id='" + value[i].id + "'>" + getTemplate("opportunities-grid-view", value[i]) + "</li>";
												}
												html += "</ul></div>";
											}
										});
						return html;
					});

	// To show milestones as sortable list
	Handlebars
			.registerHelper(
					'milestone_ul',
					function(data)
					{
						var html = "";
						var wonMsg = 'Deals with this milestone are considered as Won.';
						var lostMsg = 'Deals with this milestone are considered as Lost.';
						// var html = "<ul class='milestone-value-list
						// tagsinput' style='padding:1px;list-style:none;'>";
						if (data)
						{
							var milestones = data.milestones.split(",");
							for ( var i in milestones)
							{
								html += "<tr data='" + milestones[i] + "' style='display: table-row;'><td><div class='milestone-name-block inline-block v-top text-ellipsis' style='width:80%'>";
								if(milestones[i] == data.won_milestone){
									html += milestones[i] + "<i data-toogle='tooltip' title='"+wonMsg+"' class='icon-like mark-won m-l-sm'></i></div></td><td class='b-r-none'><div class='m-b-n-xs'>";
									html += "<a class='milestone-won text-l-none-hover c-p text-xs hover-show disabled' style='visibility:hidden;' data-toggle='tooltip' title='Set as Won Milestone'><i class='icon-like'></i></a>";
									html += "<a class='milestone-lost text-l-none-hover c-p text-xs m-l-sm not-applicable hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Lost Milestone'><i class='icon-dislike'></i></a>";
								} else if(milestones[i] == data.lost_milestone){
									html += milestones[i] + "<i data-toogle='tooltip' title='"+lostMsg+"' class='icon-dislike mark-lost m-l-sm'></i></div></td><td class='b-r-none'><div class='m-b-n-xs'>";
									html += "<a class='milestone-won text-l-none-hover c-p text-xs not-applicable hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Won Milestone'><i class='icon-like'></i></a>";
									html += "<a class='milestone-lost text-l-none-hover c-p text-xs m-l-sm hover-show disabled' style='visibility:hidden;' data-toggle='tooltip' title='Set as Lost Milestone'><i class='icon-dislike'></i></a>";
								} else{
									html += milestones[i] + "</div></td><td class='b-r-none'><div class='m-b-n-xs'>";
									html += "<a class='milestone-won text-l-none-hover c-p text-xs hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Won Milestone'><i class='icon-like'></i></a>";
									html += "<a class='milestone-lost text-l-none-hover c-p text-xs m-l-sm hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Lost Milestone'><i class='icon-dislike'></i></a>";
								}
								html +=	"<a class='milestone-delete c-p m-l-sm text-l-none text-xs hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Delete Milestone'><i class='icon icon-trash'></i>" +
										"</a><a class='text-l-none-hover c-p text-xs m-l-sm hover-show' style='visibility:hidden;'><i title='Drag' class='icon-move'></i></a></div></td></tr>";
								// html += "<li data='" + milestones[i] +
								// "'><div><span>" + milestones[i] + "</span><a
								// class='milestone-delete right'
								// href='#'>&times</a></div></li>";
							}
						}
						// html += "</ul>";
						return html;
					});

	/**
	 * Helper function to return date string from epoch time
	 */
	Handlebars.registerHelper('epochToHumanDate', function(format, date)
	{

		if (!format)
			format = "mmm dd yyyy HH:MM:ss";

		if (!date)
			return;

		if ((date / 100000000000) > 1)
		{
			console.log(new Date(parseInt(date)).format(format));
			return new Date(parseInt(date)).format(format, 0);
		}
		// date form milliseconds
		var d = "";
		try
		{
			d= new Date(parseInt(date) * 1000).format(format);
		}
		catch (err)
		{
			console.log("Invalid date for custom field.");
		}

		return d

		// return $.datepicker.formatDate(format , new Date( parseInt(date) *
		// 1000));
	});

	// Helper function to return date in user selected format in  preferences.

	Handlebars.registerHelper('epochToHumanDateInFormat', function(date)
	{

		if (!date)
			return;
		return getDateInFormatFromEpoc(date);
		
	});

	// Helper function to return date format from  preferences.

	Handlebars.registerHelper('dateFormat', function()
	{

		return "Select Date";
		
	});

	// Helper function to return current date in preferences page.

	Handlebars.registerHelper('currentDateInFormat', function(format)
	{
		if(!format)
			return;
		format = format.replace(/MM/g, "mmmm").replace(/M/g, "mmm").replace(/DD/g, "dddd").replace(/D/g, "ddd");
		return new Date().format(format);
		
	});

	Handlebars.registerHelper('stringToHumanDateInFormat', function(date)
	{
		if(!date)
			return;
		var dateString = new Date(date);
		if(dateString == "Invalid Date")
			return getDateInFormatFromEpoc(date);
		else
			return en.dateFormatter({raw: getGlobalizeFormat()})(dateString);

		
	});

	/**
	 * Helper function to return the date string converting to local timezone.
	 */
	Handlebars.registerHelper('toLocalTimezone', function(dateString)
	{
		var date = new Date(dateString);

		return date.toDateString() + ' ' + date.toLocaleTimeString();
	});

	/**
	 * Helper function to return the date string converting to local timezone
	 * from UTC.
	 */
	Handlebars.registerHelper('toLocalTimezoneFromUtc', function(dateString)
	{
		var date = new Date(dateString + ' GMT+0000');

		return date.toDateString() + ' ' + date.toLocaleTimeString();
	});

	/**
	 * Helper function to return task date (MM dd, ex: Jan 10 ) from epoch time
	 */
	Handlebars.registerHelper('epochToTaskDate', function(date)
	{

		var intMonth, intDay;

		// Verifies whether date is in milliseconds, then
		// no need to multiply with 1000
		if ((date / 100000000000) > 1)
		{
			intMonth = new Date(date).getMonth();
			intDay = new Date(date).getDate();
		}
		else
		{
			intMonth = new Date(parseInt(date) * 1000).getMonth();
			intDay = new Date(parseInt(date) * 1000).getDate();
		}
		var monthArray = [
				"Jan", "Feb", "March", "April", "May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"
		];

		return (monthArray[intMonth] + " " + intDay);
	});

	/**
	 * Helper function to return task color based on it's priority
	 */
	Handlebars.registerHelper('task_label_color', function(priority)
	{
		if (priority == 'HIGH' || priority == 'red')
			return 'danger';
		if (priority == 'NORMAL' || priority == '#36C')
			return 'info';
		if (priority == 'LOW')
			return 'label bg-light dk';
		if (priority == 'green')
			return 'success';
	});

	/**
	 * Helper function to return event label based on it's priority
	 */
	Handlebars.registerHelper('event_priority', function(priority)
	{
		if (priority == 'red' || priority == '#f05050')
			return 'High';
		if (priority == '#36C' || priority == '#23b7e5' || priority == 'blue')
			return 'Normal';
		if (priority == 'green' || priority == '#bbb')
			return 'Low';
	});

	/**
	 * Helper function to return event label color based on it's color
	 */
	Handlebars.registerHelper('event_label_color', function(color)
	{
		if (color == 'red' || color == '#f05050')
			return 'danger';
		if (color == '#36C' || color == '#23b7e5' || color == 'blue')
			return 'primary';
		if (color == 'green' || color == '#bbb')
			return 'warning';
	});

	/**
	 * Helper function to return type based on it's network type
	 */
	Handlebars.registerHelper('network', function(type)
	{
		if (type == 'GOOGLE')
			return 'Google Drive';
		if (type == 'S3')
			return 'Uploaded Doc';
	});

	/**
	 * Helper function to return date (Jan 10, 2012) from epoch time (users
	 * table)
	 * 
	 * @param {Object}
	 *            info_json json object containing information about
	 *            createdtime, last logged in time etc..
	 * @param {String}
	 *            date_type specifies the type of date to return (created or
	 *            logged in)
	 */
	Handlebars.registerHelper('epochToDate', function(info_json, date_type)
	{

		var obj = JSON.parse(info_json);

		if (!obj[date_type])
			return "-";
		if (date_type != "created_time")
		{
			if ((obj[date_type] / 100000000000) > 1)
			{
				return new Date(parseInt(obj[date_type])).format("mmm dd yyyy HH:MM:ss", 0);
			}
			// date form milliseconds
			return new Date(parseInt(obj[date_type]) * 1000).format("mmm dd yyyy HH:MM:ss", 0);
		}
		else
		{
			var intMonth = new Date(parseInt(obj[date_type]) * 1000).getMonth();
			var intDay = new Date(parseInt(obj[date_type]) * 1000).getDate();
			var intYear = new Date(parseInt(obj[date_type]) * 1000).getFullYear();

			var monthArray = [
					"Jan", "Feb", "March", "April", "May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"
			];

			return (monthArray[intMonth] + " " + intDay + ", " + intYear);
		}
	});

	/**
	 * Returns currency symbol based on the currency value (deals)
	 */
	Handlebars.registerHelper('currencySymbol', function()
	{
		var value = ((CURRENT_USER_PREFS.currency != null) ? CURRENT_USER_PREFS.currency : "USD-$");
		var symbol = ((value.length < 4) ? "$" : value.substring(4, value.length));
		return symbol;
	});
	Handlebars.registerHelper('mandrill_exist', function(options)
	{
		if (IS_HAVING_MANDRILL)
			return options.fn(this);
		else
			return options.inverse(this);
	});

	/**
	 * Calculates the "pipeline" for deals based on their value and probability
	 * (value * probability)
	 * 
	 * @param {Number}
	 *            value of the deal
	 * @param {Number}
	 *            probability of the deal
	 */
	Handlebars.registerHelper('calculatePipeline', function(value, probability)
	{

		var pipeline = parseInt(value) * parseInt(probability) / 100;
		return pipeline;
	});

	/**
	 * Returns required log (time or message) from logs (campaign logs)
	 */
	Handlebars.registerHelper('getRequiredLog', function(log_array_string, name)
	{
		var logArray = JSON.parse(log_array_string);
		if (name == "t")
		{
			var readableTime = new Date(logArray[0][name] * 1000);
			return readableTime;
		}
		return logArray[0][name];
	});

	/**
	 * Returns table headings for custom contacts list view
	 */
	Handlebars.registerHelper('contactTableHeadings', function(item)
	{

		var el = "";
		$.each(App_Contacts.contactViewModel[item], function(index, element)
		{
			if (element.indexOf("custom_") == 0)
				element = element.split("custom_")[1];
			element = element.replace("_", " ")

			el = el.concat('<th>' + ucfirst(element) + '</th>');

		});

		return new Handlebars.SafeString(el);
	});

	/**
	 * Returns table headings for reports custom contacts list view
	 */
	Handlebars.registerHelper('reportsContactTableHeadings', function(item)
	{

		var el = "";
		$.each(REPORT[item], function(index, element)
		{

			if (element.indexOf("properties_") != -1)
				element = element.split("properties_")[1];
			if (element.indexOf("custom_") == 0)
				element = element.split("custom_")[1];
			element = element.replace("_", " ")

			el = el.concat('<th>' + ucfirst(element) + '</th>');

		});

		return new Handlebars.SafeString(el);
	});

	/**
	 * Helper function, which executes different templates (entity related)
	 * based on entity type. Here "this" reffers the current entity object.
	 * (used in timeline)
	 * 
	 */
	Handlebars.registerHelper('if_entity', function(item, options)
	{

		if (this.entity_type == item)
		{
			return options.fn(this);
		}
		if (!this.entity && this[item] != undefined)
		{
			return options.fn(this);
		}
	});

	/**
	 * Returns trigger type, by removing underscore and converting into
	 * lowercase, excluding first letter.
	 */
	Handlebars.registerHelper('titleFromEnums', function(value)
	{
		if (!value)
			return;

		var str = value.replace(/_/g, ' ');
		return ucfirst(str.toLowerCase());

	});

	Handlebars.registerHelper('actionTemplate', function(actions)
	{
		if (!actions)
			return;

		var actions_count = actions.length;

		var el = '<div class="table-resp">';

		$.each(actions, function(key, val)
		{
			if (--actions_count == 0)
			{
				el = el.concat(titleFromEnums(val.action));
				return;
			}
			el = el.concat(titleFromEnums(val.action) + ", ");
		});

		el = el.concat('</div>');
		return new Handlebars.SafeString(el);

	});

	Handlebars.registerHelper('triggerType', function(value)
	{
		if (value == 'ADD_SCORE')
			return value.replace('ADD_SCORE', 'Score (>=)');

		return titleFromEnums(value);
	});

	/**
	 * Returns notification type,by replacing 'has been' with underscore and
	 * converting into lowercase.
	 */
	Handlebars.registerHelper('if_notification_type', function()
	{

		// Makes 'CONTACT CREATED' To 'COMPANY CREATED'
		if (this.type == "COMPANY")
		{
			var arr = this.notification.split('_');
			var temp = ucfirst(arr[0].replace('CONTACT', 'COMPANY')) + " " + ucfirst(arr[1]);
			return " - " + temp;
		}

		// Replaces '_' with ' '
		var str = this.notification.replace(/_/, ' ');

		switch (str) {
		case "IS BROWSING":
			return str.toLowerCase() + " " + this.custom_value;

		case "CLICKED LINK":
			var customJSON = JSON.parse(this.custom_value);

			if (customJSON["workflow_name"] == undefined)
				return str.toLowerCase() + " " + customJSON.url_clicked;

			return str.toLowerCase() + " " + customJSON.url_clicked + " " + " of campaign " + "\"" + customJSON.workflow_name + "\""

		case "OPENED EMAIL":
			var customJSON = JSON.parse(this.custom_value);

			if (customJSON.hasOwnProperty("workflow_name"))
				return str.toLowerCase() + " " + " of campaign " + "\"" + customJSON.workflow_name + "\"";

			return str.toLowerCase() + " with subject " + "\"" + customJSON.email_subject + "\"";

		case "CONTACT ADDED":
			return " - " + ucfirst(str.split(' ')[0]) + " " + ucfirst(str.split(' ')[1]);

		case "CONTACT DELETED":
			return " - " + ucfirst(str.split(' ')[0]) + " " + ucfirst(str.split(' ')[1]);

		case "DEAL CREATED":
			return " - " + ucfirst(str.split(' ')[0]) + " " + ucfirst(str.split(' ')[1]);

		case "DEAL CLOSED":
			return " - " + ucfirst(str.split(' ')[0]) + " " + ucfirst(str.split(' ')[1]);

		case "TAG ADDED":
			return " - " + "\"" + this.custom_value + "\" " + str.toLowerCase().split(' ')[0] + " has been " + str.toLowerCase().split(' ')[1];

		case "TAG DELETED":
			return " - " + "\"" + this.custom_value + "\" " + str.toLowerCase().split(' ')[0] + " has been " + str.toLowerCase().split(' ')[1];

		default:
			return str.toLowerCase();
		}
	});

	/**
	 * Converts Epoch Time to Human readable date of default format.Used for
	 * campaign-logs.
	 */
	Handlebars.registerHelper('epochToLogDate', function(logTime)
	{
		return new Date(logTime * 1000);
	});

	/**
	 * Returns country name from country code.
	 */
	Handlebars.registerHelper('getCountryName', function(countrycode)
	{
		// retrieves country name from code using country-from-code.js
		return getCode(countrycode);
	});

	/**
	 * Replace '+' symbols with space.Used in notification.
	 */
	Handlebars.registerHelper('replace_plus_symbol', function(name)
	{

		return name.replace(/\+/, ' ');
	});
	/**
	 * Replace '-' symbols with empty.Used in invoice.
	 */
	Handlebars.registerHelper('replace_minus_symbol', function(name)
	{

		return name.replace(/\-/, '');
	});

	Handlebars.registerHelper('get_amount_with_possitive', function(amount)
	{
		if (amount < 0)
			return amount / 100 * (-1);
		else
			return amount / 100;
	});
	/**
	 * Removes forward slash. Makes A/B to AB. Used in contact-detail-campaigns
	 */
	Handlebars.registerHelper('removeSlash', function(value)
	{
		if (value == 'A/B')
			return value.replace(/\//, '');

		return value;
	});

	/**
	 * Displays all the properties of a contact in its detail view, excluding
	 * the function parameters (fname, lname, company etc..)
	 */
	Handlebars
			.registerHelper(
					'if_property',
					function(fname, lname, company, title, image, email, phone, website, address, options)
					{

						if (this.name != fname && this.name != lname && this.name != company && this.name != title && this.name != image && this.name != email && this.name != phone && this.name != website && this.name != address)
							return options.fn(this);
					});

	/**
	 * Counts the existence of property name which occurred multiple times.
	 */
	Handlebars.registerHelper('property_is_exists', function(name, properties, options)
	{

		if (getPropertyValue(properties, name))
			return options.fn(this);
		return options.inverse(this);
	});

	/**
	 * returns online scheduling url of current user
	 */
	Handlebars.registerHelper('online_schedule_URL', function()
	{
		return ONLINE_SCHEDULING_URL;
	});

	// gets the refernce code of current domain

	Handlebars.registerHelper('get_current_domain', function()
	{
		return CURRENT_DOMAIN_USER.domain;
	});

	
	/*
	 * To add comma in between the elements.
	 */
	Handlebars.registerHelper('comma_in_between_property', function(value1, value2, properties, options)
	{

		if (getPropertyValue(properties, value1) && getPropertyValue(properties, value2))
			return ",";
	});

	Handlebars.registerHelper('property_subtype_is_exists', function(name, subtype, properties, options)
	{

		if (getPropertyValueBySubtype(properties, name, subtype))
			return options.fn(this);
		return options.inverse(this);
	});

	/**
	 * Displays multiple times occurred properties of a contact in its detail
	 * view in single entity
	 */
	Handlebars.registerHelper('multiple_Property_Element', function(name, properties, options)
	{

		var matching_properties_list = agile_crm_get_contact_properties_list(name)
		if (matching_properties_list.length > 0)
			return options.fn(matching_properties_list);
	});
	
	/**
	 * Displays multiple times occurred properties of a contact in its detail
	 * view in single entity
	 */
	Handlebars.registerHelper('multiple_Company_Property_Element', function(name, properties, options)
	{

		var matching_properties_list = company_util.agile_crm_get_company_properties_list(name)
		if (matching_properties_list.length > 0)
			return options.fn(matching_properties_list);
	});

	/**
	 * Converts address as comma seprated values and returns as handlebars safe
	 * string.
	 */
	Handlebars
			.registerHelper(
					'address_Element',
					function(properties)
					{
						var properties_count = 0;
						for (var i = 0, l = properties.length; i < l; i++)
						{

							if (properties[i].name == "address")
							{
								var el = '';

								var address = {};
								try
								{
									address = JSON.parse(properties[i].value);
								}
								catch (err)
								{
									address['address'] = properties[i].value;
								}

								// Gets properties (keys) count of given json
								// object
								var count = countJsonProperties(address);

								if (properties_count != 0)

									el = el
											.concat('<div class="contact-addressview"><div><div class="pull-left hide" style="width:18px"><i class="icon icon-pointer"></i></div><div class="custom-color">');
								else
									el = el
											.concat('<div class="contact-addressview"><div><div class="pull-left hide" style="width:18px"><i class="icon icon-pointer"></i></div><div class="custom-color">');

								if(address.address !== undefined)
									el = el.concat(address.address+", ");

								if(address.city !== undefined)
									el = el.concat(address.city+", ");

								if(address.state !== undefined)
									el = el.concat(address.state+", ");

								if(address.zip !== undefined)
									el = el.concat(address.zip+", ");

								if(address.country !== undefined)
									el = el.concat(address.country+".");

								/*$.each(address, function(key, val)
								{
									if (--count == 0)
									{
										el = el.concat(val + ".");
										return;
									}
									el = el.concat(val + ", ");
								});*/

								if (properties[i].subtype)
									el = el.concat('<span class="label bg-light dk text-tiny">' + properties[i].subtype + '</span>');
								el = el.concat('</span>&nbsp;<span id="map_view_action"></span></div></div>');
								return new Handlebars.SafeString(el);
							}
							else if (properties[i].name == "phone" || properties[i].name == "email")
							{
								++properties_count;
							}
						}
					});

	Handlebars.registerHelper('address_Template', function(properties)
	{

		for (var i = 0, l = properties.length; i < l; i++)
		{

			if (properties[i].name == "address")
			{
				var el = '';

				var address = {};
				try
				{
					address = JSON.parse(properties[i].value);
				}
				catch (err)
				{
					address['address'] = properties[i].value;
				}

				// Gets properties (keys) count of given json
				// object
				var count = countJsonProperties(address);

				$.each(address, function(key, val)
				{
					if (--count == 0)
					{
						el = el.concat(val + ".");
						return;
					}
					el = el.concat(val + ", ");
				});
				/*
				 * if (properties[i].subtype) el = el.concat(" <span
				 * class='label'>" + properties[i].subtype + "</span>");
				 */

				return new Handlebars.SafeString(el);
			}
		}
	});
	
	/**
	 * To represent a number with commas in deals
	 */
	Handlebars.registerHelper('numberWithCommas', function(value)
	{
		if (value == 0)
			return value;

		if (value)
		{
			return value.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g, ",").replace('.00', '');
		}
	});

	/**
	 * Converts reports/view field element as comma seprated values and returns
	 * as handlebars safe string.
	 */
	Handlebars.registerHelper('field_Element', function(properties)
	{
		var el = "";
		var count = properties.length;

		$.each(properties, function(key, value)
		{

			if (value.indexOf("properties_") != -1)
				value = value.split("properties_")[1];
			else if (value.indexOf("custom_") != -1)
				value = value.split("custom_")[1];
			else if (value.indexOf("CUSTOM_") != -1)
				value = value.split("CUSTOM_")[1];
			else if (value == "created_time")
				value = "Created Date";
			else if (value == "updated_time")
				value = "Updated Date";

			value = value.replace("_", " ");

			if (--count == 0)
			{
				el = el.concat(value);
				return;
			}
			el = el.concat(value + ", ");
		});

		return new Handlebars.SafeString(el);
	});

	/**
	 * Converts string to JSON
	 */
	Handlebars.registerHelper('stringToJSON', function(object, key, options)
	{
		console.log(object);
		console.log(key);
		if (key)
		{
			try
			{

				object[key] = JSON.parse(object[key]);
			}
			finally
			{
				return options.fn(object[key]);
			}
		}

		try
		{
			return options.fn(JSON.parse(object));
		}
		catch (err)
		{
			return options.fn(object);
		}
	});

	/**
	 * Checks the existence of property name and prints value
	 */
	Handlebars.registerHelper('if_propertyName', function(pname, options)
	{
		var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;

		if (value.search(exp) != -1)
			return options.fn(this);
		else
			return options.inverse(this);
	});

	Handlebars.registerHelper('show_link_in_statement', function(value)
	{

		var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;

		try
		{
			value = value.replace(exp, "<a href='$1' target='_blank' class='cd_hyperlink'>$1</a>");
			return new Handlebars.SafeString(value);
		}
		catch (err)
		{
			return value;
		}

	});

	/**
	 * Returns table headings for custom contacts list view
	 */
	Handlebars.registerHelper('displayPlan', function(value)
	{

		return ucfirst(value).replaceAll("_", " ");

	});

	/**
	 * Returns plain text removes underscore from text
	 */
	Handlebars.registerHelper('displayPlainText', function(value)
	{

		return value.split("_").join(" ");

	});

	/**
	 * Returns plain text removes underscore from text
	 */
	Handlebars.registerHelper('displayTaskStatus', function(value)
	{
		var val = value.split("_").join("").trim().toLowerCase();
		if (val == "yettostart")
			return "Not Started";
		else
			return ucfirst(value.split("_").join(" ").trim());

	});

	Handlebars.registerHelper('getCurrentContactProperty', function(value)
	{
		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model)
		{
			var contact_properties = App_Contacts.contactDetailView.model.get('properties')
			console.log(App_Contacts.contactDetailView.model.toJSON());
			return getPropertyValue(contact_properties, value);
		}
	});

	Handlebars.registerHelper('safe_string', function(data)
	{

		data = data.replace(/\n/, "<br/>");
		return new Handlebars.SafeString(data);
	});

	Handlebars.registerHelper('string_to_date', function(format, date)
	{

		return new Date(date).format(format);
	});

	Handlebars.registerHelper('isArray', function(data, options)
	{
		if (isArray(data))
			return options.fn(this);
		return options.inverse(this);
	});

	Handlebars.registerHelper('is_string', function(data, options)
	{
		if (typeof data == "string")
			return options.fn(this);
		return options.inverse(this);

	});

	Handlebars.registerHelper("bindData", function(data)
	{

		return JSON.stringify(data);
	});

	Handlebars.registerHelper("getCurrentUserPrefs", function(options)
	{
		if (CURRENT_USER_PREFS)
			;
		return options.fn(CURRENT_USER_PREFS);
	});

	Handlebars.registerHelper("getCurrentDomain", function(options)
	{

		var url = window.location.host;

		var exp = /(\.)/;

		if (url.search(exp) >= 0)
			return url.split(exp)[0];

		return " ";
	});

	Handlebars.registerHelper("getBase64Domain", function()
			{
				return window.btoa(window.location.host.split(".")[0]);
	});

	// Gets date in given range
	Handlebars.registerHelper('date-range', function(from_date_string, no_of_days, options)
	{
		var from_date = Date.parse(from_date_string);
		var to_date = Date.today().add({ days : parseInt(no_of_days) });
		return to_date.toString('MMMM d, yyyy') + " - " + from_date.toString('MMMM d, yyyy');

	});

	Handlebars.registerHelper("extractEmail", function(content, options)
	{

		console.log(content);

		return options.fn(content.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)[0]);
	});

	Handlebars.registerHelper('getCurrentContactPropertyBlock', function(value, options)
	{
		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model)
		{
			var contact_properties = App_Contacts.contactDetailView.model.get('properties')
			console.log(App_Contacts.contactDetailView.model.toJSON());
			return options.fn(getPropertyValue(contact_properties, value));
		}
	});

	Handlebars.registerHelper('isDuplicateContactProperty', function(properties, key, options)
	{
		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model)
		{
			var contact_properties = App_Contacts.contactDetailView.model.get('properties');
			var currentContactEntity = getPropertyValue(contact_properties, key);
			var contactEntity = getPropertyValue(properties, key);

			if (!currentContactEntity || !contactEntity)
			{
				currentContactEntity = getPropertyValue(contact_properties, "first_name") + " " + getPropertyValue(contact_properties, "last_name");
				contactEntity = getPropertyValue(properties, "first_name") + " " + getPropertyValue(properties, "last_name");
			}
			
			if(App_Contacts.contactDetailView.model.get('type') == 'COMPANY')
			{
				currentContactEntity = getPropertyValue(contact_properties, "name") ;
				contactEntity = getPropertyValue(properties, "name");
			}

			if (currentContactEntity == contactEntity)
				return options.fn(this);

			return options.inverse(this)
		}
	});

	Handlebars.registerHelper('containString', function(value, target, options)
	{
		if (target.search(value) != -1)
			return options.fn(this);

		return options.inverse(this);
	});
	Handlebars.registerHelper('is_emailPlan', function(planId, options)
	{

		if (planId.search("email") != -1)
			return options.fn(this);

		return options.inverse(this);

	});
	Handlebars.registerHelper('is_userPlan', function(planId, options)
	{
		if (planId.search("email") != -1)
			return options.inverse(this);
		return options.fn(this);

	});

	Handlebars.registerHelper('numeric_operation', function(operand1, operand2, operator)
	{

		var operators = "/*-+";

		if (operators.indexOf(operator) == -1)
			return "";

		if (operator == "+")
			return operand1 + operand2;

		if (operator == "-")
			return operand1 - operand2;

		if (operator == "*")
			return operand1 * operand2;

		if (operator == "/")
			return operand1 / operand2;
	});
	Handlebars.registerHelper('get_total_amount', function(operand1, operand2)
	{

		return (operand1 / 100) * operand2;
	});

	Handlebars.registerHelper('check_length', function(content, length, options)
	{

		if (parseInt(content.length) > parseInt(length))
			return options.fn(this);

		return options.inverse(this);
	});
	Handlebars.registerHelper('get_unrefunded_amount', function(operand1, operand2)
	{
		return (operand1 - operand2) / 100;

	});

	Handlebars.registerHelper('check_json_length', function(content, length, options)
	{
		var json_length = 0;
		for ( var prop in content)
		{
			json_length++;
		}

		if (json_length == parseInt(length))
		{
			for ( var prop in content)
			{
				return options.fn({ property : prop, value : content[prop], last : true });
			}
		}

		return options.inverse(content);
	});

	Handlebars.registerHelper('iterate_json', function(context, options)
	{
		var result = "";
		var count = 0;
		var length = 0;
		for ( var prop in context)
		{
			length++;
		}

		for ( var prop in context)
		{
			count++;
			if (count == length)
				result = result + options.fn({ property : prop, value : context[prop], last : true });
			else
				result = result + options.fn({ property : prop, value : context[prop], last : false });

		}

		console.log(result);
		return result;
	});

	Handlebars.registerHelper('get_social_icon', function(name)
	{
		return get_social_icon(name);

	});

	Handlebars.registerHelper("each_with_index", function(array, options)
	{
		var buffer = "";
		for (var i = 0, j = array.length; i < j; i++)
		{
			var item = array[i];

			// stick an index property onto the item, starting with 1, may make
			// configurable later
			item.index = i + 1;

			console.log(item);
			// show the inside of the block
			buffer += options.fn(item);
		}

		// return the finished buffer
		return buffer;

	});

	Handlebars.registerHelper('if_json', function(context, options)
	{

		try
		{
			var json = $.parseJSON(context);

			if (typeof json === 'object')
				return options.fn(this);
			return options.inverse(this);
		}
		catch (err)
		{
			return options.inverse(this);
		}
	});

	Handlebars.registerHelper('add_tag', function(tag)
	{
		addTagAgile(tag);
	});

	Handlebars.registerHelper('set_up_dashboard_padcontent', function(key)
	{
		return new Handlebars.SafeString(getTemplate("empty-collection-model", CONTENT_JSON.dashboard[key]));
	});

	/**
	 * Removes surrounded square brackets
	 */
	Handlebars.registerHelper('removeSquareBrackets', function(value)
	{
		return value.replace(/[\[\]]+/g, '');
	});

	/**
	 * Removes "" with single quotes brackets
	 */
	Handlebars.registerHelper('removeDoubleCoutes', function(value)
	{
		var strings = value.replace(/[\[\]]+/g, '');
		var charwithsinglequote = strings.replace(/"/g, "'");
		return charwithsinglequote;
	});

	/**
	 * Shows list of triggers separated by comma
	 */
	Handlebars.registerHelper('toLinkTrigger', function(context, options)
	{
		var ret = "";
		for (var i = 0, j = context.length; i < j; i++)
		{
			ret = ret + options.fn(context[i]);

			// Avoid comma appending to last element
			if (i < j - 1)
			{
				ret = ret + ", ";
			}
			;
		}
		return ret;
	});

	// Gets minutes from milli seconds
	Handlebars.registerHelper('millSecondsToMinutes', function(timeInMill)
	{
		if (isNaN(timeInMill))
			return;
		var sec = timeInMill / 1000;
		var min = Math.floor(sec / 60);

		if (min < 1)
			return Math.ceil(sec) + " secs";

		var remainingSec = Math.ceil(sec % 60);

		return min + " mins, " + remainingSec + " secs";
	});

	Handlebars.registerHelper('if_overflow', function(content, div_height, options)
	{

		if (!content)
			return;

		console.log($('#Linkedin').width());
		content = content.trim();
		var element = $("<div style='width:" + $('#Linkedin').width() + "px;" + "word-break:normal;word-wrap:break-word;display:none;'>" + content + "</div>");

		$("#content").append(element);

		console.log(element.height() + " " + parseInt(div_height))
		if (element.height() > parseInt(div_height))
			return options.fn(this);
		return options.inverse(this);
	});

	/**
	 * To set up star rating in contacts listing
	 */
	Handlebars.registerHelper('setupRating', function(value)
	{

		var element = "";
		for (var i = 0; i < 5; i++)
		{
			if (i < parseInt(value))
			{
				element = element.concat('<li style="display: inline;"><img src="img/star-on.png" alt="' + i + '"></li>');
				continue;
			}
			element = element.concat('<li style="display: inline;"><img src="img/star-off.png" alt="' + i + '"></li>');
		}
		return new Handlebars.SafeString(element);
	});

	/**
	 * Builds options to be shown in the table heading of CSV import. Also tries
	 * to match headings in select field
	 */
	Handlebars.registerHelper('setupCSVUploadOptions', function(type, key, context)
	{
		// console.log(context.toJSON());
		var template;
		if (type == "contacts")
		{
			template = $(getTemplate('csv_upload_options', context));
		}
		else if (type == "company")
		{
			template = $(getTemplate('csv_companies_upload_options', context));
		}
		else if (type == "deals")
		{
			template = $(getTemplate('csv_deals_options', context));
		}

		// Replaces _ with spaces
		key = key.replace("_", " ");

		var isFound = false;

		var match_weight = 0;

		var key_length = key.length;
		var key = key.toLowerCase();
		var matched_value;

		var selected_element;
		template.find('option').each(function(index, element)
		{
			if ($(element).text().toLowerCase().indexOf(key) != -1)
			{

				var current_match_weight = key_length / $(element).text().length;
				if (match_weight >= current_match_weight)
					return;

				selected_element = $(element);
				matched_value = $(element).text();
				match_weight = current_match_weight;
			}
		})

		console.log(matched_value + ", " + key + " : " + match_weight);

		for (var i = 0; i < key.length - 3; i++)
		{
			template.find('option').each(function(index, element)
			{
				if ($(element).text().toLowerCase().indexOf(key.substr(0, key.length - i).toLowerCase()) != -1)
				{
					console.log(key.substr(0, key.length - i) + " , " + $(element).text());
					var current_match_weight = key.substr(0, key.length - i).length / $(element).text().length;
					console.log(current_match_weight);
					if (match_weight >= current_match_weight)
						return;
					selected_element = $(element);
					matched_value = $(element).text();
					match_weight = current_match_weight;
				}
			})
		}

		$(selected_element).attr("selected", true);

		/*
		 * // Iterates to create various combinations and check with the header
		 * for ( var i = 0; i < key.length - 3; i++) {
		 * template.find('option').each(function(index, element) { if
		 * ($(element).val().toLowerCase().indexOf(key) != -1) { isFound = true;
		 * $(element).attr("selected", true); return false; } else if
		 * ($(element).val().toLowerCase().indexOf(key.substr(0, key.length -
		 * i).toLowerCase()) != -1) { isFound = true;
		 * $(element).attr("selected", true); return false; }
		 * 
		 * }); if (isFound) break; }
		 */
		return new Handlebars.SafeString($('<div>').html(template).html());
	});

	/**
	 * Converts total seconds into hours, minutes and seconds. For e.g. 3600
	 * secs - 1hr 0 mins 0secs
	 */
	Handlebars.registerHelper('convertSecondsToHour', function(totalSec)
	{
		var hours = parseInt(totalSec / 3600) % 24;
		var minutes = parseInt(totalSec / 60) % 60;
		var seconds = totalSec % 60;

		// show only seconds if hours and mins are zero
		if (hours == 0 && minutes == 0)
			return (seconds + "s");

		// show mins and secs if hours are zero.
		if (hours == 0)
			return (minutes + "m ") + (seconds + "s");

		var result = (hours + "h ") + (minutes + "m ") + (seconds + "s");
		return result;
	});

	/**
	 * To check and return value of original referrer
	 */
	Handlebars.registerHelper('checkOriginalRef', function(original_ref)
	{
		if (!getCurrentContactProperty(original_ref))
			return "unknown";

		var url = getCurrentContactProperty(original_ref);

		url = url.split('/');
		url = (url[0] + '//' + url[2]);
		return new Handlebars.SafeString(
				'<a style="text-decoration: none" target="_blank" href="' + getCurrentContactProperty(original_ref) + '">' + url + '</a>');
	});

	/**
	 * To check google url and key words
	 */
	Handlebars.registerHelper('queryWords', function(original_ref)
	{
		// Check if original referrer exists
		if (getCurrentContactProperty(original_ref))
		{
			// Get input url from contact properties and initialize reference
			// url
			var inputUrl = getCurrentContactProperty(original_ref);
			var referenceUrl = 'www.google.';

			// Get host from input url and compare with reference url if equal
			var tempUrl = inputUrl.split('/');
			tempUrl = tempUrl[2].slice(0, 11);
			if (tempUrl === referenceUrl)
			{
				// Get search term from input url
				var parser = document.createElement('a');
				parser.href = inputUrl;
				var search = parser.search;

				// If search term exists, check if 'q' parameter exists, and
				// return its value
				if (search.length > 1)
				{
					search = search.split('&');
					var length = search.length;
					for (var i = 0; i < length; i++)
					{
						if (search[i].indexOf('q=') != -1)
						{
							search = search[i].split('=');
							return new Handlebars.SafeString('( Keyword : ' + search[1].split('+').join(" ") + ' )');
						}
					}
				}
			}
			else
				return;
		}
	});

	/**
	 * Returns contact full name if last-name exists, otherwise only first_name
	 * for contact type PERSON. It returns company name for other contact type.
	 * 
	 */
	Handlebars.registerHelper('contact_name', function(properties, type)
	{

		if (type === 'PERSON')
		{
			for (var i = 0; i < properties.length; i++)
			{

				// if last-name exists, return full name.
				if (properties[i].name === "last_name")
					return (getPropertyValue(properties, "first_name") + " " + properties[i].value);

				else if (properties[i].name === "first_name")
					return properties[i].value;
			}

			return "Contact";
		}

		// COMPANY type
		for (var i = 0; i < properties.length; i++)
		{
			if (properties[i].name === "name")
				return properties[i].value;
		}
		return "Company";
	});

	/**
	 * Returns full name of contact. Use this when empty value is not
	 * acceptable. Takes care that, even when no names are defined, returns
	 * email(necessary for PERSON) or Company <id>. Calls function
	 * getContactName defined in agile-typeahead.js. Also typeahead uses this
	 * fxn to append values as tags.
	 */
	Handlebars.registerHelper('contact_name_necessary', function(contact)
	{
		return getContactName(contact);
	});

	/**
	 * To check if string is blank
	 */
	Handlebars.registerHelper('is_blank', function(value, options)
	{
		value = value.trim();

		if (value == "")
			return options.fn(value);
		else
			return options.inverse(value);
	})

	/**
	 * Iterate through list of values (not json)
	 */
	Handlebars.registerHelper("each_with_index1", function(array, options)
	{
		console.log(array);
		var buffer = "";
		for (var i = 0, j = array.length; i < j; i++)
		{
			var item = {};
			item["value"] = array[i];

			console.log(item);
			// stick an index property onto the item, starting with 1, may make
			// configurable later
			item["index"] = i + 1;

			console.log(item);
			// show the inside of the block
			buffer += options.fn(item);
		}

		// return the finished buffer
		return buffer;

	});

	/**
	 * If log_type equals true otherwise false
	 */
	Handlebars.registerHelper("if_log_type_equals", function(object, key, log_type, options)
	{

		if (object[key] == log_type)
			return options.fn(object);

		return options.inverse(object);

	});

	/**
	 * Identifies EMAIL_SENT campaign-log string and splits the log string based
	 * on '_aGiLeCrM' delimiter into To, From, Subject and Body.
	 * 
	 */
	Handlebars.registerHelper("if_email_sent", function(object, key, options)
	{

		// delimiter for campaign send-email log
		var _AGILE_CRM_DELIMITER = "_aGiLeCrM";

		// if log_type is EMAIL_SENT
		if (object[key] === "EMAIL_SENT")
		{
			// Splits logs message
			var email_fields = object["message"].split(_AGILE_CRM_DELIMITER, 4);

			// Json to apply for handlebar template
			var json = {};

			if (email_fields === undefined)
				return options.inverse(object);

			// Iterates inorder to insert each field into json
			for (var i = 0; i < email_fields.length; i++)
			{
				// Splits based on colon. E.g "To: naresh@agilecrm.com   "
				var arrcolon = email_fields[i].split(":");

				// Inserts LHS of colon as key. E.g., To
				var key = arrcolon[0];
				key = key.trim(); // if key starts with space, it
				// can't
				// accessible

				// Inserts RHS of colon as value. E.g.,
				// naresh@agilecrm.com  
				var value = arrcolon.slice(1).join(":"); // join the
				// remaining string
				// based on colon,
				// only first occurence of colon is needed
				value = value.trim();

				json[key] = value;
			}

			// inserts time into json
			json.time = object["time"];

			// apply customized json to template.
			return options.fn(json);
		}

		// if not EMAIL_SENT log, goto else in the template
		return options.inverse(object);

	});

	Handlebars.registerHelper('remove_spaces', function(value)
	{
		if(value)
			  value = value.replace(/ +/g, '');

		return value;

	});

	Handlebars.registerHelper('replace_spaces', function(value)
	{
		if(value)
			  value = value.replace(/ +/g, '_');

		return value;
		
	});

	/***************************************************************************
	 * Returns campaignStatus object from contact campaignStatus array having
	 * same campaign-id. It is used to get start and completed time from array.
	 **************************************************************************/
	Handlebars.registerHelper('if_same_campaign', function(object, data, options)
	{

		var campaignStatusArray = object[data];

		// if campaignStatus key doesn't exist return.
		if (data === undefined || campaignStatusArray === undefined)
			return;

		// Get campaign-id from hash
		var current_campaign_id = getIdFromHash();

		for (var i = 0, len = campaignStatusArray.length; i < len; i++)
		{

			// compares campaign-id of each element of array with
			// current campaign-id
			if (campaignStatusArray[i].campaign_id === current_campaign_id)
			{
				// if equal, execute template current json
				return options.fn(campaignStatusArray[i]);
			}
		}

	});

	/**
	 * Returns other active campaigns in campaign-active subscribers.
	 */
	Handlebars.registerHelper('if_other_active_campaigns', function(object, data, options)
	{

		if (object === undefined || object[data] === undefined)
			return;

		var other_campaigns = {};
		var other_active_campaigns = [];
		var other_completed_campaigns = [];
		var campaignStatusArray = object[data];

		var current_campaign_id = getIdFromHash();

		for (var i = 0, len = campaignStatusArray.length; i < len; i++)
		{
			// neglect same campaign
			if (current_campaign_id === campaignStatusArray[i].campaign_id)
				continue;

			// push all other active campaigns
			if (campaignStatusArray[i].status.indexOf('ACTIVE') !== -1)
				other_active_campaigns.push(campaignStatusArray[i])

				// push all done campaigns
			if (campaignStatusArray[i].status.indexOf('DONE') !== -1)
				other_completed_campaigns.push(campaignStatusArray[i]);
		}

		other_campaigns["active"] = other_active_campaigns;
		other_campaigns["done"] = other_completed_campaigns;

		return options.fn(other_campaigns);

	});

	/**
	 * Returns json object of active and done subscribers from contact object's
	 * campaignStatus.
	 */
	Handlebars.registerHelper('contact_campaigns', function(object, data, options)
	{

		// if campaignStatus is not defined, return
		if (object === undefined || object[data] === undefined)
			return;

		// Temporary json to insert active and completed campaigns
		var campaigns = {};

		var active_campaigns = [];
		var completed_campaigns = [];

		// campaignStatus object of contact
		var campaignStatusArray = object[data];

		for (var i = 0, len = campaignStatusArray.length; i < len; i++)
		{
			// push all active campaigns
			if (campaignStatusArray[i].status.indexOf('ACTIVE') !== -1)
				active_campaigns.push(campaignStatusArray[i])

				// push all done campaigns
			if (campaignStatusArray[i].status.indexOf('DONE') !== -1)
				completed_campaigns.push(campaignStatusArray[i]);
		}

		campaigns["active"] = active_campaigns;
		campaigns["done"] = completed_campaigns;

		// apply obtained campaigns context within
		// contact_campaigns block
		return options.fn(campaigns);
	});

	/**
	 * Returns first occurence string from string having underscores E.g,
	 * mac_os_x to mac
	 */
	Handlebars.registerHelper('normalize_os', function(data)
	{
		if (data === undefined || data.indexOf('_') === -1)
			return data;

		// if '_' exists splits
		return data.split('_')[0];
	});

	/**
	 * Get task list name without underscore and caps, for new task UI.
	 */
	Handlebars.registerHelper('get_normal_name', function(name)
	{
		if (!name)
			return;

		var name_json = { "HIGH" : "High", "LOW" : "Low", "NORMAL" : "Normal", "EMAIL" : "Email", "CALL" : "Call", "SEND" : "Send", "TWEET" : "Tweet",
			"FOLLOW_UP" : "Follow Up", "MEETING" : "Meeting", "MILESTONE" : "Milestone", "OTHER" : "Other", "YET_TO_START" : "Yet To Start",
			"IN_PROGRESS" : "In Progress", "COMPLETED" : "Completed", "TODAY" : "Today", "TOMORROW" : "Tomorrow", "OVERDUE" : "Overdue", "LATER" : "Later" };

		name = name.trim();

		if (name_json[name])
			return name_json[name];

		return name;

	});

	/**
	 * put user address location togather separated by comma.
	 */
	Handlebars.registerHelper('user_location', function()
	{

		var City = this.city == "?" ? "" : (this.city + ", ");
		var Region = this.region == "?" ? "" : (this.region + ", ");
		var Country = this.country;
		if (this.city == "?" && this.region == "?")
			Country = this.country == "?" ? this.city_lat_long : (this.city_lat_long + " ( " + this.country + " )");

		return (City + Region + Country).trim();
	});

	/**
	 * Trims trailing spaces
	 */
	Handlebars.registerHelper('trim_space', function(value)
	{

		if (value === undefined)
			return value;

		return value.trim();
	});

	/**
	 * Returns reputation name based on value
	 * 
	 */
	Handlebars.registerHelper('get_subaccount_reputation', function(value)
	{
		var type = "bg-light dk text-tiny";
		var reputation = "Unknown";

		if (value > 1 && value < 40)
		{
			type = "label-danger text-tiny";
			reputation = "Poor";
		}
		else if (value >= 40 && value < 75)
		{
			type = "bg-light text-tiny";
			reputation = "Ok";
		}
		else if (value >= 75 && value < 90)
		{
			type = "label-success text-tiny";
			reputation = "Good";
		}
		else if (value >= 90)
		{
			type = "label-success text-tiny";
			reputation = "Excellent";
		}

		return "<span style='position: relative;' class='label " + type

		+ "'>" + reputation + "</span> <!--<span class='badge badge-" + type + "'>" + value + "</span>-->";

	});

	/**
	 * Returns id from hash. It returns id from hash iff id exists at last.
	 * 
	 */
	Handlebars.registerHelper('get_id_from_hash', function()
	{

		return getIdFromHash();

	});
	
	Handlebars.registerHelper('isAdmin',function(options)
	{
		if(CURRENT_DOMAIN_USER.is_admin){
			return options.fn(this);
		}else{
			return options.inverse(this);
		}
		 
	});

	Handlebars.registerHelper('get_subscribers_type_from_hash', function()
	{

		// Returns "workflows" from "#workflows"
		var hash = window.location.hash.substr(1);

		if (hash.indexOf("all") != -1)
			return "All";

		if (hash.indexOf("active") != -1)
			return "Active";

		if (hash.indexOf("completed") != -1)
			return "Completed";

		if (hash.indexOf("removed") != -1)
			return "Removed";

		if (hash.indexOf("unsubscribed") != -1)
			return "Unsubscribed";

		if (hash.indexOf("hardbounced") != -1)
			return "Hard Bounced";

		if (hash.indexOf("softbounced") != -1)
			return "Soft Bounced";

		if (hash.indexOf("spam-reported") != -1)
			return "Spam Reported";
	});

	Handlebars.registerHelper("check_plan", function(plan, options)
	{
		console.log(plan);

		if (!_billing_restriction)
			return options.fn(this);

		if (_billing_restriction.currentLimits.planName == plan)
			return options.fn(this);

		return options.inverse(this);

	});

	/**
	 * Safari browser doesn't supporting few CSS properties like margin-top,
	 * margin-bottom etc. So this helper is used to add compatible CSS
	 * properties to Safari
	 */
	Handlebars.registerHelper("isSafariBrowser", function(options)
	{

		if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1)
			return options.fn(this);

		return options.inverse(this);
	});

	/**
	 * give custome status base on xerotype
	 */

	Handlebars.registerHelper('xeroType', function(type)
	{
		return (type == "ACCPAY") ? "Payable" : "Receivable";
	});

	/**
	 * give custom type to xero type
	 */
	Handlebars.registerHelper('xeroTypeToolTip', function(type)
	{
		return (type == "ACCPAY") ? "Payable" : "Receivable";
	});

	/**
	 * gives first latter capital for given input
	 */
	Handlebars.registerHelper('capFirstLetter', function(data)
	{
		if (data === "DEFAULT")
		{
			// console.log("return empty");
			return "";
		}
		else
		{
			var temp = data.toLowerCase();
			return temp.charAt(0).toUpperCase() + temp.slice(1);
		}
	});

	Handlebars.registerHelper('qbStatus', function(Balance)
	{
		console.log(this);
		console.log(this.TotalAmt);
		if (Balance == 0)
		{
			return "Paid"
		}
		else
		{
			return "Due"
		}
	});
	Handlebars.registerHelper('currencyFormat', function(data)
	{

		return Number(data).toLocaleString('en');
		// data.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
	});

	Handlebars.registerHelper('formatAmount', function(data){
		data = parseFloat(data);
		return data.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,");
	});
	
	Handlebars.registerHelper('QbDateFormat', function(data)
	{

		var i = [];
		i = data.split("-");
		return i[0] + "-" + i[2] + "-" + i[1];
	});

	Handlebars.registerHelper("hasScope", function(scope_constant, options)
	{
		if (CURRENT_DOMAIN_USER.scopes && $.inArray(scope_constant, CURRENT_DOMAIN_USER.scopes) != -1)
			return options.fn(this);

		return options.inverse(this);
	});

	/**
	 * Helps to check the permission of the user based on the ACL.
	 */
	Handlebars.registerHelper("hasMenuScope", function(scope_constant, options)
	{
		if (CURRENT_DOMAIN_USER.menu_scopes && $.inArray(scope_constant, CURRENT_DOMAIN_USER.menu_scopes) != -1)
			return options.fn(this);

		return options.inverse(this);
	});

	Handlebars.registerHelper("canSyncContacts", function(options)
	{
		if (canImportContacts())
			return options.fn(this);

		return options.inverse(this);
	});

	/**
	 * To check Access controls for showing icons on dashboard
	 */
	Handlebars.registerHelper('hasMenuScope', function(item, options)
	{
		if ((CURRENT_DOMAIN_USER.menu_scopes).indexOf(item) != -1)
			return options.fn(this);
		else
			return options.inverse(this);
	});

	Handlebars.registerHelper('fetchXeroUser', function(data)
	{
		return JSON.parse(data).xeroemail;
	});

	Handlebars.registerHelper('getfbreturndomain', function(data)
	{
		var arr = window.location.href.split('/')
		return arr[2];
	});

	Handlebars
			.registerHelper(
					'tagManagementCollectionSetup',
					function(tags)
					{

						console.log(tags);
						var json = {};

						var keys = [];
						// Store tags in a json, starting letter as key
						for (var i = 0; i < tags.length; i++)
						{
							var tag = tags[i].tag;
							var key = tag.charAt(0).toUpperCase();
							// console.log(tag);
							if (jQuery.inArray(key, keys) == -1)
								keys.push(key);
						}

						console.log(keys);
						var html_temp = "";

						for (var i = 0; i < keys.length; i++)
							html_temp += "<div class=\"clearfix\"></div><div style='margin-right:10px;'><div class='tag-key tag-management-key'>" + keys[i] + "</div><div class=\"clearfix\"></div><div class='left' tag-alphabet=\"" + encodeURI(keys[i]) + "\"><ul class=\"tags-management tag-cloud\" style=\"list-style:none;\"></ul></div></div>";

						console.log(html_temp);
						return new Handlebars.SafeString(html_temp);
					});

	Handlebars.registerHelper('containsScope', function(item, list, options)
	{
		if (list.length == 0 || !item)
			return options.inverse(this);

		if (jQuery.inArray(item, list) == -1)
			return options.inverse(this);

		return options.fn(this);

	});

	Handlebars.registerHelper('isOwnerOfContact', function(owner_id, options)
	{

		if (CURRENT_DOMAIN_USER.id == owner_id)
			return options.fn(this);
		return options.inverse(this);
	});

	Handlebars.registerHelper('canEditContact', function(owner_id, options)
	{
		if (canEditContact(owner_id))
			return options.fn(this);

		return options.inverse(this)
	});

	Handlebars.registerHelper('canEditCurrentContact', function(owner_id, options)
	{
		if (canEditCurrentContact())
			return options.fn(this);

		return options.inverse(this)
	})

	Handlebars.registerHelper('gateway_exists', function(value, target, options)
	{

		for (var i = 0; i < target.length; i++)
		{

			var prefs = JSON.parse(target[i].prefs);

			if (target[i].name == "EmailGateway")
			{

				if (prefs.email_api == value)
					return options.fn(target[i]);
			}

			if (target[i].name == "SMS-Gateway")
			{
				if (prefs.sms_api == value)
					return options.fn(target[i]);
			}
		}
		return options.inverse(this);
	});

	Handlebars.registerHelper("each_index_slice", function(array, index, options)
	{
		var buffer = "";
		for (var i = index; i < array.length; i++)
		{
			var item = array[i];

			// stick an index property onto the item, starting with 1, may make
			// configurable later
			// item.index = i + 1;

			console.log(item);
			// show the inside of the block
			buffer += options.fn(item);
		}

		// return the finished buffer
		return buffer;

	});

	Handlebars.registerHelper('gateway_exists', function(value, target, options)
	{

		for (var i = 0; i < target.length; i++)
		{

			var prefs = JSON.parse(target[i].prefs);

			if (target[i].name == "EmailGateway")
			{

				if (prefs.email_api == value)
					return options.fn(target[i]);
			}

			if (target[i].name == "SMS-Gateway")
			{
				if (prefs.sms_api == value)
					return options.fn(target[i]);
			}
		}
		return options.inverse(this);
	});

	Handlebars.registerHelper('isOwnerOfContact', function(owner_id, options)
	{

		if (CURRENT_DOMAIN_USER.id == owner_id)
			return options.fn(this);
		return options.inverse(this);
	});

	Handlebars.registerHelper('canEditContact', function(owner_id, options)
	{
		if ((hasScope('UPDATE_CONTACTS') || hasScope('DELETE_CONTACTS')) || CURRENT_DOMAIN_USER.id == owner_id)
			return options.fn(this);

		return options.inverse(this)
	});

	Handlebars.registerHelper('getAccountPlanName', function(plan_name)
	{
		if (!plan_name)
			return "Free";

		var plan_fragments = plan_name.split("_");

		return ucfirst(plan_fragments[0]);

	});

	Handlebars.registerHelper('getAccountPlanInteval', function(plan_name)
	{
		if (!plan_name)
			return "Monthly";

		var plan_fragments = plan_name.split("_");

		return ucfirst(plan_fragments[1]);

	});		

	Handlebars.registerHelper('getSubscriptionBasedOnPlan', function(customer, plan, options)
	{
		var subscription = getSubscriptionWithAmount(customer, plan);

		if (subscription != null)
			return options.fn(subscription);

		return options.inverse(this);
	});

	// handling with iso date
	Handlebars.registerHelper("iso_date_to_normalizeDate", function(dateString)
	{

		/*
		 * var myDate = new Date(dateString); var timestamp = myDate.getTime();
		 * var d = new Date(parseInt(timestamp) / 1000).format("dd-MM-yyyy");
		 * return d;
		 */
		if (dateString.length <= 0)
			return;
		var arr = dateString.split("T");
		console.log("normalize date " + arr[0]);
		// var d = new Date(arr[0]).format("dd-MM-yyyy");
		return arr[0];

	});

	/**
	 * Index starts from 1
	 */
	Handlebars.registerHelper("getMonthFromIndex", function(month_index)
	{
		var monthArray = [
				"January", "february", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
		];
		if (month_index > 12)
			return monthArray[11];

		return monthArray[month_index - 1];
	});

	Handlebars.registerHelper('xeroOrganisationShortCode', function(block)
	{
		if (typeof SHORT_CODE == "undefined" || SHORT_CODE == "")
		{
			return false;
		}
		else
		{
			return SHORT_CODE;
		}
	});
	Handlebars.registerHelper('if_id', function(ctype, options)
	{
		if (this.type == ctype)
		{
			return options.fn(this);
		}
	});

	/**
	 * extract time from epochTime
	 */
	Handlebars.registerHelper("getTime", function(date)
	{

		if (!date)
			return;

		if ((date / 100000000000) > 1)
		{
			var d = new Date(parseInt(date));
			var hours = d.getHours();
			if (hours > 12)
				hours = hours - 12;
			var min = d.getMinutes();
			if (min == 0)
				min = "00"
			var ampm = hours >= 12 ? "PM" : "AM";
			return hours + ":" + min + " " + ampm;
		}
		// date form milliseconds

		var d = new Date(parseInt(date) * 1000);
		var hours = d.getHours();
		if (hours > 12)
			hours = hours - 12;
		var min = d.getMinutes();
		if (min == 0)
			min = "00"
		var ampm = hours >= 12 ? "PM" : "AM";
		return hours + ":" + min + " " + ampm;

	});

	/**
	 * get custom date with time
	 */

	Handlebars.registerHelper("getCustomDateWithTime", function(start, end)
	{
		var day1 = getDay(start);
		var day2 = getDay(end);

		var d1 = getCustomFormatedDate(start);
		var d2 = getCustomFormatedDate(end);
		var time = extractTimeFromDate(end);

		if (day1 != day2)
			return d1 + " - " + d2;
		else
			return d1 + " - " + time;

	});

	function getCustomFormatedDate(date)
	{

		var months = [
				'Jan', 'Feb', 'March', 'April', 'May', 'Jun', 'July', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'
		];

		if (!date)
			return;

		if ((date / 100000000000) > 1)
		{
			var d = new Date(parseInt(date));
			var hours = d.getHours();
			var year = d.getFullYear();
			var date = d.getDate();
			var month = d.getMonth();
			var min = d.getMinutes();
			if (min == 0)
				min = "00"
			var ampm = hours >= 12 ? "PM" : "AM";
			if (hours > 12)
				hours = hours - 12;
			return months[month] + " " + date + ", " + year + " " + hours + ":" + min + " " + ampm;

		}
		// date form milliseconds

		var d = new Date(parseInt(date) * 1000);
		var hours = d.getHours();
		var year = d.getFullYear();
		var date = d.getDate();
		var month = d.getMonth();
		var min = d.getMinutes();
		if (min == 0)
			min = "00"
		var ampm = hours >= 12 ? "PM" : "AM";
		if (hours > 12)
			hours = hours - 12;
		return months[month] + " " + date + ", " + year + " " + hours + ":" + min + " " + ampm;

	}
	function extractTimeFromDate(date)
	{
		if (!date)
			return;

		if ((date / 100000000000) > 1)
		{
			var d = new Date(parseInt(date));
			var hours = d.getHours();

			var min = d.getMinutes();
			if (min == 0)
				min = "00"
			var ampm = hours >= 12 ? "PM" : "AM";
			if (hours > 12)
				hours = hours - 12;
			return hours + ":" + min + " " + ampm;
		}
		// date form milliseconds

		var d = new Date(parseInt(date) * 1000);
		var hours = d.getHours();
		var min = d.getMinutes();
		if (min == 0)
			min = "00"
		var ampm = hours >= 12 ? "PM" : "AM";
		if (hours > 12)
			hours = hours - 12;
		return hours + ":" + min + " " + ampm;
	}

	function getDay(date)
	{
		if ((date / 100000000000) > 1)
		{
			var sDate = new Date(parseInt(date));
			return sDate.getDate();
		}
		else
		{
			var sDate = new Date(parseInt(date) * 1000);
			return sDate.getDate();
		}
	}

	Handlebars.registerHelper('buildOptions', function(field_data)
	{
		var list_values = field_data.split(";");
		var list_options = '';
		// Create options based on list values
		$.each(list_values, function(index, value)
		{
			if (value != "")
				list_options = list_options.concat('<option value="' + value + '">' + value + '</option>');
		});

		return list_options;
	});

	Handlebars.registerHelper('address_Template', function(properties)
	{

		for (var i = 0, l = properties.length; i < l; i++)
		{

			if (properties[i].name == "address")
			{
				var el = '';

				var address = {};
				try
				{
					address = JSON.parse(properties[i].value);
				}
				catch (err)
				{
					address['address'] = properties[i].value;
				}

				// Gets properties (keys) count of given json
				// object
				var count = countJsonProperties(address);

				$.each(address, function(key, val)
				{
					if (--count == 0)
					{
						el = el.concat(val + ".");
						return;
					}
					el = el.concat(val + ", ");
				});
				/*
				 * if (properties[i].subtype) el = el.concat(" <span
				 * class='label'>" + properties[i].subtype + "</span>");
				 */

				return new Handlebars.SafeString(el);
			}
		}
	});

	// To show related to contacts for contacts as well as companies
	Handlebars.registerHelper('related_to_contacts', function(data, options)
	{
		var el = "";
		var count = data.length;
		$.each(data, function(key, value)
		{
			var html = getTemplate("related-to-contacts", value);
			if (--count == 0)
			{
				el = el.concat(html);
				return;
			}
			el = el.concat(html + ", ");
		});
		return new Handlebars.SafeString(el);
	});

	// To show only one related to contacts or companies in deals
	Handlebars.registerHelper('related_to_one', function(data, options)
	{
		// return "<span>" + getTemplate("related-to-contacts", data[0]) +
		// "</span>";
		var el = "";
		var count = data.length;
		$.each(data, function(key, value)
		{
			if (key <= 3)
			{
				var html = getTemplate("related-to-contacts", value);
				if (--count == 0 || key == 3)
				{
					el = el.concat(html);
					return;
				}
				el = el.concat(html + ", ");
			}

		});
		return new Handlebars.SafeString(el);

	});

	/**
	 * To represent a number with commas in deals
	 */
	Handlebars.registerHelper('numberWithCommas', function(value)
	{
		if (value)
			return value.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g, ",").replace('.00', '');
	});

	/**
	 * Converts reports/view field element as comma seprated values and returns
	 * as handlebars safe string.
	 */
	Handlebars.registerHelper('field_Element', function(properties)
	{
		var el = "";
		var count = properties.length;

		$.each(properties, function(key, value)
		{

			if (value.indexOf("properties_") != -1)
				value = value.split("properties_")[1];
			else if (value.indexOf("custom_") != -1)
				value = value.split("custom_")[1];
			else if (value.indexOf("CUSTOM_") != -1)
				value = value.split("CUSTOM_")[1];
			else if (value == "created_time")
				value = "Created Date";
			else if (value == "updated_time")
				value = "Updated Date";

			value = value.replace("_", " ");

			if (--count == 0)
			{
				el = el.concat(value);
				return;
			}
			el = el.concat(value + ", ");
		});

		return new Handlebars.SafeString(el);
	});

	/**
	 * Converts string to JSON
	 */
	Handlebars.registerHelper('stringToJSON', function(object, key, options)
	{
		console.log(object);
		console.log(key);
		if (key)
		{
			try
			{

				object[key] = JSON.parse(object[key]);
			}
			finally
			{
				return options.fn(object[key]);
			}
		}

		try
		{
			return options.fn(JSON.parse(object));
		}
		catch (err)
		{
			return options.fn(object);
		}
	});

	/**
	 * Checks the existence of property name and prints value
	 */
	Handlebars.registerHelper('if_propertyName', function(pname, options)
	{
		for (var i = 0; i < this.properties.length; i++)
		{
			if (this.properties[i].name == pname)
				return options.fn(this.properties[i]);
		}
		return options.inverse(this);
	});

	/*
	 * Gets company image from a contact object.
	 * 
	 * --If image uploaded, returns that ( the frame size requested ). --Else if
	 * url present, fetch icon from the url via Google S2 service (frame
	 * size=32x32) --Else return img/company.png ( the frame size requested ).
	 * 
	 * --CSS for frame is adjusted when fetching from url ( default padding =
	 * 4px , now 4+adjust ). --'onError' is an attribute (js function) fired
	 * when image fails to download, maybe due to remote servers being down It
	 * defaults to img/company.png which should be present in server as static
	 * file
	 * 
	 * Usage: e.g. <img {{getCompanyImage "40" "display:inline"}} class="..."
	 * ... >
	 * 
	 * This helper sets src,onError & style attribute. "40" is full frame size
	 * requested. Additional styles like "display:inline;" or "display:block;"
	 * can be specified in 2nd param.
	 * 
	 * @author Chandan
	 */
	Handlebars
			.registerHelper(
					'getCompanyImage',
					function(frame_size, additional_style)
					{

						var full_size = parseInt(frame_size); // size
						// requested,full
						// frame
						var size_diff = 4 + ((full_size - 32) / 2); // calculating
						// padding,
						// for small
						// favicon
						// 16x16 as
						// 32x32,
						// fill rest frame with padding

						// default when we can't find image uploaded or url to
						// fetch from
						var default_return = "src='img/company.png' style='width:" + full_size + "px; height=" + full_size + "px;" + additional_style + "'";

						// when the image from uploaded one or favicon can't be
						// fetched, then show company.png, adjust CSS ( if style
						// broken by favicon ).
						var error_fxn = "";

						for (var i = 0; i < this.properties.length; i++)
						{
							if (this.properties[i].name == "image")
							{
								default_return = "src='" + this.properties[i].value + "' style='width:" + full_size + "px; height=" + full_size + "px;" + additional_style + ";'";
								// found uploaded image, break, no need to
								// lookup url

								error_fxn = "this.src='img/company.png'; this.onerror=null;";
								// no need to resize, company.png is of good
								// quality & can be scaled to this size

								break;
							}
							if (this.properties[i].name == "url")
							{
								default_return = "src='https://www.google.com/s2/favicons?domain=" + this.properties[i].value + "' " + "style='width:" + full_size + "px; height=" + full_size + "px; padding:" + size_diff + "px; " + additional_style + " ;'";
								// favicon fetch -- Google S2 Service, 32x32,
								// rest padding added

								error_fxn = "this.src='img/company.png'; " + "$(this).css('width','" + frame_size + "px'); $(this).css('height','" + frame_size + "px');" + "$(this).css('padding','4px'); this.onerror=null;";
								// resize needed as favicon is 16x16 & scaled to
								// just 32x32, company.png is adjusted on error
							}
						}
						// return safe string so that our html is not escaped
						return new Handlebars.SafeString(default_return + " onError=\"" + error_fxn + "\"");
					});

	/**
	 * Get appropriate link i.e. protocol://whatever.xxx. If no protocol
	 * present, assume http
	 */
	Handlebars.registerHelper('getHyperlinkFromURL', function(url)
	{
		if (url.match(/((http|http[s]|ftp|file):\/\/)/) != null)
			return url;
		return 'http://' + url;
	});

	Handlebars.registerHelper('getSkypeURL', function(url)
	{
		if (url.match("skype:") != null)
			return url;
		return 'skype:' + url;
	});

	Handlebars.registerHelper('getFacebookURL', function(url)
	{
		return url.replace('@', '');
	});

	// Get Count
	Handlebars.registerHelper('count', function()
	{
		return getCount(this);
	});

	Handlebars
			.registerHelper(
					'contacts_count',
					function()
					{
						var count_message;
						if (this[0] && this[0].count && (this[0].count != -1))
						{

							if (this[0].count > 9999 && (readCookie('contact_filter') || readData('dynamic_contact_filter')))
								count_message = "<small> (" + 10000 + "+ Total) </small>" + '<span style="vertical-align: text-top; margin-left: -5px">' + '<img border="0" src="/img/help.png"' + 'style="height: 10px; vertical-align: middle" rel="popover"' + 'data-placement="bottom" data-title="Lead Score"' + 'data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."' + 'id="element" data-trigger="hover">' + '</span>';

							else
								count_message = "<small> (" + this[0].count + " Total) </small>";
						}
						else
							count_message = "<small> (" + this.length + " Total) </small>";

						return new Handlebars.SafeString(count_message);
					});

	Handlebars.registerHelper('duplicate_contacts_count', function()
	{
		var count_message;
		if (this[0] && this[0].count && (this[0].count != -1))
		{
			var count = this[0].count - 1;
			count_message = "<small> (" + count + " Total) </small>";
		}
		else
			count_message = "<small> (" + this.length + " Total) </small>";

		return new Handlebars.SafeString(count_message);
	});

	/**
	 * 
	 * Returns subscribers count without parenthesis
	 * 
	 */
	Handlebars.registerHelper('subscribers_count', function()
	{

		if (this[0] && this[0].count && (this[0].count != -1))
			return this[0].count;

		return this.length;

	});

	/**
	 * Convert string to lower case
	 */
	Handlebars.registerHelper('toLowerCase', function(value)
	{
		if (!value)
			return;
		return value.toLowerCase();
	});

	/**
	 * Convert string to lower case
	 */
	Handlebars.registerHelper('toUpperCase', function(value)
	{
		if (!value)
			return;
		return value.toUpperCase();
	});

	/**
	 * Executes template, based on contact type (person or company)
	 */
	Handlebars.registerHelper('if_contact_type', function(ctype, options)
	{
		if (this.type == ctype)
		{
			return options.fn(this);
		}
	});

	/**
	 * Executes template, based on contact type (person or company)
	 */
	Handlebars.registerHelper('collection_contact_type', function(ctype, options)
	{

		if (this && this[0] && this[0].type == ctype)
			return options.fn(this);

	});

	Handlebars.registerHelper('wrap_entity', function(item, options)
	{

		if (item)
			return options.fn(item);
	});

	/**
	 * Returns modified message for timeline logs
	 */
	Handlebars.registerHelper('tl_log_string', function(string)
	{

		return string.replace("Sending email From:", "Email sent From:");
	});

	/**
	 * Returns "Lead Score" of a contact, when it is greater than zero only
	 */
	Handlebars.registerHelper('lead_score', function(value)
	{
		if (this.lead_score > 0)
			return this.lead_score;
		else
			return "";
	});

	/**
	 * Returns task completion status (Since boolean false is not getting
	 * printed, converted it into string and returned.)
	 */
	Handlebars.registerHelper('task_status', function(status)
	{
		if (status)
			return true;

		// Return false as string as the template can not print boolean false
		return "false";

	});

	/**
	 * Compares the arguments (value and target) and executes the template based
	 * on the result (used in contacts typeahead)
	 */
	Handlebars.registerHelper('if_equals', function(value, target, options)
	{

		/*
		 * console.log("typeof target: " + typeof target + " target: " +
		 * target); console.log("typeof value: " + typeof value + " value: " +
		 * value);
		 */
		/*
		 * typeof is used beacuse !target returns true if it is empty string,
		 * when string is empty it should not go undefined
		 */
		if ((typeof target === "undefined") || (typeof value === "undefined"))
			return options.inverse(this);

		if (value.toString().trim() == target.toString().trim())
			return options.fn(this);
		else
			return options.inverse(this);
	});
	Handlebars.registerHelper('if_not_equals', function(value, target, options)
	{

		if ((typeof target === "undefined") || (typeof value === "undefined"))
			return options.inverse(this);

		if (value.toString().trim() != target.toString().trim())
			return options.fn(this);
		else
			return options.inverse(this);
	});

	/**
	 * Compares the arguments (value and target) and executes the template based
	 * on the result (used in contacts typeahead)
	 */
	Handlebars.registerHelper('if_greater', function(value, target, options)
	{
		if (parseInt(target) > value)
			return options.inverse(this);
		else
			return options.fn(this);
	});

	/**
	 * Compares the arguments (value and target) and executes the template based
	 * on the result (used in contacts typeahead)
	 */
	Handlebars.registerHelper('if_less_than', function(value, target, options)
	{
		if (target < value)
			return options.inverse(this);
		else
			return options.fn(this);
	});

	Handlebars.registerHelper('if_keyboard_shortcuts_enabled', function(options)
	{
		if (CURRENT_USER_PREFS.keyboard_shotcuts)
			return options.fn(this);
		return options.inverse(this);
	});

	Handlebars.registerHelper('campaigns_heading', function(value, options)
	{
		var val = 0;
		if (value && value[0] && value[0].count)
			val = value[0].count;

		if (val <= 20)
			return "Workflows";

		return "(" + val + " Total)";
	});

	/**
	 * Adds Custom Fields to forms, where this helper function is called
	 */
	Handlebars.registerHelper('show_custom_fields', function(custom_fields, properties)
	{

		var el = show_custom_fields_helper(custom_fields, properties);
		return new Handlebars.SafeString(fill_custom_field_values($(el), properties));

	});

	Handlebars.registerHelper('is_link', function(value, options)
	{

		var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;

		if (value.search(exp) != -1)
			return options.fn(this);
		else
			return options.inverse(this);
	});

	Handlebars.registerHelper('show_link_in_statement', function(value)
	{

		var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;

		try
		{
			value = value.replace(exp, "<a href='$1' target='_blank' class='cd_hyperlink'>$1</a>");
			return new Handlebars.SafeString(value);
		}
		catch (err)
		{
			return value;
		}

	});

	/**
	 * Returns table headings for custom contacts list view
	 */
	Handlebars.registerHelper('displayPlan', function(value)
	{

		return ucfirst(value).replaceAll("_", " ");

	});

	/**
	 * Returns plain text removes underscore from text
	 */
	Handlebars.registerHelper('displayPlainText', function(value)
	{

		return ucfirst(value).replace("_", " ");

	});

	Handlebars.registerHelper('getCurrentContactProperty', function(value)
	{
		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model)
		{
			var contact_properties = App_Contacts.contactDetailView.model.get('properties')
			console.log(App_Contacts.contactDetailView.model.toJSON());
			return getPropertyValue(contact_properties, value);
		}
	});

	Handlebars.registerHelper('safe_string', function(data)
	{

		data = data.replace(/\n/, "<br/>");
		return new Handlebars.SafeString(data);
	});

	Handlebars.registerHelper('string_to_date', function(format, date)
	{

		return new Date(date).format(format);
	});

	Handlebars.registerHelper('isArray', function(data, options)
	{
		if (isArray(data))
			return options.fn(this);
		return options.inverse(this);
	});

	Handlebars.registerHelper('is_string', function(data, options)
	{
		if (typeof data == "string")
			return options.fn(this);
		return options.inverse(this);

	});

	Handlebars.registerHelper("bindData", function(data)
	{

		return JSON.stringify(data);
	});

	Handlebars.registerHelper("getCurrentUserPrefs", function(options)
	{
		if (CURRENT_USER_PREFS)
			;
		return options.fn(CURRENT_USER_PREFS);
	});

	Handlebars.registerHelper("getCurrentDomain", function(options)
	{

		var url = window.location.host;

		var exp = /(\.)/;

		if (url.search(exp) >= 0)
			return url.split(exp)[0];

		return " ";
	});

	// Gets date in given range
	Handlebars.registerHelper('date-range', function(from_date_string, no_of_days, options)
	{
		var from_date = Date.parse(from_date_string);
		var to_date = Date.today().add({ days : parseInt(no_of_days) });
		return to_date.toString('MMMM d, yyyy') + " - " + from_date.toString('MMMM d, yyyy');

	});

	Handlebars.registerHelper("extractEmail", function(content, options)
	{

		console.log(content);

		return options.fn(content.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)[0]);
	});

	Handlebars.registerHelper('if_keyboard_shortcuts_enabled', function(options)
	{
		if (CURRENT_USER_PREFS.keyboard_shotcuts)
			return options.fn(this);
		return options.inverse(this);
	});

	Handlebars.registerHelper('getCurrentContactPropertyBlock', function(value, options)
	{
		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model)
		{
			var contact_properties = App_Contacts.contactDetailView.model.get('properties')
			console.log(App_Contacts.contactDetailView.model.toJSON());
			return options.fn(getPropertyValue(contact_properties, value));
		}
	});

	Handlebars.registerHelper('isDuplicateContactProperty', function(properties, key, options)
	{
		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model)
		{
			var contact_properties = App_Contacts.contactDetailView.model.get('properties')
			var currentContactEntity = getPropertyValue(contact_properties, key);
			var contactEntity = getPropertyValue(properties, key);

			if (!currentContactEntity || !contactEntity)
			{
				currentContactEntity = getPropertyValue(contact_properties, "first_name") + " " + getPropertyValue(contact_properties, "last_name");
				contactEntity = getPropertyValue(properties, "first_name") + " " + getPropertyValue(properties, "last_name");
			}
			
			if(App_Contacts.contactDetailView.model.get('type') == 'COMPANY')
			{
				currentContactEntity = getPropertyValue(contact_properties, "name") ;
				contactEntity = getPropertyValue(properties, "name");
			}

			if (currentContactEntity == contactEntity)
				return options.fn(this);

			return options.inverse(this)
		}
	});

	Handlebars.registerHelper('containString', function(value, target, options)
	{
		if (target.search(value) != -1)
			return options.fn(this);

		return options.inverse(this);
	});
	Handlebars.registerHelper('is_emailPlan', function(planId, options)
	{

		if (planId.search("email") != -1)
			return options.fn(this);

		return options.inverse(this);

	});
	Handlebars.registerHelper('is_userPlan', function(planId, options)
	{
		if (planId.search("email") != -1)
			return options.inverse(this);
		return options.fn(this);

	});

	Handlebars.registerHelper('numeric_operation', function(operand1, operand2, operator)
	{

		var operators = "/*-+";

		if (operators.indexOf(operator) == -1)
			return "";

		if (operator == "+")
			return operand1 + operand2;

		if (operator == "-")
			return operand1 - operand2;

		if (operator == "*")
			return operand1 * operand2;

		if (operator == "/")
			return operand1 / operand2;
	});
	Handlebars.registerHelper('get_total_amount', function(operand1, operand2)
	{

		return (operand1 / 100) * operand2;
	});

	Handlebars.registerHelper('check_length', function(content, length, options)
	{

		if (parseInt(content.length) > parseInt(length))
			return options.fn(this);

		return options.inverse(this);
	});

	Handlebars.registerHelper('check_json_length', function(content, length, options)
	{
		var json_length = 0;
		for ( var prop in content)
		{
			json_length++;
		}

		if (json_length == parseInt(length))
		{
			for ( var prop in content)
			{
				return options.fn({ property : prop, value : content[prop], last : true });
			}
		}

		return options.inverse(content);
	});

	Handlebars.registerHelper('iterate_json', function(context, options)
	{
		var result = "";
		var count = 0;
		var length = 0;
		for ( var prop in context)
		{
			length++;
		}

		for ( var prop in context)
		{
			count++;
			if (count == length)
				result = result + options.fn({ property : prop, value : context[prop], last : true });
			else
				result = result + options.fn({ property : prop, value : context[prop], last : false });

		}

		console.log(result);
		return result;
	});

	Handlebars.registerHelper('get_social_icon', function(name)
	{
		return get_social_icon(name);

	});

	Handlebars.registerHelper("each_with_index", function(array, options)
	{
		var buffer = "";
		for (var i = 0, j = array.length; i < j; i++)
		{
			var item = array[i];

			// stick an index property onto the item, starting with 1, may make
			// configurable later
			item.index = i + 1;

			console.log(item);
			// show the inside of the block
			buffer += options.fn(item);
		}

		// return the finished buffer
		return buffer;

	});

	Handlebars.registerHelper('if_json', function(context, options)
	{

		try
		{
			var json = $.parseJSON(context);

			if (typeof json === 'object')
				return options.fn(this);
			return options.inverse(this);
		}
		catch (err)
		{
			return options.inverse(this);
		}
	});

	Handlebars.registerHelper('add_tag', function(tag)
	{
		addTagAgile(tag);
	});

	Handlebars.registerHelper('set_up_dashboard_padcontent', function(key)
	{
		return new Handlebars.SafeString(getTemplate("empty-collection-model", CONTENT_JSON.dashboard[key]));
	});

	/**
	 * Removes surrounded square brackets
	 */
	Handlebars.registerHelper('removeSquareBrackets', function(value)
	{
		return value.replace(/[\[\]]+/g, '');
	});

	/**
	 * Removes "" with single quotes brackets
	 */
	Handlebars.registerHelper('removeDoubleCoutes', function(value)
	{
		var strings = value.replace(/[\[\]]+/g, '');
		var charwithsinglequote = strings.replace(/"/g, "'");
		return charwithsinglequote;
	});

	/**
	 * Shows list of triggers separated by comma
	 */
	Handlebars.registerHelper('toLinkTrigger', function(context, options)
	{
		var ret = "";
		for (var i = 0, j = context.length; i < j; i++)
		{
			ret = ret + options.fn(context[i]);

			// Avoid comma appending to last element
			if (i < j - 1)
			{
				ret = ret + ", ";
			}
			;
		}
		return ret;
	});

	// Gets minutes from milli seconds
	Handlebars.registerHelper('millSecondsToMinutes', function(timeInMill)
	{
		if (isNaN(timeInMill))
			return;
		var sec = timeInMill / 1000;
		var min = Math.floor(sec / 60);

		if (min < 1)
			return Math.ceil(sec) + " secs";

		var remainingSec = Math.ceil(sec % 60);

		return min + " mins, " + remainingSec + " secs";
	});

	Handlebars.registerHelper('if_overflow', function(content, div_height, options)
	{

		if (!content)
			return;

		console.log($('#Linkedin').width());
		content = content.trim();
		var element = $("<div style='width:" + $('#Linkedin').width() + "px;" + "word-break:normal;word-wrap:break-word;display:none;'>" + content + "</div>");

		$("#content").append(element);

		console.log(element.height() + " " + parseInt(div_height))
		if (element.height() > parseInt(div_height))
			return options.fn(this);
		return options.inverse(this);
	});

	/**
	 * To set up star rating in contacts listing
	 */
	Handlebars.registerHelper('setupRating', function(value)
	{

		var element = "";
		for (var i = 0; i < 5; i++)
		{
			if (i < parseInt(value))
			{
				element = element.concat('<li style="display: inline;"><img src="img/star-on.png" alt="' + i + '"></li>');
				continue;
			}
			element = element.concat('<li style="display: inline;"><img src="img/star-off.png" alt="' + i + '"></li>');
		}
		return new Handlebars.SafeString(element);
	});

	/**
	 * Builds options to be shown in the table heading of CSV import. Also tries
	 * to match headings in select field
	 */
	Handlebars.registerHelper('setupCSVUploadOptions', function(type, key, context)
	{
		// console.log(context.toJSON());
		var template;
		if (type == "contacts")
		{
			getTemplate('csv_upload_options', context, undefined, function(template_ui){
		 		if(!template_ui)
		    		return;
		    	template = $(template_ui);
				
			}, null);

		}
		else if (type == "company")
		{
			getTemplate('csv_companies_upload_options', context, undefined, function(template_ui){
		 		if(!template_ui)
		    		return;
		    	template = $(template_ui);
				
			}, null);
		}
		else if (type == "deals")
		{
			getTemplate('csv_deals_options', context, undefined, function(template_ui){
		 		if(!template_ui)
		    		return;
		    	template = $(template_ui);
				
			}, null);
		}

		// Replaces _ with spaces
		key = key.replace("_", " ");

		var isFound = false;

		var match_weight = 0;

		var key_length = key.length;
		var key = key.toLowerCase();
		var matched_value;

		var selected_element;
		template.find('option').each(function(index, element)
		{
			if ($(element).text().toLowerCase().indexOf(key) != -1)
			{

				var current_match_weight = key_length / $(element).text().length;
				if (match_weight >= current_match_weight)
					return;

				selected_element = $(element);
				matched_value = $(element).text();
				match_weight = current_match_weight;
			}
		})

		console.log(matched_value + ", " + key + " : " + match_weight);

		for (var i = 0; i < key.length - 3; i++)
		{
			template.find('option').each(function(index, element)
			{
				if ($(element).text().toLowerCase().indexOf(key.substr(0, key.length - i).toLowerCase()) != -1)
				{
					console.log(key.substr(0, key.length - i) + " , " + $(element).text());
					var current_match_weight = key.substr(0, key.length - i).length / $(element).text().length;
					console.log(current_match_weight);
					if (match_weight >= current_match_weight)
						return;
					selected_element = $(element);
					matched_value = $(element).text();
					match_weight = current_match_weight;
				}
			})
		}

		$(selected_element).attr("selected", true);

		/*
		 * // Iterates to create various combinations and check with the header
		 * for ( var i = 0; i < key.length - 3; i++) {
		 * template.find('option').each(function(index, element) { if
		 * ($(element).val().toLowerCase().indexOf(key) != -1) { isFound = true;
		 * $(element).attr("selected", true); return false; } else if
		 * ($(element).val().toLowerCase().indexOf(key.substr(0, key.length -
		 * i).toLowerCase()) != -1) { isFound = true;
		 * $(element).attr("selected", true); return false; }
		 * 
		 * }); if (isFound) break; }
		 */
		return new Handlebars.SafeString($('<div>').html(template).html());
	});

	/**
	 * Converts total seconds into hours, minutes and seconds. For e.g. 3600
	 * secs - 1hr 0 mins 0secs
	 */
	Handlebars.registerHelper('convertSecondsToHour', function(totalSec)
	{
		var hours = parseInt(totalSec / 3600) % 24;
		var minutes = parseInt(totalSec / 60) % 60;
		var seconds = totalSec % 60;

		// show only seconds if hours and mins are zero
		if (hours == 0 && minutes == 0)
			return (seconds + "s");

		// show mins and secs if hours are zero.
		if (hours == 0)
			return (minutes + "m ") + (seconds + "s");

		var result = (hours + "h ") + (minutes + "m ") + (seconds + "s");
		return result;
	});

	/**
	 * To check and return value of original referrer
	 */
	Handlebars.registerHelper('checkOriginalRef', function(original_ref)
	{
		if (!getCurrentContactProperty(original_ref))
			return "unknown";

		var url = getCurrentContactProperty(original_ref);

		url = url.split('/');
		url = (url[0] + '//' + url[2]);
		return new Handlebars.SafeString(
				'<a style="text-decoration: none" target="_blank" href="' + getCurrentContactProperty(original_ref) + '">' + url + '</a>');
	});

	/**
	 * To check google url and key words
	 */
	Handlebars.registerHelper('queryWords', function(original_ref)
	{
		// Check if original referrer exists
		if (getCurrentContactProperty(original_ref))
		{
			// Get input url from contact properties and initialize reference
			// url
			var inputUrl = getCurrentContactProperty(original_ref);
			var referenceUrl = 'www.google.';

			// Get host from input url and compare with reference url if equal
			var tempUrl = inputUrl.split('/');
			tempUrl = tempUrl[2].slice(0, 11);
			if (tempUrl === referenceUrl)
			{
				// Get search term from input url
				var parser = document.createElement('a');
				parser.href = inputUrl;
				var search = parser.search;

				// If search term exists, check if 'q' parameter exists, and
				// return its value
				if (search.length > 1)
				{
					search = search.split('&');
					var length = search.length;
					for (var i = 0; i < length; i++)
					{
						if (search[i].indexOf('q=') != -1)
						{
							search = search[i].split('=');
							return new Handlebars.SafeString('( Keyword : ' + search[1].split('+').join(" ") + ' )');
						}
					}
				}
			}
			else
				return;
		}
	});

	/**
	 * Returns contact full name if last-name exists, otherwise only first_name
	 * for contact type PERSON. It returns company name for other contact type.
	 * 
	 */
	Handlebars.registerHelper('contact_name', function(properties, type)
	{

		if (type === 'PERSON')
		{
			for (var i = 0; i < properties.length; i++)
			{

				// if last-name exists, return full name.
				if (properties[i].name === "last_name")
					return (getPropertyValue(properties, "first_name") + " " + properties[i].value);

				else if (properties[i].name === "first_name")
					return properties[i].value;
			}

			return "Contact";
		}

		// COMPANY type
		for (var i = 0; i < properties.length; i++)
		{
			if (properties[i].name === "name")
				return properties[i].value;
		}
		return "Company";
	});

	/**
	 * Returns full name of contact. Use this when empty value is not
	 * acceptable. Takes care that, even when no names are defined, returns
	 * email(necessary for PERSON) or Company <id>. Calls function
	 * getContactName defined in agile-typeahead.js. Also typeahead uses this
	 * fxn to append values as tags.
	 */
	Handlebars.registerHelper('contact_name_necessary', function(contact)
	{
		return getContactName(contact);
	});

	/**
	 * To check if string is blank
	 */
	Handlebars.registerHelper('is_blank', function(value, options)
	{
		value = value.trim();

		if (value == "")
			return options.fn(value);
		else
			return options.inverse(value);
	})

	/**
	 * Iterate through list of values (not json)
	 */
	Handlebars.registerHelper("each_with_index1", function(array, options)
	{
		console.log(array);
		var buffer = "";
		for (var i = 0, j = array.length; i < j; i++)
		{
			var item = {};
			item["value"] = array[i];

			console.log(item);
			// stick an index property onto the item, starting with 1, may make
			// configurable later
			item["index"] = i + 1;

			console.log(item);
			// show the inside of the block
			buffer += options.fn(item);
		}

		// return the finished buffer
		return buffer;

	});

	/**
	 * If log_type equals true otherwise false
	 */
	Handlebars.registerHelper("if_log_type_equals", function(object, key, log_type, options)
	{

		if (object[key] == log_type)
			return options.fn(object);

		return options.inverse(object);

	});

	/**
	 * Identifies EMAIL_SENT campaign-log string and splits the log string based
	 * on '_aGiLeCrM' delimiter into To, From, Subject and Body.
	 * 
	 */
	Handlebars.registerHelper("if_email_sent", function(object, key, options)
	{

		// delimiter for campaign send-email log
		var _AGILE_CRM_DELIMITER = "_aGiLeCrM";

		// if log_type is EMAIL_SENT
		if (object[key] === "EMAIL_SENT")
		{
			// Splits logs message
			var email_fields = object["message"].split(_AGILE_CRM_DELIMITER, 4);

			// Json to apply for handlebar template
			var json = {};

			if (email_fields === undefined)
				return options.inverse(object);

			// Iterates inorder to insert each field into json
			for (var i = 0; i < email_fields.length; i++)
			{
				// Splits based on colon. E.g "To: naresh@agilecrm.com   "
				var arrcolon = email_fields[i].split(":");

				// Inserts LHS of colon as key. E.g., To
				var key = arrcolon[0];
				key = key.trim(); // if key starts with space, it can't
				// accessible

				// Inserts RHS of colon as value. E.g., naresh@agilecrm.com  
				var value = arrcolon.slice(1).join(":"); // join the
				// remaining string
				// based on colon,
				// only first occurence of colon is needed
				value = value.trim();

				json[key] = value;
			}

			// inserts time into json
			json.time = object["time"];

			// apply customized json to template.
			return options.fn(json);
		}

		// if not EMAIL_SENT log, goto else in the template
		return options.inverse(object);

	});

	Handlebars.registerHelper('remove_spaces', function(value)
	{
		if(value)
			  value = value.replace(/ +/g, '');

		return value;

	});

	Handlebars.registerHelper('replace_spaces', function(value)
	{
		if(value)
			  value = value.replace(/ +/g, '_');

		return value;

	});

	/***************************************************************************
	 * Returns campaignStatus object from contact campaignStatus array having
	 * same campaign-id. It is used to get start and completed time from array.
	 **************************************************************************/
	Handlebars.registerHelper('if_same_campaign', function(object, data, options)
	{

		var campaignStatusArray = object[data];

		// if campaignStatus key doesn't exist return.
		if (data === undefined || campaignStatusArray === undefined)
			return;

		// Get campaign-id from hash
		var current_campaign_id = getIdFromHash();

		for (var i = 0, len = campaignStatusArray.length; i < len; i++)
		{

			// compares campaign-id of each element of array with
			// current campaign-id
			if (campaignStatusArray[i].campaign_id === current_campaign_id)
			{
				// if equal, execute template current json
				return options.fn(campaignStatusArray[i]);
			}
		}

	});

	/**
	 * Returns other active campaigns in campaign-active subscribers.
	 */
	Handlebars.registerHelper('if_other_active_campaigns', function(object, data, options)
	{

		if (object === undefined || object[data] === undefined)
			return;

		var other_campaigns = {};
		var other_active_campaigns = [];
		var other_completed_campaigns = [];
		var campaignStatusArray = object[data];

		var current_campaign_id = getIdFromHash();

		for (var i = 0, len = campaignStatusArray.length; i < len; i++)
		{
			// neglect same campaign
			if (current_campaign_id === campaignStatusArray[i].campaign_id)
				continue;

			// push all other active campaigns
			if (campaignStatusArray[i].status.indexOf('ACTIVE') !== -1)
				other_active_campaigns.push(campaignStatusArray[i])

				// push all done campaigns
			if (campaignStatusArray[i].status.indexOf('DONE') !== -1)
				other_completed_campaigns.push(campaignStatusArray[i]);
		}

		other_campaigns["active"] = other_active_campaigns;
		other_campaigns["done"] = other_completed_campaigns;

		return options.fn(other_campaigns);

	});

	/**
	 * Returns Contact Model from contactDetailView collection.
	 * 
	 */
	Handlebars.registerHelper('contact_model', function(options)
	{

		if (App_Contacts.contactDetailView && App_Contacts.contactDetailView.model)
		{

			// To show Active Campaigns list immediately after campaign
			// assigned.
			if (CONTACT_ASSIGNED_TO_CAMPAIGN)
			{
				CONTACT_ASSIGNED_TO_CAMPAIGN = false;

				// fetches updated contact json
				var contact_json = $.ajax({ type : 'GET', url : '/core/api/contacts/' + App_Contacts.contactDetailView.model.get('id'), async : false,
					dataType : 'json' }).responseText;

				// Updates Contact Detail model
				App_Contacts.contactDetailView.model.set(JSON.parse(contact_json));

				return options.fn(JSON.parse(contact_json));
			}

			// if simply Campaigns tab clicked, use current collection
			return options.fn(App_Contacts.contactDetailView.model.toJSON());
		}
	});
	

	/**
	 * Verifies given urls length and returns options hash based on restricted
	 * count value.
	 * 
	 */
	Handlebars.registerHelper("if_more_urls", function(url_json, url_json_length, options)
	{
		var RESTRICT_URLS_COUNT = 3;
		var temp_urls_array = [];
		var context_json = {};

		// If length is less than restricted, compile
		// else block with given url_json
		if (url_json_length < RESTRICT_URLS_COUNT)
			return options.inverse(url_json);

		// Insert urls until restricted count reached
		for (var i = 0; i < url_json.length; i++)
		{
			if (i === RESTRICT_URLS_COUNT)
				break;

			temp_urls_array.push(url_json[i]);
		}

		context_json.urls = temp_urls_array;

		// More remained
		context_json.more = url_json_length - RESTRICT_URLS_COUNT;

		return options.fn(context_json);

	});

	Handlebars.registerHelper('safe_tweet', function(data)
	{
		data = data.trim();
		return new Handlebars.SafeString(data);
	});
	/**
	 * Get stream icon for social suite streams.
	 */
	Handlebars.registerHelper('get_stream_icon', function(name)
	{
		if (!name)
			return;

		var icon_json = { "Home" : "icon-home", "Retweets" : "icon-retweet", "DM_Inbox" : "icon-download-alt", "DM_Outbox" : "icon-upload-alt",
			"Favorites" : "icon-star", "Sent" : "icon-share-alt", "Search" : "icon-search", "Scheduled" : "icon-time", "All_Updates" : "icon-home",
			"My_Updates" : "icon-share-alt" };

		name = name.trim();

		if (icon_json[name])
			return icon_json[name];

		return "icon-globe";

	});

	/**
	 * Get task list name without underscore and caps, for new task UI.
	 */
	Handlebars.registerHelper('get_normal_name', function(name)
	{
		if (!name)
			return;

		var name_json = { "HIGH" : "High", "LOW" : "Low", "NORMAL" : "Normal", "YET_TO_START" : "Yet To Start",
			"IN_PROGRESS" : "In Progress", "COMPLETED" : "Completed", "TODAY" : "Today", "TOMORROW" : "Tomorrow", "OVERDUE" : "Overdue", "LATER" : "Later" };

		$.extend(name_json,categories.CATEGORIES,name_json);

		name = name.trim();

		if (name_json[name])
			return name_json[name];

		return name;

	});

	/**
	 * Get activity type without underscore and caps, for deal _details page.
	 */
	Handlebars.registerHelper('get_normal_activity_type', function(name)
	{
		if (!name)
			return;

		var name_json = { "DEAL_ADD" : "Deal Created", "DEAL_EDIT" : "Deal Edited", "DEAL_CLOSE" : "Deal Closed", "DEAL_LOST" : "Deal Lost",
			"DEAL_RELATED_CONTACTS" : " Deal Contacts Changed", "DEAL_OWNER_CHANGE" : "Deal Owner Changed", "DEAL_MILESTONE_CHANGE" : "Deal Milestone Changed",
			"DEAL_ARCHIVE" : "Deal Archived", "DEAL_RESTORE" : "Deal Restored",

			"NOTE_ADD" : "Note Added", "TASK_ADD" : "Task Created", "TASK_EDIT" : "Task Updated", "TASK_PROGRESS_CHANGE" : "Progress Changed",
			"TASK_OWNER_CHANGE" : "Owner Changed", "TASK_STATUS_CHANGE" : "Status Changed", "TASK_COMPLETED" : "Task Completed",
			"TASK_DELETE" : "Task Deleted", "TASK_RELATED_CONTACTS" : "Contacts Modified" };

		name = name.trim();

		if (name_json[name])
			return name_json[name];

		return name;

	});

	/**
	 * put user address location togather separated by comma.
	 */
	Handlebars.registerHelper('user_location', function()
	{

		var City = this.city == "?" ? "" : (this.city + ", ");
		var Region = this.region == "?" ? "" : (this.region + ", ");
		var Country = this.country;
		if (this.city == "?" && this.region == "?")
			Country = this.country == "?" ? this.city_lat_long : (this.city_lat_long + " ( " + this.country + " )");

		return (City + Region + Country).trim();
	});

	/**
	 * Trims trailing spaces
	 */
	Handlebars.registerHelper('trim_space', function(value)
	{

		if (value === undefined)
			return value;

		return value.trim();
	});

	/**
	 * Returns reputation name based on value
	 * 
	 */
	Handlebars
			.registerHelper(
					'get_subaccount_reputation',
					function(value)
					{
						var type = "bg-light dk text-tiny";
						var reputation = "Unknown";

						if (value > 1 && value < 40)
						{
							type = "label-danger text-tiny";
							reputation = "Poor";
						}
						else if (value >= 40 && value < 75)
						{
							type = "bg-light text-tiny";
							reputation = "Ok";
						}
						else if (value >= 75 && value < 90)
						{
							type = "label-success";
							reputation = "Good";
						}
						else if (value >= 90)
						{
							type = "label-success";
							reputation = "Excellent";
						}

						return "<span style='top: -3px' class='text-sm pos-rlt label " + type + "'>" + reputation + "</span> <!--<span class='badge badge-" + type + "'>" + value + "</span>-->";

					});

	/**
	 * Returns id from hash. It returns id from hash iff id exists at last.
	 * 
	 */
	Handlebars.registerHelper('get_id_from_hash', function()
	{

		return getIdFromHash();

	});

	Handlebars.registerHelper('get_subscribers_type_from_hash', function()
	{

		// Returns "workflows" from "#workflows"
		var hash = window.location.hash.substr(1);

		if (hash.indexOf("all") != -1)
			return "All";

		if (hash.indexOf("active") != -1)
			return "Active";

		if (hash.indexOf("completed") != -1)
			return "Completed";

		if (hash.indexOf("removed") != -1)
			return "Removed";

		if (hash.indexOf("unsubscribed") != -1)
			return "Unsubscribed";

		if (hash.indexOf("hardbounced") != -1)
			return "Hard Bounced";

		if (hash.indexOf("softbounced") != -1)
			return "Soft Bounced";

		if (hash.indexOf("spam-reported") != -1)
			return "Spam Reported";
	});

	Handlebars.registerHelper("check_plan", function(plan, options)
	{
		console.log(plan);

		if (!_billing_restriction)
			return options.fn(this);

		if (_billing_restriction.currentLimits.planName == plan)
			return options.fn(this);

		return options.inverse(this);

	});

	/**
	 * Safari browser doesn't supporting few CSS properties like margin-top,
	 * margin-bottom etc. So this helper is used to add compatible CSS
	 * properties to Safari
	 */
	Handlebars.registerHelper("isSafariBrowser", function(options)
	{

		if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1)
			return options.fn(this);

		return options.inverse(this);
	});

	/**
	 * give custome status base on xerotype
	 */

	Handlebars.registerHelper('xeroType', function(type)
	{
		return (type == "ACCPAY") ? "Payable" : "Receivable";
	});

	/**
	 * give custom type to xero type
	 */
	Handlebars.registerHelper('xeroTypeToolTip', function(type)
	{
		return (type == "ACCPAY") ? "Payable" : "Receivable";
	});

	/**
	 * gives first latter capital for given input
	 */
	Handlebars.registerHelper('capFirstLetter', function(data)
	{
		if (data === "DEFAULT")
		{
			// console.log("return empty");
			return "";
		}
		else
		{
			var temp = data.toLowerCase();
			return temp.charAt(0).toUpperCase() + temp.slice(1);
		}
	});

	Handlebars.registerHelper('qbStatus', function(Balance)
	{
		console.log(this);
		console.log(this.TotalAmt);
		if (Balance == 0)
		{
			return "Paid"
		}
		else
		{
			return "Due"
		}
	});
	Handlebars.registerHelper('currencyFormat', function(data)
	{

		return Number(data).toLocaleString('en');
		// data.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
	});

	Handlebars.registerHelper('QbDateFormat', function(data)
	{

		var i = [];
		i = data.split("-");
		return i[0] + "-" + i[2] + "-" + i[1];
	});

	Handlebars.registerHelper("hasScope", function(scope_constant, options)
	{
		if (CURRENT_DOMAIN_USER.scopes && $.inArray(scope_constant, CURRENT_DOMAIN_USER.scopes) != -1)
			return options.fn(this);

		return options.inverse(this);
	});

	Handlebars.registerHelper("hasMenuScope", function(scope_constant, options)
	{
		if (CURRENT_DOMAIN_USER.menu_scopes && $.inArray(scope_constant, CURRENT_DOMAIN_USER.menu_scopes) != -1)
			return options.fn(this);

		return options.inverse(this);
	});

	Handlebars.registerHelper("canSyncContacts", function(options)
	{
		if (canImportContacts())
			return options.fn(this);

		return options.inverse(this);
	});

	/**
	 * To check Access controls for showing icons on dashboard
	 */
	Handlebars.registerHelper('hasMenuScope', function(item, options)
	{
		if ((CURRENT_DOMAIN_USER.menu_scopes).indexOf(item) != -1)
			return options.fn(this);
		else
			return options.inverse(this);
	});

	Handlebars.registerHelper('fetchXeroUser', function(data)
	{
		return JSON.parse(data).xeroemail;
	});

	Handlebars.registerHelper('isContactType', function(contact_type, contact_type_2, options)
	{
		if (!contact_type && contact_type_2 == 'PERSON')
		{
			return options.fn(this);
		}
		else if (contact_type == contact_type_2)
			return options.fn(this);

		return options.inverse(this);
	});

	Handlebars.registerHelper('getfbreturndomain', function(data)
	{
		var arr = window.location.href.split('/')
		return arr[2];
	});

	Handlebars
			.registerHelper(
					'tagManagementCollectionSetup',
					function(tags)
					{

						console.log(tags);
						var json = {};

						var keys = [];
						// Store tags in a json, starting letter as key
						for (var i = 0; i < tags.length; i++)
						{
							var tag = tags[i].tag;
							var key = tag.charAt(0).toUpperCase();
							// console.log(tag);
							if (jQuery.inArray(key, keys) == -1)
								keys.push(key);
						}

						console.log(keys);
						var html_temp = "";

						for (var i = 0; i < keys.length; i++)
							html_temp += "<div class=\"clearfix\"></div><div style='margin-right:10px;'><div class='tag-key tag-management-key'>" + keys[i] + "</div><div class=\"clearfix\"></div><div class='left' tag-alphabet=\"" + encodeURI(keys[i]) + "\"><ul class=\"tags-management tag-cloud\" style=\"list-style:none;\"></ul></div></div>";

						console.log(html_temp);
						return new Handlebars.SafeString(html_temp);
					});

	Handlebars.registerHelper('containsScope', function(item, list, options)
	{
		if (list.length == 0 || !item)
			return options.inverse(this);

		if (jQuery.inArray(item, list) == -1)
			return options.inverse(this);

		return options.fn(this);

	});

	Handlebars.registerHelper('isOwnerOfContact', function(owner_id, options)
	{

		if (CURRENT_DOMAIN_USER.id == owner_id)
			return options.fn(this);
		return options.inverse(this);
	});

	Handlebars.registerHelper('canEditContact', function(owner_id, options)
	{
		if (canEditContact(owner_id))
			return options.fn(this);

		return options.inverse(this)
	});

	Handlebars.registerHelper('canEditCurrentContact', function(owner_id, options)
	{
		if (canEditCurrentContact())
			return options.fn(this);

		return options.inverse(this)
	})

	Handlebars.registerHelper('gateway_exists', function(value, target, options)
	{

		for (var i = 0; i < target.length; i++)
		{

			var prefs = JSON.parse(target[i].prefs);

			if (target[i].name == "EmailGateway")
			{

				if (prefs.email_api == value)
					return options.fn(target[i]);
			}

			if (target[i].name == "SMS-Gateway")
			{
				if (prefs.sms_api == value)
					return options.fn(target[i]);
			}
		}
		return options.inverse(this);
	});

	Handlebars.registerHelper("each_index_slice", function(array, index, options)
	{
		var buffer = "";
		for (var i = index; i < array.length; i++)
		{
			var item = array[i];

			// stick an index property onto the item, starting with 1, may make
			// configurable later
			// item.index = i + 1;

			console.log(item);
			// show the inside of the block
			buffer += options.fn(item);
		}

		// return the finished buffer
		return buffer;

	});

	Handlebars.registerHelper('gateway_exists', function(value, target, options)
	{

		for (var i = 0; i < target.length; i++)
		{

			var prefs = JSON.parse(target[i].prefs);

			if (target[i].name == "EmailGateway")
			{

				if (prefs.email_api == value)
					return options.fn(target[i]);
			}

			if (target[i].name == "SMS-Gateway")
			{
				if (prefs.sms_api == value)
					return options.fn(target[i]);
			}
		}
		return options.inverse(this);
	});

	Handlebars.registerHelper('isOwnerOfContact', function(owner_id, options)
	{

		if (CURRENT_DOMAIN_USER.id == owner_id)
			return options.fn(this);
		return options.inverse(this);
	});

	Handlebars.registerHelper('canEditContact', function(owner_id, options)
	{
		if ((hasScope('UPDATE_CONTACTS') || hasScope('DELETE_CONTACTS')) || CURRENT_DOMAIN_USER.id == owner_id)
			return options.fn(this);

		return options.inverse(this)
	});

	Handlebars.registerHelper('getAccountPlanName', function(plan_name)
	{
		if (!plan_name)
			return "Free";

		var plan_fragments = plan_name.split("_");

		return ucfirst(plan_fragments[0]);

	});

	Handlebars.registerHelper('getAccountPlanInteval', function(plan_name)
	{
		if (!plan_name)
			return "Monthly";

		var plan_fragments = plan_name.split("_");

		return ucfirst(plan_fragments[1]);

	});

	Handlebars.registerHelper('getSubscriptionBasedOnPlan', function(customer, plan, options)
	{
		var subscription = getSubscriptionWithAmount(customer, plan);

		if (subscription != null)
			return options.fn(subscription);

		return options.inverse(this);
	});

	// handling with iso date
	Handlebars.registerHelper("iso_date_to_normalizeDate", function(dateString)
	{

		/*
		 * var myDate = new Date(dateString); var timestamp = myDate.getTime();
		 * var d = new Date(parseInt(timestamp) / 1000).format("dd-MM-yyyy");
		 * return d;
		 */
		if (dateString.length <= 0)
			return;
		var arr = dateString.split("T");
		console.log("normalize date " + arr[0]);
		// var d = new Date(arr[0]).format("dd-MM-yyyy");
		return arr[0];

	});

	/**
	 * Index starts from 1
	 */
	Handlebars.registerHelper("getMonthFromIndex", function(month_index)
	{
		var monthArray = [
				"January", "february", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
		];
		if (month_index > 12)
			return monthArray[11];

		return monthArray[month_index - 1];
	});

	Handlebars.registerHelper('xeroOrganisationShortCode', function(block)
	{
		if (typeof SHORT_CODE == "undefined" || SHORT_CODE == "")
		{
			return false;
		}
		else
		{
			return SHORT_CODE;
		}
	});

	Handlebars.registerHelper('buildOptions', function(field_data)
	{
		var list_values = field_data.split(";");
		var list_options = '';
		// Create options based on list values
		$.each(list_values, function(index, value)
		{
			if (value != "")
				list_options = list_options.concat('<option value="' + value + '">' + value + '</option>');
		});

		return list_options;
	});

	/**
	 * Choose Avatar templates
	 */
	Handlebars.registerHelper('get_avatars_template', function(options)
	{
		var template = getTemplate("choose-avatar-images-modal", {});

		getTemplate('choose-avatar-images-modal', {}, undefined, function(template_ui){
	 		if(!template_ui)
	    		return;
	    	var template = $(template_ui);
			 
		}, null);

		return template;
	});

	// checks if email type is agile or not
	Handlebars.registerHelper('if_email_type_is_agile', function(value, options)
	{
		var type = email_server_type;
		if (type)
			if (value === type)
				return options.fn(this);
			else
				return options.inverse(this);
		else
		{
			return options.fn(this);
		}
	});

	// Reads the gloabal varaible and returns it value
	Handlebars.registerHelper('read_global_var', function()
	{
		var type = email_server_type;
		if (type)
			return type;
		else
		{
			return "agilecrm";
		}
	});
	
	//checks whether current user plan is pro or not.
	Handlebars.registerHelper("if_non_pro_plan", function(options)
	{
		if (!_billing_restriction)
			return options.inverse(this);
		    if (_billing_restriction.currentLimits.planName !== "PRO")
				return options.fn(this);
		return options.inverse(this);
	});
	// Checks whether user reached email accounts(GMAIL/IMAP/OFFICE) limit
	// reached or not
	Handlebars.registerHelper('has_email_account_limit_reached', function(options)
	{
		var type = HAS_EMAIL_ACCOUNT_LIMIT_REACHED;
		if (type)
			return options.fn(this);
		else
			return options.inverse(this);
	});

	// To pick randomly selected avatar url
	Handlebars.registerHelper('pick_random_avatar_url', function(options)
	{
		return choose_random_avatar();
	});

	Handlebars.registerHelper('getRemaininaEmails', function()
	{
		return getPendingEmails();
	});

	// helper function to return agile bcc special email for inbound mail event
	// trigger
	Handlebars.registerHelper('inboundMail', function()
	{
		var agile_api = $.ajax({ type : 'GET', url : '/core/api/api-key', async : false, dataType : 'json' }).responseText;
		agile_api = JSON.parse(agile_api);
		var inbound_email = window.location.hostname.split('.')[0] + "-" + agile_api.api_key + "@agle.cc";
		return new Handlebars.SafeString(inbound_email);
	});

	/**
	 * ==============================================================
	 * -------------------------- jitendra's start script ---------- Please do
	 * not add any function in this block extract time from epochTime
	 */
	Handlebars.registerHelper("getTime", function(date)
	{

		if (!date)
			return;

		if ((date / 100000000000) > 1)
		{
			var d = new Date(parseInt(date));
			var hours = d.getHours();
			if (hours > 12)
				hours = hours - 12;
			var min = d.getMinutes();
			if (min == 0)
				min = "00"
			var ampm = hours >= 12 ? "PM" : "AM";
			return hours + ":" + min + " " + ampm;
		}
		// date form milliseconds

		var d = new Date(parseInt(date) * 1000);
		var hours = d.getHours();
		if (hours > 12)
			hours = hours - 12;
		var min = d.getMinutes();
		if (min == 0)
			min = "00"
		var ampm = hours >= 12 ? "PM" : "AM";
		return hours + ":" + min + " " + ampm;

	});

	/**
	 * get custom date with time
	 */

	Handlebars.registerHelper("getCustomDateWithTime", function(start, end)
	{
		var day1 = getDay(start);
		var day2 = getDay(end);

		var d1 = getCustomFormatedDate(start);
		var d2 = getCustomFormatedDate(end);
		var time = extractTimeFromDate(end);

		if (day1 != day2)
			return d1 + " - " + d2;
		else
			return d1 + " - " + time;

	});

	function getCustomFormatedDate(date)
	{

		var months = [
				'Jan', 'Feb', 'March', 'April', 'May', 'Jun', 'July', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'
		];

		if (!date)
			return;

		if ((date / 100000000000) > 1)
		{
			var d = new Date(parseInt(date));
			var hours = d.getHours();
			var year = d.getFullYear();
			var date = d.getDate();
			var month = d.getMonth();
			var min = d.getMinutes();
			if (min == 0)
				min = "00"
			var ampm = hours >= 12 ? "PM" : "AM";
			if (hours > 12)
				hours = hours - 12;
			return months[month] + " " + date + ", " + year + " " + hours + ":" + min + " " + ampm;

		}
		// date form milliseconds

		var d = new Date(parseInt(date) * 1000);
		var hours = d.getHours();
		var year = d.getFullYear();
		var date = d.getDate();
		var month = d.getMonth();
		var min = d.getMinutes();
		if (min == 0)
			min = "00"
		var ampm = hours >= 12 ? "PM" : "AM";
		if (hours > 12)
			hours = hours - 12;
		return months[month] + " " + date + ", " + year + " " + hours + ":" + min + " " + ampm;

	}
	function extractTimeFromDate(date)
	{
		if (!date)
			return;

		if ((date / 100000000000) > 1)
		{
			var d = new Date(parseInt(date));
			var hours = d.getHours();

			var min = d.getMinutes();
			if (min == 0)
				min = "00"
			var ampm = hours >= 12 ? "PM" : "AM";
			if (hours > 12)
				hours = hours - 12;
			return hours + ":" + min + " " + ampm;
		}
		// date form milliseconds

		var d = new Date(parseInt(date) * 1000);
		var hours = d.getHours();
		var min = d.getMinutes();
		if (min == 0)
			min = "00"
		var ampm = hours >= 12 ? "PM" : "AM";
		if (hours > 12)
			hours = hours - 12;
		return hours + ":" + min + " " + ampm;
	}

	function getDay(date)
	{
		if ((date / 100000000000) > 1)
		{
			var sDate = new Date(parseInt(date));
			return sDate.getDate();
		}
		else
		{
			var sDate = new Date(parseInt(date) * 1000);
			return sDate.getDate();
		}
	}
	/**
	 * return contact property value base on type if contact type is COMPANY
	 * then return company name other wise retun contact first_name + last_name
	 * as name
	 */

	Handlebars.registerHelper('getContactDisplayValue', function(contact)
	{
		var displayName;

		var type = contact.type;
		var properties = contact.properties;
		if (properties)
		{
			if (type == "COMPANY")
			{

				for (var i = 0; i < properties.length; i++)
				{
					if (properties[i].name == 'name')
					{
						displayName = properties[i].value;
						break;
					}
				}
			}
			else
			{
				var firstName;
				var lastName;
				for (var i = 0; i < properties.length; i++)
				{
					if (properties[i].name == 'first_name')
					{
						firstName = properties[i].value;

					}

					if (properties[i].name == 'last_name')
					{
						lastName = properties[i].value;

					}

				}
				if (!firstName)
				{
					firstName = '';
				}
				if (!lastName)
				{
					lastName == '';
				}
				displayName = firstName + " " + lastName;
			}
		}
		return displayName;
	});

	// return google event custom date and time

	Handlebars.registerHelper('getGoogleEventCustomTime', function(start, end)
	{
		var startDate = new Date(start);
		var endDate = new Date(end);

		return getGoogleCustomFormatteDate(startDate.getTime(), endDate.getTime());

	});

	function getGoogleCustomFormatteDate(start, end)
	{

		var day1 = getDay(start);
		var day2 = getDay(end);

		var d1 = getCustomFormatedDate(start);
		var d2 = getCustomFormatedDate(end);
		var time = extractTimeFromDate(end);
		var createdTime = getEventCreatedTime(start);
		if (createdTime == 0 || createdTime == 1)
		{
			var t1 = extractTimeFromDate(start);
			var t2 = extractTimeFromDate(end);
			if (t1 && t2)
				return t1 + " - " + t2;
			if (t2)
				return t1 + " - " + t2;
			else
				return t1;
		}
		else
		{

			if (day1 != day2)
			{
				if (d2)
					return d1 + " - " + d2;
				else
					return d1;
			}
			else
				return d1 + " - " + time;
		}
	}

	Handlebars.registerHelper("displayCustomDateTime", function(start, end)
	{
		var eventCreateTime = get_activity_created_time(start);

		var day1 = getDay(start);
		var day2 = getDay(end);

		var d1 = getCustomFormatedDate(start);
		var d2 = getCustomFormatedDate(end);
		var time = extractTimeFromDate(end);
		if (eventCreateTime == 0 || eventCreatedTime == 1)
		{
			return time;
		}
		else
		{
			if (day1 != day2)
				return d1 + " - " + d2;
			else
				return d1 + " - " + time;
		}
	});
	// helper function return created time for event
	function getEventCreatedTime(due)
	{
		// Get Todays Date
		var eventStartDate = new Date(due);
		due = eventStartDate.getTime() / 1000;
		var date = new Date();
		date.setHours(0, 0, 0, 0);

		date = date.getTime() / 1000;
		// console.log("Today " + date + " Due " + due);
		return Math.floor((due - date) / (24 * 3600));
	}

	/**
	 * ------ End of jitendra script------ ======== Thank you =================
	 */

	// To pick randomly selected avatar url
	Handlebars.registerHelper('arrayToCamelcase', function(values)
	{
		var result = '';
		for (var i = 0; i < values.length; i++)
		{
			result += ucfirst(values[i]);
			if (i + 1 < values.length)
				result += ', ';
		}
		return result;
	});

	// To pick randomly selected avatar url
	Handlebars.registerHelper('namesFromObject', function(jsonArray, fieldName)
	{
		var result = '';
		console.log(jsonArray.length);
		for (var i = 0; i < jsonArray.length; i++)
		{
			result += jsonArray[i][fieldName];
			if (i + 1 < jsonArray.length)
				result += ', ';
		}
		return result;
	});

	// @author Purushotham
	Handlebars.registerHelper('secondsToFriendlyTime', function(time)
	{
		var hours = Math.floor(time / 3600);
		if (hours > 0)
			time = time - hours * 60 * 60;
		var minutes = Math.floor(time / 60);
		var seconds = time - minutes * 60;
		var friendlyTime = "";
		if (hours == 1)
			friendlyTime = hours + "h ";
		if (hours > 1)
			friendlyTime = hours + "h ";
		if (minutes > 0)
			friendlyTime += minutes + "m ";
		if (seconds > 0)
			friendlyTime += seconds + "s ";
		if (friendlyTime != "")
			return ' - ' + friendlyTime;
		return friendlyTime;
	});
	// To pick randomly selected avatar url
	Handlebars.registerHelper('pick_random_avatar_url', function(options)
	{
		return choose_random_avatar();
	});

	// To choose font awesome icon for custom fields
	Handlebars.registerHelper('choose_custom_field_font_icon', function(field_type)
	{
		var icon_class = '';
		if (field_type == "TEXT")
			icon_class = "icon-text-height";
		else if (field_type == "TEXTAREA")
			icon_class = "icon-file-alt";
		else if (field_type == "DATE")
			icon_class = "icon-calendar";
		else if (field_type == "CHECKBOX")
			icon_class = "icon-check";
		else if (field_type == "LIST")
			icon_class = "icon-list-ul";
		else if (field_type == "NUMBER")
			icon_class = "icon-text-height";
		return icon_class;
	});

	// To choose font awesome icon for custom fields
	Handlebars.registerHelper('choose_custom_field_type', function(field_type)
	{
		var field_type_name = '';
		if (field_type == "TEXT")
			field_type_name = "Text Field";
		else if (field_type == "TEXTAREA")
			field_type_name = "Text Area";
		else if (field_type == "DATE")
			field_type_name = "Date";
		else if (field_type == "CHECKBOX")
			field_type_name = "Checkbox";
		else if (field_type == "LIST")
			field_type_name = "List";
		else if (field_type == "NUMBER")
			field_type_name = "Number";
		else if (field_type == "FORMULA")
			field_type_name = "Formula";
		return field_type_name;
	});

	// @author Purushotham
	// function to compare integer values
	Handlebars.registerHelper('ifCond', function(v1, type, v2, options)
	{
		switch (type) {
		case "greaterthan":
			if (parseInt(v1) > parseInt(v2))
				return options.fn(this);
			break;
		case "lessthan":
			if (parseInt(v1) < parseInt(v2))
				return options.fn(this);
			break;
		case "equals":
			if (parseInt(v1) === parseInt(v2))
				return options.fn(this);
			break;
		}
		return options.inverse(this);
	});

	Handlebars.registerHelper('callActivityFriendlyStatus', function(status, direction)
	{

		switch (status) {
		case "completed":
		case "answered":
			return "Call duration";
			break;
		case "busy":
		case "no-answer":
			if (direction == 'outgoing')
				return "Contact busy";
			else
				return "Not answered";
			break;
		case "failed":
			return "Failed";
			break;
		case "in-progress":
		case "voicemail":
			return "Left voicemail";
			break;
		default:
			return "";
		}

	});

	Handlebars.registerHelper('shopifyWebhook', function()
	{
		var agile_api = $.ajax({ type : 'GET', url : '/core/api/api-key', async : false, dataType : 'json' }).responseText;
		agile_api = JSON.parse(agile_api);
		var shopify_webhook = window.location.origin + "/shopifytrigger?api-key=" + agile_api.api_key;
		return new Handlebars.SafeString(shopify_webhook);
	});

	Handlebars.registerHelper('toProperFormat', function(timeInSec)
	{
		if (timeInSec == "0")
			return "0 s";

		return twilioSecondsToFriendly(timeInSec);
	});

	/**
	 * getting convenient name of portlet
	 */
	Handlebars.registerHelper('get_portlet_name', function(p_name)
	{
		var portlet_name = '';
		if (p_name == 'Filter Based')
			portlet_name = 'Contact List';
		else if (p_name == 'Emails Opened')
			portlet_name = 'Email Opens';
		else if (p_name == 'Emails Sent')
			portlet_name = 'Emails';
		else if (p_name == 'Growth Graph')
			portlet_name = 'Tag Graph';
		else if (p_name == 'Calls Per Person')
			portlet_name = 'Calls';
		else if (p_name == 'Pending Deals')
			portlet_name = 'Pending Deals';
		else if (p_name == 'Deals By Milestone')
			portlet_name = 'Deals by Milestone';
		else if (p_name == 'Closures Per Person')
			portlet_name = 'Closures per Person';
		else if (p_name == 'Deals Won')
			portlet_name = 'Deals Won';
		else if (p_name == 'Deals Funnel')
			portlet_name = 'Deals Funnel';
		else if (p_name == 'Deals Assigned')
			portlet_name = 'Deals Assigned';
		else if (p_name == 'Agenda')
			portlet_name = "Events";
		else if (p_name == 'Today Tasks')
			portlet_name = "Tasks";
		else if (p_name == 'Agile CRM Blog')
			portlet_name = "Agile CRM Blog";
		else if (p_name == 'Task Report')
			portlet_name = "Task Report";
		else if(p_name=='Stats Report')
			portlet_name = "Activity Overview";
		else if(p_name=='Campaign stats')
			portlet_name = "Campaign Stats"
		else
			portlet_name = p_name;
		return portlet_name;
	});
	/**
	 * getting portlet icons
	 */
	Handlebars.registerHelper('get_portlet_icon', function(p_name)
	{
		var icon_name = '';
		if (p_name == 'Filter Based')
			icon_name = 'icon-user';
		else if (p_name == 'Emails Opened')
			icon_name = 'icon-envelope';
		else if (p_name == 'Emails Sent')
			icon_name = 'icon-envelope';
		else if (p_name == 'Growth Graph')
			icon_name = 'icon-graph';
		else if (p_name == 'Calls Per Person')
			icon_name = 'icon-call-end';
		else if (p_name == 'Pending Deals')
			icon_name = 'icon-clock';
		else if (p_name == 'Deals By Milestone')
			icon_name = 'icon-flag';
		else if (p_name == 'Closures Per Person')
			icon_name = 'icon-thumbs-up';
		else if (p_name == 'Deals Won')
			icon_name = 'icon-briefcase';
		else if (p_name == 'Deals Funnel')
			icon_name = 'icon-filter';
		else if (p_name == 'Deals Assigned')
			icon_name = 'icon-user';
		else if (p_name == 'Agenda' || p_name == 'Mini Calendar')
			icon_name = "icon-calendar";
		else if (p_name == 'Today Tasks' || p_name == 'Task Report')
			icon_name = "icon-tasks";
		else if (p_name == 'Agile CRM Blog')
			icon_name = "icon-feed";
		else if(p_name=='Stats Report')
			icon_name = "icon-speedometer";
		else if (p_name == 'Leaderboard')
			icon_name = "icon-trophy";
		else if (p_name== 'User Activities')
			icon_name = "icon-cogs";
		else if (p_name== 'Account Details')
			icon_name = "icon-info";
		else if (p_name == 'Revenue Graph')
			icon_name = 'icon-graph';
		else if (p_name == 'Campaign stats')
			icon_name = 'icon-sitemap';
		return icon_name;
	});
	

	Handlebars.registerHelper('if_equals_or', function()
	{
		var options = arguments[arguments.length - 1];
		try
		{
			for (var i = 0; i < arguments.length - 1; i = i + 2)
			{
				value = arguments[i];
				target = arguments[i + 1];
				if ((typeof target === "undefined") || (typeof value === "undefined"))
					return options.inverse(this);
				if (value.toString().trim() == target.toString().trim())
					return options.fn(this);
			}
			return options.inverse(this);
		}
		catch (err)
		{
			console.log("error while if_equals_or of handlebars helper : " + err.message);
			return options.inverse(this);
		}
	});

	Handlebars.registerHelper('buildFacebookProfileURL', function(url)
	{
		return buildFacebookProfileURL(url);
	});

	/**
	 * returns tracks count of opportunity
	 */
	Handlebars.registerHelper('getTracksCount', function(options)
	{
		if (parseInt(DEAL_TRACKS_COUNT) > 1)
			return options.fn(this);
		else
			return options.inverse(this);
	});
	
	/**
	 * getting time in AM and PM format for event portlet
	 */
	Handlebars.registerHelper('get_AM_PM_format', function(date_val)
	{
		var date = new Date(date_val * 1000);
		var hours = date.getHours();
		var minutes = date.getMinutes();
		var ampm = hours >= 12 ? 'pm' : 'am';
		hours = hours % 12;
		hours = hours ? hours : 12; // the hour '0' should be '12'
		minutes = minutes < 10 ? '0' + minutes : minutes;
		if(hours<10)
			hours = '0'+hours;
		var strTime = hours + ':' + minutes + '' + ampm;
		return strTime;
	});

	/**
	 * getting duration between two dates for event portlet
	 */
	Handlebars.registerHelper('get_duration', function(startDate, endDate)
	{
		var duration = '';
		var days = 0;
		var hrs = 0;
		var mins = 0;
		var diffInSeconds = endDate - startDate;
		days = Math.floor(diffInSeconds / (24 * 60 * 60));
		hrs = Math.floor((diffInSeconds % (24 * 60 * 60)) / (60 * 60));
		mins = Math.floor(((diffInSeconds % (24 * 60 * 60)) % (60 * 60)) / 60);
		if (days != 0 && days == 1)
			duration += '' + days + 'd ';
		else if (days != 0 && days > 1)
			duration += '' + days + 'd ';
		if (hrs != 0 && hrs == 1)
			duration += '' + hrs + 'h ';
		else if (hrs != 0 && hrs > 1)
			duration += '' + hrs + 'h ';
		if (mins != 0 && mins == 1)
			duration += '' + mins + 'm';
		else if (mins != 0 && mins > 1)
			duration += '' + mins + 'm';
		return duration;
	});

	/**
	 * Returns plain customise text for activity remove underscore and other
	 * special charecter from string
	 */
	Handlebars.registerHelper('displayActivityFieldText', function(value)
	{
		var fields = value.replace(/[^a-zA-Z ^,]/g, " ").split(",");
		var text = "";
		if (fields.length > 1)
		{
			for (var i = 0; i < fields.length - 1; i++)
			{
				text += " " + fields[i].trim();
				if (i != fields.length - 2)
				{
					text += ",";
				}
			}
			text += " and " + fields[fields.length - 1].trim();
		}
		else
		{
			text = fields[fields.length - 1].trim();
		}
		// update title
		text = text.replace('subject', 'Title');
		// update priority
		text = text.replace('priority type', 'Priority');
		// update category
		text = text.replace('task type', 'Category');
		// update due date
		text = text.replace('due date', 'Due date');

		text = text.replace('name', 'Name');
		// update priority
		text = text.replace('probability', 'Probability');
		// update category
		text = text.replace('expected value', 'Expected value');
		// update due date
		text = text.replace('close date', 'Close date');

		text = text.replace('close date', 'Close date');

		text = text.replace('end date', 'End time');
		// update priority
		text = text.replace('priority', 'Priority');
		// update category
		text = text.replace('title', 'Title');

		return text;

	});

	/*
	 * To represent a number with commas in deals from activities menu
	 */
	Handlebars.registerHelper('numberWithCommasForActivities', function(value)
	{
		value = parseFloat(value);
		if (value == 0)
			return value;

		if (value)
			return value.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g, ",").replace('.00', '');
	});

	// function used know weather event rescheduled or modified and task due
	// date is modified
	Handlebars.registerHelper('get_event_rescheduled', function(value, options)
	{
		console.log(value);
		var modieied_fields = value.replace(/[^a-zA-Z ^,]/g, " ").split(",");
		var fields = [];
		if (modieied_fields)
		{
			for (var i = 0; i < modieied_fields.length; i++)
			{
				fields.push(modieied_fields[i].trim());
			}
		}
		if (fields.indexOf("start date") != -1)
		{
			return options.fn(value);
		}
		if (fields.indexOf("due date") != -1)
		{
			return options.fn(value);
		}

		return options.inverse(value);

	});

	/**
	 * gets the duedate and starttime modification value for activities
	 */
	Handlebars.registerHelper('getDueDateOfTask', function(fields, values)
	{
		var field = fields.replace(/[^a-zA-Z ^,]/g, " ").split(",");
		var value = values.replace(/[^a-zA-Z0-9 ^,]/g, " ").split(",");
		var json = {};

		for (var id = 0; id < field.length; id++)
		{
			field[id] = field[id].trim();
			value[id] = value[id].trim();
		}
		for (var i = 0; i < field.length; i++)
		{

			json[field[i]] = value[i];
		}

		if (field.indexOf("due date") != -1)
		{
			var dat = parseFloat(json['due date']);
			return convertToHumanDate("ddd mmm dd yyyy h:MM TT", dat);
		}
		if (field.indexOf("start date") != -1)
		{
			var dat = parseFloat(json['start date']);
			return convertToHumanDate("ddd mmm dd yyyy h:MM TT", dat);
		}

	});
	Handlebars.registerHelper('getDealCustomProperties', function(items, options)
	{
		var fields = getDealCustomProperties(items);
		if (fields.length == 0)
			return options.inverse(fields);

		return options.fn(fields);

	});

	Handlebars.registerHelper('getFormNameFromId', function(id)
	{
		var url = '/core/api/forms/form?formId=' + id;
		var form = $.ajax({ type : 'GET', url : url, async : false, dataType : 'json' }).responseText;
		if(!form)
			return new Handlebars.SafeString("?");
		form = JSON.parse(form);
		var formName = form.formName;
		return new Handlebars.SafeString(formName);
	});

	/**
	 * Helps to check the permission of the user based on the ACL.
	 */
	Handlebars.registerHelper("isTracksEligible", function(options)
	{
		if(_billing_restriction.currentLimits.addTracks)
			   return options.fn(this);
			
		return options.inverse(this);
	});

	/**
	 * Helps to check the number of tracks.
	 */
	Handlebars.registerHelper("hasSingleTrack", function(options)
	{
		try
		{
			var tracksCount = App_Admin_Settings.pipelineGridView.collection.length;
			if (tracksCount > 1)
				return options.fn(this);

		}
		catch (e)
		{
			console.log(e);
		}
		return options.inverse(this);
	});

	/*
	 * Returns first occurance of text after "Email subject: " in the given
	 * message
	 */
	Handlebars.registerHelper('get_subject', function(message)
	{
		var delimiter = "Email subject: ";
		try
		{
			if (message)
				return message.slice(message.indexOf(delimiter) + delimiter.length, message.length);
		}
		catch (e)
		{
			return message;
		}
		return message;
	});
	/**
	 * Helps to check the current deal is the same as passed deal.
	 */
	Handlebars.registerHelper("isCurrentDeal", function(deal_id, options)
	{
		var dealId = App_Deal_Details.dealDetailView.model.id;
		if (deal_id && deal_id == dealId)
			return options.fn(this);

		return options.inverse(this);
	});
	Handlebars.registerHelper('getDealNames', function(deals)
	{
		var html = '';
		var currentDealId = 0;
		if (App_Deal_Details.dealDetailView)
			currentDealId = App_Deal_Details.dealDetailView.model.id;
		$.each(deals, function(index, deal)
		{
			if (deal.id != currentDealId)
			{
				html += '<a href="#deal/' + deal.id + '">' + deal.name + '</a>';
				if (index + 1 < deals.length)
					html += ', ';
			}
		});
		return html;

	});

	/**
	 * Returns milestone name from trigger_deal_milestone; e.g., 1234452_Won,
	 * returns Won
	 */
	Handlebars.registerHelper('trigger_milestone', function(value, options)
	{

		// If undefined
		if (!value)
			return value;

		var milestone = value.split('_');

		if (milestone.length == 1)
			return value;

		// First indexed should be pipeline id
		if (milestone.length > 1 && milestone[0] != " " && !isNaN(Number(milestone[0])))
		{
			milestone.splice(0, 1);
			return milestone.join('_');
		}

	});
	
	/*
	 * Returns the url without query parameters appended by agile
	 */
	Handlebars.registerHelper('get_url', function(url)
	{
		if (url)
		{
			if (url.indexOf("fwd=cd") == -1)
				return new Handlebars.SafeString(url);

			var delimiter;
			if (url.indexOf("?fwd=cd") != -1)
				delimiter = "?fwd=cd";
			else
				delimiter = "&fwd=cd";

			try
			{
				if (delimiter)
					return new Handlebars.SafeString(url.split(delimiter)[0]);
			}
			catch (e)
			{
				console.log("Error in get_limiter:" + e);
				return new Handlebars.SafeString(url);
			}
		}
		return new Handlebars.SafeString(url);

	});

	/*
	 * Returns first occurance of text after the given delimiter in the given
	 * message
	 */

	Handlebars.registerHelper('get_limiter', function(message, delimiter)
	{
		try
		{
			if (message && delimiter)
				return message.slice(message.indexOf(delimiter) + delimiter.length, message.length);
		}
		catch (e)
		{
			console.log("Error in get_limiter:" + e);
			return message;
		}
		return message;
	});


		Handlebars.registerHelper('isAllowedInCurrentPlan', function(functionName, options) {
	
		if(_plan_restrictions[functionName] && _plan_restrictions[functionName][0] && _plan_restrictions[functionName][0]())
		{
			return options.fn(this);
		}
		else if(_plan_restrictions[functionName] && _plan_restrictions[functionName][1])
		{
			return options.inverse(_plan_restrictions[functionName][1]());
		}
		else
			return options.inverse(this);
		
	});

	Handlebars.registerHelper("toSafeString", function(content){
		return new Handlebars.SafeString(content);
	});
	
	Handlebars.registerHelper("getPlanLimits", function(key){
		if(_billing_restriction.currentLimits.planName == "PRO")
			return "Unlimited";
		else
			return _billing_restriction.currentLimits[key];
	});

	Handlebars.registerHelper("getLeaderboardCateCount", function(options){
		var count=0;
		if(options.revenue)
			count++;
		if(options.dealsWon)
			count++;
		if(options.calls)
			count++;
		if(options.tasks)
			count++;
		return count;
	});

	/**
	 * return the increment value of index of a collection
	 */
	Handlebars.registerHelper("getIndexIncrementByOne", function(indexVal){
		return ++indexVal;
	});
	/**
	 * getting duration for portlets
	 */
	Handlebars.registerHelper('get_portlet_duration', function(duration)
	{
		var time_period = 'Today';
		if (duration == 'yesterday')
		{
			time_period = 'Yesterday';
		}
		else if (duration == '1-day' || duration == 'today')
		{
			time_period = 'Today';
		}
		else if (duration == '2-days')
		{
			time_period = 'Last 2 Days';
		}
		else if (duration == 'this-week')
		{
			time_period = 'This Week';
		}
		else if (duration == 'last-week')
		{
			time_period = 'Last Week';
		}
		else if (duration == '1-week')
		{
			time_period = 'Last 7 Days';
		}
		else if (duration == 'this-month')
		{
			time_period = 'This Month';
		}
		else if (duration == 'last-month')
		{
			time_period = 'Last Month';
		}
		else if (duration == '1-month')
		{
			time_period = 'Last 30 Days';
		}
		else if (duration == 'this-quarter')
		{
			time_period = 'This Quarter';
		}
		else if (duration == 'last-quarter')
		{
			time_period = 'Last Quarter';
		}
		else if (duration == '3-months')
		{
			time_period = 'Last 3 Months';
		}
		else if (duration == '6-months')
		{
			time_period = 'Last 6 Months';
		}
		else if (duration == '12-months')
		{
			time_period = 'Last 12 Months';
		}
		else if (duration == 'today-and-tomorrow')
		{
			time_period = 'Today and Tomorrow';
		}
		else if (duration == 'all-over-due')
		{
			time_period = 'All Over Due';
		}
		else if (duration == 'next-7-days')
		{
			time_period = 'Next 7 Days';
		}
		else if (duration == '24-hours')
		{
			time_period = 'Last 24 Hours';
		}
		else if (duration == 'next-quarter')
		{
			time_period = 'Next Quarter';
		}
		else if (duration == 'this-and-next-quarter')
		{
			time_period = 'This and Next Quarter';
		}
		else if (duration == 'this-year')
		{
			time_period = 'This Year';
		}
		else if (duration == 'next-year')
		{
			time_period = 'Next Year';
		}
		
		return time_period;
	});
	
	/**
	 * Returns a given date string to a time ago format ,used for gmaps listview implementation
	 * 
	 */
	Handlebars.registerHelper('timeAgo',function(dateString){
		
		
		var date=new Date();
		 try
			{
			 var find = '-';
			 var re = new RegExp(find, 'g');
			 dateString = dateString.replace(re, '/');
			 dateString = dateString.match(/[^:]+(\:[^:]+)?/g);
			 date = new Date(dateString[0]+' UTC');
			}
			catch (err)
			{
				console.log("Error in parsing date");
			}

	    var seconds = Math.floor((new Date() - date) / 1000);

	    var interval = Math.floor(seconds / 31536000);

	    if (interval > 1) {
	        return interval + " years ago";
	    }
	    interval = Math.floor(seconds / 2592000);
	    if (interval > 1) {
	        return interval + " months ago";
	    }
	    interval = Math.floor(seconds / 86400);
	    if (interval > 1) {
	        return interval + " days ago";
	    }
	    interval = Math.floor(seconds / 3600);
	    if (interval > 1) {
	        return interval + " hours ago";
	    }
	    interval = Math.floor(seconds / 60);
	    if (interval > 1) {
	        return interval + " minutes ago";
	    }
	    return new Handlebars.SafeString(Math.floor(seconds) + " seconds ago");

		
	
		
	});
	
	/**
	 * Returns a string by making its first letter a capital letter.
	 * Used in gmap implementation for table view
	 */
	Handlebars.registerHelper('capitalizeFirstLetter',function(city,country){
		return new Handlebars.SafeString(city.charAt(0).toUpperCase() + city.slice(1)+", "+country);
		
	});
	
	/**
	 * Returns a default image url .
	 * 
	 */
	Handlebars.registerHelper('getDefaultImage',function(){
		return new Handlebars.SafeString(FLAT_FULL_PATH + 'images/user-default.jpg');
		
	});
	
	/**
	 * Returns table headings for custom companies list view
	 */
	Handlebars.registerHelper('companyTableHeadings', function(item)
	{

		var el = "";
		$.each(App_Companies.companyViewModel[item], function(index, element)
		{
			if (element.indexOf("custom_") == 0)
				element = element.split("custom_")[1];
			element = element.replace("_", " ")

			el = el.concat('<th>' + ucfirst(element) + '</th>');

		});

		return new Handlebars.SafeString(el);
	});
	
	Handlebars
	.registerHelper(
			'companies_count',
			function()
			{
				var count_message;
				if (this[0] && this[0].count && (this[0].count != -1))
				{

					if (this[0].count > 9999 && (readCookie('company_filter') || readData('dynamic_company_filter')))
						count_message = "<small> (" + 10000 + "+ Total) </small>" + '<span style="vertical-align: text-top; margin-left: -5px">' + '<img border="0" src="/img/help.png"' + 'style="height: 10px; vertical-align: middle" rel="popover"' + 'data-placement="bottom" data-title="Lead Score"' + 'data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."' + 'id="element" data-trigger="hover">' + '</span>';

					else
						count_message = "<small> (" + this[0].count + " Total) </small>";
				}
				else
					count_message = "<small> (" + this.length + " Total) </small>";

				return new Handlebars.SafeString(count_message);
			});
	
});

// helper function return created time for event
function getEventCreatedTime(due)
{
	// Get Todays Date
	var eventStartDate = new Date(due);
	due = eventStartDate.getTime() / 1000;
	var date = new Date();
	date.setHours(0, 0, 0, 0);

	date = date.getTime() / 1000;
	// console.log("Today " + date + " Due " + due);
	return Math.floor((due - date) / (24 * 3600));
}

// generating circle for tasks progress
Handlebars.registerHelper('getcircle', function(percentage)
{
	prec = (360 * percentage) / 100;
	if (prec <= 180)
	{
		return 'background-image :linear-gradient(' + (prec + 90) + 'deg, transparent 50%, #e8eff0 50%),linear-gradient(90deg, #e8eff0  50%, transparent 50%)';
	}
	else
	{
		return 'background-image :linear-gradient(' + (prec - 90) + 'deg, transparent 50%, #39B4CC 50%), linear-gradient(90deg, #e8eff0 50%, transparent 50%)';
	}
});

/**
 * return onboarding scheduling url by reading fron globals.js file
 */
Handlebars.registerHelper('ONBOARDING_CALENDAR_URL', function()
{

	return ONBOARDING_SCHEDULE_URL;

});

/**
 * return support scheduling url by reading fron util.js file
 */
Handlebars.registerHelper('SUPPORT_CALENDAR_URL', function()
{

	return SUPPORT_SCHEDULE_URL;

});

/**
 * return sales scheduling url by reading fron util.js file
 */
Handlebars.registerHelper('SALES_CALENDAR_URL', function()
{

	return SALES_SCHEDULE_URL;

});
	Handlebars.registerHelper('trialDate', function()
	{
		
		var TRAIL_PENDING_DAYS;
		var _TRAIL_DAYS = 14; 

		var json = $.ajax({ type : 'GET', url : '/core/api/subscription/', async : false,
			dataType : 'json' }).responseText;
		console.log("sub json:");
		console.log(json);
		var string = JSON.parse(json);
		console.log("json string:");
		console.log(string);
//		var billingData = string.billing_data;
//		var billingDataString = JSON.parse(billingData);
		
		
		
			if(TRAIL_PENDING_DAYS)
				return TRAIL_PENDING_DAYS;
			
			if(!string || !string.created_time)
				return (TRAIL_PENDING_DAYS = 14)
				
			var time = (new Date().getTime()/1000) - (string.created_time);
			
			var days = time / (24 * 60 *60);
			
			TRAIL_PENDING_DAYS = _TRAIL_DAYS - days;
			
			if(TRAIL_PENDING_DAYS < 0)
			{
				TRAIL_PENDING_DAYS = 0;
			}
			
			TRAIL_PENDING_DAYS = Math.round(TRAIL_PENDING_DAYS);
			return TRAIL_PENDING_DAYS;
		});
	Handlebars.registerHelper('get_portlet_description', function(p_name)
			{
	var description = '';
	if (p_name == 'Filter Based')
		description = 'See a list of 50 recently added contacts customizable by filters.';
	else if (p_name == 'Emails Opened')
		description = 'See what percentage of people open your direct emails.';
	else if (p_name == 'Growth Graph')
		description = 'Gain a quick insight on how contacts with specific tag(s) have changed over time.';
	else if (p_name == 'Calls Per Person')
		description = 'Detailed reports on call activity of your team.';
	else if (p_name == 'Pending Deals')
		description = 'Gives you a heads up on all your pending Deals.';
	else if (p_name == 'Deals By Milestone')
		description = 'A pie-chart of Deals grouped by Milestone.';
	else if (p_name == 'Deals Funnel')
		description = 'A funnel report of total Deals value in each Milestone.';
	else if (p_name == 'Agenda')
		description = 'A quick view of events from your calendar.';
	else if (p_name == 'Today Tasks')
		description = 'A list of your upcoming or due Tasks';
	else if (p_name == 'Task Report')
		description = 'Get a quick view of tasks by all users reported by status and duration.';
	else if (p_name == 'Agile CRM Blog')
		description = "A feed of what's happening at our end including updates on new features.";
	else if(p_name=='Stats Report')
		description = 'Detailed list of activities done by your team members.';
	else if (p_name == 'Leaderboard')
		description = ' A leaderboard for your team based on revenue won, tasks done, calls etc.';
	else if (p_name== 'User Activities')
		description = 'See a timeline of user actions in Agile CRM.';
	else if (p_name== 'Account Details')
		description = 'Find current plan information, number of users and more.';
	else if (p_name== 'Revenue Graph')
		description = 'Forecasted revenue graph based on your Deals.';
	else if (p_name== 'Mini Calendar')
		description = 'A mini calendar with an overview of your agenda for the day.'
	else if (p_name == 'Campaign stats')
		description = 'See how your campaigns are performing with stats on email opens and link clicks.'
	return description;
			});

	Handlebars.registerHelper('trialEndDate', function(billingData, options)
			{
		      var json={};
		      var currentEpoch = new Date().getTime()/1000;
		      currentEpoch = Math.round(currentEpoch);
		      /*console.log("billing data is:");
		      console.log(billingData.customer.metadata.trial_end);*/
		      //billingData = billingData.toString();
		      /*console.log("string is:");
		      if(billingData.subscriptions.data.trialEnd)
		        console.log(billingData.subscriptions.data.trialEnd);*/
		      if(!billingData)
		    	  {
		    	  	return options.inverse(this);
		    	  }
		    	  console.log(billingData);
		    	  /*var billingData = JSON.parse(billingData.billingData);
		    	  console.log(billingData);*/
              if(billingData.metadata && billingData.metadata.trial_end && billingData.metadata.trial_end > currentEpoch)
        	   {

        		var has_trial = (parseInt(billingData.metadata.trial_end) - currentEpoch)/(24*60*60);
        		has_trial = Math.round(has_trial);
        		var trialDate = (billingData.metadata.trial_end)/(24*60*60);
        		if(has_trial>0)
        			{
        				json['trial_exists'] = true;
        				json['days_left'] = has_trial;
        				var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
        				                  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
        				                ];
        				var date = new Date();
        	            date.setDate(date.getDate() + has_trial); 
        	            var formattedDate = date.getDate()+' '+(monthNames[date.getMonth()])+' '+date.getFullYear();
        				/*formattedDate = JSON.stringify(formattedDate);
        	            console.log(formattedDate);*/
        				json['trial_date'] = formattedDate;
        				console.log("trial in json is:"+json['trial_date']);
        				
        			}
        		else
        			json['trial_exists'] = false;
        		
        	   }
              else
		        json['trial_exists'] = false;

		       return options.fn(json);		        

			});

	Handlebars.registerHelper('trialEnd', function(billingData, options)
			{
		      var json={};
		      var currentEpoch = new Date().getTime()/1000;
		      currentEpoch = Math.round(currentEpoch);
		      /*console.log("billing data is:");
		      console.log(billingData.customer.metadata.trial_end);*/
		      //billingData = billingData.toString();
		      /*console.log("string is:");
		      if(billingData.subscriptions.data.trialEnd)
		        console.log(billingData.subscriptions.data.trialEnd);*/
		      if(!billingData)
		    	  {
		    	  	return options.inverse(this);
		    	  }
		    	  console.log(billingData);

              if(billingData.metadata && billingData.metadata.trial_end && billingData.metadata.trial_end > currentEpoch)
        	   {

        		var has_trial = (parseInt(billingData.metadata.trial_end) - currentEpoch)/(24*60*60);
        		has_trial = Math.floor(has_trial);
        		if(has_trial>0)
        			{
        				json['trial_exists'] = true;
        				json['days_left'] = has_trial;
        				var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
        				                  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
        				                ];
        				var date = new Date();
        	            date.setDate(date.getDate() + has_trial); 
        	            var formattedDate = date.getDate()+' '+(monthNames[date.getMonth()])+' '+date.getFullYear();
        	            formattedDate = JSON.stringify(formattedDate);
        	            console.log(formattedDate);
        				json['trial_date'] = formattedDate;
        			}
        		else
        			json['trial_exists'] = false;
        		
        	   }
              else
		        json['trial_exists'] = false;

		       return options.fn(json);		        

			});
	Handlebars.registerHelper('toggle_contacts_filter', function(options)
			{	        
		    if(readCookie(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS)=="hide"){
			return "none";
	       	}
	    	
			});
Handlebars.registerHelper('get_campaign_type_filter', function(filter_name)
{
	var campaign_type ='';
	if(filter_name=='All')
		campaign_type= 'All Campaigns';
	else{
		var filter=$.ajax({ type : 'GET', url : '/core/api/workflows/'+filter_name, async : false, dataType : 'json',
		success : function(data)
			{
				if (data != null && data != undefined)
					campaign_type = "" + data.name;
			} });
	}
	return campaign_type;
		
});
	
	Handlebars.registerHelper('toggle_contacts_filter', function(options)
			{	        
		    if(readCookie(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS)=="hide"){
		    	return "none";
	       	}
			});

	Handlebars.registerHelper('totalTimeFormat', function(timeInSec)
			{
				if (timeInSec == "0")
					return "0 sec";

				return SecondsToCampaignTime(timeInSec);
			});

	// To show allowed domains as list
	Handlebars.registerHelper('allowed_domain_list', function(data)
			{
				var html = "";
				if (data)
				{
					var allowed_domains = data.split(",");
					for ( var i in allowed_domains)
					{
						allowed_domains[i] = allowed_domains[i].trim();
						html += "<tr data='" + allowed_domains[i] + "' style='display: table-row;'><td><div class='inline-block v-top text-ellipsis' style='width:80%'>";
						html += allowed_domains[i] + "</div></td><td class='b-r-none'><div class='m-b-n-xs' style='display:none;'><a class='allowed-domain-delete c-p m-l-sm text-l-none text-xs'  data-toggle='modal' role='button' href='#'><i title='Delete Allowed Domain' class='task-action icon icon-trash'></i></a></div></td></tr>";
					}
				}
				return html;
			});

	// To show blocked ips as list
	Handlebars.registerHelper('blocked_ips_list', function(data)
			{
				var html = "";
				if (data)
				{
					var blocked_ips = data.split(",");
					for ( var i in blocked_ips)
					{
						blocked_ips[i] = blocked_ips[i].trim();
						html += "<tr data='" + blocked_ips[i] + "' style='display: table-row;'><td><div class='inline-block v-top text-ellipsis' style='width:80%'>";
						html += blocked_ips[i] + "</div></td><td class='b-r-none'><div class='m-b-n-xs' style='display:none;'><a class='blocked-ip-delete c-p m-l-sm text-l-none text-xs'  data-toggle='modal' role='button' href='#'><i title='Delete Blocked IP' class='task-action icon icon-trash'></i></a></div></td></tr>";
					}
				}
				return html;
			});

	// Is new allowed domain
	Handlebars.registerHelper("hide_allowed_domains_text", function(data, options){
		if (data && data != "localhost, *")
			return options.inverse(this);
		return options.fn(this);
	});
	
	Handlebars.registerHelper('proToEnterprise', function(plan_type, options)
			{
		var temp = "Free";

		  if(plan_type.indexOf("PRO") >= 0)
			plan_type= plan_type.replace("PRO","ENTERPRISE");

		  var fragments = plan_type.split("_");

		  var interval = "Monthly";
		  if(fragments.length > 1)
		  {
		  	 interval = ucfirst(fragments[1]);
		  	 temp = ucfirst(fragments[0]);

		  	 return temp + " (" + interval+")";
		  }

		    });
	Handlebars.registerHelper('invoice_description', function(description) {

		if (!description)
			return description;

		if (description.indexOf("Unused time on") != -1) {
			description = "Balance from previous transaction";
		} else if (description.indexOf("Remaining") != -1) {
			description = "Changed on " + description.substring(description.indexOf("after") + 5);
		}

		return description + " ";

	});
/**
 * Checks if user loggedin in different instance or not.
 * @param pubnub_message
 */
function check_login_instance(pubnub_message)
{
	
	// Gets current user id
	current_user_id = get_current_user_id();
	
	console.log(pubnub_message);
	// Checks if user logged in has same id as in id received from pubnub
	if(pubnub_message.id && pubnub_message.id == current_user_id)
	{
	
		
		// Reads JESSION ID to compare with 
		JSESSIONID = readCookie("JSESSIONID");
		console.log(JSESSIONID);
		session_id_in_message = pubnub_message.session_id;
	
		if(session_id_in_message == JSESSIONID)
			return;
		
		if(pubnub_message.login_time < get_current_user_loggedin_time())
			return;
		
		pubnub_message["email"] = get_current_user_email();
		
		// Sets cookie to user it in error page to show information. 0.0025 is 10min in approx
		createCookie("_multiple_login", JSON.stringify(pubnub_message), 0.0025);
		
		window.location = "/login?ml=true";
		
		
	}
		
}

/**
 * Gets user logged in time
 * @returns
 */
function get_current_user_loggedin_time()
{
	
	var infoJSON = CURRENT_DOMAIN_USER.info_json_string;
	
	infoJSON = JSON.parse(infoJSON);
	return infoJSON.logged_in_time;
}

function get_current_user_id()
{
	return CURRENT_DOMAIN_USER.id	
}

function get_current_user_email()
{
	return CURRENT_DOMAIN_USER.email	
}


// Publishes user details who logged in to check if someone loggedin with same credentials
function publishLoginEvent(pubnub)
{
	
	var publishJSON = {
			
	};
	publishJSON["type"] = "LOGIN_INSTANCE"
	publishJSON["id"] = CURRENT_DOMAIN_USER.id;
	publishJSON["session_id"] = readCookie("JSESSIONID");
	publishJSON["login_time"] = get_current_user_loggedin_time()
	publishJSON["userAgent"] = getBrowserDetails();
	console.log(getBrowserDetails());
	
	// Message has data.
	pubnub.publish({ channel : CURRENT_DOMAIN_USER.domain, message : publishJSON, callback : function(info)
	{
		console.log(info);
	}});
}

function getBrowserDetails()
{
	var nVer = navigator.appVersion;
	var nAgt = navigator.userAgent;
	var browserName  = navigator.appName;
	var fullVersion  = ''+parseFloat(navigator.appVersion); 
	var majorVersion = parseInt(navigator.appVersion,10);
	var nameOffset,verOffset,ix;

	// In Opera, the true version is after "Opera" or after "Version"
	if ((verOffset=nAgt.indexOf("Opera"))!=-1) {
	 browserName = "Opera";
	 fullVersion = nAgt.substring(verOffset+6);
	 if ((verOffset=nAgt.indexOf("Version"))!=-1) 
	   fullVersion = nAgt.substring(verOffset+8);
	}
	// In MSIE, the true version is after "MSIE" in userAgent
	else if ((verOffset=nAgt.indexOf("MSIE"))!=-1) {
	 browserName = "Microsoft Internet Explorer";
	 fullVersion = nAgt.substring(verOffset+5);
	}
	// In Chrome, the true version is after "Chrome" 
	else if ((verOffset=nAgt.indexOf("Chrome"))!=-1) {
	 browserName = "Chrome";
	 fullVersion = nAgt.substring(verOffset+7);
	}
	// In Safari, the true version is after "Safari" or after "Version" 
	else if ((verOffset=nAgt.indexOf("Safari"))!=-1) {
	 browserName = "Safari";
	 fullVersion = nAgt.substring(verOffset+7);
	 if ((verOffset=nAgt.indexOf("Version"))!=-1) 
	   fullVersion = nAgt.substring(verOffset+8);
	}
	// In Firefox, the true version is after "Firefox" 
	else if ((verOffset=nAgt.indexOf("Firefox"))!=-1) {
	 browserName = "Firefox";
	 fullVersion = nAgt.substring(verOffset+8);
	}
	// In most other browsers, "name/version" is at the end of userAgent 
	else if ( (nameOffset=nAgt.lastIndexOf(' ')+1) < 
	          (verOffset=nAgt.lastIndexOf('/')) ) 
	{
	 browserName = nAgt.substring(nameOffset,verOffset);
	 fullVersion = nAgt.substring(verOffset+1);
	 if (browserName.toLowerCase()==browserName.toUpperCase()) {
	  browserName = navigator.appName;
	 }
	}
	// trim the fullVersion string at semicolon/space if present
	if ((ix=fullVersion.indexOf(";"))!=-1)
	   fullVersion=fullVersion.substring(0,ix);
	if ((ix=fullVersion.indexOf(" "))!=-1)
	   fullVersion=fullVersion.substring(0,ix);

	majorVersion = parseInt(''+fullVersion,10);
	if (isNaN(majorVersion)) {
	 fullVersion  = ''+parseFloat(navigator.appVersion); 
	 majorVersion = parseInt(navigator.appVersion,10);
	}
	
	var OSName="Unknown OS";
	if (navigator.appVersion.indexOf("Win")!=-1) OSName="Windows";
	if (navigator.appVersion.indexOf("Mac")!=-1) OSName="MacOS";
	if (navigator.appVersion.indexOf("X11")!=-1) OSName="UNIX";
	if (navigator.appVersion.indexOf("Linux")!=-1) OSName="Linux";

	var json = {};
	json["browser_name"] = browserName;
	json["full_version"] = fullVersion;
	json["major_version"] = majorVersion;
	json["app_name"] = navigator.appName;
	json["navigator.userAgent"] = navigator.userAgent;
	json["OSName"] = OSName;
	
	return json;

}/**
 * Shows and manages menu list of recently viewed items, on right side of main menu.
 * 
 * Non-static fxn : add_recent_view(model mdl)
 * 						This will add model mdl to the list. This function takes care of order of the list too, with most
 * 						recently viewed model being displayed first.
 * 
 * 						This is the only function necesary outside of this file/module.
 * 
 * @author Chandan
 */

var recent_view;
var recent_view_update_required=false;
var MAX_RECENT=6;

/**
 * Does actual work of populating menu from list.
 */
function populate_recent_menu()
{
	if(!recent_view)
	{	
		var arr = [];
		try{
			arr = JSON.parse(localStorage.recentItems);
		}catch(err){
			
		}
		recent_view = new Base_Collection_View({
//			url: 'core/api/contacts/recent?page_size=5' ,
			restKey: "contacts",
			templateKey: "recent-menu",
			data : arr,
			individual_tag_name: 'li',			
			sort_collection: false,
			postRenderCallback : function(el)
			{								
				$('#recent-menu').append($(el).html());
			}
		});
		
	if(recent_view.collection.length==0)	// default text, when list is empty.
		$('#recent-menu>ul').html('<li class="list-group-item"><a class="disabled" style="color:black;">No Recent Activity</a></li>');
	else {recent_view.render(true);
	}			// populate elements if filled from localStorage
}
}

/**
 * Add/Update model to recent contacts view.
 * Now non functional.
 * @param mdl - the model to add.
 */
function add_recent_view(mdl)
{
	
	if(recent_view==undefined)
		populate_recent_menu();
	
	// Add model to front of the collection, so most frequent ones are on top.
	
	if(!recent_view.collection.get(mdl.get('id'))){
		
		if(recent_view.collection.length>=MAX_RECENT)
			recent_view.collection.pop({silent:true});
		
		recent_view.collection.unshift(mdl);
	}	
	else {
			recent_view.collection.remove(mdl, { silent: true });
		
		recent_view.collection.unshift(mdl);
	}
	
	
	
	recent_view_update_required=true;

	var arr=[];
	
	for(var i=0;i<recent_view.collection.models.length;++i)
	{
		arr.push(recent_view.collection.models[i].attributes);
	}
	
	localStorage.recentItems = JSON.stringify(arr); // save current list to localStorage
}

/**
 * Appropriate action when an entry in drop down menu is clicked.
 * @param id
 */
function modelAction(elem)
{
	var id=elem.dataset['id'];
	var entity=recent_view.collection.get(id);
	var type=entity.attributes.entity_type;
	
	if(type=='contact_entity')
	{
		if(entity.attributes.type == 'COMPANY' ){
			App_Contacts.navigate("company/"+id,{trigger:true});
			$('#companiesmenu').parent().find('.active').removeClass('active');
			$('#companiesmenu').addClass('active');
		} else {
			App_Contacts.navigate("contact/"+id,{trigger:true});
			$('#contactsmenu').parent().find('.active').removeClass('active');
			$('#contactsmenu').addClass('active');
		}
	}	
	else if(type=='deal')
	{
		App_Deal_Details.navigate("deal/"+id,{trigger:true});
		$('#contactsmenu').parent().find('.active').removeClass('active');
		$('#contactsmenu').addClass('active');
	}
	else if(type == 'case')
	{
		updatecases(entity);
	}
	else if(type == 'document' || entity.attributes.network_type)
	{
		updateDocument(entity);
	}
	
	recent_view_update_required=true;
}

$(function(){
	
	// when caret clicked, show the dropdown menu
	$('#recent-menu').on('click',function(e){ 
	
		if(recent_view==undefined)
			populate_recent_menu();
		else if(recent_view_update_required)
			{
			recent_view.render(true);
			}
		
		recent_view_update_required=false;
	});
	
	$('#recent-menu li:first').mouseenter(function(e){
		e.stopPropagation();
		e.preventDefault();
		$(this).css('background-color','white');
	});
	
	// when an entry clicked
	$('#recent-menu').on('click','ul>li',function(e) {
		e.stopPropagation();
		
		var selected_element=$(e.target).closest('[data-id]',$(this));
				// find the id of the element
		
		if(selected_element.length)
			modelAction(selected_element[0]);
		
		// close the drop down menu
		$('#recent-menu').removeClass('open');
		
		return false;
	});	
});

$(function() {
	
	// Request for html5 notification permission.
	request_notification_permission();

});

/**
 * Create the Notification if permissions allowed in the browser.
 * 
 * @method show_desktop_notification
 * 
 * @param {String}
 *            imageURL - image url to show image in popup.
 * @param {String}
 *            title - Notification type.
 * @param {String}
 *            message - Notification message.
 * @param {String}
 *            link - link to navigate when clicked on popup.
 * @param {String}
 *            tag - to set tag property of Notification. Here tag is contact-id + notification-type
 */
function show_desktop_notification(imageURL, title, message, link, tag,timeout) {

	if(!timeout){
		timeout=30000;
	}
		
	var notification = notify.createNotification(title, {
		   body : message,
		   icon : imageURL,
		   tag : tag,
		   onClickCallback : function() {
				
			   window.focus();
				
			   // Open respective block
				Backbone.history.navigate(link, {
					trigger : true
				});

				notification.close();
			 }
		  });
	
	setTimeout(function() {
		notification.close();
	}, timeout);
	
	// Show when tab is inactive
	if (!window.closed)
	{	
		if (notification_prefs.notification_sound != 'no_sound')
			play_sound(notification_prefs.notification_sound);
		
	}
}

/**
 * request_notification_permission request the notification request in case of
 * "0" permissions to allow or denied the notifications.
 * 
 * @method request_notification_permission
 */
function request_notification_permission() {
	
		
	if (notify.permissionLevel() != notify.PERMISSION_DEFAULT)
		  return;
	 
    $('body').on('click', '#set-desktop-notification', function(){
		notify.requestPermission(function() {
			if(notify.permissionLevel() == notify.PERMISSION_GRANTED)
			{	
				$('#set-desktop-notification').css('display', 'none');
			    $('#desktop-notification-content')
					.html(
							"<i>Desktop Notifications are now enabled. <a href=\"#\" id=\"disable-notification\" class=\"text-info\" style=\"text-decoration:underline;\">Disable</a></i>");
			}
			else
			{
				$('#set-desktop-notification').css('display', 'none');
	            $('#desktop-notification-content').html(
					"<i>Desktop Notifications are now disabled. <a href=\"#\" id=\"enable-notification\" class=\"text-info\" style=\"text-decoration:underline;\">Enable</a></i>")
             }	
		});
	});	
}
/**
 * notification.js is a script file to show notifications.pubnub is used to emit
 * data received from server. Notification preferences are fetched for current
 * user.Noty jquery plugin are used to show pop-up messages.
 * 
 * @module Notifications
 */
var notification_prefs;

/**
 * Fetches notification preferences for current user
 */
function downloadAndRegisterForNotifications()
{

	// As of now I know that this function is calling only once after loggin. so Updating due task count in this function;
	getDueTasksCount(function(count){
		var due_task_count= count;
		
		if(due_task_count==0)
			$(".navbar_due_tasks").css("display", "none");
		else
			$(".navbar_due_tasks").css("display", "inline-block");
		if(due_task_count !=0)
			$('#due_tasks_count').html(due_task_count);
		else
			$('#due_tasks_count').html("");

	});
	

	// Download Notification Prefs
	var notification_model = Backbone.Model.extend({ url : 'core/api/notifications' });

	var model = new notification_model();
	model.fetch({ success : function(data)
	{

		// Notification Preferences with respect to current agile user
		notification_prefs = data.toJSON();
		console.log(notification_prefs);

		// Gets domain
		getDomainFromCurrentUser();
	} });
}

/**
 * Gets domain from current user using backbone model.
 */
function getDomainFromCurrentUser()
{
		var domain = CURRENT_DOMAIN_USER['domain'];
		subscribeToPubNub(domain, function(message)
		{

			_setupNotification(message);
		});
}

/**
 * Subscribes to Pubnub.
 * 
 * @param domain -
 *            Domain name.
 */
function subscribeToPubNub(domain)
{
	// Put http or https
	// var protocol = document.location.protocol;
	var protocol = 'https';
	load_urls_on_ajax_stop(protocol + '://pubnub.a.ssl.fastly.net/pubnub-3.4.min.js', function()
	{
		// CREATE A PUBNUB OBJECT
		var pubnub = PUBNUB.init({ 'publish_key' : 'pub-c-e4c8fdc2-40b1-443d-8bb0-2a9c8facd274',
			'subscribe_key' : 'sub-c-118f8482-92c3-11e2-9b69-12313f022c90', ssl : true, origin : 'pubsub.pubnub.com' });
		pubnub.ready();
		pubnub.subscribe({ channel : domain, callback : function(message)
		{
			console.log(message);
			if(message.type  == "LOGIN_INSTANCE")
			{
				check_login_instance(message);
				return;
			}
			
			// shows notification for bulk actions
			if (message.type == "BULK_ACTIONS")
			{
				bulkActivitiesNoty('information', message);
				return;
			}
			
			if (message.type == "EVENT_REMINDER")
			{
				if(CURRENT_DOMAIN_USER['email']==message.useremail){
					getTemplate("event-notification", message, undefined, function(template_ui){
						if(!template_ui)
							  return;
						showNoty('information', $(template_ui), "bottomRight", "EVENT_REMINDER",undefined,3000000);	
					}, null);

					return;
				}
			
			}
			
			
			// shows call notification
			if(message.type == "CALL"){
				getTemplate('call-notification', message, undefined, function(template_ui){
					if(!template_ui)
						  return;

					showNoty('information', $(template_ui), 'bottomRight', "CALL");
				}, null);

				return;
			}

			if(message.type == "UNKNOWN_CALL"){
				getTemplate("unknown-call-notification", message, undefined, function(template_ui){
					if(!template_ui)
						  return;

					showNoty('information', $(template_ui), "bottomRight", "UNKNOWN_CALL");
				}, null);

				return;
			}
			
			if(message.notification == "CAMPAIGN_NOTIFY")
			{
			   var custom_json = JSON.parse(message["custom_value"]);

			   if(custom_json.owner_id == "ALL"){
			   		getTemplate('campaign-notify',message, undefined, function(template_ui){
						if(!template_ui)
							  return;
						showNoty('information', $(template_ui), 'bottomRight',"CAMPAIGN_NOTIFY");
					}, null);
			   }
			   if(custom_json.owner_id == CURRENT_DOMAIN_USER['id']){

			   		getTemplate('campaign-notify', message, undefined, function(template_ui){
						if(!template_ui)
							  return;
						showNoty('information', $(template_ui), 'bottomRight',"CAMPAIGN_NOTIFY");
					}, null);
			   } 
				   
			   return;
			}

			// sets notification for notification preferences.
			_setupNotification(message);
		},
		connect : function()
		{
			console.log("connected");
			publishLoginEvent(pubnub);
		}
		
		});
	});
}

/**
 * Sets notification message
 * 
 * @param object
 *            object data such as contact
 */
function _setupNotification(object)
{
	// Inorder to avoid navigating to the contact
	if (object.notification == 'CONTACT_DELETED')
		object.id = "";

	// gets notification template.
	getTemplate('notify-html', object, undefined, function(template_ui){
		if(!template_ui)
			  return;

		var html = $(template_ui);	
		// Shows notification for link clicked, email opened and browsing.
		notification_for_email_and_browsing(object, html);

		// Verify whether current_user key exists. It doesn't exists when tag added
		// through campaign, or notification for email-clicked etc. since session
		// doesn't exist.
		if ('current_user_name' in object)
		{
			if (notification_prefs.prefs.currentDomainUserName == object.current_user_name)
				return;
		}

		// notification for tags, contact and deal actions.
		notification_for_contact_and_deal(object, html);

	}, null);
}

/**
 * Set up notification for link clicked, email opened and browsing.
 * 
 * @param object -
 *            contact object.
 * @param html -
 *            notification template
 * 
 */
function notification_for_email_and_browsing(object, html)
{

	if (object.notification == 'CLICKED_LINK' || object.notification == 'OPENED_EMAIL' || object.notification == 'IS_BROWSING')
	{
		var option = get_option(object.notification);

		notification_based_on_type_of_contact(option, object, html, object.notification);
		return;
	}
}

/**
 * Checks notification preferences and compare with notification type. If it is
 * set true then show notification. For e.g. If Deal created is true then
 * notification when 'deal is created' is shown.
 * 
 * @param object -
 *            contact or deal object.
 * 
 * @param html -
 *            notification template.
 */
function notification_for_contact_and_deal(object, html)
{
	$.each(notification_prefs, function(key, value)
	{

		if (key == object.notification.toLowerCase())
		{
			if (notification_prefs[key])
			{

				// Replace CONTACT with COMPANY for contact-type COMPANY
				if ((object.notification == "CONTACT_ADDED" || object.notification == "CONTACT_DELETED") && object.type == "COMPANY")
				{
					var company = object.notification.replace('CONTACT', 'COMPANY');
					object.notification = company;
				}

				showNoty('information', html, 'bottomRight', object.notification);
			}
		}

	});
}

/**
 * Verifies whether contact owner is same as notification prefs owner. It is
 * used for 'CONTACT_ASSIGNED' option.
 * 
 * @param contact -
 *            contact object.
 */
function is_assigned(contact)
{

	// Current user who logged_in
	var current_user = notification_prefs.prefs.currentDomainUserName;

	// User who created contact
	var contact_created_by = contact.owner_name;

	// checks for assigned contact
	if (current_user == contact_created_by)
		return true;

	return false;
}

/**
 * Verifies whether contact is assigned and starred (having star value).
 * 
 * @param contact -
 *            contact object.
 */
function is_assigned_and_starred(contact)
{

	// checks assigned and starred
	if (is_assigned(contact) && contact.star_value > 0)
		return true;

	return false;
}

/**
 * Returns notification_prefs value based on notification type for link clicked,
 * email_opened and browsing.
 * 
 * @param notification_type -
 *            CLICKED_LINK or OPENED_EMAIL or IS_BROWSING
 */
function get_option(notification_type)
{
	switch (notification_type) {
	case 'CLICKED_LINK':
		return notification_prefs.link_clicked;
	case 'OPENED_EMAIL':
		return notification_prefs.email_opened;
	case 'IS_BROWSING':
		return notification_prefs.browsing;
	}
}

/**
 * Shows notification for link clicked, email opened and browsing. It verifies
 * for option selected and shows notification accordingly.
 * 
 * @param option -
 *            ANY_CONTACT, CONTACT_ASSIGNED or CONTACT_ASSIGNED_AND_STARRED.
 * @param contact -
 *            contact object
 * @param message -
 *            notification html template.
 * @param notification_type -
 *            CLICKED_LINK or OPENED_EMAIL or IS_BROWSING
 */
function notification_based_on_type_of_contact(option, contact, message, notification_type)
{
	switch (option) {
	case 'CONTACT_ASSIGNED':
		if (is_assigned(contact))
			showNoty("information", message, "bottomRight", notification_type);
		break;
	case 'CONTACT_ASSIGNED_AND_STARRED':
		if (is_assigned_and_starred(contact))
			showNoty("information", message, "bottomRight", notification_type);
		break;
	case 'ANY_CONTACT':
		showNoty("information", message, "bottomRight", notification_type);
		break;
	}

}

/**
 * Checks html5 notifications browser settings. If desktop notifications are
 * enabled, shows enabled message and similarly for disabled.
 * 
 * @param el -
 *            backbone el element.
 */
function check_browser_notification_settings(el)
{

	// Verify desktop notification settings.
	// Check if browser support
	if (notify && !notify.isSupported)
	{
		$('#set-desktop-notification').css('display', 'none');
	}

	// Allowed
	if (notify && notify.isSupported && notify.permissionLevel() == notify.PERMISSION_GRANTED)
	{
		$('#set-desktop-notification').css('display', 'none');
		$('#desktop-notification-content')
				.html(
						"<i>Desktop Notifications are now enabled. <a href=\"#\" id=\"disable-notification\" class=\"text-info\" style=\"text-decoration:underline;\">Disable</a></i>");
	}

	// Denied
	if (notify && notify.isSupported && notify.permissionLevel() == notify.PERMISSION_DENIED)
	{
		$('#set-desktop-notification').css('display', 'none');
		$('#desktop-notification-content')
				.html(
						"<i>Desktop Notifications are now disabled. <a href=\"#\" id=\"enable-notification\" class=\"text-info\" style=\"text-decoration:underline;\">Enable</a></i>")
	}

	// notification enable help
	$('#enable-notification', el).on('click', function(e)
	{
		e.preventDefault();
        // Checking modal existance
		if($('#notification-enable-help-modal').length == 0){
			   getTemplate('notification-enable-help-modal', {}, undefined, function(template_ui){
			 		if(!template_ui)
			    		return;
					$("body").append($(template_ui)); 
				}, null);

		}

		$('#notification-enable-help-modal').modal("show");
	});

	// notification disable help
	$('#disable-notification', el).on('click', function(e)
	{
		e.preventDefault();
		 // Checking modal existance
		if($('#notification-disable-help-modal').length == 0){
			   getTemplate('notification-disable-help-modal', {}, undefined, function(template_ui){
			 		if(!template_ui)
			    		return;
					$("body").append($(template_ui)); 
				}, null);

		}

		$('#notification-disable-help-modal').modal("show");
	});
}

/**
 * Shows bootstrap switch changes accordingly. It disables all the options when
 * off and enables when on.
 * 
 * @param el-
 *            backbone el element
 * 
 */
function showSwitchChanges(el)
{
	
	$('#control_notifications').off('change').on('change',function(){
		var status = $('#notification-switch').bootstrapSwitch('status');

		// if ON - status is true
		if (status)
		{
			$(el).find('input[type=checkbox]').not('#control_notifications,#notification_sound').removeAttr('disabled');
			$(el).find('select').not('#control_notifications').removeAttr('disabled');
		}
		else
		{
			$(el).find('input[type=checkbox]').not('#control_notifications').attr('disabled', 'disabled');
			$(el).find('select').not('#control_notifications, #notification_sound').attr('disabled', 'disabled');
		}

	});	
}

/**
 * Runs jquery noty plugin for notification pop-ups when desktop permission is
 * not given.
 * 
 * @param type -
 *            noty types like information, warning etc.
 * @param message -
 *            html content for notification
 * @param position -
 *            position of pop-up within the webpage.
 * @param notification_type -
 *            notification type - TAG_CREATED, TAG_DELETED etc.
 */
function showNoty(type, message, position, notification_type, onCloseCallback,timeout)
{
	if(!timeout){
		timeout=30000;
	}
	// Don't show notifications when disabled by user. Neglect campaign ones
	if(notification_type != "EVENT_REMINDER" ){
	
	if (notification_type != "CAMPAIGN_NOTIFY"&& !notification_prefs.control_notifications)
		return;
	}

	// Check for html5 notification permission.
	if (notify && notify.isSupported && notify.permissionLevel() == notify.PERMISSION_GRANTED)
	{
		if(notification_type=="CALL"){
			show_desktop_notification($('span:eq(0)', message).attr('id'), $(message).find('#calling-contact-id').text(),
									  $(message).find('#call-notification-text').text(), $(message).find('#calling-contact-id').attr('href'),
									  $(message).find('#calling-contact-id').attr('href').split('/')[1] + '-' + "CALL");
			return;
		}
		if(notification_type=="UNKNOWN_CALL"){
			show_desktop_notification($('span:eq(0)', message).attr('id'), $(message).find("#unknown-contact-name").text(),$(message).find("#unknown-call-notification-text").text(),
										$(message).find("#unknown-contact-name").attr('href'),
										$(message).find("#unknown-contact-name").attr('href').split('/')[2]+'-'+"UNKNOWN_CALL");
			return;
		}
		if(notification_type=="CAMPAIGN_NOTIFY"){
			show_desktop_notification($('span:eq(0)', message).attr('id'), $(message).find('#campaign-contact-id').text(),
									  $(message).find('#campaign-notify-text').text(), $(message).find('#campaign-contact-id').attr('href'),
									  $(message).find('#campaign-contact-id').attr('href').split('/')[1] + '-' + "CAMPAIGN_NOTIFY");
			return;
		}
		
		if(notification_type=="EVENT_REMINDER"){
			
			show_desktop_notification(getImageUrl(message,notification_type), getNotificationType(notification_type), getTextMessage(message), getId(message), getId(message).split(
			'/')[1] + '-' + notification_type,3000000);
			return;
		}
		
		
		show_desktop_notification(getImageUrl(message,notification_type), getNotificationType(notification_type), getTextMessage(message), getId(message), getId(message).split(
				'/')[1] + '-' + notification_type);
		return;
	}

	// Download the lib
	head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH + 'lib/noty/layouts/bottomRight.js', LIB_PATH + 'lib/noty/layouts/bottom.js',
			LIB_PATH + 'lib/noty/themes/default.js', function()
			{

			var n = noty({ text : message, layout : position, type : type, timeout : timeout, 
			
				closeCallback : 
					(onCloseCallback && typeof onCloseCallback == 'function') ? onCloseCallback : undefined,
				callback : {
					// If on close callback is defined, callback is called after noty is closed. Small hack; because noty close callback in lib is badly implemented 
					// and one callback gets called on other noty action
					onClose : function(){
						console.log(this);
						if(this.options.closeCallback && typeof this.options.closeCallback == 'function')
							{
								this.options.closeCallback ();
							}
					}
				}
			});
				
				console.log(n);

				// Play sounds for only user notifications
				if (n.options.type == 'information')
				{
					if (notification_prefs.notification_sound != 'no_sound')
						play_sound(notification_prefs.notification_sound);
				}

				// Set the handler for click
				$('.noty_bar').on('click', function()
				{

					// // warning type is used for upgrade. So when cliked on it
					// navigate to subscribe.
					// if(n.options.type == "warning")
					// {
					// // Send to upgrade page
					// Backbone.history.navigate('subscribe', {
					// trigger : true
					// });
					// }

					// information type is used for user notification. When
					// clicked
					// navigate to link.
					if (n.options.type == "information")
					{
						var link = $(this).find("a").attr("href");
						if(link)
						Backbone.history.navigate(link, { trigger : true });
					}

				});
			});
}

/** HTML5 Desktop Notification utility methods. Depends on notification template.*/
/**
 * Returns required text from notification template as html5 doesn't allow html.
 * 
 * @param {String}
 *            message - notification template.
 */
function getTextMessage(message)
{
	var name;
	var type = $(message).find('#notification-type').text();

	if ($(message).find('#notification-contact-id').text() != "")
	{
		name = $(message).find('#notification-contact-id').text();
		return name + " " + type;
	}
	
	if ($(message).find('#noty_text').text() != "")
	{
		name = $(message).find('#noty_text').text();
		return name;
	}

	name = $(message).find('#notification-deal-id').text();
	return name + " " + type;
}



/**
 * Returns converted notification-type. E.g., TAG_ADDED to New Tag
 */
function getNotificationType(notification_type)
{
	if (notification_type == "CONTACT_ADDED" || notification_type == "COMPANY_ADDED" || notification_type == "TAG_ADDED" || notification_type == "DEAL_CREATED")
		return "New " + ucfirst(notification_type.split('_')[0]);

	if (notification_type == "IS_BROWSING")
		return ucfirst(notification_type.split('_')[1]);
	return ucfirst(notification_type.split('_')[0]) + " " + ucfirst(notification_type.split('_')[1]);
}

/**
 * Returns required contact-id or deal-id from notification template. This
 * allows to return to respective page when clicked on notification.
 * 
 * @param {String}
 *            message - notification template.
 */
function getId(message)
{
	if(($(message).find('#noty_text').text() != "")){
		return $(message).find('#noty_text').text();
	}
	
	if ($(message).find('#notification-contact-id').text() != "")
	{
		return $(message).find('#notification-contact-id').attr('href');
	}
	return $(message).find('#notification-deal-id').attr('href');
}

/**
 * Returns image url from notification template to display image.
 * 
 * @param {String}
 *            message - notification template.
 *            
 * @param {String}
 *            notification_type - notification-type like COMPANY_ADDED, DEAL_ADDED etc.
 */
function getImageUrl(message, notification_type)
{
	if(notification_type == "EVENT_REMINDER"){
		
		return '/img/eventreminder.png';
	}
	
	if ($(message).find('#notification-contact-id').text() != "")
		{
		
		// if contact is company fetch company url
		if(notification_type === 'COMPANY_ADDED' || notification_type === 'COMPANY_DELETED')
			return $('span:eq(1)', message).attr('id');
		
		return $('span:eq(0)', message).attr('id');
		}

	return '/img/deal.png';
}
/** End of HTML5 Desktop Notification utility methods*/

/**
 * Plays notification sounds on clicking on play button.
 */
function notification_play_button()
{
	// Play notification sound when clicked on play icon.
	$('body').on('click', '#notification-sound-play', function(e)
	{
		e.preventDefault();

		var sound = $('#notificationsForm #notification_sound').find(":selected").val();

		// silent
		if (sound == 'no_sound')
			return;

		// plays sound
		play_sound(sound);
	});

}(function(milestone_util, $, undefined) {
	
	milestone_util.HARD_RELOAD_MILESTONES = false;
	
	var wonIcon = "<i title='Make Milestone Won' class='task-action icon icon-like'></i>";
	var lostIcon = "<i title='Make Milestone Won' class='task-action icon icon-dislike'></i>";
	milestone_util.wonMsg = 'Deals with this milestone are considered as Won.';
	milestone_util.lostMsg = 'Deals with this milestone are considered as Lost.';
	var milestoneMsg = "For better deal reports and sales forecasting, please set your 'Won' and 'Lost' milestones in the <i style='text-decoration:underline;'>Deal settings</i> page.";
	milestone_util.isNotyVisible = true;
	milestone_util.showMilestonePopup = function(track){
		
		if(!(track.lost_milestone && track.won_milestone) || track.won_milestone.length == 0 || track.lost_milestone.length == 0){
			setDefaultLostAndWon(track,function(newTrack){
				if(!(newTrack.lost_milestone && newTrack.won_milestone)){
					milestone_util.showMilestoneNoty();
					milestone_util.isNotyVisible = true;
				}
				return newTrack;
			});
		}
	};
	
	milestone_util.showMilestoneNoty = function(){
		
		// If route is subscribe, it will remove existing noty and returns. If there is not existy nagger noty, it will just return
		if(Current_Route.indexOf('deal') == 0)
		{
			if(Nagger_Noty)
				$.noty.closeAll();
			//return;
		}
		
		if(milestone_util.isNotyVisible)
			return;
		
		// If Noty is present already, then noty is initiated again
		if(Nagger_Noty && $("#" +Nagger_Noty).length > 0)
			return;
		
		setTimeout(function(){ 
			// Show the first one after 3 secs
			showNotyPopUp("warning", milestoneMsg, "topCenter", "none", function(){
					$.noty.close(Nagger_Noty);
					Nagger_Noty = null;
					Backbone.history.navigate('milestones', {
						 trigger : true
						 });
				});
			
			setTimeout(function(){
				$.noty.closeAll();
			}, 10000);
		
		}, 4000);
		milestone_util.isNotyVisible = true;
			
	};
	
	var setWon = function(track,callback){
		var url = 'core/api/milestone/won';
		var input = {};
		input.pipeline_id = track.id;
		input.milestone = track.won_milestone;
		$.ajax({ url : url, type : 'POST', data : input, contentType : "application/x-www-form-urlencoded", success : function(data)
			{
				if(callback)
					callback();
			}});
	};
	
	var setLost = function(track,callback){
		var url = 'core/api/milestone/lost';
		var input = {};
		input.pipeline_id = track.id;
		input.milestone = track.lost_milestone;
		$.ajax({ url : url, type : 'POST', data : input, contentType : "application/x-www-form-urlencoded", success : function(data)
			{
				if(callback)
					callback();
			}});
	};
	
	var setDefaultLostAndWon = function(track, callback){
		var milestones = track.milestones.split(',');
		$.each(milestones, function(index, val){
			if(val.toUpperCase() == 'WON' && (track.won_milestone == undefined || track.won_milestone.length==0) && val != track.lost_milestone){
				track.won_milestone = val;
				setWon(track);
			} else if(val.toUpperCase() == 'LOST' && (track.lost_milestone == undefined || track.lost_milestone.length==0) && val != track.won_milestone){
				track.lost_milestone = val;
				setLost(track);
			}
				
		});
		
		if(callback)
			callback(track);
	};
	
	milestone_util.savePipelineForm = function(formId,callback){
		var mile = serializeForm(formId);
    	console.log('---------',mile);
		// Saving that pipeline object
    	var pipeline = new Backbone.Model();
    	pipeline.url = '/core/api/milestone';
    	pipeline.save(mile, {
    		// If the milestone is changed, to show that change in edit popup if opened without reloading the app.
    		success : function(model, response) {
    			if(milestone_util.HARD_RELOAD_MILESTONES)
    				App_Admin_Settings.milestones();
    			if(callback)
    				callback(response);
    		},
			error: function(data,response){
				console.log(response);
			}
    	});
	};
	
	var setWonMilestone = function(ele){
		var wonMilestone = ele.closest('tr').attr('data');
		if(wonMilestone != undefined && wonMilestone.length > 0){
			var formId = ele.closest('form').attr('id');
			$('#'+formId).find('input[name="won_milestone"]').val(wonMilestone);
			var container = ele.closest('tr');
			if(container.find('i.mark-lost').length > 0){
				container.find('i.mark-lost').remove();
				container.find('.milestone-lost').removeClass('disabled');
				$('#'+formId).find('input[name="lost_milestone"]').val('');
			}
			milestone_util.savePipelineForm(formId,function(resp){
				$('#'+formId+' .milestone-won').removeClass('disabled');
				$('#'+formId+' i.mark-won').remove();
				container.find('.milestone-name-block').append("<i data-toogle='tooltip' title='"+milestone_util.wonMsg+"' class='icon-like mark-won m-l-sm'></i>");
				container.find('a.milestone-won').addClass('disabled');
				$('.mark-won',container).tooltip();
				App_Admin_Settings.pipelineGridView.collection.get(resp.id).set('won_milestone',resp.won_milestone, {silent:true});
			});
		}
	};
	
	var setLostMilestone = function(ele){
		var lostMilestone = ele.closest('tr').attr('data');
		if(lostMilestone != undefined && lostMilestone.length > 0){
			var formId = ele.closest('form').attr('id');
			$('#'+formId).find('input[name="lost_milestone"]').val(lostMilestone);
			var container = ele.closest('tr');
			if(container.find('i.mark-won').length > 0){
				container.find('i.mark-won').remove();
				container.find('.milestone-won').removeClass('disabled');
				$('#'+formId).find('input[name="won_milestone"]').val('');
			}
			milestone_util.savePipelineForm(formId,function(resp){
				$('#'+formId+' .milestone-lost').removeClass('disabled');
				$('#'+formId+' i.mark-lost').remove();
				container.find('.milestone-name-block').append("<i data-toogle='tooltip' title='"+milestone_util.lostMsg+"' class='icon-dislike mark-lost m-l-sm'></i>");
				container.find('a.milestone-lost').addClass('disabled');
				$('.mark-lost',container).tooltip();
				App_Admin_Settings.pipelineGridView.collection.get(resp.id).set('lost_milestone',resp.lost_milestone, {silent:true});
			});
		}
	};
	
	var initEvents = function(el){
		$('#milestone-listner').on('click', '.milestone-won', function(e){
		//$('.milestone-won').die().live('click',function(e){
			e.preventDefault();
			if(!$(this).hasClass('disabled'))
				setWonMilestone($(this));
		});
		
		$('#milestone-listner').on('click', '.milestone-lost', function(e){
		//$('.milestone-lost').die().live('click',function(e){
			e.preventDefault();
			if(!$(this).hasClass('disabled'))
				setLostMilestone($(this));
		});
		
		$('.milestone-won, .milestone-lost, .mark-won, .mark-lost, .milestone-delete',el).tooltip();
		
	};
	
	milestone_util.init = function(el){
		initEvents();
	};
	
}(window.milestone_util = window.deal_bulk_actions || {}, $));/** 
 * To perform actions on deals arranged in milestones 
 * using sortable.js when it is dropped in middle or dragged over.
 */
function setup_deals_in_milestones(id){
	head.js(LIB_PATH + 'lib/jquery-ui.min.js', function() {
		$('ul.milestones').sortable({
		      connectWith : "ul",
		      cursor : "move",
		      containment : "#" + id ,
		      scroll : false,
		      // When deal is dragged to adjust the horizontal scroll
		      change : function(event, ui){
		    	  var width = $('#' + id + ' > div').width();
		    	  var scrollX = $('#' + id + ' > div').scrollLeft();
		    	  if(event.pageX > (width * 0.9))
		    		  $('#' + id + ' > div').scrollLeft(scrollX + 10);
		    	  else if(event.pageX < (width * 0.1))
		    		  $('#' + id + ' > div').scrollLeft(scrollX - 15);
		      },
		      // When deal is dropped its milestone is changed 
		      update : function(event, ui) {
		      	  console.log(">>>>>>>>>>>>>>>>>> deals id");
		    	  console.log(ui);
		    	  console.log(ui.item[0]);
		    	  console.log(ui.item[0].id);
					var id = ui.item[0].children[0].id;
						console.log('paging...',id);
						var old_milestone = $('#'+id).attr('data');
						console.log('old...',old_milestone);
						var dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : old_milestone });
						if(!dealPipelineModel)
							return;
						var dealModel = dealPipelineModel[0].get('dealCollection').get(id);
						var newMilestone = ($('#'+id).closest('ul').attr("milestone")).trim();
						console.log('new...',newMilestone);
						if(dealModel && dealModel.collection){
							App_Deals.dealModel = dealModel;
							App_Deals.newMilestone = newMilestone;
							App_Deals.old_milestone = old_milestone;
							App_Deals.lost_reason_milesone_id = id;
							var milestone_model_view = new Base_Model_View({ url : '/core/api/milestone/'+dealModel.collection.get(id).get('pipeline_id'), template : "" });
							milestone_model_view.model.fetch({
								success: function(data){
									var jsonModel = data.toJSON();
									console.log("jsonModel.lost_milestone----"+jsonModel.lost_milestone);
									console.log("newMilestone----"+newMilestone);
									console.log("old_milestone----"+old_milestone);
									if(jsonModel.lost_milestone == newMilestone && newMilestone != old_milestone){
										console.log("Success if block");
										App_Deals.deal_lost_reason_for_update = "";
										populateLostReasons($('#dealLostReasonModal'), undefined);
										$('#deal_lost_reason',$('#dealLostReasonModal')).removeClass("hidden");
										$('#dealLostReasonModal > .modal-dialog > .modal-content > .modal-footer > a#deal_lost_reason_save').text('Save');
										$('#dealLostReasonModal > .modal-dialog > .modal-content > .modal-footer > a#deal_lost_reason_save').attr('disabled',false);
										$('#'+id).attr('data',newMilestone);
									}
									if(jsonModel.won_milestone == newMilestone && newMilestone != old_milestone){
										$('#deal_won_date_' + id).find('small').text(getDateInFormatFromEpoc(new Date().getTime()/1000));
										$('#deal_won_date_' + id).removeClass("hide");
									}else if(jsonModel.won_milestone != newMilestone && newMilestone != old_milestone){
										$('#deal_won_date_' + id).addClass("hide");
									}
									hideTransitionBar();
								}
							});
						}
						if(dealModel){
							update_milestone(dealModel, id, newMilestone, old_milestone,true, "");
						}
						$('#'+id).attr('data',newMilestone);
					
		        }
	    });

	});
}

/** 
 * To change the milestone of the deal when it is 
 * dropped in other milestone columns and saves or updates deal object.
 */
function update_milestone(data, id, newMilestone, oldMilestone, updateCollectionFlag, lost_reason_id){
	
	var DealJSON = data.toJSON();
	
	console.log(DealJSON);
	DealJSON.milestone = newMilestone;
	DealJSON.lost_reason_id = lost_reason_id;
	// Replace notes object with note ids
	var notes = [];
	$.each(DealJSON.notes, function(index, note)
	{
		notes.push(note.id);
	});
	
	console.log(notes);
	
	DealJSON.notes = notes;
	if(DealJSON.note_description)
		delete DealJSON.note_description;
	
	 if(!DealJSON.close_date || DealJSON.close_date==0)
		 DealJSON.close_date = null;
	 DealJSON.owner_id = DealJSON.owner.id;
   // Saving that deal object
	var up_deal = new Backbone.Model();
	up_deal.url = '/core/api/opportunity';
	up_deal.save(DealJSON, {
		// If the milestone is changed, to show that change in edit popup if opened without reloading the app.
		success : function(model, response) {
			console.log('moved deal----',model);
			if (updateCollectionFlag) {
				update_deal_collection(model.toJSON(), id, newMilestone, oldMilestone);
			}
		}
	});

}

/**
 * Update the deals in the collection when user drag and drops.
 * @param dealModel 
 * 			updated deal model.
 * @param id 
 * 			id of the updated deal.
 * @param newMilestone
 * 			milestone where user drop the deal.
 * @param oldMilestone 
 * 			milestone from user drag the deal.
 */
function update_deal_collection(dealModel, id, newMilestone, oldMilestone) {
	
	// Remove the deal from the old milestone collection.
	var dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : oldMilestone });
	if(!dealPipelineModel)
		return;
	try{
		$('#'+newMilestone.replace(/ +/g, '')+'_count').text(parseInt($('#'+newMilestone.replace(/ +/g, '')+'_count').text())+1);
		$('#'+oldMilestone.replace(/ +/g, '')+'_count').text(parseInt($('#'+oldMilestone.replace(/ +/g, '')+'_count').text())-1);
	} catch(err){
		console.log(err);
	}
	
	dealPipelineModel[0].get('dealCollection').remove(dealPipelineModel[0].get('dealCollection').get(id));

	// Add the deal in to new milestone collection.
	dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : newMilestone });
	if(!dealPipelineModel)
		return;

	dealPipelineModel[0].get('dealCollection').add(copyCursor(dealPipelineModel, dealModel), { silent : true });
}

/**
 * Sets milestones as sortable list.
 */
function setup_milestones(el){
	head.js(LIB_PATH + 'lib/jquery-ui.min.js', function() {
		$(el).find('tbody').each(function(index){
			var id = $(this).closest('form').find('input[name="id"]').val();
			$(this).sortable({
			      containment : "#milestone-values-"+id,
			      items:'tr',
			      helper: function(e, tr){
			          var $originals = tr.children();
			          var $helper = tr.clone();
			          $helper.children().each(function(index)
			          {
			            // Set helper cell sizes to match the original sizes
			            $(this).width($originals.eq(index).width());
			            console.log('-----------'+$originals.eq(index).width());
			            $(this).css("background","#f5f5f5");
			            $(this).css("border-bottom","1px solid #ddd");
			          });
			          return $helper;
			      },
			      start: function(event, ui){
			    	  $.each(ui.item.children(),function(index,ele){
			    		  ui.helper.children().eq(index).width(ui.helper.children().eq(index).width()-$(this).width());
			    	  });
			    	  ui.helper.width(ui.helper.width());
			      },
			      sort: function(event, ui){
			    	  ui.helper.css("top",(ui.helper.offset().top+ui.item.offset().top)+"px");
			      },
			      forceHelperSize:true,
			      placeholder:'<tr><td></td></tr>',
			      forcePlaceholderSize:true,
			      handle: ".icon-move",
			      cursor: "move",
			      tolerance: "intersect",
			      
			      // When milestone is dropped its input value is changed 
			      update : function(event, ui) {
			    	  console.log($(ui.item).attr('data'));
			    	  fill_ordered_milestone($(ui.item).closest('form').attr('id'));
			        }
		    });
		});
	});
}

/**
 * To capitalize and trim the given string 
 */
function capitalize_string(str){
	str = str.trim().replace(/\b[a-z]/g, function(x) {
  		    return x.toUpperCase();
  		});
	return str;
}

/**
 * Edits the value of milestone when sorted or added new or removes milestone.
 */
function fill_ordered_milestone(formId){
   	var values;
   	$('#'+formId).find("tbody").find("tr").each(function(index, data) { 
   		if($(data).is( ":visible"))
   		{
   			// To capitalize the string
   	   		if(values != undefined)
   	   			values = values + "," + capitalize_string(($(data).attr("data")).toString());
   	   		else 
   	   			values = capitalize_string(($(data).attr("data")).toString());
   		}
	});
   	
   	// To remove the ending "," if present
   	if(values && values.charAt((values.length)-1) == ",")
   		values = values.slice(0, -1);

   	$("#"+formId).find( 'input[name="milestones"]' ).val(values); 
   	$('#admin-settings-milestones-model-list').find('form').each(function(index){
		var mile = serializeForm($(this).attr('id'));
    	console.log('---------',mile);
    	App_Admin_Settings.pipelineGridView.collection.get(mile.id).set('milestones',mile.milestones, {silent:true});
    	// Saving that pipeline object
    	var pipeline = new Backbone.Model();
    	pipeline.url = '/core/api/milestone';
    	pipeline.save(mile);
	});
}
(function(deal_bulk_actions, $, undefined) {
	
	var changOwner = null;
	var archiveDeals = null;
	var restoreDeals = null;
	var deleteDeals = null;
	var dealConAddTag = null;
	var dealConAddCamp = null;
	var filterJSON = null;
	
	var reload_deals = false;
	deal_bulk_actions.SELECT_ALL_DEALS = false;
	var message = 'Bulk operation is in progress. You will be notified when it is done.';
	var el = null;
	
	var numberWithCommas = function(num) {
	    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}
	
	var postBulkActionDealsData = function(url, form_id, callback, error_message){
		
		var input = {};
		if(!deal_bulk_actions.SELECT_ALL_DEALS)
			input.ids = JSON.stringify(getDealsBulkIds());
		input.filter = JSON.stringify(filterJSON);
		if(form_id){
			input.form = JSON.stringify(serializeForm(form_id));
		}
		console.log(input);
		// Ajax request to post data
		$.ajax({ url : url, type : 'POST', data : input, contentType : "application/x-www-form-urlencoded", success : function(data)
		{

			$save_info = $('<div style="display:inline-block"><small><p class="text-success"><i>Task Scheduled.</i></p></small></div>');

			if(form_id !== undefined)
			{
				var save_msg=$('#'+form_id).find('.form-actions');
			
				if(save_msg.find('.text-success'))
					save_msg.find('.text-success').parent().parent().remove(); // erase previous message.

				save_msg.append($save_info);
			}
			
			reload_deals = true;

			if (callback && typeof (callback) === "function")
				callback(data);

			// On save back to deals list
			// Backbone.history.navigate("deals", { trigger : true });  
			//setTimeout(App_Deals.deals(),100);
			// If no_noty is given as error message, neglect noty
			if(error_message === "no_noty")
				return;
			
			if(!error_message)
				{
					showNotyPopUp('information', "Task scheduled", "top", 5000);
					return;
				}
				showNotyPopUp('information', error_message, "top", 5000);
		} });
	}
	
	var bulkRestoreDeals = function(){
		console.log('restore',getDealsBulkIds());
		console.log('archive',getDealsBulkIds());
		var url = '/core/api/opportunity/bulk/restore';
		postBulkActionDealsData(url,undefined,function(){
			$("#deal_bulk_restore_modal").modal('hide');
		},message);
	};
	
	var bulkArchiveDeals = function(){
		console.log('archive',getDealsBulkIds());
		var url = '/core/api/opportunity/bulk/archive';
		postBulkActionDealsData(url,undefined,function(){
			$("#deal_bulk_archive_modal").modal('hide');
		},message);
	};
	
	var bulkOwnerChangeDeals = function(){
		console.log('change owner',getDealsBulkIds());
		console.log('archive',getDealsBulkIds());
		var owner_id = $("#owners-list-bulk", $("#deal_owner_change_modal")).val();
		var url = '/core/api/opportunity/bulk/change-owner/'+owner_id;
		postBulkActionDealsData(url,undefined,function(){
			$("#deal_owner_change_modal").modal('hide');
		},message);
	};
	
	var bulkAddDealContactsToCamp = function(saveBtn){
		// Disables save button to prevent multiple click event issues
		disable_save_button(saveBtn);
		
		var workflow_id = $("#workflows-list-bulk", $("#deal_contact_add_camp_modal")).val();
		var url = '/core/api/opportunity/bulk/contacts/add-campaign/'+workflow_id;
		postBulkActionDealsData(url,undefined,function(){
			// Removes disabled attribute of save button
			enable_save_button(saveBtn);
			$("#deal_contact_add_camp_modal").modal('hide');
		},message);
	};
	
	var bulkAddDealContactTags = function(saveBtn){
		
		// Returns, if the save button has disabled attribute
		if (saveBtn.attr('disabled'))
			return;

		// Disables save button to prevent multiple click event issues
		disable_save_button(saveBtn);//$(saveBtn).attr('disabled', 'disabled');
		
		var form = 'dealContactTagsBulkForm';
		
		var tags = serializeForm(form).tags;
		
		if(tags.length == 0)
		{
			$('#addBulkTags').focus();
			$('.error-tags').show().delay(3000).hide(1);
			// Removes disabled attribute of save button
			enable_save_button(saveBtn);//$(saveBtn).removeAttr('disabled');
			return false;
		}
		
		if (tags.length > 0)
		{
			var tags_valid = true;
			$.each(tags, function(index, value)
				{
					if(!isValidTag(value, false)) {
						tags_valid = false;
						return false;
					}
				});
			if(!tags_valid) {
				$('.invalid-tags').show().delay(6000).hide(1);
				enable_save_button(saveBtn);
				return false;
			}
			
			// To add input field value as tags
			var tag_input = $('#addBulkTags').val().trim();
			$('#addBulkTags').val("");
			
			if(tag_input && tag_input.length>=0 && !(/^\s*$/).test(tag_input))
			{
				$('#addBulkTags').closest(".control-group").find('ul.tags').append('<li class="tag" style="display: inline-block;" data="'+tag_input+'">'+tag_input+'<a class="close" id="remove_tag" tag="'+tag_input+'">&times</a></li>');
			}
		
			var url = '/core/api/opportunity/bulk/contacts/add-tag';
			postBulkActionDealsData(url,form,function(){
				enable_save_button(saveBtn);
				$('ul.tagsinput',$("#deal_contact_add_tag_modal")).html('');
				$("#deal_contact_add_tag_modal").modal('hide');
			},message);
		}
	};
	
	var bulkDeleteDeals = function(){
		console.log('Delete',getDealsBulkIds());
		var url = '/core/api/opportunity/bulk';
		postBulkActionDealsData(url,undefined,function(){
			$("#deal_bulk_delete_modal").modal('hide');
		},message);
	};
	
	var bulkMilestoneChange = function(saveBtn){
		// Returns, if the save button has disabled attribute
		if (saveBtn.attr('disabled'))
			return;

		// Disables save button to prevent multiple click event issues
		disable_save_button(saveBtn);//$(saveBtn).attr('disabled', 'disabled');
		
		var form = 'bulk_mile_Form';
		if(!isValidForm('#'+form)){
			// Removes disabled attribute of save button
			enable_save_button(saveBtn);//$(saveBtn).removeAttr('disabled');
			return false;
		}
		var url = '/core/api/opportunity/bulk/change-milestone';
		postBulkActionDealsData(url,form,function(){
			enable_save_button(saveBtn);
			$("#deal_mile_change_modal").modal('hide');
		},message);
	};
	
	var getAvailableDeals = function() {
		if(App_Deals.opportunityCollectionView && App_Deals.opportunityCollectionView.collection.length > 0){
			var temp = 	App_Deals.opportunityCollectionView.collection.models[0].toJSON();
			if(temp.count)
				return temp.count;
		}
		return App_Deals.opportunityCollectionView.collection.length;
	};
	
	var getDealsBulkIds = function(){
		var check_count = 0
		var id_array = [];
		$.each($('.tbody_check',el), function(index, element)
		{
			if ($(element).is(':checked'))
			{
				check_count++;
				id_array.push($(element).closest('tr').data().get('id'));
			}
			// return;
		});
		console.log('Number of deals selected = ',check_count);
		return id_array;
	};
	
	
	deal_bulk_actions.init_dom = function(ele){
		el = ele;
		changeOwner = $('#deal-bulk-owner');
		archiveDeals = $('#deal-bulk-archive');
		restoreDeals = $('#deal-bulk-restore');
		deleteDeals = $('#deal-bulk-delete');
		dealConAddTag = $('#deal-contact-add-tag');
		dealConAddCamp = $('#deal-contact-add-camp');
		filterJSON = $.parseJSON(readCookie('deal-filters'));
		
		changeOwner.on('click',function(e){
			e.preventDefault();
			bulkOwnerChangeDeals();
		});
		
		archiveDeals.on('click',function(e){
			e.preventDefault();
			bulkArchiveDeals();
		});
		
		restoreDeals.on('click',function(e){
			e.preventDefault();
			bulkRestoreDeals();
		});
		
		deleteDeals.on('click',function(e){
			e.preventDefault();
			bulkDeleteDeals();
		});
		
		dealConAddTag.on('click',function(e){
			e.preventDefault();
			bulkAddDealContactTags($(this));
		});
		
		dealConAddCamp.on('click',function(e){
			e.preventDefault();
			bulkAddDealContactsToCamp($(this));
		});
		
		$('body').on('change', '#pipeline-list-bulk', function(e) {
			populateMilestones($("#deal_mile_change_modal"), undefined,$(this).val(), undefined, function(data){
				$("#milestone-list-bulk").html(data);
				$("#milestone-list-bulk").closest('div').find('.loading-img').hide();
				$('#pipeline-name').val($("#pipeline-list-bulk option:selected").text());
			});
		});
		
		$('body').on('click', '#deal-bulk-mile', function(e) {
			e.preventDefault();
			bulkMilestoneChange($(this));
		});
		
		$('body').on('click', '#select-all-available-deals', function(e) {
			e.preventDefault();
			deal_bulk_actions.SELECT_ALL_DEALS = true;
			$('body').find('#bulk-select').html("Selected " + numberWithCommas(getAvailableDeals()) + " deals. <a id='select-choosen-deals' href='#'>Select choosen deals only.</a>");
		});
		
		$('body').on('click', '#select-choosen-deals', function(e) {
			e.preventDefault();
			deal_bulk_actions.SELECT_ALL_DEALS = false;
			$('body').find('#bulk-select').html("Selected " + numberWithCommas(App_Deals.opportunityCollectionView.collection.length) + " deals. <a id='select-all-available-deals' class='text-info' href='#'>Select all " + numberWithCommas(getAvailableDeals()) + " deals</a>");
		});
		
		$(".deal_bulk_modal").on('show.bs.modal',function(){
			if(deal_bulk_actions.SELECT_ALL_DEALS)
				$(this).find('span.count').text(numberWithCommas(getAvailableDeals()));
			else
				$(this).find('span.count').text(numberWithCommas(getDealsBulkIds().length));
			
			reload_deals = false;
		})
		
		$(".deal_bulk_modal").on('hidden.bs.modal', function (e) {
			  // do something...
			if(reload_deals)
				App_Deals.deals();
			
			$(this).find('.help-line').remove();
		});
		
		// Initialize the add tag dialog box ui.
		setup_tags_typeahead();
		deal_bulk_actions.fillCampaignsList($('#workflows-list-bulk',el));
		
	};
	
	deal_bulk_actions.fillCampaignsList = function(el){
		$.ajax({
			url: 'core/api/workflows',
			type: 'GET',
			dataType: 'json',
			success: function(campaigns){
				var html = '';
				$.each(campaigns, function(index,camp){
					//console.log(customfield);
					if(camp.is_disabled){
 						html += '<option value="'+camp.id+'" disabled = disabled>'+camp.name+' (disabled)</option>';
 						return true;
 					} 

					html += '<option value="'+camp.id+'">'+camp.name+'</th>';
				});
				el.html(html);
				return campaigns;
			}
		});
	};
	
	deal_bulk_actions.fillPipelineList = function(pipelines){
		var html = '<option value="">Select</option>';
		$.each(pipelines,function(index,value){
			html += '<option value="'+value.id+'" data="'+value.milestones+'">'+value.name+'</option>'
		});
		$("#deal_mile_change_modal").find("#pipeline-list-bulk").html(html);
	};

	deal_bulk_actions.toggle_deals_bulk_actions_dropdown = function(clicked_ele, isBulk, isCampaign)
	{
		
		if (!readCookie("agile_deal_view")){
			return;
		}
		
		deal_bulk_actions.SELECT_ALL_DEALS = false;
		_BULK_DEALS = undefined;
		console.log('deal bulk actions.');
		
		var total_available_deals = getAvailableDeals();

		console.log(filterJSON);
		if ($(clicked_ele).is(':checked'))
		{
			$('body').find('#bulk-actions').css('display', 'inline-block');

			if (isBulk && total_available_deals != App_Deals.opportunityCollectionView.collection.length)
				$('body')
						.find('#bulk-select')
						.show()
						.html(
								"Selected " + numberWithCommas(App_Deals.opportunityCollectionView.collection.length) + " deals. <a id='select-all-available-deals' class='text-info' href='#'>Select all " + numberWithCommas(total_available_deals) + " deals</a>");
		}
		else
		{
			if (isBulk)
			{
				$('#bulk-actions,#bulk-select').css('display', 'none');
				return;
			} else if($('#bulk-select').is(":visible")){
				$('#bulk-select').css('display', 'none');
			}

			var check_count = 0
			$.each($('.tbody_check'), function(index, element)
			{
				if ($(element).is(':checked'))
				{
					check_count++;
					return false;
				}
				// return;
			});

			if (check_count == 0)
			{
				$('#bulk-actions').css('display', 'none');
			}
		}
		
	};
	
}(window.deal_bulk_actions = window.deal_bulk_actions || {}, $));

/**
 * opportunity-filters.js is a script file that handles opportunity filters like
 * pipeline, milestones and owner select list.
 * 
 * @module Deals
 * 
 */
$(function()
{

 $('.deals-add').on('click', function(e)
	{
		e.preventDefault();
		show_deal();
	});


	$('#opportunityUpdateModal, #opportunityModal').on('click', '#opportunity_archive', function(e)
	{
		e.preventDefault();
		$('#archived', $('#opportunityUpdateForm')).attr('checked', 'checked');
		$("#opportunityUpdateModal #opportunity_validate").trigger('click');
	});
	$('#opportunityUpdateModal, #opportunityModal').on('click', '#opportunity_unarchive', function(e)
	{
		e.preventDefault();
		$('#archived', $('#opportunityUpdateForm')).removeAttr('checked');
		$('#opportunityUpdateModal #opportunity_validate').trigger('click');
	});


	/**
	 * Validates deal and saves
	 */
	$('#opportunityUpdateModal, #opportunityModal').on('click', '#opportunity_validate', function(e)
	{
		e.preventDefault();

		// To know updated or added deal form names
		var modal_id = $(this).closest('.opportunity-modal').attr("id");
		var form_id = $(this).closest('.opportunity-modal').find('form').attr("id");

		var json = serializeForm(form_id);
		json["custom_data"] = serialize_custom_fields(form_id);

		console.log(json);
		if (form_id == "opportunityForm")
			saveDeal(form_id, modal_id, this, json, false);
		else
			saveDeal(form_id, modal_id, this, json, true);
	});

	
});

function setupDealFilters(cel)
{

	getTemplate('deal-filter', {}, undefined, function(template_ui){
		if(!template_ui)
			  return;

		$('#deal-list-filters').html($(template_ui));
		var el = $('#filter_options');

		// Fills owner select element
		populateUsers("owners-list-filters", el, undefined, undefined, function(data)
		{

			$("#deals-filter").find("#owners-list-filters").html(data);
			// Select none by default.
			if (readCookie('deal-filters'))
			{
				var json = $.parseJSON(readCookie('deal-filters'));
			}

			$("#owners-list-filters", $("#dealsFilterForm")).closest('div').find('.loading-img').hide();

			$("#deal_owner_change_modal").find("#owners-list-bulk").html(data);
			$("#owners-list-bulk", $("#deal_owner_change_modal")).closest('div').find('.loading').hide();

			// Populate pipeline in the select box.
			populateTracks(el, undefined, undefined, function(data)
			{
				// Select none by default.
				$('#pipeline').val('');
				deal_bulk_actions.fillPipelineList(data);
				$('#owners-list-filters').val('');
				if (readCookie('deal-filters'))
				{
					var json = $.parseJSON(readCookie('deal-filters'));
					$.each(json, function(key, value)
					{

						// Fill the filters based on previously selected filters in
						// cookie.
						if (value)
						{
							if ($('[name="' + key + '"]').closest('.controls').height() == 0 && key.indexOf('_filter') < 0)
							{
								$('[name="' + key + '"]').closest('.controls').addClass('in');
								$('[name="' + key + '"]').closest('.control-group').find('a.changeIcon').find('i').toggleClass('icon-plus icon-minus');
							}

							if (key == 'pipeline_id')
							{
								// Fills milestone and select element
								populateMilestones(el, undefined, json.pipeline_id, undefined, function(data)
								{
									$("#milestone", el).html(data);
									$("#milestone", el).closest('div').find('.loading-img').hide();
									$("#milestone", el).val(json.milestone);
								});
							}
							$('#' + key).val(value);
							if (key == 'pipeline_id')
								$('#pipeline').val(value);
							else if (key == 'owner_id')
								$('#owners-list-filters').val(value);
							else if ($('#' + key).hasClass('date'))
								$('#' + key).val(new Date(value * 1000).format('mm/dd/yyyy'));

							if (key.indexOf('_filter') > 0)
								$('#' + key).trigger('change');

						}
					});
					// deserializeForm(json, $('#dealsFilterForm'));
					updateFilterColor();
				}
				// Enable the datepicker
				$('#filter_options .date').datepicker({ format : 'mm/dd/yyyy', });
				if (!readCookie("agile_deal_view"))
				{
					$('#pipeline').closest('.control-group').hide();
					$('#milestone').closest('.control-group').hide();
				}
				$('#filter_options select').find('option[value=""]').text('Any');
			});
		});

	}, '#deal-list-filters');
}

function updateFilterColor()
{
	var filters_count = 0;
	var json = $.parseJSON(readCookie('deal-filters'));
	if (json.owner_id.length > 0)
		filters_count++;
	if (json.value_filter == 'equals')
	{
		if (json.value.length > 0)
			filters_count++;
	}
	else
	{
		if (json.value_start.length > 0 || json.value_end.length > 0)
			filters_count++;
	}

	if (readCookie("agile_deal_view"))
	{
		if (json.pipeline_id.length > 0)
			filters_count++;
	}

	if (json.archived != 'false')
		filters_count++;

	if (filters_count > 0)
		$('#show-filter-button').addClass('btn-primary');
}

/**
 * Show filters drop down and fill the options.
 */
function showFilters()
{
	var el = $('#filter_options');

	el.show();
	// $("#deals-filter").modal('show');

	/*
	 * add_custom_fields_to_form({}, function(data){
	 * console.log('----------------',data); var el_custom_fields =
	 * getTemplate("deal-custom-filter",data["custom_fields"]);
	 * //$(el_custom_fields).find('div.control-group').addClass('row-filter');
	 * $("#dealsCustomFilterForm fieldset",
	 * el).html($(el_custom_fields)).find('div.control-group').addClass('row-filter');
	 *  }, "DEAL");
	 */

}

/**
 * Deserialize the filters form and save them in the cookie as JSON string and
 * reload the page.
 * 
 * @param saveBtn
 */
function filterDeals(saveBtn)
{
	// Returns, if the sav e button has disabled attribute
	if (saveBtn.attr('disabled'))
		return;
	saveBtn.attr('disabled', 'disabled');
	$('#filter_options').hide();
	var formId = 'dealsFilterForm';
	/*
	 * if (!isValidForm('#' + formId)) { // Removes disabled attribute of save
	 * button enable_save_button(saveBtn);//$(saveBtn).removeAttr('disabled');
	 * return false; }
	 */
	var json = serializeForm(formId);
	// var customJson = serializeForm('dealsCustomFilterForm');
	// json.customFields=customJson;
	if (readCookie("agile_deal_track") && json.pipeline_id.length > 1 && readCookie("agile_deal_track") != json.pipeline_id)
		createCookie("agile_deal_track", json.pipeline_id)
	createCookie('deal-filters', JSON.stringify(json));
	saveBtn.removeAttr('disabled');
	// Loads the deals
	App_Deals.deals();
}

/**
 * Get the deal filters in the cookie.
 * 
 * @returns
 */
function getDealFilters()
{
	var query = ''
	if (readCookie('deal-filters'))
	{
		query = readCookie('deal-filters');
		// Remove the milestone field in the filters if it is milestone view.
		if (!readCookie("agile_deal_view"))
		{
			var json = $.parseJSON(query);
			if (json.pipeline_id.length == 0)
				json.pipeline_id = readCookie('agile_deal_track');
			json.milestone = '';
			return JSON.stringify(json);
		}
	}
	return query;
}



// Deal Listeners
function initializeDealListners(el){
	
$('#opportunity-listners').off('click', ".deals-list-view");
$('#opportunity-listners').on('click', '.deals-list-view', function(e) {
		e.preventDefault();
		
		// Creates the cookie
		createCookie("agile_deal_view", "list_view");
		
		// Loads the deals
		App_Deals.deals();

	});


	/**
	 * If default view is selected, deals are loaded with default view and 
	 * removes the view cookie set when view is selected
	 */ 
	
	$('#opportunity-listners').off('click', '#opportunity-track-list-model-list a.pipeline');
	$('#opportunity-listners').on('click', '#opportunity-track-list-model-list a.pipeline', function(e) {
		e.preventDefault();
		createCookie("agile_deal_track", $(this).attr('id'));
		if(readCookie('deal-filters')){
			var json = $.parseJSON(readCookie('deal-filters'));
			var track = $(this).attr('id');
			if(track == '1')
				json.pipeline_id = '';
			else
				json.pipeline_id = $(this).attr('id');
			createCookie('deal-filters',JSON.stringify(json));
		}
		App_Deals.deals();
	});
	
	
	/**
	 * Update the milestones list when the pipeline is changed in the modal.
	 */
	$('#opportunity-listners').off('change', '#pipeline');
	$('#opportunity-listners').on('change', '#pipeline', function(e)
	{
		var el = $(this).closest('form');
		$('#milestone', el).closest('div').find('.loading-img').show();
		// Fills milestone select element
		populateMilestones(el, undefined, $(this).val(), undefined, function(data)
		{
			$("#milestone", el).html(data);
			$("#milestone", el).closest('div').find('.loading-img').hide();
		});
	});
	/**
	 * If Pipelined View is selected, deals are loaded with pipelined view and 
	 * creates the pipelined view cookie
	 */
	$('#opportunity-listners').off('click', '.deals-pipelined-view');
	$('#opportunity-listners').on('click', '.deals-pipelined-view', function(e) {
		e.preventDefault();

		// Erases the cookie
		eraseCookie("agile_deal_view");

		// Loads the deals
		App_Deals.deals();

	});
	/**
	 * If Pipelined View is selected, deals are loaded with pipelined view and 
	 * creates the pipelined view cookie
	 */
	$('#opportunity-listners').off('click', '.deals-export-csv');
	$('#opportunity-listners').on('click', '.deals-export-csv', function(e) {
		e.preventDefault();

		console.log('Exporting ...');
		$("body #deals-export-csv-modal").remove();

		getTemplate('deals-export-csv-modal', {}, undefined, function(template_ui){
			if(!template_ui)

				  return;
			var deals_csv_modal = $(template_ui);
			deals_csv_modal.modal('show');			
			deals_csv_modal.on("shown.bs.modal", function(){
					// If Yes clicked
					$('#deals-export-csv-modal').on('click', '#deals-export-csv-confirm', function(e) {
							e.preventDefault();
							if($(this).attr('disabled'))
						   	     return;
							
							$(this).attr('disabled', 'disabled');
							var input = {};
							var filterJSON = JSON.stringify($.parseJSON(readCookie('deal-filters')));
							if (!readCookie("agile_deal_view"))
								filterJSON.pipeline_id = readCookie('agile_deal_track');
							input.filter = filterJSON;
							 // Shows message
						    $save_info = $('<img src="img/1-0.gif" height="18px" width="18px" style="opacity:0.5;"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>Email will be sent shortly.</i></small></span>');
						    $(this).parent('.modal-footer').find('.deals-export-csv-message').append($save_info);
							$save_info.show();
							// Export Deals.
							$.ajax({
								url: '/core/api/opportunity/export',
								type: 'POST',
								data : input,
								success: function() {
									console.log('Exported!');
									deals_csv_modal.modal('hide');
								}
							});
					});

			});
		}, null);
	});


	// Show filter drop down.
	$('#opportunity-listners').off('click', '#show-filter-button');
	$('#opportunity-listners').on('click', '#show-filter-button', function(e)
	{
		e.preventDefault();
		if ($('#filter_options').is(':visible'))
			$('#filter_options').hide();
		else
			showFilters();
	});

	// Filter deals.
	$('#opportunity-listners').off('click', '#deals-filter-validate');
	$('#opportunity-listners').on('click', '#deals-filter-validate', function(e)
	{
		e.preventDefault();
		filterDeals($(this));
	});

	// For updating the filter inequality and the fields based on the filter
	// type selected.
	$('#opportunity-listners').off('change', '#filter_options .filter_type');
	$('#opportunity-listners').on('change', '#filter_options .filter_type', function(e)
	{
		var filter = $(this).closest('.control-group').attr('id');
		if ($(this).val() == 'equals')
		{
			$('#' + filter + ' .equals').show();
			$('#' + filter + ' .between').hide();
		}
		else
		{
			var msg = "You can only use one 'between' condition for filtering. Press Ok to change other conditions to equal.";
			var bwCount = $("#filter_options").find('select option[value="between"]:selected').length;
			var valid = true;
			if (bwCount > 1)
				valid = false;
			if (valid)
			{
				$('#filter_options .filter_type').val('equal');
				$(this).val('between');
				$('#sort_field').val($(this).attr('data'));
				$('#filter_options .between').hide();
				$('#filter_options .equals').show();
				$('#' + filter + ' .equals').hide();
				$('#' + filter + ' .between').show();
			}
			else
			{
				alert("Sorry. You can't have multiple 'Between' conditions.");
				$(this).val('equals');
			}

		}
	});

	// Clear the deal filter form and remove the cookie.
	$('#opportunity-listners').off('click', '#clear-deal-filters');
	$('#opportunity-listners').on('click', '#clear-deal-filters', function(e)
	{
		$('#dealsFilterForm input').val('');
		$('#dealsFilterForm select').filter(':visible').val('');
		$('#dealsFilterForm select.filter_type').val('equals');
		$('#filter_options .between').hide();
		$('#filter_options .equals').show();
		$('#dealsFilterForm #archived').val('false');
		$('#filter_options').find('.control-group').each(function(index)
		{
			if ($(this).find('.controls').height() > 0)
				$(this).find('a.changeIcon').trigger('click');
		});
		eraseCookie('deal-filters');
		$('#show-filter-button').removeClass('btn-primary');
	});

	$('#opportunity-listners').off('click', '#filter_options a.changeIcon');
	$('#opportunity-listners').on('click', '#filter_options a.changeIcon', function(e)
	{
		$(this).find('i').toggleClass('icon-plus icon-minus')
	});


  	$('#opportunity-listners').off('mouseenter', '.milestones > li');
	$('#opportunity-listners').on('mouseenter', '.milestones > li', function(e)
	{
		$(this).find('.deal-options').css("visibility", "visible");
	});

	$('#opportunity-listners').off('mouseleave', '.milestones > li');
	$('#opportunity-listners').on('mouseleave', '.milestones > li', function(e)
	{
		$(this).find('.deal-options').css("visibility", "hidden");
	});

	/**
	 * Milestone view deal edit
	 */
	$('#opportunity-listners').off('click', '.deal-edit');
	$('#opportunity-listners').on('click', '.deal-edit', function(e)
	{
		e.preventDefault();
		var id = $(this).closest('.data').attr('id');
		var milestone = ($(this).closest('ul').attr("milestone")).trim();
		var currentDeal;

		// Get the current deal model from the collection.
		var dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : milestone });
		if (!dealPipelineModel)
			return;
		currentDeal = dealPipelineModel[0].get('dealCollection').get(id).toJSON();

		if (currentDeal)
			updateDeal(currentDeal, true);
	});

	/**
	 * Milestone view deal delete
	 */
	$('#opportunity-listners').off('click', '.deal-delete');
	$('#opportunity-listners').on('click', '.deal-delete', function(e)
	{
		e.preventDefault();
		if (!confirm("Are you sure you want to delete?"))
			return;

		var id = $(this).closest('.data').attr('id');
		var milestone = ($(this).closest('ul').attr("milestone")).trim();
		var id_array = [];
		var id_json = {};

		// Create array with entity id.
		id_array.push(id);

		// Set entity id array in to json object with key ids,
		// where ids are read using form param
		id_json.ids = JSON.stringify(id_array);

		var that = this;
		$.ajax({ url : 'core/api/opportunity/' + id, type : 'DELETE', success : function()
		{
			// Remove the deal from the collection and remove the UI element.
			var dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : milestone });
			if (!dealPipelineModel)
				return;
			dealPipelineModel[0].get('dealCollection').remove(dealPipelineModel[0].get('dealCollection').get(id));

			// Removes deal from list
			$(that).closest('li').css("display", "none");

			// Shows Milestones Pie
			pieMilestones();

			// Shows deals chart
			dealsLineChart();
		} });
	});

	

	/**
	 * Deal list view edit
	 */
	$('#opportunity-listners').off('click', '#opportunities-model-list > tr > td:not(":first-child")');
	$('#opportunity-listners').on('click', '#opportunities-model-list > tr > td:not(":first-child")', function(e){
		e.preventDefault();
		$('.popover').remove();
		var currentdeal = $(this).closest('tr').data();
		Backbone.history.navigate("deal/" + currentdeal.id, { trigger : true });
		// updateDeal($(this).closest('tr').data());
	});



	/**
	 * Shows deal popup
	 */
	$('#opportunity-listners').off('click', '.deals-add');
	$('#opportunity-listners').on('click', '.deals-add', function(e)
	{
		e.preventDefault();
		show_deal();
	});
 

	/**
	 * Milestone view deal delete
	 */
	$('#opportunity-listners').off('click', '.deal-archive');
	$('#opportunity-listners').on('click', '.deal-archive', function(e)
	{
		e.preventDefault();

		var temp = {};
		temp.id = $(this).closest('.data').attr('id');
		temp.milestone = ($(this).closest('ul').attr("milestone")).trim();
		$("#archived-deal-id", $("#deal_archive_confirm_modal")).val(temp.id);
		$("#archived-deal-milestone", $("#deal_archive_confirm_modal")).val(temp.milestone);
		$("#deal_archive_confirm_modal").modal('show');
	});

	/**
	 * Milestone view deal delete
	 */
	$('#opportunity-listners').off('click', '.deal-restore');
	$('#opportunity-listners').on('click', '.deal-restore', function(e)
	{
		e.preventDefault();

		var temp = {};
		temp.id = $(this).closest('.data').attr('id');
		temp.milestone = ($(this).closest('ul').attr("milestone")).trim();
		$("#restored-deal-id", $("#deal_restore_confirm_modal")).val(temp.id);
		$("#restored-deal-milestone", $("#deal_restore_confirm_modal")).val(temp.milestone);
		$("#deal_restore_confirm_modal").modal('show');
	});

	$('#opportunity-listners').off('change', '#pipeline_milestone');
	$('#opportunity-listners').on('change', '#pipeline_milestone', function(e)
	{
		var temp = $(this).val();
		var track = temp.substring(0, temp.indexOf('_'));
		var milestone = temp.substring(temp.indexOf('_') + 1, temp.length + 1);
		$(this).closest('form').find('#pipeline').val(track);
		$(this).closest('form').find('#milestone').val(milestone);
		console.log(track, '-----------', milestone);
	});



		/**
	 * When mouseover on any row of opportunities list, the popover of deal is shown
	 **/
	$('#opportunity-listners').off('mouseenter', '#opportunities-model-list > tr');
	$('#opportunity-listners').on('mouseenter', '#opportunities-model-list > tr', function(e) {
        var data = $(this).find('.data').attr('data');

        var currentDeal = App_Deals.opportunityCollectionView.collection.get(data);
       	var that = this;
        getTemplate("opportunity-detail-popover", currentDeal.toJSON(), undefined, function(template_ui){
			if(!template_ui)
				  return;
				
			var ele = $(template_ui);	
			$(that).popover({
	        	"rel" : "popover",
	        	"trigger" : "hover",
	        	"placement" : 'right',
	        	"original-title" : currentDeal.toJSON().name,
	        	"content" :  ele,
	        	"html" : true,
	        	"container": 'body'
	        });

			/**
	         * Checks for last 'tr' and change placement of popover to 'top' inorder
	         * to prevent scrolling on last row of list
	         **/
	       $('#opportunities-model-list > tr:last').popover({
	        	"rel" : "popover",
	        	"trigger" : "hover",
	        	"placement" : 'top',
	        	"original-title" : currentDeal.toJSON().name,
	        	"content" :  ele,
	        	"html" : true,
	        	"container": 'body'
	        });
	        
	        $(that).popover('show');

		}, null);
     });
	
    /**
     * On mouse out on the row hides the popover.
     **/
    $('#opportunity-listners').off('mouseleave', '#opportunities-model-list > tr');
	$('#opportunity-listners').on('mouseleave', '#opportunities-model-list > tr', function(e) {
    	 $(this).popover('hide');
    });
	
    /**
     * On click on the row hides the popover.
     **/
    $('#opportunity-listners').off('click', '#opportunities-model-list > tr, .hide-popover');
	$('#opportunity-listners').on('click', '#opportunities-model-list > tr, .hide-popover', function(e) {
    	 $(this).closest('tr').popover('hide');
    });
    
   /**
    * When deal is added from contact-detail by selecting 'Add Opportunity' from actions 
    * and then close button of deal is clicked, it should navigate to contact-detail.
    **/
    $('#opportunity-listners').off('click', '#close-deal');
	$('#opportunity-listners').on('click', '#close-deal', function(e) {
    	e.preventDefault();
    	window.history.back();
    });
	
	$('#opportunity-listners').off('click', '#deal-milestone-regular');
	$('#opportunity-listners').on('click', '#deal-milestone-regular', function(e) {
    	e.preventDefault();
    	eraseCookie('deal-milestone-view');
    	App_Deals.deals();
    });
	
	$('#opportunity-listners').off('click', '#deal-milestone-compact');
	$('#opportunity-listners').on('click', '#deal-milestone-compact', function(e) {
    	e.preventDefault();
    	createCookie('deal-milestone-view','compact');
    	App_Deals.deals();
    });
	
	$('#opportunity-listners').off('click', '#deal-milestone-fit');
	$('#opportunity-listners').on('click', '#deal-milestone-fit', function(e) {
    	e.preventDefault();
    	createCookie('deal-milestone-view','fit');
    	App_Deals.deals();
    });

}



function initializeMilestoneListners(el){
	
	$('#milestone-listner').off();	
	$('#milestone-listner').on('click', '.add-pipeline', function(e) {
		$('#pipelineForm input').val('');
		$('#pipelineForm input#milestones').val('New,Prospect,Proposal,Won,Lost');
		$('#pipelineForm input#won_milestone').val('Won');
		$('#pipelineForm input#lost_milestone').val('Lost');
		$('#pipelineModal').find('.save-status').html('');
	});
	
	$('#milestone-listner').off('click', '.pipeline-edit');
	$('#milestone-listner').on('click', '.pipeline-edit', function(e) {
		var id = $(this).attr('id');
		var json = App_Admin_Settings.pipelineGridView.collection.get(id).toJSON();
		deserializeForm(json,$('#pipelineForm'));
		
	});
	
	/**
	 * If Pipelined View is selected, deals are loaded with pipelined view and 
	 * creates the pipelined view cookie
	 */
	$('#milestone-listner').off('click', '.pipeline-delete');
	$('#milestone-listner').on('click', '.pipeline-delete', function(e) {
		e.preventDefault();
		var id = $(this).attr('id');
		var name = $(this).attr('data');
		$('#track-name').text(name);
		// If Yes clicked
		$('body').on('click', '#pipeline-delete-confirm', function(e) {
			e.preventDefault();
			if($(this).attr('disabled'))
		   	     return;
			
			$(this).attr('disabled', 'disabled');
			var that = $(this);
			 // Shows message
		    $save_info = $('<img src="img/1-0.gif" height="18px" width="18px" style="opacity:0.5;"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>Deleting track.</i></small></span>');
		    $(this).parent('.modal-footer').find('.pipeline-delete-message').append($save_info);
			$save_info.show();
			// Export Deals.
			$.ajax({
				url: '/core/api/milestone/pipelines/'+id,
				type: 'DELETE',
				success: function() {
					console.log('Deleted!');
					$('#pipeline-delete-modal').modal('hide');
					if(readCookie("agile_deal_track") && readCookie("agile_deal_track") == id)
						eraseCookie("agile_deal_track");
					if(readCookie("deal-filters")){
						var json = $.parseJSON(readCookie("deal-filters"));
						if(json.pipeline_id = id)
							eraseCookie("deal-filters");
					}
					
					App_Admin_Settings.milestones();
					$('body').removeClass('modal-open');
					$save_info.hide();
					that.removeAttr('disabled');
				},
				error : function(jqXHR, status, errorThrown){
					console.log(jqXHR);
					$save_info.hide();
					$('#pipeline-delete-modal').find('.pipeline-delete-message').text(jqXHR.responseText);
					that.removeAttr('disabled');
				}
			});
		});
		

	});

	// Admin Settings milestone list
	/**
	 * To remove the milestone from list.
	 */
	$('#milestone-listner').off('click', '.milestone-delete');
	$('#milestone-listner').on('click', '.milestone-delete', function(e) {
		e.preventDefault();
		if (!confirm("Are you sure you want to delete ?" ))
			return;
		
		var formId = $(this).closest('form');
		if($(this).closest('tr').find('.mark-won').length > 0){
			formId.find('input[name="won_milestone"]').val('');
		} else if($(this).closest('tr').find('.mark-lost').length > 0){
			formId.find('input[name="lost_milestone"]').val('');
		}
		$(this).closest('tr').css("display", "none");
		fill_ordered_milestone($(this).closest('form').attr('id'));
	});
	
	/**
	 * Shows input field to add new milestone.
	 */
	$('#milestone-listner').off('click', '.show_milestone_field');
	$('#milestone-listner').on('click', '.show_milestone_field', function(e) {
    	e.preventDefault();
    	var form = $(this).closest('form');
    	console.log('New Milestone to - ',form.attr('id'));
    	$(this).closest("div").css("display","none");
    	form.find('.show_field').css("display","block");
    	form.find(".add_new_milestone").focus();
    });
    
    /**
	 * Adds new milestone to the sortable list.
	 */
	$('#milestone-listner').off('click', '.add_milestone');
	$('#milestone-listner').on('click', '.add_milestone', function(e) {
    	
    	e.preventDefault();
    	var form = $(this).closest('form');
    	var new_milestone = form.find(".add_new_milestone").val().trim();

    	/*if(!new_milestone || new_milestone.length <= 0 || !(/^[a-zA-Z0-9-_ ]*$/).test(new_milestone))
		{
    		$('#milestone-error-modal').modal('show');
			return;
		}*/
		if(form.find(".add_new_milestone").val().trim()==""){
			$('#new_milestone_name_error_'+form.attr('id').split('milestonesForm_')[1]).show();
			return false;
		}
		if(!(/^[a-zA-Z0-9-_ ]*$/).test(form.find(".add_new_milestone").val().trim())){
			$('#new_milestone_chars_error_'+form.attr('id').split('milestonesForm_')[1]).show();
			return false;
		}
    	form.find('.show_field').css("display","none");
    	form.find(".show_milestone_field").closest("div").css("display","inline-block");
    	
    	if(!new_milestone || new_milestone.length <= 0 || (/^\s*$/).test(new_milestone))
		{
			return;
		}
    	
    	// To add a milestone when input is not empty
    	if(new_milestone != "")
    	{
    		e.preventDefault();
    	
    		// Prevents comma (",") as an argument to the input field
    		form.find(".add_new_milestone").val("");
        	
    		var milestone_list = form.find('tbody');
    		var add_milestone = true;
    		
    		// Iterate over already present milestones, to check if this is a new milestone
    		milestone_list.find('tr').each(function(index, elem){
    			if($(elem).is( ":visible") && elem.getAttribute('data').toLowerCase() == new_milestone.toLowerCase())
    			{
    				add_milestone = false; // milestone exists, don't add
    				return false;
    			}
    		});
    		
    		if(add_milestone)
    		{
    			var html = "<tr data='" + new_milestone + "' style='display: table-row;'><td><div class='milestone-name-block inline-block v-top text-ellipsis' style='width:80%'>";
    			html += new_milestone + "</div></td><td class='b-r-none'><div class='m-b-n-xs'>";
    			html += "<a class='milestone-won text-l-none-hover c-p text-xs hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Won Milestone'><i class='icon-like'></i></a>";
				html += "<a class='milestone-lost text-l-none-hover c-p text-xs m-l-sm hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Lost Milestone'><i class='icon-dislike'></i></a>";
				html +=	"<a class='milestone-delete c-p m-l-sm text-l-none text-xs hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Delete Milestone'><i class='icon icon-trash'></i>" +
				"</a><a class='text-l-none-hover c-p text-xs m-l-sm hover-show' style='visibility:hidden;'><i title='Drag' class='icon-move'></i></a></div></td></tr>";
				milestone_list.append(html);
    			//milestone_list.append("<tr data='"+new_milestone+"' style='display: table-row;'><td><div style='display:inline-block;vertical-align:top;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;width:80%'>"+new_milestone+"</div></td><td><div class='m-b-n-xs' style='display:none;'><a class='text-l-none-hover c-p'><i title='Drag' class='icon-move'></i></a><a class='milestone-delete' style='cursor: pointer;margin-left:10px; text-decoration: none;' data-toggle='modal' role='button' href='#'><i title='Delete Milestone' class='task-action icon icon-trash'></i></a></div></td></tr>");
    	//		milestone_list.append("<li data='" + new_milestone + "'><div><span>" + new_milestone + "</span><a class='milestone-delete right' href='#'>&times</a></div></li>");
    			fill_ordered_milestone(form.attr('id'));
    		}
    	}
    });
	
	$('#milestone-listner').off('keypress', '.add_new_milestone');
	$('#milestone-listner').on('keypress', '.add_new_milestone', function(e) {
		var form = $(this).closest('form');
    	$('#new_milestone_name_error_'+form.attr('id').split('milestonesForm_')[1]).hide();
		$('#new_milestone_existed_error_'+form.attr('id').split('milestonesForm_')[1]).hide();
		$('#new_milestone_chars_error_'+form.attr('id').split('milestonesForm_')[1]).hide();
    	if(e.keyCode == 13)
    	{
    		var form = $(this).closest("form");
    		form.find(".add_milestone").click();
    	}
    });

    $('#pipelineModal').off('click', '#pipeline_validate');
	$('#pipelineModal').on('click', '#pipeline_validate', function(e) {
    	e.preventDefault();
    	
    	// Returns, if the save button has disabled attribute
    	if ($(this).attr('disabled'))
    		return;
    	var that = $(this);
    	// Disables save button to prevent multiple click event issues
    	disable_save_button($(this));//$(saveBtn).attr('disabled', 'disabled');
    	
    	if (!isValidForm('#pipelineForm')) {
    		// Removes disabled attribute of save button
    		enable_save_button(that);//$(saveBtn).removeAttr('disabled');
    		return false;
    	}
    	
    	var mile = serializeForm('pipelineForm');
    	console.log(mile);
    	// Saving that pipeline object
    	var pipeline = new Backbone.Model();
    	pipeline.url = '/core/api/milestone/pipelines';
    	pipeline.save(mile, {
    		// If the milestone is changed, to show that change in edit popup if opened without reloading the app.
    		success : function(model, response) {
    			// Removes disabled attribute of save button
    			$('#pipelineModal').modal('hide');
    			enable_save_button(that);
    			App_Admin_Settings.milestones();
    			$('body').removeClass('modal-open');
    		},
			error: function(data,response){
				console.log(response,data);
				$('#pipelineModal').find('.save-status').html('<span style="color:red;">'+response.responseText+'</span>');
				setTimeout(function(){$('#pipelineModal').find('.save-status').html('');}, 5000);
				enable_save_button(that);
			}
    	});
    	
    });
	
	$("#milestone-listner").off('click', '.add_lost_reason');
	$("#milestone-listner").on('click', '.add_lost_reason', function(e){
		e.preventDefault();
		if($('#lost_reason_name').val().trim()==""){
			$('#lost_reason_name_error').show();
			return false;
		}
		if(!(/^[a-zA-Z0-9-_ ]*$/).test($('#lost_reason_name').val().trim())){
			$('#lost_reason_chars_error').show();
			return false;
		}
		var obj = serializeForm('lostReasonsForm');
		var model = new BaseModel();
		model.url = 'core/api/categories';
		model.save(obj, {
        success: function (data) {
        	var model = data.toJSON();
	        App_Admin_Settings.dealLostReasons.collection.add(new BaseModel(model));
	        $('.show_field').find('#lost_reason_name').val("");
	        $('.show_field').hide();
	        $('.show_lost_reason_add').show();
        },
        error: function (model, response) {
        	if(response.status==400 && response.responseText=="Reason with this name already exists."){
        		$('#lost_reason_existed_error').show();
        	}
        }});
	});

	$("#milestone-listner").off('keypress', '#lost_reason_name');
	$("#milestone-listner").on('keypress', '#lost_reason_name', function(e){
		$('#lost_reason_name_error').hide();
		$('#lost_reason_existed_error').hide();
		$('#lost_reason_chars_error').hide();
		if(e.keyCode == 13)
    	{
    		e.preventDefault();
    		var form = $(this).closest("form");
    		form.find(".add_lost_reason").click();
    	}
	});

	$('#milestone-listner').off("click", '.lost-reason-edit');
	$('#milestone-listner').on("click", '.lost-reason-edit', function(e){
		$(this).closest('tr').find('.lost_reason_name_div').hide();
		$(this).closest('tr').find('.lost_reason_name_input').show();
	});

	$('#milestone-listner').off("keypress", '.update_lost_reason');
	$('#milestone-listner').on("keypress", '.update_lost_reason', function(e){
		if(e.which == 13){
			e.preventDefault();
			if($(this).val().trim()==""){
				$('#lost_reason_name_error_'+$(this).attr("id")).show();
				return false;
			}
			if(!(/^[a-zA-Z0-9-_ ]*$/).test($(this).val().trim())){
				$('#lost_reason_chars_error_'+$(this).attr("id")).show();
				return false;
			}
			var obj = serializeForm('lostReasonsForm_'+$(this).attr("id"));
			var model = new BaseModel();
			model.url = 'core/api/categories';
			model.save(obj, {
        	success: function (data) {
        		var model = data.toJSON();
	       		App_Admin_Settings.dealLostReasons.collection.get(model).set(new BaseModel(model));
	        	$('.lost_reason_name_input').hide();
	        	$('.lost_reason_name_div').show();
        	},
        	error: function (model, response) {
        		if(response.status==400 && response.responseText=="Reason with this name already exists."){
        			$('#lost_reason_existed_error').show();
        		}
        	}});
		}else{
			$('#lost_reason_name_error_'+$(this).attr("id")).hide();
			$('#lost_reason_existed_error_'+$(this).attr("id")).hide();
			$('#lost_reason_chars_error_'+$(this).attr("id")).hide();
		}
	});
	
	$('#milestone-listner').off("click", '.updates_lost_reason');
	$('#milestone-listner').on("click", '.updates_lost_reason', function(e){
		if($(this).parent().find('input:text').val().trim()==""){
			$('#lost_reason_name_error_'+$(this).parent().find('input:text').attr("id")).show();
			return false;
		}
		if(!(/^[a-zA-Z0-9-_ ]*$/).test($(this).parent().find('input:text').val().trim())){
			$('#lost_reason_chars_error_'+$(this).parent().find('input:text').attr("id")).show();
			return false;
		}
		var obj = serializeForm('lostReasonsForm_'+$(this).parent().find('input:text').attr("id"));
		var model = new BaseModel();
		model.url = 'core/api/categories';
		model.save(obj, {
        success: function (data) {
        	var model = data.toJSON();
	       	App_Admin_Settings.dealLostReasons.collection.get(model).set(new BaseModel(model));
	       	$('.lost_reason_name_input').hide();
	       	$('.lost_reason_name_div').show();
        },
        error: function (model, response) {
        	if(response.status==400 && response.responseText=="Reason with this name already exists."){
        		$('#lost_reason_existed_error').show();
        	}
        }});
	});
	
	$("#milestone-listner").off('click', '.lost-reason-delete');
	$("#milestone-listner").on('click', '.lost-reason-delete', function(e){
		if(confirm("Are you sure you want to delete ?")){
			e.preventDefault();
			var that = $(this);
			var obj = serializeForm($(this).closest('form').attr("id"));
			var model = new BaseModel();
			model.url = 'core/api/categories/'+obj.id;
			model.set({ "id" : obj.id });
			model.destroy({
        	success: function (data) {
        		var model = data.toJSON();
	      	  App_Admin_Settings.dealLostReasons.collection.remove(new BaseModel(model));
	      	  that.closest('tr').remove();
        	},
        	error: function (model, response) {
        	
        	}});
		}
	});

	$("#milestone-listner").off('click', '.add_deal_source');
	$("#milestone-listner").on('click', '.add_deal_source', function(e){
		e.preventDefault();
		if($('#deal_source_name').val().trim()==""){
			$('#deal_source_name_error').show();
			return false;
		}
		if(!(/^[a-zA-Z0-9-_ ]*$/).test($('#deal_source_name').val().trim())){
			$('#deal_source_chars_error').show();
			return false;
		}
		var obj = serializeForm('dealSourcesForm');
		var model = new BaseModel();
		model.url = 'core/api/categories';
		model.save(obj, {
        success: function (data) {
        	var model = data.toJSON();
	        App_Admin_Settings.dealSourcesView.collection.add(new BaseModel(model));
	        $('.show_field').find('#deal_source_name').val("");
	        $('.show_field').hide();
	        $('.show_deal_source_add').show();
        },
        error: function (model, response) {
        	if(response.status==400 && response.responseText=="Source with this name already exists."){
        		$('#deal_source_existed_error').show();
        	}
        }});
	});

	$("#milestone-listner").off('keypress', '#deal_source_name');
	$("#milestone-listner").on('keypress', '#deal_source_name', function(e){
		$('#deal_source_name_error').hide();
		$('#deal_source_existed_error').hide();
		$('#deal_source_chars_error').hide();
		if(e.keyCode == 13)
    	{
    		e.preventDefault();
    		var form = $(this).closest("form");
    		form.find(".add_deal_source").click();
    	}
	});

	$('#milestone-listner').off("click", '.deal-source-edit');
	$('#milestone-listner').on("click", '.deal-source-edit', function(e){
		$(this).closest('tr').find('.deal_source_name_div').hide();
		$(this).closest('tr').find('.deal_source_name_input').show();
	});

	$('#milestone-listner').off("keypress", '.update_deal_source');
	$('#milestone-listner').on("keypress", '.update_deal_source', function(e){
		if(e.which == 13){
			e.preventDefault();
			if($(this).val().trim()==""){
				$('#deal_source_name_error_'+$(this).attr("id")).show();
				return false;
			}
			if(!(/^[a-zA-Z0-9-_ ]*$/).test($(this).val().trim())){
				$('#deal_source_chars_error_'+$(this).attr("id")).show();
				return false;
			}
			var obj = serializeForm('dealSourcesForm_'+$(this).attr("id"));
			var model = new BaseModel();
			model.url = 'core/api/categories';
			model.save(obj, {
        	success: function (data) {
        		var model = data.toJSON();
	       		App_Admin_Settings.dealSourcesView.collection.get(model).set(new BaseModel(model));
	        	$('.deal_source_name_input').hide();
	        	$('.deal_source_name_div').show();
        	},
        	error: function (model, response) {
        		if(response.status==400 && response.responseText=="Source with this name already exists."){
        			$('#deal_source_existed_error').show();
        		}
        	}});
		}else{
			$('#deal_source_name_error_'+$(this).attr("id")).hide();
			$('#deal_source_existed_error_'+$(this).attr("id")).hide();
			$('#deal_source_chars_error_'+$(this).attr("id")).hide();
		}
	});
	
	$('#milestone-listner').off("click", '.updates_deal_source');
	$('#milestone-listner').on("click", '.updates_deal_source', function(e){
		if($(this).parent().find('input:text').val().trim()==""){
			$('#deal_source_name_error_'+$(this).parent().find('input:text').attr("id")).show();
			return false;
		}
		if(!(/^[a-zA-Z0-9-_ ]*$/).test($(this).parent().find('input:text').val().trim())){
			$('#deal_source_chars_error_'+$(this).parent().find('input:text').attr("id")).show();
			return false;
		}
		var obj = serializeForm('dealSourcesForm_'+$(this).parent().find('input:text').attr("id"));
		var model = new BaseModel();
		model.url = 'core/api/categories';
		model.save(obj, {
        success: function (data) {
        	var model = data.toJSON();
	       	App_Admin_Settings.dealSourcesView.collection.get(model).set(new BaseModel(model));
	        $('.deal_source_name_input').hide();
	        $('.deal_source_name_div').show();
        },
        error: function (model, response) {
        	if(response.status==400 && response.responseText=="Source with this name already exists."){
        		$('#deal_source_existed_error').show();
        	}
        }});
	});
	
	$("#milestone-listner").off('click', '.deal-source-delete');
	$("#milestone-listner").on('click', '.deal-source-delete', function(e){
		if(confirm("Are you sure you want to delete ?")){
			e.preventDefault();
			var that = $(this);
			var obj = serializeForm($(this).closest('form').attr("id"));
			var model = new BaseModel();
			model.url = 'core/api/categories/'+obj.id;
			model.set({ "id" : obj.id });
			model.destroy({
        	success: function (data) {
        		var model = data.toJSON();
	      	  App_Admin_Settings.dealSourcesView.collection.remove(new BaseModel(model));
	      	  that.closest('tr').remove();
        	},
        	error: function (model, response) {
        	
        	}});
		}
	});
}// Before selecting proper type array from map, need to fill map with user's detail.
function startGettingDeals(criteria, pending)
{
	console.log('------started-----', pipeline_id);
	var milestoneString = trackListView.collection.get(pipeline_id).toJSON().milestones;
	if (milestoneString.trim().length == 0)
	{
		var html = '<div class="slate" style="margin:0px;"><div class="slate-content"><div class="box-left"><img alt="Clipboard" src="/img/clipboard.png"></div><div class="box-right"><h3>You have no milestones defined</h3><br><a href="#milestones" class="btn"><i class="icon icon-plus-sign"></i> Add Milestones</a></div></div></div>';
		$('#new-opportunity-list-paging').html(html);
		return;
	}
	if (readCookie('agile_deal_track'))
	{
		if (readCookie('agile_deal_track') != pipeline_id)
			createCookie('agile_deal_track', pipeline_id);
	}
	var currentTrack = trackListView.collection.get(pipeline_id).toJSON();
	var milestones = currentTrack.milestones.split(',');
	console.log(milestones);
	createDealsNestedCollection(pipeline_id,milestones,currentTrack);
	
}

// Decide which array to pass for creation of collection.
function dealFiltersForCollection(criteria)
{
	if (criteria == "CATEGORY")
		// Sort task list on count of task and then create collection
		getArraySortOnCount(criteria, GROUPING_MAP[criteria].type, pending);
	else
		// Creates nested collection
		createNestedCollection(criteria, GROUPING_MAP[criteria].type, pending);
}

// Creates nested collection
function createDealsNestedCollection(pipeline_id,milestones,currentTrack)
{
	console.log("In createNestedCollection");

	// Initialize nested collection
	initDealListCollection(milestones);

	// Url to call DB
	var initialURL = '/core/api/opportunity/based?pipeline_id=' + pipeline_id + '&order_by=close_date';

	if (readCookie('deal-filters'))
	{
		initialURL += '&filters=' + encodeURIComponent(getDealFilters());
	}

	// Creates main collection with deals lists
	for ( var i in milestones)
	{
		var newDealList;

		// Add heading to task list in main collection
			var url = initialURL + "&milestone=" + milestones[i];
			newDealList = { "heading" : milestones[i], "url" : url};
			if(currentTrack.won_milestone == milestones[i])
				newDealList.won_milestone = currentTrack.won_milestone;
			else if(currentTrack.lost_milestone == milestones[i])
				newDealList.lost_milestone = currentTrack.lost_milestone;

		if (!newDealList)
			return;

		// Add task list in main collection
		DEALS_LIST_COLLECTION.collection.add(newDealList);// main-collection
	}

	// Render it
	$('#new-opportunity-list-paging').html(DEALS_LIST_COLLECTION.render(true).el);

	pipeline_count = 0;
	// Fetch tasks from DB for first task list
	fetchForNextDealsList(milestones);
}

// Initialize nested collection
function initDealListCollection(milestones)
{
	// Define main collection
	DEALS_LIST_COLLECTION = new Base_Collection_View({ restKey : "deal", templateKey : "opportunities-by-paging", individual_tag_name : 'div',
		sort_collection : false, postRenderCallback : function(el)
		{
			// Remove loding imgs
			$('.loading-img', el).remove();
			$('.loading', el).remove();

			// Adjust Height Of Task List And Scroll as per window size
			var count = milestones.length;
			if (!count)
				return;
			// Setting dynamic auto width
			var width = (100 / count);

			if (readCookie('deal-milestone-view'))
			{
				if (readCookie('deal-milestone-view') == "compact" && count > 8)
					width = 100 / 8;
			}
			else if (count > 5)
			{
				width = 100 / 5;
			}

			$('#opportunities-by-paging-model-list', el).find('.milestone-column').width(width + "%");
			$('.mark-won, .mark-lost',el).tooltip();
		} });

	// Over write append function
	DEALS_LIST_COLLECTION.appendItem = dealAppend;
}

// Append sub collection and model
function dealAppend(base_model)
{
	var dealsListModel = new Base_List_View({ model : base_model, "view" : "inline", template : "opportunities-by-paging-model", tagName : 'div',
		className : "milestone-column panel m-b-none  b-n r-n panel-default", id : base_model.get("heading").replace(/ +/g, '') });

	// Render model in main collection
	var el = dealsListModel.render().el;

	// Append model from main collection in UI
	$('#opportunities-by-paging-model-list > div', this.el).append(el);
}

/*
 * Compare counter with length of criteria array and call function to Fetch
 * tasks from DB for next task list if available.
 */
function fetchForNextDealsList(milestones)
{
	// is All task list are done?
	if (deal_fetching)
		return;

	// Some task list are pending
	if (pipeline_count < milestones.length)
	{
		// call fetch for next task list.
		dealsFetch(pipeline_count, milestones);
	}

	// All task list are done.
	if (pipeline_count >= milestones.length)
		deal_fetching = true;
}

/**
 * Create sub collection, ad to model in main collection, fetch tasks from DB
 * for sub collection and update UI.
 */
function dealsFetch(index, milestones)
{
	console.log("index: " + index);

	// Get model from main collection
	var base_model = DEALS_LIST_COLLECTION.collection.at(index);

	if (!base_model)
		return;

	var dealsTemplate = 'deals-by-paging';

	if (!readCookie('deal-milestone-view'))
	{
		dealsTemplate = 'deals-by-paging-relax';
	}

	// Define sub collection
	var dealCollection = new Base_Collection_View({ url : base_model.get("url"), templateKey : dealsTemplate, individual_tag_name : 'li',
		sort_collection : false, cursor : true, page_size : 20, postRenderCallback : function(el)
		{
			$('ul.milestones', el).attr('milestone', base_model.get("heading"));

			if (!readCookie("agile_deal_view"))
				deal_infi_scroll($('#' + base_model.get("heading").replace(/ +/g, '') + '-list-container')[0], dealCollection);

			includeTimeAgo(el);
		} });

	// Fetch task from DB for sub collection
	dealCollection.collection.fetch({ success : function(data)
	{
		// Add sub collection in model of main collection.
		base_model.set('dealCollection', dealCollection.collection);
		$('#' + base_model.get("heading").replace(/ +/g, '') + '-list-container').html(dealCollection.render(true).el)
		console.log($('#' + base_model.get("heading").replace(/ +/g, '')).find('img.loading_img').length);
		$('#' + base_model.get("heading").replace(/ +/g, '')).find('img.loading_img').hide();
		try
		{
			var count = data.at(0) ? data.at(0).toJSON().count : 0;
			$('#' + base_model.get("heading").replace(/ +/g, '') + '_count').text(data.at(0) ? data.at(0).toJSON().count : 0);
		}
		catch (err)
		{
			console.log(err);
		}

		$('a.deal-notes').tooltip();
		// Counter to fetch next sub collection
		pipeline_count++;
		setup_deals_in_milestones('opportunities-by-paging-model-list');
		// Fetch tasks from DB for next task list
		fetchForNextDealsList(milestones);
	} });
}

function deal_infi_scroll(element_id, targetCollection)
{
	console.log("initialize_infinite_scrollbar", element_id);

	if (element_id == undefined || element_id == null)
	{
		console.log("no elmnt");
		return;
	}
	console.log(targetCollection);
	targetCollection.infiniScroll = new Backbone.InfiniScroll(targetCollection.collection, {
		target : element_id,
		untilAttr : 'cursor',
		param : 'cursor',
		strict : false,
		pageSize : targetCollection.page_size,
		success : function(colleciton, response)
		{
			console.log('in success');

			if (!colleciton.last().get("cursor"))
			{
				this.strict = true;
				targetCollection.infiniScroll.disableFetch();
			}

			// Remove loading icon
			$(targetCollection.infiniScroll.options.target).find('.scroll-loading').remove();
			includeTimeAgo($(targetCollection.infiniScroll.options.target));
			$('a.deal-notes').tooltip();
		},
		onFetch : function()
		{
			console.log('in fetch');

			// Add loading icon
			$(targetCollection.infiniScroll.options.target).append(
					'<div class="scroll-loading"> <img src="/img/ajax-loader-cursor.gif" style="margin-left: 44%;"> </div>');
		} });
}$(function()
{


	/**
	 * To avoid showing previous errors of the modal.
	 */
	$('#opportunityModal, #opportunityUpdateModal').on('show.bs.modal', function()
	{

		// Removes alert message of error related date and time.
		$('#' + this.id).find('.alert').css('display', 'none');

		// Removes error class of input fields
		$('#' + this.id).find('.error').removeClass('error');
	});

	$('#opportunityModal, #opportunityUpdateModal').on("shown.bs.modal", function()
	{

		// Add placeholder and date picker to date custom fields
		$('.date_input').attr("placeholder","Select Date");
    
		$('.date_input').datepicker({
			format: CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY
		});
	})

	/**
	 * "Hide" event of note modal to remove contacts appended to related to
	 * field and validation errors
	 */
	$('#opportunityModal').on('hidden.bs.modal', function()
	{

		// Removes appended contacts from related-to field
		$("#opportunityForm").find("li").remove();

		// Removes validation error messages
		remove_validation_errors('opportunityModal');

		// Removes note from deal form
		$('#opportunityModal #forNoteForm').html("");
		// Hide + Add note link
		$(".deal-add-note", $("#opportunityModal")).show();
		// Hide the Note label.
		$(".deal-note-label").hide();

	});

	/**
	 * "Hide" event of note modal to remove contacts appended to related to
	 * field and validation errors
	 */
	$('#opportunityUpdateModal').on('hidden.bs.modal', function()
	{

		// Removes appended contacts from related-to field
		$("#opportunityUpdateForm").find("li").remove();

		// Removes validation error messages
		remove_validation_errors('opportunityUpdateModal');

		// Removes note from deal form
		$('#opportunityUpdateModal #forNoteForm').html("");

		// Hide + Add note link
		$(".deal-add-note", $("#opportunityUpdateModal")).show();
		// Hide the Note label.
		$("#deal-note-label").hide();

	});

	
	/**
	 * Dash board edit
	 */
	$('body').on('click', '#dashboard-opportunities-model-list > tr', function(e){
		e.preventDefault();
		var currentdeal = $(this).closest('tr').data();
		Backbone.history.navigate("deal/" + currentdeal.id, { trigger : true });
		// updateDeal($(this).closest('tr').data());
	});
  
	$('body').on('click', '#deal-quick-archive', function(e)
					{
						e.preventDefault();

						// Returns, if the save button has disabled attribute
						if ($(this).attr('disabled'))
							return;

						// Disables save button to prevent multiple click event
						// issues
						disable_save_button($(this));

						var id = $("#archived-deal-id", $("#deal_archive_confirm_modal")).val();
						var milestone = $("#archived-deal-milestone", $("#deal_archive_confirm_modal")).val();
						var currentDeal;
						var dealPipelineModel;

						// Get the current deal model from the collection.
						if (Current_Route != 'deals')
						{
							currentDeal = App_Deal_Details.dealDetailView.model.toJSON();
						}
						else
						{
							dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : milestone });
							if (!dealPipelineModel)
								return;
							currentDeal = dealPipelineModel[0].get('dealCollection').get(id).toJSON();
						}

						currentDeal.archived = true;
						var that = $(this);

						var notes = [];
						$.each(currentDeal.notes, function(index, note)
						{
							notes.push(note.id);
						});
						currentDeal.notes = notes;
						if (currentDeal.note_description)
							delete currentDeal.note_description;

						if (!currentDeal.close_date || currentDeal.close_date == 0)
							currentDeal.close_date = null;

						currentDeal.owner_id = currentDeal.owner.id;

						var arch_deal = new Backbone.Model();
						arch_deal.url = '/core/api/opportunity';
						arch_deal
								.save(
										currentDeal,
										{
										// If the milestone is changed, to show
										// that change in edit popup if opened
										// without reloading the app.
										success : function(model, response)
										{
											// For deal details page.
											if (Current_Route != 'deals')
											{
												$("#deal_archive_confirm_modal").modal('hide');
												App_Deal_Details.dealDetailView.model = model;
												App_Deal_Details.dealDetailView.render(true)
												Backbone.history.navigate("deal/" + model.toJSON().id, { trigger : true });
												return;
											}

											// Remove the deal from the
											// collection and remove the UI
											// element.
											if (removeArchive(response))
											{
												dealPipelineModel[0].get('dealCollection').remove(dealPipelineModel[0].get('dealCollection').get(id));
												$('#' + id).parent().remove();
											}
											else
											{
												$('#' + id + ' .deal-options').find('.deal-archive').remove();
												$('#' + id + ' .deal-options').find('.deal-edit').remove();
												$('#' + id + ' .deal-options')
														.prepend(
																'<a title="Restore" class="deal-restore" style="cursor:pointer;text-decoration:none;"> <i style="width: 0.9em!important;" class="icon-mail-reply"></i> </a>');
											}
											console.log('archived deal----', model);
											// Shows Milestones Pie
											pieMilestones();
											enable_save_button(that);
											$("#deal_archive_confirm_modal").modal('hide');
											// Shows deals chart
											dealsLineChart();
											update_deal_collection(model.toJSON(), id, milestone, milestone);

										} });
					});

	$('body').on('click', '#deal-quick-restore', function(e)
					{
						e.preventDefault();

						var id = $("#restored-deal-id", $("#deal_restore_confirm_modal")).val();
						var milestone = $("#restored-deal-milestone", $("#deal_restore_confirm_modal")).val();
						var currentDeal;
						var dealPipelineModel;

						// Returns, if the save button has disabled attribute
						if ($(this).attr('disabled'))
							return;

						// Disables save button to prevent multiple click event
						// issues
						disable_save_button($(this));

						// Get the current deal model from the collection.
						if (Current_Route != 'deals')
						{
							currentDeal = App_Deal_Details.dealDetailView.model.toJSON();
						}
						else
						{
							dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : milestone });
							if (!dealPipelineModel)
								return;
							currentDeal = dealPipelineModel[0].get('dealCollection').get(id).toJSON();
						}

						currentDeal.archived = false;
						var that = $(this);

						var notes = [];
						$.each(currentDeal.notes, function(index, note)
						{
							notes.push(note.id);
						});
						currentDeal.notes = notes;
						if (currentDeal.note_description)
							delete currentDeal.note_description;

						if (!currentDeal.close_date || currentDeal.close_date == 0)
							currentDeal.close_date = null;
						currentDeal.owner_id = currentDeal.owner.id;
						var arch_deal = new Backbone.Model();
						arch_deal.url = '/core/api/opportunity';
						arch_deal
								.save(
										currentDeal,
										{
										// If the milestone is changed, to show
										// that change in edit popup if opened
										// without reloading the app.
										success : function(model, response)
										{
											if (Current_Route != 'deals')
											{
												$("#deal_restore_confirm_modal").modal('hide');
												App_Deal_Details.dealDetailView.model = model;
												App_Deal_Details.dealDetailView.render(true)
												Backbone.history.navigate("deal/" + model.toJSON().id, { trigger : true });
												return;
											}

											// Remove the deal from the
											// collection and remove the UI
											// element.
											if (removeArchive(response))
											{
												dealPipelineModel[0].get('dealCollection').remove(dealPipelineModel[0].get('dealCollection').get(id));
												$('#' + id).parent().remove();
											}
											else
											{
												$('#' + id + ' .deal-options').find('.deal-restore').remove();
												var htmllinks = '<a title="Archive" class="deal-archive" style="cursor:pointer;text-decoration:none;"> <i style="width: 0.9em!important;" class="icon-archive"></i> </a>';
												htmllinks += '<a title="Edit" class="deal-edit" style="cursor:pointer;text-decoration:none;"> <i style="width: 0.9em!important;" class="icon-pencil"></i> </a>';
												$('#' + id + ' .deal-options').prepend(htmllinks);
											}
											console.log('archived deal----', model);
											// Shows Milestones Pie
											pieMilestones();
											enable_save_button(that);
											$("#deal_restore_confirm_modal").modal('hide');
											// Shows deals chart
											dealsLineChart();
											update_deal_collection(model.toJSON(), id, milestone, milestone);

										} });

					});

	/**
	 * Milestone view deal delete
	 */
	$('#opportunity-listners').on('click', '.deal-archive', function(e)
	{
		e.preventDefault();

		var temp = {};
		temp.id = $(this).closest('.data').attr('id');
		temp.milestone = ($(this).closest('ul').attr("milestone")).trim();
		$("#archived-deal-id", $("#deal_archive_confirm_modal")).val(temp.id);
		$("#archived-deal-milestone", $("#deal_archive_confirm_modal")).val(temp.milestone);
		$("#deal_archive_confirm_modal").modal('show');
	});

	/**
	 * Milestone view deal delete
	 */
	$('body').on('click', '.deal-restore', function(e)
	{
		e.preventDefault();

		var temp = {};
		temp.id = $(this).closest('.data').attr('id');
		temp.milestone = ($(this).closest('ul').attr("milestone")).trim();
		$("#restored-deal-id", $("#deal_restore_confirm_modal")).val(temp.id);
		$("#restored-deal-milestone", $("#deal_restore_confirm_modal")).val(temp.milestone);
		$("#deal_restore_confirm_modal").modal('show');
	});

	$('body').on('change', '#pipeline_milestone', function(e)
	{
		var temp = $(this).val();
		var track = temp.substring(0, temp.indexOf('_'));
		var milestone = temp.substring(temp.indexOf('_') + 1, temp.length + 1);
		$(this).closest('form').find('#pipeline').val(track);
		$(this).closest('form').find('#milestone').val(milestone);
		console.log(track, '-----------', milestone);
		var lost_milestone_flag = false;
		$(this).find('option').each(function(){
			if($(this).css("display") == "none" && $(this).val() == temp){
				lost_milestone_flag = true;
			}
		});
		if(lost_milestone_flag && $('#lost_reason',$(this).closest('.modal')).find('option').length>1){
			$('#lost_reason',$(this).closest('.modal')).val("");
			$('#deal_lost_reason',$(this).closest('.modal')).removeClass("hidden");
		}else{
			$('#lost_reason',$(this).closest('.modal')).val("");
			$('#deal_lost_reason',$(this).closest('.modal')).addClass("hidden");
		}
	});

	$('body').on('click', '#deal_lost_reason_save', function(e){
		e.preventDefault();
		$(this).attr('disabled',true);
		$(this).text('Saving...');
		var dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : App_Deals.newMilestone });
		var dealModel = dealPipelineModel[0].get('dealCollection').get(App_Deals.lost_reason_milesone_id);
		dealModel.collection.get(App_Deals.lost_reason_milesone_id).set({ "lost_reason_id" : $(this).closest('.modal').find('form').find('#lost_reason').val() });
		update_milestone(App_Deals.dealModel, App_Deals.lost_reason_milesone_id, App_Deals.newMilestone, App_Deals.old_milestone, false, $(this).closest('.modal').find('form').find('#lost_reason').val());
		$('#dealLostReasonModal').modal('hide');
	});

});

/**
 * Show deal popup for editing
 */
function updateDeal(ele, editFromMilestoneView)
{

	// Checking Whether the edit is from milestone view,
	// if it is we are passing JSON object so no need to convert
	var value = (editFromMilestoneView ? ele : ele.toJSON());

	add_recent_view(new BaseModel(value));

	var dealForm = $("#opportunityUpdateForm");

	$("#opportunityUpdateForm")[0].reset();

	deserializeForm(value, $("#opportunityUpdateForm"));

	$("#opportunityUpdateModal").modal('show');

	// Hide archive button, if the is already archived.
	if (value.archived)
	{
		$('#opportunity_archive').hide();
		$('#opportunity_unarchive').show();
	}
	else
	{
		$('#opportunity_unarchive').hide();
		$('#opportunity_archive').show();
	}

	// Call setupTypeAhead to get contacts
	agile_type_ahead("relates_to", dealForm, contacts_typeahead);

	// Fills owner select element
	populateUsers("owners-list", dealForm, value, 'owner', function(data)
	{
		dealForm.find("#owners-list").html(data);
		if (value.owner)
		{
			$("#owners-list", dealForm).find('option[value=' + value['owner'].id + ']').attr("selected", "selected");
			$("#owners-list", $("#opportunityUpdateForm")).closest('div').find('.loading-img').hide();
		}
	});

	// Fills the pipelines list in the select menu.
	populateTrackMilestones(dealForm, undefined, value, function(pipelinesList)
	{

	});

	// Enable the datepicker
	$('#close_date', dealForm).datepicker({
		format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY
	});
	
	// Add notes in deal modal
	showNoteOnForm("opportunityUpdateForm", value.notes);

	add_custom_fields_to_form(value, function(data)
	{
		var el = show_custom_fields_helper(data["custom_fields"], [
			"modal"
		]);
		// if(!value["custom_data"]) value["custom_data"] = [];
		$("#custom-field-deals", dealForm).html(fill_custom_fields_values_generic($(el), value["custom_data"]));

	}, "DEAL")

	populateLostReasons(dealForm, value);

	populateDealSources(dealForm, value);
}

/**
 * Show new deal popup
 */
function show_deal()
{

	var el = $("#opportunityForm");

	$("#opportunityModal").modal('show');

	add_custom_fields_to_form({}, function(data)
	{
		var el_custom_fields = show_custom_fields_helper(data["custom_fields"], [
			"modal"
		]);
		$("#custom-field-deals", $("#opportunityModal")).html($(el_custom_fields));

	}, "DEAL");

	// Fills owner select element
	populateUsers("owners-list", el, undefined, undefined, function(data)
	{

		$("#opportunityForm").find("#owners-list").html(data);
		$("#owners-list", $("#opportunityForm")).find('option[value=' + CURRENT_DOMAIN_USER.id + ']').attr("selected", "selected");
		$("#owners-list", $("#opportunityForm")).closest('div').find('.loading-img').hide();
	});
	// Contacts type-ahead
	agile_type_ahead("relates_to", el, contacts_typeahead);

	// Fills the pipelines list in select box.
	populateTrackMilestones(el, undefined, undefined, function(pipelinesList)
	{
		console.log(pipelinesList);
		$.each(pipelinesList, function(index, pipe)
		{
			if (pipe.isDefault)
			{
				var val = pipe.id + '_';
				if (pipe.milestones.length > 0)
				{
					val += pipe.milestones.split(',')[0];
					$('#pipeline_milestone', el).val(val);
					$('#pipeline', el).val(pipe.id);
					$('#milestone', el).val(pipe.milestones.split(',')[0]);
				}

			}
		});
	});

	populateLostReasons(el, undefined);

	populateDealSources(el, undefined);

	// Enable the datepicker
	$('#close_date', el).datepicker({
		format : CURRENT_USER_PREFS.dateFormat, weekStart : CALENDAR_WEEK_START_DAY
	});
}

function checkPipeline(pipeId)
{
	var presentPipe = 0;
	if (readCookie("agile_deal_track"))
		presentPipe = readCookie("agile_deal_track");

	if (presentPipe == pipeId)
		return true;
	return false;
}

function removeArchive(deal)
{
	var result = false;
	if (readCookie('deal-filters'))
	{
		var arch = $.parseJSON(readCookie('deal-filters')).archived;
		if (arch == 'false' && deal.archived == true)
			return true;
		else if (arch == 'true' && deal.archived == false)
			return true;
		else
			return false;

	}
	else
		return result;
}

/**
 * Updates or Saves a deal
 */
function saveDeal(formId, modalId, saveBtn, json, isUpdate)
{
	// Returns, if the save button has disabled attribute
	if ($(saveBtn).attr('disabled'))
		return;

	// Disables save button to prevent multiple click event issues
	disable_save_button($(saveBtn));// $(saveBtn).attr('disabled', 'disabled');

	if (!isValidForm('#' + formId))
	{
		var container = $('#' + formId).closest('.modal');
		var ele = $('#' + formId).find('.single-error').first();
		container.scrollTop(ele.offset().top - container.offset().top + container.scrollTop());
		// Removes disabled attribute of save button
		enable_save_button($(saveBtn));// $(saveBtn).removeAttr('disabled');
		return false;
	}

	// Shows loading symbol until model get saved
	// $('#' + modalId).find('span.save-status').html(getRandomLoadingImg());
	if (json.close_date == 0)
		json.close_date = null;
	var newDeal = new Backbone.Model();
	newDeal.url = 'core/api/opportunity';
	newDeal.save(json, { success : function(data)
	{

		// Removes disabled attribute of save button
		enable_save_button($(saveBtn));// $(saveBtn).removeAttr('disabled');

		// $('#' + modalId).find('span.save-status img').remove();
		$('#' + modalId).modal('hide');

		$('#' + formId).each(function()
		{
			this.reset();
		});

		var deal = data.toJSON();

		add_recent_view(new BaseModel(deal));

		// Updates data to timeline
		if (App_Contacts.contactDetailView && Current_Route == "contact/" + App_Contacts.contactDetailView.model.get('id'))
		{

			// Add model to collection. Disabled sort while adding and called
			// sort explicitly, as sort is not working when it is called by add
			// function

			/*
			 * Verifies whether the added deal is related to the contact in
			 * contact detail view or not
			 */
			$.each(deal.contacts, function(index, contact)
			{

				if (contact.id == App_Contacts.contactDetailView.model.get('id'))
				{

					if (dealsView && dealsView.collection)
					{
						if (deal.archived == true)
						{
							dealsView.collection.remove(deal.id);
							dealsView.collection.sort();
						}
						else if (dealsView.collection.get(deal.id))
						{
							dealsView.collection.get(deal.id).set(new BaseModel(deal));
						}
						else
						{
							dealsView.collection.add(new BaseModel(deal), { sort : false });
							dealsView.collection.sort();
						}
					}

					// Activates "Timeline" tab and its tab content in
					// contact detail view
					// activate_timeline_tab();
					add_entity_to_timeline(data);
					/*
					 * If timeline is not defined yet, initiates with the data
					 * else inserts
					 */
					return false;
				}
			});
		} else if(App_Companies.companyDetailView
				&& Current_Route == "company/"
					+ App_Companies.companyDetailView.model.get('id')){
			company_util.updateDealsList(deal,true);
		}
		// When deal is added or updated from Deals route
		else if (Current_Route == 'deals')
		{

			if (!readCookie("agile_deal_view"))
			{

				var newMilestone = deal.milestone;

				if (isUpdate)
				{

					var id = deal.id;
					var oldMilestone = $('#' + id).attr('data');
					// update_deal_collection(deal, id, newMilestone,
					// oldMilestone);

					var dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : oldMilestone });
					if (!dealPipelineModel)
						return;
					dealPipelineModel[0].get('dealCollection').remove(dealPipelineModel[0].get('dealCollection').get(id));

					if (!checkPipeline(deal.pipeline_id))
					{
						console.log('removing the deal');
						$("#" + oldMilestone.replace(/ +/g, '')).find("#" + id).parent().remove();
						try
						{
							$('#' + oldMilestone.replace(/ +/g, '') + '_count').text(parseInt($('#' + oldMilestone.replace(/ +/g, '') + '_count').text()) - 1);
						}
						catch (err)
						{
							console.log(err);
						}
					}
					else if (newMilestone != oldMilestone)
					{

						dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : newMilestone });
						if (!dealPipelineModel)
							return;

						dealPipelineModel[0].get('dealCollection').add(copyCursor(dealPipelineModel, deal));
						$("#" + oldMilestone.replace(/ +/g, '')).find("#" + id).parent().remove();

						try
						{
							$('#' + newMilestone.replace(/ +/g, '') + '_count').text(parseInt($('#' + newMilestone.replace(/ +/g, '') + '_count').text()) + 1);
							$('#' + oldMilestone.replace(/ +/g, '') + '_count').text(parseInt($('#' + oldMilestone.replace(/ +/g, '') + '_count').text()) - 1);
						}
						catch (err)
						{
							console.log(err);
						}
					}
					else
					{
						dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : newMilestone });
						if (!dealPipelineModel)
							return;

						dealPipelineModel[0].get('dealCollection').add(copyCursor(dealPipelineModel, deal), { silent : true });
						console.log('Updating html - ', deal);
						var dealsTemplate = 'deals-by-paging-model';

						if (!readCookie('deal-milestone-view'))
						{
							dealsTemplate = 'deals-by-paging-relax-model';
						}
						$("#" + newMilestone.replace(/ +/g, '')).find("#" + id).parent().html(getTemplate(dealsTemplate, deal));
					}

					if (removeArchive(deal))
					{

						console.log('removing the deal when archived');
						$("#" + oldMilestone.replace(/ +/g, '')).find("#" + id).parent().remove();
						try
						{
							$('#' + oldMilestone.replace(/ +/g, '') + '_count').text(parseInt($('#' + oldMilestone.replace(/ +/g, '') + '_count').text()) - 1);
						}
						catch (err)
						{
							console.log(err);
						}
					}

				}
				else if (checkPipeline(deal.pipeline_id))
				{
					var dealPipelineModel = DEALS_LIST_COLLECTION.collection.where({ heading : newMilestone });
					if (!dealPipelineModel)
						return;
					var filterJSON = $.parseJSON(readCookie('deal-filters'));
					console.log(deal.owner.id.toString() != filterJSON.owner_id, deal.owner.id.toString(), filterJSON.owner_id);
					if (filterJSON.owner_id.length > 0 && deal.owner.id.toString() != filterJSON.owner_id)
						return;
					console.log(filterJSON.archived != 'all' && deal.archived != filterJSON.archived, deal.archived);
					if (filterJSON.archived)
					{
						console.log(filterJSON.archived);
						if (filterJSON.archived != 'all' && deal.archived.toString() != filterJSON.archived)
							return;
					}

					dealPipelineModel[0].get('dealCollection').add(copyCursor(dealPipelineModel, deal));
					try
					{
						$('#' + newMilestone.replace(/ +/g, '') + '_count').text(parseInt($('#' + newMilestone.replace(/ +/g, '') + '_count').text()) + 1);
					}
					catch (err)
					{
						console.log(err);
					}
				}
				includeTimeAgo($("#" + newMilestone.replace(/ +/g, '')));
				$('a.deal-notes').tooltip();
			}
			else
			{
				if (isUpdate)
					App_Deals.opportunityCollectionView.collection.remove(json);
				if (App_Deals.opportunityCollectionView.collection.length > 0)
					data.attributes.cursor = App_Deals.opportunityCollectionView.collection.last().toJSON().cursor;
				App_Deals.opportunityCollectionView.collection.add(data);
				App_Deals.opportunityCollectionView.render(true);
			}

		}
		else if (Current_Route == undefined || Current_Route == 'dashboard')
		{
			if (App_Portlets.currentPosition && App_Portlets.pendingDeals && App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)])
			{
				if (isUpdate)
					App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)].collection.remove(json);

				// Updates task list view
				if (json.milestone != "Won" && json.milestone != "Lost")
					App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)].collection.add(data);

				App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)].render(true);
			}
			if (App_Portlets.currentPosition && App_Portlets.dealsWon && App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)])
			{
				if (isUpdate)
					App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)].collection.remove(json);

				// Updates task list view
				App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)].collection.add(data);

				App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)].render(true);
			}

		}
		else
		{
			App_Deal_Details.dealDetailView.model = data;
			App_Deal_Details.dealDetailView.render(true)
			Backbone.history.navigate("deal/" + data.toJSON().id, { trigger : true });
			/*
			 * App_Deals.navigate("deals", { trigger : true });
			 */

		}
	}, error : function(model, err)
	{
		enable_save_button($(saveBtn));
		$('#' + modalId).find('span.error-status').html(err.responseText);
		setTimeout(function()
		{
			$('#' + modalId).find('span.error-status').html('');
		}, 2000);
		console.log('-----------------', err.responseText);
	} });
}/**
 * opportunity.js is a script file that handles opportunity pop-over,
 * milestones and owner select list.
 * 
 * @module Deals
 * 
 **/
$(function () {
	
	/**
	 * When mouseover on any row of opportunities list, the popover of deal is shown
	 **/
	$('#opportunity-listners').on('mouseenter', '#opportunities-model-list > tr', function(e) {
        var data = $(this).find('.data').attr('data');

        var currentDeal = App_Deals.opportunityCollectionView.collection.get(data);
        var that = this;
        
        getTemplate("opportunity-detail-popover", currentDeal.toJSON(), undefined, function(template_ui){
			if(!template_ui)
				  return;
			
			var ele = $(template_ui);
	        console.log(ele);
	        console.log(that);
	        $(that).popover({
	        	"rel" : "popover",
	        	"trigger" : "hover",
	        	"placement" : 'right',
	        	"original-title" : currentDeal.toJSON().name,
	        	"content" :  ele,
	        	"html" : true,
	        	"container": 'body'
	        });
       
	        /**
	         * Checks for last 'tr' and change placement of popover to 'top' inorder
	         * to prevent scrolling on last row of list
	         **/
	       $('#opportunities-model-list > tr:last').popover({
	        	"rel" : "popover",
	        	"trigger" : "hover",
	        	"placement" : 'top',
	        	"original-title" : currentDeal.toJSON().name,
	        	"content" :  ele,
	        	"html" : true,
	        	"container": 'body'
	        });

	        $(that).popover('show');

		}, null);

     });
	
    /**
     * On mouse out on the row hides the popover.
     **/
	$('#opportunity-listners').on('mouseleave', '#opportunities-model-list > tr', function(e) {
    	 $(this).popover('hide');
    });
	
    /**
     * On click on the row hides the popover.
     **/
	$('#opportunity-listners').on('click', '#opportunities-model-list > tr, .hide-popover', function(e) {
    	 $(this).closest('tr').popover('hide');
    });
    
   /**
    * When deal is added from contact-detail by selecting 'Add Opportunity' from actions 
    * and then close button of deal is clicked, it should navigate to contact-detail.
    **/
	$('#opportunity-listners').on('click', '#close-deal', function(e) {
    	e.preventDefault();
    	window.history.back();
    });
	
	$('#opportunity-listners').on('click', '#deal-milestone-regular', function(e) {
    	e.preventDefault();
    	eraseCookie('deal-milestone-view');
    	App_Deals.deals();
    });
	
	$('body').on('click', '#deal-milestone-compact', function(e) {
    	e.preventDefault();
    	createCookie('deal-milestone-view','compact');
    	App_Deals.deals();
    });
	
	$('body').on('click', '#deal-milestone-fit', function(e) {
    	e.preventDefault();
    	createCookie('deal-milestone-view','fit');
    	App_Deals.deals();
    });
	
	//Check the archived filter for the first time and set it to false as default.
	if(readCookie('deal-filters')){
		var json = $.parseJSON(readCookie('deal-filters'));
		if(!json.archived){
			json.archived="false";
			createCookie('deal-filters',JSON.stringify(json));
		}
	} else {
		var json = {"owner_id":"","pipeline_id":"","milestone":"","value_filter":"equals","value":"","value_start":"","value_end":"","archived":"false","":false,"contact_ids":[]};
		json.archived="false";
		createCookie('deal-filters',JSON.stringify(json));
	}
	
});

/**
 * Populate users in options of owner input field drop-down.
 * When new deal is created,owner select is filled with owners list.When
 * deal is need to edit,the owner select field is filled with previous option.
 *  
 * @param id - Id of select element of Owner
 * @param el - el references the DOM object created in the browser.
 * @param value - Deal object
 * @param key - key name in the value.It is passed during declaration
 **/
function populateUsers(id, el ,value, key, callback) {
		
	// Users set id of agile user to save agileuser key in opportunities
	var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
	
	 /**
      * Fills owner select with existing Users.
      * 
      * @param id - Id of select element of Owner
      * @param /core/api/users - Url to get users
      * @param 'domainUser' - parse key
      * @param function - callback function
      * @param optionsTemplate- to fill options with users
      **/
	fillSelect(id,'/core/api/users', 'domainUser', function fillOwner() {
		
		if(value)
		{
			// If domain user is deleted owner is undefined
			if(value[key])
				// While deserialize set agile user id from user prefs, to save agile user key in opportunity 
				$('#' + id, el).find('option[value='+ value[key].id +']').attr("selected", "selected");
		}
		else
			$('#' + id, el).find('option[value='+ CURRENT_DOMAIN_USER.id +']').attr("selected", "selected");
		// If callback is present, it is called to deserialize the select field
		if (callback && typeof (callback) === "function") {
			// execute the callback, passing parameters as necessary
			callback($('#' + id).html());
		}
	}, optionsTemplate); 
	
	
}

/**
 * Populate Pipelines in options of pipeline input field drop-down.
 * When new deal is created,pipeline select is filled with pipelines list.When
 * deal is need to edit,the pipeline select field is filled with previous option.
 * 
 * @param el - el references the DOM object created in the browser.
 * @param dealDetails - dealDetails value
 * @param value - Deal Object
 **/
function populateTrackMilestones(el, dealsDetails, value, callback, defaultSelectOption, id){
var tracks = new Base_Collection_View({url : '/core/api/milestone/pipelines'});
	
	// If id undefined
	if(!id)
		id = 'pipeline_milestone';

	tracks.collection.fetch({
		success: function(data){
			var jsonModel = data.toJSON();
			var html = '<option value="">Select...</option>';
			console.log(jsonModel);
			
			// If there is only one pipeline, select the option by default and hide the field.
			if(jsonModel.length==1){
				var mile = jsonModel[0];
				$.each(mile.milestones.split(","), function(index,milestone){
					if(value && mile.id == value.pipeline_id && milestone == value.milestone)
						html+='<option value="'+mile.id+'_'+milestone+'" selected="selected">'+milestone+'</option>';
					else
						html+='<option value="'+mile.id+'_'+milestone+'">'+milestone+'</option>';
				});
				if(mile.lost_milestone){
					html+='<option value="'+mile.id+'_'+mile.lost_milestone+'" style="display:none;">'+mile.lost_milestone+'</option>';
				}
				$('#' + id, el).closest('.control-group').find('label b').text('Milestone');
			}
			else {
				$.each(jsonModel,function(index,mile){
					console.log(mile.milestones,value);
					var array = [];
					html+='<optgroup label="'+mile.name+'">';
					$.each(mile.milestones.split(","), function(index,milestone){
						array.push($.trim(this));
						if(value && mile.id == value.pipeline_id && milestone == value.milestone)
							html+='<option value="'+mile.id+'_'+milestone+'" selected="selected">'+mile.name+' - '+milestone+'</option>';
						else
							html+='<option value="'+mile.id+'_'+milestone+'">'+mile.name+' - '+milestone+'</option>';
					});
					if(mile.lost_milestone){
						html+='<option value="'+mile.id+'_'+mile.lost_milestone+'" style="display:none;">'+mile.name+' - '+mile.lost_milestone+'</option>';
					}
					html+='</optgroup>';
				});
				$('#' + id, el).closest('.control-group').find('label b').text('Track & Milestone');
			}
			$('#' + id, el).html(html);
			console.log('adding');
			$('#' + id, el).closest('div').find('.loading-img').hide();

			// Hide loading bar
			hideTransitionBar();
			
			/* Hide the Tracks select box when there is only one pipeline.
			if(jsonModel.length==1){
				$('#pipeline',el).closest('div.control-group').hide();
				$('#milestone',el).closest('div.control-group').css("margin-left","0px");
				$('#dealsFilterForm #pipeline',el).closest('div.control-group').show();
			}*/
			
			if (callback && typeof (callback) === "function") {
				// execute the callback, passing parameters as necessary
				callback(jsonModel);
			}
		}
	}); 
}

/**
 * Populate Pipelines in options of pipeline input field drop-down.
 * When new deal is created,pipeline select is filled with pipelines list.When
 * deal is need to edit,the pipeline select field is filled with previous option.
 * 
 * @param el - el references the DOM object created in the browser.
 * @param dealDetails - dealDetails value
 * @param value - Deal Object
 **/
function populateTracks(el, dealsDetails, value, callback, defaultSelectOption){
var tracks = new Base_Collection_View({url : '/core/api/milestone/pipelines'});
	
	tracks.collection.fetch({
		success: function(data){
			hideTransitionBar();
			var jsonModel = data.toJSON();
			var html = '<option value="">Select..</option>';
			console.log(jsonModel);
			
			// If there is only one pipeline, select the option by default and hide the field.
			if(jsonModel.length==1){
				html+='<option value="'+jsonModel[0].id+'" selected="selected">'+jsonModel[0].name+'</option>';
				milestone_util.showMilestonePopup(jsonModel[0]);
			}
			else {
				milestone_util.isNotyVisible = false;
				$.each(jsonModel,function(index,mile){
					console.log(mile.milestones,value);
					if(!mile.name)
						mile.name = 'Default';
					if(value && mile.id == value.pipeline_id)
						html+='<option value="'+mile.id+'" selected="selected">'+mile.name+'</option>';
					else
						html+='<option value="'+mile.id+'">'+mile.name+'</option>';
					milestone_util.showMilestonePopup(mile);
				});
			}
			$('#pipeline',el).html(html);
			console.log('adding');
			$('#pipeline',el).closest('div').find('.loading-img').hide();
			
			// Hide the Tracks select box when there is only one pipeline.
			if(jsonModel.length==1){
				$('#pipeline',el).closest('div.control-group').hide();
				$('#milestone',el).closest('div.control-group').css("margin-left","0px");
				$('#dealsFilterForm #pipeline',el).closest('div.control-group').show();
			}
			
			if (callback && typeof (callback) === "function") {
				// execute the callback, passing parameters as necessary
				callback(jsonModel);
			}
		}
	}); 
}

/**
 * Populate milestones in options of milestone input field drop-down.
 * When new deal is created,milestone select is filled with milestones list.When
 * deal is need to edit,the milestone select field is filled with previous option.
 * 
 * @param el - el references the DOM object created in the browser.
 * @param dealDetails - dealDetails value
 * @param piepline - pipeline value, to which the deal belogs to.
 * @param value - Deal Object
 **/
function populateMilestones(el, dealsDetails, pipeline, value, callback, defaultSelectOption){
	 // Fill milestones in select options
    var milestone_model = Backbone.Model.extend({
   	 url: '/core/api/milestone/'+pipeline
		});
    
    var model = new milestone_model();
    model.fetch({ 
   			 success: function(data) 
   			 { 
   				 		var jsonModel = data.toJSON();
						var milestones = jsonModel.milestones;
						console.log("------", data);
						// Split , and trim
						var array = [];
						$.each(milestones.split(","), function(){
							array.push($.trim(this));
						});
						if(dealsDetails)
						{
							fillMilestones('move', array);
							return;
						}
						/**
						 * Fills milestone select with existing milestones.
						 * 
						 * @param 'milestone' - Id of select element of Owner
						 * @param  array - array of milestones
						 * @param function - callback function
						 **/
						fillTokenizedSelect('pipeline_milestone', array, function(){
														
							// Quotes required for option value because milestone can have spaces in between
							if(value && value.milestone)
								$("#pipeline_milestone",el).find('option[value=\"'+ value.milestone +'\"]').attr("selected", "selected");
								
							// If callback is present, it is called to deserialize the select field
							if (callback && typeof (callback) === "function") {
								var optionsHtml = '<option value="">Select...</option>';
								$.each(array, function(index,element){
									optionsHtml += '<option value=' + '"' + element + '">' + element + '</option>'
								});
								// execute the callback, passing parameters as necessary
								callback($(optionsHtml));
							}
						}, defaultSelectOption);
    			   }
    });
}

/**
 * Build the Pipeline list filter for displaying the pipeline.
 * @param cel
 * @returns
 */
function setupDealsTracksList(cel){
	this.trackListView = new Base_Collection_View({ url : '/core/api/milestone/pipelines', templateKey : "opportunity-track-list", individual_tag_name : 'li', postRenderCallback : function(el){
		
		var tracksArray = trackListView.collection.models;
		$.each(tracksArray,function(i,value){
			console.log(value.toJSON());
			if(pipeline_id == 0 && value.toJSON().isDefault){
				pipeline_id = value.id;
				console.log('default pipeline set.');
				createCookie('agile_deal_track',pipeline_id);
			}
				
			if(value.id == pipeline_id)
				$('#deals-tracks .filter-dropdown').append(value.attributes.name);
		});
		
		// Add all option for the deals in the list view.
		if (readCookie("agile_deal_view"))
			$('#deals-tracks .dropdown-menu').append('<li><a id="1" class="pipeline" data="All" style="cursor: pointer;">All</a></li>');
		else{
			startGettingDeals();
		}
		// Hide the track list if there is only one pipeline.
		if(tracksArray.length<=1)
			$('#deals-tracks',cel).hide();
		
		
	}});
	this.trackListView.collection.fetch();
	$('#deals-tracks',cel).append(this.trackListView.render().el);
	
}

/**
 * Copy the cursor in the last model of collection to the new model while adding it to the collection. 
 * @param dealPipelineModel
 * @param newDeal
 * @returns
 */
function copyCursor(dealPipelineModel, newDeal){
	var dealColl = dealPipelineModel[0].get('dealCollection');
	if(dealColl.length > 0 && dealColl.at(dealColl.length -1).get('cursor'))
		newDeal.cursor = dealColl.at(dealColl.length -1).get('cursor');
	
	return newDeal;
}

/**
 * Append Column names for Deals customfields to the Deals List view.
 */
function appendCustomfieldsHeaders(el){
	$.ajax({
		url: 'core/api/custom-fields/scope?scope=DEAL',
		type: 'GET',
		dataType: 'json',
		success: function(customfields){
			var columns = '';
			$.each(customfields, function(index,customfield){
				//console.log(customfield);
				columns += '<th>'+customfield.field_label+'</th>';
			});
			$(el).find('#deal-list thead tr').append(columns);
		}
	});
}

/**
 * Append Deals customfields to the Deals List view.
 */ 
function appendCustomfields(el){
	$.ajax({
		url: 'core/api/custom-fields/scope?scope=DEAL',
		type: 'GET',
		dataType: 'json',
		success: function(customfields){
			 var deals = App_Deals.opportunityCollectionView.collection.models;
			 $(el).find('td.deal_custom_replace').remove();
			 $(el).find('#opportunities-model-list tr').each(function(index,element){
				 var row = '';
				 $.each(customfields, function(i,customfield){
				 		if(customfield.field_type == "DATE")
				 			row += '<td class="deal_custom_replace"><div class="text-ellipsis" style="width:6em">'+dealCustomFieldValueForDate(customfield.field_label,deals[index].attributes.custom_data)+'</div></td>';
				 		else
							row += '<td class="deal_custom_replace"><div class="text-ellipsis" style="width:6em">'+dealCustomFieldValue(customfield.field_label,deals[index].attributes.custom_data)+'</div></td>';
					});
				 $(this).append(row);
			 });
			 
		}
	});
}

/**
 * Returns the value of the custom field.
 * @param name name of the custom field.
 * @param data the name. value pair of the custom fields of the deal.
 * @returns {String} value of the custom field.
 */
function dealCustomFieldValue(name, data){
	var value = '';
	$.each(data,function(index, field){
		if(field.name == name){
			value = field.value;
		}
	});
	return value;
}

function dealCustomFieldValueForDate(name, data){
	var value = '';
	$.each(data,function(index, field){
		if(field.name == name){
			if(!field.value)
				return '';
			var dateString = new Date(field.value);
			if(dateString == "Invalid Date")
				value = getDateInFormatFromEpoc(field.value);
			else
				value = en.dateFormatter({raw: getGlobalizeFormat()})(dateString);
			
		}
	});
	return value;
}

function populateLostReasons(el, value){
	if(!$('#deal_lost_reason',el).hasClass("hidden")){
		$('#deal_lost_reason',el).addClass("hidden");
	}
	var tracks = new Base_Collection_View({url : '/core/api/categories?entity_type=DEAL_LOST_REASON', sortKey : "label"});
	tracks.collection.fetch({
		success: function(data){
			var jsonModel = data.toJSON();
			var html = '<option value="">Select...</option>';
			console.log(jsonModel);
			
			$.each(jsonModel,function(index,lostReason){
				if (value && value.lost_reason_id == lostReason.id){
					html+='<option value="'+lostReason.id+'" selected="selected">'+lostReason.label+'</option>';
					$('#deal_lost_reason',el).removeClass("hidden");
				}else{
					html+='<option value="'+lostReason.id+'">'+lostReason.label+'</option>';
				}
			});
			$('#lost_reason', el).html(html);
			console.log('adding');
			$('#lost_reason', el).closest('div').find('.loading-img').hide();

			// Hide loading bar
			hideTransitionBar();

			if($('#pipeline_milestone',el).length>0){
				var temp = $('#pipeline_milestone',el).val();
				var track = temp.substring(0, temp.indexOf('_'));
				var milestone = temp.substring(temp.indexOf('_') + 1, temp.length + 1);
				$('#pipeline_milestone',el).closest('form').find('#pipeline').val(track);
				$('#pipeline_milestone',el).closest('form').find('#milestone').val(milestone);
				console.log(track, '-----------', milestone);
				var lost_milestone_flag = false;
				$('#pipeline_milestone',el).find('option').each(function(){
					if($(this).css("display") == "none" && $(this).val() == temp){
						lost_milestone_flag = true;
					}
				});
				if(lost_milestone_flag && $('#lost_reason',$('#pipeline_milestone',el).closest('.modal')).find('option').length>1){
					$('#deal_lost_reason',$('#pipeline_milestone',el).closest('.modal')).removeClass("hidden");
				}else{
					$('#lost_reason',$('#pipeline_milestone',el).closest('.modal')).val("");
					$('#deal_lost_reason',$('#pipeline_milestone',el).closest('.modal')).addClass("hidden");
				}
			}else{
				if($('#lost_reason',el).find('option').length>1){
					$('#dealLostReasonModal').modal('show');
				}
			}
		}
	}); 
}

function populateDealSources(el, value){
	if(!$('#deal_deal_source',el).hasClass("hidden")){
		$('#deal_deal_source',el).addClass("hidden");
	}
	var tracks = new Base_Collection_View({url : '/core/api/categories?entity_type=DEAL_SOURCE', sortKey : "label"});
	tracks.collection.fetch({
		success: function(data){
			var jsonModel = data.toJSON();
			var html = '<option value="">Select...</option>';
			console.log(jsonModel);
			
			$.each(jsonModel,function(index,dealSource){
				if (value && value.deal_source_id == dealSource.id){
					html+='<option value="'+dealSource.id+'" selected="selected">'+dealSource.label+'</option>';
					$('#deal_deal_source',el).removeClass("hidden");
				}else{
					html+='<option value="'+dealSource.id+'">'+dealSource.label+'</option>';
				}
			});
			$('#deal_source', el).html(html);
			console.log('adding');
			$('#deal_source', el).closest('div').find('.loading-img').hide();

			// Hide loading bar
			hideTransitionBar();

			if($('#deal_source',el).find('option').length>1){
				$('#deal_deal_source',el).removeClass("hidden");
			}
		}
	}); 
}var portlet_graph_data_utility = {

	/**
	 * Generic function to fetch data for graphs and act accordingly on plan
	 * limit error
	 * 
	 * @param url
	 * @param successCallback
	 */
	fetchPortletsGraphData : function(url, successCallback) {
		// Hides error message
		$("#plan-limit-error").hide();

		// Fetches data
		$.getJSON(url, function(data) {
			// Sends data to callback
			if (successCallback && typeof (successCallback) === "function")
				successCallback(data);
		}).error(function(response) {
			// If error is not billing exception and forbidden exception then it
			// is returned
			if (response.status != 406 && response.status != 403)
				return;

			// If it is billing exception or forbidden exception, then empty set
			// is sent so page will not be showing loading on error message
			if (successCallback && typeof (successCallback) === "function")
				successCallback(response);
		});
	},

	/**
	 * To fetch deals by milestone portlet data to render as pie graph
	 */
	dealsByMilestoneGraphData : function(base_model, selector, url) {
		var milestonesList = [];
		var milestoneValuesList = [];
		var milestoneNumbersList = [];

		var milestoneMap = [];
		var sizey = parseInt($('#' + selector).parent().attr("data-sizey"));
		var topPos = 50 * sizey;
		if (sizey == 2 || sizey == 3)
			topPos += 50;
		$('#' + selector)
				.html(
						"<div class='text-center v-middle opa-half' style='margin-top:"
								+ topPos
								+ "px'><img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 403) {
								$('#' + selector)
										.html(
												"<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
								return;
							}
							milestonesList = data["milestonesList"];
							milestoneValuesList = data["milestoneValuesList"];
							milestoneNumbersList = data["milestoneNumbersList"];
							milestoneMap = data["milestoneMap"];
							portlet_graph_utility.dealsByMilestonePieGraph(
									selector, milestonesList,
									milestoneValuesList, milestoneNumbersList);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},

	/**
	 * To fetch closers per person portlet data to render as bar graph
	 */
	closuresPerPersonGraphData : function(base_model, selector, url) {
		var milestoneNumbersList = [];
		var milestoneValuesList = [];
		var domainUsersList = [];
		$('#' + selector).html(getRandomLoadingImg());
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 403) {
								$('#' + selector)
										.html(
												"<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
								return;
							}
							milestoneNumbersList = data["milestoneNumbersList"];
							milestoneValuesList = data["milestoneValuesList"];
							domainUsersList = data["domainUsersList"];

							var catges = [];

							$.each(domainUsersList,
									function(index, domainUser) {
										catges.push(domainUser);
									});

							var data2 = [];
							var text = '';
							var name = '';

							if (base_model.get('settings')["group-by"] == "number-of-deals") {
								$.each(milestoneNumbersList, function(index,
										mNumber) {
									data2.push(mNumber);
								});
								text = "No. of Deals Won";
								name = "Deals Won";
							} else {
								$.each(milestoneValuesList, function(index,
										mValue) {
									data2.push(mValue);
								});
								text = "Deals Won Value";
								name = "Won Deal Value";
							}

							portlet_graph_utility.closuresPerPersonBarGraph(
									selector, catges, data2, text, name);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},

	/**
	 * To fetch deals funnel portlet data to render as funnel graph
	 */
	dealsFunnelGraphData : function(base_model, selector, url) {
		var milestonesList = [];
		var milestoneValuesList = [];
		var milestoneMap = [];
		var sizey = parseInt($('#' + selector).parent().attr("data-sizey"));
		var topPos = 50 * sizey;
		if (sizey == 2 || sizey == 3)
			topPos += 50;
		$('#' + selector)
				.html(
						"<div class='text-center v-middle opa-half' style='margin-top:"
								+ topPos
								+ "px'><img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 403) {
								$('#' + selector)
										.html(
												"<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
								return;
							}
							milestonesList = data["milestonesList"];
							milestoneValuesList = data["milestoneValuesList"];
							milestoneMap = data["milestoneMap"];
							wonMilestone = data["wonMilestone"];
							lostMilestone = data["lostMilestone"];

							var funnel_data = [];
							var temp;

							$.each(milestonesList, function(index, milestone) {
								var each_data = [];
								if (milestone != lostMilestone) {
									if (milestone != wonMilestone)
										each_data.push(milestone,
												milestoneValuesList[index]);
									else
										temp = index;
									if (each_data != "")
										funnel_data.push(each_data);
								}
							});

							var temp_data = [];
							if (temp != undefined) {
								temp_data.push(milestonesList[temp],
										milestoneValuesList[temp]);
								funnel_data.push(temp_data);
							}
							var falg = false;
							$.each(funnel_data, function(index, json1) {
								if (json1[1] > 0)
									falg = true;
							});
							if (falg)
								funnel_data = funnel_data;
							else
								funnel_data = [];
							portlet_graph_utility.dealsFunnelGraph(selector,
									funnel_data);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},

	/**
	 * To fetch emails sent portlet data to render as bar graph
	 */
	emailsSentGrapgData : function(base_model, selector, url) {
		var domainUsersList = [];
		var mailsCountList = [];
		var mailsOpenedCountList = [];
		$('#' + selector).html(getRandomLoadingImg());
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 403) {
								$('#' + selector)
										.html(
												"<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
								return;
							}
							domainUsersList = data["domainUsersList"];
							mailsCountList = data["mailsCountList"];
							mailsOpenedCountList = data["mailsOpenedCountList"];

							var series = [];
							var text = '';
							var colors;

							var tempData = {};
							tempData.name = "Emails Not Opened";
							tempData.data = mailsCountList;
							series[0] = tempData;
							tempData = {};
							tempData.name = "Emails Opened";
							tempData.data = mailsOpenedCountList;
							series[1] = tempData;
							text = "No. of Emails";
							colors = [ 'gray', 'green' ];

							portlet_graph_utility.emailsSentBarGraph(selector,
									domainUsersList, series, mailsCountList,
									mailsOpenedCountList, text, colors);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},

	/**
	 * To fetch growth graph portlet data to render as area spline graph
	 */
	growthGraphData : function(base_model, selector, url) {

		var sizey = parseInt($('#' + selector).parent().attr("data-sizey"));
		var topPos = 50 * sizey;
		if (sizey == 2 || sizey == 3)
			topPos += 50;
		$('#' + selector)
				.html(
						"<div class='text-center v-middle opa-half' style='margin-top:"
								+ topPos
								+ "px'><img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 406) {
								// Show cause of error in saving
								$save_info = $('<div class="portlet-error-message inline-block"><small><p class="text-base" style="color:#B94A48;"><i>'
										+ data.responseText
										+ '</i></p></small></div>');

								$('#' + selector).html($save_info).show();

								return;
							}

							var categories = [];
							var tempcategories = [];
							var dataLength = 0;
							var min_tick_interval = 1;
							var frequency = base_model.get('settings').frequency;

							var sortedKeys = [];
							$.each(data, function(k, v) {
								sortedKeys.push(k);
							});
							sortedKeys.sort();
							var sortedData = {};
							$.each(sortedKeys, function(index, value) {
								sortedData['' + value] = data['' + value];
							});
							var series;
							// Iterates through data and adds keys into
							// categories
							$.each(sortedData, function(k, v) {
								// Initializes series with names with the first
								// data point
								if (series == undefined) {
									var index = 0;
									series = [];
									$.each(v, function(k1, v1) {
										var series_data = {};
										series_data.name = k1;
										series_data.data = [];
										series[index++] = series_data;
									});
								}
								// Fill Data Values with series data
								$.each(v, function(k1, v1) {
									// Find series with the name k1 and to that,
									// push v1
									var series_data = find_series_with_name(
											series, k1);
									var dt = new Date(k * 1000);
									series_data.data.push(v1);
								});
								tempcategories.push(k * 1000);
								dataLength++;

							});

							var cnt = 0;
							if (Math.ceil(dataLength / 10) > 0) {
								min_tick_interval = Math.ceil(dataLength / 10);
								if (min_tick_interval == 3) {
									min_tick_interval = 4;
								}
							}
							head
									.js(
											LIB_PATH
													+ 'lib/flot/highcharts-3.js',
											function() {
												$
														.each(
																sortedData,
																function(k, v) {
																	var dte = new Date(
																			tempcategories[cnt]);
																	if (frequency != undefined) {
																		if (frequency == "daily") {
																			categories
																					.push(Highcharts
																							.dateFormat(
																									'%e.%b',
																									Date
																											.UTC(
																													dte
																															.getUTCFullYear(),
																													dte
																															.getUTCMonth(),
																													dte
																															.getUTCDate()))
																							+ '');
																		} else if (frequency == "weekly") {
																			if (cnt != dataLength - 1) {
																				var next_dte = new Date(
																						tempcategories[cnt + 1]);
																				categories
																						.push(Highcharts
																								.dateFormat(
																										'%e.%b',
																										Date
																												.UTC(
																														dte
																																.getUTCFullYear(),
																														dte
																																.getUTCMonth(),
																														dte
																																.getUTCDate()))
																								+ ' - '
																								+ Highcharts
																										.dateFormat(
																												'%e.%b',
																												Date
																														.UTC(
																																next_dte
																																		.getUTCFullYear(),
																																next_dte
																																		.getUTCMonth(),
																																next_dte
																																		.getUTCDate() - 1)));
																			} else {
																				var end_date = new Date();
																				categories
																						.push(Highcharts
																								.dateFormat(
																										'%e.%b',
																										Date
																												.UTC(
																														dte
																																.getUTCFullYear(),
																														dte
																																.getUTCMonth(),
																														dte
																																.getUTCDate()))
																								+ ' - '
																								+ Highcharts
																										.dateFormat(
																												'%e.%b',
																												Date
																														.UTC(
																																end_date
																																		.getFullYear(),
																																end_date
																																		.getMonth(),
																																end_date
																																		.getDate())));
																			}
																		} else if (frequency == "monthly") {
																			if (cnt != dataLength - 1) {
																				var next_dte = new Date(
																						tempcategories[cnt + 1]);
																				var current_date = new Date();
																				var from_date = '';
																				var to_date = '';
																				if (cnt != 0) {
																					if (current_date
																							.getUTCFullYear() != dte
																							.getUTCFullYear()) {
																						from_date = Highcharts
																								.dateFormat(
																										'%b.%Y',
																										Date
																												.UTC(
																														dte
																																.getUTCFullYear(),
																														dte
																																.getUTCMonth(),
																														dte
																																.getUTCDate()));
																					} else {
																						from_date = Highcharts
																								.dateFormat(
																										'%b',
																										Date
																												.UTC(
																														dte
																																.getUTCFullYear(),
																														dte
																																.getUTCMonth(),
																														dte
																																.getUTCDate()));
																					}
																					categories
																							.push(from_date);
																				} else {
																					if (current_date
																							.getUTCFullYear() != dte
																							.getUTCFullYear()) {
																						from_date = Highcharts
																								.dateFormat(
																										'%e.%b.%Y',
																										Date
																												.UTC(
																														dte
																																.getUTCFullYear(),
																														dte
																																.getUTCMonth(),
																														dte
																																.getUTCDate()));
																					} else {
																						from_date = Highcharts
																								.dateFormat(
																										'%e.%b',
																										Date
																												.UTC(
																														dte
																																.getUTCFullYear(),
																														dte
																																.getUTCMonth(),
																														dte
																																.getUTCDate()));
																					}
																					if (current_date
																							.getUTCFullYear() != next_dte
																							.getUTCFullYear()) {
																						to_date = Highcharts
																								.dateFormat(
																										'%e.%b.%Y',
																										Date
																												.UTC(
																														next_dte
																																.getUTCFullYear(),
																														next_dte
																																.getUTCMonth(),
																														next_dte
																																.getUTCDate() - 1));
																					} else {
																						to_date = Highcharts
																								.dateFormat(
																										'%e.%b',
																										Date
																												.UTC(
																														next_dte
																																.getUTCFullYear(),
																														next_dte
																																.getUTCMonth(),
																														next_dte
																																.getUTCDate() - 1));
																					}
																					categories
																							.push(from_date
																									+ ' - '
																									+ to_date);
																				}
																			} else {
																				var current_date = new Date();
																				var from_date = '';
																				var to_date = '';
																				var end_date = new Date();
																				if (current_date
																						.getUTCFullYear() != dte
																						.getUTCFullYear()) {
																					from_date = Highcharts
																							.dateFormat(
																									'%e.%b.%Y',
																									Date
																											.UTC(
																													dte
																															.getUTCFullYear(),
																													dte
																															.getUTCMonth(),
																													dte
																															.getUTCDate()));
																					to_date = Highcharts
																							.dateFormat(
																									'%e.%b.%Y',
																									Date
																											.UTC(
																													end_date
																															.getFullYear(),
																													end_date
																															.getMonth(),
																													end_date
																															.getDate()));
																				} else {
																					from_date = Highcharts
																							.dateFormat(
																									'%e.%b',
																									Date
																											.UTC(
																													dte
																															.getUTCFullYear(),
																													dte
																															.getUTCMonth(),
																													dte
																															.getUTCDate()));
																					to_date = Highcharts
																							.dateFormat(
																									'%e.%b',
																									Date
																											.UTC(
																													end_date
																															.getFullYear(),
																													end_date
																															.getMonth(),
																													end_date
																															.getDate()));
																				}
																				categories
																						.push(from_date
																								+ ' - '
																								+ to_date);
																			}
																		}
																		cnt++;
																	}
																});
											});

							portlet_graph_utility.portletGrowthGraph(selector,
									series, base_model, categories,
									min_tick_interval);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},

	/**
	 * To fetch deals assigned portlet data to render as bar graph
	 */
	dealsAssignedGraphData : function(base_model, selector, url) {
		var domainUsersList = [];
		var dealsAssignedCountList = [];
		$('#' + selector).html(getRandomLoadingImg());
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 403) {
								$('#' + selector)
										.html(
												"<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
								return;
							}
							domainUsersList = data["domainUsersList"];
							dealsAssignedCountList = data["assignedOpportunitiesCountList"];

							portlet_graph_utility.dealsAssignedBarGraph(
									selector, domainUsersList,
									dealsAssignedCountList);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},

	/**
	 * To fetch calls per person portlet data to render as bar graph
	 */
	callsPerPersonGraphData : function(base_model, selector, url) {
		var answeredCallsCountList = [];
		var busyCallsCountList = [];
		var failedCallsCountList = [];
		var voiceMailCallsCountList = [];
		var callsDurationList = [];
		var totalCallsCountList = [];
		var domainUsersList = [];
		var domainUserImgList = [];
		var sizey = parseInt($('#' + selector).parent().attr("data-sizey"));
		var topPos = 50 * sizey;
		if (sizey == 2 || sizey == 3)
			topPos += 50;
		$('#' + selector)
				.html(
						"<div class='text-center v-middle opa-half' style='margin-top:"
								+ topPos
								+ "px'><img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 403) {
								$('#' + selector)
										.html(
												"<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
								return;
							}
							answeredCallsCountList = data["answeredCallsCountList"];
							busyCallsCountList = data["busyCallsCountList"];
							failedCallsCountList = data["failedCallsCountList"];
							voiceMailCallsCountList = data["voiceMailCallsCountList"];
							callsDurationList = data["callsDurationList"];
							totalCallsCountList = data["totalCallsCountList"];
							domainUsersList = data["domainUsersList"];
							domainUserImgList = data["domainUserImgList"];

							var series = [];
							var text = '';
							var colors;

							if (base_model.get('settings')["group-by"] == "number-of-calls") {
								var tempData = {};
								tempData.name = "Answered";
								tempData.data = answeredCallsCountList;
								series[0] = tempData;

								tempData = {};
								tempData.name = "Busy";
								tempData.data = busyCallsCountList;
								series[1] = tempData;

								tempData = {};
								tempData.name = "Failed";
								tempData.data = failedCallsCountList;
								series[2] = tempData;

								tempData = {};
								tempData.name = "Voicemail";
								tempData.data = voiceMailCallsCountList;
								series[3] = tempData;
								text = "No. of Calls";
								colors = [ 'green', 'blue', 'red', 'violet' ];
							} else {
								var tempData = {};
								tempData.name = "Total Duration";
								var callsDurationInMinsList = [];
								$
										.each(
												callsDurationList,
												function(index, duration) {
													callsDurationInMinsList[index] = duration / 60;
												});
								tempData.data = callsDurationInMinsList;
								series[0] = tempData;
								text = "Calls Duration (Mins)";
								colors = [ 'green' ];
							}

							portlet_graph_utility.callsPerPersonBarGraph(
									selector, domainUsersList, series,
									totalCallsCountList, callsDurationList,
									text, colors, domainUserImgList);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},

	/**
	 * To fetch task report portlet data to render as bar graph
	 */
	taskReportGraphData : function(base_model, selector, url) {
		var groupByList = [];
		var splitByList = [];
		var splitByNamesList = [];
		var domainUserNamesList = [];
		var sizey = parseInt($('#' + selector).parent().attr("data-sizey"));
		var topPos = 50 * sizey;
		if (sizey == 2 || sizey == 3)
			topPos += 50;
		$('#' + selector)
				.html(
						"<div class='text-center v-middle opa-half' style='margin-top:"
								+ topPos
								+ "px'><img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 403) {
								$('#' + selector)
										.html(
												"<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
								return;
							}
							groupByList = data["groupByList"];
							splitByList = data["splitByList"];
							domainUserNamesList = data["domainUserNamesList"];
							var series = [];
							var text = '';
							var colors;

							$.each(splitByList, function(index, splitByData) {
								if (splitByNamesList.length == 0)
									$.each(splitByData, function(key, value) {
										splitByNamesList.push(portlet_utility
												.getPortletNormalName(key));
									});
							});
							for ( var i = 0; i < splitByNamesList.length; i++) {
								var tempData = {};
								var splitByDataList = [];
								$
										.each(
												splitByList,
												function(index, splitByData) {
													$
															.each(
																	splitByData,
																	function(
																			key,
																			value) {
																		if (portlet_utility
																				.getPortletNormalName(key) == splitByNamesList[i])
																			splitByDataList
																					.push(value);
																	});
												});
								tempData.name = splitByNamesList[i];
								tempData.data = splitByDataList;
								series[i] = tempData;
							}
							text = "Task Report";

							var groupByNamesList = [];

							$.each(groupByList, function(index, name) {
								groupByNamesList[index] = portlet_utility
										.getPortletNormalName(name);
							});

							portlet_graph_utility.taskReportBarGraph(selector,
									groupByNamesList, series, text, base_model,
									domainUserNamesList);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},

	/**
	 * To fetch revenue graph portlet data to render as area spline graph
	 */
	revenueGraphData : function(base_model, selector, url) {
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 406) {
								// Show cause of error in saving
								$save_info = $('<div class="portlet-error-message inline-block"><small><p class="text-base" style="color:#B94A48;"><i>'
										+ data.responseText
										+ '</i></p></small></div>');

								$('#' + selector).html($save_info).show();

								return;
							}
							var sortedKeys = [];
							var categories = [];
							$.each(data, function(k, v) {
								sortedKeys.push(k);
							});
							sortedKeys.sort();
							var sortedData = {};
							$.each(sortedKeys, function(index, value) {
								sortedData['' + value] = data['' + value];
							});
							var series;
							// Iterates through data and adds keys into
							// categories
							$.each(sortedData, function(k, v) {
								// Initializes series with names with the first
								// data point
								if (series == undefined) {
									var index = 0;
									series = [];
									$.each(v, function(k1, v1) {
										var series_data = {};
										series_data.name = k1;
										series_data.data = [];
										series[index++] = series_data;
									});
								}
								// Fill Data Values with series data
								$.each(v, function(k1, v1) {
									// Find series with the name k1 and to that,
									// push v1
									var series_data = find_series_with_name(
											series, k1);
									series_data.data.push(v1);
								});
								var dt = new Date(k * 1000);
								categories.push(Date.UTC(dt.getFullYear(), dt
										.getMonth(), dt.getDate()));

							});

							portlet_graph_utility.portletDealRevenueGraph(
									selector, series, base_model, categories);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},

	/**
	 * To fetch emails opened portlet data to render as pie graph
	 */
	emailsOpenedGraphData : function(base_model, selector, url) {
		var emailsSentCount = 0;
		var emailsOpenedCount = 0;
		var sizey = parseInt($('#' + selector).parent().attr("data-sizey"));
		var topPos = 50 * sizey;
		$('#' + selector)
				.html(
						"<div class='text-center v-middle opa-half' style='margin-top:"
								+ topPos
								+ "px'><img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");
		this
				.fetchPortletsGraphData(
						url,
						function(data) {
							if (data.status == 403) {
								$('#' + selector)
										.html(
												"<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
								return;
							}
							emailsSentCount = data["emailsSentCount"];
							emailsOpenedCount = data["emailsOpenedCount"];

							var series = [];
							series.push([ "Emails Sent",
									emailsSentCount - emailsOpenedCount ]);
							series.push([ "Emails Opened", emailsOpenedCount ]);

							portlet_graph_utility.emailsOpenedPieChart(
									selector, series, emailsSentCount,
									emailsOpenedCount);

							portlet_utility.addWidgetToGridster(base_model);
						});
	},
};var portlet_graph_utility = {

	/**
	 * To display deals by milestone portlet as pie graph
	 */
	dealsByMilestonePieGraph : function(selector, milestonesList,
			milestoneValuesList, milestoneNumbersList) {
		head
				.js(
						LIB_PATH + 'lib/flot/highcharts-3.js',
						LIB_PATH + 'lib/flot/no-data-to-display.js',
						function() {
							var emptyFlag = true;
							$.each(milestoneValuesList, function(index, value) {
								if (value > 0)
									emptyFlag = false;
							});
							if (milestonesList.length == 0 || emptyFlag) {
								$('#' + selector)
										.html(
												'<div class="portlet-error-message">No deals found</div>');
							} else {
								var data = [];
								$.each(milestonesList, function(index, value) {
									data.push([ value,
											milestoneValuesList[index] ]);
								});
								$('#' + selector)
										.highcharts(
												{
													chart : {
														type : 'pie',
														marginRight : 20
													},
													colors : [ '#7266ba',
															'#23b7e5',
															'#fad733',
															'#27c24c',
															'#f05050',
															"#aaeeee",
															"#ff0066",
															"#eeaaee",
															"#55BF3B",
															"#DF5353",
															"#7798BF",
															"#aaeeee" ],
													title : {
														text : ''
													},
													tooltip : {
														formatter : function() {
															return '<table>'
																	+ '<tr><td class="p-n">'
																	+ this.series.name
																	+ 's: </td>'
																	+ '<td class="p-n"><b>'
																	+ milestoneNumbersList[this.point.x]
																	+ '</b></td></tr>'
																	+ '<tr><td class="p-n">Total Value: </td>'
																	+ '<td class="p-n"><b>'
																	+ portlet_utility
																			.getPortletsCurrencySymbol()
																	+ ''
																	+ milestoneValuesList[this.point.x]
																			.toLocaleString()
																	+ '</b></td></tr>'
																	+ '</table>';
														},
														shared : true,
														useHTML : true,
														borderWidth : 1,
														backgroundColor : '#313030',
														shadow : false,
														borderColor : '#000',
														borderRadius : 3,
														style : {
															color : '#EFEFEF'
														}
													},
													plotOptions : {
														series : {
															borderWidth : 0
														},
														pie : {
															borderWidth : 0,
															innerSize : '50%',
															dataLabels : {
																enabled : true,
																useHTML : true,
																/*
																 * connectorWidth:
																 * 0,
																 */
																softConnector : true,
																formatter : function() {
																	return '<div class="text-center"><span style="color:'
																			+ this.point.color
																			+ '"><b>'
																			+ this.point.name
																			+ '</b></span><br/>'
																			+ '<span style="color:'
																			+ this.point.color
																			+ '"><b>'
																			+ Math
																					.round(this.point.percentage)
																			+ '%</b></span></div>';
																},
																/*
																 * format: '<b>{point.name}</b>:
																 * {point.percentage:.1f}',
																 */
																distance : 30,
																x : 2,
																y : -10
															},
															showInLegend : false
														}
													},
													series : [ {
														name : 'Deal',
														data : data
													} ],
													exporting : {
														enabled : false
													}
												});
							}
						});
	},

	/**
	 * To display closers per person portlet as bar graph
	 */
	closuresPerPersonBarGraph : function(selector, catges, data, text, name) {
		head.js(LIB_PATH + 'lib/flot/highcharts-3.js', function() {
			$('#' + selector).highcharts(
					{
						chart : {
							type : 'bar',
							marginRight : 20
						},
						title : {
							text : ''
						},
						xAxis : {
							categories : catges
						},
						yAxis : {
							min : 0,
							title : {
								text : text
							},
							allowDecimals : false
						},
						legend : {
							enabled : false
						},
						tooltip : {
							formatter : function() {
								return '<span class="text-xxs">'
										+ this.points[0].key + '</span>'
										+ '<table>'
										+ '<tr><td class="p-n" style="color:'
										+ this.points[0].series.color + ';">'
										+ this.points[0].series.name
										+ ': </td>' + '<td class="p-n"><b>'
										+ data[this.points[0].point.x]
										+ '</b></td></tr>' + '</table>';
							},
							shared : true,
							useHTML : true
						},
						plotOptions : {
							column : {
								pointPadding : 0.2,
								borderWidth : 0
							}
						},
						series : [ {
							name : name,
							data : data
						} ],
						exporting : {
							enabled : false
						}
					});
		});
	},

	/**
	 * To display deals funnel portlet as funnel graph
	 */
	dealsFunnelGraph : function(selector, funnel_data) {
		head
				.js(
						LIB_PATH + 'lib/flot/highcharts-3.js',
						LIB_PATH + 'lib/flot/funnel.js',
						LIB_PATH + 'lib/flot/no-data-to-display.js',
						function() {
							if (funnel_data == undefined
									|| (funnel_data != undefined && funnel_data.length == 0)) {
								$('#' + selector)
										.html(
												'<div class="portlet-error-message">No deals found</div>');
								return;
							}
							$('#' + selector)
									.highcharts(
											{
												chart : {
													type : 'funnel',
													marginRight : 20,
													className : 'deals-funnel-portlet'
												},
												colors : [ "#23b7e5",
														"#27c24c", "#7266ba",
														"#fad733", "#f05050",
														"#aaeeee", "#ff0066",
														"#eeaaee", "#55BF3B",
														"#DF5353" ],
												title : {
													text : ''
												},
												plotOptions : {
													series : {
														dataLabels : {
															enabled : true,
															useHTML : true,
															format : '<div class="text-center"><span style="color:{point.color}"><b>{point.name}</b></span><br/>'
																	+ '<span style="color:{point.color}">('
																	+ portlet_utility
																			.getPortletsCurrencySymbol()
																	+ '{point.y:,.0f})</span></div>',
															softConnector : true
														},
														neckWidth : '20%',
														neckHeight : '20%',

														// -- Other available
														// options
														height : '100%',
														width : '50%',
														borderWidth : 1,
														borderColor : 'white'
													}
												},
												tooltip : {
													pointFormat : '<span>{series.name}:<b>'
															+ portlet_utility
																	.getPortletsCurrencySymbol()
															+ '{point.y:,.0f}</b></span>',
													shared : true,
													useHTML : true,
													borderWidth : 1,
													backgroundColor : '#313030',
													shadow : false,
													borderColor : '#000',
													borderRadius : 3,
													style : {
														color : '#EFEFEF'
													}
												},
												series : [ {
													name : 'Value',
													data : funnel_data
												} ],
												exporting : {
													enabled : false
												}
											});
						});
	},

	/**
	 * To display emails sent portlet as bar graph
	 */
	emailsSentBarGraph : function(selector, domainUsersList, series,
			mailsCountList, mailsOpenedCountList, text, colors) {
		head
				.js(
						LIB_PATH + 'lib/flot/highcharts-3.js',
						function() {
							$('#' + selector)
									.highcharts(
											{
												chart : {
													type : 'bar',
													marginRight : 20
												},
												title : {
													text : ''
												},
												xAxis : {
													categories : domainUsersList
												},
												yAxis : {
													min : 0,
													title : {
														text : text
													},
													allowDecimals : false
												},
												tooltip : {
													formatter : function() {
														return '<table>'
																+ '<tr><td class="p-n" style="color:'
																+ this.points[0].series.color
																+ ';">'
																+ this.points[0].series.name
																+ ': </td>'
																+ '<td class="p-n"><b>'
																+ mailsCountList[this.points[0].point.x]
																+ '</b></td></tr>'
																+ '<tr><td class="p-n" style="color:'
																+ this.points[1].series.color
																+ ';">'
																+ this.points[1].series.name
																+ ': </td>'
																+ '<td class="p-n"><b>'
																+ mailsOpenedCountList[this.points[1].point.x]
																+ '</b></td></tr>'
																+ '</table>';
													},
													shared : true,
													useHTML : true
												},
												plotOptions : {
													series : {
														stacking : 'normal'
													},
													column : {
														pointPadding : 0.2,
														borderWidth : 0
													}
												},
												series : series,
												exporting : {
													enabled : false
												},
												colors : colors
											});
						});
	},

	/**
	 * To display growth graph portlet as area spline graph
	 */
	portletGrowthGraph : function(selector, series, base_model, categories,
			min_tick_interval) {
		var flag = true;
		if (base_model.get("settings").tags == "") {
			$('#' + selector)
					.html(
							"<div class='portlet-error-message'>Please <a href='#' id='"
									+ base_model.get("id")
									+ "-settings' class='portlet-settings text-info' dada-toggle='modal'>configure</a> the dashlet and add the Tags.</div>");
			flag = false;
		}
		if (flag) {
			head.js(LIB_PATH + 'lib/flot/highcharts-3.js', function() {
				$('#' + selector).highcharts(
						{
							chart : {
								type : 'areaspline',
								marginRight : 20,
							// plotBorderWidth: 1,
							// plotBorderColor: '#F4F4F5'
							},
							title : {
								text : ''
							},
							xAxis : {
								categories : categories,
								tickmarkPlacement : 'on',
								minTickInterval : min_tick_interval,
								gridLineWidth : 1,
								gridLineColor : '#F4F4F5',
								labels : {
									style : {
										color : '#98a6ad',
										fontSize : '11px'
									}
								},
								lineWidth : 0,
								tickWidth : 0
							},
							yAxis : {
								min : 0,
								title : {
									text : ''
								},
								gridLineWidth : 1,
								gridLineColor : '#F4F4F5',
								labels : {
									style : {
										color : '#98a6ad',
										fontSize : '11px'
									}
								}
							},
							plotOptions : {
								series : {
									borderWidth : 2,
									borderColor : '#23b7e5',
									marker : {
										symbol : 'circle'
									}
								},
								areaspline : {
									marker : {
										lineWidth : 1,
										lineColor : null, // inherit from
										// series
										radius : 2
									}
								}
							},
							series : series,
							exporting : {
								enabled : false
							},
							tooltip : {
								borderWidth : 1,
								backgroundColor : '#313030',
								shadow : false,
								borderColor : '#000',
								borderRadius : 3,
								style : {
									color : '#EFEFEF'
								}
							},
							legend : {
								itemStyle : {
									fontSize : '10px',
									color : '#98a6ad'
								},
								borderWidth : 0,
								layout : 'vertical',
								floating : true,
								align : 'right',
								verticalAlign : 'top'
							},
							colors : [ "#23b7e5", "#27c24c", "#7266ba",
									"#fad733", "#f05050", "#aaeeee", "#ff0066",
									"#eeaaee", "#55BF3B", "#DF5353" ],
						});
			});
		}
	},

	/**
	 * To display deals assigned portlet as bar graph
	 */
	dealsAssignedBarGraph : function(selector, catges, dealsCountList) {
		head
				.js(
						LIB_PATH + 'lib/flot/highcharts-3.js',
						function() {
							$('#' + selector)
									.highcharts(
											{
												chart : {
													type : 'bar',
													marginRight : 20
												},
												title : {
													text : ''
												},
												xAxis : {
													categories : catges
												},
												yAxis : {
													min : 0,
													title : {
														text : 'No. of deals assigned'
													},
													allowDecimals : false
												},
												legend : {
													enabled : false
												},
												tooltip : {
													formatter : function() {
														return '<span class="text-xxs">'
																+ this.points[0].key
																+ '</span>'
																+ '<table>'
																+ '<tr><td class="p-n" style="color:'
																+ this.points[0].series.color
																+ ';">'
																+ this.points[0].series.name
																+ ': </td>'
																+ '<td class="p-n"><b>'
																+ dealsCountList[this.points[0].point.x]
																+ '</b></td></tr>'
																+ '</table>';
													},
													shared : true,
													useHTML : true
												},
												plotOptions : {
													column : {
														pointPadding : 0.2,
														borderWidth : 0
													}
												},
												series : [ {
													name : 'Assigned Deals',
													data : dealsCountList
												} ],
												exporting : {
													enabled : false
												}
											});
						});
	},

	/**
	 * To display calls per person portlet as bar graph
	 */
	callsPerPersonBarGraph : function(selector, domainUsersList, series,
			totalCallsCountList, callsDurationList, text, colors,
			domainUserImgList) {
		head
				.js(
						LIB_PATH + 'lib/flot/highcharts-3.js',
						function() {
							
							$('#'+selector).highcharts({
								chart: {
						            type: 'bar',
						            marginRight: 100,
						            plotBorderWidth: 1,
						            plotBorderColor: '#F4F4F5'
						        },
						        title: {
						            text: ''
						        },
						        xAxis: {
						            categories: domainUserImgList,
						            labels: {
						                formatter: function() {
						                	var userIndex=0;
						                	for(var i=0;i<domainUserImgList.length;i++){
						                		if(this.value==domainUserImgList[i] && domainUserImgList[i].substring(0,8)!="no image")
						                			userIndex=i;
						                		else if(this.value==domainUserImgList[i] && domainUserImgList[i].substring(0,8)=="no image")
							                			userIndex=parseInt(domainUserImgList[i].substring(9,10));
						                	}
						                	if(this.value!=undefined && this.value!="" && this.value.substring(0,8)!="no image")
						                		return '<img src="'+this.value+'" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'+domainUsersList[userIndex]+'"/>';
						                	else
						                		return '<img src="'+gravatarImgForPortlets(25)+'" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'+domainUsersList[userIndex]+'"/>';
						                },
						                style : {
						    				color : '#98a6ad',
						    				fontSize : '11px'
						    			},
						                useHTML: true
						            },
						            gridLineWidth : 0,
						    		gridLineColor : '#F4F4F5',
						    		lineWidth : 0,
						    		tickWidth : 0
						        },
						        yAxis: {
						            min: 0,
						            title: {
						                text: text
						            },
						            allowDecimals: false,
						            gridLineWidth : 1,
						    		gridLineColor : '#F4F4F5',
						    		labels : {
						    			style : {
						    				color : '#98a6ad',
						    				fontSize : '11px'
						    			}
						    		}
						        },
						        tooltip: {
						        	formatter: function(){
						        		var tt = '';
						        		if(text=="Calls Duration (Mins)")
						        			tt = '<table>' + 
					        		              '<tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+':&nbsp; </td>' +
					        		              '<td style="padding:0"><b>'+portlet_utility.getPortletsTimeConversion(callsDurationList[this.points[0].point.x])+'</b></td></tr>' +
					        		              '<tr><td style="color:'+this.points[0].series.color+';padding:0">Calls:&nbsp; </td>' + 
					        		        	  '<td style="padding:0"><b>'+totalCallsCountList[this.points[0].point.x]+'</b></td></tr>' +
					        		        	  '</table>';
						        		else if(text=="Average Call Duration (Mins)"){
						        			
						        			tt += '<table>';
						        			if(this.points[0]!=undefined && this.points[0].series!=undefined){
						        				tt += 	'<tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+':&nbsp; </td>' +
							                      		'<td style="padding:0"><b>'+portlet_utility.getPortletsTimeConversion(Math.round(this.points[0].point.y))+'</b></td></tr>';
						        			}
						        			tt += '</table>';
						        			
						        		}else{
						        			tt += '<table>';
						        			if(this.points[0]!=undefined && this.points[0].series!=undefined){
						        				tt += 	'<tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+':&nbsp; </td>' +
							                      		'<td style="padding:0"><b>'+this.points[0].point.y+'</b></td></tr>';
						        			}
						        			if(this.points[1]!=undefined && this.points[1].series!=undefined){
						        				tt += 	'<tr><td style="color:'+this.points[1].series.color+';padding:0">'+this.points[1].series.name+':&nbsp; </td>' +
							                      		'<td style="padding:0"><b>'+this.points[1].point.y+'</b></td></tr>';
						        			}
						        			if(this.points[2]!=undefined && this.points[2].series!=undefined){
						        				tt += 	'<tr><td style="color:'+this.points[2].series.color+';padding:0">'+this.points[2].series.name+':&nbsp; </td>' +
							                      		'<td style="padding:0"><b>'+this.points[2].point.y+'</b></td></tr>';
						        			}
						        			if(this.points[3]!=undefined && this.points[3].series!=undefined){
						        				tt += 	'<tr><td style="color:'+this.points[3].series.color+';padding:0">'+this.points[3].series.name+':&nbsp; </td>' +
							                      		'<td style="padding:0"><b>'+this.points[3].point.y+'</b></td></tr>';
						        			}
						        			tt += '</table>';
						        		}
						        		return tt;
						        	},
						            shared: true,
						            useHTML: true,
						            borderWidth : 1,
						    		backgroundColor : '#313030',
						    		shadow : false,
						    		borderColor: '#000',
						    		borderRadius : 3,
						    		style : {
						    			color : '#EFEFEF'
						    		}
						        },
						        plotOptions: {
						        	series: {
						        		pointWidth: 10,
						                stacking: 'normal',
						                borderWidth : 0
						            },
						            column: {
						                pointPadding: 0.2,
						                borderWidth: 0
						            },
						            bar : {
						    			shadow : false
						    		}
						        },
						        series: series,
						        exporting: {
							        enabled: false
							    },
							    colors : [ "#27c24c", "#23b7e5", "#f05050", "#7266ba", "#fad733","#aaeeee", "#ff0066", "#eeaaee", "#55BF3B", "#DF5353" ],
							    legend : {
									itemStyle : {
										fontSize : '10px',
										color : '#98a6ad'
									},
									borderWidth : 0,
									layout : 'vertical',
									floating : true,
									align : 'right',
									verticalAlign : 'top'
								}
						    });
							
						});
	},
	
	
	/**
	 * To plot calls per person data  as a pie graph
	 */
	callsByPersonPieGraph :function(selector,categoryList,valueList){

	head.js(LIB_PATH + 'lib/flot/highcharts-3.js',LIB_PATH + 'lib/flot/no-data-to-display.js', function(){
		var emptyFlag = true;
		$.each(valueList,function(index,value){
			if(value>0)
				emptyFlag = false;
		});
		if(categoryList.length==0 || emptyFlag){
			
			$('#'+selector).html('<div class="portlet-error-message">No Calls Found</div>');
		}else{
			var data = [];
			$.each(categoryList,function(index,value){
				data.push([value,valueList[index]]);
			});
			$('#'+selector).highcharts({
		        chart: {
		            type: 'pie',
		            marginRight: 20
		        },
		        colors : ['#7266ba','#23b7e5','#fad733','#27c24c','#f05050',"#aaeeee", "#ff0066", "#eeaaee", "#55BF3B", "#DF5353", "#7798BF","#aaeeee"],
		        title: {
		            text: ''
		        },
		        tooltip: {
		        	formatter: function(){
		        		return '<table>' + 
		        		        '<tr><td class="p-n">Total '+categoryList[this.point.x]+':&nbsp; </td>' + 
		        		        '<td class="p-n"><b>'+ valueList[this.point.x]+'</b></td></tr>' +
		        		        '</table>';
		        	},
		            shared: true,
		            useHTML: true,
		            borderWidth : 1,
		    		backgroundColor : '#313030',
		    		shadow : false,
		    		borderColor: '#000',
		    		borderRadius : 3,
		    		style : {
		    			color : '#EFEFEF'
		    		}
		        },
		        plotOptions: {
		        	series: {
		                borderWidth : 0
		            },
		            pie: {
		            	borderWidth: 0,
		            	innerSize : '50%',
		            	dataLabels: {
		            		enabled: true,
		            		useHTML: true,
		            		/*connectorWidth: 0,*/
		            		softConnector: true,
		    	            formatter: function () {
		    	            	return 	'<div class="text-center"><span style="color:'+this.point.color+'"><b>'+this.point.name+'</b></span><br/>' +
		    	            			'<span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage)+'%</b></span></div>';
		    	            },
		            		/*format: '<b>{point.name}</b>: {point.percentage:.1f}',*/
		                    distance: 30,
		                    x: 2,
		                    y: -10
		                },
		                showInLegend: false
		            }
		        },
		        series: [{
		            name: "",
		            data: data
		        }],
		        exporting: {
			        enabled: false
			    }
		    });
		}
	});
	},
	

	/**
	 * To display task report portlet as bar graph
	 */
	taskReportBarGraph : function(selector, groupByList, series, text,
			base_model, domainUserNamesList) {
		head
				.js(
						LIB_PATH + 'lib/flot/highcharts-3.js',
						function() {
							$('#' + selector)
									.highcharts(
											{
												colors : [ "#23b7e5",
														"#27c24c", "#7266ba",
														"#fad733", "#f05050",
														"#aaeeee", "#ff0066",
														"#eeaaee", "#55BF3B",
														"#DF5353" ],
												chart : {
													type : 'bar',
													marginRight : 20
												},
												title : {
													text : ''
												},
												xAxis : {
													categories : groupByList,
													labels : {
														formatter : function() {
															if (base_model
																	.get('settings')["group-by"] == "user") {
																var userIndex = 0;
																for ( var i = 0; i < groupByList.length; i++) {
																	if (this.value == groupByList[i]
																			&& groupByList[i]
																					.substring(
																							0,
																							8) != "no image")
																		userIndex = i;
																	else if (this.value == groupByList[i]
																			&& groupByList[i]
																					.substring(
																							0,
																							8) == "no image")
																		userIndex = parseInt(groupByList[i]
																				.substring(
																						9,
																						10));
																}
																if (this.value != undefined
																		&& this.value != ""
																		&& this.value
																				.substring(
																						0,
																						8) != "no image")
																	return '<img src="'
																			+ this.value
																			+ '" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'
																			+ domainUserNamesList[userIndex]
																			+ '"/>';
																else
																	return '<img src="'
																			+ gravatarImgForPortlets(25)
																			+ '" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'
																			+ domainUserNamesList[userIndex]
																			+ '"/>';
															} else {
																if (this.value.length > 12) {
																	return this.value
																			.slice(
																					0,
																					12)
																			+ '...';
																} else {
																	return this.value;
																}
															}
														},
														style : {
															color : '#98a6ad',
															fontSize : '11px'
														},
														useHTML : true
													},
													gridLineWidth : 1,
													gridLineColor : '#F4F4F5',
													lineWidth : 0,
													tickWidth : 0
												},
												yAxis : {
													min : 0,
													title : {
														text : ''
													},
													allowDecimals : false,
													gridLineWidth : 1,
													gridLineColor : '#F4F4F5',
													labels : {
														style : {
															color : '#98a6ad',
															fontSize : '11px'
														}
													}
												},
												plotOptions : {
													series : {
														stacking : 'normal',
														borderWidth : 0
													},
													column : {
														pointPadding : 0.2,
														borderWidth : 0
													},
													bar : {
														shadow : false
													}
												},
												series : series,
												exporting : {
													enabled : false
												},
												tooltip : {
													borderWidth : 1,
													backgroundColor : '#313030',
													shadow : false,
													borderColor : '#000',
													borderRadius : 3,
													style : {
														color : '#EFEFEF'
													},
													formatter : function() {
														if (base_model
																.get('settings')["group-by"] == "user") {
															var userIndex = 0;
															for ( var i = 0; i < groupByList.length; i++) {
																if (this.key == groupByList[i])
																	userIndex = i;
															}
															return '<div>'
																	+ '<div class="p-n" style="color:'
																	+ this.series.color
																	+ ';">'
																	+ domainUserNamesList[userIndex]
																	+ ' </div>'
																	+ '<div class="p-n" style="color:'
																	+ this.series.color
																	+ ';">'
																	+ this.series.name
																	+ ':'
																	+ this.y
																	+ ' </div>'
																	+ '</div>';
														} else
															return '<div>'
																	+ '<div class="p-n" style="color:'
																	+ this.series.color
																	+ ';">'
																	+ this.x
																	+ ' </div>'
																	+ '<div class="p-n" style="color:'
																	+ this.series.color
																	+ ';">'
																	+ this.series.name
																	+ ':'
																	+ this.y
																	+ ' </div>'
																	+ '</div>';
													},
													useHTML : true
												},
												legend : {
													itemStyle : {
														fontSize : '10px',
														color : '#98a6ad'
													},
													borderWidth : 0,
													layout : 'vertical',
													floating : true,
													align : 'right',
													verticalAlign : 'top',
													labelFormatter : function() {
														if (this.name.length > 12) {
															return this.name
																	.slice(0,
																			12)
																	+ '...';
														} else {
															return this.name;
														}
													}
												}
											});
						});
	},

	/**
	 * To display revenue graph portlet as area spline graph
	 */
	portletDealRevenueGraph : function(selector, series, base_model, categories) {
		head
				.js(
						LIB_PATH + 'lib/flot/highcharts-3.js',
						function() {
							if (series == undefined && categories != undefined
									&& categories.length == 0) {
								$('#' + selector)
										.html(
												'<div class="portlet-error-message">No deals found</div>');
								return;
							}
							$('#' + selector)
									.highcharts(
											{
												chart : {
													type : 'areaspline',
													marginRight : 20
												},
												title : {
													text : ''
												},
												xAxis : {
													categories : categories,
													gridLineWidth : 1,
													gridLineColor : '#F4F4F5',
													labels : {
														style : {
															color : '#98a6ad',
															fontSize : '11px'
														},
														formatter : function() {
															return Highcharts
																	.dateFormat(
																			'%b',
																			this.value);
														},
													},
													lineWidth : 0,
													tickWidth : 0,
													tickmarkPlacement : 'on'
												},
												yAxis : {
													min : 0,
													title : {
														text : ''
													},
													gridLineWidth : 1,
													gridLineColor : '#F4F4F5',
													labels : {
														style : {
															color : '#98a6ad',
															fontSize : '11px'
														}
													}
												},
												plotOptions : {
													series : {
														borderWidth : 2,
														borderColor : '#23b7e5',
														marker : {
															symbol : 'circle'
														}
													},
													areaspline : {
														marker : {
															lineWidth : 1,
															lineColor : null, // inherit
															// from
															// series
															radius : 2
														}
													}
												},
												series : series,
												exporting : {
													enabled : false
												},
												tooltip : {
													borderWidth : 1,
													backgroundColor : '#313030',
													shadow : false,
													borderColor : '#000',
													borderRadius : 3,
													style : {
														color : '#EFEFEF'
													},
													formatter : function() {
														return '<div>'
																+ '<div class="p-n">'
																+ Highcharts
																		.dateFormat(
																				'%b',
																				this.x)
																+ '</div>'
																+ '<div class="p-n"><font color='
																+ this.series.color
																+ '>'
																+ this.series.name
																+ '</font> : '
																+ portlet_utility
																		.getPortletsCurrencySymbol()
																+ ''
																+ portlet_utility
																		.getNumberWithCommasForPortlets(this.y)
																+ '</div>'
																+ '</div>';
													},
													useHTML : true
												},
												legend : {
													itemStyle : {
														fontSize : '10px',
														color : '#98a6ad'
													},
													borderWidth : 0,
													layout : 'vertical',
													floating : true,
													align : 'right',
													verticalAlign : 'top'
												},
												colors : [ "#23b7e5",
														"#27c24c", "#7266ba",
														"#fad733", "#f05050",
														"#aaeeee", "#ff0066",
														"#eeaaee", "#55BF3B",
														"#DF5353" ],
											});
						});
	},

	/**
	 * To display emails opened portlet as pie graph
	 */
	emailsOpenedPieChart : function(selector, data, emailsSentCount,
			emailsOpenedCount) {
		head
				.js(
						LIB_PATH + 'lib/flot/highcharts-3.js',
						LIB_PATH + 'lib/flot/no-data-to-display.js',
						function() {
							if (emailsSentCount == 0 && emailsOpenedCount == 0) {
								$('#' + selector)
										.html(
												'<div class="portlet-error-message">No email activity</div>');
								return;
							}

							$('#' + selector)
									.highcharts(
											{
												chart : {
													type : 'pie',
													marginLeft : -150,
													height : 150
												},
												colors : [ '#e8eff0', '#27C24C' ],
												title : {
													text : ''
												},
												tooltip : {
													enabled : false
												},
												legend : {
													layout : 'vertical',
													align : 'right',
													verticalAlign : 'top',
													x : -20,
													y : 40,
													labelFormatter : function() {
														if (this.name == "Emails Opened")
															return '<div><span>Opened:'
																	+ emailsOpenedCount
																	+ '</span></div>';
														else if (this.name == "Emails Sent")
															return '<div><span>Sent:'
																	+ emailsSentCount
																	+ '</span></div>';

													},
													itemStyle : {
														color : "#ccc",
														cursor : '',
														fontSize : "12px",
														fontWeight : "bold"
													},
													borderWidth : 0,
													floating : true,
												},
												plotOptions : {
													series : {
														borderWidth : 0,
														states : {
															hover : {
																enabled : false
															}
														}
													},
													pie : {
														borderWidth : 0,
														innerSize : 95,
														dataLabels : {
															enabled : true,
															useHTML : true,
															connectorWidth : 0,
															formatter : function() {
																var ff = '';
																if (this.point.name == "Emails Opened")
																	ff = '<div class="text-center"><span style="color:'
																			+ this.point.color
																			+ '"><b>'
																			+ Math
																					.round(
																							this.point.percentage)
																					.toString()
																			+ '%</b></span></div>';
																return ff;
															},
															/*format: '<b>{point.name}</b>: {point.percentage:.1f}',*/
															distance : -55
														},
														showInLegend : true,
														enableMouseTracking : false,
														point : {
															events : {
																legendItemClick : function() {
																	return false;
																}
															}
														}
													}
												},
												series : [ {
													name : 'Deal',
													data : data
												} ],
												exporting : {
													enabled : false
												}
											});
						});
	},

	/**
	 * To display campaigns stats portlet as pie graph 
	 */
	campstatsPieChart : function() {
		head
				.js(
						LIB_PATH + 'lib/flot/highcharts-3.js',
						LIB_PATH + 'lib/flot/no-data-to-display.js',
						function() {
							var color;
							//var innersize='100%';
							var dis = 0;
							if (data[1][0] == 'Emails Opened')
								color = 'rgb(250, 215, 51)';
							if (data[1][0] == 'Emails Clicked')
								color = 'rgb(18, 209, 18)';
							if (data[1][0] == 'Emails Unsubscribed')
								color = 'rgb(240, 80, 80)';
							$(selector)
									.find('.graph')
									.highcharts(
											{
												chart : {
													type : 'pie',
													labelsEnabled : false,
													autoMargins : false,
													marginTop : 0,
													marginBottom : -6,
													marginLeft : 0,
													marginRight : 0,
													pullOutRadius : 0,
													events : {
														load : function(e) {
															console.log(this);
															this.options.plotOptions.series.dataLabels.distance = ((this.chartHeight + this.chartWidth) / 7.5)
																	* -1;
															this.series[0]
																	.update(this.options);
														},
														redraw : function(e) {
															console.log(this);
															var pos_left, pos_top;
															var chart = this;
															if ($(selector)
																	.parents(
																			'.portlet_body')
																	.height() <= 200) {
																pos_top = chart.chartHeight / 2.72;
															} else if ($(
																	selector)
																	.parents(
																			'.portlet_body')
																	.height() > 200
																	&& $(
																			selector)
																			.parents(
																					'.portlet_body')
																			.height() <= 450) {
																pos_top = chart.chartHeight / 2.16;
															}

															else {
																pos_top = chart.chartHeight / 2.04;
															}
															if ($(selector)
																	.parents(
																			'.portlet_body')
																	.width() <= 405)
																pos_left = chart.chartWidth / 2.00;
															else if ($(selector)
																	.parents(
																			'.portlet_body')
																	.width() > 405
																	&& $(
																			selector)
																			.parents(
																					'.portlet_body')
																			.width() <= 836) {
																pos_left = chart.chartWidth / 2.05;

															}

															else {
																pos_left = chart.chartWidth / 2.00;

															}

															chart.series[0].data[1].dataLabel
																	.attr({
																		x : pos_left,
																		y : pos_top
																	});
														}
													},

												},
												colors : [ '#e8eff0', color ],
												title : {
													text : ''
												},
												tooltip : {
													enabled : false
												},
												legend : {
													enabled : false,

												},
												plotOptions : {
													series : {
														dataLabels : {
															align : 'center',
															enabled : true,
															useHTML : true,
															connectorWidth : 0,
															formatter : function() {
																var ff = '';

																if (this.point.name == "Emails Opened")
																	ff = '<div class="text-center"><span style="color:'
																			+ this.point.color
																			+ '"><b>'
																			+ Math
																					.round(
																							this.point.percentage)
																					.toString()
																			+ '%</b></span></div>';

																if (this.point.name == "Emails Clicked")
																	ff = '<div class="text-center"><span style="color:'
																			+ this.point.color
																			+ '"><b>'
																			+ Math
																					.round(
																							this.point.percentage)
																					.toString()
																			+ '%</b></span></div>';
																if (this.point.name == "Emails Unsubscribed")
																	ff = '<div class="text-center"><span style="color:'
																			+ this.point.color
																			+ '"><b>'
																			+ Math
																					.round(
																							this.point.percentage)
																					.toString()
																			+ '%</b></span></div>';

																return ff;

															},
															/*format: '<b>{point.name}</b>: {point.percentage:.1f}',*/
															distance : 0,
														},
														borderWidth : 0,
														states : {
															hover : {
																enabled : false
															}
														}
													},
													pie : {
														borderWidth : 0,
														size : '100%',
														innerSize : '100%',
													},
													showInLegend : true,
													enableMouseTracking : false,
													point : {
														events : {
															legendItemClick : function() {
																return false;
															}
														}
													}
												},
												series : [ {
													// name: 'Deal',
													data : data
												} ],
												exporting : {
													enabled : false
												}
											});
						});
	},

};
/** Listener function for Event handling* */
function initializePortletsListeners() {

	$('.modal-footer')
			.off("click")
			.on(
					'click',
					'.portlet-settings-save-modal',
					function(e) {
						e.preventDefault();
						var scrollPosition = $(window).scrollTop();
						var form_id = $(this).parent().prev().find(
								'form:visible').attr('id');
						var modal_id = $(this).parent().parent().parent()
								.parent().attr('id');
						if (!isValidForm('#' + form_id))
							return false;
						$(this).attr('disabled', true);
						$(this).text('Saving...');

						var el = this.id;
						var flag = true;
						var json = {};
						var obj = {};
						var portletType = $('#portlet-type', $('#' + modal_id))
								.val();
						var portletName = $('#portlet-name', $('#' + modal_id))
								.val();
						json = serializeForm(form_id);
						if (portletType == "CONTACTS"
								&& portletName == "Growth Graph") {
							var tags = '';
							if ($('#addPortletBulkTags').val() != "") {
								var tag = $('#addPortletBulkTags').val();
								if ($('#portlet-ul-tags > li').length == 0)
									$('#portlet-ul-tags')
											.append(
													"<li data='"
															+ tag
															+ "' class='tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block'>'"
															+ tag
															+ "'<a tag='"
															+ tag
															+ "' id='remove_tag' class='close m-l-xs'>&time</a></li>");
								else
									$('#portlet-ul-tags > li:last')
											.after(
													"<li data='"
															+ tag
															+ "' class='tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block'>'"
															+ tag
															+ "'<a tag='"
															+ tag
															+ "' id='remove_tag' class='close m-l-xs'>&time</a></li>");
							}
							$('#portlet-ul-tags > li').each(function() {
								if ($(this).is(':last'))
									tags += $(this).attr('data');
								else
									tags += $(this).attr('data') + ',';
							});
							json['tags'] = tags;
						}

						if (portletType == "USERACTIVITY"
								&& portletName == "Leaderboard") {
							var tempJson = {};
							var tempJson1 = [];
							$('#category-list', $('#' + el).parent().parent())
									.find('option')
									.each(
											function() {
												if ($(this).is(':selected'))
													tempJson['' + $(this).val()] = true;
												else
													tempJson['' + $(this).val()] = false;
											});
							$('#user-list', $('#' + el).parent().parent())
									.find('option:selected').each(function() {
										tempJson1.push($(this).val());
									});
							json['duration'] = $('#duration',
									$('#' + el).parent().parent()).val();
							json['category'] = tempJson;
							json['user'] = tempJson1;
						}

						var idVal = $(
								'#'
										+ $(this).attr('id').split(
												"-save-modal")[0]).parent()
								.find('.portlet_body').attr('id');
						var portlet = Portlets_View.collection.get(el
								.split("-save-modal")[0]);
						var column_position = portlet.get('column_position');
						var row_position = portlet.get('row_position');
						portlet.set({
							"prefs" : JSON.stringify(json)
						}, {
							silent : true
						});

						portlet.url = "core/api/portlets";
						var model = new BaseModel();
						model.url = 'core/api/portlets';

						if (flag) {
							model
									.save(
											portlet.toJSON(),
											{
												success : function(data) {

													hidePortletSettingsAfterSave(modal_id);
													$(window).scrollTop(
															scrollPosition);
													scrollPosition = 0;
													var model = data.toJSON();
													Portlets_View.collection
															.get(model)
															.set(
																	new BaseModel(
																			model));
													var pos = ''
															+ data
																	.get("column_position")
															+ ''
															+ data
																	.get("row_position");
													portlet_utility
															.getInnerViewOfPortlet(
																	data,
																	$('#portlet-res'));

													setPortletContentHeight(data);
													$('#' + data.get('id'))
															.parent()
															.find('div:last')
															.after(
																	'<span class="gs-resize-handle gs-resize-handle-both"></span>');
												},
											});
						}
					});

	$('#portletsTaskReportSettingsModal')
			.off("change")
			.on(
					'change',
					'#group-by-task-report',
					function(e) {

						$('#tasks-task-report').trigger("change");

						$('#split-by-task-report > option')
								.each(
										function(e1) {
											if ($(this).val() == $(
													'#group-by-task-report')
													.val())
												$(this).hide();
											else {
												if ($('#tasks-task-report')
														.val() == "completed-tasks"
														&& $(this).val() != "status") {
													$(this).show();
													$(this).attr("selected",
															true);
												} else if ($(
														'#tasks-task-report')
														.val() == "all-tasks") {
													$(this).show();
													$(this).attr("selected",
															true);
												}
											}
										});
						if ($('#group-by-task-report').val() == "status") {
							$('#tasks-task-report > option#all-tasks').attr(
									"selected", true);
							$('#tasks-control-group').hide();
						} else
							$('#tasks-control-group').show();
					});

	$('.modal-content')
			.off("change")
			.on(
					'change',
					'#tasks-task-report',
					function(e) {
						var taskreportStatus = $('#split-by-task-report > option#status');
						if ($('#tasks-task-report').val() == "completed-tasks") {
							if (taskreportStatus.is(':selected'))
								taskreportStatus.attr("selected", false);
							taskreportStatus.hide();
						} else
							taskreportStatus.show();
					});

	$('.gridster-portlets').off("mouseover").on(
			'mouseover',
			'.stats_report_portlet_body',
			function(e) {
				if ($('.stats_report_portlet_body').parent().find(
						'.gs-resize-handle')) {
					$('.stats_report_portlet_body').parent().find(
							'.gs-resize-handle').remove();
				}
			});

	$('.portlet_body').off("change").on(
			'change',
			'.onboarding-check',
			function(e) {
				var that = $(this);
				var model_id = $(this).parent().parent().parent().find(
						'.portlets').attr('id');
				var model = Portlets_View.collection.get(model_id);
				var json1 = {};
				$(this).parent().parent().find('label').each(function() {
					var json2 = {};
					if ($(this).find('input:checkbox').is(':checked')) {
						json2["done"] = true;
						json2["skip"] = false;
					} else {
						json2["done"] = false;
						json2["skip"] = false;
					}
					json1["" + $(this).prop('value')] = json2;
				});
				model.set({
					'prefs' : JSON.stringify(json1)
				}, {
					silent : true
				});
				// Saves new width and height in server
				$.ajax({
					type : 'POST',
					url : '/core/api/portlets/saveOnboardingPrefs',
					data : JSON.stringify(model.toJSON()),
					contentType : "application/json; charset=utf-8",
					dataType : 'json',
					success : function() {
						if (that.find('input:checkbox').is(':checked')) {
							that.parent().find('span').css("text-decoration",
									"line-through");
						} else {
							that.parent().find('span').css("text-decoration",
									"none");
						}
					}
				});

			});

	$('.modal-body').off("click").on('click', '#category-select-all',
			function(e) {
				e.preventDefault();
				$('#category-list').multiSelect('select_all');
			});

	$('.modal-content').off("click").on('click', '#category-select-none',
			function(e) {
				e.preventDefault();
				$('#category-list').multiSelect('deselect_all');
			});

	$('.modal-body').on('click', '#user-select-all', function(e) {
		e.preventDefault();
		$('#user-list').multiSelect('select_all');
	});

	$('.modal-content').on('click', '#user-select-none', function(e) {
		e.preventDefault();
		$('#user-list').multiSelect('deselect_all');
	});

	$('.modal-body').on('click', '#calls-user-select-all', function(e) {
		e.preventDefault();
		$('#calls-user-list').multiSelect('select_all');
	});

	$('.modal-content').on('click', '#calls-user-select-none', function(e) {
		e.preventDefault();
		$('#calls-user-list').multiSelect('deselect_all');
	});

	$('.modal-body').on('click', '#task-report-user-select-all', function(e) {
		e.preventDefault();
		$('#task-report-user-list').multiSelect('select_all');
	});

	$('.modal-content').on('click', '#task-report-user-select-none',
			function(e) {
				e.preventDefault();
				$('#task-report-user-list').multiSelect('deselect_all');
			});

	$('.gridster-portlets').on('mouseover', '.portlet_body_calendar',
			function(e) {
				$(this).find('.portlet_header_icons').removeClass('vis-hide');
				$(this).find('.fc-button').css('visibility', 'visible');
			});

	$('.gridster-portlets').on('mouseout', '.portlet_body_calendar',
			function(e) {
				$(this).find('.portlet_header_icons').addClass('vis-hide');
				$(this).find('.fc-button').css('visibility', 'hidden');
			});

	$('.events_show')
			.on(
					'click',
					'.minical-portlet-event',
					function(e) {
						App_Portlets.currentPosition = ''
								+ $(this).parents('.gs-w').find(
										'.column_position').text().trim()
								+ ''
								+ $(this).parents('.gs-w')
										.find('.row_position').text().trim();
						App_Portlets.currentPortletName = 'Mini Calendar';

						$("#updateActivityModal").html(getTemplate("update-activity-modal"));
						var id = $(this).attr('id');
						if (id && !isNaN(id)) {
							var events_array = $(
									'#calendar_container',
									$(this)
											.parentsUntil('.mini-cal')
											.eq(
													$(this).parentsUntil(
															'.mini-cal').length - 1))
									.fullCalendar(
											'clientEvents',
											id,
											function(event) {
												return (event.start >= date && event.start < endDate);
											});
							// $('#'+id,$('#calendar_container')).trigger('click');
							var model = events_array[0];
							App_Portlets.currentEventObj = model;
							var eventsURL = '/core/api/events/'
									+ events_array[0].id;
							var event;
							$
									.getJSON(
											eventsURL,
											function(doc) {
												event = doc;
												var start = getDate(event.start);
												var end = getDate(event.end);
												if (!model)
													return;
												if (model.color == "#f05050"
														|| model.color == "red")
													model.color = "red";
												else if (model.color == "#7266ba"
														|| model.color == "#36C")
													model.color = "#36C";
												else
													model.color = "green";
												// Deserialize
												deserializeForm(
														model,
														$("#updateActivityForm"));

												$("#update-event-date-1").val(
														getDateInFormat(start));
												$("#update-event-date-2").val(
														getDateInFormat(end));
												// Set time for update Event
												$('#update-event-time-1')
														.val(
																(start
																		.getHours() < 10 ? "0"
																		: "")
																		+ start
																				.getHours()
																		+ ":"
																		+ (start
																				.getMinutes() < 10 ? "0"
																				: "")
																		+ start
																				.getMinutes());
												$('#update-event-time-2')
														.val(
																(end.getHours() < 10 ? "0"
																		: "")
																		+ end
																				.getHours()
																		+ ":"
																		+ (end
																				.getMinutes() < 10 ? "0"
																				: "")
																		+ end
																				.getMinutes());

												// hide end date & time for all
												// day events
												if (model.allDay) {
													$("#update-event-date-2")
															.closest('.row')
															.hide();
													$('#update-event-time-1')
															.closest(
																	'.control-group')
															.hide();
												} else {
													$('#update-event-time-1')
															.closest(
																	'.control-group')
															.show();
													$("#update-event-date-2")
															.closest('.row')
															.show();
												}

												if (model.type == "WEB_APPOINTMENT"
														&& (model.start
																.getTime() / 1000) > parseInt(new Date()
																.getTime() / 1000)) {
													$("[id='event_delete']")
															.attr("id",
																	"delete_web_event");
													web_event_title = model.title;
													if (model.contacts.length > 0) {
														var firstname = getPropertyValue(
																model.contacts[0].properties,
																"first_name");
														if (firstname == undefined)
															firstname = "";
														var lastname = getPropertyValue(
																model.contacts[0].properties,
																"last_name");
														if (lastname == undefined)
															lastname = "";
														web_event_contact_name = firstname
																+ " "
																+ lastname;
													}
												} else {
													$("[id='delete_web_event']")
															.attr("id",
																	"event_delete");
												}

												if (model.description) {
													var description = '<label class="control-label"><b>Description </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="Add Description"></textarea></div>'
													$("#event_desc").html(
															description);
													$("textarea#description")
															.val(
																	model.description);
												} else {
													var desc = '<div class="row-fluid">'
															+ '<div class="control-group form-group m-b-none">'
															+ '<a href="#" id="add_event_desctiption"><i class="icon-plus"></i> Add Description </a>'
															+ '<div class="controls event_discription hide">'
															+ '<textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="Add Description"></textarea>'
															+ '</div></div></div>'
													$("#event_desc").html(desc);
												}
												// Fills owner select element
												populateUsersInUpdateActivityModal(model);

												// Show edit modal for the event
												$("#updateActivityModal")
														.modal('show');
												$(
														'#' + id,
														$('#calendar_container'))
														.trigger('click');
												return false;

											});
						}
					});

	$('.events_show').on(
			'click',
			'.minical-portlet-event-add',
			function(e) {
				// Shows a new event
				App_Portlets.currentPosition = ''
						+ $(this).parents('.gs-w').find('.column_position')
								.text().trim()
						+ ''
						+ $(this).parents('.gs-w').find('.row_position').text()
								.trim();
				App_Portlets.currentPortletName = 'Mini Calendar';
				var start = new Date(parseInt($(this).attr('id')));
				
				$('#activityModal').getTemplate("new-event-modal").modal('show');
				highlight_event();

				// Set Date for Event
				// var dateFormat = 'mm/dd/yyyy';
				$('#task-date-1').val(getDateInFormat(start));
				$("#event-date-1").val(getDateInFormat(start));
				$("#event-date-2").val(getDateInFormat(start));

				// Set Time for Event
				// if ((start.getHours() == 00) && (start.getHours() == 00) &&
				// (start.getMinutes() == 00))
				$('#event-time-1').val('');
				$('#event-time-2').val('');
			});

	$('#portletDeleteModal').off("click").on(
			"click",
			'.portlet-delete-modal',
			function(e) {
				e.preventDefault();

				var portlet = Portlets_View.collection.get($(this).attr('id'));
				/*
				 * Sends Delete request with portlet name as path parameter, and
				 * on success fetches the portlets to reflect the changes
				 * is_added, to show add portlet in the view instead of delete
				 * option
				 */
				$.ajax({
					type : 'DELETE',
					url : '/core/api/portlets/' + portlet.get("id"),
					contentType : "application/json; charset=utf-8",

					success : function(data) {

						Portlets_View.collection.remove(portlet);

						gridster.remove_widget($('#' + portlet.get("id"))
								.parent(), false);

						setTimeout(function() {
							gridster.$changed.attr('id', 'ui-id-'
									+ gridster.$changed.attr('data-col') + '-'
									+ gridster.$changed.attr('data-row'));
						}, 500);

						$('#' + portlet.get("id")).parent().remove();

						if ($('.gridster-portlets > div').length == 0)
							$('#no-portlets').show();

						$('#portletDeleteModal').modal('hide');

					},
					dataType : 'json'
				});

			});

	$('#dashlet_heading #tutotial_modal').off('click');
	$('#dashlet_heading').on('click', '#tutotial_modal', function(e) {
		e.preventDefault();

		$('#tutorialModal').html(getTemplate("tutorial-modal"));
		$('#tutorialModal').modal("show");
	});

	$(
			'.portlet_body #portlets-contacts-model-list > tr, #portlets-companies-model-list > tr, #portlets-contacts-email-opens-model-list > tr')
			.off();
	$('.portlet_body')
			.on(
					"click",
					'#portlets-contacts-model-list > tr, #portlets-companies-model-list > tr, #portlets-contacts-email-opens-model-list > tr',
					function(e) {
						var id = $(this).find(".data").attr("data");
						App_Contacts.navigate("contact/" + id, {
							trigger : true
						});
					});

	$('.portlet_body .email-details').off();
	$('.portlet_body').on('click', '.email-details', function(e) {
		e.preventDefault();
		var data = $(this).closest('a').attr("data");

		portlet_utility.getActivityObject(data, function(resp) {

			console.log(resp);
			getTemplate("infoModal", resp, undefined, function(template_ui) {
				if (!template_ui)
					return;

				var emailinfo = $(template_ui);
				emailinfo.modal('show');
			}, null);
		});
	});

	$('.portlet_body .activity-event-edit').off();
	$('.portlet_body').on('click', '.activity-event-edit', function(e) {
		e.preventDefault();
		var data = $(this).closest('a').attr("data");

		getEventObject(data, function(resp) {
			update_event_activity(resp);
		});

	});

	$('.portlet_body').on(
			"click",
			'#portlets-opportunities-model-list > tr',
			function(e) {

				/*
				 * if(e.target.attributes[0].name!="href"){ e.preventDefault();
				 * App_Portlets.currentPosition =
				 * ''+$(this).parents('.gs-w').find('.column_position').text().trim()+''+$(this).parents('.gs-w').find('.row_position').text().trim();
				 * updateDeal($(this).data()); }
				 */
				var hrefFlag = false;
				if (e.target.attributes != undefined
						&& e.target.attributes != null
						&& e.target.attributes.length == 0)
					hrefFlag = true;
				$.each(e.target.attributes, function() {
					if (this.name == "href")
						hrefFlag = true;
				});

				if (!hrefFlag) {

					// code for navigating deal details page
					var id = $(this).find(".data").attr("data");
					App_Deal_Details.navigate("deal/" + id, {
						trigger : true
					});
				}
			});

	$('.portlet_body')
			.on(
					"click",
					'#portlets-events-model-list > tr',
					function(e) {

						var hrefFlag = false;
						if (e.target.attributes
								&& e.target.attributes.length == 0)
							hrefFlag = true;
						$.each(e.target.attributes, function() {
							if (this.name == "href")
								hrefFlag = true;
						});

						$("#updateActivityModal").html(getTemplate("update-activity-modal"));
						if (!hrefFlag) {

							App_Portlets.currentPosition = ''
									+ $(this).parents('.gs-w').find(
											'.column_position').text().trim()
									+ ''
									+ $(this).parents('.gs-w').find(
											'.row_position').text().trim();
							var id = $(this).find(".data").attr("data");
							var model = $(this).data().collection.get(id);
							if (isNaN(id))
								return;

							// Deserialize
							deserializeForm(model.toJSON(),
									$("#updateActivityForm"));

							var startDate = new Date(model.get('start') * 1000);
							var endDate = new Date(model.get('end') * 1000)
							// Set time for update Event
							$('#update-event-time-1')
									.val(
											(startDate.getHours() < 10 ? "0"
													: "")
													+ startDate.getHours()
													+ ":"
													+ (startDate.getMinutes() < 10 ? "0"
															: "")
													+ startDate.getMinutes());
							$('#update-event-time-2').val(
									(endDate.getHours() < 10 ? "0" : "")
											+ endDate.getHours()
											+ ":"
											+ (endDate.getMinutes() < 10 ? "0"
													: "")
											+ endDate.getMinutes());

							// Set date for update Event
							var dateFormat = CURRENT_USER_PREFS.dateFormat;
							$("#update-event-date-1").val(
									startDate.format(dateFormat));
							$("#update-event-date-2").val(
									endDate.format(dateFormat));

							// Hide end date & time for all day events
							if (model.toJSON().allDay) {
								$("#update-event-date-2").closest('.row')
										.hide();
								$('#update-event-time-1').closest(
										'.control-group').hide();
							} else {
								$('#update-event-time-1').closest(
										'.control-group').show();
								$("#update-event-date-2").closest('.row')
										.show();
							}

							if (model.toJSON().type == "WEB_APPOINTMENT"
									&& parseInt(model.toJSON().start) > parseInt(new Date()
											.getTime() / 1000)) {
								$("[id='event_delete']").attr("id",
										"delete_web_event");
								web_event_title = model.toJSON().title;
								if (model.toJSON().contacts.length > 0) {
									var firstname = getPropertyValue(model
											.toJSON().contacts[0].properties,
											"first_name");
									if (firstname == undefined)
										firstname = "";
									var lastname = getPropertyValue(model
											.toJSON().contacts[0].properties,
											"last_name");
									if (lastname == undefined)
										lastname = "";
									web_event_contact_name = firstname + " "
											+ lastname;
								}
							} else {
								$("[id='delete_web_event']").attr("id",
										"event_delete");
							}

							// Fills owner select element
							populateUsersInUpdateActivityModal(model.toJSON());
							if (model.toJSON().description) {
								var description = '<label class="control-label"><b>Description </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="Add Description"></textarea></div>'
								$("#event_desc").html(description);
								$("textarea#description").val(
										model.toJSON().description);
							} else {
								var desc = '<div class="row-fluid">'
										+ '<div class="control-group form-group m-b-none">'
										+ '<a href="#" id="add_event_desctiption"><i class="icon-plus"></i> Add Description </a>'
										+ '<div class="controls event_discription hide">'
										+ '<textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="Add Description"></textarea>'
										+ '</div></div></div>'
								$("#event_desc").html(desc);
							}

							// Show edit modal for the event
							$("#updateActivityModal").modal('show');
							return false;
						}
					});

	$('.portlet_body').on(
			"click",
			'#portlets-tasks-model-list > tr',
			function(e) {

				var hrefFlag = false;
				if (e.target.tagName.toLowerCase() == "a"
						|| e.target.tagName.toLowerCase() == "i"
						|| e.target.tagName.toLowerCase() == "input")
					hrefFlag = true;
				/*
				 * if(e.target.tagName.toLowerCase()=="a") hrefFlag = true;
				 */
				$.each(e.target.attributes, function() {
					if (this.name == "href")
						hrefFlag = true;
				});

				if (!hrefFlag) {
					var id = $(this).find(".data").attr("data");
					App_Tasks.navigate("task/" + id, {
						trigger : true
					});
				}
			});

	$('.gridster-portlets')
			.on(
					"click",
					'.portlets-tasks-select',
					function(e) {

						e.stopPropagation();
						if ($(this).is(':checked')) {

							// Complete
							var taskId = $(this).attr('data');

							var column_pos = $(this).parentsUntil('.gs-w')
									.last().parent().find('.column_position')
									.text().trim();
							var row_pos = $(this).parentsUntil('.gs-w').last()
									.parent().find('.row_position').text()
									.trim();
							var pos = column_pos + '' + row_pos;

							complete_task(
									taskId,
									App_Portlets.tasksCollection[parseInt(pos)].collection,
									$(this).closest('tr'));

							if ($(this).parentsUntil('table').last().find(
									'tr:visible').length == 1) {
								$(this)
										.parentsUntil('table')
										.parent()
										.parent()
										.html(
												'<div class="portlet-error-message">No tasks found.</div>');
							}
						}
					});

	$('.gridster-portlets').on("click", '.portlet-settings', function(e) {
		e.preventDefault();

		portlet_utility.showPortletSettings(this.id);
	});

}

/** 
 *Listener function for Event handling
 */
function initializeAddPortletsListeners() {

	$('.col-md-3')
			.on(
					"mouseenter",
					'.show_screeshot',
					function(e) {

						var p_name = $(this).attr('id');
						var image;
						var placement = "right";
						var image_url_json = {
							"FilterBased" : "img/dashboard_images/My-contacts.png",
							"EmailsOpened" : "img/dashboard_images/Email-opened.png",
							"GrowthGraph" : "img/dashboard_images/Tag-Graph.png",
							"PendingDeals" : "img/dashboard_images/Pending-Deals.png",
							"DealsByMilestone" : "img/dashboard_images/Milestone.png",
							"DealsFunnel" : "img/dashboard_images/Deals-Funnel.png",
							"Agenda" : "img/dashboard_images/Events.png",
							"TodayTasks" : "img/dashboard_images/Task.png",
							"CallsPerPerson" : "img/dashboard_images/Calls.png",
							"AgileCRMBlog" : "img/dashboard_images/Agile-Blog.png",
							"TaskReport" : "img/dashboard_images/Task-report.png",
							"StatsReport" : "img/dashboard_images/stats.png",
							"Leaderboard" : "img/dashboard_images/Leaderboard.png",
							"RevenueGraph" : "img/dashboard_images/Revenue-graph.png",
							"AccountDetails" : "img/dashboard_images/account-information.png",
							"MiniCalendar" : "img/dashboard_images/Mini-Calendar.jpg",
							"UserActivities" : "img/dashboard_images/User-Activities.png",
							"Campaignstats" : "img/dashboard_images/Campaign-stats.jpg"
						};
						var placements_json = {
							"GrowthGraph" : "left",
							"DealsFunnel" : "left",
							"CallsPerPerson" : "left",
							"TaskReport" : "left",
							"RevenueGraph" : "left",
							"MiniCalendar" : "left",
							"UserActivities" : "left",
							"Campaignstats" : ""
						};
						if (placements_json[p_name]) {
							placement = "left";
						}

						$(this).popover(
								{
									"rel" : "popover",
									"trigger" : "hover",
									"placement" : placement,
									"html" : "true",
									"content" : function() {
										return '<img src='
												+ image_url_json[p_name] + '>';

									}
								});
						$(this).popover('show');
					});

	$('#portlets-add-listener').on(
			"click",
			'.add-portlet',
			function() {

				var portlet_type = $(this).attr("portlet_type");
				var p_name = $(this).attr("portlet_name");

				var json = portlet_utility.getDefaultPortletSettings(
						portlet_type, p_name);

				var obj = {};
				obj.name = p_name;
				var curDate = new Date();
				obj.portlet_type = portlet_type;
				var max_row_position = 0;
				var next_position = gridster.next_position(1, 1);
				obj.column_position = next_position.col;
				obj.row_position = next_position.row;
				obj.size_x = next_position.size_x;
				obj.size_y = next_position.size_y;

				if (portlet_type == "RSS" && p_name == "Agile CRM Blog")
					obj.size_y = 2;

				else if (portlet_type == "USERACTIVITY"
						&& p_name == "Leaderboard") {
					obj.size_y = 2;
					obj.size_x = 2;
				}

				var portlet = new BaseModel();
				portlet.url = 'core/api/portlets/addPortlet';
				portlet.set({
					"prefs" : JSON.stringify(json)
				}, {
					silent : true
				});
				var model;
				var scrollPosition;
				portlet.save(obj, {
					success : function(data) {
						model = new BaseModel(data.toJSON());
						if ($('#zero-portlets').is(':visible'))
							$('#zero-portlets').hide();
						if ($('#no-portlets').is(':visible'))
							$('#no-portlets').hide();
						App_Portlets.navigate("dashboard", {
							trigger : true
						});
					},
					error : function(model, response) {
						alert("Failed to add.");
					}
				});
			});

}var Portlets_View, gridster;

/** If CURRENT_AGILE_USER is not set, set it from user.domain **/
$(function()
{
	$.getJSON('/core/api/users/agileusers', function(users)
	{
		$.each(users, function(i, user)
		{
			if (CURRENT_DOMAIN_USER.id == user.domain_user_id)
			{
				CURRENT_AGILE_USER = user;
			}
		});
	});
});

/**
 * Loads all the portlets for the current agile user
 * 
 * @param el
 */
function loadPortlets(el){

	App_Portlets.todayEventsCollection = new Array();
	App_Portlets.tasksCollection = new Array();
	App_Portlets.pendingDeals = new Array();
	App_Portlets.dealsWon = new Array();
	App_Portlets.filteredCompanies = new Array();
	App_Portlets.filteredContacts = new Array();
	App_Portlets.emailsOpened = new Array();
	App_Portlets.statsReport = new Array();
	App_Portlets.leaderboard = new Array();
	App_Portlets.accountInfo = new Array();
	App_Portlets.activity=new Array();
	App_Portlets.activitiesView= new Array();
	App_Portlets.campaignstats = new Array();

	/*
	 * If Portlets_View is not defined , creates collection view, collection is
	 * sorted based on position i.e., set when sorted using jquery ui sortable
	 */
	
	// This flag is used to ensure portlet script are loaded only once in
	// postrender. It is set to false after portlet setup is initialized
	Portlets_View = new Base_Collection_View({ url : '/core/api/portlets', sortKey : "row_position",sort_collection : false, restKey : "portlet", templateKey : "portlets", individual_tag_name : 'div',
		postRenderCallback : function(portlets_el){
			set_up_portlets(el, portlets_el);

				if(Portlets_View.collection.length==0)
					$('.gridster > div:visible > div',el).removeClass('gs-w');
			
			initializePortletsListeners();

		} });

	this.Portlets_View.appendItem = set_p_portlets;

	//  Fetch portlets from collection and set_up_portlets (load their scripts)
	Portlets_View.collection.fetch();

	// show portlets
	var newEl = Portlets_View.render().el;
	$('#portlets', el).html(newEl);	
}

/**
 * set the portlets size and position on dashboard 
 * 
 * @param el
 * @param portlets_el
 */
function set_up_portlets(el, portlets_el){

	var dimensions;
	var dim_width = Math.round($('.gridster-portlets').width()/3)-20;
	var dim_height = 200;
	dimensions = [dim_width, dim_height];
	gridster = $('.gridster > div:visible',portlets_el).gridster({
    	widget_selector: "div",
        widget_margins: [10, 12],
        widget_base_dimensions: dimensions,
        min_cols: 3,
        autogenerate_stylesheet: true,
        draggable: {
        	limit: true,
        	ignore_dragging: [".portlet_body",".portlet_body *",".portlet-panel",".portlet-panel *",".fc-content *",".events_show *"],
        	stop: function(event,ui){
        		
				var models = [];

				/*
				 * Iterate through each all the portlets and set each portlet
				 * position and store it in array
				 */
				$('#portlet-res > div > .gs-w').each(function(){
					
					$(this).attr('id','ui-id-'+$(this).attr("data-col")+'-'+$(this).attr("data-row"));
					$(this).find('div.portlet_body').attr('id','p-body-'+$(this).attr("data-col")+'-'+$(this).attr("data-row"));
					
					var model_id = $(this).find('.portlets').attr('id');
					
					var model = Portlets_View.collection.get(model_id);
					model.set({ 'column_position' : parseInt($(this).attr("data-col")) }, { silent : true });
					model.set({ 'row_position' : parseInt($(this).attr("data-row")) }, { silent : true });

					models.push({ id : model.get("id"), column_position : parseInt($(this).attr("data-col")), row_position : parseInt($(this).attr("data-row")) });
				});
				// Saves new positions in server
				$.ajax({ type : 'POST', url : '/core/api/portlets/positions', data : JSON.stringify(models),
					contentType : "application/json; charset=utf-8", dataType : 'json' });
			}
        },
        resize: {
        	enabled: true,
        	max_size: [3,3],
			resize: function(event,ui){
				var temp=Portlets_View.collection.get($('#'+this.$resized_widget.attr('id')+' > div.portlets').attr('id'));
				if(temp.get("name")=="Mini Calendar"){
					var el=this.$resized_widget.find('#calendar_container');
					var height=$('#'+this.$resized_widget.attr('id')).height();

					if(height<=200)
					{
						$(el).find('.fc-header').css('height','25px');
						$(el).parent().find('.show').css('padding-top','5px');
					}
					else if(height>200 && height<=450 )
					{
						$(el).find('.fc-header').css('height','145px');
						$(el).find('.show').css('padding-top','70px');
					}
					else
					{
						$(el).find('.fc-header').css('height','250px');
						$(el).find('.show').css('padding-top','120px');
					}

					var css = {"height" : height+"px", "max-height" : height+"px"};

					$('#'+this.$resized_widget.attr('id')+' > .portlet_body_calendar').css(css);
					$(el).fullCalendar('option','aspectRatio',getaspectratio($(el).parent()));
					var top=parseInt($(el).find('.fc-widget-content').css('height'))/2-7;
					$(el).find('.fc-day-number').css('top',top);
				}	
			},

        	stop: function(event,ui){
        		
        		$(window).trigger('resize');
        		
        		$('#'+this.$resized_widget.attr('id')+' > div.portlet_body').css('overflow-x','hidden').css('overflow-y','auto');
					
        		var tempModel = Portlets_View.collection.get($('#'+this.$resized_widget.attr('id')+' > div.portlets').attr('id'));
        		
        		var that = this;
        		if(tempModel.get("name")=="Leaderboard"){
        			$('#'+this.$resized_widget.attr('id')+' > .portlet_header').find('ul').width(($('#'+this.$resized_widget.attr('id')+' > .portlet_body').find('ul').width()/$('#'+this.$resized_widget.attr('id')+' > .portlet_body').width()*100)+'%');
        		}

        		else if(tempModel.get("name")=="Mini Calendar")
        			{
						var el=this.$resized_widget.find('.portlet_body_calendar');
						var aspectratio, height = this.$resized_widget.attr('data-sizey');


	        			if(height==1){
	        				height = height*200;

							$(el).find('.fc-header').css('height','25px');
							$(el).find('.show').css('padding-top','5px');
							 
							
							
						}else if(height==2){
							height = height*200+25;

							$(el).find('.fc-header').css('height','145px');
							$(el).find('.show').css('padding-top','70px');
							
							
						}
						else if(height==3){
							height = height*200+50;

							$(el).find('.fc-header').css('height','250px');
							$(el).find('.show').css('padding-top','120px');
							
							
							
						}

						var css = {"height" : height+"px", "max-height" : height+"px"};

						$('#'+this.$resized_widget.attr('id')+' > .portlet_body_calendar').css(css);
						$('#calendar_container').fullCalendar('option','aspectRatio',getaspectratio(el));	
						
						var top=parseInt($(el).find('.fc-widget-content').css('height'))/2-7;
						$(el).find('.fc-day-number').css('top',top);

        			}
        		

				var models = [];

				/*
				 * Iterate through each all the portlets and set each portlet
				 * position and store it in array
				 */
				$('#portlet-res > div > .gs-w').each(function(){
					
					$(this).attr('id','ui-id-'+$(this).attr("data-col")+'-'+$(this).attr("data-row"));
					
					$(this).find('div.portlet_body').attr('id','p-body-'+$(this).attr("data-col")+'-'+$(this).attr("data-row"));
					
					var model_id = $(this).find('.portlets').attr('id');
					
					var model = Portlets_View.collection.get(model_id);
					
					model.set({ 'size_x' : parseInt($(this).attr("data-sizex")) }, { silent : true });
					
					model.set({ 'size_y' : parseInt($(this).attr("data-sizey")) }, { silent : true });
					
					model.set({ 'column_position' : parseInt($(this).attr("data-col")) }, { silent : true });
					
					model.set({ 'row_position' : parseInt($(this).attr("data-row")) }, { silent : true });

					models.push({ id : model.get("id"), size_x : parseInt($(this).attr("data-sizex")), size_y : parseInt($(this).attr("data-sizey")), 
						column_position : parseInt($(this).attr("data-col")), row_position : parseInt($(this).attr("data-row")) });
				});
				// Saves new width and height in server
				$.ajax({ type : 'POST', url : '/core/api/portlets/widthAndHeight', data : JSON.stringify(models),
					contentType : "application/json; charset=utf-8", dataType : 'json' });

			}
        }
    }).data('gridster');

    $(window).resize(function()
    {
    	if(gridster!=undefined)
    		$('.gridster-portlets').css("height","auto");

    	if($(window).width()<768 && gridster!=undefined){
    		gridster.disable();
    		gridster.disable_resize();
    	}
    	else if(gridster!=undefined)
    	{
    		gridster.enable();
    		gridster.enable_resize();
    		gridster.set_dom_grid_height();
    	}

		if($(window).width()<975 && $(window).width()>768 && $('.portlet_body_calendar').is(':visible'))
		{
				$('.portlet_body_calendar').each(function(){
				$(this).find('#calendar_container').find('.fc-widget-header').each(function(){
				$(this).text($(this).text().substring(0, 1));
				});
			});
		}
		else if($(window).width()>975 && $('.portlet_body_calendar').is(':visible'))
		{
				$('.portlet_body_calendar').each(function()
				{
					var weeksArray = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
					$(this).find('#calendar_container').find('.fc-widget-header').each(function(index)
					{
						$(this).text(weeksArray[index]);
					});
				});
		}
    });

    if($(window).width()<768 && gridster!=undefined){
		gridster.disable();
		gridster.disable_resize();
	}
	else if(gridster!=undefined){
		gridster.enable();
		gridster.enable_resize();
	}

    $(window).trigger('resize');
}

/**To hide the modal popup after the portlet setting is saved**/
function hidePortletSettingsAfterSave(modal_id){

	var modal=$('#'+modal_id+ '> .modal-dialog > .modal-content > .modal-footer > a');
	modal.text('Save');
	modal.attr('disabled',false);
	$('#'+modal_id).modal('hide');
	$('.modal-backdrop').hide();
}

/** Initializes and fetched latest feeds from AgileCRM blosspot.**/
function initBlogPortletSync(el)
{
	head.js(LIB_PATH + 'lib/jquery.feeds.min.js',
		function()
		{

		  $('#portlet_blog_sync_container',el)
				.feeds(
					   {
						feeds : { blog : "https://www.agilecrm.com/blog/feed/" },
						max : 3,
						entryTemplate : function(entry)
						 {
							return '' + '<a href="' + entry.link + '" title = "' + entry.title + '" target="_blank" >' + entry.title + '</a><div style="color:#999;font-size:11px;line-height: 13px;margin-bottom:5px">' 
							+ new Date(entry.publishedDate).format('mmm d, yyyy') + '</div><p style="padding-top:5px;margin-bottom:15px">' 
							+ entry.contentSnippet.replace('<a', '<a target="_blank"') + '</p>';
						 },
							onComplete : function(e){
							$('#portlet_blog_sync_container',el).append('<span class="pull-right"><a href="https://www.agilecrm.com/blog" target="_blank">Agile CRM Blog</a></span>');
							}
						});
		});

}

$('body').on('click', '.onboarding-skip', function(e) {
	var parent_el=$(this).parent();

	parent_el.find('span').css("text-decoration","line-through");

	if(!parent_el.find('small').hasClass('onboarding-undo'))
		parent_el.find('span').after("<small class='p-l-sm onboarding-undo c-p'>(undo)</small>");
	$(this).remove();
});

$('body').on('click', '.onboarding-undo', function(e) {
	var parent_el=$(this).parent();

	parent_el.find('span').css("text-decoration","none");
	parent_el.find('label').remove();
	parent_el.find('span').before("<label class='i-checks i-checks-sm onboarding-check' style='padding-right:4px;'><input type='checkbox'><i></i></label>");
	
	if(!parent_el.find('small').hasClass('onboarding-skip'))
		parent_el.find('span').after("<small class='p-l-sm onboarding-skip c-p'>(skip)</small>");
	$(this).remove();
});

/** Loads the default image for owner if no image is present **/
function gravatarImgForPortlets(width){
	// Default image
	var img = DEFAULT_GRAVATAR_url;
	var backup_image = "&d=404\" ";
	// backup_image="";
	var initials = '';
	
	if (initials.length == 0)
		backup_image = "&d=" + DEFAULT_GRAVATAR_url + "\" ";
	var data_name = '';
		return new Handlebars.SafeString('https://secure.gravatar.com/avatar/' + Agile_MD5("") + '.jpg?s=' + width + '' + backup_image + data_name);
}

/** Loading google events for Events Portet**/
function loadGoogleEventsForPortlets(p_el,startTime,endTime){
	$.getJSON('core/api/calendar-prefs/get', function(response)
	{
		var events = new Array();
		console.log(response);
		if (response)
		{

		head.js('https://apis.google.com/js/client.js', '/lib/calendar/gapi-helper.js', function()
		{
			setupGC(function()
			{

				gapi.auth.setToken({ access_token : response.access_token, state : "https://www.googleapis.com/auth/calendar" });

				var current_date = new Date();
				var timezone_offset = current_date.getTimezoneOffset();
				var startDate = new Date(startTime * 1000);
				var gDateStart = startDate.toISOString();
   				var endDate = new Date(endTime * 1000);
   				var gDateEnd = endDate.toISOString();

				// Retrieve the events from primary
				var request = gapi.client.calendar.events
							.list({ 'calendarId' : 'primary', maxResults : 25, singleEvents : true, orderBy : 'startTime', timeMin : gDateStart, timeMax : gDateEnd });
					request.execute(function(resp)
					{
						console.log(resp);
						for (var i = 0; i < resp.items.length; i++)
						{
							var fc_event = google2fcEvent(resp.items[i]);
							fc_event.startEpoch = new Date(fc_event.start).getTime()/1000;
							fc_event.endEpoch = new Date(fc_event.end).getTime()/1000;
							if (isNaN(fc_event.endEpoch))
							{
								fc_event.endEpoch = new Date(fc_event.google.end.date).getTime()/1000;
							}
							console.log(fc_event);
							events.push(fc_event);

						}
						App_Portlets.googleEventCollectionView = new Base_Collection_View({ data : events, templateKey : "portlets-google-events", individual_tag_name : 'tr',
							sort_collection : true, sortKey : 'start', descending : false, 
							postRenderCallback : function(el){
								if($(p_el).parent().parent().find('#normal-events').find('table').find('tr').length>0)
								{
									$(p_el).parent().parent().find('#google-events').addClass('m-t-n-md').css("border-top","1px solid #eee");
								}
								setTimeout(function(){
									if($(p_el).parent().parent().find('#normal-events').find('table').find('tr').length==0 && $(p_el).parent().parent().find('#google-events').find('table').find('tr').length==0)
									{
										$(p_el).parent().parent().find('#normal-events').html('<div class="portlet-error-message">No calendar events</div>');
									}
								},1000);
							} });
						//googleEventCollectionView.appendItem = appendGoogleEvent;
						if($(p_el).parent().parent().find('#google-events').find('table').find('tr').length==0)
						{
							$(p_el).parent().parent().find('#google-events').html(App_Portlets.googleEventCollectionView.render(true).el);
						}
						hideTransitionBar();
					});

				});
			});
		}
		else{
			setTimeout(function(){
				if($(p_el).parent().parent().find('#normal-events').find('table').find('tr').length==0 && $(p_el).parent().parent().find('#google-events').find('table').find('tr').length==0)
				{
					$(p_el).parent().parent().find('#normal-events').html('<div class="portlet-error-message">No calendar events</div>');
				}
			},1000);
		}
	});
}
/**
* js for initialising the mini Calendar portlet with agile 
* and google events along with adding and updating the events
**/

//json Object for collecting events
var jso=[];

/**
 * initialises full calendar functionality in a mini calendar
 * with a list of events in the side bar for each day.
 * and can add and update event for the day. Also mousehoveing the events shows the complete detail of events
 */
function minicalendar(el)
{
	eraseCookie('current_date_calendar');
	init_cal(el);
	var totalEvents = 0;
	var eventsCount = 0;
	var dayClasses = [];


	$('#calendar_container',el).fullCalendar({


		aspectRatio:getaspectratio(el),
		selectable: true,
		header : { left : 'prev',right:'next', center :'title'  },
		weekMode:'liquid',

		eventSources :[
		               {
		            	   events : function(start, end, callback)
		            	   {
		            		   var datasizeY=$(el).parent().attr('data-sizey');
		            		   if(datasizeY==2)
		            			   $(el).find('.fc-header').css('height','145px');		
		            		   else if(datasizeY==3)
		            			   $(el).find('.fc-header').css('height','250px');		

		            		   jso=[];
		            		   var date=new Date();
		            		   var todayDate=new Date(date.getFullYear(), date.getMonth(), date.getDate(),00,00,00);
		            		   var endDate=new Date(date.getFullYear(), date.getMonth(), date.getDate(),23,59,59);
		            		   var todayDiv='<div class="show p-t-xs text-md text-center">Today </div><ul class="list"></ul>';
		            		   if(readCookie('current_date_calendar')!=null)
		            		   {
		            			   var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
		            			   var cookie_date=new Date(readCookie('current_date_calendar'));
		            			   if(cookie_date.getTime()!=todayDate.getTime()){
		            				   todayDate=cookie_date;
		            				   endDate=new Date(cookie_date.getFullYear(), cookie_date.getMonth(), cookie_date.getDate(),23,59,59);
		            				   $(el).find('.events_show').empty().append('<div class="show p-t-xs text-md text-center">'+days[cookie_date.getDay()]+', ' +cookie_date.format('dd mmm')+' </div><ul class="list"></ul>');

		            			   }
		            			   else
		            				   $(el).find('.events_show').empty().append(todayDiv);
		            		   }
		            		   else if(start<todayDate &&  todayDate<end){
		            			   $(el).find('.events_show').empty().append(todayDiv);

		            		   }

		            		   if(datasizeY==2)
		            			   $(el).find('.show').css('padding-top','70px');
		            		   else if(datasizeY==3)
		            			   $(el).find('.show').css('padding-top','120px');
		            		   var top=parseInt($(el).find('.fc-widget-content').css('height'))/2-7;
		            		   $(el).find('.fc-day-number').css('top',top);  

		            		   var eventsURL = '/core/api/events?start=' + start.getTime() / 1000 + "&end=" + end.getTime() / 1000 + "&owner_id=" +CURRENT_AGILE_USER.id;


		            		   $.getJSON(eventsURL, function(doc)
		            				   {
		            			   $.each(doc, function(index, data)
		            					   {

		            				   if (data.color == 'red' || data.color == '#f05050')
		            					   data.color='#f05050';
		            				   else if (data.color == '#36C' || data.color == '#23b7e5' || data.color == 'blue')
		            					   data.color='#7266ba';
		            				   else if (data.color == 'green' || data.color == '#bbb')
		            					   data.color='#fad733';


		            				   var e_date= new Date(data.start*1000);
		            				   var end_date=new Date(data.end*1000);
		            				   //var a=Math.round((end_date-e_date)/(1000*60*60*24));
		            				   var a=(end_date.getMonth()-e_date.getMonth())+(end_date.getDate()-e_date.getDate());
		            				   if(a==0){
		            					   var new_json1=JSON.parse(JSON.stringify(data));
		            					   jso.push(new_json1);
		            				   }
		            				   else{
		            					   for(var i=0;i<=a;i++){
		            						   var new_json=JSON.parse(JSON.stringify(data));
		            						   var json_start=new Date(e_date.getFullYear(),e_date.getMonth(),e_date.getDate()+i,00,00,00).getTime()/1000;
		            						   var json_end=new Date(e_date.getFullYear(),e_date.getMonth(),e_date.getDate()+i,23,59,59).getTime()/1000;
		            						   if(i==0){
		            							   new_json.start=e_date.getTime()/1000;
		            							   new_json.end=json_end;
		            						   }
		            						   else if(i<a){		
		            							   new_json.start=json_start;
		            							   new_json.end=json_end
		            						   }
		            						   else{
		            							   new_json.start=json_start
		            							   new_json.end=end_date.getTime()/1000;
		            						   }
		            						   jso.push(new_json);
		            					   } }
		            					   });

		            			   if (doc)
		            			   {

		            				   console.log(jso);
		            				   $.each(jso,function(index,ev){
		            					   if(ev.start >= (todayDate.getTime()/1000) && ev.start <= (endDate.getTime()/1000)) {
		            						   if($(el).find('.portlet-calendar-error-message').length!=0)
		            						   {
		            							   $(el).find('.portlet-calendar-error-message').css('display','none');
		            							   $(el).find('.minical-portlet-event-add').css('display','none');
		            						   }
		            						   var e_date= new Date(ev.start*1000);
		            						   var len=$(el).find('.list').find('li').length;
		            						   var event_list='<li class="p-t-xs p-r-xs" style="color:'+ev.color+'"><span style="color : #58666e" class="text-cap word-break"><a class="minical-portlet-event" id='+ev.id+' data-date='+todayDate.getTime()+'>'+ev.title+'</a><br><small class="block m-t-n-xxs">'+ e_date.format('HH:MM') + ' </small></span></li>';
		            						   if(len!=0)
		            						   {
		            							   $(el).find('.list').find('small').each(function(x) 
		            									   {
		            								   if(e_date.format('HH:MM')<$(this).text())
		            								   {
		            									   $(this).parents('li').before(event_list);
		            									   return false;
		            								   }
		            								   if(x==len-1)
		            									   $(this).parents('.list').append(event_list) ;

		            									   });
		            						   }

		            						   else
		            							   $(el).find('.list').append(event_list);
		            					   }
		            				   }); 


		            				   callback(jso);
		            			   }



		            				   });


		            	   } },{dataType :'agile-events'}


		            	   ],



		            	   eventRender: function (event, element, view) { 
		            		   var year = event.start.getFullYear(), month = event.start.getMonth() + 1, date = event.start.getDate();
		            		   var result = year + '-' + (month < 10 ? '0' + month : month) + '-' + (date < 10 ? '0' + date : date);
		            		   $(element).addClass(result);
		            		   $(element).attr('id',event.id);
		            		   dayClasses.push(result);
		            		   $('.fc-event').find('.fc-event-inner').css('display','none');

		            		   var count=$(el).find('.'+result).length;
		            		   if(count>3){
		            			   return false;
		            		   }  
		            	   } ,
		            	   eventAfterRender: function (event, element, view) {

		            		   eventsCount++;
		            		   if(totalEvents == 0)
		            		   {
		            			   totalEvents = $(el).find('#calendar_container').find('.fc-event').length;
		            		   }
		            		   var h=parseInt($(el).find('.fc-widget-content').css('height'));
		            		   var head=parseInt($(el).find('.fc-header').css('height'));
		            		   var top=element.position().top+h-25;
		            		   var left=element.position().left+5;
		            		   $(element).css('top',top);
		            		   $(element).css('left',left);

		            		   if(eventsCount==totalEvents || eventsCount==(2*totalEvents)){
		            			   var temp;
		            			   var dayEventsTotalCount = totalEvents;
		            			   totalEvents = 0;
		            			   eventsCount = 0;
		            			   jso=[];
		            			   var classNamesArray = [];
		            			   $(el).find('#calendar_container').find('.fc-event').each(function(index){
		            				   if($.inArray($(this).attr('class').split(" ")[$(this).attr('class').split(" ").length-1], classNamesArray)==-1){
		            					   classNamesArray.push($(this).attr('class').split(" ")[$(this).attr('class').split(" ").length-1]);
		            				   }
		            			   });
		            			   $.each(classNamesArray,function(index, value){
		            				   var dayEventsCount = 0;
		            				   $.each(dayClasses, function(index1, value1){
		            					   if(dayClasses[index1]==classNamesArray[index]){
		            						   dayEventsCount++;
		            					   }
		            				   });
		            				   if(eventsCount==(2*dayEventsTotalCount)){
		            					   dayEventsCount = dayEventsCount/2;
		            				   }
		            				   var pos = $('.'+this,el).eq(0).position();
		            				   var eventsLength = $('.'+this,el).length;
		            				   var addPixels = Math.round(($(el).find('.fc-widget-header').eq(1).width()-10)/2);
		            				   if(eventsLength==1){
		            					   pos.left += addPixels;
		            				   }
		            				   else if(eventsLength==2){
		            					   pos.left += addPixels;
		            					   pos.left -= 3;
		            				   }
		            				   else if(eventsLength==3){
		            					   pos.left += addPixels;
		            					   pos.left -= 6;
		            				   }
		            				   else{
		            					   pos.left += addPixels;
		            					   pos.left -= 10;
		            				   }

		            				   pos.top += 8;
		            				   $('.'+this,el).each(function(index)
		            						   {
		            					   if(index>0){
		            						   $(this,el).css({"top": pos.top, "left":pos.left+(6*index)});

		            						   if(index>2)
		            						   {
		            							   $(this,el).hide();
		            						   }
		            					   }
		            					   else if(index==0){
		            						   $(this,el).css({"top": pos.top, "left":pos.left});
		            					   }

		            						   });
		            				   if(dayEventsCount>3)
		            				   {
		            					   var icon_pos = pos.left+(3*6);
		            					   $('.'+this,el).eq(eventsLength-1).after('<div class="plus-button pos-abs c-p" style="top: '+(pos.top-7)+'px;left: '+icon_pos+'px; color:lightgray;" title="'+(dayEventsCount-3)+' more">&nbsp;</div>');
		            				   }
		            			   });

		            			   dayClasses = [];
		            		   }
		            	   },

		            	   eventMouseover : function(event, jsEvent, view)
		            	   {
		            		   $(el).find('.portlet_header_icons').removeClass('vis-hide');
		            		   $(el).find('.fc-button').css('visibility','visible');
		            		   el.parent().css('z-index',3);
		            		   var reletedContacts = '';
		            		   var meeting_type = '';
		            		   if(CURRENT_AGILE_USER.domainUser.ownerPic=="" || CURRENT_AGILE_USER.domainUser.ownerPic=="no image")
		            			   event.ownerPic=gravatarImgForPortlets(25);
		            		   if (event.contacts)
		            		   {
		            			   if (event.contacts.length > 0)
		            				   reletedContacts += '<i class="icon-user text-muted m-r-xs"></i>';
		            		   }
		            		   if (event.contacts)
		            		   {
		            			   for (var i = 0; i < event.contacts.length; i++)
		            			   {
		            				   if (event.contacts[i].type == "PERSON")
		            				   {
		            					   var last_name = getPropertyValue(event.contacts[i].properties, "last_name");
		            					   if (last_name == undefined)
		            						   last_name = "";
		            					   reletedContacts += '<a class="text-info" href="#contact/' + event.contacts[i].id + '">' + getPropertyValue(
		            							   event.contacts[i].properties, "first_name") + ' ' + last_name + '</a>';
		            				   }
		            				   else
		            				   {
		            					   try
		            					   {
		            						   reletedContacts += '<a class="text-info" href="#company/' + event.contacts[i].id + '">' + getPropertyValue(
		            								   event.contacts[i].properties, "name") + '</a>';
		            					   }
		            					   catch (err)
		            					   {
		            						   console.log("error");
		            					   }
		            				   }
		            				   if (i != event.contacts.length - 1)
		            					   reletedContacts += ', ';
		            			   }
		            		   }
		            		   if (event.meeting_type && event.description)
		            		   {
		            			   meeting_type = '<i class="icon-comment-alt text-muted m-r-xs"></i><span>Meeting Type - ' + event.meeting_type + '</span><br/><span title=' + event.description + '>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + event.description + '</span>';
		            		   }

		            		   else if (event.description)
		            		   {
		            			   meeting_type = '<i class="icon-comment-alt text-muted m-r-xs"></i><span title=' + event.description + '>' + event.description + '</span>';
		            		   }

		            		   var leftorright = 'bottom';
		            		   var pullupornot = '';
		            		   var popoverElement = '';
		            		   if(event.type=="AGILE"){
		            			   popoverElement = '<div class="fc-overlay ' + leftorright + '" style="width:100%;">' + '<div class="panel bg-white b-a pos-rlt p-sm">' + '<span class="arrow ' + leftorright + ' ' + pullupornot + '"></span>' + '<div class="h4 font-thin m-b-sm"><div class="pull-left text-ellipsis p-b-xs" style="width:100%;">' + event.title + '</div></div>' + '<div class="line b-b b-light"></div>' + '<div><i class="icon-clock text-muted m-r-xs"></i>' + event.start
		            			   .format('dd-mmm-yyyy HH:MM') + '<div class="pull-right" style="width:10%;"><img class="r-2x" src="' + event.ownerPic + '" height="20px" width="20px" title="' + event.owner.name + '"/></div></div>' + '<div class="text-ellipsis">' + reletedContacts + '</div>' + '<div class="text-ellipsis">' + meeting_type + '</div>' + '</div>' + '</div>';
		            			   $(this).append(popoverElement);
		            			   $(this).find('.fc-overlay').find('.arrow').css('top','70px');
		            		   }
		            		   else{
		            			   popoverElement = '<div class="fc-overlay ' + leftorright + '" style="width:100%;">' + '<div class="panel bg-white b-a pos-rlt p-sm">' + '<span class="arrow ' + leftorright + ' ' + pullupornot + '"></span>' + '<div class="h4 font-thin m-b-sm"><div class="pull-left text-ellipsis p-b-xs" style="width:100%;">' + event.title + '</div></div>' + '<div class="line b-b b-light"></div>' + '<div><i class="icon-clock text-muted m-r-xs"></i>' + event.start
		            			   .format('dd-mmm-yyyy HH:MM') + '<div class="pull-right" style="width:10%;"></div></div>' + '<div class="text-ellipsis">' + reletedContacts + '</div>' + '<div class="text-ellipsis">' + meeting_type + '</div>' + '</div>' + '</div>';
		            			   $(this).append(popoverElement);
		            		   }
		            		   var overlay=$(this).find('.fc-overlay');
		            		   if(event.start.getDay()==4 || event.start.getDay()==5 || event.start.getDay()==6){
		            			   overlay.css('left','-180px');
		            			   overlay.find('.arrow').css('left','91%');
		            		   }
		            		   if(reletedContacts!='' || meeting_type!=''){
		            			   overlay.css('top','-95px');
		            			   overlay.find('.arrow').css('top','84px');
		            		   }
		            		   if(reletedContacts!='' && meeting_type!=''){
		            			   overlay.css('top','-108px');
		            			   overlay.find('.arrow').css('top','98px');
		            		   }
		            		   overlay.show();
		            	   },
		            	   eventMouseout : function(event, jsEvent, view)
		            	   {
		            		   el.parent().css('z-index',2);
		            		   $(this).find('.fc-overlay').hide();
		            		   $(this).find('.fc-overlay').remove();
		            	   },

		            	   dayClick : function(date,allDay,jsEvent,view){
		            		   App_Portlets.refetchEvents = false;
		            		   var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
		            		   var current_date = new Date();
		            		   if(date.getFullYear()==current_date.getFullYear() && date.getMonth()==current_date.getMonth() && date.getDate()==current_date.getDate()){
		            			   $(el).find('.events_show').empty().append('<div class="show p-t-xs text-md text-center">Today</div><ul class="list"></ul>');
		            		   }
		            		   else{
		            			   $(el).find('.events_show').empty().append('<div class="show p-t-xs text-md text-center">'+days[date.getDay()]+', ' +date.format('dd mmm')+' </div><ul class="list"></ul>');
		            		   }

		            		   if($(el).parent().attr('data-sizey')==2)
		            			   $(el).find('.show').css('padding-top','70px');
		            		   else if($(el).parent().attr('data-sizey')==3)
		            			   $(el).find('.show').css('padding-top','120px');
		            		   var endDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);
		            		   var array= $('#calendar_container',el).fullCalendar('clientEvents', function(event)
		            				   {
		            			   return (event.start >= date && event.start < endDate);
		            				   });
		            		   if(array.length!=0){
		            			   $.each(array,function(index){
		            				   var len=$(el).find('.list').find('li').length;
		            				   var event_list='<li class="p-t-xs p-r-xs" style="color : '+array[index].color+'"><span style="color : #58666e" class="text-cap word-break"><a class="minical-portlet-event" id='+array[index].id+' data-date='+date.getTime()+'>'+array[index].title+'</a><br><small class="block m-t-n-xxs">'+ array[index].start.format('HH:MM') + ' </small></span></li>';
		            				   if(len!=0){
		            					   $(el).find('.list').find('small').each(function(x) 
		            							   {
		            						   if(array[index].start.format('HH:MM')<$(this).text())
		            						   {
		            							   $(this).parents('li').before(event_list);
		            							   return false;
		            						   }

		            						   if(x==len-1)
		            							   $(this).parents('.list').append(event_list);
		            							   });
		            				   }
		            				   else
		            					   $(el).find('.list').append(event_list);

		            			   });
		            		   }
		            		   else if(!App_Portlets.refetchEvents){
		            			   $(el).find('.events_show').append('<div class="portlet-calendar-error-message">No appointments for the day</div><div class="text-center"><a class="minical-portlet-event-add text-info" id='+date.getTime()+' data-date='+date.getTime()+'>+Add</a></div>');
		            		   }
		            	   }

	}); 


}

/** set up the library and gapi used to get google events from google calendar 
 * If calendar not available , returns.
 **/
function loadingGoogleEvents(el,startTime,endTime){

	$.getJSON('core/api/calendar-prefs/get', function(response)
			{
		if(response==undefined)
		{
			setTimeout(function(){
				if($(el).find('.list').find('li').length==0 && $(el).find('.portlet-calendar-error-message').length==0)
				{
					var date=new Date();
					$(el).find('.events_show').append('<div class="portlet-calendar-error-message">No appointments for the day</div><div class="text-center"><a class="minical-portlet-event-add text-info" id='+date.getTime()+' data-date='+date.getTime()+'>+Add</a></div>');
				}
			},5000);
			eraseCookie('current_date_calendar');
		}
		console.log(response);
		if (response)
		{
			if(typeof gapi != "undefined" && isDefined(gapi) && isDefined(gapi.client) && isDefined(gapi.client.calendar)) 
			{googledata(el,response,startTime,endTime);
			return;
			}


			head.js('https://apis.google.com/js/client.js', '/lib/calendar/gapi-helper.js', function()
					{
				setupGC(function()
						{

					googledata(el,response,startTime,endTime);
					return;
						});
					});
		}
			});

}

/**Initializes google Calendar **/
function init_cal(el){
	var fc = $.fullCalendar;
	fc.sourceFetchers = [];
	// Transforms the event sources to Google Calendar Events
	fc.sourceFetchers.push(function(sourceOptions, start, end) {
		if (sourceOptions.dataType == 'agile-events')
			loadingGoogleEvents(el,start.getTime()/1000,end.getTime()/1000);
	});

}
/**
 * Get the Google events from attached goodle calendar 
 */
function googledata(el,response,startTime,endTime)
{
	gapi.auth.setToken({ access_token : response.access_token, state : "https://www.googleapis.com/auth/calendar" });

	var current_date = new Date();
	var timezone_offset = current_date.getTimezoneOffset();
	var startDate = new Date((startTime * 1000)-(timezone_offset*60*1000));
	var gDateStart = startDate.toISOString();
	var endDate = new Date((endTime * 1000)-(timezone_offset*60*1000));
	var gDateEnd = endDate.toISOString();
	// Retrieve the events from primary
	var request = gapi.client.calendar.events
	.list({ 'calendarId' : 'primary', maxResults : 25, singleEvents : true, orderBy : 'startTime', timeMin : gDateStart, timeMax : gDateEnd });
	request.execute(function(resp)
			{
		var events = new Array();
		console.log(resp);
		for (var j = 0; j < resp.items.length; j++)
		{
			var fc_event = google2fcEvent(resp.items[j]);
			renderGoogleEvents(events,fc_event,el);


		}

		//**Add the google Events in the list of events in events_show div **/
		var len=$(".events_show").find('.list').find('li').length;
		var date=new Date();
		$.each(events,function(index,ev){
			var todayDate=new Date(date.getFullYear(), date.getMonth(), date.getDate(),00,00,00);
			var endDate=new Date(date.getFullYear(), date.getMonth(), date.getDate(),23,59,59);

			if(readCookie('current_date_calendar')!=null)
			{
				var cookie_date=new Date(readCookie('current_date_calendar'));
				todayDate=cookie_date;
				endDate=new Date(cookie_date.getFullYear(), cookie_date.getMonth(), cookie_date.getDate(),23,59,59);

			}
			if(ev.start.getTime() >= (todayDate.getTime()) && ev.start.getTime() <= (endDate.getTime())) 
			{	
				var event_list='<li class="p-t-xs p-r-xs" style="color:'+ev.color+'"><span style="color : #58666e" class="text-cap word-break"><a class="minical-portlet-event" id='+ev.id+' data-date='+date.getTime()+'>'+ev.title+'</a><br><small class="block m-t-n-xxs">'+ ev.start.format('HH:MM') + ' </small></span></li>';
				if(len!=0){
					$(el).find('.list').find('small').each(function( index ) 
							{
						if(ev.start.format('HH:MM')<$(this).text())
						{
							$(this).parents('li').before(event_list);
							return false;
						}

							});
				}
				else
					$(el).find('.list').append(event_list);
			}
		});
		eraseCookie('current_date_calendar');
		setTimeout(function(){
			//eraseCookie('current_date_calendar');
			if($(el).find('.list').find('li').length==0 && $(el).find('.portlet-calendar-error-message').length==0)
			{
				$(el).find('.events_show').append('<div class="portlet-calendar-error-message">No appointments for the day</div><div class="text-center"><a class="minical-portlet-event-add text-info" id='+date.getTime()+' data-date='+date.getTime()+'>+Add</a></div>');
			}
		},5000);


			});
}

/** Rendering the events to the mini Calendar
** Also all day events are broken into each day event to show on every day
*/
function renderGoogleEvents(events,fc_event,el)
{
	fc_event.startDate=new Date(fc_event.start);
			fc_event.end=new Date(fc_event.end);
			fc_event.color='#3a3f51';
			fc_event.backgroundColor='#3a3f51';
			if(fc_event.allDay==true){
				fc_event.start = new Date(fc_event.startDate.getTime()+fc_event.startDate.getTimezoneOffset()*60*1000);
				fc_event.end= new Date(new Date(fc_event.google.end.date).getTime()+fc_event.startDate.getTimezoneOffset()*60*1000);
				var a=(fc_event.end.getMonth()-fc_event.startDate.getMonth())+(fc_event.end.getDate()-fc_event.start.getDate());
				if(a==1)
				{
					fc_event.start=fc_event.start.getTime()/1000;
					fc_event.end=(fc_event.end.getTime()-1)/1000;
					$('#calendar_container',el).fullCalendar('renderEvent',fc_event);
					events.push(fc_event);
				}
				else
				{
					for(var i=0;i<a;i++){
						var new_json={};
						new_json=JSON.parse(JSON.stringify(fc_event));
						if(i==0){
							new_json.start=fc_event.start.getTime()/1000;
							new_json.end=new Date(fc_event.start.getFullYear(),fc_event.startDate.getMonth(),fc_event.startDate.getDate()+i,23,59,59).getTime()/1000;
						}
						else if(i<a){		
							new_json.start=new Date(fc_event.start.getFullYear(),fc_event.start.getMonth(),fc_event.start.getDate()+i,00,00,00).getTime()/1000;
							new_json.end=new Date(fc_event.start.getFullYear(),fc_event.start.getMonth(),fc_event.start.getDate()+i,23,59,59).getTime()/1000;
						}
						else{
							new_json.start=new Date(fc_event.start.getFullYear(),fc_event.start.getMonth(),fc_event.start.getDate()+i,00,00,00).getTime()/1000;
							new_json.end=fc_event.end.getTime()/1000;
						}
						console.log(new_json);
						$('#calendar_container',el).fullCalendar('renderEvent',new_json);
						events.push(new_json);
					}
				}

			} 
			else
			{
				var a=(fc_event.end.getMonth()-fc_event.startDate.getMonth())+(fc_event.end.getDate()-fc_event.startDate.getDate());

				if(a==0){
					fc_event.start=fc_event.startDate.getTime()/1000;
					fc_event.end=fc_event.end.getTime()/1000;
					$('#calendar_container',el).fullCalendar('renderEvent',fc_event);
					events.push(fc_event);
				}
				else{
					for(var i=0;i<=a;i++){
						var new_json={};
						new_json=JSON.parse(JSON.stringify(fc_event));
						if(i==0){
							new_json.start=fc_event.startDate.getTime()/1000;
							new_json.end=new Date(fc_event.startDate.getFullYear(),fc_event.startDate.getMonth(),fc_event.startDate.getDate()+i,23,59,59).getTime()/1000;
						}
						else if(i<a){		
							new_json.start=new Date(fc_event.startDate.getFullYear(),fc_event.startDate.getMonth(),fc_event.startDate.getDate()+i,00,00,00).getTime()/1000;
							new_json.end=new Date(fc_event.startDate.getFullYear(),fc_event.startDate.getMonth(),fc_event.startDate.getDate()+i,23,59,59).getTime()/1000;
						}
						else{
							new_json.start=new Date(fc_event.startDate.getFullYear(),fc_event.startDate.getMonth(),fc_event.startDate.getDate()+i,00,00,00).getTime()/1000;
							new_json.end=fc_event.end.getTime()/1000;
						}
						console.log(new_json);
						$('#calendar_container',el).fullCalendar('renderEvent',new_json);
						events.push(new_json);
					}
				}
			}
}
/*
 *  get the aspectratio(width/height) for minicalendar
 */
function getaspectratio(el)
{
	var width;
	var height;
	var dataSizeX=$(el).parent().attr('data-sizex');
	var dataSizeY=$(el).parent().attr('data-sizey');
	if(dataSizeX==1)
	{
		$(el).find('#calendar_container').css("padding","0px");
	}
	if(dataSizeX==2)
	{
		$(el).find('#calendar_container').css("padding","0px 50px 0px");

	}
	if(dataSizeX==3)
	{
		$(el).find('#calendar_container').css("padding","0px 100px 0px");

	}
	if(dataSizeY==1)
	{
		height=$(el).height()-25;
	}
	else if(dataSizeY==2){
		height=$(el).height()-200;
	}
	else
		height=$(el).height()-350;
	width=$(el).find('#calendar_container').width();
	return (width/height);
}/*
 * Appends the model (portlet) to its specific div, based on the portlet_type
 * as div id (div defined in portlet-add.html)
 */
function organize_portlets(base_model) {

	var itemView = new Base_List_View({
		model : base_model,
		template : this.options.templateKey + "-model",
		tagName : 'div',
		className : 'col-md-3 col-sm-6 col-xs'
	});

	// Get portlet type from model (portlet object)
	var portlet_type = base_model.get('portlet_type');

	/*
	 * Appends the model (portlet) to its specific div, based on the
	 * portlet_type as div id (div defined in portlet-add.html)
	 */
	var containerJSON = {
		"CONTACTS" : "contacts",
		"DEALS" : "deals",
		"TASKSANDEVENTS" : "taksAndEvents",
		"USERACTIVITY" : "userActivity",
		"RSS" : "rssFeed",
		"ACCOUNT" : "accountInfo"
	};

	// Append Item View
	$('#' + containerJSON[portlet_type], this.el).append(
			$(itemView.render().el));
}

/*
 * Appends the outer view and inner view of each portlet.
 */
function set_p_portlets(base_model) {

	var that = this;
	portlet_utility.getOuterViewOfPortlet(base_model, this.el, function() {
		portlet_utility.getInnerViewOfPortlet(base_model, that.el);
	});

}

/*
 * Sets the portlet content height based on it's size-y attribute.
 */
function setPortletContentHeight(base_model) {
	if (base_model.get("name") == "Stats Report") {

		var $resize_ele = $('#' + base_model.get("id")).parent().find(
				'.stats_report_portlet');
		var size_y = base_model.get("size_y"), resized_val = 0;

		if (size_y == 1) {
			resized_val = (size_y * 200);
		} else if (size_y == 2) {
			resized_val = (size_y * 200) + 10;
		} else if (size_y == 3) {
			resized_val = (size_y * 200) + 20;
		}

		var css = {
			"overflow-x" : "hidden",
			"overflow-y" : "hidden",
			"height" : resized_val + "px",
			"max-height" : resized_val + "px"
		}

		$resize_ele.css(css);

	} else if (base_model.get("name") == "Mini Calendar") {

		var $resize_ele = $('#' + base_model.get("id")).parent().find(
				'.portlet_body_calendar');
		var size_y = base_model.get("size_y"), resized_val = 0;

		if (size_y == 1) {
			resized_val = (size_y * 200);
		} else if (size_y == 2) {
			resized_val = (size_y * 200) + 25;
		} else if (size_y == 3) {
			resized_val = (size_y * 200) + 50;
		}

		var css = {
			"height" : resized_val + "px",
			"max-height" : resized_val + "px"
		}

		$resize_ele.css(css);
	} else {

		var $resize_ele = $('#' + base_model.get("id")).parent().find(
				'.portlet_body');
		var size_y = base_model.get("size_y"), resized_val = 0;

		if (size_y == 1) {
			resized_val = (size_y * 200) - 45;
		} else if (size_y == 2) {
			resized_val = (size_y * 200) + 25 - 45;
		} else if (size_y == 3) {
			resized_val = (size_y * 200) + 50 - 45;
		}

		var css = {
			"overflow-x" : "hidden",
			"overflow-y" : "auto",
			"height" : resized_val + "px",
			"max-height" : resized_val + "px"
		}

		$resize_ele.css(css);
	}

}

/*
 * Appends the activity to activity portlet.
 */
function append_activity(base_model) {

	var itemView = new Base_List_View({
		model : base_model,
		"view" : "inline",
		template : this.options.templateKey + "-model"
	});

	// add to the right box - overdue, today, tomorrow etc.
	var createdtime = get_activity_created_time(base_model.get('time'));

	// Today
	if (createdtime == 0) {
		$('#earllier', this.el).show();

		var $todayActivityEle = $('#today-activity', this.el);

		$todayActivityEle.append(itemView.render().el);
		$todayActivityEle.parent('table').css("display", "block");
		$todayActivityEle.show();

		$('#today-heading', this.el).show();
	}

	if (createdtime == -1) {
		$('#earllier', this.el).show();

		var heading = $('#tomorrow-heading', this.el);
		var $tomorrowActivityEle = $('#tomorrow-activity', this.el);

		$tomorrowActivityEle.append(itemView.render().el);
		$tomorrowActivityEle.parent('table').css("display", "block");
		$tomorrowActivityEle.show();

		heading.show();
	}

	if (createdtime < -1) {
		var $nextWeekActivityEle = $('#next-week-activity', this.el);

		$nextWeekActivityEle.append(itemView.render().el);
		$nextWeekActivityEle.parent('table').css("display", "block");
		$nextWeekActivityEle.show();
		$('#next-week-heading', this.el).show();

	}

	if($('#tomorrow-heading', this.el).css('display')=="none" && $('#today-heading', this.el).css('display')=="none")
		$('#next-week-heading', this.el).hide();
}var portlet_utility = {

	/**
	 * Adding deal tracks to Track option in deals funnel and deals by milestone
	 * portlets.
	 */
	addTracks : function(tracks, base_model, elData) {
		var options = '';
		var deal_track = base_model.get('settings').track;
		$.each(tracks,
				function(index, trackObj) {
					if (deal_track == 0 && trackObj.name == "Default")
						options += "<option value=" + trackObj.id
								+ " selected='selected'>" + trackObj.name
								+ "</option>";
					else if (deal_track == trackObj.id)
						options += "<option value=" + trackObj.id
								+ " selected='selected'>" + trackObj.name
								+ "</option>";
					else
						options += "<option value=" + trackObj.id + ">"
								+ trackObj.name + "</option>";
				});

		$('#track', elData).html(options);
		$('.loading-img').hide();
		$("#deals", elData).find(
				'option[value=' + base_model.get("settings").deals + ']').attr(
				"selected", "selected");
	},

	/**
	 * getting filtered contact portlet header name
	 */
	get_filtered_contact_header : function(base_model, callback) {

		if (base_model.get("settings").filter == 'contacts')
			return callback("All Contacts");
		else if (base_model.get("settings").filter == 'companies')
			return callback("All Companies");
		else if (base_model.get("settings").filter == 'recent')
			return callback = "Recent Contacts";
		else if (base_model.get("settings").filter == 'myContacts')
			return callback("My Contacts");
		else if (base_model.get("settings").filter == 'leads')
			return callback("Leads");
		else {

			var contactFilter = $.ajax({
				type : 'GET',
				url : '/core/api/filters/' + base_model.get("settings").filter,
				dataType : 'json',
				success : function(data) {
					var header_name = '';
					if (data != null && data != undefined)
						header_name = "" + data.name;

					if (!header_name) {
						header_name = "Contact List";
					}

					return callback(header_name);

				}
			});
		}

	},

	/**
	 * getting deals funnel portlet header name
	 */
	get_deals_funnel_portlet_header : function(base_model, callback) {

		var track_id = base_model.get("settings").track;

		App_Portlets.track_length = 0;
		$.ajax({
			type : 'GET',
			url : '/core/api/milestone/pipelines',
			dataType : 'json',
			success : function(data) {
				App_Portlets.track_length = data.length;
				App_Portlets.deal_tracks = data;

				if (App_Portlets.track_length > 1) {
					if (track_id == 0)
						return callback("Default");
					else {
						var milestone = $.ajax({
							type : 'GET',
							url : '/core/api/milestone/' + track_id,
							dataType : 'json',
							success : function(data) {
								if (data != null && data != undefined)
									return callback("" + data.name + "");
							}
						});
					}
				}

			}
		});

	},

	/**
	 * getting campaign_type for campaign portlet header
	 */
	get_campaign_stats_portlet_header : function(base_model, callback) {
		var campaign_id = base_model.get("settings").campaign_type;

		if (campaign_id == 'All')
			return callback('All Campaigns');
		else {
			var campaign = $.ajax({
				type : 'GET',
				url : '/core/api/workflows/' + campaign_id,
				dataType : 'json',
				success : function(data) {
					if (data)
						return callback("" + data.name);
				}
			});
		}
	},

	/**
	 * getting default portlet settings for all portlets
	 */
	getDefaultPortletSettings : function(portlet_type, p_name) {

		var json = {};
		if (portlet_type == "CONTACTS" && p_name == "Filter Based")
			json['filter'] = "myContacts";
		else if (portlet_type == "CONTACTS" && p_name == "Emails Opened")
			json['duration'] = "2-days";
		else if (portlet_type == "USERACTIVITY" && p_name == "Emails Sent")
			json['duration'] = "1-day";
		else if (portlet_type == "CONTACTS" && p_name == "Growth Graph") {
			json['tags'] = "";
			json['frequency'] = 'daily';
			json['duration'] = "1-week";
		} else if (portlet_type == "DEALS" && p_name == "Pending Deals") {
			json['deals'] = "my-deals";
		} else if (portlet_type == "DEALS"
				&& (p_name == "Deals By Milestone" || p_name == "Deals Funnel")) {
			json['deals'] = "my-deals";
			json['track'] = 0;
		} else if (portlet_type == "DEALS" && p_name == "Closures Per Person") {
			json['group-by'] = "number-of-deals";
			json['due-date'] = Math.round((new Date()).getTime() / 1000);
		} else if (portlet_type == "DEALS" && p_name == "Deals Won")
			json['duration'] = "1-week";
		else if (portlet_type == "DEALS" && p_name == "Deals Assigned")
			json['duration'] = "1-day";
		else if (portlet_type == "USERACTIVITY" && p_name == "Calls Per Person") {
			json['group-by'] = "number-of-calls";
			json['duration'] = "1-day";
		} else if (portlet_type == "TASKSANDEVENTS" && p_name == "Task Report") {
			json['group-by'] = "user";
			json['split-by'] = "category";
			json['duration'] = "1-week";
			json['tasks'] = "all-tasks";
		} else if (portlet_type == "USERACTIVITY" && p_name == "Stats Report") {
			json['duration'] = "yesterday";
		} else if (portlet_type == "TASKSANDEVENTS"
				&& (p_name == "Agenda" || p_name == "Today Tasks"))
			json['duration'] = "today-and-tomorrow";
		else if (portlet_type == "USERACTIVITY" && p_name == "Leaderboard") {
			json['duration'] = "this-month";
			var categoryJson = {};
			categoryJson['revenue'] = true;
			categoryJson['dealsWon'] = true;
			categoryJson['calls'] = true;
			categoryJson['tasks'] = true;
			json['category'] = categoryJson;
		} else if (portlet_type == "DEALS" && p_name == "Revenue Graph") {
			json['duration'] = "this-quarter";
			json['track'] = "anyTrack";
		} else if (portlet_type == "USERACTIVITY" && p_name == "Campaign stats") {
			json['duration'] = "yesterday";
			json['campaign_type'] = "All";
		}
		return json;
	},

	/**
	 * Getting start and end dates as string to get start and end epoch times
	 */
	getStartAndEndDurations : function(base_model, callback) {
		var durationJson = {};
		if (!base_model.get('settings')) {
			return;
		}
		var duration = base_model.get('settings').duration;

		durationJson['start_date_str'] = ''
				+ base_model.get('settings').duration;
		durationJson['end_date_str'] = '' + base_model.get('settings').duration;

		if (duration == 'yesterday') {
			durationJson['end_date_str'] = 'today';
		} else if (duration == 'this-week') {
			durationJson['end_date_str'] = 'this-week-end';
		} else if (duration == 'this-month') {
			durationJson['end_date_str'] = 'this-month-end';
		} else if (duration == 'next-7-days') {
			durationJson['start_date_str'] = 'TOMORROW';
		} else if (duration == 'today-and-tomorrow') {
			durationJson['start_date_str'] = 'today';
		} else if (duration == 'last-week') {
			durationJson['end_date_str'] = 'last-week-end';
		} else if (duration == 'last-month') {
			durationJson['end_date_str'] = 'last-month-end';
		} else if (duration == '24-hours') {
			durationJson['end_date_str'] = 'now';
		} else if (duration == 'today' || duration == '1-day' || duration == '2-days' || duration == '1-week' || duration == '1-month' || duration == 'all-over-due') {
			durationJson['end_date_str'] = 'TOMORROW';
		} else {
			durationJson['start_date_str'] = ''
				+ base_model.get('settings').duration + '-start';
			durationJson['end_date_str'] = '' + base_model.get('settings').duration + '-end';
		}

		return callback(durationJson);
	},

	/**
	 * To format portlet duration (ex: last-week as Last Week)
	 */
	getDurationForPortlets : function(duration, callback) {
		var time_period = 'Today';
		if (duration == 'yesterday') {
			time_period = 'Yesterday';
		} else if (duration == '1-day' || duration == 'today') {
			time_period = 'Today';
		} else if (duration == '2-days') {
			time_period = 'Last 2 Days';
		} else if (duration == 'this-week') {
			time_period = 'This Week';
		} else if (duration == 'last-week') {
			time_period = 'Last Week';
		} else if (duration == '1-week') {
			time_period = 'Last 7 Days';
		} else if (duration == 'this-month') {
			time_period = 'This Month';
		} else if (duration == 'last-month') {
			time_period = 'Last Month';
		} else if (duration == '1-month') {
			time_period = 'Last 30 Days';
		} else if (duration == 'this-quarter') {
			time_period = 'This Quarter';
		} else if (duration == 'last-quarter') {
			time_period = 'Last Quarter';
		} else if (duration == '3-months') {
			time_period = 'Last 3 Months';
		} else if (duration == '6-months') {
			time_period = 'Last 6 Months';
		} else if (duration == '12-months') {
			time_period = 'Last 12 Months';
		} else if (duration == 'today-and-tomorrow') {
			time_period = 'Today and Tomorrow';
		} else if (duration == 'all-over-due') {
			time_period = 'All Over Due';
		} else if (duration == 'next-7-days') {
			time_period = 'Next 7 Days';
		} else if (duration == '24-hours') {
			time_period = 'Last 24 Hours';
		}

		return callback(time_period);
	},

	/**
	 * To get outer view of each portlet, it is calling from set_p_portlets()
	 */
	getOuterViewOfPortlet : function(base_model, el, callback) {
		var templates_json = {
			"Filter Based" : "portlets-contacts-filterbased",
			"Emails Opened" : "portlets-contacts-emails-opened",
			"Emails Sent" : "portlets-contacts-emails-sent",
			"Growth Graph" : "portlets-contacts-growth-graph",
			"Pending Deals" : "portlets-deals-pending-deals",
			"Deals By Milestone" : "portlets-deals-deals-by-milestone",
			"Closures Per Person" : "portlets-deals-closures-per-person",
			"Deals Won" : "portlets-deals-deals-won",
			"Deals Funnel" : "portlets-deals-deals-funnel",
			"Deals Assigned" : "portlets-deals-deals-assigned",
			"Agenda" : "portlets-tasksandevents-agenda",
			"Today Tasks" : "portlets-tasksandevents-today-tasks",
			"Calls Per Person" : "portlets-contacts-calls-per-person",
			"Agile CRM Blog" : "portlets-useractivity-blog",
			"Task Report" : "portlets-tasksandevents-task-report",
			"Stats Report" : "portlets-status-report",
			"Onboarding" : "portlets-user-onboarding",
			"Leaderboard" : "portlets-leader-board",
			"Revenue Graph" : "portlets-deals-revenue-graph",
			"Account Details" : "portlets-account",
			"Mini Calendar" : "portlets-minicalendar",
			"User Activities" : "portlets-activites",
			"Campaign stats" : "portlets-campaign-stats-report"
		};
		var templateKey = templates_json[base_model.get('name')];
		if (CURRENT_DOMAIN_USER.is_admin
				&& base_model.get('name') == "Onboarding") {
			templateKey = "portlets-admin-onboarding";
		}
		var that = this;
		App_Portlets.portletOuterView = new Base_Model_View({
			model : base_model,
			template : templateKey + '-model',
			tagName : 'div',
			postRenderCallback : function(ele) {
				that.invokeOuterViewCallback(base_model, ele);
			}
		});

		var column_position = base_model.get("column_position");
		var row_position = base_model.get("row_position");
		var size_x = base_model.get("size_x");
		var size_y = base_model.get("size_y");

		if ($('.gridster > div:visible > div', el).length == 0)
			$('.gridster > div:visible', el).html(
					$(App_Portlets.portletOuterView.render().el).attr(
							"id",
							"ui-id-" + column_position + "-"
									+ row_position).attr(
							"data-sizey", size_y).attr(
							"data-sizex", size_x).attr(
							"data-col", column_position)
							.attr("data-row", row_position)
							.addClass('gs-w panel panel-default'));
		else
			$('.gridster > div:visible > div:last', el).after(
					$(App_Portlets.portletOuterView.render().el).attr(
							"id",
							"ui-id-" + column_position + "-"
									+ row_position).attr(
							"data-sizey", size_y).attr(
							"data-sizex", size_x).attr(
							"data-col", column_position)
							.attr("data-row", row_position)
							.addClass('gs-w panel panel-default'));

		return callback();

	},

	/**
	 * To invoke outer view of post render call back method of each portlet
	 */
	invokeOuterViewCallback : function(base_model, el) {
		var that = this;
		switch (base_model.get('name')) {
		case "Filter Based": {
			that.get_filtered_contact_header(base_model, function(header_name) {
				$(el).find(".flitered_contact_portlet_header")
						.html(header_name);
			});
			break;
		}
		case "Deals By Milestone": {
			that.get_deals_funnel_portlet_header(base_model, function(
					header_name) {
				$(el).find(".deals_funnel_portlet_header").html(header_name);
			});
			break;
		}
		case "Deals Funnel": {
			that.get_deals_funnel_portlet_header(base_model, function(
					header_name) {
				$(el).find(".deals_funnel_portlet_header").html(header_name);
			});
			break;
		}
		case "Campaign stats": {
			that.get_campaign_stats_portlet_header(base_model, function(
					header_name) {
				$(el).find(".campaign_stats_header").html(header_name);
			});
			break;
		}
		case "Stats Report": {
			$(el).find('.stats_report_portlet_body').parent().css('background',
					'#f0f3f4');
			break;
		}
		case "User Activities" : {
			var pos = base_model.get("column_position")+''+base_model.get("row_position");
			App_Portlets.activitiesView[parseInt(pos)] = el;
			break;
		}
		}
	},

	/**
	 * To get inner view of each portlet, it is calling from set_p_portlets()
	 */
	getInnerViewOfPortlet : function(base_model, el) {
		var column_position = base_model.get('column_position'), row_position = base_model
				.get('row_position');
		var pos = '' + column_position + '' + row_position;
		var portlet_name = base_model.get('name'), portlet_ele = $(
				'#ui-id-' + column_position + '-' + row_position, el).find(
				'.portlet_body');
		portlet_ele
				.attr('id', 'p-body-' + column_position + '-' + row_position);
		var start_date_str = '', end_date_str = '', users = '', selector = portlet_ele
				.attr('id');
		;

		portlet_utility.getStartAndEndDurations(base_model, function(
				durationJson) {
			start_date_str = durationJson['start_date_str'];
			end_date_str = durationJson['end_date_str'];
		});

		if (base_model.get('settings') && base_model.get('settings').user != undefined) {
			users = JSON.stringify(base_model.get('settings').user);
		}

		switch (portlet_name) {
		case "Filter Based": {
			App_Portlets.filteredContacts[parseInt(pos)] = new Base_Collection_View(
					{
						url : '/core/api/portlets/portletContacts?filter='
								+ base_model.get('settings').filter
								+ '&sortKey=-created_time',
						templateKey : "portlets-contacts",
						sort_collection : false,
						individual_tag_name : 'tr',
						sortKey : "-created_time",
						postRenderCallback : function(p_el) {
							portlet_utility.addWidgetToGridster(base_model);
						}
					});
			portlet_utility.renderPortletsInnerCollection(
					App_Portlets.filteredContacts[parseInt(pos)], portlet_ele,
					base_model);
			break;
		}
		case "Emails Opened": {
			App_Portlets.emailsOpened[parseInt(pos)] = new Base_Collection_View(
					{
						url : '/core/api/portlets/portletEmailsOpened?duration='
								+ base_model.get('settings').duration
								+ '&start-date='
								+ portlet_utility
										.getStartAndEndDatesOnDue(start_date_str)
								+ '&end-date='
								+ portlet_utility
										.getStartAndEndDatesOnDue(end_date_str),
						templateKey : 'portlets-contacts-email-opens',
						sort_collection : false,
						individual_tag_name : 'tr',
						postRenderCallback : function(p_el) {
							head.js(LIB_PATH + 'lib/jquery.timeago.js', function() {
								$(".time-ago", p_el).timeago();
							});
							portlet_utility.addWidgetToGridster(base_model);
						}
					});
			App_Portlets.emailsOpened[parseInt(pos)].collection.fetch();
			portlet_ele.find('#emails-opened-contacts-list').attr(
					'id',
					'emails-opened-contacts-list-' + column_position + '-'
							+ row_position);
			portlet_ele.find(
					'#emails-opened-contacts-list-' + column_position + '-'
							+ row_position).html(getRandomLoadingImg());
			portlet_ele.find(
					'#emails-opened-contacts-list-' + column_position + '-'
							+ row_position).html(
					$(App_Portlets.emailsOpened[parseInt(pos)].render().el));
			portlet_ele.find('#emails-opened-pie-chart').attr(
					'id',
					'emails-opened-pie-chart-' + column_position + '-'
							+ row_position);
			selector = 'emails-opened-pie-chart-' + column_position + '-'
					+ row_position;
			var url = '/core/api/portlets/portletEmailsOpenedPie?duration='
					+ base_model.get('settings').duration + '&start-date='
					+ portlet_utility.getStartAndEndDatesOnDue(start_date_str)
					+ '&end-date='
					+ portlet_utility.getStartAndEndDatesOnDue(end_date_str);
			portlet_graph_data_utility.emailsOpenedGraphData(base_model,
					selector, url);
			setPortletContentHeight(base_model);
			break;
		}
		case "Pending Deals": {
			App_Portlets.pendingDeals[parseInt(pos)] = new Base_Collection_View(
					{
						url : '/core/api/portlets/portletPendingDeals?deals='
								+ base_model.get('settings').deals,
						templateKey : 'portlets-opportunities',
						sort_collection : false,
						individual_tag_name : 'tr',
						postRenderCallback : function(p_el) {
							head.js(LIB_PATH + 'lib/jquery.timeago.js', function() {
								$(".time-ago", p_el).timeago();
							});
							portlet_utility.addWidgetToGridster(base_model);
						}
					});
			portlet_utility.renderPortletsInnerCollection(
					App_Portlets.pendingDeals[parseInt(pos)], portlet_ele,
					base_model);
			break;
		}
		case "Deals Won": {
			App_Portlets.dealsWon[parseInt(pos)] = new Base_Collection_View({
				url : '/core/api/portlets/portletDealsWon?duration='
						+ base_model.get('settings').duration,
				templateKey : 'portlets-opportunities',
				individual_tag_name : 'tr',
				postRenderCallback : function(p_el) {
					head.js(LIB_PATH + 'lib/jquery.timeago.js', function() {
						$(".time-ago", p_el).timeago();
					});
					portlet_utility.addWidgetToGridster(base_model);
				}
			});
			portlet_utility.renderPortletsInnerCollection(
					App_Portlets.dealsWon[parseInt(pos)], portlet_ele,
					base_model);
			break;
		}
		case "Agenda": {
			App_Portlets.todayEventsCollection[parseInt(pos)] = new Base_Collection_View(
					{
						url : '/core/api/portlets/portletAgenda?duration='
								+ base_model.get('settings').duration
								+ '&start_time='
								+ portlet_utility
										.getStartAndEndDatesOnDue(start_date_str)
								+ '&end_time='
								+ portlet_utility
										.getStartAndEndDatesOnDue(end_date_str),
						templateKey : 'portlets-events',
						sort_collection : false,
						individual_tag_name : 'tr',
						postRenderCallback : function(p_el) {
							portlet_utility.addWidgetToGridster(base_model);
							loadGoogleEventsForPortlets(
									p_el,
									portlet_utility
											.getStartAndEndDatesOnDue(start_date_str),
									portlet_utility
											.getStartAndEndDatesOnDue(end_date_str));
						}
					});
			portlet_utility.renderPortletsInnerCollection(
					App_Portlets.todayEventsCollection[parseInt(pos)],
					portlet_ele.find('#normal-events'), base_model);
			break;
		}
		case "Today Tasks": {
			App_Portlets.tasksCollection[parseInt(pos)] = new Base_Collection_View(
					{
						url : '/core/api/portlets/portletTodayTasks?duration='
								+ base_model.get('settings').duration
								+ '&start_time='
								+ portlet_utility
										.getStartAndEndDatesOnDue(start_date_str)
								+ '&end_time='
								+ portlet_utility
										.getStartAndEndDatesOnDue(end_date_str),
						templateKey : 'portlets-tasks',
						sort_collection : false,
						individual_tag_name : 'tr',
						postRenderCallback : function(p_el) {
							portlet_utility.addWidgetToGridster(base_model);
						}
					});
			portlet_utility.renderPortletsInnerCollection(
					App_Portlets.tasksCollection[parseInt(pos)], portlet_ele,
					base_model);
			break;
		}
		case "Leaderboard": {
			var leaderboardCate = base_model.get('settings').category;

			App_Portlets.leaderboard[parseInt(pos)] = new Base_Model_View(
					{
						url : '/core/api/portlets/portletLeaderboard?duration='
								+ base_model.get('settings').duration
								+ '&start-date='
								+ portlet_utility
										.getStartAndEndDatesOnDue(start_date_str)
								+ '&end-date='
								+ portlet_utility
										.getStartAndEndDatesOnDue(end_date_str)
								+ '&revenue='
								+ leaderboardCate.revenue
								+ '&dealsWon='
								+ leaderboardCate.dealsWon
								+ '&calls='
								+ leaderboardCate.calls
								+ '&tasks='
								+ leaderboardCate.tasks
								+ '&user=' + users,
						template : 'portlets-leader-board-body-model',
						tagName : 'div',
						portletSizeX : base_model.get('size_x'),
						portletSizeY : base_model.get('size_y'),
						postRenderCallback : function(p_el) {
							portlet_utility.addWidgetToGridster(base_model);
							$(
									'#ui-id-' + column_position + '-'
											+ row_position
											+ ' > .portlet_header')
									.find('ul')
									.width(
											($(
													'#ui-id-'
															+ column_position
															+ '-'
															+ row_position
															+ ' > .portlet_body')
													.find('ul').width()
													/ $(
															'#ui-id-'
																	+ column_position
																	+ '-'
																	+ row_position
																	+ ' > .portlet_body')
															.width() * 100)
													+ '%');
						}
					});
			portlet_ele
					.html($(App_Portlets.leaderboard[parseInt(pos)].render().el));
			setPortletContentHeight(base_model);
			break;
		}
		case "Account Details": {
			App_Portlets.accountInfo[parseInt(pos)] = new Base_Model_View({
				url : '/core/api/portlets/portletAccount',
				template : "portlets-account-body-model",
				postRenderCallback : function(p_el) {
					portlet_utility.addWidgetToGridster(base_model);
				}
			});
			portlet_ele.html(getRandomLoadingImg());
			portlet_ele
					.html($(App_Portlets.accountInfo[parseInt(pos)].render().el));
			setPortletContentHeight(base_model);
			break;
		}
		case "User Activities": {
			App_Portlets.activity[parseInt(pos)] = new Base_Collection_View({
				url : '/core/api/portlets/portletCustomerActivity',
				sortKey : 'time',
				descending : true,
				templateKey : "portlets-activities-list-log",
				cursor : true,
				page_size : 20,
				individual_tag_name : 'div',
				postRenderCallback : function(p_el) {
					portlet_utility.addWidgetToGridster(base_model);

					head.js(LIB_PATH + 'lib/jquery.timeago.js', function() {
						$("time", p_el).timeago();

					});
					contact_detail_page_infi_scroll($('.activity_body',
							App_Portlets.activitiesView[parseInt(pos)].el),
							App_Portlets.activity[parseInt(pos)])
				},
				appendItemCallback : function(p_el) {
					includeTimeAgo(p_el);
				}
			});
			App_Portlets.activity[parseInt(pos)].appendItem = append_activity;
			portlet_utility.renderPortletsInnerCollection(
					App_Portlets.activity[parseInt(pos)], portlet_ele,
					base_model);
			break;
		}
		case "Campaign stats": {
			var emailsSentCount, emailsOpenedCount, emailsClickedCount, emailsUnsubscribed, that = portlet_ele;
			var url = '/core/api/portlets/portletCampaignstats?duration='
					+ base_model.get('settings').duration + '&start-date='
					+ portlet_utility.getStartAndEndDatesOnDue(start_date_str)
					+ '&end-date='
					+ portlet_utility.getStartAndEndDatesOnDue(end_date_str)
					+ '&time_zone=' + (new Date().getTimezoneOffset())
					+ '&campaign_type='
					+ base_model.get('settings').campaign_type;

			setTimeout(
					function() {
						if (that.find('#emails-sent-count').text().trim() == "")
							that
									.find('#emails-sent-count')
									.html(
											"<img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' />");
					}, 1000);

			portlet_graph_data_utility
					.fetchPortletsGraphData(
							url,
							function(data) {
								emailsSentCount = data["emailsent"];
								emailsOpenedCount = data["emailopened"];
								emailsClickedCount = data["emailclicked"];
								emailsUnsubscribed = data["emailunsubscribed"];
								if (emailsSentCount == 0) {
									that.find('#emails-sent').css('width',
											'100%').css('height', '100%');
									that
											.find('#emails-sent')
											.html(
													'<div class="portlet-error-message">No Email activity</div>');
								} else {
									that
											.find('#emails-opened')
											.css('display', 'block')
											.addClass(
													'pull-left p-xs b-b b-light w-half');
									that
											.find('#emails-clicked')
											.css('display', 'block')
											.addClass(
													'pull-left p-xs b-r b-light w-half');
									that.find('#emails-unsubscribed').css(
											'display', 'block').addClass(
											'pull-left p-xs w-half');
									that
											.find('#emails-sent')
											.addClass(
													'pull-left p-xs b-b b-r b-light w-half overflow-hidden');

									that
											.find('#emails-sent-count')
											.text(
													portlet_utility
															.getNumberWithCommasForPortlets(emailsSentCount));
									that.find('#emails-sent-label').text(
											"Emails sent");
									that
											.find('#emails-opened')
											.html(
													'<div class="pull-left text-light stats_text"><div class="text-sm text-ellipsis">Opened</div><div class="text-count text-center" style="color:rgb(250, 215, 51);">'
															+ portlet_utility
																	.getNumberWithCommasForPortlets(emailsOpenedCount)
															+ '</div></div>');
									that
											.find('#emails-clicked')
											.html(
													'<div class="pull-left text-light stats_text"><div class="text-sm text-ellipsis">Clicked</div><div class="text-count text-center" style="color:rgb(18, 209, 18);">'
															+ portlet_utility
																	.getNumberWithCommasForPortlets(emailsClickedCount)
															+ '</div></div>');
									that
											.find('#emails-unsubscribed')
											.html(
													'<div class="pull-left text-light stats_text"><div class="text-sm text-ellipsis">Unsubscribed</div><div class="text-count text-center" style="color:rgb(240, 80, 80);">'
															+ portlet_utility
																	.getNumberWithCommasForPortlets(emailsUnsubscribed)
															+ '</div>');
								}

								portlet_utility.addWidgetToGridster(base_model);
							});
			setPortletContentHeight(base_model);
			break;
		}
		case "Deals By Milestone": {
			var url = '/core/api/portlets/portletDealsByMilestone?deals='
					+ base_model.get('settings').deals + '&track='
					+ base_model.get('settings').track;
			portlet_graph_data_utility.dealsByMilestoneGraphData(base_model,
					selector, url);
			setPortletContentHeight(base_model);
			break;
		}
		case "Closures Per Person": {
			var url = '/core/api/portlets/portletClosuresPerPerson?due-date='
					+ base_model.get('settings')["due-date"];
			portlet_graph_data_utility.closuresPerPersonGraphData(base_model,
					selector, url);
			setPortletContentHeight(base_model);
			break;
		}
		case "Deals Funnel": {
			var url = '/core/api/portlets/portletDealsFunnel?deals='
					+ base_model.get('settings').deals + '&track='
					+ base_model.get('settings').track;
			portlet_graph_data_utility.dealsFunnelGraphData(base_model,
					selector, url);
			setPortletContentHeight(base_model);
			break;
		}
		case "Emails Sent": {
			var url = '/core/api/portlets/portletEmailsSent?duration='
					+ base_model.get('settings').duration;
			portlet_graph_data_utility.emailsSentGrapgData(base_model,
					selector, url);
			setPortletContentHeight(base_model);
			break;
		}
		case "Growth Graph": {
			var url = '/core/api/portlets/portletGrowthGraph?tags='
					+ base_model.get('settings').tags
					+ '&frequency='
					+ base_model.get('settings').frequency
					+ '&duration='
					+ base_model.get('settings').duration
					+ '&start-date='
					+ getUTCMidNightEpochFromDate(new Date(portlet_utility
							.getStartAndEndDatesOnDue(base_model
									.get('settings').duration) * 1000))
					+ '&end-date='
					+ getUTCMidNightEpochFromDate(new Date(portlet_utility
							.getStartAndEndDatesOnDue("TOMORROW") * 1000));
			portlet_graph_data_utility.growthGraphData(base_model, selector,
					url);
			setPortletContentHeight(base_model);
			// Saved tags are appended
			var p_settings = base_model.get('settings');
			var p_tags = p_settings.tags;
			var tags = p_tags.split(",");
			var li = '';
			$
					.each(
							tags,
							function(index, tagName) {
								if (tagName != "")
									li += "<li data='"
											+ tagName
											+ "' class='tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block'>"
											+ tagName
											+ "<a id='remove_tag' class='close m-l-xs'>&times</a></li>";
							});
			$('#' + base_model.get("id") + '-portlet-ul-tags').append(li);

			// enable tags properties
			setup_tags_typeahead();
			break;
		}
		case "Deals Assigned": {
			var url = '/core/api/portlets/portletDealsAssigned?duration='
					+ base_model.get('settings').duration;
			portlet_graph_data_utility.dealsAssignedGraphData(base_model,
					selector, url);
			setPortletContentHeight(base_model);
			break;
		}
		case "Calls Per Person": {
			if (base_model.get('settings')["calls-user-list"] != undefined) {
				users = JSON
						.stringify(base_model.get('settings')["calls-user-list"]);
			}
			var url = '/core/api/portlets/portletCallsPerPerson?duration='
					+ base_model.get('settings').duration + '&start-date='
					+ portlet_utility.getStartAndEndDatesOnDue(start_date_str)
					+ '&end-date='
					+ portlet_utility.getStartAndEndDatesOnDue(end_date_str)
					+ '&user=' + users;
			portlet_graph_data_utility.callsPerPersonGraphData(base_model,
					selector, url);
			setPortletContentHeight(base_model);
			break;
		}
		case "Agile CRM Blog": {
			portlet_ele.find('div').html(getRandomLoadingImg());
			initBlogPortletSync(portlet_ele);
			setPortletContentHeight(base_model);
			break;
		}
		case "Task Report": {
			if (base_model.get('settings')["task-report-user-list"] != undefined) {
				users = JSON
						.stringify(base_model.get('settings')["task-report-user-list"]);
			}
			var url = '/core/api/portlets/portletTaskReport?group-by='
					+ base_model.get('settings')["group-by"] + '&split-by='
					+ base_model.get('settings')["split-by"] + '&start-date='
					+ portlet_utility.getStartAndEndDatesOnDue(start_date_str)
					+ '&end-date='
					+ portlet_utility.getStartAndEndDatesOnDue(end_date_str)
					+ '&tasks=' + base_model.get('settings').tasks + '&user='
					+ users;
			portlet_graph_data_utility.taskReportGraphData(base_model,
					selector, url);
			setPortletContentHeight(base_model);
			break;
		}
		case "Revenue Graph": {
			var pipeline_id = 0;
			if (base_model.get('settings').track != undefined
					&& base_model.get('settings').track != "anyTrack") {
				pipeline_id = base_model.get('settings').track;
			}
			var url = 'core/api/opportunity/stats/details/'
					+ pipeline_id
					+ '?min='
					+ portlet_utility.getStartAndEndDatesOnDue(start_date_str)
					+ '&max='
					+ (portlet_utility.getStartAndEndDatesOnDue(end_date_str) - 1)
					+ '';
			portlet_graph_data_utility.revenueGraphData(base_model, selector,
					url);
			setPortletContentHeight(base_model);
			break;
		}
		case "Stats Report": {
			portlet_ele = $('#ui-id-' + column_position + '-' + row_position,
					el).find('.stats_report_portlet_body');
			var that = portlet_ele;
			var newContactsurl = '/core/api/portlets/portletStatsReport?reportType=newContacts&duration='
					+ base_model.get('settings').duration
					+ '&start-date='
					+ portlet_utility.getStartAndEndDatesOnDue(start_date_str)
					+ '&end-date='
					+ portlet_utility.getStartAndEndDatesOnDue(end_date_str)
					+ '&time_zone=' + (new Date().getTimezoneOffset());
			setTimeout(
					function() {
						if (that.find('#new-contacts-count').text().trim() == "")
							that
									.find('#new-contacts-count')
									.html(
											"<img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' />");
					}, 1000);
			portlet_graph_data_utility
					.fetchPortletsGraphData(
							newContactsurl,
							function(data) {
								that
										.find('#new-contacts-count')
										.text(
												portlet_utility
														.getNumberWithCommasForPortlets(data["newContactsCount"]));
								that.find('#new-contacts-label').text(
										"New contacts");
							});

			var wonDealsurl = '/core/api/portlets/portletStatsReport?reportType=wonDeals&duration='
					+ base_model.get('settings').duration
					+ '&start-date='
					+ portlet_utility.getStartAndEndDatesOnDue(start_date_str)
					+ '&end-date='
					+ portlet_utility.getStartAndEndDatesOnDue(end_date_str)
					+ '&time_zone=' + (new Date().getTimezoneOffset());
			setTimeout(
					function() {
						if (that.find('#won-deal-value').text().trim() == "")
							that
									.find('#won-deal-value')
									.html(
											"<img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' />");
					}, 1000);
			portlet_graph_data_utility
					.fetchPortletsGraphData(
							wonDealsurl,
							function(data) {
								that
										.find('#won-deal-value')
										.text(
												portlet_utility
														.getPortletsCurrencySymbol()
														+ ''
														+ portlet_utility
																.getNumberWithCommasForPortlets(data["wonDealValue"]));
								that
										.find('#won-deal-count')
										.text(
												"Won from "
														+ portlet_utility
																.getNumberWithCommasForPortlets(data['wonDealsCount'])
														+ " deals");
							});

			var newDealsurl = '/core/api/portlets/portletStatsReport?reportType=newDeals&duration='
					+ base_model.get('settings').duration
					+ '&start-date='
					+ portlet_utility.getStartAndEndDatesOnDue(start_date_str)
					+ '&end-date='
					+ portlet_utility.getStartAndEndDatesOnDue(end_date_str)
					+ '&time_zone=' + (new Date().getTimezoneOffset());
			setTimeout(
					function() {
						if (that.find('#new-deal-value').text().trim() == "")
							that
									.find('#new-deal-value')
									.html(
											"<img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' />");
					}, 1000);
			portlet_graph_data_utility
					.fetchPortletsGraphData(
							newDealsurl,
							function(data) {
								that
										.find('#new-deal-value')
										.text(
												portlet_utility
														.getNumberWithCommasForPortlets(data["newDealsCount"]));
								that
										.find('#new-deal-count')
										.text(
												"New deals worth "
														+ portlet_utility
																.getPortletsCurrencySymbol()
														+ ''
														+ portlet_utility
																.getNumberWithCommasForPortlets(data['newDealValue'])
														+ "");
							});

			var campaignEmailsSentsurl = '/core/api/portlets/portletStatsReport?reportType=campaignEmailsSent&duration='
					+ base_model.get('settings').duration
					+ '&start-date='
					+ portlet_utility.getStartAndEndDatesOnDue(start_date_str)
					+ '&end-date='
					+ portlet_utility.getStartAndEndDatesOnDue(end_date_str)
					+ '&time_zone=' + (new Date().getTimezoneOffset());
			setTimeout(
					function() {
						if (that.find('#emails-sent-count').text().trim() == "")
							that
									.find('#emails-sent-count')
									.html(
											"<img src='../img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' />");
					}, 1000);
			portlet_graph_data_utility
					.fetchPortletsGraphData(
							campaignEmailsSentsurl,
							function(data) {
								that
										.find('#emails-sent-count')
										.text(
												portlet_utility
														.getNumberWithCommasForPortlets(data["emailsSentCount"]));
								that.find('#emails-sent-label').text(
										"Campaign emails sent");
							});
			setPortletContentHeight(base_model);
			break;
		}
		case "Mini Calendar": {
			head
					.js(
							LIB_PATH + 'lib/jquery-ui.min.js',
							'lib/fullcalendar.min.js',
							function() {
								$('.portlet_body_calendar', $('#portlet-res'))
										.attr(
												'id',
												'p-body-calendar'
														+ column_position + '-'
														+ row_position)
								$(
										'#p-body-calendar' + column_position
												+ '-' + row_position,
										$('#portlet-res'))
										.each(
												function() {
													$(this)
															.find(
																	'.events_show')
															.html(
																	getRandomLoadingImg());
													setPortletContentHeight(base_model);
													App_Portlets.refetchEvents = false;
													minicalendar($(this));
												});
							});
			break;
		}
		case "Onboarding" : {
			setPortletContentHeight(base_model);
			break;
		}

		}
	},

	/**
	 * To render collection view of each portlet
	 */
	renderPortletsInnerCollection : function(collectionView, portlet_ele,
			base_model) {
		collectionView.collection.fetch();
		portlet_ele.html(getRandomLoadingImg());
		portlet_ele.html($(collectionView.render().el));
		setPortletContentHeight(base_model);
	},

	/**
	 * It should open settings modal of each portlet with filled or deafult
	 * data.
	 */
	showPortletSettings : function(el) {
		var elData, base_model = Portlets_View.collection.get(el
				.split("-settings")[0]);
		var portlet_name = base_model.get('name'), that = this;

		// Hide previous error messages
		$('.help-inline').hide();

		switch (portlet_name) {
		case "Filter Based": {
			$('#filter', elData).find('option').remove();
			$('.loading-img', elData).show();
			that.addPortletSettingsModalContent(base_model,
					"portletsContactsFilterBasedSettingsModal");
			elData = $('#portletsContactsFilterBasedSettingsForm');
			var existed_filter = base_model.get("settings").filter;
			var options = '<option value="">Select...</option>';
			if (existed_filter == "contacts") {
				options += "<option selected='selected' value='contacts'>All Contacts</option>";
			}
			else {
				options += "<option value='contacts'>All Contacts</option>";
			}
			if (existed_filter == "myContacts") {
				options += "<option selected='selected' value='myContacts'>My Contacts</option>";
			}
			else {
				options += "<option value='myContacts'>My Contacts</option>";
			}
			$.ajax({
				type : 'GET',
				url : '/core/api/filters?type=PERSON',
				dataType : 'json',
				success : function(data) {
					$.each(data, function(index, contactFilter) {
						if (contactFilter.id == existed_filter) {
							options += "<option selected='selected' value=" + contactFilter.id + ">"
								+ contactFilter.name + "</option>";
						}
						else {
							options += "<option value=" + contactFilter.id + ">"
								+ contactFilter.name + "</option>";
						}
						
					});
					$('#filter', elData).html(options);
					$('.loading-img').hide();
				}
			});
			break;
		}
		case "Emails Opened": {
			that.addPortletSettingsModalContent(base_model,
					"portletsContactsEmailsOpenedSettingsModal");
			elData = $('#portletsContactsEmailsOpenedSettingsModal');
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			break;
		}
		case "Emails Sent": {
			that.addPortletSettingsModalContent(base_model,
					"portletsContactsEmailsSentSettingsModal");
			elData = $('#portletsContactsEmailsSentSettingsModal');
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			break;
		}
		case "Growth Graph": {
			$('#portlet-ul-tags > li').remove();
			$('#cancel-modal').attr('disabled', false);
			that.addPortletSettingsModalContent(base_model,
					"portletsContactsGrowthGraphSettingsModal");
			elData = $('#portletsContactsGrowthGraphSettingsModal');
			// Saved tags are appended
			var tags = base_model.get('settings').tags.split(",");
			var li = '';
			$
					.each(
							tags,
							function(index, tagName) {
								if (tagName != "")
									li += "<li data='"
											+ tagName
											+ "' class='tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block'>"
											+ tagName
											+ "<a id='remove_tag' class='close m-l-xs'>&times</a></li>";
							});
			$('#portlet-ul-tags').append(li);

			// enable tags properties
			setup_tags_typeahead();

			$("#frequency", elData).find(
					'option[value=' + base_model.get("settings").frequency
							+ ']').attr("selected", "selected");
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			break;
		}
		case "Pending Deals": {
			that.addPortletSettingsModalContent(base_model,
					"portletsPendingDealsSettingsModal");
			elData = $('#portletsPendingDealsSettingsModal');
			$("#deals", elData).find(
					'option[value=' + base_model.get("settings").deals + ']')
					.attr("selected", "selected");
			break;
		}
		case "Deals By Milestone": {
			that.addPortletSettingsModalContent(base_model,
					"portletsDealsByMilestoneSettingsModal");
			elData = $('#portletsDealsByMilestoneSettingsModal');
			var that = this;
			var url = '/core/api/portlets/portletDealsByMilestone?deals='
					+ base_model.get('settings').deals + '&track='
					+ base_model.get('settings').track;
			if (App_Portlets.track_length != undefined
					&& App_Portlets.track_length > 1)
				$('#portletsDealsByMilestoneTrack', elData).show();

			var tracks = [];
			if (App_Portlets.deal_tracks != undefined
					&& App_Portlets.deal_tracks != null)
				tracks = App_Portlets.deal_tracks;
			else {
				$.ajax({
					type : 'GET',
					url : '/core/api/milestone/pipelines',
					dataType : 'json',
					success : function(data) {
						App_Portlets.track_length = data.length;
						App_Portlets.deal_tracks = data;
						tracks = App_Portlets.deal_tracks;

						that.addTracks(tracks, base_model, elData);
					}
				});

				return;
			}
			that.addTracks(tracks, base_model, elData);
			break;
		}
		case "Closures Per Person": {
			that.addPortletSettingsModalContent(base_model,
					"portletsDealsClosuresPerPersonSettingsModal");
			elData = $('#portletsDealsClosuresPerPersonSettingsModal');
			$("#group-by", elData).find(
					'option[value=' + base_model.get("settings")["group-by"]
							+ ']').attr("selected", "selected");
			$("#due-date", elData)
					.val(
							getDateInFormatFromEpoc(base_model.get("settings")["due-date"]));
			break;
		}
		case "Deals Won": {
			that.addPortletSettingsModalContent(base_model,
					"portletsDealsWonSettingsModal");
			elData = $('#portletsDealsWonSettingsModal');
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			break;
		}
		case "Deals Funnel": {
			that.addPortletSettingsModalContent(base_model,
					"portletsDealsFunnelSettingsModal");
			elData = $('#portletsDealsFunnelSettingsModal');
			var that = this;
			var url = '/core/api/portlets/portletDealsFunnel?deals='
					+ base_model.get('settings').deals + '&track='
					+ base_model.get('settings').track;
			if (App_Portlets.track_length != undefined
					&& App_Portlets.track_length > 1)
				$('#portletsDealsFunnelTrack', elData).show();

			var tracks = [];
			if (App_Portlets.deal_tracks != undefined
					&& App_Portlets.deal_tracks != null)
				tracks = App_Portlets.deal_tracks;
			else {
				$.ajax({
					type : 'GET',
					url : '/core/api/milestone/pipelines',
					dataType : 'json',
					success : function(data) {
						App_Portlets.track_length = data.length;
						App_Portlets.deal_tracks = data;
						tracks = App_Portlets.deal_tracks;

						that.addTracks(tracks, base_model, elData);

					}
				});

				return;
			}
			that.addTracks(tracks, base_model, elData);
			break;
		}
		case "Deals Assigned": {
			that.addPortletSettingsModalContent(base_model,
					"portletsDealsAssignedSettingsModal");
			elData = $('#portletsDealsAssignedSettingsModal');
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			break;
		}
		case "Calls Per Person": {
			elData = $('#portletsCallsPerPersonSettingsModal');
			$("#group-by", elData).find(
					'option[value=' + base_model.get("settings")["group-by"]
							+ ']').attr("selected", "selected");
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");

			portlet_utility.setUsersInPortletSettings("calls-user-list",
					base_model, "calls-user-list", "calls-user", elData, function(){
						that.addPortletSettingsModalContent(base_model, "portletsCallsPerPersonSettingsModal");
					});
			break;
		}
		case "Task Report": {
			elData = $('#portletsTaskReportSettingsModal');
			$("#group-by-task-report", elData).find(
					'option[value=' + base_model.get("settings")["group-by"]
							+ ']').attr("selected", "selected");
			if (base_model.get("settings").tasks != undefined)
				$("#tasks-task-report", elData).find(
						'option[value=' + base_model.get("settings").tasks
								+ ']').attr("selected", "selected");
			$("#split-by-task-report", elData).find(
					'option[value=' + base_model.get("settings")["split-by"]
							+ ']').attr("selected", "selected");
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			$('#' + base_model.get("settings")["group-by"] + '', elData).hide();
			if (base_model.get("settings")["group-by"] == "status")
				$('#tasks-control-group').hide();
			if (base_model.get("settings").tasks == "completed-tasks")
				$('#split-by-task-report > option#status').hide();

			portlet_utility.setUsersInPortletSettings("task-report-user-list",
					base_model, "task-report-user-list", "task-report-user",
					elData, function(){
						that.addPortletSettingsModalContent(base_model, "portletsTaskReportSettingsModal");
					});
			break;
		}
		case "Stats Report": {
			that.addPortletSettingsModalContent(base_model,
					"portletsStatsReportSettingsModal");
			elData = $('#portletsStatsReportSettingsModal');
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			break;
		}
		case "Agenda": {
			that.addPortletSettingsModalContent(base_model,
					"portletsAgendaSettingsModal");
			elData = $('#portletsAgendaSettingsModal');
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			break;
		}
		case "Today Tasks": {
			that.addPortletSettingsModalContent(base_model,
					"portletsTodayTasksSettingsModal");
			elData = $('#portletsTodayTasksSettingsModal');
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			break;
		}
		case "Leaderboard": {
			elData = $('#portletsLeaderboardSettingsModal');
			var leaderboardCate = base_model.get("settings").category;
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");

			if (leaderboardCate && leaderboardCate.revenue)
				$("#category-list", elData).find('option[value=revenue]').attr(
						"selected", "selected");

			if (leaderboardCate && leaderboardCate.dealsWon)
				$("#category-list", elData).find('option[value=dealsWon]')
						.attr("selected", "selected");

			if (leaderboardCate && leaderboardCate.calls)
				$("#category-list", elData).find('option[value=calls]').attr(
						"selected", "selected");

			if (leaderboardCate && leaderboardCate.tasks)
				$("#category-list", elData).find('option[value=tasks]').attr(
						"selected", "selected");

			portlet_utility.setUsersInPortletSettings("user-list", base_model,
					"user-list", "user", elData, function(){
						that.addPortletSettingsModalContent(base_model, "portletsLeaderboardSettingsModal");
					});

			$('#ms-category-list', elData).remove();
			head.js(LIB_PATH + 'lib/jquery.multi-select.js', function() {
				$('#category-list, #user-list', elData).multiSelect();
				$('#ms-category-list .ms-selection', elData).children('ul')
						.addClass('multiSelect').attr("name", "category-list")
						.attr("id", "category");
				$('#ms-category-list .ms-selectable .ms-list', elData).css(
						"height", "105px");
				$('#ms-category-list .ms-selection .ms-list', elData).css(
						"height", "105px");
				$('#ms-category-list', elData).addClass(
						'portlet-category-ms-container');
			});
			break;
		}
		case "Revenue Graph": {
			that.addPortletSettingsModalContent(base_model,
					"portletsDealsRevenueGraphSettingsModal");
			elData = $('#portletsDealsRevenueGraphSettingsModal');
			var options = '';
			if (base_model.get('settings').track == "anyTrack") {
				options += '<option value="anyTrack" selected="selected">Any</option>';
			} else {
				options += '<option value="anyTrack">Any</option>';
			}
			$.ajax({
				type : 'GET',
				url : '/core/api/milestone/pipelines',
				dataType : 'json',
				success : function(data) {
					$.each(data, function(index, trackObj) {
						if (base_model.get('settings').track == trackObj.id)
							options += "<option value=" + trackObj.id
									+ " selected='selected'>" + trackObj.name
									+ "</option>";
						else
							options += "<option value=" + trackObj.id + ">"
									+ trackObj.name + "</option>";
					});
					$('#track', elData).html(options);
					$('.loading-img').hide();
				}
			});
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			break;
		}
		case "Campaign stats": {
			that.addPortletSettingsModalContent(base_model,
					"portletsCampaignStatsSettingsModal");
			elData = $('#portletsCampaignStatsSettingsModal');
			$("#duration", elData)
					.find(
							'option[value='
									+ base_model.get("settings").duration + ']')
					.attr("selected", "selected");
			var options = "<option value='All'>All Campaigns</option>";
			$.ajax({
				type : 'GET',
				url : '/core/api/workflows',
				dataType : 'json',
				success : function(data) {
					$.each(data, function(index, campaignfilter) {
						options += "<option value=" + campaignfilter.id + ">"
								+ campaignfilter.name + "</option>";
					});
					$('#campaign_type', elData).html(options);
					$("#campaign_type", elData).find(
							'option[value='
									+ base_model.get("settings").campaign_type
									+ ']').attr("selected", "selected");
					$('.loading-img').hide();
				}
			});
			break;
		}
		}
		if (base_model.get('name') == "Pending Deals"
				|| base_model.get('name') == "Deals By Milestone"
				|| base_model.get('name') == "Closures Per Person"
				|| base_model.get('name') == "Deals Funnel") {
			$('#due-date', elData).datepicker({
				format : CURRENT_USER_PREFS.dateFormat
			});
		}
	},

	/**
	 * Set portlet type and name in settings modal of each portlet and modal
	 * should be open.
	 */
	addPortletSettingsModalContent : function(base_model, modal_id) {
		$('#' + modal_id).modal('show');
		$(
				'#'
						+ modal_id
						+ ' > .modal-dialog > .modal-content > .modal-footer > .save-modal')
				.attr('id', base_model.get("id") + '-save-modal');
		$("#portlet-type", $('#' + modal_id)).val(
				base_model.get('portlet_type'));
		$("#portlet-name", $('#' + modal_id)).val(base_model.get('name'));
	},

	/**
	 * Set multiselected users data in calls, task report, leaderboard portlet
	 * settings.
	 */
	setUsersInPortletSettings : function(ele_id, base_model, ele_name, ele,
			elData, callback) {

		head.js(LIB_PATH + 'lib/jquery.multi-select.js', function() {
			var user_ele = base_model.get("settings")[ele_id];

			if (user_ele) {
				var options = '';
				$.ajax({
					type : 'GET',
					url : '/core/api/users',
					dataType : 'json',
					success : function(data) {
						$.each(data, function(index, domainUser) {
							if (!domainUser.is_disabled)
								options += "<option value=" + domainUser.id + ">"
										+ domainUser.name + "</option>";
						});
						$('#' + ele_id, elData).html(options);
						$.each(user_ele, function() {
							$("#" + ele_id, elData).find(
									'option[value=' + this + ']').attr("selected",
									"selected");
						});
						$('.loading-img').hide();

						$('#ms-' + ele_id, elData).remove();
						$('#' + ele_id, elData).multiSelect();
						$('#ms-' + ele_id + ' .ms-selection', elData).children('ul')
								.addClass('multiSelect').attr("name", ele_name).attr("id",
										ele);
						$('#ms-' + ele_id + ' .ms-selectable .ms-list', elData).css(
								"height", "130px");
						$('#ms-' + ele_id + ' .ms-selection .ms-list', elData).css(
								"height", "130px");
						$('#ms-' + ele_id, elData).addClass('portlet-user-ms-container');
					}
				});
			} else {
				var options = '';
				$.ajax({
					type : 'GET',
					url : '/core/api/users',
					dataType : 'json',
					success : function(data) {
						$.each(data, function(index, domainUser) {
							if (!domainUser.is_disabled)
								options += "<option value=" + domainUser.id
										+ " selected='selected'>" + domainUser.name
										+ "</option>";
						});
						$('#' + ele_id, elData).html(options);
						$('.loading-img').hide();

						$('#ms-' + ele_id, elData).remove();
						$('#' + ele_id, elData).multiSelect();
						$('#ms-' + ele_id + ' .ms-selection', elData).children('ul')
								.addClass('multiSelect').attr("name", ele_name).attr("id",
										ele);
						$('#ms-' + ele_id + ' .ms-selectable .ms-list', elData).css(
								"height", "130px");
						$('#ms-' + ele_id + ' .ms-selection .ms-list', elData).css(
								"height", "130px");
						$('#ms-' + ele_id, elData).addClass('portlet-user-ms-container');
					}
				});
			}
		});	
		return callback();
	},

	/**
	 * Get the currency symbol based on user's currency
	 */
	getPortletsCurrencySymbol : function() {

		var value = ((CURRENT_USER_PREFS.currency != null) ? CURRENT_USER_PREFS.currency
				: "USD-$");
		var symbol = ((value.length < 4) ? "$" : value.substring(4,
				value.length));

		return symbol;
	},

	/**
	 * Get the number with english number format (ex : 782,345,32)
	 */
	getNumberWithCommasForPortlets : function(value) {

		value = parseFloat(value);
		value = Math.round(value);
		if (value == 0)
			return value;

		if (value)
			return value.toFixed(2).toString().replace(
					/\B(?=(?:\d{3})+(?!\d))/g, ",").replace('.00', '');
	},

	/**
	 * Get the time format in (h m s) by passing seconds
	 */
	getPortletsTimeConversion : function(diffInSeconds) {
		if (!diffInSeconds)
			return 0;

		var duration = '';

		var days = Math.floor(diffInSeconds / (24 * 60 * 60));
		var hrs = Math.floor((diffInSeconds % (24 * 60 * 60)) / (60 * 60));
		var mins = Math
				.floor(((diffInSeconds % (24 * 60 * 60)) % (60 * 60)) / 60);
		var secs = Math
				.floor(((diffInSeconds % (24 * 60 * 60)) % (60 * 60)) % 60);

		if (hrs != 0)
			duration += '' + ((days * 24) + hrs) + 'h';
		if (mins != 0)
			duration += ' ' + mins + 'm';
		if (secs != 0)
			duration += ' ' + secs + 's';

		return duration;
	},

	/**
	 * Get the priorities for Events and Tasks portlets.
	 */
	getPortletNormalName : function(name) {

		if (!name)
			return;

		var name_json = {
			"HIGH" : "High",
			"LOW" : "Low",
			"NORMAL" : "Normal",
			"EMAIL" : "Email",
			"CALL" : "Call",
			"SEND" : "Send",
			"TWEET" : "Tweet",
			"FOLLOW_UP" : "Follow Up",
			"MEETING" : "Meeting",
			"MILESTONE" : "Milestone",
			"OTHER" : "Other",
			"YET_TO_START" : "Yet To Start",
			"IN_PROGRESS" : "In Progress",
			"COMPLETED" : "Completed",
			"TODAY" : "Today",
			"TOMORROW" : "Tomorrow",
			"OVERDUE" : "Overdue",
			"LATER" : "Later"
		};

		name = name.trim();

		return (name_json[name] ? name_json[name] : name);

	},

	/**
	 * Get the start and end dates epoch based on duration.
	 */
	getStartAndEndDatesOnDue : function(duration) {

		var d = new Date();

		// Last 24 Hrs
		if (duration == "24-hours") {
			var hrs = (d.setMilliseconds(0) / 1000) - (24 * 60 * 60);
			return hrs;
		}
		// Current time
		if (duration == "now")
			return (d.setMilliseconds(0) / 1000);
		// Today
		if (duration == "1-day" || duration == "today") {
			getGMTTimeFromDate(d) / 1000;
		}

		// This week
		if (duration == "this-week" || duration == "this-week-start") {
			if (new Date().getDay() != 0)
				d.setDate(d.getDate() - (new Date().getDay() - 1));
			else
				d.setDate(d.getDate() - (new Date().getDay() + 6));
		}
		// This week end
		if (duration == "this-week-end") {
			if (new Date().getDay() != 0)
				d.setDate((d.getDate() - (new Date().getDay() - 1)) + 7);
			else
				d.setDate((d.getDate() - (new Date().getDay() + 6)) + 7);
		}
		// Last week start
		if (duration == "last-week" || duration == "last-week-start")
			d.setDate(d.getDate() - d.getDay() - 6);

		// Lats week end
		if (duration == "last-week-end")
			d.setDate((d.getDate() - d.getDay()) + 1);

		// 1 Week ago
		if (duration == "1-week")
			d.setDate(d.getDate() - 6);

		// 1 Month ago
		if (duration == "1-month")
			d.setDate(d.getDate() - 29);

		// This month
		if (duration == "this-month" || duration == "this-month-start")
			d.setDate(1);

		// Last month start
		if (duration == "last-month" || duration == "last-month-start") {
			d.setDate(1);
			d.setMonth(d.getMonth() - 1);
		}

		// Lats month end
		if (duration == "last-month-end") {
			d.setDate((d.getDate() - d.getDate()) + 1);
			d.setMonth(d.getMonth());
		}

		// Tomorrow
		if (duration == "TOMORROW")
			d.setDate(d.getDate() + 1);

		// Yesterday
		if (duration == "yesterday")
			d.setDate(d.getDate() - 1);

		// Last 2 days
		if (duration == "2-days")
			d.setDate(d.getDate() - 1);

		// next 7 days
		if (duration == "next-7-days")
			d.setDate(d.getDate() + 8);

		// next 7 days
		if (duration == "today-and-tomorrow")
			d.setDate(d.getDate() + 2);

		// this quarter start
		if (duration == "this-quarter-start"
				|| duration == "this-and-next-quarter-start") {
			var currentMonth = d.getMonth();
			if (currentMonth < 3)
				d.setMonth(0);
			else if (currentMonth >= 3 && currentMonth < 6)
				d.setMonth(3);
			else if (currentMonth >= 6 && currentMonth < 9)
				d.setMonth(6);
			else if (currentMonth >= 9 && currentMonth < 12)
				d.setMonth(9);
			d.setDate(1);
		}

		// this quarter end
		if (duration == "this-quarter-end") {
			var currentMonth = d.getMonth();
			if (currentMonth < 3)
				d.setMonth(3);
			else if (currentMonth >= 3 && currentMonth < 6)
				d.setMonth(6);
			else if (currentMonth >= 6 && currentMonth < 9)
				d.setMonth(9);
			else if (currentMonth >= 9 && currentMonth < 12) {
				d.setFullYear(d.getFullYear() + 1);
				d.setMonth(0);
			}
			d.setDate(1);
		}

		// last quarter start
		if (duration == "last-quarter-start") {
			var currentMonth = d.getMonth();
			if (currentMonth < 3) {
				d.setFullYear(d.getFullYear() - 1);
				d.setMonth(9);
			} else if (currentMonth >= 3 && currentMonth < 6)
				d.setMonth(0);
			else if (currentMonth >= 6 && currentMonth < 9)
				d.setMonth(3);
			else if (currentMonth >= 9 && currentMonth < 12)
				d.setMonth(6);
			d.setDate(1);
		}

		// last quarter end
		if (duration == "last-quarter-end") {
			var currentMonth = d.getMonth();
			if (currentMonth < 3)
				d.setMonth(0);
			else if (currentMonth >= 3 && currentMonth < 6)
				d.setMonth(3);
			else if (currentMonth >= 6 && currentMonth < 9)
				d.setMonth(6);
			else if (currentMonth >= 9 && currentMonth < 12)
				d.setMonth(9);
			d.setDate(1);
		}

		// This month end
		if (duration == "this-month-end") {
			d.setDate(1);
			d.setMonth(d.getMonth() + 1);
		}

		// next quarter start
		if (duration == "next-quarter-start") {
			var currentMonth = d.getMonth();
			if (currentMonth < 3)
				d.setMonth(3);
			else if (currentMonth >= 3 && currentMonth < 6)
				d.setMonth(6);
			else if (currentMonth >= 6 && currentMonth < 9)
				d.setMonth(9);
			else if (currentMonth >= 9 && currentMonth < 12) {
				d.setFullYear(d.getFullYear() + 1);
				d.setMonth(0);
			}
			d.setDate(1);
		}

		// next quarter end
		if (duration == "next-quarter-end"
				|| duration == "this-and-next-quarter-end") {
			var currentMonth = d.getMonth();
			if (currentMonth < 3)
				d.setMonth(6);
			else if (currentMonth >= 3 && currentMonth < 6)
				d.setMonth(9);
			else if (currentMonth >= 6 && currentMonth < 9) {
				d.setFullYear(d.getFullYear() + 1);
				d.setMonth(0);
			} else if (currentMonth >= 9 && currentMonth < 12) {
				d.setFullYear(d.getFullYear() + 1);
				d.setMonth(3);
			}
			d.setDate(1);
		}

		// this year start
		if (duration == "this-year-start") {
			d.setMonth(d.getMonth() - d.getMonth());
			d.setDate(1);
		}

		// this year end
		if (duration == "this-year-end") {
			d.setFullYear(d.getFullYear() + 1);
			d.setMonth(d.getMonth() - d.getMonth());
			d.setDate(1);
		}

		// next year start
		if (duration == "next-year-start") {
			d.setFullYear(d.getFullYear() + 1);
			d.setMonth(d.getMonth() - d.getMonth());
			d.setDate(1);
		}

		// next year end
		if (duration == "next-year-end") {
			d.setFullYear(d.getFullYear() + 2);
			d.setMonth(d.getMonth() - d.getMonth());
			d.setDate(1);
		}

		return (getGMTTimeFromDate(d) / 1000);
	},

	/**
	 * To add newly added portlet to gridster.
	 */
	addWidgetToGridster : function(base_model) {

		if (!gridster)
			return;

		var add_flag = true;
		var portletId = 'ui-id-' + base_model.get("column_position") + '-'
				+ base_model.get("row_position") + '';

		gridster.$widgets.each(function(index, widget) {
			if (widget.id == portletId)
				add_flag = false;
		});

		if (!add_flag)
			return;

		gridster.add_widget($('#' + portletId), base_model.get("size_x"),
				base_model.get("size_y"), base_model.get("column_position"),
				base_model.get("row_position"));

		gridster.set_dom_grid_height();
		window
				.scrollTo(
						0,
						((parseInt($('#' + portletId).attr('data-row')) - 1) * 200) + 5);

	},

	getActivityObject : function(id, callback) {
		
		$.ajax({ 
			type : "GET", 
			url : 'core/api/activitylog/' + id,
			success : function(data) {
				return callback(data);
			}
		});
	
	}

};function saveActivityReport(saveBtn){
	// Returns, if the save button has disabled attribute
	if ($(saveBtn).attr('disabled'))
		return;

	// Disables save button to prevent multiple click event issues
	disable_save_button(saveBtn);
	/*if(!isValidForm('#activityReportsForm')){
		// Removes disabled attribute of save button
		enable_save_button(saveBtn);
		return;
	}*/
	
	var json = serializeForm('activityReportsForm');
	json.activity = $('#activity-type-list').val();
	json.user_ids = $('#users-list').val();
	console.log(json);
	
	// Saving that pipeline object
	var activityReportModel = new Backbone.Model();
	activityReportModel.url = '/core/api/activity-reports';
	activityReportModel.save(json, {
		// If the milestone is changed, to show that change in edit popup if opened without reloading the app.
		success : function(model, response) {
			console.log(model);
			App_Reports.activityReports.collection.add(model);
			$('#activityReportModal').modal('hide');
		},
		error: function(data,response){
			enable_save_button(saveBtn);
			console.log(response);
		}
	});
	
}

function updateActivityReport(id){
	alert(id);
	var json = App_Reports.activityReports.collection.get(6528900045733888).toJSON();
	$('#activityReportModal').modal('show');
	deserializeForm(json,$('#activityReportsForm'));
	$.each(json.user_ids,function(i,user_id){
		$('#users-list').multiSelect('select',user_id);
	});
	$.each(json.activity,function(i,activity){
		$('#activity-type-list').multiSelect('select',activity);
	});
	
}

function initializeActivityReportsListeners(){
	
	$('body').on('hidden.bs.modal', '#activityReportModal', function(e){
		$('#users-list, #activity-type-list').multiSelect('deselect_all');
	});
	
	$('#reports-listerners-container').on('click', '#activity-reports-email-now', function(e){
		e.preventDefault();
		e.stopPropagation();
		var id = $(this).attr('data');
		var confirmationModal = $('<div id="report-send-confirmation" class="modal fade in">' +
				
			'<div class="modal-dialog">'+
				'<div class="modal-content">' +
				'<div class="modal-header" >'+
					'<a href="#" data-dismiss="modal" class="close">&times;</a>' +
						'<h3 class="modal-title">Send Report</h3></div>' +
							'<div class="modal-body">' +
								'<p>You are about to send report.</p>' +
								'<p>Do you want to proceed?</p>' +
							'</div>' +	
					'<div class="modal-footer">' +
						'<div><span class="report-message" style="margin-right:5px"></span></div>' +
						'<div>' +
						'<a href="#" id="report-send-confirm" class="btn btn-primary">Yes</a>' +
						'<a  href="#" class="btn btn-default" data-dismiss="modal" >No</a>'+ 
						'</div>' +
					'</div>' +
				'</div>' + 
				'</div>' +
				'</div>' + 
			'</div>');

		confirmationModal.modal('show');
		var date = Math.floor(Date.now()/1000);
		$("#report-send-confirm", confirmationModal).click(
				function(event)
				{
					event.preventDefault();
					
					if ($(this).attr("disabled")) return;
					
					$(this).attr("disabled", "disabled");
					$.get('/core/api/activity-reports/email/' + id +'?end_time='+date, function(data){
						
						console.log("sending email");
							$save_info = $('<div style="display:inline-block"><small><p class="text-success"><i>Report will be sent shortly</i></p></small></div>');
				
							$('.report-message').html($save_info);
				
							$save_info.show();

							setTimeout(function ()
							            {
								   (confirmationModal).modal('hide');
							            }, 2000);

					}).fail(function(response){
						$save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+response.responseText+'</i></p></small></div>');
						
						$('.report-message').html($save_info);
			
						$save_info.show();

						setTimeout(function ()
						            {
							   (confirmationModal).modal('hide');
						            }, 2000);

					});
				});
	});
	
	$('#reports-listerners-container').on('click', '#activity-type-list-select-all', function(e){
		e.preventDefault();
		$('#activity-type-list').multiSelect('select_all');
	});
	$('#reports-listerners-container').on('click', '#activity-type-list-select-none', function(e){
		e.preventDefault();
		$('#activity-type-list').multiSelect('deselect_all');
	});
	
	$('#reports-listerners-container').on('click', '#users-list-select-all', function(e){
		e.preventDefault();
		$('#users-list').multiSelect('select_all');
	});
	$('#reports-listerners-container').on('click', '#users-list-select-none', function(e){
		e.preventDefault();
		$('#users-list').multiSelect('deselect_all');
	});
	
	/** 
	    * Deal list view edit
	    
	    $('#activity-report-model-list > tr > td:not(":first-child")').live('click', function(e) {
			e.preventDefault();
			updateActivityReport($(this).closest('tr').find('.data').attr('data'));
		});
	*/
}function initializeChartReportsListeners(){
	$('#reports-listerners-container').on('click', '.report-chorts', function(e){
		e.preventDefault();
		var formelement = $(this).parents('form'); 
		if (!isValidForm($(formelement))) {
			return false;
		}
		
		var object = serializeForm($(formelement).attr('id'));
		
		
		var report_type = object["report_chart_type"];
		
		var tags = "";
		
		if(object["tags"] && isArray(object["tags"]))
			$.each(object["tags"], function(i, tag){
				if(i == 0)
					tags += tag;
				else
					tags += ", " +tag;
			});
		
		console.log(tags);
		
		if(report_type == 'GROWTH')
		{
			Backbone.history.navigate("report-growth/" + tags, { trigger : true });
		}
		else if(report_type == 'FUNNEL')
		{
			Backbone.history.navigate("report-funnel/" + tags, { trigger : true });
		}
		else if(report_type == 'RATIO')
		{
			var tag1 = object["tag1"];
			var tag2 = object["tag2"];
			Backbone.history.navigate("report-ratio/" + tag1 + "/" + tag2, { trigger : true });
		}
		else if(report_type == 'COHORTS')
		{
			var tag1 = object["tag1"];
			var tag2 = object["tag2"];
			
			Backbone.history.navigate("report-cohorts/" + tag1 + "/" + tag2, { trigger : true });
		}
		
		
		
	});
}
/** Activity and contact report add edit functionality * */
var report_utility = {

/** Loads add report for activity email report* */
load_activities : function(el)
{
	// Fills owner select element
	fillSelect("users-list", '/core/api/users', 'domainUser', function()
	{
		loadActivityReportLibs(function()
		{

			$('#activity-type-list, #users-list', el).multiSelect();
			$('#ms-activity-type-list .ms-selection', el).children('ul').addClass('multiSelect').attr("name", "activity").attr("id", "activity_type");
			$('#ms-users-list .ms-selection', el).children('ul').addClass('multiSelect').attr("name", "user_ids").attr("id", "user_ids");
			++count;
			if (count > 0)
				$("#reports-listerners-container").html(el);

			$('.activity_time_timepicker', el).timepicker({ 'timeFormat' : 'H:i ', 'step' : 30 });
			$(".activity_time_timepicker", el).val("09:00");
			$("#report_timezone", el).val(ACCOUNT_PREFS.timezone);

		});

	}, '<option value="{{id}}">{{name}}</option>', true, el);
},

/** Editing the condition for an existing activity email report* */
edit_activities : function(el, json)
{
	var frequency=json.frequency;
	$('#activity-type-list, #users-list', el).multiSelect();
	$('#ms-activity-type-list .ms-selection', el).children('ul').addClass('multiSelect').attr("name", "activity").attr("id", "activity_type");
	$('#ms-users-list .ms-selection', el).children('ul').addClass('multiSelect').attr("name", "user_ids").attr("id", "user_ids");

	$("#reports-listerners-container").html(el)
	$.each(json.user_ids, function(i, user_id)
	{
		$('#users-list').multiSelect('select', user_id);
		console.log('select user---', user_id);
	});
	$.each(json.activity, function(i, activity)
	{
		$('#activity-type-list').multiSelect('select', activity);
		console.log('select activity-------', activity);
	});
	$('#ms-activity-type-list .ms-selection').children('ul').addClass('multiSelect').attr("name", "activity").attr("id", "activity_type");
	$('#ms-users-list .ms-selection').children('ul').addClass('multiSelect').attr("name", "user_ids").attr("id", "user_ids");

	if (json.report_timezone == null)
	{
		$("#report_timezone").val(ACCOUNT_PREFS.timezone);
	}
	// based on frequency we are showing and hiding the time and date and
	// month fields
	updateWeekDayReportVisibility(frequency, "activity");
	$('.activity_time_timepicker').timepicker({ 'timeFormat' : 'H:i ', 'step' : 30 });
},

/** Loads add report for contact email report* */
load_contacts : function(el)
{

	fillSelect("custom-fields-optgroup", "core/api/custom-fields/scope?scope=CONTACT", undefined, function()
	{
		loadActivityReportLibs(function()
		{

			$('#multipleSelect', el).multiSelect({ selectableOptgroup : true });

			$('.ms-selection', el).children('ul').addClass('multiSelect').attr("name", "fields_set").attr("id", "fields_set").sortable();

			++count;
			if (count > 1)
				$("#reports-listerners-container").html(el);

			$('.report_time_timepicker', el).timepicker({ 'timeFormat' : 'H:i ', 'step' : 30 });
			$(".report_time_timepicker", el).val("09:00");
			$("#report_timezone", el).val(ACCOUNT_PREFS.timezone);

		});

	}, '<option value="custom_{{field_label}}">{{field_label}}</option>', true, el);

	head.js(LIB_PATH + 'lib/jquery-ui.min.js', LIB_PATH + 'lib/agile.jquery.chained.min.js', function()
	{
		scramble_input_names($(el).find('div#report-settings'));
		chainFiltersForContact(el, undefined, function()
		{
			++count;
			if (count > 1)
				$("#reports-listerners-container").html(el)
		});
	});
},

/** Editing the condition for an existing contacts email report* */
edit_contacts : function(el, report)
{
	console.log(el);
	console.log(report.toJSON());
	$('#multipleSelect', el).multiSelect({ selectableOptgroup : true });
	++count;
	if (count > 1)
		deserialize_multiselect(report.toJSON(), el);

	setTimeout(function()
	{
		$('.report_time_timepicker').timepicker({ 'timeFormat' : 'H:i ', 'step' : 30 });

		var frequency = report.toJSON().duration;
		updateWeekDayReportVisibility(frequency,"contact");

		if (report.toJSON().report_timezone == null)
		{
			$("#report_timezone").val(ACCOUNT_PREFS.timezone);
		}
	}, 1000);
}, 
/**Function block to be executed for every call back for Call Reports*/
call_reports : function(url,reportType,graphOn){
	var selector="email-reports";

	var answeredCallsCountList=[];
	var busyCallsCountList=[];
	var failedCallsCountList=[];
	var voiceMailCallsCountList=[];
	var callsDurationList=[];
	var totalCallsCountList=[];
	var domainUsersList=[];
	var domainUserImgList=[];
	var averageCallList=[];
	var sizey = parseInt($('#'+selector).parent().attr("data-sizey"));
	var topPos = 50*sizey;
	if(sizey==2 || sizey==3)
		topPos += 50;
	$('#'+selector).html("<div class='text-center v-middle opa-half' style='margin-top:"+topPos+"px'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");

	portlet_graph_data_utility.fetchPortletsGraphData(url,function(data){
		if(data.status==403){
			$('#'+selector).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
			return;
		}
		answeredCallsCountList=data["answeredCallsCountList"];
		busyCallsCountList=data["busyCallsCountList"];
		failedCallsCountList=data["failedCallsCountList"];
		voiceMailCallsCountList=data["voiceMailCallsCountList"];
		callsDurationList=data["callsDurationList"];
		totalCallsCountList=data["totalCallsCountList"];
		domainUsersList=data["domainUsersList"];
		domainUserImgList=data["domainUserImgList"];
		pieGraphRegions=['Answered Calls','Busy Calls','Failed Calls','Voice Mail Calls'];
		
		var series=[];
		var text='';
		var colors;
		
		/**This executes for plotting pie chart*/
		
		if(reportType == 'pie-graph'){ /**When it is a pie graph and dropdown is Number of calls */
			
			var answeredCallCount=0;
			var CompleteCallsCount=[];
			$.each(answeredCallsCountList,function(index,answeredCall){
				answeredCallCount +=answeredCall;
			});
			CompleteCallsCount.push(answeredCallCount);
			var busyCallCount=0;
			$.each(busyCallsCountList,function(index,busyCall){
				busyCallCount +=busyCall;
			});
			CompleteCallsCount.push(busyCallCount);
			var failedCallCount=0;
			$.each(failedCallsCountList,function(index,failedCall){
				failedCallCount +=failedCall;
			});
			CompleteCallsCount.push(failedCallCount);
			var voicemailCallCount=0;
			$.each(voiceMailCallsCountList,function(index,voicemailCall){
				voicemailCallCount +=voicemailCall;
			});
			CompleteCallsCount.push(voicemailCallCount);
			
			
			portlet_graph_utility.callsByPersonPieGraph(selector,pieGraphRegions,CompleteCallsCount);
			return;
			
		}
		
		/**This executes for plotting the Bar graph*/ 
		if(graphOn == "number-of-calls"){
			var tempData={};
			tempData.name="Answered";
			tempData.data=answeredCallsCountList;
			series[0]=tempData;
			
			tempData={};
			tempData.name="Busy";
			tempData.data=busyCallsCountList;
			series[1]=tempData;
			
			tempData={};
			tempData.name="Failed";
			tempData.data=failedCallsCountList;
			series[2]=tempData;
			
			tempData={};
			tempData.name="Voicemail";
			tempData.data=voiceMailCallsCountList;
			series[3]=tempData;
			text="Total Calls";
			colors=['green','blue','red','violet'];
		}
		else if(graphOn == "average-calls"){
			
				var tempData={};
				tempData.name="Average Call Duration";
			    $.each(callsDurationList,function(index,duration){
			    if(duration > 0){
			    	
					var callsDurationAvg=duration/answeredCallsCountList[index];
					averageCallList.push(callsDurationAvg);
			    	
			    }else{
			    	averageCallList.push(0);
			    }
				
			    });
			    tempData.data=averageCallList;
			    tempData.showInLegend=false;
			    series[0]=tempData;
			    text="Average Call Duration (Mins)";
			    colors=['green'];
		}
		else
		{
			var tempData={};
			tempData.name="Total Call Duration";
			var callsDurationInMinsList = [];
			$.each(callsDurationList,function(index,duration){
				if(duration > 0){
					callsDurationInMinsList[index] = duration;
				}else{
					callsDurationInMinsList[index] = 0;
				}
				
			});
			tempData.data=callsDurationInMinsList;
			tempData.showInLegend=false;
			series[0]=tempData;
			text="Calls Duration (Mins)";
			colors=['green'];
		}
		
		portlet_graph_utility.callsPerPersonBarGraph(selector,domainUsersList,series,totalCallsCountList,callsDurationList,text,colors,domainUserImgList);
	});

	return;

},

/**Function block to be executed on every call back for User Reports*/
user_reports :function(callReportUrl){
	
	
	   var selector="calls-chart-user";
		
		var answeredCallsCountList=[];
		var busyCallsCountList=[];
		var failedCallsCountList=[];
		var voiceMailCallsCountList=[];
		var callsDurationList=[];
		var totalCallsCountList=[];
		var domainUsersList=[];
		var domainUserImgList=[];
		var averageCallList=[];
		var sizey = parseInt($('#'+selector).parent().attr("data-sizey"));
		var topPos = 50*sizey;
		if(sizey==2 || sizey==3)
			topPos += 50;
		$('#'+selector).html("<div class='text-center v-middle opa-half' style='margin-top:"+topPos+"px'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");
		
		portlet_graph_data_utility.fetchPortletsGraphData(callReportUrl,function(data){
			if(data.status==403){
				$('#'+selector).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
				return;
			}
			answeredCallsCountList=data["answeredCallsCountList"];
			busyCallsCountList=data["busyCallsCountList"];
			failedCallsCountList=data["failedCallsCountList"];
			voiceMailCallsCountList=data["voiceMailCallsCountList"];
			callsDurationList=data["callsDurationList"];
			totalCallsCountList=data["totalCallsCountList"];
			domainUsersList=data["domainUsersList"];
			domainUserImgList=data["domainUserImgList"];
			pieGraphRegions=['Answered Calls','Busy Calls','Failed Calls','Voice Mail Calls'];
			
			var series=[];
			var text='';
			var colors;
			
			/**This executes for plotting pie chart*/
				
				var answeredCallCount=0;
				var CompleteCallsCount=[];
				$.each(answeredCallsCountList,function(index,answeredCall){
					answeredCallCount +=answeredCall;
				});
				CompleteCallsCount.push(answeredCallCount);
				var busyCallCount=0;
				$.each(busyCallsCountList,function(index,busyCall){
					busyCallCount +=busyCall;
				});
				CompleteCallsCount.push(busyCallCount);
				var failedCallCount=0;
				$.each(failedCallsCountList,function(index,failedCall){
					failedCallCount +=failedCall;
				});
				CompleteCallsCount.push(failedCallCount);
				var voicemailCallCount=0;
				$.each(voiceMailCallsCountList,function(index,voicemailCall){
					voicemailCallCount +=voicemailCall;
				});
				CompleteCallsCount.push(voicemailCallCount);
				
				
				portlet_graph_utility.callsByPersonPieGraph(selector,pieGraphRegions,CompleteCallsCount);
			
		});
	
	
}


 };


/* Loads libraries needed for reporting * */
function initReportLibs(callback)
{

	head.load(LIB_PATH + 'lib/date-charts.js', LIB_PATH + 'lib/date-range-picker.js'+'?_=' + _AGILE_VERSION, function()
	{
		callback();

	});
}

/* Loads libraries needed for activity reporting * */
function loadActivityReportLibs(callback)
{

	head.js(LIB_PATH + 'lib/jquery.multi-select.js', CSS_PATH + 'css/businesshours/jquerytimepicker.css', LIB_PATH + 'lib/businesshours/jquerytimepicker.js',
			function()
			{
				callback();
			});

}
/* format the selected start and end dates  as an url * */
function getSelectedDates(){
	var options = "?";

	var range = $('#range').html().split("-");
	var start_time=new Date(range[0]).getTime() / 1000;

	var end_value = $.trim(range[1]);

	
	if (end_value)
		end_value = end_value + " 23:59:59";

	var end_time=new Date(end_value).getTime() / 1000;
	options += ("start-date=" + start_time + "&end-date=" + end_time);
return options;
}
// Stores report object, so it can be used while creating report table headings
var REPORT;
function initializeReportsListeners(){
	$('#reports-listerners-container').on('click', '#reports-email-now', function(e)
					{
						// e.preventDefault();
						e.stopPropagation();

						var id = $(this).attr('data');

						var confirmationModal = $('<div id="report-send-confirmation" class="modal fade in">' + '<div class="modal-dialog">' + '<div class="modal-content">' + '<div class="modal-header" >' + '<a href="#" data-dismiss="modal" class="close">&times;</a>' + '<h3>Send Report</h3></div>' + '<div class="modal-body">' + '<p>You are about to send report.</p>' + '<p>Do you want to proceed?</p>' + '</div>' + '<div class="modal-footer">' + '<div><span class="report-message" style="margin-right:5px"></span></div>' + '<div>' + '<a href="#" id="report-send-confirm" class="btn btn-primary">Yes</a>' + '<a  href="#" class="btn btn-default" data-dismiss="modal" >No</a>' + '</div>' + '</div>' + '</div>' + '</div>' + '</div>' + '</div>');

						confirmationModal.modal('show');

						$("#report-send-confirm", confirmationModal)
								.click(
										function(event)
										{
											event.preventDefault();

											if ($(this).attr("disabled"))
												return;

											$(this).attr("disabled", "disabled");

											$
													.get(
															'core/api/reports/send/' + id,
															function(data)
															{

																console.log("sending email");
																$save_info = $('<div style="display:inline-block"><small><p class="text-success"><i>Report will be sent shortly</i></p></small></div>');

																$('.report-message').html($save_info);

																$save_info.show();

																setTimeout(function()
																{
																	(confirmationModal).modal('hide');
																}, 2000);

															})
													.fail(
															function(response)
															{
																$save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>' + response.responseText + '</i></p></small></div>');

																$('.report-message').html($save_info);

																$save_info.show();

																setTimeout(function()
																{
																	(confirmationModal).modal('hide');
																}, 2000);

															});
										});
					});

	$('#reports-listerners-container').on('click', '#campaign_id', function(e)
			{
				e.preventDefault();
				e.stopPropagation();
				$.ajax({ url : '/core/api/workflows?page_size=1', type : 'GET', dataType : "json",
					accept : { json : 'application/json', xml : 'application/xml' }, success : function(data)
					{
						if (data[0])
						{
							window.document.location = "#email-reports/" + data[0].id;
							$(window).scrollTop(0);
						}
						else
							window.document.location = "#workflows";

						return;

					}, error : function(response)
					{
						alert("error occured Please try again");
						window.document.location = "#reports";
					} });

			});
	$('#reports-listerners-container').on('click', '#report-instant-results', function(e) 
	{
		e.stopPropagation();
		var id = $(this).attr('data');
		console.log(id);
		/*
		 * Backbone.history.navigate("report-results/" + id, { trigger: true });
		 */
	});

	$('#reports-listerners-container').on('change', '#frequency', function(e) 
	{
		var frequency = $("#frequency").val();
		if (frequency == "DAILY")
		{
			$("#activity_report_weekday").css("display", "none");
			$("#activity_report_day").css("display", "none");
			$("#activity_report_time").css("display", "block");

		}
		else if (frequency == "WEEKLY")
		{
			$("#activity_report_day").css("display", "none");
			$("#activity_report_time").css("display", "block");
			$("#activity_report_weekday").css("display", "block");

		}
		else if (frequency == "MONTHLY")
		{
			$("#activity_report_weekday").css("display", "none");
			$("#activity_report_time").css("display", "block");
			$("#activity_report_day").css("display", "block");

		}
	});

	/*
	 * author jaagdeesh
	 */
	$('#reports-listerners-container').on('click', '#report-dashlat-navigate', function(e)
	{
		e.preventDefault();
		Backbone.history.navigate("add-dashlet", { trigger : true });

	});

	$('#reports-listerners-container').on('click', '#activity_advanced', function(e) 
	{
		e.preventDefault();

	});

	$('#reports-listerners-container').on('shown', '#activity-advanced-block', function(e) 
	{
		$('#activity_advanced').html('<span><i class="icon-minus"></i></span> Advanced');

	});

    $('#reports-listerners-container').on('hidden', '#activity-advanced-block', function(e) 
	{
		$('#activity_advanced').html('<span><i class="icon-plus"></i></span> Advanced');
	});

	$('#reports-listerners-container').on('click', '#report_advanced', function(e) 
	{
		e.preventDefault();
		$("#report_advanced span i").toggleClass("fa-minus");
		$("#report_advanced span i").toggleClass("fa-plus");

	});
            
	$('#reports-listerners-container').on('shown', '#report-advanced-block', function(e)
	{
		$('#report_advanced').html('<span><i class="icon-minus"></i></span> Advanced');

	});
			
	$('#reports-listerners-container').on('hidden', '#report-advanced-block', function(e)
	{
		$('#report_advanced').html('<span><i class="icon-plus"></i></span> Advanced');
	});
	
	$('#reports-listerners-container').on('change', '#duration', function(e)
			{
				var frequency = $("#duration").val();
				if (frequency == "DAILY")
				{
					$("#contact_report_weekday").css("display", "none");
					$("#contact_report_day").css("display", "none");
					$("#contact_report_time").css("display", "block");

				}
				else if (frequency == "WEEKLY")
				{
					$("#contact_report_day").css("display", "none");
					$("#contact_report_time").css("display", "block");
					$("#contact_report_weekday").css("display", "block");

				}
				else if (frequency == "MONTHLY")
				{
					$("#contact_report_weekday").css("display", "none");
					$("#contact_report_time").css("display", "block");
					$("#contact_report_day").css("display", "block");

				}
	});
}

function reportsContactTableView(base_model, customDatefields, view)
{
	/*
	 * Old Code : Using this fails on firefox, works on Chrome though // Creates
	 * list view for var itemView = new Base_List_View({ model : base_model,
	 * template : 'contacts-custom-view-model', tagName :
	 * this.options.individual_tag_name }); // Reads the modelData (customView
	 * object) var modelData = this.options.modelData; // Reads fields_set from
	 * modelData var fields = modelData['fields_set']; // Converts base_model
	 * (contact) in to JSON var contact = base_model.toJSON(); // Clears the
	 * template, because all the fields are appended, has to be reset // for
	 * each contact $('#contacts-custom-view-model-template').empty(); //
	 * Iterates through, each field name and appends the field according to //
	 * order of the fields $.each(fields, function(index, field_name) {
	 * if(field_name.indexOf("properties_") != -1) field_name =
	 * field_name.split("properties_")[1];
	 * 
	 * $('#contacts-custom-view-model-template').append(
	 * getTemplate('contacts-custom-view-' + field_name, contact)); }); //
	 * Appends model to model-list template in collection template $(("#" +
	 * this.options.templateKey + '-model-list'), this.el).append(
	 * itemView.render().el); // ----------- this line fails on Firefox
	 */

	getTemplate('contacts-custom-view-custom', {}, undefined, function(ui){

			var modelData = view.options.modelData; // Reads the modelData (customView
			// object)
			var fields = modelData['fields_set']; // Reads fields_set from modelData
			var contact = base_model.toJSON(); // Converts base_model (contact) in to
			// JSON
			var final_html_content = "";
			var element_tag = view.options.individual_tag_name;
			var templateKey = view.options.templateKey;

			// Iterates through, each field name and appends the field according to
			// order of the fields
			$.each(fields, function(index, field_name)
			{

				if (field_name.indexOf("custom_") != -1)
				{
					field_name = field_name.split("custom_")[1];
					var property = getProperty(contact.properties, field_name);
					if (!property)
						property = {};

					if (isDateCustomField(customDatefields, property))
						final_html_content += getTemplate('contacts-custom-view-custom-date', property);
					else
						final_html_content += getTemplate('contacts-custom-view-custom', property);

					return;
				}

				if (field_name.indexOf("properties_") != -1)
					field_name = field_name.split("properties_")[1];

				final_html_content += getTemplate('contacts-custom-view-' + field_name, contact);
			});

			// Appends model to model-list template in collection template
			$(("#" + templateKey + '-model-list'), view.el).append('<' + element_tag + '>' + final_html_content + '</' + element_tag + '>');

			// Sets data to tr
			$(('#' + templateKey + '-model-list'), view.el).find('tr:last').data(base_model);



	 }, null);

}

function deserialize_multiselect(data, el)
{
	$("#reports-listerners-container").html(el);

	if (!data['fields_set'])
		return;
	$.each(data['fields_set'], function(index, field)
	{
		$('#multipleSelect', el).multiSelect('select', field);
	});

	$('.ms-selection', el).children('ul').addClass('multiSelect').attr("name", "fields_set").attr("id", "fields_set").sortable();
}

function getEpochTimeFromReport(time, day, frequency)
{

	var time_array = new Array();
	var d = new Date();
	var hour, min;
	if (time)
	{
		time_array = time.toString().split(':');
		hour = time_array[0];
		min = time_array[1];
	}

	if (frequency == "DAILY")
	{
		var date = new Date();

		var day_of_month = date.getDate();

		date.setDate(day_of_month + 1);
		date.setHours(hour);
		date.setMinutes(min);
		return (date.getTime()) / 1000;

	}

	if (frequency == "WEEKLY")
	{
		var date = new Date();

		var weekday = date.getDay();
		var day_of_month = date.getDate();

		if (day > weekday)
		{
			day_of_month += (parseInt(day) - weekday);
		}
		else
		{
			day_of_month = (day_of_month - (weekday - parseInt(day))) + 7;
		}

		date.setDate(day_of_month);
		date.setHours(hour);
		date.setMinutes(min);
		return (date.getTime()) / 1000;

	}

	if (frequency == "MONTHLY")
	{
		var date = new Date();
		var day_of_month = date.getDate();
		var month_in_year = date.getMonth();
		if (day > day_of_month)
		{
			month_in_year = month_in_year;
		}
		else
		{
			month_in_year = month_in_year + 1;
		}
		date.setMonth(month_in_year);
		date.setDate(day);
		date.setHours(hour);
		date.setMinutes(min);
		return (date.getTime()) / 1000;

	}

}

function getNextMonthEppoch(time, day, month)
{
	var time_array = new Array();
	var hour, min;
	if (time)
	{
		time_array = time.toString().split(':');
		hour = time_array[0];
		min = time_array[1];
	}
	var date = new Date();
	var day_of_month = date.getDate();
	var month_in_year = date.getMonth();
	if (day > day_of_month)
	{
		month_in_year = month_in_year + 1;
	}
	else
	{
		month_in_year = month_in_year + 2;
	}
	date.setMonth(month_in_year);
	date.setDate(day);
	date.setHours(hour);
	date.setMinutes(min);
	return (date.getTime()) / 1000;
}

/**This is being invoked from call category -call logs under reports:where it should redirect to activities with calls as a entity type*/
$(function()
		{
	
	$("body").on("click","a#call-activity-link", function(e){
	var entitytype = "Calls";
	var entity_attribute = "CALL";
	buildActivityFilters(entitytype,entity_attribute,"entityDropDown");
	//ActivitylogRouter.activities("id");
	App_Activity_log.navigate("activities", { trigger : true });
	
});
	
		});/**
 * contact-filter.js defines functionalities to show filter in dropdown, events
 * on selecting filter, call to set cookie when filter is selected. Shows name
 * of the selected filter on dropdown button client side. This also defines
 * clone function, used while adding multiple filter conditions
 * 
 * @module Search author: Yaswanth
 */
var filter_name;
var CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS = "toggle_dynamic_filter_" + CURRENT_DOMAIN_USER.id;

/**
 * Change name of input[name='temp'] to more random i.e. temp-<unique_number>.
 * This is necessary for showing correct validation errors when multiple entries with same field-name are on the page.
 * @param el
 */
var scrambled_index=0;
function scramble_input_names(el)
{
	el.find("input").each(function(){
		$(this).attr('name','temp-'+scrambled_index);
		$(this).addClass('required');
		scrambled_index+=1;
	});
}
SEARCHABLE_CONTACT_CUSTOM_FIELDS = undefined;
COMPANY_CUSTOM_FIELDS = undefined;

/**
*  Contact Reports filters event view
*/
var Report_Filters_Event_View = Base_Model_View.extend({
    events: {
    	'click .filter-contacts-multiple-add' : 'contactsFilterMultipleAdd',
    	'click .filter-contacts-multiple-add-or-rules' : 'contactsFilterAddOrRules',
    	'click .filter-companies-multiple-add' : 'companiesFilterMultipleAdd',
    	'click .filter-companies-multiple-add-or-rules' : 'companiesFilterAddOrRules',
    	'click i.filter-contacts-multiple-remove' : 'contactsFilterRemove',
    	'click .filter' : 'filterResults',
    	'click .default_filter' : 'defaultFilterResults',
    	'click .default_contact_remove_tag' : 'defaultContactRemoveTag',

    	'click #companies-filter' : 'companyFilterResults',
    	'change .lhs_chanined_parent' : 'onParentLHSChanged',
    	'change #condition > select' : 'onConditionChanged',
    	'change #contact_type' : 'onChangeContactType',
    	
    },

	// Filter Contacts- Clone Multiple
	contactsFilterMultipleAdd: function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var that = targetEl;
		// To solve chaining issue when cloned

		getTemplate("filter-contacts", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			
			var htmlContent = $($(template_ui).find('.chained-table.contact')[0]).find('tr').clone();
			$(htmlContent).removeClass('hide');
			scramble_input_names($(htmlContent));

			// boolean parameter to avoid contacts/not-contacts fields in form
			chainFilters(htmlContent, function(){
			}, false);

	//		$(this).hide();
			// var htmlContent = $(this).closest("tr").clone();
			$(htmlContent).find("i.filter-contacts-multiple-remove").css("display", "inline-block");
			//hide camapign status
			//$(htmlContent).find('#LHS select').find("optgroup[label='Activities']").remove();
			$(that).prev('table').find("tbody").append(htmlContent);

		}, null);
	},
	
	// Filter Contacts- Clone Multiple
	contactsFilterAddOrRules: function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		var that = targetEl;
		// To solve chaining issue when cloned
		getTemplate("filter-contacts", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			var htmlContent = $($(template_ui).find('.chained-table.contact')[1]).find('tr').clone();
			$(htmlContent).removeClass('hide');
			scramble_input_names($(htmlContent));

			// boolean parameter to avoid contacts/not-contacts fields in form
			chainFilters(htmlContent, function(){
			}, false);

	//		$(this).hide();
			// var htmlContent = $(this).closest("tr").clone();
			$(htmlContent).find("i.filter-contacts-multiple-remove").css("display", "inline-block");
			//hide camapign status
			//$(htmlContent).find('#LHS select').find("optgroup[label='Activities']").remove()
			$(that).prev('table').find("tbody").append(htmlContent);

		}, null);
		
	},
	
	// Filter Contacts- Clone Multiple
	companiesFilterMultipleAdd: function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		// To solve chaining issue when cloned
		var that = targetEl;
		getTemplate("filter-contacts", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			var htmlContent = $($(template_ui).find('.chained-table.company')[0]).find('tr').clone();
			$(htmlContent).removeClass('hide');
			scramble_input_names($(htmlContent));

			// boolean parameter to avoid contacts/not-contacts fields in form
			chainFilters(htmlContent,undefined, function(){
			}, false, true);

	//		$(this).hide();
			// var htmlContent = $(this).closest("tr").clone();
			$(htmlContent).find("i.filter-contacts-multiple-remove").css("display", "inline-block");
			$(that).prev("table").find("tbody").append(htmlContent);

		}, null);
		
	},
	
	// Filter Contacts- Clone Multiple
	companiesFilterAddOrRules: function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget);
		
		var that = targetEl;
		// To solve chaining issue when cloned
		getTemplate("filter-contacts", {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			var htmlContent = $($(template_ui).find('.chained-table.company')[1]).find('tr').clone();
			$(htmlContent).removeClass('hide');
			scramble_input_names($(htmlContent));

			// boolean parameter to avoid contacts/not-contacts fields in form
			chainFilters(htmlContent,undefined, function(){
			}, false, true);

	//		$(this).hide();
			// var htmlContent = $(this).closest("tr").clone();
			$(htmlContent).find("i.filter-contacts-multiple-remove").css("display", "inline-block");
			$(that).prev("table").find("tbody").append(htmlContent);

		}, null);

		
	},

	// Filter Contacts- Remove Multiple
	contactsFilterRemove: function(e)
	{
		var targetEl = $(e.currentTarget);
		$(targetEl).closest("tr").remove();
	},

	// Fetch filter result without changing route on click
	filterResults:  function(e)
	{

		e.preventDefault();
		var targetEl = $(e.currentTarget);

		eraseData('dynamic_contact_filter');

		var filter_id = $(targetEl).attr('id');
		var filter_type = $(targetEl).attr('filter_type');

		// Saves Filter in cookie
		createCookie('contact_filter', filter_id)
		createCookie('contact_filter_type', filter_type)

		// Gets name of the filter, which is set as data
		// attribute in filter
		filter_name = $(targetEl).attr('data');

		CONTACTS_HARD_RELOAD=true;
		App_Contacts.contacts();
		return;
		// /removed old code from below,
		// now filters will work only on contact, not company
	},

	/*
	 * If default filter is selected, removes filter cookies an load contacts
	 * with out any query condition
	 */
	defaultFilterResults:  function(e)
	{
		e.preventDefault();
		revertToDefaultContacts();
	},

	defaultContactRemoveTag: function(e)
	{
		e.preventDefault();
		// Navigate to show form
		Backbone.history.navigate("contacts", { trigger : true });
	},

	companyFilterResults: function(e)
	{

		e.preventDefault();
		eraseCookie('contact_filter');
		eraseCookie('contact_filter_type');

		createCookie('company_filter', "Companies");
		CONTACTS_HARD_RELOAD = true;
		App_Contacts.contacts(); // /Show Companies list, explicitly hard
		// reload
		return;
		
	},

	onParentLHSChanged:  function(e)
	{
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		if (($(targetEl).val()).indexOf('tags') != -1)
		{
			var element = $(targetEl).closest('tr').find('div#RHS');
			addTagsDefaultTypeahead(element);
		}
	},
	
	onConditionChanged: function(e){
		e.preventDefault();
		var targetEl = $(e.currentTarget);

		if ($(targetEl).find("option:selected").hasClass('tags'))
		{
			var element = $(targetEl).parents().closest('tr').find('div#RHS');
			addTagsDefaultTypeahead(element);
		}
		
	},
	
	onChangeContactType: function(e)
	{
		var targetEl = $(e.currentTarget);

		if($(targetEl).val() == 'COMPANY') {
			$('#companies-filter-wrapper').show();
			$('#contacts-filter-wrapper').hide();
		} else {
			$('#companies-filter-wrapper').hide();
			$('#contacts-filter-wrapper').show();
		}
	},
	
});

/**
 * Sets up contact filters list in contacts list page, also whether cookie is
 * save with filter name to load filter results instead of all contacts
 * 
 * @method setupContactFilterList
 * @param cel
 *            Html form element to append filters list,
 */
var contactFiltersListView
function setupContactFilterList(cel, tag_id)
{
	if (tag_id)
		$('.filter-criteria', cel)
				.html(
						'<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li  class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="m-l-xs pull-left">' + decodeURI(tag_id) + '</span><a class="close default_contact_remove_tag m-l-xs pull-left">&times</a></li></ul>').attr("_filter", tag_id);
						

	var filter_id = null;
		contactFiltersListView = new Base_Collection_View(
			{
				url : '/core/api/filters?type=PERSON',
				sort_collection : false,
				restKey : "ContactFilter",
				templateKey : "contact-filter-list",
				individual_tag_name : 'li',
				sort_collection : false,
				postRenderCallback : function(el)
				{
					var filter_name;
					// Set saved filter name on dropdown button
					if (filter_name = readCookie('contact_filter'))
					{
						/*
						 * Check whether filter contains recent of lead to set
						 * system filter names, to load results based on those
						 * filters
						 */
						if (filter_name.toLowerCase().indexOf('recent') >= 0)
							filter_name = "Recent";

						else if (filter_name.toLowerCase().indexOf('contacts') >= 0)
							filter_name = "My Contacts";

						else if (filter_name.toLowerCase().indexOf('leads') >= 0)
							filter_name = "Leads";

						// If is not system type get the name of the filter from
						// id(from cookie)
						else if (filter_name.indexOf("system") < 0)
						{
							filter_id = filter_name;
							if(contactFiltersListView.collection.get(filter_name))
									filter_name = contactFiltersListView.collection.get(filter_name).toJSON().name;
							
						}

						el.find('.filter-dropdown').append(filter_name);
					}

					if (!filter_name)
						return;

					
					$('.filter-criteria', cel)
					.html(
							'<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="inline-block m-r-xs v-middle">' + filter_name + '</span><a class="close default_filter">&times</a></li></ul>');
					
					if(filter_id)
						$('.filter-criteria', cel).attr("_filter", filter_id);
					else
						$('.filter-criteria', cel).attr("_filter", filter_name);
						
				} });

			// Fetchs filters
			contactFiltersListView.collection.fetch();
		
			var filter_dropdown_element = contactFiltersListView.render().el;
		
			// Shows in contacts list
			$('#filter-list', cel).html(contactFiltersListView.render().el);
}

/**
 * Removes filter from cookie and calls function to load default contacts
 * without filter
 */
function revertToDefaultContacts()
{
	// Erase filter cookie. Erases both contact and company filter
	eraseCookie('contact_filter');
	eraseCookie('contact_filter_type');
	eraseCookie('company_filter');
	eraseData('dynamic_filter');

	if (App_Contacts.contactsListView)
		App_Contacts.contactsListView = undefined;
	if (App_Contacts.contact_custom_view)
		App_Contacts.contact_custom_view = undefined;

	// Loads contacts
	App_Contacts.contacts();
}

function chainFiltersForContactAndCompany(el, data, callback) {
	if(data && data.contact_type) {
		if(data.contact_type == 'PERSON') {
			chainFilters($(el).find('.chained-table.contact.and_rules'), data.rules, undefined, false, false);
			chainFilters($(el).find('.chained-table.contact.or_rules'), data.or_rules, undefined, false, false);
			chainFilters($(el).find('.chained-table.company.and_rules'), undefined, undefined, false, true);
			chainFilters($(el).find('.chained-table.company.or_rules'), undefined, callback, false, true);
		} else if(data.contact_type == 'COMPANY') {
			chainFilters($(el).find('.chained-table.company.and_rules'), data.rules, undefined, false, true);
			chainFilters($(el).find('.chained-table.company.or_rules'), data.or_rules, undefined, false, true);
			chainFilters($(el).find('.chained-table.contact.and_rules'), undefined, undefined, false, false);
			chainFilters($(el).find('.chained-table.contact.or_rules'), undefined, callback, false, false);
		}
	} else {
		chainFilters($(el).find('.chained-table.contact.and_rules'), undefined, undefined, false, false);
		chainFilters($(el).find('.chained-table.contact.or_rules'), undefined, undefined, false, false);
		chainFilters($(el).find('.chained-table.company.and_rules'), undefined, undefined, false, true);
		chainFilters($(el).find('.chained-table.company.or_rules'), undefined, callback, false, true);
	}
}

function chainFiltersForContact(el, data, callback) {
	if(data) {
		chainFilters($(el).find('.chained-table.contact.and_rules'), data.rules, undefined, false, false);
		chainFilters($(el).find('.chained-table.contact.or_rules'), data.or_rules, callback, false, false);			
	} else {
		chainFilters($(el).find('.chained-table.contact.and_rules'), undefined, undefined, false, false);
		chainFilters($(el).find('.chained-table.contact.or_rules'), undefined, callback, false, false);
	}
}

/**
 * Chains fields using jquery.chained library. It deserialzed data into form
 * 
 * @param el
 */
function chainFilters(el, data, callback, is_webrules, is_company)
{
	if(is_company) {
		fillCompanyCustomFieldsInFilters(el, function(){
			show_chained_fields(el, data, true);
			if (callback && typeof (callback) === "function")
			{
				// execute the callback, passing parameters as necessary
				callback();
			}
		});
		return;
	} else {
		if(!SEARCHABLE_CONTACT_CUSTOM_FIELDS)
		{			
			/*if(window.location.hash.indexOf("contact-filter") != -1)
			   $("#content").html(getRandomLoadingImg());*/
			fillContactCustomFieldsInFilters(el, function(){
				show_chained_fields(el, data, true);
				if (callback && typeof (callback) === "function")
				{
					// execute the callback, passing parameters as necessary
					callback();
				}
			}, is_webrules)
			return;
		}
		
		fillCustomFields(SEARCHABLE_CONTACT_CUSTOM_FIELDS, el, undefined, false)
	}
	
	
	show_chained_fields(el, data);
	if (callback && typeof (callback) === "function")
	{
		// execute the callback, passing parameters as necessary
		callback();
	}
	
}

function show_chained_fields(el, data, forceShow)
{
	var el_self = $(el).clone();
	var LHS, condition, RHS, RHS_NEW, NESTED_CONDITION, NESTED_RHS, NESTED_LHS;

	// LHS, RHS, condition blocks are read from DOM
	LHS = $("#LHS", el);
	condition = $("#condition", el);
	RHS = $("#RHS", el);

	// Extra field required for (Between values condition)
	RHS_NEW = $("#RHS-NEW", el);

	NESTED_CONDITION = $("#nested_condition", el);
	NESTED_RHS = $("#nested_rhs", el);
	NESTED_LHS = $("#nested_lhs", el);
	
	RHS.chained(condition, function(chained_el, self){
		var selected_field = $(chained_el).find('option:selected');
		var placeholder = $(selected_field).attr("placeholder");
		var is_custom_field = $(selected_field).hasClass("custom_field");
		
		var field_type = $(selected_field).attr("field_type");
		
		// If there are any select fields without option elements they should be removed
		$("select", self).each(function(index, value){
			if($("option", value).length == 0)
				$(this).remove();
		})
		
		
		if(placeholder)
		{
			$("input", self).attr("placeholder", placeholder);
		}
		if(field_type && field_type == 'LIST')
		{
			var field_name = $(selected_field).attr("field_name");
			
			$("input", self).remove();
			$($('select[name="'+field_name+'"]', self)[0]).show();
			$('select:not([name="'+field_name+'"])', self).remove();
		}
		
		
	});
	condition.chained(LHS);
	
	RHS_NEW.chained(condition);
	NESTED_CONDITION.chained(LHS);
	NESTED_LHS.chained(NESTED_CONDITION);
	NESTED_RHS.chained(NESTED_CONDITION);

	if(data && data.rules) {
		deserializeChainedSelect(el, data.rules, el_self);
	} else if(data) {
		deserializeChainedSelect(el, data, el_self);
	}
		
	
	// If LHS selected is tags then typeahead is enabled on rhs field
	if ($(':selected', LHS).val() && ($(':selected', LHS).val()).indexOf('tags') != -1)
	{
		addTagsDefaultTypeahead(RHS)
	}

	// If there is a change in lhs field, and it has tags in it then tags are
	// loaded into its respective RHS block
	$('.lhs', el).on('change', function(e)
	{
		e.preventDefault();
		var value = $(this).val();

		if (value.indexOf('tags') != -1)
		{
			addTagsDefaultTypeahead($(this).closest('td').siblings('td.rhs-block'));
		}

	})
}

/**
 * Added tags typeahead on fields
 * 
 * @param element
 */
function addTagsDefaultTypeahead(element)
{
	var tags_array = [];

	// 'TAGS' are saved in global variable when they are fetched to show stats
	// in contacts page. If it is undefined, tags are fetched from DB an then type ahead is built
	if (!TAGS)
	{
		var TagsCollection = Backbone.Collection.extend({ url : '/core/api/tags', sortKey : 'tag' });

		tagsCollection = new TagsCollection();

		tagsCollection.fetch({ success : function(data)
		{
			TAGS = tagsCollection.models;
			addTagsArrayasTypeaheadSource(tagsCollection.toJSON(), element);

		} });
		return;
	}
	

	// Adds typeahead to given element
	addTagsArrayasTypeaheadSource(tagsCollection.toJSON(), element);
}

// With tags JSON sent type ahead is built on input fields
function addTagsArrayasTypeaheadSource(tagsJSON, element)
{
	var tags_array = [];

	$.each(tagsJSON, function(index, element)
	{
		tags_array.push(element.tag.toString());
	});

	// $("input", element).attr("data-provide","typeahead");
	$("input", element).typeahead({ "source" : tags_array }).attr('placeholder', "Enter Tag").width("92%");
}


function fillContactCustomFieldsInFilters(el, callback, is_webrules)
{

	$.getJSON("core/api/custom-fields/searchable/scope?scope=CONTACT", function(fields){
		console.log(fields);
		SEARCHABLE_CONTACT_CUSTOM_FIELDS = fields;
		fillCustomFields(fields, el, callback, is_webrules)
	})
}

function fillCompanyCustomFieldsInFilters(el, callback)
{
	if(!COMPANY_CUSTOM_FIELDS)
	{
		$.getJSON("core/api/custom-fields/searchable/scope?scope=COMPANY", function(fields){
			console.log(fields);
			COMPANY_CUSTOM_FIELDS = fields;
			fillCustomFields(fields, el, callback, false);
		});
	} else {
		fillCustomFields(COMPANY_CUSTOM_FIELDS, el, callback, false)
	}
}

var _AGILE_CUSTOM_DIVIDER_ = ' _AGILE_CUSTOM_DIVIDER_';
var custom_chained_filter = "custom_chained_class";
function fillCustomFields(fields, el, callback, is_webrules)
{
	var lhs_element = $("#LHS > select > #custom-fields", el);
	var rhs_element = $("#RHS", el);
	var condition = $("#condition > select", el);

	var _AGILE_CUSTOM_DIVIDER_ = ' _AGILE_CUSTOM_DIVIDER_';
	for(var i = 0; i < fields.length ; i++)
	{
		if(i == 0)
			lhs_element.removeClass('hide');
		var field = fields[i];

		condition.append('<option value="EQUALS" custom_chained_class= "'+field.field_label+ " " + _AGILE_CUSTOM_DIVIDER_ +'  custom_field" class="'+field.field_label + _AGILE_CUSTOM_DIVIDER_ + ' custom_field" field_type="'+field.field_type+'" field_name="'+field.field_label+'">is</option>');
		condition.append('<option value="NOTEQUALS" custom_chained_class= "'+field.field_label+ " " +_AGILE_CUSTOM_DIVIDER_+'  custom_field" class="'+field.field_label + _AGILE_CUSTOM_DIVIDER_ + ' custom_field" field_type="'+field.field_type+'" field_name="'+field.field_label+'">isn\'t</option>');

		if(field.field_type == "DATE")
		{
			lhs_element.append('<option value="'+field.field_label+'_time" field_type="'+field.field_type+'">'+field.field_label+'</option>');
			//condition.find("option.created_time").addClass(field.field_label+'_time');
			var element = condition.find("option.created_time"); 
			add_custom_class_to_filter_elements(element, field.field_label+'_time');
			$(element).addClass(field.field_label+'_time' + _AGILE_CUSTOM_DIVIDER_);
			if(!is_webrules)
			{
				condition.append('<option value="DEFINED" custom_chained_class= "'+field.field_label+'_time'+ " " + _AGILE_CUSTOM_DIVIDER_ +'  custom_field" class="'+field.field_label +'_time '+ _AGILE_CUSTOM_DIVIDER_ + ' custom_field" field_type="'+field.field_type+'" field_name="'+field.field_label+'">is defined</option>');
				condition.append('<option value="NOT_DEFINED" custom_chained_class= "'+field.field_label+'_time'+ " " +_AGILE_CUSTOM_DIVIDER_+'  custom_field" class="'+field.field_label +'_time																																				 '+ _AGILE_CUSTOM_DIVIDER_ + ' custom_field" field_type="'+field.field_type+'" field_name="'+field.field_label+'">is not defined</option>');
			}
		} else if(field.field_type == "NUMBER")
		{
			lhs_element.append('<option value="'+field.field_label+'_number" field_type="'+field.field_type+'">'+field.field_label+'</option>');
			// condition.find("option.lead_score").addClass(field.field_label+'_number');
			var element = condition.find("option.lead_score");
			add_custom_class_to_filter_elements(element, field.field_label+'_number');
			$(element).addClass(field.field_label+'_number' + _AGILE_CUSTOM_DIVIDER_);
			if(!is_webrules)
			{
				condition.append('<option value="DEFINED" custom_chained_class= "'+field.field_label+'_number'+ " " + _AGILE_CUSTOM_DIVIDER_ +'  custom_field" class="'+field.field_label +'_number '+ _AGILE_CUSTOM_DIVIDER_ + ' custom_field" field_type="'+field.field_type+'" field_name="'+field.field_label+'">is defined</option>');
				condition.append('<option value="NOT_DEFINED" custom_chained_class= "'+field.field_label+'_number'+ " " +_AGILE_CUSTOM_DIVIDER_+'  custom_field" class="'+field.field_label +'_number '+ _AGILE_CUSTOM_DIVIDER_ + ' custom_field" field_type="'+field.field_type+'" field_name="'+field.field_label+'">is not defined</option>');
			}
		
		}
		else
		{
			lhs_element.append('<option value="'+field.field_label+'" field_type="'+field.field_type+'" >'+field.field_label+'</option>');
			if(!is_webrules)
			{
				condition.append('<option value="DEFINED" custom_chained_class= "'+field.field_label+ " " + _AGILE_CUSTOM_DIVIDER_ +'  custom_field" class="'+field.field_label + _AGILE_CUSTOM_DIVIDER_ + ' custom_field" field_type="'+field.field_type+'" field_name="'+field.field_label+'">is defined</option>');
				condition.append('<option value="NOT_DEFINED" custom_chained_class= "'+field.field_label+ " " +_AGILE_CUSTOM_DIVIDER_+'  custom_field" class="'+field.field_label + _AGILE_CUSTOM_DIVIDER_ + ' custom_field" field_type="'+field.field_type+'" field_name="'+field.field_label+'">is not defined</option>');
			}
		
		}
		
		// Contacts and not contains should only be in webrules form
		if(is_webrules)
		{
			condition.append('<option value="MATCHES" custom_chained_class= "'+field.field_label+ " " + _AGILE_CUSTOM_DIVIDER_+'  custom_field" class="'+field.field_label +' custom_field" field_name="'+field.field_label+'">contains</option>');
			condition.append('<option value="NOT_CONTAINS"  custom_chained_class= "'+field.field_label+ " " +_AGILE_CUSTOM_DIVIDER_+'  custom_field" class="'+field.field_label+' custom_field" field_name="'+field.field_label+'">doesn\'t contain</option>');
		}
		
		if(field.field_type == "LIST")
		{
			var custom_list_values = field.field_data.split(";");
			el = "<select class='form-control' style='display:none' name='"+field.field_label+"'>"
			for(var j = 0; j < custom_list_values.length; j++)
			{
				
				el = el + '<option value="'+custom_list_values[j]+'" class="EQUALS NOTEQUALS MATCHES NOT_CONTAINS" field_type="'+field.field_type+'">'+custom_list_values[j]+'</option>';
			}
			el = el +"</select>";
			rhs_element.append(el);
		}
		console.log(rhs_element[0]);
	}
	
	if (callback && typeof (callback) === "function")
	{
		// execute the callback, passing parameters as necessary
		callback();
	}
}

function add_custom_class_to_filter_elements(element, className)
{
	var custom_class = $(element).attr(custom_chained_filter);
	 var attrClass = $(element).attr('class');
	if(!custom_class)
		custom_class = "";
	else
		{
		 var classArray = attrClass.split(" ");
	     if(classArray && classArray.length > 0)
	      {
	       for(var i = 0 ; i < classArray.length ; i++)
	        {
	         custom_class += (_AGILE_CUSTOM_DIVIDER_ + " " +classArray[i]); 
	        }
	      }
		}
	
	custom_class += (_AGILE_CUSTOM_DIVIDER_ + " " +className);
	console.log(custom_class)
	
	$(element).attr('custom_chained_class', custom_class);
}

function showDynamicFilters(el){
	if(readCookie(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS)=="hide"){
		$('#contacts-lhs-filters-toggle').hide();
	}
	else{
		$('#contacts-lhs-filters-toggle').show();
	}
}


function setUpContactView(cel,tagExists){

	
	if (readCookie("agile_contact_view"))
	{
		$('#contacts-view-options', cel).html("<a data-toggle='tooltip' data-placement='bottom' data-original-title='List View' class='btn btn-default btn-sm contacts-view' data='list'><i class='fa fa-list'  style='margin-right:3px'></i></a>");
	}
	else{
		$('#contacts-view-options', cel).html("<a data-toggle='tooltip' data-placement='bottom' data-original-title='Grid View' class='btn btn-default btn-sm contacts-view' data='grid'><i class='fa fa-th-large' style='margin-right:3px'></i></a>");
	}
	
}/**
 * Search.js is a used to show typeahead results in different page and also
 * initialized typeahead on search field in navbar client side.
 * 
 * @module Search author: Yaswanth
 */

/**
 * showSearchResults method is used to show the simple search/ typeahead results
 * in a separate page
 * 
 * @method showSearchResults
 */
function showSearchResults()
{
	/*
	 * Reads query keyword from input field to send a query request and show in
	 * separate page.
	 */
	var query_text = $("#searchText").val();

	// If keyword/input field is empty returns with out querying
	if (query_text == "")
		return;

	/*
	 * If App_Contacts route is not initialized, initializes it because
	 * typeahead can be accessed without entering in to contacts list view
	 */
	if (!App_Contacts)
		App_Contacts = new ContactsRouter();

	// Initialize contacts search results view
	App_Contact_Search.navigate("contacts/search/" + query_text, { trigger : true });
}

function navigateToDetailsPage(data, name)
{
	var model;
	for ( var i = 0; i < QUERY_RESULTS.length; i++)
	{
		if (QUERY_RESULTS[i].id != data)
			continue;

		model = QUERY_RESULTS[i];
		break;
	}
	console.log(model);
	if (model.entity_type == "contact_entity")
	{
		if(model.type == "COMPANY")
			App_Companies.navigate("company/" + data, { trigger : true });
		else
			App_Contacts.navigate("contact/" + data, { trigger : true });
		return;
	}
	if(model.entity_type == "deal")
	{
		if(!tight_acl.checkPermission('DEALS')){
			var obj = {};
			obj.entity = 'Deals';
			getTemplate('no-permission',obj, undefined, function(template_ui){
				if(!template_ui)
					  return;

				$(template_ui).modal('show');
			}, null);
			return;
		}
		// updateDeal(new BaseModel(model));
		console.log(model);
		var currentdeal=model;
		Backbone.history.navigate("deal/"+currentdeal.id , {
            trigger: true
        });
		return;
	}
	if(model.entity_type == "document")
	{
		if(!tight_acl.checkPermission('DOCUMENT')){
			var obj = {};
			obj.entity = 'Documents';

			getTemplate('no-permission',obj, undefined, function(template_ui){
				if(!template_ui)
					  return;

				$(template_ui).modal('show');
			}, null);

			return;
		}

		console.log(model);
		updateDocument(new BaseModel(model));
		return;
	}
		
	if(!tight_acl.checkPermission('CASES')){
		var obj = {};
		obj.entity = 'Cases';
		getTemplate('no-permission',obj, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$(template_ui).modal('show');
		}, null);

		return;
	}
	updatecases(new BaseModel(model));
}

/**
 * Initializes typeahead functionality on search field in top navbar, and
 * defines event action on the filed
 */
$(function()
{

	/*
	 * Enables typeahead in search field in top nav-bar, custom callback to
	 * redefine events on dropdown, which takes to contact details page
	 */
	agile_type_ahead("searchText", undefined, contacts_typeahead, navigateToDetailsPage, undefined, undefined, 'core/api/search/all/keyword');

	/*
	 * Click on search icon in search field top nav-bar, shows simple search
	 * results in separate page
	 */
	$('body').on('click', '#search-results', function(e)
	{
		e.preventDefault();
		showSearchResults();
	});
});
function load_imap_folders(el, model) {
	var id = model.id;
	var optionsTemplate = "<option {{selected}}>{{name}}</option>";
	fillSelect('imap-folders-multi-select', '/core/api/imap/' + id
			+ '/imap-folders', 'folders', function fillNew() {
		$("#imap-folders-multi-select .default-select", el).remove();

	}, optionsTemplate, false, el);
	var el2 = $(".imap-folders-settings-click", el).closest("div");
	$(".imap-folders-settings-click", el).css("display", "none");
	el2.find(".imap-folders-settings-txt").css("display", "none");
	el2.find(".imap-folders-select").css("display", "inline");
}

function load_gmail_widgets(limit) {
	// Gets Social Prefs (Same as Linkedin/Twitter) for Gmail
	gmailListView1 = new Base_Collection_View({
		url : 'core/api/social-prefs/GMAIL/list',
		templateKey : "settings-social-prefs",
		individual_tag_name : 'div',
		postRenderCallback : function(el) {
			var gmail_count = gmailListView1.collection.length;
			if ((gmail_count < limit && !HAS_EMAIL_ACCOUNT_LIMIT_REACHED)
					|| gmail_count === 0) {
				var data1 = {
					"service" : "Gmail",
					"return_url" : encodeURIComponent(window.location.href)
				};

				getTemplate("settings-social-prefs-model", data1, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#prefs-tabs-content').find("#social-prefs").append($(template_ui));
				}, null);
			}
			updateTimeOut();
		}
	});
	gmailListView1.collection.fetch();
	App_Settings.gmailListView = gmailListView1;
	$('#prefs-tabs-content').find("#social-prefs").html(App_Settings.gmailListView.el);
			
}
function load_imap_widgets(limit) {
	// Gets imap prefs
	imapListView1 = new Base_Collection_View({
		url : 'core/api/imap/',
		templateKey : "settings-imap-access",
		individual_tag_name : 'div',
		postRenderCallback : function(el) {
			var imap_count = imapListView1.collection.length;
			if ((imap_count < limit && !HAS_EMAIL_ACCOUNT_LIMIT_REACHED)
					|| imap_count === 0) {
				var data1 = {};

				getTemplate("settings-imap-access-model", data1, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#prefs-tabs-content').find("#imap-prefs").append($(template_ui));
				}, null);
			}
			updateTimeOut();
		}
	});
	imapListView1.collection.fetch();
	App_Settings.imapListView = imapListView1;
	$('#prefs-tabs-content').find("#imap-prefs").html(App_Settings.imapListView.el);
}

function load_office365_widgets(limit) {
	// Gets office prefs list
	officeListView1 = new Base_Collection_View({
		url : 'core/api/office/',
		templateKey : "settings-office-access",
		individual_tag_name : 'div',
		postRenderCallback : function(el) {
			var office_count = officeListView1.collection.length;
			if ((office_count < limit && !HAS_EMAIL_ACCOUNT_LIMIT_REACHED)
					|| office_count === 0) {
				var data1 = {};

				getTemplate("settings-office-access-model", data1, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#prefs-tabs-content').find("#office-prefs").append($(template_ui));
				}, null);
			}
			updateTimeOut();
		}
	});
	officeListView1.collection.fetch();
	App_Settings.officeListView = officeListView1;
	$('#prefs-tabs-content').find("#office-prefs").html(App_Settings.officeListView.el);
}

function updateTimeOut(widget_height) {
	setTimeout(function() {
		$('#all-email-settings-prefs .col-md-4 .panel').each(function() {	
			if($(this).height() > EMAIL_PREFS_WIDGET_SIZE)
				EMAIL_PREFS_WIDGET_SIZE = $(this).height();
		});
		$('#all-email-settings-prefs .col-md-4 .panel').each(function() {
			$(this).height(EMAIL_PREFS_WIDGET_SIZE);
		});
	},1000);
}

function load_imap_properties(model, el) {
	var id = model.id;
	var optionsTemplate1 = "<option value='{{id}}' {{selected}}>{{name}}</option>";
	var el1 = $('.imap-share-settings-select', el).closest("div");
	fillSelect('imap-share-user-select', 'core/api/imap/shared-to-users?id='
			+ id, 'users', function fillNew() {
		$("#imap-share-user-select .default-select", el).remove();
		$(".imap-share-select .loading", el).hide();
	}, optionsTemplate1, false, el1);

	var el2 = $('.imap-folders-settings-click', el).closest("div");
	var optionsTemplate2 = "<option {{selected}}>{{name}}</option>";
	fillSelect('imap-folders-multi-select', 'core/api/imap/' + id
			+ '/imap-folders', 'folders', function fillNew() {
		$("#imap-folders-multi-select .default-select", el).remove();

	}, optionsTemplate2, false, el2);
}


/**
*  Settings modal event listeners
*/
var Settings_Modal_Events = Base_Model_View.extend({

	/**
	 * For adding new document
	 */
	onGmailShareOptionsSelect: function(e){
		e.preventDefault();
		var target_el = $(e.currentTarget);

		var id = $(target_el).attr("oid");
		var el = $(target_el).closest("div");

		$(target_el).css("display", "none");
		el.find(".gmail-share-select").css("display", "inline");
		el.find(".gmail-share-settings-txt").css("display",
				"none");
		var optionsTemplate = "<option value='{{id}}' {{selected}}>{{name}}</option>";
		fillSelect(
				'gmail-share-user-select',
				'core/api/social-prefs/shared-to-users?id='
						+ id,
				'users',
				function fillNew() {
					$(
							"#gmail-share-user-select .default-select",
							el).remove();
				}, optionsTemplate, false, el);
	},

	 /**
	 * To cancel the imap share settings event
	 */
	onGmailShareOptionsCancel : function(e){

		if(e.target.parentElement.attributes[0].name!="href" && e.target.parentElement.attributes[1].name!="href"){
     		e.preventDefault();
     		var target_el = $(e.currentTarget);

     	 	var el = $(target_el).closest("div");
			var name = $(target_el).attr('name');
			el.find(".gmail-share-select").css("display", "none");
			el.find(".gmail-share-settings-select").css("display", "inline");
			el.find(".gmail-share-settings-txt").css("display", "inline");
	     }
	},

	/**
	 * Share imap settings with othe users
	 */
	onImapShareOptionsSelect : function(e){
		e.preventDefault();
		var target_el = $(e.currentTarget);

		var id = $(target_el).attr("oid");
		var el = $(target_el).closest("div");
		$(target_el).css("display", "none");
		el.find(".imap-share-settings-txt").css("display",
				"none");
		el.find(".imap-share-select").css("display", "inline");
		var optionsTemplate = "<option value='{{id}}' {{selected}}>{{name}}</option>";
		fillSelect(
				'imap-share-user-select',
				'core/api/imap/shared-to-users?id=' + id,
				'users',
				function fillNew() {
					$(
							"#imap-share-user-select .default-select",
							el).remove();
				}, optionsTemplate, false, el);
	},

	/**
	 * To cancel the imap share settings event
	 */
	onImapShareOptionsCancel : function(e){
		e.preventDefault();
		var target_el = $(e.currentTarget);

		var el = $(target_el).closest("div");
		var name = $(target_el).attr('name');
		el.find("#imap-share-user-select").empty();
		el.find(".imap-share-select").css("display", "none");
		el.find(".imap-share-settings-select").css("display", "inline");
		el.find(".imap-share-settings-txt").css("display", "inline");
	},

	/**
	 * Select imap server folder, will fetch mails from these folders
	 */
	onImapFoldersOptionsSelect :  function(e){
		e.preventDefault();
		var target_el = $(e.currentTarget);

		var el = $(target_el).closest("div");
		var id = $(target_el).attr("oid");
		$(target_el).css("display", "none");
		el.find(".imap-folders-select").css("display", "inline");
		var optionsTemplate = "<option {{selected}}>{{name}}</option>";
		fillSelect('imap-folders-multi-select', 'core/api/imap/' + id
				+ '/imap-folders', 'folders', function fillNew() {
			$("#imap-folders-multi-select .default-select", el)
					.remove();
		}, optionsTemplate, false, el);
	},

	/**
	 * To cancel the imap folder settings
	 */
	onImapFoldersOptionsCancel :  function(e){
		e.preventDefault();
		var target_el = $(e.currentTarget);

		var el = $(target_el).closest("div");
		el.find('#imap-folders-multi-select').empty();
		el.find(".imap-folders-select").css("display", "none");
		el.find(".imap-folders-settings-click").css("display", "inline");
	},


	/**
	 * Share office settings with other users
	 */
	onOfficeShareOptionsSelect : function(e){
		e.preventDefault();
		var target_el = $(e.currentTarget);

		var el = $(target_el).closest("div");
		$(target_el).css("display", "none");
		var id = $(target_el).attr("oid");
		el.find(".office-share-settings-txt").css("display",
				"none");
		el.find(".office-share-select")
				.css("display", "inline");
		var optionsTemplate = "<option value='{{id}}' {{selected}}>{{name}}</option>";
		fillSelect(
				'office-share-user-select',
				'core/api/office/shared-to-users?id=' + id,
				'users',
				function fillNew() {
					$(
							"#office-share-user-select .default-select",
							el).remove();
				}, optionsTemplate, false, el);
	},

	/**
	 * To cancel the imap share settings event
	 */
	onOfficeShareOptionsCancel : function(e){
		e.preventDefault();
		var target_el = $(e.currentTarget);

		var el = $(target_el).closest("div");
		var name = $(target_el).attr('name');
		el.find(".office-share-select").css("display", "none");
		el.find(".office-share-settings-select").css("display", "inline");
		el.find(".office-share-settings-txt").css("display", "inline");
	},

	onGmailPrefsDelete : function(e){
		e.preventDefault();
		var target_el = $(e.currentTarget);

		var saveBtn = $(target_el);
		var id = $(saveBtn).attr("oid");

		// Returns, if the save button has disabled attribute
		if ($(saveBtn).attr('disabled'))
			return;

		if (!confirm("Are you sure you want to delete this?"))
			return false;

		// Disables save button to prevent multiple click event issues
		disable_save_button($(saveBtn));

		$.ajax({
			url : '/core/api/social-prefs/delete' + "/" + id,
			type : 'DELETE',
			success : function() {
				enable_save_button($(saveBtn));
				App_Settings.email();
				return;
			}
		});
	},

	onImapOfficePrefsDelete : function(e){
		e.preventDefault();
		var target_el = $(e.currentTarget);

		var saveBtn = $(target_el);		
		var id = $(saveBtn).attr("oid");

		// Returns, if the save button has disabled attribute
		if ($(saveBtn).attr('disabled'))
			return;
		
		if(!confirm("Are you sure you want to delete?"))
    		return false;
		
		// Disables save button to prevent multiple click event issues
		disable_save_button($(saveBtn));

		var button_id = $(saveBtn).attr("name");

		$.ajax({
			url : '/core/api/' + button_id + "/delete/" + id,
			type : 'DELETE',
			success : function()
			{
				enable_save_button($(saveBtn));
				App_Settings.email();
				return;
			}
		});

	},

	events: {
		'click .gmail-share-settings-select': 'onGmailShareOptionsSelect',
		'click .gmail-share-settings-cancel': 'onGmailShareOptionsCancel',		
		'click .imap-share-settings-select': 'onImapShareOptionsSelect',		
		'click .imap-share-settings-cancel': 'onImapShareOptionsCancel',	
		'click .imap-folders-settings-click': 'onImapFoldersOptionsSelect',	
		'click .imap-folders-settings-cancel': 'onImapFoldersOptionsCancel',	
		'click .office-share-settings-select': 'onOfficeShareOptionsSelect',	
		'click .office-share-settings-cancel': 'onOfficeShareOptionsCancel',	
		'click #gmail-prefs-delete': 'onGmailPrefsDelete',	
		'click #office-prefs-delete,#imap-prefs-delete': 'onImapOfficePrefsDelete',	
	},

});


$(function(){
	
	$("#content").on("click", '#email-gateway-delete', function(e) {
		e.preventDefault();
		
		if(!confirm("Are you sure you want to delete?"))
    		return false;
		
		$.ajax({
			url: 'core/api/email-gateway',
			type: 'DELETE',
			success: function(){
				
				if(App_Admin_Settings.email_gateway && App_Admin_Settings.email_gateway.model)
			     {
			    	 var data = App_Admin_Settings.email_gateway.model.toJSON();
			    	 
			    	 if(data.email_api == "MANDRILL")
			    	 {
			    		 	// Delete mandrill webhook
							$.getJSON("core/api/email-gateway/delete-webhook?api_key="+ data.api_key+"&type="+data.email_api, function(data){
								
								console.log(data);
								
							});
			    	 }
			     }	
				
				location.reload(true);
			}
		});
	});

	$("#content").on('click', '#sms-gateway-delete', function(e){ 
		e.preventDefault();
		
		if(!confirm("Are you sure you want to delete?"))
    		return false;
		var id=$(this).attr('data');
		$.ajax({
			url: 'core/api/widgets/integrations/'+id,
			type: 'DELETE',
			success: function(){
				location.reload(true);
			}
		});
	});

});



	/**
 * Calls from onload of Profile image on add contact form to fill account
 * holder's name in Form.
 */
function onloadProfileImg()
{
	// Save button for twitter on addStreamModal is shown.
	$('#add_twitter_stream').show();

	getTemplate('twitter-stream-type', {}, undefined, function(template_ui){
		if(!template_ui)
			  return;

		// Add twitter stream types template.
		$("#streamDetails").html($(template_ui));

		// Add profile image to account description.
		$('#twitter_profile_img').attr("src", document.getElementById("twitter_profile_img_url").src);

		// Add screen name to label.
		document.getElementById('account_description_label').innerHTML = '<b>' + $('#twitter_account').val() + '</b>';

	}, "#streamDetails");
	
}

// Add website and select network on continue form in add contact form flow for update page.
function socialsuite_add_website()
{
	if (Tweet_Owner_For_Add_Contact != null)
	{
		// Add values in continue form after add contact form.
		// Add website / handle of twitter of tweet owner.
		$("#website", $('#continueform')).attr("value", Tweet_Owner_For_Add_Contact);

		// Select network type.
		$("div.website select").val("TWITTER");

		Tweet_Owner_For_Add_Contact = null;
	}
}

/*
 * Change property of website and select network in add contact form. When email
 * id is entered, pic is related to that. When email id is not there so twitter
 * profile image is selected. There is some error already, so to adjust size of
 * image and twitter handle text size as per that.
 */
function changeProperty()
{
	var display = $('#network_handle', $('#personModal')).css("display");
	var picDisplay = $("#pic", $('#personModal')).css("display");
	var picValue = $("#pic", $('#personModal')).html();

	if ((picDisplay == 'inline' || picDisplay == 'block') && picValue != '')
	{
		if (display == 'none')
			document.getElementById("network_handle").className = 'after-img-load-hide';
		else if (display == 'block')
			document.getElementById("network_handle").className = 'after-img-load-show';

		document.getElementById("handle").className = 'add-form-input';
	}
	else if ((picDisplay == 'none' || picDisplay == null || picDisplay == '') || (picValue == null || picValue == ''))
	{
		if (display == 'none')
			document.getElementById("network_handle").className = 'network-handle';
		else if (display == 'block')
			document.getElementById("network_handle").className = 'socialsuite-network-handle';

		document.getElementById("handle").className = '';
	}
}
$(function()
{
	/**
	 * After display of add contact form, Fills name with tweet owner's name in
	 * add-contact popup form.
	 */
	$('body').on('click', '.add-twitter-contact', function(e)
	{
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetId = ($(this).closest('article').attr('id'));

		// Get stream from collection.
		var modelStream = Streams_List_View.collection.get(streamId);

		// Get tweet from stream.
		var tweet = modelStream.get('tweetListView').get(tweetId).toJSON();

		// Tweet owner's full name.
		var fullName = tweet.user.name;

		// Tweet owner's description.
		var description = tweet.user.description;

		// Tweet owner's handle/Screen name.
		Tweet_Owner_For_Add_Contact = tweet.user.screen_name;

		// Separate full name.
		var firstName = fullName.substr(0, fullName.indexOf(' '));
		var lastName = fullName.substr(fullName.indexOf(' ') + 1);

		// Add values in add contact form.
		$("#fname", $('#personModal')).attr("value", firstName);
		$("#lname", $('#personModal')).attr("value", lastName);
		$("#job_title", $('#personModal')).attr("value", description);

		document.getElementById("network_handle").className = 'socialsuite-network-handle';
		$("#handle", $('#personModal')).attr("value", Tweet_Owner_For_Add_Contact);

		// Add website / handle of twitter of tweet owner.
		$("#website", $('#personModal')).attr("value", Tweet_Owner_For_Add_Contact);
		$("#image", $('#personModal')).attr("value", tweet.user.profile_image_url);

		// Select network type.
		$("div.website select").val("TWITTER");

		// If picture is not null and undefined, display it by given width, else
		// display none
		var pic = tweet.user.profile_image_url;
		if (pic != undefined && pic != null)
		{
			var el = $('<img class="imgholder thumbnail person-img" onload="changeProperty()" style="display: inline;"  src="' + pic + '"></img>');
			$('#pic').html(el).show();
			$("img").error(function()
			{
				$('#pic').css("display", "none");
			});
		}

		// As per pic property need to change social suites element property.
		changeProperty();
	});

	// Hide network handle from add contact form.
	$('#personModal').on('hidden.bs.modal', function()
	{
		document.getElementById("network_handle").className = 'network-handle';
		document.getElementById("handle").className = '';
		$('#pic').css("display", "none");
		$('#pic').empty();
		changeProperty();
	});

	// If img is shown then reduce size of network handle on add contact form.
	$('#personModal').on('shown.bs.modal', function()
	{
		changeProperty();
	});
	$('#personModal').on('show.bs.modal', function()
	{
		changeProperty();
	});
	$("#pic").change(function()
	{
		changeProperty();
	});
});
/**
 * When social tab is not selected or user is in different tab, so add isNew
 * field with value true in tweet. so that will usefull to count unread tweets
 * and display that count in stream notification.
 */
function isNewUnreadTweet(tweet)
{
	var modelStream = null;

	// Newly register stream tweet or first tweet. So need to take stream from
	// original collection.
	if (tweet.id == "000" || tweet.type == "ACK")
	{
		console.log("got 000");
	}
	else
	{
		tweet["isNew"] = "true";
	}

	// Get stream from collection.
	modelStream = Streams_List_View.collection.get(tweet.stream_id);

	// Add tweet to stream model.
	rebuildTweet(modelStream, tweet);
}

/**
 * Calls method to Add Tweet in relevant stream (in sub-collection) with some extra tags as per
 * requirement are added. We were not having pubnub channel capacity so this solution
 * applied.
 */
function rebuildTweet(modelStream, tweet)
{
	// Hide waiting symbol.
	$("#stream-spinner-modal-" + tweet.stream_id).hide();

	// Add type of message
	if (tweet.text == "There is no tweets to show here." || tweet.text == "Dear you do not have any tweets.")
	{
		tweet["msg_type"] = "NoTweet";
		tweet["show"] = true;
		tweet.text = "No Tweets to show here.";
	}
	else if (tweet.type == "ACK")
	{
		// This ACK is from our social server to indicate current stream is
		// registered.
		tweet["msg_type"] = "ACK";
		tweet["text"] = "ACK";
	}
	else
	{
		//console.log(tweet);
		if (tweet.text == null || tweet.user == null)
			return;

		tweet["msg_type"] = "Tweet";

		//console.log(modelStream.get('tweetListView').length);

		// Remove no tweet notification.
		if (modelStream.get('tweetListView').length == 2)
			clearNoTweetNotification(modelStream);

		// If stream owner is tweet owner no need to show retweet icon.
		if (modelStream.get('screen_name') != tweet.user.screen_name)
			tweet["tweetowner_not_streamuser"] = true;

		// If stream is Sent or tweet owner is stream owner then show delete
		// option.
		if (tweet.stream_type == "Sent" || modelStream.get('screen_name') == tweet.user.screen_name)
			tweet["deletable_tweet"] = true;

		// If tweet is DM then show delete options and hide other options.
		if (tweet.stream_type == "DM_Inbox" || tweet.stream_type == "DM_Outbox")
		{
			tweet["direct_message"] = true;
			tweet["deletable_tweet"] = true;
		}

		// To set RT icon green, to show tweet is RT by user.
		var checkRT = modelStream.get('screen_name') + " retweeted";
		if (tweet.retweeted == checkRT)
			tweet["retweeted_by_user"] = true;

		// Save original text for other actions.
		tweet["original_text"] = tweet.text;

		// Converts normal text to tweet with link on url, # and @.
		tweet.text = convertTextToTweet(tweet);
	}

	// console.log("tweet : "+tweet.text);
	// console.log("add at "+modelStream.get('tweetListView').length);

	// On scroll down, To avoid freezing, collect 5 tweets in JSON Array and then add to stream.
	if (Scroll_Down_Call == true)
	{
		checkPastTweetAdd(tweet, modelStream);
		return;
	}

	/*
	 * Ack from server that shows current streams registration is done. So call
	 * register all with new counter to register next stream
	 */
	if (tweet.type == "ACK")
	{
		Register_Counter++;
		registerAll(Register_Counter);
	}

	// Add tweet to relevant stream.
	addTweetToStream(tweet, modelStream);
}

/**
 * Add given tweets in given stream model which is sub-collection.
 */
function addTweetToStream(tweet, modelStream)
{
	// Sort stream on tweet id basis which is unique and recent tweet has highest value.
	modelStream.get('tweetListView').comparator = function(model)
	{
		if (model.get('id'))
			return -model.get('id');
	};

	// Add tweet to stream.
	modelStream.get('tweetListView').add(tweet);

	// Sort stream on id. so recent tweet comes on top.
	modelStream.get('tweetListView').sort();

	// Create normal time.
	displayTimeAgo($(".chirp-container"));
}

/**
 * Removes isNew field from tweet so new unread tweet can be visible in stream. 
 */
function mergeNewUnreadTweets(streamId)
{
	// Get stream from collections.
	var stream = Streams_List_View.collection.get(streamId);

	var newAddedTweets = stream.get('tweetListView').where({ isNew : "true" });

	$.each(newAddedTweets, function(i, tweetModel)
	{
		tweetModel.unset("isNew");
	});

	// Create normal time.
	displayTimeAgo($(".chirp-container"));

	// Remove waiting symbol.
	removeWaiting();
}
/*
 * Remove waiting symbol from stream's column header, 
 * when user return to social tab as well as after getting reply from social server.
 */
function removeWaiting()
{
	var streamsJSON = Streams_List_View.collection.toJSON();

	// Streams not available.
	if (streamsJSON == null)
		return;

	// Get stream
	$.each(streamsJSON, function(i, stream)
	{
		// Get stream from collection.
		var modelStream = Streams_List_View.collection.get(stream.id);

		if (modelStream != null || modelStream != undefined)
		{
			// If any collection have some tweets then remove waiting.
			if (modelStream.get('tweetListView').length >= 1)
			{
				// Hide waiting symbol.
				$("#stream-spinner-modal-" + stream.id).hide();
			}
		}
	});
}
/*
 * Check valid scheduled. Selected schedule should be in future time. 
 * If it is past or current time then revert action and show alert.
 */
function isTimeInPast()
{
	// Get selected date and time.
	var scheduledDate = document.getElementById('scheduled_date').value;
	var scheduledTime = document.getElementById('scheduled_time').value;

	// Current date and time.
	var today = new Date().format('mm/dd/yyyy');
	var now = new Date();

	var min = (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();

	now = now.getHours() + ':' + min;

	// Convert selected schedule in epoch time.

	// selected schedule.
	var schedulearray = (scheduledTime).split(":");
	var sdate = new Date(scheduledDate);
	var selectedSchedule = sdate.setHours(schedulearray[0], schedulearray[1]) / 1000.0;

	// current schedule.
	var currentSchedulearray = (now).split(":");
	var currentSdate = new Date(today);
	var currentSchedule = currentSdate.setHours(currentSchedulearray[0], currentSchedulearray[1]) / 1000.0;

	if (selectedSchedule > currentSchedule) // Future Time
	{
		// Appending schedule.
		var schedulearray = (scheduledTime).split(":");
		var sdate = new Date(scheduledDate);
		sdate = sdate.setHours(schedulearray[0], schedulearray[1]) / 1000.0;
		document.getElementById('schedule').value = sdate;

		var myDate = new Date(sdate * 1000);

		// Changes in UI.
		$('#send_tweet').removeAttr("disabled");
		Schedule_In_Future = true;

		// To check text limit after button text change.
		$('#twit-tweet').keypress();
	}
	
	// Past Time
	else
	{
		alert("Please select Date/Time in future.");
		$("#send_tweet").attr("disabled", "disable");
		Schedule_In_Future = false;
	}
}

/**
 * Gets Scheduled Updates count fron DB and show or hide button which links to
 * scheduled updates page.
 */
function checkScheduledUpdates()
{	
	// Get scheduled updates count
	$.getJSON("/core/scheduledupdate/getscheduledupdatescount", function(data)
	{
		if (data > 0)
			$("#show_scheduled_updates").show();
		
	}).error(function(jqXHR, textStatus, errorThrown)
	{
		$("#show_scheduled_updates").hide();
		console.log("Error occured in scheduled updates search.");
	});
}

/**
 * On click of scheduled update it will open message modal. And on click of
 * schedule it will save modified scheduled update.
 */
function scheduledmessagesEdit(id)
{
	$('#socialsuite_twitter_messageModal').remove();

	// Gets the update from its collection
	var selectedUpdate = Scheduled_Updates_View.collection.get(id);

	Scheduled_Edit = true;

	Message_Model = new Base_Model_View({ url : '/core/scheduledupdate', model : selectedUpdate, template : "socialsuite-twitter-message",
		modal : '#socialsuite_twitter_messageModal', window : 'scheduledmessages', postRenderCallback : function(el)
		{
			// Remove back drop, It remains there so need to remove.
			$('.modal-backdrop').remove();

			// Only once it will execute for same scheduled update on one click.
			if (!selectedUpdate.hasChanged())
			{
				// After displaying modal with details, need to show schedule from selected message.
				$("#socialsuite_twitter_messageModal", el).on('shown.bs.modal', function()
				{
					/*
					 * Shows scheduling clock icon on message modal with
					 * selected scheduled with disabled click event, so user
					 * only can schedule message.
					 */
					$("#tweet_scheduling", el).click();

					// Display date from selected message in message modal.
					$('input.date', $('#schedule_controls')).val((new Date(selectedUpdate.toJSON().scheduled_date * 1000)).toLocaleDateString());

					// For Testing: Enables schedule button if selected
					// scheduled update having future schedule.
					//isTimeInPast();
					// Changes in UI.
					$('#send_tweet').removeAttr("disabled");
				});

				// Show modal with details.
				$('#socialsuite_twitter_messageModal', el).modal('show');
			}
		}, saveCallback : function(data)
		{			
			// Hide message modal.
			$('#socialsuite_twitter_messageModal').modal('hide');
			$('#socialsuite_twitter_messageModal').remove();
			$('.modal-backdrop').remove();
			Scheduled_Edit = false;

			// Default check box is not added so need to add from handlebar so that will check this condition.
			data["checkbox"] = true;

			// Update changes in UI.
			selectedUpdate.set(data);
			
			// Creates normal time.
			displayTimeAgo($(".is-actionable"));
		} });

	// Add modal in "#schedule-edit-modal" Div on same page, to display modal with details.
	$('#schedule-edit-modal').html(Message_Model.render().el);

} // scheduledmessagesEdit end

/**
 * This file contains event of button which shows calendar and timer in message
 * modal and check selected schedules range.
 */

$(function()
{
	/* Show calender and time for selection on message modal. */
	$('body').on('click', '#tweet_scheduling', function(e)
			{
				// Message modal open for edit scheduled update.
				if ($("#schedule_controls").css("display") == "block" && Scheduled_Edit)
					return;

				// Toggle calendar and timer.
				$("#schedule_controls").toggle();

				if ($("#schedule_controls").css("display") == "block")
				{
					// Change send button's text.
					document.getElementById("send_tweet").innerHTML = "Schedule";
					$("#send_tweet").attr("disabled", "disable");

					this.className = "tweet-scheduling tweet-scheduling-active";

					// Set current date.
					$('input.date').val(getDateInFormat(new Date()));
					$('#scheduled_date').datepicker({ startDate : "today", autoclose : true, todayHighlight : true, format : CURRENT_USER_PREFS.dateFormat }).on('changeDate',
							function(ev)
							{
								console.log(new Date(ev.date));

								// Check selected schedule
								isTimeInPast();
							});

					// Set current time.
					$('#scheduled_time').timepicker({ showMeridian : false, defaultTime : 'current' }).on('changeTime.timepicker',
							function(e)
							{
								console.log(e.time.value);

								// Check selected schedule
								isTimeInPast();
							});

					// Save original URL from model.
					Previous_URL = Message_Model.model.url;

					// Update scheduled URL in model.
					Message_Model.model.url = '/core/scheduledupdate';
				}
				else
				{
					// Message modal open for scheduled update edit.
					if (Scheduled_Edit)
						return;

					this.className = "tweet-scheduling";
					// $('input.date').val()='';
					$('#scheduled_time').attr("value", '');

					// Set original URL back to model.
					Message_Model.model.url = Previous_URL;

					// Change send button's text.
					document.getElementById("send_tweet").innerHTML = "Send";
					$('#send_tweet').removeAttr("disabled");

					// Scheduling de-select
					Schedule_In_Future = false;

					// To check text limit after button text change.
					$('#twit-tweet').keypress();
				}
			});

	/**
	 * Calls function to check selected time after cloasing Time picker modal.
	 */
	/**$('.bootstrap-timepicker').live('hide', function()
	{
		isTimeInPast();
	});
	*/

	/**
	 * Calls function to open Message modal with selected scheduled update
	 * details and save into DB after modifications.
	 */
	$('body').on('click', '.edit-scheduled-update', function(e)
	{
		var updateId = $(this).closest('tr').find('.data').attr('data');

		// Opens Message Modal and save modifications in DB, makes changes in
		// UI.
		scheduledmessagesEdit(updateId);
	});
});
/**
 * Fill details of stream in add-stream form and arrange elements as per
 * requirement.
 */
function fillStreamDetail()
{
	// Network Type not selected
	Network_Type = null;

	// Stream Type not selected
	Stream_Type = null;

	// Empty screen name means Oauth is not done.
	$("#twitter_account", $('#addStreamModal')).attr("value", '');

	// Empty stream type.
	$("#stream_type", $('#addStreamModal')).attr("value", '');

	// remove keyword input element
	$('.remove-keyword').remove();

	// Add value to hidden input element.
	$("#domain_user_id", $('#addStreamModal')).attr("value", CURRENT_DOMAIN_USER.id);
	$("#client_channel", $('#addStreamModal')).attr("value", CURRENT_DOMAIN_USER.id + "_Channel");

	// Add button for twitter is hidden.
	$('#add_twitter_stream').hide();

	// To hide stream type description.
	document.getElementById("stream_description_label").className = 'description-hidden txt-mute';

	// Empty hidden profile image on form.
	$('#twitter_profile_img_url').attr("src", "");
}


/**
 * Register all streams on social server.
 */
function registerAll(index)
{
	var streamsJSON = Streams_List_View.collection.toJSON();

	// Streams not available OR streams already registered OR pubnub not
	// initialized OR (index 0 stream is done and Register_Counter is increased.)
	if (streamsJSON == null || Register_All_Done == true || Pubnub == null || (Register_Counter != null && index == 0))
	{
		console.log("Register_All_Done : " + Register_All_Done);
		return;
	}

	// Get stream.
	var stream = Streams_List_View.collection.at(index);

	// Check stream is present or added in collection.
	if (stream == null || stream == undefined)
		return;

	// First stream from collection to register and assign value to RC.
	if (index == 0 && Register_Counter == null)
	{
		Register_Counter = 0;

		// Add user's profile img from twitter to stream header.
		if (Add_Img_Done == false)
			addUserImgToColumn();
	}

	// Publish data to register on server
	var publishJSON = { "message_type" : "register", "stream" : stream };
	sendMessage(publishJSON);

	// All added streams registered.
	if (Register_Counter == (Streams_List_View.collection.length - 1))
		Register_All_Done = true;
}

/**
 * On logout or browser/window clise, Unregister all streams on server.
 */
function unregisterAll()
{
	// Collection not defined.
	if (!Streams_List_View)
		return;

	// Streams not available OR pubnub not initialized.
	if (Streams_List_View == undefined || Pubnub == null)
		return;

	// Unregister on server
	var publishJSON = { "message_type" : "unregister_all", "client_channel" : CURRENT_DOMAIN_USER.id + "_Channel" };
	sendMessage(publishJSON);

	// Flush all data.
	Register_All_Done = false;
	Register_Counter = null;
	Add_Img_Done = false;
	Streams_List_View = undefined;
}

/**
 * Add relevant profile img from twitter to stream in column header.
 */
function addUserImgToColumn()
{
	var streamsJSON = Streams_List_View.collection.toJSON();

	// Get stream
	$.each(streamsJSON, function(i, stream)
	{
		// Get stream from collection.
		var modelStream = Streams_List_View.collection.get(stream.id);

		// Fetching profile image url from twitter server
		$.get("/core/social/getprofileimg/" + stream.id, function(url)
		{
			// Set url in stream model.
			modelStream.set("profile_img_url", url);

			// Append in collection
			socialsuitecall.streams(modelStream);
		});
	});
	Add_Img_Done = true;
}

/**
 * On click of retry button in stream notification,
 * Sends register message again to twitter server. 
 */
function registerStreamAgain(streamId)
{
	// Fetch stream from collection
	var stream = Streams_List_View.collection.get(streamId).toJSON();

	// Register on server
	var publishJSON = { "message_type" : "register", "stream" : stream };
	sendMessage(publishJSON);

	// Show waiting symbol.
	$("#stream-spinner-modal-" + streamId).show();
}
/**
 * Calls updateNotification method to update or add new tweet notification with
 * count of new unread tweets in stream.
 * 
 * @param stream
 */
function showNotification(stream)
{
	if (stream)
		updateNotification(stream);
	else
	{
		var streamsJSON = Streams_List_View.collection.toJSON();

		// Streams not available.
		if (streamsJSON == null)
			return;

		// Get stream
		$.each(streamsJSON, function(i, stream)
		{
			updateNotification(stream);
		});
	}

	// Remove deleted tweet element from ui
	$('.deleted').remove();
}

/**
 * Check for new tweets when user was not in social tab. Show new tweet
 * notification on respective stream with number of new tweet.
 */
function updateNotification(stream)
{
	// Get stream from collection.
	var modelStream = Streams_List_View.collection.get(stream.id);

	// Get all new unread tweet on basis of isNew field value true.
	var newAddedTweets = modelStream.get('tweetListView').where({ isNew : "true" });

	// If no new unread tweets are available but stream has some tweets so clear
	// no tweet notification from stream.
	if (newAddedTweets.length == 0 && modelStream.get('tweetListView').length >= 1)
	{
		// Remove no tweet notification.
		clearNoTweetNotification(Streams_List_View.collection.get(stream.id));

		return;
	}
	else if (newAddedTweets.length == 1)
	{
		// Add notification of new tweet on stream.
		document.getElementById('stream_notifications_' + stream.id).innerHTML = '<p class="bg-info">' + newAddedTweets.length + ' new Tweet </p>';
	}
	else if (newAddedTweets.length > 1)
	{
		// Add notification of new tweets on stream.
		document.getElementById('stream_notifications_' + stream.id).innerHTML = '<p class="bg-info">' + newAddedTweets.length + ' new Tweets </p>';
	}

	/*
	 * Add relation from <div> for notification. So on click of notification we
	 * can add new unread tweets to stream.
	 */
	$('#stream_notifications_' + stream.id).attr("rel", 'add-new-tweet');
}

/**
 * Remove no tweet notification. Search for that tweet in collection and makes
 * that tweets model hide.
 */
function clearNoTweetNotification(modelStream)
{
	// Get tweet from stream.
	var modelTweet = modelStream.get('tweetListView').get('000');

	if (modelTweet != null || modelTweet != undefined)
	{
		// Set show false, so handlebar condition check will avoid to display.
		modelTweet.set("show", false);

		// Add back to stream.
		modelStream.get('tweetListView').add(modelTweet);
	}
}

/**
 * When request rate limit is exceeded so Twitter server send code 88, It will
 * not accept any more REST call. When Twitter service or network is unavailable
 * User have to wait for some time and retry again. We need to display
 * notification for that in relavant stream.
 */
function displayErrorInStream(errorMsg)
{
	var streamId = null;

	// Get stream id.
	if (errorMsg.id == "001") // from Tweet
		streamId = errorMsg.stream_id;
	else
		// from Stream
		streamId = errorMsg.id;

	// Hide waiting symbol.
	$("#stream-spinner-modal-" + streamId).hide();

	var modelStream = Streams_List_View.collection.get(streamId);

	if (modelStream.get('tweetListView').length == 0)
	{
		// Add notification of error on stream.
		document.getElementById('stream_notifications_' + streamId).innerHTML = '<p>Request rate limit exceeded, Retry after some time. <i class="icon icon-refresh" title="Retry again."></i></p>';

		// Add relation from <div> for notification.
		$('#stream_notifications_' + streamId).attr("rel", 'retry');
	}
}
/**
 * Checks scroll reached to end or not. Suppose it reached to end then call past
 * tweets and add to stream as well as maintain scrolls current position.
 * 
 * @param elementDiv -
 *            element where scrollDown performed
 */
function OnScrollDiv(elementDiv)
{
	// Check scroll bar is reached to end and function is not called before.
	if (($(elementDiv).scrollTop() + $(elementDiv).innerHeight() >= $(elementDiv)[0].scrollHeight) && ($(elementDiv).attr("data") == "0"))
	{

		// Function is alredy called for this stream.
		$(elementDiv).attr("data", "1");

		// Get stream id.
		var streamId = ($(elementDiv).closest('li').attr('id'));

		// Get stream from collection.
		var modelStream = Streams_List_View.collection.get(streamId);

		// Stream not found.
		if (modelStream == undefined || modelStream == null)
			return;

		// model to json.
		var stream = modelStream.toJSON();

		// Get tweet from stream.
		var modelTweet = modelStream.get('tweetListView').at(modelStream.get('tweetListView').length - 2);
		var tweet = modelTweet.toJSON();
	
		// Store reference to top message
		var currMsg = $("#" + tweet.id);

		// Store current scroll/offset
		var curOffset = currMsg.offset().top - $(elementDiv).scrollTop();

		// Append loading icon.
		$(elementDiv)
				.append(
						'<span id="stream-waiting-modal-' + streamId + '" class="social-loader-icon text-center"><img class="thumb-tiny" src="img/ajax-spinner.gif"></span>');

		/*
		 * Calls TwitterAPI class to request for 20 more updates tweeted before
		 * the tweet id of the last update
		 */
		$
				.getJSON(
						"/core/social/pasttweets/" + stream.id + "/" + tweet.id + "/" + tweet.id_str,
						function(data)
						{
							// If no more updates available, show message.
							if (data == null)
							{
								showNotyPopUp('information', "No more updates available for stream " + stream.stream_type + " of " + stream.screen_name, "top",
										5000);

								// Remove loading icon.
								$('#stream-waiting-modal-' + streamId).remove();

								// Do not call this function again once its
								// called on one scroll.
								$(elementDiv).attr("data", "1");

								// Twitter icon and up arrow appended in stream
								// to show no more tweets available.
								$(elementDiv)
										.append(
												'<span id="past-tweet-end-' + streamId + '" class="text-light p-t-sm p-b-sm  block text-center"><i class="icon icon-twitter icon-2x m-r-xs"></i><i class="icon icon-long-arrow-up icon-2x"></i></span>');
								return;
							}
							if (data.length == 0)
							{
								showNotyPopUp('information', "No more updates available for stream " + stream.stream_type + " of " + stream.screen_name, "top",
										5000);
								$('#stream-waiting-modal-' + streamId).remove();
								$(elementDiv).attr("data", "1");
								$(elementDiv)
										.append(
												'<span id="past-tweet-end-' + streamId + '" class="text-light p-t-sm p-b-sm  block text-center"><i class="icon icon-twitter icon-2x m-r-xs"><i class="icon icon-long-arrow-up icon-2x"></i></i></span>');
								return;
							}

							
							 // Populate the collection with update stream
							 // details and show
							 
							var i;
							var myObject;

							// Global flag set.
							Scroll_Down_Call = true;

							for (i = 0; i < data.length; i++)
							{
								// String to json.
								myObject = eval('(' + data[i] + ')');

								// Add tweet to stram.
								handleMessage(myObject);

								// All tweets done.
								if (i + 1 == data.length)
									Scroll_Down_Call = false;
							}

							// Add remaining tweets.
							if (Scroll_Down_Call == false && Past_Tweets_Count != 0 && Past_Tweets.length != 0)
								addPastTweetsToStream(modelStream);

							// Set scroll to current position minus previous
							// offset/scroll
							var scrollOnDiv = $('#' + streamId).find('#Column-model-list');
							scrollOnDiv.scrollTop((currMsg.offset().top - curOffset) + 650);

							// Remove loading icon.
							$('#stream-waiting-modal-' + streamId).remove();

							// One function call for current stream is over.
							$(elementDiv).attr("data", "0");

						}).error(function(data)
				{
					// Loading icon remove.
					$('#stream-waiting-modal-' + streamId).remove();

					// One function call for current stream is over.
					$(elementDiv).attr("data", "0");

					var result = data.responseText;

					// Error message is shown to the user
					if (data.responseText == "")
						showNotyPopUp('information', "No more updates available for stream " + stream.stream_type + " of " + stream.screen_name, "top", 7000);
					else if (result.indexOf("rate") != -1)
						showNotyPopUp('information', "Request rate limit exceeded, Retry after some time.", "top", 5000);
					else if (result.indexOf("Could not fetch URL") != -1)
						showNotyPopUp('information', "Please, check your internet connection.", "top", 5000);
					else
						showNotyPopUp('information', data.responseText, "top", 5000);
				});
	}

	// Remove deleted tweet element from ui
	$('.deleted').remove();
}

// Checks counter and adds tweet in json array.
function checkPastTweetAdd(tweet, modelStream)
{
	// If collected tweets less than 5.
	if (Past_Tweets_Count < 5)
	{
		// Add tweet in json array.
		Past_Tweets[Past_Tweets_Count] = tweet;

		// Increment counter.
		Past_Tweets_Count++;
	}
	else if (Past_Tweets_Count == 5)
	{
		// If collected tweets are 5 then add them in to stream.
		addPastTweetsToStream(modelStream);
	}
}

/**
 * Fetches relavant stream model from collection and update that collection with
 * past tweets fetched on scroll down.
 */
function addPastTweetsToStream(modelStream)
{
	// If no tweets to add in collection.
	if (Past_Tweets.length == 0)
		return;

	// Update collection.
	addTweetToStream(Past_Tweets, modelStream);

	// Reset json array and counter.
	Past_Tweets_Count = 0;
	Past_Tweets = [];
}
/** 
 * This file contains all event related actions on Stream, 
 * Like add stream, remove stream, select network type, select stream type, etc.
 */

/** On load of social suites page. */
$(function()
{
	// Default values
	Stream_Type = null;
	Network_Type = null;
	Register_All_Done = false;
	Tweet_Owner_For_Add_Contact = null;
	Focused = true;
	Scheduled_Edit = false;
	Register_Counter = null;
	Add_Img_Done = false;

	/*
	 * When user click on clock icon to schedule update so need to save original
	 * URL of model, in case of user de-select scheduling.
	 */
	Previous_URL = null;

	// If selected schedule is future time then it will be true.
	Schedule_In_Future = false;

	// Flag for Scroll down reached to end of stream.
	Scroll_Down_Call = false;

	// How many Tweets ready for display.
	Past_Tweets_Count = 0;
});

// To collect tweets in temp collection.
window.onfocus = function()
{
	Focused = true;
};
window.onblur = function()
{
	Focused = false;
};

window.onbeforeunload = unregisterAll;

function initializeSocialSuite()
{
	// On close tab/window unregister all streams on server.
	$(window).unload(function()
	{
		unregisterAll();
	});

	// After clicking on logout, unregister all streams on server.
	$('a').click(function(event)
	{		
		var herfLogout = $(this).attr("href");
		if (herfLogout == "/login")
			unregisterAll();
	});

	/**
	 * Display popup form with stream details.
	 */
	$('body').on('click', '.add-stream', function(e)
	{
		// Need to call openTwitter function in ui.js for Oauth.
		head.js('js/designer/ui.js', function()
		{
		});

		// Reset all fields
		$('#streamDetail').each(function()
		{
			this.reset();
		});

		// Enable button of add stream on form of stream detail
		// $('#addStreamModal').find('#add_twitter_stream').removeAttr('disabled');

		// Fill elements on form related to stream.
		fillStreamDetail();

		getTemplate('socialsuite-social-network', {}, undefined, function(template_ui){
			if(!template_ui)
				  return;
			// Add social network types template
			$('#streamDetails').html($(template_ui));

			// Show form modal
			$('#addStreamModal').modal('show');

		}, "#streamDetails");
		
	});

	/**
	 * On click of twitter icon, Calls Oauth for selected network type.
	 */
	$('body').on('click', '.network-type', function(e)
	{
		// User select Twitter.
		if (this.id == "twitter_option")
		{
			// Oauth for twitter.
			openTwitter();

			/**
			 * Get network type from selected option of social networks. Icon
			 * can not store value attribute so need store on options.
			 */
			Network_Type = "TWITTER";
		}

		// Store network type on input element for form feild.
		$("#network_type", $('#addStreamModal')).attr("value", Network_Type);
	});

	/**
	 * Get stream name from selected option in list of streams.
	 */
	$('body').on('click', '.stream-type', function(e)
					{
						e.preventDefault();

						if (this.className == "stream-type stream-type-button-color")
						{
							// remove keyword input element
							$('.remove-keyword').remove();

							// Remove all selection.
							$('.stream-type').removeClass("stream-type-button-color");

							// Button deselected.
							this.className = "stream-type";

							// Empty stream type.
							Stream_Type = null;
							$("#stream_type", $('#addStreamModal')).attr("value", '');
						}
						else
						{
							// Remove all other selection.
							$('.stream-type').removeClass("stream-type-button-color");

							// Button selected.
							this.className = "stream-type stream-type-button-color";

							// Store stream type.
							Stream_Type = $(this).attr("value").trim();
							$("#stream_type", $('#addStreamModal')).attr("value", Stream_Type);

							// Display keyword field.
							if (Stream_Type == "Search")
							{
								$("#search_stream_keyword").html('<div class="remove-keyword"><div class="row"><div class="control-group col-md-5"><span class="controls"><input id="keyword" name="keyword" type="text" class="required form-control" required="required" autocapitalize="off" placeholder="Search Keyword..." value="" autofocus></span></div></div></div>');
							}
							else
							{
								// Remove keyword input element
								$('.remove-keyword').remove();
							}
						}

						// Removes bg color.
						$(this).css('background-color', '');
					});

	/**
	 * Get description of stream on mouse over and show at bottom of add stream
	 * form.
	 */
	$(document)
			.on(
					"mouseover",
					".stream-type",
					function(e)
					{
						// To show stream type description.
						$("#stream_description_label").addClass("txt-mute");

						// Gets value of selected stream type.
						mouseoverStream = $(this).attr("value");

						var theColorIs = $(this).css("background-color");

						if (theColorIs != 'rgb(187, 187, 187)')
						{
							// Changes bg color.
							$(this).css('background-color', '#EDEDED');
						}

						getTemplate('socialsuite-hover-helptext', {"item":mouseoverStream}, undefined, function(template_ui){
							if(!template_ui)
								  return;
							$("#stream_description_label").removeClass('description-hidden');
							$('#stream_description_label').html(template_ui);	
						}, null);

						
					});

	/**
	 * Remove description of stream on mouse out and from bottom of form.
	 */
	$(document).on("mouseout", ".stream-type", function(e)
	{
		// Removes bg color.
		$(this).css('background-color', '');

		// To hide stream type description.
		$("#stream_description_label").addClass('description-hidden txt-mute');
	});

	/**
	 * Fetchs data from popup stream add form and save stream as well as add to
	 * the collection, publish register message to the server.
	 */
	$('body').on('click', '.save-twitter-stream', function(e)
					{
						// Check add-stream button is not enable
						if ($('#addStreamModal').find('#add_twitter_stream').attr('disabled'))
							return;

						// Check if Oauth is done.
						if ($('#twitter_account').val() == null || $('#twitter_account').val() == '')
						{
							alert("You have to give access to your social account.");
							$("#add-stream").click();
							return;
						}

						// Check if stream type is not selected.
						if (Stream_Type == null || Stream_Type == '')
						{
							// To show error description.
							$("#stream_description_label").addClass("txt-mute").html('<span style="color: red;"><i class="icon-exclamation"></i> You have to select your favorite stream type.</span>');
							return;
						}

						// Check if the form is valid
						if (!isValidForm('#streamDetail'))
						{
							$('#streamDetail').find("input").focus();
							return false;
						}

						// Disables add button to prevent multiple add on click
						// event issues
						$('#addStreamModal').find('#add_twitter_stream').attr('disabled', 'disabled');

						// Show notification for adding stream.
						showNotyPopUp('information', "Adding Stream...", "top", 2500);

						// Get data from form elements
						var formData = jQuery(streamDetail).serializeArray();
						var json = {};

						// Convert into JSON
						jQuery.each(formData, function()
						{
							json[this.name] = this.value || '';
						});

						// Add collection's column index in stream.
						json["column_index"] = Streams_List_View.collection.length + 1;

						// Create new stream
						var newStream = new Backbone.Model();
						newStream.url = '/core/social';
						newStream.save(json, { success : function(stream)
						{
							// Append in collection,add new stream
							socialsuitecall.streams(stream);

							// Scroll down the page till end, so user can see
							// newly added stream.
							$("html, body").animate({ scrollTop : $(document).height() - $(window).height() });

							// Register on server
							var publishJSON = { "message_type" : "register", "stream" : stream.toJSON() };
							sendMessage(publishJSON);

							// Notification for stream added.
							showNotyPopUp('information', "Stream added. You can add another Stream now.", "top", 4000);

							setTimeout(function()
							{
								// Find selected stream id.
								var idOfStreamType = $('#addStreamModal').find("div[value='" + Stream_Type + "']").attr('id');
								$("#" + idOfStreamType).click();

								// Make send button enable
								$('#addStreamModal').find('#add_twitter_stream').removeAttr('disabled');

								Stream_Type = "";
							}, 4000);

							// Adds tag in 'our' domain to track usage
							addTagAgile(SOCIAL_TAG);

						}, error : function(data)
						{
							console.log(data);
						} });
					});

	/**
	 * Gets stream, Delete it from collection and dB and publish unregister
	 * stream.
	 */
	$('body').on('click', '.stream-delete', function(e)
	{
		if (!confirm("Are you sure you want to delete?"))
			return;

		var id = $(this).attr('id');

		// Fetch stream from collection
		var stream = Streams_List_View.collection.get(id).toJSON();

		// Stream size is too big, can not handle by pubnub so remove list of
		// tweet.
		delete stream.tweetListView;

		// Unregister on server
		var publishJSON = { "message_type" : "unregister", "stream" : stream };
		sendMessage(publishJSON);

		// Delete stream from collection and DB
		//Streams_List_View.collection.get(id).destroy();
		$.ajax({ type : 'DELETE', url : '/core/social/' + id, contentType : "application/json; charset=utf-8",
			success : function(data){
				Streams_List_View.collection.remove(id);
				Streams_List_View.render(true).el;
			}, dataType : 'json' });
	});

	/**
	 * In stream on click of notification, Gets relation and perform action as
	 * per that. like Retry : re-register stream on server. Add-new -tweet : Add
	 * new unread tweets on stream.
	 */
	$('body').on('click', '.action-notify', function(e)
	{
		// Get relation for action.
		var relation = $(this).attr('rel');

		// Get stream id.
		var streamId = $(this).attr('data');

		// Remove notification of new tweets on stream.
		$("#"+this.id).html('');

		if (relation == "add-new-tweet")
			mergeNewUnreadTweets(streamId);
		else if (relation == "retry")
			registerStreamAgain(streamId);

		// Remove relation from <div> for notification.
		$(this).attr("rel", '');

		// Remove deleted tweet element from ui
		$('.deleted').remove();
	});
}
/**
 * As per given action type it selects url to send get request and perfome
 * action on tweet. Tweet actions are Follow, un follow, Favorite, undo favorite
 * etc.
 * 
 * @param streamId
 * @param tweetId
 * @param tweetOwner
 * @param actionType
 */
function performTweetAction(streamId, tweetId, tweetOwner, actionType)
{
	// Get stream from collection.
	var modelStream = Streams_List_View.collection.get(streamId);

	if (tweetId)
	{
		// Get tweet from stream.
		var modelTweet = modelStream.get('tweetListView').get(tweetId);
		var tweet = modelTweet.toJSON();

		var tweetIdStr = tweet.id_str;
	}

	var urlForGet = null;

	switch (actionType) {
		case "favorite":
		{
			/*
			 * Sends get request to url "core/social/favorite/" and Calls
			 * StreamAPI with Stream id, tweet idStr as path parameters.
			 */
			urlForGet = "/core/social/favorite/" + streamId + "/" + tweetIdStr;
		}
			break;
		case "undofavorite":
		{
			/*
			 * Sends get request to url "core/social/undofavorite/" and Calls
			 * StreamAPI with Stream id, tweet idStr as path parameters.
			 */

			urlForGet = "/core/social/undofavorite/" + streamId + "/" + tweetIdStr;
		}
			break;
		case "followuser":
		{
			// Calls method to send request to follow user.
			urlForGet = "/core/social/followuser/" + streamId + "/" + tweetOwner;
		}
			break;
		case "unfollowuser":
		{
			// Calls method to send request to unfollow user.
			urlForGet = "/core/social/unfollowuser/" + streamId + "/" + tweetOwner;
		}
			break;
		case "blockuser":
		{
			// Calls method to send request to block user.
			urlForGet = "/core/social/blockuser/" + streamId + "/" + tweetOwner;
		}
			break;
		case "unblockuser":
		{
			// Calls method to send request to unblock user.
			urlForGet = "/core/social/unblockuser/" + streamId + "/" + tweetOwner;
		}
			break;
	}

	requestAction(urlForGet, actionType, modelStream, modelTweet, tweetOwner);
}

/**
 * Call REST api and perfome action as per reply from backend.
 */
function requestAction(urlForGet, actionType, modelStream, modelTweet, tweetOwner)
{
	$.get(urlForGet, function(data)
	{
		// Favorite is Unsuccessful.
		if (data == "Unsuccessful" || data == "false")
		{
			showNotyPopUp('information', "Retry after sometime.", "top", 5000);
			return;
		}

		// As per reply from get request reflect that in UI on tweet in stream.
		reflectActionOnTweet(data, actionType, modelStream, modelTweet, tweetOwner);

		// Create normal time.
		displayTimeAgo($(".chirp-container"));
		
	}).error(function(data)
	{
		// Error message is shown when error occurs
		displayError(null, data);
	});
}

/**
 * Accept data and reflect action in UI on tweet in stream. like On favorite :
 * change icon color to orange, Undo same action on undo favorite. On Block user ,
 * unfollow user and show noty... etc.
 * 
 * @param data
 * @param actionType
 * @param modelStream
 * @param modelTweet
 * @param tweetOwner
 */
function reflectActionOnTweet(data, actionType, modelStream, modelTweet, tweetOwner)
{
	if (modelTweet)
		var tweet = modelTweet.toJSON();

	switch (actionType) {
		case "favorite":
		{
			// On success, the color of the favorite is shown orange.
			// Update attribute in tweet.
			modelTweet.set("favorited_by_user", "true");

			// Add back to stream.
			modelStream.get('tweetListView').add(modelTweet);
		}
			break;

		case "undofavorite":
		{
			// On success, Change favorite icon to normal.
			// Delete tweet from stream
			modelTweet.unset("favorited_by_user");

			// Add back to stream.
			modelStream.get('tweetListView').add(modelTweet);
		}
			break;
		case "followuser":
		{
			if (data == "true")
				showNotyPopUp('information', "Now you are following @" + tweetOwner, "top", 5000);
		}
			break;
		case "unfollowuser":
		{
			if (data == "Unfollowed")
				showNotyPopUp('information', "Now you are not following @" + tweetOwner, "top", 5000);
		}
			break;
		case "blockuser":
		{
			if (data == "true")
				showNotyPopUp('information', "You just blocked @" + tweetOwner, "top", 5000);
		}
			break;
		case "unblockuser":
		{
			if (data == "Unblock")
				showNotyPopUp('information', "You just unblock @" + tweetOwner, "top", 5000);
		}
			break;

	}
}

// Displays Error notification.
function displayError(modalToDisplay, data)
{
	$("#spinner-modal").hide();

	if (modalToDisplay != null)
	{
		// If error occurs while posting modal is removed and error message is
		// shown
		$('#' + modalToDisplay).modal("hide");
	}
	
	var result = data.responseText;

	// Error message is shown if error occurs
	if (result.trim() == "Status is a duplicate.")
		showNotyPopUp('information', "Whoops! You already tweeted that...", "top", 5000);
	else if(result.trim() == "Sorry, that page does not exist")
		showNotyPopUp('information', "Sorry, that tweet does not exist.", "top", 5000);
	else
		showNotyPopUp('information', "Retry after sometime.", "top", 5000);

	console.log(data.responseText);
}
/**
 * This file contains all event related actions on tweet, Like delete tweet,
 * follow, unfollow, favorite, block, etc.
 */

$(function()
{
	/**
	 * Get stream and perform favorite action on selected tweet.
	 */
	$('body').on('click', '.favorite-status', function(e)
	{
		// Get the id of the tweet on which retweet is clicked
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetId = ($(this).closest('article').attr('id'));

		performTweetAction(streamId, tweetId, null, "favorite");
	});

	/**
	 * Get stream and perform undo-favorite action on selected tweet.
	 */
	$('body').on('click', '.undo-favorite-status', function(e)
	{
		// Get the id of the tweet on which retweet is clicked
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetId = ($(this).closest('article').attr('id'));

		performTweetAction(streamId, tweetId, null, "undofavorite");
	});

	/**
	 * Sends details of tweet and stream id. Method will check whether
	 * relashionship of stream owner and tweet owner, so more options will be
	 * displyed as per that.
	 * 
	 * @param stream_id
	 *            stream id to fetch stream details.
	 * @param tweetOwner
	 *            Twitter user's screen name.
	 */
	$('body').on('click', '.more-options', function(e)
					{
						var streamId = ($(this).closest('article').attr('stream-id'));
						var tweetId = ($(this).closest('article').attr('id'));
						var elementId = $(this).attr("id");

						// Get stream from collection.
						var modelStream = Streams_List_View.collection.get(streamId);

						// Get tweet from stream.
						var modelTweet = modelStream.get('tweetListView').get(tweetId);
						var tweet = modelTweet.toJSON();

						var tweetIdStr = tweet.id_str;
						var tweetOwner = tweet.user.screen_name;

						// Fetch stream from collection
						var stream = modelStream.toJSON();

						// Remove extra element from dropdown menu list.
						$('.list-clear').remove();

						// Close all dropdowns of other tweets.
						$('.more-options-list').toggle(false);

						// Open dropdown with slow speed.
						$('#' + elementId + '_list', $('#' + streamId)).toggle("slow");

						// Tweet belongs to stream owner so no extra options
						// required.
						if (stream.screen_name == tweetOwner)
							return;

						// Check stream owner relashionship tweet owner.
						$
								.get(
										"/core/social/checkrelationship/" + streamId + "/" + tweetOwner,
										function(data)
										{
											// Stream owner follows tweet owner
											// then add unfollow option
											if (data.follow == "true")
											{
												$('#' + elementId + '_list', $('#' + streamId))
														.append(
																'<li class="list-clear"><a href="#social" class="unfollow-user" tweet-owner=' + tweetOwner + '>Unfollow @' + tweetOwner + '</a></li>');
											}
											// Stream owner not following tweet
											// owner then add follow option
											else if (data.follow == "false")
											{
												$('#' + elementId + '_list', $('#' + streamId))
														.append(
																'<li class="list-clear"><a href="#social" class="follow-user" tweet-owner=' + tweetOwner + '>Follow @' + tweetOwner + '</a></li>');
											}

											// Tweet owner is stream owner's
											// follower then add send DM option
											if (data.follower == "true")
											{
												$('#' + elementId + '_list', $('#' + streamId)).append(
														'<li class="list-clear"><a href="#social" class="direct-message">Send Direct Message</a></li>');
											}

											// Check tweet owner is Block or
											// Unblock
											if (data.blocked == "true")
											{
												$('#' + elementId + '_list', $('#' + streamId))
														.append(
																'<li class="list-clear"><a href="#social" class="unblock-user" tweet-owner=' + tweetOwner + '>Unblock @' + tweetOwner + '</a></li>');
											}
											else if (data.blocked == "false")
											{
												$('#' + elementId + '_list', $('#' + streamId))
														.append(
																'<li class="list-clear"><a href="#social" class="block-user" tweet-owner=' + tweetOwner + '>Block @' + tweetOwner + '</a></li>');
											}
										}).error(function(data)
								{
									// Error message is shown when error occurs
									displayError(null, data);
								});
					});

	/**
	 * Sends follow request to Follow the contact's Twitter profile in Twitter
	 * based on stream id and Twitter user's screen name
	 * 
	 * @param stream_id
	 *            stream id to fetch stream details
	 * @param tweetOwner
	 *            Twitter user's screen name to send follow request
	 */
	$('body').on('click', '.follow-user', function(e)
	{
		// Details to be pass on to method.
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetOwner = $(this).attr("tweet-owner");

		performTweetAction(streamId, null, tweetOwner, "followuser");
	});
	
	/**
	 * Sends unfollow request to unFollow the contact's Twitter profile in
	 * Twitter based on stream id and Twitter user's screen name
	 * 
	 * @param stream_id
	 *            stream id to fetch stream details
	 * @param tweetOwner
	 *            Twitter user's screen name to send unfollow request
	 */
	$('body').on('click', '.unfollow-user', function(e)
	{
		// Details to be pass on to method.
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetOwner = $(this).attr("tweet-owner");

		performTweetAction(streamId, null, tweetOwner, "unfollowuser");
	});

	/**
	 * Sends block request to Block the contact's Twitter profile in Twitter
	 * based on stream id and Twitter user's screen name.
	 * 
	 * @param stream_id
	 *            stream id to fetch stream details
	 * @param tweetOwner
	 *            Twitter user's screen name to send block request
	 */
	$('body').on('click', '.block-user', function(e)
	{
		// Details to be pass on to method.
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetOwner = $(this).attr("tweet-owner");

		performTweetAction(streamId, null, tweetOwner, "blockuser");
	});

	/**
	 * Sends unblocked request to unBlocked the contact's Twitter profile in
	 * Twitter based on stream id and Twitter user's screen name.
	 * 
	 * @param stream_id
	 *            stream id to fetch stream details
	 * @param tweetOwner
	 *            Twitter user's screen name to send unblock request
	 */
	$('body').on('click', '.unblock-user', function(e)
	{
		// Details to be pass on to method.
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetOwner = $(this).attr("tweet-owner");

		performTweetAction(streamId, null, tweetOwner, "unblockuser");
	});

	/**
	 * Sends delete request to Twitter profile in Twitter based on stream id,
	 * Twitter user's screen name and tweet id.
	 */
	$('body').on('click', '.delete-tweet', function(e)
	{
		// Ask confirmation to user.
		if (!confirm("Are you sure you want to delete this tweet?"))
			return;

		// Details to pass on to method.
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetId = ($(this).closest('article').attr('id'));

		// Get stream from collection.
		var modelStream = Streams_List_View.collection.get(streamId);

		// Get tweet from stream.
		var modelTweet = modelStream.get('tweetListView').get(tweetId);
		var tweet = modelTweet.toJSON();

		var tweetIdStr = tweet.id_str;
		var tweetOwner = tweet.user.screen_name;

		// Call method with details of tweet to be deleted.
		$.get("/core/social/deletetweet/" + streamId + "/" + tweetOwner + "/" + tweetIdStr, function(data)
		{
			if (data == "Successful")
			{
				modelTweet.set("deleted_msg", "deleted");

				// Add back to stream.
				modelStream.get('tweetListView').add(modelTweet);

				showNotyPopUp('information', "Your tweet has been deleted.", "top", 5000);

				// Remove tweet element from ui
				$('.deleted').remove();
			}
			else if (data == "Unsuccessful")
			{
				showNotyPopUp('information', "Retry after sometime.", "top", 5000);
			}
		}).error(function(data)
		{
			// Error message is shown if error occurs
			displayError(null, data);
		});
	});

	/**
	 * Get tweet, show tweet in modal with list of user with details, who
	 * retweeted that tweet.
	 */
	$('body').on('click', '.show-retweet', function(e)
	{		
		// Close all dropdowns of all tweets.
		$('.more-options-list').toggle(false);

		// Details to be pass on to method.
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetId = ($(this).closest('article').attr('id'));

		// Get stream from collection.
		var modelStream = Streams_List_View.collection.get(streamId);

		// Get tweet from stream.
		var modelTweet = modelStream.get('tweetListView').get(tweetId);
		var tweet = modelTweet.toJSON();

		/*
		 * Suppose input json has id then modal will not be display. Before
		 * calling displayModal need to remove tweet id. Tweet id is not used
		 * here in future.
		 */
		delete tweet.id;

		// Display Modal
		displayModal("socialsuite_RT_userlistModal", "socialsuite-RT-userlist", tweet, null, null, "/core/social/tweet/" + streamId);

		$("#spinner-modal").show();
		
		// Collection for user's list.
		var RTUserListView = new Base_Collection_View({ url : function()
		{
			return '/core/social/getrtusers/' + streamId + "/" + tweet.id_str;
		}, restKey : "user", templateKey : "socialsuite-RT-userlist", individual_tag_name : 'li', });

		RTUserListView.collection.fetch({
		    success : function(data) {		        
		        $("#spinner-modal").hide();
		    },
		    error: function(response) {
		        console.log("ON ERROR");
		        console.log(response);
		        
		        var data = {}; data["responseText"] = "Sorry, that page does not exist";
		        
		        displayError("socialsuite_RT_userlistModal", data);
		    }
		});

		$('#RTuser_list').html(RTUserListView.render(true).el);

		// Create normal time.
		displayTimeAgo($("#socialsuite_RT_userlistModal"));		
	});
});
/**
 * AS per tweet data and type, It will perform actions like : display rate limit
 * exceed error, add tweet, show notification if user is not in social
 * tab/window.
 * if tweet id is 001 : Rate limit exceeded.
 * if tweet id is 000 : tweets not available for stream..
 * if tweet type is ACK : tweet is register on server and all REST tweets are sent.
 */
function handleMessage(tweet)
{
	// We need this messages to reflect actions in all added relevant streams.
	if (tweet["delete"] != null) // (tweet.delete != null)
	{
		return;
	}

	// Error message from server "Rate limit exceeded." or "server not connected."
	if (tweet.id == "001") // (tweet.delete != null)
	{
		displayErrorInStream(tweet);
		return;
	}

	// Get stream from collection.
	var modelStream = Streams_List_View.collection.get(tweet.stream_id);

	if (modelStream != undefined)
	{
		// User on #social as well as window is active.
		if (Current_Route == "social" && Focused == true)
		{
			// New tweet notification not yet clicked in stream.
			if ($('#stream_notifications_' + tweet.stream_id).is(':empty') == false)
			{
				// console.log("not clicked");

				// User did not click on notification so mark tweet as new unread tweet.
				isNewUnreadTweet(tweet);

				// Change notification to show number of new tweets.
				showNotification(modelStream);
			}
			else
			{
				// User is in #social and there is no notification on stream.
				// Rebuild tweet and Add tweet to model in normal way.
				rebuildTweet(modelStream, tweet);
			}
		}
		else
		{			
			// Add tweet as new unread, because user is on another tab or window is inactive.
			isNewUnreadTweet(tweet);

			// User in #social but window is inactive.
			if (Current_Route == "social")
			{
				// Change notification to show number of new tweets.
				showNotification(modelStream);
			}
		}
	} // If End

	// Remove deleted tweet element from ui
	$('.deleted').remove();
}

/*
 * Convert normal text of tweet to tweet with links on @screen_name , #hashtags
 * and url.
 */
function convertTextToTweet(tweet)
{
	var linkableTweetArray = new Array();
	var tweetText = tweet.text;
	var regex = new RegExp();
	var temp;

	// Replace &amp; with &
	regex = new RegExp("&amp;", "g");
	tweetText = tweetText.replace(regex, '&');

	// Split text in array.
	linkableTweetArray = tweetText.split(/[\s,?&;.'":!)({}]+/);

	// Remove duplicate words.
	linkableTweetArray = _.uniq(linkableTweetArray);

	for ( var i = 0; i < linkableTweetArray.length; i++)
	{
		if (linkableTweetArray[i].charAt(0) == "@") // Mentions
		{
			regex = new RegExp(linkableTweetArray[i], "g");
			tweetText = tweetText
					.replace(
							regex,
							'&lt;a href=\'https://twitter.com/' + linkableTweetArray[i].substring(1) + '\' target=\'_blank\' class=\'cd_hyperlink\'>' + linkableTweetArray[i] + '&lt;/a>');
		}
		else if (linkableTweetArray[i].charAt(0) == "#") // Hashtags
		{
			regex = new RegExp(linkableTweetArray[i], "g");
			var url = "https://twitter.com/search?q=%23" + linkableTweetArray[i].substring(1) + "&src=hash";
			tweetText = tweetText.replace(regex, '&lt;a href=\'' + url + '\' target=\'_blank\' class=\'cd_hyperlink\'>' + linkableTweetArray[i] + '&lt;/a>');
		}
	}

	// URL
	linkableTweetArray = new Array();
	linkableTweetArray = tweetText.split(/\s/);
	var exp = "^(https?|ftp|file)://[-a-zA-Z0-9+&@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&@#/%=~_|]";

	$.each(linkableTweetArray, function(index, word)
	{
		if (word.match(exp))
			tweetText = tweetText.replace(word, '&lt;a href=\'' + word + '\' target=\'_blank\' class=\'cd_hyperlink\'>' + word + '&lt;/a>');
	});

	regex = new RegExp("&lt;", "g");
	tweetText = tweetText.replace(regex, '<');
	return tweetText;
}
// Displays modal with filled details.
function displayFilledModal(streamId, tweetId, tweetOwner, messageType)
{
	var urlForPost = "/core/social/tweet/" + streamId;

	// Fetch stream from collection
	var modelStream = Streams_List_View.collection.get(streamId);
	var stream = modelStream.toJSON();

	if (tweetId != null)
	{
		// Get tweet from stream.
		var modelTweet = modelStream.get('tweetListView').get(tweetId);
		var tweet = modelTweet.toJSON();
	}

	// Store info in a json, to send it to the modal window when making send
	// tweet request
	var json = {};

	json["streamId"] = streamId;
	json["profileImg"] = $("#" + streamId + "-profile-img").prop("src");
	json["domain_user_id"] = CURRENT_DOMAIN_USER.id;
	json["screen_name"] = stream.screen_name;
	json["network_type"] = "TWITTER";
	json["token"] = stream.token;
	json["secret"] = stream.secret;
	json["schedule"] = "0";

	switch (messageType) {
	case "Tweet":
	{
		// Set headline of modal window as Send Message
		json["headline"] = "Tweet";

		// Information to be shown in the modal to the user while sending
		// message
		json["info"] = "Status from " + stream.screen_name;
		json["description"] = "What's happening?";
	}
		break;
	case "Reply Tweet":
	{
		if (messageType == "Reply Tweet" && tweetOwner == null)
		{
			// Set headline of modal window as Send Message
			json["headline"] = "Reply Tweet";

			// Information to be shown in the modal to the user while sending
			// message
			json["info"] = "Reply " + "@" + tweet.user.screen_name + " from " + stream.screen_name;
			json["description"] = "@" + tweet.user.screen_name;
			json["tweetId"] = tweet.id_str;
			json["tweetOwner"] = tweet.user.screen_name;
		}
		else if (messageType == "Reply Tweet" && tweetOwner != null)
		{
			// Set headline of modal window as Send Message
			json["headline"] = "Reply Tweet";

			// Information to be shown in the modal to the user while sending
			// message
			json["info"] = "Reply " + "@" + tweetOwner + " from " + stream.screen_name;

			json["description"] = "@" + tweetOwner;
			json["tweetOwner"] = tweetOwner;
			json["tweetId"] = null;
		}
	}
		break;
	case "Direct Message":
	{
		json["headline"] = "Direct Message";

		// Information to be shown in the modal to the user while sending
		// message
		json["info"] = "Direct message from " + stream.screen_name + " to " + tweet.user.screen_name;

		json["description"] = "Tip: you can send a message to anyone who follows you."
		json["tweetId"] = tweet.id_str;
		json["tweetOwner"] = tweet.user.screen_name;
	}
		break;
	case "Retweet":
	{
		// Set headline of modal window as Send Message
		json["headline"] = "Retweet";

		// Information to be shown in the modal to the user while sending
		// message
		json["info"] = "Status of " + "@" + tweet.user.screen_name;

		json["description"] = tweet.original_text;
		json["tweetId"] = tweet.id;
		json["tweetOwner"] = tweet.user.screen_name;

		urlForPost = "/core/social/retweet/" + streamId + "/" + tweet.id_str;
	}
		break;
	}

	console.log(json);

	// Display Modal
	displayModal("socialsuite_twitter_messageModal", "socialsuite-twitter-message", json, "twitter-counter", "twit-tweet", urlForPost);

	// In compose message text limit is crossed so disable send button.
	$('#twit-tweet').on('cross', function()
	{
		$('#send_tweet').attr("disabled", "disable");		
	});

	// In compose message text limit is uncrossed so enable send button.
	$('#twit-tweet').on('uncross', function()
	{
		// If scheduling is selected and schedule is in past time so do not enable schedule button.
		if(!Schedule_In_Future && $("#schedule_controls").css("display") == "block")
			return;
		
		/*
		 * 1. If scheduling is selected and selected schedule is in future time so enable schedule button.
		 * 2. If scheduling is not selected and its non schedule message so enable schedule button.
		 */
		$('#send_tweet').removeAttr('disabled');
		
	});
}

// Displays Modal.
function displayModal(modalToDisplay, templt, json, counterVar, focusElmnt, urlForPost)
{
	// If modal already exists remove to show a new one
	$('#' + modalToDisplay).remove();
	
	Schedule_In_Future = false;

	// Populate the modal template with the above json details in the form
	Message_Model = new Base_Model_View({ data : json, url : urlForPost, template : templt, modal : '#' + modalToDisplay, postRenderCallback : function(el)
	{
		$('.modal-backdrop').remove();
		
		if (Message_Model.model.get("id") || Message_Model.model.get("response") == "Successful")
			return;

		$('#' + modalToDisplay, el).modal('show');
	}, saveCallback : function(data)
	{
		// Display Noty on top.
		displayNoty(data);

		// Hide message modal.
		$('#' + modalToDisplay).modal('hide');
		$('#' + modalToDisplay).remove();
	} });

	$('#content').append(Message_Model.render().el);

	if (counterVar != null && focusElmnt != null)
	{
		// Display modal
		$('#' + modalToDisplay).on('shown', function()
		{
			head.js(LIB_PATH + 'lib/bootstrap-limit.js', function()
			{
				$(".twit-tweet-limit").limit({ maxChars : 140, counter : "#" + counterVar });
				$('#' + modalToDisplay).find('#' + focusElmnt).focus();
			});
		});
	}
}

function displayNoty(data)
{
	// data.response may be :Successful, UnSuccessful or Id of RT.
	
	if (data.response == "Successful")
	{
		if (Message_Model.model.get("headline") == "Tweet")
			showNotyPopUp('information', "Your Tweet was posted!", "top", 5000);
		else
			showNotyPopUp('information', "Your Tweet to @" + Message_Model.model.get("tweetOwner") + " has been sent!", "top", 5000);
	}
	else if (data.response == "Unsuccessful")
	{
		// On failure, shows the status as retry
		$('#socialsuite_twitter_messageModal').find('span.save-status').html("Retry");
		showNotyPopUp('information', "Retry after sometime.", "top", 5000);
	}
	else if (Message_Model.model.get("headline") == "Retweet" && data.response != undefined)
		showEffectOfRT(data);
	else if (data.id != undefined && data.schedule != undefined)
		{
    	  // Show clock icon in social suite, which is linked to shcedule update page.	
	      $("#show_scheduled_updates").show(); 
		}	
}

/*
 * Makes changes in UI, user click on RT of tweet actions, After RT it will
 * change RT icon in green color.
 */
function showEffectOfRT(data)
{
	// Fetch stream from collection
	var modelStream = Streams_List_View.collection.get(Message_Model.model.get("streamId"));

	// Get tweet from stream.
	var modelTweet = modelStream.get('tweetListView').get(Message_Model.model.get("tweetId"));

	if (modelStream == undefined || modelTweet == undefined)
		return;

	// On success, the color of the retweet is shown green. Update
	// attribute in tweet.
	modelTweet.set("retweeted_by_user", "true");
	modelTweet.set("retweet_id", data.response);

	// Add back to stream.
	modelStream.get('tweetListView').add(modelTweet);

	// Create normal time.
	displayTimeAgo($(".chirp-container"));
}
/**
 * This file contains all event related messages in Twitter like Tweet, Direct
 * Message, RT, Edit RT, Reply Message, Tweet to user.
 */

$(function()
{
	/**
	 * get stream and create tweet for posting on Twitter.
	 */
	$('body').on('click', '.compose-message', function(e)
	{
		// Close all dropdowns of all tweets.
		$('.more-options-list').toggle(false);

		$('#socialsuite_twitter_messageModal').remove();

		var streamId = $(this).attr("stream-id");

		// Display modal with JSON filled in that.
		displayFilledModal(streamId, null, null, "Tweet");
	});

	//twitter text field message limit to 140
	$('body').on('keyup', '.twit-tweet-limit', function(e) {
 			var left;
            left = 140 - $(this).val().length;
 
            if(left < 0){
                $('#twitter-counter').addClass("text-danger");
                 $('#send_tweet').attr("disabled", true);
            }else{
                $('#twitter-counter').removeClass("text-danger");
                $('#send_tweet').attr("disabled", false);
            }
 
            $('#twitter-counter').text(left);
        });


	/**
	 * Get stream and create reply tweet and post it on Twitter to related
	 * tweet.
	 */
	$('body').on('click', '.reply-message', function(e)
	{
		// Close all dropdowns of all tweets.
		$('.more-options-list').toggle(false);

		$('#socialsuite_twitter_messageModal').remove();

		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetId = ($(this).closest('article').attr('id'));

		// Display modal with JSON filled in that.
		displayFilledModal(streamId, tweetId, null, "Reply Tweet");
	});

	/**
	 * get stream and create tweet for posting on Twitter to user who RT owner's
	 * tweet.
	 */
	$('body').on('click', '.tweet-to-user', function(e)
	{
		// Hide modal before showing message modal.
		$("#socialsuite_RT_userlistModal").modal("hide");

		$('#socialsuite_twitter_messageModal').remove();

		// Close all dropdowns of all tweets.
		$('.more-options-list').toggle(false);

		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetOwner = $(this).attr("tweet-owner");

		// Display modal with JSON filled in that.
		displayFilledModal(streamId, null, tweetOwner, "Reply Tweet");
	});

	/**
	 * Sends a direct message to the Twitter profile , who is tweet owner.
	 */
	$('body').on('click', '.direct-message', function(e)
	{
		// Close all dropdowns of all tweets.
		$('.more-options-list').toggle(false);

		$('#socialsuite_twitter_messageModal').remove();

		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetId = ($(this).closest('article').attr('id'));

		// Display modal with JSON filled in that.
		displayFilledModal(streamId, tweetId, null, "Direct Message");
	});

	/**
	 * Get stream and perform retweet action on selected tweet.
	 */
	$('body').on('click', '.retweet-status', function(e)
	{
		$('#socialsuite_twitter_messageModal').remove();

		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetId = ($(this).closest('article').attr('id'));

		// Display modal with JSON filled in that.
		displayFilledModal(streamId, tweetId, null, "Retweet");

		// On click of edit button in the modal, retweet edit.
		$('#edit_retweet').click(function(e)
		{
			e.preventDefault();
			// Check Send button is not enable
			if ($("#send_retweet").hasClass('disabled') && $("#edit_retweet").hasClass('disabled'))
				return;

			/*
			 * Need to remove this element because it has save class and it is
			 * not disabled but hidden so base-model accept action save on click
			 * of send, which is disabled.
			 */
			$('#send_retweet').remove();

			$('#edit_retweet').hide();
			$('#twit-retweet').hide();
			$('#send_tweet').show();
			$('#twit-tweet').show();
			$('#link-text').show();
			$('#tweet_scheduling').show();

			// Update edit RT URL in model.
			Message_Model.model.url = "/core/social/tweet/" + streamId;
		});
	});

	/**
	 * Get stream and perform undo-retweet action on selected tweet. If stream
	 * is "Sent" then remove tweet from stream and if stream is "Home" then
	 * remove RT icon only.
	 */
	$('body').on('click', '.undo-retweet-status', function(e)
	{
		// Ask for confirmation from user.
		if (!confirm("Are you sure you want to undo retweet this status?"))
			return;

		// Get the id of the tweet on which undo-retweet is clicked
		var streamId = ($(this).closest('article').attr('stream-id'));
		var tweetId = ($(this).closest('article').attr('id'));
		var tweetIdStr = null;

		// Get stream from collection.
		var modelStream = Streams_List_View.collection.get(streamId);

		// Get tweet from stream.
		var modelTweet = modelStream.get('tweetListView').get(tweetId);
		var tweet = modelTweet.toJSON();

		// If stream type is "Sent" then "tweet-id-str" is tweet handle else
		// "retweet-id" to perform action.
		if (modelStream.toJSON().stream_type == "Sent")
			tweetIdStr = tweet.id_str;
		else if (modelStream.toJSON().stream_type == "Home")
			tweetIdStr = tweet.retweet_id;

		/*
		 * Sends get request to url "core/social/undoretweet/" and Calls
		 * StreamAPI with Stream id, tweet id and tweet idStr as path
		 * parameters.
		 */
		$.get("/core/social/undoretweet/" + streamId + "/" + tweetId + "/" + tweetIdStr,

		function(data)
		{
			// Undo-Retweet is Unsuccessful.
			if (data == "Unsuccessful")
			{
				showNotyPopUp('information', "Retry after sometime.", "top", 5000);
				return;
			}

			// On success, Change retweet icon to normal.
			// Delete tweet from stream
			if (tweet.stream_type == "Sent")
				modelTweet.set("deleted_msg", "deleted");
			else
				modelTweet.unset("retweeted_by_user");

			// Add back to stream.
			modelStream.get('tweetListView').add(modelTweet);

			// Remove tweet element from ui
			$('.deleted').remove();

			// Create normal time.
			displayTimeAgo($(".chirp-container"));

		}).error(function(data)
		{
			// Error message is shown when error occurs
			displayError(null, data);
		});
	});

	// On copy paste from mouse right click call key press to check cross limit.
	$('body').on('mouseleave', '#twit-tweet', function(e)
	{
		$('#twit-tweet').keypress();
	});

	// On click of link in message modal, Add agile text to message text area in
	// message modal.
	$('body').on('click', '#add_message', function(e)
	{
		var quote = " Sell & Market like Fortune 500 with @agilecrm";

		document.getElementById("twit-tweet").value += quote;

		$("#link-text").html("<b>Thank you.</b>");

		setTimeout(function()
		{
			$("#link-text").hide();
		}, 2000);
	});

	/*
	 * On modal close,Makes Scheduled_Edit flag false to show normal update
	 * flow, because scheduling div display is depend on that.
	 */
	$('#socialsuite_twitter_messageModal').on('hidden.bs.modal', function()
	{
		if (this.id != "#socialsuite_twitter_messageModal")
			return;

		$('.modal-backdrop').remove();
		Scheduled_Edit = false;
		$('#socialsuite_twitter_messageModal').remove();
	});
}); // init end
/**
 * account-setting.js is a script file to deal with account deletion, shows data
 * used by account and number of entities saved
 * 
 * @module Billing author: Yaswanth
 */

// Global variable to store statistics, to show details in confirmation of
// account delete
var ACCOUNT_STATS;

/**
 * Fetches account statistics for the current Namespace from
 * "core/api/namespace-stats", called when manage subscription details is loaded
 * 
 * @method setUpAccountStats
 * @param html
 *            element to show stats
 * @author Yaswanth
 */
function set_up_account_stats(el, callback)
{

	/**
	 * Creates base model for namespace stats, template is
	 * account-stats-template
	 */
	var account_stats = new Base_Model_View({
		url : "core/api/namespace-stats",
		template : "account-stats",
		postRenderCallback: function(el) {
			
			ACCOUNT_STATS = account_stats.model.toJSON();
			
			if (callback && typeof (callback) === "function")
			{
				callback(ACCOUNT_STATS);
			}
		}
	});

	// Shows account statistics in subscription page
	$('#account-stats', el).html(account_stats.render(true).el);

}


/**
 * Handles events on delete account at stats and confirmation, sends delete
 * request on confirmation
 */
$(function(){

/**
	 * If user clicks on confirm delete the modal is hidden and
	 * delete request is sent to "core/api/delete/account"
	 */
	$("#content #confirm-delete-account").off("click");
	$('#content').on('click', '#confirm-delete-account', function(e) {
		
			e.preventDefault();

			// Hides modal
			$(".modal-body").html(getRandomLoadingImg());

			/**
			 * Sends delete request to delete account , on
			 * success send to login
			 */
			$.ajax({
				type : "DELETE",
				url : "core/api/delete/account",
				success : function()
				{
					add_account_canceled_info(ACCOUNT_DELETE_REASON_JSON, function(data){
						
						$("#warning-deletion-feedback").modal('hide');	

						// Show loading in content
						$("#content").html(getRandomLoadingImg());
						// Navigate to login page after delete
						window.location.href = window.location.href .split('#')[0] + 'login';
					})
					
				}
			});
	});
	
	// Cancellation for free users
	$("#content #cancel-account").off("click");
	$('#content').on('click', '#cancel-account', function(e) {
			e.preventDefault();		

			// Shows account stats warning template with stats(data used)
			$("#warning-deletion-feedback").html(getTemplate('warning-feedback', {})).modal('show');	
			
			
	});
	
	// Cancellation for paid users
	$("#content #cancel-account-request").off("click");
	$('#content').on('click', '#cancel-account-request', function(e) {
			e.preventDefault();
			
			// Shows cancellation modal
			$("#send-cancellation").html(getTemplate('send-cancellation-request', {})).modal('show');	
			
	});

});
	

$('#send-cancellation').on('click', '#send-delete-request', function(e) {

		e.preventDefault();

		if($(this).attr('disabled'))
	   	     return;
		
		// If not a valid form return else serialize form data to parse
		if(!isValidForm($("#cancelation-request-form")))
			return;
		
		// Disables send button and change text to Sending...
		disable_send_button($(this));
		
		var json = serializeForm("cancelation-request-form");
		
		var info = json.account_cancel_reason;
		
		// Replace \r\n with <br> tags as email is sent as text/html
		var reason = info.replace(/\r\n/g,"<br/>");
		
		// Build url
		var url =  'core/api/emails/send-email?from=' + encodeURIComponent(CURRENT_DOMAIN_USER.email) + '&to=' + 
		encodeURIComponent("care@agilecrm.com") + '&subject=' + encodeURIComponent("Cancellation Request") + '&body=' + 
		encodeURIComponent(reason);

		$.post(url,function(){

			// Reset form fields after sending email
			$("#cancelation-request-form").each(function () {
				this.reset();
			});
			
			// Adds "Cancellation Request" tag in "Our" domain
			add_tag_our_domain("Cancellation Request");
			
			// Adds note in "Our" domain
			var note = {};
			note.subject = "Cancellation Request";
			note.description = info;
			
			agile_addNote(note,'', CURRENT_DOMAIN_USER.email);
								
			$("#send-cancellation .modal-title").html($("#send-delete-request-step2 .modal-title").html());		    
		    $("#send-cancellation .modal-body").html($("#send-delete-request-step2 .modal-body").html());
			$("#send-cancellation .modal-footer").html($("#send-delete-request-step2 .modal-footer").html());
			
			// Enables Send Email button.
			enable_send_button($('#send-delete-request'));
		});
		
	});

$('#warning-deletion-feedback').on('click', '#warning-feedback-save', function(e) {
		e.preventDefault();
		
		var form = $("#cancelation-feedback-form");
		
		if(!isValidForm(form))
		{
			return;
		}
		
		var input =  $("input[name=cancellation_reason]:checked");
	
		ACCOUNT_DELETE_REASON_JSON = {};
		ACCOUNT_DELETE_REASON_JSON["reason"] = $(input).val();
		ACCOUNT_DELETE_REASON_JSON["reason_info"] = $("#account_delete_reason").val();
		$(".modal-body").html(getRandomLoadingImg());
		var delete_step1_el = "";
		if(ACCOUNT_STATS){
			getTemplate('warning', ACCOUNT_STATS, undefined, function(template_ui){
		 		if(!template_ui)
		    		return;
		    	delete_step1_el = $(template_ui);
				
			}, null);

		}
		else
			{
				set_up_account_stats(el, function(data){
					getTemplate('warning', data, undefined, function(template_ui){
				 		if(!template_ui)
				    		return;
				    	delete_step1_el = $(template_ui);
						$(".modal-body").css("padding", 0 ).html($(".modal-body", $(delete_step1_el)));
						$(".modal-footer").html($(".modal-footer", $(delete_step1_el)).html());
					}, null);
						
				})
				return;
			}
			 
		$(".modal-body").css("padding", 0 ).html($(".modal-body", $(delete_step1_el)));
		$(".modal-footer").html($(".modal-footer", $(delete_step1_el)).html());
		
	});

// Undefines delete reason, if use chose not to delete account in delete process
$("#warning-deletion-feedback").on('hidden.bs.modal', function(){
	ACCOUNT_DELETE_REASON_JSON = undefined;
});
				function getSubscription(customer, plan)
{
	if(!plan)
		return null;
	
	if(!customer)
		return null;
	
	if(typeof customer != "object")
		{
			customer = JSON.parse(customer);
		}
	
	var subscriptions = customer.subscriptions;
	if(!subscriptions)
		{
			if(!customer.subscription)
				return null;
			else
				return customer.subscription;
			
			return null;
		}
	
	var has_subscription_id = false;
	if(plan.subscription_id)
		has_subscription_id = true;
	for(var i = 0; i < subscriptions.data.length ; i ++)
		{
			var subscription = subscriptions.data[i];
			if(has_subscription_id)
				{
					if(subscription.id != plan.subscription_id)
						continue;
					
					return subscription;
				}
			else if(subscription.plan.id == plan.plan_id)
				return subscription;
		}
	
	return null;
}

function getSubscriptionWithAmount(customer, plan)
{
	var subscription = getSubscription(customer, plan);
	
	if(!subscription)
		return null;
	
	if(!subscription.plan)
		return subscription;
	
	var amount = subscription.plan.amount/100;
	var quantity = subscription.quantity;
	subscription.total = amount * quantity;
	return subscription;
}

function getActiveCard(customer)
{
	if(!customer)
		return null;
	
	if(typeof customer != "object")
	{
		customer = JSON.parse(customer);
	}
	
	return customer.cards.data[0];
	
}
/**
 * agile_billing.js is a script file to manage form fields i.e., credit card
 * expiry date and deserialize credit card details client side.
 * 
 * @module Billing author: Yaswanth
 */

/**
 * Show months and years in billing section for credit card expiry date
 * 
 * @param el
 *            html element
 */
function card_expiry(el)
{
	var yearMonthsArray = {};
	yearMonthsArray[1] = "01 (Jan)";
	yearMonthsArray[2] = "02 (Feb)";
	yearMonthsArray[3] = "03 (Mar)";
	yearMonthsArray[4] = "04 (Apr)";
	yearMonthsArray[5] = "05 (May)";
	yearMonthsArray[6] = "06 (Jun)";
	yearMonthsArray[7] = "07 (Jul)";
	yearMonthsArray[8] = "08 (Aug)";
	yearMonthsArray[9] = "09 (Sep)";
	yearMonthsArray[10] = "10 (Oct)";
	yearMonthsArray[11] = "11 (Nov)";
	yearMonthsArray[12] = "12 (Dec)";

	var select = $("#exp_month", el), month = new Date().getMonth() + 1;
	for ( var i = 1; i <= 12; i++)
	{
		select.append($("<option value='" + i + "' "
				+ (month === i ? "selected" : "") + ">" + yearMonthsArray[i]
				+ "</option>"))
	}

	var select = $("#exp_year", el), year = new Date().getFullYear();

	for ( var i = 0; i < 22; i++)
	{

		select.append($("<option value='" + (i + year) + "' "
						+ (i === 0 ? "selected" : "") + ">" + (i + year)
						+ "</option>"))
	}
}

/**
 * Deserializes the credit card details in billing session, fills address
 * fields, derialization is to be done explicitly because data returned from the
 * stripe does not match with the fields to fields names.
 * 
 * @param data
 *            subscription object
 * @param form
 *            form html element
 */
function deserialize_card_details(activeCard, form)
{
	/**
	 * Iterates through activeCard details in data, finds corresponding values
	 * for the fields and fills them
	 */
	$.each(activeCard, function(key, value)
	{
		/**
		 * Match all the fields according to value key and actual field name and
		 * fills the fields with appropriate values.
		 */

		var fel;
		if (key.indexOf("name") != -1)
			fel = form.find('*[name="name"]');

		else
			if (key == "addressCountry")
				fel = form.find('*[name="address_country"]');
			else
				if (key == "addressState")
					fel = form.find('*[name="address_state"]');

				else
					if (key == "addressState")
						fel = form.find('*[name="address_state"]');

					else
						if (key == "addressLine1")
							fel = form.find('*[name="address_line1"]');

						else
							if (key == "addressLine2")
								fel = form.find('*[name="address_line2"]');

							else
								if (key == "addressZip")
									fel = form.find('*[name="address_zip"]');

		// If fields are found matching the fill assign values to them
		if (fel && fel.length > 0)
		{
			// Get to tag name to check the type of the tag
			tag = fel[0].tagName.toLowerCase();

			// If type of the field is input assgins value to it
			if (tag == "input")
			{
				$(fel).val(value);
			}
			/**
			 * If tag type is select and key is related to country then select
			 * the country and trigger change, to get the values, since this
			 * field uses "countries.js"
			 */
			else
				if (tag == "select" && key == "addressCountry")
				{
					// console.log($('#country'));
					$("#country").val(value).prop('selected', true).trigger(
							'change');
					// $(fel).val(value).trigger('change');
					$("#state").val(activeCard.addressState).prop(
							'selected', true).trigger('change');
				}
		}

	});
}
//Coupons array
var AGILE_COUPONS_JSON = {}, AGILE_COUPON_INVALID_MESSAGE = "Coupon is either expired or invalid for the selected plan.";
function showCouponCodeContainer(id) {

	/**
	 * Changes for coupon existence or not. In future if want, change this to
	 * hide coupon container
	 */
	if (id)
		$("#content").find("#coupon_code_container").show();

	id = (id) ? "payment_selection_container" : "payment_selection_container1";
	$("#" + id).remove();
}

/**
 * Get coupon code status and show to the user
 * 
 * @param selected_plan_json
 * @param el
 * @returns
 */
function showCouponDiscountAmount(selected_plan_json, el) {

	var element = $(".coupon_code_discount_amount", el);

	var original_cost = selected_plan_json.cost;
	if (!original_cost)
		return element.html("");

	// Rest call to get the amount to discount
	checkValidCoupon(selected_plan_json.coupon_code, function(status) {

		// Get coupon
		var data = (!status) ? {}
				: AGILE_COUPONS_JSON[selected_plan_json.coupon_code];

		// Load Element
		var element = $(".coupon_code_discount_amount", el);
		var discountPrice = "0%";

		// Check percent and amout to deduct from main amount
		if (!data || !(data.percentOff || data.amountOff)) {
			element.find("#total_cost_with_discount").html(original_cost);
			return element.find("#coupon_code_discount_percent").html(
					"$0 (" + discountPrice + ")");
		}

		// Check amount off param
		var amountOff = data.amountOff;
		if (amountOff) {
			original_cost = original_cost - (amountOff / 100);
			discountPrice = "$" + (amountOff / 100);
		}

		// Check percent Off param
		var percentOff = data.percentOff;
		if (!amountOff && percentOff) {

			// Discount amount
			var discountAmount = original_cost * (percentOff / 100);

			// Get original cost
			original_cost = original_cost - discountAmount;

			discountPrice = "$" + (discountAmount.toFixed(2)) + " ("
					+ percentOff + "%)";
		}

		element.find("#total_cost_with_discount")
				.html(original_cost.toFixed(2));
		element.find("#coupon_code_discount_percent").html(discountPrice);

	});

}

/** Get coupon json from stripe
* 
* @param couponId
* @param callback
* @returns {Boolean}
*/
function getCouponJSON(couponId, callback) {

	if (!couponId)
		return false;

	// Load image
	var $load_img = '<img src="img/1-0.gif" height="20px" width="20px" />';
	$("#coupon_code_container form i").before($load_img);

	// Rest call to get the amount to discount
	$.get("corea/subscription/coupon/" + couponId, {}, function(data) {
		// Remove loading
		$("#coupon_code_container form img").remove();

		// Set this coupon object
		if (!data.id)
			AGILE_COUPONS_JSON[couponId] = "null";
		else
			AGILE_COUPONS_JSON[data.id] = data;

		// Call callback
		if (callback)
			callback(couponId);
	});

}


/**
 * Validate coupon
 * 
 * @param couponId
 * @param callback
 * @returns
 */
function checkValidCoupon(couponId, callback) {

	if (!couponId)
		return callback(false);

	if (AGILE_COUPONS_JSON[couponId])
		return callback(AGILE_COUPONS_JSON[couponId] != "null")

	console.log(AGILE_COUPONS_JSON[couponId]);

	// Get coupon json from server
	getCouponJSON(couponId, function(id) {
		checkValidCoupon(id, callback);
	});
}

/*
 * Get coupon json from stripe
 * 
 * @param couponId
 * @param callback
 * @returns {Boolean}
 */
function getCouponJSON(couponId, callback) {

	if (!couponId)
		return false;

	// Load image
	var $load_img = '<img src="img/1-0.gif" height="20px" width="20px" />';
	$("#coupon_code_container form i").before($load_img);

	// Rest call to get the amount to discount
	$.getJSON("core/api/subscription/coupon/" + couponId, {}, function(data) {
		console.log(data);
		// Remove loading
		$("#coupon_code_container form img").remove();

		// Set this coupon object
		if (!data.id)
			AGILE_COUPONS_JSON[couponId] = "null";
		else
			AGILE_COUPONS_JSON[data.id] = data;

		// Call callback
		if (callback)
			callback(couponId);
	});

}


function showCouponStatus(couponId) {

	var $load_img = '<img src="img/1-0.gif" height="15px" width="15px" />';
	$("#check_valid_coupon").remove($load_img);

}/**
 * invoice.js is a script file to navigates to invoice details template if
 * clicked on invoice list element client side.
 * 
 * @module Billing author: Yaswanth
 */
function initializeInvoicesListeners()
{
	$('#invoice-details-holder').on('click', '#invoice-model-list > tr', function(e)
	{
		e.preventDefault();

		// Reads the id of the invoice
		var invoice_id = $(this).find('.data').attr('data');

		if (invoice_id)
		{
			Backbone.history.navigate("invoice/" + invoice_id, {
				trigger : true
			});
		}
		// App_Subscription.invoiceDetails(data);
	});
	
	/*$('#invoice-details-holder').on('click', '#charge-model-list > tr', function(e)
			{
				e.preventDefault();
				var invoice_id = $(this).find('.data').attr('data');
				if (invoice_id)
				{
					window.document.location = "#getInvoiceDetails/"+invoice_id;
				}	
								
	});*/
}var plan_json = [];
var INTERVALS = ["monthly", "yearly", "biennial"];
//Plans with costs
var PLANS_COSTS_JSON = {};
PLANS_COSTS_JSON.starter = "14.99";
PLANS_COSTS_JSON.regular = "49.99";
PLANS_COSTS_JSON.pro = "79.99";
PLANS_COSTS_JSON.enterprise = "79.99";

// Plans intervals JSON
var PLANS_DISCOUNTS_JSON = {};
PLANS_DISCOUNTS_JSON.monthly = "0";
PLANS_DISCOUNTS_JSON.yearly = "20";
PLANS_DISCOUNTS_JSON.biennial = "40";

var PLANS_DISCOUNTS_JSON_NEW = {};

PLANS_DISCOUNTS_JSON_NEW.starter = {};
PLANS_DISCOUNTS_JSON_NEW.starter.monthly = "0";
PLANS_DISCOUNTS_JSON_NEW.starter.yearly = "33.355";
PLANS_DISCOUNTS_JSON_NEW.starter.biennial = "40";

PLANS_DISCOUNTS_JSON_NEW.regular = {};
PLANS_DISCOUNTS_JSON_NEW.regular.monthly = "0";
PLANS_DISCOUNTS_JSON_NEW.regular.yearly = "20";
PLANS_DISCOUNTS_JSON_NEW.regular.biennial = "40";

PLANS_DISCOUNTS_JSON_NEW.pro = {};
PLANS_DISCOUNTS_JSON_NEW.pro.monthly = "0";
PLANS_DISCOUNTS_JSON_NEW.pro.yearly = "18.75";
PLANS_DISCOUNTS_JSON_NEW.pro.biennial = "40";

PLANS_DISCOUNTS_JSON_NEW.enterprise = {};
PLANS_DISCOUNTS_JSON_NEW.enterprise.monthly = "0";
PLANS_DISCOUNTS_JSON_NEW.enterprise.yearly = "18.75";
PLANS_DISCOUNTS_JSON_NEW.enterprise.biennial = "40";

function is_new_signup_payment()
{
	return IS_NEW_USER && _plan_on_signup;
}var plan_json = [];
var email_json = {};
var PLAN_DETAILS = { getPlanPrice : function(plan_name)
{
	return PLANS_COSTS_JSON[plan_name];
}, getDiscountedPrice : function(plan_name, interval)
{
	var price = this.getPlanPrice(plan_name);
	var discount = PLANS_DISCOUNTS_JSON_NEW[plan_name][interval];
	return price * (100 - discount) / 100;
}, getDiscount : function(plan_name, interval)
{
	return PLANS_DISCOUNTS_JSON_NEW[plan_name][interval];
} }

// User existing plan name
var user_existing_plan_name = "";
var USER_CREDIRCARD_DETAILS = {};
var USER_BILLING_PREFS;

var USER_DETAILS = { getCurrentPlanName : function(userJSON)
{
	if (userJSON.plan.plan_type == "FREE")
		return "free";
	return userJSON.plan.plan_type;
},

getDomainName : function(userJSON)
{
	if (userJSON.plan.plan_type == "FREE")
		return "free";
	return userJSON.domain_name;
},

getCurrentPlanId : function(userJSON)
{
	if (userJSON.plan.plan_type == "FREE")
		return "free";
	return userJSON.plan.plan_id;
}, getPlanType : function(userJSON)
{
	if (userJSON.plan.plan_type == "FREE")
		return "free";

	if (userJSON.plan.plan_type)
	{
		if (userJSON.plan.plan_type.split("_").length == 1)
			return userJSON.plan.plan_type;

		// Returns lite-yearly....
		return userJSON.plan.plan_type.split("_")[0];
	}
	return "LITE"
}, getPlanInterval : function(userJSON)
{

	if (!userJSON || !userJSON.plan.plan_type || userJSON.plan.plan_type == "FREE")
		return "MONTHLY";

	var plan = userJSON.plan.plan_type

	if (plan)
		return plan.split("_")[1];

}, getQuantity : function(userJSON)
{

	if (!userJSON || !userJSON.plan || userJSON.plan.plan_type == "FREE")
		return 2;

	return userJSON.plan.quantity;
}, getPlanTypeByStripe : function(userJSON)
{
	var billing_data = JSON.parse(userJSON.billingData);
	if (!billing_data.subscription)
		return "free";

	if (billing_data.subscription.plan.name)
	{
		if (billing_data.subscription.plan.name.toUpperCase().replace(/\s/g, '').split("-").length == 1)
			return billing_data.subscription.plan.name.toUpperCase().replace(/\s/g, '').replace("-", '_');

		// Returns lite-yearly....
		return billing_data.subscription.plan.name.toUpperCase().replace(/\s/g, '').split("-")[0];
	}
	return "LITE"
}, getPlanIntervalByStripe : function(userJSON)
{
	if (!userJSON)
		return "MONTHLY";
	var billing_data = JSON.parse(userJSON.billingData);
	if (!billing_data.subscription || !billing_data.subscription.plan.name)
		return "MONTHLY";

	var plan = billing_data.subscription.plan.name;

	if (plan)
		return billing_data.subscription.plan.name.toUpperCase().replace(/\s/g, '').split("-")[1];

}

}

function load_slider(el)
{
	$("#users_select_slider", el).slider({ from : 1, to : 20, step : 1, skin : "plastic", onstatechange : function(value)
	{
		$("#users_quantity", el).text(value);
		price = update_price();
		$("#users_total_cost", el).text((value * price).toFixed(2));
	} });
}

function setCost(price)
{
	return $("#users_total_cost").text(($("#users_quantity").text() * price).toFixed(2));
}

function update_price()
{
	// Get the selected plan cost
	var plan_name = $("#plan_type").val();
	return $("#" + plan_name + "_plan_price").text();
}

function setPriceTemplete(user_plan, element)
{

	var interval = "yearly", plan_type = "pro", quantity = 1;

	if (user_plan != "free" && user_plan != "super")
	{
		plan_type = USER_DETAILS.getPlanType(USER_BILLING_PREFS);
		interval = USER_DETAILS.getPlanInterval(USER_BILLING_PREFS);
		quantity = USER_DETAILS.getQuantity(USER_BILLING_PREFS);

		plan_type = plan_type.toLowerCase();
		interval = interval.toLowerCase();
	}

	if (IS_NEW_USER && _plan_on_signup)
	{
		quantity = _plan_on_signup.quantity;
	}

	$(element).find('#' + plan_type + '_plan_select').attr('checked', 'checked');
	$(element).find('.' + interval).addClass("plan-select");
	$(element).find('#users_select_slider').val(quantity);
	$(element).find('#billing_cycle').val(interval);
	return element;

}

function setPlan(user_plan)
{

	try
	{
		var interval = "yearly", plan_type = "regular";
		if (IS_NEW_USER && _plan_on_signup)
		{
			plan_type = _plan_on_signup.plan_type.toLowerCase();
			interval = "yearly";
		}
		else if (user_plan != "free" && user_plan != "super")
		{
			var stripe_subscription = getSubscription(user_plan.billingData, user_plan.plan);
			if (stripe_subscription || CURRENT_DOMAIN_USER.domain == "admin")
			{
				plan_type = USER_DETAILS.getPlanTypeByStripe(USER_BILLING_PREFS);
				interval = USER_DETAILS.getPlanIntervalByStripe(USER_BILLING_PREFS);

				plan_type = plan_type.toLowerCase();
				interval = interval.toLowerCase();
			}
			else
			{
				interval = "yearly";
				plan_type = "free";
			}
		}

		$("#plan_type").val(plan_type).trigger("change");

		// $("ul.tagsli a." + interval).trigger("click");
		$("#billing_cycle").val(interval).trigger("change");

	}
	catch (err)
	{
		console.log(err);
		// alert(err);
	}
}

function initializeSubscriptionListeners()
{


	$('#subscribe_plan_change').off("click");

	$('#subscribe_plan_change').on('click', '.plan-collection-in', function(e)
	{

		$(this).find("[name='pro_vs_lite']").attr('checked', 'checked');
		var plan_type = "";
		$('.plan-collection-in').each(function(index, element)
		{

			// Get plan type
			plan_type = $(element).find("#plan_name").text().toLowerCase();
			$(element).find("span.plan-collection-icon").removeClass(plan_type + "_selected");
		});

		// Get plan type
		plan_type = $(this).find("#plan_name").text().toLowerCase();
		$(this).find("span.plan-collection-icon").addClass(plan_type + "_selected");

		// Set cost based on the selected plan type
		var selected_plan = $(this).find("[name='pro_vs_lite']").val();

		removeStyleForAPlan();
		var id = $(this).parent();
		addStyleForAPlan(id, null);
		$("#plan_type").val(id.attr("id").split("_")[0]);

		// Cost
		setCost(update_price());

	});

	// Tags selection
	$('#subscribe_plan_change #plans-panel').off('click').on('click', 'ul.tagsli a', function(e)
	{

		e.preventDefault();

		$("ul.tagsli a").removeClass("plan-select");
		$(this).addClass("plan-select");

		// Get interval
		var plan_interval = $(this).attr("class");
		plan_interval = plan_interval.replace("plan-select", "");
		plan_interval = plan_interval.trim();

		for ( var key in PLANS_COSTS_JSON)
		{
			var amount = PLANS_COSTS_JSON[key];
			var discount = PLAN_DETAILS.getDiscount(key, plan_interval);
			var discount_amount = amount - ((discount / 100) * amount);
			$('#' + key + '_plan_price').html(discount_amount.toFixed(2));
		}

		// Cost
		setCost(update_price());
	});

	$('#subscribe_plan_change').on('change', '#billing_cycle', function(e)
	{
		e.preventDefault();
		var plan_interval = $(this).val();

		for ( var key in PLANS_COSTS_JSON)
		{
			var amount = PLANS_COSTS_JSON[key];
			var discount = PLAN_DETAILS.getDiscount(key, plan_interval);
			var discount_amount = amount - ((discount / 100) * amount);
			$('#' + key + '_plan_price').html(discount_amount.toFixed(2));
		}
		var price = update_price();
		if (!price)
			return;
		var value = $("#user_quantity").val();
		$("#users_quantity").text(value);
		$("#users_total_cost").text((value * price).toFixed(2));

	});
	$('#subscribe_plan_change').on('change', '#user_quantity', function(e)
	{
		e.preventDefault();
		var value = $(this).val();
		price = update_price();

		$("#users_quantity").text(value);

		$("#users_total_cost").text((value * price).toFixed(2));

		var quantity = $("#user_quantity").val();

		(quantity && quantity > 1) ? $("#users_quantity_text").text("Users") : $("#users_quantity_text").text("User");

	});

	$('#subscribe_plan_change').on('change', '#plan_type', function(e)
	{
		var plan_type = $(this).val();
		$("#" + plan_type + "_plan > .plan-collection-in").click();
		if ($(this).val() == "free")
		{
			$("#plans-panel .plan-collection-bot").css("opacity", "0.5");
			setCost(update_price());
		}
	});

	$('#subscribe_plan_change').on('click', '#purchase-email-plan', function(e)
	{

		if (!email_validation($("#email-plan-form")))
		{
			e.preventDefault();
		}
		var emailQuantity = $("#email-quantity").val();
		var emailCost = $("#emails_total_cost").text();
		var emailRate = $("#email_rate").text();
		var currentDate = new Date();
		// email_json.billingDate =
		// currentDate.setDate(currentDate.getDate()+30) / 1000;
		email_json.billingData = App_Subscription.subscribe_plan.model.toJSON()['billingData'];
		email_json.emailRate = emailRate;
		email_json.emailCost = emailCost;
		email_json.quantity = emailQuantity;
		// console.log("email_json"+email_json);
		// if(!$.isEmptyObject(USER_CREDIRCARD_DETAILS)){
		//				    	
		// plan_json.customer = JSON.parse(USER_CREDIRCARD_DETAILS);
		// }

	});

	$('#subscribe_plan_change').on(
			'click',
			'#purchase-plan',
			function(e)
			{
				/*
				 * var quantity = $("#users_quantity").text(); var cost =
				 * $("#users_total_cost").text(); var plan =
				 * $("input[name='pro_vs_lite']:checked").val();
				 */

				var quantity = $("#user_quantity").val();
				var cost = $("#users_total_cost").text();
				var plan = $("#plan_type").val();
				if("pro" == plan)
					plan = "enterprise";
				var discount = "", months = "";
				var billing_cycle = $("#billing_cycle").val();
				if (!plan || plan == "free")
				{
					alert("Please select a plan to proceed");
					return false;
				}

				/*
				 * if($('.monthly').hasClass("plan-select")){cycle =
				 * "Monthly";months = 1; discount =
				 * PLAN_DETAILS.getDiscount(plan, "monthly")} else
				 * if($('.yearly').hasClass("plan-select")){cycle =
				 * "Yearly";months = 12;discount =
				 * PLAN_DETAILS.getDiscount(plan, "yearly")} else
				 * if($('.biennial').hasClass("plan-select")){cycle =
				 * "biennial";months = 24;discount =
				 * PLAN_DETAILS.getDiscount(plan, "biennial")}
				 */

				if (billing_cycle == "monthly")
				{
					cycle = "Monthly";
					months = 1;
					discount = PLAN_DETAILS.getDiscount(plan, "monthly")
				}
				else if (billing_cycle == "yearly")
				{
					cycle = "Yearly";
					months = 12;
					discount = PLAN_DETAILS.getDiscount(plan, "yearly")
				}
				else if (billing_cycle == "biennial")
				{
					cycle = "biennial";
					months = 24;
					discount = PLAN_DETAILS.getDiscount(plan, "biennial")
				}

				var variable = [];
				var amount = PLANS_COSTS_JSON[plan];
				for ( var interval in PLANS_DISCOUNTS_JSON_NEW[plan])
				{
					var percent = PLAN_DETAILS.getDiscount(plan, interval);
					var discount_amount = PLAN_DETAILS.getDiscountedPrice(plan, interval);
					variable[interval] = discount_amount.toFixed(2);
				}

				user_existing_plan_name = USER_DETAILS.getCurrentPlanId(USER_BILLING_PREFS);

				// Check the plan
				var selected_plan_name = amount + "-" + months;

				if (selected_plan_name.toLowerCase() + "-" + quantity == user_existing_plan_name + "-" + USER_DETAILS.getQuantity(USER_BILLING_PREFS))
				{
					alert("Please change your plan to proceed");
					return false;
				}

				var currentDate = new Date();
				plan_json.date = currentDate.setMonth(currentDate.getMonth() + months) / 1000;
				plan_json.new_signup = is_new_signup_payment();
				plan_json.price = update_price();
				plan_json.cost = (cost * months).toFixed(2);
				plan_json.months = months;
				plan_json.plan = plan;
				plan_json.plan_type = plan.toUpperCase() + "_" + cycle.toUpperCase();
				plan_json.cycle = cycle;
				plan_json.billingData = App_Subscription.subscribe_plan.model.toJSON()['billingData'];
				// Set coupon Only for Pro users
				delete plan_json["coupon_code"];
				var couponCode = $("#coupon_code").val();
				if (couponCode)
					plan_json.coupon_code = couponCode;

				if (cycle != "biennial")
				{
					plan_json.yearly_discount = ([
						cost * 12
					] - [
						variable.yearly * quantity * 12
					]).toFixed(2);
					plan_json.bi_yearly_discount = ([
						cost * 24
					] - [
						variable.biennial * quantity * 24
					]).toFixed(2);
				}

				if ((USER_DETAILS.getPlanType(USER_BILLING_PREFS) + "-" + USER_DETAILS.getQuantity(USER_BILLING_PREFS) + "-" + USER_DETAILS
						.getPlanInterval(USER_BILLING_PREFS)) == (plan.toUpperCase() + "-" + quantity + "-" + cycle.toUpperCase()))
				{

					alert("Please change the plan to proceed");
					return false;
				}

				var plan_id = (months > 1) ? PLANS_COSTS_JSON[plan] + "-" + months : PLANS_COSTS_JSON[plan];

				plan_json.plan_id = plan_id;
				plan_json.discount = discount;
				plan_json.quantity = quantity;
				plan_json.current_plan = USER_DETAILS.getCurrentPlanName(USER_BILLING_PREFS);
				plan_json.domain_name = USER_DETAILS.getDomainName(USER_BILLING_PREFS);
				if (!$.isEmptyObject(USER_CREDIRCARD_DETAILS))
				{

					plan_json.customer = JSON.parse(USER_CREDIRCARD_DETAILS);
				}

			});

	// Check coupon functionality
	$('#subscribe_plan_change').on('click', '#check_valid_coupon', function(e)
	{
		// Get coupon input value
		var couponId = $("#coupon_code").val();
		if (!couponId)
		{
			$("#coupon_code_container").find(".error").html("Invalid Coupon");
			return false;
		}

		$("#coupon_code_container i").removeAttr("class");
		var iconClass = "icon-", that = $(this);

		// Check coupon status
		checkValidCoupon(couponId, function(response)
		{
			iconClass += (response) ? "ok" : "remove";
			$("#coupon_code_container i").removeAttr("class").addClass(iconClass);
		});

	});

	$('#subscribe_plan_change').on("keyup", '#email-quantity', function(e)
	{
		// console.log(e.which);
		var quantity = $(this).val();
		if (isNaN(quantity))
			return;

		var emails = quantity * 1000;

		if (IS_HAVING_MANDRILL)
		{
			if(emails < 5000)
			{
				$("#emails_total_cost").html(quantity * 0);
				$("#email_rate").html("$2");
			}
			else
			{
				$("#emails_total_cost").html(quantity * 2);
				$("#email_rate").html("$2");
			}
		}
		else
		{
		if(emails < 5000)
		{
			$("#emails_total_cost").html(quantity * 0);
			$("#email_rate").html("$4");
		}
		else if (emails < 100000)
		{
			$("#emails_total_cost").html(quantity * 4);
			$("#email_rate").html("$4");
		}

		else if (emails <= 1000000)
		{
			$("#emails_total_cost").html(quantity * 3);
			$("#email_rate").html("$3");
		}
		else if (emails >= 1000000)
		{
			$("#emails_total_cost").html(quantity * 2);
			$("#email_rate").html("$2");
		}
		}
		email_validation($("#email-plan-form"));
		jQuery.validator.addMethod("email_plan_minimum", function(value, element)
		{

			if (this.optional(element))
				return true;

			return parseInt(value) >= 5;
		}, " Should purchase a minimum of 5000 emails.");
	});

}

function is_new_signup_payment()
{
	return IS_NEW_USER && _plan_on_signup;
}

function email_validation(form)
{

	$(form).validate(
			{ rules : { atleastThreeMonths : true, multipleEmails : true, email : true, phone : true }, debug : true, errorElement : 'span',
				errorClass : 'help-inline',

				// Higlights the field and addsClass error if validation failed
				highlight : function(element, errorClass)
				{
					$(element).closest('#email_validation_container').addClass('single-error');
				},

				// Unhiglights and remove error field if validation check passes
				unhighlight : function(element, errorClass)
				{
					$(element).closest('#email_validation_container').removeClass('single-error');
				},

				errorPlacement : function(error, element)
				{
					console.log(error);
					console.log($(element).closest('#email_validation_container').length);

					try
					{
						if ($(element).closest('#email_validation_container').length)
						{
							error.insertAfter($(element).closest('#email_validation_container'));
						}
						else
						{
							error.insertAfter($(element).closest(element));
						}
					}
					catch (err)
					{
						console.log(err);
					}

				} });
	return $(form).valid();
}
var _plan_restrictions = {};
$(function() {
	init_acl_restriction();
});

function init_acl_restriction()
{
	_plan_restrictions = {

			billing_restriction : _billing_restriction,
			plan : _billing_restriction.currentLimits,
			is_social_suite :  [ function(){
				return _plan_restrictions.plan.socialSuite;
			},
			function() {
				return {
					"message" : "Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Regular or Pro plan to use this feature."
				}
			}
			],

			// Emails tags
			is_email_gateway_allowed : [ function() {
				return _plan_restrictions.plan.emailGateway;
			}, function() {
				return {
					"message" : "Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Pro plan"
				}
			} ],
			
			// Emails tags
			is_sms_gateway_allowed : [ function() {
				return _plan_restrictions.plan.smsgateway;
			}, function() {
				return {
					"message" : "Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Regular or Pro plan"
				}
			} ],
			is_ecommerce_sync_allowed : [ function() {
				return _plan_restrictions.plan.ecommerceSync;
			},
			function()
			{
				return {
					"message" : "Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Regular or Pro plan"
				}
			}
			],
			
			is_accounting_sync_allowed : [function(){
				return _plan_restrictions.plan.accountingSync;
			},
			function() {
				return {
					"message" : "Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Regular or Pro plan"
				}
			}
			],

			// ACLs
			is_ACL_allowed : [ function() {
				return _plan_restrictions.plan.acl;
			}, function() {
				return {
					"message" : " Please <a href=\"#subscribe-plan\" class='c-p text-info'>upgrade</a> to Regular or Pro plan to use this feature. "
				}
			} ],
			is_calling_widget : [function(){
				return _plan_restrictions.plan.callingWidget;
			},
			function(){
				return {
					"message" : "Please <a href=\"#subscribe-plan\" class='c-p text-info'>upgrade</a> to Regular or Pro plan to use this feature. "
				}
			}
			],
			is_custom_widget : [function(){
				return _plan_restrictions.plan.customWidget;
			},
			function(){
				return {
					"message" : "Please <a href=\"#subscribe-plan\" class='c-p text-info'>upgrade</a> to Regular or Pro plan."
				}
			}
			],

			// Calendar
			online_appointment : [ function() {
				return _plan_restrictions.plan.onlineAppointment;

			}, function() {
				return 

			} ],

			// Mobile Integration
			is_mobile_integration : [function() {
				return _plan_restrictions.plan.mobileIntegration;
			},
			function () {
				
			}
			],

			/**
			 * Sync
			 * 
			 */
			// Google sync
			is_google_sync : function() {
				return this.plan.googleSync;
			},

			// Ecommerce Sync
			is_ecommerce_sync : function() {
				return this.plan.ecommerceSync;
			},

			// Payment Sync
			is_payment_sync : function() {
				return this.plan.paymentSync;
			},

			// Repoprts
			is_activity_reports_enabled : [ function() {
				return _plan_restrictions.plan.activityReports;
			}, function() {
				return {
					"message" : "Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Pro plan"
				}
			} ],
			is_cohort_reports_enabled : [ function() {
				return _plan_restrictions.plan.cohortReports;
			}, function() {
				return {
					"message" : "Regular/Pro plan only"
				}
			} ],
			process_widgets : function(data) {
				
				var collection = data.where({"is_added" : true});
				if(collection && collection.length >= _plan_restrictions.plan.widgetsLimit)
				{
					var collectionToBlock = data.where({"is_added" : false});
					
					for(var i= 0 ;i < collectionToBlock.length ; i++)
						{
						collectionToBlock[i].set("allowedToAdd", false);
						}
				}
				else if(collection && collection.length == 0)
				{
					var collectionToBlock = data.where({"allowedToAdd" : false});
					
					for(var i= 0 ;i < collectionToBlock.length ; i++)
						{
						collectionToBlock[i].set("allowedToAdd", true);
						}
				}
				console.log(data);
				
				if(!this.is_calling_widget[0]())
				{
					var call_widget_collection = data.where({"is_added" : false, "widget_type" : "CALL"});
					if(call_widget_collection && call_widget_collection.length)
					{
						for(var i = 0; i < call_widget_collection.length ; i++)
						{
							var widget_type= call_widget_collection[i].get("widget_type");
							if(widget_type == "CALL")
								{
									call_widget_collection[i].set("allowedToAdd", false);
								}
						}
					}
				}
			}
		}
		
		$('#content').on('click', '._upgrade', function(e) {
			e.preventDefault();
			var id = $(this).attr('id');
			if(!id)
				return;
			var element = $("." + id);
			
			if(!element || element.length == 0)
				return;
			
			$(element).show().delay(3000).hide(1);;
		})
}

function getDomainUserFromDeserialize(user)
{
	var json = {};
	json["menu_scopes"] = {};
	json ["user_scopes"] = {};
	
	json.menu_scopes["checked"] = true;
	json.menu_scopes["disabled"] = false;
	
	json.user_scopes["checked"] = true;
	json.user_scopes["disabled"] = false;
	
	if(!_plan_restrictions.is_ACL_allowed[0]())
		{
			json.menu_scopes["disabled"] = true;
			json.user_scopes["disabled"] = true;
			return json;
		}
	
	
	if(user && user.id)
		{
			json.menu_scopes["checked"] = false;
			json.menu_scopes["disabled"] = false;
		
			json.user_scopes["checked"] = false;
			json.user_scopes["disabled"] = false;
		}
	
	// If it is new user
	if(user != null && user.id && user.is_admin)
		{
			json.user_scopes["disabled"] = true;
		}
	console.log(user);
	console.log(json);
	return json;
}/*
 * Creates an view object on the model, with events click on .delete, .edit,
 * .agile_delete and respective funtionalities are defined and binds to current
 * view.
 */
var TAG_MODEL_VIEW = Backbone.View
		.extend(
		{
			events : {
				"click .delete" : "deleteItem",
				"click .edit" : "edit",
				"delete-checked .agile_delete" : "deleteItem",
				"keypress .edit-input" : "renameTag",
				"blur .edit-input" : "updateTag",
				"mouseover" : "showActionButtons",
				"mouseout" : "hideActionButtons",
				'click .details' : "showDetails",
				"click #add-new-tag" : "addNewTag",

			},
			/*
			 * Binds events on the model
			 */
			initialize : function() {
				_.bindAll(this, 'render', 'deleteItem', 'edit'); // every
																	// function
				// that uses 'this'
				// as the current
				// object should be
				// in here
				this.model.bind("destroy", this.close, this);

				this.model.bind("change", this.render, this);
			},
			showDetails : function(e) {
				e.preventDefault();
				var _that = this;
				var details_el = $(".details", this.el);

				/**
				 * Checks for last 'tr' and change placement of popover to 'top'
				 * inorder to prevent scrolling on last row of list
				 */
				$(this.el).popover(
						{
							"rel" : "popover",
							"trigger" : "click",
							"popover-title" : "\""
									+ this.model.get('tag') + "\" Stats",
							"content" : LOADING_HTML,
							'show' : true,
							"html" : true,
							'data-container' : this.el
						// "data-container" : '.tag'
						});


				$.getJSON('core/api/tags/getstats/' + this.model.get('tag'),
						function(data) {
							_that.model.set('availableCount',
									data.availableCount);
							console.log(_that.model.toJSON());
							$(_that.el).attr(
									'data-content',
									_that.model.get('availableCount')
											+ " Contacts");
							$(_that.el).popover('show');
						})
			},
			renameTag : function(e) {
				if (e.keyCode == 13) {
					$(e.currentTarget).blur();
				}
			},
			updateTag : function(e) {
				// console.log(this.input);

				if (this.model.get('tag') == this.input.val()) {
					$("#tag-solid-state", this.el).show();
					$("#editing", this.el).hide();
					$(this.el).addClass('tag');
					return;
				}
				if (!isValidTag(this.input.val(), true)) {
					this.input.val(this.model.get('tag')).focus();
					return;
				}

				var newTag = this.input.val().trim();
				var oldTag = this.model.get('tag');

				var r = false;
				var newTagObject = {};
				newTagObject.tag = newTag;
				var is_merge = isMergeTag(newTagObject);

				var message = "";
				if (is_merge)
					message = '<p>Tag "' + newTag
							+ '" exists already. Do you want to merge "'
							+ oldTag + '" and "' + newTag + '" ?</p>';
				else
					message = "<p>Rename tag \"" + oldTag + "\" to \"" + newTag
							+ "\" ?</p>";

				var _that = this;
				r = showModalConfirmation(
						'Tag Management Action',
						message,
						function() {
							_that.model.url = 'core/api/tags/bulk/rename?tag='
									+ newTag;

							_that.model
									.save(
											[],
											{
												success : function(data) {
													if (is_merge)
														showNotyPopUp(
																'information',
																"Merging tags \""
																		+ oldTag
																		+ "\" and \""
																		+ newTag
																		+ "\". This may take a while.  You may see the merged tag on some contacts cc",
																"top", 5000);
													else
														showNotyPopUp(
																'information',
																"Renaming tag \""
																		+ oldTag
																		+ "\" to \""
																		+ newTag
																		+ "\". This may take a while. You may see the renamed tag on some contacts while this happens",
																"top", 5000);
												}
											});

							if (is_merge) {
								_that.remove();
								return;
							}

							_that.model.set('tag', _that.input.val().trim());
							$(_that.el).addClass('tag');
							if(isValidTag(_that.input.val().trim(), false)) {
								$(_that.el).removeClass('error');
							}

						}, function() {
							_that.reset();
							return;
						}, function() {
							_that.reset();
							return;
						});

			},
			reset : function() {
				$("#tag-solid-state", this.el).show();
				$("#editing", this.el).hide();
				$(this.el).addClass('tag');
			},
			showActionButtons : function(e) {
				e.preventDefault();
				$('#actions', this.el).show();
				$("a", this.el).popover('toggle');
			},
			hideActionButtons : function(e) {
				e.preventDefault();
				$('#actions', this.el).hide();
				$(this.el).attr(
						{
							"data-trigger" : "click",
						})
				$(this.el).popover({"trigger" : "focus", 'hide': true});
			},
			addNewTag : function(e) {
				e.preventDefault();
				$("#add-new-tag", this.el).addClass("hide");
				$("#new_tag_field_block", this.el).removeClass("hide");
			},
			/*
			 * On click on ".delete" model representing the view is deleted, and
			 * removed from the collection
			 */
			deleteItem : function(e) {
				e.preventDefault();
				var _that = this;
				showModalConfirmation(
						'Tag Management',
						"<p>Delete \"" + this.model.get('tag') + "\" tag ?</p>",
						function() {
							_that.model.url = "core/api/tags/bulk/delete?tag="
									+ escape(_that.model.get('tag'));
							_that.model.set({
								"id" : _that.model.get('tag')
							});
							_that.model
									.destroy({
										success : function(model, respone) {
											showNotyPopUp(
													'information',
													"Deleting tag \""
															+ _that.model
																	.get('tag')
															+ "\".  You may see the deleted tag on some contacts while this happens",
													"top", 5000);
										}
									});
						});
			},
			edit : function(e) {
				e.preventDefault();

				$("#tag-solid-state", this.el).hide();
				$(this.el).removeClass('tag');
				$("#editing", this.el).show();
				addTagsDefaultTypeahead($("#editing", this.el));
				this.input.attr('width', '100%').focus();
				this.input.val(this.model.get('tag'));

			},
		render : function(callback) {
				$(this.el)
						.html(
								getTemplate(this.options.template, this.model
										.toJSON()));
				$(this.el).data(this.model);
				this.input = $('.edit-input', this.el);
				// Add model as data to it's corresponding row

				return this;
		
			}
		});

function append_tag_management(base_model) {

	var itemView = new TAG_MODEL_VIEW({
		model : base_model,
		"view" : "inline",
		template : this.options.templateKey + "-model",
		tagName : 'li',
	});

	console.log(itemView);

	var key = base_model.get('tag').charAt(0).toUpperCase();
	console.log($('div[tag-alphabet="' + encodeURI(key) + '"]', this.el))

	var el = itemView.render().el;
	$(el).addClass('tag bg-white');
	
	var tag_name = base_model.get('tag');
	if(!isValidTag(tag_name, false)) {
		$(el).addClass('error');
	}

	var element = $('div[tag-alphabet="' + encodeURI(key) + '"] ul', this.el);
	console.log(element.length);
	if (element.length > 0)
		$('div[tag-alphabet="' + encodeURI(key) + '"] ul', this.el).append(
				$(el));
	else {
		$(this.model_list_element).append("<div class='clearfix'></div>")
				.append($(el));
	}

	// $(this.model_list_element).append($(el));
}

function initializeTagManagementListeners(){


$('#admin-prefs-tabs-content').on('click', '#add-new-tag', function(e){
	e.preventDefault();

	toggleAddTag(true);
});

$('#admin-prefs-tabs-content').on('keydown', '#new_tag', function(event){
	console.log(event.which)

	if (event.which == 0) {
		blur_out_input_field(this);
		return;
	} else if (event.which != 13)
		return;
	saveTag(this);
});
}

function blur_out_input_field(element) {
	var value = $(element).val().trim();

	if (value == "") {
		toggleAddTag(false);
		return;
	}
	
	saveTag(element);
}

function toggleAddTag(show) {
	if (show) {
		$("#add-new-tag").hide();
		$("#new_tag_field_block").show();
		$("#add_new_tag").removeAttr('disabled');
		$("#new_tag").focus();
		console.log($("#add_new_tag").attr('disabled'));
		
		return;
	}
	$("#add-new-tag").show();
	$("#new_tag_field_block").hide();

}

/*
 * $("#new_tag").on('blur', function(event){
 * 
 * });
 */

$('body').on('click', '#add_new_tag', function(e){
	e.preventDefault();
	var newTag = $().val();

	blur_out_input_field("#new_tag");
});

function saveTag(field) {
	var fieldValue = $(field).val();

	if ($(field).attr('disabled'))
		return;

	if (!isValidTag(fieldValue, true)) {
		$(field).focus();
		return;
	}
	var existingTagObject = App_Admin_Settings.tagsview1.collection.where({tag:fieldValue.trim()});
	if(existingTagObject && existingTagObject.length > 0) {
		var message = "<p>Tag \"" + fieldValue.trim() + "\" exists already. Please choose a different name.</p>";

		var _that = this;
		r = showModalConfirmation(
				'Tag Management Action',
				message,
				function() {
					return;
				},function() {
					return;
				},function() {
					return;
				}, 'Ok');

		return;
	}

	var tagObject = {};
	tagObject.tag = fieldValue.trim();

	// Disables input field
	$(field).attr('disabled', 'disabled');

	var model = new BaseModel(tagObject);
	model.url = "core/api/tags";
	model.save([], {
		success : function(response) {
			$(field).val("");
			$(field).removeAttr('disabled');
			toggleAddTag(false);
			
			showNotyPopUp('information', "New tag \"" + model.get('tag')
					+ "\" created.", "top", 5000);

		}
	});
	console.log(App_Admin_Settings);
	App_Admin_Settings.tagsview1.collection.add(model);

}

function isValidTag(tag, showAlert) {
	
	var r = '\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA793\uA7A0-\uA7AA\uA7F8-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC';
	var regexString = '^['+r+']['+r+' 0-9_-]*$';
	var is_valid = new RegExp(regexString).test(tag);
	if (showAlert && !is_valid)
		alert("Tag name should start with an alphabet and can not contain special characters other than underscore, space and hypen");
	return is_valid;
}

/**
 * Added tags typeahead on fields
 * 
 * @param element
 */
function addTagsDefaultTypeaheadTagManagement(element) {
	var tags_array = [];

	// 'TAGS' are saved in global variable when they are fetched to show stats
	// in contacts page. If it is undefined, tags are fetched from DB an then
	// type ahead is built
	if (!TAGS) {
		var TagsCollection = Backbone.Collection.extend({
			url : '/core/api/tags',
			sortKey : 'tag'
		});

		tagsCollection = new TagsCollection();

		tagsCollection
				.fetch({
					success : function(data) {
						TAGS = tagsCollection.models;
						addTagsArrayasTypeaheadSource(tagsCollection.toJSON(),
								element);

					}
				});
		return;
	}

	// Adds typeahead to given element
	addTagsArrayasTypeaheadSourceTagManagement(tagsCollection.toJSON(), element);
}

function isMergeTag(tag) {
	console.log(App_Admin_Settings.tagsview1.collection.where({
		"tag" : tag.tag
	}));
	return (App_Admin_Settings.tagsview1.collection.where({
		"tag" : tag.tag
	}).length > 0);
}

// With tags JSON sent type ahead is built on input fields
function addTagsArrayasTypeaheadSource(tagsJSON, element) {
	var tags_array = [];

	$.each(tagsJSON, function(index, element) {
		tags_array.push(element.tag.toString());
	});

	// $("input", element).attr("data-provide","typeahead");
	$("input", element).typeahead({
		"source" : tags_array
	}).attr('placeholder', "Enter Tag");
}

function showModalConfirmation(title, body, yes_callback, no_callback,
		close_callback, yes_button_text, no_button_text) {
	if(!yes_button_text && !no_button_text)
	{
		yes_button_text = "Yes";
		no_button_text = "No";
	}
	var yes_action = "";
	var no_action = "";
	if(yes_button_text)
		yes_action = '<a href="#" id="confirm" class="action btn btn-primary" action="confirm">'+yes_button_text+'</a>';
	if(no_button_text)
		no_action = '<a  href="#" id="deny" class="btn btn-danger action" data-dismiss="modal" action="deny">'+no_button_text+'</a>';
		
	var confirmationModal = $('<div id="confirmation" class="modal fade in">'
			+ '<div class="modal-dialog">'
			+ '<div class="modal-content">'
			+ '<div class="modal-header" >'
			+ '<a href="#" data-dismiss="modal" class="close">&times;</a>'
			+ '<h3>'
			+ title
			+ '</h3></div>'
			+ '<div class="modal-body">'
			+ body
			+ '</div>'
			+ '<div class="modal-footer">'
			+ '<div>'
			+ no_action
			+ yes_action
			+ '</div>' + '</div>' + '</div>' + '</div>' + '</div>' + '</div>');

	confirmationModal.modal('show');
	confirmationModal.focus();

	confirmationModal.on('hidden.bs.modal', function(e) {
		if (close_callback && typeof close_callback == "function")
			close_callback();

	});

	$(".action", confirmationModal).click(
			function(e) {
				e.preventDefault();
				var action = $(this).attr('action');

				confirmationModal.modal('hide');

				if (action == "confirm" && yes_callback
						&& typeof yes_callback == "function") {
					yes_callback();
					return;
				}

				if (no_callback && typeof no_callback == "function")
					no_callback(this);

			})

}// Before selecting proper type array from map, need to fill map with user's detail.
function startMakingCollection(criteria, pending)
{
	console.log("in startMakingCollection");
	console.log(criteria+" "+ pending);
	
	// Check for list view 
	if(criteria == "LIST")
		{	
		  // Display list view
		  displayListView();
		  return;
		}	
	
	// Hide list view and show column view with loading img
	hideListViewAndShowLoading();
			
	// Get user details and add into GROUPING_MAP's owner array.
	if (criteria == "OWNER" && GROUPING_MAP[criteria].type.length == 0)
		getUserDetails(function(data)
		{
			findArrayForCollection(criteria, pending);
		});
	else
		findArrayForCollection(criteria, pending);
}

// Decide which array to pass for creation of collection.
function findArrayForCollection(criteria, pending)
{
	if (criteria == "CATEGORY")
		categories.getGroupingMap(function(map){
			GROUPING_MAP[criteria] = map;
			console.log('-------------------',map);
			// Sort task list on count of task and then create collection
			//getArraySortOnCount(criteria, GROUPING_MAP[criteria].type, pending);
			createNestedCollection(criteria, GROUPING_MAP[criteria].type, pending);
		});
	else
		// Creates nested collection
		createNestedCollection(criteria, GROUPING_MAP[criteria].type, pending);
}

// Creates nested collection
function createNestedCollection(criteria, criteriaArray, pending)
{
	console.log("In createNestedCollection");

	// Initialize nested collection
	initTaskListCollection();

	// Url to call DB
	var initialURL = null;

	if (criteria == "DUE")
		initialURL = '/core/api/tasks/fordue' + getParamsNew() + "&pending=" + pending;
	else
		initialURL = '/core/api/tasks/forcategory' + getParamsNew() + "&pending=" + pending;

	// Creates main collection with Task lists
	for ( var i in criteriaArray)
	{
		var newTaskList;

		// Url to call DB
		var url = null;

		// Add heading to task list in main collection
		if (criteria == "OWNER")
		{
			url = initialURL + "&owner=" + criteriaArray[i].id;
			newTaskList = { "heading" : criteriaArray[i].name, "owner_id" : criteriaArray[i].id, "url" : url, "flag" : true };
		}
		else
		{
			url = initialURL + "&type=" + criteriaArray[i];
			newTaskList = { "heading" : criteriaArray[i], "url" : url, "flag" : true };
		}

		if (!newTaskList)
			return;

		// Add task list in main collection
		TASKS_LIST_COLLECTION.collection.add(newTaskList);// main-collection
	}

	// Render it
	$('#new-task-list-based-condition').html(TASKS_LIST_COLLECTION.render(true).el);

	// Fetch tasks from DB for first task list
	fetchForNextTaskList();
}

// Initialize nested collection
function initTaskListCollection()
{
	// Define main collection
	TASKS_LIST_COLLECTION = new Base_Collection_View({ restKey : "task", templateKey : "new-tasks-lists", individual_tag_name : 'div',
		className : "list-area-wrapper", sort_collection : false, postRenderCallback : function(el)
		{
			// Remove loding imgs
			$('.loading-img', el).remove();
			$('.loading', el).remove();

			// Adjust Height Of Task List And Scroll as per window size
			adjustHeightOfTaskListAndScroll();			
		} });

	// Over write append function
	TASKS_LIST_COLLECTION.appendItem = taskAppend;
}

// Append sub collection and model
function taskAppend(base_model)
{
	var tasksListModel = new Base_List_View({ model : base_model, "view" : "inline", template : "new-tasks-lists-model", tagName : 'div',
		className : "task-trello-list panel panel-default", id : base_model.get("heading") });

	// Render model in main collection
	var el = tasksListModel.render().el;

	// Append model from main collection in UI
	$('#new-tasks-lists-model-list', this.el).append(el);
}

/**
 * Create sub collection, ad to model in main collection, fetch tasks from DB
 * for sub collection and update UI.
 */
function taskFetch(index)
{
	console.log("index: " + index);

	// Get model from main collection
	var base_model = TASKS_LIST_COLLECTION.collection.at(index);

	if (!base_model)
		return;

	// Define sub collection
	var taskCollection = new Base_Collection_View({
		url : base_model.get("url"),
		templateKey : 'task',
		individual_tag_name : 'div',
		sort_collection : false,
		cursor : true,
		page_size : 20,
		postRenderCallback : function(el)
		{
			var flag = false;

			if (base_model.has("owner_id"))
				flag = $("div[id='list-tasks-" + base_model.get("heading") + "-" + base_model.get("owner_id") + "']")[0];
			else
				flag = $("div[id='list-tasks-" + base_model.get("heading") + "']")[0];

			// If we have task list then only need to apply following
			if (flag)
			{
				// Remove loading icon from task list header
				removeLoadingIcon(base_model.toJSON());

				// Display task count
				addTaskCount(base_model.toJSON());

				// Apply infi scroll on sub-collection
				if (base_model.has("owner_id"))
					initialize_infinite_scrollbar($("div[id='list-tasks-" + base_model.get("heading") + "-" + base_model.get("owner_id") + "']")[0],
							taskCollection);
				else
					initialize_infinite_scrollbar($("div[id='list-tasks-" + base_model.get("heading") + "']")[0], taskCollection);
			}
		} });

	// Fetch task from DB for sub collection
	taskCollection.collection.fetch({ success : function(data)
	{
		// Add sub collection in model of main collection.
		base_model.set('taskCollection', taskCollection.collection);

		// Update UI
		if (base_model.has("owner_id"))
			$("div[id='list-tasks-" + base_model.get("heading") + "-" + base_model.get("owner_id") + "']").html(taskCollection.render(true).el);
		else
			$("div[id='list-tasks-" + base_model.get("heading") + "']").html(taskCollection.render(true).el);

		// Adjust Height Of Task List And Scroll as per window size
		adjustHeightOfTaskListAndScroll();

		// Maintain changes in UI
		displaySettings();

		// Gives ability of dragging and dropping to tasks in task list.
		setup_sortable_tasks();

		// Counter to fetch next sub collection
		FETCH_COUNTER++;

		// Fetch tasks from DB for next task list
		fetchForNextTaskList();
	} });
}
/*Get user's name and id to add in GROUPING_MAP for owner of task, 
 * user name can be redundant so we need user's id too.*/
function getUserDetails(callback)
{
	$.getJSON('/core/api/users', function(users)
	{
		for ( var i in users)
		{
			GROUPING_MAP.OWNER.type[i] = { "name" : users[i].name, "id" : users[i].id };
		}

		if (callback && typeof (callback) === "function")
			callback();

	}).error(function(data)
	{
		console.log("get user err");
		console.log(data);
	});
}

// Gives heading of task list from due of task
function getHeadingForDueTask(task)
{
	var headingToSearch = null;

	// add to the right task list - overdue, today, tomorrow etc.
	var due = get_due(task.due);

	// OVERDUE
	if (due < 0)
		return headingToSearch = "OVERDUE";

	// Today
	if (due == 0)
		return headingToSearch = "TODAY";

	// Tomorrow
	if (due == 1)
		return headingToSearch = "TOMORROW";

	// Next Week
	if (due > 1)
		return headingToSearch = "LATER";
}

// As per new task list get new due date for task, after task drop
function getNewDueDate(newTaskListId)
{
	var d = new Date();

	// OVERDUE (yesterday)
	if (newTaskListId == "OVERDUE")
		d.setDate(d.getDate() - 1);

	// Today
	if (newTaskListId == "TODAY"){
		(getGMTTimeFromDate(d) / 1000);
	}
		

	// Tomorrow
	if (newTaskListId == "TOMORROW")
		d.setDate(d.getDate() + 1);

	// Later Day after tomorrow
	if (newTaskListId == "LATER")
		d.setDate(d.getDate() + 2);

	return (getGMTTimeFromDate(d) / 1000);
}



//As per new task list get new due date for task, after task drop
function getNewDueDateBasedOnTime(newTaskListId,duedate)
{
	var d = new Date();
	var d1 = new Date(duedate*1000);
	var secs = d1.getSeconds() + (60 * d1.getMinutes()) + (60 * 60 * d1.getHours());
	console.log(secs);

	// OVERDUE (yesterday)
	if (newTaskListId == "OVERDUE")
		d.setDate(d.getDate() - 1);

	// Today
	if (newTaskListId == "TODAY")
		(getGMTTimeFromDate(d) / 1000);

	// Tomorrow
	if (newTaskListId == "TOMORROW")
		d.setDate(d.getDate() + 1);

	// Later Day after tomorrow
	if (newTaskListId == "LATER")
		d.setDate(d.getDate() + 2);

	return (getGMTTimeFromDate(d) / 1000)+secs;
}



// On basis of status return progress value, when criteria is status and task is
// dragged in task lists.
function getProgressValue(status)
{
	if (status == YET_TO_START)
		return 0;
	else if (status == COMPLETED)
		return 100;
	else if (status == IN_PROGRESS)
		return 1;
}

// Get Task id from UI
function getTaskId(element)
{
	if ($(element).hasClass('task-body'))
		return $(element).parent().attr('id');
	else
		return $(element).attr('data');
}

// Get heading of task list
function getTaskListId(element)
{
	return $(element).closest('.task-trello-list').attr('id');
}

/*
 * Get owner's id when heading of task list is Owner's name, name can be
 * duplicate so get owner's Id.
 */
function getTaskListOwnerId(element)
{
	return $(element).closest('.task-trello-list').find('.list-header').attr('ownerID');
}

// Get Criteria from dropdown
function getCriteria()
{
	// Get selection from criteria dropdown
	var criteria = $('#new-type-tasks').data("selected_item");

	// If criteria is not selected then make it default one
	if (!criteria)
		criteria = "DUE";

	return criteria;
}

// Get task list from main-collection by ID
function getTaskList(criteria, taskListId, owner_id)
{
	// Get task list
	if (criteria == "OWNER")
		return TASKS_LIST_COLLECTION.collection.where({ heading : taskListId, owner_id : parseInt(owner_id) });
	else
		return TASKS_LIST_COLLECTION.collection.where({ heading : taskListId });
}

// Get form ID for notes in task
function getTaskFormId(element)
{
	// Get form Id
	var formId = $(element).closest('form').attr('id');
	console.log(formId);
	return formId;

}

// Get task count of all task list and call function to sort array and create
// collection.
function getArraySortOnCount(criteria, criteriaArray, pending)
{
	var initialURL = '/core/api/tasks/countoftype' + getParamsNew() + "&pending=" + pending;

	var countTypeArray = {};

	$.each(criteriaArray, function(index, type)
	{
		var url = initialURL + "&type=" + criteriaArray[index];

		$.getJSON(url, function(data)
		{
			countTypeArray[data.type] = data.count;

			if (_.size(countTypeArray) == criteriaArray.length)
				sortArray(criteria, countTypeArray, pending);

		}).error(function(data)
		{
			console.log("get count err");
			console.log(data);
		});
	});
}

// Sort array on count and call function to create collection.
function sortArray(criteria, countTypeArray, pending)
{
	var array = [];
	var result = [];

	for (a in countTypeArray)
		array.push([
				a, countTypeArray[a]
		]);

	array.sort(function(a, b)
	{
		return a[1] - b[1]
	});

	array.reverse();

	for (a in array)
		result.push(array[a][0]);

	// Creates nested collection
	createNestedCollection(criteria, result, pending);
}

// Get details from dropdown and call function to create collection
function getDetailsForCollection()
{
	FETCH_COUNTER = 0;
	IS_FECHING_DONE = false;

	// Make drop down intelligent and return Pending value task to fetch or not
	var pending = dropdownintelligence();

	// Get selection from criteria dropdown
	var criteria = getCriteria();

	// Get selection from owner's dropdown
	var owner = $('#new-owner-tasks').data("selected_item");

	// Creates nested collection
	startMakingCollection(criteria, pending);
}

/**
 * getParams() method returns a string(used as query param string) contains user
 * selected type and owners
 * 
 * @returns {String} query string
 */
function getParamsNew()
{
	var params = "?";

	// Get task type and append it to params
	var criteria = getCriteria();
	if (criteria)
		params += ("&criteria=" + criteria);

	if (criteria == "DUE")
	{
		params += ("&start_time=" + getNewDueDate("TODAY"));
		params += ("&end_time=" + getNewDueDate("TOMORROW"));
	}

	// Get owner name and append it to params
	var owner = $('#new-owner-tasks').data("selected_item");
	if (owner == 'my-pending-tasks')
	{
		params += ("&pending=" + true);
		params += ("&owner=" + CURRENT_DOMAIN_USER.id);
		return params;
	}
	if (owner == 'all-pending-tasks')
	{
		params += ("&pending=" + true);
		owner = "";
	}
	if (owner)
		params += ("&owner=" + owner);
	else if (owner == undefined)		
		params += ("&owner=" + CURRENT_DOMAIN_USER.id);	
		
	return params;
}$(function()
{
	/**
	 * Displays note modal. Also prepends the contact name to related to field
	 * of activity modal.
	 */
	$('body').on('click', '.task-add-note, .deal-add-note', function(e){
		e.preventDefault();

		// Get form id
		var formId = getTaskFormId(this);
		
		// Append note form
		var that = this;
		getTemplate('note-form', {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$("#forNoteForm", "#" + formId).html($(template_ui));	
			$(".deal-note-label").show();
			// Hide + Add note link
			$(that).hide();

		}, $("#forNoteForm", "#" + formId));
	});			
			
});

// Add related notes of task to task form modal
function showNoteOnForm(formName, notes)
{
	console.log("showNoteOnForm");	

	$.each(notes, function(index, note)
	{
		getTemplate('notes-for-task', note, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$("#notes", "#" + formName).append($(template_ui));
		}, null);

		
	});
}

/**
 * Reads the note values from the elements having class "notes" and maps them as
 * a json object to return.
 * 
 * @method get_notes
 * @param {String}
 *            form_id to read notes from the form
 * @returns json object of notes
 */
function get_notes(form_id)
{
	var notes_json = $('#' + form_id + ' .notes').map(function()
	{
		var values = [];

		$.each($(this).children(), function(index, data)
		{
			values.push(($(data).attr("data")).toString())
		});
		return { "name" : $(this).attr('name'), "value" : values };
	}).get();
	
	return notes_json;
}
// Adds task to task list
function addTaskToTaskList(headingToSearch, tasksToAdd, conditionToCheck)
{
	console.log("In addTaskToTaskList");

	var modelTaskList;

	// Get task list on basis of heading and id in case of owner criteria
	if (conditionToCheck == "OWNER") // new task
	{
		modelTaskList = getTaskList("OWNER", tasksToAdd.taskOwner.name, tasksToAdd.taskOwner.id);

		// Remove Loading Icon from task list
		$('.task-list-loading-img-' + tasksToAdd.taskOwner.name + "-" + tasksToAdd.taskOwner.id, ".task-trello-list").hide();
	}
	else if ((conditionToCheck == "dragged" || conditionToCheck == true) && headingToSearch == "taskOwner.name")
	// dragged/edited task
	{
		modelTaskList = getTaskList("OWNER", tasksToAdd.get("taskOwner").name, tasksToAdd.get("taskOwner").id);

		// Remove Loading Icon from task list
		$('.task-list-loading-img-' + tasksToAdd.get("taskOwner").name + "-" + tasksToAdd.get("taskOwner").id, ".task-trello-list").hide();
	}
	else
	// task other than owner criteria
	{
		modelTaskList = getTaskList(null, headingToSearch, null);

		// Remove Loading Icon from task list
		$('.task-list-loading-img-' + headingToSearch + "-", ".task-trello-list").hide();
	}

	if (!modelTaskList)
		return;

	// Copy cursor for infi-scroll
	tasksToAdd = setCursor(modelTaskList[0], tasksToAdd, conditionToCheck);

	// Add task in sub collection means in Task List
	if (conditionToCheck == "dragged") // if dragged task then do not update UI
		modelTaskList[0].get('taskCollection').add(tasksToAdd.toJSON(), { silent : true });// sub-collection
	else
	{
		modelTaskList[0].get('taskCollection').add(tasksToAdd);// sub-collection

		// change task count in header of task list
		changeTaskCount(modelTaskList[0].toJSON(), true);
	}

	// Maintain changes in UI
	displaySettings();
}

// Delete Task
function deleteTask(taskId, taskListId, taskListOwnerId)
{
	var modelTaskList;

	// Get Task list
	if (taskListOwnerId)
		modelTaskList = getTaskList("OWNER", taskListId, taskListOwnerId);
	else
		modelTaskList = getTaskList(null, taskListId, null);

	if (!modelTaskList)
		return;

	// Call method with task id to be deleted.
	var new_task = modelTaskList[0].get('taskCollection').get(taskId);
	new_task.url = '/core/api/tasks/' + taskId;
	new_task.destroy({ success : function(model, response)
	{
		// Creates normal time.
		displayTimeAgo($(".task-trello-list"));

		// change task count in header of task list
		changeTaskCount(modelTaskList[0].toJSON(), false);
		
		getDueTasksCount(function(count){
			var due_task_count= count;
			if(due_task_count==0)
				$(".navbar_due_tasks").css("display", "none");
			else
				$(".navbar_due_tasks").css("display", "inline-block");
			if(due_task_count !=0)
				$('#due_tasks_count').html(due_task_count);
			else
				$('#due_tasks_count').html("");

		});
		
	} });
}

/*
 * Compare counter with length of criteria array and call function to Fetch
 * tasks from DB for next task list if available.
 */
function fetchForNextTaskList()
{
	// is All task list are done?
	if (IS_FECHING_DONE)
		return;

	var criteria = getCriteria();
	var criteriaArray = GROUPING_MAP[criteria].type;

	// Some task list are pending
	if (FETCH_COUNTER < criteriaArray.length)
	{
		// call fetch for next task list.
		taskFetch(FETCH_COUNTER);
	}

	// All task list are done.
	if (FETCH_COUNTER >= criteriaArray.length)
		IS_FECHING_DONE = true;
}
function addDetailsInCookie(elmnt)
{
	console.log("In addDetailsInCookie");
	console.log($(elmnt));

	var name = $(elmnt).html();
	var id = $(elmnt).attr("href");

	var taskField = null;
	var taskFieldValue = null;
	var taskFieldForGroupView = null;
	var taskFieldValueForGroupView = null;

	if ($(elmnt).closest("ul").attr('id') == "new-type-tasks")
	   {
		taskField = "task_criteria";
		taskFieldForGroupView = "task_criteria_forgroupview";
	   }	
	else if ($(elmnt).closest("ul").attr('id') == "new-owner-tasks")
	   {
		taskField = "task_owner";
		taskFieldForGroupView = "task_owner_forgroupview";
	   }		
	
	taskFieldValue = name + "_" + id;
	taskFieldValueForGroupView = name + "_" + id;

	// Creates the cookie
	createCookie(taskField, taskFieldValue);
	
	// Save setting for group view	
	if(getCriteria() != "LIST")
		{
		 // Creates the cookie
		 createCookie(taskFieldForGroupView, taskFieldValueForGroupView);
		}	
}

function readDetailsFromCookie()
{
	console.log("In readDetailsFromCookie");

	var task_criteria = readCookie("task_criteria");
	var task_owner = readCookie("task_owner");

	console.log(task_criteria + " " + task_owner);
	
	withoutEventChangeDropDowns(task_criteria, task_owner, undefined);	
}
/**
 * Sets tasks as sortable list.
 */
function setup_sortable_tasks()
{
	head.js(LIB_PATH + 'lib/jquery-ui.min.js', function()
	{
		$(".task-model-list").sortable(
				{
					connectWith : '.task-model-list',
					cursor : "move",
					/*containment : ".list-area-wrapper",*/
					scroll : false,
					helper : "clone",
					placeholder : "ui-sortable-placeholder",
					forcePlaceholderSize : true,					
					revert : true,

					start: function(e, ui){
				        ui.placeholder.height(ui.item.height());
				    },
					
					beforeStop : function(event, ui)
					{
						// If sender and receiver is same
						if ($(ui.helper).closest('.task-trello-list').find('.list-header').attr('attr') === $(ui.placeholder).closest('.task-trello-list').find('.list-header').attr(
								'attr'))
						{
							// If criteria is owner
							if ($(ui.helper).closest('.task-trello-list').find('.list-header').attr('ownerID'))
							{
								// If sender and receiver is same owner
								if ($(ui.helper).closest('.task-trello-list').find('.list-header').attr('ownerID') === $(ui.placeholder).closest('.task-trello-list').find(
										'.list-header').attr('ownerID'))
									return false;
								// $(this).sortable('cancel');
							}
							else
								return false;
							// $(this).sortable('cancel');
						}
					},

					// When task is dragged to adjust the horizontal scroll
					change : function(event, ui)
					{						
						var width = $('.list-area-wrapper > div').width();
						var scrollX = $('.list-area-wrapper > div').scrollLeft();

						if (event.pageX > (width * 0.9)) // right 90%
							$('.list-area-wrapper > div').scrollLeft(scrollX + 100);
						else if (event.pageX < (width * 0.2)) // left 10%
							$('.list-area-wrapper > div').scrollLeft(scrollX - 105);

					},
					// When task is dropped its criteria is changed
					update : function(event, ui)
					{
						// Same task list
						if (ui.sender == null)
							return;

						// Make UI and DB changes after task dropped.
						changeAfterDrop(event, ui);

					} }).disableSelection();
	});
}

// Make changes after task dropped to other task list
function changeAfterDrop(event, ui)
{
	var item = ui.item[0];
	var sender = ui.sender[0];

	// Get heading of task list
	var oldTaskListId = getTaskListId(sender);
	var newTaskListId = getTaskListId(item);

	var oldTaskListOwnerId = getTaskListOwnerId(sender);
	var newTaskListOwnerId = getTaskListOwnerId(item);

	// Get selected criteria
	var criteria = getCriteria();

	var getUpdatedUI = false;

	// If criteria is owner and task is dragged to other task list
	if (criteria == "OWNER" && oldTaskListOwnerId != newTaskListOwnerId)
		getUpdatedUI = true;
	else if (oldTaskListId != newTaskListId) // Checks current task list is
		// different from previous
		getUpdatedUI = true;

	if (getUpdatedUI)
	{
		// Gets search key from map so we can change that field in task as per
		// new task list.
		var fieldToChange = GROUPING_MAP[criteria].searchKey;

		// Get task id
		var taskId = $(item).find('.listed-task').attr('id');

		// Get old task list
		var modelOldTaskList = getTaskList(criteria, oldTaskListId, oldTaskListOwnerId);

		// Gets task from old sub collection (task list) to var type json
		var oldTask = modelOldTaskList[0].get('taskCollection').get(taskId).toJSON();

		// Make updation in task and save in DB as well as collection
		updateDraggedTask(oldTask, criteria, oldTaskListOwnerId, oldTaskListId, newTaskListId, newTaskListOwnerId, taskId, fieldToChange);

		// Change count of old task list.
		changeTaskCount(modelOldTaskList[0].toJSON(), false);
	}
}

// Make updation in task and save in DB as well as collection
function updateDraggedTask(oldTask, criteria, oldTaskListOwnerId, oldTaskListId, newTaskListId, newTaskListOwnerId, taskId, fieldToChange)
{
	// Changes field of task
	if (fieldToChange == "due")
	{
		// Criteria is due
		if (oldTask.taskOwner)
			oldTask.owner_id = oldTask.taskOwner.id;
		oldTask["due"] = getNewDueDateBasedOnTime(newTaskListId,oldTask['due']);
	}
	else if (fieldToChange == "taskOwner.name")
	{
		// Criteria is owner
		oldTask.owner_id = newTaskListOwnerId;
		oldTask["taskListOwnerId"] = oldTaskListOwnerId;
	}
	else
	{
		if (oldTask.taskOwner)
			oldTask.owner_id = oldTask.taskOwner.id;
		oldTask[fieldToChange] = newTaskListId;

		// Criteria is status
		if (fieldToChange == "status")
		{
			// send new status
			oldTask.progress = getProgressValue(newTaskListId);

			if (newTaskListId == "COMPLETED")
				oldTask.is_complete = true;
			else
				oldTask.is_complete = false;
		}
	}

	// To change task list in collection we need old task list id.
	oldTask["taskListId"] = oldTaskListId;

	// Replace contacts object with contact ids
	var contacts = [];
	$.each(oldTask.contacts, function(index, contact)
	{
		contacts.push(contact.id);
	});

	// Replace notes object with note ids
	var notes = [];
	$.each(oldTask.notes, function(index, note)
	{
		notes.push(note.id);
	});

	oldTask.contacts = contacts;
	oldTask.notes = notes;
	oldTask.due = new Date(oldTask.due).getTime();

	// Save task after dropped to new task list
	saveAfterDrop(oldTask, criteria, newTaskListId, newTaskListOwnerId, taskId);
}

// Save task after dropped to new task list
function saveAfterDrop(oldTask, criteria, newTaskListId, newTaskListOwnerId, taskId)
{
	// Save task in DB
	var newTask = new Backbone.Model();
	newTask.url = 'core/api/tasks';
	newTask.save(oldTask, { success : function(data)
	{
		// Will add new task to dropped task list and remove task from dragged
		// task list.
		updateTask("dragged", data, oldTask);

		// Update task in UI
		if (criteria == "OWNER")
			$(".list-header[ownerID=" + newTaskListOwnerId + "]").parent().find("#" + taskId).parent().html(getTemplate('task-model', data.toJSON()));
		else
			$("#" + newTaskListId).find("#" + taskId).parent().html(getTemplate('task-model', data.toJSON()));

		// Maintain changes in UI
		displaySettings();

		// Get new task list
		var modelNewTaskList = getTaskList(criteria, newTaskListId, newTaskListOwnerId);

		// Change count of new task list.
		changeTaskCount(modelNewTaskList[0].toJSON(), true);
		getDueTasksCount(function(count){
			var due_task_count= count;
			if(due_task_count==0)
				$(".navbar_due_tasks").css("display", "none");
			else
				$(".navbar_due_tasks").css("display", "block");
			if(due_task_count !=0)
				$('#due_tasks_count').html(due_task_count);
			else
				$('#due_tasks_count').html("");

		});
		
	} });
}
function initialize_infinite_scrollbar(element_id, targetCollection)
{
	console.log("initialize_infinite_scrollbar");

	if (element_id == undefined || element_id == null)
	{
		console.log("no elmnt");
		return;
	}

	targetCollection.infiniScroll = new Backbone.InfiniScroll(targetCollection.collection, {
		target : element_id,
		untilAttr : 'cursor',
		param : 'cursor',
		strict : false,
		pageSize : targetCollection.page_size,
		success : function(colleciton, response)
		{
			console.log('in success');

			if (!colleciton.last().get("cursor"))
			{
				this.strict = true;
				targetCollection.infiniScroll.disableFetch();
			}

			// Maintain changes in UI
			displaySettings();

			// Remove loading icon
			$(targetCollection.infiniScroll.options.target.nextElementSibling).html('');
		},
		onFetch : function()
		{
			console.log('in fetch');

			// Add loading icon
			$(targetCollection.infiniScroll.options.target.nextElementSibling).html(
					'<div class="scroll-loading"> <img src="/img/ajax-loader.gif" style="margin-left: 44%;"> </div>');
		} });
}

/*
 * Copy cursor of last task in targeted task list to new task because newly
 * added task will go to end of collection and we lost cursor, cursor is
 * important for infi-scroll
 */
function setCursor(targetTaskListModel, newTaskToAdd, conditionToCheck)
{
	console.log("In setCursor");

	if (!targetTaskListModel.get('taskCollection') || targetTaskListModel.get('taskCollection').length == 0)
		return newTaskToAdd;

	var len = targetTaskListModel.get('taskCollection').length;
	var crsr = targetTaskListModel.get('taskCollection').at(len - 1).get("cursor");

	if (crsr)
	{
		if (conditionToCheck == "dragged" || conditionToCheck == true)
		{
			newTaskToAdd.set({ cursor : crsr });
		}

		else if (newTaskToAdd.attributes)
		{
			newTaskToAdd.attributes.cursor = crsr;
		}
		else
			newTaskToAdd["cursor"] = crsr;
	}

	return newTaskToAdd;
}
// Shows and Fill Task Edit Modal
function editTask(taskId, taskListId, taskListOwnerId)
{
	console.log("editTask");
	var modelTaskList;

	if (taskListOwnerId)
		modelTaskList = getTaskList("OWNER", taskListId, taskListOwnerId);
	else
		modelTaskList = getTaskList(null, taskListId, null);

	if (!modelTaskList)
		return;

	var modelTask = modelTaskList[0].get('taskCollection').get(taskId);

	if (!modelTask)
		return;

	var taskJson = modelTask.toJSON();

	taskJson["taskListId"] = taskListId;
	taskJson["taskListOwnerId"] = taskListOwnerId;

	// Fill form
	deserializeForm(taskJson, $("#updateTaskForm"));
	$('.update-task-timepicker').val(fillTimePicker(taskJson.due));

	// Show modal
	$("#updateTaskModal").modal('show');
	categories.getCategoriesHtml(taskJson,function(catsHtml){
		$('#type',$("#updateTaskForm")).html(catsHtml);
		// Fills owner select element
		populateUsers("owners-list", $("#updateTaskForm"), taskJson, 'taskOwner', function(data)
		{
			$("#updateTaskForm").find("#owners-list").html(data);
			if (taskJson.taskOwner)
			{
				$("#owners-list", $("#updateTaskForm")).find('option[value=' + taskJson['taskOwner'].id + ']').attr("selected", "selected");
			}
	
			$("#owners-list", $("#updateTaskForm")).closest('div').find('.loading-img').hide();
		});
	});

	showNoteOnForm("updateTaskForm", taskJson.notes);

	// Creates normal time.
	displayTimeAgo($(".task-trello-list"));
}

// Update edited task
function updateTask(isUpdate, data, json)
{
	console.log("In updateTask");

	// Get selected criteria
	var criteria = getCriteria();

	var headingToSearch = json[GROUPING_MAP[criteria].searchKey];

	if (criteria == "DUE")
		headingToSearch = getHeadingForDueTask(json);

	// To update task with criteria owner, it will skip if of changeTaskList()
	// and will continue to update task
	if (criteria == "OWNER" && parseInt(json.taskListOwnerId) == data.get("taskOwner").id)
		headingToSearch = json.taskListId;

	// Task list change
	if (json.taskListId != undefined)
		if (headingToSearch != json.taskListId) // Not belongs to same task list
		{
			// Change task's list
			changeTaskList(data, json, criteria, headingToSearch, isUpdate);
			return;
		}

	// Task update(edit)
	if (isUpdate == true)
	{
		var modelTaskList;

		// Get Task List
		if (criteria == "OWNER")
			modelTaskList = getTaskList(criteria, json.taskListId, json.taskListOwnerId);
		else
			modelTaskList = getTaskList(null, headingToSearch, null);

		if (!modelTaskList)
			return;

		// Set new details in Task
		modelTaskList[0].get('taskCollection').get(json.id).set(data);

		// Update task in UI : set() won't work on task which is dragged, so need to do manually. 
		if (criteria == "OWNER")
			$(".list-header[ownerID=" + json.taskListOwnerId + "]").parent().find("#" + json.id).parent().html(getTemplate('task-model', data.toJSON()));
		else
			$("#" + headingToSearch).find("#" + json.id).parent().html(getTemplate('task-model', data.toJSON()));

		// Maintain changes in UI
		displaySettings();

		return;
	}

	// Add new task
	if (criteria == "OWNER")
		addTaskToTaskList(headingToSearch, data.toJSON(), criteria);
	else
		addTaskToTaskList(headingToSearch, data, null);
}

// Removes task from old task list and add to new task list.
function changeTaskList(data, json, criteria, headingToSearch, isUpdate)
{
	console.log("In changeTaskList");

	var modelOldTaskList;

	// Get old task list
	if (criteria == "OWNER")
	{
		var ownerId;

		if (json.taskListOwnerId)
			ownerId = parseInt(json.taskListOwnerId);
		else
			ownerId = json.taskOwner.id;

		if (!ownerId)
			return;

		modelOldTaskList = getTaskList(criteria, json.taskListId, ownerId);

		headingToSearch = "taskOwner.name";

		// Find proper column with owner id and then dlt task in UI
		$(".list-header[ownerID=" + ownerId + "]").parent().find("#" + json.id).remove();
	}
	else
	{
		modelOldTaskList = getTaskList(null, json.taskListId, null);

		// Remove task from UI
		$("#" + json.taskListId).find("#" + json.id).remove();
	}

	if (!modelOldTaskList)
		return;

	// Remove from task from old task list
	modelOldTaskList[0].get('taskCollection').remove(modelOldTaskList[0].get('taskCollection').get(json.id));

	// Add in task in new task list
	addTaskToTaskList(headingToSearch, data, isUpdate);
}

// On click of task action , makes task completed
function completeTask(taskId, taskListId, taskListOwnerId)
{
	var modelTaskList;

	// Get task list
	if (taskListOwnerId)
		modelTaskList = getTaskList("OWNER", taskListId, taskListOwnerId);
	else
		modelTaskList = getTaskList(null, taskListId, null);

	if (!modelTaskList)
		return;

	// Get task
	var modelTsk = modelTaskList[0].get('taskCollection').get(taskId);

	var taskJson = modelTsk.toJSON();

	if (taskJson.status == COMPLETED || taskJson.is_complete == true)
		return;

	// Replace contacts object with contact ids
	var contacts = [];
	$.each(taskJson.contacts, function(index, contact)
	{
		contacts.push(contact.id);
	});

	// Replace notes object with note ids
	var notes = [];
	$.each(taskJson.notes, function(index, note)
	{
		notes.push(note.id);
	});

	taskJson.contacts = contacts;
	taskJson.notes = notes;
	taskJson.is_complete = true;
	taskJson.due = new Date(taskJson.due).getTime();
	taskJson.status = COMPLETED;
	taskJson.progress = 100;
	taskJson.note_description = "";

	if (taskJson.taskOwner)
		taskJson.owner_id = taskJson.taskOwner.id;

	taskJson.taskListId = taskListId;

	if (taskListOwnerId)
		taskJson.taskListOwnerId = taskListOwnerId;

	var newTask = new Backbone.Model();
	newTask.url = 'core/api/tasks';
	newTask.save(taskJson, { success : function(data)
	{
		getDueTasksCount(function(count){
			var due_task_count= count;
			if(due_task_count==0)
				$(".navbar_due_tasks").css("display", "none");
			else
				$(".navbar_due_tasks").css("display", "block");
			if(due_task_count !=0)
				$('#due_tasks_count').html(due_task_count);
			else
				$('#due_tasks_count').html("");

		});
		
		updateTask(true, data, taskJson);

		// Maintain changes in UI
		displaySettings();
	} });
}
// Main Collection
var TASKS_LIST_COLLECTION = null;

// Grouping Map After selection from filter/ drop down
var GROUPING_MAP = { 
		"PRIORITY" : { "type" : ["HIGH", "NORMAL", "LOW"], "searchKey" : "priority_type" }, 
		"CATEGORY" : { "type" : ["CALL","EMAIL","FOLLOW_UP","MEETING", "MILESTONE","OTHER","SEND","TWEET"], "searchKey" : "type" }, 
        "STATUS" : { "type" : ["YET_TO_START", "IN_PROGRESS", "COMPLETED"], "searchKey" : "status" }, 
        "DUE" : { "type" : ["OVERDUE", "TODAY", "TOMORROW", "LATER"], "searchKey" : "due" }, 
        "OWNER" : { "type" : [], "searchKey" : "taskOwner.name" } };

// Status of Task
var YET_TO_START = "YET_TO_START";
var IN_PROGRESS = "IN_PROGRESS";
var COMPLETED = "COMPLETED";

var flag = true;

var FETCH_COUNTER = 0;
var IS_FECHING_DONE = false;

$(function()
{	
	$(document).ready(function() {
		// Adjust Height Of Task List And Scroll as per window size
	    adjustHeightOfTaskListAndScroll();
	});

	// for the window resize
	$(window).resize(function() {
		// Adjust Height Of Task List And Scroll as per window size
		adjustHeightOfTaskListAndScroll();
	});	
	
	// Display task actions
	
});
// Maintain changes in UI
function displaySettings()
{
	// Creates normal time.
	displayTimeAgo($(".task-trello-list"));

	$(".listed-task").parent().addClass("task-striped");

	// Get selected criteria
	var criteria = getCriteria();

	// Change task UI as per group selection
	if (criteria == "CATEGORY")
	{
		// Remove type of task from UI when category filter selected
		$(".new-task-type").remove();

		// Assign new setting to Owner image
		$(".new-task-owner").addClass("shift-up");

		// Assign new min height to task
		$(".task-body").addClass("task-body-category");
	}

	if (criteria == "OWNER")
	{
		// Remove owner pic of task from UI when owner filter selected
		$(".new-task-owner").remove();

		// Assign new min height to task
		$(".task-body").addClass("task-body-owner");
	}
}

// Load and display slider in update task modal of task for progress.
function loadProgressSlider(el)
{
	head.load(LIB_PATH + 'lib/jquery.slider.min.js', function()
	{
		$(".progress_slider", el).slider({ 
			from : 0, 
			to : 100, 
			step : 1, 
			skin : "round", 
			onstatechange : function(value){
				changeProgress(value, $(".status", el).val(), el);
			}
		});
	});
}

/*
 * Make changes in UI on status button and add new value to input field of
 * status in task edit modal.
 */
function changeStatus(status, parentForm)
{
	var value;

	if (status == YET_TO_START)
		value = 0;
	else if (status == COMPLETED)
		value = 100;
	else if (status == IN_PROGRESS)
		value = 1;

	changeProgress(value, status, parentForm);
}

/*
 * Make changes in UI in progress slider and add new value to input field of
 * progress in task edit modal.
 */
function changeProgress(value, status, parentForm)
{	
	// Add progress % to input field
	$("#progress", parentForm).val(value);

	// Show slider for progress
	showProgressSlider(value, status, parentForm);
}

/*
 * Make changes in UI on status selection and display progress slider in task
 * update modal.
 */
function showProgressSlider(value, status, parentForm)
{	
	if (value == 100 || status == COMPLETED){
		$(".status", parentForm).val(COMPLETED);
		$("#progress", parentForm).val(100);
		$("#is_complete", parentForm).val(true);
	}else{
		$("#is_complete", parentForm).val(false);
	}

	if (status == IN_PROGRESS){
		$(parentForm).find(".progress-slider").css("display", "block");
		if($(parentForm).find(".jslider-label-to").is(':visible'))
			$(parentForm).find(".jslider-label-to").hide();
	}else{
		$(parentForm).find(".progress-slider").css("display", "none");
	}
}

function resetForm(formToReset)
{
	$('#progress', formToReset).val(0);
	$('#is_complete', formToReset).val(false);
	$('#priority_type', formToReset).val("NORMAL");
	$('#status', formToReset).val(YET_TO_START);
	$(".progress_slider", formToReset).slider("value", 0);
}

/*
 * After loading update task modal check is_completed is true or false, is it is
 * true so change status and progress, make status completed and progress 100%.
 */
function setForm(formToSet)
{
	var isComplete = $("#is_complete", formToSet).val();

	if (isComplete == "true")
	{
		// Show slider for progress
		showProgressSlider(100, COMPLETED, formToSet);
	}
	else
	{
		// Show slider for progress
		showProgressSlider($('#progress', formToSet).val(), $('#status', formToSet).val(), formToSet);

		$(".progress_slider", formToSet).slider("value", $('#progress', formToSet).val());
	}
}

// Change Page heading as per selection of owner criteria
function changeHeadingOfPage(heading)
{
	// Change page heading
	$('#new-task-heading').html(heading + '&nbsp<small class="tasks-count"></small>');
}

/*
 * Remove Loading Icon from task list which is just loaded.
 */
function removeLoadingIcon(target)
{
	// Hide loading icon in same task list
	if (target.owner_id)
		$("img[id='task-list-loading-img-" + target.heading + "-" + target.owner_id + "']").hide();
	else
		$("img[id='task-list-loading-img-" + target.heading + "-']").hide();
}

/*
 * Display Task Count from task list in task list header.
 */
function addTaskCount(target)
{
	if (!target.taskCollection)
		return;

	var targetModel = target.taskCollection.at(0);
	
	if (!targetModel)
		return;

	var count = targetModel.get("count");

	// Display task count in header of task list.
	displayTaskCount(count, target.heading, target.owner_id);
}

// Display task count in header of task list.
function displayTaskCount(count, heading, owner_id)
{
	if (count == 0)
		count = "";

	if (owner_id)
	{
		$("span[id='task-count-" + heading + "-" + owner_id + "']").html(count);
		$("span[id='task-count-" + heading + "-" + owner_id + "']").attr("count", count);
	}

	else
	{
		$("span[id='task-count-" + heading + "-']").html(count);
		$("span[id='task-count-" + heading + "-']").attr("count", count);
	}
}

/*
 * Change Task Count from task list in task list header after drag-drop, delete
 * or add task.
 */
function changeTaskCount(target, increased)
{
	var targetModel = target.taskCollection.at(0);
	
	if (!targetModel)
		return;

	var count = null;

	// Get task count from header of task list.
	if (target.owner_id)
		count = $("span[id='task-count-" + target.heading + "-" + target.owner_id + "']").attr("count");
	else
		count = $("span[id='task-count-" + target.heading + "-']").attr("count");

	if (count != null)
	{		
		if (increased)
			count++;
		else
			count--;
	}
	else
		count = 1;

	// Display task count in header of task list.
	displayTaskCount(count, target.heading, target.owner_id);
}

// Make drop down intelligent and return Pending value task to fetch or not
function dropdownintelligence()
{
	// As per selected criteria change owner dropdown's options
	changesOnCriteria();

	// As per selected owner change criteria dropdown's options
	return changesOnOwner();
}

// As per selected criteria change owner dropdown's options
function changesOnCriteria()
{
	var criteria = getCriteria();

	if (criteria == "OWNER")
	{
		// Hide pending task selection options from dropdown
		$(".hide-on-status").show();
		// $(".hide-on-owner").hide();
	}
	else if (criteria == "STATUS")
	{
		// Hide pending task selection options from dropdown
		$(".hide-on-owner").show();
		$(".hide-on-status").hide();
	}
	else
	{
		// show pending task selection options from dropdown
		$(".hide-on-status").show();
		$(".hide-on-owner").show();
	}
}

// As per selected owner change criteria dropdown's options
function changesOnOwner()
{
	// Get selection from owner's dropdown
	var owner = $('#new-owner-tasks').data("selected_item");

	if (owner == "all-pending-tasks")
	{
		// Show owner and status
		$(".hide-on-pending").show();

		// Hide status task selection options from dropdown
		$(".hide-on-all-pending").hide();

		return true;
	}
	else if (owner == "my-pending-tasks" || owner == undefined)
	{
		// Hide owner's and status task selection options from dropdown
		$(".hide-on-pending").hide();

		changeCriteriaToCategory();

		return true;
	}
	else if (owner == CURRENT_DOMAIN_USER.id) // My task
	{
		// Show owner's and status task selection options from dropdown
		$(".hide-on-pending").show();
		$(".hide-on-my-task").hide();

		changeCriteriaToCategory();

		return false;
	}
	else
	// All task
	{
		// Show owner's and status task selection options from dropdown
		$(".hide-on-pending").show();

		return false;
	}
}

// On selection of
function changeCriteriaToCategory()
{
	var criteria = getCriteria();

	if (criteria != "OWNER")
		return;

	$("#new-type-tasks").data("selected_item", "CATEGORY");
	$("#new-type-tasks").closest(".btn-group").find(".selected_name").text("Category");
}

// Adjust Height Of Task List And Scroll as per window size
function adjustHeightOfTaskListAndScroll()
{
	var bodyheight = $(window).height();

	$("#new-task-list-based-condition").height(bodyheight - 155);
	$(".list-tasks").css('max-height', bodyheight - 245);
}

/**
 * Hide task in list view and display column view with loading img. 
 */
function hideListViewAndShowLoading()
{	
	// Hide list view and show column view
	$('#new-task-list-based-condition').show();
	$('#task-list-based-condition').hide();
	$('.tasks-count').html("");
	
	// Shows loading image untill data gets ready for displaying
	$('#new-task-list-based-condition').html(LOADING_HTML);	
}

/**
 * Display task in list view with selected filter. 
 */
function displayListView()
{
	console.log("in displayListView");
	$('#new-task-list-based-condition').hide();
	$('#task-list-based-condition').show();
	
	// Display group view
	$(".group-view").show();
	
	// Hide group by
	$(".do-onclick-nothing").hide();
	
	// Hide list view
	$(".list-view").hide();
	
	var url = getParamsNew();
	
	// When user hit list view first time and my pending is selected as default one, we have to set pending true.
	var owner = $('#new-owner-tasks').data("selected_item");
	if(owner == undefined)
		url = url  + "&pending=" + true;
	
	console.log("url for list view: "+url);	
	
	updateData(url);
}

//
function bindDropdownEvents()
{
	$('.dropdown-menu').find(".do-onclick-nothing").on("click",function(e)
	 {
	    e.stopImmediatePropagation();
	 });
	
	// Click events to agents dropdown of Owner's list and Criteria's list
	$("ul#new-owner-tasks li a,ul#new-type-tasks .new-type-task").on("click", function(e)
	{        
		e.preventDefault();			
				
		// Hide list view and show column view with loading img
		hideListViewAndShowLoading();		
		
		// Hide dropdown
		if($(".type-task-button").hasClass("open"))
			$(".type-task-button").removeClass("open");
		
		// Show selected name
		var name = $(this).html(), id = $(this).attr("href");
		
		var selectedDropDown = $(this).closest("ul").attr("id");
				
		if(selectedDropDown == "new-type-tasks") // criteria type
		    $(this).closest("ul.main-menu").data("selected_item", id);
		else  // owner type
			$(this).closest("ul").data("selected_item", id);
		
		$(this).closest(".btn-group").find(".selected_name").text(name);

		// Empty collection
		if(TASKS_LIST_COLLECTION != null)
		TASKS_LIST_COLLECTION.collection.reset();
		
		// Add selected details of dropdown in cookie
		addDetailsInCookie(this);
				
		setTimeout(function() { // Do something after 2 seconds
			// Get details from dropdown and call function to create collection
			getDetailsForCollection();
		}, 2000);
	});

	// Change page heading as per owner selection
	$("ul#new-owner-tasks li a").on("click", function()
	{		
		// Change heading of page
		changeHeadingOfPage($('#new-owner-tasks').closest(".btn-group").find(".selected_name").html());
	});	
}

// Change UI and input field 
function applyDetailsFromGroupView()
{
	console.log("In applyDetailsFromGroupView");
	
	var task_criteria_forgroupview = readCookie("task_criteria_forgroupview");
	var task_owner_forgroupview = readCookie("task_owner_forgroupview");

	console.log(task_criteria_forgroupview + " " + task_owner_forgroupview);
			
	withoutEventChangeDropDowns(task_criteria_forgroupview, task_owner_forgroupview, true);	

	// Hide group view
	$(".group-view").hide();
	
	// Display group by
	$(".do-onclick-nothing").show();
	
	// Display list view
	$(".list-view").show();
	
	var ownerType = $('#new-owner-tasks').data("selected_item");
	
	// Add owner type in cookie
	addDetailsInCookie($("ul#new-owner-tasks").find('a[href='+ownerType+']'));
	
	// Add task type in cookie
	addDetailsInCookie($("ul#new-type-tasks").find('a[href='+getCriteria()+']'));
}

//
function withoutEventChangeDropDowns(task_criteria, task_owner, apply_groupview)
{
	console.log("In withoutEventChangeDropDowns");
	console.log(task_criteria + " " + task_owner);	
	
	if (task_criteria)
	{
		var res = task_criteria.split("_");

		console.log(res);

		$('#new-type-tasks').data("selected_item", res[1]);
		$('#new-type-tasks').closest(".btn-group").find(".selected_name").text(res[0]);
	}

	if (task_owner)
	{
		var res = task_owner.split("_")

		console.log(res);

		$('#new-owner-tasks').data("selected_item", res[1]);
		$('#new-owner-tasks').closest(".btn-group").find(".selected_name").text(res[0]);
	}

	if(!task_criteria && !task_owner && apply_groupview)
	  {
		// Type of task
		$('#new-type-tasks').data("selected_item", "DUE");
		$('#new-type-tasks').closest(".btn-group").find(".selected_name").text("Due");		
	  }
	
	// Change heading of page
	changeHeadingOfPage($('#new-owner-tasks').closest(".btn-group").find(".selected_name").html());

	// Get details from dropdown and call function to create collection
	getDetailsForCollection();
}

//Add details about task list where add task btn is clicked
function addTasklListDetails(addTaskElement)
{
	console.log("In addTasklListDetails");
	console.log(addTaskElement);	
	
	if(!$(addTaskElement).hasClass("list-bottom"))
		return;	
	
	switch (getCriteria()) {
	case "STATUS":
	{ 
		$("#status", $("#taskForm")).val($(addTaskElement).attr("heading"));
		changeStatus($(addTaskElement).attr("heading"), $("#taskForm"));
	}
		break;	
	case "CATEGORY":
	{$("#type", $("#taskForm")).val($(addTaskElement).attr("heading"));}
		break;
	case "OWNER":
	{$("#owners-list", $("#taskForm")).val($(addTaskElement).attr("ownerID"));}
		break;
	case "DUE":
	{		
		var epochTime = getNewDueDate($(addTaskElement).attr("heading"));
		var startDate = getDateInFormatFromEpoc(epochTime);
		$("#taskForm").find("input.date").val(startDate).datepicker('update');		
	}
		break;		
	case "PRIORITY":
	{$("#priority_type", $("#taskForm")).val($(addTaskElement).attr("heading"));}
		break;	
	}	
}/**
 * 
 */
 var Bria_Call_Noty;
 var default_call_type;
 var callFromBria = false;
 var Bria={};
 var NamedPipe="";
 var displayName="";
 
$(function()
{
	globalBriaSetup();
	
	$('body').on('click', '.contact-make-bria-call', function(e)
	{
	  	e.preventDefault();
		var command = "Start-Call";
		var number =  $(this).attr("phone");
		var callId = "";
		
		sendMessageToBriaClient(command,number,callId);

	});
	
// }


//answer the call
	$('body').on('click', '.noty_bria_answer', function(e)
		{
			e.preventDefault();
			var command = "Answer-Call";
			var number =  "";
			var callId = $("#callId").attr("value");
			
			sendMessageToBriaClient(command,number,callId);
	  });
	  
//ignore the incoming call
	$('body').on('click', '.noty_bria_ignore', function(e)
		{
			e.preventDefault();
			var command = "Ignore-Call";
			var number =  "";
			var callId =  $("#callId").attr("value");
			
			sendMessageToBriaClient(command,number,callId);

	});


//hang up the call	
	$('body').on('click', '.noty_bria_hangup', function(e)
		{
		
		e.preventDefault();
		var command = "End-Call";
		var number =  "";
		var callId =  $("#callId").attr("value");
		
		sendMessageToBriaClient(command,number,callId);

	});


//cancel the outgoing call	
	$('body').on('click', '.noty_bria_cancel', function(e)
	{
		
		e.preventDefault();
		var command = "Cancel-Call";
		var number =  "";
		var callId =  $("#callId").attr("value");
		
		sendMessageToBriaClient(command,number,callId);
	});

	
//mute the current call	
	$('body').on('click', '.noty_bria_mute', function(e)
	{
		
		e.preventDefault();
		var command = "mute";
		var number =  "";
		var callId =  $("#callId").attr("value");
		
		$('.noty_buttons').find('.noty_bria_mute').toggle();
		$('.noty_buttons').find('.noty_bria_unmute').toggle();
		
		sendMessageToBriaClient(command,number,callId);
	});

//unmute the call	
	$('body').on('click', '.noty_bria_unmute', function(e)
	{
		
		e.preventDefault();
		var command = "unMute";
		var number =  "";
		var callId =  $("#callId").attr("value");
		
		$('.noty_buttons').find('.noty_bria_unmute').toggle();
		$('.noty_buttons').find('.noty_bria_mute').toggle();
		sendMessageToBriaClient(command,number,callId);
	});


	
//show dialpad	 ---note implemented
	$('body').on('click', '.noty_bria_dialpad', function(e)
	{
	e.preventDefault();
	e.stopPropagation();
	$('#briaDialpad_btns').toggle();
	});


//this is to close the dialpad when clicked anywhere in screen
	$(document).on('click', function(e){
		if($('#briaDialpad_btns').length !=0){
			$('#briaDialpad_btns').hide();
		}
		
		
	});	
	
// this is used to prevent dialpad from closing 	
	$('body').on('click', '#briaDialpad_btns', function(e)	{
		e.stopPropagation();
	});
	

//	This function is to hide the information shown to the client when the user is not running bria client
	$('body').on('click', '#bria_info_ok', function(e)	{
		e.preventDefault();
		$('#briaInfoModal').modal('hide');
	});
	
	
});

//function for sending DTMF
function briaSendDTMF(digit)
{
	if(digit){
			play_sound("dtmf");
			var command = "sendDTMF";
			var number =  digit;
			var callId =  "";
			sendMessageToBriaClient(command,number,callId);
			return;
	}
}


function sendMessageToBriaClient(command, number, callid){
	var domain = CURRENT_DOMAIN_USER['domain'];
	var id = CURRENT_DOMAIN_USER['id'];
	var image = new Image();
	image.onload = function(png) {
		console.log("bria sucess");
		window.focus();

	};
	image.onerror= function(png) {
		console.log("bria failure");
		if (Bria_Call_Noty != undefined)
			Bria_Call_Noty.close();
		window.focus();
		$('#briaInfoModal').modal('show');
	};
	
	image.src = "http://localhost:33333/"+ new Date().getTime() +"?command="+command+";number="+number+";callid="+callid+";domain="+domain+";userid="+id+";namedpipe="+NamedPipe+"?";
}





function globalBriaSetup()
{
	console.log('Fetching Bria initial status');
	
	$.getJSON("/core/api/widgets/Bria", function(bria_widget)
	{
		if (bria_widget == null)
			return;

		if (bria_widget.prefs != undefined)
		{
			
				bria_widget.prefs = eval("(" + bria_widget.prefs + ")");
				
				var type = bria_widget.prefs.bria_type;
				if(type == "X-Lite"){
					NamedPipe = "apixlite";
				}else if(type == "Bria4"){
					NamedPipe = "apipipe";
				}else if(type == "Bria3"){
					NamedPipe = "apipipe";
				}
				
			if (bria_widget.prefs.make_bria_default_call){
				default_call_type = "Bria";
				callFromBria = true;
				initToPubNub();
				console.log("Bria is set properly");
				showBriaCallOption();
			}else{
				if(default_call_type == "Bria"){
					default_call_type = null;
					callFromBria = false;
				}
				
			}
		}else{
			console.log("No preferences found for bria setting");
		}

		
	}).error(function(data)
			{
				console.log("Bria error");
				console.log(data);
			});
}

function showBriaCallOption(){
	
	$(".contact-call-button").removeAttr('disabled');
	$(".contact-make-call").removeAttr("href");
	$(".contact-call-button").addClass("contact-make-bria-call");
	
}


function changeTooltipTo(selector, text){
	$(selector).tooltip('hide')
	  .attr('data-original-title', text)
    .tooltip('fixTitle');

}

function _getMessage(message, callback){
	var state = message.state;
	var number = message.number;
	var callId = message.callId;
	var displayName = message.displayName;
	var message="";
	console.log("state--" + state + " number --" + number + "   callId" + callId + "  displayName" + displayName);
	
	if (state == "incoming"){
		To_Number = number;
		/*		searchForContact(To_Number, function(name){
			displayName = name;
		});*/
		
		getContactImage(number,"Incoming",function(contact_Image){
			message =contact_Image+'<span class="noty_contact_details m-l-sm inline pos-rlt" style="top: 10px;"><i class="icon icon-phone m-r-xs pos-rlt m-t-xxs"></i><b>Incoming Call &nbsp;&nbsp;&nbsp;  </b>'+'<span id="callId" class="text-xs" value ='+callId+ '>' + number +'</span>'+'<br><br></span><div class="clearfix"></div>';
			if(callback)
				callback(message);
		});
				
	}else if(state == "connected"){
		getContactImage(number,"Outgoing",function(contact_Image){
			message =contact_Image+'<span class="noty_contact_details m-l-sm inline pos-rlt" style="top: 10px;"><i class="icon icon-phone m-r-xs pos-rlt m-t-xxs"></i><b>On Call &nbsp;&nbsp;&nbsp; </b>'+'<span id="callId" class="text-xs" value ='+callId+ '>' + number + '</span>'+'<br><br></span><div class="clearfix"></div>';
			if(callback)
				callback(message);
		});
		
	
	}else if(state == "missed-call"){
		To_Number = number;
		getContactImage(number,"Incoming",function(contact_Image){		
			message =contact_Image+'<span class="noty_contact_details m-l-sm inline pos-rlt" style="top: 10px;"><i class="icon icon-phone m-r-xs pos-rlt m-t-xxs"></i><b>Missed Call &nbsp;&nbsp;&nbsp;  </b>'+ '<span id="callId" class="text-xs" value ='+callId+ '>' + number + '</span>' +'<br><br></span><div class="clearfix"></div>';
		if(callback)
			callback(message);
		});
		
	}else if(state == "connecting"){
		//var contactDetailsObj = agile_crm_get_contact();
		//displayName = getContactName(contactDetailsObj);
		
		getContactImage(number,"Outgoing",function(contact_Image){		
			message =contact_Image+'<span class="noty_contact_details m-l-sm inline pos-rlt" style="top: 10px;"><i class="icon icon-phone m-r-xs pos-rlt m-t-xxs"></i><b>Calling... &nbsp;&nbsp;&nbsp; </b>'+'<span id="callId" class="text-xs" value ='+callId+ '>' + number + '</span>' +'<br><br></span><div class="clearfix"></div>';
		if(callback)
			callback(message);
		});
		
		
		
	}else if(state == "failed"){
		getContactImage(number,"Outgoing",function(contact_Image){		
			message =contact_Image+'<span class="noty_contact_details m-l-sm inline pos-rlt" style="top: 10px;"><i class="icon icon-phone m-r-xs pos-rlt m-t-xxs"></i><b>Call Failed &nbsp;&nbsp;&nbsp; </b>'+'<span id="callId" class="text-xs" value ='+callId+ '>' + number + '</span>'+'<br><br></span><div class="clearfix"></div>';
		if(callback)
			callback(message);
		});
		
	
	}else if(state == "ended"){
		callback("");
	}

}

function getContactImage(number, type, callback){
	if(type){
		if(type == "Outgoing"){
			var currentContact = agile_crm_get_contact();
			getTemplate('contact-image', currentContact, undefined, function(image){
		 		if(!image)
		    		callback("");
		 			callback(image);
			});
			
		}else{
			
			searchForContactImg(number,function(currentContact){
				getTemplate('contact-image', currentContact, undefined, function(image){
			 		if(!image)
			    		callback("");
			 			callback(image);
				});
			});
			
		}
	}
	
}


/**
 * Global object of call campaign to maintain state, call status and contact
 * details.
 * 
 * STATE = START, DISCONNECTED,PAUSE
 * Start = you can call for auto-dial // This is initial state
 * Pause = You cant dial from campaign // this state tells not to make twilio call request  because the campaing has been paused 
 * Disconnected = Call disconnected by twilio error or no answer or failed. //This state tells twilio call has been disconnected by twilio
 * 
 *call_status = IDEAL,CALL-ENDED,CONNECTED,CONNECTING
 *Ideal = The campaign is in ideal state // twilio call function is not called
 *Connecting = The camapign is connecting the call  //The twilio call has been made 
 *Connected = The call has been connected. // call connected by twilio
 *
 *
 *To start the manual call you have to call the below methods:
 * 1)changeContactDeatilView(); // only changes the contact detail page view taking the current object from campaign
 * 2)startCall();	//It will reset the campaign variabe, get contact detail, edit container and then make campaign call
 *
 *To start the call in case of autodial 
 * 1)getContactDetails();
 * 2)editCallContainer();
 * 3)makeCampaigncall();
 * 
 * 
 */

/**
 * Initialised the campaign variable to default value.
 */

var CALL_CAMPAIGN = {};

function campaignVariableToInitialState()
{
	CALL_CAMPAIGN = { "start" : false, "state" : "START", "total_count" : 0, "current_count" : 0, "temp_count" : 0, "contact_id_list" : null, "cursor" : 0,
		"select_all" : false, "autodial" : false, "total_time" : 0, "user_timer" : 0, "current_contact" : null, "current_contact_name" : null,
		"current_contact_img" : null, "current_contact_email" : null, "current_contact_phonenumber" : null, "countdown_timer" : 0, "call_duration" : 0,
		"call_status" : "IDEAL", "contact_update" : false, "selected_number" : null, "call_from_campaign" : false, "remember_phone" : [],
		"last_clicked" : null, "tag" : null, "has_tag" : false, "callObject" : null, "timeObject" : null };

}

/**
 * start call campaign will start calling to selected contacts or to all
 * contacts if selected all is true then fetch next 25 and call them too.
 * 
 * @param id_array
 */

function startCallCampaign(id_array)
{
	try
	{
		console.log("In startCallCampaign");

		// If collection is there then proceed otherwise refresh the page
		if (!App_Contacts.contactsListView || !App_Contacts.contactsListView.collection)
			return;

		console.log("collection found");
		// step1:
		CALL_CAMPAIGN.start = true;
		// step2:
		addCallContainer();
		// step3:
		updateContactInCampaignVariable();
		// step4:

		// step5:
		startCall();
	}
	catch (err)
	{
		console.log("error-->" + err.message);
		CALL_CAMPAIGN.start = false;
		//routeToPage("contacts");
		$('#startCampaignAgain').modal('show');
	}

}

/**
 * It will stop the ongoing campaign and disconnect the current call if any.
 * 
 */
function stopCallCampaign()
{
	console.log("In stopCallCampaign");

	// step1:
	disconnectAnyTwilioCall();
	// step2:
	removeCallContainer();
	// step3:
	campaignVariableToInitialState();
	// step4:
	routeToPage("contacts");

}

function showSettingPage()
{

	// changes for new requirement
	// when SELECT_ALL is true i.e., all contacts are selected.
	campaignVariableToInitialState();
	CALL_CAMPAIGN.contact_id_list = get_contacts_bulk_ids();

	if (CALL_CAMPAIGN.contact_id_list.length === 0)
	{
		console.log("all are selected");
		// Get id of first selected all contacts
		CALL_CAMPAIGN.select_all = true;
		CALL_CAMPAIGN.contact_id_list = getIdOfContacts(App_Contacts.contactsListView.collection.toJSON());
		CALL_CAMPAIGN.total_count = getAvailableContacts();
	}
	else
	{
		console.log("some are selected");
		CALL_CAMPAIGN.total_count = CALL_CAMPAIGN.contact_id_list.length;
	}

	console.log(CALL_CAMPAIGN.contact_id_list);

	Backbone.history.loadUrl("#call-contacts");

}

/**
 * this will route the page to given url
 * 
 * @param url
 */
function routeToPage(url)
{

	if (window.location.hash.indexOf("#" + url) != -1)
	{
		Backbone.history.loadUrl("#" + url);
	}
	else
	{
		Backbone.history.navigate(url, { trigger : true });
	}
}

/**
 * This will end any connected call by twilio
 */
function disconnectAnyTwilioCall()
{
	if (Twilio.Device.status() == "busy")
	{
		Twilio.Device.disconnectAll();
	}
}

/**
 * true if more contact is remaining to call otherwise false
 */
function hasMoreContactLeftToDial()
{
	var value = CALL_CAMPAIGN.total_count - 1;
	if (CALL_CAMPAIGN.current_count >= value)
	{
		return false;
	}
	else
	{
		return true;
	}
}

function getNextContactIdSet()
{
	// fetch next 25 contacts id
	if ((CALL_CAMPAIGN.select_all == true) && (CALL_CAMPAIGN.current_count == (CALL_CAMPAIGN.contact_id_list.length - 1)))
	{
		if (CALL_CAMPAIGN.current_count == (CALL_CAMPAIGN.total_count-1))
			return;

		getNextContactsId(function(id_array)
		{
			CALL_CAMPAIGN.contact_id_list = CALL_CAMPAIGN.contact_id_list.concat(id_array);
		});

	}
}

/**
 * This will automatically dial next call otherwise return false
 */
function dialNextCallAutomatically()
{

	if (hasMoreContactLeftToDial())
	{
		pointToNextContact();
		updateContactInCampaignVariable();
		changeContactDeatilView();
		startCall();
		getNextContactIdSet();
	}
	else
	{
		console.log("Last call done");
		stopCallCampaign();
		var alertMessage = '<center><div class="alert alert-success fade in" style="z-index:10000;margin-bottom:0px;margin-right:-4px;font-size: 14px;"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">×</a><strong>Congrats!</strong> Your call campaign has been completed successfully.</div></center>';
		var timeToDisplay = 5000;
		showCampaignAlert(alertMessage, timeToDisplay);
		return;
	}
}

/**
 * This will called for manual dialing of call
 */
function dialNextCallManually()
{

	restartCalling();
	getNextContactIdSet();
}

/**
 * 
 */

function startCall()
{
	console.log("In startCall");
	console.log(CALL_CAMPAIGN.total_count);
	console.log(CALL_CAMPAIGN.current_count);
	console.log(CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count]);

	// step1 : check if campaign is already started
	if (!CALL_CAMPAIGN.start)
		return;

	// step2: reset some variable to make next call without error
	resetSomeCampaignVariable();
	// step3:
	editCallContainer();
	// step4: After 2 sec procedure will start.
	setTimeout(function()
	{
		if (CALL_CAMPAIGN.state == "START" && CALL_CAMPAIGN.autodial == true)
			makeCampaignCall();
	}, 2000);
}

/**
 * fetch the current contact and store in camaign variable
 */
function updateContactInCampaignVariable()
{
	try
	{
		CALL_CAMPAIGN.current_contact = getContact(CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count]);
		getContactDetails();
		console.log(CALL_CAMPAIGN.current_contact);
	}
	catch (err)
	{
		console.log("error" + err.message);
	}

}

/**
 * It will move the current object pointer to next contact..
 */
function pointToNextContact()
{
	// Increase current_count
	var lastClick = CALL_CAMPAIGN.last_clicked;
	if (lastClick != "CONTINUE" && lastClick != "STOP")
	{
		if (CALL_CAMPAIGN.current_count <= CALL_CAMPAIGN.total_count)
		{
			CALL_CAMPAIGN.current_count++;
		}
	}

}

/**
 * Show the alert in campaign style to the user for n seconds
 */
function showCampaignAlert(alertMessage, timeToDisplay)
{
	try
	{
		$('#call-campaign-content').show();
		$("div#call-campaign-content center:first").remove();
		$("#call-campaign-content").prepend(alertMessage);
		removeAlertAutomaticallyAfter(timeToDisplay);
	}
	catch (err)
	{
		console.log("error in showCampaignAlert" + err.message);
	}
}

/**
 * 
 * This function is actually calling the twiliocall function to make the call If
 * the device is busy it will show alert message and return If the state is
 * pause it will show the aert messae and return This will take the nunber to
 * dail and dial the call
 * 
 */
function makeCampaignCall()
{
	console.log("In makeCampaignCall");

	// Step1: check whether to make a call or not
	if (Twilio.Device.status() == "busy")
	{
		$('#alreadyOnCall').modal('show');
		return;
	}
	if (CALL_CAMPAIGN.state === "PAUSE")
	{
		$('#pleaseWait').modal('show');
		return;
	}
	// Step2: get selected phone number to call otherwise select default phone
	if ($("#call_campaign_contact_number").length)
	{
		CALL_CAMPAIGN.selected_number = $("#call_campaign_contact_number option:selected").attr("value");
		$("#call_campaign_contact_number").attr("disabled", "disabled");
	}
	// else get from contact
	else
	{
		CALL_CAMPAIGN.selected_number = getPropertyValue(CALL_CAMPAIGN.current_contact.properties, "phone");
	}

	// Step3: If selected number is present then dial
	if (CALL_CAMPAIGN.selected_number)
	{

		// step3.1:Twilio setings for outgoing call
		TWILIO_CALLTYPE = "Outgoing";
		TWILIO_DIRECTION = "outbound-dial";
		TWILIO_IS_VOICEMAIL = false;

		// step3.2:update campaign variable
		CALL_CAMPAIGN.call_from_campaign = true;
		var rampUP_Time = 0;

		// step3.3:check for 1st contact and dial without rampup time/delay for
		// autodial
		if (CALL_CAMPAIGN.autodial)
		{
			var current_id = (CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count]);
			var first_id = CALL_CAMPAIGN.contact_id_list[0];
				
			if (current_id != first_id)
			{
				// Step3.4: Initialize campaign variables
				rampUP_Time = CALL_CAMPAIGN.user_timer * 1000; // Time selected
				// by user to
				// start call
				// after n
				// seconds
				var callText = " Next call starts in ";
				CALL_CAMPAIGN.countdown_timer = CALL_CAMPAIGN.user_timer; // timer
				// variable
				// set
				// to
				// run
				// countdown
				// to
				// start
				// call

				// Step3.5: Show message when the next cal is going to start
				changeHtml("#callStartText", callText);
				changeHtml("#callStartTime", CALL_CAMPAIGN.countdown_timer);
				Tick();

				// Step3.6: show pause and resume button
				$("#pauseCallDiv").show();
				$("#campaign_resumeCall").hide();
				$("#campaign_pauseCall").show();
				$("#start").show();
			}
			// step3.7: Change the call icon from green to grey
			// $("#start").hide();
			// $("#start").css({'background':'rgb(185, 185,
			// 185)','cursor':'context-menu'});
			// $("#start").attr('id','non-start');
		}

		// step3.8: change the state to pause so that in mean time no other call
		// can be dialled from campaign
		CALL_CAMPAIGN.state = "PAUSE";
		console.log("CALL will start after -- >" + rampUP_Time + "sec.");

		// step3.9: twiliocall function is called after n sec, where n=0 for
		// manual or n otherwise
		CALL_CAMPAIGN.callObject = setTimeout(function()
		{
			CALL_CAMPAIGN.last_clicked = null; // this is to check the last
			// click variable in disconnect
			// call
			CALL_CAMPAIGN.state = "START";
			twiliocall(CALL_CAMPAIGN.selected_number, getContactName(CALL_CAMPAIGN.current_contact));
			CALL_CAMPAIGN.callObject = null;
		}, rampUP_Time);

	}

}
/**
 * Write html inside id or class.
 */
function changeHtml(select, value)
{
	$(select).html(value);
}

/**
 * For Auto dial restart calling from continue/call/resume btn only to current
 * call
 */
function restartCalling()
{
	resetSomeCampaignVariable();
	editCallContainer();
	if (CALL_CAMPAIGN.autodial == true)
	{
		makeCampaignCall();
	}
}

/**
 * Reset some variable to initial state : State variables we are not doing
 * anything with contact data here
 */
function resetSomeCampaignVariable()
{
	// Remove Dialpad
	if ($(".call_campaign_dialpad_btns").length != 0)
		$(".call_campaign_dialpad_btns").remove();

	// CALL_CAMPAIGN.call_duration : The current call duration
	CALL_CAMPAIGN.call_duration = 0;

	// CALL_CAMPAIGN.countdown_timer : Timer to start call after n seconds
	CALL_CAMPAIGN.countdown_timer = 0;

	// CALL_CAMPAIGN.selected_number : The number to dial the call
	CALL_CAMPAIGN.selected_number = null;

	// CALL_CAMPAIGN.callObject : The setTimeOut object to call twilio call
	// function
	CALL_CAMPAIGN.callObject = null;

	// CALL_CAMPAIGN.timeObject : The setTimeOut object to decrease the
	// countdown timer
	CALL_CAMPAIGN.timeObject = null;

	// CALL_CAMPAIGN.call_from_campaign : true if the call is dialled by
	// campaign otherwise manually
	CALL_CAMPAIGN.call_from_campaign = false;

	// CALL_CAMPAIGN.contact_update : true if the contact update is calle by
	// campaign otherwise false
	CALL_CAMPAIGN.contact_update = false;

	// CALL_CAMPAIGN.call_status : IDEAL if the twiliocall function is not
	// called
	CALL_CAMPAIGN.call_status = "IDEAL";
}

/** ***** Contacts function ****** */
/**
 * Returns array of ids of given contacts.
 */
function getIdOfContacts(contactsArray)
{
	console.log("In getIdOfContacts");
	console.log(contactsArray);

	var idArray = [];
	for (var i = 0; i < contactsArray.length; i++)
	{
		idArray[idArray.length] = contactsArray[i].id;
	}

	return idArray;
}

/**
 * 
 * It takes the contact id as a prarameter and return the contact object
 * 
 * @param contactId
 * @returns
 */
function getContact(contactId)
{
	console.log("In getContact");

	return App_Contacts.contactsListView.collection.where({ id : contactId })[0].toJSON();

	// var json = $.parseJSON($.ajax({ url : '/core/api/contacts/' + contactId,
	// async : false, dataType : 'json' }).responseText);

	// return json;
}

/**
 * IT will get the properties of contact. If the contact has no phone it will
 * set the campaign in pause state and autodial will not work
 */
function getContactDetails()
{
	// Contact name in normal format like "fname lname"
	To_Name = getContactName(CALL_CAMPAIGN.current_contact);

	// Contact id for twilio reference
	TWILIO_CONTACT_ID = CALL_CAMPAIGN.current_contact.id;

	CALL_CAMPAIGN.current_contact_name = To_Name;
	CALL_CAMPAIGN.current_contact_email = getPropertyValue(CALL_CAMPAIGN.current_contact.properties, "email");
	CALL_CAMPAIGN.current_contact_phonenumber = getPhoneNumbersInArray(CALL_CAMPAIGN.current_contact.properties);
}

/**
 * It will return the phone in array having more than one contact
 */
function getPhoneNumbersInArray(items)
{
	var va = [];
	var name = "phone";
	for (var i = 0, l = items.length; i < l; i++)
	{
		if (items[i].name == name)
		{
			// If phone number has value only then add to array
			if (items[i].value != "" || items[i].value != null)
				va[va.length] = items[i].value;
		}
	}
	return va;
}

/** ***** Fetching next contacts related functions ****** */
/**
 * Fetch next 25 contacts on cursor from db and append ids in contact id list of
 * call campaign.
 */
function getNextContactsId(callback)
{
	console.log("In getNextContactsId");

	var url = null;

	// Get sort key
	var sortKey = readCookie("sort_by_name");
	if (!sortKey || sortKey == null)
	{
		sortKey = '-created_time';
		// Saves Sort By in cookie
		createCookie('sort_by_name', sortKey);
	}

	console.log("1. CALL_CAMPAIGN.cursor");
	console.log(CALL_CAMPAIGN.cursor);

	// First time get cursor from collection
	if (CALL_CAMPAIGN.cursor == 0 || CALL_CAMPAIGN.cursor == undefined)
		CALL_CAMPAIGN.cursor = getCursor();

	console.log("after getcursor() CALL_CAMPAIGN.cursor");
	console.log(CALL_CAMPAIGN.cursor);

	if (!CALL_CAMPAIGN.cursor)
		return;

	// If there is a filter saved in cookie then show filter results
	if (readData('dynamic_contact_filter') && !readCookie('company_filter'))
		url = 'core/api/filters/filter/dynamic-filter?data=' + encodeURIComponent(readData('dynamic_contact_filter')) + '&cursor=' + CALL_CAMPAIGN.cursor + '&page_size=25&global_sort_key=' + sortKey;
	else if (readData('dynamic_company_filter') && readCookie('company_filter'))
		url = 'core/api/filters/filter/dynamic-filter?data=' + encodeURIComponent(readData('dynamic_company_filter')) + '&cursor=' + CALL_CAMPAIGN.cursor + '&page_size=25&global_sort_key=' + sortKey;
	else if (readCookie('contact_filter'))
		url = 'core/api/filters/query/' + readCookie('contact_filter') + '?cursor=' + CALL_CAMPAIGN.cursor + '&page_size=25&global_sort_key=' + sortKey;
	else if (readCookie('company_filter'))
		url = 'core/api/contacts/companies?cursor=' + CALL_CAMPAIGN.cursor + '&page_size=25&global_sort_key=' + sortKey;
	else
		url = '/core/api/contacts?cursor=' + CALL_CAMPAIGN.cursor + '&page_size=25&global_sort_key=' + sortKey;

	// Get next 25 contacts
	$.ajax({ url : url, dataType : 'json', success : function(nextContacts)
	{

		console.log("nextContacts");
		console.log(nextContacts);

		// update CURRENT_CURSOR for next fetch
		CALL_CAMPAIGN.cursor = nextContacts[nextContacts.length - 1].cursor;

		console.log("after contacts fetch CALL_CAMPAIGN.cursor");
		console.log(CALL_CAMPAIGN.cursor);

		// Get Id of fetched contact
		var idArray = getIdOfContacts(nextContacts);

		return callback(idArray);

	} });

}

/**
 * Get cursor from contacts collection
 * 
 * @returns
 */
function getCursor()
{
	console.log("In getCursor");
	var contactsJson = App_Contacts.contactsListView.collection.toJSON();
	return contactsJson[CALL_CAMPAIGN.current_count].cursor;
}

/**
 * It will add the container for noty to dail calls
 */
function addCallContainer()
{
	// show the div for call campaign
	$('#call-campaign-content').show();
	$('#call-campaign-content').html(getTemplate("call-campaign-start"));
	$('body').find('#wrap').addClass("call-campaign-running"); // the class is
}

/**
 * It will remove the contaner from page
 */
function removeCallContainer()
{
	try
	{
		$('#call-campaign-content').find('#callnoty-container').remove();
		$('body').find('#wrap').removeClass("call-campaign-running");
		// Remove Dialpad if there
		if ($(".call_campaign_dialpad_btns").length != 0)
			$(".call_campaign_dialpad_btns").remove();
	}
	catch (err)
	{
		console.log("error" + err.message);
	}

}

/**
 * It will automatically remove alert of campaign
 */
function removeAlertAutomaticallyAfter(time)
{
	if (CALL_CAMPAIGN.alertObject != null)
	{
		clearTimeout(CALL_CAMPAIGN.alertObject);
	}
	CALL_CAMPAIGN.alertObject = setTimeout(function hide()
	{
		$("div#call-campaign-content center:first").remove();
	}, time);
}

/**
 * This will edit the container with the current object of campaign get contact
 * method
 */
function editCallContainer()
{
	CALL_CAMPAIGN.temp_count = CALL_CAMPAIGN.current_count + 1;
	$('#call-campaign-content').find('#callnoty-container').html(getTemplate("call-campaign-body", CALL_CAMPAIGN));

	var dialpad = $(getTemplate("campaign-dialpad"), {});
	$('.campaign_noty_buttons').append(dialpad);

	lookForSelectedNumber();
}

/*
 * If contact have multiple number and so display selected number in list If
 * number is present in select box then select it. if number is present then
 * save it in select_number varables ** If the contact having many number is
 * selected to change the callin number in campaign. It wills store the number
 * to show in future : campaign variable
 */
function lookForSelectedNumber()
{
	CALL_CAMPAIGN.selected_number = null;
	CALL_CAMPAIGN.remember_phone = setSelectedPhone(CALL_CAMPAIGN.remember_phone, TWILIO_CONTACT_ID);

	if (CALL_CAMPAIGN.selected_number == null)
	{
		if ($("#call_campaign_contact_number"))
		{
			if ($("#call_campaign_contact_number > option").length > 1)
			{
				$("#call_campaign_contact_number option:selected").next().attr('selected', 'selected');
			}
		}
	}

	$("#call_campaign_contact_number").change(function()
	{
		console.log("In call_campaign_contact_number change function");
		console.log($(".noty_twilio_call"));
		CALL_CAMPAIGN.selected_number = $("#call_campaign_contact_number").val();
		CALL_CAMPAIGN.remember_phone = setValueInArray(CALL_CAMPAIGN.remember_phone, TWILIO_CONTACT_ID, CALL_CAMPAIGN.selected_number);
	});

}

/**
 * IT will show the countdown time to start the call
 */
function Tick()
{
	if (CALL_CAMPAIGN.countdown_timer <= 0)
	{
		$("#callStartText").html("");
		$("#callStartTime").html("");
		return;
	}

	CALL_CAMPAIGN.countdown_timer -= 1;
	$("#callStartTime").html(CALL_CAMPAIGN.countdown_timer + '  sec');

	// Set for next sec
	CALL_CAMPAIGN.timeObject = window.setTimeout("Tick()", 1000);
}

/**
 * This will set the value in remember_phone variable if not present - for
 * manual call only
 */
function setValueInArray(arrayObject, id, value)
{
	// var obj = $.parseJSON(arrayObject);
	var obj = arrayObject;
	var flag = false;
	// check if id is present -- if present then modify the existing selected
	// number
	// if not present then push a new record
	if (obj != undefined)
	{
		$.each(obj, function(index, element)
		{
			// alert(element.timeStamp);
			if (element.id == id)
			{
				flag = true;
				element.number = value;
			}
		});
	}
	else
	{
		obj = [];
	}
	if (!flag)
	{
		obj.push({ "id" : id, "number" : value });
	}
	return obj;
}

// function to select the number in select box if phone number is present -- for
// manual call only
// set the number in selected number variable if the number is present
function setSelectedPhone(arrayObject, id)
{
	// var obj = $.parseJSON(arrayObject );
	var obj = arrayObject;
	if (obj != undefined)
	{
		$.each(obj, function(index, element)
		{
			// alert(element.timeStamp);
			if (element.id == id)
			{
				if ($("#call_campaign_contact_number").find('option[value="' + element.number + '"]'))
				{
					$("#call_campaign_contact_number").find('option[value="' + element.number + '"]').prop('selected', true);
					CALL_CAMPAIGN.selected_number = element.number;
				}
				else
				{
					obj.splice(index, 1);
				}
			}
		});
	}

	return obj;
}

/**
 * It will change the contact detail view pointed by the current_count pointer
 */
function changeContactDeatilView()
{
	var id = (CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count]);
	Backbone.history.navigate("contact/" + id, { trigger : true });
}

/**
 * changes the timer value to 00:00:00 format
 */
function secToColonFormat(time)
{
	var friendlyTime = null;
	var min = 0;
	var hours = 0;
	var sec = 0;
	if (time >= 3600)
	{
		hours = Math.floor(time / 3600);
		time = time - hours * 3600;
		if (hours < 10)
		{
			hours = "0" + hours;
		}
		friendlyTime = hours;
	}

	if (time >= 60)
	{
		min = Math.floor(time / 60);
		time = time - min * 60;
	}
	if (min < 10)
	{
		min = "0" + min;
	}
	if (friendlyTime != null)
	{
		friendlyTime += ":" + min;
	}
	else
	{
		friendlyTime = min;
	}

	sec = time;
	if (sec < 10)
	{
		sec = "0" + sec;
	}

	if (friendlyTime != null)
	{
		friendlyTime += ":" + sec;
	}
	else
	{
		friendlyTime = "00:" + sec;
	}

	return friendlyTime;
}

/**
 * provided time it will change it to 0sec format
 * 
 * @param time
 * @returns {String}
 */
function SecondsToCampaignTime(time)
{
	if (time == 0)
		return "0 sec";
	var hours = Math.floor(time / 3600);
	if (hours > 0)
		time = time - hours * 60 * 60;
	var minutes = Math.floor(time / 60);
	var seconds = time - minutes * 60;
	var friendlyTime = "";
	if (hours == 1)
		friendlyTime = hours + " hour";
	if (hours > 1)
		friendlyTime = hours + " hour";
	if (minutes > 0)
		friendlyTime += minutes + " min";
	if (seconds > 0)
		friendlyTime += seconds + " sec";
	if (friendlyTime != "")
		return friendlyTime;
}

/**
 * This method is remaining for future
 */
function holdCurrentCall()
{
	var widgetDetails = twilioGetWidgetDetails();
	var widgetPrefs = $.parseJSON(widgetDetails.prefs);
	var acc_sid = widgetPrefs.twilio_acc_sid;
	var auth_token = widgetPrefs.twilio_auth_token;
	var url = "/core/api/widgets/twilio/holdtone/" + acc_sid + "/" + auth_token + "/" + globalconnection.parameters.CallSid;
	// rest is to be implemented later.

}

/**
 * After the call is success the function should be called to save tag for
 * particular contact
 */
function saveTagForCampaign()
{
	console.log("inside saveTagForCampaign --->");
	if (CALL_CAMPAIGN.has_tag)
	{
		var tag = CALL_CAMPAIGN.tag;
		var json = CALL_CAMPAIGN.current_contact;
		json.tagsWithTime.push({ "tag" : tag.toString() });
		var contact = new Backbone.Model();
		contact.url = 'core/api/contacts';
		contact.save(json, { success : function(data)
		{
			addTagToTimelineDynamically(tag, data.get("tagsWithTime"));
			tagsCollection.add(new BaseModel({ "tag" : tag }));
		}

		});
		console.log("Tag added to campaign call");
	}

}

/**
 * Update the total time by campaign
 * 
 * @param timeToAdd
 */
function updateTotalTime(timeToAdd)
{
	CALL_CAMPAIGN.total_time = CALL_CAMPAIGN.total_time + parseInt(timeToAdd);
	$("#totalTime").html('(' + SecondsToCampaignTime(CALL_CAMPAIGN.total_time) + ')');
}
$(function(){
	
	
// This method is called when the add-note modal is closed .....
//This will check if the campaign is started and need to dial the next call....
	$('#noteModal').on('hidden.bs.modal', function (e) {
		console.log(CALL_CAMPAIGN.start +"  closeTwilioNoty "+CALL_CAMPAIGN.call_from_campaign);
			
			// If call campaign then update call noty
		if(CALL_CAMPAIGN.last_clicked == "ADD-NOTE"){
				CALL_CAMPAIGN.last_clicked = null;
				return;
		}
			
		if(CALL_CAMPAIGN.start){
			if(CALL_CAMPAIGN.call_status == "DISCONNECTED"){
				  CALL_CAMPAIGN.state = "START";
				  if(CALL_CAMPAIGN.autodial){
					  dialNextCallAutomatically();
				  }else{
					  dialNextCallManually();
				  }
			}
		}	
			
	});  
	
//This method is called when the personmodal is closed....
//This will check if the campaign is started and need to dial the next call....
	$('#personModal').on('hidden.bs.modal', function (e) {
			
			
		if(CALL_CAMPAIGN.start){
			if(CALL_CAMPAIGN.call_status == "DISCONNECTED"){
				  CALL_CAMPAIGN.state = "START";
				  if(CALL_CAMPAIGN.autodial){
					  dialNextCallAutomatically();
				  }else{
					  dialNextCallManually();
				  }
			}
		}	
			
	});  

//This method is called when the user click on select box for wrapup time in call-campaign setting page....
//This will update the selected value in variable....
	$('body').on('click', '#timerValue', function(e){
			e.preventDefault();
			if(CALL_CAMPAIGN.start){return;}
			var time = $(this).attr("value");
			var timeHtml = $(this).html();
			$("#call_campaign_timer").attr("value",time);
			$("#call_campaign_timer").html(timeHtml);
			CALL_CAMPAIGN.user_timer = time;
	});
	
//This method is called when the user checks the autodial radio button in call-campaign setting page....
//This will update the selected value in variable....
	$('body').on('click', '#call_campaign_autodial', function(e)
	{
					if(CALL_CAMPAIGN.start){return;}
					var autoDial = false;
					var type = $(this).val();
					$("#wrapUpDiv").hide();
					//$("#rampTimeButton").attr("disabled","disabled");
					if(type == "autodial"){
						autoDial = true;
						$("#wrapUpDiv").show();
						//$("#rampTimeButton").removeAttr('disabled');
					}
					
					CALL_CAMPAIGN.autodial = autoDial;
	});
			
//This method is called when the user clicks on close button in call-campaign setting page.... 
//This method will take the user back to contact list page....	
	$('body').on('click', '#bulk-close-call-campaign', function(e)
	{
				e.preventDefault();
				console.log("Cancel call campaign");
				if(CALL_CAMPAIGN.callObject != null){
					clearTimeout(CALL_CAMPAIGN.callObject);
					CALL_CAMPAIGN.callObject = null;
				}
				routeToPage("contacts");

	});	
	
//This method is called when the user clicks on start-campaign button in call-campaign setting page.... 	
//This method will start the call-campaign and take the user to contact detail page....		
	$('body').on('click', '#bulk-start-call-campaign', function(e)
	{
		
		try{
					e.preventDefault();
					if(CALL_CAMPAIGN.last_clicked == "start-bulk-campaign"){
						return;
					}
					
					// Disabled the buttons and fields......
					$("#bulk-start-call-campaign").attr("disabled","disabled");
					$("#bulk-start-call-campaign").html("Loading...");
					$("#call_campaign_autodial").attr("disabled","disabled");
					$("#addTag").attr("disabled","disabled");
					$("#rampTimeButton").attr("disabled","disabled");
					
					
					//set the rampup timer value to the variable.......
					CALL_CAMPAIGN.user_timer = $("#call_campaign_timer").attr("value");
					
					
					//set the dial type value to the variable.......
					var autoDial = false;
					var type = $("input[name=call_campaign_autodial]:checked").val();
					if(type == "autodial"){
						autoDial = true;
					}
					CALL_CAMPAIGN.autodial = autoDial;
					
					
					//check and set tag................
					var tag = $("#addTag").val().trim();
					if(tag.length>0)
					{
						if (!isValidTag(tag, false) || (/^\s*$/).test(tag)) {
							console.log("not valid tag");
							$('#correctTag').modal('show');
							$("#bulk-start-call-campaign").removeAttr('disabled');
							$("#bulk-start-call-campaign").html("Start Campaign");
							$("#call_campaign_autodial").removeAttr('disabled');
							$("#addTag").removeAttr('disabled');
							$("#addTag").val("");
							if(CALL_CAMPAIGN.autodial == true){
								$("#rampTimeButton").removeAttr('disabled');
							}
							return;
						}
						CALL_CAMPAIGN.tag = tag;
						CALL_CAMPAIGN.has_tag = true;	
							
					}	
					
					
					
					// check whether the twilio widget is loaded. If loaded then move to contact detail page.
					// after timeout it is not loaded ask client to check internet connection.
					if (!Twilio_Start)
					{
						
							var waitTime=1000; // this is in milisecond
							
							CALL_CAMPAIGN.callObject = setTimeout( function wait(){
									if(Twilio_Start){
										
										CALL_CAMPAIGN.last_clicked = "start-bulk-campaign";
										var id = (CALL_CAMPAIGN.contact_id_list[0]);
										Backbone.history.navigate("contact/" + id, { trigger : true });
										//CALL_CAMPAIGN.start = true;
										CALL_CAMPAIGN.callObject = null;
										$( window ).scrollTop( 0 );
										
									}else{
										
										waitTime = waitTime+1000;
										if(waitTime < 7000){
											CALL_CAMPAIGN.callObject = setTimeout(wait,waitTime);
										}else{
											
											$("#bulk-start-call-campaign").removeAttr('disabled');
											$("#bulk-start-call-campaign").html("Start Campaign");
											$("#call_campaign_autodial").removeAttr('disabled');
											$("#addTag").removeAttr('disabled');
											if(CALL_CAMPAIGN.autodial == true){
												$("#rampTimeButton").removeAttr('disabled');
											}
											$('#hitRefreshModel').modal('show');
										}
									}
									
								}, waitTime);
					
					}else{
						CALL_CAMPAIGN.last_clicked = "start-bulk-campaign";
						var id = (CALL_CAMPAIGN.contact_id_list[0]);
						Backbone.history.navigate("contact/" + id, { trigger : true });
						//CALL_CAMPAIGN.start = true;
						$( window ).scrollTop( 0 );
					}		
		}catch(err){
			console.log("error in -start-call-campaign " + err.message);
			CALL_CAMPAIGN.last_clicked = null;
			$("#bulk-start-call-campaign").removeAttr('disabled');
			$("#bulk-start-call-campaign").html("Start Campaign");
			$("#call_campaign_autodial").removeAttr('disabled');
			$("#addTag").removeAttr('disabled');
			if(CALL_CAMPAIGN.autodial == true){
				$("#rampTimeButton").removeAttr('disabled');
			}
		}
	   });
	
//This method is called when the user clicks on startcallcampaign button in contact list page.... 	
//This method will take the user to call campaign setting page....		
	$('body').on('click', '#show-callcampaignModal', function(e)
	{
				e.preventDefault();
				console.log("In show-callcampaignModal");
				
				if (CALL_CAMPAIGN.start)
				{
					var alertMessage = '<center><div class="alert alert-danger fade in" style="z-index:10000;margin-bottom:0px;margin-right:-4px;font-size: 14px;"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">×</a><strong>Alert!</strong> Call campaign is already running.</div></center>';
					var timeToDisplay = 10000;
					showCampaignAlert(alertMessage,timeToDisplay);
					return;
				}
			
				// twilio check
				if (!Twilio_Start)
				{
					//-----------
					$.getJSON("/core/api/widgets/TwilioIO", function(twilioio_widget)
							{
								if (twilioio_widget == null){
									$('#twilioStateModal').modal('show');
									return;
								}	
								console.log("twilioio_widget");
								showSettingPage();
							}).error(function(data)
							{
								console.log("twilioio_widget error");
								console.log(data);
								return;
							});
					return;
					
				}else{
					showSettingPage();
				}
				
	});
			

//This method is called when the user clicks on mute button in campaign.... 	
//This method will mute the call and change the mute icon....	
	$('body').on('click', '#pause', function(e)
	{
				e.preventDefault();
				console.log("Twilio mute from noty");
				
					//CALL_CAMPAIGN.last_clicked = "PAUSE";
					//CALL_CAMPAIGN.state = "PAUSE";
					
					$("#pauseDiv").hide();
					$("#resumeDiv").show();
					if(globalconnection){
						globalconnection.mute(true);
					}
					
	});
	
//This method is called when the user clicks on unmute button in campaign.... 	
//This method will unmute the call and change the unmute icon....		
	$('body').on('click', '#resume', function(e)
			{
				e.preventDefault();
				console.log("Twilio unmute from noty");
				
					//CALL_CAMPAIGN.last_clicked = "RESUME";
					//CALL_CAMPAIGN.state = "RESUME";
					
					$("#resumeDiv").hide();
					$("#pauseDiv").show();
					if(globalconnection){
						globalconnection.mute(false);
					}
			});
	
//This method is called when the user clicks on exit button in campaign.... 	
//This method will show the alert to user confirming to exit from the campaign....		
	$('body').on('click', '#stop', function(e)
			{
				e.preventDefault();
				console.log("Twilio call noty_twilio_stop from noty");
				
				CALL_CAMPAIGN.last_clicked = "STOP";
				$('#exitCampaignModal').modal('show');
				//holdCurrentCall();
			});
	
//This method is called when the user clicks on hangup button in campaign.... 	
//This method will end the current call and dial next call in case of autodial....	
	$('body').on('click', '#hangup', function(e)
	{
				e.preventDefault();
				console.log("Twilio call hang up from noty");
				CALL_CAMPAIGN.last_clicked = "HANGUP";
				
				if(CALL_CAMPAIGN.call_status == "DISCONNECTED"  && (($("#noteModal").data('bs.modal') || {}).isShown != true)){
					CALL_CAMPAIGN.state = "START";
					
						  if(CALL_CAMPAIGN.autodial){
							  dialNextCallAutomatically();
						  }else{
							  dialNextCallManually();
						  }
					
				}
				
				Twilio.Device.disconnectAll();
				

				
				//if the call campaign is started then we try to make a next call from campaign
				// After 24hrs check where call is connected or not 
/*							if(CALL_CAMPAIGN.start && CALL_CAMPAIGN.call_from_campaign)
							  {
								// if state is pause i.e callresp.status != completed then make another call
								// if state is pause i.e callresp.status = completed then hidden function will make the call 
									if(CALL_CAMPAIGN.state == "DISCONNECTED"  && (($("#noteModal").data('bs.modal') || {}).isShown != true)){
										CALL_CAMPAIGN.state = "START";
										
											  if(CALL_CAMPAIGN.autodial){
												  dialNextCallAutomatically();
											  }else{
												  dialNextCallManually();
											  }
										
									}
								
										// Next contact call
									  
							  }*/
	});
	
//This method is called when the user clicks on start button in campaign.... 	
//This method will start the call in case of manual dailing....		
	$('body').on('click', '#start', function(e)	
	{
					e.preventDefault();
					console.log("Twilio call noty_twilio_call from noty");

					if(CALL_CAMPAIGN.autodial){
						if(CALL_CAMPAIGN.callObject != null){
							clearTimeout(CALL_CAMPAIGN.callObject);
							CALL_CAMPAIGN.callObject = null;
						}
						if(CALL_CAMPAIGN.timeObject != null){
							clearTimeout(CALL_CAMPAIGN.timeObject);
							CALL_CAMPAIGN.timeObject = null;
						}
							CALL_CAMPAIGN.state = "START";
							CALL_CAMPAIGN.last_clicked = null; // this is to check the last
							CALL_CAMPAIGN.countdown_timer = 0;
							twiliocall(CALL_CAMPAIGN.selected_number, getContactName(CALL_CAMPAIGN.current_contact));
						
					}else{
						if(CALL_CAMPAIGN.callObject != null){
							return;
						}
						makeCampaignCall();
					}
					

	});
	
//This method is called when the user .......... 	
//This method will .......		
			
	$('body').on('click', '#noty-show-note', function(e)
	{	
				e.preventDefault();
				console.log("Twilio call noty-show-note from noty");
				CALL_CAMPAIGN.last_clicked = "ADD-NOTE";
				// Show add note modal with current contact from call
				// noty
				var el = $("#noteForm");
				$('.tags', el)
						.html(
								'<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="' + CALL_CAMPAIGN.current_contact.id + '">' + CALL_CAMPAIGN.current_contact_name + '</li>');
				$("#noteForm").find("#description").focus();
				$('#noteModal').modal('show');
				agile_type_ahead("note_related_to", el, contacts_typeahead);
	});
	
	
//This method is called when the user clicks on next button in campaign in case of manual dialing.... 	
//This method will show the modal to confirm in case of ongoing call otherwise take to next contact....		
	$('body').on('click', '.noty_twilio_next', function(e)	
	{
				e.preventDefault();
				
				if(CALL_CAMPAIGN.call_status != "IDEAL"){
					$('#campaignNextModal').modal('show');
					
				}else{
					
					console.log("Twilio call noty_twilio_next from noty");
					CALL_CAMPAIGN.last_clicked = "NEXT"	;
					  
					  dialNextCallAutomatically();					
				}
	});
	
//This method is called when the user clicks on skip button in campaign in case of Autodaial dialing.... 	
//This method will show the modal to confirm in case of ongoing call otherwise take to next contact....
	$('body').on('click', '.noty_twilio_skip', function(e)	
	{
			e.preventDefault();
			if(CALL_CAMPAIGN.current_contact_phonenumber.length != 0 && (Twilio.Device.status() == "busy" || CALL_CAMPAIGN.call_status == "CALLING")){
					$('#campaignSkipModal').modal('show');
				
			}else{
				console.log("Twilio call noty_twilio_skip from noty");
				if(CALL_CAMPAIGN.callObject != null){
					clearTimeout(CALL_CAMPAIGN.callObject);
					CALL_CAMPAIGN.callObject = null;
				}
				CALL_CAMPAIGN.last_clicked = "SKIP"	;
				CALL_CAMPAIGN.state = "START";
				dialNextCallAutomatically();
			}
			
	});

//This method is called when the user clicks on next button in campaign in case of manual dialing.... 	
//This method will show the modal to confirm in case of ongoing call otherwise take to previous contact....

	$('body').on('click', '.noty_twilio_previous', function(e)
	{
					e.preventDefault();
					if(CALL_CAMPAIGN.call_status != "IDEAL"){
						$('#campaignPreviousModal').modal('show');
					}else{
						console.log("Twilio call noty_twilio_previous from noty");
						CALL_CAMPAIGN.last_clicked = "PREVIOUS"	;
						CALL_CAMPAIGN.current_count = CALL_CAMPAIGN.current_count - 2;
						  dialNextCallAutomatically();
							
					}
					
	});


//This method is called when the user clicks on addphonenumber button in campaign.... 	
//This method will show the continue edit page to edit the contact....
	$('body').on('click', '.noty_add_phone', function(e)	
	{
				e.preventDefault();
				console.log("Twilio call noty_add_phone from noty");
				CALL_CAMPAIGN.last_clicked = "ADD-PHONE";
				// Add loading img till contact update
				$(".noty_new_phone").html('<img src="/img/ajax-loader.gif">');

				CALL_CAMPAIGN.contact_update = true;

				var contact = CALL_CAMPAIGN.current_contact;

				// Open current contact edit
				// Contact Edit - take him to continue-contact form
				add_custom_fields_to_form(contact, function(contact)
				{
					if (contact.type == 'COMPANY')
						deserialize_contact(contact, 'continue-company');
					else
						deserialize_contact(contact, 'continue-contact');
				//	$("#continueform").css({"pointer-events":"auto"});
					$(".noty_new_phone").html('');
				}, contact.type);
	});

//This method is called when the user clicks on dialpad button in campaign.... 	
//This method will show the dialpad which can be closed by clicking anywhere on screen....
	$('body').on('click', '#dialpad', function(e)
	{
							e.preventDefault();
							e.stopPropagation();
							console.log("Twilio call dailpad from noty");
							$('#dialpad').hide();
							$('#campaign_dialpad_btns').show();
	});


//This method is called when the user clicks on dialpad buttons to prevent it from disappear in campaign.... 	
	$('body').on('click', '#campaign_dialpad_btns', function(e)	
	{
							e.stopPropagation();
	});


//This method will close the dialpad which can be closed by clicking anywhere on screen....
	$(document).on('click', function(e)
	{
			if($('#campaign_dialpad_btns').length !=0){
				$('#campaign_dialpad_btns').hide();
				$('#dialpad').show();
			}
	});	
	

//This method is called when the user clicks on No option in exitmodal in campaign.... 	
//This method will close the shown model....				
	$('body').on('click', '#exit_campaign_no', function(e)
	{
						e.preventDefault();
						$('#exitCampaignModal').modal('hide');
						
	});


//This method is called when the user clicks on Yes option in exitmodal in campaign.... 	
//This method will close the shown model and end the campaign taking the user to contact list page....
	$('body').on('click', '#exit_campaign_yes', function(e)
	{
				e.preventDefault();
				if(CALL_CAMPAIGN.start){
					$('#exitCampaignModal').modal('hide');
					if(CALL_CAMPAIGN.callObject != null){
						clearTimeout(CALL_CAMPAIGN.callObject);
					}
				
					stopCallCampaign();
					 var alertMessage = '<center><div class="alert alert-success fade in" style="z-index:10000;margin-bottom:0px;margin-right:-4px;font-size: 14px;"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">×</a>You have successfully exited the call campaign.</div></center>'; 
					 var timeToDisplay = 10000;
					 showCampaignAlert(alertMessage,timeToDisplay) 
				}
	});


//This method is called when the user clicks on No option in previousModal in campaign.... 	
//This method will close the shown model....
	$('body').on('click', '#previous_contact_no', function(e)
	{
					e.preventDefault();
					$('#campaignPreviousModal').modal('hide');
					
	});


//This method is called when the user clicks on Yes option in previousmodal in campaign in manualmode.... 	
//This method will close the shown model and take the user to next conntact....
	$('body').on('click', '#previous_contact_yes', function(e)
	{
			e.preventDefault();
			$('#campaignPreviousModal').modal('hide');
			console.log("Twilio call noty_twilio_previous from noty");
			CALL_CAMPAIGN.last_clicked = "PREVIOUS"	;
			
			CALL_CAMPAIGN.current_count = CALL_CAMPAIGN.current_count - 2;
		
			if (CALL_CAMPAIGN.call_status == "CONNECTED" || Twilio.Device.status() == "busy" || CALL_CAMPAIGN.call_status == "CALLING"){
				Twilio.Device.disconnectAll();
			}				

		//	  dialNextCallAutomatically();

	});



//This method is called when the user clicks on No option in Nextmodal in campaign.... 	
//This method will close the shown model....	
	$('body').on('click', '#next_contact_no', function(e)
	{
				e.preventDefault();
				$('#campaignNextModal').modal('hide');
				
	});


//This method is called when the user clicks on No option for skipModel in campaign for autodial mode.... 	
//This method will close the shown model....	
	$('body').on('click', '#skip_contact_no', function(e)
	{
				e.preventDefault();
				$('#campaignSkipModal').modal('hide');
				
	});



//This method is called when the user clicks on Skip option in twiliostatemodal in campaign.... 	
//This method will close the shown model....
	$('body').on('click', '#twilio_state_skip', function(e)	
	{
				e.preventDefault();
				$('#twilioStateModal').modal('hide');
	});



//This method is called when the user clicks on Add option in twiliostatemodal in campaign.... 	
//This method will close the shown model and take the user to add-widget page....	
	$('body').on('click', '#twilio_state_add', function(e)	
	{
		e.preventDefault();
		$('#twilioStateModal').modal('hide');
		routeToPage("add-widget");
	});


//This method is called when the user clicks on Ok option in alert message in campaign.... 	
//This method will close the shown model....
	$('body').on('click', '#info_onCall_ok', function(e)
	{
				e.preventDefault();
				$('#alreadyOnCall').modal('hide');
	});



//This method is called when the user clicks on Ok option in alert message in campaign.... 	
//This method will close the shown model....	
	$('body').on('click', '#info_wait_ok', function(e)
	{
				e.preventDefault();
				$('#pleaseWait').modal('hide');
	});


//This method is called when the user clicks on Ok option in alert message for tagmodal in campaign.... 	
//This method will close the shown model....	
	$('body').on('click', '#info_tag_ok', function(e)
	{
		e.preventDefault();
		$('#correctTag').modal('hide');
	});

//This method is called when the user clicks on Ok option in alert message for noconnection shown at the time of startcampaign in campaign.... 	
//This method will close the shown model....		
	$('body').on('click', '#hitRefresh_ok', function(e)
	{
		e.preventDefault();
		$('#hitRefreshModel').modal('hide');
	});

//This method is called when the user clicks on Pause button in campaign.... 	
//This method will pause the call which is scheduled to start after n sec....		
	$('body').on('click', '#campaign_pauseCall', function(e)
	{
				e.preventDefault();
				console.log("Twilio pause from noty");
				CALL_CAMPAIGN.last_clicked = "PAUSE";
				$("#campaign_pauseCall").hide();
				$("#campaign_resumeCall").show();
				$("#callPauseText").show();
				$("#pauseCallDiv").tooltip('hide')
				  .attr('data-original-title', "Resume current call.")
				  .tooltip('fixTitle')
				  .tooltip('show');
				
				if(CALL_CAMPAIGN.callObject != null){
					clearTimeout(CALL_CAMPAIGN.callObject);
					CALL_CAMPAIGN.callObject = null;
				}
				if(CALL_CAMPAIGN.timeObject != null){
					clearTimeout(CALL_CAMPAIGN.timeObject);
					CALL_CAMPAIGN.timeObject = null;
				}
	});


//This method is called when the user clicks on Resume button in campaign.... 	
//This method will start the pasued call....		
	$('body').on('click', '#campaign_resumeCall', function(e)
	{
				e.preventDefault();
				console.log("Twilio resume from noty");
				CALL_CAMPAIGN.last_clicked = "RESUME";
				$("#campaign_resumeCall").hide();
				$("#campaign_pauseCall").show();
				$("#callPauseText").hide();
				$("#pauseCallDiv").tooltip('hide')
				  .attr('data-original-title', "Pause current call.")
				  .tooltip('fixTitle')
				  .tooltip('show');
				var time = CALL_CAMPAIGN.countdown_timer * 1000;
				Tick();
				CALL_CAMPAIGN.callObject = setTimeout( function(){
					CALL_CAMPAIGN.state = "START";
					CALL_CAMPAIGN.last_clicked = null;   // this is to check the last click variable in disconnect call
					twiliocall(CALL_CAMPAIGN.selected_number, getContactName(CALL_CAMPAIGN.current_contact));
				}, time);
	});


//This method is called when the user clicks Yes option in campaign in manul mode.... 	
//This method will disconnect any ongoing call and the user to next contact....		
	$('body').on('click', '#next_contact_yes', function(e)
	{
		e.preventDefault();
		$('#campaignNextModal').modal('hide');
		console.log("Twilio call noty_twilio_next from noty");
		CALL_CAMPAIGN.last_clicked = "NEXT"	;

		if (CALL_CAMPAIGN.call_status == "CONNECTED" || Twilio.Device.status() == "busy" || CALL_CAMPAIGN.call_status == "CALLING"){
			Twilio.Device.disconnectAll();
		}				

		//  dialNextCallAutomatically();

	});


//This method is called when the user clicks Yes option in skipmodel in campaign in Autodial mode.... 	
//This method will disconnect any ongoing call and the user to next contact....		
	$('body').on('click', '#skip_contact_yes', function(e)
	{
		e.preventDefault();
		$('#campaignSkipModal').modal('hide');
		console.log("Twilio call noty_twilio_skip from noty");
		CALL_CAMPAIGN.last_clicked = "SKIP"	;
		
		if(CALL_CAMPAIGN.callObject != null){
			clearTimeout(CALL_CAMPAIGN.callObject);
			//CALL_CAMPAIGN.callObject = null;
		}

		if (CALL_CAMPAIGN.call_status == "CONNECTED" || Twilio.Device.status() == "busy" || CALL_CAMPAIGN.call_status == "CALLING"){
			Twilio.Device.disconnectAll();
		}				
	//	CALL_CAMPAIGN.state = "START";
	//	dialNextCallAutomatically();

	});


	//This will hide the info shown to the user at the time of starting of campaign
	$('body').on('click', '#reStartCampaign_ok', function(e)
			{
				e.preventDefault();
				$('#startCampaignAgain').modal('hide');
			});
	
	
	window.onbeforeunload = function() {
		var message = 'You are currently running a call campaign. If you reload the page the current call campaign will be exited automatically.';
		 if(CALL_CAMPAIGN.start){
			 return message;
		 }else{
			 return;
		 }
	}
});

//end call campaign related @Thnx Prakash @ 24/9/2015
/**
 * Telephony noty functions.
 */

/**
 * Show noty popup at bottom right.
 * 
 * @param state :
 *            Event happen with SIP
 * @param type :
 *            noty type like error, default, information, warning, etc.
 * @param message :
 *            text to display eg. callee details, etc.
 * @param duration :
 *            false or sec.
 */
function showCallNotyPopup(state, type, message, duration)
{
	// return if call under notification prefs is disabled
	if (state === "incoming" || state === "missedCall")
	{
		if (notification_prefs && notification_prefs["call"] === false)
			return;
	}

	head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH + 'lib/noty/layouts/bottom.js', LIB_PATH + 'lib/noty/layouts/bottomRight.js',
			LIB_PATH + 'lib/noty/themes/default.js', LIB_PATH + 'lib/noty/packaged/jquery.noty.packaged.min.js', function()
			{
				if (state == "incoming") // confirm
					incomingCallNoty(message, type);
				else if (state == "connected") // success
					connectedCallNoty(message, type);
				else if (state == "outgoing") // confirm
					outgoingCallNoty(message, type);
				else
					showCallNoty(type, message, duration); // as per
				// requirement
			});
}

/**
 * Default noty without buttons.
 * 
 * @param type
 * @param message
 * @param duration
 */
function showCallNoty(type, message, duration)
{
	// Close event
	if (CALL != undefined)
		CALL.close();

	// Set properties
	CALL = noty({ text : message, type : type, layout : "bottomLeft", timeout : duration,
	// delay for closing event. Set false for sticky notifications
	});
}

/**
 * Incoming call noty with buttons : Answer and Ignore
 * 
 * @param message
 */
function incomingCallNoty(message, type)
{
	if (type == "Twilio")
	{
		// Close noty
		if (Twilio_Call_Noty != undefined)
			Twilio_Call_Noty.close();

		// Set properties
		Twilio_Call_Noty = noty({ text : message, type : "confirm", layout : "bottomLeft", buttons : [
				{ addClass : 'btn btn-primary noty_twilio_answer', text : 'Answer' }, { addClass : 'btn btn-danger noty_twilio_ignore', text : 'Ignore' }
		] });

		return;
	}

	// Close event
	if (CALL != undefined)
		CALL.close();

	// Set properties
	CALL = noty({ text : message, type : "confirm", layout : "bottomLeft", buttons : [
			{ addClass : 'btn btn-sm btn-primary answer', text : 'Answer' }, { addClass : 'btn btn-danger ignore', text : 'Ignore' }
	] });
}

/**
 * Connected noty displayed, After received call from callee or user with
 * Dialpad and Hangup buttons.
 * 
 * @param message
 */
function connectedCallNoty(message, type)
{
	if (type == "Twilio")
	{
		// Close noty
		if (Twilio_Call_Noty != undefined)
			Twilio_Call_Noty.close();

		// Set properties
		Twilio_Call_Noty = noty({ text : message, type : "success", layout : "bottomLeft", buttons : [
				{ addClass : 'btn btn-sm btn-default noty_twilio_mute', text : '<i class="icon-microphone"></i>' },
				{ addClass : 'btn btn-sm btn-default noty_twilio_unmute', text : '<i class="icon-microphone-off"></i>' },
				{ addClass : 'btn btn-sm btn-default noty_twilio_dialpad', text : '<i class="icon-th"></i>' }, 
				{ addClass : 'btn btn-sm btn-danger noty_twilio_hangup', text : 'Hangup' }
		] });
		
		if(TWILIO_DIRECTION == "outbound-dial") {

			accessUrlUsingAjax("core/api/voicemails", function(resp){

					var responseJson = resp;
					getTemplate("twilioio-voicemail",responseJson, undefined, function(template_ui){
						if(!template_ui)
							  return;
							
						$('.noty_buttons').prepend($(template_ui));

						// Add dialpad template in twilio content
						$('.noty_buttons').prepend(getTemplate("twilioio-dialpad"));

					}, null);
			});
		
		} else {

			// Add dialpad template in twilio content
			getTemplate("twilioio-dialpad", {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$('.noty_buttons').prepend($(template_ui));	
			}, null);
		}
		
		return;
	}

	// Close event
	if (CALL != undefined)
		CALL.close();

	// Set properties
	CALL = noty({ text : message, type : "success", layout : "bottomLeft", buttons : [
			{ addClass : 'btn dialpad noty_sip_dialpad', text : '<i class="icon-th"></i>' }, { addClass : 'btn btn-danger hangup', text : 'Hangup' }
	] });
}

/**
 * On Outgoing call, noty with cancel button shows.
 * 
 * @param message
 */
function outgoingCallNoty(message, type)
{
	if (type == "Twilio")
	{
		// Close noty
		if (Twilio_Call_Noty != undefined)
			Twilio_Call_Noty.close();

		// Set properties
		Twilio_Call_Noty = noty({ text : message, type : "confirm", layout : "bottomLeft", buttons : [
			{ addClass : 'btn btn-default btn-sm noty_twilio_cancel', text : 'Cancel' }
		] });

		return;
	}

	// Close event
	if (CALL != undefined)
		CALL.close();

	// Set properties
	CALL = noty({ text : message, type : "confirm", layout : "bottomLeft", buttons : [
		{ addClass : 'btn btn-default btn-sm hangup', text : 'Cancel' }
	] });
}

function voiceMailDropAction() { 
//	alert("clicked");
	$( "div.noty_bar" ).parent().css( "overflow", "visible" );
}

function showMissedNotyPopUp(type, message,position,notyTimeout)
{
	head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH + 'lib/noty/layouts/bottom.js', LIB_PATH
			+ 'lib/noty/themes/default.js', function(){
	var n = noty({
		text : message,
		layout : position,
		type : type,
		animation : {
			open : {
				height : 'toggle'
			},
			close : {
				height : 'toggle'
			},
			easing : 'swing',
			speed : 500
			// opening & closing animation speed
		},
		timeout : notyTimeout == undefined ? notyTimeout : (notyTimeout == "none" ? undefined : 20000), // delay for closing event. Set false for sticky
						// notifications
				
	});
			});		
}

// added by prakash for bria call notification
function showBriaCallNoty(message){
	if(message.type == "BRIA_CALL"){

		_getMessage(message, function(data) {
			
			var messageHtml = data;
			
			head.js(LIB_PATH + 'lib/noty/jquery.noty.js', LIB_PATH + 'lib/noty/layouts/bottom.js', LIB_PATH + 'lib/noty/layouts/bottomRight.js',
					LIB_PATH + 'lib/noty/themes/default.js', LIB_PATH + 'lib/noty/packaged/jquery.noty.packaged.min.js', function()
					{

				
				if (Bria_Call_Noty != undefined)
					Bria_Call_Noty.close();
				
				if(message.state == "incoming"){

					Bria_Call_Noty = noty({ text : messageHtml, type : "confirm", layout : "bottomLeft", buttons : [
			{ addClass : 'btn btn-primary noty_bria_answer', text : 'Answer'}, 
			{ addClass : 'btn btn-danger noty_bria_ignore', text : 'Ignore'}] });
					
					if (notification_prefs.notification_sound != 'no_sound')
						play_sound(notification_prefs.notification_sound);
					
				}else if(message.state == "connected"){
					
					Bria_Call_Noty = noty({ text : messageHtml, type : "success", layout : "bottomLeft", buttons : [
		    { addClass : 'btn btn-sm btn-default noty_bria_mute', text : '<i class="fa fa-microphone"></i>' },
		    { addClass : 'btn btn-sm btn-default noty_bria_unmute none', text : '<i class="fa fa-microphone-slash"></i>' },
		    { addClass : 'btn btn-sm btn-default noty_bria_dialpad', text : '<i class="icon-th text-base" style="vertical-align: middle;"></i>' }, 
					{ addClass : 'btn btn-sm btn-danger noty_bria_hangup', text : 'Hangup'}
								] });
					
					var dialpad = $(getTemplate("briaDialpad"));
					//$('.noty_buttons').prepend(dialpad);
					$('#noty_bottomLeft_layout_container').prepend(dialpad);
					
					
				}else if(message.state == "missed-call"){
					
					Bria_Call_Noty = noty({ text : messageHtml, type : "information", layout : "bottomLeft"});
				
					if (notification_prefs.notification_sound != 'no_sound')
						play_sound(notification_prefs.notification_sound);
				}else if(message.state == "connecting"){
					
					Bria_Call_Noty = noty({ text : messageHtml, type : "success", layout : "bottomLeft", buttons : [
		           { addClass : 'btn btn-danger btn-sm noty_bria_cancel', text : 'Cancel'}
					] });
					
					if (notification_prefs.notification_sound != 'no_sound')
						play_sound(notification_prefs.notification_sound);
				
				}else if(message.state == "failed"){
					
					Bria_Call_Noty = noty({ text : messageHtml, type : "error", layout : "bottomLeft"});
					
				}else if(message.state == "ended"){

					
				}
				
					});
		
		
		});


	}
}/* SIP related functions */

/**
 * SIPml initialization, stack creation and session regisration does after
 * adding sip widget / updating sip widget / re-login user.
 */
function sipStart()
{
	// After 15 sec procedure will start.
	setTimeout(function()
	{
		// after DOM ready.
		if (document.readyState === "complete")
		{
			// If sip already register.
			if (Sip_Start == true)
				return;

			// If sip not register yet.
			// Get Sip widget
			$.getJSON("/core/api/widgets/Sip", function(sip_widget)
			{
				if (sip_widget == null)
					return;

				Sip_Widget_Object = sip_widget;

				if (sip_widget.prefs != undefined)
				{
					head.js(LIB_PATH + 'lib/telephony/SIPml-api.js', function()
					{
						// SIPml.setDebugLevel("error");

						// initialize SIPML5
						if (SIPml.isInitialized()){
							// If already done.
							sipRegister();
						} 
						else{
							SIPml.init(sipRegister);
						}
							
					});
				}
			}).error(function(data)
			{
				console.log("Sip error");
				console.log(data);
			});

		}
	}, 15000); // 15 sec
}

/**
 * Create stack, to register a sip.
 */
function sipRegister()
{

	// Add audio tags in home page.
	addAudio();

	// Properties for session object.
	Config_Call = { audio_remote : document.getElementById('audio_remote'), events_listener : { events : '*', listener : sipSessionEventsListener } };

	// If sip is already started.
	if (Sip_Start == true)
		return;

	// If sip is not started yet.
	// Set flag to avoid recall.
	Sip_Start = true;

	var url = null;

	// Get widget details.
	var credentials = eval('(' + Sip_Widget_Object.prefs + ')');

	var message = null;

	try
	{
		// Check Sip Public Identity is valid.
		var o_impu = tsip_uri.prototype.Parse(credentials.sip_publicid);

		if (!o_impu || !o_impu.s_user_name || !o_impu.s_host)
		{
			Sip_Start = false;
			message = credentials.sip_publicid + " is not a valid Public identity. Please provide valid credentials.";
			showCallNotyPopup("failed", "error", message, 5000);
		}
		else
		{
			// Check websocket_proxy_url
			if (credentials.sip_wsenable == "true")
			{
				console.log(window.location.protocol);
				if (window.location.protocol != "https:")
					//url = "ws://54.83.12.176:10060/ws"; // http
					url = "ws://rtc.agilecrm.com:10060/ws"; 
				else
					url = "wss://rtc.agilecrm.com:10062/wss"; 
					//url = "wss://54.83.12.176:10062/wss"; // https
			}

			
			// Define sip stack
			Sip_Stack = new SIPml.Stack({ realm : credentials.sip_realm, impi : credentials.sip_privateid, impu : credentials.sip_publicid,
				password : credentials.sip_password, display_name : credentials.sip_username, websocket_proxy_url : url, enable_rtcweb_breaker : true,
				events_listener : { events : '*', listener : sipStackEventsListener } });

			// sip stack start
			if (Sip_Stack.start() != 0)
			{
				Sip_Start = false;
				message = 'Failed to start the SIP stack. Please provide valid credentials.';
				showCallNotyPopup("failed", "error", message, 5000);
			}
		} // else end
	}
	catch (e)
	{
		Sip_Start = false;
		message = e + " Please provide valid credentials.";
		showCallNotyPopup("failed", "error", message, 5000);
	}

}

/**
 * Register or login on sip server for session.
 */
function sipLogin()
{
	try
	{
		// LogIn (REGISTER) as soon as the stack finish starting
		Sip_Register_Session = Sip_Stack.newSession('register', { events_listener : { events : '*', listener : sipSessionEventsListener } });
		Sip_Register_Session.register();
	}
	catch (e)
	{
		Sip_Start = false;
	}
}

/**
 * sends SIP REGISTER (expires=0) to logout. Sip unregister stack and session,
 * On logout / window close / SIP details in Sip widget modified.
 */
function sipUnRegister()
{
	// Check stack available.
	if (Sip_Stack)
	{
		// shutdown all sessions
		var done = Sip_Stack.stop();

		console.log("Sip_Stack.stop() :" + done);

		// If not then recursive call.
		if (done != 0)
			sipUnRegister();
	}
}
/**
 * Onclick of number buttons in dialpad, It send dtmf tone to SIP and will play
 * sound on success.
 * 
 * @param c
 */
function sipSendDTMF(digit)
{
	//console.log("sipSendDTMF: " + digit);

	// session for call is active and number is available.
	if (Sip_Session_Call && digit)
	{
		// play sound.
		play_sound("dtmf");
		
		// send dtmf on SIP
		if (Sip_Session_Call.dtmf(digit) == 0)
		{
			// Dtmf sent.
		}
	}
}
/* SIP event listeners */

/**
 * Callback function for SIP Stack or Events Listener for sip stack
 */
function sipStackEventsListener(e /* SIPml.Stack.Event */)
{	
	//console.log(e.type);
	//console.log(e.description);

	//tsk_utils_log_info('==agile stack event = ' + e.type);

	switch (e.type) {
	case 'started':
	{
		// Register on sip.
		sipLogin();
		break;
	}
	case 'failed_to_start':
	{
		showCallNotyPopup("disconnected", 'error', "SIP: There was an error registering your account. Please modify and try again.", false);
	}
	case 'failed_to_stop':
	case 'stopping':
	case 'stopped':
	{
		// Empty all data.
		Sip_Start = false;
		Sip_Stack = null;
		Sip_Register_Session = null;
		Sip_Session_Call = null;
		User_Name = null;
		User_Number = null;
		User_Img = null;
		User_ID = null;
		SIP_Call_Noty_IMG = "";
		Show_Add_Contact = false;

		// Stop sound.		
		stopRingTone();

		break;
	}
	case 'i_new_call':
	{
		// Incoming call.
		newIncomingCall(e);
		break;
	}
	case 'starting':
	{		
		break;
	}
	case 'm_permission_requested':
	{
		break;
	}
	case 'm_permission_accepted':
	{
		break;
	}
	case 'm_permission_refused':
	{
		// Stop sound.		
		stopRingTone();

		// Display
		showCallNotyPopup("mediaDeny", 'warning', "SIP: Media stream permission denied.", false);

		// SIP hangup call.
		hangupCall();
		break;
	}
	default:
	{
		console.log("In sipStack event Listner. " + e.type);
		break;
	}
	}
};

/**
 * Callback function for SIP sessions (INVITE, REGISTER, MESSAGE...)
 */
function sipSessionEventsListener(e /* SIPml.Session.Event */)
{	
	//console.log(e.type);
	//console.log(e.description);

	//tsk_utils_log_info('==agile session event = ' + e.type);

	switch (e.type) {
	case 'connecting':
	{
		break;
	}
	case 'sent_request':
	{
		break;
	}
	case 'connected':
	{
		if (e.session == Sip_Register_Session)
		{
			// Play sound on sip register.
			play_sound();

			// Display.
			showCallNotyPopup("register", 'information', "SIP: You are now registered to make and receive calls successfully.", 5000);

			// call action and telephone icon, Make visible.
			$(".contact-make-sip-call").show();
			
			// Contact with tel: is hidden
			$(".contact-make-call").hide();		
			$(".contact-make-twilio-call").hide();
			
			// enable notifications if not already done
			if (window.webkitNotifications && window.webkitNotifications.checkPermission() != 0)
			{
				window.webkitNotifications.requestPermission();
			}
		}
		else if (e.session == Sip_Session_Call)
		{
			// Call received.
			stopRingTone();

			// Display.
			showCallNotyPopup("connected", "success", SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>On call  </b>' + User_Number +'<br><a href="#'+Contact_Link+'" style="color: inherit;">' + User_Name +  '</a><br></span><div class="clearfix"></div>', false);

			// Close html5 notification.
			if (Notify_Call)
			{
				Notify_Call.cancel();
				Notify_Call = null;
			}
		}
		break;
	} // 'connecting' | 'connected'
	case 'terminating':
	case 'terminated':
	{
		if (e.session == Sip_Register_Session)
		{
			// Session terminated.
			Sip_Start = false;
			Sip_Session_Call = null;
			Sip_Register_Session = null;
			User_Name = null;
			User_Number = null;
			User_Img = null;
			User_ID = null;
			SIP_Call_Noty_IMG = "";
			Show_Add_Contact = false;

			if (Sip_Updated == true && e.description == "Disconnecting...")
			{
				Sip_Updated = false;
				showCallNotyPopup("disconnected", 'warning', "SIP : Terminated for modifications. Registering again...", 5000);
			}
			else if (No_Internet == true && e.description == "Disconnecting...")
			{
				No_Internet = false;
				showCallNotyPopup("disconnected", 'error', "SIP : Terminated because no internet connectivity.", 5000);
			}
			else
				showCallNotyPopup("disconnected", 'error', "SIP : Terminated because " + e.description, 5000);
		}
		else if (e.session == Sip_Session_Call)
		{
			// Call terminated.
			Sip_Session_Call = null;
			stopRingTone();

			// Show state of call.
			if (e.description == "Request Cancelled")
				showCallNotyPopup("missedCall", "error", SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Missed call </b>' + User_Number +'<br><a href="#'+Contact_Link+'" style="color: inherit;">' + User_Name +  '</a><br></span><div class="clearfix"></div>', false);
			else if (e.description == "PSTN calls are forbidden")
				showCallNotyPopup("forbidden", "error", "SIP: PSTN calls are forbidden.", false);
			else if (e.description == "Not acceptable here")
				showCallNotyPopup("noresponce", "error", "SIP: Not acceptable here.", false);
			else if (e.description == "Media stream permission denied")
				showCallNotyPopup("permissiondenied", "error", "SIP: Media stream permission denied.");
			else if (e.description == "Call terminated")
				showCallNotyPopup("hangup", "information", SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Call ended with  <b>' + User_Number +'<br><a href="#'+Contact_Link+'" style="color: inherit;">' + User_Name +  '</a><br></span><div class="clearfix"></div>', false);
			else if (e.description == "Decline")
				showCallNotyPopup("decline", "error", "Call Decline.", false);
			else if (e.description == "Request Timeout")
				showCallNotyPopup("requestTimeout", "error", "SIP: Request Timeout.", false);
			else if (e.description == "Hackers Forbidden")
				showCallNotyPopup("hackersForbidden", "error", "SIP: Hackers Forbidden.", false);
			else if (e.description == "User not found")
				showCallNotyPopup("userNotFound", "error", "SIP: User not found.", false);
			else if(e.description == "Call terminating...")
			    console.log("SIP : Terminated because " + e.description);
			else if(!Is_Ignore)
				showCallNotyPopup("disconnected", 'error', "SIP : Terminated because " + e.description, 5000);

			// Show add contact modal if contact id not added
			if(Show_Add_Contact == true)
				{
				 $('#personModal').modal('show');
				 $("#personForm").find("#phone").val(User_Number);
				}			
			
			// call terminated.			
			User_Name = null;
			User_Number = null;
			User_Img = null;
			User_ID = null;
			SIP_Call_Noty_IMG = "";
			Is_Ignore = false;
			Show_Add_Contact = false;

			// Close html5 notification.
			if (Notify_Call)
			{
				Notify_Call.cancel();
				Notify_Call = null;
			}
		}
		break;
	} // 'terminating' | 'terminated'
	case 'i_ao_request':
	{
		if (e.session == Sip_Session_Call)
		{
			var iSipResponseCode = e.getSipResponseCode();
			if (iSipResponseCode == 180 || iSipResponseCode == 183)
			{
				// On outgoing call.
				startRingTone("ringbacktone");
				//console.log("Remote ringing....");
			}
		}

		break;
	}
	case 'media_added':
	{
		break;
	}
	case 'media_removed':
	{
		break;
	}
	case 'i_request':
	{
		break;
	}
	case 'o_request':
	{
		break;
	}
	case 'cancelled_request':
	{
		break;
	}
	case 'sent_request':
	{
		break;
	}
	case 'transport_error':
	{
		break;
	}
	case 'global_error':
	{
		break;
	}
	case 'message_error':
	{
		break;
	}
	case 'webrtc_error':
	{
		break;
	}

	case 'm_early_media':
	{
		// Call refused.
		stopRingTone();
		break;
	}
	case 'm_stream_audio_local_added':
	{
		break;
	}
	case 'm_stream_audio_local_removed':
	{
		break;
	}
	case 'm_stream_audio_remote_added':
	{
		break;
	}
	case 'm_stream_audio_remote_removed':
	{
		break;
	}
	case 'i_info':
	{
		break;
	}
	default:
	{
		console.log("Sip Session event Listner. " + e.type);
		break;
	}
	}
}
/**
 * On incoming call, It finds relevant contact user from added contacts with
 * same phone number.
 */
function findContact()
{	
	console.log("FindContact. " + Sip_Session_Call.getRemoteUri());

	// Get contact details on phone number
	$.getJSON("/core/api/contacts/search/phonenumber/" + removeBracesFromNumber(Sip_Session_Call.getRemoteUri()), function(caller)
	{
		console.log(caller);

		// Contact added
		if (caller != null)
		{
			// Get details to update call noty.
			//if (caller.properties[0].name == 'first_name' || caller.properties[1].name == 'last_name')
			{
				User_ID = caller.id;
				User_Name = getContactName(caller);
				User_Number = removeBracesFromNumber(Sip_Session_Call.getRemoteUri());
				User_Img = getGravatar(caller.properties, 40);
				SIP_Call_Noty_IMG = addSipContactImg();				

				// Set details if call is still active.
				if (CALL != undefined)
					CALL.setText(SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Incoming call  </b>'+ User_Number +'<br><a href="#'+Contact_Link+'" style="color: inherit;">' + User_Name +  '</a><br></span><div class="clearfix"></div>' );
			}
		}
		else
			Show_Add_Contact = true;
	}).error(function(data)
	{
		console.log("Find contact : " + data.responseText);
	});
}
/**
 * On i_new_call event of sip stack, New session is created and noty displyed.
 */
function newIncomingCall(e)
{
	// Session for call is already created.
	if (Sip_Session_Call != null)
	{
		//showNotyPopUp('information', "You are already in call.", "top", 5000);
		//alert("Already on call.");
		var newCall = e.newSession;
		newCall.setConfiguration(Config_Call);
		console.log(e);
		console.log(newCall);
		 
		showMissedNotyPopUp("warning", '<b>Missed call : </b><br>' + (newCall.getRemoteFriendlyName() || 'unknown')+' '+ removeBracesFromNumber(newCall.getRemoteUri()), "bottomRight");
		
		// do not accept the incoming call if we're already 'in call'
		e.newSession.hangup(); // comment this line for multi-line support
	}
	else
	{
		// Create new session for call.
		Sip_Session_Call = e.newSession;

		// start listening for events and set properties.
		Sip_Session_Call.setConfiguration(Config_Call);

		// Assign display name and number for noty.
		var sRemoteName = (Sip_Session_Call.getRemoteFriendlyName() || 'unknown');
		User_Name = sRemoteName;
		User_Number = removeBracesFromNumber(Sip_Session_Call.getRemoteUri());

		// Show noty
		showIncomingCall();
	}
}

// show details in noty popup for incoming call.
function showIncomingCall()
{
	// return if call under notification prefs is disabled
	if(notification_prefs && notification_prefs["call"] === false)
		return;
	
	showCallNotyPopup("incoming", "confirm", SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Incoming call </b>'+ User_Number + '<br><a href="#'+Contact_Link+'" style="color: inherit;">' + User_Name +  '</a><br></span><div class="clearfix"></div>', false);

	// Incoming call sound play.
	startRingTone("ringtone");

	// notification display permission already asked when we registered	
	show_desktop_notification("../img/plugins/sipIcon.png", "Incoming Call :", User_Name + " " + User_Number, undefined, "SipCall");
	
	// Find contact for incoming call and update display.
	findContact();
}
/**
 * Makes a call (SIP INVITE). Outgoing call.
 * 
 * @param phoneNumber
 * @returns {Boolean}
 */
function makeCall(phoneNumber)
{
	// Check Stack is available, Session is empty and phone number is available.
	if (Sip_Stack && !Sip_Session_Call && !tsk_string_is_null_or_empty(phoneNumber))
	{
		// create call session
		Sip_Session_Call = Sip_Stack.newSession('call-audio', Config_Call);

		// make call
		if (Sip_Session_Call.call(phoneNumber) != 0)
		{
			// If failed.
			Sip_Session_Call = null;
			showCallNotyPopup("failed", "error", "Failed to make call.", false);

			return false;
		}
		return true;
	}
	else if (Sip_Stack != null && Sip_Session_Call != null)
	{
		//showNotyPopUp('information', "You are already in call.", "top", 5000);
		alert("Already on call.");
		return false;
	}
	else if (!Sip_Stack)
	{
		showNotyPopUp('information', "You are not register with SIP server, Please refresh the page.", "top", 5000);
		return false;
	}
}

/**
 * terminates the call (SIP BYE or CANCEL)
 */
function hangupCall()
{
	// Call session not null.
	if (Sip_Session_Call != null)
	{
		// stop ringtone.
		stopRingTone();
		
		//console.log("Terminating the call...");
		
		// Hangup call
		Sip_Session_Call.hangup({ events_listener : { events : '*', listener : sipSessionEventsListener } });
	}

	// Close notification.
	if (Notify_Call)
	{
		Notify_Call.cancel();
		Notify_Call = null;
	}
}
/* functions related to audio */

/**
 * Add audio tag in home.jsp after SIP registration is done successfully.
 * It is required for Voice in Call. It is SIP API requirement.
 */
function addAudio() {
	var audioElmt = document.getElementById("audio_remote");

	// Already added.
	if (audioElmt != undefined)
		return;
	else if (audioElmt == undefined) // not added.
	{
		// add audio
		$('body')
				.append(
						'<!-- Sip Audios --><audio id="audio_remote" autoplay="autoplay" />');
	}
}

/**
 * On incoming call it starts. On outgoing call after remote connect it will
 * starts.
 */
function startRingTone(sound) {
	try {
		Sip_Audio = new Audio("../res/" + sound + ".mp3");
		if (typeof Sip_Audio.loop == 'boolean') {
			Sip_Audio.loop = true;
		} else {
			var onEnded = function() {
				//console.log("play");
				this.play();
			};

			Sip_Audio.addEventListener('ended', onEnded, false);
		}

		Sip_Audio.play();
	} catch (e) {
		console.log("Error Sip_Audio can not play.");
	}
}

/**
 * Incoming call: After receive / missed / ignore from user and on error it
 * stops. Outgoing call: After received / missed / ignored from callee and on
 * error it stops.
 */
function stopRingTone() {
	try {
		Sip_Audio.pause();
	} catch (e) {
		console.log("Error Sip_Audio can not stop.");
	}
}
// Sip stack.
var Sip_Stack;

// Sip register session.
var Sip_Register_Session;

// Sip call session.
var Sip_Session_Call;

/*
 * Sip call session properties. Used to create incoming call, outgoing call, and
 * sip registration. Even we need when user reject or accept call.
 */
var Config_Call;

// Sip widget.
var Sip_Widget_Object;

// User details of callee / contact user. We can not set fields in session. 
var User_Name;
var User_Img;
var User_Number;
var User_ID;
var SIP_Call_Noty_IMG = "";
var Contact_Link = "";
var Show_Add_Contact = false;

// Call is ignored
var Is_Ignore = false;

// Call noty.
var CALL;

// HTML5 notification.
var Notify_Call;

// Sip flags.
var Sip_Start = false;
var Sip_Updated = false;
var No_Internet = false;

// Audio object
var Sip_Audio;

// If user get disconnect from internet.
window.addEventListener("offline", function(e)
{	
	No_Internet = true;

	// Unregister all sessions and stop sip stack.
	sipUnRegister();
}, false);

// If user get reconnect with internet.
window.addEventListener("online", function(e)
{
	No_Internet = false;

	// Re-register on sip.
	sipStart();
}, false);

// For telephony on SIP.
$(function()
{
	// Register SIP
	sipStart();
});
/**
 * Handles events related to telephony.
 */
$(function()
{
	/**
	 * On click of dialpad button on call noty, will display/remove keypad.
	 */
	$('body').on('click', '.dialpad', function(e)
	{
		e.preventDefault();

		// If noty do not have dialpad then add
		if ($('.noty_buttons').find('.dialpad_btns').html() == null)
		{
			getTemplate('dialpad', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$(".noty_buttons").prepend($(template_ui));	
			},null);
		}
		else
		{
			// If noty has dialpad then remove
			$("#dialpad_btns").remove();
		}
	});

	/**
	 * On click of call action on contact page from list, will make SIP call to
	 * hard coded number. For Testing purpose. Call action is not visible to
	 * user.
	 */
	$('body').on('click', '.make-call', function(e)
	{
		e.preventDefault();

		// SIP
		/*
		 * if (makeCall('sip:+18004321000@proxy.ideasip.com')) { // Hard coded
		 * user details. User_Name = "Agile"; User_Number =
		 * "sip:+18004321000@proxy.ideasip.com";
		 */

		if (makeCall('sip:farah@sip2sip.info'))
		{
			User_Name = "farah";
			User_Number = "sip:farah@sip2sip.info";

			// Display
			showCallNotyPopup("outgoing", "confirm", SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Calling </b>' + User_Number +'<br><a href="#'+Contact_Link+'" style="color: inherit;">' + User_Name +  '</a><br></span><div class="clearfix"></div>', false);
		}
	});

	/**
	 * On click of telephone icon on contact page before phone number at top
	 * right panel, will make SIP call to same number.
	 */
	$('body').on('click', '.contact-make-sip-call', function(e)
	{
		e.preventDefault();

		// Get details from UI
		var userid = $(this).attr('userid');
		var phone = $(this).attr('phone');

		// Check number is available.
		if (phone == "" || phone == null)
		{
			alert(name + "'s contact number not added.");
			return;
		}

		// SIP outgoing call.
		if (makeCall(phone))
		{
			var currentContact = App_Contacts.contactDetailView.model.toJSON();
			
			// Assign details to set in noty.
			User_Name = getContactName(currentContact);
			User_Number = removeBracesFromNumber(phone);
			User_Img = getGravatar(currentContact.properties, 40);
			User_ID = currentContact.id;
			SIP_Call_Noty_IMG = addSipContactImg();
			Show_Add_Contact = false;

			// Display
			showCallNotyPopup("outgoing", "confirm", SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Calling  </b>' + User_Number +'<br><a href="#'+Contact_Link+'" style="color: inherit;">' + User_Name +  '</a><br></span><div class="clearfix"></div>', false);
		}
	});

	/**
	 * Onclick of hangup button in call noty, when call is connected.
	 */
	$('body').on('click', '.hangup', function(e)
	{
		e.preventDefault();

		// Display
		showCallNotyPopup("hangup", "information", SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Call ended with  </b>' + User_Number + '<br><a href="#'+Contact_Link+'" style="color: inherit;">' + User_Name +  '</a><br></span><div class="clearfix"></div>', false);

		// SIP hangup call.
		hangupCall();
	});

	/**
	 * On incoming call noty, on ignore button click. It will cut the call.
	 */
	$('body').on('click', '.ignore', function(e)
	{
		// Display
		showCallNotyPopup("ignored", "error", SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Ignored call  </b>'+ User_Number + '<br><a href="#'+Contact_Link+'" style="color: inherit;">' + User_Name +  '</a><br></span><div class="clearfix"></div>', 5000);

		// SIP reject call.
		Sip_Session_Call.reject(Config_Call);

		Is_Ignore = true;
		
		// Remove html5 notification.
		if (Notify_Call)
		{
			Notify_Call.cancel();
			Notify_Call = null;
		}
	});

	/**
	 * On incoming call noty, on answer button click. It will connect call.
	 */
	$('body').on('click', '.answer', function(e)
	{
		// SIP accept call.
		Sip_Session_Call.accept(Config_Call);
	});

});

//Add contact img in html for call noty text with contact url
function addSipContactImg()
{
  console.log("User_Img:");
  console.log(User_Img);
	
  Contact_Link = "";
  
  if(User_ID)
	  Contact_Link = Contact_Link+"contact/"+User_ID;
	  
  // Default img 
  var notyContactImg = '<a href="#'+Contact_Link+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+DEFAULT_GRAVATAR_url+'" style="display:inline;"></a>';
	
  // If contact have img
  if(User_Img)
     notyContactImg = '<a href="#'+Contact_Link+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+User_Img+'" style="display:inline;"></a>';
	 
  console.log("notyContactImg: "+notyContactImg);
  return notyContactImg;     
}

// Remove <> from sip number
function removeBracesFromNumber(number)
{
	console.log("number: "+number);
	if(number.match("^<") && number.match(">$"))
		number = number.substr(1, number.length-2);	
 	
	var regExp = /\:([^@]+)\@/;
	var matches = regExp.exec(number);
	
	if(matches)
    {	
	  //matches[1] contains the value between the parentheses
	  console.log(matches[1]);
	  number = matches[1];
    }
	return number;
}$(function ($) {
	
    $.fn.initial = function (options) {

        // Defining Colors
        var colors = ["#1abc9c", "#16a085", "#f1c40f", "#f39c12", "#2ecc71", "#27ae60", "#e67e22", "#d35400", "#3498db", "#2980b9", "#e74c3c", "#c0392b", "#9b59b6", "#8e44ad", "#bdc3c7", "#34495e", "#2c3e50", "#95a5a6", "#7f8c8d", "#ec87bf", "#d870ad", "#f69785", "#9ba37e", "#b49255", "#b49255", "#a94136"];

        return this.each(function () {

            var e = $(this);
            var settings = $.extend({
                // Default settings
                name: 'Name',
                charCount: 1,
                textColor: '#ffffff',
                height: 100,
                width: 100,
                fontSize: 60,
                fontWeight: 400,
                fontFamily: 'HelveticaNeue-Light,Helvetica Neue Light,Helvetica Neue,Helvetica, Arial,Lucida Grande, sans-serif'
            }, options);

            // overriding from data attributes
            settings = $.extend(settings, e.data());

            settings.name = "" + settings.name;
            // making the text object
            var c = settings.name.substr(0, settings.charCount).toUpperCase();
            var cobj = $('<text text-anchor="middle"></text>').attr({
                'y': '50%',
                'x': '50%',
                'dy' : '0.35em',
                'pointer-events':'auto',
                'fill': settings.textColor,
                'font-family': settings.fontFamily
            }).html(c).css({
                'font-weight': settings.fontWeight,
                'font-size': settings.fontSize+'px',
            });

            var colorIndex = null;
            if(c.length > 1)
            	colorIndex = Math.abs(Math.floor((((c.charCodeAt(0) - 65) + (c.charCodeAt(1) - 65))/2)  % colors.length));
            else
            	colorIndex = Math.abs(Math.floor((c.charCodeAt(0) - 65) % colors.length));

            var svg = $('<svg></svg>').attr({
                'xmlns': 'http://www.w3.org/2000/svg',
                'pointer-events':'none',
                'width': settings.width,
                'height': settings.height
            }).css({
                'background-color': colors[colorIndex],
                'width': settings.width+'px',
                'height': settings.height+'px'
            });

            svg.append(cobj);
           // svg.append(group);
            var svgHtml = window.btoa(unescape(encodeURIComponent($('<div>').append(svg.clone()).html())));

            e.attr("src", 'data:image/svg+xml;base64,' + svgHtml);

        })
    };

});


function image_error(element)
{
		var name = $(element).attr("_data-name");
		
		if(!name)
			return;
		$(element).attr("data-name", name);
		$(element).initial({charCount: 2, fontWeight : 'normal'});
}

function image_load(element)
{
	//alert(element);
	var name = $(element).attr("_data-name");
	var src = $(element).attr('src');
	
	if(!src)
		{
			$(element).attr('src', DEFAULT_GRAVATAR_url);
			return;
		}
	
	if(src.indexOf(DEFAULT_GRAVATAR_url) >= 0)
		{
			$(element).attr("data-name", name);
			$(element).removeAttr("onLoad");
			//$(element).initial({charCount: 2, fontWeight : 'normal'});
		}
}

// Contacts on querying
var QUERY_RESULTS;

// Saves map of key: name and value: contact id
var TYPEHEAD_TAGS = {};

// Saves map of key: name and value: contact email
var TYPEHEAD_EMAILS = {};

// Saves map of key: name and value: contact name
var TYPEHEAD_NAMES = {};

var TYPEHEAD_TYPE = {};

/**
 * This script file defines simple search keywords entered in input fields are
 * sent to back end as query through bootstrap typeahead. Methods render,
 * matcher and updater are overridden for custom functionality. Last 2
 * parameters were added later for Companies autofill. They can be left
 * undefined and things will go to default, the way its normally used otherwise
 * throughout the project.
 * 
 * @method agile_type_ahead
 * @param id
 *            Html element id of input field
 * @param el
 *            Html element of the view
 * @param callback
 *            To customer contacts to show in dropdown
 * @param isSearch
 *            Callback to override functionalities of updater function
 * @param urlParams
 *            [Added later] Additional parameters to be append, e.g.
 *            type=COMPANY
 * @param noResultText
 *            [Added later] HTML text to display in case of no result
 * @param isDealSearch
 *            true when it is using for deals typeahead.
 * @module Search
 * @author Yaswanth
 * 
 */
function agile_type_ahead(id, el, callback, isSearch, urlParams, noResultText, url, isEmailSearch, isDealSearch, appendNameToEmail)
{

	// Turn off browser default auto complete
	$('#' + id, el).attr("autocomplete", "off");
	if (!url)
		url = "core/api/search/"

	var CONTACTS = {};

	var el_typeahead = $('#' + id, el)
			.typeahead(
					{

						// Time delay to start query
						timedelay : 250,

						// Holds current search query xhr object
						searchAJAXRequest : undefined,
						source : function(query, process)
						{

							/* Resets the results before query */
							CONTACTS = {};

							/* Stores type ahead object in temporary variable */
							var that = this;

							this.options.showLoading(this);

							// Drop down with loading image is shown
							// this.shown = true;

							// Get data on query

							var type_url = "";

							if (urlParams && urlParams.length)
								type_url = '&' + urlParams;

							// Sends search request and holds request object,
							// which can be reference to cancel request if there
							// is any new request
							this.options.searchAJAXRequest = $.getJSON(url + "?q=" + encodeURIComponent(query) + "&page_size=10" + type_url, function(data)
							{

								var current_query = $('#' + id, el).val();

								// If current query is not equal to that of
								// token in search url, results are not shown
								// (never occurs now as it is handled in keyup
								// function)
								if (query != current_query)
								{
									return;
								}

								/*
								 * Stores query results to use them in updater
								 * and render functions
								 */
								CONTACTS = data;

								/*
								 * Sets results in global variable, used to show
								 * results in different page (when search symbol
								 * is clicked)
								 */
								QUERY_RESULTS = data;

								/*
								 * If no result found based on query, shows info
								 * in type-ahead drop-down and return
								 */
								if (data.length == 0)
								{
									var txt = '<b>No Results Found</b>';

									if (noResultText && noResultText.length)
										txt = noResultText;

									// Not to show "no Results Found" for email
									// search
									if (txt == "email-search")
									{
										that.$menu.hide();
										return;
									}

									that.$menu.html('<div class="m-t-sm"><p align="center"   class="custom-color">' + txt + '<p></div>');
									that.render();
									return;
								}

								var items_list = [];

								/*
								 * Customizes data for type ahead, items_list
								 * contains list of contact names (first_name +
								 * last_name without space). callback is
								 * contacts_typeahead
								 */
								if (callback && typeof (callback) === "function")
									items_list = callback(data);

								/*
								 * Stores contacts in a map with
								 * first_name+last_name as key and id as value
								 */
								$.each(data, function(index, item)
								{
									tag_name = items_list[index];
									// Used for related to contacts for ids
									TYPEHEAD_TAGS[tag_name] = item.id;
									// Used for related to contacts for emails
									// in send-email
									TYPEHEAD_EMAILS[tag_name] = getContactEmail(item);

									TYPEHEAD_NAMES[tag_name] = getContactName(item);
									
									if(item.type == 'PERSON')
										TYPEHEAD_TYPE[tag_name] = '#contact/';
									else if(item.type == 'COMPANY')
										TYPEHEAD_TYPE[tag_name] = '#company/';
										
								});

								/*
								 * Calls matcher and render methods by verifying
								 * the data
								 */
								process(items_list);
							});
						},
						showLoading : function(self)
						{
							self.$menu.empty();
							/* Sets css to html data to be displayed */
							self.$menu.css("width", 300);							

							/*
							 * Calls render because menu needs to be initialized
							 * even before first result is fetched to show
							 * loading
							 */

							/*
							 * If loading image is not available in menu then
							 * appends it to menu
							 */
							if (!$(self.$menu.find('li').last()).hasClass('loading-results'))
							{
								self.$menu.html('<li class="divider"></li><li class="loading-results"><p align="center">' + LOADING_ON_CURSOR + '</p></li>');
								self.render();
							}

						},

						/**
						 * Overridden to return always true (when contacts are
						 * fetched based on email or company name etc..)
						 */
						matcher : function(item)
						{
							if (~item.toLowerCase().indexOf(this.query.toLowerCase()) != 0)
								return ~item.toLowerCase().indexOf(this.query.toLowerCase());
							else
								return -1;
						},

						/**
						 * Overridden to customize the view of matched drop down
						 * entities (i.e with image, email address etc..)
						 */
						render : function()
						{
							var that = this;

							// If query results are not available activate the
							// menu to show info and return
							if (!CONTACTS.length)
							{
								this.show();
								return;
							}

							// Stores all the matched elements (<li> drop down)
							// in items
							items = buildcategorizedResultDropdown(CONTACTS, that.options);

							items.css("overflow", "hidden");

							// this.$menu.css("max-height", "400px");
							// this.$menu.css("overflow", "auto");

							// Keeps the list of items in menu (ul) and shows
							// the drop down
							this.$menu.html(items).show();
							this.shown = true;
							//Sets modal backdrop height to sum of modal dialog height and related contacts drop down height after render the related contacts
							$('.modal-backdrop',$('.modal:visible')).height($('.modal-dialog',$('.modal:visible')).height()+$('ul.dropdown-menu',$('.modal:visible')).height());
							return this;
						},

						/**
						 * Handles the select (clicking a drop down element)
						 * event of drop down elements. If, it is search fiel
						 * navigates to detail view, related to field prepends
						 * the name as tag to the field. Also shows all the
						 * matched entities in other page when search symbol is
						 * clicked.
						 */
						updater : function(items)
						{
							// To verify whether the entity (task, deal etc..)
							// related to same contact twice
							var tag_not_exist = true;
							var email_not_exist = true;

							/*
							 * Stores items in temp variable so that, shows
							 * first name and last name separated by space
							 */
							if (items)
								var items_temp = items.substr(0, items.lastIndexOf('-'));

							// Trims spaces in names to retrieve contact id from
							// JSON (TYPEHEAD_TAGS)
							if (items)
								items = items.split(" ").join("")

								// Customizes data for type ahead
							if (isSearch && typeof (isSearch) === "function")
							{

								/*
								 * If no item is selected (when clicked on
								 * search symbol or enter) then show results in
								 * different page
								 */
								if (!items)
								{
									showSearchResults(); // fails
									// automatically for
									// non main search
									// bar typeaheads.
									return this.query; // return text of query
									// to set in input field
								}

								// Navigates the item to its detail view
								isSearch(TYPEHEAD_TAGS[items], items_temp);
								return;
							}

							// Return if items are not defined and it is not
							// search in nav bar
							if (!items)
								return;

							if (isEmailSearch)
							{
								// If email already exists returns
								$.each($('#' + id, el).closest("div.controls").find(".tags").children('li'), function(index, tag)
								{

									if ($(tag).attr('data') == TYPEHEAD_EMAILS[items] || ~($(tag).attr('data').indexOf(TYPEHEAD_EMAILS[items])))
									{
										email_not_exist = false;
										return;
									}
								});
								if (email_not_exist && (TYPEHEAD_EMAILS[items] != "No email"))
								{

									var data = TYPEHEAD_EMAILS[items];
									var name = TYPEHEAD_NAMES[items];

									if (appendNameToEmail && data && name && Object.keys(TYPEHEAD_NAMES).length != 0)
									{
										// Replace < or > with spaces
										if (name.indexOf("<") != -1 || name.indexOf(">") != -1)
										{
											name = name.replace(/</g, " ");
											name = name.replace(/>/g, " ");
										}

										// Don't append email
										if (name.trim() != data.trim())
											data = name.trim() + ' <' + data.trim() + '>';
									}

									$('#' + id, el)
											.closest("div.controls")
											.find(".tags")
											.append(
													'<li class="tag  btn btn-xs btn-primary m-r-xs inline-block"  data="' + TYPEHEAD_EMAILS[items] + '"><a class="text-white" href="'+TYPEHEAD_TYPE[items] + TYPEHEAD_TAGS[items] + '">' + items_temp + '</a><a class="close text-white m-l-xs" id="remove_tag">&times</a></li>');

								}

							}
							else if (isDealSearch)
							{
								// If tag already exists returns
								$.each($('.deal_tags', el).children('li'), function(index, tag)
								{

									if ($(tag).attr('data') == TYPEHEAD_TAGS[items])
									{
										tag_not_exist = false;
										return;
									}
								});
								// add tag
								if (tag_not_exist)
									$('.deal_tags', el)
											.append(
													'<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block"  data="' + TYPEHEAD_TAGS[items] + '"><a href="#deal/' + TYPEHEAD_TAGS[items] + '" class="text-white v-middle">' + items_temp + '</a><a class="close m-l-xs" id="remove_tag">&times</a></li>');
							}
							else
							{
								// If tag already exists returns
								$.each($('.tags', el).children('li'), function(index, tag)
								{

									if ($(tag).attr('data') == TYPEHEAD_TAGS[items])
									{
										tag_not_exist = false;
										return;
									}
								});

								// add tag
								if (tag_not_exist)
									$('.tags', el)
											.append(
													'<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block"  data="' + TYPEHEAD_TAGS[items] + '"><a href="'+TYPEHEAD_TYPE[items] + TYPEHEAD_TAGS[items] + '" class="text-white v-middle">' + items_temp + '</a><a class="close m-l-xs" id="remove_tag">&times</a></li>');
							}
							//Sets modal backdrop height to modal dialog height after select the tag
							$('.modal-backdrop',$('.modal:visible')).height($('.modal-dialog',$('.modal:visible')).height()+70);
						},
						// Needs to be overridden to set timedelay on search
						keyup : function(e)
						{
							switch (e.keyCode) {
							case 40: // down arrow
							case 38: // up arrow
							case 16: // shift
							case 17: // ctrl
							case 18: // alt
								break

							case 9: // tab
							case 13: // enter
								if (!this.shown)
									return

								

																

								

																								

								

																

								

																																

								

																

								

																								

								

																

								

								if (isEmailSearch && !CONTACTS.length)
									this.hide();
								else
									this.select();
								break

							case 27: // escape
								if (!this.shown)
									return

								

																

								

																								

								

																

								

																																

								

																

								

																								

								

																

								

								this.hide()
								break

							case 188:
								if (isEmailSearch)
								{
									if (checkEmailValidation(($('#' + id, el).val()).slice(0, -1)))
									{
										var email_check = true;
										var email_value = ($('#' + id, el).val()).slice(0, -1);
										$.each($('#' + id, el).closest("div.controls").find(".tags").children('li'), function(index, tag)
										{

											if ($(tag).attr('data') == email_value || ~($(tag).attr('data').indexOf(email_value)))
											{
												email_check = false;
												return;
											}
										});
										if (email_check)
											$('#' + id, el)
													.closest("div.controls")
													.find(".tags")
													.append(
															'<li class="tag"  style="display: inline-block;" data="' + email_value + '"><a style="cursor:pointer;">' + email_value + '</a><a class="close" id="remove_tag">&times</a></li>');
										this.select();
									}
									else
										this.hide();
								}
								break

							default:
							{
								// Checks if there is previous request and
								// cancels it
								if (this.options.searchAJAXRequest != null && (this.options.searchAJAXRequest && this.options.searchAJAXRequest.readystate != 4))
								{
									this.options.searchAJAXRequest.abort();
								}

								if (this.timer)
									clearTimeout(this.timer);
								var self = this;

								// Reset results
								CONTACTS = {};

								/*
								 * If loading image is not available in menu
								 * then appends it to menu
								 */
								this.options.showLoading(self);

								this.timer = setTimeout(function()
								{
									self.lookup();
								}, this.options.timedelay);
							}
							}

							e.stopPropagation()
							e.preventDefault()
						}

						,

						// Hides the results list
						hide : function()
						{
							this.$menu.hide();
							this.shown = false;
							return this;
						},

						// Handles cursor exiting the textbox
						blur : function(e)
						{
							var that = this;
							e.stopPropagation();
							e.preventDefault();
							setTimeout(function()
							{
								if (!that.$menu.is(':focus'))
									that.hide();
							}, 150)
						}, minLength : 2, })
}

// Removes tags ("Related to" field contacts)
$("body").on("click", '#remove_tag', function(event)
{
	event.preventDefault();
	$(this).parent().remove();
});

/* Customization of Type-Ahead data */

/**
 * Returns list of contact names (with no space separation) for type ahead
 * 
 * @method contacts_typeahead
 * @param data
 *            contacts on querying, from type-ahead
 */
function contacts_typeahead(data)
{
	if (data == null)
		return;

	// To store contact names list
	var contact_names_list = [];

	/*
	 * Iterates through all the contacts and get name property
	 */
	$.each(data, function(index, contact)
	{

		var contact_name;

		if (contact.entity_type == 'deal')
		{
			// Append the name of the deal and the id for deals in search.
			contact_name = contact.name + "-" + contact.id;
		}
		else
		{
			// Appends first and last name to push in to a list
			contact_name = getContactName(contact) + "-" + contact.id;

		}

		// Spaces are removed from the name, name should be used as a key in map
		// "TYPEHEAD_TAGS"
		contact_names_list.push(contact_name.split(" ").join(""));
	});

	// Returns list of contact/company names
	return contact_names_list;

}

/**
 * Returns list of contact names (with no space separation) for type ahead
 * 
 * @method contacts_typeahead
 * @param data
 *            contacts on querying, from type-ahead
 */
function deals_typeahead(data)
{
	if (data == null)
		return;

	// To store contact names list
	var deal_names_list = [];

	/*
	 * Iterates through all the contacts and get name property
	 */
	$.each(data, function(index, deal)
	{

		var deal_name;

		// Appends first and last name to push in to a list
		deal_name = deal.name.split(" ").join("") + "-" + deal.id;

		// Spaces are removed from the name, name should be used as a key in map
		// "TYPEHEAD_TAGS"
		deal_names_list.push(deal_name);
	});

	// Returns list of contact/company names
	return deal_names_list;

}

function getContactEmail(contact)
{
	var email = getPropertyValue(contact.properties, "email");
	email = email != undefined ? email.trim() : "";

	if (email.length)
		return email;
	else
		return "No email";

}

function checkEmailValidation(value)
{
	return /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/i.test(value);
}

function getContactName(contact)
{
	var name = "";
	if (!contact.type || contact.type == 'PERSON')
	{
		var first_name = getPropertyValue(contact.properties, "first_name");
		var last_name = getPropertyValue(contact.properties, "last_name");
		last_name = last_name != undefined ? last_name.trim() : "";
		first_name = first_name != undefined ? first_name.trim() : "";
		name = (first_name + " " + last_name).trim();
	}
	else if (contact.type == "COMPANY")
	{
		var company_name = getPropertyValue(contact.properties, "name");
		company_name = company_name != undefined ? company_name.trim() : "";
		name = company_name.trim();
	}

	if (name.length)
		return name;

	var email = getPropertyValue(contact.properties, "email");
	email = email != undefined ? email.trim() : "";

	if (email.length)
		return email;

	// if nothing found, assume Company and return with id.

	return 'Company ' + contact.id;
}

function buildcategorizedResultDropdown(items, options)
{
	var contact_custom_view = new Base_Collection_View({ data : items, templateKey : "typeahead-contacts", individual_tag_name : 'li',
		typeahead_options : options });

	contact_custom_view.appendItem = appendItemInResult;

	var el = contact_custom_view.render(true).el;
	return $(el);

	/*
	 * $(items).each(function (i, item){
	 * 
	 * if()
	 * 
	 * Check if item if of company type get company name instead of first name
	 * and last name of person
	 * 
	 * var fullname = getContactName(item) + "-" + item.id;
	 * 
	 * console.log(fullname); // Sets data-value to name i =
	 * $(that.options.item).attr('data-value', fullname); // To add border to
	 * all after li except to last one i.addClass('typeahead-border'); //
	 * Returns template, can be contact or company compares in template
	 * i.find('a').html(getTemplate('typeahead-contacts', item)); return i[0];
	 * });
	 */
}

function appendItemInResult(item)
{

	var fullname = getContactName(item.toJSON()) + "-" + item.id;

	var type = item.toJSON().entity_type;

	if (type && type == "deal")
		fullname = item.toJSON().name + "-" + item.id;

	var itemView = new Base_List_View({ model : item, "view" : "inline", template : this.options.templateKey + "-model", tagName : 'div', });

	// Sets data-value to name
	i = $(this.options.typeahead_options.item).attr('data-data-value', fullname);

	// To add border to all after li except to last one
	i.addClass('typeahead-border');
	// Returns template, can be contact or company compares in template
	i.find('a').html(itemView.render(true).el);

	i.find('a').removeAttr('href');

	if (type)
	{
		if (type == "contact_entity")
		{

			$("#contact-typeahead-heading", this.el).show();
			$("#contact-results", this.el).append(i);
		}
		if (type == "deal")
		{
			$("#deal-typeahead-heading", this.el).show();
			$("#deals-results", this.el).append(i);
		}
		if (type == "case")
		{
			$("#case-typeahead-heading", this.el).show();
			$("#case-results", this.el).append(i);
		}
		if (type == "document")
		{
			$("#document-typeahead-heading", this.el).show();
			$("#document-results", this.el).append(i);
		}
	}

}
/**
 * TAGS and tagsCollection are taken as global variables.
 * 
 * TAGS --> Stores models of tagsCollection (to avoid fetching the data from server side, 
 * 			every time the tags typeahead is called)
 * tagsCollection --> To show up the added tags in tags view, by adding to this collection 
 */
var TAGS;
var tagsCollection;
var isTagsTypeaheadActive;
var tagsTemplate;
var tagsCollectionView;
/**
 * Creates a list (tags_list) only with tag values (i.e excludes the keys), 
 * by fetching the tags from server side, if they do not exist at client side (in TAGS). 
 * 
 * This tags_list is used as source for the typeahead, to show the matched items 
 * as drop down list, when a key is entered in the input box of typeahead 
 * 
 * @method setup_tags_typeahead
 * 
 */
function setup_tags_typeahead() {
	var tags_list = [];
	
	
	// Fetches tags collection, if no tags are exist (in TAGS) 
    if(!TAGS)
    	{
    		init_tags_collection();
    		return;
    	}
    
    TAGS = tagsCollection.models;
    
    // Iterate TAGS to create tags_list (only with tag values)   
    _(TAGS).each(function (item) { 
        var tag = item.get("tag");
        if ($.inArray(tag, tags_list) == -1) tags_list.push(tag);
    });

    if(!$('.tags-typeahead').attr('placeholder'))
    	$('.tags-typeahead').attr("placeholder", "Separate tags with commas");
    
    // Turn off browser default auto complete
    $('.tags-typeahead').attr("autocomplete","off");
 
    /**
     * typeahead is activated to the input field, having the class "tags-typeahead" 
     */
    $('.tags-typeahead').typeahead({
        
    	/**
    	 * Shows a drop down list of matched elements to the key, entered in the 
    	 * input field (having the class "tags-typeahead") from the list of elements
    	 * (tags_list) passed to the source method of typeahead
    	 */
    	source: function (query, process)
    	{
    		isTagsTypeaheadActive = false;
    		(this.$menu).empty();
    		
    		process(tags_list);
    		
    		if(this.$menu.find('.active').length > 0)
    			isTagsTypeaheadActive = true;
    	},
    	/**
    	 * Performs its operation (adds the tag as an li element to its nearest ul) on selecting 
    	 * a tag from the list of matched items provided by the source method   
    	 */
    	updater: function(tag) {
    		
    		if(!tag || (/^\s*$/).test(tag))
    			{
    				return;
    			}
    	
    		tag = tag.trim();
    	
    		// Saves the selected tag to the contact
    		if((this.$element).closest(".control-group").hasClass('save-tag')){
    			
    			var json = null;
    			
    			if(company_util.isCompany())
    				json = App_Companies.companyDetailView.model.toJSON();
    			else
    				json = App_Contacts.contactDetailView.model.toJSON();
    			
    			// Checks if tag already exists in contact
    			if($.inArray(tag, json.tags) >= 0)
    				return;

    			json.tagsWithTime.push({"tag" : tag});
    			
    			
    			saveEntity(json, 'core/api/contacts', function(data){
    				$("#addTagsForm").css("display", "none");
        		    $("#add-tags").css("display", "block");
        		    
    	     		// Get all existing tags of the contact to compare with the added tags
	       			var old_tags = [];
	       			$.each($('#added-tags-ul').children(), function(index, element){
       					
	       				old_tags.push($(element).attr('data'));
       				});
	       			
	       			if(company_util.isCompany()){
	       				App_Companies.companyDetailView.model.set(data.toJSON(), {silent : true});
	       			// Append to the list, when no match is found 
		       			if ($.inArray(tag, old_tags) == -1) 
		       				$('#added-tags-ul').append('<li class="tag btn btn-xs btn-default m-r-xs m-b-xs inline-block" data="' + tag + '"><span><a class="anchor m-r-xs" href="#tags/'+ tag + '" >'+ tag + '</a><a class="close remove-company-tags" id="' + tag + '" tag="'+tag+'">&times</a></span></li>');
	    				
	       			}
	       			else{
	       				App_Contacts.contactDetailView.model.set(data.toJSON(), {silent : true});
	       				addTagToTimelineDynamically(tag, data.get("tagsWithTime"));
	       			// Append to the list, when no match is found 
		       			if ($.inArray(tag, old_tags) == -1) 
		       				$('#added-tags-ul').append('<li class="tag btn btn-xs btn-default m-r-xs m-b-xs inline-block" data="' + tag + '"><span><a class="anchor m-r-xs" href="#tags/'+ tag + '" >'+ tag + '</a><a class="close remove-tags" id="' + tag + '" tag="'+tag+'">&times</a></span></li>');
	    				
	       			}
	       			
    			});
    	        return;
    		}
    		
    		// To store existing tags in form.
    		var tags_temp = [];
    		
    	    // If tag already exists returns
            $.each((this.$element).closest(".control-group").find('ul.tags').children('li'), function (index, tag){
            	tags_temp.push($(tag).attr('data'));
            });

            // If tag is not added already, then add new tag.
    		if($.inArray(tag, tags_temp) == -1)
    			(this.$element).closest(".control-group").find('ul.tags').append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block"   data="'+ tag+'"><span class="m-r-xs v-middle">'+tag+'</span><a class="close" id="remove_tag">&times</a></li>');
        }
    });
    
    $('body').on('keydown', '#addTags', function(e) {
    	if(e.which == 13 && !isTagsTypeaheadActive)
    		{
    			e.preventDefault();
    			
    			var contact_json = App_Contacts.contactDetailView.model.toJSON();
    	
    			var tag = $(this).val().trim();
    			
    			if(!tag || tag.length<=0 || (/^\s*$/).test(tag))
    			{
    				return;
    			}

    			if (!isValidTag(tag, true)) {
    				return false;
    			}
    			$("#addTags").val("");
    			
    			tag = tag.trim();
    			
    			acl_util.canAddTag(tag,function(canAdd){
    				
    				if(!canAdd){
        				return;
        			}
    				
    				// Get all existing tags of the contact to compare with the added tags
        			var old_tags = [];
        			$.each($('#added-tags-ul').children(), function(index, element){
    				
        				old_tags.push($(element).attr('data'));
        			});
    			
        			// Append to the list, when no match is found 
        			if ($.inArray(tag, old_tags) != -1) 
        				return;
       			
        			contact_json.tagsWithTime.push({"tag" : tag});
        	    	
        			saveEntity(contact_json, 'core/api/contacts',  function(data) {
        				// Updates to both model and collection
        				App_Contacts.contactDetailView.model.set(data.toJSON(), {silent : true});
        				addTagToTimelineDynamically(tag, data.get("tagsWithTime"));
        				tagsCollection.add(new BaseModel( {"tag" : tag} ));
        			$("#addTagsForm").css("display", "none");
        		    $("#add-tags").css("display", "block");

           				$('#added-tags-ul').append('<li class="inline-block tag btn btn-xs btn-default m-r-xs m-b-xs" data="' + tag + '" ><span><a class="anchor m-r-xs" href="#tags/'+ tag + '">'+ tag + '</a><a class="close remove-tags" id="' + tag + '" tag="'+tag+'">&times</a></span></li>');
        			},function(model,response){
        				console.log(response);
    	       			alert(response.responseText);
        			});
    			});
    			
    		}
    });
    
    
    /**
     * If entered tag is not in typeahead source, create a new tag (enter "," at the end of new tag 
     * element, then it could be added as new tag)
     */
    $(".tags-typeahead").bind("keydown", function(e){
    	
    	// Adds no tags when the key down is "," in contact detail view tags 
    	if($(this).hasClass('ignore-comma-keydown'))
    	  return;
    	
    	var tag = $(this).val().trim();
    	
    	if(!tag || tag.length<=0 || (/^\s*$/).test(tag))
		{
			return;
		}
    	
    	// To make a tag when "," keydown and check input is not empty
    	if(e.which == 188 && tag != "")
    	{
    		e.preventDefault();
    	
    		// Prevents comma (",") as an argument to the input field
    		$(this).val("");
    		
    		var tags_list=$(this).closest(".control-group").find('ul.tags');
    		var add_tag=true;
    		
    		// Iterate over already present tags, to check if this is a new tag
    		tags_list.find('li').each(function(index,elem){
    			
    			if(elem.getAttribute('data')==tag)
    			{
    				add_tag=false; // tag exists, don't add
    				return false;
    			}
    		});
    		
    		if(add_tag)
    			tags_list.append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block"  data="'+ tag+'">'+tag+'<a class="close m-l-xs" id="remove_tag" tag="'+tag+'">&times</a></li>');
    	}
    });
}

/**
 * Fetches the tags collection from server side and shows them in their 
 * separate section along  with contacts list.
 * Called from contacts router and customView router.
 * 
 * @method setup_tags
 * @param {Object} cel 
 * 			contacts list view page as html object
 */
function setup_tags(cel) {
	
	if(!tagsCollection || !tagsCollectionView)
	{
		
		init_tags_collection(cel, function(el){
			$('#tagslist', cel).html(el);
		});
		return;
	}
	  $('#tagslist', cel).html(tagsCollectionView.render(true).el);
}

/**
 * Reads the tag values from the elements having class "tags" and maps 
 * them as a json object to return.
 * 
 * @method get_tags
 * @param {String} form_id 
 * 			to read tags from the form
 * @returns json object of tags
 */
function get_tags(form_id) {
    var tags_json = $('#' + form_id + ' .tags').map(function () {
       	var values = [];

       	$.each($(this).children(), function(index, data) { 
       		values.push(($(data).attr("data")).toString())
    	});
        return {
        	"name" : $(this).attr('name'),
           	"value":values
        };
    }).get();
    
    // Reads input value from input field too.
    var input_filed = $("#" + form_id + " input.tags-typeahead");
    if(input_filed != null)
    {
    	var tag_input = $(input_filed).val();
    	
    	if(tag_input)
    		{
    			tag_input = tag_input.trim();
    			tags_json[0].value.push(tag_input);
    		//	input_filed.val("");
    		}
    }
    return tags_json;
}

/**
 * Reads the tag values from the elements having class "tags" and maps 
 * them as a json object to return.
 * 
 * @method get_tags
 * @param {String} form_id 
 * 			to read tags from the form
 * @returns json object of tags
 */
function get_related_deals(form_id) {
    var tags_json = $('#' + form_id + ' .deal_tags').map(function () {
       	var values = [];

       	$.each($(this).children(), function(index, data) { 
       		values.push(($(data).attr("data")).toString())
    	});
        return {
        	"name" : $(this).attr('name'),
           	"value":values
        };
    }).get();
    
    return tags_json;
}

/**
 * Reads the values of a input field and splits based on comma
 * @param id
 * @returns
 */
function get_new_tags(id){
    // Add Tags
    if (isValidField(id)) {
        var tags = $('#' + id).val();
        
        // Replace multiple space with single space
        tags =  tags.replace(/ +(?= )/g,'');

        
        // Replace ,space with space
        tags = tags.replace(", ", " ");

        // Replace , with spaces
        tags = tags.replace(",", " ");

        return tags;
//        return tags.split(" ");
    }
}

function init_tags_collection(cel, callback, url)
{
	url = url ? url : '/core/api/tags'
	tagsCollectionView = new Base_Collection_View({ 
			url : url, 
			sortKey: 'tag',
			templateKey : 'tags', 
		});
	
	tagsCollectionView.appendItem = append_tag;
	

	tagsCollection = tagsCollectionView.collection;
	
	tagsCollectionView.collection.fetch({success: function(data){
		  TAGS = tagsCollection.models
		  
		// Called to initiate typeahead to the fields with class attribute "tags_typeahead"
        setup_tags_typeahead();
		  
		if(callback && typeof (callback) === "function")
			callback(tagsCollectionView.render(true).el);		  
	}});
}

function append_tag(base_model)
{
	var tag = base_model.get('tag');
	var key = tag.charAt(0).toUpperCase();
	tag_encoded = encodeURIComponent(tag);
	$( 'div[tag-alphabet="'+encodeURI(key)+'"]', this.el).append('<a href="#tags/'+tag_encoded+'" id="'+tag_encoded.replace( / +/g, '' )+'-in-list">'+tag+'</a>&nbsp;');
}

function remove_tags(base_model)
{
	console.log("removed");	
}

$(function(){

	$('body').on('click', '#refresh-tags', function(e){
		e.preventDefault();
		$('#tagslist', App_Contacts.contactsListView.el).html(getRandomLoadingImg());
		init_tags_collection(App_Contacts.contactsListView.el, function(tags){
			setup_tags(App_Contacts.contactsListView.el);
			pieTags(App_Contacts.contactsListView.el, true);
		}, 'core/api/tags?reload=true');
	})
	$('body').on('focusout', '.contact-detail-addtags', function(e)
	{
		e.preventDefault();
		var contact_tag_temp = $(this).val();
		$('body').on('mousedown', function(s)
		{
			s.preventDefault();
			var t = s.target.id;
			if (!contact_tag_temp && t != "contact-add-tags" && t != "addTags")
			{
				$("#addTagsForm").css("display", "none");
				$("#add-tags").css("display", "block");
			}
		});
	});
});
/**
*  Document collection event listeners
*/
var Document_Collection_Events = Base_Collection_View.extend({
	
	events: {
		'click .documents-add': 'onAddDocument',
		'click #documents-model-list > tr > td:not(":first-child")': 'onDocumentListSelect',		
	},

	/**
	 * For adding new document
	 */
	onAddDocument: function(e){
		e.preventDefault();

		// Show modal
		$('#uploadDocumentModal').html(getTemplate("upload-document-modal", {})).modal('show');
	
		// Add type a head actions
		var el = $("#uploadDocumentForm");
		// Contacts type-ahead
		agile_type_ahead("document_relates_to_contacts", el, contacts_typeahead);
		
		// Deals type-ahead
		agile_type_ahead("document_relates_to_deals", el, deals_typeahead, false,null,null,"core/api/search/deals",false, true);
	},

	 /** 
     * Document list view edit
     */
	onDocumentListSelect : function(e){
		if(e.target.parentElement.attributes[0].name!="href" && e.target.parentElement.attributes[1].name!="href"){
     		e.preventDefault();

     	 	updateDocument($(e.currentTarget).closest('tr').data());
     	 }
	},

});
  
/** Modal event initializer **/
$(function(){

    /** 
     * When clicked on choose network type
     */
    $('#uploadDocumentUpdateModal,#uploadDocumentModal').on('click', '.link', function(e)
	{
		e.preventDefault();
		$(this).closest('form').find('#error').html("");
		var form_id = $(this).closest('form').attr("id");
		var id = $(this).find("a").attr("id");
		
		if(id && id == "GOOGLE")
			var newwindow = window.open("upload-google-document.jsp?id="+ form_id, 'name','height=510,width=800');
		else if(id && id == "S3")
			var newwindow = window.open("upload-custom-document.jsp?id="+ form_id +"&t=" + CURRENT_USER_PREFS.template +"&d=" + CURRENT_DOMAIN_USER.domain, 'name','height=310,width=500');
		
		if (window.focus)
		{
			newwindow.focus();
		}
		return false;
	});
	
	/**
	 * To validate the document add or edit forms
	 */
	$('#uploadDocumentUpdateModal,#uploadDocumentModal').on('click', '#document_validate, #document_update_validate', function(e){
 		e.preventDefault();

 		var modal_id = $(this).closest('.upload-document-modal').attr("id");
    	var form_id = $(this).closest('.upload-document-modal').find('form').attr("id");
    	
    	// serialize form.
    	var json = serializeForm(form_id);
    	console.log(json);

    	if(form_id == "uploadDocumentForm")
    		saveDocument(form_id, modal_id, this, false, json);
    	else
    		saveDocument(form_id, modal_id, this, true, json);
	});

	$('#uploadDocumentModal').on('hidden.bs.modal', function(e){
		$('#GOOGLE',$('#uploadDocumentModal')).parent().show();
	});

});


/**
 * Show document popup for updating
 */ 
function updateDocument(ele) {
	
	var value = ele.toJSON();
	
	add_recent_view(new BaseModel(value));

	var uploadModal = $('#uploadDocumentUpdateModal');
	uploadModal.html(getTemplate("upload-document-update-modal", {}));
	uploadModal.modal('show');
	
	var documentUpdateForm = $("#uploadDocumentUpdateForm");
	deserializeForm(value, $("#uploadDocumentUpdateForm"));
	$('#uploadDocumentUpdateForm').find("#" + value.network_type).closest(".link").find(".icon-ok").css("display", "inline");
	$('#uploadDocumentUpdateForm').find("#" + value.network_type).closest(".link").css("background-color", "#EDEDED");

	// Call setupTypeAhead to get contacts
	agile_type_ahead("document_relates_to_contacts", documentUpdateForm, contacts_typeahead);
	
	// Deals type-ahead
	agile_type_ahead("document_relates_to_deals", documentUpdateForm, deals_typeahead, false,null,null,"core/api/search/deals",false, true);
}

/**
 * Return url of document from JSP and appends to form
 * @param url
 * @param network
 */
function saveDocumentURL(url, network, id)
{
	id = id.split("?id=")[1];
	var form_id = id.split("&")[0];
	
	// Saving extension of document
	var extension = url.split("?");
	if(url.match("agilecrm/panel/uploaded-logo/"))
	{
		extension = extension[0];
		extension = extension.substring(extension.lastIndexOf("/")+1);
	}
	else 
		extension = "Google";
	
	$('#' + form_id).find("#extension").val(extension);
	$('#' + form_id).find("#network_type").val(network);
	$('#' + form_id).find('#network_type').closest(".controls").find("div.link").css("background-color", "#FFFFFF");
	$('#' + form_id).find('#network_type').closest(".controls").find(".icon-ok").css("display", "none");
	$('#' + form_id).find("#" + network).closest(".link").find(".icon-ok").css("display", "inline");
	$('#' + form_id).find('#' + network).closest(".link").css("background-color", "#EDEDED");
   	$('#' + form_id).find('#upload_url').val(url);
   	$('#' + form_id).find('#size').val(CUSTOM_DOCUMENT_SIZE);

    //$('#' + form_id).find('#url').html('<a href="'+ url +'" target="_blank">'+ url +'</a>');
}

/**
 *stores size of document
 */

/**
 * Saves document instance
 * @param form_id
 * @param modal_id
 * @param saveBtn
 * @param update
 * @returns {Boolean}
 */
function saveDocument(form_id, modal_id, saveBtn, isUpdate, json)
{
	// Returns, if the save button has disabled attribute
	if ($(saveBtn).attr('disabled'))
		return;

	// Disables save button to prevent multiple click event issues
	disable_save_button($(saveBtn));
	
	// While attaching document is from existing documenst list, no need of form verification.
	if(form_id)
	{	
		
		if (!isValidForm('#' + form_id)) {

			// Removes disabled attribute of save button
			enable_save_button($(saveBtn));//$(saveBtn).removeAttr('disabled');
			
			return false;
		}
		
		var url = $('#' + form_id).find('#upload_url').val();
		if(url == "")
		{
			$('#' + form_id).find('#network_type').closest(".controls").find(".icon-ok").css("display", "none");
			$('#' + form_id).find('#network_type').closest(".controls").find("div.link").css("background-color", "#FFFFFF");
			$('#' + form_id).find('#error').html('<div class="alert alert-danger">Sorry! Document not attached properly.</div>');
			enable_save_button($(saveBtn));
			return;
		}
	}
	
	var newDocument = new Backbone.Model();
	newDocument.url = 'core/api/documents';
	newDocument.save(json, {
		success : function(data) {
			// reset document size 
			CUSTOM_DOCUMENT_SIZE = 0;

			// Removes disabled attribute of save button
			enable_save_button($(saveBtn));//$(saveBtn).removeAttr('disabled');
			
			// While attaching document is from existing documenst list, no need of form verification.
			if(form_id)
			{
				$('#' + form_id).find("#network_type").val("");
				$('#' + form_id).find('#network_type').closest(".controls").find(".icon-ok").css("display", "none");
				$('#' + form_id).find('#network_type').closest(".controls").find("div.link").css("background-color", "#FFFFFF");
				$('#' + form_id).find("#upload_url").val("");
				$('#' + form_id).find("#extension").val("");
				
				$('#' + form_id).each(function() {
					this.reset();
				});
			}
			
			//$('#' + modalId).find('span.save-status img').remove();
			if(form_id)
				$('#' + modal_id).modal('hide');
			
			var document = data.toJSON();
			add_recent_view(new BaseModel(document));
			
			// Updates data to timeline
			if (App_Contacts.contactDetailView
					&& Current_Route == "contact/"
							+ App_Contacts.contactDetailView.model.get('id')) {

				// Add model to collection. Disabled sort while adding and called
				// sort explicitly, as sort is not working when it is called by add
				// function
				
				
				/*
				 * Verifies whether the added document is related to the contact in
				 * contact detail view or not
				 */
				$.each(document.contacts, function(index, contact) {
					
					if (contact.id == App_Contacts.contactDetailView.model.get('id'))
					{
						if (documentsView && documentsView.collection)
						{
							if(documentsView.collection.get(document.id))
							{
								documentsView.collection.get(document.id).set(new BaseModel(document));
							}
							else
							{
								documentsView.collection.add(new BaseModel(document), { sort : false });
								documentsView.collection.sort();
							}
						}
						
							// Activates "Timeline" tab and its tab content in
							// contact detail view
							// activate_timeline_tab();
							//add_entity_to_timeline(data);
							/*
							 * If timeline is not defined yet, initiates with the
							 * data else inserts
							 */
							return false;
					}
				});
			} else if (company_util.isCompany()){
				company_util.updateDocumentsList(document,true);
			}
			else if (Current_Route == 'documents') {
				if (isUpdate)
					App_Documents.DocumentCollectionView.collection.remove(json);

				App_Documents.DocumentCollectionView.collection.add(data);

				App_Documents.DocumentCollectionView.render(true);

			}
			else if (App_Deal_Details.dealDetailView
					&& Current_Route == "deal/"
						+ App_Deal_Details.dealDetailView.model.id) {

			// Add model to collection. Disabled sort while adding and called
			// sort explicitly, as sort is not working when it is called by add
			// function
			
			
			/*
			 * Verifies whether the added document is related to the deal in
			 * deal detail view or not
			 */
			$.each(document.deals, function(index, deal) {
				
				if (deal.id == App_Deal_Details.dealDetailView.model.id)
				{
					if (dealDocsView && dealDocsView.collection)
					{
						if(dealDocsView.collection.get(document.id))
						{
							dealDocsView.collection.get(document.id).set(new BaseModel(document));
						}
						else
						{
							dealDocsView.collection.add(new BaseModel(document), { sort : false });
							dealDocsView.collection.sort();
						}
					}
					
						// Activates "Timeline" tab and its tab content in
						// contact detail view
						// activate_timeline_tab();
						//add_entity_to_timeline(data);
						/*
						 * If timeline is not defined yet, initiates with the
						 * data else inserts
						 */
						return false;
				}
			});
		}
		else if (Current_Route == "email-template-add" || Current_Route.indexOf("email-template") == 0) {
			$('#tpl-attachment-select').find('select').find('option:last').after("<option value="+document.id+" selected='selected'>"+document.name+"</option>");
			$('.add-tpl-attachment-confirm').trigger("click");
			App_Settings.navigate(Current_Route, {
					trigger : true
				});
		}
			else {
				App_Documents.navigate("documents", {
					trigger : true
				});
			}
		}
	});
}


function saveAttachmentBlobKey(blobKey,fileName)
{
	var el = $("#uploadAttachmentForm");
	$("#uploadAttachmentModal").modal('hide');
	$('#emailForm').find('#eattachment').css('display','block');
	$('#emailForm').find('#attachment_id').find("#attachment_fname").text(fileName);
	$('#emailForm').find('#eattachment_key').attr('value',blobKey);
	$('#emailForm').find('#eattachment_key').attr('name',"blob_key");
	$('#emailForm').find('#attachment-select').find('option:first').attr('selected', 'selected');
	var el = $('#emailForm').find(".attachment-document-select");
	$('#emailForm').find(".attachment-document-select").css('display','none');
}

$(function(){
	
	$('body').on('click', '.voice-mail-add', function(e){
		e.preventDefault();
		$("#uploadVoiceMailModal").modal('show');
	});
	
	$('body').on('show.bs.modal', '#uploadVoiceMailModal', function(e) {
		// Removes alert message of error related date and time.
		$('#' + this.id).find('.alert').css('display', 'none');		
		// Removes error class of input fields
		$('#' + this.id).find('.error').removeClass('error');
	});
	
	$('body').on('click', '.addFileLink', function(e) {
		e.preventDefault();
		$(this).closest('form').find('#error').html("");
		var form_id = $(this).closest('form').attr("id");
		var id = $(this).find("a").attr("id");
		if(id && id == "S3")
			var newwindow = window.open("upload-voice-mail.jsp?id="+ form_id +"&t=" + CURRENT_USER_PREFS.template +"&d=" + CURRENT_DOMAIN_USER.domain, 'name','height=310,width=500');
		if (window.focus){
			newwindow.focus();
		}
		return false;
	});
	
	$('body').on('click', '#voicemail_validate', function(e){
 		e.preventDefault();
 		var modal_id = $(this).closest('.voice-mail-modal').attr("id");
    	var form_id = $(this).closest('.voice-mail-modal').find('form').attr("id");
    	
    	if(!isValidForm('#' + form_id))
    		return false;
    			
    	// serialize form.
    	var json = serializeForm(form_id);
    	if(form_id == "uploadVoiceMaiForm")
    		saveVoiceMail(form_id, modal_id, this, json);
	});
    
    $("#uploadVoiceMaiForm").submit(function(e){
    	e.preventDefault();
    });
    
    
    //audio javascript controls
    
	$('body').on('click', '.audioPlay', function(e){
	   e.preventDefault();
//	   alert("audioPlay");
	   audio = $(this).find("audio");
	   $(this).addClass("audioPause");
	   $(this).removeClass("audioPlay");
	   $(this).find("i").removeClass("icon-play");
//	   $(this).find("i").addClass("icon-pause");
	   $(this).find("i").addClass("icon-stop");
	   audio.trigger('play');
	   var that = this;
	   audio.bind('ended', function(){
		   $(that).addClass("audioPlay");
		   $(that).removeClass("audioPause");
		   $(that).find("i").removeClass("icon-stop");
		   $(that).find("i").addClass("icon-play");
		});
   });
   
   $('body').on('click', '.audioPause', function(e){
	   e.preventDefault();
//	   alert("audioPause");
	   audio = $(this).find("audio");
	   $(this).addClass("audioPlay");
	   $(this).removeClass("audioPause");
//	   $(this).find("i").removeClass("icon-pause");
	   $(this).find("i").removeClass("icon-stop");
	   $(this).find("i").addClass("icon-play");
	   audio.trigger('pause');
	   audio.prop("currentTime",0);
   });
	
});//end of function


function saveVoiceMailFileURL(url, network, id)
{
	id = id.split("?id=")[1];
	var form_id = id.split("&")[0];
	
	// Saving extension of document
	var extension = url.split("?");
	if(url.match("audiofiles/"))
	{
		extension = extension[0];
		extension = extension.substring(extension.lastIndexOf("/")+1);
	}
	else 
		extension = "";
	
	$('#' + form_id).find("#extension").val(extension);
	$('#' + form_id).find("#network_type").val(network);
	var newUrl = url.substring(0, url.indexOf("?"));//removing query string
   	$('#' + form_id).find('#upload_url').val(newUrl);
   	$(".addFileLink").empty();
   	if(extension != "")
   		$(".addFileLink").html(extension);
}

function saveVoiceMail(form_id, modal_id, saveBtn, json)
{
	// Returns, if the save button has disabled attribute
	if ($(saveBtn).attr('disabled'))
		return;

	disable_save_button($(saveBtn));
	
	if(form_id)
	{
		if (!isValidForm('#' + form_id)) {
			enable_save_button($(saveBtn));
			return false;
		}
		
		var url = $('#' + form_id).find('#upload_url').val();
		if(url == "")
		{
			$('#' + form_id).find('#error').html('<div class="alert alert-danger">Sorry! Voice file not uploaded properly.</div>');
			enable_save_button($(saveBtn));
			return;
		}
	}
	
	var newVoiceMail = new Backbone.Model();
	newVoiceMail.url = 'core/api/voicemails';
	newVoiceMail.save(json, {
		success : function(data) {
		App_VoiceMailRouter.VoiceMailCollectionView.collection.add(data);
		App_VoiceMailRouter.VoiceMailCollectionView.render(true);
		enable_save_button($(saveBtn));
		
		if(form_id)
		{
			$('#' + form_id).find("#network_type").val("");
			$('#' + form_id).find("#upload_url").val("");
			$('#' + form_id).find("#extension").val("");
			$('#' + form_id).find(".addFileLink").empty();
			$('#' + form_id).find('#error').empty();
			$('#' + form_id).find(".addFileLink").html('<a href="#" id="S3"><i class="icon-plus-sign"></i> <span>Add File</span></a>');
			$('#' + form_id).each(function() {
				this.reset();
			});
			
			$('#' + modal_id).modal('hide');
		}
		
	}
	});
	
}

// Convert human date to epoch time
function getEpochTimeFromDate(selectedDate)
{
	var d = new Date(selectedDate);
	return getGMTTimeFromDate(d) / 1000;
}

/**
 * Returns GMT time.
 * 
 * @param date
 * @returns
 */
function getGMTTimeFromDate(date)
{
	var current_sys_date = new Date();
	date = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);

	// Adding offset to date returns GMT time
	return date.getTime();
}

// Get Timezone Abbreviation from Time
function GetTimezoneShort(now)
{
	// now is expected as a Date object
	if (now == null)
		return '';
	var str = now.toString();
	// Split on the first ( character
	var s = str.split("(");
	if (s.length == 2)
	{
		// remove the ending ')'
		var n = s[1].replace(")", "");
		// split on words
		var parts = n.split(" ");
		var abbr = "";
		for (i = 0; i < parts.length; i++)
		{
			// for each word - get the first letter
			abbr += parts[i].charAt(0).toUpperCase();
		}
		return abbr;
	}
}

// Convert epoch time to human time
function createNormalTime(slotTime)
{

	var counter = 0;

	var date = new Date(slotTime * 1000);

	var hr = date.getHours();
	var normHr = date.getHours();

	// Get mins
	var min = date.getMinutes();

	var result = new Array();

	// Make hrs in 12hr format
	if (hr > 12)
		normHr = hr - 12;
	else if (hr == 0)
		normHr = "12";

	// add 0 before hr if hr is less than 10, so hr will be 2 digit
	if (normHr < 10)
		result[counter++] = "0";

	result[counter++] = normHr;

	// add : in time
	result[counter++] = ":"

	// add 0 before min if min is less than 10, so min will be 2 digit
	if (min < 10)
		result[counter++] = "0";

	// add min in time
	result[counter++] = min;

	// Decide pm or am
	if (hr >= 12)
		result[counter++] = " pm";
	else
		result[counter++] = " am";

	return result.join('');
}

function getSelectedTimeFromDate(date)
{
	date = new Date(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
	return date.getTime();
}

function getConvertedTimeFromEpoch(epoch)
{
	// var dateVal = 1395184260;
	var date = moment.unix(epoch);
	var time = date.tz(SELECTED_TIMEZONE).format('hh:mm a');
	return time;
}

function getNormalBusinessHouts(hr)
{
	var hrs = hr;
	hr = hr.split(":")[0];
	var min = hrs.split(":")[1];
	if (parseInt(hr) == 0 || parseInt(hr) == 24)
		return "12:" + min + "am";
	if (parseInt(hr) >= 12 && parseInt(hr) <= 23)
		return getNormalTimeAMPM(hr) + ":" + min + "pm";
	else
		return parseInt(hr) + ":" + min + "am";
}

function getNormalTimeAMPM(hr)
{
	var name_json = { "12" : "12", "13" : "1", "14" : "2", "15" : "3", "16" : "4", "17" : "5", "18" : "6", "19" : "7", "20" : "8", "21" : "9", "22" : "10",
		"23" : "11" };

	if (name_json[hr])
		return name_json[hr];
	else
		return hr;
}

/**
 * in backend data stored as 0-6(mon-sun) in js 0-6(sun-sat)
 * 
 * @param day
 * @returns {Number}
 */
function convertWeekDayToArray(day)
{
	if (parseInt(day) >= 1 && parseInt(day) <= 6)
		return parseInt(day) - 1;
	if (parseInt(day) == 0)
		return 6;
}

function getTimezoneOffset(timezonename)
{

	return moment.tz.zone(SELECTED_TIMEZONE).offset(new Date().getTime());
}

// current date format is 2013-12-4
function getMidnightEpoch(current_date)
{

	if (CURRENT_DAY_OPERATION == true)
	{
		current_date_mozilla = getUnixTimeStampInSpecificTimezone();
	}
	if (!current_date)
	{
		current_date = current_date_mozilla;
	}
	var d = moment.tz(current_date, SELECTED_TIMEZONE).unix();
	return d;
}

function getUnixTimeStampInSpecificTimezone(timezone)
{
	var m = moment().tz(SELECTED_TIMEZONE);

	m.set('hour', 00);
	m.set('minute', 00);
	m.set('second', 00);
	m.set('millisecond', 00);
	return m.valueOf();
}


/**
 * gets the time
 * @param time
 * @param timezone
 * @param firstTimeLoading if {true} then loading from jsp page
 * @returns
 */
function getTimeInVisitorTimezone(time,timezone,firstTimeLoading)
{
	if(!timezone)
		timezone=$("#timezone-"+User_Id).html();
	var m = moment().tz(timezone);
	var hour=null;
	var min=null;
	var result=null;
	if(time){
		result=time.split(":")
		
	}
	if(result){
		hour=result[0];
		min=result[1];
	}
	m.set('hour', parseInt(hour));
	m.set('minute', parseInt(min));
	m.set('second', 00);
	m.set('millisecond', 00);
	if(firstTimeLoading==true){
		return toTimeZoneFirstTimeLoading(m.valueOf());
	}
	return toTimeZone(m.valueOf());
}



/**
 * 
 * @param time  while loading jsp time will be 09:00-18:00 format.
 * @param timezone  we are change @agile user 09:00 to Visitor time @Us/eastrn 
 * @returns {String}
 */
function getTimeInVisitorTimezoneWhileLoading(time,timezone){
	var workhours=null;
	var times=null;
	if(time!="Today is holiday")
		times=time.split("-");
	if(times){
		workhours=getTimeInVisitorTimezone(times[0],timezone,true)+" - "+getTimeInVisitorTimezone(times[1],timezone,true);
	}
	else{
		workhours="Today is holiday";
	}
	return workhours;
}



/**
 * 
 * @param time  after click on date picker we are changing time to visitor time
 * @param zone
 * @returns
 */
function toTimeZone(time, zone) {
	
	return moment.tz(time, SELECTED_TIMEZONE).format('hh:mm a')
}


/**
 * converts the @agile user time to vistor time
 * @param time
 * @param zone
 * @returns
 */
function toTimeZoneFirstTimeLoading(time, zone) {
	
	return moment.tz(time, jstz.determine().name()).format('hh:mm a');
}

function getVisitorWhileLoading(){
	return jstz.determine().name(); 
}


function updateUserBusinessHoursInVisitorTimezone(dates){
	
	if(!dates)
		dates=selecteddate;
	
	for(var k=0;k<=multi_user_ids.length - 1;k++){
		var array=business_hours_array[k];
		var s=array[convertWeekDayToArray(new Date(dates).getDay())];
		if(s.isActive){
			$("#workhours-"+multi_user_ids[k]).html(getTimeInVisitorTimezone(s.timeFrom)+" - "+getTimeInVisitorTimezone(s.timeTill));
		}
		else{
			$("#workhours-"+multi_user_ids[k]).html("No working hours");
		}
	}
}$(function()
{
	// Total available slots on selected date with selecetd slot
	var Available_Slots = null;
	var selected_user_name = null;
	var MIDNIGHT_START_TIME = null;
	var MIDNIGHT_END_TIME = null;

	// Select slot duration 60/30/15min
	$('body').on('click', '.selected_meeting_time', function(e)
	{
		// e.preventDefault();

		$("#details").empty();
		Selected_Time = $(this).attr('data');
		$(".show_slots").find('input:radio').attr('checked', false);
		$(this, [
			'input:radio'
		]).attr('checked', true);
		appointmenttype = $('input[name="selected_meeting_time"]:checked').val();

		$(".activemin").removeClass("activemin");
		$(this).find('.minutes').addClass("activemin");

		// Make next part enable
		$('.segment2').removeClass('me-disable');
		$(".segment2").fadeIn("slow");
		$('#one').addClass('green-bg').html('<i class="fa fa-check"></i>');

		autoscrol(".segment2");

		var isFirefox = typeof InstallTrigger !== 'undefined';
		if (isFirefox)
		{
			$('#datepick').DatePickerSetDate(current_date_mozilla, true);
		}
		$('.checkbox-main-grid').html('<img class="loading-img" src="../../img/21-0.gif" style="width: 40px;margin-left: 216px;"></img>');
		if (!selecteddate)
		{
			selecteddate = new Date();
			CURRENT_DAY_OPERATION = true;

		}
		if (selecteddate)
		{

			get_slots(selecteddate, Selected_Time);
		}

		// Reset all
		// resetAll();
	});

	// Confirm filled info with selected slot
	$('#confirm').click(function(e)
	{
		e.preventDefault();
		// Save scheduled slot
		save_web_event('addEventForm', this);
	});

	// Only single slot selection is allowed
	$('body').on('click', '.selected-slot', function(e)
	{
		var currentId = $(this).attr('id');

		$('.selected-slot').each(function()
		{
			if ($(this).attr('id') != currentId)
				$(this).attr("checked", false);
		});

		// Make next part enable
		enableSegment3();

		$(".segment3").fadeIn("slow");
		$("#confirm").show();
		$('#two').addClass('green-bg').html('<i class="fa fa-check"></i>');
		autoscrol(".segment3");

	});

	$('body').on('click', '#multi-user-avatar', function(e)
	{
		$(".thumbnail").css("background", "none");
		$(this).css("background", "#4A90E2");
		$('#users_div').addClass('green-bg').html('<i class="fa fa-check"></i>');
		var domainUser_id = $(this).attr('data');
		if (domainUser_id != User_Id)
		{
			resetToPrevious();
			if (!isEmpty(mapobject))
			{
				SELECTED_DOMAIN_USER = mapobject[domainUser_id];

				User_Id = SELECTED_DOMAIN_USER['id'];
				Agile_User_Id = SELECTED_DOMAIN_USER['agile_user_id'];
				User_Name = selected_user_name = SELECTED_DOMAIN_USER['name'];
				meeting_duration = SELECTED_DOMAIN_USER['meeting_durations'];
				meeting_types = SELECTED_DOMAIN_USER['meeting_types'];
				BUFFERTIME = SELECTED_DOMAIN_USER['buffer_time'];

				if (meeting_types[0] != "")
				{
					$(".meetingtypes").show();
					$(".meetingtypes").empty();
					$(".meetingtypes").append("<option selected disabled>Meeting Type</option>");
					for (var i = 0; i < meeting_types.length; i++)
					{
						$(".meetingtypes").append("<option value='" + meeting_types[i] + "'>" + meeting_types[i] + "</option>");
					}
				}
				else
					$(".meetingtypes").hide();

				slot_details = SELECTED_DOMAIN_USER['slot_details'];
				$('.show_slots').hide();

				getSlotDurations();
				$(".segment1").fadeIn("slow");
				$(".panel-body").height(parseInt(getPanelBodyMaxHeight()) + 26);
				autoscrol(".segment1");
			}

		}

	});

	$('#user_timezone').change(function()
	{

		SELECTED_TIMEZONE = $('#user_timezone').val();
		$(".timezone1").text(SELECTED_TIMEZONE);
		$('.timezone1').show();
		$("#hidetimezone").addClass("hide");

		if (!selecteddate || !Selected_Time)
			return;
		$("#current_local_time").html("Current Time: " + getConvertedTimeFromEpoch(new Date().getTime() / 1000));
		$('.checkbox-main-grid').html('<img class="loading-img" src="../../img/21-0.gif" style="width: 40px;margin-left: 216px;"></img>');
		get_slots(selecteddate, Selected_Time);
	});

	$('.timezone1').click(function()
	{
		$("#hidetimezone").removeClass("hide");
		$('.timezone1').hide();
	});

	$('#user_timezone').blur(function()
	{
		if (SELECTED_TIMEZONE == $('#user_timezone').val())
		{
			$(".timezone1").text(SELECTED_TIMEZONE);
			$('.timezone1').show();
			$("#hidetimezone").addClass("hide");
		}
	});

	function autoscrol(divclass)
	{

		console.log($(divclass).offset().top);

		$("body,html").animate({ scrollTop : $(divclass).offset().top }, 1000);

	}

	function isEmpty(o)
	{
		for ( var p in o)
		{
			if (o.hasOwnProperty(p))
			{
				return false;
			}
		}
		return true;
	}

});
// On change of date, change right column above available slot box
function change_availability_date(selected_date)
{

	var date = new Date(selected_date);

	$('.availability').html("Availability on " + date.getDayName() + ", " + date.getMonthName() + ", " + date.getDate());
}

// Get slot details time n description
function getSlotDurations()
{

	if (multiple_schedule_ids)
	{
		fillSlotDetails();
		return;
	}
	else if (single_user_mapobject[User_Id].length > 0)
	{
		fillSlotDetails(single_user_mapobject[User_Id]);
		return;
	}
	// Send request to get slot details time n description
	var initialURL = '/core/api/webevents/calendar/getslotdetails?userid=' + User_Id;
	$
			.getJSON(
					initialURL,
					function(data)
					{
						var slots_data = data;
						var slot_data_temp = [];
						if (slot_array && slot_array.length > 0)
						{
							for (var i = 0; i < slot_array.length; i++)
							{
								if ((parseInt(slot_array[i]) - 1) < data.length && parseInt(slot_array[i]) != 0)
								{

									slot_data_temp[i] = slot_array[i];
								}
							}
							if (slot_data_temp.length > 0)
							{
								slot_array = [];
								slot_array = slot_data_temp;
							}
							else
							{
								$('.segment1')
										.append(
												'<div class="col-sm-12" align="center"><p class="lead" style="color: #777;font-size: 19px;text-align: center;font-weight:normal">please enter valid slot number </p> </div>');
								return;

							}
						}
						if (slot_array && data.length >= slot_array.length && slot_array.length > 0)
						{
							data = [];
							var j = 0;
							for (var i = 0; i < slot_array.length; i++)
							{

								if ((parseInt(slot_array[i]) - 1) < slots_data.length)
								{
									data[j] = slots_data[parseInt(slot_array[i]) - 1];
									j++;
								}

							}
						}
						if (data.length == 3)
						{
							for ( var slotDetail in data)
							{
								var json = JSON.parse(data[slotDetail]);
								$('.segment1')
										.append(
												'<div class="col-sm-4 show_slots"><p title="' + json.title + '" class="choose timeslot-view" data="' + json.time + '"><span class="minutes">' + json.time + ' mins</span><br />' + addDotsAtEnd(json.title) + '</p></div>');
							}
							$('.segment1').append('<div class="clearfix"></div>');
						}
						if (data.length == 2)
						{
							for ( var slotDetail in data)
							{
								var json = JSON.parse(data[slotDetail]);
								$('.segment1')
										.append(
												'<div class="col-sm-5 col-md-4 show_slots" style="margin-left: 99px;"><p title="' + json.title + '" class="choose" data="' + json.time + '"><span class="minutes">' + json.time + ' mins</span><br />' + addDotsAtEnd(json.title) + '</p></div>');
							}
							$('.segment1').append('<div class="clearfix"></div>');
						}
						if (data.length == 1)
						{
							for ( var slotDetail in data)
							{
								var json = JSON.parse(data[slotDetail]);
								$('.segment1')
										.append(
												'<div class="col-sm-12 show_slots" align="center"><p title="' + json.title + '" class="choose" data="' + json.time + '"><span class="minutes">' + json.time + ' mins</span><br />' + addDotsAtEnd(json.title) + '</p></div>');
							}
						}
					});
}

// Enable segment 3 after selection of slot
function enableSegment3()
{
	// Make input enable
	$('.me-disable').removeAttr("disabled");

	// Make next part enable
	$('.me-disable').removeClass('me-disable');
}

// Reset all, set current date in calendar, clear all slots, clear form and make
// segment 3 disable
function resetAll()
{
	// Get current date
	var newDate = new Date();
	var currMonth = (newDate.getMonth() + 1);
	if (currMonth < 10)
		currMonth = "0" + currMonth;
	var currentDate = newDate.getFullYear() + '-' + currMonth + '-' + newDate.getDate();

	// Set current date as selected date
	Selected_Date = currentDate;

	// Set current date in calendar
	$('#datepick').DatePickerSetDate(Selected_Date, true);

	// Default date in right column above available slot box
	change_availability_date(Selected_Date);

	// Empty div where all slots listed
	$('.checkbox-main-grid').html('');

	// Clear form
	document.getElementById("addEventForm").reset();

	Available_Slots = null;
}

// Send selected slot and selected date and get available slots from all sync
// calendar.
function get_slots(s_date, s_slot)
{
	MIDNIGHT_START_TIME = null;
	MIDNIGHT_END_TIME = null;
	var selected_epoch_start = getSelectedTimeFromDate(s_date);
	// Current timezone name
	var timezoneName = SELECTED_TIMEZONE;

	// selected date in current epoch time
	var epochTime = getEpochTimeFromDate(s_date); // milliseconds

	var d = new Date(s_date);
	var secs = epochTime + d.getSeconds() + (60 * d.getMinutes()) + (60 * 60 * d.getHours());
	// gets the midnight of selected date. selected date will be stored in
	// global variable i.e current_date_mozilla
	MIDNIGHT_START_TIME = selected_epoch_start = getMidnightEpoch();
	MIDNIGHT_END_TIME = selected_epoch_end = selected_epoch_start + 86400;
	var start_time = getEpochTimeFromDate(d);
	d.setDate(d.getDate() + 1)
	var end_time = getEpochTimeFromDate(d);
	var timezone = getTimezoneOffset();

	// Send request to get available slot
	var initialURL = '/core/api/webevents/calendar/getslots?&user_id=' + User_Id + '&date=' + s_date + '&slot_time=' + s_slot + "&timezone_name=" + timezoneName + "&epoch_time=" + epochTime + "&startTime=" + selected_epoch_start + "&endTime=" + selected_epoch_end + "&agile_user_id=" + Agile_User_Id + "&timezone=" + timezone;
	$.getJSON(initialURL, function(data)
	{

		// No slots available for selected day
		if (data.length == 0)
		{
			displayNoSlotsMsg();
			return;
		}

		Available_Slots = data;

		// Update in UI
		displaySlots();
	});
}

// Add no slots available msg in grid of checkbox
function displayNoSlotsMsg()
{
	// Empty div where all slots listed, to display new slots
	$('.checkbox-main-grid').html('');

	var date = new Date(selecteddate);

	$('.availability').html("No slots available for " + date.getDayName() + ", " + date.getMonthName() + ", " + date.getDate());

	// Add msg
	// $('.checkbox-main-grid').append('<label for="no-slots"
	// style="margin-left:112px;">Slots are not available for selected
	// day.</label>');
}

// Add slots in grid checkbox in checkbox list
function displaySlots()
{
	var i = 0, j = 0, k = 0;

	// Empty div where all slots listed, to display new slots
	$('.checkbox-main-grid').html('');

	console.log(Available_Slots.length);
	var after_now = [];
	var date = new Date();
	if (BUFFERTIME == null)
	{
		BUFFERTIME = single_user_mapobject['buffer_time'];
	}
	var current_date_time = date.getTime() + parseInt(BUFFERTIME);
	for (var s = 0; s < Available_Slots.length; s++)
	{
		if (Available_Slots[s][0] * 1000 > parseInt(current_date_time))
		{

			after_now.push(Available_Slots[s]);
		}

	}
	console.log(after_now.length);
	Available_Slots = "";
	Available_Slots = after_now;

	if (Available_Slots.length == 0)
	{
		displayNoSlotsMsg();
		return;
	}

	change_availability_date(selecteddate);
	// Number of row
	var numRow = Available_Slots.length / 5;

	numRow++;

	var addList = function()
	{
		var listSlot = "";
		for (i = 0; i <= numRow; i++)
		{
			if (k < Available_Slots.length)
				listSlot = listSlot + '<li><input class="selected-slot" type="checkbox" id="startTime_' + k + '"name="startTime_' + k + '" value="' + Available_Slots[k][0] + '" /><label for="' + Available_Slots[k][0] + '">' + getConvertedTimeFromEpoch(Available_Slots[k][0]) + '</label></li>';

			k++;
		}
		return listSlot;
	}

	// 5 columns
	for (j = 0; j < 5; j++)
	{
		// Add number of rows, slots with time conversion
		$('.checkbox-main-grid').append('<li><ul class="checkbox-grid">' + addList() + '<ul><li>');
	}
}

// Validates the form fields
function isValid(formId)
{

	$(formId).validate();
	return $(formId).valid();
}

/*
 * // Validates phone number function validatePhone(txtPhone) { var a =
 * document.getElementById(txtPhone).value; var filter = /^[0-9-+]+$/; if
 * (filter.test(a)) return true; else return false; }​
 */

// Save selected slot with user details
function save_web_event(formId, confirmBtn)
{
	// Check if the form is valid
	if (!isValid('#' + formId))
	{
		$('#' + formId).find("input").focus();
		return false;
	}

	// Get details
	var data = $('#' + formId).serializeArray();

	// Make json
	var web_calendar_event = {};
	$.each(data, function()
	{
		if (web_calendar_event[this.name])
		{
			if (!web_calendar_event[this.name].push)
			{
				web_calendar_event[this.name] = [
					web_calendar_event[this.name]
				];
			}
			web_calendar_event[this.name].push(this.value || '');
		}
		else
		{
			web_calendar_event[this.name] = this.value || '';
		}
	});

	// Add selected parameter which are out of form
	web_calendar_event["name"] = appointmenttype;
	// web_calendar_event["date"] = Selected_Date;
	web_calendar_event["slot_time"] = Selected_Time;
	web_calendar_event["domainUserId"] = User_Id;
	web_calendar_event["agileUserId"] = Agile_User_Id;
	web_calendar_event["selectedSlotsString"] = [];
	web_calendar_event["timezone"] = SELECTED_TIMEZONE;
	web_calendar_event["midnight_start_time"] = MIDNIGHT_START_TIME;
	web_calendar_event["midnight_end_time"] = MIDNIGHT_END_TIME;
	web_calendar_event["timezone_offset"] = getTimezoneOffset();
	// Get selected slots in UI from available slots list.
	var i = 0;
	for ( var prop in web_calendar_event)
	{
		if (prop.indexOf("startTime") != -1)
		{
			var res = prop.split("_");

			var result = {};
			result["start"] = Available_Slots[res[1]][0];
			result["end"] = Available_Slots[res[1]][1];
			web_calendar_event["selectedSlotsString"][i] = result;
			i++;

			var dd = new Date(result["start"] * 1000);
			web_calendar_event["date"] = dd.toString();
		}
	}

	if (web_calendar_event["selectedSlotsString"].length == 0)
	{
		alert("Please select appointment time.");
		return false;
	}
	$('#confirm').attr('disabled', 'disabled');
	$('#three').addClass('green-bg').html('<i class="fa fa-check"></i>');
	// Add selected slots to input json
	web_calendar_event["selectedSlotsString"] = JSON.stringify(web_calendar_event["selectedSlotsString"]);

	// Send request to save slot, if new then contact, event
	$
			.ajax({
				url : '/core/api/webevents/calendar/save',
				type : 'PUT',
				contentType : 'application/json; charset=utf-8',
				data : JSON.stringify(web_calendar_event),
				dataType : '',
				complete : function(res, status)
				{

					console.log(status);
					// style="border-bottom: 1px solid #ddd;"
					var dates = JSON.parse(web_calendar_event.selectedSlotsString);
					var d = dates[0];
					var start = convertToHumanDateUsingMoment("", d.start);

					if (status == "success" && res.responseText != "slot booked")
					{
						$('#mainwrap').addClass("appointment-wrap");
						var appointment_success_img1 = "/img/appointment_confirmation.png";
						var temp = '<div style="margin: 26px;font-size:15px;">'

						+ '<div id="info" ><h3 style="border-bottom: 1px solid #ddd;padding-bottom:8px;margin-bottom:15px;"><img style="margin-right: 8px;margin-top: -4px;" src=' + appointment_success_img1 + '><b>Appointment Scheduled</b></h3>' + '<p >Your appointment (' + appointmenttype + ') has been scheduled with <b>' + User_Name + '</b> for ' + web_calendar_event.slot_time + ' mins on ' + start + '. </div>' + '<div class="row">' + '<div class="col-md-12">' + '<div class="row">' + '<div class="col-md-12">' + '<div class="left">' + '<a class="btn btn-primary" id="create_new_appointment" style="margin-top:20px;">Schedule Another Appointment</a>' + '</div>' + '</div>' + '</div>' + '</div>' + '<div align="right" style="position: absolute;right: 280px;bottom: -80px;">' + '<span style="display: inherit;font-style: italic; font-family: Times New Roman; font-size: 10px; padding-right: 71px;">Powered by</span> <a href="https://www.agilecrm.com?utm_source=powered-by&amp;medium=event_scheduler&amp;utm_campaign=' + domainname + '" rel="nofollow" target="_blank"><img src="https://s3.amazonaws.com/agilecrm/panel/uploaded-logo/1383722651000?id=upload-container" alt="Logo for AgileCRM" style="border: 0;background: white;padding: 0px 10px 5px 2px;height: auto;width: 135px;"></a>' + '</div>'

						resetAll();

						$(".container").html(temp);

					}
					else if (res.responseText == "slot booked")
					{
						alert("Looks like this slot is booked already. Please try another one.");
						get_slots(selecteddate, Selected_Time);
						$('#confirm').attr('disabled', false);
					}

					else
					{
						alert("Something went wrong as your appointment was not scheduled. Please try again in few hours. Error: " + res.statusText);
						resetAll();
						location.reload(true);
					}

				} });
}

function convertToHumanDate(format, date)
{

	if (!format)
		format = "ddd, mmmm d yyyy, h:MM TT";

	if (!date)
		return;

	if ((date / 100000000000) > 1)
	{
		return new Date(parseInt(date)).format(format, 0);
	}
	// date form milliseconds
	var d = new Date(parseInt(date) * 1000).format(format);

	return d
}

function convertToHumanDateUsingMoment(format, date)
{

	if (!format)
		format = "ddd, MMM DD YYYY, hh:mm A";

	if (!date)
		return;
	var date = moment.unix(date);
	var time_s = date.tz(SELECTED_TIMEZONE).format(format);
	return time_s;
}

$('body').on('click', '#create_new_appointment', function(e)
{
	// reloads the page
	location.reload(true);

});

/**
 * if value morethan 50 adds .. at the end
 */
function addDotsAtEnd(title)
{
	if (title)
	{
		if (title.length > 10)
		{
			var subst = title.substr(0, 10);
			subst = subst + "....";
			return subst;
		}
	}

	return title;
}

function resetToPrevious()
{
	$("#one").html("2");
	$("#two").html("3");
	$("#three").html("4");
	$('#two').removeClass("green-bg").html('3');
	$('#one').removeClass("green-bg").html('2');
	$('#three').removeClass("green-bg").html('4');
	$("#confirm").hide();
	$(".segment3").hide();
	$(".segment2").hide();

}
function fillSlotDetails(slot_durations_one_user)
{
	var slots_data = data = slot_details;
	if (slot_durations_one_user)
	{
		slots_data = data = slot_durations_one_user;
	}
	var slot_data_temp = [];
	if (slot_array && slot_array.length > 0)
	{
		for (var i = 0; i < slot_array.length; i++)
		{
			if ((parseInt(slot_array[i]) - 1) < data.length && parseInt(slot_array[i]) != 0)
			{

				slot_data_temp[i] = slot_array[i];
			}
		}
		if (slot_data_temp.length > 0)
		{
			slot_array = [];
			slot_array = slot_data_temp;
		}
		else
		{
			$('.segment1')
					.append(
							'<div class="col-sm-12" align="center"><p class="lead" style="color: #777;font-size: 19px;text-align: center;font-weight:normal">please enter valid slot number </p> </div>');
			return;

		}
	}
	if (slot_array && data.length >= slot_array.length && slot_array.length > 0)
	{
		data = [];
		var j = 0;
		for (var i = 0; i < slot_array.length; i++)
		{

			if ((parseInt(slot_array[i]) - 1) < slots_data.length)
			{
				data[j] = slots_data[parseInt(slot_array[i]) - 1];
				j++;
			}

		}
	}
	MEETING_DURATION_AND_NAMES = data = generateNewDataArray(data);
	var dataLength = 12 / data.length;
	for ( var slotDetail in data)
	{
		var json = JSON.parse(data[slotDetail]);
		var meeting_names = json.meeting_names;
		var temp = '';

		for ( var meeting_name in meeting_names)
		{
			temp += '<div class="radio"><label><input class="c-p selected_meeting_time" type="radio" data="' + json.time + '" name="selected_meeting_time" value="' + meeting_names[meeting_name] + '"><i></i>' + meeting_names[meeting_name] + '</label></div>';
		}
		var select = '<div class="panel panel-default">' + '<div class="panel-heading font-bold">' + json.time + ' mins</div>' + '<div class="panel-body">' + '<form class="bs-example form-horizontal">' + '<div class="form-group" style="margin-left:7px;">' + temp + '</div></form></div></div>';
		$('.segment1').append('<div class="col-sm-' + dataLength + ' show_slots"><p class="timeslot-view">' + select + '</p></div>');
	}
	if(multi_user_ids.length<2)
	$(".panel-body").height(parseInt(getPanelBodyMaxHeight()) + 26);
	$('.segment1').append('<div class="clearfix"></div>');

}

function getPanelBodyMaxHeight()
{
	var max = 0;
	$('.panel-body').each(function()
	{
		var height = $(this).height();
		if (height > max)
		{
			max = height;
		}
	});
	return max;
}

function generateNewDataArray(data)
{
	var finalJsonArray = [];
	for ( var slotDetail in data)
	{
		var json = JSON.parse(data[slotDetail]);

		var json_meeting_names = [];
		if (json.title.indexOf(",") > -1)
		{
			json_meeting_names = json.title.split(",");
		}
		else
		{
			json_meeting_names.push(json.title);
		}
		if (json_meeting_names.length > 0)
		{
			var newJson = {};
			newJson.time = json.time;
			newJson.meeting_names = json_meeting_names;
			finalJsonArray.push(JSON.stringify(newJson));

		}
		else
		{
			finalJsonArray.push(JSON.stringify(json));
		}

	}
	return finalJsonArray;
}
// Global variables
var _agile_contact; // Agile contact object
var _agile_webrules; // Array of agile web rule objects

// Rules object with methods, to verify the conditions
var rules = {

	// To check if tags are equal
	tags_in : function(webrules, _agile_contact) {
		if (webrules.tags_in && _agile_contact) {
			var flag = 0;
			var i = webrules.tags_in.length;
			var j = _agile_contact.tags.length;
			if (i <= j) {
				for ( var k = 0; k < i; k++) {
					for ( var l = 0; l < j; l++) {

						// Check if tags from webrules match with contact tags
						if (webrules.tags_in[k] === _agile_contact.tags[l]) {
							flag++;
						}
					}
				}
			}
			if (flag == i && flag !== 0 && i !== 0)
				return true;
		}
	},

	// To check if tags are not equal
	tags_out : function(webrules, _agile_contact) {
		if (_agile_contact && webrules.tags_out) {
			var count = 0;
			var i = webrules.tags_out.length;
			var j = _agile_contact.tags.length;
			for ( var k = 0; k < i; k++) {
				for ( var l = 0; l < j; l++) {

					// Check if tags from webrules match contact tags
					if (_agile_contact.tags[l] !== webrules.tags_out[k]) {
						count++;
					}
				}
			}
			if (count == i * j && count !== 0 && i !== 0 && j !== 0)
				return true;
		}
	},

	// To check if tags match and verify time conditions like tags created
	// after, before, in the last specified days
	tags_time : function(webrules, _agile_contact) {
		if (webrules.tags_time && _agile_contact) {
			var f = 0;
			var i = webrules.tags_time.tags.length;
			var j = _agile_contact.tagsWithTime.length;
			var current_time = new Date().getTime();
			if (i <= j) {
				for ( var d = 0; d < i; d++) {
					for ( var h = 0; h < j; h++) {
						if (webrules.tags_time.tags[d] == _agile_contact.tagsWithTime[h].tag) {
							if ((webrules.tags_time.condition == "LAST" && (0 <= (current_time - _agile_contact.tagsWithTime[h].createdTime) && (current_time - _agile_contact.tagsWithTime[h].createdTime) <= (webrules.tags_time.time * 86400000)))
									|| (webrules.tags_time.condition == "BEFORE" && (webrules.tags_time.time >= _agile_contact.tagsWithTime[h].createdTime))
									|| (webrules.tags_time.condition == "AFTER" && (webrules.tags_time.time <= _agile_contact.tagsWithTime[h].createdTime))
									|| (webrules.tags_time.condition == "EQUALS" && (webrules.tags_time.time <= _agile_contact.tagsWithTime[h].createdTime && _agile_contact.tagsWithTime[h].createdTime <= (webrules.tags_time.time + 86400000)))
									|| (webrules.tags_time.condition == "BETWEEN" && (webrules.tags_time.time_min <= _agile_contact.tagsWithTime[h].createdTime && _agile_contact.tagsWithTime[h].createdTime <= webrules.tags_time.time_max))) {
								f++;
							}
						}
					}
				}
			}
			if (f == i && f !== 0 && i !== 0)
				return true;
		}
	},

	// To check if score greater than min_score
	min_score : function(webrules, _agile_contact) {
		if (_agile_contact && webrules.min_score
				&& _agile_contact.lead_score >= webrules.min_score)
			return true;
	},

	// To check if score less than max_score
	max_score : function(webrules, _agile_contact) {
		if (_agile_contact && webrules.max_score
				&& _agile_contact.lead_score <= webrules.max_score)
			return true;
	},

	// To check if referrer url matches with url in webrules
	referrer_is : function(anon_webrules) {
		if (anon_webrules.referrer_is === document.referrer)
			return true;
	},

	// To check if referrer url matches with specified string in webrules
	referrer_matches : function(anon_webrules) {
		var url = document.referrer;
		if (url.indexOf(anon_webrules.referrer_matches) !== -1)
			return true;
	},

	// To check current page matches with given url in webrules
	page_view_is : function(anon_webrules) {
		if (anon_webrules.page_view_is === document.location.href)
			return true;
	},

	// To check if current page url matches with given string in webrules
	page_view_matches : function(anon_webrules) {
		var url = document.location.href;
		if (url.indexOf(anon_webrules.page_view_matches) !== -1)
			return true;
	},

	// To check if session is new or ongoing
	session_type : function(anon_webrules) {
		if (anon_webrules.session_type === "first")
			return agile_session.new_session;
		if (anon_webrules.session_type === "ongoing")
			return !agile_session.new_session;
	},

	// To check if visit is first visit or repeat
	visit_type : function(anon_webrules) {
		if (anon_webrules.visit_type === "repeat")
			return !agile_guid.new_guid;
		if (anon_webrules.visit_type === "first")
			return agile_guid.new_guid;
	},

	// To check if contact properties match or not
	contact_properties_in : function(webrules, _agile_contact) {
		if (_agile_contact && webrules.contact_properties_in) {
			var flag = 0;
			var l = webrules.contact_properties_in.length;
			var k = _agile_contact.properties.length;
			for ( var r = 0; r < l; r++) {
				for ( var s = 0; s < k; s++) {

					// Check if contact properties from webrules match with
					// contact properties
					if (webrules.contact_properties_in[r].name === _agile_contact.properties[s].name
							&& webrules.contact_properties_in[r].value === _agile_contact.properties[s].value) {
						flag++;
					}
				}
			}
			if (flag == l && flag !== 0 && l !== 0)
				return true;
		}
	},

	// To check if contact properties do not match
	contact_properties_out : function(webrules, _agile_contact) {
		if (_agile_contact && webrules.contact_properties_out) {
			var count = 0;
			var l = webrules.contact_properties_out.length;
			var k = _agile_contact.properties.length;
			for ( var g = 0; g < l; g++) {
				for ( var h = 0; h < k; h++) {

					// Check if contact properties from webrules match with
					// contact properties
					if (webrules.contact_properties_out[g].name === _agile_contact.properties[h].name
							&& webrules.contact_properties_out[g].value !== _agile_contact.properties[h].value) {
						count++;
					}
				}
			}
			if (count == l && count !== 0 && l !== 0 && k !== 0)
				return true;
		}
	},

	// To check contact created time is after, before or in the last few days
	contact_time : function(webrules, _agile_contact) {
		if (_agile_contact && webrules.contact_time) {
			var current_time = new Date().getTime();
			var created_time = (_agile_contact.created_time * 1000);
			var dif = (current_time - created_time);
			if ((webrules.contact_time.condition == "LAST" && (0 <= dif && dif <= (webrules.contact_time.time * 86400000)))
					|| (webrules.contact_time.condition == "AFTER" && (webrules.contact_time.time <= created_time))
					|| (webrules.contact_time.condition == "BEFORE" && (webrules.contact_time.time >= created_time))
					|| (webrules.contact_time.condition == "ON" && (webrules.contact_time.time <= created_time && created_time <= (86400000 + webrules.contact_time.time)))
					|| (webrules.contact_time.condition == "BETWEEN" && (webrules.contact_time.time_min <= created_time && created_time <= webrules.contact_time.time_max)))
				return true;
		}
	}
};

// Modal API function to show modal

function show_modal(modal_data, modal_options, modal_callback) {

	var SM = new SimpleModal(modal_options);
	SM.addButton("Ok", "simple_modal_btn primary", function() {

		// Callback for confirm action of modal
		if (modal_options.form_id && (document.id(modal_options.form_id))) {
			var contact = {};
			var collection = document.id('modal-form');
			for ( var i = 0; i < collection.length; i++) {
				if (collection[i].name.toLowerCase() == "firstname"
						|| collection[i].name.toLowerCase() == "first_name"
						|| collection[i].name.toLowerCase() == "first name"
						|| collection[i].name.toLowerCase() == "name"
						|| collection[i].name.toLowerCase() == "first") {
					contact.first_name = collection[i].value;
				}
				if (collection[i].name.toLowerCase() == "lastname"
						|| collection[i].name.toLowerCase() == "last_name"
						|| collection[i].name.toLowerCase() == "last name"
						|| collection[i].name.toLowerCase() == "last") {
					contact.last_name = collection[i].value;
				}
				if (collection[i].name.toLowerCase().indexOf("email") != -1) {
					contact.email = collection[i].value;
				}
			}
			_agile.create_contact(contact, {
				success : function(data) {
					_agile.set_email(contact.email);
					_agile.add_tag('signup', {
						success : function() {
							console.log("tag added")
						},
						error : function() {
							console.log("error");
						}
					});
					console.log("success");
				},
				error : function(data) {
					console.log("error");
				}
			});
		}
		this.hide();
	});

	// If modal is type confirmation adding cancel button
	if (modal_options.show_btn_cancel) {
		SM.addButton("Cancel", "simple_modal_btn");
	}

	// Assign modal type, title, contents, callback

	SM.show({
		"model" : "modal",
		"title" : modal_data.title,
		"contents" : function() {
			if (modal_options.form_id && (document.id(modal_options.form_id)))
				return '<form id=modal-form>'
						+ document.id(modal_options.form_id).innerHTML
						+ '</form>';
			else
				return modal_data.contents;
		},
	});
}

// Noty API function to show noty

function show_noty(noty_data, noty_options, noty_callback) {
	head.js("lib/noty/jquery.noty.js", "/lib/noty/layouts/" + noty_options.position+".js",
			"lib/noty/themes/default-custom.js", function() {
					
				// Format noty_callback to noty API
				var call_back = {};
				if (noty_callback && typeof (noty_callback) === "function")
					call_back.onClose = noty_callback;

				// Assign noty text, type, theme, callback etc
				var n = noty({
					text : noty_data,
					
					type : noty_options.type,
					dismissQueue : noty_options.dismiss_queue,
					layout : noty_options.position,
					theme : noty_options.theme,
					callback : call_back,
					timeout : 2000
				});
			});
}

function execute_action(modal_data, modal_options, modal_callback, noty_data,
		noty_options, noty_callback, add_campaign_id, rm_campaign_id,
		add_score, rm_score, add_tags, rm_tags, email) {
	// If webrule action is modal
	if (modal_options.btn_ok) {
		show_modal(modal_data, modal_options, modal_callback);
	}

	// If webrule action is noty
	if (noty_options.type) {
		show_noty(noty_data, noty_options, noty_callback);
	}

	// If webrule action is add campaign
	if (add_campaign_id.length !== 0 && email) {
		for ( var u = 0; u < add_campaign_id.length; u++) {
			_agile.add_campaign({
				"id" : add_campaign_id[u]
			}, {
				success : function() {
					console.log("campaign assigned");
				},
				error : function() {
					console.log("error in assigning campaign");
				}
			}, email);
		}
	}

	// If webrule is to add tag
	if (add_tags.length !== 0 && email)
		_agile.add_tag(add_tags.toString(), {
			success : function() {
				console.log("tags added");
			},
			error : function() {
				console.log("failed to add tags");
			}
		}, email);

	// If webrule is to add score
	if (add_score && email)
		_agile.add_score(add_score, {
			success : function() {
				console.log("score added");
			},
			error : function() {
				console.log("failed to add score");
			}
		}, email);

	// If webrule action is unsubscribe campaign
	if (rm_campaign_id.length !== 0 && email) {
		for ( var v = 0; v < rm_campaign_id.length; v++) {
			_agile.unsubscribe_campaign({
				"id" : rm_campaign_id[v]
			}, {
				success : function() {
					console.log("unsubscribed");
				},
				error : function() {
					console.log("error in unsubscribing");
				}
			}, email);
		}
	}

	// If webrule is to remove score
	if (rm_score && email)
		_agile.add_score(rm_score, {
			success : function() {
				console.log("score");
			},
			error : function() {
				console.log("failed to subtract score");
			}
		}, email);

	// If webrule is to remove tags
	if (rm_tags.length !== 0 && email)
		_agile.remove_tag(rm_tags.toString(), {
			success : function() {
				console.log("tags removed");
			},
			error : function() {
				console.log("failed to remove tags");
			}
		}, email);
}

// Function to check if all conditions in a single webrule object are true,
// if yes call API (modal and/or noty and/or add-campaign)

function perform_action(anon_webrules, webrules, modal_data, modal_options,
		modal_callback, noty_data, noty_options, noty_callback,
		add_campaign_id, rm_campaign_id, add_score, rm_score, add_tags, rm_tags) {
	var len = 0; // Length of anon_webrules
	var _counter = 0; // Counter for satisfied anon_webrules
	var t = 0; // Webrules length

	// Get number of webrules
	for ( var j in webrules) {
		if (webrules.hasOwnProperty(j))
			t++;
	}

	// Check if all anonymous conditions are true
	for ( var anon_rule in anon_webrules) {
		len++;
		if (anon_webrules.hasOwnProperty(anon_rule)
				&& rules[anon_rule](anon_webrules)) {
			_counter++;
		}
	}
	var email; // Agile contact email

	// Get email from cookie
	agile_getEmail({
		success : function(data) {
			email = data.email;

			if (email == "null" || email == undefined) {
				if (t == 0) {
					if (len == _counter && len !== 0 && _counter !== 0) {
						execute_action(modal_data, modal_options,
								modal_callback, noty_data, noty_options,
								noty_callback, add_campaign_id, rm_campaign_id,
								add_score, rm_score, add_tags, rm_tags);
					}
				}
			} else if (email) {
				_agile
						.get_contact(
								email,
								{
									success : function(data) {
										_agile_contact = data;
										var counter = 0;
										for ( var rule in webrules) {
											if (webrules.hasOwnProperty(rule)
													&& rules[rule](webrules,
															_agile_contact)) {
												counter++;
											}
										}

										if ((t == 0 && len !== 0 && len == _counter)
												|| (t !== 0 && t == counter && len == 0)
												|| (t != 0 && t == counter
														&& len == _counter && len !== 0)) {
											execute_action(modal_data,
													modal_options,
													modal_callback, noty_data,
													noty_options,
													noty_callback,
													add_campaign_id,
													rm_campaign_id, add_score,
													rm_score, add_tags,
													rm_tags, email);
										}
									},
									error : function() {
										if (t == 0 && len !== 0
												&& len == _counter) {
											execute_action(modal_data,
													modal_options,
													modal_callback, noty_data,
													noty_options,
													noty_callback,
													add_campaign_id,
													rm_campaign_id, add_score,
													rm_score, add_tags, rm_tags);
										}
									}
								});
			}
		}
	});
}

// Webrule API to get array of webrule objects (if multiple webrules defined)
// from agile,
// iterate, and build webrule actions, condition

function execute_webrules() {

	setTimeout(
			function() {
				_agile
						.web_rules({
							success : function(data) {

								// Build webrules
								var r = _agile_webrules[i].rules.length;
								for ( var s = 0; s < r; s++) {

									if (_agile_webrules[i].rules[s].LHS == "tags") {
										if (_agile_webrules[i].rules[s].CONDITION == "EQUALS")
											webrules.tags_in = _agile_webrules[i].rules[s].RHS
													.replace(', ', ',').split(
															',');
										if (_agile_webrules[i].rules[s].CONDITION == "NOTEQUALS")
											webrules.tags_out = _agile_webrules[i].rules[s].RHS
													.replace(', ', ',').split(
															',');
									}
									if (_agile_webrules[i].rules[s].LHS == "page") {
										if (_agile_webrules[i].rules[s].CONDITION == "EQUALS")
											anon_webrules.page_view_is = _agile_webrules[i].rules[s].RHS;
										if (_agile_webrules[i].rules[s].CONDITION == "MATCHES")
											anon_webrules.page_view_matches = _agile_webrules[i].rules[s].RHS;
									}
									if (_agile_webrules[i].rules[s].LHS == "visit") {
										if (_agile_webrules[i].rules[s].CONDITION == "FIRST_TIME")
											anon_webrules.visit_type = "first";
										if (_agile_webrules[i].rules[s].CONDITION == "REPEAT")
											anon_webrules.visit_type = "repeat";
									}
									if (_agile_webrules[i].rules[s].LHS == "referrer") {
										if (_agile_webrules[i].rules[s].CONDITION == "EQUALS")
											anon_webrules.referrer_is = _agile_webrules[i].rules[s].RHS;
										if (_agile_webrules[i].rules[s].CONDITION == "MATCHES")
											anon_webrules.referrer_matches = _agile_webrules[i].rules[s].RHS;
									}
									if (_agile_webrules[i].rules[s].LHS == "tags_time"
											&& _agile_webrules[i].rules[s].CONDITION == "EQUALS") {
										webrules.tags_time = {};
										if (_agile_webrules[i].rules[s].nested_condition == "BETWEEN") {
											webrules.tags_time["tags"] = _agile_webrules[i].rules[s].RHS
													.replace(', ', ',').split(
															',');
											webrules.tags_time["time_min"] = _agile_webrules[i].rules[s].nested_lhs;
											webrules.tags_time["time_max"] = _agile_webrules[i].rules[s].nested_rhs;
											webrules.tags_time["condition"] = _agile_webrules[i].rules[s].nested_condition;
										}
										if (_agile_webrules[i].rules[s].nested_condition == "BEFORE"
												|| _agile_webrules[i].rules[s].nested_condition == "AFTER"
												|| _agile_webrules[i].rules[s].nested_condition == "EQUALS"
												|| _agile_webrules[i].rules[s].nested_condition == "NEXT"
												|| _agile_webrules[i].rules[s].nested_condition == "LAST") {
											webrules.tags_time["tags"] = _agile_webrules[i].rules[s].RHS
													.replace(', ', ',').split(
															',');
											webrules.tags_time["time"] = _agile_webrules[i].rules[s].nested_lhs;
											webrules.tags_time["condition"] = _agile_webrules[i].rules[s].nested_condition;
										}
									}
									if (_agile_webrules[i].rules[s].LHS == "created_time") {
										webrules.contact_time = {};
										if (_agile_webrules[i].rules[s].CONDITION == "BEFORE"
												|| _agile_webrules[i].rules[s].CONDITION == "AFTER"
												|| _agile_webrules[i].rules[s].CONDITION == "ON"
												|| _agile_webrules[i].rules[s].CONDITION == "LAST"
												|| _agile_webrules[i].rules[s].CONDITION == "NEXT") {
											webrules.contact_time["time"] = _agile_webrules[i].rules[s].RHS;
											webrules.contact_time["condition"] = _agile_webrules[i].rules[s].CONDITION;
										}
										if (_agile_webrules[i].rules[s].CONDITION == "BETWEEN") {
											webrules.contact_time["time_max"] = _agile_webrules[i].rules[s].RHS_NEW;
											webrules.contact_time["time_min"] = _agile_webrules[i].rules[s].RHS;
											webrules.contact_time["condition"] = _agile_webrules[i].rules[s].CONDITION;
										}
									}
									if (_agile_webrules[i].rules[s].LHS == "title"
											|| _agile_webrules[i].rules[s].LHS == "company"
											|| _agile_webrules[i].rules[s].LHS == "owner_id") {
										var property_json = {};
										property_json.name = _agile_webrules[i].rules[s].LHS;
										property_json.value = _agile_webrules[i].rules[s].RHS;
										if (_agile_webrules[i].rules[s].CONDITION == "EQUALS") {
											if (!webrules.contact_properties_in)
												webrules.contact_properties_in = [];
											webrules.contact_properties_in
													.push(property_json);
										}
										if (_agile_webrules[i].rules[s].CONDITION == "NOTEQUALS") {
											if (!webrules.contact_properties_out)
												webrules.contact_properties_out = [];
											webrules.contact_properties_out
													.push(property_json);
										}
									}
								}

								perform_actions(data);
							},
							error : function() {
								console.log("error");
							}
						});
			}, 150);
}

function perform_actions(data, validate) {

	// Agile API to get array of webrule objects from datastore
	_agile_webrules = data;
	console.log(_agile_webrules);
	var l = _agile_webrules.length;

	// Iterate array of webrule objects and build rules, options, modal/noty
	// content etc
	// Each webrule object has three main parts webrule conditions, webrule
	// actions, data (title / content)
	for ( var i = 0; i < l; i++) {

		var webrules = {}; // Webrule object
		var anon_webrules = {}; // Webrules object for anonymous visitor
		var modal_data = {}; // Modal data
		var modal_options = {}; // Modal options
		var modal_callback; // Modal callback
		var noty_callback; // Noty callback
		var noty_data = {}; // Noty data
		var noty_options = {}; // Noty options
		var add_campaign_id = []; // Workflow id
		var rm_campaign_id = []; // Workflow id
		var add_tags = []; // Tags array to add
		var rm_tags = []; // Tags array to remove
		var add_score; // Score to add
		var rm_score // Score to remove

		// Build webrule actions
		console.log(_agile_webrules[i]);
		var u = _agile_webrules[i].actions.length;
		console.log()
		console.log(u);
		console.log(data);
		for ( var t = 0; t < u; t++) {

			console.log(_agile_webrules[i].actions[t]);

			// If webrule action is modal
			if (_agile_webrules[i].actions[t].action == "MODAL_POPUP") {

				// If modal is of type confirmation
				if (_agile_webrules[i].actions[t].popup_pattern == "confirmation") {
					modal_options.show_btn_cancel = true;
					modal_data.title = _agile_webrules[i].actions[t].title;
					modal_data.contents = _agile_webrules[i].actions[t].popup_text;
				}

				// If modal is of type information
				if (_agile_webrules[i].actions[t].popup_pattern == "information") {
					modal_options.show_btn_cancel = false;
					modal_data.title = _agile_webrules[i].actions[t].title;
					modal_data.contents = _agile_webrules[i].actions[t].popup_text;
					modal_options.hideHeader = false;
				}

				// If modal is of type form
				if (_agile_webrules[i].actions[t].popup_pattern == "form") {
					modal_options.form_id = _agile_webrules[i].actions[t].title;
					modal_options.hideHeader = true;
					modal_options.show_btn_cancel = true;
				}

				// If modal is of type custom_html
				if (_agile_webrules[i].actions[t].popup_pattern == "custom_html") {
					var e = document.createElement('div');
		        	e.innerHTML = _agile_webrules[i].actions[t].popup_text;
		        	var data = e.childNodes[0].nodeValue;
		        	if(data)
		        	    modal_data.contents = data;
		        	else modal_data.contents = e.innerHTML;
		            modal_options.hideHeader = true;
		            modal_options.hideFooter = true;
				}

				// Build options for webrule action (modal) right now hardcoded
				// as no option from UI
				modal_options.btn_ok = 'Subscribe';
				modal_options.btn_cancel = 'Cancel';
				modal_options.width = 275;
				modal_options.overlayOpacity = 0.6;
				modal_options.onAppend = function() {
					document.id('simple-modal').fade('hide');
					setTimeout((function() {
						document.id('simple-modal').fade('show')
					}), 200);
					var tw = new Fx.Tween(document.id('simple-modal'), {
						duration : 0,
						//transition : 'bounce:out',
						link : 'cancel',
						property : 'top'
					}).start(-400, 150)
				};
				modal_callback = function() {
					test('this_is_modal_callback');
				}
			}

			console.log(_agile_webrules[i].actions[t].action);
			// If webrule action is noty and type is custom_html
			if (_agile_webrules[i].actions[t].action == "CORNER_NOTY"
					&& _agile_webrules[i].actions[t].popup_pattern == "information") {

				if (_agile_webrules[i].actions[t].position == "RIGHT_BOTTOM")
					noty_options.position = "bottomRight";
				if (_agile_webrules[i].actions[t].position == "RIGHT_TOP")
					noty_options.position = "topRight";
				if (_agile_webrules[i].actions[t].position == "LEFT_BOTTOM")
					noty_options.position = "bottomLeft";
				if (_agile_webrules[i].actions[t].position == "LEFT_TOP")
					noty_options.position = "topLeft";
				if (_agile_webrules[i].actions[t].position == "TOP")
					noty_options.position = "top";
				if (_agile_webrules[i].actions[t].position == "BOTTOM")
					noty_options.position = "bottom";

				noty_data = _agile_webrules[i].actions[t].popup_text;
				noty_options.theme = 'defaultTheme';
				noty_options.dismiss_queue = 'true';
				noty_options.type = "information";
				noty_callback = function() {
					test('this_is_noty_callback');
				}
			}

			// If webrule action is campaign
			if (_agile_webrules[i].actions[t].action == "ASSIGN_CAMPAIGN")
				add_campaign_id.push(_agile_webrules[i].actions[t].RHS);
			if (_agile_webrules[i].actions[t].action == "UNSUBSCRIBE_CAMPAIGN")
				rm_campaign_id.push(_agile_webrules[i].actions[t].RHS);

			// If webrule action is tag
			if (_agile_webrules[i].actions[t].action == "ADD_TAG")
				add_tags.push(_agile_webrules[i].actions[t].popup_pattern);
			if (_agile_webrules[i].actions[t].action == "REMOVE_TAG")
				rm_tags.push(_agile_webrules[i].actions[t].popup_pattern);

			// If webrule action is score
			if (_agile_webrules[i].actions[t].action == "ADD_SCORE")
				add_score = _agile_webrules[i].actions[t].popup_pattern;
			if (_agile_webrules[i].actions[t].action == "SUBTRACT_SCORE")
				rm_score = _agile_webrules[i].actions[t].popup_pattern;
		}

		if (!validate) {
			execute_action(modal_data, modal_options, modal_callback,
					noty_data, noty_options, noty_callback, add_campaign_id,
					rm_campaign_id, add_score, rm_score, add_tags, rm_tags)
			return;
		}
		// Call to method to check all conditions in a webrule are true and
		// perform action
		perform_action(anon_webrules, webrules, modal_data, modal_options,
				modal_callback, noty_data, noty_options, noty_callback,
				add_campaign_id, rm_campaign_id, add_score, rm_score, add_tags,
				rm_tags);
	}

}

// Test callback

function test(k) {
	console.log(k);
}
/**
 * For sorting of web rules
 * @param el
 */
function enableWebrulesSorting(el)
{
	$("#webrule-model-list").append("<tr class='pseduo-row' style='display:none;'><td></td><td></td><td></td><td></td></tr>");
	// Loads jquery-ui to get sortable functionality on widgets
	head.js(LIB_PATH + 'lib/jquery-ui.min.js', function()
	{
		$('.webrule-sortable', el).sortable( 
		{
				axis: "y" ,
				forcePlaceholderSize: true,
				placeholder:'<tr><td></td></tr>',
				handle: ".icon-move",
				containment: "#webrule-model-list",
				cursor: "move",
				forceHelperSize: true,
				scroll: false,
				items: "> tr",
				helper: function(e, tr)
				{
				    var $originals = tr.children();
				    var $helper = tr.clone();
				    $helper.children().each(function(index)
				    {
				      // Set helper cell sizes to match the original sizes
				      $(this).width($originals.eq(index).width());
				    });
				    return $helper;

				}

		});

		/*
		 * This event is called after sorting stops to save new positions of
		 * widgets
		 */
		$('.webrule-sortable', el).on("sortstop", function(event, ui) {

			var models = [];

			/*
			 * Iterate through each all the widgets and set each widget
			 * position and store it in array
			 */
			$('.webrule-sortable > tr', el).each(function(index, element)
			{
				if(!$(element).hasClass("pseduo-row")){


					var model_id = $(element).find('.data').attr('data');

					// Get Model, model is set as data to widget element
					var model = App_WebReports.webrules.collection.get(model_id);

					model.set({ 'position' : index+1 }, { silent : true });

					models.push({ id : model.get("id"), position : index+1 });
				}

			});

			// Saves new positions in server
			$.ajax({ type : 'POST', url : '/core/api/webrule/positions', data : JSON.stringify(models),
				contentType : "application/json; charset=utf-8", dataType : 'json' });
		});
	});
}
function chainWebRules(el, data, isNew, actions)
{
	var element_clone = $(el).clone();
	
	$("#campaign-actions", el).chained($("#action", el), function(){
	});
	$("#action-details", el).chained($("#action", el),  function(){
	});
	$("#WEB_RULE_RHS", el).chained($("#action", el), function(el, self){

		var select = $('select', $(self));
		
		if(data)
			{
				$.each(data, function(index, action){
					if(index == "actions" && (action[0].action == "ASSIGN_CAMPAIGN" || action[0].action == "UNSUBSCRIBE_CAMPAIGN"))
					{
						$(select).find('option[value='+ action[0].RHS +']').attr("selected", "selected");
						return false;
					}
				});	
			}
		
		// Enable tags typeahead if tags field is available 
		var element = $(".tags", self);
		if(element.length > 0)
			addTagsDefaultTypeahead(self);
		
	});
	$("#campaign", el).chained($("#action", el));
	
	$("#possition", el).chained($("#action", el));

	
	$("#timer", el).chained($("#delay", el));
	$("#delay", el).chained($("#action", el));
	
	$("#noty-message", el).chained($("#action", el), function(select, self){
		var value = $("select", select).val();
		$(self).show();
		console.log(value);
	
		if(value == "MODAL_POPUP" || value == "CORNER_NOTY")
			{
				if(value == "MODAL_POPUP")
				$("#tiny_mce_webrules_link", self).show();
				self.find(".web-rule-preview").show();
			return;
			}
		self.find(".web-rule-preview").hide();
	});
	
	if(data && data.actions)
		deserializeChainedSelect1($(el).find('form'), data.actions, element_clone, data.actions[0]);
	
	scramble_input_names($(".reports-condition-table", element_clone))
}

/**
*  WebRules event view
*/
var Web_Rules_Event_View = Base_Model_View.extend({
		    events: {
		 		'click .web-rule-multiple-add' : 'ruleMultipleAdd',
		 		'click i.webrule-multiple-remove' : 'ruleMultipleRemove',
		 		'click i.filter-contacts-web-rule-multiple-add' : 'webruleMultipleAdd',
		 		'click i.filter-contacts-web-rule-multiple-remove' : 'webruleMultipleRemove',
		 		'click .web-rule-preview' : 'webrulePreview',
		 		'click #tiny_mce_webrules_link' : 'tinymceWebruleLink',
		    },

			// Filter Contacts- Clone Multiple
			ruleMultipleAdd: function(e)
			{
				e.preventDefault();

				// To solve chaining issue when cloned
				getTemplate('webrules-add', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;

					var htmlContent = $(template_ui).find('.webrule-actions > div').clone();
					chainWebRules($(htmlContent)[0], undefined, true);
					// var htmlContent = $(this).closest("tr").clone();
					$(htmlContent).find("i.webrule-multiple-remove").css("display", "inline-block");
					$(".webrule-actions").append(htmlContent);

				}, null);

			},
			
			// Filter Contacts- Remove Multiple
			ruleMultipleRemove: function(e)
			{
				$(e.currentTarget).closest(".chained-table > div").remove();
			},
			
			// Filter Contacts- Clone Multiple
			webruleMultipleAdd: function(e)
			{
				// To solve chaining issue when cloned
				var that = $(e.currentTarget);
				getTemplate('webrules-add', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;

					var htmlContent = $(template_ui).find('.web-rule-contact-condition-table tr').clone();
					scramble_input_names($(htmlContent));

					chainFilters(htmlContent, undefined, undefined, true);

					$(htmlContent).find("i.filter-contacts-multiple-remove").css("display", "inline-block");
					$(that).parents("tbody").append(htmlContent);

				}, null);
				
			},

			// Filter Contacts- Remove Multiple
			webruleMultipleRemove: function(e)
			{
				var targetEl = $(e.currentTarget);
				$(targetEl).closest("tr").remove();
			},

			webrulePreview: function(e){
				e.preventDefault();
				var that = $(e.currentTarget);
				_agile_require_js("https://s3.amazonaws.com/agilewebgrabbers/scripts/agile-webrules-min.js", function(){

					// Serializes webrule action to show preview
					var action = serializeChainedElement($(that).closest('table'));
					// Popup va'ue should be in a json object with key value, as it is returned that way from server text field
					var popup_text = {};
					popup_text["value"] = action.popup_text;
					action.popup_text = popup_text;
					action.delay = "IMMEDIATE";
					
						_agile_execute_action(action);
					});
			},

			tinymceWebruleLink: function(e){
				e.preventDefault();

				// If not empty, redirect to tinymce
				if($('#tinyMCEhtml_email').val() !== "")
				{
					if($('.custom_html').length > 1){
						alert("Only one popup is allowed per webrule. You have already set a popup action for this webrule.");
						$($(e.currentTarget)).closest(".alert").remove();
						return;
					}
					loadTinyMCE("tinyMCEhtml_email");
					return;
				}
				var strWindowFeatures = "height=650, width=800,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes";
				var new_window = window.open('templates.jsp?id=tinyMCEhtml_email&t=web_rules', 'name', strWindowFeatures);
				
				if(window.focus)
					{
						new_window.focus();
					}
				return false;
			},

		});


function loadTinyMCE(name)
{
	var strWindowFeatures = "height=650, width=800,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes";
	var newwindow = window.open('cd_tiny_mce.jsp?id=' + name,'name',strWindowFeatures);
	if (window.focus)
	{
		newwindow.focus();
	}
	return false;
	
}

function tinyMCECallBack(name, htmlVal)
{
	$('#' + name).val(htmlVal);
}

/**
 * MergeFields function to fetch all available merge-fields.
 * 
 * @param type - to add specific fields for specific nodes
 *               like unsubscribe link to SendEmail node
 **/
function getMergeFields(type, callback)
{
	var options=
	{
		"Select Merge Field": "",
		"First Name": "{{first_name}}",
		"Last Name": "{{last_name}}",
		"Email": "{{email}}",
		"Company":"{{company}}",
		"Title": "{{title}}",
		"Website": "{{website}}",
		"Phone": "{{phone}}",
		"City": "{{city}}",
		"State": "{{state}}",
		"Country": "{{country}}",
		"Zip": "{{zip}}",
		"Domain": "{{domain}}",
		"Address": "{{address}}",
		"Score": "{{score}}",
		"Created Time": "{{created_time}}",
		"Modified Time": "{{modified_time}}",
		"Owner Name": "{{owner_name}}",
		"Owner Email": "{{owner_email}}"
	};
	
	// Get Custom Fields in template format
	get_webrules_custom_fields(function(custom_fields){

		console.log("Custom Fields are");
		console.log(custom_fields);
		
		// Merges options json and custom fields json
		var merged_json = merge_webrules_jsons({}, options, custom_fields);
		if(callback)
			 return callback(merged_json);

		return merged_json;

		});
}

/**
 * Returns custom fields in format required for merge fields. 
 * E.g., Nick Name:{{Nick Name}}
 */
function get_webrules_custom_fields(callback)
{
    var url = window.location.protocol + '//' + window.location.host;
	
	// Sends GET request for customfields.
	accessUrlUsingAjax(url+'/core/api/custom-fields', function(resp){

		var customfields = {}, data = resp;
	
		// Iterate over data and get field labels of each custom field
		$.each(data, function(index,obj)
				{
						// Iterate over single custom field to get field-label
			            $.each(obj, function(key, value){
							
							// Needed only field labels for merge fields
							if(key == 'field_label')
								customfields[value] = "{{[" + value+"]}}"
						});
				});

		if(callback)
			callback(customfields);

	});
	
}

/**
 * Returns merged json of two json objects
 **/
function merge_webrules_jsons(target, object1, object2)
{
	return $.extend(target, object1, object2);
}
/**
 * THIRD PARTY SCRIPTS - PLUGINS - INTEGRATION POINTS.
 * 
 * agile_widgets.js defines third party JavaScript API.
 * Functionalities provided by script API are
 * <pre>
 * -- Return widget object by widget name			 : agile_crm_get_widget(pluginName)
 * -- Return widget preferences by widget name	     : agile_crm_get_widget_prefs(pluginName)
 * -- Save widget preferences  by widget name		 : agile_crm_save_widget_prefs(pluginName, preferences)
 * -- Delete widget preferences by widget name       : agile_crm_delete_widget_prefs(pluginName, callback)
 * -- Saves widget property to contact               : agile_crm_save_widget_property_to_contact(propertyName, value)
 * -- Retrieves widget property from current contact : agile_crm_get_widget_property_from_contact(propertyName)
 * -- Delete widget property from current contact	 : agile_crm_delete_widget_property_from_contact(propertyName)
 * -- Retrieves current contact object				 : agile_crm_get_contact()
 * -- Retrieves property of current contact 	     : agile_crm_get_contact_property(propertyName)
 * -- Retrieves properties list of current contact   : agile_crm_get_contact_properties_list(propertyName)
 * -- Retrieves contact property value by subtype    : agile_crm_get_contact_property_by_subtype(propertyName, subtype)
 * -- Save property to contact for given subtype     : agile_crm_save_contact_property(propertyName, subtype, value, type)
 * -- Updating a contact by specifying property name : agile_crm_update_contact(propertyName, Value)
 * -- Updates contact properties with given values   : agile_crm_update_contact_properties(propertiesArray, callback)
 * -- Delete value given from contact by subtype     : agile_crm_delete_contact_property_by_subtype(propertyName, subtype, value)
 * -- Add Note to current contact					 : agile_crm_add_note(subject, description)
 * </pre>
 */

/**
 * Searches the property fields in current contact with given property name, if
 * property with given property name exists, then returns its value as string
 * 
 * @param propertyName
 *            name of the property
 */
function agile_crm_get_contact_property(propertyName)
{
	// Reads current contact model form the contactDetailView
	var contact_model = App_Contacts.contactDetailView.model;

	// Gets properties field list from contact
	var properties = contact_model.get('properties');
	var property_value;

	/*
	 * Iterates through each property in contact properties and checks for the
	 * match in it for the given property name and retrieves value of the
	 * property if it matches
	 */
	$.each(properties, function(index, property)
	{
		if (property.name == propertyName)
		{
			property_value = property.value;
			return false;
		}
	});

	// If property value is defined then return it
	if (property_value)
		return property_value;

}

/**
 * Searches the property fields in current contact with given property name, if
 * property with given property name exists, then returns its value in a array
 * 
 * <p>
 * This method is used when contact property has multiple values like email,
 * phone, website etc
 * </p>
 * 
 * @param propertyName
 *            name of the property
 * @returns {Array}
 */
function agile_crm_get_contact_properties_list(propertyName)
{
	// Reads current contact model form the contactDetailView
	var contact_model = App_Contacts.contactDetailView.model;

	// Gets properties list field from contact
	var properties = contact_model.get('properties');
	var property_list = [];

	/*
	 * Iterates through each property in contact properties and checks for the
	 * match in it for the given property name and retrieves value of the
	 * property if it matches
	 */
	$.each(properties, function(index, property)
	{
		if (property.name == propertyName)
		{
			property_list.push(property);
		}
	});

	// If property is defined then return property value list
	return property_list;

}

/**
 * Updates a contact based on the property name and its value specified. If
 * property name already exists with the given then replaces the value, if
 * property is new then creates a new field and saves it
 * 
 * @param propertyName:
 *            Name of the property to be created/updated
 * @param value :
 *            value for the property
 */
function agile_crm_update_contact(propertyName, value, callback)
{
	// Gets current contact model from the contactDetailView object
	var contact_model = null;
	
	if(company_util.isCompany()){
		contact_model = App_Companies.companyDetailView.model;
	} else {
		contact_model = App_Contacts.contactDetailView.model;
	}

	// Reads properties fied from the contact
	var properties = contact_model.toJSON()['properties'];
	var flag = false;

	/*
	 * Iterates through each property in contact properties and checks for the
	 * match in it for the given property name and if match is found, updates
	 * the value of it with the given value
	 */
	$.each(properties, function(index, property)
	{
		if (property.name == propertyName)
		{
			// flag is set true to indicate property already exists in contact
			flag = true;
			property.value = value;
			return false;
		}
	});

	// If flag is false, given property is new then new field is created
	if (!flag)
		properties.push({ "name" : propertyName, "value" : value, "type" : "CUSTOM" });

	contact_model.set({ "properties" : properties }, { silent : true });
	contact_model.url = "core/api/contacts";

	// Save model
	contact_model.save({ success : function(model, response)
	{
		if (callback && typeof (callback) == "function")
			callback();
	} }, { silent : true });

}

/**
 * Updates a contact with the list of property name and its value specified in
 * propertiesArray. If property name already exists with the given then replaces
 * the value, if property is new then creates a new field and saves it
 * 
 * @param propertiesArray
 *            Array of the properties to be created/updated
 * @param callback
 */
function agile_crm_update_contact_properties(propertiesArray, callback)
{
	// Gets current contact model from the contactDetailView object
	var contact_model = App_Contacts.contactDetailView.model;

	// Reads properties field from the contact
	var properties = contact_model.toJSON()['properties'];

	// Iterates for each property in properties list
	for ( var i in propertiesArray)
	{
		var flag = false;

		// Iterates through each property in contact properties
		$.each(properties, function(index, property)
		{
			/*
			 * checks for the match with given property name in properties list
			 * and if match is found and if given properties has no subtype,
			 * updates the value of it with the given value
			 */
			if (property.name == propertiesArray[i].name)
			{
				// flag is set true to indicate property is not new
				flag = true;

				/*
				 * If given properties list has subtype, then update the value
				 * of it, else flag is set false to indicate it as new property
				 */
				if (propertiesArray[i].subtype)
				{
					if (propertiesArray[i].subtype == property.subtype)
						property.value = propertiesArray[i].value;
					else
						flag = false;
				}
				else
					property.value = propertiesArray[i].value;

				// break each if match is found
				return false;
			}
		});

		// If flag is false, given property is new then new field is created
		if (!flag)
			properties
					.push({ "name" : propertiesArray[i].name, "value" : propertiesArray[i].value, "subtype" : propertiesArray[i].subtype, "type" : "CUSTOM" });

	}

	// If property is new then new field is created
	contact_model.set({ "properties" : properties }, { silent : true });
	contact_model.url = "core/api/contacts";

	// Save model
	contact_model.save({ success : function(model, response)
	{
		console.log('contact saving ');
		if (callback && typeof (callback) == "function")
			callback();
	} }, { silent : true });
}

/**
 * Retrieves current contact from model
 * 
 * @returns
 */
function agile_crm_get_contact()
{
	return App_Contacts.contactDetailView.model.toJSON();
}

/**
 * Adds note to current contact
 * 
 * @param sub
 * @param description
 */
function agile_crm_add_note(subject, description)
{
	// Get Current Contact Model
	var contact_model = App_Contacts.contactDetailView.model;

	// Get ID
	var note = new Backbone.Model();
	var contactModel = new Backbone.Model();
	note.url = 'core/api/notes';

	note.set("subject", subject);
	note.set("description", description);

	note.set("contacts", [
		contact_model.id.toString()
	]);

	note.save();
	// Create Model and Save
}

/**
 * Retrieves plugin object based on the plugin name specified
 * 
 * @param pluginName :
 *            name of the plugin to fetch
 */
function agile_crm_get_widget(pluginName)
{
	pluginName = pluginName.replace(/ +/g, '');
	console.log('plugin name ' + pluginName);

	/*
	 * Retrieves plugin data from the model data which is set to plugin block
	 * while loading plugins
	 */
	console.log($('#' + pluginName));
	var model_data = $('#' + pluginName, App_Contacts.contactDetailView.el).data('model');

	console.log(model_data);

	return model_data.toJSON();
}

/**
 * Retrieves plugin preferences based on the name of the plugin
 * 
 * @param pluginName :
 *            name of the plugin to get preferences
 * @returns plugin preferences
 */
function agile_crm_get_widget_prefs(pluginName)
{
	pluginName = pluginName.replace(/ +/g, '');
	console.log("in get widget prefs " + pluginName);
	// Gets data attribute of from the plugin, and return prefs from that object
	return $('#' + pluginName, App_Contacts.contactDetailView.el).data('model').toJSON().prefs;
}

/**
 * Saves given widget preferences to current user based on given plugin name.
 * 
 * @param pluginName :
 *            name of the plugin specified, to associate preferences
 * @param prefs :
 *            preferences to be saved
 */
function agile_crm_save_widget_prefs(pluginName, prefs, callback)
{
	console.log(pluginName);
	pluginName = pluginName.replace(/ +/g, '');

	console.log(App_Contacts.contactDetailView.el);
	console.log($('#' + pluginName, App_Contacts.contactDetailView.el));

	// Get the model from the the element
	var widget = $('#' + pluginName, App_Contacts.contactDetailView.el).data('model');

	console.log(widget);
	// Set changed preferences to widget backbone model
	widget.set({ "prefs" : prefs }, { silent : true });

	// URL to connect with widgets
	widget.url = "core/api/widgets"

	console.log(widget);

	var model = new BaseModel();
	model.url = "core/api/widgets";
	model.save(widget.toJSON(), { success : function(data)
	{
		console.log(data);
		console.log("Saved widget: " + data.toJSON());
		
		// Set the changed model data to respective plugin div as data
		$('#' + pluginName, App_Contacts.contactDetailView.el).data('model', widget);
		
		if (callback && typeof (callback) === "function")
		{
			console.log("in save callback");
			console.log(data.toJSON());
			// Execute the callback, passing parameters as necessary
			callback(data.toJSON());
		}
	} }, { silent : true });

}

/**
 * Deletes widget preferences saved in widget under the field prefs in widget
 * object
 * 
 * @param pluginName
 *            name of the plugin specified
 */
function agile_crm_delete_widget_prefs(pluginName, callback)
{
	// saves prefs as undefined
	agile_crm_save_widget_prefs(pluginName, undefined, callback);
}

/**
 * Returns widget property value from widget_properties field in contact
 * 
 * @param propertyName :
 *            name(key) of the property value stored in widget_properties JSON
 * @Return widget property value
 * 
 */
function agile_crm_get_widget_property_from_contact(propertyName)
{

	// Gets Current Contact Model
	var contact_model = App_Contacts.contactDetailView.model;

	// Gets WidgetProperties from Contact Model
	var widget_properties = contact_model.get('widget_properties');

	// If widget-properties are null return
	if (!widget_properties)
		return;

	// Converts JSON string to JSON Object
	widget_properties = JSON.parse(widget_properties);

	// Returns value of property from widget_properties JSON
	return widget_properties[propertyName];
}

/**
 * Deletes widget property, the property key value pair from widget_properties
 * JSON string in contact based on given property name
 * 
 * @param propertyName :
 *            Name of the property to be deleted
 */
function agile_crm_delete_widget_property_from_contact(propertyName)
{

	// Gets Current Contact Model from contactDetailView object
	var contact_model = App_Contacts.contactDetailView.model;

	// Gets WidgetProperties from Contact Model
	var widget_properties = contact_model.get('widget_properties');

	// If widget-properties id null return
	if (!widget_properties)
		return;

	/*
	 * If widget_properties are not null, then convert widget_properties string
	 * in to JSON object
	 */
	widget_properties = JSON.parse(widget_properties);

	// deletes value from JSON
	delete widget_properties[propertyName];

	// set Updated widget_properties in to contact model
	contact_model.set("widget_properties", JSON.stringify(widget_properties));

	contact_model.url = "core/api/contacts";

	// Save updated contact model
	contact_model.save();
}

/**
 * Retrieves property value from current contact based on given property name
 * and sub type of the property
 * 
 * @param propertyName
 *            Name of the property
 * @param subtype
 *            Subtype of the property
 */
function agile_crm_get_contact_property_by_subtype(propertyName, subtype)
{

	// Reads current contact model form the contactDetailView
	var contact_model = App_Contacts.contactDetailView.model;

	// Gets properties list field from contact
	var properties = contact_model.get('properties');
	var property;

	// Iterates though each property and finds the value related to the property
	// name
	$.each(properties, function(key, value)
	{
		if (value.name == propertyName && value.subtype == subtype)
		{
			property = value;
		}
	});

	// If property is defined then return property value
	if (property)
		return property.value;

}

/**
 * Deletes contact property value from contact based on given property name and
 * sub type of the property and value of the property
 * 
 * @param propertyName
 *            Name of the property
 * @param subtype
 *            Subtype of the property
 * @param value
 *            Value of the property
 */
function agile_crm_delete_contact_property_by_subtype(propertyName, subtype, value, callback)
{

	// Reads current contact model form the contactDetailView
	var contact_model = App_Contacts.contactDetailView.model;

	// Gets properties list field from contact
	var properties = contact_model.get('properties');

	/*
	 * Iterates though each property and finds the value related to the property
	 * name and deletes it
	 */
	$.each(properties, function(index, property)
	{
		if (property.name == propertyName && property.subtype == subtype && property.value == value)
		{
			properties.splice(index, 1);
			contact_model.set({ "properties" : properties }, { silent : true });

			contact_model.url = "core/api/contacts";

			// Save updated contact model
			contact_model.save([], { silent : true, success : function(data)
			{
				console.log("in success");
				if (callback && typeof callback === "function")
					callback(data);

			} });

			return false;
		}
	});

}

/**
 * Saves contact property value to contact with the given property name and sub
 * type of the property and value of the property.
 * 
 * <p>
 * type should be given as "SYSTEM" if it already exists and "CUSTOM" if it is a
 * new field
 * </p>
 * 
 * 
 * @param propertyName
 * @param subtype
 * @param value
 * @param type
 */
function agile_crm_save_contact_property(propertyName, subtype, value, type)
{
	// Reads current contact model form the contactDetailView
	var contact_model = App_Contacts.contactDetailView.model;

	// Gets properties list field from contact
	var properties = contact_model.get('properties');

	var property = {};
	property["name"] = propertyName;
	property["value"] = value;
	property["subtype"] = subtype;
	property["type"] = type;

	properties.push(property);

	contact_model.set("properties", properties);

	console.log(properties);

	contact_model.url = "core/api/contacts"

	// Save updated contact model
	contact_model.save()

}

/**
 * Saves the given property to widget_properties field in contact as key value
 * pair, which is saved as JSON string object in field name widget_properties.
 * 
 * @param propertyName
 * @param value
 */
function agile_crm_save_widget_property_to_contact(propertyName, value, callback)
{

	// Gets Current Contact Model
	var contact_model = App_Contacts.contactDetailView.model;

	// Get WidgetProperties from Contact Model
	var widget_properties = contact_model.get('widget_properties');

	/*
	 * If widget_properties are null i.e, contact do not contain any widget
	 * properties yet, then create new JSON object to save widget properties
	 */
	if (!widget_properties)
		widget_properties = {};

	/*
	 * If widget properties already exists then convert Stringified JSON in to
	 * JSON object to add new properties
	 */
	else
		widget_properties = JSON.parse(widget_properties);

	/*
	 * Adds the new property name and key value pair, in widget_properties JSON
	 */
	widget_properties[propertyName] = value;

	// Stringifies widget_properties json in to string and set to contact model.
	contact_model.set({"widget_properties": JSON.stringify(widget_properties)}, {silent :true});

	contact_model.url = "core/api/contacts";

	// Saves updated model
	//contact_model.save(contact_model.toJSON);
	
	// Save updated contact model
	contact_model.save(contact_model.toJSON, { silent : true, success : function(data)
	{
		console.log("in success");
		if (callback && typeof callback === "function")
			callback(data);

	} });


}

function agile_crm_add_event_to_timeline(name, title, body, time)
{
	var model = {};
	model['id'] = name;
	model['body'] = body;
	model["title"] = title;
	
	if (time && (time / 100000000000) > 1)
		model["created_time"] = time;
	else
		model["created_time"] = time;
	
	model["entity_type"] = "custom";
	
	add_entity_to_timeline(new BaseModel(model));
}

function agile_crm_get_current_view()
{
	if(App_Contacts.contactDetailView)
		return App_Contacts.contactDetailView.el;
	
	return undefined;
}
var CSRCOLLECTION;

function initializeCallScriptListeners(){

    $('#prefs-tabs-content').off();
    $('#prefs-tabs-content #callscriptruleForm').off('click');
	$('#prefs-tabs-content').on('click', '#callscriptruleForm', function(e)
	 {
		 makeWidgetTabActive();
	 });
	
	// Filter Contacts- Clone Multiple
	$('#prefs-tabs-content .callscript-multiple-add').off('click');
	$('#prefs-tabs-content').on('click', '.callscript-multiple-add', function(e)
	{
		e.preventDefault();
		// To solve chaining issue when cloned
		var that = this;
		getTemplate('callscript-rule', {}, undefined, function(template_ui){
			if(!template_ui)
				  return;

			var htmlContent = $(template_ui).find('tr').clone();
			scramble_input_names($(htmlContent));

			// boolean parameter to avoid contacts/not-contacts fields in form
			chainFilters(htmlContent, function()
			{

			}, false);

			// $(this).hide();
			// var htmlContent = $(this).closest("tr").clone();
			$(htmlContent).find("i.callscript-multiple-remove").css("display", "inline-block");
			$(that).siblings("table").find("tbody").append(htmlContent);


		}, null);
	});

	// Filter Contacts- Remove Multiple
	$('#prefs-tabs-content i.callscript-multiple-remove').off('click');
	$('#prefs-tabs-content').on('click', 'i.callscript-multiple-remove', function(e)
	{
		$(this).closest("tr").remove();
	});

	// Add rule from modal to widget form, show save btn , hide add rule btn
	$('#prefs-tabs-content .edit-callscriptrule').off('click');
	$('#prefs-tabs-content').on('click', '.edit-callscriptrule', function(e)
	{
		e.preventDefault();

		// Shows loading image until data gets ready for displaying
		$('#prefs-tabs-content').html(LOADING_HTML);
		
		var editRuleCount = $(this).attr("data");
		
		// Redirect to show call script rules page
		window.location.href = "#callscript/editrules/" + editRuleCount;
		
		// Shows loading image until data gets ready for displaying
		$('#prefs-tabs-content').html(LOADING_HTML);
	});

	// Delete event for call script rule
	$('#prefs-tabs-content .delete-callscriptrule').off('click');
	$('#prefs-tabs-content').on('click', '.delete-callscriptrule', function(e)
	{
		e.preventDefault();
		
		// If not confirmed to delete, return
		if (!confirm("Are you sure to delete a rule"))
			return;

		// Remove element
		$(this).closest("tr").remove();

		// Delete rule from widget
		deleteCallScriptRule($(this).attr("data"))
	});

	// Display rule actions
	$('#prefs-tabs-content .row-callscriptrule').off('mouseenter');
	$('#prefs-tabs-content').on('mouseenter', '.row-callscriptrule', function(e)
	{
		$(this).find(".callscriptrule-actions").css("visibility", "visible");
	});

	// Hide rule actions
	$('#prefs-tabs-content .row-callscriptrule').off('mouseleave');
	$('#prefs-tabs-content').on('mouseleave', '.row-callscriptrule', function(e)
	{
		$(this).find(".callscriptrule-actions").css("visibility", "hidden");
	});

	
	// On click of save button, check input and save details
	$('#prefs-tabs-content #save_prefs').off('click');
	$('#prefs-tabs-content').on('click', '#save_prefs', function(e)
	{	e.preventDefault();

		if ($(this).text() == "Saving..." || $(this).text() == "Loading...") {
			console.log("Do not hit me again " + $(this).text());
			return;
		}

		// Checks whether all input fields are given
		try {
			if (!isValidForm($("#callscriptruleForm"))) {
				return;
			}
		} catch (err) {
			return;
		}

		// Saves call script preferences in callscript widget object
		saveCallScriptWidgetPrefs();
	});
}

// Get widget and make adjustment of buttons in widget form
function adjust_form()
{
	// Disable add rule btn
	$("#add_csrule").text("Loading...");
	$("#add_csrule").attr("disabled", true);

	// if widget is already added so display showrules and hide add rule btn
	if (isCallScriptAdded())
	{
		var ruleCount = getCallScriptRuleCount();
		if(ruleCount >0)
		  {
			$(".rule-count").html(ruleCount);
			$("#add_csrule").hide();
			$(".rule-added").show();
			$("#show_csrules").show();
		  }		
		else
			$(".no-rule-added").show();
	}
	else
		$(".no-rule-added").show();

	// Enable add rule btn
	$("#add_csrule").text('Add Rule');
	$("#add_csrule").attr("disabled", false);
}

//Check call script widget is added or not
function isCallScriptAdded()
{
	// Get call script widget
	var callscriptWidget = App_Widgets.Catalog_Widgets_View.collection.where({ name : "CallScript" });
	console.log(callscriptWidget);

	// call script widget not added
	if (callscriptWidget[0].get("is_added") == false)
		return false;

	// call script widget added
	return true;
}

// Get widget from collection and Convert prefs in json
function getCallScriptJSON()
{
	// If Widgets collection is not defined, navigates to add widget
	if (!App_Widgets || !App_Widgets.Catalog_Widgets_View || !App_Widgets.Catalog_Widgets_View.collection)
	{	
		window.location.href = "#add-widget";
		return;
	}	
	
	// Get call script widget
	var callscriptWidget = App_Widgets.Catalog_Widgets_View.collection.where({ name : "CallScript" });

	if (callscriptWidget[0].get("is_added") == false)
		return null;

	// Convert prefs in json
	var callscriptPrefsJson = JSON.parse(callscriptWidget[0].get("prefs"));

	return callscriptPrefsJson;
}

function getCallScriptRuleCount()
{
	var prefs = getCallScriptJSON();
	return prefs.csrules.length;	
}

function createCSRCollection()
{
	var csr = getCallScriptJSON();
	CSRCOLLECTION = new Base_Collection_View({data: csr.csrules});
}

// Add rules in rules array to add same array in widget's prefs
function makeRule()
{
	// Get rule from form
	var json = serializeForm("callscriptruleForm");

	// Get index of edited rule
	var editRuleCount = json.rulecount;
	
	// Get widget from collection and Convert prefs in json
	var callscriptPrefsJson = getCallScriptJSON();

	/*
	 * if widget is already added so get rules from widget and add new rules in
	 * array
	 */
	if (callscriptPrefsJson != null)
	{
		// Edit rule
		if (editRuleCount != "")
		  {
			// Get rule index from rulecount			
			callscriptPrefsJson.csrules[getRuleIndex(callscriptPrefsJson,editRuleCount)] = json;
		  }			
		else
		// Add Rule
		{
			// Add position to rule
			json["position"] = callscriptPrefsJson.csrules.length;

			// Increment csr count
			callscriptPrefsJson["csrcount"]= callscriptPrefsJson.csrcount + 1;

			// Add csr count to rule
			json["rulecount"] = callscriptPrefsJson.csrcount;
			
			// Add rule in rules
			callscriptPrefsJson.csrules.push(json);			
		}

		return callscriptPrefsJson;
	}

	// Add position 0 to first rule
	json["position"] = 0;
	
	// Add csr count to rule
	json["rulecount"] = 1;

	// Make it define
	callscriptPrefsJson = {}; 
	
	// First rule in widget
	callscriptPrefsJson["csrules"]= [json];
	
	// First csr count
	callscriptPrefsJson["csrcount"]= 1;
	
	return callscriptPrefsJson;
}

// Delete selected call script rule from widget
function deleteCallScriptRule(dltRuleIndex)
{
	// Get widget from collection and Convert prefs in json
	var callscriptPrefsJson = getCallScriptJSON();

	/*
	 * if widget is already added so get rules from widget and delete rules in
	 * array
	 */
	if (callscriptPrefsJson != null)
	{
		// Get rule from prefs
		console.log(callscriptPrefsJson.csrules[dltRuleIndex]);

		// Delete rule from widget
		callscriptPrefsJson.csrules.splice(dltRuleIndex, 1);

		// Saves the preferences into widget with sip widget name
		save_widget_prefs("CallScript", JSON.stringify(callscriptPrefsJson), function(data)
		{
			console.log('In call script save success after delete');
			console.log(data);
		});
	}
	initializeCallScriptListeners();
	makeWidgetTabActive();
}

// Get widget from collection and convert prefs to json before display in table.
function showCallScriptRule()
{
	makeWidgetTabActive();

	// Shows loading image untill data gets ready for displaying
	$('#prefs-tabs-content').html(LOADING_HTML);

	// Get widget from collection and Convert prefs in json
	var callscriptPrefsJson = getCallScriptJSON();

	// if widget is already added so
	// Add rules to show rules page
	if (callscriptPrefsJson != null)
	{
		getTemplate("callscript-table", callscriptPrefsJson.csrules, undefined, function(template_ui){
			if(!template_ui)
				  return;

			$("#prefs-tabs-content").html($(template_ui));
			initializeSubscriptionListeners();
			
			// Apply drag drop (sortable)
			setup_sortable_callscriptrules();

		}, null);
	}
	initializeCallScriptListeners();
}

// show add rule page with chaining
function addCallScriptRule()
{
	// If Widgets collection is not defined, navigates to add widget
	if (!App_Widgets || !App_Widgets.Catalog_Widgets_View || !App_Widgets.Catalog_Widgets_View.collection)
	{	
		window.location.href = "#add-widget";
		return;
	}
	
	makeWidgetTabActive();

	var add_csr = new Base_Model_View({ template : "callscript-rule", isNew : "true", postRenderCallback : function(el)
	{
		
		head.js(LIB_PATH + 'lib/agile.jquery.chained.min.js', function()
		{
			chainFilters(el, undefined, function()
			{
				$('#prefs-tabs-content').html(el);
				initializeSubscriptionListeners();

				// if this is first rule then set add-widget url on cancel btn
				if (!isCallScriptAdded())
				{
					$(".redirect-to-addwidget").show();
					$(".redirect-to-showrules").hide();
				}
			});
		})
	} });

	// Shows loading image until data gets ready for displaying
	$("#prefs-tabs-content").html(LOADING_HTML);
	initializeCallScriptListeners();

	add_csr.render();
}

// Get call script rule from widget and display in edit rule page
function editCallScriptRule(ruleCount)
{
	makeWidgetTabActive();

	// Shows loading image until data gets ready for displaying
	$('#prefs-tabs-content').html(LOADING_HTML);

	// Get widget from collection and Convert prefs in json
	var callscriptPrefsJson = getCallScriptJSON();

	// if widget is already added
	if (callscriptPrefsJson != null)
	{
		// get rule from id as in rulecount of rule
		var csrule = getRule(callscriptPrefsJson,ruleCount);

		$("#prefs-tabs-content").html(LOADING_HTML);
		initializeCallScriptListeners();
		
		head.js(LIB_PATH + 'lib/agile.jquery.chained.min.js', function()
		{

			getTemplate('callscript-rule', {}, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$("#prefs-tabs-content").html($(template_ui));

				$("#prefs-tabs-content").find('#filter-settings').find("#loading-img-for-table").html(LOADING_HTML).show();
				$("#prefs-tabs-content").find('#filter-settings').find(".chained-table").hide();
				
				chainFilters($("#prefs-tabs-content"), csrule, function()
				{
					$("#prefs-tabs-content").find('#filter-settings').find("#loading-img-for-table").hide();
					$("#prefs-tabs-content").find('#filter-settings').find(".chained-table").show();
					initializeSubscriptionListeners();
					
					$(".callscript-multiple-remove").show();
					$(".callscript-multiple-remove")[0].style.display = "none";
				});
				scramble_input_names($("#prefs-tabs-content").find('#filter-settings'));

				// Change heading
				$(".addLable").html(" Edit Call Script Rule");

				// Fill input tags
				$("#name").val(csrule.name);
				$("#displaytext").val(csrule.displaytext);
				$("#position").val(csrule.position);
				$("#rulecount").val(csrule.rulecount);

			}, "#prefs-tabs-content");

		});
	}
}

//Get rule from csrules array by rulecount
function getRule(callscriptPrefsJson,ruleCount)
{
	var rules = callscriptPrefsJson.csrules;
	
	for(var i=0;i<rules.length;i++)
		{		
		 if( rules[i].rulecount == ruleCount)
			 {
			   return rules[i];
			 }
		}
}

// Get rule index from csrules array by rulecount 
function getRuleIndex(callscriptPrefsJson,ruleCount)
{
  var rules = callscriptPrefsJson.csrules;
	
  for(var i=0;i<rules.length;i++)
		{
		 if( rules[i].rulecount == ruleCount)
			 {
			   return i;
			 }
		}
}
/**
 * Sets call script rules as sortable list.
 */
function setup_sortable_callscriptrules()
{	
	$(".csr-sortable").append("<tr class='pseduo-row' style='border:none!important;'><td></td><td></td><td></td></tr>");

	// Loads jquery-ui to get sortable functionality on widgets
	head.js(LIB_PATH + 'lib/jquery-ui.min.js', function()
	{
		$(".csr-sortable").sortable(
				{		
					axis: "y" ,
					forcePlaceholderSize: true,
					placeholder:'<tr><td></td></tr>',
					handle: ".icon-move",
					containment: ".csr-sortable",
					cursor: "move",
					forceHelperSize: true,
					scroll: false,
					items: "> tr",
					helper: function(e, tr)
					{
					    var $originals = tr.children();
					    var $helper = tr.clone();
					    $helper.children().each(function(index)
					    {
					      // Set helper cell sizes to match the original sizes
					      $(this).width($originals.eq(index).width());
					    });
					    return $helper;
					}
				}).disableSelection();
				
		/*
		 * This event is called after sorting stops to save new positions of
		 * rules
		 */
		$('.csr-sortable').off("sortstop");
		$('.csr-sortable').on("sortstop", function(event, ui) {
					
			// Get new array of rule
			getRulesNewPosition(function(newRules){
				
				// Saves new positions in widget
				saveCSRAfterDrop(newRules);
			});			
		});		
	});
}

// Get new positioned array of rule
function getRulesNewPosition(callback)
{
	var newRules = [];
	
	// Get widget from collection and Convert prefs in json
	var callscriptPrefsJson = getCallScriptJSON();

	/*
	 * Iterate through each all the rules and set each rule
	 * position and store it in array
	 */
	$('.csr-sortable > tr').each(function(index, element)
	{
		if(!$(element).hasClass("pseduo-row")){

			var old_rule_index = $(element).attr('data');
			
			// Get Model, model is set as data to widget element
			var rule = callscriptPrefsJson.csrules[old_rule_index];
			
			if(old_rule_index != index)
			  {									
				rule["position"] = index;				
				$(element).attr('data',index);					
			  }
			
			newRules.push(rule);			
		}
	});
	
	if (callback && typeof (callback) === "function")
		callback(newRules);	
}

// Save rules after dropped 
function saveCSRAfterDrop(newRules)
{
//Get widget from collection and Convert prefs in json
var callscriptPrefsJson = getCallScriptJSON();
 
//Add rule to pref
 callscriptPrefsJson["csrules"] = newRules;
 
 //Saves the preferences into widget with sip widget name
 save_widget_prefs("CallScript", JSON.stringify(callscriptPrefsJson), function(data)
	{
		console.log('In call script save success after drag-drop');
		console.log(data);
	}); 
}

// Make widget tab active
function makeWidgetTabActive()
{
	$('#PrefsTab .select').removeClass('select');
	$('.add-widget-prefs-tab').addClass('select');	
}


// from widget-util.js



/**
 * Calls method in script API (agile_widget.js) to save CallScript preferences
 * in CallScript widget object
 */
function saveCallScriptWidgetPrefs() {
	$("#save_prefs").text("Saving...");
	$("#save_prefs").attr("disabled", true);

	// Retrieve and store the Sip preferences entered by the user as
	// JSON
	var callscript_prefs = makeRule();

	console.log(callscript_prefs);

	// Saves the preferences into widget with sip widget name
	save_widget_prefs("CallScript", JSON.stringify(callscript_prefs), function(
			data) {
		console.log('In call script save success');
		console.log(data);

		// Redirect to show call script rules page
		window.location.href = "#callscript/rules";
	});
}



/**
 * Shows setup if user adds call script widget for the first time or clicks on
 * reset icon on call script panel in the UI
 * 
 */
function callscript_save_widget_prefs() {
	
}



function build_custom_widget_form(el)
{
	var divClone;
	
    $('#prefs-tabs-content').off('click', '#add-custom-widget');
	$('#prefs-tabs-content').on('click', '#add-custom-widget', function(e)
	{
		$('#custom-widget-btn').removeClass('open');
		divClone = $("#custom-widget").clone();
		var widget_custom_view = new Base_Model_View({ url : "/core/api/widgets/custom", template : "add-custom-widget", isNew : true,
			postRenderCallback : function(el)
			{
				console.log('In post render callback');
				console.log(el);
                
				$('#custom-widget').off('change').on('change', '#script_type', function(e)
				{
					var script_type = $('#script_type').val();
					if (script_type == "script")
					{
						$('#script_div').show();
						$('#url_div').hide();
						return;
					}

					if (script_type == "url")
					{
						$('#script_div').hide();
						$('#url_div').show();
					}
				});

			}, saveCallback : function(model)
			{
				console.log('In save callback');

				console.log(model);

				if (model == null)
					alert("A widget with this name exists already. Please choose a different name");

				App_Widgets.Catalog_Widgets_View.collection.add(model);
				$("#custom-widget").replaceWith(divClone);
			} });

		$('#custom-widget', el).html(widget_custom_view.render(true).el);
		
		// Is Custom widget for all.
		if(!($(this).hasClass('add_to_all'))){
			isForAll = false;
		}

		$('#custom_isForAll').val(isForAll);
		
        $('#prefs-tabs-content').off('click', '#cancel_custom_widget');
		$('#prefs-tabs-content').on('click', '#cancel_custom_widget', function(e)
		{
			// Restore element back to original
			$("#custom-widget").replaceWith(divClone); 
		});
	});
}
/**

	appends datasync widgets by fetching collection in single call
*/

function organize_sync_widgets(base_model)
{
	var itemView = new Base_List_View({ model : base_model, template : 'admin-settings-import-skeleton', tagName : 'div', });

	// Get widget type from model (widget object)
	var sync_type = base_model.get('type');

	if (sync_type == "GOOGLE")
		$('#contact-prefs', this.el).append($(itemView.render().el));
	if (sync_type == "STRIPE")
		$('#stripe', this.el).append($(itemView.render().el));
	if (sync_type == "FRESHBOOKS")
		$('#freshbook', this.el).append($(itemView.render().el));
	if (sync_type == "SHOPIFY")
		$('#shopify', this.el).append($(itemView.render().el));
	if (sync_type == "QUICKBOOK")
		$('#quickbook', this.el).append($(itemView.render().el));

}



/**

single click for all data sync collection events
*/
function initializeDataSyncListners(){


	$('#prefs-tabs-content #data-sync-type').off();
    $('#prefs-tabs-content').on('click', '#data-sync-type', function(e){

		var sync_type=$(this).attr("sync_type");
		if(sync_type=="GOOGLE"){
		// URL to return, after fetching token and secret key from LinkedIn
		var callbackURL = window.location.href + "/contacts";
		console.log(callbackURL);
		// For every request of import, it will ask to grant access
		window.open("/scribe?service=google&window_opened=true&return_url=" + encodeURIComponent(callbackURL),'dataSync','height=1000,width=500');
		}
		if(sync_type=="STRIPE"){

			var callbackURL = window.location.origin + "/#sync/stripe-import";
		// For every request of import, it will ask to grant access
		window.open( "/scribe?service=stripe_import&window_opened=true&return_url=" + encodeURIComponent(callbackURL),'dataSync','height=1000,width=500');
		return false;
		}
		if(sync_type=="SHOPIFY"){

			Backbone.history.navigate("#sync/shopify" , {
                trigger: true
            });
		}
		if(sync_type=="QUICKBOOK"){

		window.open('/OAuthServlet?service=quickbook-import&window_opened=true&return_url=' + encodeURIComponent(window.location.href) + 'quickbooks','dataSync','height=1000,width=500');

		return false;
		}
		if(sync_type=="FRESHBOOKS"){
			Backbone.history.navigate("#sync/freshbooks" , {
                trigger: true
            });
		}
	});




	$('#prefs-tabs-content #sync-import-prefs-delete').off();
    $('#prefs-tabs-content').on('click', '#sync-import-prefs-delete', function(e){
		

    	if(!confirm("Are you sure you want to delete?"))
		    		return false;
		var sync_widget_type=$(this).attr("data_sync_type");

		var sync_widget_id=$(this).attr("data_sync_id");

		if(!sync_widget_type)
			return;
		var deleteSyncUrl="core/api/contactprefs/delete/"+sync_widget_type+"/"+sync_widget_id;
		$.ajax({
 				url : deleteSyncUrl,
				type : 'DELETE',
				success : function(){
					console.log("success");
					
					App_Datasync.dataSync();
				}
			});
		
			

	});



	
}

/**

	function call to close newly opend window after authentication done. 
*/

function executeDataSyncReturnCallback(returnUrl,serviceName){
		
		if(serviceName=='google_calendar'){
			App_Datasync.google_calendar();
			return;
		}

		DATA_SYNC_FORCE_FETCH=true;
		if(serviceName=='shopify'){
			App_Datasync.shopify();
			return;
		}
		returnUrl=returnUrl.substr(returnUrl.indexOf('#'));

		if(window.location.hash==returnUrl && (serviceName=='quickbook-import' || serviceName=='stripe_import')){
			window.location.reload();
			return;
		}

		Backbone.history.navigate(returnUrl , {
                trigger: true
            });		
}

function executeCloseWindowCallback(returnUrl){
	Backbone.history.navigate(returnUrl , {
                trigger: true
            });		
}

var DATA_SYNC_FORCE_FETCH=false;

/**

fetches the model from collection if collection exists
else fetchs colection and returns model
*/
function getSyncModelFromName(name, callback){

       // Checks force fetch
       if(DATA_SYNC_FORCE_FETCH){
       		DATA_SYNC_FORCE_FETCH=false;

       		App_Datasync.agile_sync_collection_view = new Base_Collection_View({ url : '/core/api/contactprefs/allPrefs' });

			// Fetch the list of widgets
			App_Datasync.agile_sync_collection_view.collection.fetch({ success : function(data)
			{
				callback(getModalfromName(data.toJSON(), name));
				
			} });
       	 
      	 return;
       }

       // Check view obj
       if(App_Datasync.agile_sync_collection_view){
          return callback(getModalfromName(App_Datasync.agile_sync_collection_view.collection.toJSON(), name));
       }
       else{
       	DATA_SYNC_FORCE_FETCH=true;
       	callback(getSyncModelFromName(name,callback));
       }
  }


/**

iterates over collection and fetches model based on type
name is type i.e GOOGLE or STRIPE or SHOPIFY etc
*/
  function getModalfromName(collection, name){

	for (var i in collection){
		var model=collection[i];
		if(model.type==name){
			return model;
		}
	}
      
  }

/**

renders inner sync view and binds all model events to DataSync_Event_Modal_View
*/

  function renderInnerSyncView(url,templateName,data,callback){

  		 var data_sync = new DataSync_Event_Modal_View({
			                    url: url,
			                    template: templateName,
			                    data:data,
			                    saveCallback: function(model) {
			                       callback(model);
			                    }
			                });

			   $("#prefs-tabs-content").html(data_sync.render().el);
  }


// Twilio call noty when user change tab
var Twilio_Call_Noty;
var Twilio_Call_Noty_IMG = "";

var To_Number;
var To_Name = "";

var Twilio_Token;
var Verfied_Number;
var globalconnection;
var Twilio_Setup_Called = false;
var Twilio_Start = false;
var Restart_Twilio = false;
TWILIO_CONTACT_ID = 0;
TWILIO_CALLTYPE = "";
TWILIO_DIRECTION = "";
TWILIO_CALLED_NO = "";
TWILIO_IS_VOICEMAIL = false;

function initializeTwilioGlobalListeners(){
	
}

$(function(){

	// After 15 sec procedure will start.
	setTimeout(function()
	{
		// after DOM ready.
		if (document.readyState === "complete")
		{
			globalTwilioIOSetup();
		}
	}, 10000); // 15 sec
    
    $('body').off('click', '.noty_twilio_mute');
	$('body').on('click', '.noty_twilio_mute', function(e)
			{
				e.preventDefault();
				console.log("Twilio call noty_twilio_mute from noty");
				
				globalconnection.mute(true);
				
				$('.noty_buttons').find('.noty_twilio_unmute').toggle();
				$('.noty_buttons').find('.noty_twilio_mute').toggle();
			});
	
    $('body').off('click', '.noty_twilio_unmute');
	$('body').on('click', '.noty_twilio_unmute', function(e)
			{
				e.preventDefault();
				console.log("Twilio call noty_twilio_unmute from noty");

				globalconnection.mute(false);
				
				$('.noty_buttons').find('.noty_twilio_unmute').toggle();
				$('.noty_buttons').find('.noty_twilio_mute').toggle();
			});
	
	$('body').off('click', '.noty_twilio_hangup');
	$('body').on('click', '.noty_twilio_hangup', function(e)
	{
		e.preventDefault();
		console.log("Twilio call hang up from noty");

		Twilio.Device.disconnectAll();
	});

    $('body').off('click', '.noty_twilio_dialpad');
	$('body').on('click', '.noty_twilio_dialpad', function(e)
	{
		e.preventDefault();
		console.log("Twilio call dailpad from noty");

		$('.noty_buttons').find('#dialpad_in_twilio').toggle();
	});
	
	//START voice mails
    $('body').off('click', '#noty_twilio_voicemail');
	$('body').on('click', '#noty_twilio_voicemail', function(e){
		e.preventDefault();
		var voiceMailCount = parseInt($(this).attr('data-length'));
		if(voiceMailCount === 1) {
			sendVoiceAndEndCall($(this).attr('data-src'));
		} else {
			$("#splitButtonVoicemail").trigger("click");
		}
	});
	
    $('body').off('click', '.voiceMailItem');
	$('body').on('click', '.voiceMailItem', function(e){
		e.preventDefault();
		sendVoiceAndEndCall($(this).attr('data-src'));
	});
		
	//END voice mails related
    $('body').off('click', '.noty_twilio_answer');
	$('body').on('click', '.noty_twilio_answer', function(e)
	{
		e.preventDefault();
		console.log("Twilio call answered from noty");

		globalconnection.accept();
	});

    $('body').off('click', '.noty_twilio_ignore');
	$('body').on('click', '.noty_twilio_ignore', function(e)
	{
		e.preventDefault();
		console.log("Twilio call ignore from noty");

		globalconnection.ignore();
		if(CALL_CAMPAIGN.start){
				CALL_CAMPAIGN.state = "START";
				dialNextCallManually();			
	}
	});

    $('body').off('click', '.noty_twilio_cancel');
	$('body').on('click', '.noty_twilio_cancel', function(e)
	{
		e.preventDefault();
		console.log("Twilio call canceld from noty");

		//globalconnection.disconnect();

		Twilio.Device.disconnectAll();
	});

    $('body').off('click', '#validate_account');
	$('body').on('click', '#validate_account', function(e)
	{
		e.preventDefault();
		console.log("In validate event");

		if ($(this).text() == "Validating...")
		{
			console.log("Do not hit me again " + $(this).text());
			return;
		}

		// Checks whether all input fields are given
		if (!isValidForm($("#twilioio_login_form")))
		{
			return;
		}

		var acc_sid = $("#twilio_acc_sid").val();
		var auth_token = $("#twilio_auth_token").val();

		// if (acc_sid.match("^AC"))
		{
			// Change validate to validating
			$("#validate_account").text("Validating...");
			$("#validate_account").attr("disabled", true);

			// validate entered details and get verified numbers
			getValidateAndVerfiedCallerId(acc_sid, auth_token, null);
		}
		/*
		 * else alert("Account SID should start with 'AC'");
		 */
	});

    $('body').off('change', '#twilio_number');
	$('body').on('change', '#twilio_number', function(e)
	{
		e.preventDefault();
		$("#error-number-not-selected").hide();

		var numberSID = $("#twilio_number option:selected").attr("data");
		console.log("twilio_number change");
		console.log("twilio_number " + $(this).val() + " clicked " + numberSID);

		$("#twilio_number_sid").val(numberSID);
	});
	
    $('body').off('change', '#twilio_from_number');
	$('body').on('change', '#twilio_from_number', function(e)
	{
		e.preventDefault();
		$("#error-number-not-selected").hide();
	});

    $('body').off('click', '.contact-make-twilio-call');
	$('body').on('click', '.contact-make-twilio-call', function(e)
	{
		e.preventDefault();
		TWILIO_CALLTYPE = "Outgoing";
		TWILIO_DIRECTION = "outbound-dial";
		TWILIO_IS_VOICEMAIL = false;
		
//		alert("connecting twilio call");
		
		var contactDetailsObj = agile_crm_get_contact();
		TWILIO_CONTACT_ID = contactDetailsObj.id;
//		alert(TWILIO_CONTACT_ID);

		if (Twilio.Device.status() == "busy")
		{
			alert("Already on call.");
			return;
		}

		console.log("phone: " + $(this).attr("phone"));

		if(CALL_CAMPAIGN.start )
			  {
				if(CALL_CAMPAIGN.state == "PAUSE"){
					alert("Already on call");
					return;
				}
				CALL_CAMPAIGN.state = "PAUSE" ;
			  }
		twiliocall($(this).attr("phone"), getContactName(contactDetailsObj));
	});

	$('body').off('click', '#twilio_acc_sid, #twilio_auth_token');
    $('body').on('click', '#twilio_acc_sid, #twilio_auth_token', function(e)
	{
		e.preventDefault();
		$("#note-number-not-available").hide();
	});
	
    $('body').off('click', '.twilioio-advance-settings');
	$('body').on('click', '.twilioio-advance-settings', function(e)
	 {
		e.preventDefault();
		
		// If twimlet url is none so display nothing
		if("None" == $("#twilio_twimlet_url").val())
			$("#twilio_twimlet_url").val(""); 
		
		// Toggle advanced settings
		$(".twilioio-advance-settings-hide").toggle();
	    $(".twilioio-advance-settings-show").toggle();
	    $("#twilio_recording").toggle();
	    $("#twilio_twimlet_url_controls").toggle();
	 });

    $('body').off('click', '#twilio_verify_settings');
	$('body').on('click', '#twilio_verify_settings', function(e)
			{
				e.preventDefault();

				getTemplate('twilio-initial', {}, undefined, function(template_ui){
					if(!template_ui)
						  return;
					$('#widget-settings').html($(template_ui));	

				}, "#widget-settings");
			});
	
		/*
		 * If Twilio account doesn't have numbers, we need to verify numbers in
		 * Twilio.On click of verify button in Twilio initial template,
		 * verifyNumberFromTwilio is called to verify a number in Twilio
		 */
        $('body').off('click', '#twilio_verify');
		$('body').on('click', '#twilio_verify', function(e)
		{
			e.preventDefault();

			// Checks whether all input fields are given
			if (!isValidForm($("#twilio_call_form")))
				return;

			// From number to make calls as entered by user
			var from_number = $('#twilio_from').val();
			console.log("Twilio verify from number: " + from_number);

			$.getJSON("core/api/widgets/Twilio", function(data)
					{
						console.log(data);
						
						if(data)
						{
							/*
							 * Verifies a number in Twilio and shows verification code in the Twilio
							 * template with a procced button
							 */
							verifyNumberFromTwilio(from_number, data.id, function(verified_data)
							{
								verified_data["settings"] = true;
								// Append the url with the random number in order to differentiate the same action performed more than once.
								verified_data["id"] = Math.floor((Math.random()*10)+1);
								
								console.log(verified_data);
								getTemplate('twilio-verify', verified_data, undefined, function(template_ui){
									if(!template_ui)
										  return;

									$('#widget-settings').html($(template_ui));	
								}, "#widget-settings");

							});
						}
					});
		});
	
});

/*
 * Get token from widget details and setup twilio device. Caller : 1.
 * Twilio.Device.offline 2. init() 3. save_widget_prefs(...)
 */

function globalTwilioIOSetup()
{
	console.log("Twilio_Setup_Called: " + Twilio_Setup_Called);

	if (Twilio_Setup_Called)
		return;

	Twilio_Setup_Called = true;

	// Get Sip widget
	$.getJSON("/core/api/widgets/TwilioIO", function(twilioio_widget)
	{
		console.log("twilioio_widget");
		console.log(twilioio_widget);

		if (twilioio_widget == null)
			return;

		if (twilioio_widget.prefs != undefined)
		{
			twilioio_widget.prefs = eval("(" + twilioio_widget.prefs + ")");

			if (twilioio_widget.prefs.twilio_from_number)
				Verfied_Number = twilioio_widget.prefs.twilio_from_number;
			else
				Verfied_Number = twilioio_widget.prefs.twilio_number;
			
			getGlobalToken();
		}
	}).error(function(data)
	{
		console.log("twilioio error");
		console.log(data);
	});
}

function getGlobalToken()
{
	console.log("****** In getGlobalToken ******");
	Restart_Twilio = false;

	$.get("/core/api/widgets/twilio/getglobaltoken", function(token)
	{
		console.log("Twilio token " + token);
		Twilio_Token = token;

		setUpGlobalTwilio();

		// Restart twilio after 24 hrs with new token, because token life is 24hrs
		setTimeout(function()
		{
			// After 24hrs check where call is connected or not 
			if (Twilio.Device.status() == "busy")
			{
				Restart_Twilio = true;
			}
			else
			{
				// Get widget, Create token and set twilio device
				globalTwilioIOSetup();
			}
		}, 86400000); // 24 hr = 86400000ms

	}).error(function(data)
	{
		console.log("Twilio IO error ");
		console.log(data);
	});
}

function getValidateAndVerfiedCallerId(acc_sid, auth_token, callback)
{
	$.get("/core/api/widgets/twilio/validateaccount/" + acc_sid + "/" + auth_token, function(result)
	{
		console.log("Twilio validate account " + result);
		console.log(result);
		result = eval("(" + result + ")");
		console.log("Twilio validate account " + result);

		if (result)
		{
			// Get twilio number
			getTwilioNumbers(acc_sid, auth_token, function(twilioNumbers)
			{
				// Get verified number
				getVerifiedNumbers(acc_sid, auth_token, function(verifiedNumbers)
				{
					addNumbersInUI(twilioNumbers, verifiedNumbers);

					// If defined, execute the callback function
					if (callback && typeof (callback) === "function")
						callback(result);
				});
			});
		}
		else
			setToValidate(result, true);
	}).error(function(data)
	{
		console.log("Twilio validate account error");
		setToValidate(data, true);
	});
}

function addNumbersInUI(twilioNumbers, verifiedNumbers)
{
	console.log("Twilio twilio number " + twilioNumbers + "  " + verifiedNumbers);
	console.log("Twilio twilio number " + twilioNumbers.length + "  " + verifiedNumbers.length);

	// no twilio # as well as no verified #
	if (twilioNumbers.length == 0 && verifiedNumbers.length == 0)
	{
		// Reset form
		setToValidate("no number", false);

		// Add error msg at bottom of form
		$("#note-number-not-available").html("You have no twilio numbers and verified numbers.");
		$("#note-number-not-available").show();
	}
	// twilio # is available but no verified #
	else if (twilioNumbers.length != 0 && verifiedNumbers.length == 0)
	{
		// Add note at bottom you do not have verified #
		$("#note-number-not-available").html("You have no verified numbers. Please verify number in your Twilio account.");
		$("#note-number-not-available").show();

		// If no numbers
		if (!twilioNumbers[0].PhoneNumber)
		{
			alert("You have no twilio numbers. Please buy or port a number in your Twilio account.");
			return;
		}

		console.log("Twilio twilio number " + twilioNumbers[0].PhoneNumber);

		// Add verified number in UI
		addTwilioNumbersInUI(twilioNumbers);

		// Hide validate button
		$("#validate_account").hide();

		// Show save button
		$("#save_prefs").show();

		// Hide twilio from numbers list
		$("#twilio_from_numbers").hide();

		// Show twilio numbers list
		$("#twilio_numbers").show();

		$("#twilio_number").addClass("required");
	}
	// verified # is available but no twilio #
	else if (twilioNumbers.length == 0 && verifiedNumbers.length != 0)
	{
		// Add note at bottom you do not have twilio #
		$("#note-number-not-available").html("You have no twilio numbers. Please buy or port a number in your Twilio account.");
		$("#note-number-not-available").show();

		// If no numbers
		if (!verifiedNumbers[0].PhoneNumber)
		{
			alert("You have no verified numbers. Please verify number in your Twilio account.");
			return;
		}

		console.log("Twilio verified number " + verifiedNumbers[0].PhoneNumber);

		// Add verified number in UI
		addVerifiedCallerIdInUI(verifiedNumbers);

		// Hide validate button
		$("#validate_account").hide();

		// Show save button
		$("#save_prefs").show();

		// Show twilio from numbers list
		$("#twilio_from_numbers").show();

		// Hide twilio numbers list
		$("#twilio_numbers").hide();

		$("#twilio_from_number").addClass("required");
	}
	// both available
	else if (twilioNumbers.length != 0 && verifiedNumbers.length != 0)
	{
		// Add verified number in UI
		addTwilioNumbersInUI(twilioNumbers);

		// Add verified number in UI
		addVerifiedCallerIdInUI(verifiedNumbers);

		// Hide validate button
		$("#validate_account").hide();

		// Show save button
		$("#save_prefs").show();

		// Show twilio from numbers list
		$("#twilio_from_numbers").show();

		// Show twilio numbers list
		$("#twilio_numbers").show();
	}
	
	// Show record call option on form
	//$("#twilio_recording").show();
	
	// Show twimlet url controls
	//$("#twilio_twimlet_url_controls").show();
}

function setToValidate(data, showAlert)
{
	// Change validate to validating
	$("#validate_account").text("Validate");
	$("#validate_account").attr("disabled", false);

	console.log("Twilio error ");
	console.log(data);

	if (showAlert)
		alert("Please enter valid details.");

	// Reset form fields after sending email
	$("#twilioio_login_form").each(function()
	{
		this.reset();
	});
}

function getTwilioNumbers(acc_sid, auth_token, callback)
{
	$.get("/core/api/widgets/twilio/gettwilionumbers/" + acc_sid + "/" + auth_token, function(result)
	{
		console.log("Twilio getTwilioNumbers " + result);
		console.log(result);
		result = eval("(" + result + ")");
		console.log("Twilio getTwilioNumbers " + result);

		// If defined, execute the callback function
		if (callback && typeof (callback) === "function")
			callback(result);
	}).error(function(data)
	{
		console.log("error in getTwilioNumbers");
		setToValidate(data, true);
	});
}

function getVerifiedNumbers(acc_sid, auth_token, callback)
{
	$.get("/core/api/widgets/twilio/getverifiednumbers/" + acc_sid + "/" + auth_token, function(result)
	{
		console.log("Twilio getVerifiedNumbers " + result);
		console.log(result);
		result = eval("(" + result + ")");
		console.log("Twilio getVerifiedNumbers " + result);

		// If defined, execute the callback function
		if (callback && typeof (callback) === "function")
			callback(result);
	}).error(function(data)
	{
		console.log("error in getVerifiedNumbers");
		setToValidate(data, true);
	});
}

function addTwilioNumbersInUI(result)
{
	var phoneNumberHtml = '<option value="" default selected style="display:none;">Select a Twilio number</option>';
	var optionHtml = "";

	// Collect all twilio number for display
	$.each(result, function(index, phoneNumber)
	{
		optionHtml = '<option data="' + phoneNumber.Sid + '" value="' + phoneNumber.PhoneNumber + '">' + phoneNumber.PhoneNumber + '</option>';
		phoneNumberHtml = phoneNumberHtml + optionHtml;
	});

	optionHtml = '<option data="" value="">None</option>';
	phoneNumberHtml = phoneNumberHtml + optionHtml;
	
	// Add verified number in list
	$("#twilio_number").html(phoneNumberHtml);
}

function addVerifiedCallerIdInUI(result)
{
	var phoneNumberHtml = '<option value="" default selected style="display:none;">Select a verifed number</option>';
	var optionHtml = "";

	// Collect all verified number for display
	$.each(result, function(index, phoneNumber)
	{
		optionHtml = '<option value="' + phoneNumber.PhoneNumber + '">' + phoneNumber.PhoneNumber + '</option>';
		phoneNumberHtml = phoneNumberHtml + optionHtml;
	});

	optionHtml = '<option data="" value="">None</option>';
	phoneNumberHtml = phoneNumberHtml + optionHtml;
	
	// Add verified number in list
	$("#twilio_from_number").html(phoneNumberHtml);
}

//
function createAppSid(twilioio_prefs, callback)
{
	console.log("In createAppSid");
	var numberSid = "None";
	if (twilioio_prefs.twilio_number_sid != "")
		numberSid = twilioio_prefs.twilio_number_sid;

	if (twilioio_prefs.twilio_twimlet_url == "")
		twilioio_prefs.twilio_twimlet_url = "None";
	
	$.get("/core/api/widgets/twilio/createappsid/" + twilioio_prefs.twilio_acc_sid + "/" + twilioio_prefs.twilio_auth_token + "/" + numberSid+ "/" + twilioio_prefs.twilio_record+ "/" + encodeURIComponent(twilioio_prefs.twilio_twimlet_url), function(result)
	{
		console.log("Twilio createAppSid " + result);

		// If defined, execute the callback function
		if (callback && typeof (callback) === "function")
			callback(result);
	}).error(function(data)
	{
		console.log("Twilio get app sid error ");
		console.log(data);

		alert("Please try again with valid details.");

		$("#save_prefs").text("Save");
		$("#save_prefs").attr("disabled", false);
		$("#save_prefs").hide();
		$("#validate_account").text("Validate");
		$("#validate_account").attr("disabled", false);
		$("#validate_account").show();

		// Show twilio from numbers list
		$("#twilio_from_numbers").hide();

		// Show twilio numbers list
		$("#twilio_numbers").hide();

		// Hide record call option on form
		//$("#twilio_recording").hide();
		
		// Hide twimlet url controls
		//$("#twilio_twimlet_url_controls").hide();
		
		// Reset form fields after sending email
		$("#twilioio_login_form").each(function()
		{
			this.reset();
		});
	});
}

function fill_twilioio_numbers()
{
	// Hide validate button
	$("#validate_account").hide();

	// Show save button
	$("#save_prefs").show();

	$("#save_prefs").text("Loading...");
	$("#save_prefs").attr("disabled", true);
	
	// Retrieves widget which is fetched using script API
	// Get TwilioIO widget
	$.getJSON("/core/api/widgets/TwilioIO", function(twilioio_widget)
	{
		if (twilioio_widget == null)
			return;

		console.log("twilioio_widget");
		console.log(twilioio_widget);

		if (twilioio_widget.prefs != undefined)
		{
			twilioio_widget.prefs = eval("(" + twilioio_widget.prefs + ")");
			
			// Show advanced settings if data available
			if((twilioio_widget.prefs.twilio_record == "true") || (twilioio_widget.prefs.twilio_twimlet_url != "None"))
				$(".twilioio-advance-settings").click();

			getValidateAndVerfiedCallerId(twilioio_widget.prefs.twilio_acc_sid, twilioio_widget.prefs.twilio_auth_token, function(data)
			{
				console.log("In callback getValidateAndVerfiedCallerId");
				$('#twilio_from_number').val(twilioio_widget.prefs.twilio_from_number);
				$('#twilio_number').val(twilioio_widget.prefs.twilio_number);
				$('#twilio_number_sid').val(twilioio_widget.prefs.twilio_number_sid);
				$("#save_prefs").text("Save");
				$("#save_prefs").attr("disabled", false);
			});
		}
	}).error(function(data)
	{
		console.log("twilioio_widget error");
		console.log(data);
	});
}

function setUpGlobalTwilio()
{
	// Loads twilio min.js to intiliaze twilio call events
	head.js("https://static.twilio.com/libs/twiliojs/1.2/twilio.min.js", function()
	{
		Twilio.Device.setup(Twilio_Token);

		if (Twilio_Start)
			return;

		Twilio_Start = true;

		Twilio.Device.ready(function(device)
		{
			console.log("ready");

			console.log("in twilio ready Twilio_Setup_Called: " + Twilio_Setup_Called);
			Twilio_Setup_Called = false;

			// Make call option visible on contact detail page
			// Sequence of calling option 1) BRIA 2) Twilio 3) SIP
			if(default_call_type == "Bria"){
				if(callFromBria == true){
					$(".contact-call-button").removeAttr('disabled');
					$(".contact-make-call").removeAttr("href");
					$(".contact-call-button").addClass('contact-make-bria-call');
					var selector = '.contact-call-button-div';
					var text = "Call from Bria";
					changeTooltipTo(selector,text);
				}
			}else{
				if(Twilio.Device.status() == "ready" || Twilio.Device.status() == "busy")
					//else if (Twilio.Device.status() == "ready" || Twilio.Device.status() == "busy")			
					{
						$(".contact-call-button").removeAttr('disabled');
						$(".contact-make-call").removeAttr("href");
						$(".contact-call-button").addClass('contact-make-twilio-call');
						var selector = '.contact-call-button-div';
						var text = "Call from Twilio";
						changeTooltipTo(selector,text);
					}else if (Sip_Stack != undefined && Sip_Register_Session != undefined && Sip_Start == true)
						{
							$(".contact-call-button").removeAttr('disabled');
							$(".contact-make-call").removeAttr("href");
							$(".contact-call-button").addClass('contact-make-sip-call');
							var selector = '.contact-call-button-div';
							var text = "Call from SIP";
							changeTooltipTo(selector,text);
						}
			}
		});

		Twilio.Device.error(function(error)
		{
			console.log("Twilio error");
			console.log(error);
			console.log(error.code);

			if (Twilio.Device.status() == "busy")
			{
				if(!(CALL_CAMPAIGN.start && CALL_CAMPAIGN.call_from_campaign)){
					alert("A connection is currently active.");
					return;
				}
			}
			Twilio.Device.disconnectAll();

			closeTwilioNoty();

			// Token expired error
			if (error.code == "31205")
			{
				// Get widget, Create token and set twilio device
				globalTwilioIOSetup();
			}
			
			if (error.code == "31000")
			{
				// Get widget, Create token and set twilio device
				Twilio_Start = false;
				setUpGlobalTwilio();
			}
/*			if(CALL_CAMPAIGN.state == "START" ){
				restartCalling();
			}*/
		});

		Twilio.Device.connect(function(conn)
		{
			console.log("Twilio call is connected");
			// Called for all new connections
			console.log(conn);
			console.log(conn._status);
			globalconnection = conn;

				// If call campaign then update call noty
				if(CALL_CAMPAIGN.start && CALL_CAMPAIGN.call_from_campaign)
				  {
					
						// Change status of call
						CALL_CAMPAIGN.call_status = "CONNECTED";				
						
						// Start all timers
						//setTimerCallDuration();
						
						// Edit call status on call noty
						//$(".call_status").html("On Call");
						//$("#currentTime").html("");
						editCallContainer();
						
						return;
					 
				  }else{
						//TWILIO_CALLTYPE = "Incoming";
						//TWILIO_DIRECTION = "inbound";
						//To_Number = globalconnection.parameters.From;
						//To_Name = searchForContact(To_Number);
						//Twilio_Call_Noty_IMG = addContactImg("Incoming");
					  
						console.log("calling call noty");
						showCallNotyPopup("connected", "Twilio", Twilio_Call_Noty_IMG+'<span class="noty_contact_details"><b>On call  </b>' + To_Number +'<br><a href="#contact/'+TWILIO_CONTACT_ID+'" style="color: inherit;">' + To_Name + '</a><br></span><div class="clearfix"></div>', false);
					 }		
		});

		Twilio.Device.disconnect(function(conn)
		{
			
			console.log("Twilio call is disconnected");

			if(CALL_CAMPAIGN.start){
				CALL_CAMPAIGN.call_status = "DISCONNECTED";
			}
			// Called for all disconnections
			console.log(conn);
			
			var phoneNumber = To_Number;
			var messageObj = conn.message;
			
			if (Twilio.Device.status() != "busy")
			{
				closeTwilioNoty();
					if(globalconnection){
						globalconnection.mute(false);
					}				

				// after disconnect check If restart is set so restart twilio with new token.
				// restart is set after 24hrs
				if (Restart_Twilio == true)
				{
					// Get widget, Create token and set twilio device
					globalTwilioIOSetup();
				}
			}
			
			try{
				// Get all call logs for widget only on cotact detail page
				if(window.location.hash.indexOf("contact/") != -1)
				  {
					if(typeof getTwilioIOLogs == 'undefined')
						return;
					
					getTwilioIOLogs(phoneNumber);
					
					// Change selected number if its different than calling number.
					var selectedNumber = $('#contact_number').val();
					if(selectedNumber != phoneNumber)
					{
						$("#contact_number").val(phoneNumber);
					}
				  }		
			}catch(err){
				console.log('error in log fetching' + err.message);
			}
	   	
			
		
		try{
			// notes related code			
			console.log("calSid new  " + conn.parameters.CallSid);
			
			
			twilioGetWidgetDetails(function(data){

				var widgetDetails = data;
				var widgetPrefs = $.parseJSON(data.prefs);
				var acc_sid = widgetPrefs.twilio_acc_sid;
				var auth_token = widgetPrefs.twilio_auth_token;	
				var isParent = "true";
				if(TWILIO_CALLTYPE == "Incoming") {
					isParent = "false";
				}

				var ApiCallUrl = "/core/api/widgets/twilio/getlastcall/" + acc_sid + "/" + auth_token + "/" + conn.parameters.CallSid + "/" + isParent;
				console.log(ApiCallUrl);
				if(!widgetDetails)
					return;

				twilioApiRequest(ApiCallUrl, function(data){
						var callDetails  = data;
						console.log("Call Details : isParent " + isParent);
						console.log(callDetails);
						
						if(!callDetails)
							return;

						var callDetailsJson = $.parseJSON(callDetails.responseText);
						if(isParent == "true")
							var callRespJson = callDetailsJson.calls[0];
						else
							var callRespJson = callDetailsJson;
						
						if(typeof callRespJson != "undefined") {
							if(typeof callRespJson.status != "undefined") {
								if(callRespJson.status != "completed" && CALL_CAMPAIGN.start){
									CALL_CAMPAIGN.state = "DISCONNECTED";
								}
								console.log(callRespJson.status);
								showNoteAfterCall(callRespJson,messageObj);
							}
						} else {
							if(CALL_CAMPAIGN.start){
								CALL_CAMPAIGN.state = "DISCONNECTED";
							}						

						}
						
							//if the call campaign is started then we try to make a next call from campaign
								if(($("#noteModal").data('bs.modal') || {}).isShown != true){
								if(CALL_CAMPAIGN.start)
								  {
									if(CALL_CAMPAIGN.call_from_campaign ){
											// if state is pause i.e callresp.status != completed then make another call
												if(CALL_CAMPAIGN.state == "DISCONNECTED"){
													CALL_CAMPAIGN.state = "START";
														
													  if(CALL_CAMPAIGN.autodial){
														  dialNextCallAutomatically();
													  }else{
														  if(CALL_CAMPAIGN.last_clicked == "NEXT" || CALL_CAMPAIGN.last_clicked == "PREVIOUS"){
															  dialNextCallAutomatically();
														  }else{
															  dialNextCallManually();
														  }
													  }
												}
									}else{
											CALL_CAMPAIGN.state = "START";
											dialNextCallManually();
										  }
								  	}	
								}
				});			

			});
			}catch(err){
				console.log("error --> " + err.message);
				if(CALL_CAMPAIGN.start)
				  {
					CALL_CAMPAIGN.state = "START";
					dialNextCallAutomatically();
				}
			}										
		});

		Twilio.Device
				.incoming(function(conn)
				{
					TWILIO_CALLTYPE = "Incoming";
					TWILIO_DIRECTION = "inbound";
					TWILIO_IS_VOICEMAIL = false;
					TWILIO_CONTACT_ID = 0;
					globalconnection = conn;
					var previousDialled;
					
						if(To_Number){
							previousDialled = To_Number;
						}
					
					To_Number = globalconnection.parameters.From;
					console.log("Incoming connection from " + conn.parameters.From);
					console.log("globalconnection status: "+globalconnection.status());


					addContactImg("Incoming", function(img){
						Twilio_Call_Noty_IMG = img;
					
						if (Twilio.Device.status() == "busy" || (CALL_CAMPAIGN.call_status == "CONNECTED" || CALL_CAMPAIGN.call_status == "CALLING" || CALL_CAMPAIGN.autodial == true))
						{
							console.log("getting one more call.");

							showCallNotyPopup("missedCall", "error", Twilio_Call_Noty_IMG+'<span class="noty_contact_details"><b>Missed call : </b><br>' + conn.parameters.From + '<br></span><div class="clearfix"></div>', 5000);
							if(previousDialled){
								To_Number = previousDialled ;  
							}
							conn.reject();						
							if (conn)
								conn.disconnect();
							return;
						}
					
						if(CALL_CAMPAIGN.start){
							CALL_CAMPAIGN.state = "PAUSE";
						}

					// accept the incoming connection and start two-way audio
					// conn.accept();

						searchForContact(To_Number, function(name){
								To_Name = name;


								showCallNotyPopup("incoming", "Twilio",
										Twilio_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Incoming call </b>'+ To_Number + '<br><a href="#contact/'+TWILIO_CONTACT_ID+'" style="color: inherit;">' + To_Name + '</a><br></span><div class="clearfix"></div>', false);										
						});
					});	
					
				});

		// If any network failure, show error
		Twilio.Device.offline(function()
		{
			// Called on network connection lost.
			console.log("Twilio went offline");

			closeTwilioNoty();

			// Get widget, Create token and set twilio device
			// globalTwilioIOSetup();
		});

		// When call is cancelled, hide hang up and show call
		Twilio.Device.cancel(function(conn)
		{
			// who canceled the call
			console.log(conn.parameters.From);
			closeTwilioNoty();
			
			console.log("Incoming call calSid new  " + conn.parameters.CallSid);
			
			var messageObj = conn.message;	

			twilioGetWidgetDetails(function(data){

				var widgetDetails = data;
				var widgetPrefs = $.parseJSON(widgetDetails.prefs);
				var acc_sid = widgetPrefs.twilio_acc_sid;
				var auth_token = widgetPrefs.twilio_auth_token;	
				var isParent = "true";
				if(TWILIO_CALLTYPE == "Incoming") {
					isParent = "false";
				}
				var ApiCallUrl = "/core/api/widgets/twilio/getlastcall/" + acc_sid + "/" + auth_token + "/" + conn.parameters.CallSid + "/" + isParent;
				console.log(ApiCallUrl);
				if(!widgetDetails)
					return;
				
				twilioApiRequest(ApiCallUrl, function(data1){

					var callDetails  = data1;
					console.log(callDetails);
					
					if(!callDetails)
						return;
					
					var callRespJson = $.parseJSON(callDetails.responseText);
					
					if(typeof callRespJson != "undefined") {
						if(typeof callRespJson.status != "undefined") {
							console.log(callRespJson.status);
							showNoteAfterCall(callRespJson,messageObj);
						}
					} 
					// added for call campaign
					if(CALL_CAMPAIGN.start){
						CALL_CAMPAIGN.state = "START";	
						if(CALL_CAMPAIGN.autodial){
							dialNextCallAutomatically();
						}else{
							dialNextCallManually();
						}
					}	

				});
			});		
			
		});

		/*
		 * Called for each available client when this device becomes ready and
		 * every time another client's availability changes.
		 */
		Twilio.Device.presence(function(presenceEvent)
		{
			// name of client whose availablity changed
			console.log(presenceEvent.from);

			// true or false
			console.log(presenceEvent.available);
		});
	});
}
function twiliocall(phoneNumber, toName)
{
	// get the phone number to connect the call to
	
	params = { "from" : Verfied_Number, "PhoneNumber" : phoneNumber};

	// if call campaign is running then modify call container	
	try{
		if(CALL_CAMPAIGN.start)
		  {
				if(Twilio.Device.status() == "busy" || CALL_CAMPAIGN.call_status == "CONNECTED" || CALL_CAMPAIGN.call_status == "CALLING"){
					return;
				}
				
			if(CALL_CAMPAIGN.call_from_campaign)
			  {
				// Change status of call
				TWILIO_CALLTYPE = "Outgoing";
				TWILIO_DIRECTION = "outbound-dial";
				CALL_CAMPAIGN.call_status = "CALLING";		
				$("#pauseCallDiv").hide();
				$("#callStartText").html("");
				$("#callStartTime").html("");
				$("#callPauseText").hide();
				// Edit call status on call noty
				//$(".call_status").html("Calling");
		  	  }
		  }	
	}catch(err) {
		console.log("error --> " + err.message);
		Twilio.Device.disconnectAll();
		$("#callStartText").html("");
		$("#callStartTime").html("");
		return;
	}
	
	Twilio.Device.connect(params);

	To_Number = phoneNumber;
	To_Name = toName;
	TWILIO_CALLED_NO = To_Number;	
	
	if(!CALL_CAMPAIGN.call_from_campaign){
		addContactImg("Outgoing", function(img){
			Twilio_Call_Noty_IMG = img;
			// this was added to remve the error of popup message	
				console.log("calling call noty");
				showCallNotyPopup("outgoing", "Twilio", Twilio_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Calling </b>'+ To_Number +'<br><a href="#contact/'+TWILIO_CONTACT_ID+'" style="color: inherit;">' + To_Name + '</a><br></span><div class="clearfix"></div>', false);
		});		
	}	
}

// Send DTMF signal to twilio active connection from dialpad.
function twilioSendDTMF(digit)
{
	console.log("twilioSendDTMF: " + digit);

	// session for call is active and number is available.
	if (Twilio.Device.status() == "busy" && digit)
	{
		// send dtmf on twilio
		// if (connection)
		globalconnection.sendDigits(digit);
	}
}

function closeTwilioNoty()
{
	if (Twilio.Device.status() == "busy")
		return;

	globalconnection = undefined;
	To_Number = undefined;
	To_Name = "";

	// Close noty
	if (Twilio_Call_Noty != undefined)
	{
		Twilio_Call_Noty.close();
		Twilio_Call_Noty = undefined;
	}
}

function showNoteAfterCall(callRespJson,messageObj)
{
	if(!(TWILIO_IS_VOICEMAIL == false))
		   return;

	var	el = $("#noteForm");
	//	TWILIO_CONTACT_ID = 0;

	if(CALL_CAMPAIGN.start){
		if(TWILIO_CALLTYPE == "Outgoing" && CALL_CAMPAIGN.call_from_campaign){
			getContactDetails();
		}
	}
	if(TWILIO_CONTACT_ID) {

		accessUrlUsingAjax("core/api/contacts/"+TWILIO_CONTACT_ID, function(resp){

			console.log(callRespJson);
			var json = resp;
			if(json == null) {
				return showNewContactModal(messageObj);
			}

			var contact_name = getContactName(json);
			var noteSub = "";
			var friendlyStatus = "";
			var callStatus = callRespJson.status;

			if(callStatus != 404 && typeof callRespJson.duration != "undefined") {
			
					var phoneNumber = "";
					if(TWILIO_DIRECTION == "outbound-dial") {
		//				phoneNumber = callRespJson.to;
						phoneNumber = TWILIO_CALLED_NO;
						TWILIO_CALLED_NO = "";
					}
					else
						phoneNumber = callRespJson.from;
					
					$.post( "/core/api/widgets/twilio/savecallactivity",{
						direction: TWILIO_DIRECTION, 
						phone: phoneNumber, 
						status : callRespJson.status,
						duration : callRespJson.duration 
						});
					
					switch(callStatus) {
				    case "canceled":
				    	noteSub = TWILIO_CALLTYPE + " call - Declined";
				    	friendlyStatus = "Declined";
				        break;
				    case "completed":
				    	noteSub = TWILIO_CALLTYPE + " call - Done";
				    	friendlyStatus = "Done";
				    	break;
				    case "busy":
				    	noteSub = TWILIO_CALLTYPE + " call - Busy";
				    	friendlyStatus = "Received busy tone on number "+ phoneNumber;
				    	break;
				    case "failed":
				    	noteSub = TWILIO_CALLTYPE + " call - Failed";
				    	friendlyStatus = TWILIO_CALLTYPE + " call made to "+ phoneNumber +" has failed";
				    	break;
				    case "no-answer":
				    	noteSub = TWILIO_CALLTYPE + " call - No answer";
				    	friendlyStatus = "No answer";
				    	break;
				    default:
				        return;
					}
				 	// Adds contact name to tags ul as li element
					if(callStatus == "completed") {
					 	$('.tags',el).html('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="'+ json.id +'">'+contact_name+'</li>');
					 	$("#noteForm #subject").val(noteSub);
				 		$("#noteForm #description").val("Call duration - "+ twilioSecondsToFriendly(callRespJson.duration));
				 		$("#noteForm").find("#description").focus();
						$('#noteModal').modal('show');
						agile_type_ahead("note_related_to", el, contacts_typeahead);
						//changed by prakash to add the last_called parameter and last_connected parameter of contact object on server side - 15/6/15
							if(TWILIO_DIRECTION == "outbound-dial") {
								twilioIOSaveContactedTime();	
							//code to be written to save tag to cotacts for call campaign...
							if(CALL_CAMPAIGN.start && CALL_CAMPAIGN.call_from_campaign){
								updateTotalTime(callRespJson.duration);
								saveTagForCampaign();
							}
							}
											
					} else {
						//add note automatically
						$.post( "/core/api/widgets/twilio/autosavenote", {
							subject: noteSub,
							message: "",
							contactid: TWILIO_CONTACT_ID
							});
					}
				}
		});
			
	} else {
		var phoneNumber = "";
		if(TWILIO_DIRECTION == "outbound-dial")
			phoneNumber = callRespJson.to;
		else
			phoneNumber = callRespJson.from;
		
		$.post( "/core/api/widgets/twilio/savecallactivity",{
			direction: TWILIO_DIRECTION, 
			phone: phoneNumber, 
			status : callRespJson.status,
			duration : callRespJson.duration 
			});
		return showNewContactModal(phoneNumber);
	}
	
}


function showNewContactModal(phoneNumber) {
	$('#personModal').modal('show');
	$("#personForm").find("#phone").val(phoneNumber);
	return;
}

function twilioSecondsToFriendly(time) {
	var hours = Math.floor(time / 3600);
	if(hours > 0)
	time = time - hours*60*60;
	var minutes = Math.floor(time / 60);
	var seconds = time - minutes * 60;
	var friendlyTime = "";
	if(hours == 1)
		friendlyTime = hours+ "h ";
	if(hours > 1)
		friendlyTime = hours+ "h ";
	if(minutes > 0)
		friendlyTime += minutes + "m ";
	if(seconds > 0)
		friendlyTime += seconds + "s ";
	if(friendlyTime != "")
	return friendlyTime;
}

function searchForContact(from, callback) {
	console.log("searchForContact : " + from);	
	
	var name = "";
	try {

	    accessUrlUsingAjax("core/api/contacts/search/phonenumber/"+from, function(responseJson){

	    	if(!responseJson)
	    		 callback(name);

			TWILIO_CONTACT_ID = responseJson.id;
			console.log("TWILIO_CONTACT_ID : "+TWILIO_CONTACT_ID);
			callback(getContactName(responseJson));
	    });
		
    } catch(e){
    	callback(name);
    }
}

function sendVoiceAndEndCall(fileSelected) {
	console.log("Sending voice mail...");

	if(TWILIO_IS_VOICEMAIL == false) {
		
		var conn = globalconnection;
		twilioGetWidgetDetails(function(data){
			var widgetDetails = data;
			var widgetPrefs = $.parseJSON(widgetDetails.prefs);

			var acc_sid = widgetPrefs.twilio_acc_sid;
			var auth_token = widgetPrefs.twilio_auth_token;	
			var isParent = "true";
			var ApiCallUrl = "/core/api/widgets/twilio/getlastcall/" + acc_sid + "/" + auth_token + "/" + conn.parameters.CallSid + "/" + isParent;
			if(!widgetDetails)
				return;

			twilioApiRequest(ApiCallUrl, function(data1){
				var callDetails  = data1;
				if(!callDetails)
					return;

				var callDetailsJson = $.parseJSON(callDetails.responseText);
				if(isParent == "true")
					var callRespJson = callDetailsJson.calls[0];
				else
					var callRespJson = callDetailsJson;

				if(typeof callRespJson != "undefined") {
				if(typeof callRespJson.status != "undefined" && callRespJson.status == 'in-progress') {

						// alert("Voicemail will be sent to user.Current call will be closed.");
						var messageObj = globalconnection.message;
						twilioVoiceMailRedirect(fileSelected, function(data){
								if(!data)
								  return;
								closeTwilioNoty();
								if(TWILIO_CONTACT_ID) {		
									//add note automatically
									$.post( "/core/api/widgets/twilio/autosavenote", {
										subject: TWILIO_CALLTYPE + " call - Left voicemail",
										message: "",
										contactid: TWILIO_CONTACT_ID
										});
									
									if(TWILIO_CALLED_NO != "") {
										$.post( "/core/api/widgets/twilio/savecallactivity",{
											direction: TWILIO_DIRECTION, 
											phone: TWILIO_CALLED_NO, 
											status : "voicemail",
											duration : 0 
											});
									}
									TWILIO_IS_VOICEMAIL = true;					
								}
						});
					}

				} else {
					return;
				}


			});
		});

	}
}

function twilioVoiceMailRedirect(fileSelected, callback) {

	twilioGetWidgetDetails(function(data){

		var widgetDetails = data;	
		if(!widgetDetails)
			return callback(false);

		var widgetPrefs = $.parseJSON(widgetDetails.prefs);
		var acc_sid = widgetPrefs.twilio_acc_sid;
		var auth_token = widgetPrefs.twilio_auth_token;	
		
		var isParent = "true";
		if(TWILIO_CALLTYPE == "Incoming") {
			isParent = "false";
		}
		var ApiCallUrl = "/core/api/widgets/twilio/getlastcall/" + acc_sid + "/" + auth_token + "/" + globalconnection.parameters.CallSid + "/" + isParent;
		console.log(ApiCallUrl);
		
		twilioApiRequest(ApiCallUrl, function(data1){
 	
 			var callDetails  = data1;
 			console.log("Call Details : isParent " + isParent);
			console.log(callDetails);	
			if(!callDetails)
				return;

			var callDetailsJson = $.parseJSON(callDetails.responseText);
			if(isParent == "true")
				var callRespJson = callDetailsJson.calls[0];
			else
				var callRespJson = callDetailsJson;

			ApiCallUrl = "/core/api/widgets/twilio/setvoicemail/" + acc_sid + "/" + auth_token + "/" +callRespJson.sid + "/" + fileSelected
			console.log("In ajax send voice mail : " + ApiCallUrl);	
			var resp  = twilioApiRequest(ApiCallUrl);
			return callback(true);

		});
	});
}


function twilioGetWidgetDetails(callback){

	accessUrlUsingAjax("/core/api/widgets/TwilioIO", function(resp){
		return callback(resp);
	});
}

//this will return an object
function twilioApiRequest(ApiCallUrl, callback){

	accessUrlUsingAjax(ApiCallUrl, function(resp){
		return callback(resp);
	});
}

// Get contact from DB and then return contact img
function searchForContactImg(from, callback) {
	console.log("searchForContactImg : " + from);	
	var contactImg = "";
	try {

		accessUrlUsingAjax("core/api/contacts/search/phonenumber/"+from, function(resp){

			var responseJson = resp;
			console.log("**** responseJson ****");
			console.log(responseJson);
			return callback(responseJson);

		});

	} catch(e) {
		return callback(null);
	}	
}

// Add contact img in html for call noty text with contact url
function addContactImg(callType, callback)
{
	var notyContactImg = "";
	if(callType == "Outgoing")
	  {
		var currentContact = agile_crm_get_contact();
		var contactImg = getGravatar(currentContact.properties, 40);
		notyContactImg = '<a href="#contact/'+TWILIO_CONTACT_ID+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+contactImg+'" style="display:inline;"></a>';
		return callback(notyContactImg);
	  }
	else
	{
		searchForContactImg(To_Number, function(contact){
			var callingContact = contact;
			if(callingContact != null)
			{
				var contactImg = getGravatar(callingContact.properties, 40);
				notyContactImg = '<a href="#contact/'+TWILIO_CONTACT_ID+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+contactImg+'" style="display:inline;"></a>';			
			}
			return callback(notyContactImg);
		});
	} 
}

/**
 * Take contact property and width for img, return gravatar or contact img.
 * Used for twilio IO as well as SIP call noty.
 */
function getGravatar(items, width)
{
	if (items == undefined)
		return;

	// Checks if properties already has an image, to return it
	var agent_image = getPropertyValue(items, "image");
	if (agent_image)
		return agent_image;

	// Default image
	var img = DEFAULT_GRAVATAR_url;
	var backup_image = "&d=404\" ";
	// backup_image="";
	var initials = text_gravatar_initials(items);

	if (initials.length == 0)
		backup_image = "&d=" + DEFAULT_GRAVATAR_url + "\" ";
	var data_name = "onLoad=\"image_load(this)\" onError=\"image_error(this)\" _data-name=\"" + initials;
	var email = getPropertyValue(items, "email");
	if (email)
	{
		return ('https://secure.gravatar.com/avatar/' + Agile_MD5(email) + '.jpg?s=' + width + backup_image + data_name);
	}

	return ('https://secure.gravatar.com/avatar/' + Agile_MD5("") + '.jpg?s=' + width + '' + backup_image + data_name);	
}
	
/**
 * Verifies a given number In Twilio and returns verification code to verify in
 * the Twilio Widget
 * 
 * @param from_number
 *            {@link String} Number to verify
 * @param callback
 *            Function to be executed on success
 */
function verifyNumberFromTwilio(from_number, id, callback)
{

	/*
	 * Sends GET request to the URL "/core/api/widgets/twilio/verify/numbers/"
	 * with Twilio_Plugin_Id and from_number as path parameters
	 */
	$.getJSON("/core/api/widgets/twilio/verify/numbers/" + id + "/" + from_number, function(verified_data)
	{
		console.log("Twilio verified_data " + verified_data);

		// If data is not defined return
		if (!verified_data)
			return;

		// If defined, execute the callback function
		if (callback && typeof (callback) === "function")
			callback(verified_data);

	}).error(function(data)
	{	
		// Append the url with the random number in order to differentiate the same action performed more than once.
		var flag = Math.floor((Math.random()*10)+1); 
		setUpError("Twilio", "widget-settings-error", data.responseText, window.location.protocol + "//" 
				+ window.location.host + "/#Twilio/twilio"+flag);
	});
	
	return;
}


var Widget_Collection_Events = Base_Collection_View.extend({

   events : {
   	  "click .install-custom-widget" : "addCustomWidgetClicked",
   },

   addCustomWidgetClicked : function(e){

   },
});


var Widget_Model_Events = Base_Model_View.extend({

   events : {
   	  "click .save-agile-widget" : "saveWidgetPrefs",
   	  "click .connect_shopify" : "connectShopify",
   	  "click .revoke-widget" : "revokeWidget"
   },

   revokeWidget : function(e){
   		e.preventDefault();
      	var ele = $(e.currentTarget);
      	
   		var widgetName = $(ele).closest("#widget-settings").attr("widget-name");
   		delete_widget(widgetName);
   		window.location.href = "#add-widget";
   },

   saveWidgetPrefs : function(e){
      e.preventDefault();
      var ele = $(e.currentTarget);

      var widgetName = $(ele).closest("#widget-settings").attr("widget-name");
      if(!widgetName){
      	  return;
      }
	  
	  // Checks whether all input fields are given
	  if (!isValidForm($(ele).closest("form"))){
		 return;
	  }

		var prefs = serializeForm($(ele).closest("form").attr("id"));
		console.log(prefs);

		if(widgetName == "Sip"){
			prefs["sip_publicid"] = "sip:" + prefs["sip_privateid"] + "@" + prefs["sip_realm"]; 
		}

		if($(ele).attr("disabled"))
			  return;

		$(ele).attr("disabled", "disabled").val("Saving...");

      if(widgetName != "TwilioIO"){
         // Saves the preferences into widget with name
         save_widget_prefs(widgetName, JSON.stringify(prefs), function(data){
            console.log(data);
            $(ele).removeAttr("disabled").val("Save");
         });
      }else{
         createAppSid(prefs, function(data){
               // Update prefs
               console.log(data);
               prefs["twilio_app_sid"] = data;
               // Saves the preferences into widget with name
               save_widget_prefs(widgetName, JSON.stringify(prefs), function(data){
                  console.log(data);
                  $(ele).removeAttr("disabled").val("Save");
               });
         });
      }

		
   },

   connectShopify : function(e){
   	  e.preventDefault();

      var shopName = $('#shop').val();
		if (shopName != ""){
			var domain = window.location.origin;
			window.location = "/scribe?service_type=shopify&url=shopify&isForAll="+isForAll+"&shop=" + shopName + "&domain=" + domain + "";
		}else{
			alert("Enter Shop name");
			$('#shop').focus();
			return false;
		}
   }

});/**
 * Loads widgets on a contact, creates a collection view
 */
var Widgets_View;
var widget_template_loaded_map = {};

/**
 * Loads all the widgets for the current agile user
 * 
 * @param el
 * @param contact
 */
function loadWidgets(el, contact)
{
	// Before loading the widgets, clear the queue of requests.
	// queueClear("widget_queue");
	// Create Data JSON
	var data = { contact : contact };

	var is_widget_view_new = false;
	/*
	 * If Widgets_View is not defined , creates collection view, collection is
	 * sorted based on position i.e., set when sorted using jquery ui sortable
	 */
	if (!Widgets_View)
	{
		// This flag is used to ensure widget script are loaded only once in
		// postrender. It is set to false after widget setup is initialized
		is_widget_view_new = true;
		Widgets_View = new Base_Collection_View({ url : '/core/api/widgets', restKey : "widget", templateKey : "widgets", individual_tag_name : 'li',
			sortKey : 'position', modelData : data, postRenderCallback : function(widgets_el)
			{
				head.load(FLAT_FULL_UI + "css/misc/agile-widgets.css", function()
				{
					// If scripts aren't loaded earlier, setup is initialized
					if (is_widget_view_new)
					{
						set_up_widgets(el, widgets_el);
					}
					is_widget_view_new = false;
				})

			} });

		/*
		 * Fetch widgets from collection and set_up_widgets (load their scripts)
		 */
		Widgets_View.collection.fetch();

		// show widgets
		var newEl = Widgets_View.render().el;
		$('#widgets', el).html(newEl);
		widgetBindingsLoader();
	}
	else
	{
		/*
		 * Have a flag, which is used to check whether widgets are already
		 * loaded. This avoid unnecessary loading.
		 */
		var flag = false;
        $(el).off('view_loaded');
		$(el).on('view_loaded', function(e)
		{

			if (flag == false)
			{
				flag = true;

				// Sort needs to be called as there could be position change
				Widgets_View.collection.sort();

				$('#widgets', el).html(Widgets_View.render(true).el);
				// Sets up widget
				set_up_widgets(el, Widgets_View.el);

			}
			widgetBindingsLoader();
		});
	}
}

function widgetBindingsLoader(){
	/*
	 * Called on click of icon-minus on widgets, collapsed class is added to it
	 * and sets "is_minimized" field of widget as true, we check this while
	 * loading widgets and skip loading widget if it is minimized
	 */
    $('#widgets').off('click', '.widget-minimize');
	$('#widgets').on('click', '.widget-minimize', function(e)
	{
		e.preventDefault();
		var widget_name = $(this).attr('widget');

		// content in widget is hidden
		$("#" + widget_name).collapse('hide');
		$(this).removeClass();

		$(this).addClass('collapsed');
		$(this).addClass('widget-maximize');
		$(this).addClass('fa');
		$(this).addClass('fa-plus');
		$(this).addClass('text-muted');

		// Get widget from collection by widget name
		var widget = Widgets_View.collection.where({ name : widget_name })[0]
		var widgetJSON = widget.toJSON();

		// set "is_minimized" field of widget as true
		widget.set({ 'is_minimized' : true }, { silent : true });
		widgetJSON['is_minimized'] = true;

		// Get model and save widget
		var model = new BaseModel();
		model.url = "core/api/widgets";
		model.save(widgetJSON, { silent : true });

	});

	/*
	 * Called on click of icon-plus on widgets, sets "is_minimized" field of
	 * widget as false, we check this while loading widgets and skip loading
	 * widget if it is minimized
	 */
    $('#widgets').off('click', '.widget-maximize');
	$('#widgets').on('click', '.widget-maximize', function(e)
	{
		e.preventDefault();
		var widget_name = $(this).attr('widget');

		// Get widget from collection by widget name
		var widget = Widgets_View.collection.where({ name : widget_name })[0];
		var widgetJSON = widget.toJSON();

		// set "is_minimized" field of widget as false
		widgetJSON['is_minimized'] = false;
		widget.set({ 'is_minimized' : false }, { silent : true })

		// Get model and save widget
		var model = new BaseModel();
		model.url = "core/api/widgets";
		model.save(widgetJSON, { silent : true });

		// Stores boolean whether widget has class collapsed
		var is_collapsed = $(this).hasClass('collapsed');
		$(this).removeClass();

		$(this).addClass('widget-minimize');
		$(this).addClass('text-muted');
		$(this).addClass('fa');
		$(this).addClass('fa-minus');
		$(this).addClass('c-p');		

		/*
		 * If is collapsed, script is already loaded, show the content in widget
		 * and return
		 */
		if (is_collapsed)
		{
			$("#" + widget_name).collapse('show');
		}else{
			queueGetRequest("_widgets_", "flatfull/"+widget.get('url'), "script", function(data, queueName){
					try{
					console.log("start" + model.get('name') + "Widget");
					  eval("start" + model.get('name') + "Widget")(queueName.replace("_widgets_", ""));	
					  $("#" + widget_name).collapse('show');
					}catch(err){console.log(err);}		
			}, undefined, 'true');
		}

	});
}

function process_url(url)
{
	return url = FLAT_FULL_UI + url;
}

/**
 * Loads the scripts of widgets which are not minimized and enables sorting
 * functionality on widgets
 * 
 * @param el
 * @param widgets_el
 */
function set_up_widgets(el, widgets_el)
{
	/*
	 * Iterates through all the models (widgets) in the collection, and scripts
	 * are loaded from the URL in the widget
	 */
	_(Widgets_View.collection.models).each(function(model)
	{
		// In case collection is not empty
		var id = model.get("id");
		var url = process_url(model.get("url"));

		model.set('selector', model.get('name').replace(/ +/g, ''));

		/*
		 * Set the data element in the div so that we can retrieve this in get
		 * plugin preferences
		 */
		$('#' + model.get('selector'), widgets_el).data('model', model);

		var contact_id = App_Contacts.contactDetailView.model.get("id");
		/*
		 * Checks if widget is minimized, if minimized script is not loaded
		 */
		if (!model.get("is_minimized") && model.get("widget_type") != "CUSTOM")
		{
			if (widget_template_loaded_map[model.get('name').toLowerCase()])
			{
				queueGetRequest("_widgets_" + contact_id, url, "script", function(data, queueName){
					try{
					console.log("start" + model.get('name') + "Widget");
					  eval("start" + model.get('name') + "Widget")(queueName.replace("_widgets_", ""));	
					}catch(err){console.log(err);}
					
				}, undefined, 'true');
			}
			else
				downloadTemplate(model.get('name').toLowerCase() + ".js", function()
				{
					widget_template_loaded_map[model.get('name').toLowerCase()] = true;
					queueGetRequest("_widgets_" + contact_id, url, "script", function(data, queueName){
						try{
							console.log("start" + model.get('name') + "Widget");
					  		eval("start" + model.get('name') + "Widget")(queueName.replace("_widgets_", ""));	
						}catch(err){console.log(err);}						
					}, undefined, 'true');
				});
		}

		/*
		 * For custom widgets we load the scripts using HTTP connections and
		 * store the script in script field of widget object, that is retrieved
		 * and appended in the body
		 */
		if (model.get("widget_type") == "CUSTOM")
		{

			if ($('#' + model.get('selector') + '-container').length)
			{
				setup_custom_widget(model, widgets_el)
			}
			else
				$('#' + model.get('selector') + '-container', widgets_el).show('0', function(e)
				{
					setup_custom_widget(model, widgets_el)
				});
		}
	}, this);
	enableWidgetSoring(widgets_el);
}

function setup_custom_widget(model, widgets_el)
{
	try
	{
		// $('form', this).focus_first();
		if (model.get('script'))
			$('#' + model.get('selector'), widgets_el).html(model.get('script'));
		else
			getScript(model, function(data)
			{
				console.log(data);
				$('#' + model.get('selector'), widgets_el).html(data);
			});
	}
	catch (err)
	{
		console.log(err);
	}
}

function getScript(model, callback)
{
	try
	{
		// Gets contact id, to save social results of a particular id
		var contact_id = agile_crm_get_contact()['id'];

		$.post("core/api/widgets/script/" + contact_id + "/" + model.get("name"), function(data)
		{

			// If defined, execute the callback function
			if (callback && typeof (callback) === "function")
				callback(data);
		}).error(function(data)
		{
			console.log(data);
			console.log(data.responseText);
		});
	}
	catch (err)
	{
		console.log(err);
	}
}

/**
 * Enables sorting on widgets by loading jquery-ui to get sortable functionality
 * on widgets. Whenever widget is sorted, it saves the new positions of widgets
 * 
 * @param el
 */
function enableWidgetSoring(el)
{
	// Loads jquery-ui to get sortable functionality on widgets
	head.js(LIB_PATH + 'lib/jquery-ui.min.js', function()
	{
		$('.widget-sortable', el).sortable();

		// Makes icon-cursor-move on widgets panel as handle for sorting
		$('.widget-sortable', el).sortable("option", "handle", ".icon-cursor-move");

		/*
		 * This event is called after sorting stops to save new positions of
		 * widgets
		 */
        $('.widget-sortable', el).off("sortstop");
		$('.widget-sortable', el).on(
				"sortstop",
				function(event, ui)
				{
					var models = [];

					/*
					 * Iterate through each all the widgets and set each widget
					 * position and store it in array
					 */
					$('.widget-sortable > li', el).each(function(index, element)
					{
						var model_name = $(element).find('.collapse').attr('id');

						if(!model_name)
						model_name = $(element).find('.widgets').attr('id');
						
						
						// Get Model, model is set as data to widget element
						var model = $('#' + model_name).data('model');

						model.set({ 'position' : index }, { silent : true });

						models.push({ id : model.get("id"), position : index });
					});

					// Saves new positions in server
					$.ajax({ type : 'POST', url : '/core/api/widgets/positions', data : JSON.stringify(models),
						contentType : "application/json; charset=utf-8", dataType : 'json' });
				});
	});
}

/**
 * Initializes an ajax queue with GET request for the given URL with the given
 * queue name
 * 
 * <p>
 * Requests with the same queue name are processes synchronously one after the
 * other. This method is used by widgets
 * </p>
 * 
 * @param queueName
 *            Name of the queue
 * @param url
 *            URL to make request
 * @param dataType
 *            Type of data to be retrieved
 * @param successcallback
 *            Function to be executed on success
 * @param errorCallback
 *            Function to be executed on error
 */
function queueGetRequest(queueName, url, dataType, successCallback, errorCallback, isCacheEnable)
{
	console.log(queueName + ", " + url);
	// Loads ajaxq to initialize queue
	head.js('/js/lib/ajaxm/ajaxq.js', function()
	{
		try
		{
			isCacheEnable = (isCacheEnable) ? true : false;
			/*
			 * Initialize a queue, with GET request
			 */
			$.ajaxq(queueName, { url : url, cache : isCacheEnable, dataType : dataType,

			// function to be executed on success, if successCallback is
			// defined
			success : function(data)
			{
				console.log("Sucesses", url);
				if (successCallback && typeof (successCallback) === "function")
					successCallback(data, queueName);
			},

			// function to be executed on success, if errorCallback is
			// defined
			error : function(data)
			{
				console.log("error", url);
				if (errorCallback && typeof (errorCallback) === "function")
					errorCallback(data, queueName);
			},

			// function to be executed on completion of queue
			complete : function(data)
			{
				console.log('completed get');
			}, });
		}
		catch (err)
		{
			console.log(err);
		}
	});
}

/**
 * Initializes an ajax queue with POST request for the given URL with the given
 * queue name
 * 
 * <p>
 * Requests with the same queue name are processes synchronously one after the
 * other. This method is used by widgets
 * </p>
 * 
 * @param queueName
 *            Name of the queue
 * @param url
 *            URL to make request
 * @param dataType
 *            Type of data to be retrieved
 * @param successcallback
 *            Function to be executed on success
 * @param errorCallback
 *            Function to be executed on error
 */
function queuePostRequest(queueName, url, data, successcallback, errorCallback)
{
	// Loads ajaxq to initialize queue
	head.js('/js/lib/ajaxm/ajaxq.js', function()
	{
		try
		{
			/*
			 * Initialize a queue, with POST request
			 */
			$.ajaxq(queueName, { type : 'POST', url : url, cache : false, data : data,

			// function to be executed on success, if successCallback is
			// defined
			success : function(data)
			{
				if (successcallback && typeof (successcallback) === "function")
					successcallback(data);
			},

			// function to be executed on success, if errorCallback is
			// defined
			error : function(data)
			{
				if (errorCallback && typeof (errorCallback) === "function")
					errorCallback(data);
			},

			// function to be executed on completion of queue
			complete : function(data)
			{
				console.log('completed post');
			} });
		}
		catch (err)
		{
			console.log(err);
		}
	});
}

/**
 * Aborts all the requests in the queue.
 * 
 * @param queueName
 *            the name of the queue.
 */
function queueClear(queueName)
{
	console.log('clear queue.');
	if (document.ajaxq)
	{
		document.ajaxq.q[queueName] = [];
		try{

			document.ajaxq.qr[queueName].abort();
	  		document.ajaxq.qr[queueName] = null;
  		}catch(e){
  			console.log(e);
  		}
	}
}

/**
 * Shrink the widget header name width
 * 
 * <p>
 * Shows the icons and decrease the width of widget header to avoid the widget
 * name overflow on mouse hover
 * 
 * @param el
 *            Element on which mouse entered (widget header)
 */
function showIcons(el)
{
	// Shows widget icons on hover
	$(el).find('div.widget_header_icons').show();

	// Changes width of widget name
	$(el).find('div.widget_header_name').css({ "width" : "40%" });
}

/**
 * Expand the widget header name width.
 * 
 * <p>
 * Hide the icons and use the remaining width in widget header name DIV on mouse
 * leave
 * </p>
 * 
 * @param el
 *            Element on which mouse left (widget header)
 */
function hideIcons(el)
{
	// Hide widget icons on hover
	$(el).find('div.widget_header_icons').hide();

	// Changes width of widget name
	$(el).find('div.widget_header_name').css({ "width" : "80%" });
}
/**
 * Organizes widgets into different categories like (SOCIAL, SUPPORT, EMAIL,
 * CALL, BILLING.. etc) to show in the add widget page, based on the widget_type
 * fetched from Widget object
 * 
 * @param base_model
 */
function organize_widgets(base_model)
{
	var itemView = new Base_List_View({ model : base_model, template : this.options.templateKey + "-model", tagName : 'div', });

	// Get widget type from model (widget object)
	var widget_type = base_model.get('widget_type');

	/*
	 * Appends the model (widget) to its specific div, based on the widget_type
	 * as div id (div defined in widget_add.html)
	 */
	var container = "";

	if (widget_type == "SOCIAL")
		  container = "social";
	if (widget_type == "SUPPORT")
		  container = "support";
	if (widget_type == "EMAIL")
		container = "email";
	if (widget_type == "CALL")
	{
	  if( base_model.get('name') == "Twilio" && !base_model.get('is_added'))
		  console.log("It is old twilio");
	  else
		  container = "call";
	}	
	if (widget_type == "BILLING")
		container = "billing";
	if (widget_type == "ECOMMERCE")
		container = "ecommerce";
	if (widget_type == "CUSTOM")
		 container = "custom";

	if(container)
		$('#' + container, this.el).append($(itemView.render().el).addClass('col-md-4 col-sm-6 col-xs-12'));
}

/**
 * Add/ Delete button are shown in the widget based on the attribute is_added in
 * widget model, Add and delete functionalities of the widgets are defined in
 * this init function
 */
function initializeWidgetSettingsListeners(){
	// adding widget
	/**
	 * When user clicks on add-widget, gets the widget-name which is set to add
	 * anchor tag and gets the model from the collection with widget name and
	 * add widget then navigates back to the contact-details page
	 */
	$('#prefs-tabs-content').off();
	$('#prefs-tabs-content .install-custom-widget').off();
	$('#prefs-tabs-content, #custom-widget').on('click', '.install-custom-widget', function(e)
	{

		e.preventDefault();
		console.log($(this));
		
		/* We make add button on a widget disabled on click of it. This is done
		 * to avoid continuous click in a short time, like double click on add
		 * button
		 */
		if ($(this).attr("disabled"))
			return;

		// set attribute disabled as disabled
		$(this).attr("disabled", "disabled");

		// Reads the name of the widget to be added
		var widget_name = $(this).attr('widget-name');

		console.log('In add widget');
		console.log(widget_name);

		if (App_Widgets.Catalog_Widgets_View == null)
			return;

		
		 /* Get widget model from collection based on the name attribute of the
		 * widget model
		 */
		var models = App_Widgets.Catalog_Widgets_View.collection.where({ name : widget_name });

		
		 /* Saves widget model and on success navigate back to contact detailed
		 * view
		 */
		var widgetModel = new Backbone.Model();

		console.log(widgetModel);

		// URL to connect with widgets
		widgetModel.url = '/core/api/widgets';

		widgetModel.save(models[0].toJSON(), { success : function(data)
		{
			// Checks if Widget_View is defined and adds widget to collection
			if (Widgets_View && Widgets_View.collection)
				Widgets_View.collection.add(new BaseModel(data.toJSON()));


			data.set('is_added', true);
			models[0].set(data);

		} });

	});

	// Deleting widget
	/**
	 * When user chooses to delete a widget, on confirmation sends delete
	 * request based on the name of the widget
	 */
	$('#prefs-tabs-content #delete-widget').off();
	$('#prefs-tabs-content').on('click', '#delete-widget', function(e)
	{
		// Fetch widget name from the widget on which delete is clicked
		var widget_name = $(this).attr('widget-name');

		// If not confirmed to delete, return
		var displayName;
		
		if(widget_name == "Rapleaf"){
			displayName = "Towerdata";
		}else if(widget_name == "TwilioIO"){
			displayName = "Twilio";
		}else{
			displayName = widget_name;
		}

		if (!confirm("Are you sure to delete " + displayName))
			return;
		
		delete_widget(widget_name);
		if(widget_name == "Linkedin")
			$('#Linkedin-container').hide();
		
		if(widget_name == "Twilio")
			$('#Twilio-container').hide();

		if(widget_name == "Bria")
			callFromBria = false;
			default_call_type = null;
	});	
	
	// Helps to know that widget is for all users.
	$('#prefs-tabs-content .add_to_all').off();
	$('#prefs-tabs-content').on('click', '.add_to_all', function(e){
		isForAll = true;
	});

	$('#prefs-tabs-content .add-widget').off();
	$('#prefs-tabs-content').on('click', '.add-widget', function(e){
		isForAll = false;
	});
	
	$('#prefs-tabs-content #remove-widget').off();
	$('#prefs-tabs-content').on('click', '#remove-widget', function(e)
	{

		// Fetch widget name from the widget on which delete is clicked
		var widget_name = $(this).attr('widget-name');
		
		
		// If not confirmed to delete, return
		if (!confirm("Are you sure to remove " + widget_name))
			return;

		//Deletes the cutom widget form the widget entity.
		delete_widget(widget_name);
		
		/*
		 * Sends Delete request with widget name as path parameter, and on
		 * success fetches the widgets to reflect the changes is_added, to show
		 * add widget in the view instead of delete option
		 */
		$.ajax({ type : 'DELETE', url : '/core/api/widgets/remove?widget_name=' + widget_name, contentType : "application/json; charset=utf-8",

		success : function(data)
		{
			update_collection(widget_name);
			
			// Call fetch on collection to update widget models
			App_Widgets.Catalog_Widgets_View.collection.fetch();

		}, dataType : 'json' });

	});
	
}


function delete_widget(widget_name)
{
	/*
	 * Sends Delete request with widget name as path parameter, and on
	 * success fetches the widgets to reflect the changes is_added, to show
	 * add widget in the view instead of delete option
	 */
	$.ajax({ type : 'DELETE', url : '/core/api/widgets?widget_name=' + widget_name, contentType : "application/json; charset=utf-8",

	success : function(data)
	{

		App_Widgets.Catalog_Widgets_View.collection.where({ name : widget_name })[0].set({'is_added': false}, {silent : true}).unset("prefs");
		update_collection(widget_name);
		
	}, dataType : 'json' });

}

function update_collection(widget_name)
{
	/*
	 * If Widgets_View is defined, remove widgets from widget collection
	 */
	if (Widgets_View && Widgets_View.collection)
	{
		// Fetch widget from collection based on widget_name
		var model = Widgets_View.collection.where({ name : widget_name });
		Widgets_View.collection.remove(model);
	}
}//Helps to know that widget is for all users.
var isForAll = false;

function update_collection_with_prefs(data) {
	console.log("In update_collection_with_prefs");
	console.log(data);
	if (App_Widgets.Catalog_Widgets_View
			&& App_Widgets.Catalog_Widgets_View.collection) {
		var models = App_Widgets.Catalog_Widgets_View.collection.where({
			name : data["name"]
		});
		if (models && models[0]) {
			models[0].set({
				'prefs' : data.prefs
			});
			console.log(App_Widgets.Catalog_Widgets_View.collection.where({
				name : data["name"]
			})[0]);
		}

	}

	if (Widgets_View && Widgets_View.collection) {
		var models = Widgets_View.collection.where({
			name : data["name"]
		});
		if (models && models[0]) {
			models[0].set({
				'prefs' : data.prefs
			});
			console.log(Widgets_View.collection.where({
				name : data["name"]
			})[0]);
		}

	}
}

function save_widget_prefs(pluginName, prefs, callback) {
	console.log("In save_widget_prefs.");
	/*
	 * Get widget model from collection based on the name attribute of the
	 * widget model
	 */
	var models = App_Widgets.Catalog_Widgets_View.collection.where({
		name : pluginName
	});

	/*
	 * Saves widget model and on success navigate back to contact detailed view
	 */
	var widgetModel = new Backbone.Model();

	console.log(widgetModel);

	// URL to connect with widgets
	widgetModel.url = '/core/api/widgets';
	models[0].set('prefs', prefs);
	models[0].set('isForAll', isForAll);

	widgetModel.save(models[0].toJSON(), {
		success : function(data) {
			// Checks if Widget_View is defined and adds
			// widget to collection
			if (Widgets_View && Widgets_View.collection) {
				Widgets_View.collection.add(new BaseModel(data.toJSON()));
			}

			data.set('is_added', true);
			models[0].set(data);
			var widgetID = data.id;
			var displayName;
			if(pluginName  == "Rapleaf"){
				displayName = "Towerdata"
			}else if(pluginName == "HelpScout"){
				displayName = "Help Scout"
			}else if(pluginName == "TwilioIO"){
				displayName = "Twilio";
			}else{
				displayName = pluginName;
			}

			var msgType = "success";
			var msg = displayName+" widget saved successfully";

			if(widgetID){

				// If plugin name is CallScript do not redirect
				if (pluginName != "CallScript") {
					window.location.href = ("#" + pluginName + "/" + data.id);
				}

				console.log("data******");
				console.log(data);

				update_collection_with_prefs(data);

				if (pluginName == "Sip") {
					// Stop old stack.
					if (Sip_Start == true) {
						Sip_Updated = true;
						sipUnRegister();
					}
					// Register on Sip.
					sipStart();
				}

				if (pluginName == "TwilioIO") {
					Twilio_Setup_Called = false;
					// Get widget, Create token and set twilio device
					globalTwilioIOSetup();
				}
				if (pluginName == "Bria"){
					callFromBria = true;

					// Get widget,set bria device
					globalBriaSetup();
				}

			}else{
				msgType = "error";
				msg = ("Error occurred while saving "+displayName);
			}

			showNotyPopUp(msgType , msg, "bottomRight");

			if (callback && typeof (callback) === "function") {
				callback(data);
			}

		}, error : function(data){
			console.log(data);
			alert("error occurred"+data);
		}
	});
}

function setUpError(widget_name, template_id, error_data, error_url, model) {

	$("#content").html(getTemplate("settings"), {});

	var el;
	var models;
	var json;

	if (model) {
		el = $(getTemplate("widget-settings", model));
		json = model;
	} else {

		if (!App_Widgets.Catalog_Widgets_View
				|| App_Widgets.Catalog_Widgets_View.collection.length == 0) {

						if(callback)
			 				callback(el);

			// Fetch the list of widgets
			App_Widgets.Catalog_Widgets_View.collection.fetch({ success : function() {
					$.getJSON('core/api/widgets/' + widget_name,function(data1) {
						setUpError(widget_name, template_id,
								error_data, error_url, data1)
					});
				}
			});
			return;
		}

		models = App_Widgets.Catalog_Widgets_View.collection.where({
			name : widget_name
		});
		json = models[0].toJSON();
		el = $(getTemplate("widget-settings", json));
	}

	json['error_message'] = error_data;
	json['error_url'] = error_url;
}

function set_up_access(widget_name, template_id, data, url, model){
	getTemplate('settings', {}, undefined, function(template_ui){
 		if(!template_ui)
    		return;
		$('#content').html($(template_ui)); 
		var el;
		var json;
		var models;

		$('#prefs-tabs-content').html(getRandomLoadingImg());
		$('#PrefsTab .select').removeClass('select');
		$('.add-widget-prefs-tab').addClass('select');

		if (model){
			getTemplate('widget-settings', model, undefined, function(template_ui1){
		 		if(!template_ui1)
		    		return;
				el = $(template_ui1);
				json = model; 
				setup_widget_revoke_access(el, json, data, widget_name, template_id, url, model);
			}, null);

			return;
		} else {

			$('#widget-settings', el).html(getTemplate(template_id, json));

			App_Widgets.Catalog_Widgets_View = new Base_Collection_View({ url : '/core/api/widgets/default' });

			$('#prefs-tabs-content').find('form').data('widget', json);

			$.getJSON('core/api/widgets/' + widget_name, function(data1){
				set_up_access(widget_name, template_id, data, url, data1)
			});
		} 
	});
}

function addWidgetProfile(widgetId, widgetName, template, url) {
	loadSettingsUI(function() {

		// Get route model
		getWidgetModelFromName(widgetId, "", function(model) {
				$.getJSON((url), function(data) {

					getTemplate(
							"widget-settings", model, undefined, function(widget_el){

					$('#prefs-tabs-content')
							.html(widget_el);

					// Loading GooglePlus profile
					if (widgetName == "GooglePlus") {
						var widgetPrefGP = JSON.parse(model.prefs);
						$.getJSON("https://www.googleapis.com/plus/v1/people/me?access_token="+ widgetPrefGP['access_token']).success(function(userData) { 
							model["profile"] = userData;
							// Create a view modal for widgets
							renderWidgetView(template, url, model, '#widget-settings');
							return;
						}).error(function() { 
							model["profile"] = {};
							// Create a view modal for widgets
							renderWidgetView(template, url, model, '#widget-settings');
							return;
						});
						return;
						// Loading Stripe profile
					} else if (widgetName == "Stripe") {
						$.getJSON("core/api/custom-fields/type/scope?scope=CONTACT&type=TEXT", function(data) {
							model["custom_data"] = data;

							// Create a view modal for widgets
							renderWidgetView(template, url, model, '#widget-settings');
							return;

						});
						model["profile"] = jQuery.parseJSON(model.prefs);
					} else {

						if (data) {
							if($.isArray(data)){
								model["profile"] = jQuery.parseJSON(model.prefs);
							}else{
								try{
									data.prefs = jQuery.parseJSON(data.prefs);
								}catch(e){
									console.log("Error occured while parsing widget prefs");
								}
								model["profile"] = data;
							}
						}
					}
					
					// Create a view modal for widgets
					renderWidgetView(template, url, model, '#widget-settings');
					
				});								
			});
		});
	});
}

// 
function addOAuthWidget(widgetName, template, url) {
	loadSettingsUI(function() {

		// Get route model
		getWidgetModelFromName(widgetName, "name", function(model) {

			if (model) {
				model["url"] = url;
			}

			getTemplate("widget-settings", model, undefined, function(widget_el){
				$('#prefs-tabs-content').html(widget_el);

				// Create a view modal for widgets
				renderWidgetView(template, 'core/api/widgets',model, '#widget-settings');
			});

		});

	});
}

/**
 * Add model widget.
 */
function addConfigurableWidget(widgetId, widgetName, templateName) {

	loadSettingsUI(function() {

		var type = "";
		var selector = "";

		if (!widgetId) {
			type = "name";
			selector = widgetName;
		} else {
			selector = widgetId;
		}

		// Get route model
		getWidgetModelFromName(selector, type, function(model) {

			var widget_el = getTemplate("widget-settings", model);
			$('#prefs-tabs-content').html(widget_el);

			// Create a view modal for widgets
			renderWidgetView(templateName, 'core/api/widgets',model, '#widget-settings');
			
			if (model.name == "TwilioIO") {
				fill_twilioio_numbers();
			}

		});

	});
}

function loadSettingsUI(callback) {
	getTemplate('settings', {}, undefined, function(template_ui) {
		if (!template_ui)
			return;

		$('#content').html($(template_ui));
		$('#prefs-tabs-content').html(getRandomLoadingImg());

		$('#PrefsTab .select').removeClass('select');
		$('.add-widget-prefs-tab').addClass('select');

		if (callback)
			callback();
	}, "#content");
}

function getWidgetModelFromName(widgetId, type, callback) {

	getAgileConfiguredWidgetCollection(function(widgetCollection) {

		var model = "";
		if (type == "name") {
			models = widgetCollection.where({ name : widgetId });
			model = models[0];
		} else {
			model = widgetCollection.get(widgetId);
		}

		if (!model) {
			Backbone.history.navigate('add-widget', { trigger : true });
			return;
		}
		callback(model.toJSON());
	});
}

function deserializeWidget(widget, el) {
	if (!widget.prefs){
		return;
	}
	deserializeForm(JSON.parse(widget.prefs), $(el).find("form"));
}/**
 * triggers.js is a script file that sets tags typeahead when Tag options are
 * selected
 * 
 * @module Campaigns
 * 
 */
function initializeTriggersListeners(){
}

$(function(){

	// Tag suggestions when 'Tag is added' and 'Tag is deleted' options selected
	$('body').on('change', '#trigger-type', function(e)
	{
		e.preventDefault();

		// Hide trigger milestones div for other trigger conditions.
		if ($(this).val() !== 'DEAL_MILESTONE_IS_CHANGED'){
			$('form#addTriggerForm').find('select#trigger-deal-milestone').closest('div.control-group').css('display', 'none');
		}
		
		if($(this).val() !== 'RUNS_DAILY' || $(this).val() !== 'RUNS_WEEKLY' || $(this).val() !== 'RUNS_MONTHLY'){
			$('form#addTriggerForm').find('select#contact-filter').closest('div.control-group').css('display', 'none');
		}

		// Hide trigger stripe event div for other trigger conditions.
		if($(this).val() !== 'STRIPE_CHARGE_EVENT'){
			$('form#addTriggerForm').find('select#trigger-stripe-event').closest('div.control-group').css('display', 'none');
			$('form#addTriggerForm').find('select#trigger-stripe-event').val("");
			$('#trigger-run-on-new-contacts').css('display', 'none');
		}
		
		// Hide trigger shopify event div for other trigger conditions.
		if($(this).val() !== 'SHOPIFY_EVENT'){
			$('form#addTriggerForm').find('select#trigger-shopify-event').closest('div.control-group').css('display', 'none');
			$('form#addTriggerForm').find('select#trigger-shopify-event').val("");
			$('#trigger-run-on-new-contacts').css('display', 'none');
		}
		
		// Hide trigger inbound mail event div for other trigger conditions.
		if($(this).val() !== 'INBOUND_MAIL_EVENT'){
			$('form#addTriggerForm').find('div#trigger-inbound-mail-event').css('display', 'none');
			$('#new-mail-trigger-run-on-new-contacts').css('display', 'none');
		}
		
		if($(this).val() != 'EMAIL_OPENED' || $(this).val() != 'EMAIL_LINK_CLICKED'){
			
			$('form#addTriggerForm').find('select#email-tracking-type').closest('div.control-group').css('display', 'none');
			
			$('form#addTriggerForm').find('#custom-link-clicked').closest('div.control-group').css('display', 'none');
			
			$('form#addTriggerForm').find('select#email-tracking-campaign-id').closest('div.control-group').css('display', 'none');
		}
		
		if($(this).val() != 'UNSUBSCRIBED')
			$('form#addTriggerForm').find('select#email-tracking-campaign-id').closest('div.control-group').css('display', 'none');
		
		if($(this).val() != 'EVENT_IS_ADDED')
		{
			$('form#addTriggerForm').find('select#event-owner-id').closest('div.control-group').css('display', 'none');
			
			$('form#addTriggerForm').find('select#event-type').closest('div.control-group').css('display', 'none');
		}
		
		// Hide trigger milestones div for other trigger conditions.
		if ($(this).val() !== 'INBOUND_CALL' || $(this).val() !== 'OUTBOUND_CALL'){
			$('form#addTriggerForm').find('div#CALL').closest('div.control-group').css('display', 'none');
		}
			
		if($(this).val() != 'FORM_SUBMIT'){
			$('form#addTriggerForm').find('select#trigger-form-event').closest('div.control-group').css('display', 'none');
			$('#trigger-run-on-new-contacts').css('display', 'none');
		}

		// Initialize tags typeahead
		if ($(this).val() == 'TAG_IS_ADDED' || $(this).val() == 'TAG_IS_DELETED')
		{
			$('form#addTriggerForm').find('#trigger-custom-tags').closest('div.control-group').css('display', '');
			
			// Tags typeahead for tag input field
			addTagsDefaultTypeahead($('form#addTriggerForm').find('div#RHS'));
		}
		
		// Initialize tags typeahead
		if ($(this).val() == 'RUNS_DAILY' || $(this).val() == 'RUNS_WEEKLY' || $(this).val() == 'RUNS_MONTHLY')
		{	
			populate_contact_filters_in_trigger($('form#addTriggerForm'), 'contact-filter');
		}


		// Show score
		if ($(this).val() == 'ADD_SCORE')
			$('form#addTriggerForm').find('#trigger-custom-score').closest('div.control-group').css('display', '');
		
		// Populate milestones for triggers
		if ($(this).val() == 'DEAL_MILESTONE_IS_CHANGED')
		{
			populate_milestones_in_trigger($('form#addTriggerForm'), 'trigger-deal-milestone');
		}
		
		// Show stripe events
		if($(this).val() == 'STRIPE_CHARGE_EVENT')
		{
			populate_stripe_events_in_trigger($('form#addTriggerForm'), 'trigger-stripe-event');
		}
		
		// Show shopify events
		if($(this).val() == 'SHOPIFY_EVENT')
		{
			populate_shopify_events_in_trigger($('form#addTriggerForm'), 'trigger-shopify-event');
		}

		if($(this).val() == 'INBOUND_MAIL_EVENT')
		{
			populate_inbound_mail_events_in_trigger($('form#addTriggerForm'), 'trigger-inbound-mail-event');
		}
		
		if($(this).val() == 'EMAIL_OPENED' || $(this).val() == 'EMAIL_LINK_CLICKED'){
			$('form#addTriggerForm').find('#email-tracking-type').closest('div.control-group').css('display', '');
			
			if($(this).val() == 'EMAIL_LINK_CLICKED')
				$('form#addTriggerForm').find('#custom-link-clicked').closest('div.control-group').css('display', '');
		}
		
		if($(this).val() == 'EVENT_IS_ADDED')
		{
			$('form#addTriggerForm').find('select#event-type').closest('div.control-group').css('display', '');
			
			populate_owners_in_trigger($('form#addTriggerForm'), 'event-owner-id');
		}
		
		if($(this).val() == 'INBOUND_CALL' || $(this).val() == 'OUTBOUND_CALL')
		{
			populate_call_trigger_options($('form#addTriggerForm'));	
		}
		
		if($(this).val() == 'FORM_SUBMIT')
		{
			populate_forms_in_trigger($('form#addTriggerForm'), 'trigger-form-event');
		}

		if($(this).val() == 'UNSUBSCRIBED')
			show_email_tracking_campaigns();

	});
	
	// When cancel clicked, take to Back page
	$('body').on('click', '#trigger-cancel', function(e)
	{
		e.preventDefault();

		if (history !== undefined)
			history.back(-1);
	});
	
	$('body').on('change', '#email-tracking-type', function(e){
		
		e.preventDefault();
		
		if($(this).val() == 'ANY' || $(this).val() == 'PERSONAL')
		{
			// Show milestones select element
			$('form#addTriggerForm').find('select#email-tracking-campaign-id').closest('div.control-group').css('display', 'none');
			return;
		}
		
		// show email tracking campaigns
		show_email_tracking_campaigns();
		
	});
});

/**
 * Shows hidden trigger-milestones select element and fills with milestones
 * data.
 * 
 * @param trigger_form -
 *            trigger form jQuery object
 * @param milestones_select_id -
 *            trigger milestones select id
 * @param trigger_deal_milestone_value -
 *            trigger milestone value obtained from saved trigger.
 */
function populate_milestones_in_trigger(trigger_form, milestones_select_id, trigger_deal_milestone_value)
{

	// Show milestones select element
	trigger_form.find('select#' + milestones_select_id).closest('div.control-group').css('display', '');

	// Show loading image.
	$('select#' + milestones_select_id).after(getRandomLoadingImg());

	populateTrackMilestones(trigger_form, undefined, undefined, function(tracks)
	{
//		console.log(tracks);
		$('.loading').remove();

		// Make obtained milestone value selected
		if (trigger_deal_milestone_value !== undefined)
		{
//			"Won" - > "defaultId_Won";
			
			var pipeline_id = trigger_deal_milestone_value.split('_')[0];
			
			// If pipeline_id is not NUMBER
			if(pipeline_id != " " && isNaN(Number(pipeline_id)))
			{
				$.each(tracks, function(index, track){
					
					// For Old code compatibility - Appending Default track id to default milestones
					if(track.isDefault && ~track.milestones.indexOf(trigger_deal_milestone_value))
					{
						trigger_deal_milestone_value = track.id + "_" + trigger_deal_milestone_value;
						return true;
					}
				});
				
			}
			
			trigger_form.find('select#' + milestones_select_id).val(trigger_deal_milestone_value).attr('selected', 'selected').trigger('change');
		}
	}, "Select new milestone...", 'trigger-deal-milestone');

	// Fills milestone select element
/*	populateMilestones(trigger_form, undefined, 0, undefined, function(data)
	{
		$('.loading').remove();
		// Append obtained option values to select
		trigger_form.find('select#' + milestones_select_id).html(data);
		// Make obtained milestone value selected
		if (trigger_deal_milestone_value !== undefined)
		{
			trigger_form.find('select#' + milestones_select_id).val(trigger_deal_milestone_value).attr('selected', 'selected').trigger('change');
		}
	}, "Select new milestone...");*/
}

/**
 * Shows hidden trigger-milestones select element and fills with milestones
 * data.
 * 
 * @param trigger_form -
 *            trigger form jQuery object
 * @param filter_select_id -
 *            contact filter select id
 * @param trigger_deal_milestone_value -
 *            trigger milestone value obtained from saved trigger.
 */
function populate_contact_filters_in_trigger(trigger_form, filter_select_id, value)
{
	// Show milestones select element
	trigger_form.find('select#' + filter_select_id).closest('div.control-group').css('display', '');

	var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
	
	fillSelect('contact-filter', '/core/api/filters', 'workflow', function fillContactFilter()
	{
		if (value)
		{
			$('#contact-filter',trigger_form).find('option[value=' + value + ']').attr('selected', 'selected');
		}
	}, optionsTemplate, false,undefined,"Select Contact filter");
}

/**
 *	Function to populate the stripe event trigger with stripe events
 * 
 * @param trigger_form
 * 				trigger form object
 * @param stripe_event_select_id
 * 				stripe event select element id
 * @param stripe_event_value
 * 				stripe event type
 */
function populate_stripe_events_in_trigger(trigger_form, stripe_event_select_id, stripe_event_value, trigger_run_on_new_contacts)
{
	trigger_form.find('select#' + stripe_event_select_id).closest('div.control-group').css('display','');
	trigger_form.find("#trigger-run-on-new-contacts").css('display', '');
	if(trigger_run_on_new_contacts)
		trigger_form.find("#trigger-run-on-new-contacts").val(trigger_run_on_new_contacts);

	if(stripe_event_value !== undefined)
	{
		trigger_form.find('select#' + stripe_event_select_id).val(stripe_event_value).attr('selected', 'selected').trigger('change');
	}
}

function populate_shopify_events_in_trigger(trigger_form, shopify_event_select_id, shopify_event_value, trigger_run_on_new_contacts)
{
	trigger_form.find('select#' + shopify_event_select_id).closest('div.control-group').css('display','');
	trigger_form.find("#trigger-run-on-new-contacts").css('display', '');
	if(trigger_run_on_new_contacts)
		trigger_form.find("#trigger-run-on-new-contacts").val(trigger_run_on_new_contacts);

	if(shopify_event_value !== undefined)
	{
		trigger_form.find('select#' + shopify_event_select_id).val(shopify_event_value).attr('selected', 'selected').trigger('change');
	}
}

function populate_inbound_mail_events_in_trigger(trigger_form, inbound_mail_event_div_class, new_email_trigger_run_on_new_contacts)
{
	trigger_form.find('div#' + inbound_mail_event_div_class).css('display','');
	trigger_form.find("#new-mail-trigger-run-on-new-contacts").css('display', '');
	if(new_email_trigger_run_on_new_contacts)
		trigger_form.find("#new-mail-trigger-run-on-new-contacts").val(new_email_trigger_run_on_new_contacts);
}

function populate_owners_in_trigger(trigger_form, owner_select_id, trigger_owner_id)
{
	// Show milestones select element
	trigger_form.find('select#' + owner_select_id).closest('div.control-group').css('display', '');

	var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
	
	fillSelect(owner_select_id, '/core/api/users', 'users', function()
			{
		
			$("#" + owner_select_id +' option:first').after('<option value="ANY">Any Owner</option>');
			
			if (trigger_owner_id)
			{
				$('#'+owner_select_id, trigger_form).find('option[value=' + trigger_owner_id + ']').attr('selected', 'selected');
			}
		
	}, optionsTemplate, false, undefined, "Select Event Owner");
}

function populate_call_trigger_options(trigger_form, triggerJSON)
{
	
	trigger_form.find('div#CALL').closest('div.control-group').css('display', '');
	
	if(triggerJSON && triggerJSON["call_disposition"])
		trigger_form.find('div#CALL select').find('option[value=' + triggerJSON["call_disposition"] + ']').attr('selected', 'selected').trigger('change');
}

function populate_forms_in_trigger(trigger_form, trigger_form_select_id, trigger_form_id, trigger_run_on_new_contacts)
{
	trigger_form.find("#trigger-run-on-new-contacts").css('display', '');
	if(trigger_run_on_new_contacts)
		trigger_form.find("#trigger-run-on-new-contacts").val(trigger_run_on_new_contacts);
	trigger_form.find('select#' + trigger_form_select_id).closest('div.control-group').css('display', '');
	var formOptionsTemplate = "<option value='{{id}}'>{{formName}}</option>";
	fillSelect(trigger_form_select_id, 'core/api/forms', 'forms', function()
	{
		if (trigger_form_id)
		{
			$('#' + trigger_form_select_id, trigger_form).find('option[value=' + trigger_form_id + ']').attr('selected', 'selected');
		}
	}, formOptionsTemplate, false, undefined, "Select Form");
}


/**
 * Shows triggers for each td in workflows list
 * 
 * @param el -
 *            Backbone el
 * 
 */
function show_triggers_of_each_workflow(el)
{
	// Fetches triggers from collection and appends
	if (App_Workflows.triggersCollectionView != undefined && App_Workflows.triggersCollectionView.collection.length != 0)
	{
		append_triggers_to_workflow(el);
		return;
	}

	App_Workflows.triggersCollectionView = new Base_Collection_View({ url : '/core/api/triggers', restKey : "triggers", templateKey : "triggers",
		individual_tag_name : 'tr' });

	App_Workflows.triggersCollectionView.collection.fetch({ success : function(data)
	{
		// Shows pending triggers content
		if (App_Workflows.triggersCollectionView == undefined || App_Workflows.triggersCollectionView.collection.length == 0)
		{
			$('#triggers-verification', el).css('display', 'block');
			return;
		}

		// Append triggers to workflow
		append_triggers_to_workflow(el);

	} });

}

/**
 * Appends triggers to each workflow in UI
 * 
 * @param el -
 *            Backbone el
 * 
 */
function append_triggers_to_workflow(el)
{
	// Appends triggers to respective workflow
	$('.workflow-triggers', el).each(function(index, td)
	{

		// Returns filtered array of models
		var trigger_models = App_Workflows.triggersCollectionView.collection.where({ campaign_id : parseInt($(td).attr('workflow-id')) });
		var trigger_collection = new BaseCollection(trigger_models, {});

		// show triggers if exists for a workflow
		if (trigger_collection.length !== 0){

			getTemplate('workflow-triggers', { "triggers" : trigger_collection.toJSON() }, undefined, function(template_ui){
				if(!template_ui)
					  return;
				$(td).html($(template_ui));	
			}, $(td));

		}
	});
}

function show_email_tracking_campaigns()
{
	// Show campaign select element
	$('form#addTriggerForm').find('select#email-tracking-campaign-id').closest('div.control-group').css('display', '');

	var optionsTemplate = "<option value='{{id}}'>{{name}}</option>";
	
	/**
	 * Fills campaign select with existing Campaigns.
	 * 
	 * @param campaign-select -
	 *            Id of select element of Campaign
	 * @param /core/api/workflows -
	 *            Url to get workflows
	 * @param 'workflow' -
	 *            parse key
	 * @param no-callback -
	 *            No callback
	 * @param optionsTemplate-
	 *            to fill options with workflows
	 */
	fillSelect('email-tracking-campaign-id', '/core/api/workflows', 'workflow', function()
			{
				
				$('#email-tracking-campaign-id option:first').after('<option value="0">All</option>');
				
			}, optionsTemplate, false);
}
/**
 * workflow-alerts deals with the alerts inside a campaign.
 * Ex- If the node limit is reached
 */
function campaignAlert(alertType)
{
	if(alertType == null)
		return;
	var alertJSON={};
	var alertTemplate;
	var templateName = "";

	if(alertType == "nodeLimit")
		{
		alertJSON = _billing_restriction.currentLimits;
		templateName = "campaign-node-limit-modal";
		}

	 
	if(alertType == "Empty")
		{
		alertJSON["title"]="No Twilio Number";
		alertJSON["message"]="The Twilio SMS gateway you configured does not have a purchased number. Please purchase a number from Twilio to start sending SMS.";
		templateName = "SMSGateway-integration-alert-modal";
		}
	
	if(alertType == "Unauthorised")
		{
		alertJSON["title"]="SMS Gateway not Configured";
		alertJSON["message"]="You need to enable SMS Gateway integration to use this option. Please enable it in Admin Settings -> Integrations";
		templateName = "SMSGateway-integration-alert-modal";
		}

		getTemplate(templateName, alertJSON, undefined, function(template_ui){
			if(!template_ui)
				  return;
			$(template_ui).modal('show');
		}, null);
}

function workflow_alerts(title, message , template, callback){
	
	var JSONValues = {};
	JSONValues["title"] = title;
	JSONValues["message"] = message;
	
	getTemplate(template, JSONValues, undefined, function(template_ui){
		if(!template_ui)
			  return;
			
		var $modal = $(template_ui);
		$modal.modal('show');	

		if(callback && typeof (callback) === "function")
			callback($modal);

	}, null);
}

function send_verify_email(el)
{
	// On Enter Key
	$('#verify-email-form', el).find('input').on('keypress', function(e){
		
		// Enter key
		if(e.type== 'keypress' && e.which != 13)
			return;

		e.preventDefault();

		// Trigger click on enter
		$('#verify-email-send').trigger('click');
	});

	$('#verify-email-send', el).on('click', function(e){
		
		e.preventDefault();

		// If already clicked, return
		if($(this).attr("disabled"))
			return;

		if(!isValidForm('#verify-email-form'))
			return;

		$(this).attr('disabled', 'disabled').text("Sending...");

		var json = serializeForm("verify-email-form");
		
		if(!json)
			return;
		
		$.ajax({
			url: 'core/api/emails/verify-from-email',
			type: 'POST',
			data: json,
			success: function(data){
				
				$('#verify-email-send').removeAttr('disabled');

			     // Hide form elements
			     $('#verify-email-form').find('div.row div').hide();
			     $('#verify-email-form').find('div.row input').val(json.email);

			     $('#verify-email-form').find('div.row span#alert-msg').html("<p class='m-l'>Verification email sent to &#39;"+json.email+"&#39;. Please check your email and complete the verification process.</p>");
			     $('#verify-email-send').removeAttr('href').removeAttr('id').attr('data-dismiss', 'modal').text('Done');
			},
			error: function(response)
			{
				$('#verify-email-send').removeAttr('disabled');
				
				if(response.responseText == 'Email not verified yet.')
				{
					// Hide form elements
					$('#verify-email-form').find('div.row div').hide();
					$('#verify-email-form').find('div.row input').val(json.email);
			     
					$('#verify-email-form').find('div.row span#alert-msg').html("<p class='m-l'> &#39;"+json.email+"&#39; is not verified yet. Please check your email and complete the verification process.</p>");
					$('#verify-email-send').removeAttr('href').removeAttr('id').attr('data-dismiss', 'modal').text('Done');
					
//					$("#verify-ignore").show();
					return;
			     }

				$('#workflow-verify-email').modal('hide');
			}
		});
		
	});
}$(function()
{
    $('#content').on('click', '#select-all-active-contacts', function(e)
	{
						e.preventDefault();
						SUBSCRIBERS_SELECT_ALL = true;
						$('#content')
								.find('#subscribers-bulk-select')
								.css('display', 'block')
								.html(
										'Selected All ' + getAvailableActiveContacts() + ' contacts. <a hrer="#" id="select-all-active-contacts-revert" class="text-info">Select chosen contacts only</a>');

						// On choosing select all option, all the visible
						// checkboxes in the table should be checked
						$.each($('.tbody_check'), function(index, element)
						{
							$(element).attr('checked', "checked");
						});
					});

    $('#content').on('click', '#select-all-active-contacts-revert', function(e)
					{
						e.preventDefault();
						SUBSCRIBERS_SELECT_ALL = false;
						$('#content')
								.find('#subscribers-bulk-select')
								.css('display', 'block')
								.html(
										"Selected " + App_Workflows.active_subscribers_collection.collection.length + " contacts. <a href='#' id='select-all-active-contacts' class='text-info'>Select all " + getAvailableActiveContacts() + " contacts</a>");
					});
});

/**
 * Shows delete button when thead/tbody checkbox is checked.
 * 
 * @param clicked_ele - 
 * 				clicked checkbox element.
 * 
 * @param isBulk -
 * 				true if .thead is checked, otherwise false
 * 
 */
function toggle_active_contacts_bulk_actions_dropdown(clicked_ele, isBulk)
{
	SUBSCRIBERS_SELECT_ALL = false;
	var total_available_contacts;

	if (clicked_ele)
			total_available_contacts = getAvailableActiveContacts();

	$('#content').find('#subscribers-bulk-select').css('display', 'none');

	// When checked show Delete button
	if ($(clicked_ele).is(':checked'))
	{
		$('#content').find('#subscribers-block').css('display', 'block');
		
		$('#subscribers-block').find('#remove-active-from-campaign').css('display', 'inline-block');

		// To show subscribers-bulk-select only thead is checked i.e., isBulk is true.
		if (isBulk && total_available_contacts != App_Workflows.active_subscribers_collection.collection.length)
		$('#subscribers-block')
					.find('#subscribers-bulk-select')
					.css('display', 'block')
					.html(
							"Selected " + App_Workflows.active_subscribers_collection.collection.length + " contacts. <a id='select-all-active-contacts' class='text-info' href='#'>Select all " + total_available_contacts + " contacts</a>");

	}
	// When unchecked hide Delete button
	else
	{
		// To hide Delete button when .thead is unchecked
		if (isBulk)
		{
			$('#remove-active-from-campaign').css('display', 'none');
			return;
		}

		// Hide delete button when .tbody is unchecked
		var check_count = 0
		$.each($('.tbody_check'), function(index, element)
		{
			if ($(element).is(':checked'))
			{
				check_count++;
				return false;
			}
		});

		if (check_count == 0)
		{
			$('#remove-active-from-campaign').css('display', 'none');
		}
	}
}

/**
 * Returns total active subscribers count.
 **/
function getAvailableActiveContacts()
{

	if (App_Workflows.active_subscribers_collection.collection.toJSON()[0] && App_Workflows.active_subscribers_collection.collection.toJSON()[0].count)
	{
		var current_active_subscribers_count = App_Workflows.active_subscribers_collection.collection.toJSON()[0].count;
		return current_active_subscribers_count;
	}

	return App_Workflows.active_subscribers_collection.collection.toJSON().length;

}

/**
 * Returns subscribers base collection view object for given params.
 * 
 * @param workflow_id - 
 * 				workflow (or campaign) id
 * @param fetch_url -
 * 				rest url to get subscribers
 * 
 * @param template-key - 
 * 				id of subscribers html template
 * 
 **/
function get_campaign_subscribers_collection(workflow_id, fetch_url, template_key)
{
	/* Set the designer JSON. This will be deserialized */
	//var workflow_model = App_Workflows.workflow_list_view.collection.get(workflow_id);
	//var workflow_name = workflow_model.get("name");

	var subscribers_collection = new Base_Collection_View({ 
		url : fetch_url, 
		templateKey : template_key,
		individual_tag_name : 'tr', 
		cursor : true,
		page_size : 20,
		postRenderCallback : function(el)
		{
			head.js(LIB_PATH + 'lib/jquery.timeago.js', function()
			{
				$("time.campaign-started-time", el).timeago();
				$("time.campaign-completed-time", el).timeago();
			});

			//$('#subscribers-campaign-name').text(workflow_name);

		},
		appendItemCallback : function(el)
		{
			$("time.campaign-started-time", el).timeago();
			$("time.campaign-completed-time", el).timeago();
		} });

	return subscribers_collection;
}

/**
 * Fills pad-content for all, active, completed and removed 
 * subscribers when empty json obtains.
 * 
 * @param id -
 *          slate div id.
 * @param type - 
 *          to match with SUBSCRIBERS_PAD_CONTENT json key
 **/
function fill_subscribers_slate(id, type)
{
	var SUBSCRIBERS_PAD_CONTENT = {
		    "active-subscribers": {
		        "title": "Campaign does not have any active subscriber",
		        "description": "You can add subscribers from Contacts tab - using the Bulk Actions option",
		        "button_text" : "Add subscribers",
				"route" : "#contacts",
		        "image": "/img/clipboard.png"
		    },
		    "completed-subscribers": {
		        "title": "No contact assigned to this campaign",
		        "description": "You can add subscribers from Contacts tab - using the Bulk Actions option",
		        "button_text" : "Add subscribers",
				"route" : "#contacts",
		        "image": "/img/clipboard.png"
		    },
		    "removed-subscribers": {
		        "title": "No contact removed from this campaign",
		        "description": "Removed subscribers are the contacts deleted from the active campaign",
		        "image": "/img/clipboard.png"
		    },
		    "all-subscribers": {
		        "title": "No current or past subscribers for this campaign",
		        "description": "You can add subscribers from Contacts tab - using the Bulk Actions option",
		        "button_text" : "Add subscribers",
				"route" : "#contacts",
				"image": "/img/clipboard.png"
		    },
		    "unsubscribe-subscribers": {
		    	"title": "No unsubscriptions for this campaign",
		        "description": "Great! No one unsubscribed from this campaign",
				"image": "/img/clipboard.png"
		    },
		    "hardbounced-subscribers": {
		    	"title": "No hard bounces for this campaign",
		        "description": "Great! No email get hardbounced",
				"image": "/img/clipboard.png"
		    },
		    "softbounced-subscribers": {
		    	"title": "No soft bounces for this campaign",
		        "description": "Great! No email get softbounced",
				"image": "/img/clipboard.png"
		    },
		    "spam-reported-subscribers": {
		    	"title": "No one reported spam for this campaign",
		        "description": "Great! No one reported spam yet",
				"image": "/img/clipboard.png"
		    }
		}

	
	getTemplate("empty-collection-model", SUBSCRIBERS_PAD_CONTENT[type], undefined, function(template_ui){
		if(!template_ui)
			  return;

		$("#" + id).html($(template_ui));
	}, "#" + id);

}
/**
 * workflows.js is a script file to deal with common UI Handlers for
 * workflows from client side.
 * 
 * @module Campaigns  
 * 
 * 
 */
 /**
*  Workflow event listeners
*/
var Workflow_Model_Events = Base_Model_View.extend({
   
    events: {
        'click #save-workflow-top,#save-workflow-bottom,#duplicate-workflow-top,#duplicate-workflow-bottom': 'saveCampaignClick',
        'click #workflow-unsubscribe-option': 'unsubscribeCampaign',
        'click #workflow-designer-help': 'helpCampaign',
        'change #unsubscribe-action': 'unsubscribeCampaignOptionSelect',
    },

    unsubscribeCampaignOptionSelect : function(e){

        var targetEl = $(e.currentTarget);
        
        var all_text = "Contact will not receive any further emails from any campaign (i.e., the 'Send Email' option will not work. However, other actions in" 
                       + " campaign will work as expected)";
        
        var this_text = "Contact will be removed from this campaign";
        
        var ask_text = "Prompts the user with options to either unsubscribe from this campaign or all communication";
        
        var $p_ele = $(this).closest('div.controls').parent().find('small');
        
        if($(targetEl).val() == "UNSUBSCRIBE_FROM_ALL")
            $p_ele.html(all_text);
        
        if($(targetEl).val() == "UNSUBSCRIBE_FROM_THIS_CAMPAIGN")
            $p_ele.html(this_text);
        
        if($(targetEl).val() == "ASK_USER")
            $p_ele.html(ask_text);
          
    },
    /**
     * Script to show workflow video tutorial in bootstrap modal.
     **/
    helpCampaign : function(e){
        e.preventDefault();

        getTemplate('workflow-designer-help-modal', {}, undefined, function(template_ui){
            if(!template_ui)
                  return;           

            $("#workflow-designer-help-modal").html($(template_ui)).modal('show');

            // Stops video on modal hide
            $("#workflow-designer-help-modal").on("hide.bs.modal", function(){
                $(this).html("");
            });

        }, null);
    },

    unsubscribeCampaign : function(e){
        e.preventDefault();
        var targetEl = $(e.currentTarget);

        if($(targetEl).hasClass('collapsed'))
        {
            $('#workflow-unsubscribe-option').html('<span><i class="icon-plus"></i></span> Manage Unsubscription');
            return;
        }
        
        $('#workflow-unsubscribe-option').html('<span><i class="icon-minus"></i></span> Manage Unsubscription')
        
    },

   /**
     * Saves the content of workflow if the form is valid. Verifies for duplicate workflow names.
     * Separate ids are given for buttons (as IDs are unique in html) but having same functionality, 
     * so ids are separated by comma in click event.
     * 
     **/
    saveCampaignClick: function(e){
        e.preventDefault();
        var targetEl = $(e.currentTarget);

        // Temporary variable to hold clicked button, either top or bottom. $ is preceded, just to show 
       // it is holding jQuery object
       var $clicked_button = $(targetEl);
       
       if(!window.frames.designer.checkWorkflowSize())
           return;
       
       if($(targetEl).attr('disabled'))
        return;
           
        // Check if the form is valid
        if (!isValidForm('#workflowform')) {
            $('#workflowform').find("span.help-inline").not(':hidden').prev('input').focus();
            return false;
        }
        
        // Gets Designer JSON
        var designerJSON = window.frames.designer.serializePhoneSystem();
        /**
         * Checks if start node is connected to any other node.
         */      
        if(!is_start_active(designerJSON)){
            var $save_info = '<span style="color: red;">Please connect the \'Start\' node to another node in the campaign</span>';
            $("#workflow-msg").html($save_info).show().fadeOut(3000);
            return false;
        }

        var name = $('#workflow-name').val();
        
        var unsubscribe_tag = $('#unsubscribe-tag').val().trim();
        var unsubscribe_action = $('#unsubscribe-action').val();
        var unsubscribe_email = $('#unsubscribe-email').val().trim();
        var is_disabled = $('.is-disabled-top').attr("data");
        if($clicked_button.attr("class") == "is-disabled-top" && is_disabled)
            is_disabled = !JSON.parse(is_disabled);

        var unsubscribe_json ={
                                    "tag":unsubscribe_tag,
                                    "action":unsubscribe_action,
                                    "unsubscribe_email": unsubscribe_email
                               }
        
        // Check for valid name
        if (isNotValid(name)) {
            alert("Name not valid");
            return;
        }

        // Disables save button to prevent multiple save on click event issues
        disable_save_button($(targetEl));
        
        var workflowJSON = {};

        // New Workflow or Copy Workflow
        if (App_Workflows.workflow_model === undefined || $(targetEl).attr('id') === 'duplicate-workflow-top' || $(targetEl).attr('id') === 'duplicate-workflow-bottom') 
        {
            create_new_workflow(name, designerJSON, unsubscribe_json, $clicked_button, trigger_data, is_disabled);
        }
        // Update workflow
        else
        {
            workflowJSON = App_Workflows.workflow_model;
            App_Workflows.workflow_model.set("name", name);
            App_Workflows.workflow_model.set("rules", designerJSON);
            App_Workflows.workflow_model.set("unsubscribe", unsubscribe_json);
            App_Workflows.workflow_model.set("is_disabled", is_disabled);
            App_Workflows.workflow_model.save({}, {success: function(){
                
                enable_save_button($clicked_button);
                
                show_campaign_save();
                
                // Adds tag in our domain
                add_tag_our_domain(CAMPAIGN_TAG);
                
                // Hide message
                $('#workflow-edit-msg').hide();

                //toggle disable dropdown
                 if($clicked_button.attr("class") == "is-disabled-top"){
                     var disabled = $(".is-disabled-top");
                 
                    if (is_disabled) {
                        disabled.attr("data", true);
                        disabled.find('i').toggleClass('fa-lock').toggleClass('fa-unlock');
                        disabled.find('div').text("Enable Workflow");
                        $('#designer-tour').addClass("blur").removeClass("anti-blur");;
                        window.frames[0].$('#paintarea').addClass("disable-iframe").removeClass("enable-iframe");
                        window.frames[0].$('#paintarea .nodeItem table>tbody').addClass("disable-iframe").removeClass("enable-iframe");
                    } else {
                        disabled.attr("data", false);
                        disabled.find('i').toggleClass('fa-unlock').toggleClass('fa-lock');
                        disabled.find('div').text("Disable Workflow"); 
                        $('#designer-tour').addClass("anti-blur").removeClass("blur");;
                        window.frames[0].$('#paintarea').addClass("enable-iframe").removeClass("disable-iframe");
                        window.frames[0].$('#toolbartabs').removeClass("disable-iframe");
                       // $('#designer-tour').css("pointer-events","none");
                        window.frames[0].$('#paintarea .nodeItem table>tbody').addClass("enable-iframe").removeClass("disable-iframe");
                        
                    }
                }

                
                // Boolean data used on clicking on Done
                if(trigger_data && trigger_data["navigate"])
                {
                    Backbone.history.navigate("workflows", {
                      trigger: true
                  });
                }

                 // Adds tag in our domain
                add_tag_our_domain(CAMPAIGN_TAG);
                
            },
            
            error: function(jqXHR, status, errorThrown){ 
              enable_save_button($clicked_button);
              //var json = JSON.parse(status.responseText);
              //workflow_alerts(json["title"], json["message"],"workflow-alert-modal");
              // shows Exception message
              alert(status.responseText);
                }
            });        
            
        } 
    },

});

function initializeLogReportHandlers(){

    // Show stats of selected campaign
    $("#campaign-reports-select").change(function(e){
      
       e.preventDefault();
        var targetEl = $(e.currentTarget);

        var active_tab = $('#campaign-tabs .select').data('campaign-tab-active');
        
        if(active_tab == "STATS")
            Backbone.history.navigate("email-reports/"+$(targetEl).val() , {
                trigger: true
            });
        
        if(active_tab == "SUBSCRIBERS")
            Backbone.history.navigate("workflow/all-subscribers/"+$(targetEl).val() , {
                trigger: true
            });
        
        if(active_tab == "LOGS")
            Backbone.history.navigate("workflows/logs/"+$(targetEl).val() , {
                trigger: true
            });
    });
}
/**
* Report Collection event handlers
*/
var Workflow_Reports_Events = Base_Collection_View.extend({
   
    events: {
        'click #delete_campaign_logs': 'onDeleteAllCampaignLogs',
        'click .log-filters': 'onChangeLogFilter',       
    },

     /**
     *  Deletes all logs of campaign
     *      
     **/
    onDeleteAllCampaignLogs : function(e){

        e.preventDefault();
        
        // Gets campaign id
        var campaign_id = $("#logs-table").find("input.campaign").val();
        
        if(!campaign_id)
            return;
        
        if(!confirm("Are you sure you want to delete all logs?"))
            return;
        
        // Sends delete request to CampaignsAPI for deletion of logs
        $.ajax({
            url: 'core/api/campaigns/logs/' + campaign_id,
            type: 'DELETE',
            success: function(){
                App_Workflows.logsToCampaign(campaign_id);
                //location.reload(true);
            }
        });
    },

    // Show logs of selected filter
    onChangeLogFilter : function(e){
        e.preventDefault();
        var targetEl = $(e.currentTarget);

        var log_type = $(targetEl).data('log-type');
        var id = $(targetEl).data('campaign-id');
        
        App_Workflows.logsToCampaign(id, log_type, $(targetEl).text());

    },

});

$(function(){

	// To stop propagation to edit page
	$('body').on('click', '.stop-propagation', function (e) {
        e.stopPropagation();
    });
	
});

/**
 * Creates a new workflow or Copy existing workflow and add to workflows collection
 * 
 * @param name - workflow name
 * @param designerJSON - campaign workflow in json
 * @param unsubscribe_json - unsubscribe data of workflow
 * @param $clicked_button - jquery object to know clicked button
 **/
function create_new_workflow(name, designerJSON, unsubscribe_json, $clicked_button, trigger_data, is_disabled, was_disabled)
{
	var workflowJSON = {};
	
	workflowJSON.name = name;
    workflowJSON.rules = designerJSON;
    workflowJSON.unsubscribe = unsubscribe_json;
    workflowJSON.is_disabled = is_disabled;
    workflowJSON.was_disabled = was_disabled;
    
    var workflow = new Backbone.Model(workflowJSON);
    App_Workflows.workflow_list_view.collection.create(workflow,{
    	    success:function(){  

    	    	// Removes disabled attribute of save button
    	    	enable_save_button($clicked_button);
    	    	
    	    	// Shows Campaign save message
    	    	show_campaign_save();
    	    	
    	    	// $('#workflowform').find('#save-workflow').removeAttr('disabled');
    	    	
    	    	// Hide edit message
    	    	$('#workflow-edit-msg').hide();
    	    	
    	    	// $(".save-workflow-img").remove();
    	    	        
    	    	// Boolean data used on clicking on Done
    	    	if(trigger_data && trigger_data["navigate"])
    	    	{
    	    		Backbone.history.navigate("workflows", {
                      trigger: true
                  });
    	    	}
    	    	
    	    	// Updates workflow model
    	    	App_Workflows.workflow_model = workflow;
    	    },
            
            error: function(jqXHR, status, errorThrown){ 
              enable_save_button($clicked_button); 
              
              // shows Exception message
              if(status.status != 406)
              {
            	  // Show different message for Copy
            	  if($clicked_button.attr('id') === 'duplicate-workflow-bottom' || $clicked_button.attr('id') === 'duplicate-workflow-top')
            	  {
            		  if(status.responseText === "Please change the given name. Same kind of name already exists.")
            		  {
            			  alert("Please change the name and click on 'Create a Copy' again.");
            			  return;
            		  }
            	  }
            	  
            	  alert(status.responseText);
              }
              else
            	  {
            	  console.log(status);
            		// Show cause of error in saving
					$save_info = $('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'
							+ status.responseText
							+ '</i></p></small></div>');

					// Appends error info to form actions
					// block.
					$("#workflow-msg").html(
							$save_info).show();
            	  }
                }
    });
}

/**
 * Fills pad-content for logs when empty json obtains.
 * 
 * @param id -
 *          slate div id.
 * @param type - 
 *          to match with LOGS_PAD_CONTENT json key
 **/
function fill_logs_slate(id, type)
{
	if(type == undefined)
		type="ALL";
	
	var LOGS_PAD_CONTENT = {
		    "ALL": {
		        "title": "No logs for this campaign yet",
				"image": "/img/clipboard.png"
		    },
		    "EMAIL_SENT": {
		    	"title": "No emails sent yet",
				"image": "/img/clipboard.png"
		    },
		    "EMAIL_OPENED": {
		    	"title": "No emails opened in this campaign",
				"image": "/img/clipboard.png"
		    },
		    "EMAIL_CLICKED": {
		    	"title": "No emails clicked in this campaign",
				"image": "/img/clipboard.png"
		    },
		    "UNSUBSCRIBED": {
		    	"title": "No one unsubscribed from this campaign",
				"image": "/img/clipboard.png"
		    },
		    "EMAIL_HARD_BOUNCED": {
		    	"title": "No hard bounces seen for  this campaign",
				"image": "/img/clipboard.png"
		    },
		    "EMAIL_SOFT_BOUNCED": {
		    	"title": "No soft bounces seen for this campaign",
				"image": "/img/clipboard.png"
		    },
		    "EMAIL_SPAM": {
		    	"title": "No spam reports seen for this campaign",
				"image": "/img/clipboard.png"
		    }
		}

	getTemplate("empty-collection-model", LOGS_PAD_CONTENT[type], undefined, function(template_ui){
        if(!template_ui)
              return;
            
        $("#" + id).html($(template_ui));
    }, "#" + id);


}

function show_campaign_save()
{
	// Campaign save message
	var $save_info = '<span style="color: green;">Campaign saved.</span>';

	$("#workflow-msg").html($save_info).show().fadeOut(3000);
}

function is_start_active(designerJSON){
    
    var nodes  = JSON.parse(designerJSON).nodes;
    var is_active = true;
    try{
    $.each(nodes,function(node_name,node_value){
        if(node_value.displayname == "Start"){
        var start_states= node_value.States;
        $.each(start_states,function(start_name,start_node){
        if(start_node.start == "hangup"){
            is_active = false;
            return true
        }
        });
        }
        });
    }
    catch(err){
        return is_active;
    }
    return is_active;
}
/**
 * wysihtml.js is used to embed beautiful html editors to email body. Inserts
 * merge fields into email body. wysihtml makes use of wysihtml5 which is a
 * javascript plugin that makes it easy to create simple, beautiful wysiwyg
 * editors with the help of wysihtml5 and Twitter Bootstrap.
 */
var Email_Template_Events = Base_Model_View.extend({
	
	events: {
		'click .merge-field': 'onMergeFieldSelect',
		'click .add-attachment-select': 'onAddAttachmentSelect',
		'click .add-attachment-confirm': 'onAddAttachmentConfirm',
		'click .add-attachment-cancel': 'onAddAttachmentCancel',				
		'click .add-tpl-attachment-confirm': 'onTemplateAddAttachmentConfirm',
		'click .add-tpl-attachment-cancel': 'onTemplateAddAttachmentCancel',
		'change #attachment-select': 'onChangedAttachment',					
	},

	// Code for Merge fields in Email Template
	onMergeFieldSelect: function(e){
		e.preventDefault();

		// Get Selected Value
		var fieldContent = $(e.currentTarget).attr("name");

		// Get Current HTML
		var val = $('#email-template-html').val();

		// Set New HTML
		var wysihtml5 = $('#email-template-html').data('wysihtml5');
		if (wysihtml5) {
			
			// wysihtml5.editor.setValue(fieldcontent + " " + val,
			// true);
		    editor.focus();
			wysihtml5.editor.composer.commands.exec("insertHTML", '{{'
					+ fieldContent + '}}');
		}
	},

	onAddAttachmentSelect : function(e){
		e.preventDefault();
		var target_ele = $(e.currentTarget);

		var el = $(target_ele).closest("div");
		$(target_ele).css("display", "none");
		el.find(".attachment-document-select").css("display", "inline");
		var optionsTemplate = "<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}'>{{name}}</option>";
        fillSelect('attachment-select','core/api/documents', 'documents',  function fillNew()
		{
			el.find("#attachment-select option:first").after("<option value='new'>Upload new doc</option>");

		}, optionsTemplate, false, el);
        $('#enable_tracking').css("margin-top", "-7px");

	},
	
	/**
	 * For adding existing document to current contact
	 */
	onAddAttachmentConfirm : function(e){
		e.preventDefault();
		var target_ele = $(e.currentTarget);

		var network_type = $('#attachment-select').find(":selected").attr('network_type');
		var document_size = $('#attachment-select').find(":selected").attr('size');
		if(typeof network_type !=='undefined' && network_type.toUpperCase() === 'GOOGLE')
		{
			$(target_ele).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>Can not attach Google Drive doc to email. You can add a link instead in the email.</span>");
			$(target_ele).css({'border': '1px solid #df382c','outline': 'none'   });				             	            
		}
		else if(document_size >= 5242880){
			$(target_ele).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>Document size exceeds the 5MB limit.</span>");
			$(target_ele).css({'border': '1px solid #df382c','outline': 'none'   });
		}
		else
		{
			$('#attachment-select').closest("span").find('.attachment-status').find("span").fadeOut(0);
			$('#attachment-select').css({"border":"1px solid #bbb"});
		    var document_id = $(target_ele).closest(".attachment-document-select").find("#attachment-select").val();
		    var saveBtn = $(target_ele);
			
	  		// To check whether the document is selected or not
		    if(document_id == "")
		    {
		    	saveBtn.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>This field is required.</span>");
		    	saveBtn.closest("span").find('span.save-status').find("span").fadeOut(5000);
		    	return;
		    }	    	
		    else if(document_id == "new")
		    {	
		    	e.preventDefault();
				$(target_ele).closest('form').find('#error').html("");
				var form_id = $(target_ele).closest('form').attr("id");
				var id = $(target_ele).find("a").attr("id");
				
				var newwindow = window.open("upload-attachment.jsp?id="+ form_id +"&t=" + CURRENT_USER_PREFS.template +"&d=" + CURRENT_DOMAIN_USER.domain, 'name','height=310,width=500');
				
				if (window.focus)
				{
					newwindow.focus();
				}
		    }
		    else if(document_id != undefined && document_id != null)
		    {
		    	var docName = $( "#attachment-select option:selected").text();
		    	$('#emailForm').find('#eattachment').css('display','block');
		    	$('#emailForm').find('#attachment_id').find("#attachment_fname").text(docName);
		    	$('#emailForm').find(".attachment-document-select").css('display','none');
		    	$('#emailForm').find('#eattachment_key').attr('name',"document_key");
		    	$('#emailForm').find('#eattachment_key').attr('value',document_id);
		    }
	    }
		$('#enable_tracking').css("margin-top", "-47px");

	},

	/**
	 * To cancel the add attachment request in send-email form
	 */
	onAddAttachmentCancel : function(e){
		e.preventDefault();
		var target_ele = $(e.currentTarget);

		var blobKey = $('#emailForm').find('#attachment_id').attr('name');
		if(typeof blobKey !== typeof undefined)
	    {
			if(blobKey.toLowerCase() === 'blob_key')
			{
				var blobKeyValue = $('#emailForm').find('#eattachment_key').attr("value");
				deleteBlob(blobKeyValue);
			}
	    }
		$('#attachment-select').closest("span").find('.attachment-status').find("span").fadeOut(0);
		$('#attachment-select').css({"border":"1px solid #bbb"});	 
		$('#attachment-select').find('option:first').attr('selected', 'selected');
		var el = $(target_ele).closest("div");
		$('#emailForm').find('.attachment-document-select').css('display','none');
		$('#emailForm').find('#eattachment').css('display','none');
		$('#emailForm').find(".add-attachment-select").css("display", "inline");
		$('#emailForm').find('#eattachment_key').attr("name","name");
    	$('#emailForm').find('#eattachment_key').attr("value","value");
    	$('#enable_tracking').css("margin-top", "-7px");

	},

	onTemplateAddAttachmentConfirm : function(e){
		e.preventDefault();
		var target_ele = $(e.currentTarget);

		if($(target_ele).parent().find('select').val()=="new"){

			$('#uploadDocumentModal').html(getTemplate("upload-document-modal", {})).modal('show');
			$('#GOOGLE',$('#uploadDocumentModal')).parent().hide();

		}else if($(target_ele).parent().find('select').val()!=""){
			$('#tpl-attachment-select').hide();
			$('#tpl-attachment-name').show();
			$('#attachment_id',$('#tpl-attachment-name')).val($(target_ele).parent().find('select').val());
			$('#tpl_attachment_fname',$('#tpl-attachment-name')).html('<a href='+$(target_ele).parent().find('option:selected').attr('url')+'>'+$(target_ele).parent().find('option:selected').text()+'</a>');
		}else if($(target_ele).parent().find('select').val()==""){
			$('#attachment-select-required').show();
		}

	},

	onTemplateAddAttachmentCancel : function(e){
		e.preventDefault();
		var target_ele = $(e.currentTarget);

		$('#tpl-attachment-select').show();
		$('#tpl-attachment-name').hide();
		$('.add-attachment-select').show();
		$('.attachment-document-select').hide();
		$('#attachment_id',$('#tpl-attachment-name')).val("");

	},

	onChangedAttachment : function(e){
		e.preventDefault();
		var target_ele = $(e.currentTarget);

		if($(target_ele).val()==""){
			$('#attachment-select-required').show();
		}else{
			$('#attachment-select-required').hide();
		}

	},

});

/**
 * Sets HTML Editor for UserPrefs, EmailTemplates etc.
 **/
function setupHTMLEditor(selector, data) {
	head.js(LIB_PATH + 'lib/wysihtml5-0.3.0-min.js', LIB_PATH + 'lib/bootstrap-wysihtml5-min.js',
			function() {
				console.log('setting up text');
				console.log(selector.html());
				
				if(!$(selector).data('wysihtml5'))
					selector.wysihtml5();
				
				if(data)
					selector.data("wysihtml5").editor.setValue(data, false);
				
			});
}