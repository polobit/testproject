Backbone.View.prototype.close=function(){this.remove();this.unbind();if(this.onClose){this.onClose()}};var BaseModel=Backbone.Model.extend({});var BaseCollection=Backbone.Collection.extend({model:BaseModel,initialize:function(c,b){this.restKey=b.restKey;if(b.sortKey){this.sortKey=b.sortKey}if(b.descending){this.descending=b.descending}this.sort_collection=b.sort_collection;if(this.sort_collection==false){this.comparator=false}},comparator:function(b){if(this.sortKey){if(this.descending==true){return -b.get(this.sortKey)}return b.get(this.sortKey)}return b.get("id")},parse:function(b){if(b&&b[this.restKey]){return b[this.restKey]}return b}});var Base_List_View=Backbone.View.extend({events:{"click .delete":"deleteItem","click .edit":"edit","delete-checked .agile_delete":"deleteItem","click .delete-model":"deleteModel"},initialize:function(){_.bindAll(this,"render","deleteItem","edit","deleteModel");this.model.bind("destroy",this.close,this);this.model.bind("change",this.render,this)},deleteItem:function(b){b.preventDefault();this.model.destroy();this.remove()},deleteModel:function(b){b.preventDefault();if(!confirm("Are you sure you want to delete?")){return false}$.ajax({type:"DELETE",url:this.model.url(),success:function(){location.reload(true)}})},edit:function(b){},render:function(d){var b=false;if(b){var c=this;getTemplate(c.options.template,c.model.toJSON(),undefined,function(e){$(c.el).html(e);$(c.el).data(c.model);console.log($(c.el));d(c.el)});return this}$(this.el).html(getTemplate(this.options.template,this.model.toJSON()));$(this.el).data(this.model);return this}});var Base_Collection_View=Backbone.View.extend({initialize:function(){_.bindAll(this,"render","appendItem","appendItemOnAddEvent","buildCollectionUI");if(this.options.data){this.collection=new BaseCollection(this.options.data,{restKey:this.options.restKey,sortKey:this.options.sortKey,descending:this.options.descending,sort_collection:this.options.sort_collection})}else{this.collection=new BaseCollection([],{restKey:this.options.restKey,sortKey:this.options.sortKey,descending:this.options.descending,sort_collection:this.options.sort_collection})}this.collection.url=this.options.url;this.model_list_template=$('<div class="model-list"></div>');this.collection.bind("sync",this.appendItem);this.collection.bind("add",this.appendItemOnAddEvent);var d=this;this.collection.bind("reset",function(){d.render(true)});this.collection.bind("error",function(j,g){if(g.status==401){var h=window.location.hash;unregisterAll();sipUnRegister();window.location.href=window.location.protocol+"//"+window.location.host+"/login"+h;return}d.render(true,g.responseText)});this.render();if(this.options.cursor){this.page_size=this.options.page_size;this.global_sort_key=this.options.global_sort_key;this.request_method=this.options.request_method;this.post_data=this.options.post_data;if(!this.page_size){this.page_size=20}var d=this;this.infiniScroll=new Backbone.InfiniScroll(this.collection,{success:function(){$(".scroll-loading",d.el).remove()},untilAttr:"cursor",param:"cursor",strict:true,pageSize:this.page_size,onFetch:function(){var g="table";if(d.options.scroll_symbol){g="section"}$(g,d.el).after('<div class="scroll-loading" style="margin-left:50%">'+LOADING_ON_CURSOR+"</div>")}});addInfiniScrollToRoute(this.infiniScroll);var c=this.page_size;var f=this.global_sort_key;var b=this.request_method;var e=this.post_data;this.collection.fetch=function(g){g||(g={});g.data||(g.data={});g.data.page_size=c;if(f&&f!=null){g.data.global_sort_key=f}if(b&&b!=null){g.type=b;if(b.toLowerCase()=="post"&&e&&e!=null){$.each(e,function(h,j){g.data[h]=j})}}return Backbone.Collection.prototype.fetch.call(this,g)}}},appendItem:function(c,b){if(b){$(this.model_list_element).append(this.createListView(c).render().el);return}this.model_list_element_fragment.appendChild(this.createListView(c).render().el)},createListView:function(b){if(this.options.modelData){b.set(this.options.modelData)}var c=new Base_List_View({model:b,template:(this.options.templateKey+"-model"),tagName:this.options.individual_tag_name});return c},appendItemOnAddEvent:function(b){this.appendItem(b,true);var c=this.options.appendItemCallback;if(c&&typeof(c)==="function"){c($(this.el))}if($("table",this.el).hasClass("onlySorting")){return}append_checkboxes(this.model_list_element)},render:function(d,c){if(d==undefined){$(this.el).html(getRandomLoadingImg());return this}if($(this.el).html()==getRandomLoadingImg()){$(this.el).empty()}if(c){$(this.el).html('<div style="padding:10px;font-size:14px"><b>'+c+"<b></div>");return}var e=this;var b=this.buildCollectionUI;getTemplate((this.options.templateKey+"-collection"),this.collection.toJSON(),"yes",b);if(this.page_size&&(this.collection.length<this.page_size)){console.log("Disabling infini scroll");this.infiniScroll.destroy()}return this},buildCollectionUI:function(b){$(this.el).html(b);if(this.collection.models.length==0){fill_slate("slate",this.el,this.options.slateKey)}if(IS_FLUID){$(this.el).find("div.row").removeClass("row").addClass("row-fluid")}this.model_list_element_fragment=document.createDocumentFragment();this.model_list_element=$("#"+this.options.templateKey+"-model-list",$(this.el));var c=document.createDocumentFragment();_(this.collection.models).each(function(e){this.appendItem(e)},this);$(this.model_list_element).append(this.model_list_element_fragment);var d=this.options.postRenderCallback;if(d&&typeof(d)==="function"){d($(this.el),this.collection)}$("body").trigger("agile_collection_loaded",[this.el]);return this}});var Base_Model_View=Backbone.View.extend({events:{"click .save":"save","click .delete":"deleteItem"},initialize:function(){_.bindAll(this,"render","save","deleteItem","buildModelViewUI");if(this.options.data!=undefined){this.model=new Backbone.Model(this.options.data)}else{if(this.options.model){this.model=this.options.model}else{this.model=new Backbone.Model({})}}this.model.bind("change",this.onChange,this);this.model.bind("error",function(d,c){if(c.status==401){var e=window.location.hash;unregisterAll();sipUnRegister();window.location.href=window.location.protocol+"//"+window.location.host+"/login"+e;return}});if(this.options.url){this.model.url=this.options.url}if((!this.options.isNew)&&$.isEmptyObject(this.model.toJSON())){console.log("to fetch");var b=this;this.model.fetch({success:function(c){b.render(true)}})}},deleteItem:function(b){b.preventDefault();var c=this.options.deleteCallback;if(!confirm("Are you sure you want to delete?")){return false}this.model.destroy({success:function(e,d){if(c&&typeof(c)==="function"){console.log(d);c(e,d)}location.reload(true)}})},save:function(g){g.preventDefault();trigger_tinymce_save();var k=$(this.el).find("form").attr("id");var c=this.options.saveCallback;var d=this.options.errorCallback;var n=$("#"+k);console.log(n.find(".save"));if($(g.currentTarget).attr("disabled")){return}disable_save_button($(g.currentTarget));var l,m;if($(this.el).find("form").length>1){m={};$.each($(this.el).find("form"),function(p,q){if(!isValidForm($(q))){l=false;return}var e=$(q).attr("id");var o=$(q).attr("name");if(o){m[o]=serializeForm(e)}else{$.each(serializeForm(e),function(s,t){m[s]=t})}})}if(l==false||!isValidForm(n)){enable_save_button($(g.currentTarget));return}this.model.clear({silent:true});if(!m){m=serializeForm(k)}this.model.set(m,{silent:true});var h=this.options.window;var b=this.options.reload;var j=this.options.modal;var f=this.options.prePersist;if(f&&typeof(f)==="function"){f(this.model)}this.model.save([],{wait:true,success:function(o,e){enable_save_button($(g.currentTarget));if(c&&typeof(c)==="function"){console.log(e);c(e)}if(b){location.reload(true)}else{if(h){if(h=="back"){history.back(-1)}else{Backbone.history.navigate(h,{trigger:true})}n.each(function(){this.reset()});if(j){$(j).modal("hide")}}else{}}},error:function(o,e){enable_save_button($(g.currentTarget));console.log(e);if(d&&typeof(d)==="function"){d(e);return}$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+e.responseText+"</i></p></small></div>");$(g.currentTarget).closest(".form-actions",this.el).append($save_info);if(e.status!=406){$save_info.show().delay(3000).hide(1)}}},{silent:true})},render:function(b){if(!this.model.isNew()||this.options.isNew||!$.isEmptyObject(this.model.toJSON())||b){getTemplate(this.options.template,this.model.toJSON(),"yes",this.buildModelViewUI)}else{$(this.el).html(getRandomLoadingImg())}return this},onChange:function(){if(this.options.change==false){return}this.render(true)},buildModelViewUI:function(b){$(this.el).on("DOMNodeInserted",function(d){$(this).trigger("view_loaded")});$(this.el).html(b);var c=this.options.postRenderCallback;if(c&&typeof(c)==="function"){c($(this.el),this.model.toJSON())}if(this.options.isNew!=true){if($(this.el).find("form").length>1){deserializeMultipleForms(this.model.toJSON(),$(this.el).find("form"))}else{if($(this.el).find("form").length==1){deserializeForm(this.model.toJSON(),$(this.el).find("form"))}}}if(IS_FLUID){$(this.el).find("div.row").removeClass("row").addClass("row-fluid")}$(this.el).trigger("agile_model_loaded")}});function disable_save_button(b){b.css("min-width",b.width()+"px").attr("disabled","disabled").attr("data-save-text",b.html()).text("Saving...")}function enable_save_button(b){b.html(b.attr("data-save-text")).removeAttr("disabled data-save-text")}var INFINI_SCROLL_JSON={};function addInfiniScrollToRoute(b){var c=window.location.hash.split("#")[1];if(INFINI_SCROLL_JSON[c]){INFINI_SCROLL_JSON[c].destroy()}INFINI_SCROLL_JSON[c]=b}function activateInfiniScroll(){var b=window.location.hash.split("#")[1];$.each(INFINI_SCROLL_JSON,function(c,d){d.disableFetch()});if(INFINI_SCROLL_JSON[b]){INFINI_SCROLL_JSON[b].enableFetch()}}var PortletsRouter=Backbone.Router.extend({routes:{},portlets:function(){head.js(LIB_PATH+"jscore/handlebars/handlebars-helpers.js",LIB_PATH+"lib/jquery.gridster.js",function(){var b=$(getTemplate("portlets",{}));
$("#content").html(b);if(IS_FLUID){$("#content").find("div.row").removeClass("row").addClass("row-fluid")}loadPortlets(b)})}});function addNewPortlet(f,b){var d={};var k={};var c=new Date();if(b=="FilterBased"){d.name="Filter Based"}else{if(b=="EmailsOpened"){d.name="Emails Opened"}else{if(b=="EmailsSent"){d.name="Emails Sent"}else{if(b=="PendingDeals"){d.name="Pending Deals"}else{if(b=="Agenda"){d.name="Agenda"}else{if(b=="TodayTasks"){d.name="Today Tasks"}else{if(b=="DealsByMilestone"){d.name="Deals By Milestone"}else{if(b=="ClosuresPerPerson"){d.name="Closures Per Person"}else{if(b=="DealsWon"){d.name="Deals Won"}else{if(b=="DealsFunnel"){d.name="Deals Funnel"}else{if(b=="GrowthGraph"){d.name="Growth Graph"}else{if(b=="DealsAssigned"){d.name="Deals Assigned"}else{if(b=="CallsPerPerson"){d.name="Calls Per Person"}else{if(b=="AgileCRMBlog"){d.name="Agile CRM Blog"}else{if(b=="TaskReport"){d.name="Task Report"}}}}}}}}}}}}}}}d.portlet_type=f;var l=0;if(gridster!=undefined){var j=gridster.next_position(1,1)}d.column_position=j.col;d.row_position=j.row;d.size_x=j.size_x;d.size_y=j.size_y;if(f=="CONTACTS"&&b=="FilterBased"){k.filter="myContacts"}else{if(f=="CONTACTS"&&b=="EmailsOpened"){k.duration="2-days"}else{if(f=="USERACTIVITY"&&b=="EmailsSent"){k.duration="1-day"}else{if(f=="CONTACTS"&&b=="GrowthGraph"){k.tags="";k.frequency="daily";k.duration="1-week"}else{if(f=="DEALS"&&b=="PendingDeals"){k.deals="my-deals"}else{if(f=="DEALS"&&(b=="DealsByMilestone"||b=="DealsFunnel")){k.deals="my-deals";k.track=0}else{if(f=="DEALS"&&b=="ClosuresPerPerson"){k["group-by"]="number-of-deals";k["due-date"]=Math.round((new Date()).getTime()/1000)}else{if(f=="DEALS"&&b=="DealsWon"){k.duration="1-week"}else{if(f=="DEALS"&&b=="DealsAssigned"){k.duration="1-day"}else{if(f=="USERACTIVITY"&&b=="CallsPerPerson"){k["group-by"]="number-of-calls";k.duration="1-day"}else{if(f=="TASKSANDEVENTS"&&b=="TaskReport"){k["group-by"]="user";k["split-by"]="category";k.duration="1-week"}else{if(f=="RSS"&&b=="AgileCRMBlog"){d.size_y=2}}}}}}}}}}}}var h=new BaseModel();h.url="core/api/portlets/addPortlet";h.set({prefs:JSON.stringify(k)},{silent:true});var e;var g;h.save(d,{success:function(m){hidePortletsPopup();e=m.toJSON();if($("#zero-portlets").is(":visible")){$("#zero-portlets").hide()}if($("#no-portlets").is(":visible")){$("#no-portlets").hide()}Portlets_View.collection.add(e);g=((parseInt($("#ui-id-"+e.column_position+"-"+e.row_position).attr("data-row"))-1)*200)+5;window.scrollTo(0,g)},error:function(n,m){hidePortletsPopup();var n=data.toJSON();if($("#zero-portlets").is(":visible")){$("#zero-portlets").hide()}if($("#no-portlets").is(":visible")){$("#no-portlets").hide()}Portlets_View.collection.add(n);g=((parseInt($("#ui-id-"+n.column_position+"-"+n.row_position).attr("data-row"))-1)*200)+5;window.scrollTo(0,g)}})}function hidePortletsPopup(){$("#portletStreamModal").modal("hide");$(".modal-backdrop").hide()}function deletePortlet(b){var c=b.id.split("-close")[0];$("#portletDeleteModal").modal("show");$("#portletDeleteModal > .modal-footer > .save-modal").attr("id",c);$("#portletDeleteModal > .modal-body").html("Are you sure you want to delete Dashlet - "+$("#"+c).parent().find(".portlet_header > .portlet_header_name").text().trim()+"?")}$(".portlet-delete-modal").live("click",function(b){b.preventDefault();var c=Portlets_View.collection.get($(this).attr("id"));$.ajax({type:"DELETE",url:"/core/api/portlets/"+c.get("id"),contentType:"application/json; charset=utf-8",success:function(d){Portlets_View.collection.remove(c);gridster.remove_widget($("#"+c.get("id")).parent(),false);setTimeout(function(){gridster.$changed.attr("id","ui-id-"+gridster.$changed.attr("data-col")+"-"+gridster.$changed.attr("data-row"))},500);$("#"+c.get("id")).parent().remove();if($(".gridster-portlets > div").length==0){$("#no-portlets").show()}$("#portletDeleteModal").modal("hide")},dataType:"json"})});$("#add-portlet").live("click",function(b){b.preventDefault();this.Catalog_Portlets_View=new Base_Collection_View({url:"/core/api/portlets/default",restKey:"portlet",templateKey:"portlets-add",sort_collection:false,individual_tag_name:"div",postRenderCallback:function(c){if($("#deals",$("#portletStreamModal")).children().length==0){$("#deals",$("#portletStreamModal")).parent().hide()}if($("#taksAndEvents",$("#portletStreamModal")).children().length==0){$("#taksAndEvents",$("#portletStreamModal")).parent().hide()}if($("#userActivity",$("#portletStreamModal")).children().length==0){$("#userActivity",$("#portletStreamModal")).parent().hide()}}});this.Catalog_Portlets_View.appendItem=organize_portlets;this.Catalog_Portlets_View.collection.fetch();$("#portletStreamModal").modal("show");$("#portletstreamDetails",$("#portletStreamModal")).html(this.Catalog_Portlets_View.el)});$("#portlets-contacts-model-list > tr, #portlets-companies-model-list > tr, #portlets-contacts-email-opens-model-list > tr").live("click",function(b){var c=$(this).find(".data").attr("data");App_Contacts.navigate("contact/"+c,{trigger:true})});$("#portlets-opportunities-model-list > tr").live("click",function(b){if(b.target.attributes[0].name!="href"){var c=$(this).find(".data").attr("data");App_Deal_Details.navigate("deal/"+c,{trigger:true})}});$("#portlets-events-model-list > tr").live("click",function(d){App_Portlets.currentPosition=""+$(this).parents(".gs-w").find(".column_position").text().trim()+""+$(this).parents(".gs-w").find(".row_position").text().trim();var f=$(this).find(".data").attr("data");var c=$(this).data().collection.get(f);if(isNaN(f)){return}deserializeForm(c.toJSON(),$("#updateActivityForm"));$("#update-event-time-1").val((new Date(c.get("start")*1000).getHours()<10?"0":"")+new Date(c.get("start")*1000).getHours()+":"+(new Date(c.get("start")*1000).getMinutes()<10?"0":"")+new Date(c.get("start")*1000).getMinutes());$("#update-event-time-2").val((new Date(c.get("end")*1000).getHours()<10?"0":"")+new Date(c.get("end")*1000).getHours()+":"+(new Date(c.get("end")*1000).getMinutes()<10?"0":"")+new Date(c.get("end")*1000).getMinutes());var b="mm/dd/yyyy";$("#update-event-date-1").val((new Date(c.get("start")*1000)).format(b));$("#update-event-date-2").val((new Date(c.get("end")*1000)).format(b));if(event.allDay){$("#update-event-date-2").closest(".row").hide();$("#update-event-time-1").closest(".control-group").hide()}else{$("#update-event-time-1").closest(".control-group").show();$("#update-event-date-2").closest(".row").show()}populateUsersInUpdateActivityModal(c.toJSON());$("#updateActivityModal").modal("show");return false});$("#portlets-tasks-model-list > tr").live("click",function(b){if(b.target.attributes[0].name!="href"){var c=$(this).find(".data").attr("data");App_Tasks.navigate("task/"+c,{trigger:true})}});$(".portlets-tasks-select").live("click",function(f){f.stopPropagation();if($(this).is(":checked")){var d=$(this).attr("data");var b=$(this).parentsUntil(".gs-w").last().parent().find(".column_position").text().trim();var c=$(this).parentsUntil(".gs-w").last().parent().find(".row_position").text().trim();var g=b+""+c;complete_task(d,App_Portlets.tasksCollection[parseInt(g)].collection,$(this).closest("tr"));if($(this).parentsUntil("table").last().find("tr:visible").length==1){$(this).parentsUntil("table").parent().parent().html('<div class="portlet-error-message">No tasks found.</div>')}}});function hidePortletErrors(b){if($("#"+b.id).next().is(":visible")){$("#"+b.id).next().hide()}}$(".portlet-settings").live("click",function(b){b.preventDefault();showPortletSettings(this.id)});function addWidgetToGridster(b){var c=true;if(gridster!=undefined){gridster.$widgets.each(function(d,e){if(e.id=="ui-id-"+b.get("column_position")+"-"+b.get("row_position")+""){c=false}});if(c){gridster.add_widget($("#ui-id-"+b.get("column_position")+"-"+b.get("row_position")),b.get("size_x"),b.get("size_y"),b.get("column_position"),b.get("row_position"));gridster.set_dom_grid_height();window.scrollTo(0,((parseInt($("#ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-row"))-1)*200)+5)}}}function getStartAndEndDatesOnDue(b){var c=new Date();if(b=="1-day"||b=="today"){console.log(getGMTTimeFromDate(c)/1000)}if(b=="this-week"){if(new Date().getDay()!=0){c.setDate(c.getDate()-(new Date().getDay()-1))}else{c.setDate(c.getDate()-(new Date().getDay()+6))}}if(b=="1-week"){c.setDate(c.getDate()-6)}if(b=="1-month"){c.setDate(c.getDate()-29)}if(b=="this-month"){c.setDate(1)}if(b=="TOMORROW"){c.setDate(c.getDate()+1)}if(b=="yesterday"){c.setDate(c.getDate()-1)}if(b=="2-days"){c.setDate(c.getDate()-1)}console.log((getGMTTimeFromDate(c)/1000));return(getGMTTimeFromDate(c)/1000)}var view={};var AdminSettingsRouter=Backbone.Router.extend({routes:{admin:"adminSettings","account-prefs":"accountPrefs",users:"users","users-add":"usersAdd","user-edit/:id":"userEdit","custom-fields":"customFields",api:"api","analytics-code":"analyticsCode","analytics-code/:id":"analyticsCode",milestones:"milestones","menu-settings":"menu_settings","integrations-stats":"integrationsStats",integrations:"integrations","tag-management":"tagManagement","email-gateways/:id":"emailGateways","sms-gateways/:id":"smsGateways"},menu_settings:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});var b=new Base_Model_View({url:"/core/api/menusetting",template:"admin-settings-menu-settings",reload:true});$("#content").find("#admin-prefs-tabs-content").html(b.render().el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".menu-settings-tab").addClass("active")},accountPrefs:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});var b=new Base_Model_View({url:"/core/api/account-prefs",template:"admin-settings-account-prefs"});$("#content").find("#admin-prefs-tabs-content").html(b.render().el);
$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".account-prefs-tab").addClass("active")},users:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});this.usersListView=new Base_Collection_View({url:"/core/api/users",restKey:"domainUser",templateKey:"admin-settings-users",individual_tag_name:"tr",postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".last-login-time",b).timeago()})}});this.usersListView.collection.fetch();$("#content").find("#admin-prefs-tabs-content").html(this.usersListView.el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".users-tab").addClass("active")},usersAdd:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});var b=new Base_Model_View({url:"core/api/users",template:"admin-settings-user-add",isNew:true,window:"users",reload:false,postRenderCallback:function(c){if(b.model.get("id")){addTagAgile("User invited")}bindAdminChangeAction(c,b.model.toJSON())},saveCallback:function(c){$.getJSON("core/api/users/current-owner",function(d){if(d){d.created_user_email=c.email;add_created_user_info_as_note_to_owner(d)}})}});$("#content").find("#admin-prefs-tabs-content").html(b.render().el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".users-tab").addClass("active")},userEdit:function(e){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});if(!this.usersListView||!this.usersListView.collection.get(e)){this.navigate("users",{trigger:true});return}var d=this.usersListView.collection.get(e);var c=false;if(CURRENT_DOMAIN_USER.email==d.attributes.email){c=true}var b=new Base_Model_View({url:"core/api/users",model:d,template:"admin-settings-user-add",saveCallback:function(f){if(c&&CURRENT_DOMAIN_USER.email!=f.email){console.log("Logging out...");showNotyPopUp("information","You Email has been updated successfully. Logging out...","top");var g=window.location.hash;setTimeout(function(){window.location.href=window.location.protocol+"//"+window.location.host+"/login"+g},5000)}else{Backbone.history.navigate("users",{trigger:true})}},postRenderCallback:function(f){bindAdminChangeAction(f,b.model.toJSON())}});$("#content").find("#admin-prefs-tabs-content").html(b.render().el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".users-tab").addClass("active")},customFields:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});this.customFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields/allScopes",restKey:"customFieldDefs",templateKey:"admin-settings-customfields",individual_tag_name:"tr"});this.customFieldsListView.appendItem=groupingCustomFields;this.customFieldsListView.collection.fetch();$("#content").find("#admin-prefs-tabs-content").html(this.customFieldsListView.el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".custom-fields-tab").addClass("active")},analyticsCode:function(b){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});head.js(LIB_PATH+"lib/prettify-min.js",function(){var c=new Base_Model_View({url:"/core/api/api-key",template:"admin-settings-api-key-model",postRenderCallback:function(d){$("#content").find("#admin-prefs-tabs-content").html(c.el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".analytics-code-tab").addClass("active");prettyPrint();if(b){$(d).find('#APITab a[href="#'+b+'"]').trigger("click")}}})})},api:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}head.js(LIB_PATH+"lib/prettify-min.js",function(){var b=new Base_Model_View({url:"/core/api/api-key",template:"admin-settings-api-model",postRenderCallback:function(c){prettyPrint()}});$("#content").html(getTemplate("admin-settings"),{});$("#content").find("#admin-prefs-tabs-content").html(b.el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".analytics-code-tab").addClass("active")})},milestones:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});this.pipelineGridView=new Base_Collection_View({url:"/core/api/milestone/pipelines",templateKey:"admin-settings-milestones",individual_tag_name:"div",sortKey:"name",postRenderCallback:function(b){setup_milestones(b);var c=App_Admin_Settings.pipelineGridView.collection.length;if(c==1){$("#content").find("#deal-tracks-accordion").find(".collapse").addClass("in")}}});this.pipelineGridView.collection.fetch();$("#content").find("#admin-prefs-tabs-content").html(this.pipelineGridView.render().el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".milestones-tab").addClass("active")},integrationsStats:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".stats-tab").addClass("active");$("#content").find("#admin-prefs-tabs-content").html(getRandomLoadingImg());head.js(LIB_PATH+"jscore/handlebars/handlebars-helpers.js",function(){var c={};var b={};$.ajax({url:"core/api/emails/email-stats",type:"GET",dataType:"json",success:function(d){c=d;$.ajax({url:"core/api/sms-gateway/SMSlogs",type:"GET",dataType:"json",success:function(g){b=g;var f={};f=$.extend(c,b);var e=new Base_Model_View({template:"admin-settings-integrations-stats",data:f});$("#content").find("#admin-prefs-tabs-content").html(e.render(true).el)}})}})})},integrations:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});this.integrations=new Base_Collection_View({url:"core/api/widgets/integrations",templateKey:"admin-settings-web-to-lead"});this.integrations.collection.fetch();$("#content").find("#admin-prefs-tabs-content").html(this.integrations.render().el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".integrations-tab").addClass("active")},tagManagement:function(){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});this.tagsview1=new Base_Collection_View({url:"core/api/tags/stats1",templateKey:"tag-management",individual_tag_name:"li",sort_collection:true,sortKey:"tag",postRenderCallback:function(b){}});this.tagsview1.appendItem=append_tag_management;console.log(this.tagsview1);this.tagsview1.collection.fetch();$("#content").find("#admin-prefs-tabs-content").html(this.tagsview1.render().el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".tag-management-tab").addClass("active")},emailGateways:function(c){console.log(App_Admin_Settings.integrations.collection);$("#content").html(getTemplate("admin-settings"),{});if(!this.integrations||this.integrations.collection==undefined){this.navigate("integrations",{trigger:true});return}var b="SEND_GRID";if(c=="mandrill"){b="MANDRILL"}this.email_gateway=new Base_Model_View({url:"core/api/email-gateway",template:"settings-email-gateway",postRenderCallback:function(d){head.js(LIB_PATH+"lib/agile.jquery.chained.min.js",function(){var f,e;f=$("#LHS",d);e=$("#RHS",d);e.chained(f);setTimeout(function(){$("#email-api",d).val(b).attr("selected","selected").trigger("change")},1)})},saveCallback:function(){Backbone.history.navigate("integrations",{trigger:true});data=App_Admin_Settings.email_gateway.model.toJSON();if(data.email_api=="MANDRILL"){$.getJSON("core/api/email-gateway/add-webhook?api_key="+data.api_key+"&type="+data.email_api,function(d){console.log(d)})}}});$("#content").find("#admin-prefs-tabs-content").html(this.email_gateway.render().el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".integrations-tab").addClass("active")},smsGateways:function(e){console.log("inside sms gateways");$("#content").html(getTemplate("admin-settings"),{});if(!this.integrations||this.integrations.collection==undefined){this.navigate("integrations",{trigger:true});return}var c,d;if(e=="plivo"){c="PLIVO";d="account_id"}if(e=="twilio"){c="TWILIO";d="account_sid"}var b;$.each(this.integrations.collection.models,function(f,g){var h=JSON.parse(g.attributes.prefs);if(h.sms_api){b=h.sms_api}});if(b!=undefined){if(b.toUpperCase()!=c){modalAlert("sms-integration-alert-modal","You have a SMS Gateway already configured. Please disable that to configure a new one.","SMS Gateway Configured");this.navigate("integrations",{trigger:true});return}}view=new Base_Model_View({model:App_Admin_Settings.integrations.collection.where({name:"SMS-Gateway"})[0],url:"core/api/sms-gateway",template:"settings-sms-gateway",prePersist:function(f){if(e=="plivo"){var g={account_id:f.attributes.account_id,auth_token:f.attributes.auth_token,endpoint:f.attributes.endpoint,sms_api:c}}if(e=="twilio"){var g={account_sid:f.attributes.account_sid,auth_token:f.attributes.auth_token,endpoint:f.attributes.endpoint,sms_api:c}}f.set({prefs:JSON.stringify(g)},{silent:true})},postRenderCallback:function(f){if(e=="plivo"){$("#integrations-image",f).attr("src","/img/plugins/plivo.png");$("#accoundID",f).attr("name","account_id");$("#accoundID",f).attr("placeholder","Auth ID");$("#integrations-label",f).text("You need a Paid Plivo account to be able to send SMS")
}if(e=="twilio"){$("#integrations-image",f).attr("src","/img/plugins/twilio.png");$("#accoundID",f).attr("name","account_sid");$("#accoundID",f).attr("placeholder","Account SID");$("#integrations-label",f).text("Please provide your account details")}},saveCallback:function(f){Backbone.history.navigate("integrations",{trigger:true})},errorCallback:function(f){if($("#sms-gateway-error").is(":visible")){$("#sms-gateway-error").remove()}$responceText="<div style='color:#B94A48; font-size:14px' id='sms-gateway-error'><i>"+f.responseText+"</i></div>";$("#sms-integration-error",this.el).append($responceText)}});$("#content").find("#admin-prefs-tabs-content").html(view.render().el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".integrations-tab").addClass("active")}});var CasesRouter=Backbone.Router.extend({routes:{cases:"listCases"},listCases:function(){this.casesCollectionView=new Base_Collection_View({url:"core/api/cases",sort_collection:false,restKey:"case",templateKey:"cases",cursor:true,page_size:25,individual_tag_name:"tr",postRenderCallback:function(b){includeTimeAgo(b)},appendItemCallback:function(b){includeTimeAgo(b)}});this.casesCollectionView.collection.fetch();$("#content").html(this.casesCollectionView.render().el);$(".active").removeClass("active");$("#casesmenu").addClass("active")}});var Streams_List_View;var Scheduled_Updates_View;var Past_Tweets=[];var Message_Model;var Pubnub=null;var SocialSuiteRouter=Backbone.Router.extend({routes:{social:"socialsuite",streams:"streams",scheduledmessages:"scheduledmessages"},socialsuite:function(){if(!tight_acl.checkPermission("SOCIAL")){return}if(!_plan_restrictions.is_social_suite[0]()){$(".active").removeClass("active");$("#socialsuitemenu").addClass("active");$("#content").html("<h4>"+_plan_restrictions.is_social_suite[1]().message+"</h4>");return}initializeSocialSuite();$(".active").removeClass("active");$("#socialsuitemenu").addClass("active");$("#content").html(getTemplate("socialsuite-show-streams"),{});initToPubNub();this.streams()},streams:function(c){var b=document.location.href;if(b.search("social")!=-1){$("#content").html(getTemplate("socialsuite-show-streams"),{})}checkScheduledUpdates();if(!Streams_List_View){console.log("Creating Collection First Time.");Streams_List_View=new Base_Collection_View({url:"/core/social",restKey:"stream",templateKey:"socialsuite-streams",individual_tag_name:"div",className:"app-content container clearfix",id:"stream_container",postRenderCallback:function(d){registerAll(0)}});Streams_List_View.appendItem=this.socialSuiteAppendItem;Streams_List_View.collection.fetch();$("#socialsuite-tabs-content").append(Streams_List_View.render().el);return}if(Streams_List_View){console.log("Collection already defined.");if(c){Streams_List_View.collection.add(c)}$("#socialsuite-tabs-content").append(Streams_List_View.render(true).el);displayTimeAgo($(".chirp-container"));showNotification(null)}$(".deleted").remove();removeWaiting()},socialSuiteAppendItem:function(c){console.log("base_model in append.");var b=new Base_List_View({model:c,view:"inline",template:this.options.templateKey+"-model",tagName:"li",className:"column ui-state-default span4 "+c.get("id"),id:c.get("id"),name:c.get("column_index")});var e=new Base_Collection_View({data:[],templateKey:"Column",individual_tag_name:"div"});e.collection.comparator=function(f){if(f.get("id")){return -f.get("id")}};if(c.has("tweetListView")){e.collection.add(c.get("tweetListView").toJSON());e.collection.sort()}c.set("tweetListView",e.collection);var d=b.render().el;$("#stream",d).html(e.render(true).el);$("#socialsuite-streams-model-list",this.el).append(d)},scheduledmessages:function(){Scheduled_Updates_View=new Base_Collection_View({url:"/core/scheduledupdate",restKey:"scheduledUpdate",templateKey:"socialsuite-scheduled-updates",individual_tag_name:"tr",postRenderCallback:function(b){displayTimeAgo($(".is-actionable"))}});Scheduled_Updates_View.collection.fetch();console.log(Scheduled_Updates_View.collection);$("#content").html(Scheduled_Updates_View.render(true).el);$(".active").removeClass("active")}});var socialsuitecall=new SocialSuiteRouter();var ReportsRouter=Backbone.Router.extend({routes:{reports:"reports","email-reports":"emailReportTypes","activity-reports":"activityReports","activity-report-add":"activityReportAdd","activity-report-edit/:id":"activityReportEdit","acivity-report-results/:id":"activityReportInstantResults","contact-reports":"emailReports","report-add":"reportAdd","report-edit/:id":"reportEdit","report-results/:id":"reportInstantResults","report-charts/:type":"reportCharts","report-funnel/:tags":"showFunnelReport","report-growth/:tags":"showGrowthReport","report-cohorts/:tag1/:tag2":"showCohortsReport","report-ratio/:tag1/:tag2":"showRatioReport"},reports:function(){if(!tight_acl.checkPermission("REPORT")){return}head.js(LIB_PATH+"jscore/handlebars/handlebars-helpers.js",function(){$("#content").html(getTemplate("report-categories",{}));$(".active").removeClass("active");$("#reportsmenu").addClass("active")})},emailReportTypes:function(){$("#content").html(getTemplate("email-report-categories",{}));$(".active").removeClass("active");$("#reportsmenu").addClass("active")},activityReports:function(){$("#content").html(getRandomLoadingImg());this.activityReports=new Base_Collection_View({url:"/core/api/activity-reports",restKey:"activityReports",templateKey:"activity-report",individual_tag_name:"tr"});this.activityReports.collection.fetch();$("#content").html(this.activityReports.render().el);$(".active").removeClass("active");$("#reportsmenu").addClass("active")},activityReportAdd:function(){if(!tight_acl.checkPermission("REPORT")){return}if(!tight_acl.checkPermission("ACTIVITY")){return}$("#content").html(getRandomLoadingImg());var b=0;var c=new Base_Model_View({url:"core/api/activity-reports",template:"activity-reports-add",window:"activity-reports",isNew:true,postRenderCallback:function(d){if(b!=0){return}fillSelect("users-list","/core/api/users","domainUser",function(){head.js(LIB_PATH+"lib/jquery.multi-select.js",CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){$("#activity-type-list, #users-list",d).multiSelect();$("#ms-activity-type-list .ms-selection",d).children("ul").addClass("multiSelect").attr("name","activity").attr("id","activity_type");$("#ms-users-list .ms-selection",d).children("ul").addClass("multiSelect").attr("name","user_ids").attr("id","user_ids");++b;if(b>0){$("#content").html(d)}$(".activity_time_timepicker").timepicker({timeFormat:"H:i ",step:30});$(".activity_time_timepicker").val("09:00");$("#report_timezone").val(ACCOUNT_PREFS.timezone)})},'<option value="{{id}}">{{name}}</option>',true,d)}});$("#content").html(getRandomLoadingImg());c.render()},activityReportEdit:function(e){if(!tight_acl.checkPermission("REPORT")){return}if(!tight_acl.checkPermission("ACTIVITY")){return}$("#content").html(getRandomLoadingImg());var c=0;if(!this.activityReports||!this.activityReports.collection||this.activityReports.collection.length==0||this.activityReports.collection.get(e)==null){this.navigate("activity-reports",{trigger:true});return}var d=this.activityReports.collection.get(e);var b=new Base_Model_View({url:"core/api/activity-reports",change:false,model:d,template:"activity-reports-add",window:"activity-reports",postRenderCallback:function(f){if(c!=0){return}fillSelect("users-list","/core/api/users","domainUser",function(){var g=d.toJSON();var j=g.activity_start_time;var h=g.frequency;deserializeForm(g,$("#activityReportsForm",f));head.js(LIB_PATH+"lib/jquery.multi-select.js",CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){$("#activity-type-list, #users-list",f).multiSelect();$("#ms-activity-type-list .ms-selection",f).children("ul").addClass("multiSelect").attr("name","activity").attr("id","activity_type");$("#ms-users-list .ms-selection",f).children("ul").addClass("multiSelect").attr("name","user_ids").attr("id","user_ids");$("#content").html(f);$.each(g.user_ids,function(l,k){$("#users-list").multiSelect("select",k);console.log("select user---",k)});$.each(g.activity,function(k,l){$("#activity-type-list").multiSelect("select",l);console.log("select activity-------",l)});$("#ms-activity-type-list .ms-selection").children("ul").addClass("multiSelect").attr("name","activity").attr("id","activity_type");$("#ms-users-list .ms-selection").children("ul").addClass("multiSelect").attr("name","user_ids").attr("id","user_ids");if(g.report_timezone==null){$("#report_timezone").val(ACCOUNT_PREFS.timezone)}if(h=="DAILY"){$("#activity_report_weekday").css("display","none");$("#activity_report_day").css("display","none");$("#activity_report_time").css("display","block")}else{if(h=="WEEKLY"){$("#activity_report_day").css("display","none");$("#activity_report_time").css("display","block");$("#activity_report_weekday").css("display","block")}else{if(h=="MONTHLY"){$("#activity_report_weekday").css("display","none");$("#activity_report_time").css("display","block");$("#activity_report_day").css("display","block")}}}$(".activity_time_timepicker").timepicker({timeFormat:"H:i ",step:30})})},'<option value="{{id}}">{{name}}</option>',true,f)}});$("#content").html(getRandomLoadingImg());b.render()},emailReports:function(){this.reports=new Base_Collection_View({url:"/core/api/reports",restKey:"reports",templateKey:"report",individual_tag_name:"tr"});this.reports.collection.fetch();$("#content").html(this.reports.render().el);$(".active").removeClass("active");$("#reportsmenu").addClass("active")},reportAdd:function(){var b=0;$("#content").html(getRandomLoadingImg());SEARCHABLE_CONTACT_CUSTOM_FIELDS=undefined;var c=new Base_Model_View({url:"core/api/reports",template:"reports-add",window:"contact-reports",isNew:true,postRenderCallback:function(d){if(b!=0){return}fillSelect("custom-fields-optgroup","core/api/custom-fields/scope?scope=CONTACT",undefined,function(){head.js(LIB_PATH+"lib/jquery.multi-select.js",CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){$("#multipleSelect",d).multiSelect({selectableOptgroup:true});
$(".ms-selection",d).children("ul").addClass("multiSelect").attr("name","fields_set").attr("id","fields_set").sortable();++b;if(b>1){$("#content").html(d)}$(".report_time_timepicker").timepicker({timeFormat:"H:i ",step:30});$(".report_time_timepicker").val("09:00");$("#report_timezone").val(ACCOUNT_PREFS.timezone)})},'<option value="custom_{{field_label}}">{{field_label}}</option>',true,d);head.js(LIB_PATH+"lib/jquery-ui.min.js",LIB_PATH+"lib/agile.jquery.chained.min.js",function(){scramble_input_names($(d).find("div#report-settings"));chainFilters(d,undefined,function(){++b;if(b>1){$("#content").html(d)}})})}});$("#content").html(getRandomLoadingImg());c.render()},reportEdit:function(e){$("#content").html(getRandomLoadingImg());var d=0;if(!this.reports||!this.reports.collection||this.reports.collection.length==0||this.reports.collection.get(e)==null){this.navigate("reports",{trigger:true});return}var b=this.reports.collection.get(e);var c=new Base_Model_View({url:"core/api/reports",change:false,model:b,template:"reports-add",window:"contact-reports",postRenderCallback:function(f){if(d!=0){return}fillSelect("custom-fields-optgroup","core/api/custom-fields/scope?scope=CONTACT",undefined,function(){head.js(LIB_PATH+"lib/jquery.multi-select.js",CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){console.log(f);console.log(b.toJSON());$("#multipleSelect",f).multiSelect({selectableOptgroup:true});++d;if(d>1){deserialize_multiselect(b.toJSON(),f)}setTimeout(function(){$(".report_time_timepicker").timepicker({timeFormat:"H:i ",step:30});var g=b.toJSON().duration;if(g=="DAILY"){$("#contact_report_weekday").css("display","none");$("#contact_report_day").css("display","none");$("#contact_report_time").css("display","block")}else{if(g=="WEEKLY"){$("#contact_report_day").css("display","none");$("#contact_report_time").css("display","block");$("#contact_report_weekday").css("display","block")}else{if(g=="MONTHLY"){$("#contact_report_weekday").css("display","none");$("#contact_report_time").css("display","block");$("#contact_report_day").css("display","block")}}}if(b.toJSON().report_timezone==null){$("#report_timezone").val(ACCOUNT_PREFS.timezone)}},1000)})},'<option value="custom_{{field_label}}">{{field_label}}</option>',true,f);head.js(LIB_PATH+"lib/jquery-ui.min.js",LIB_PATH+"lib/agile.jquery.chained.min.js",LIB_PATH+"lib/jquery.multi-select.js",function(){chainFilters(f,b.toJSON(),function(){++d;if(d>1){deserialize_multiselect(b.toJSON(),f)}});scramble_input_names($(f).find("div#report-settings"))})}});$("#content").html(getRandomLoadingImg());c.render()},reportInstantResults:function(f,b){if(!b){if(!this.reports||!this.reports.collection||this.reports.collection.length==0||this.reports.collection.get(f)==null){$("#content").html(getRandomLoadingImg());var e=new Backbone.Model();e.url="core/api/reports/"+f;e.fetch({success:function(g){App_Reports.reportInstantResults(f,g.toJSON())}});return}else{b=this.reports.collection.get(f).toJSON()}}REPORT=b;var d=new Base_Collection_View({url:"core/api/reports/show-results/"+f,modelData:b,templateKey:"report-search",individual_tag_name:"tr",cursor:true,sort_collection:false,page_size:15});var c=this;$.getJSON("core/api/custom-fields/type/scope?type=DATE&scope=CONTACT",function(g){d.appendItem=function(h){reportsContactTableView(h,g,this)};d.collection.fetch()});$("#content").html(d.render().el)},showFunnelReport:function(b){head.load(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){$("#content").html(getTemplate("report-funnel",{}));$("#reports-funnel-tags").text(b);initFunnelCharts(function(){showFunnelGraphs(b)})});$(".active").removeClass("active");$("#reportsmenu").addClass("active")},showGrowthReport:function(b){head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){$("#content").html(getTemplate("report-growth",{}));$("#reports-growth-tags").text(b);initFunnelCharts(function(){showGrowthGraphs(b)})});$(".active").removeClass("active");$("#reportsmenu").addClass("active")},showCohortsReport:function(c,b){head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){$("#content").html(getTemplate("report-cohorts",{}));$("#reports-cohorts-tags").text(c+" versus "+b);initFunnelCharts(function(){showCohortsGraphs(c,b)})});$(".active").removeClass("active");$("#reportsmenu").addClass("active")},showRatioReport:function(c,b){head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){$("#content").html(getTemplate("report-ratio",{}));$("#reports-ratio-tags").text(c+" versus "+b);initFunnelCharts(function(){showRatioGraphs(c,b)})});$(".active").removeClass("active");$("#reportsmenu").addClass("active")},reportCharts:function(c){var b="";if(c){b=$(getTemplate("report-"+c+"-form",{}))}else{b=$(getTemplate("report-growth",{}))}$("#content").html(b);if(c&&(c=="growth"||c=="funnel")){setup_tags_typeahead();return}$.each($("#tags-reports",b),function(e,d){console.log(d);addTagsDefaultTypeahead(d)})}});var AgileConfigRouter=Backbone.Router.extend({routes:{"onboarding/:link":"onBoarding"},onBoarding:function(b){if(!CURRENT_DOMAIN_USER.is_admin){$("#content").html(getTemplate("others-not-allowed",{}));return}$("#content").html(getTemplate("admin-settings"),{});head.js(LIB_PATH+"lib/prettify-min.js","../lib/zeroclipboard/ZeroClipboard.js",function(){var c=new Base_Model_View({url:"/core/api/api-key",template:"admin-settings-api-key-model",postRenderCallback:function(d){prettyPrint();console.log(b+"link is");if(b){$(d).find('#APITab a[href="#'+b+'"]').trigger("click")}initZeroClipboard("saas_api_track_code_icon","saas_api_track_code")}});$("#content").find("#admin-prefs-tabs-content").html(c.render().el);$("#content").find("#AdminPrefsTab .active").removeClass("active");$("#content").find(".analytics-code-tab").addClass("active")});$.getJSON("core/api/api-key",function(c){console.log(c);$("#content").html(getTemplate("onboarding-"+b,c))})}});var WidgetsRouter=Backbone.Router.extend({routes:{"add-widget":"addWidget",Linkedin:"Linkedin","Linkedin/:id":"Linkedin",Twitter:"Twitter","Twitter/:id":"Twitter",GooglePlus:"GooglePlus","GooglePlus/:id":"GooglePlus",Rapleaf:"Rapleaf","Rapleaf/:id":"Rapleaf",ClickDesk:"ClickDesk","ClickDesk/:id":"ClickDesk",HelpScout:"HelpScout","HelpScout/:id":"HelpScout",Zendesk:"Zendesk","Zendesk/:id":"Zendesk",Sip:"Sip","Sip/:id":"Sip",Twilio:"Twilio","Twilio/:id":"Twilio",TwilioIO:"TwilioIO","TwilioIO/:id":"TwilioIO",FreshBooks:"FreshBooks","FreshBooks/:id":"FreshBooks",Stripe:"Stripe","Stripe/:id":"Stripe","Custom-widget":"Custom","Custom-widget/:id":"Custom",Xero:"Xero","Xero/:id":"Xero",QuickBooks:"QuickBooks","QuickBooks/:id":"QuickBooks",Facebook:"Facebook","Facebook/:id":"Facebook",Shopify:"Shopify","Shopify/:id":"Shopify",Chargify:"Chargify","Chargify/:id":"Chargify","callscript/rules":"CallScriptShow","callscript/add-rules":"CallScriptAdd","callscript/editrules/:id":"CallScriptEdit",callscript:"CallScript","callscript/:id":"CallScript",sync:"contactSync","sync/contacts":"google_apps_contacts","sync/calendar":"google_apps_calendar","sync/stripe-import":"stripe_sync","sync/shopify":"shopify","sync/salesforce":"salesforce","sync/zoho-import":"zoho_sync","sync/quickbook":"quickbook_import","sync/xero":"xero_import","sync/freshbooks":"freshbooks_sync","sync/freshbooks/setting":"freshbooks_sync_setting"},addWidget:function(){$("#content").html(getTemplate("settings"),{});this.Catalog_Widgets_View=new Base_Collection_View({url:"/core/api/widgets/default",restKey:"widget",templateKey:"widgets-add",sort_collection:false,individual_tag_name:"div",postRenderCallback:function(b){build_custom_widget_form(b)}});this.Catalog_Widgets_View.appendItem=organize_widgets;this.Catalog_Widgets_View.collection.fetch({success:function(b){console.log(b.where({is_added:true}));_plan_restrictions.process_widgets(b)}});$("#prefs-tabs-content").html(this.Catalog_Widgets_View.el);$("#PrefsTab .active").removeClass("active");$(".add-widget-prefs-tab").addClass("active")},Linkedin:function(b){if(!b){show_set_up_widget("Linkedin","linkedin-login","/scribe?service=linkedin&return_url="+encodeURIComponent(window.location.href)+"/linkedin")}else{if(!isNaN(parseInt(b))){$.getJSON("core/api/widgets/social/profile/"+b,function(c){set_up_access("Linkedin","linkedin-login",c,"/scribe?service=linkedin&return_url="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#Linkedin/linkedin"))}).error(function(c){console.log(c);setUpError("Linkedin","widget-settings-error",c.responseText,window.location.protocol+"//"+window.location.host+"/#Linkedin/linkedin1")});return}$.getJSON("core/api/widgets/Linkedin",function(c){console.log(c);if(c){$.getJSON("core/api/widgets/social/profile/"+c.id,function(d){set_up_access("Linkedin","linkedin-login",d,"/scribe?service=linkedin&return_url="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#Linkedin/linkedin"),c)}).error(function(d){console.log(d);setUpError("Linkedin","widget-settings-error",d.responseText,window.location.protocol+"//"+window.location.host+"/#Linkedin/linkedin1",c)});return}else{show_set_up_widget("Linkedin","linkedin-login","/scribe?service=linkedin&return_url="+encodeURIComponent(window.location.href))}})}},Twitter:function(b){if(!b){show_set_up_widget("Twitter","twitter-login","/scribe?service=twitter&return_url="+encodeURIComponent(window.location.href)+"/twitter")}else{if(!isNaN(parseInt(b))){$.getJSON("core/api/widgets/social/profile/"+b,function(c){set_up_access("Twitter","twitter-login",c,"/scribe?service=twitter&return_url="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#Twitter/twitter"))}).error(function(c){console.log(c);setUpError("Twitter","widget-settings-error",c.responseText,window.location.protocol+"//"+window.location.host+"/#Twitter/twitter1")
});return}$.getJSON("core/api/widgets/Twitter",function(c){console.log(c);if(c){$.getJSON("core/api/widgets/social/profile/"+c.id,function(d){set_up_access("Twitter","twitter-login",d,"/scribe?service=twitter&return_url="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#Twitter/twitter"),c)}).error(function(d){setUpError("Twitter","widget-settings-error",d.responseText,window.location.protocol+"//"+window.location.host+"/#Twitter/twitter1",c)});return}else{show_set_up_widget("Twitter","twitter-login","/scribe?service=twitter&return_url="+encodeURIComponent(window.location.href))}})}},Rapleaf:function(b){if(!b){show_set_up_widget("Rapleaf","rapleaf-login")}else{fill_form(b,"Rapleaf","rapleaf-login")}},ClickDesk:function(b){if(!b){show_set_up_widget("ClickDesk","clickdesk-login")}else{fill_form(b,"ClickDesk","clickdesk-login")}},HelpScout:function(b){if(!b){show_set_up_widget("HelpScout","helpscout-login")}else{fill_form(b,"HelpScout","helpscout-login")}},Zendesk:function(b){if(!b){show_set_up_widget("Zendesk","zendesk-login")}else{fill_form(b,"Zendesk","zendesk-login")}},Sip:function(b){if(!b){show_set_up_widget("Sip","sip-login")}else{fill_form(b,"Sip","sip-login")}},TwilioIO:function(b){if(!b){show_set_up_widget("TwilioIO","twilioio-login")}else{fill_form(b,"TwilioIO","twilioio-login");fill_twilioio_numbers()}},Twilio:function(b){if(!b){show_set_up_widget("Twilio","twilio-login",encodeURIComponent(window.location.href)+"/twilio")}else{if(!isNaN(parseInt(b))){$.getJSON("/core/api/widgets/twilio/numbers/"+b,function(c){if(!c){return}set_up_access("Twilio","twilio-login",c,encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#Twilio/twilio"))}).error(function(d){var c=Math.floor((Math.random()*10)+1);setUpError("Twilio","widget-settings-error",d.responseText,window.location.protocol+"//"+window.location.host+"/#Twilio/twilio"+c)});return}$.getJSON("core/api/widgets/Twilio",function(c){console.log(c);if(c){console.log(c);$.getJSON("/core/api/widgets/twilio/numbers/"+c.id,function(d){if(!d){return}set_up_access("Twilio","twilio-login",d,encodeURIComponent(window.location.href),c)}).error(function(e){var d=Math.floor((Math.random()*10)+1);setUpError("Twilio","widget-settings-error",e.responseText,window.location.protocol+"//"+window.location.host+"/#Twilio/twilio"+d,e)});return}else{show_set_up_widget("Twilio","twilio-login",encodeURIComponent(window.location.href)+"/twilio")}})}},FreshBooks:function(b){if(!b){show_set_up_widget("FreshBooks","freshbooks-login")}else{fill_form(b,"FreshBooks","freshbooks-login")}},Stripe:function(b){if(!b){show_set_up_widget("Stripe","stripe-login","/scribe?service=stripe&return_url="+encodeURIComponent(window.location.href)+"/stripe")}else{$.getJSON("core/api/custom-fields/type/scope?scope=CONTACT&type=TEXT",function(c){set_up_access("Stripe","stripe-login",c,"/scribe?service=stripe&return_url="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#Stripe/stripe"))});return;$.getJSON("core/api/widgets/Stripe",function(c){console.log(c);if(c){$.getJSON("core/api/custom-fields/scope?scope=CONTACT&type=TEXT",function(d){set_up_access("stripe","stripe-login",d,"/scribe?service=stripe&return_url="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#Stripe/stripe"),c)});return}else{show_set_up_widget("Stripe","stripe-login","/scribe?service=stripe&return_url="+encodeURIComponent(window.location.href))}})}},Shopify:function(b){if(!b){show_set_up_widget("Shopify","shopify-login")}else{show_set_up_widget("Shopify","shopify-revoke-access")}},Xero:function(b){if(!b){show_set_up_widget("Xero","xero-login","http://integrations.clickdesk.com:8080/ClickdeskPlugins/agile-xero-oauth?callbackUrl="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/XeroServlet?data="))}else{$.getJSON("core/api/widgets/Xero",function(c){if(typeof c.prefs!="undefined"){c.prefsObj=JSON.parse(c.prefs)}set_up_access("Xero","xero-login",c,"http://integrations.clickdesk.com:8080/ClickdeskPlugins/agile-xero-oauth?callbackUrl="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/XeroServlet?data="))});return;$.getJSON("core/api/widgets/Xero",function(c){console.log(c);if(c){$.getJSON("core/api/widgets/Xero",function(d){set_up_access("Xero","xero-login",d,"http://integrations.clickdesk.com:8080/ClickdeskPlugins/agile-xero-oauth?callbackUrl="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/XeroServlet?data="),c)});return}else{show_set_up_widget("Xero","xero-login","http://integrations.clickdesk.com:8080/ClickdeskPlugins/agile-xero-oauth?callbackUrl="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/XeroServlet?data="))}})}},QuickBooks:function(b){if(!b){show_set_up_widget("QuickBooks","quickbooks-login","/OAuthServlet?service=quickbooks&return_url="+encodeURIComponent(window.location.href)+"/quickbooks")}else{$.getJSON("core/api/widgets/QuickBooks",function(c){console.log(c);if(c){$.getJSON("core/api/custom-fields",function(d){set_up_access("QuickBooks","quickbooks-login",d,"/OAuthServlet?service=quickbooks&return_url="+encodeURIComponent(window.location.href)+"/quickbooks",c)});return}else{show_set_up_widget("QuickBooks","quickbooks-login","/OAuthServlet?service=quickbooks&return_url="+encodeURIComponent(window.location.href)+"/quickbooks")}})}},Facebook:function(b){if(!b){show_set_up_widget("Facebook","facebook-login","/scribe?service=facebook&return_url="+encodeURIComponent(window.location.href)+"/facebook")}else{if(!isNaN(parseInt(b))){$.getJSON("/core/api/widgets/facebook/currentUserProfile/"+b,function(c){console.log("data is");console.log(c);set_up_access("Facebook","facebook-login",c,"/scribe?service=facebook&return_url="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#Facebook/facebook"))}).error(function(c){console.log(c);setUpError("Facebook","widget-settings-error",c.responseText,window.location.protocol+"//"+window.location.host+"/#Facebook/facebook1")});return}$.getJSON("core/api/widgets/Facebook",function(c){console.log(c);if(c){$.getJSON("core/api/widgets/facebook/currentUserProfile/"+c.id,function(d){set_up_access("Facebook","facebook-login",d,"/scribe?service=facebook&return_url="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#Facebook/facebook"),c)}).error(function(d){setUpError("Facebook","widget-settings-error",d.responseText,window.location.protocol+"//"+window.location.host+"/#Facebook/facebook1",c)});return}else{show_set_up_widget("Facebook","facebook-login","/scribe?service=facebook&return_url="+encodeURIComponent(window.location.href))}})}},Chargify:function(b){if(!b){show_set_up_widget("Chargify","chargify-login")}else{fill_form(b,"Chargify","chargify-login")}},Custom:function(c){if(c){console.log($(this));divClone=$(this).clone();var b=new Base_Model_View({url:"/core/api/widgets/custom",template:"add-custom-widget",isNew:true,postRenderCallback:function(d){console.log("In post render callback");console.log(d);$("#script_type").die().live("change",function(g){var f=$("#script_type").val();if(f=="script"){$("#script_div").show();$("#url_div").hide();return}if(f=="url"){$("#script_div").hide();$("#url_div").show()}})},saveCallback:function(d){console.log("In save callback");console.log(d);if(d==null){alert("A widget with this name exists already. Please choose a different name")}App_Widgets.Catalog_Widgets_View.collection.add(d);$("#custom-widget").replaceWith(divClone)}});$("#custom-widget",el).html(b.render(true).el);$("#cancel_custom_widget").die().live("click",function(d){$("#custom-widget").replaceWith(divClone)})}},contactSync:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");this.contact_sync_google=new Base_Model_View({url:"core/api/contactprefs/google",template:"admin-settings-import-google-contacts"});$("#prefs-tabs-content").html('<div class="row-fluid prefs-datasync"><h2 class="widget-head">Google <small>import Contacts from Google</small></h2><div class="span11 no-mg-l"><div id="contact-prefs" class="span4" style="margin-left:0px;"></div><div id="calendar-prefs" class="span4" style="margin-left:0px;"></div><div id="email-prefs" class="span4" style="margin-left:0px;"></div></div></div><div class="row-fluid prefs-datasync"><h2 class="widget-head">E-commerce <small>import Contacts from E-commerce</small></h2><div class="span11 no-mg-l"><div id ="shopify"></div></div></div><div class="row-fluid prefs-datasync"><h2 class="widget-head">Payment <small>import Contacts from payment gateway</small></h2><div class="span11 no-mg-l"><div id ="stripe"></div></div></div><div class="row-fluid prefs-datasync"><h2 class="widget-head">Accounting <small>import Contacts from Accounting</small></h2><div class="span11 no-mg-l"><div class="span4" id ="freshbook"></div><div class="span4" id ="quickbook"></div></div>');$("#contact-prefs").append(this.contact_sync_google.render().el);this.calendar_sync_google=new Base_Model_View({url:"core/api/calendar-prefs/get",template:"import-google-calendar"});$("#calendar-prefs").append(this.calendar_sync_google.render().el);this.shopify_sync=new Base_Model_View({url:"core/api/shopify/import-settings",template:"admin-settings-import-shopify-contact-syncPrefs"});$("#shopify").append(this.shopify_sync.render().el);this.freshbooks_sync=new Base_Model_View({url:"core/api/freshbooks/import-settings",template:"admin-settings-import-freshbooks-contacts-syncPrefs"});$("#freshbook").append(this.freshbooks_sync.render().el);this.zoho_sync=new Base_Model_View({url:"core/api/zoho/import-settings",template:"admin-settings-import-zoho-contact-sync"});$("#zoho").append(this.zoho_sync.render().el);this.quickbook_sync=new Base_Model_View({url:"core/quickbook/import-settings",template:"admin-settings-import-quickbook"});$("#quickbook").append(this.quickbook_sync.render().el);this.xero_sync=new Base_Model_View({url:"core/xero/import-settings",template:"admin-settings-import-xeroSync"});
$("#xero").append(this.xero_sync.render().el);this.stripe_sync=new Base_Model_View({url:"core/api/stripe/import-settings",template:"admin-settings-import-stripe-contact-sync"});$("#stripe").append(this.stripe_sync.render().el);var c={service:"Gmail",return_url:encodeURIComponent(window.location.href)};var b=new Base_Model_View({url:"/core/api/social-prefs/GMAIL",template:"settings-social-prefs",data:c});b.model.fetch();$("#email-prefs").html(b.render().el)},google_apps_contacts:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");var c={url:"core/api/contactprefs/GOOGLE",template:"admin-settings-import-google-contacts-setup",postRenderCallback:function(d){console.log(d)}};var b=true;if(this.contact_sync_google&&this.contact_sync_google.model){c.model=this.contact_sync_google.model;b=false}else{this.contact_sync_google=new Base_Model_View({url:"core/api/contactprefs/google",template:"import-google-contacts"})}this.setup_google_contacts=new Base_Model_View(c);if(b){$("#prefs-tabs-content").html(this.setup_google_contacts.render().el);return}$("#prefs-tabs-content").html(this.setup_google_contacts.render(true).el)},google_apps_calendar:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");var c={url:"core/api/calendar-prefs/get",template:"import-google-calendar-setup"};var b=true;if(this.calendar_sync_google&&this.calendar_sync_google.model){c.model=this.calendar_sync_google.model;b=false}this.setup_google_calendar=new Base_Model_View(c);if(b){$("#prefs-tabs-content").html(this.setup_google_calendar.render().el);return}$("#prefs-tabs-content").html(this.setup_google_calendar.render(true).el)},stripe_sync:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");this.stripe_sync_setting=new Base_Model_View({url:"core/api/stripe/import-settings",template:"admin-settings-import-stripe-contact-sync-prefs",saveCallback:function(b){showNotyPopUp("information","Contacts sync initiated","top",1000)}});$("#prefs-tabs-content").html(this.stripe_sync_setting.render().el)},shopify:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");this.shopify_sync_setting=new Base_Model_View({url:"core/api/shopify/import-settings",template:"admin-settings-import-shopify-prefs",saveCallback:function(b){showNotyPopUp("information","Contacts sync initiated","top",1000)}});$("#prefs-tabs-content").html(this.shopify_sync_setting.render().el)},freshbooks_sync:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");this.freshbooks_sync_setting=new Base_Model_View({url:"core/api/freshbooks/import-settings",template:"admin-settings-import-freshbooks-contacts-form",saveCallback:function(b){showNotyPopUp("information","Contacts sync initiated","top",1000)}});$("#prefs-tabs-content").html(this.freshbooks_sync_setting.render().el)},freshbooks_sync_setting:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");this.freshbooks_import_settings=new Base_Model_View({url:"core/api/freshbooks/import-settings",template:"admin-settings-import-freshbooks-settings",saveCallback:function(b){showNotyPopUp("information","Contacts sync initiated","top",1000)}});$("#prefs-tabs-content").html(this.freshbooks_import_settings.render().el)},zoho_sync:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");this.zoho_sync_settings=new Base_Model_View({url:"core/api/zoho/import-settings",template:"admin-settings-import-zoho-prefs",saveCallback:function(b){showNotyPopUp("information","Contacts sync initiated","top",1000)}});$("#prefs-tabs-content").html(this.zoho_sync_settings.render().el)},quickbook_import:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");this.quickbook_import_settings=new Base_Model_View({url:"core/quickbook/import-settings",template:"admin-settings-import-quickbook-settings",saveCallback:function(b){showNotyPopUp("information","Contacts sync initiated","top",1000)}});$("#prefs-tabs-content").html(this.quickbook_import_settings.render().el)},xero_import:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".contact-sync-tab").addClass("active");this.xero_import_settings=new Base_Model_View({url:"core/xero/import-settings",template:"admin-settings-import-xero-settings",saveCallback:function(b){showNotyPopUp("information","Contacts sync initiated","top",1000)}});$("#prefs-tabs-content").html(this.xero_import_settings.render().el)},GooglePlus:function(d){if(!d){show_set_up_widget("GooglePlus","googleplus-login","/scribe?service=googleplus&return_url="+encodeURIComponent(window.location.href)+"/googleplus")}else{var c=$.parseJSON($.ajax({url:"core/api/widgets/GooglePlus",async:false,dataType:"json"}).responseText);console.clear();console.log("In google Plus widget Router");console.log(c);if(c){widgetPrefGP=JSON.parse(c.prefs);var b=$.parseJSON($.ajax({url:"https://www.googleapis.com/plus/v1/people/me?access_token="+widgetPrefGP.access_token,async:false,dataType:"json"}).responseText);set_up_access("GooglePlus","googleplus-login",b,"/scribe?service=googleplus&return_url="+encodeURIComponent(window.location.protocol+"//"+window.location.host+"/#GooglePlus/googleplus"))}else{show_set_up_widget("GooglePlus","googleplus-login","/scribe?service=googleplus&return_url="+encodeURIComponent(window.location.href)+"/googleplus");return}}},CallScript:function(b){if(!b){show_set_up_widget("CallScript","callscript-login")}else{fill_form(b,"CallScript","callscript-login")}adjust_form()},CallScriptShow:function(){showCallScriptRule()},CallScriptAdd:function(){addCallScriptRule()},CallScriptEdit:function(b){editCallScriptRule(b)}});var ContactSearchRouter=Backbone.Router.extend({routes:{"contacts/search/:query":"searchResults"},searchResults:function(c){var b=new Base_Collection_View({url:"core/api/search?q="+encodeURIComponent(c),templateKey:"search",individual_tag_name:"tr",cursor:true,data:QUERY_RESULTS,sort_collection:false,page_size:15,postRenderCallback:function(d){if(b.collection.length==0){$("#search-query-heading",d).html('No matches found for "'+c+'"')}else{$("#search-query-heading",d).html('Search results for "'+c+'"')}}});b.collection.fetch();$("#content").html(b.render().el)}});var taskDetailView;var TaskDetailsRouter=Backbone.Router.extend({routes:{"task/:id":"taskDetailView"},taskDetailView:function(d){if(d){if(App_Calendar.allTasksListView){var b=App_Calendar.allTasksListView.collection.get(d);taskDetailView=b;$("#content").html(getTemplate("task-detail",b.toJSON()));task_details_tab.loadActivitiesView()}else{if(App_Calendar.tasksListView){var b=App_Calendar.tasksListView.collection.get(d);if(b){taskDetailView=b;$("#content").html(getTemplate("task-detail",b.toJSON()));task_details_tab.loadActivitiesView()}else{var c=Backbone.Model.extend({});$.ajax({url:"core/api/tasks/getTaskObject/"+d,success:function(e){taskDetailView=new c(e);$("#content").html(getTemplate("task-detail",taskDetailView.toJSON()));task_details_tab.loadActivitiesView()}})}}else{var c=Backbone.Model.extend({});$.ajax({url:"core/api/tasks/getTaskObject/"+d,success:function(e){taskDetailView=new c(e);$("#content").html(getTemplate("task-detail",taskDetailView.toJSON()));task_details_tab.loadActivitiesView()}})}}}}});$(function(){var b;$('#taskDetailsTab a[href="#timeline"]').live("click",function(c){c.preventDefault();save_task_tab_position_in_cookie("timeline");task_details_tab.load_timeline()});$('#taskDetailsTab a[href="#notes"]').live("click",function(c){c.preventDefault();save_task_tab_position_in_cookie("notes");task_details_tab.load_notes()});$('#taskDetailsTab a[href="#contacts"]').live("click",function(c){c.preventDefault();save_task_tab_position_in_cookie("contacts");task_details_tab.loadTaskRelatedContactsView()});$('#taskDetailsTab a[href="#activity"]').live("click",function(c){c.preventDefault();save_task_tab_position_in_cookie("activity");task_details_tab.loadActivitiesView()});$(".activity-delete").die().live("click",function(k){k.preventDefault();var f=$(this).parents("li").data();if(f&&f.collection){f.collection.remove(f)}var c=$(this).attr("id");var j=$(this).attr("url");if(!j){return}var g=[];var d={};g.push(c);d.ids=JSON.stringify(g);var h=this;if($(this).find(".loading").length==0){$(this).prepend($(LOADING_HTML).addClass("pull-left").css("width","20px"))}$.ajax({url:j,type:"POST",data:d,success:function(){$(h).parents(".activity").fadeOut(400,function(){$(this).remove()});removeItemFromTimeline($("#"+c,$("#timeline")))}})});$(".task-owner-list").live("click",function(){$("#change-task-owner-ul").css("display","none");var c=$(this).attr("data");var e=$(this).text();var f=$("#task-owner").attr("data");if(c==f){show_task_owner();return}var d=new BaseModel();d.url="/core/api/tasks/change-owner/"+c+"/"+taskDetailView.get("id");d.save(taskDetailView.toJSON(),{success:function(g){$("#task-owner").text(e);$("#task-owner").attr("data",c);show_task_owner();taskDetailView=g;task_details_tab.loadActivitiesView()}})});$("#change-owner-element > .task-owner-add").live("click",function(c){c.preventDefault();fill_task_owners(undefined,undefined,function(){$(".task-owner-add").css("display","none");$("#change-task-owner-ul").css("display","inline-block");$("#change-task-owner-ul").addClass("open");if($("#change-owner-element > #change-task-owner-ul").css("display")=="inline-block"){$("#change-owner-element").find(".loading").remove()
}})});$("#task-owner").live("click",function(c){c.preventDefault();fill_task_owners(undefined,undefined,function(){$("#task-owner").css("display","none");$("#change-task-owner-ul").css("display","inline-block");if($("#change-task-owner-ul").css("display")=="inline-block"){$("#change-owner-element").find(".loading").remove()}})});$(".task-note-edit").die().live("click",function(d){d.preventDefault();var c=notesView.collection.get($(this).attr("data"));console.log(c);deserializeForm(c.toJSON(),$("#tasknoteUpdateForm",$("#tasknoteupdatemodal")));fill_relation_task($("#tasknoteUpdateForm"));$("#tasknoteupdatemodal").modal("show")});$("#task_note_update").live("click",function(d){d.preventDefault();if($(this).attr("disabled")){return}disable_save_button($(this));if(!isValidForm("#tasknoteUpdateForm")){enable_save_button($(this));return}var c=serializeForm("tasknoteUpdateForm");saveTaskNote($("#tasknoteUpdateForm"),$("#tasknoteupdatemodal"),this,c)});$(".delete_task").live("click",function(c){var d=$(".delete_task").attr("data");c.preventDefault();if(!confirm("Are you sure you want to delete?")){return false}$.ajax({url:"core/api/tasks/"+d,type:"DELETE",success:function(e){document.location.href=document.location.origin+"#/tasks"}})})});function activate_timeline_tab(){$("#contactDetailsTab").find("li.active").removeClass("active");$("#contactDetailsTab li:first-child").addClass("active");$("div.tab-content").find("div.active").removeClass("active");$("div.tab-content > div:first-child").addClass("active");if(App_Contacts.contactDetailView.model.get("type")=="COMPANY"){fill_company_related_contacts(App_Contacts.contactDetailView.model.id,"company-contacts")}}function save_task_tab_position_in_cookie(c){var b=readCookie(contact_tab_position_cookie_name);if(b==c){return}createCookie(contact_tab_position_cookie_name,c)}$(function(){$("#task_edit").die().live("click",function(c){c.preventDefault();var d=$(this).attr("data");var b;if(App_Calendar.allTasksListView){b=App_Calendar.allTasksListView.collection.get(d)}else{if(App_Calendar.tasksListView){b=App_Calendar.tasksListView.collection.get(d);if(!b){b=taskDetailView}}else{b=taskDetailView}}if(b){update_task(b.toJSON())}});$(".task-add-contact").die().live("click",function(b){b.preventDefault();update_task(taskDetailView.toJSON())})});function update_task(b){deserializeForm(b,$("#updateTaskForm"));$("#updateTaskModal").modal("show");populateUsers("owners-list",$("#updateTaskForm"),b,"taskOwner",function(c){$("#updateTaskForm").find("#owners-list").html(c);if(b.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+b.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()});showNoteOnForm("updateTaskForm",b.notes)}function fill_task_owners(c,d,e){var b="<li><a class='task-owner-list' data='{{id}}'>{{name}}</a></li>";fillSelect("task-detail-owner","/core/api/users","domainUsers",e,b,true)}function show_task_owner(){$("#task-owner").css("display","inline-block")}function fill_relation_task(c){var b=taskDetailView.toJSON();var d=b.name;$(".tags",c).html('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+b.id+'">'+d+"</li>")}$("#tasknote_validate").live("click",function(c){c.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm("#tasknoteForm")){return}disable_save_button($(this));var b=serializeForm("tasknoteForm");console.log(b);saveTaskNote($("#tasknoteForm"),$("#new-task-modal"),this,b)});function saveTaskNote(e,b,c,d){var f=new Backbone.Model();f.url="core/api/notes";f.save(d,{success:function(k){enable_save_button($(c));e.each(function(){this.reset()});b.modal("hide");var h=k.toJSON();console.log(h);if(!notesView){notesView=new Base_Collection_View(k)}if(notesView&&notesView.collection){if(notesView.collection.get(h.id)){notesView.collection.get(h.id).set(new BaseModel(h))}else{var l=taskDetailView.toJSON();var j=[];$.each(l.contacts,function(o,n){j.push(n.id)});var g=[];$.each(l.notes,function(o,p){g.push(p.id)});g.push(h.id);l.contacts=j;l.notes=g;if(l.taskOwner){l.owner_id=l.taskOwner.id}var m=new Backbone.Model();m.url="core/api/tasks";m.save(l,{success:function(n){notesView.collection.add(new BaseModel(h),{sort:false});notesView.collection.sort()}})}}}})}var DEAL_TRACKS_COUNT;var DealDetailsRouter=Backbone.Router.extend({routes:{"deal/:id":"dealdetails","dealEdit/:id":"dealEdit"},dealdetails:function(c){if(App_Deals.customFieldsList==null||App_Deals.customFieldsList==undefined){App_Deals.customFieldsList=new Base_Collection_View({url:"/core/api/custom-fields/scope/position?scope=DEAL",sort_collection:false,restKey:"customFieldDefs",templateKey:"admin-settings-customfields",individual_tag_name:"tr"});App_Deals.customFieldsList.collection.fetch()}this.dealDetailView=new Base_Model_View({url:"/core/api/opportunity/"+c,template:"deal-detail",postRenderCallback:function(e){if(!DEAL_TRACKS_COUNT){DEAL_TRACKS_COUNT=getTracksCount()}load_deal_tab(e,"");var d;if(App_Deals.opportunityCollectionView&&App_Deals.opportunityCollectionView.collection){d=App_Deals.opportunityCollectionView.collection}if(d!=null&&readCookie("agile_deal_view")){deal_detail_view_navigation(c,d,e)}}});var b=this.dealDetailView.render(true).el;$("#content").html(getRandomLoadingImg());$("#content").html(b)},dealEdit:function(e,c){if(!c){console.log("Downloading deal");var d=Backbone.Model.extend({url:function(){return"/core/api/opportunity/"+this.id}});var b=new d();b.id=e;b.fetch({success:function(f){App_Deal_Details.dealEdit(e,f)},error:function(g,f){if(f&&f.status=="403"){$("#content").html(f.responseText)}}});return}add_custom_fields_to_form(c,function(f){deserialize_deal(f,"deal-detail-edit")},"DEAL")}});$("#opportunity_validate_form").live("click",function(f){f.preventDefault();var d=$(this).closest(".container").attr("id");var b=$(this).closest(".container").find("form").attr("id");var c=serializeForm(b);c.custom_data=serialize_custom_fields(b);console.log(c);if(b=="opportunityForm1"){saveDeal(b,d,this,c,false)}else{saveDeal(b,d,this,c,false)}});$("#deal-owner").live("click",function(b){b.preventDefault();fill_deal_owners(undefined,undefined,function(){$("#deal-owner").css("display","none");$("#change-deal-owner-ul").css("display","inline-block");if($("#change-deal-owner-ul").css("display")=="inline-block"){$("#change-owner-element").find(".loading").remove()}})});$("#opportunity-actions-delete").live("click",function(b){b.preventDefault();if(!confirm("Are you sure you want to delete?")){return}var c=$(this).closest(".deal_detail_delete").attr("data");$.ajax({url:"core/api/opportunity/"+c,type:"DELETE",success:function(d){Backbone.history.navigate("#deals",{trigger:true})},error:function(d){alert("some exception occured please try again")}})});function fill_deal_owners(c,d,e){var b="<li><a class='deal-owner-list' data='{{id}}'>{{name}}</a></li>";fillSelect("deal-detail-owner","/core/api/users","domainUsers",e,b,true)}function show_deal_owner(){$("#deal-owner").css("display","inline-block")}function deal_detail_view_navigation(h,c,d){console.log("collection >>>>>>>>>>>>>>>>");console.log(c);var e=c.length;var g=c.indexOf(c.get(h));var b;var f;if(e>1&&g<e&&c.at(g+1)&&c.at(g+1).has("id")){f=c.at(g+1).id}if(e>0&&g!=0&&c.at(g-1)&&c.at(g-1).has("id")){b=c.at(g-1).id}if(b!=null){$(".navigation",d).append('<a style="float:left;" href="#deal/'+b+'" class=""><i class="icon icon-chevron-left"></i></a>')}if(f!=null){$(".navigation",d).append('<a style="float:right;" href="#deal/'+f+'" class=""><i class="icon icon-chevron-right"></i></a>')}}$(".deal-owner-list").live("click",function(){$("#change-deal-owner-ul").css("display","none");var b=$(this).attr("data");var c=$(this).text();var e=$("#deal-owner").attr("data");if(b==e){show_deal_owner();return}var d=new BaseModel();d.url="/core/api/opportunity/change-owner/"+b+"/"+App_Deal_Details.dealDetailView.model.get("id");d.save(App_Deal_Details.dealDetailView.model.toJSON(),{success:function(f){$("#deal-owner").text(c);$("#deal-owner").attr("data",b);show_deal_owner();App_Deal_Details.dealDetailView.model=f;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+f.toJSON().id,{trigger:true})}})});$(".deal-add-contact").live("click",function(b){b.preventDefault();console.log(App_Deal_Details.dealDetailView.model.toJSON());var c=App_Deal_Details.dealDetailView.model;updateDeal(c);setTimeout(function(){$("#opportunityUpdateForm").find("input[name='relates_to']").focus()},800)});$(".deal-detail-edit-deal").live("click",function(b){b.preventDefault();console.log(App_Deal_Details.dealDetailView.model.toJSON());var c=App_Deal_Details.dealDetailView.model;updateDeal(c)});$(".deal-note").live("click",function(c){c.preventDefault();var b=$("#dealnoteForm");fill_relation_deal(b);$("#deal-note-modal").modal("show")});function fill_relation_deal(c){var b=App_Deal_Details.dealDetailView.model.toJSON();var d=b.name;$(".tags",c).html('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+b.id+'">'+d+"</li>")}function deserialize_deal(d,c){d=d.toJSON();var b=$("#content").html(getTemplate(c,d));deserializeForm(d,b);agile_type_ahead("relates_to",b,contacts_typeahead);populateUsers("owners-list",b,d,"owner",function(e){b.find("#owners-list").html(e);if(d.owner){$("#owners-list",b).find("option[value="+d.owner.id+"]").attr("selected","selected");$("#owners-list",b).closest("div").find(".loading-img").hide()}});populateTracks(b,undefined,d,function(e){populateMilestones(b,undefined,d.pipeline_id,d,function(f){b.find("#milestone").html(f);if(d.milestone){$("#milestone",b).find('option[value="'+d.milestone+'"]').attr("selected","selected")}$("#milestone",b).closest("div").find(".loading-img").hide()})});$("#close_date",b).datepicker({format:"mm/dd/yyyy"});add_custom_fields_to_form(d,function(f){var e=show_custom_fields_helper(f.custom_fields,[]);$("#custom-field-deals",b).html(fill_custom_fields_values_generic($(e),d.custom_data));
$(".date_input",b).datepicker({format:"mm/dd/yyyy"})},"DEAL")}$("#dealdetail-archive").live("click",function(c){c.preventDefault();var b=App_Deal_Details.dealDetailView.model.toJSON();$("#archived-deal-id",$("#deal_archive_confirm_modal")).val(b.id);$("#archived-deal-milestone",$("#deal_archive_confirm_modal")).val(b.milestone);$("#deal_archive_confirm_modal").modal("show")});$(".deal-restore-detail-view").live("click",function(c){c.preventDefault();var b=App_Deal_Details.dealDetailView.model.toJSON();$("#restored-deal-id",$("#deal_restore_confirm_modal")).val(b.id);$("#restored-deal-milestone",$("#deal_restore_confirm_modal")).val(b.milestone);$("#deal_restore_confirm_modal").modal("show")});function getTracksCount(){var b=$.ajax({type:"GET",url:"core/api/milestone/tracks/count",async:false,dataType:"json"}).responseText;if(!isNaN(b)){return b}return 0}var VisitorsRouter=Backbone.Router.extend({routes:{visitors:"loadGmap"},initialize:function(){},loadGmap:function(){head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){var b=new Base_Model_View({model:new BaseModel(),template:"gmap-html-page",isNew:true,postRenderCallback:function(c){try{if(google.maps){gmap_initialize(c)}}catch(d){gmap_load_script(c)}}});$("#content").html(b.render().el)})}});CONTACTS_HARD_RELOAD=true;var ContactsRouter=Backbone.Router.extend({routes:{"":"dashboard",dashboard:"dashboard",contacts:"contacts","contact/:id":"contactDetails","import":"importContacts","contact-edit":"editContact","contact-duplicate":"duplicateContact","duplicate-contacts/:id":"duplicateContacts","merge-contacts":"mergeContacts","tags/:tag":"contacts","send-email":"sendEmail","send-email/:id":"sendEmail","add-campaign":"addContactToCampaign",gmail:"email",twitter:"socialPrefs",linkedin:"socialPrefs","contacts/call-lead/:first/:last":"addLead","contacts/call-lead/:first/:last/:mob":"addLeadDirectly"},initialize:function(){},dashboard:function(){$(".active").removeClass("active");head.js(LIB_PATH+"jscore/handlebars/handlebars-helpers.js",LIB_PATH+"lib/jquery.gridster.js",function(){var b=$(getTemplate("portlets",{}));$("#content").html(b);if(IS_FLUID){$("#content").find("div.row").removeClass("row").addClass("row-fluid")}loadPortlets(b)})},contacts:function(b,l,e,n){if(SCROLL_POSITION){$("html, body").animate({scrollTop:SCROLL_POSITION},1000);SCROLL_POSITION=0}else{$(window).scrollTop(0)}SELECT_ALL=false;if(readData("dynamic_contact_filter")&&readData("dynamic_contact_filter").indexOf("campaign_status")>=0){eraseData("dynamic_contact_filter")}var o=20;var h=false;var k="contacts";var m="tr";var g=readCookie("sort_by_name");if(!g||g==null){g="-created_time";createCookie("sort_by_name",g)}if(e||readCookie("agile_contact_view")){k="contacts-grid";m="div"}var c="/core/api/contacts/list";var j=false;this.tag_id=b;var d;if(readCookie("company_filter")){eraseCookie("contact_filter");eraseCookie("contact_filter_type");h=true}if(readCookie("contact_filter_type")&&readCookie("contact_filter_type")=="COMPANY"){h=true}if(b){b=decodeURI(b);b=decodeURI(b);eraseCookie("contact_filter");eraseCookie("company_filter");eraseCookie("contact_filter_type");eraseData("dynamic_contact_filter");if(this.contactsListView&&this.contactsListView.collection){if(this.contactsListView.collection.url.indexOf("core/api/tags/list/"+b)==-1){this.contactsListView=undefined}}this.customView(readCookie("contact_view"),undefined,"core/api/tags/list/"+b,b);return}else{if(this.contactsListView&&this.contactsListView.collection){if(this.contactsListView.collection.url.indexOf("core/api/tags/list")!=-1){console.log(window.location.hash="#contacts");this.contactsListView=undefined}}}if(readCookie("company_filter")){c="core/api/contacts/companies/list";if(!e&&!readCookie("agile_contact_view")){k="companies"}}if(l||(l=readCookie("contact_filter"))){j=false;c="core/api/filters/query/list/"+l;if(readCookie("contact_filter_type")&&readCookie("contact_filter_type")=="COMPANY"){k="companies"}}if((!readCookie("company_filter")&&readCookie("contact_filter_type")!="COMPANY")&&!readCookie("agile_contact_view")){if(readData("dynamic_contact_filter")){this.customView(readCookie("contact_view"),undefined,"core/api/filters/filter/dynamic-filter",undefined,n,readData("dynamic_contact_filter"));return}if(readCookie("contact_filter")){this.customView(readCookie("contact_view"),undefined,"core/api/filters/query/list/"+readCookie("contact_filter"),b);return}this.customView(readCookie("contact_view"),undefined,undefined,undefined,n);return}console.log("while creating new base collection view : "+j);if(CONTACTS_HARD_RELOAD==true){this.contactsListView=undefined;CONTACTS_HARD_RELOAD=false}if(this.contactsListView&&this.contactsListView.collection){this.contactsListView.collection.url=c;$("#content").html(this.contactsListView.render(true).el);$(".active").removeClass("active");$("#contactsmenu").addClass("active");return}if(readData("dynamic_contact_filter")&&!readCookie("company_filter")){c="core/api/filters/filter/dynamic-filter";d=readData("dynamic_contact_filter")}else{if(readData("dynamic_company_filter")&&readCookie("company_filter")){c="core/api/filters/filter/dynamic-filter";d=readData("dynamic_company_filter")}}var f=getContactPadcontentKey(c);if(n){k="contacts-table";if(e||readCookie("agile_contact_view")){k="contacts-grid-table";m="div"}if(readCookie("company_filter")){k="companies-table"}}this.contactsListView=new Base_Collection_View({url:c,sort_collection:false,templateKey:k,individual_tag_name:m,cursor:true,page_size:25,global_sort_key:g,slateKey:f,request_method:"POST",post_data:{filterJson:d},postRenderCallback:function(q,u){var p=App_Contacts.contactsListView.el;var u=App_Contacts.contactsListView.collection;if(n){var s=0;if(u.models.length>0){s=u.models[0].attributes.count||u.models.length}var t;if(s>9999&&(readCookie("contact_filter")||readData("dynamic_contact_filter"))){t="<small> ("+10000+'+ Total) </small><span style="vertical-align: text-top; margin-left: -5px"><img border="0" src="/img/help.png"style="height: 10px; vertical-align: middle" rel="popover"data-placement="bottom" data-title="Lead Score"data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."id="element" data-trigger="hover"></span>'}else{t="<small> ("+s+" Total) </small>"}$("#contacts-count").html(t);setupViews();setupContactFilterList()}else{setupLhsFilters(p,h);setupViews(p);setupContactFilterList(p,b)}start_tour("contacts",q)}});this.contactsListView.collection.fetch();if(!n){$("#content").html(this.contactsListView.render().el)}else{$("#content").find(".span9").html(this.contactsListView.render().el);$("#bulk-actions").css("display","none");CONTACTS_HARD_RELOAD=true}$(".active").removeClass("active");$("#contactsmenu").addClass("active")},duplicateContacts:function(d){dup_contacts1_array.length=0;var e=20;var b="tr";this.contact_id=d;var c="/core/api/search/duplicate-contacts/"+d;var f=false;template_key="duplicate-contacts";if(App_Contacts.contactDetailView===undefined){Backbone.history.navigate("contact/"+d,{trigger:true});return}this.duplicateContactsListView=new Base_Collection_View({url:c,templateKey:template_key,individual_tag_name:"tr",cursor:true,page_size:25,sort_collection:f,slateKey:null,postRenderCallback:function(g){}});this.duplicateContactsListView.collection.fetch();$("#content").html(this.duplicateContactsListView.render().el);$(".active").removeClass("active");$("#contactsmenu").addClass("active")},mergeContacts:function(){var b=dup_contacts1_array[0];var k=20;var h="table";var f=false;template_key="merge-contacts";if(App_Contacts.duplicateContactsListView==undefined||dup_contacts1_array.length<1){Backbone.history.navigate("contacts",{trigger:true});return}var l=[];for(var e=0;e<dup_contacts1_array.length;e++){var g=Number(dup_contacts1_array[e]);var d=App_Contacts.duplicateContactsListView.collection.where({id:g});var j=l.concat(d);l=j}var o={};var n=App_Contacts.contactDetailView.model.toJSON();console.log(n);var m=[];var c=0;m[0]=n;for(e=0;e<l.length;e++){m[e+1]=l[e].toJSON();c++}o.contacts=m;o.length=c;add_custom_fields_to_form(o,function(p){this.mergeContactsView=new Base_Model_View({template:template_key,data:o,postRenderCallback:function(q){}});$("#content").html(this.mergeContactsView.render(true).el);$(window).scrollTop(0);$(".active").removeClass("active");$("#contactsmenu").addClass("active")},n.type)},contactDetails:function(g,b){if(App_Contacts.customFieldsList==null||App_Contacts.customFieldsList==undefined){App_Contacts.customFieldsList=new Base_Collection_View({url:"/core/api/custom-fields/position",sort_collection:false,restKey:"customFieldDefs",templateKey:"admin-settings-customfields",individual_tag_name:"tr"});App_Contacts.customFieldsList.collection.fetch()}var f;if(!b&&this.contactDetailView&&this.contactDetailView.model!=null){if(g==this.contactDetailView.model.toJSON()["id"]){App_Contacts.contactDetails(g,this.contactDetailView.model);return}}if(!b){if(!this.contactsListView||this.contactsListView.collection.length==0||this.contactsListView.collection.get(g)==null){console.log("Downloading contact");var e=Backbone.Model.extend({url:function(){return"/core/api/contacts/"+this.id}});var c=new e();c.id=g;c.fetch({success:function(h){App_Contacts.contactDetails(g,c)},error:function(j,h){if(h&&h.status=="403"){$("#content").html(h.responseText)}}});return}}if(!b){b=this.contactsListView.collection.get(g)}if(this.contactsListView&&this.contactsListView.collection){f=this.contactsListView.collection}add_recent_view(b);if(b.get("type")=="COMPANY"){this.contactDetailView=new Base_Model_View({model:b,isNew:true,template:"company-detail",postRenderCallback:function(j){fill_company_related_contacts(g,"company-contacts");var h=new Backbone.Model();h.url="core/api/contacts/viewed-at/"+b.get("id");h.save();if(App_Contacts.contactsListView&&App_Contacts.contactsListView.collection&&App_Contacts.contactsListView.collection.get(g)){App_Contacts.contactsListView.collection.get(g).attributes=b.attributes
}starify(j);show_map(j);if(Sip_Stack!=undefined&&Sip_Register_Session!=undefined&&Sip_Start==true){$(".contact-make-sip-call",j).show();$(".contact-make-twilio-call",j).hide();$(".contact-make-call",j).hide()}else{if(Twilio_Start==true){$(".contact-make-sip-call",j).hide();$(".contact-make-twilio-call",j).show();$(".contact-make-call",j).hide()}}}});var d=this.contactDetailView.render(true).el;$("#content").html(d);fill_company_related_contacts(g,"company-contacts");return}this.contactDetailView=new Base_Model_View({model:b,isNew:true,template:"contact-detail",postRenderCallback:function(j){if(canEditCurrentContact()){var h=new Backbone.Model();h.url="core/api/contacts/viewed-at/"+b.get("id");h.save()}if(App_Contacts.contactsListView&&App_Contacts.contactsListView.collection&&App_Contacts.contactsListView.collection.get(g)){App_Contacts.contactsListView.collection.get(g).attributes=b.attributes}load_contact_tab(j,b.toJSON());loadWidgets(j,b.toJSON());starify(j);show_map(j);if(f!=null){contact_detail_view_navigation(g,App_Contacts.contactsListView,j)}start_tour("contact-details",j);if(Sip_Stack!=undefined&&Sip_Register_Session!=undefined&&Sip_Start==true){$(".contact-make-sip-call",j).show();$(".contact-make-twilio-call",j).hide();$(".contact-make-call",j).hide()}else{if(Twilio_Start==true){$(".contact-make-sip-call",j).hide();$(".contact-make-twilio-call",j).show();$(".contact-make-call",j).hide()}}}});var d=this.contactDetailView.render(true).el;$("#content").html(d);checkContactUpdated();if(localStorage.getItem("MAP_VIEW")=="disabled"){$("#map_view_action").html("<i class='icon-plus text-xxs c-p' title='Show map' id='enable_map_view'></i>")}else{$("#map_view_action").html("<i class='icon-minus text-xxs c-p' title='Hide map' id='disable_map_view'></i>")}},editContact:function(b){if(!this.contactDetailView||!this.contactDetailView.model.id){this.navigate("contacts",{trigger:true});return}var e=this.contactDetailView.model.id;if(this.contactDetailView&&this.contactDetailView.model.id){b=this.contactDetailView.model.toJSON()}else{if(this.contactsListView&&this.contactsListView.collection&&this.contactsListView.collection.get(e)){b=this.contactsListView.collection.get(e).toJSON()}else{if(this.contact_custom_view&&this.contact_custom_view.collection&&this.contact_custom_view.collection.get(e)){b=this.contact_custom_view.collection.get(e).toJSON()}else{if(!b){var d=Backbone.Model.extend({url:function(){return"/core/api/contacts/"+e}});var c=new d();c.fetch({success:function(f){App_Contacts.editContact(f.toJSON())}});return}}}}add_custom_fields_to_form(b,function(f){if(f.type=="COMPANY"){deserialize_contact(f,"continue-company")}else{deserialize_contact(f,"continue-contact")}},b.type)},duplicateContact:function(){if(!this.contactDetailView||!this.contactDetailView.model.id||!this.contactsListView||this.contactsListView.collection.length==0){this.navigate("contacts",{trigger:true});return}var b=this.contactDetailView.model;var d=b.toJSON();d=delete_contact_property(d,"email");delete d.id;var c=new Backbone.Model();c.url="core/api/contacts";c.save(d,{success:function(e){add_custom_fields_to_form(e.toJSON(),function(f){deserialize_contact(f,"continue-contact")})}})},importContacts:function(){$("#content").html(getTemplate("import-contacts",{}))},addContactToCampaign:function(){$("#content").html(getTemplate("contact-detail-campaign",{}));$("body").trigger("fill_campaigns_contact")},sendEmail:function(b,l,h,f,j){var g={};if(!canSendEmails(1)){var k=getPendingEmails();window.history.back();var m="Emails limit";var d="";var n="Ok";var e='Please <a href="#subscribe" class="action" data-dismiss="modal" subscribe="subscribe" action="deny">upgarde your email subscription.</a>';var o="You have used up all emails in your quota. "+e;showModalConfirmation(m,o,"",function(p){Backbone.history.navigate("subscribe",{trigger:true});return},function(p){},d,n);return}if(this.contactDetailView&&!this.contactDetailView.model.get(b)){g=this.contactDetailView.model.toJSON()}var c=$("#content").html(getTemplate("send-email",g));agile_type_ahead("to",c,contacts_typeahead,null,null,"email-search",null,true);agile_type_ahead("email_cc",c,contacts_typeahead,null,null,"email-search",null,true);agile_type_ahead("email_bcc",c,contacts_typeahead,null,null,"email-search",null,true);if(b){$("#emailForm",c).find('input[name="to"]').val(b)}else{$("#emailForm",c).find('input[name="to"]').val("")}if(checkTagAgile("Zoomifier")&&this.contactDetailView){head.js(LIB_PATH+"lib/zoomifier.contentpicker.min.js",function(){$("#emailForm",c).find('textarea[name="body"]').closest(".controls").append('<div><a style="cursor:pointer;" onclick="Javascript:loadZoomifierDocSelector();"><i class="icon-plus-sign"></i> Attach Zoomifier Doc</a></div>')})}populate_send_email_details(c);if(l){$("#emailForm",c).find('input[name="subject"]').val(l)}if(f){$("#emailForm",c).find("#email_cc").closest(".control-group").show();$("#emailForm",c).find('input[name="email_cc"]').val(f)}if(j){$("#emailForm",c).find("#email_bcc").closest(".control-group").show();$("#emailForm",c).find('input[name="email_bcc"]').val(j)}if(b){setupTinyMCEEditor("textarea#email-body",false,undefined,function(){if(!h){h=""}set_tinymce_content("email-body",h);register_focus_on_tinymce("email-body")})}else{setupTinyMCEEditor("textarea#email-body",true,undefined,function(){if(!h){h=""}set_tinymce_content("email-body",h);register_focus_on_tinymce("email-body")})}},customView:function(d,l,c,b,m,e){SELECT_ALL=false;App_Contacts.tag_id=b;if(!c){c="core/api/contacts/list"}if(CONTACTS_HARD_RELOAD==true){this.contact_custom_view=undefined;CONTACTS_HARD_RELOAD=false;l=undefined;App_Contacts.contactViewModel=undefined}if(!l){if(!App_Contacts.contactViewModel){var n=new Backbone.Model();n.url="core/api/contact-view-prefs";n.fetch({success:function(o){if($.isEmptyObject(o.toJSON())){eraseCookie("contact_view");App_Contacts.contacts();return}App_Contacts.contactViewModel=o.toJSON();App_Contacts.customView(undefined,App_Contacts.contactViewModel,c,b,m)}});return}l=App_Contacts.contactViewModel}if(this.contact_custom_view&&this.contact_custom_view.collection.url==c){var f=App_Contacts.contact_custom_view.render(true).el;$("#content").html(f);if(readCookie("company_filter")){$("#contact-heading",f).text("Companies")}setupViews(f,l.name);setupContactFilterList(f,b);$(".active").removeClass("active");$("#contactsmenu").addClass("active");return}var g=getContactPadcontentKey(c);var j=readCookie("sort_by_name");if(!j||j==null){j="-created_time";createCookie("sort_by_name",j)}var k="contacts-custom-view";if(readData("dynamic_contact_filter")){c="core/api/filters/filter/dynamic-filter";e=readData("dynamic_contact_filter")}if(m){k="contacts-custom-view-table"}this.contact_custom_view=new Base_Collection_View({url:c,restKey:"contact",modelData:l,global_sort_key:j,templateKey:k,individual_tag_name:"tr",slateKey:g,cursor:true,request_method:"POST",post_data:{filterJson:e},page_size:25,sort_collection:false,postRenderCallback:function(o,s){App_Contacts.contactsListView=App_Contacts.contact_custom_view;if(readCookie("company_filter")){$("#contact-heading",o).text("Companies")}setupViews(o,l.name);setupContactFilterList(o,App_Contacts.tag_id);if(m){var p=0;if(s.models.length>0){p=s.models[0].attributes.count||s.models.length}var q;if(p>9999&&(readCookie("contact_filter")||readData("dynamic_contact_filter"))){q="<small> ("+10000+'+ Total) </small><span style="vertical-align: text-top; margin-left: -5px"><img border="0" src="/img/help.png"style="height: 10px; vertical-align: middle" rel="popover"data-placement="bottom" data-title="Lead Score"data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."id="element" data-trigger="hover"></span>'}else{q="<small> ("+p+" Total) </small>"}$("#contacts-count").html(q)}else{setupLhsFilters(o)}}});var h=this;$.getJSON("core/api/custom-fields/type/scope?type=DATE&scope=CONTACT",function(o){h.contact_custom_view.appendItem=function(p){contactTableView(p,o,this)};h.contact_custom_view.collection.fetch()});if(!m){$("#content").html(this.contact_custom_view.el)}else{$("#content").find(".span9").html(this.contact_custom_view.el);$("#bulk-actions").css("display","none");CONTACTS_HARD_RELOAD=true}$(".active").removeClass("active");$("#contactsmenu").addClass("active")},addLead:function(c,b){$("#personModal").on("shown",function(){$(this).find("#fname").val(c);$(this).find("#lname").val(b)});$("#personModal").modal()},addLeadDirectly:function(d,c,b){$("#personModal").on("shown",function(){$(this).find("#fname").val(d);$(this).find("#lname").val(c);$(this).find("#phone").val(b)});$("#personModal").modal()}});var ContactBulkActionRouter=Backbone.Router.extend({routes:{"bulk-owner":"ownerBulk","bulk-campaigns":"campaignsBulk","bulk-tags":"tagsBulk","bulk-tags-remove":"tagsRemoveBulk","bulk-email":"emailBulk"},ownerBulk:function(){if(!App_Contacts.contactsListView){Backbone.history.navigate("contacts",{trigger:true})}else{$("#content").html(getTemplate("bulk-actions-owner",{}));$("body").trigger("fill_owners")}},campaignsBulk:function(){if(!App_Contacts.contactsListView){Backbone.history.navigate("contacts",{trigger:true})}else{$("#content").html(getTemplate("bulk-actions-campaign",{}));$("body").trigger("fill_campaigns")}},tagsBulk:function(){if(!App_Contacts.contactsListView){Backbone.history.navigate("contacts",{trigger:true})}else{$("#content").html(getTemplate("bulk-actions-tags",{}))}},tagsRemoveBulk:function(){if(!App_Contacts.contactsListView){Backbone.history.navigate("contacts",{trigger:true})}else{$("#content").html(getTemplate("bulk-actions-tags-remove",{}))}},emailBulk:function(){if(!App_Contacts.contactsListView){Backbone.history.navigate("contacts",{trigger:true})}else{$("#content").html(getTemplate("send-email",{}));$("#emailForm").find(".add-attachment-select").hide();$("body").trigger("fill_emails")}}});var WorkflowsRouter=Backbone.Router.extend({routes:{workflows:"workflows","workflow-add":"workflowAdd","workflow/:id":"workflowEdit","workflow-templates":"workflowTemplates","workflow-add/:c/:t":"workflowAddTemplate","workflows/logs/:id":"logsToCampaign","campaign-stats":"campaignStats","email-reports/:id":"emailReports",triggers:"triggers","trigger-add/:id":"triggerAdd","trigger-add":"triggerAdd","trigger/:id":"triggerEdit","workflow/all-subscribers/:id":"allSubscribers","workflow/active-subscribers/:id":"activeSubscribers","workflow/completed-subscribers/:id":"completedSubscribers","workflow/removed-subscribers/:id":"removedSubscribers","workflow/unsubscribed-subscribers/:id":"unsubscribedSubscribers","workflow/hardbounced-subscribers/:id":"hardBouncedSubscribers","workflow/softbounced-subscribers/:id":"softBouncedSubscribers","workflow/spam-reported-subscribers/:id":"spamReportedSubscribers"},workflows:function(){this.workflow_list_view=new Base_Collection_View({url:"/core/api/workflows",restKey:"workflow",sort_collection:false,templateKey:"workflows",individual_tag_name:"tr",cursor:true,page_size:20,postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time.campaign-created-time",b).timeago()
});start_tour(undefined,b);if(App_Workflows.workflow_list_view&&!(App_Workflows.workflow_list_view.collection.length===0)){show_triggers_of_each_workflow(b)}},appendItemCallback:function(b){$("time.campaign-created-time",b).timeago();show_triggers_of_each_workflow(b)}});this.workflow_list_view.collection.fetch();$("#content").html(this.workflow_list_view.el);$(".active").removeClass("active");$("#workflowsmenu").addClass("active")},workflowAdd:function(){if(!this.workflow_list_view||!this.workflow_list_view.collection){this.navigate("workflows",{trigger:true});return}this.workflow_json=undefined;this.workflow_model=undefined;$("#content").html(getTemplate("workflow-add",{is_new:true}));initiate_tour("workflows-add",$("#content"))},workflowEdit:function(h,g){if(!this.workflow_list_view||this.workflow_list_view.collection.length==0){this.navigate("workflows",{trigger:true});return}if(g){this.workflow_model=g}else{this.workflow_model=this.workflow_list_view.collection.get(h)}if(this.workflow_model===undefined){console.log("Downloading workflow.");var e=this.workflow_list_view.collection.at(0).attributes.count;if(this.workflow_list_view.collection.length!==e){var b=Backbone.Model.extend({url:"/core/api/workflows/"+h});var c=new b();c.id=h;c.fetch({success:function(j){if(!$.isEmptyObject(j.toJSON())){App_Workflows.workflowEdit(h,c);return}}})}}if(this.workflow_model===undefined){return}this.workflow_json=this.workflow_model.get("rules");var d=$(getTemplate("workflow-add",{}));$("#content").html(d);$("#workflow-name").val(this.workflow_model.get("name"));var f=this.workflow_model.get("unsubscribe");$("#unsubscribe-tag").val(f.tag);$("#unsubscribe-action").val(f.action);$("#unsubscribe-action").trigger("change")},workflowTemplates:function(){if(!this.workflow_list_view||!this.workflow_list_view.collection){this.navigate("workflows",{trigger:true});return}$("#content").html(getTemplate("workflow-categories",{}))},workflowAddTemplate:function(d,f){if(!this.workflow_list_view||!this.workflow_list_view.collection){this.navigate("workflows",{trigger:true});return}this.workflow_json=undefined;this.workflow_model=undefined;var e=Backbone.Model.extend({url:"misc/campaign-templates/"+d+"/"+f+"_template.jsp"});var b=new e();var c=this;b.fetch({success:function(g){c.workflow_json=JSON.stringify(g)}});$("#content").html(getTemplate("workflow-add",{is_new:true}))},logsToCampaign:function(e,c,d){$("#campaign-analysis-tabs").html(getTemplate("campaign-analysis-tabs",{id:e}));if(c==undefined||c=="ALL"){c=""}else{c="?log-type="+c}var b=new Base_Collection_View({url:"/core/api/campaigns/logs/"+e+c,templateKey:"campaign-logs",cursor:true,page_size:20,individual_tag_name:"tr",sort_collection:false,postRenderCallback:function(f){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time.log-created-time",f).timeago()});$("#log-filter-title").html(d)},appendItemCallback:function(f){includeTimeAgo(f)}});b.collection.fetch({success:function(f){if(f.length===0){fill_logs_slate("logs-slate",c.split("=")[1])}}});$("#campaign-analysis-tabs-content").html(b.el);$("#campaign-tabs .active").removeClass("active");$(".campaign-logs-tab").addClass("active")},campaignStats:function(){$("#content").html(getTemplate("campaign-stats-chart",{}));showBar("/core/api/campaign-stats/stats/","campaign-stats-chart","Campaigns Comparison","Email Stats",null);$(".active").removeClass("active");$("#workflowsmenu").addClass("active")},emailReports:function(d){if($("#campaign-reports-select").html()===null){$("#content").html(getTemplate("campaign-analysis",{}));var c="<option value='{{id}}'>{{name}}</option>";fillSelect("campaign-reports-select","/core/api/workflows","workflow",function b(){$("#campaign-reports-select").find("option[value="+d+"]").attr("selected","selected")},c)}$("#campaign-analysis-tabs").html(getTemplate("campaign-analysis-tabs",{id:d}));head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){$("#campaign-analysis-tabs-content").html(getTemplate("campaign-email-reports",{}));initChartsUI(d)});$(".active").removeClass("active");$("#workflowsmenu").addClass("active");$("#campaign-tabs .active").removeClass("active");$(".campaign-stats-tab").addClass("active")},triggers:function(){this.triggersCollectionView=new Base_Collection_View({url:"/core/api/triggers",restKey:"triggers",templateKey:"triggers",individual_tag_name:"tr"});this.triggersCollectionView.collection.fetch();$("#content").html(this.triggersCollectionView.el);$(".active").removeClass("active");$("#workflowsmenu").addClass("active")},triggerAdd:function(c){this.triggerModelview=new Base_Model_View({url:"core/api/triggers",template:"trigger-add",isNew:true,window:"triggers",postRenderCallback:function(e){head.js(LIB_PATH+"lib/agile.jquery.chained.min.js",function(){var g,f;g=$("#LHS",e);f=$("#RHS",e);CALL=$("#CALL",e);f.chained(g);CALL.chained(g)});var d="<option value='{{id}}'>{{name}}</option>";if(c){fillSelect("campaign-select","/core/api/workflows","workflow",function(f){$("#campaign-select",e).find("option[value="+c+"]").attr("selected","selected")},d,false,e)}else{fillSelect("campaign-select","/core/api/workflows","workflow","no-callback",d,false,e)}},saveCallback:function(){App_Workflows.triggersCollectionView=undefined}});var b=this.triggerModelview.render();$("#content").html(b.el)},triggerEdit:function(d){if(!this.triggersCollectionView||this.triggersCollectionView.collection.length==0){this.navigate("triggers",{trigger:true});return}var c=this.triggersCollectionView.collection.get(d);var b=new Base_Model_View({url:"core/api/triggers",model:c,template:"trigger-add",window:"triggers",postRenderCallback:function(h){head.js(LIB_PATH+"lib/agile.jquery.chained.min.js",function(){var s,q;s=$("#LHS",h);q=$("#RHS",h);CALL=$("#CALL",h);q.chained(s);CALL.chained(s)});var l=c.toJSON()["type"];$("#trigger-type",h).val(l).attr("selected","selected").trigger("change");if(l==="DEAL_MILESTONE_IS_CHANGED"){var k=c.toJSON()["trigger_deal_milestone"];populate_milestones_in_trigger($("form#addTriggerForm",h),"trigger-deal-milestone",k)}if(l=="FORM_SUBMIT"){var n=c.toJSON()["trigger_form_event"];var o=c.toJSON()["trigger_run_on_new_contacts"];populate_forms_in_trigger($("form#addTriggerForm",h),"trigger-form-event",n,o)}if(l=="RUNS_DAILY"||l=="RUNS_WEEKLY"||l=="RUNS_MONTHLY"){var p=c.toJSON()["contact_filter_id"];populate_contact_filters_in_trigger($("form#addTriggerForm",h),"contact-filter",p)}if(l=="TAG_IS_ADDED"||l=="TAG_IS_DELETED"){$("#trigger-custom-tags",h).closest("div.control-group").css("display","");$(".trigger-tags",h).live("focus",function(q){q.preventDefault();addTagsDefaultTypeahead($("form#addTriggerForm").find("div#RHS"))})}if(l=="ADD_SCORE"){$("#trigger-custom-score",h).closest("div.control-group").css("display","")}if(l=="STRIPE_CHARGE_EVENT"){var m=c.toJSON()["trigger_stripe_event"];var o=c.toJSON()["trigger_run_on_new_contacts"];populate_stripe_events_in_trigger($("form#addTriggerForm",h),"trigger-stripe-event",m,o)}if(l=="SHOPIFY_EVENT"){var j=c.toJSON()["trigger_shopify_event"];var o=c.toJSON()["trigger_run_on_new_contacts"];populate_shopify_events_in_trigger($("form#addTriggerForm",h),"trigger-shopify-event",j,o)}if(l=="INBOUND_MAIL_EVENT"){var e=c.toJSON()["new_email_trigger_run_on_new_contacts"];populate_inbound_mail_events_in_trigger($("form#addTriggerForm",h),"trigger-inbound-mail-event",e)}if(l=="EMAIL_OPENED"||l=="EMAIL_LINK_CLICKED"||l=="UNSUBSCRIBED"){if(l!=="UNSUBSCRIBED"){$("#email-tracking-type",h).closest("div.control-group").css("display","");$("#email-tracking-type",h).find("option[value="+c.toJSON()["email_tracking_type"]+"]").attr("selected","selected").trigger("change")}if(c.toJSON()["email_tracking_type"]=="CAMPAIGNS"||l=="UNSUBSCRIBED"){$("#email-tracking-campaign-id",h).closest("div.control-group").css("display","");var g="<option value='{{id}}'>{{name}}</option>";fillSelect("email-tracking-campaign-id","/core/api/workflows","workflow",function f(){$("#email-tracking-campaign-id option:first").after('<option value="0">All</option>');var q=c.toJSON();if(q){$("#email-tracking-campaign-id",h).find("option[value="+q.email_tracking_campaign_id+"]").attr("selected","selected")}$(".loading",h).remove()},g,false,h)}if(l=="EMAIL_LINK_CLICKED"){$("#custom-link-clicked",h).closest("div.control-group").css("display","")}}if(l=="EVENT_IS_ADDED"){$("form#addTriggerForm",h).find("select#event-type").closest("div.control-group").css("display","");$("#email-type",h).find("option[value="+c.toJSON()["email_type"]+"]").attr("selected","selected").trigger("change");populate_owners_in_trigger($("form#addTriggerForm",h),"event-owner-id",c.toJSON()["event_owner_id"])}if(l=="INBOUND_CALL"||l=="OUTBOUND_CALL"){populate_call_trigger_options($("form#addTriggerForm",h),c.toJSON())}var g="<option value='{{id}}'>{{name}}</option>";fillSelect("campaign-select","/core/api/workflows","workflow",function f(){var q=c.toJSON();if(q){$("#campaign-select",h).find("option[value="+q.campaign_id+"]").attr("selected","selected")}},g,false,h)},saveCallback:function(){App_Workflows.triggersCollectionView=undefined}});$("#content").html(b.render().el)},automationAdd:function(){this.automationModelview=new Base_Model_View({url:"/core/api/automations",template:"automation-add",isNew:true,window:"automations",postRenderCallback:function(d){var c="<option value='{{id}}'>{{name}}</option>";fillSelect("campaign-select","/core/api/workflows","workflow","no-callback",c,false,d);fillSelect("filter-select","/core/api/filters","workflow","no-callback",c,false,d)}});var b=this.automationModelview.render();$("#content").html(b.el)},automations:function(){this.automationsCollectionView=new Base_Collection_View({url:"/core/api/automations",restKey:"automations",templateKey:"automations",individual_tag_name:"tr"});this.automationsCollectionView.collection.fetch();$("#content").html(this.automationsCollectionView.el);$(".active").removeClass("active");
$("#workflowsmenu").addClass("active")},automationEdit:function(d){if(!this.automationsCollectionView||this.automationsCollectionView.collection.length==0){this.navigate("automations",{trigger:true});return}var c=this.automationsCollectionView.collection.get(d);var b=new Base_Model_View({url:"core/api/automations",model:c,template:"automation-add",window:"automations",postRenderCallback:function(h){var j=c.toJSON()["durationType"];$("#period-type",h).val(j).attr("selected","selected").trigger("change");var g="<option value='{{id}}'>{{name}}</option>";fillSelect("campaign-select","/core/api/workflows","workflow",function f(){var k=c.toJSON();if(k){$("#campaign-select",h).find("option[value="+k.campaign_id+"]").attr("selected","selected")}},g,false,h);fillSelect("filter-select","/core/api/filters","workflow",function e(){var k=c.toJSON();if(k){$("#filter-select",h).find("option[value="+k.contactFilter_id+"]").attr("selected","selected")}},g,false,h)}});$("#content").html(b.render().el)},allSubscribers:function(c){$("#campaign-analysis-tabs").html(getTemplate("campaign-analysis-tabs",{id:c}));var b=get_campaign_subscribers_collection(c,"core/api/workflows/all-subscribers/"+c,"workflow-other-subscribers");b.collection.fetch({success:function(d){if(d.length===0){fill_subscribers_slate("subscribers-slate","all-subscribers")}}});$("#campaign-analysis-tabs-content").html(b.el);$("#campaign-tabs .active").removeClass("active");$(".campaign-subscribers-tab").addClass("active")},activeSubscribers:function(b){if(!this.workflow_list_view||this.workflow_list_view.collection.length==0){this.navigate("workflows",{trigger:true});return}this.active_subscribers_collection=get_campaign_subscribers_collection(b,"core/api/workflows/active-subscribers/"+b,"workflow-active-contacts");this.active_subscribers_collection.collection.fetch({success:function(c){if(c.length===0){fill_subscribers_slate("subscribers-slate","active-subscribers")}}});$("#campaign-analysis-tabs-content").html(this.active_subscribers_collection.el);$("#campaign-tabs .active").removeClass("active");$(".campaign-subscribers-tab").addClass("active")},completedSubscribers:function(c){if(!this.workflow_list_view||this.workflow_list_view.collection.length==0){this.navigate("workflows",{trigger:true});return}var b=get_campaign_subscribers_collection(c,"core/api/workflows/completed-subscribers/"+c,"workflow-other-subscribers");b.collection.fetch({success:function(d){if(d.length===0){fill_subscribers_slate("subscribers-slate","completed-subscribers")}}});$("#campaign-analysis-tabs-content").html(b.el);$("#campaign-tabs .active").removeClass("active");$(".campaign-subscribers-tab").addClass("active")},removedSubscribers:function(c){if(!this.workflow_list_view||this.workflow_list_view.collection.length==0){this.navigate("workflows",{trigger:true});return}var b=get_campaign_subscribers_collection(c,"core/api/workflows/removed-subscribers/"+c,"workflow-other-subscribers");b.collection.fetch({success:function(d){if(d.length===0){fill_subscribers_slate("subscribers-slate","removed-subscribers")}}});$("#campaign-analysis-tabs-content").html(b.el);$("#campaign-tabs .active").removeClass("active");$(".campaign-subscribers-tab").addClass("active")},unsubscribedSubscribers:function(c){if(!this.workflow_list_view||this.workflow_list_view.collection.length==0){this.navigate("workflows",{trigger:true});return}var b=get_campaign_subscribers_collection(c,"core/api/workflows/unsubscribed-subscribers/"+c,"workflow-other-subscribers");b.collection.fetch({success:function(d){if(d.length===0){fill_subscribers_slate("subscribers-slate","unsubscribe-subscribers")}}});$("#campaign-analysis-tabs-content").html(b.el);$("#campaign-tabs .active").removeClass("active");$(".campaign-subscribers-tab").addClass("active")},hardBouncedSubscribers:function(c){if(!this.workflow_list_view||this.workflow_list_view.collection.length==0){this.navigate("workflows",{trigger:true});return}var b=get_campaign_subscribers_collection(c,"core/api/workflows/hardbounced-subscribers/"+c,"workflow-other-subscribers");b.collection.fetch({success:function(d){if(d.length===0){fill_subscribers_slate("subscribers-slate","hardbounced-subscribers")}}});$("#campaign-analysis-tabs-content").html(b.el);$("#campaign-tabs .active").removeClass("active");$(".campaign-subscribers-tab").addClass("active")},softBouncedSubscribers:function(c){if(!this.workflow_list_view||this.workflow_list_view.collection.length==0){this.navigate("workflows",{trigger:true});return}var b=get_campaign_subscribers_collection(c,"core/api/workflows/softbounced-subscribers/"+c,"workflow-other-subscribers");b.collection.fetch({success:function(d){if(d.length===0){fill_subscribers_slate("subscribers-slate","softbounced-subscribers")}}});$("#campaign-analysis-tabs-content").html(b.el);$("#campaign-tabs .active").removeClass("active");$(".campaign-subscribers-tab").addClass("active")},spamReportedSubscribers:function(c){if(!this.workflow_list_view||this.workflow_list_view.collection.length==0){this.navigate("workflows",{trigger:true});return}var b=get_campaign_subscribers_collection(c,"core/api/workflows/spam-reported-subscribers/"+c,"workflow-other-subscribers");b.collection.fetch({success:function(d){if(d.length===0){fill_subscribers_slate("subscribers-slate","spam-reported-subscribers")}}});$("#campaign-analysis-tabs-content").html(b.el);$("#campaign-tabs .active").removeClass("active");$(".campaign-subscribers-tab").addClass("active")}});var SubscribeRouter=Backbone.Router.extend({routes:{"subscribe-plan":"subscribe","subscribe-plan/:id":"subscribe",updatecard:"updateCreditCard",updateplan:"updatePlan","purchase-plan":"purchasePlan","purchase-plan-new":"purchasePlanNew",invoice:"invoice","invoice/:id":"invoiceDetails","getInvoiceDetails/:id":"getInvoiceDetails",subscribe_new:"subscribe_new",subscribe:"subscribe_new",email_subscription:"email_subscription","attach-card":"addCreditCardNew","update-card":"updateCardNew"},subscribe:function(c){if(IS_NEW_USER&&_plan_on_signup&&_plan_on_signup.plan_type&&_plan_on_signup.plan_type=="FREE"){_plan_on_signup=null;Backbone.history.navigate("dashboard",{trigger:true});return}config_version_2_plans();var b=new Base_Model_View({url:"core/api/subscription",template:"subscribe-new",window:"subscribe",postRenderCallback:function(d){var e=b.model.toJSON();var f=window;set_up_account_stats(d);USER_BILLING_PREFS=e;USER_CREDIRCARD_DETAILS=b.model.toJSON().billingData;if(!USER_CREDIRCARD_DETAILS&&!(IS_NEW_USER&&_plan_on_signup)){Backbone.history.navigate("subscribe",{trigger:true});return}element=setPriceTemplete(e.plan.plan_type,d);c=(c&&c=="coupon")?c:"";showCouponCodeContainer(c);head.load(CSS_PATH+"css/jslider.css",CSS_PATH+"css/misc/agile-plan-upgrade.css",LIB_PATH+"lib/jquery.slider.min.js",function(){if($.isEmptyObject(e)){setPlan("free")}else{setPlan(e)}load_slider(d)})}});$("#content").html(b.render().el)},getInvoiceDetails:function(e){var c;var b;var d;if(e){$.ajax({url:"core/api/subscription/getinvoice?d="+e,type:"GET",async:false,success:function(f){console.log("Invoice object");console.log(f);c=f},error:function(f){showNotyPopUp("information","error occured please try again","top")}}).responseText;$.ajax({url:"/core/api/account-prefs",type:"GET",async:false,dataType:"json",success:function(f){console.log("Account prefs");console.log(f);b=f},error:function(f){showNotyPopUp("information","error occured please try again","top")}}).responseText;d={invoice:c,company:b};console.log("xxxxxxxxxxxxxxx");console.log(d);head.js(LIB_PATH+"jscore/handlebars/handlebars-helpers.js",function(){$("#content").html(getTemplate("invoice-detail",d))})}},purchasePlanNew:function(){var d=this;var c=this;var e=plan_json;var b=new Base_Model_View({url:"core/api/subscription",template:"purchase-plan-new",isNew:true,postRenderCallback:function(f){head.js(LIB_PATH+"lib/countries.js",function(){print_country($("#country",f))})},saveCallback:function(f){_IS_FREE_PLAN=false;c.navigate("subscribe",{trigger:true});showNotyPopUp("information","You have been upgraded successfully. Please logout and login again for the new changes to apply.","top")}});$("#content").html(b.render().el);$(".active").removeClass("active")},updateCreditCard:function(){var b=new Base_Model_View({url:"core/api/subscription",template:"subscription-card-detail",window:"purchase-plan",postRenderCallback:function(d){card_expiry(d);var e=d.find("form.card_details"),c=b.model.toJSON().billingData;USER_CREDIRCARD_DETAILS=c;plan_json.customer=JSON.parse(USER_CREDIRCARD_DETAILS);if(!$.isEmptyObject(c)){deserialize_card_details(JSON.parse(c),$(e))}},saveCallback:function(c){$("#change-card").show()}});$("#content").html(b.render().el)},updatePlan:function(){var b=new Base_Model_View({url:"core/api/subscription-addon/subscribe",template:"purchase-email-plan",saveCallback:function(){window.navigate("subscribe",{trigger:true});showNotyPopUp("information","You have been upgraded successfully. Please logout and login again for the new changes to apply.","top")},postRenderCallback:function(c){card_expiry(c);head.js(LIB_PATH+"lib/countries.js",function(){print_country($("#country",c))})}});$("#content").html(b.render().el)},invoice:function(){this.invoice=new Base_Collection_View({url:"core/api/subscription/invoices",templateKey:"invoice",window:"subscribe",individual_tag_name:"tr"});this.invoice.collection.fetch();console.log(this.invoice.collection.fetch());$("#content").html(this.invoice.el)},invoiceDetails:function(d){if(!this.invoice||!this.invoice.collection||this.invoice.collection==0||this.invoice.collection.get(d)==null){this.navigate("invoice",{trigger:true});return}var b=this.invoice.collection.get(d);var c=new Base_Model_View({model:b,template:"invoice-detail",window:"invoice",isNew:true});$("#content").html(c.render().el)},purchasePlan:function(){if(!plan_json.plan){this.navigate("subscribe",{trigger:true});return}_plan_on_signup=null;var c=this;var d=plan_json;var b=new Base_Model_View({url:"core/api/subscription",template:"purchase-plan",isNew:true,data:d,postRenderCallback:function(e){showCouponDiscountAmount(plan_json,e);
card_expiry(e)},saveCallback:function(e){c.navigate("subscribe",{trigger:true});showNotyPopUp("information","You have been upgraded successfully. Please logout and login again for the new changes to apply.","top")},errorCallback:function(e){showNotyPopUp("information","There was an error while processing your payment. Please try again later.","top")}});$("#content").html(b.render().el);$(".active").removeClass("active")},email_subscription:function(f){var e=this;var c=0;var b={url:"core/api/subscription",isNew:true,template:"email-plan-form",postRenderCallback:function(g){$("#close",g).click(function(h){h.preventDefault();e.setup_email_plan(f)});jQuery.validator.addMethod("email_plan_minimum",function(j,h){if(this.optional(h)){return true}return parseInt(j)>=5}," Should purchase a minimum of 5000 emails.");$("#email-quantity",g).die().live("keyup",function(h){isValidForm($("#email-plan-form",g));if(h.which==13){h.preventDefault()}})},saveCallback:function(g){e.setup_email_plan(f);showNotyPopUp("information","Your email package will be updated in a few minutes.","top")}};if(f){b.model=f}var c=0;var d=new Base_Model_View(b);$("#email-details-pane").html(d.render().el);$("#email-quantity").bind("keyup",function(h){var g=$(this).val();if(isNaN(g)){return}var j=g*1000;if(IS_HAVING_MANDRILL){$("#emails_total_cost").html(g*2);$("#email_rate").html("$2");return}if(j<100000){$("#emails_total_cost").html(g*4);$("#email_rate").html("$4")}else{if(j<=1000000){$("#emails_total_cost").html(g*3);$("#email_rate").html("$3")}else{if(j>=1000000){$("#emails_total_cost").html(g*2);$("#email_rate").html("$2")}}}})},email_sbuscrption_step1:function(f){var j=true;try{f.toJSON()}catch(g){j=false}var d=this;var b=0;var h={url:"core/api/subscription?reload=true",template:"email-plan-details",window:"subscribe",isNew:true,postRenderCallback:function(e){if(++b<=1){$("#account_email_plan_upgrade",e).die().live("click",function(k){k.preventDefault();d.email_subscription(c.model)})}}};if(j){h.model=f}else{h.data=f}var c=new Base_Model_View(h);$("#email-details-pane").html(c.render(true).el)},updateCardNew:function(){var b=new Base_Model_View({url:"core/api/subscription",template:"subscription-card-detail",window:"purchase-plan",postRenderCallback:function(d){card_expiry(d);var f=d.find("form.card_details"),c=b.model.toJSON().billingData;USER_CREDIRCARD_DETAILS=c;plan_json.customer=JSON.parse(USER_CREDIRCARD_DETAILS);var e=getActiveCard(plan_json.customer);if(!$.isEmptyObject(c)){deserialize_card_details(e,$(f))}}});$("#content").html(b.render().el)},subscribe_new:function(){var c=this;var b=0;$("#content").html(LOADING_HTML);$.getJSON("core/api/subscription?reload=true",function(e){_billing_restriction=e.cachedData;$("#content").html(getTemplate("subscribe",e));var d=new BaseModel(e);$("#change-card").die().live("click",function(f){f.preventDefault();c.showCreditCardForm(d,function(g){})});c.setup_account_plan(d);c.setup_email_plan(d);c.show_card_details(d);c.recent_invoice(d)})},setup_account_plan:function(e){var b=0;var d=this;var c=new Base_Model_View({url:"core/api/subscription",model:e,template:"account-plan-details",window:"subscribe-plan",postRenderCallback:function(f){if(++b<=1){$("#attach_card_notification",f).die().live("click",function(g){g.preventDefault();d.showCreditCardForm(c.model,function(h){Backbone.history.navigate("subscribe-plan",{trigger:true})})});$("#user-plan-details-popover",f).live("click",function(h){var g=getTemplate("account-plan-details-popover",c.model.get("planLimits"));console.log(g);$(this).attr({rel:"popover","data-placement":"right","data-original-title":"Plan Details","data-content":g});$(this).popover("show")})}}});$("#plan-details-pane").html(c.render(true).el)},setup_email_plan:function(e){var b=0;var d=this;IS_HAVING_MANDRILL=false;$.ajax({url:"core/api/email-gateway",type:"GET",success:function(f){if(f.email_api=="MANDRILL"){IS_HAVING_MANDRILL=true}}});var c=new Base_Model_View({url:"core/api/subscription",template:"email-plan-details",model:e,window:"subscribe",postRenderCallback:function(f){$("#account_email_attach_card",f).die().live("click",function(g){g.preventDefault();d.showCreditCardForm(c.model,function(h){d.email_subscription(c.model)})});$("#account_email_plan_upgrade",f).die().live("click",function(g){g.preventDefault();d.email_subscription(c.model)});getTemplate("email-plan-subscription-details-popover",c.model.toJSON(),"Yes",function(g){console.log(g);$("#email-plan-details-popover",f).attr({rel:"popover","data-placement":"right","data-original-title":"Plan Details","data-content":g});$("#email-plan-details-popover",f).live("click",function(h){$(this).popover("show")})})}});$("#email-details-pane").html(c.render(true).el)},showCreditCardForm:function(c,e){if(!c){c=new BaseModel({})}var b=0;$("#credit-card-form-modal-holder").empty();var d=new Base_Model_View({url:"core/api/subscription",modal:"#credit-card-form-modal",template:"credit-card-form",model:c,postRenderCallback:function(f){card_expiry(f);if(++b<=1){$(".modal-backdrop").remove()}},saveCallback:function(f){$(".modal-backdrop").remove();$("#credit-card-form-modal").modal("hide");$("#change-card").show();if(e&&typeof e=="function"){e(f)}}});$("#credit-card-form-modal-holder").html(d.render(true).el);$("#credit-card-form-modal").modal("show")},show_card_details:function(e){var d=this;var b=0;var c=new Base_Model_View({url:"core/api/subscription",model:e,template:"customer-details-block",postRenderCallback:function(f){$("#change-card",f).die().live("click",function(g){g.preventDefault();d.showCreditCardForm(c.model,function(h){})})}});$("#customer-details-holder").html(c.render(true).el)},addCreditCardNew:function(c){var b={url:"core/api/subscription",template:"subscription-card-detail",window:"purchase-plan",isNew:true,postRenderCallback:function(e){card_expiry(e);head.js(LIB_PATH+"lib/countries.js",function(){print_country($("#country",e))})}};if(c){b.model=c;b.isNew=false}var d=new Base_Model_View();$("#content").html(d.render().el)},recent_invoice:function(c){if(!c.get("billingData")){return}console.log(c.get("billingData"));var d=null;try{d=JSON.parse(c.get("billingData")).id}catch(f){d=c.get("billingData").id}var b=new Base_Collection_View({url:"core/api/subscription/charges/"+d+"?page_size=20",templateKey:"charge",individual_tag_name:"tr",sortKey:"created",descending:true});b.collection.fetch();$("#invoice-details-holder").html(b.render().el)}});function getPendingEmails(){var d=_billing_restriction.one_time_emails_count;var b=getMaxEmailsLimit();if(b>0){if(d<0){return 0}return d}if(b==0){var c=5000+d;if(c<0){return 0}return c}return d}function getMaxEmailsLimit(){var b=_billing_restriction.max_emails_count;if(b==undefined){b=0}return b}function canSendEmails(b){var c=getPendingEmails();if(c>=b){return true}return false}function is_free_plan(){return _IS_FREE_PLAN}var ACLRestriction=Backbone.Router.extend({routes:{"not-allowed":"notAllowed"},notAllowed:function(b){$("#content").html(getTemplate("not-allowed",b))}});var ActivitylogRouter=Backbone.Router.extend({routes:{activities:"activities","contact-activities":"contactActivities","contact-activities/:type":"contactActivities"},activities:function(b){if(!tight_acl.checkPermission("ACTIVITY")){return}DEAL_TRACKS_COUNT=getTracksCount();head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){$("#content").html(getTemplate("activity-list-header",{}));if(IS_FLUID){$("#activity_header").removeClass("row").addClass("row-fluid")}else{$("#activity_header").removeClass("row-fluid").addClass("row")}initActivitiesDateRange();$(".activity-log-button").hide();var f=readCookie("selecteduser");var e=readCookie("selectedentity");console.log("values read from activity cookie  selected user "+f+"  selected entityname "+e);var c="<li><a  href='{{id}}'>{{name}}</li>";fillSelect("user-select","core/api/users","domainuser",function d(){$("#content").find("#user-select").append("<li><a href=''>All Users</a></li>");var l=readCookie("selectedStartTime");var h=readCookie("selectedEndTime");if(f||e||(l&&h)){$("ul#user-select li a").closest("ul").data("selected_item",f);$("ul#entity_type li a").closest("ul").data("selected_item",e);if(l&&h){$("#activities_date_range #range").html(l+" - "+h)}console.log("activites function called  "+new Date().getTime()+"  time with milliseconds "+new Date());updateActivty(getParameters());console.log("activites function ended rendering  "+new Date().getTime()+"  time with milliseconds "+new Date());var g=readCookie("selecteduser_value");var j=readCookie("selectedentity_value");if(g){$("#selectedusername").html(g)}if(j){$("#selectedentity_type").html(j);$(".activity-sub-heading").html(j)}}else{var k=new Base_Collection_View({url:"/core/api/activitylog/getAllActivities",sortKey:"time",descending:true,templateKey:"activity-list-log",cursor:true,scroll_symbol:"scroll",page_size:20,individual_tag_name:"li",postRenderCallback:function(m){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time",m).timeago()})},appendItemCallback:function(m){includeTimeAgo(m)}});k.appendItem=append_activity_log;k.collection.fetch();$("#activity-list-based-condition").html(k.el)}$(".activity-log-button").show();if(IS_FLUID){$("#activity_model").removeClass("row").addClass("row-fluid")}else{$("#activity_model").removeClass("row-fluid").addClass("row")}},c,true);$(".active").removeClass("active");$("#activitiesmenu").addClass("active")})},contactActivities:function(b){head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){var c="core/api/campaigns/logs/ContactActivities";$("#content").html(getTemplate("contact-activity-header",{}));if(b==undefined||b=="All Activities"){$("#log-filter-title").text("All Activities")}else{$("#log-filter-title").text(b.replace(/_/g," "))}if(b!=undefined){if(b=="Spam_Reports"){b="Email_Spam"}c=c+"?log_type="+b}var d=new Base_Collection_View({url:c,templateKey:"contact-activity-list-log",individual_tag_name:"tr",cursor:true,page_size:20,sort_collection:false,postRenderCallback:function(e){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time",e).timeago();
console.log(b);if(IS_FLUID){$("#contact_activity_header").removeClass("row").addClass("row-fluid");$("#contact_activity_model").removeClass("row").addClass("row-fluid")}else{$("#contact_activity_header").removeClass("row-fluid").addClass("row");$("#contact_activity_model").removeClass("row-fluid").addClass("row")}})},appendItemCallback:function(e){includeTimeAgo(e)}});d.collection.fetch();$("#contact-activity-list-based-condition").html(d.render().el);console.log("========contact activities ==========");console.log(d.render().el)})}});$(function(){$("ul#user-select li a, ul#entity_type li a").die().live("click",function(d){d.preventDefault();var c=$(this).html(),f=$(this).attr("href");$(this).closest("ul").data("selected_item",f);$(this).closest(".btn-group").find(".selected_name").text(c);var b=getParameters();updateActivty(b)});$("ul#entity_type li a").die().live("click",function(){var c=$(this).html();var b=$(this).attr("href");createCookie("selectedentity",b,90);createCookie("selectedentity_value",c,90);$(".activity-sub-heading").html(c)});$("ul#user-select li a").die().live("click",function(){var c=$(this).html();var b=$(this).attr("href");createCookie("selecteduser",b,90);createCookie("selecteduser_value",c,90)})});email=null;var AdminPanelRouter=Backbone.Router.extend({routes:{domainSubscribe:"domainSubscribeDetails","domainSubscribe/:id":"domainSubscribeDetails","purchase-plan-formAdminPanel":"purchasePlanFromAdminpanel","all-domain-users":"allDomainUsers","change-password-admin/:id":"changePasswordadmin","getDomainUserDetails/:id":"getDomainUserDetails"},get_account_stats_for_domain_from_adminpanel:function(b,c){console.log("in accountstats object");console.log(c);$.ajax({url:"core/api/admin_panel/getdomainstats?d="+c,type:"GET",success:function(d){console.log(d);var e=d.emailcount;d.emailcount=JSON.parse(d.emailcount);$(b).find("#account").html(getTemplate("domain-info",d));$(b).find("#emailcount").html(getTemplate("email-stats",JSON.parse(e)));$(".delete-namespace").attr("data",c)},error:function(d){console.log(d)}})},get_customerobject_for_domain_from_adminpanel:function(b,d){var c=this;$.ajax({url:"core/api/admin_panel/getcustomer?d="+d,type:"GET",success:function(e){console.log("ssssssssssssssssssssssss");console.log(e);$(b).find("#planinfo").html(getTemplate("plan-info",e));if(e==null||e==""||e==undefined){$("#login_id").attr("href","https://"+d+".agilecrm.com/login")}else{c.get_collection_of_charges_for_customer_from_adminpanel(b,e.id)}}})},get_collection_of_invoices_for_domain_from_adminpanel:function(b,c){this.invoicecollection=new Base_Collection_View({url:"core/api/admin_panel/getinvoices?d="+c,templateKey:"admin-invoice",individual_tag_name:"tr"});this.invoicecollection.collection.fetch();$(".past-invoicecollection",b).html(this.invoicecollection.render().el)},get_collection_of_charges_for_customer_from_adminpanel:function(c,b){this.chargecollection=new Base_Collection_View({url:"core/api/admin_panel/getcharges?d="+b,templateKey:"admin-charge",individual_tag_name:"tr",sortKey:"createdtime",descending:true});this.chargecollection.collection.fetch();$(".past-chargecollection",c).html(this.chargecollection.render().el)},getDomainUserDetails:function(d){var b=this;var c;this.usersListViewCollection=new Base_Collection_View({url:"core/api/admin_panel/getParticularDomainUsers?d="+d,templateKey:"all-domain",individual_tag_name:"tr",postRenderCallback:function(f){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".last-login-time",f).timeago()});var e=b.usersListViewCollection.collection.models;c=e[0].get("domain");email=e[0].get("email");b.get_customerobject_for_domain_from_adminpanel(f,c);$("#account").html("<img src='img/21-0.gif'>");b.get_account_stats_for_domain_from_adminpanel(f,c)}});this.usersListViewCollection.collection.fetch();$("#content").html(this.usersListViewCollection.el)},changePasswordadmin:function(b){$("#content").html(getTemplate("settings"),{});$("#content").html(getTemplate("settings-change-password-adminpanel"),{});$("#saveNewPasswordFromAdmin").on("click",function(g){g.preventDefault();var f=$(this);if($(f).attr("disabled")){return}disable_save_button($(f));var c=$(this).closest("form").attr("id");if(!isValidForm("#"+c)){enable_save_button($(f));return false}$("#changePasswordForm").find("span.save-status").html(getRandomLoadingImg());var d=serializeForm(c);$.ajax({url:"/core/api/admin_panel/changepassword/"+b,type:"PUT",data:d,success:function(){add_password_change_info_as_note_to_owner(email);Backbone.history.navigate("all-domain-users",{trigger:true});showNotyPopUp("information","password changed successfully","top")},error:function(e){$("#changePasswordForm").find("span.save-status").html("");$("#changePasswordForm").find('input[name="current_pswd"]').closest(".controls").append("<span style='color:red;margin-left:10px;'>Incorrect Password</span>");$("#changePasswordForm").find('input[name="current_pswd"]').closest(".controls").find("span").fadeOut(5000);$("#changePasswordForm").find('input[name="current_pswd"]').focus();enable_save_button($(f))}})})},allDomainUsers:function(){allDomainUsersCollectionView=new Base_Collection_View({url:"core/api/admin_panel/getAllDomainUsers",templateKey:"all-domain-users",individual_tag_name:"tr",cursor:true,page_size:25});allDomainUsersCollectionView.collection.fetch();$("#content").html(allDomainUsersCollectionView.el)},domainSubscribeDetails:function(c){var b=new Base_Model_View({url:"core/api/admin_panel/subscriptionofparticulardomain?d="+c,template:"all-domain-admin-subscribe-new",window:"domainSubscribe",postRenderCallback:function(d){var e=b.model.toJSON();set_up_account_stats(d);if(!$.isEmptyObject(e)){USER_BILLING_PREFS=e;USER_CREDIRCARD_DETAILS=b.model.toJSON().billingData;console.log(USER_CREDIRCARD_DETAILS);element=setPriceTemplete(e.plan.plan_type,d)}else{element=setPriceTemplete("free",d)}c=(c&&c=="coupon")?c:"";showCouponCodeContainer(c);head.load(CSS_PATH+"css/jslider.css",CSS_PATH+"css/misc/agile-plan-upgrade.css",LIB_PATH+"lib/jquery.slider.min.js",function(){if($.isEmptyObject(e)){setPlan("free")}else{setPlan(e)}load_slider(d)})}});$("#content").html(b.render().el)},purchasePlanFromAdminpanel:function(){if(!plan_json.plan){this.navigate("all-domain-users",{trigger:true});return}var c=this;var d=plan_json;var b=new Base_Model_View({url:"core/api/admin_panel/upgradesubscription",template:"admin-purchase-plan",isNew:true,data:d,postRenderCallback:function(e){showCouponDiscountAmount(plan_json,e);card_expiry(e);head.js(LIB_PATH+"lib/countries.js",function(){print_country($("#country",e))})},saveCallback:function(e){c.navigate("domainSubscribe/"+d.domain_name,{trigger:true});add_plan_change_info_as_note_to_owner(email,d.plan_type,d.plan_id,d.quantity);showNotyPopUp("information","You have been upgraded successfully. Please logout and login again for the new changes to apply.","top")}});$("#content").html(b.render().el);$(".active").removeClass("active")}});var ShopifyRouter=Backbone.Router.extend({routes:{"shopify/:shopurl":"shopify",shopify:"shopify"},shopify:function(c){var d="core/shopifyapp?shop="+c;var b={};b.shopurl=c;$.ajax({type:"GET",url:d,success:function(e){if(e){b.installed=true;$("#content").html(getTemplate("shopifyboxes",b));return}else{$.ajax({type:"POST",url:d,success:function(f){b.installed=false;$("#content").html(getTemplate("shopifyboxes",b));return}})}}})}});var DocumentsRouter=Backbone.Router.extend({routes:{documents:"documents"},documents:function(){this.DocumentCollectionView=new Base_Collection_View({url:"core/api/documents",templateKey:"documents",cursor:true,page_size:20,individual_tag_name:"tr",postRenderCallback:function(b){includeTimeAgo(b)},appendItemCallback:function(b){includeTimeAgo(b)}});this.DocumentCollectionView.collection.fetch();$("#content").html(this.DocumentCollectionView.render().el);$(".active").removeClass("active");$("#documentsmenu").addClass("active")}});var FormsRouter=Backbone.Router.extend({routes:{forms:"formSettings"},formSettings:function(){console.log("forms collection template");this.formsListView=new Base_Collection_View({url:"/core/api/forms",restKey:"forms",templateKey:"forms",individual_tag_name:"tr",postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(c){$("time.form-modified-time",c).timeago()})}});this.formsListView.collection.fetch();$("#content").html(this.formsListView.el)}});var WebreportsRouter=Backbone.Router.extend({routes:{"web-rules":"webrules","webrules-add":"web_reports_add","webrule-edit/:id":"web_reports_edit"},webrules:function(){var b=this;this.webrules=new Base_Collection_View({url:"/core/api/webrule",restKey:"webrule",templateKey:"webrule",individual_tag_name:"tr",sortKey:"position",postRenderCallback:function(c){if(b.webrules.collection&&b.webrules.collection.length==0){head.js(LIB_PATH+"lib/prettify-min.js",function(){$.ajax({url:"core/api/api-key",type:"GET",dataType:"json",success:function(d){$("#content").html(getTemplate("webrule-collection",d));prettyPrint()}})})}else{enableWebrulesSorting(c)}}});this.webrules.collection.fetch();$("#content").html(this.webrules.render().el);$(".active").removeClass("active");$("#web-rules-menu").addClass("active")},web_reports_add:function(){if(!tight_acl.checkPermission("WEBRULE")){return}var b=new Base_Model_View({url:"core/api/webrule",template:"webrules-add",window:"web-rules",isNew:true,postRenderCallback:function(c){head.js("lib/agile.jquery.chained.min.js",function(){chainFilters(c,undefined,function(){chainWebRules(c,undefined,true);$("#content").html(c)},true)})}});$("#content").html(getRandomLoadingImg());b.render()},web_reports_edit:function(f){if(!tight_acl.checkPermission("WEBRULE")){return}if(!this.webrules||!this.webrules.collection||this.webrules.collection.length==0||this.webrules.collection.get(f)==null){this.navigate("web-rules",{trigger:true});return}var c=0;var d=this.webrules.collection.get(f);var b="webrules-add";var e=new Base_Model_View({url:"core/api/webrule",model:d,template:b,window:"web-rules",postRenderCallback:function(g){if(c>0){return
}head.js("lib/agile.jquery.chained.min.js",function(){chainFilters(g,d.toJSON(),function(){chainWebRules(g,d.toJSON(),false,d.toJSON()["actions"]);$("#content").html(g)},true)});c++}});$("#content").html(getRandomLoadingImg());e.render()}});var ContactFiltersRouter=Backbone.Router.extend({routes:{"contact-filters":"contactfilters","contact-filter-add":"contactFilterAdd","contact-filter-edit/:id":"contactFilterEdit","contact-filter/:id":"showFilterContacts"},contactfilters:function(){this.contactFiltersList=new Base_Collection_View({url:"/core/api/filters",restKey:"ContactFilter",templateKey:"contact-filter",individual_tag_name:"tr",sort_collection:false,postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".created_time",b).timeago()})}});this.contactFiltersList.collection.fetch();$("#content").html(this.contactFiltersList.render().el)},contactFilterAdd:function(){var b=new Base_Model_View({url:"core/api/filters",template:"filter-contacts",isNew:"true",window:"contact-filters",postRenderCallback:function(c){head.js(LIB_PATH+"lib/agile.jquery.chained.min.js",function(){chainFiltersForContactAndCompany(c,undefined,function(){$("#content").html(c);scramble_input_names($(c).find("#filter-settings"));$("#contact_type").trigger("change")})})}});$("#content").html(LOADING_HTML);b.render()},contactFilterEdit:function(d){if(!this.contactFiltersList||this.contactFiltersList.collection.length==0||this.contactFiltersList.collection.get(d)==null){this.navigate("contact-filters",{trigger:true});return}var c=this.contactFiltersList.collection.get(d);var b=new Base_Model_View({url:"core/api/filters",model:c,template:"filter-contacts",window:"contact-filters",postRenderCallback:function(e){$(e).live("agile_model_loaded",function(f){$("#contact_type").trigger("change")});$("#content").html(LOADING_HTML);head.js(LIB_PATH+"lib/agile.jquery.chained.min.js",function(){chainFiltersForContactAndCompany(e,c.toJSON(),function(){$("#content").html(e)});scramble_input_names($(e).find("#filter-settings"))})},saveCallback:function(e){var f=readCookie("contact_filter");if(f&&f==e.id){CONTACTS_HARD_RELOAD=true}}});$("#content").html(LOADING_HTML);b.render()},showFilterContacts:function(b){if(App_Contacts){App_Contacts.contacts(undefined,b)}}});var SettingsRouter=Backbone.Router.extend({routes:{settings:"settings","user-prefs":"userPrefs","change-password":"changePassword",email:"email",imap:"imap",office:"office","social-prefs":"socialPrefs","gmail/:id":"gmailShare","email-templates":"emailTemplates","email-template-add":"emailTemplateAdd","email-template/:id":"emailTemplateEdit","notification-prefs":"notificationPrefs","scheduler-prefs":"scheduler",help:"support","contact-us":"contactUsEmail"},userPrefs:function(){$("#content").html(getTemplate("settings"),{});$("#prefs-tabs-content").html(getRandomLoadingImg());var b=new Base_Model_View({url:"/core/api/user-prefs",template:"settings-user-prefs",el:$("#prefs-tabs-content"),change:false,reload:true,postRenderCallback:function(c){setupTinyMCEEditor("textarea#WYSItextarea",true,["textcolor link image preview code"],function(){register_focus_on_tinymce("WYSItextarea")})}});$("#PrefsTab .active").removeClass("active");$(".user-prefs-tab").addClass("active")},changePassword:function(){$("#content").html(getTemplate("settings"),{});$("#prefs-tabs-content").html(getTemplate("settings-change-password"),{});$("#PrefsTab .active").removeClass("active");$(".user-prefs-tab").addClass("active");$("#saveNewPassword").on("click",function(f){f.preventDefault();var d=$(this);if($(d).attr("disabled")){return}disable_save_button($(d));var b=$(this).closest("form").attr("id");if(!isValidForm("#"+b)){enable_save_button($(d));return false}if($("#current_pswd").val()==$("#new_pswd").val()){$("#changePasswordForm").find("span.save-status").html("<span style='color:red;margin-left:10px;'>Current and New Password can not be the same</span>");$("#changePasswordForm").find("span.save-status").find("span").fadeOut(5000);enable_save_button($(d));return false}$("#changePasswordForm").find("span.save-status").html(getRandomLoadingImg());var c=serializeForm(b);$.ajax({url:"/core/api/user-prefs/changePassword",type:"PUT",data:c,success:function(){$("#changePasswordForm").find("span.save-status").html("<span style='color:green;margin-left:10px;'>Password changed successfully</span>").fadeOut(5000);enable_save_button($(d));$("#"+b).each(function(){this.reset()});history.back(-1)},error:function(e){$("#changePasswordForm").find("span.save-status").html("");$("#changePasswordForm").find('input[name="current_pswd"]').closest(".controls").append("<span style='color:red;margin-left:10px;'>Incorrect Password</span>");$("#changePasswordForm").find('input[name="current_pswd"]').closest(".controls").find("span").fadeOut(5000);$("#changePasswordForm").find('input[name="current_pswd"]').focus();enable_save_button($(d))}})})},socialPrefs:function(){$("#content").html(getTemplate("settings"),{});var d={service:"linkedin"};var c=new Base_Model_View({url:"/core/api/social-prefs/LINKEDIN",template:"settings-social-prefs",data:d});$("#prefs-tabs-content").html(c.render().el);d={service:"twitter"};var b=new Base_Model_View({url:"/core/api/social-prefs/TWITTER",template:"settings-social-prefs",data:d});$("#prefs-tabs-content").append(b.render().el);$("#PrefsTab .active").removeClass("active");$(".social-prefs-tab").addClass("active")},email:function(){$("#content").html(getTemplate("settings"),{});$("#prefs-tabs-content").html(getTemplate("settings-email-prefs"),{});var c={service:"Gmail",return_url:encodeURIComponent(window.location.href)};var b=new Base_Model_View({url:"/core/api/social-prefs/GMAIL",template:"settings-social-prefs",data:c});b.model.fetch();$("#prefs-tabs-content").find("#social-prefs").html(b.render().el);$.getJSON("/core/api/imap",function(d){$("#prefs-tabs-content").find("#imap-prefs").html($(getTemplate("settings-imap-access",d)))});$.getJSON("/core/api/office",function(d){$("#prefs-tabs-content").find("#office-prefs").html($(getTemplate("settings-office-access",d)))});$("#PrefsTab .active").removeClass("active");$(".email-tab").addClass("active");$("#office-prefs-delete, #imap-prefs-delete").live("click",function(g){g.preventDefault();var f=$(this);if($(f).attr("disabled")){return}if(!confirm("Are you sure you want to delete?")){return false}disable_save_button($(f));var d=$(f).attr("name");$.ajax({url:"/core/api/"+d,type:"DELETE",success:function(){enable_save_button($(f));App_Settings.email();return}})})},imap:function(){$("#content").html(getTemplate("settings"),{});var b=new Base_Model_View({url:"/core/api/imap",template:"settings-imap-prefs",change:false,postRenderCallback:function(h){var d=b.model;b.model.set("password","");var j="<option value='{{id}}' {{selected}}>{{name}}</option>";var f=$(".imap-share-settings-select",h).closest("div");fillSelect("imap-share-user-select","core/api/imap/shared-to-users","users",function e(){$("#imap-share-user-select .default-select",h).remove();$(".imap-share-select .loading",h).hide()},j,false,f);var c=$(".imap-folders-settings-click").closest("div");var g="<option {{selected}}>{{name}}</option>";fillSelect("imap-folders-multi-select","core/api/imap/imap-folders","folders",function e(){$("#imap-folders-multi-select .default-select").remove()},g,false,c)},saveCallback:function(){var c=b.model;var d=c.toJSON();if(typeof d.isUpdated!=="undefined"&&d.hasOwnProperty("isUpdated")&&d.isUpdated){App_Settings.navigate("email",{trigger:true})}else{b.render(true);var e=b.el;load_imap_folders(e)}}});$("#prefs-tabs-content").html(b.render().el);$("#PrefsTab .active").removeClass("active");$(".email-tab").addClass("active");$(".imap-share-settings-select").die().live("click",function(g){g.preventDefault();var f=$(this).closest("div");$(this).css("display","none");f.find(".imap-share-settings-txt").css("display","none");f.find(".imap-share-select").css("display","inline");var c="<option value='{{id}}' {{selected}}>{{name}}</option>";fillSelect("imap-share-user-select","core/api/imap/shared-to-users","users",function d(){$("#imap-share-user-select .default-select").remove()},c,false,f)});$(".imap-share-settings-cancel").die().live("click",function(f){f.preventDefault();var d=$(this).closest("div");var c=$(this).attr("name");d.find("#imap-share-user-select").empty();d.find(".imap-share-select").css("display","none");d.find(".imap-share-settings-select").css("display","inline");d.find(".imap-share-settings-txt").css("display","inline")});$(".imap-folders-settings-click").die().live("click",function(g){g.preventDefault();var f=$(this).closest("div");$(this).css("display","none");f.find(".imap-folders-select").css("display","inline");var c="<option {{selected}}>{{name}}</option>";fillSelect("imap-folders-multi-select","core/api/imap/imap-folders","folders",function d(){$("#imap-folders-multi-select .default-select").remove()},c,false,f)});$(".imap-folders-settings-cancel").die().live("click",function(d){d.preventDefault();var c=$(this).closest("div");c.find("#imap-folders-multi-select").empty();c.find(".imap-folders-select").css("display","none");c.find(".imap-folders-settings-click").css("display","inline")})},office:function(){$("#content").html(getTemplate("settings"),{});var b=new Base_Model_View({url:"/core/api/office",template:"settings-office-prefs",postRenderCallback:function(c){b.model.set("password","")},saveCallback:function(){$("#office-prefs-form").find("#office-password").val("");App_Settings.navigate("email",{trigger:true});return}});$("#prefs-tabs-content").html(b.render().el);$("#PrefsTab .active").removeClass("active");$(".email-tab").addClass("active");$(".office-share-settings-select").die().live("click",function(g){g.preventDefault();var f=$(this).closest("div");$(this).css("display","none");f.find(".office-share-settings-txt").css("display","none");f.find(".office-share-select").css("display","inline");var c="<option value='{{id}}' {{selected}}>{{name}}</option>";
fillSelect("#office-share-user-select","core/api/office/shared-to-users","users",function d(){$("#office-share-user-select .default-select").remove()},c,false,f)});$(".office-share-settings-cancel").die().live("click",function(f){f.preventDefault();var d=$(this).closest("div");var c=$(this).attr("name");d.find(".office-share-select").css("display","none");d.find(".office-share-settings-select").css("display","inline");d.find(".office-share-settings-txt").css("display","inline")})},gmailShare:function(c){$("#content").html(getTemplate("settings"),{});var b=new Base_Model_View({url:"/core/api/social-prefs/GMAIL",template:"settings-gmail-prefs-share",postRenderCallback:function(d){},saveCallback:function(){App_Settings.navigate("email",{trigger:true});return}});$("#prefs-tabs-content").html(b.render().el);$("#PrefsTab .active").removeClass("active");$(".email-tab").addClass("active");$(".gmail-share-settings-select").die().live("click",function(h){h.preventDefault();var g=$(this).closest("div");$(this).css("display","none");g.find(".gmail-share-select").css("display","inline");g.find(".gmail-share-settings-txt").css("display","none");var d="<option value='{{id}}' {{selected}}>{{name}}</option>";fillSelect("#gmail-share-user-select","core/api/social-prefs/GMAIL/shared-to-users","users",function f(){$("#gmail-share-user-select .default-select").remove()},d,false,g)});$(".gmail-share-settings-cancel").die().live("click",function(g){g.preventDefault();var f=$(this).closest("div");var d=$(this).attr("name");f.find(".gmail-share-select").css("display","none");f.find(".gmail-share-settings-select").css("display","inline");f.find(".gmail-share-settings-txt").css("display","inline")});$("#share-gmail-prefs-btn").die().live("click",function(g){g.preventDefault();var f=[];var d=b.model;$("#gmail-share-user-select :selected").each(function(e,h){f[e]=$(h).val()});d.set({shared_with_users_ids:f});d.save({},{url:"/core/api/social-prefs/GMAIL",success:function(){Backbone.history.navigate("email",{trigger:true})}})})},emailTemplates:function(){$("#content").html(getTemplate("settings"),{});this.emailTemplatesListView=new Base_Collection_View({url:"/core/api/email/templates",restKey:"emailTemplates",templateKey:"settings-email-templates",individual_tag_name:"tr",postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){console.log("In email tmplt postrender");$(".created_time",b).timeago()})}});this.emailTemplatesListView.collection.fetch();$("#prefs-tabs-content").html(this.emailTemplatesListView.el);$("#PrefsTab .active").removeClass("active");$(".email-templates-tab").addClass("active")},emailTemplateAdd:function(){$("#content").html(getTemplate("settings"),{});var b=new Base_Model_View({url:"/core/api/email/templates",isNew:true,template:"settings-email-template-add",window:"email-templates"});$("#prefs-tabs-content").html(b.render().el);setupTinyMCEEditor("textarea#email-template-html",false,undefined,function(){set_tinymce_content("email-template-html","");register_focus_on_tinymce("email-template-html")});$("#PrefsTab .active").removeClass("active");$(".email-templates-tab").addClass("active")},emailTemplateEdit:function(d){$("#content").html(getTemplate("settings"),{});if(!this.emailTemplatesListView||this.emailTemplatesListView.collection.length==0){this.navigate("email-templates",{trigger:true});return}var c=this.emailTemplatesListView.collection.get(d);var b=new Base_Model_View({url:"/core/api/email/templates",model:c,template:"settings-email-template-add",window:"email-templates"});$("#prefs-tabs-content").html(b.render().el);setupTinyMCEEditor("textarea#email-template-html",false,undefined,function(){set_tinymce_content("email-template-html",c.toJSON().text);register_focus_on_tinymce("email-template-html")});$("#PrefsTab .active").removeClass("active");$(".email-templates-tab").addClass("active")},notificationPrefs:function(){$("#content").html(getTemplate("settings"),{});var b=new Base_Model_View({url:"core/api/notifications",template:"settings-notification-prefs",reload:true,postRenderCallback:function(c){notification_prefs=b.model.toJSON();console.log("updated notification prefs are...");console.log(notification_prefs);head.load(CSS_PATH+"css/bootstrap_switch.css",LIB_PATH+"lib/bootstrapSwitch.js",LIB_PATH+"lib/desktop-notify-min.js",function(){showSwitchChanges(c);check_browser_notification_settings(c)});try{$("#notification-switch",c).bootstrapSwitch()}catch(d){console.log(d)}notification_play_button();if(navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Chrome")===-1){$("#notification-switch").parent().css("margin-top","-32px")}}});$("#prefs-tabs-content").html(b.render().el);$("#PrefsTab .active").removeClass("active");$(".notification-prefs-tab").addClass("active")},support:function(){load_clickdesk_code();$("#content").html(getTemplate("support-form"),{});try{CLICKDESK_Live_Chat.onStatus(function(c){if(c=="online"){$("#clickdesk_status").html('Chat with our support representative.<br/> <a style="cursor:pointer" onclick="CLICKDESK_LIVECHAT.show();">Start chat</a>.')}else{$("#clickdesk_status").html('No chat support representative is available at the moment. Please<br/> <a href="#contact-us" id="show_support">leave a message</a>.')}})}catch(b){setTimeout(function(){CLICKDESK_Live_Chat.onStatus(function(c){if(c=="online"){$("#clickdesk_status").html('Chat with our support representative.<br/> <a style="cursor:pointer" onclick="CLICKDESK_LIVECHAT.show();">Start chat</a>.')}else{$("#clickdesk_status").html('No chat support representative is available at the moment. Please<br/> <a href="#contact-us" id="show_support">leave a message</a>.')}})},5000)}},scheduler:function(){$("#content").html(getTemplate("settings"),{});var b=new Base_Model_View({url:"core/api/users/current-user",template:"settings-business-prefs",postRenderCallback:function(d){var e="https://"+b.model.get("domain")+".agilecrm.com/calendar/"+b.model.get("schedule_id");var c="https://"+b.model.get("domain")+".agilecrm.com/calendar/";$("#scheduleurl").attr("href",e);$("#hrefvalue").html(c);$("#schedule_id").html(b.model.get("schedule_id"));$("#scheduleurl").removeClass("nounderline");head.js(CSS_PATH+"css/businesshours/businesshours.css",CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/businesshours.js",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){var f=JSON.parse(b.model.get("business_hours"));console.log();businessHoursManager=$("#define-business-hours").businessHours({operationTime:f,postInit:function(){$(".operationTimeFrom, .operationTimeTill").timepicker({timeFormat:"H:i",step:30})}});$(".mini-time").keydown(false)})}});$("#prefs-tabs-content").html(b.render().el);$("#PrefsTab .active").removeClass("active");$(".scheduler-prefs-tab").addClass("active")},contactUsEmail:function(){$("#content").html(getTemplate("help-mail-form"),{})}});var ReferelRouter=Backbone.Router.extend({routes:{referrals:"referrelprogram"},referrelprogram:function(){head.js(LIB_PATH+"../lib/zeroclipboard/ZeroClipboard.js",function(){referelsview=new Base_Collection_View({url:"/core/api/users/getreferedbyme?reference_domain="+CURRENT_DOMAIN_USER.domain,templateKey:"referrals",individual_tag_name:"tr",postRenderCallback:function(b){initZeroClipboard("url_clip_button","referral_url")}});referelsview.collection.fetch();$("#content").html(referelsview.render().el)})}});var eventCollectionView;var googleEventCollectionView;var googleNextPageToken;var CalendarRouter=Backbone.Router.extend({routes:{calendar:"calendar",tasks:"tasks_new","tasks-new":"tasks_new"},calendar:function(){$("#content").html(getTemplate("calendar",{}));buildEventFilters();var b=readCookie("agile_calendar_view");if(b){loadGoogleEvents();loadAgileEvents()}else{$(".active").removeClass("active");$("#calendarmenu").addClass("active");$("#agile_event_list").addClass("hide");head.js(LIB_PATH+"lib/jquery-ui.min.js","lib/fullcalendar.min.js",function(){showCalendar()});$("#grp_filter").css("display","none");$("#event_tab").css("display","none")}this.tasksListView=new Base_Collection_View({url:"/core/api/tasks",restKey:"task",templateKey:"tasks",individual_tag_name:"tr",postRenderCallback:function(c){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".task-due-time",c).timeago()})}});this.tasksListView.appendItem=append_tasks;this.tasksListView.collection.fetch();$("#tasks").html(this.tasksListView.el);$("#event-list-filters").html(getTemplate("event-filter"))},tasks:function(){$("#content").html(getTemplate("tasks-list-header",{}));fillSelect("owner-tasks","/core/api/users/current-user","domainUser",function b(){$("#content").find("#owner-tasks").prepend("<li><a href=''>All Tasks</a></li>");$("#content").find("#owner-tasks").append("<li><a href='my-pending-tasks'>My Pending Tasks</a></li>");initOwnerslist()},"<li><a href='{{id}}'>My Tasks</a></li>",true);$(".active").removeClass("active");$("#calendarmenu").addClass("active")},tasks_new:function(){$("#content").html(getTemplate("new-tasks-list-header",{}));fillSelect("new-owner-tasks","/core/api/users/current-user","domainUser",function b(){$("#content").find("#new-owner-tasks").prepend("<li><a href=''>All Tasks</a></li>");$("#content").find("#new-owner-tasks").append("<li><a href='all-pending-tasks' class='hide-on-status'>All Pending Tasks</a></li>");$("#content").find("#new-owner-tasks").append("<li><a href='my-pending-tasks' class='hide-on-owner hide-on-status'>My Pending Tasks</a></li>");readDetailsFromCookie();bindDropdownEvents()},"<li><a href='{{id}}' class='hide-on-owner'>My Tasks</a></li>",true);$(".loading").remove();$(".active").removeClass("active");$("#calendarmenu").addClass("active");$(".hide-on-pending").hide()}});$(function(){$(".c_list").die().live("click",function(b){b.preventDefault();if(readCookie("event-filters")&&JSON.parse(readCookie("event-filters")).time=="future"){createCookie("agile_calendar_view","calendar_list_view_future")}else{createCookie("agile_calendar_view","calendar_list_view")
}App_Calendar.calendar()});$(".c_cal").die().live("click",function(b){b.preventDefault();eraseCookie("agile_calendar_view");App_Calendar.calendar()});$(".c_list_view_future").die().live("click",function(b){b.preventDefault();createCookie("agile_calendar_view","calendar_list_view_future");App_Calendar.calendar()});if(readCookie("agile_calendar_view")){$("#grp_filter").removeClass("hide")}$("#event_tab").tab();if(!readCookie("agile_calendar_view")){$("#agile_event_list").addClass("hide")}else{if($("#agile_event_list").hasClass("hide")){$("#agile_event_list").removeClass("hide")}}$("#taskDetailsTab").tab()});$(function(){$(".c_list").die().live("click",function(b){b.preventDefault();if(readCookie("event-filters")&&JSON.parse(readCookie("event-filters")).time=="future"){createCookie("agile_calendar_view","calendar_list_view_future")}else{createCookie("agile_calendar_view","calendar_list_view")}App_Calendar.calendar()});$(".c_cal").die().live("click",function(b){b.preventDefault();eraseCookie("agile_calendar_view");App_Calendar.calendar()});$(".c_list_view_future").die().live("click",function(b){b.preventDefault();createCookie("agile_calendar_view","calendar_list_view_future");App_Calendar.calendar()});$("#event_tab").tab();$(window).scroll(function(){if($("#google").hasClass("active")){if($(window).scrollTop()+$(window).height()==$(document).height()){loadMoreEventsFromGoogle()}}})});function appendItem1(c){var e=new Base_List_View({model:c,view:"inline",template:this.options.templateKey+"-model",tagName:"tr"});console.log(c.get("title"));var g=get_activity_created_time(c.get("start"));if(g==0){var f=$("#today-heading",this.el);$("#today-event",this.el).append(e.render().el);$("#today-event",this.el).parent("table").css("display","block");$("#today-event",this.el).show();$("#today-heading",this.el).show()}else{if(g==1){var f=$("#tomorrow-heading",this.el);$("#tomorrow-event",this.el).append(e.render().el);$("#tomorrow-event",this.el).parent("table").css("display","block");$("#tomorrow-event",this.el).show();$("#tomorrow-heading",this.el).show()}else{if(g>1){var f=$("#next-week-heading",this.el);$("#next-week-event",this.el).append(e.render().el);$("#next-week-event",this.el).parent("table").css("display","block");$("#next-week-event",this.el).show();if($("#tomorrow-event").children().length>0||$("#today-event").children().length>0){$("#next-week-heading",this.el).show()}}}}var d=$.parseJSON(readCookie("event-filters"));var b=d.owner_id;if(b!=""){$(".e_owner").addClass("hide")}else{if($(".e_owner").hasClass("hide")){$(".e_owner").removeClass("hide")}}$(".contact_text").children().last().text($(".contact_text").children().last().text().replace(",","").trim())}function appendItem2(c){var e=new Base_List_View({model:c,view:"inline",template:this.options.templateKey+"-model",tagName:"tr"});var f=$("#event-heading",this.el);$("#eventAll",this.el).append(e.render().el);$("#eventAll",this.el).parent("table").css("display","block");$("#eventAll",this.el).show();$("#event-heading",this.el).show();var d=$.parseJSON(readCookie("event-filters"));var b=d.owner_id;if(b!=""){$(".e_owner").addClass("hide")}else{if($(".e_owner").hasClass("hide")){$(".e_owner").removeClass("hide")}}$(".contact_text").children().last().text($(".contact_text").children().last().text().replace(",","").trim())}function appendGoogleEvent(b){var c=new Base_List_View({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"tr"});$("#google_event",this.el).append(c.render().el);$("#google_event",this.el).parent("table").css("display","block");$("#google_event",this.el).show();$(".contact_text").children().last().text($(".contact_text").children().last().text().replace(",","").trim())}function appendGoogleEventCategorization(b){var e=new Base_List_View({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"tr"});console.log(b.get("title"));var c=b.get("start");var g=new Date(c);var f=get_activity_created_time(g.getTime()/1000);if(f==0){$("#today-event",this.el).append(e.render().el);$("#today-event",this.el).parent("table").css("display","block");$("#today-event",this.el).show();$("#today-heading",this.el).show()}else{if(f==1){$("#tomorrow-event",this.el).append(e.render().el);$("#tomorrow-event",this.el).parent("table").css("display","block");$("#tomorrow-event",this.el).show();$("#tomorrow-heading",this.el).show()}else{if(f>1){$("#next-week-event",this.el).append(e.render().el);$("#next-week-event",this.el).parent("table").css("display","block");$("#next-week-event",this.el).show();if($("#tomorrow-event",this.el).children().length>0||$("#today-event",this.el).children().length>0){$("#next-week-heading",this.el).show()}}}}$(".contact_text").children().last().text($(".contact_text").children().last().text().replace(",","").trim())}function show_model(f){if($(window.event.target).is("a")){window.event.stopPropagation()}else{$("#updateActivityModal").modal("show");var e=eventCollectionView.collection.get(f).toJSON();console.log("clicked event "+e);var b=e.contacts;for(var d=0;d<b.length;d++){if(b[d].type=="COMPANY"){$("#updateActivityModal").find("ul[name='contacts']").append('<li class="tag" data="'+b[d].id+'" style="display: inline-block; "><a href="#contact/'+b[d].id+'">'+getCompanyName(b[d].properties)+'</a><a class="close" id="remove_tag">x</a></li>')}else{$("#updateActivityModal").find("ul[name='contacts']").append('<li class="tag" data="'+b[d].id+'" style="display: inline-block; "><a href="#contact/'+b[d].id+'">'+getName(b[d].properties)+'</a><a class="close" id="remove_tag">x</a></li>')}}var c=e.color;$("#updateActivityModal").find("select").children().each(function(){if(this.value==c){$(this).attr("selected","selected")}});if(e.allDay){$("#updateActivityModal").find("input[name='allDay']").attr("checked","checked")}else{$("#updateActivityModal").find("input[name='allDay']").removeAttr("checked")}$("#updateActivityModal").find("input[name='title']").val(e.title);highlight_event();start=getDate(e.start);end=getDate(e.end);$("#update-event-date-1").val(getFormattedDate(e.start));$("#update-event-date-2").val(getFormattedDate(e.end));if((start.getHours()==0)&&(end.getHours()==0)&&(end.getMinutes()==0)){$("#update-event-time-1").val("");$("#update-event-time-2").val("")}else{$("#update-event-time-1").val((start.getHours()<10?"0":"")+start.getHours()+":"+(start.getMinutes()<10?"0":"")+start.getMinutes());$("#update-event-time-2").val((end.getHours()<10?"0":"")+end.getHours()+":"+(end.getMinutes()<10?"0":"")+end.getMinutes())}$("#updateActivityModal").find("input[name='id']").val(f);$("#updateActivityModal").find("input[name='type']").val(e.type);populateUsersInUpdateActivityModal(e)}}function getFormattedDate(c){var b="mm/dd/yyyy";if((c/100000000000)>1){var e=new Date(parseInt(c));return e.format(b)}else{var e=new Date(parseInt(c)*1000);return e.format(b)}}function getDate(b){if((b/100000000000)>1){return new Date(parseInt(b))}else{return new Date(parseInt(b)*1000)}}function getName(e){var c;var f;var b;for(var d=0;d<e.length;d++){if(e[d].name=="first_name"){f=e[d].value}if(e[d].name=="last_name"){b=e[d].value}}c=f+" "+b;return c.replace("undefined","").trim()}function getCompanyName(d){var b;for(var c=0;c<d.length;c++){if(d[c].name=="name"){b=d[c].value}}return b}function loadAgileEvents(){var d=false;$.ajax({url:"core/api/calendar-prefs/get",async:false,success:function(f){if(f){d=true}}});var e=$.parseJSON(readCookie("event-filters"));var b=e.owner_id;var c=readCookie("agile_calendar_view");if(c=="calendar_list_view"){eventCollectionView=new Base_Collection_View({url:"core/api/events/list?ownerId="+b+"",templateKey:"events",individual_tag_name:"tr",sort_collection:true,sortKey:"start",descending:false,cursor:true,page_size:25});eventCollectionView.appendItem=appendItem2;eventCollectionView.collection.fetch();if(d){$("#agile").html(this.eventCollectionView.render().el);$("#agile_event_list").addClass("hide")}else{$("#agile_event").html(this.eventCollectionView.render().el)}}else{if(c=="calendar_list_view_future"){eventCollectionView=new Base_Collection_View({url:"core/api/events/future/list?ownerId="+b+"",templateKey:"future",individual_tag_name:"tr",sort_collection:true,sortKey:"start",descending:false,cursor:true,page_size:25});eventCollectionView.appendItem=appendItem1;eventCollectionView.collection.fetch();if(d){$("#agile").html(this.eventCollectionView.render().el);$("#agile_event_list").addClass("hide")}else{$("#agile_event").html(this.eventCollectionView.render().el)}}}}function loadGoogleEvents(){$.getJSON("core/api/calendar-prefs/get",function(b){console.log(b);if(b){createCookie("google_event_token",b.access_token);head.js("https://apis.google.com/js/client.js","/lib/calendar/gapi-helper.js",function(){setupGC(function(){gapi.auth.setToken({access_token:b.access_token,state:"https://www.googleapis.com/auth/calendar"});var d=readCookie("agile_calendar_view");if(d=="calendar_list_view"){var f=gapi.client.calendar.events.list({calendarId:"primary",maxResults:25,singleEvents:true,orderBy:"startTime"});f.execute(function(k){var j=new Array();console.log(k);for(var h=0;h<k.items.length;h++){var g=google2fcEvent(k.items[h]);console.log(g);j.push(g)}googleNextPageToken=k.nextPageToken;googleEventCollectionView=new Base_Collection_View({data:j,templateKey:"google-event",individual_tag_name:"tr",sort_collection:true,sortKey:"start",descending:false});googleEventCollectionView.appendItem=appendGoogleEvent;$("#google").html(googleEventCollectionView.render(true).el)})}else{var c=new Date();var e=c.toISOString();var f=gapi.client.calendar.events.list({calendarId:"primary",maxResults:25,singleEvents:true,timeMin:e});f.execute(function(k){var j=new Array();console.log(k);for(var h=0;h<k.items.length;h++){var g=google2fcEvent(k.items[h]);console.log(g);j.push(g)}googleEventCollectionView=new Base_Collection_View({data:j,templateKey:"googleEventCategorization",individual_tag_name:"tr",sort_collection:true,sortKey:"start",descending:false});
googleEventCollectionView.appendItem=appendGoogleEventCategorization;$("#google").html(googleEventCollectionView.render(true).el)})}});return})}else{$("#event_tab").addClass("hide");$("#agile_event").removeClass("hide")}})}function loadMoreEventsFromGoogle(){var b=readCookie("google_event_token");if(googleNextPageToken){if(b){gapi.auth.setToken({access_token:b,state:"https://www.googleapis.com/auth/calendar"});var c=gapi.client.calendar.events.list({calendarId:"primary",maxResults:20,singleEvents:true,pageToken:googleNextPageToken,orderBy:"startTime"});c.execute(function(h){var g=new Array();console.log(h);for(var f=0;f<h.items.length;f++){var e=google2fcEvent(h.items[f]);console.log(e);g.push(e)}googleNextPageToken=h.nextPageToken;var d=readCookie("agile_calendar_view");if(d=="calendar_list_view"){googleEventCollectionView.collection.add(g);googleEventCollectionView.collection.sort()}else{googleEventCollectionView.collection.add(g);googleEventCollectionView.collection.sort()}})}else{$.getJSON("core/api/calendar-prefs/get",function(d){gapi.auth.setToken({access_token:d.access_token,state:"https://www.googleapis.com/auth/calendar"});var e=gapi.client.calendar.events.list({calendarId:"primary",maxResults:1000,singleEvents:true,pageToken:googleNextPageToken});e.execute(function(k){var j=new Array();console.log(k);for(var h=0;h<k.items.length;h++){var g=google2fcEvent(k.items[h]);console.log(g);j.push(g)}googleNextPageToken=k.nextSyncToken;var f=readCookie("agile_calendar_view");if(f=="calendar_list_view"){googleEventCollectionView.collection.add(j);googleEventCollectionView.collection.sort()}else{googleEventCollectionView.collection.add(j);googleEventCollectionView.collection.sort()}})})}}}var DealsRouter=Backbone.Router.extend({routes:{deals:"deals","import-deals":"importDeals"},deals:function(){pipeline_id=0;if(readCookie("agile_deal_track")){pipeline_id=readCookie("agile_deal_track")}if(!readCookie("agile_deal_view")){template_key="opportunities-by-milestones";if(pipeline_id==1){pipeline_id=0}$("#content").html(getTemplate("new-opportunity-header",{}));if(IS_FLUID){$("#content").find("div.row").removeClass("row").addClass("row-fluid")}pipeline_count=0;deal_fetching=false;DEALS_LIST_COLLECTION=null;setupDealsTracksList();setupDealFilters()}else{DEALS_LIST_COLLECTION=null;var b="";if(readCookie("deal-filters")){b="&filters="+encodeURIComponent(getDealFilters())}this.opportunityCollectionView=new Base_Collection_View({url:"core/api/opportunity/based?pipeline_id="+pipeline_id+b,templateKey:"opportunities",individual_tag_name:"tr",sort_collection:false,cursor:true,page_size:25,postRenderCallback:function(d){if(pipeline_id==1){pipeline_id=0}var c=App_Deals.opportunityCollectionView.el;appendCustomfieldsHeaders(d);appendCustomfields(d);includeTimeAgo(d);pieMilestonesByPipeline(pipeline_id);dealsLineChartByPipeline(pipeline_id);deal_bulk_actions.init_dom(d);setupDealsTracksList(c);setupDealFilters(c)},appendItemCallback:function(c){appendCustomfields(c);includeTimeAgo(c)}});this.opportunityCollectionView.collection.fetch();$("#content").html(this.opportunityCollectionView.render().el)}$(".active").removeClass("active");$("#dealsmenu").addClass("active");setTimeout(function(){$("a.deal-notes").tooltip()},2000)},importDeals:function(){$("#content").html(getTemplate("import-deals",{}))}});var ContactViewsRouter=Backbone.Router.extend({routes:{"contact-view-prefs":"editContactView"},editContactView:function(){var b=new Base_Model_View({url:"core/api/contact-view-prefs",template:"contact-view",change:false,restKey:"contactView",window:"contacts",postRenderCallback:function(d,c){fillSelect("custom-fields-optgroup","core/api/custom-fields/scope?scope=CONTACT",undefined,function(e){head.js(LIB_PATH+"lib/jquery-ui.min.js",LIB_PATH+"lib/jquery.multi-select.js",function(){$("#multipleSelect",d).multiSelect();$(".ms-selection",d).children("ul").addClass("multiSelect").attr("name","fields_set").attr("id","fields_set").sortable();$.each(c.fields_set,function(f,g){$("#multipleSelect",d).multiSelect("select",g)})})},'<option value="CUSTOM_{{field_label}}">{{field_label}}</option>',true,d)},saveCallback:function(c){CONTACTS_HARD_RELOAD=true;App_Contacts.navigate("contacts",{trigger:true})}});$("#content").html(b.render().el)}});var VoiceMailRouter=Backbone.Router.extend({routes:{voicemail:"voicemail"},voicemail:function(){$("#content").html(getTemplate("settings"),{});$("#PrefsTab .active").removeClass("active");$(".add-widget-prefs-tab").addClass("active");this.VoiceMailCollectionView=new Base_Collection_View({url:"core/api/voicemails",templateKey:"voice-mail",cursor:true,page_size:20,individual_tag_name:"tr",postRenderCallback:function(b){includeTimeAgo(b)},appendItemCallback:function(b){includeTimeAgo(b)}});this.VoiceMailCollectionView.collection.fetch();console.log(this.VoiceMailCollectionView);$("#prefs-tabs-content").html(this.VoiceMailCollectionView.render().el)}});function initZeroClipboard(g,d){try{ZeroClipboard.setDefaults({moviePath:"/lib/zeroclipboard/ZeroClipboard.swf",allowScriptAccess:"always"})}catch(f){console.log(f);return false}var b=$("#"+d).text();var c=new ZeroClipboard();c.glue(document.getElementById(g));c.setText(b);c.options.id=g;$("#"+g).attr("data-clipboard-text",b);c.on("complete",function(e,h){var m=$(this).attr("id");var k=function(){$("#"+m).tooltip("hide").removeAttr("data-original-title")};var j=setTimeout(k,500);window.clearTimeout(j);if(!m){return false}var l=getTitleForClip(m);$("#"+m).attr({"data-placement":"right","data-original-title":l});$("#"+m).tooltip("show").off("mouseenter mouseleave");j=setTimeout(k,2000)})}function getTitleForClip(c){var b="Code copied to clipboard";switch(c){case"copy_email_to_clip_button":b="Email id copied to clipboard";break;case"api_key_code_icon":b="Key copied to clipboard";break;case"popup_clip_button":b="Code copied to clipboard";break;case"url_clip_button":b="URl copied to clipboard";break}return b}function startMakingCollection(c,b){console.log("in startMakingCollection");console.log(c+" "+b);if(c=="LIST"){displayListView();return}hideListViewAndShowLoading();if(c=="OWNER"&&GROUPING_MAP[c].type.length==0){getUserDetails(function(d){findArrayForCollection(c,b)})}else{findArrayForCollection(c,b)}}function findArrayForCollection(c,b){if(c=="CATEGORY"){getArraySortOnCount(c,GROUPING_MAP[c].type,b)}else{createNestedCollection(c,GROUPING_MAP[c].type,b)}}function createNestedCollection(h,d,f){console.log("In createNestedCollection");initTaskListCollection();var c=null;if(h=="DUE"){c="/core/api/tasks/fordue"+getParamsNew()+"&pending="+f}else{c="/core/api/tasks/forcategory"+getParamsNew()+"&pending="+f}for(var e in d){var g;var b=null;if(h=="OWNER"){b=c+"&owner="+d[e].id;g={heading:d[e].name,owner_id:d[e].id,url:b,flag:true}}else{b=c+"&type="+d[e];g={heading:d[e],url:b,flag:true}}if(!g){return}TASKS_LIST_COLLECTION.collection.add(g)}$("#new-task-list-based-condition").html(TASKS_LIST_COLLECTION.render(true).el);fetchForNextTaskList()}function initTaskListCollection(){TASKS_LIST_COLLECTION=new Base_Collection_View({restKey:"task",templateKey:"new-tasks-lists",individual_tag_name:"div",className:"list-area-wrapper",sort_collection:false,postRenderCallback:function(b){$(".loading-img",b).remove();$(".loading",b).remove();adjustHeightOfTaskListAndScroll()}});TASKS_LIST_COLLECTION.appendItem=taskAppend}function taskAppend(c){var b=new Base_List_View({model:c,view:"inline",template:"new-tasks-lists-model",tagName:"div",className:"task-trello-list",id:c.get("heading")});var d=b.render().el;$("#new-tasks-lists-model-list",this.el).append(d)}function taskFetch(d){console.log("index: "+d);var b=TASKS_LIST_COLLECTION.collection.at(d);if(!b){return}var c=new Base_Collection_View({url:b.get("url"),templateKey:"task",individual_tag_name:"div",sort_collection:false,cursor:true,page_size:20,postRenderCallback:function(f){var e=false;if(b.has("owner_id")){e=$("div[id='list-tasks-"+b.get("heading")+"-"+b.get("owner_id")+"']")[0]}else{e=$("div[id='list-tasks-"+b.get("heading")+"']")[0]}if(e){removeLoadingIcon(b.toJSON());addTaskCount(b.toJSON());if(b.has("owner_id")){initialize_infinite_scrollbar($("div[id='list-tasks-"+b.get("heading")+"-"+b.get("owner_id")+"']")[0],c)}else{initialize_infinite_scrollbar($("div[id='list-tasks-"+b.get("heading")+"']")[0],c)}}}});c.collection.fetch({success:function(e){b.set("taskCollection",c.collection);if(b.has("owner_id")){$("div[id='list-tasks-"+b.get("heading")+"-"+b.get("owner_id")+"']").html(c.render(true).el)}else{$("div[id='list-tasks-"+b.get("heading")+"']").html(c.render(true).el)}adjustHeightOfTaskListAndScroll();displaySettings();setup_sortable_tasks();FETCH_COUNTER++;fetchForNextTaskList()}})}$(function(){$(".task-add-note, .deal-add-note").live("click",function(b){b.preventDefault();var c=getTaskFormId(this);$("#forNoteForm","#"+c).html(getTemplate("note-form"));$(".deal-note-label").show();$(this).hide()})});function showNoteOnForm(c,b){console.log("showNoteOnForm");$.each(b,function(d,e){$("#notes","#"+c).append(getTemplate("notes-for-task",e))})}function get_notes(c){var b=$("#"+c+" .notes").map(function(){var d=[];$.each($(this).children(),function(e,f){d.push(($(f).attr("data")).toString())});return{name:$(this).attr("name"),value:d}}).get();return b}function setup_sortable_tasks(){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".task-model-list").sortable({connectWith:".task-model-list",cursor:"move",scroll:false,helper:"clone",placeholder:"ui-sortable-placeholder",forcePlaceholderSize:true,revert:true,start:function(c,b){b.placeholder.height(b.item.height())},beforeStop:function(b,c){if($(c.helper).closest(".task-trello-list").find(".list-header").attr("attr")===$(c.placeholder).closest(".task-trello-list").find(".list-header").attr("attr")){if($(c.helper).closest(".task-trello-list").find(".list-header").attr("ownerID")){if($(c.helper).closest(".task-trello-list").find(".list-header").attr("ownerID")===$(c.placeholder).closest(".task-trello-list").find(".list-header").attr("ownerID")){return false
}}else{return false}}},change:function(c,d){var b=$(".list-area-wrapper > div").width();var e=$(".list-area-wrapper > div").scrollLeft();if(c.pageX>(b*0.9)){$(".list-area-wrapper > div").scrollLeft(e+100)}else{if(c.pageX<(b*0.2)){$(".list-area-wrapper > div").scrollLeft(e-105)}}},update:function(b,c){if(c.sender==null){return}changeAfterDrop(b,c)}}).disableSelection()})}function changeAfterDrop(b,k){var o=k.item[0];var g=k.sender[0];var p=getTaskListId(g);var f=getTaskListId(o);var e=getTaskListOwnerId(g);var n=getTaskListOwnerId(o);var l=getCriteria();var j=false;if(l=="OWNER"&&e!=n){j=true}else{if(p!=f){j=true}}if(j){var d=GROUPING_MAP[l].searchKey;var h=$(o).find(".listed-task").attr("id");var m=getTaskList(l,p,e);var c=m[0].get("taskCollection").get(h).toJSON();updateDraggedTask(c,l,e,p,f,n,h,d);changeTaskCount(m[0].toJSON(),false)}}function updateDraggedTask(b,h,d,l,e,k,g,c){if(c=="due"){if(b.taskOwner){b.owner_id=b.taskOwner.id}b.due=getNewDueDateBasedOnTime(e,b.due)}else{if(c=="taskOwner.name"){b.owner_id=k;b.taskListOwnerId=d}else{if(b.taskOwner){b.owner_id=b.taskOwner.id}b[c]=e;if(c=="status"){b.progress=getProgressValue(e);if(e=="COMPLETED"){b.is_complete=true}else{b.is_complete=false}}}}b.taskListId=l;var j=[];$.each(b.contacts,function(n,m){j.push(m.id)});var f=[];$.each(b.notes,function(m,n){f.push(n.id)});b.contacts=j;b.notes=f;b.due=new Date(b.due).getTime();saveAfterDrop(b,h,e,k,g)}function saveAfterDrop(e,g,f,c,d){var b=new Backbone.Model();b.url="core/api/tasks";b.save(e,{success:function(k){updateTask("dragged",k,e);if(g=="OWNER"){$(".list-header[ownerID="+c+"]").parent().find("#"+d).parent().html(getTemplate("task-model",k.toJSON()))}else{$("#"+f).find("#"+d).parent().html(getTemplate("task-model",k.toJSON()))}displaySettings();var j=getTaskList(g,f,c);changeTaskCount(j[0].toJSON(),true);var h=getDueTasksCount();if(h==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}$("#due_tasks_count").html(h)}})}var TASKS_LIST_COLLECTION=null;var GROUPING_MAP={PRIORITY:{type:["HIGH","NORMAL","LOW"],searchKey:"priority_type"},CATEGORY:{type:["CALL","EMAIL","FOLLOW_UP","MEETING","MILESTONE","OTHER","SEND","TWEET"],searchKey:"type"},STATUS:{type:["YET_TO_START","IN_PROGRESS","COMPLETED"],searchKey:"status"},DUE:{type:["OVERDUE","TODAY","TOMORROW","LATER"],searchKey:"due"},OWNER:{type:[],searchKey:"taskOwner.name"}};var YET_TO_START="YET_TO_START";var IN_PROGRESS="IN_PROGRESS";var COMPLETED="COMPLETED";var flag=true;var FETCH_COUNTER=0;var IS_FECHING_DONE=false;$(function(){$(document).ready(function(){adjustHeightOfTaskListAndScroll()});$(window).resize(function(){adjustHeightOfTaskListAndScroll()});$(".listed-task").live("mouseenter",function(){$(this).find(".task-actions").css("display","block");$(this).find(".task-note-action").hide()});$(".listed-task").live("mouseleave",function(){$(this).find(".task-actions").css("display","none");$(this).find(".task-note-action").show()});$(".delete-task").die().live("click",function(b){if(!confirm("Are you sure you want to delete?")){return}deleteTask(getTaskId(this),getTaskListId(this),getTaskListOwnerId(this))});$(".is-task-complete").die().live("click",function(b){b.preventDefault();completeTask(getTaskId(this),getTaskListId(this),getTaskListOwnerId(this))});$(".edit-task").die().live("click",function(b){b.preventDefault();editTask(getTaskId(this),getTaskListId(this),parseInt(getTaskListOwnerId(this)))});$(".status").change(function(){console.log("status change event");changeStatus($(this).attr("value"),$(this).closest("form"))});$(".group-view").die().live("click",function(b){b.preventDefault();console.log("group-view event");applyDetailsFromGroupView()})});function initialize_infinite_scrollbar(c,b){console.log("initialize_infinite_scrollbar");if(c==undefined||c==null){console.log("no elmnt");return}b.infiniScroll=new Backbone.InfiniScroll(b.collection,{target:c,untilAttr:"cursor",param:"cursor",strict:false,pageSize:b.page_size,success:function(e,d){console.log("in success");if(!e.last().get("cursor")){this.strict=true;b.infiniScroll.disableFetch()}displaySettings();$(b.infiniScroll.options.target.nextElementSibling).html("")},onFetch:function(){console.log("in fetch");$(b.infiniScroll.options.target.nextElementSibling).html('<div class="scroll-loading"> <img src="/img/ajax-loader.gif" style="margin-left: 44%;"> </div>')}})}function setCursor(f,d,e){console.log("In setCursor");if(!f.get("taskCollection")||f.get("taskCollection").length==0){return d}var c=f.get("taskCollection").length;var b=f.get("taskCollection").at(c-1).get("cursor");if(b){if(e=="dragged"||e==true){d.set({cursor:b})}else{if(d.attributes){d.attributes.cursor=b}else{d.cursor=b}}}return d}function displaySettings(){displayTimeAgo($(".task-trello-list"));$(".listed-task").parent().css("padding-bottom","5px");var b=getCriteria();if(b=="CATEGORY"){$(".new-task-type").remove();$(".new-task-owner").addClass("shift-up");$(".task-body").addClass("task-body-category")}if(b=="OWNER"){$(".new-task-owner").remove();$(".task-body").addClass("task-body-owner")}}function loadProgressSlider(b){head.load(CSS_PATH+"css/jslider.css",LIB_PATH+"lib/jquery.slider.min.js",function(){$(".progress_slider",b).slider({from:0,to:100,step:1,skin:"round",onstatechange:function(c){changeProgress(c,$(".status",b).attr("value"),b)}})})}function changeStatus(c,b){var d;if(c==YET_TO_START){d=0}else{if(c==COMPLETED){d=100}else{if(c==IN_PROGRESS){d=1}}}changeProgress(d,c,b)}function changeProgress(d,c,b){$("#progress",b).val(d);showProgressSlider(d,c,b)}function showProgressSlider(d,c,b){if(d==100||c==COMPLETED){$(".status",b).val(COMPLETED);$("#progress",b).val(100);$("#is_complete",b).val(true)}else{$("#is_complete",b).val(false)}if(c==IN_PROGRESS){$(b).find(".progress-slider").css("display","block")}else{$(b).find(".progress-slider").css("display","none")}}function resetForm(b){$("#progress",b).val(0);$("#is_complete",b).val(false);$("#priority_type",b).val("NORMAL");$("#status",b).val(YET_TO_START);$(".progress_slider",b).slider("value",0)}function setForm(b){var c=$("#is_complete",b).val();if(c=="true"){showProgressSlider(100,COMPLETED,b)}else{showProgressSlider($("#progress",b).val(),$("#status",b).val(),b);$(".progress_slider",b).slider("value",$("#progress",b).val())}}function changeHeadingOfPage(b){$("#new-task-heading").html(b+'&nbsp<small class="tasks-count"></small>')}function removeLoadingIcon(b){if(b.owner_id){$("img[id='task-list-loading-img-"+b.heading+"-"+b.owner_id+"']").hide()}else{$("img[id='task-list-loading-img-"+b.heading+"-']").hide()}}function addTaskCount(d){if(!d.taskCollection){return}var b=d.taskCollection.at(0);if(!b){return}var c=b.get("count");displayTaskCount(c,d.heading,d.owner_id)}function displayTaskCount(c,d,b){if(c==0){c=""}if(b){$("span[id='task-count-"+d+"-"+b+"']").html(c);$("span[id='task-count-"+d+"-"+b+"']").attr("count",c)}else{$("span[id='task-count-"+d+"-']").html(c);$("span[id='task-count-"+d+"-']").attr("count",c)}}function changeTaskCount(e,b){var c=e.taskCollection.at(0);if(!c){return}var d=null;if(e.owner_id){d=$("span[id='task-count-"+e.heading+"-"+e.owner_id+"']").attr("count")}else{d=$("span[id='task-count-"+e.heading+"-']").attr("count")}if(d!=null){if(b){d++}else{d--}}else{d=1}displayTaskCount(d,e.heading,e.owner_id)}function dropdownintelligence(){changesOnCriteria();return changesOnOwner()}function changesOnCriteria(){var b=getCriteria();if(b=="OWNER"){$(".hide-on-status").show()}else{if(b=="STATUS"){$(".hide-on-owner").show();$(".hide-on-status").hide()}else{$(".hide-on-status").show();$(".hide-on-owner").show()}}}function changesOnOwner(){var b=$("#new-owner-tasks").data("selected_item");if(b=="all-pending-tasks"){$(".hide-on-pending").show();$(".hide-on-all-pending").hide();return true}else{if(b=="my-pending-tasks"||b==undefined){$(".hide-on-pending").hide();changeCriteriaToCategory();return true}else{if(b==CURRENT_DOMAIN_USER.id){$(".hide-on-pending").show();$(".hide-on-my-task").hide();changeCriteriaToCategory();return false}else{$(".hide-on-pending").show();return false}}}}function changeCriteriaToCategory(){var b=getCriteria();if(b!="OWNER"){return}$("#new-type-tasks").data("selected_item","CATEGORY");$("#new-type-tasks").closest(".btn-group").find(".selected_name").text("Category")}function adjustHeightOfTaskListAndScroll(){var b=$(window).height();$("#new-task-list-based-condition").height(b-155);$(".list-tasks").css("max-height",b-245)}function hideListViewAndShowLoading(){$("#new-task-list-based-condition").show();$("#task-list-based-condition").hide();$(".tasks-count").html("");$("#new-task-list-based-condition").html(LOADING_HTML)}function displayListView(){console.log("in displayListView");$("#new-task-list-based-condition").hide();$("#task-list-based-condition").show();$(".group-view").show();$(".do-onclick-nothing").hide();$(".list-view").hide();var c=getParamsNew();var b=$("#new-owner-tasks").data("selected_item");if(b==undefined){c=c+"&pending="+true}console.log("url for list view: "+c);updateData(c)}function bindDropdownEvents(){$(".dropdown-menu").find(".do-onclick-nothing").on("click",function(b){b.stopImmediatePropagation()});$("ul#new-owner-tasks li a,ul#new-type-tasks .new-type-task").on("click",function(c){c.preventDefault();hideListViewAndShowLoading();if($(".type-task-button").hasClass("open")){$(".type-task-button").removeClass("open")}var b=$(this).html(),f=$(this).attr("href");var d=$(this).closest("ul").attr("id");if(d=="new-type-tasks"){$(this).closest("ul.main-menu").data("selected_item",f)}else{$(this).closest("ul").data("selected_item",f)}$(this).closest(".btn-group").find(".selected_name").text(b);if(TASKS_LIST_COLLECTION!=null){TASKS_LIST_COLLECTION.collection.reset()}addDetailsInCookie(this);setTimeout(function(){getDetailsForCollection()},2000)});$("ul#new-owner-tasks li a").on("click",function(){changeHeadingOfPage($("#new-owner-tasks").closest(".btn-group").find(".selected_name").html())
})}function applyDetailsFromGroupView(){console.log("In applyDetailsFromGroupView");var b=readCookie("task_criteria_forgroupview");var c=readCookie("task_owner_forgroupview");console.log(b+" "+c);withoutEventChangeDropDowns(b,c,true);$(".group-view").hide();$(".do-onclick-nothing").show();$(".list-view").show();var d=$("#new-owner-tasks").data("selected_item");addDetailsInCookie($("ul#new-owner-tasks").find("a[href="+d+"]"));addDetailsInCookie($("ul#new-type-tasks").find("a[href="+getCriteria()+"]"))}function withoutEventChangeDropDowns(b,e,c){console.log("In withoutEventChangeDropDowns");console.log(b+" "+e);if(b){var d=b.split("_");console.log(d);$("#new-type-tasks").data("selected_item",d[1]);$("#new-type-tasks").closest(".btn-group").find(".selected_name").text(d[0])}if(e){var d=e.split("_");console.log(d);$("#new-owner-tasks").data("selected_item",d[1]);$("#new-owner-tasks").closest(".btn-group").find(".selected_name").text(d[0])}if(!b&&!e&&c){$("#new-type-tasks").data("selected_item","DUE");$("#new-type-tasks").closest(".btn-group").find(".selected_name").text("Due")}changeHeadingOfPage($("#new-owner-tasks").closest(".btn-group").find(".selected_name").html());getDetailsForCollection()}function addTasklListDetails(c){console.log("In addTasklListDetails");console.log(c);if(!$(c).hasClass("list-bottom")){return}switch(getCriteria()){case"STATUS":$("#status",$("#taskForm")).val($(c).attr("heading"));changeStatus($(c).attr("heading"),$("#taskForm"));break;case"CATEGORY":$("#type",$("#taskForm")).val($(c).attr("heading"));break;case"OWNER":$("#owners-list",$("#taskForm")).val($(c).attr("ownerID"));break;case"DUE":var d=getNewDueDate($(c).attr("heading"));var b=new Date(d*1000).format("mm/dd/yyyy");$("#taskForm").find("input.date").val(new Date(b).format("mm/dd/yyyy")).datepicker("update");break;case"PRIORITY":$("#priority_type",$("#taskForm")).val($(c).attr("heading"));break}}function editTask(e,d,g){console.log("editTask");var f;if(g){f=getTaskList("OWNER",d,g)}else{f=getTaskList(null,d,null)}if(!f){return}var b=f[0].get("taskCollection").get(e);if(!b){return}var c=b.toJSON();c.taskListId=d;c.taskListOwnerId=g;deserializeForm(c,$("#updateTaskForm"));$(".update-task-timepicker").val(fillTimePicker(c.due));$("#updateTaskModal").modal("show");populateUsers("owners-list",$("#updateTaskForm"),c,"taskOwner",function(h){$("#updateTaskForm").find("#owners-list").html(h);if(c.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+c.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()});showNoteOnForm("updateTaskForm",c.notes);displayTimeAgo($(".task-trello-list"))}function updateTask(d,c,b){console.log("In updateTask");var g=getCriteria();var f=b[GROUPING_MAP[g].searchKey];if(g=="DUE"){f=getHeadingForDueTask(b)}if(g=="OWNER"&&parseInt(b.taskListOwnerId)==c.get("taskOwner").id){f=b.taskListId}if(b.taskListId!=undefined){if(f!=b.taskListId){changeTaskList(c,b,g,f,d);return}}if(d==true){var e;if(g=="OWNER"){e=getTaskList(g,b.taskListId,b.taskListOwnerId)}else{e=getTaskList(null,f,null)}if(!e){return}e[0].get("taskCollection").get(b.id).set(c);if(g=="OWNER"){$(".list-header[ownerID="+b.taskListOwnerId+"]").parent().find("#"+b.id).parent().html(getTemplate("task-model",c.toJSON()))}else{$("#"+f).find("#"+b.id).parent().html(getTemplate("task-model",c.toJSON()))}displaySettings();return}if(g=="OWNER"){addTaskToTaskList(f,c.toJSON(),g)}else{addTaskToTaskList(f,c,null)}}function changeTaskList(f,d,h,g,e){console.log("In changeTaskList");var c;if(h=="OWNER"){var b;if(d.taskListOwnerId){b=parseInt(d.taskListOwnerId)}else{b=d.taskOwner.id}if(!b){return}c=getTaskList(h,d.taskListId,b);g="taskOwner.name";$(".list-header[ownerID="+b+"]").parent().find("#"+d.id).remove()}else{c=getTaskList(null,d.taskListId,null);$("#"+d.taskListId).find("#"+d.id).remove()}if(!c){return}c[0].get("taskCollection").remove(c[0].get("taskCollection").get(d.id));addTaskToTaskList(g,f,e)}function completeTask(d,e,c){var j;if(c){j=getTaskList("OWNER",e,c)}else{j=getTaskList(null,e,null)}if(!j){return}var h=j[0].get("taskCollection").get(d);var k=h.toJSON();if(k.status==COMPLETED||k.is_complete==true){return}var g=[];$.each(k.contacts,function(m,l){g.push(l.id)});var b=[];$.each(k.notes,function(l,m){b.push(m.id)});k.contacts=g;k.notes=b;k.is_complete=true;k.due=new Date(k.due).getTime();k.status=COMPLETED;k.progress=100;k.note_description="";if(k.taskOwner){k.owner_id=k.taskOwner.id}k.taskListId=e;if(c){k.taskListOwnerId=c}var f=new Backbone.Model();f.url="core/api/tasks";f.save(k,{success:function(m){var l=getDueTasksCount();if(l==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}$("#due_tasks_count").html(l);updateTask(true,m,k);displaySettings()}})}function addDetailsInCookie(f){console.log("In addDetailsInCookie");console.log($(f));var e=$(f).html();var h=$(f).attr("href");var g=null;var c=null;var d=null;var b=null;if($(f).closest("ul").attr("id")=="new-type-tasks"){g="task_criteria";d="task_criteria_forgroupview"}else{if($(f).closest("ul").attr("id")=="new-owner-tasks"){g="task_owner";d="task_owner_forgroupview"}}c=e+"_"+h;b=e+"_"+h;createCookie(g,c);if(getCriteria()!="LIST"){createCookie(d,b)}}function readDetailsFromCookie(){console.log("In readDetailsFromCookie");var b=readCookie("task_criteria");var c=readCookie("task_owner");console.log(b+" "+c);withoutEventChangeDropDowns(b,c,undefined)}function addTaskToTaskList(e,d,c){console.log("In addTaskToTaskList");var b;if(c=="OWNER"){b=getTaskList("OWNER",d.taskOwner.name,d.taskOwner.id);$(".task-list-loading-img-"+d.taskOwner.name+"-"+d.taskOwner.id,".task-trello-list").hide()}else{if((c=="dragged"||c==true)&&e=="taskOwner.name"){b=getTaskList("OWNER",d.get("taskOwner").name,d.get("taskOwner").id);$(".task-list-loading-img-"+d.get("taskOwner").name+"-"+d.get("taskOwner").id,".task-trello-list").hide()}else{b=getTaskList(null,e,null);$(".task-list-loading-img-"+e+"-",".task-trello-list").hide()}}if(!b){return}d=setCursor(b[0],d,c);if(c=="dragged"){b[0].get("taskCollection").add(d.toJSON(),{silent:true})}else{b[0].get("taskCollection").add(d);changeTaskCount(b[0].toJSON(),true)}displaySettings()}function deleteTask(c,b,f){var e;if(f){e=getTaskList("OWNER",b,f)}else{e=getTaskList(null,b,null)}if(!e){return}var d=e[0].get("taskCollection").get(c);d.url="/core/api/tasks/"+c;d.destroy({success:function(j,h){displayTimeAgo($(".task-trello-list"));changeTaskCount(e[0].toJSON(),false);var g=getDueTasksCount();if(g==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}$("#due_tasks_count").html(g)}})}function fetchForNextTaskList(){if(IS_FECHING_DONE){return}var c=getCriteria();var b=GROUPING_MAP[c].type;if(FETCH_COUNTER<b.length){taskFetch(FETCH_COUNTER)}if(FETCH_COUNTER>=b.length){IS_FECHING_DONE=true}}function getUserDetails(b){$.getJSON("/core/api/users",function(d){for(var c in d){GROUPING_MAP.OWNER.type[c]={name:d[c].name,id:d[c].id}}if(b&&typeof(b)==="function"){b()}}).error(function(c){console.log("get user err");console.log(c)})}function getHeadingForDueTask(b){var d=null;var c=get_due(b.due);if(c<0){return d="OVERDUE"}if(c==0){return d="TODAY"}if(c==1){return d="TOMORROW"}if(c>1){return d="LATER"}}function getNewDueDate(c){var b=new Date();if(c=="OVERDUE"){b.setDate(b.getDate()-1)}if(c=="TODAY"){console.log(getGMTTimeFromDate(b)/1000)}if(c=="TOMORROW"){b.setDate(b.getDate()+1)}if(c=="LATER"){b.setDate(b.getDate()+2)}console.log((getGMTTimeFromDate(b)/1000));return(getGMTTimeFromDate(b)/1000)}function getNewDueDateBasedOnTime(g,c){var f=new Date();var e=new Date(c*1000);var b=e.getSeconds()+(60*e.getMinutes())+(60*60*e.getHours());console.log(b);if(g=="OVERDUE"){f.setDate(f.getDate()-1)}if(g=="TODAY"){console.log(getGMTTimeFromDate(f)/1000)}if(g=="TOMORROW"){f.setDate(f.getDate()+1)}if(g=="LATER"){f.setDate(f.getDate()+2)}console.log((getGMTTimeFromDate(f)/1000));return(getGMTTimeFromDate(f)/1000)+b}function getProgressValue(b){if(b==YET_TO_START){return 0}else{if(b==COMPLETED){return 100}else{if(b==IN_PROGRESS){return 1}}}}function getTaskId(b){if($(b).hasClass("task-body")){return $(b).parent().attr("id")}else{return $(b).attr("data")}}function getTaskListId(b){return $(b).closest(".task-trello-list").attr("id")}function getTaskListOwnerId(b){return $(b).closest(".task-trello-list").find(".list-header").attr("ownerID")}function getCriteria(){var b=$("#new-type-tasks").data("selected_item");if(!b){b="DUE"}return b}function getTaskList(d,b,c){if(d=="OWNER"){return TASKS_LIST_COLLECTION.collection.where({heading:b,owner_id:parseInt(c)})}else{return TASKS_LIST_COLLECTION.collection.where({heading:b})}}function getTaskFormId(b){var c=$(b).closest("form").attr("id");console.log(c);return c}function getArraySortOnCount(f,d,e){var c="/core/api/tasks/countoftype"+getParamsNew()+"&pending="+e;var b={};$.each(d,function(h,j){var g=c+"&type="+d[h];$.getJSON(g,function(k){b[k.type]=k.count;if(_.size(b)==d.length){sortArray(f,b,e)}}).error(function(k){console.log("get count err");console.log(k)})})}function sortArray(f,c,d){var e=[];var b=[];for(a in c){e.push([a,c[a]])}e.sort(function(h,g){return h[1]-g[1]});e.reverse();for(a in e){b.push(e[a][0])}createNestedCollection(f,b,d)}function getDetailsForCollection(){FETCH_COUNTER=0;IS_FECHING_DONE=false;var c=dropdownintelligence();var d=getCriteria();var b=$("#new-owner-tasks").data("selected_item");startMakingCollection(d,c)}function getParamsNew(){var c="?";var d=getCriteria();if(d){c+=("&criteria="+d)}if(d=="DUE"){c+=("&start_time="+getNewDueDate("TODAY"));c+=("&end_time="+getNewDueDate("TOMORROW"))}var b=$("#new-owner-tasks").data("selected_item");if(b=="my-pending-tasks"){c+=("&pending="+true);c+=("&owner="+CURRENT_DOMAIN_USER.id);return c}if(b=="all-pending-tasks"){c+=("&pending="+true);b=""}if(b){c+=("&owner="+b)}else{if(b==undefined){c+=("&owner="+CURRENT_DOMAIN_USER.id)}}return c
}function setupCharts(b){head.js(LIB_PATH+"lib/flot/highcharts-3.js",LIB_PATH+"lib/flot/highcharts-exporting.js",LIB_PATH+"lib/flot/funnel.js",function(){if(b&&typeof(b)==="function"){b()}})}function pie(d,b,c){var e;setupCharts(function(){fetchReportData(d,function(j){var k=[];var g=0;var f=0;$.each(j,function(m,l){g+=l;f++});console.log(j,g);$.each(j,function(m,l){var n=[];n.push(m);n.push(l/g*100);k.push(n)});console.log(k);var h=f>20?false:true;e=new Highcharts.Chart({chart:{renderTo:b,type:"pie",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,marginTop:50},title:{text:c},tooltip:{backgroundColor:null,borderWidth:0,borderRadius:0,headerFormat:"",useHTML:true,enabled:true,shadow:false,formatter:function(){var l='<div class="highcharts-tool-tip"><div class="tooltip-title">'+this.point.name+'</div><div style="text-align:center;margin-top:7px;margin-left:-3px"><b>'+(this.point.percentage).toFixed(2)+"%<b></div></div>";return l},message:"Hover over chart slices<br>for more information.",positioner:function(){return{x:15,y:23}}},legend:{itemWidth:75},plotOptions:{pie:{animation:h,allowPointSelect:true,cursor:"pointer",borderWidth:0,dataLabels:{enabled:true,color:"#000000",connectorColor:"#000000",connectorWidth:0,formatter:function(){return"";if(this.percentage<=2){return""}return(this.percentage).toFixed(2)+" %"},distance:2},showInLegend:false,innerSize:"30%",size:"75%",shadow:true,borderWidth:0},series:{events:{mouseOver:function(){$(".tooltip-default-message").hide()},mouseOut:function(l){$(".tooltip-default-message").show()}}}},series:[{type:"pie",name:"Tag",data:k,startAngle:90}],exporting:{enabled:false}},function(l){l.renderer.image("img/donut-tooltip-frame.png",14,5,200,80).add();l.renderer.text(this.options.tooltip.message,50,40).attr("class","tooltip-default-message").add()})})})}function showBar(d,b,c,g,f){var e;$("#"+b).html(getRandomLoadingImg());setupCharts(function(){fetchReportData(d,function(k){var h=[];var j;$.each(k,function(m,l){h.push(m);if(j==undefined){var n=0;j=[];$.each(l,function(q,p){var o={};o.name=q;o.data=[];j[n++]=o})}$.each(l,function(q,p){var o=find_series_with_name(j,q);o.data.push(p)})});e=new Highcharts.Chart({chart:{renderTo:b,type:"column"},colors:["#4365AD","#D52A3E","gray","#1E995C"],title:{text:c},xAxis:{categories:h,tickPositioner:function(){if(this.options.categories.length>30){this.options.minTickInterval=5}},labels:{overflow:"justify"}},yAxis:{min:0,title:{text:g},stackLabels:{enabled:true,style:{fontWeight:"bold",color:(Highcharts.theme&&Highcharts.theme.textColor)||"gray"}}},legend:{align:"right",x:-100,verticalAlign:"top",y:20,floating:true,backgroundColor:(Highcharts.theme&&Highcharts.theme.legendBackgroundColorSolid)||"white",borderColor:"#CCC",borderWidth:1,shadow:false},tooltip:{formatter:function(){return"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.y}},plotOptions:{column:{stacking:f,dataLabels:{enabled:true,color:(Highcharts.theme&&Highcharts.theme.dataLabelsColor)||"white"}}},series:j})})})}function find_series_with_name(d,b){for(var c=0;c<d.length;c++){if(d[c].name==b){return d[c]}}}function showLine(d,b,c,f,g){if(typeof g==="undefined"){}else{$("#"+b).html(getRandomLoadingImg())}var e;setupCharts(function(){fetchReportData(d,function(k){var h=[];var j;$.each(k,function(m,l){if(j==undefined){var n=0;j=[];$.each(l,function(q,p){var o={};o.name=q;o.data=[];j[n++]=o})}$.each(l,function(q,p){var o=find_series_with_name(j,q);o.data.push([m*1000,p])})});e=new Highcharts.Chart({chart:{renderTo:b,type:"line",marginRight:130,marginBottom:25},title:{text:c,x:-20},xAxis:{type:"datetime",dateTimeLabelFormats:{year:"%b"},minTickInterval:24*3600*1000},yAxis:{title:{text:f},plotLines:[{value:0,width:1,color:"#808080"}],min:0},ongraphtooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.dateFormat("%e.%b",this.x)+": "+this.y.toFixed(2)}},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-10,y:100,borderWidth:0},series:j,exporting:{enabled:false}})})})}function showFunnel(d,b,c,f){if(typeof f==="undefined"){}else{$("#"+b).html(getRandomLoadingImg())}var e;setupCharts(function(){fetchReportData(d,function(h){var g=[];$.each(h,function(k,j){$.each(j,function(n,m){var l=[];l.push(n,m);g.push(l)})});console.log(g);e=new Highcharts.Chart({chart:{type:"funnel",marginRight:100,renderTo:b},title:{text:c,x:-50},plotOptions:{series:{dataLabels:{enabled:true,format:"<b>{point.name}</b> ({point.y:,.0f})",color:"black",softConnector:true},neckWidth:"30%",neckHeight:"25%"}},legend:{enabled:false},series:[{name:"Contacts",data:g}]})})})}function showCohorts(d,b,c,f,g){if(typeof g==="undefined"){}else{$("#"+b).html(getRandomLoadingImg())}var e;setupCharts(function(){fetchReportData(d,function(k){var h=k.categories;var j=k.series;e=new Highcharts.Chart({chart:{renderTo:b,type:"line",marginRight:130,marginBottom:25,zoomType:"x"},title:{text:c,x:-20},xAxis:{categories:h},yAxis:{title:{text:f},plotLines:[{value:0,width:1,color:"#808080"}],min:0},ongraphtooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.dateFormat("%e.%b",this.x)+": "+this.y.toFixed(2)}},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-10,y:100,borderWidth:0},series:j,exporting:{enabled:false}})})})}function pieTags(c,d){var b="/core/api/tags/stats";if(d){b=b+"?reload=true"}$("#pie-tags-chart",c).html(getRandomLoadingImg());pie(b,"pie-tags-chart","")}function pieMilestones(){pie("/core/api/opportunity/stats/milestones?min=0&max=1543842319","pie-deals-chart","")}function pieMilestonesByPipeline(b){pie("/core/api/opportunity/stats/milestones/"+b+"?min=0&max=1543842319","pie-deals-chart","")}function pieTasks(b){pie("core/api/tasks/stats"+b,"pie-tasks-chart","")}function dealsLineChart(){showLine("core/api/opportunity/stats/details?min=0&max=1543842319","total-pipeline-chart","Monthly Deals","Total Value")}function dealsLineChartByPipeline(b){showLine("core/api/opportunity/stats/details/"+b+"?min=0&max=1543842319","total-pipeline-chart","Monthly Deals","Total Value")}function fetchReportData(c,b){$("#plan-limit-error").hide();$.getJSON(c,function(d){if(b&&typeof(b)==="function"){b(d)}}).error(function(d){if(d.status!=406){return}if(b&&typeof(b)==="function"){b([])}$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+d.responseText+"</i></p></small></div>");$("#plan-limit-error").html($save_info).show()})}var contact_tab_position_cookie_name="contact_tab_position_"+CURRENT_DOMAIN_USER.id;var CONTACT_ASSIGNED_TO_CAMPAIGN=false;var NO_WEB_STATS_SETUP=true;var email_server_type="agilecrm";var email_server_type_cookie_name="email_server_type_"+CURRENT_DOMAIN_USER.id;function fill_company_related_contacts(c,b){$("#"+b).html(LOADING_HTML);var d=new Base_Collection_View({url:"core/api/contacts/related/"+c,templateKey:"company-contacts",individual_tag_name:"tr",cursor:true,page_size:25,sort_collection:false,postRenderCallback:function(e){}});d.collection.fetch();$("#"+b).html(d.render().el)}$(function(){var b;$('#contactDetailsTab a[href="#timeline"]').live("click",function(c){c.preventDefault();save_contact_tab_position_in_cookie("timeline");contact_details_tab.load_timeline()});$(".email-subject").die().live("click",function(d){d.preventDefault();var c=$(this).attr("href");var f=$(this).attr("id");$(".collapse-"+f).hide();$(c).collapse("toggle");$(c).on("hidden",function(){$(".collapse-"+f).show()})});$("#more-page-urls").die().live("click",function(c){c.preventDefault();$(this).css("display","none");$(this).parent().parent().find("#truncated-webstats").css("display","none");$(this).parent().parent().find("#complete-webstats").removeAttr("style")});$(".remove-active-campaign").die().live("click",function(h){h.preventDefault();if(!confirm("Are you sure to remove "+$(this).attr("contact_name")+" from "+$(this).attr("campaign_name")+" campaign?")){return}var c=$(this).closest("li").attr("data");var f;if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){f=App_Contacts.contactDetailView.model.get("id")}var d="core/api/workflows/remove-active-subscriber/"+c+"/"+f;var g=$(this);$.ajax({url:d,type:"DELETE",success:function(m){var k=App_Contacts.contactDetailView.model.toJSON();var l=k.campaignStatus;if(l!==undefined){for(var j=0,e=l.length;j<e;j++){if(c===l[j].campaign_id){l.splice(j,1);break}}}g.closest("li").remove()}})});$('#contactDetailsTab a[href="#notes"]').live("click",function(c){c.preventDefault();save_contact_tab_position_in_cookie("notes");contact_details_tab.load_notes()});$('#contactDetailsTab a[href="#events"]').live("click",function(c){c.preventDefault();save_contact_tab_position_in_cookie("events");contact_details_tab.load_events()});$('#contactDetailsTab a[href="#documents"]').live("click",function(c){c.preventDefault();save_contact_tab_position_in_cookie("documents");contact_details_tab.load_documents()});$('#contactDetailsTab a[href="#tasks"]').live("click",function(c){c.preventDefault();save_contact_tab_position_in_cookie("tasks");contact_details_tab.load_tasks()});$('#contactDetailsTab a[href="#deals"]').live("click",function(c){c.preventDefault();save_contact_tab_position_in_cookie("deals");contact_details_tab.load_deals()});$('#contactDetailsTab a[href="#cases"]').live("click",function(c){c.preventDefault();save_contact_tab_position_in_cookie("cases");contact_details_tab.load_cases()});$('#contactDetailsTab a[href="#mail"]').live("click",function(c){c.preventDefault();email_server_type="agilecrm";save_contact_tab_position_in_cookie("mail");contact_details_tab.load_mail()});$('#contactDetailsTab a[href="#stats"]').live("click",function(c){c.preventDefault();save_contact_tab_position_in_cookie("stats");contact_details_tab.load_stats()});$('#contactDetailsTab a[href="#campaigns"]').live("click",function(c){c.preventDefault();save_contact_tab_position_in_cookie("campaigns");contact_details_tab.load_campaigns()});$('#contactDetailsTab a[href="#company-contacts"]').live("click",function(c){c.preventDefault();
fill_company_related_contacts(App_Contacts.contactDetailView.model.id,"company-contacts")});$(".agile-emails").die().live("click",function(f){f.preventDefault();var c=$(this).attr("email-server");var d=$(this).attr("data-url");$("#email-type-select",App_Contacts.contactDetailView.el).html($(this).html());email_server_type=$(this).attr("email-server-type");if(c&&d&&c!="agile"){d=d.concat(email_server_type)}var g=email_server_type+"|"+c;save_email_server_type_in_cookie(g);contact_details_tab.load_mail(d,c)});$(".emailSelect").die().live("change",function(f){f.preventDefault();$("#emailForm").find(".error").removeClass("error");$("#emailForm").find(".help-inline").css("display","none");var g=$(".emailSelect option:selected").attr("value");if(!g){$("#emailForm").find('input[name="subject"]').val("");set_tinymce_content("email-body","");$("#emailForm").find('textarea[name="body"]').val("");return}var c=Backbone.Model.extend({url:"/core/api/email/templates/"+g,restKey:"emailTemplates"});var d=new c();d.fetch({success:function(m){var e=m.toJSON();var j=e.subject;var n=e.text;if(Current_Route!=="bulk-email"&&Current_Route!=="send-email"){var h=get_contact_json_for_merge_fields();var k;try{k=Handlebars.compile(j);j=k(h)}catch(l){j=add_square_brackets_to_merge_fields(j);k=Handlebars.compile(j);j=k(h)}try{k=Handlebars.compile(n);n=k(h)}catch(l){n=add_square_brackets_to_merge_fields(n);k=Handlebars.compile(n);n=k(h)}}$("#emailForm").find('input[name="subject"]').val(j);set_tinymce_content("email-body",n)}})});$("#sendEmail").die().live("click",function(g){g.preventDefault();if($(this).attr("disabled")){return}var d=$("#emailForm");if(!isValidForm(d)){return}var c=$("#attachment-select").find(":selected").attr("network_type");if(c){if(c.toUpperCase()==="GOOGLE"){return}}save_content_to_textarea("email-body");var f=serializeForm("emailForm");if((f.contact_to_ids).join()){f.to+=((f.to!="")?",":"")+(f.contact_to_ids).join()}if((f.contact_cc_ids).join()){f.email_cc+=((f.email_cc!="")?",":"")+(f.contact_cc_ids).join()}if((f.contact_bcc_ids).join()){f.email_bcc+=((f.email_bcc!="")?",":"")+(f.contact_bcc_ids).join()}if(f.to==""||f.to==null||f.to==undefined){$save_info=$('<span style="display:inline-block;color:#df382c;">This field is required.</span>');$("#emailForm").find("#to").closest(".controls > div").append($save_info);$("#emailForm").find("#to").focus();$save_info.show().delay(3000).hide(1);enable_send_button($("#sendEmail"));return}if(!isValidForm($("#emailForm"))){return}disable_send_button($(this));$.ajax({type:"POST",data:f,url:"core/api/emails/contact/send-email",success:function(){enable_send_button($("#sendEmail"));window.history.back()},error:function(e){enable_send_button($("#sendEmail"));$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+e.responseText+"</i></p></small></div>");$($("#sendEmail")).closest(".form-actions",this.el).append($save_info);if(e.status!=406){$save_info.show().delay(10000).hide(1)}}})});$("#send-email-close").die().live("click",function(c){c.preventDefault();window.history.back()});$("#email-reply").die().live("click",function(k){k.preventDefault();var l=$(this).data("from");var d=$(this).parent().parent();var g=d.find(".to-emails").data("to");var j=d.find(".cc-emails").data("cc");var c=d.find(".bcc-emails").data("bcc");var h=contact_details_tab.configured_sync_email;var f;if(h){f=h}if(f&&g){g=get_emails_to_reply(l+", "+g,f)}if(f&&j){j=get_emails_to_reply(j,f)}if(f&&c){c=get_emails_to_reply(c,f)}App_Contacts.navigate("send-email");reply_email=g;reply_email=reply_email.replace(/(, $)/g,"");if(j){j=j.replace(/(, $)/g,"")}if(c){c=c.replace(/(, $)/g,"")}App_Contacts.sendEmail(reply_email,"Re: "+d.find(".email-subject").text(),'<p></p><blockquote style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex;">'+d.find(".email-body").html()+"</blockquote>",j,c)});$("#email-reply-div").live("hover",function(c){c.preventDefault();$(this).find("#email-reply").toggle()});$(".activity-delete").die().live("click",function(k){k.preventDefault();var f=$(this).parents("li").data();if(f&&f.collection){f.collection.remove(f)}var c=$(this).attr("id");var j=$(this).attr("url");if(!j){return}var g=[];var d={};g.push(c);d.ids=JSON.stringify(g);var h=this;if($(this).find(".loading").length==0){$(this).prepend($(LOADING_HTML).addClass("pull-left").css("width","20px"))}$.ajax({url:j,type:"POST",data:d,success:function(){$(h).parents(".activity").fadeOut(400,function(){$(this).remove()});removeItemFromTimeline($("#"+c,$("#timeline")))}})});$("#cc-link, #bcc-link").die().live("click",function(c){c.preventDefault();$(this).hide();if($(this).attr("id")==="cc-link"){$("#email_cc").closest(".control-group").show();if($(this).parent().find("#bcc-link").css("display")==="none"){$(this).closest(".control-group").hide()}return}if($(this).parent().find("#cc-link").css("display")==="none"){$(this).closest(".control-group").hide()}$("#email_bcc").closest(".control-group").show()});$("#from_email_link").die().live("click",function(c){c.preventDefault();$(this).closest(".control-group").hide();$("#from_email").closest(".control-group").show();$("#from_name").closest(".control-group").show();return})});function get_property_JSON(d){var c=d.properties;var b={};$.each(c,function(e,f){b[this.name]=this.value});console.log(b);return b}function populate_send_email_details(c){$("#emailForm",c).find('input[name="from_name"]').val(CURRENT_DOMAIN_USER.name);$("#emailForm",c).find('input[name="from_email"]').val(CURRENT_DOMAIN_USER.email);var b="<option value='{{id}}'> {{#if name}}{{name}}{{else}}{{subject}}{{/if}}</option>";fillSelect("sendEmailSelect","/core/api/email/templates","emailTemplates",undefined,b,false,c,"- Fill from Template -")}function activate_timeline_tab(){$("#contactDetailsTab").find("li.active").removeClass("active");$("#contactDetailsTab li:first-child").addClass("active");$("div.tab-content").find("div.active").removeClass("active");$("div.tab-content > div:first-child").addClass("active");if(App_Contacts.contactDetailView.model.get("type")=="COMPANY"){fill_company_related_contacts(App_Contacts.contactDetailView.model.id,"company-contacts")}}function disable_send_button(b){b.css("min-width",b.width()+"px").attr("disabled","disabled").attr("data-send-text",b.text()).text("Sending...")}function enable_send_button(b){b.text(b.attr("data-send-text")).removeAttr("disabled data-send-text")}function get_web_stats_count_for_domain(){return $.ajax({type:"GET",url:"core/api/web-stats/JSAPI-status",async:false}).responseText}function save_contact_tab_position_in_cookie(c){var b=readCookie(contact_tab_position_cookie_name);if(b==c){return}createCookie(contact_tab_position_cookie_name,c)}function load_contact_tab(c,d){timeline_collection_view=null;var b=readCookie(contact_tab_position_cookie_name);$('#contactDetailsTab a[href="#'+b+'"]',c).tab("show");if(!b||b=="timeline"){activate_timeline_tab();contact_details_tab.load_timeline();return}if(contact_details_tab["load_"+b]){$(".tab-content",c).find("#"+b).addClass("active");contact_details_tab["load_"+b]()}}function get_emails_to_reply(g,c){var f=g.split(",");g="";for(var e=0,b=f.length;e<b;e++){var d=f[e].match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)[0];if(c&&d==c){continue}if(d==CURRENT_DOMAIN_USER.email){continue}g+=d;if(e<b-1){g+=", "}}return g}function save_email_server_type_in_cookie(c){if(c){var b=readCookie(email_server_type_cookie_name);if(b===c){return}createCookie(email_server_type_cookie_name,c,30)}}var notesView;var dealsView;var eventsView;var tasksView;var casesView;var documentsView;var contact_details_tab={load_timeline:function(){$("div.tab-content",App_Contacts.contactDetailView.el).find("div.active").removeClass("active");$("#time-line",App_Contacts.contactDetailView.el).addClass("active");if($("#timeline",App_Contacts.contactDetailView.el).hasClass("isotope")){$("#timeline",App_Contacts.contactDetailView.el).isotope("reLayout",function(){});return}load_timeline_details(App_Contacts.contactDetailView.el,App_Contacts.contactDetailView.model.get("id"))},load_notes:function(){var b=App_Contacts.contactDetailView.model.id;notesView=new Base_Collection_View({url:"/core/api/contacts/"+b+"/notes",restKey:"note",templateKey:"notes",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(c){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".note-created-time",c).timeago()})}});notesView.collection.fetch();$("#notes",App_Contacts.contactDetailView.el).html(notesView.el)},load_events:function(){var b=App_Contacts.contactDetailView.model.id;eventsView=new Base_Collection_View({url:"/core/api/contacts/"+b+"/events",restKey:"event",templateKey:"contact-events",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(c){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".event-created-time",c).timeago()})}});eventsView.collection.fetch();$("#events",App_Contacts.contactDetailView.el).html(eventsView.el)},load_documents:function(){id=App_Contacts.contactDetailView.model.id;documentsView=new Base_Collection_View({url:"/core/api/documents/contact/"+id+"/docs",restKey:"document",templateKey:"contact-documents",individual_tag_name:"li",sortKey:"uploaded_time",descending:true,postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".document-created-time",b).timeago()})}});documentsView.collection.fetch();$("#documents",App_Contacts.contactDetailView.el).html(documentsView.el)},load_tasks:function(){id=App_Contacts.contactDetailView.model.id;tasksView=new Base_Collection_View({url:"/core/api/contacts/"+id+"/tasks",restKey:"task",templateKey:"contact-tasks",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".task-created-time",b).timeago()})}});tasksView.collection.fetch();$("#tasks",App_Contacts.contactDetailView.el).html(tasksView.el)
},load_deals:function(){id=App_Contacts.contactDetailView.model.id;dealsView=new Base_Collection_View({url:"core/api/contacts/"+id+"/deals",restKey:"opportunity",templateKey:"deals",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".deal-created-time",b).timeago()})}});dealsView.collection.fetch();$("#deals",App_Contacts.contactDetailView.el).html(dealsView.el)},load_cases:function(){id=App_Contacts.contactDetailView.model.id;casesView=new Base_Collection_View({url:"core/api/contacts/"+id+"/cases",restKey:"cases",templateKey:"cases-contact",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".deal-created-time",b).timeago()})}});casesView.collection.fetch();$("#cases",App_Contacts.contactDetailView.el).html(casesView.el)},load_mail:function(l,j){$("#mails",App_Contacts.contactDetailView.el).html("");var f=App_Contacts.contactDetailView.model;var m=f.toJSON();var g=getAllPropertyValuesByName(m.properties,"email",",");if(!g){$("#mail",App_Contacts.contactDetailView.el).html('<div class="alert alert-error span4" style="margin-top:30px"><a class="close" data-dismiss="alert" href="#">&times;</a>Sorry! this contact has no email to get the mails.</div>');return}var h=this;var n=true;var c=true;if(j&&l){if($("#has_email_configured",App_Contacts.contactDetailView.el).html()==="true"){n=true}else{n=false}fetch_mails(h,n,l,j,g)}else{var e="";var k="";var b="";var d=new Base_Model_View({url:"core/api/emails/synced-accounts",template:"email-account-types",change:false,postRenderCallback:function(p){e=d.model.toJSON();if(e.hasEmailAccountsConfigured){n=true}else{n=false}if(e.hasSharedEmailAccounts){c=true}else{c=false}var o=fetch_mailserverurl_from_cookie(e);if(o&&o.length==4){l=o[0];k=o[1];j=o[2];b=o[3];if(b){email_server_type=b}}if(!j||!l||!b||(!n&&!c)){j="agile";k='<i class="icon-cloud" style="margin-right:4px;font-size: 1.2em"></i>Agile';email_server_type="agilecrm"}fetch_mails(h,n,l,j,g);if(n||c){if(k){$("#email-type-select",App_Contacts.contactDetailView.el).html(k)}$("#mail-account-types",App_Contacts.contactDetailView.el).css("display","block")}}});$("#mail-account-types",App_Contacts.contactDetailView.el).html(d.render().el)}},load_stats:function(){var b=App_Contacts.contactDetailView.model;var e=b.toJSON();var d=getPropertyValue(e.properties,"email");if(!d){$("#stats",App_Contacts.contactDetailView.el).html('<div class="alert alert-error span4" style="margin-top:30px"><a class="close" data-dismiss="alert" href="#">&times;</a>Sorry! this contact has no email to get the stats.</div>');return}if(!(readCookie("_agile_jsapi")!=null&&readCookie("_agile_jsapi")=="true")&&(NO_WEB_STATS_SETUP&&get_web_stats_count_for_domain()=="0")){$("#stats",App_Contacts.contactDetailView.el).html('<h4><p>You have not yet setup the Javascript API on your website.</p><p>Please <a href="#analytics-code">set it up</a> to see the contact\'s site visits here.</p></h4>');return}addTagAgile(CODE_SETUP_TAG);var c=new Base_Collection_View({url:"core/api/web-stats?e="+encodeURIComponent(d),templateKey:"stats",individual_tag_name:"li",postRenderCallback:function(f){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".stats-created-time",f).each(function(g,h){$(h).timeago()})})}});c.collection.fetch();c.collection.comparator=function(f){if(f.get("created_time")){return -f.get("created_time")}};console.log($("#stats",App_Contacts.contactDetailView.el));$("#stats",App_Contacts.contactDetailView.el).html(c.render().el)},load_campaigns:function(){var b=new Base_Collection_View({url:"/core/api/campaigns/logs/contact/"+App_Contacts.contactDetailView.model.id,restKey:"logs",templateKey:"campaigns",individual_tag_name:"li",cursor:true,page_size:20,sort_collection:false,postRenderCallback:function(c){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time.log-created-time",c).timeago()})},appendItemCallback:function(c){includeTimeAgo(c)}});b.collection.fetch();$("#campaigns",App_Contacts.contactDetailView.el).html(b.el)}};function fetch_mails(e,d,h,b,c){this.configured_sync_email="";var g=true;if(b==="agile"){h="core/api/emails/agile-emails?e="+encodeURIComponent(c);email_server_type="agilecrm";g=false}else{h=h+"&search_email="+encodeURIComponent(c)}var f=new Base_Collection_View({url:h,cursor:g,page_size:10,templateKey:"email-social",sort_collection:true,sortKey:"date_secs",descending:true,individual_tag_name:"li",postRenderCallback:function(j){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".email-sent-time",j).each(function(k,l){$(l).timeago()})});if(email_server_type!="agilecrm"){e.configured_sync_email=email_server_type}if(!d){$("#email-prefs-verification",App_Contacts.contactDetailView.el).css("display","block")}}});f.collection.fetch();$("#mails",App_Contacts.contactDetailView.el).html(f.render().el)}function fetch_mailserverurl_from_cookie(g){var e=readCookie(email_server_type_cookie_name);var l="";var h=[];if(e){var o=e.split("|");if(o){if(o.length===2){var k=o[0];var m=o[1];var f="";var b=false;if(k&&m){if(m.toLowerCase()==="google"){var j=false;if(g.hasOwnProperty("gmailUserName")&&(g.gmailUserName===k)){j=true}else{if(typeof g.sharedGmailUserNames!=="undefined"&&g.hasOwnProperty("sharedGmailUserNames")){for(var d=0;d<g.sharedGmailUserNames.length;d++){if(g.sharedGmailUserNames[d]===k){j=true;b=true;break}}}}if(j){l="core/api/social-prefs/google-emails?from_email="+k;f='<i class="icon-google-plus" style="margin-right:4px;font-size: 1.2em"></i>'+k;if(b){f=f+" (Shared)"}}}else{if(m.toLowerCase()==="imap"){var c=false;if(g.hasOwnProperty("imapUserName")&&(g.imapUserName===k)){c=true}else{if(typeof g.sharedImapUserNames!=="undefined"&&g.sharedImapUserNames.length>0){for(var d=0;d<g.sharedImapUserNames.length;d++){if(g.sharedImapUserNames[d]===k){c=true;b=true;break}}}}if(c){l="core/api/imap/imap-emails?from_email="+k;f='<i class="icon-envelope-alt" style="margin-right:4px;font-size: 1.2em"></i>'+k;if(b){f=f+" (Shared)"}}}else{if(m.toLowerCase()==="exchange"){var n=false;if(g.hasOwnProperty("exchangeUserName")&&(g.exchangeUserName===k)){n=true}else{if(g.sharedExchangeUserNames!=="undefined"&&g.hasOwnProperty("sharedExchangeUserNames")){for(var d=0;d<g.sharedExchangeUserNames.length;d++){if(g.sharedExchangeUserNames[d]===k){n=true;b=true;break}}}}if(n){l="core/api/office/office365-emails?from_email="+k;f='<i class="icon-windows" style="margin-right:4px;font-size: 1.2em"></i>'+k;if(b){f=f+" (Shared)"}}}}}if(l){h[0]=l;h[1]=f;h[2]=m;h[3]=k}}}}}return h}$(function(){$(".contact-add-task").live("click",function(c){c.preventDefault();var b=$("#taskForm");$("#activityTaskModal").modal("show");highlight_task();fill_relation(b);agile_type_ahead("task_related_to",b,contacts_typeahead);populateUsers("owners-list",$("#taskForm"),undefined,undefined,function(d){$("#taskForm").find("#owners-list").html(d);$("#owners-list",b).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#taskForm")).closest("div").find(".loading-img").hide()})});$(".contact-add-event").live("click",function(c){c.preventDefault();var b=$("#activityForm");$("#activityModal").modal("show");highlight_event();fill_relation(b);agile_type_ahead("event_related_to",b,contacts_typeahead)});$(".contact-add-note").live("click",function(c){c.preventDefault();var b=$("#noteForm");fill_relation(b);$("#noteModal").modal("show");agile_type_ahead("note_related_to",b,contacts_typeahead)});$(".contact-add-campaign, .add-to-campaign").live("click",function(d){d.preventDefault();var c=App_Contacts.contactDetailView.model.id;if($(this).attr("class")==="contact-add-campaign"){$("body").die("fill_campaigns_contact").live("fill_campaigns_contact",function(f){var e="<option value='{{id}}'>{{name}}</option>";fillSelect("campaign-select","/core/api/workflows","workflow","no-callback ",e)});Backbone.history.navigate("add-campaign",{trigger:true})}if($(this).attr("class")==="add-to-campaign"){$(this).css("display","none");$(".show_campaigns_list").css("display","inline-block");var b="<option value='{{id}}'>{{name}}</option>";fillSelect("campaign-select","/core/api/workflows","workflow","no-callback ",b)}$("#subscribe-contact-campaign, #add-to-campaign").die().live("click",function(m){m.preventDefault();var p;if($(this).attr("id")==="subscribe-contact-campaign"){p=$("#contactCampaignForm")}if($(this).attr("id")==="add-to-campaign"){p=$("#add-to-campaign-form")}if(!isValidForm(p)){return}if($(this).attr("disabled")=="disabled"){return}var l=$(this);disable_save_button(l);var j=$(this).attr("id");var f=$("#campaign-select option:selected").attr("value");var k=$("#campaign-select option:selected").text();if(is_subscriber_active(f)){var n=App_Contacts.contactDetailView.model.get("properties");var h="Contact";if(n){h=getPropertyValue(n,"first_name")}var o=h+" is already active in Campaign '"+k+"'.";showNotyPopUp("information",o,"top",10000);enable_save_button(l);return}var g="/core/api/campaigns/enroll/"+c+"/"+f;$.ajax({url:g,type:"GET",success:function(){enable_save_button(l);if(j==="add-to-campaign"){CONTACT_ASSIGNED_TO_CAMPAIGN=true;$(".show_campaigns_list").css("display","none");$(".add-to-campaign").css("display","inline-block");$('#contactDetailsTab a[href="#campaigns"]').trigger("click");return}Backbone.history.navigate("contact/"+c,{trigger:true})}})});$("#contact-close-campaign, #cancel-to-add-campaign").live("click",function(h){h.preventDefault();if($(this).attr("id")==="cancel-to-add-campaign"){var f=$("#add-to-campaign-form");var g=$("form#add-to-campaign-form").validate();g.resetForm();f.find("div.controls").removeClass("single-error");$(".show_campaigns_list").css("display","none");$(".add-to-campaign").css("display","inline-block");return}Backbone.history.navigate("contact/"+c,{trigger:true})})})});function fill_relation(d){var b=App_Contacts.contactDetailView.model.toJSON();
var c=getContactName(b);$(".tags",d).html('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+b.id+'">'+c+"</li>")}function is_subscriber_active(f){var c=App_Contacts.contactDetailView.model;if(!c){return false}var b=App_Contacts.contactDetailView.model.toJSON();var e=b.campaignStatus;if(!e){return false}for(var d=0;d<e.length;d++){if(e[d].status==f+"-ACTIVE"){return true}}return false}function starify(b){head.js(LIB_PATH+"lib/jquery.raty.min.js",function(){var c=App_Contacts.contactDetailView.model;if(App_Contacts.contactDetailView.model.get("owner")&&!canEditContact(App_Contacts.contactDetailView.model.get("owner").id)){$("#star",b).raty({readOnly:true,score:App_Contacts.contactDetailView.model.get("star_value")});return}$("#star",b).raty({click:function(f,e){App_Contacts.contactDetailView.model.set({star_value:f},{silent:true});c=App_Contacts.contactDetailView.model.toJSON();var d=new Backbone.Model();d.url="core/api/contacts";d.save(c,{success:function(g){}})},score:c.get("star_value")})})}function checkContactUpdated(){var b=App_Contacts.contactDetailView.model;var e=b.id;var d=b.attributes.updated_time;queueGetRequest("contact_queue","/core/api/contacts/"+b.id+"/isUpdated?updated_time="+d,"",function f(g){if(g=="true"){$("#refresh_contact").show()}},function c(g){})}function fill_owners(c,d,e){var b="<li><a class='contact-owner-list' data='{{id}}'>{{name}}</a></li>";fillSelect("contact-detail-owner","/core/api/users","domainUsers",e,b,true)}function show_owner(){$(".contact-owner-pic").css("visibility","visible");$("#contact-owner").css("display","inline-block")}$(function(){$("#contact-actions-delete").live("click",function(b){b.preventDefault();if(!confirm("Do you want to delete the contact?")){return}App_Contacts.contactDetailView.model.url="core/api/contacts/"+App_Contacts.contactDetailView.model.id;App_Contacts.contactDetailView.model.destroy({success:function(d,c){Backbone.history.navigate("contacts",{trigger:true})}})});$(".remove-tags").live("click",function(g){g.preventDefault();var c=$(this).attr("tag");removeItemFromTimeline($("#"+c.replace(/ +/g,"")+"-tag-timeline-element",$("#timeline")).parent(".inner"));console.log($(this).closest("li").parent("ul").append(getRandomLoadingImg()));var d=App_Contacts.contactDetailView.model.toJSON();d=delete_contact_tag(d,c);var f=this;$(this).unbind("click");var b=new Backbone.Model();b.url="core/api/contacts";b.save(d,{success:function(e){$(f).closest("li").parent("ul").find(".loading").remove();$(f).closest("li").remove();App_Contacts.contactDetailView.model.set(e.toJSON(),{silent:true});$.ajax({url:"core/api/tags/"+c,type:"DELETE",success:function(){if(tagsCollection){tagsCollection.remove(tagsCollection.where({tag:c})[0])}}})}})});$("#add-tags").live("click",function(b){b.preventDefault();$(this).css("display","none");$("#addTagsForm").css("display","block");$("#addTags").focus();setup_tags_typeahead()});$("#contact-add-tags").live("click",function(f){f.preventDefault();var d=get_new_tags("addTags");if(d){d=d.trim()}if(!d||d.length<=0||(/^\s*$/).test(d)){console.log(d);return}if(!isValidTag(d,true)){return}$("#add-tags").css("display","block");$("#addTagsForm").css("display","none");console.log(d);if(d){var c=App_Contacts.contactDetailView.model.toJSON();$("#addTagsForm input").each(function(){$(this).val("")});if($.inArray(d,c.tags)>=0){return}c.tagsWithTime.push({tag:d.toString()});var b=new Backbone.Model();b.url="core/api/contacts";b.save(c,{success:function(g){addTagToTimelineDynamically(d,g.get("tagsWithTime"));var e=[];$.each($("#added-tags-ul").children(),function(h,j){e.push($(j).attr("data"))});App_Contacts.contactDetailView.model.set(g.toJSON(),{silent:true});if($.inArray(d,e)==-1){$("#added-tags-ul").append('<li style="display:inline-block;" class="tag" data="'+d+'"><span><a class="anchor" href="#tags/'+d+'" >'+d+'</a><a class="close remove-tags" id="'+d+'" tag="'+d+'">&times</a></span></li>')}console.log(d);tagsCollection.add(new BaseModel({tag:d}))}})}});$(".contact-owner-list").live("click",function(){$("#change-owner-ul").css("display","none");var b=$(this).attr("data");var d=$(this).text();var e=$("#contact-owner").attr("data");if(b==e){show_owner();return}var c=new BaseModel();c.url="/core/api/contacts/change-owner/"+b+"/"+App_Contacts.contactDetailView.model.get("id");c.save(App_Contacts.contactDetailView.model.toJSON(),{success:function(f){$("#contact-owner").text(d);$("#contact-owner").attr("data",b);show_owner();App_Contacts.contactDetailView.model=f}})});$("#action_refresh_contact").live("click",function(){var d=App_Contacts.contactDetailView.model.id;var c=Backbone.Model.extend({url:function(){return"/core/api/contacts/"+this.id}});var b=new c();b.id=d;b.fetch({success:function(e){App_Contacts.contactDetails(d,b);$("#refresh_contact").hide()}})})});function qr_load(){head.js(LIB_PATH+"lib/downloadify.min.js",LIB_PATH+"lib/swfobject.js",function(){Downloadify.create("downloadify",{filename:function(){return agile_crm_get_contact_property("first_name")+".vcf"},data:function(){return $("#qr_code").attr("data")},onError:function(){alert("Error downloading a file!")},transparent:false,swf:"media/downloadify.swf",downloadImage:"img/download.png",width:36,height:30,transparent:true,append:false})})}function contact_detail_view_navigation(j,h,c){console.log("collection >>>>>>>>>>>>>>>>");console.log(e);var e=h.collection;var d=e.length;var g=e.indexOf(e.get(j));var b;var f;if(d<=g+5){h.infiniScroll.fetchNext()}if(d>1&&g<d&&e.at(g+1)&&e.at(g+1).has("id")){f=e.at(g+1).id}if(d>0&&g!=0&&e.at(g-1)&&e.at(g-1).has("id")){b=e.at(g-1).id}if(b!=null){$(".navigation",c).append('<a style="float:left;" href="#contact/'+b+'" class=""><i class="icon icon-chevron-left"></i></a>')}if(f!=null){$(".navigation",c).append('<a style="float:right;" href="#contact/'+f+'" class=""><i class="icon icon-chevron-right"></i></a>')}}$(function(){$(".tooltip_info").die().live("hover",function(){$(this).tooltip("show")});$("#add").live("click",function(f){f.preventDefault();var d=parseInt($("#lead-score").text());d=d+1;$("#lead-score").text(d);App_Contacts.contactDetailView.model.set({lead_score:d},{silent:true});var c=App_Contacts.contactDetailView.model.toJSON();var b=new Backbone.Model();b.url="core/api/contacts";b.save(c,{success:function(e){}})});$("#minus").live("click",function(f){f.preventDefault();var d=parseInt($("#lead-score").text());if(d<=0){return}d=d-1;$("#lead-score").text(d);App_Contacts.contactDetailView.model.set({lead_score:d},{silent:true});var c=App_Contacts.contactDetailView.model.toJSON();var b=new Backbone.Model();b.url="core/api/contacts";b.save(c,{success:function(e){}})});$("#score").children().attr("unselectable","on");$("#element").live("mouseenter",function(b){b.preventDefault();$(this).popover({template:'<div class="popover"><div class="arrow"></div><div class="popover-inner"><div class="popover-content"><p></p></div></div></div>'});$(this).popover("show")});$("#element-title").live("mouseenter",function(b){b.preventDefault();$(this).popover("show")});$("#change-owner-element > #contact-owner").live("click",function(b){b.preventDefault();fill_owners(undefined,undefined,function(){$("#contact-owner").css("display","none");$("#change-owner-ul").css("display","inline-block");if($("#change-owner-element > #change-owner-ul").css("display")=="inline-block"){$("#change-owner-element").find(".loading").remove()}})});$("#change-owner-element > .contact-owner-add").live("click",function(b){b.preventDefault();fill_owners(undefined,undefined,function(){$(".contact-owner-add").css("display","none");$("#change-owner-ul").css("display","inline-block");$("#change-owner-ul").addClass("open");if($("#change-owner-element > #change-owner-ul").css("display")=="inline-block"){$("#change-owner-element").find(".loading").remove()}})});$("#disable_map_view").die().live("click",function(b){b.preventDefault();if(islocalStorageHasSpace()){localStorage.setItem("MAP_VIEW","disabled")}$("#map").css("display","none");$("#contacts-local-time").hide();$("#map_view_action").html("<i class='icon-plus text-xxs c-p' title='Show map' id='enable_map_view'></i>")});$("#enable_map_view").die().live("click",function(b){b.preventDefault();if(islocalStorageHasSpace()){localStorage.setItem("MAP_VIEW","enabled")}show_map()})});var forceCompany={};$(function(){$("#personModal").on("show",function(b){if(forceCompany.doit==true){$("#personForm [name='contact_company_id']").html('<li class="tag"  style="display: inline-block;" data="'+forceCompany.id+'"><a href="#contact/'+forceCompany.id+'" id="contact_company_autofilled">'+forceCompany.name+"</a></li>");$("#personForm #contact_company").hide();forceCompany.doit=false}else{$("#personForm [name='contact_company_id']").html("");$("#personForm #contact_company").show();$("#personForm #contact_company").val("");$("#personForm input").val("")}});$("#companyModal").on("show",function(b){var c=b.target;add_custom_fields_to_form({},function(e){var d=show_custom_fields_helper(e.custom_fields,[]);$("#custom-field-deals",$(c)).html(d);$(".date_input",$(c)).attr("placeholder","MM/DD/YYYY");$(".date_input",$(c)).datepicker({format:"mm/dd/yyyy"})},"COMPANY")});$("#personModal").on("shown",function(c){setup_tags_typeahead();var b=$("#personForm #contact_company").attr("display");if(b!="none"){var d=function(f,e){$("#personForm [name='contact_company_id']").html('<li class="tag"  style="display: inline-block;" data="'+f+'"><a href="#contact/'+f+'" id="contact_company_autofilled">'+e+'</a><a class="close" id="remove_tag">&times</a></li>');$("#personForm #contact_company").hide()};agile_type_ahead("contact_company",$("#personForm"),contacts_typeahead,d,"type=COMPANY","<b>No Results</b> <br/> Will add a new one")}});$("#personForm [name='contact_company_id'] a.close").live("click",function(b){$("#personForm #contact_company").show()});$("#person_validate").live("click",function(b){serialize_and_save_continue_contact(b,"personForm","personModal",false,true,this,"tags_source_person_modal")
});$("#import-link").live("click",function(b){Backbone.history.navigate("import",{trigger:true})});$("#company_validate").live("click",function(b){serialize_and_save_continue_contact(b,"companyForm","companyModal",false,false,this)});$("#personModal").on("hidden",function(){$("#personModal").find(".alert").hide();remove_validation_errors("personModal");$("#personModal input").val("")});$("#companyModal").on("hidden",function(){remove_validation_errors("companyModal");$("#companyModal input").val("")})});function remove_validation_errors(b){$("#"+b).find("div.control-group").removeClass("error");$("#"+b).find("div.control-group").removeClass("success");$("#"+b).find("span.help-inline").remove()}$(function(){$(".add-attachment-select").die().live("click",function(f){f.preventDefault();var d=$(this).closest("div");$(this).css("display","none");d.find(".attachment-document-select").css("display","inline");var b="<option value='{{id}}' network_type='{{titleFromEnums network_type}}'>{{name}}</option>";fillSelect("#attachment-select","core/api/documents/","documents",function c(){},b,false,d)});$(".add-attachment-cancel").die().live("click",function(c){c.preventDefault();$("#attachment-select").closest("span").find(".attachment-status").find("span").fadeOut(0);$("#attachment-select").css({border:"1px solid #bbb"});$("#attachment-select").find("option:first").attr("selected","selected");var b=$(this).closest("div");b.find(".attachment-document-select").css("display","none");b.find(".add-attachment-select").css("display","inline")});$("#attachment-select").live("change",function(c){c.preventDefault();var b=$(this).find(":selected").attr("network_type");if(b){if(b.toUpperCase()==="GOOGLE"){$(this).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>Can not attach Google Drive doc to email. You can add a link instead in the email.</span>");$(this).css({border:"1px solid #df382c",outline:"none"})}else{$(this).closest("span").find(".attachment-status").find("span").fadeOut(0);$(this).css({border:"1px solid #bbb"})}}else{$(this).closest("span").find(".attachment-status").find("span").fadeOut(0);$(this).css({border:"1px solid #bbb"})}})});function show_error(c,f,b,g){var d=$("#"+c);var e=$("#"+f);if(d.css("display")!=="none"){d.find("."+b).html('<div class="alert alert-error" ><a class="close" data-dismiss="alert" href="#">&times</a>'+g+"</div>").show()}else{if(e.css("display")!=="none"){e.find("."+b).html('<div class="alert alert-error" ><a class="close" data-dismiss="alert" href="#">&times</a>'+g+"</div>").show()}}}function show_error_in_formactions(c,g,b,h){var e=$("#"+c);var f=$("#"+g);var d=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+h+"</i></p></small></div>");if(e.css("display")!=="none"){e.find("."+b).html(d).show().delay(3000).hide(1)}else{if(f.css("display")!=="none"){f.find("."+b).html(d).show().delay(3000).hide(1)}}}function serialize_and_save_continue_contact(z,x,b,c,C,h,B){z.preventDefault();var f=$("#"+x);if($(h).attr("disabled")||!isValidForm(f)){var k=$(h).closest("form").find(".single-error").first();var m=f;$("body").scrollTop(k.offset().top-m.offset().top+m.scrollTop());return}disable_save_button($(h));var g=[];var p=$("#"+x+" input[name=id]").val();var D=$("#"+x+" input[name=created_time]").val();var l={};var g=[];if(p){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model!=null&&App_Contacts.contactDetailView.model.get("id")==p){l=App_Contacts.contactDetailView.model.toJSON()}else{if(App_Contacts.contactsListView&&App_Contacts.contactsListView.collection.get(p)!=null){l=App_Contacts.contactsListView.collection.get(p).toJSON()}else{if(App_Contacts.contact_custom_view&&App_Contacts.contact_custom_view.collection.get(p)!=null){l=App_Contacts.contact_custom_view.collection.get(p).toJSON()}}}}var E;var u=$("#"+x).find(".custom_field");var d=[];$.each(u,function(H,I){var J=$(I).attr("id"),e=$(I).attr("name");d.push(e);if(isValidField(J)){g.push(custom_Property_JSON(e,"CUSTOM",x))}});if(C){E="continue-contact";l.type="PERSON";if(isValidField(x+" #fname")){g.push(property_JSON("first_name",x+" #fname"))}if(isValidField(x+" #lname")){g.push(property_JSON("last_name",x+" #lname"))}if(isValidField(x+" #image")){g.push(property_JSON("image",x+" #image"))}var j=$("#"+x+" [name='contact_company_id']").find("li");if(j&&j.length){var G=$(j.get(0)).attr("data");var q=$(j.get(0)).find("a:first").text();l.contact_company_id=G;g.push({type:"SYSTEM",name:"company",value:q})}else{if(isValidField(x+" #contact_company")){if(f.find("#contact_company").attr("value").length>100){show_error(b,x,"duplicate-email","Company name too long. Please restrict upto 100 characters.");enable_save_button($(h));return}l.contact_company_id=null;g.push(property_JSON("company",x+" #contact_company"))}else{l.contact_company_id=null}}if(isValidField(x+" #email")){g.push(property_JSON("email",x+" #email"))}if(isValidField(x+" #phone")){g.push(property_JSON("phone",x+" #phone"))}if(isValidField(x+" #job_title")){g.push(property_JSON("title",x+" #job_title"))}if(B===undefined||!B||B.length<=0){B=x}var n=get_tags(B);if(n!=undefined&&n.length!=0){l.tags=[];var y=true;if(!l.tagsWithTime||l.tagsWithTime.length==0){$.each(n[0].value,function(e,H){if(!isValidTag(H,false)){y=false;return false}});l.tagsWithTime=[];$.each(n[0].value,function(e,H){l.tagsWithTime.push({tag:H})})}else{var t=[];$.each(n[0].value,function(e,H){var I=true;$.each(l.tagsWithTime,function(K,J){if(H==J.tag){t.push(J);I=false;return false}});if(I){t.push({tag:H});if(!isValidTag(H,false)){y=false;return false}}});l.tagsWithTime=t}if(!y){$(".invalid-tags-person").show().delay(6000).hide(1);enable_save_button($(h));return false}}}else{E="continue-company";l.type="COMPANY";if(isValidField("company_name")){var F=f.find("#company_name").attr("value");if(F.length>100){show_error(b,x,"duplicate-email","Company name too long. Please restrict upto 100 characters.");enable_save_button($(h));return}if(!p){var v=isCompanyExist(F);if(v){show_error(b,x,"duplicate-email","Company name already exist.");enable_save_button($(h));return}else{g.push(property_JSON("name",x+" #company_name"))}}else{g.push(property_JSON("name",x+" #company_name"))}}if(isValidField(x+" #company_url")){g.push(property_JSON("url",x+" #company_url"))}}$("#"+x+" div.multiple-template").each(function(I,J){if($(J).attr("data")=="address"){var L={};var e;$.each($(J).children(":not(br)"),function(N,M){if($(M).val()==undefined||$(M).val().length==0){return}if($(M).attr("name")=="address-type"){e=$(M).val()}else{L[$(M).attr("name")]=$(M).val()}});if($.isEmptyObject(L)){return}g.push({name:$(J).attr("data"),value:JSON.stringify(L),subtype:e})}else{var K=$(J).find("input");var H=$(J).find("select");if(K.val()==undefined||K.val().trim().length==0){return}if(!$(J).find("input").parents("div.controls").hasClass("hide")){g.push({name:$(J).attr("data"),value:K.val(),subtype:H.val()})}}});if(l.properties){var o=g;$.each(l.properties,function(H,e){$.each(o,function(J,I){if(I.name==e.name){return false}else{if(J==(o.length-1)&&d.indexOf(e.name)==-1&&e.type=="CUSTOM"){g.push(e)}}})})}var s=[];s.push({name:"properties",value:g});for(var w=0;w<s.length;++w){l[s[w].name]=s[w].value}if(p!=null){l.id=p}l.created_time=D;var A=new BaseModel();A.url="core/api/contacts";A.save(l,{success:function(e){localStorage.removeItem("Agile_linkedin_matches_"+e.get("id"));localStorage.removeItem("Agile_twitter_matches_"+e.get("id"));enable_save_button($(h));add_contact_to_view(App_Contacts.contactsListView,e,l.id);if(n!=undefined&&n.length!=0){$.each(n[0].value,function(I,H){console.log(tagsCollection);tagsCollection.add(new BaseModel({tag:H}))})}$("#"+b).find("img.person-img").remove();if(c){add_custom_fields_to_form(e.toJSON(),function(H){console.log(H);deserialize_contact(H,E)},e.toJSON()["type"])}else{if(App_Contacts.contactDetailView){App_Contacts.contactDetailView.model=e}App_Contacts.navigate("contact/"+e.id,{trigger:true})}$("#"+b).modal("hide");$("#"+x).each(function(){this.reset()});$(".tagsinput",$("#"+b)).empty()},error:function(H,e){enable_save_button($(h));if(e.status==400){var I=e.responseText.split("|")[1];if(!I){I=""}show_error(b,x,"duplicate-email",e.responseText)}else{if(e.status==403){show_error_in_formactions(b,x,"form-action-error",e.responseText)}else{show_error(b,x,"duplicate-email",e.responseText)}}}});return l}function deserialize_contact(b,d){var e=$("#content").html(getTemplate(d,b));$(".date_input").attr("placeholder","MM/DD/YYYY");$(".date_input").datepicker({format:"mm/dd/yyyy"});setup_tags_typeahead();$.each(b.properties,function(h,j){if(j.type=="CUSTOM"&&j.name!="website"){return}$($("#"+e.attr("id")+" div.multiple-template."+j.name).closest("div.controls.second")).remove();var g=$("#"+e.attr("id")+" div.multiple-template."+j.name);fill_multi_options(g,j)});var f=function(h,g){$("#content [name='contact_company_id']").html('<li class="tag"  style="display: inline-block;" data="'+h+'"><a href="#contact/'+h+'">'+g+'</a><a class="close" id="remove_tag">&times</a></li>');$("#content #contact_company").hide()};agile_type_ahead("contact_company",$("#content"),contacts_typeahead,f,"type=COMPANY","<b>No Results</b> <br/> Will add a new one");if(b.contact_company_id&&b.contact_company_id.length>0){for(var c=0;c<b.properties.length;++c){if(b.properties[c].name=="company"){$("#content #contact_company").hide();$("#content [name='contact_company_id']").html('<li class="tag"  style="display: inline-block;" data="'+b.contact_company_id+'"><a href="#contact/'+b.contact_company_id+'">'+b.properties[c].value+'</a><a class="close" id="remove_tag">&times</a></li>')}}}}function fill_multi_options(b,d){if(d.type=="CUSTOM"&&d.name!="website"){return}if(d.name=="address"){var c=JSON.parse(d.value);$.each($(b).children(":not(br)"),function(j,g){var h=$(g).attr("name");if(h=="address-type"){$(g).val(d.subtype)}else{if(h=="country"){if(c[h]&&c[h].length>2){$("#country").remove();
$(b).append('<input type="text" name="country" id="country" placeholder="country">');$("#country").val(c[h])}else{$(g).val(c[h])}}else{$(g).val(c[h])}}})}else{var f=$(b).parents("div.control-group");var e=f.children().siblings("div.controls:first").clone().removeClass("hide");$(e).find("input").val(d.value).attr("name",d.value);$(e).find("select").val(d.subtype);e.appendTo(f)}}function custom_Property_JSON(c,f,b){var d={};d.name=c;d.type=f;var h=$("#"+b).find('*[name="'+c+'"]');var e=h.attr("type"),g;console.log(e);if(e=="checkbox"){g=h.is(":checked")?"on":"off"}else{if(h.hasClass("date_input")){g=new Date(h.val()).getTime()/1000}else{g=h.val()}}d.value=g;return d}$(function(){$("#content [name='contact_company_id'] a.close").live("click",function(){$("#content #contact_company").show();$("#content [name='contact_company_id']").html("")});$("a.multiple-add").die().live("click",function(b){b.preventDefault();$(this).parents("div.control-group").append($(this).parents().siblings("div.controls:first").clone().removeClass("hide"))});$("a.multiple-remove").live("click",function(b){b.preventDefault();$(this).closest("div.multiple-template").remove()});$("#continue-contact").click(function(b){serialize_and_save_continue_contact(b,"personForm","personModal",true,true,this,"tags_source_person_modal")});$("#update").die().live("click",function(b){serialize_and_save_continue_contact(b,"continueform","personModal",false,true,this,"tags_source_continue_contact")});$("#close").live("click",function(b){b.preventDefault();var c=$("#continueform input[name=id]").val();if(c){Backbone.history.navigate("contact/"+c,{trigger:true})}});$("#continue-company").click(function(b){serialize_and_save_continue_contact(b,"companyForm","companyModal",true,false,this)});$("#company-update").die().live("click",function(b){serialize_and_save_continue_contact(b,"continueCompanyForm","companyModal",false,false,this)})});function add_contact_to_view(d,b,c){if(!d){return}if(b.get("type")=="COMPANY"){if(d.collection.get(b.id)!=null){d.collection.get(b.id).set(b)}else{if(readCookie("company_filter")){add_model_cursor(d.collection,b)}else{if(c){CONTACTS_HARD_RELOAD=true}}}}else{if(!readCookie("company_filter")){if(!readCookie("contact_filter")){if(d.collection.get(b.id)!=null){d.collection.get(b.id).set(b)}else{add_model_cursor(d.collection,b)}}else{CONTACTS_HARD_RELOAD=true}}}}function add_model_cursor(c,b){if(c.models.length>=1){c.add(b,{at:c.models.length-1})}else{c.add(b)}if(c.at(0).attributes.count){c.at(0).attributes.count+=1}}function isCompanyExist(c){var b=false;$.ajax({url:"core/api/contacts/company/validate/"+c,async:false,success:function(d){if(d==="true"){b=true}}});return b}$(function(){$(".edit-note").die().live("click",function(f){f.preventDefault();console.log($(this).attr("data"));var d=notesView.collection.get($(this).attr("data"));console.log(d);$("#noteUpdateModal").remove();var c=$("#noteModal").clone();$("#noteForm > fieldset",c).prepend('<input name="id" type="hidden"/>');$("#noteForm > fieldset",c).prepend('<input name="created_time" type="hidden"/>');$("#noteForm",c).parent().parent().find(".modal-header > h3").html('<i class="icon-edit"></i>&nbsp;Edit Note');$("#noteForm",c).attr("id","noteUpdateForm");c.attr("id","noteUpdateModal");agile_type_ahead("note_related_to",$("#noteUpdateForm",c),contacts_typeahead);$("#note_validate",c).attr("id","note_update");deserializeForm(d.toJSON(),$("#noteUpdateForm",c));c.modal("show")});$("#note_update").live("click",function(d){d.preventDefault();if($(this).attr("disabled")){return}disable_save_button($(this));if(!isValidForm("#noteUpdateForm")){enable_save_button($(this));return}var c=serializeForm("noteUpdateForm");b($("#noteUpdateForm"),$("#noteUpdateModal"),this,c)});$("#note_validate").live("click",function(d){d.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm("#noteForm")){return}disable_save_button($(this));var c=serializeForm("noteForm");console.log(c.from_task);if(c.from_task=="true"){saveNoteOfTask($("#noteForm"),$("#noteModal"),this,c)}else{b($("#noteForm"),$("#noteModal"),this,c)}});$("#show-note").live("click",function(d){d.preventDefault();$("#noteModal").modal("show");var c=$("#noteForm");agile_type_ahead("note_related_to",c,contacts_typeahead)});$("#noteModal").on("hidden",function(){$("#noteForm").find("li").remove();$("#from_task","#noteForm").val("");$("#task_form","#noteForm").val("");remove_validation_errors("noteModal")});function b(f,e,c,d){console.log(d);var g=new Backbone.Model();g.url="core/api/notes";g.save(d,{success:function(j){enable_save_button($(c));f.each(function(){this.reset()});e.modal("hide");var h=j.toJSON();console.log(h);console.log(notesView.collection.toJSON());if(notesView&&notesView.collection){if(notesView.collection.get(h.id)){notesView.collection.get(h.id).set(new BaseModel(h))}else{notesView.collection.add(new BaseModel(h),{sort:false});notesView.collection.sort()}}if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){$.each(h.contacts,function(l,k){if(k.id==App_Contacts.contactDetailView.model.get("id")){add_entity_to_timeline(j);return false}})}}})}});var existingDocumentsView;$(function(){$(".task-edit-contact-tab").die().live("click",function(c){c.preventDefault();var d=$(this).attr("data");var b=tasksView.collection.get(d).toJSON();deserializeForm(b,$("#updateTaskForm"));$("#updateTaskModal").modal("show");$(".update-task-timepicker").val(fillTimePicker(b.due));populateUsers("owners-list",$("#updateTaskForm"),b,"taskOwner",function(e){$("#updateTaskForm").find("#owners-list").html(e);if(b.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+b.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()});showNoteOnForm("updateTaskForm",b.notes)});$(".event-edit-contact-tab").die().live("click",function(c){c.preventDefault();var d=$(this).attr("data");var b=eventsView.collection.get(d).toJSON();deserializeForm(b,$("#updateActivityForm"));$("#updateActivityModal").modal("show");$(".update-start-timepicker").val(fillTimePicker(b.start));$(".update-end-timepicker").val(fillTimePicker(b.end));populateUsersInUpdateActivityModal(b)});$(".complete-task").die().live("click",function(c){c.preventDefault();if($(this).is(":checked")){var d=$(this).attr("data");var b=this;complete_task(d,tasksView.collection,undefined,function(e){$(b).fadeOut();$(b).siblings(".task-subject").css("text-decoration","line-through");console.log($(b).parents(".activity-text-block").css("background-color","#FFFAFA"))})}});$(".contact-add-deal").die().live("click",function(f){f.preventDefault();var d=$("#opportunityForm");$("#opportunityModal").modal("show");add_custom_fields_to_form({},function(g){var e=show_custom_fields_helper(g.custom_fields,[]);$("#custom-field-deals",$("#opportunityModal")).html($(e))},"DEAL");populateUsers("owners-list",d,undefined,undefined,function(e){$("#opportunityForm").find("#owners-list").html(e);$("#owners-list",$("#opportunityForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#opportunityForm")).closest("div").find(".loading-img").hide()});agile_type_ahead("relates_to",d,contacts_typeahead);populateTrackMilestones(d,undefined,undefined,function(e){console.log(e);$.each(e,function(g,h){if(h.isDefault){var j=h.id+"_";if(h.milestones.length>0){j+=h.milestones.split(",")[0];$("#pipeline_milestone",d).val(j);$("#pipeline",d).val(h.id);$("#milestone",d).val(h.milestones.split(",")[0])}}})});$("#close_date",d).datepicker({format:"mm/dd/yyyy"});var b=App_Contacts.contactDetailView.model.toJSON();var c=getContactName(b);$(".tags",d).append('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+b.id+'">'+c+"</li>")});$(".deal-edit-contact-tab").die().live("click",function(b){b.preventDefault();var c=$(this).attr("data");updateDeal(dealsView.collection.get(c))});$(".contact-add-case").die().live("click",function(c){c.preventDefault();var b=$("#casesForm");populateUsers("owners-list",b,undefined,undefined,function(f){$("#casesForm").find("#owners-list").html(f);$("#owners-list",$("#casesForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");agile_type_ahead("contacts-typeahead-input",b,contacts_typeahead);$("#close_date",b).datepicker({format:"mm/dd/yyyy"});var d=App_Contacts.contactDetailView.model.toJSON();var e=getContactName(d);$(".tags",b).append('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+d.id+'">'+e+"</li>");$("#casesModal").modal("show")})});$(".cases-edit-contact-tab").die().live("click",function(b){b.preventDefault();var c=$(this).attr("data");updatecases(casesView.collection.get(c))});$(".contact-add-contact").die().live("click",function(c){c.preventDefault();var b=App_Contacts.contactDetailView.model.toJSON();forceCompany.name=getContactName(b);forceCompany.id=b.id;forceCompany.doit=true;$("#personModal").modal("show")});$(".contact-add-document").die().live("click",function(f){f.preventDefault();var d=$("#uploadDocumentForm");$("#uploadDocumentModal").modal("show");agile_type_ahead("document_relates_to_contacts",d,contacts_typeahead);agile_type_ahead("document_relates_to_deals",d,deals_typeahead,false,null,null,"core/api/search/deals",false,true);var b=App_Contacts.contactDetailView.model.toJSON();var c=getContactName(b);$(".tags",d).append('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+b.id+'">'+c+"</li>")});$(".document-edit-contact-tab").die().live("click",function(b){b.preventDefault();var c=$(this).attr("data");updateDocument(documentsView.collection.get(c))});$(".document-unlink-contact-tab").die().live("click",function(f){f.preventDefault();var g=$(this).attr("data");var c=documentsView.collection.get(g).toJSON();var d=App_Contacts.contactDetailView.model.id+"";
c.contact_ids.splice(c.contact_ids.indexOf(d),1);var b=new Backbone.Model();b.url="core/api/documents";b.save(c,{success:function(e){documentsView.collection.remove(c);documentsView.render(true)}})});$(".add-document-select").die().live("click",function(f){f.preventDefault();var d=$(this).closest("div");$(this).css("display","none");d.find(".contact-document-select").css("display","inline");var b="<option value='{{id}}'>{{name}}</option>";fillSelect("document-select","core/api/documents","documents",function c(){d.find("#document-select").append("<option value='new'>Add New Doc</option>")},b,false,d)});$(".add-document-cancel").die().live("click",function(c){c.preventDefault();var b=$(this).closest("div");b.find(".contact-document-select").css("display","none");b.find(".add-document-select").css("display","inline")});$(".add-document-confirm").die().live("click",function(h){h.preventDefault();var b=$(this).closest(".contact-document-select").find("#document-select").val();var g=$(this);if(b==""){g.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>This field is required.</span>");g.closest("span").find("span.save-status").find("span").fadeOut(5000);return}else{if(b=="new"){var f=$("#uploadDocumentForm");$("#uploadDocumentModal").modal("show");agile_type_ahead("document_relates_to_contacts",f,contacts_typeahead);agile_type_ahead("document_relates_to_deals",f,deals_typeahead,false,null,null,"core/api/search/deals",false,true);var c=App_Contacts.contactDetailView.model.toJSON();var d=getContactName(c);$(".tags",f).append('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+c.id+'">'+d+"</li>")}else{if(b!=undefined&&b!=null){if(!existingDocumentsView){existingDocumentsView=new Base_Collection_View({url:"core/api/documents",restKey:"documents"});existingDocumentsView.collection.fetch({success:function(e){existing_document_attach(b,g)}})}else{existing_document_attach(b,g)}}}}})});function existing_document_attach(b,e){var c=existingDocumentsView.collection.get(b).toJSON();var d=App_Contacts.contactDetailView.model.id+"";if((c.contact_ids).indexOf(d)<0){c.contact_ids.push(d);saveDocument(null,null,e,false,c)}else{e.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>Linked Already</span>");e.closest("span").find("span.save-status").find("span").fadeOut(5000);return}}function setup_dashboardTimeline(b){if(!b){b="core/api/timeline/contact"}head.js(LIB_PATH+"lib/storyjs-embed.js",function(){createStoryJS({type:"default",width:"1170",height:"350",source:b,embed_id:"my-timeline",js:"lib/timeline-min.js",css:"css/dashboard-timeline.css"})})}function setup_dashboard(b){show_dashboard_subscription_details(b);show_dashboard_contacts(b);show_dashboard_tasks(b);show_dashboard_deals(b);show_dashboard_workflows(b);initBlogSync()}function initBlogSync(){head.js(LIB_PATH+"lib/jquery.feeds.min.js",function(){$("#blog_sync_container").feeds({feeds:{blog:"https://www.agilecrm.com/blog/feed/"},max:3,entryTemplate:function(b){return'<strong><a href="'+b.link+'" title = "'+b.title+'" target="_blank" >'+b.title+'</a></strong><div style="color:#999;font-size:11px;line-height: 13px;margin-bottom:5px">'+new Date(b.publishedDate).format("mmm d, yyyy")+'</div><p style="padding-top:5px;margin-bottom:15px">'+b.contentSnippet.replace("<a",'<a target="_blank"')+"</p>"}})})}function show_dashboard_contacts(c){var b=new Base_Collection_View({url:"core/api/contacts/recent?page_size=5",restKey:"contacts",templateKey:"dashboard-contacts",individual_tag_name:"tr",sort_collection:false});b.collection.fetch();$("#recent-contacts",c).html(b.render().el)}function show_dashboard_tasks(c){var b=new Base_Collection_View({url:"/core/api/tasks/my/dashboardtasks",restKey:"task",sortKey:"due",templateKey:"dashboard1-tasks",individual_tag_name:"tr",postRenderCallback:function(d){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".task-due-time",d).timeago()})}});b.appendItem=append_tasks_dashboard;b.collection.fetch();$("#my-tasks").html(b.el)}function show_dashboard_deals(b){var c=new Base_Collection_View({url:"core/api/opportunity/my/upcoming-deals",restKey:"opportunity",templateKey:"dashboard-opportunities",individual_tag_name:"tr",page_size:5,sortKey:"created_time",descending:true,postRenderCallback:function(d){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".deal-close-time",d).timeago()})}});c.collection.fetch();$("#my-deals").html(c.el)}function show_dashboard_workflows(b){var c=new Base_Collection_View({url:"/core/api/campaigns/logs/recent?page_size=5",restKey:"workflow",templateKey:"dashboard-campaign-logs",individual_tag_name:"tr",page_size:10,sortKey:"time",descending:true,postRenderCallback:function(d){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time.log-created-time",d).timeago()})}});c.collection.fetch();$("#my-logs").html(c.el)}function show_dashboard_subscription_details(c){var b=new Base_Model_View({url:"core/api/subscription",template:"dashboard-account-info"});b.model.fetch({success:function(d){if(!$.isEmptyObject(d.toJSON())){$("#subscription-stats").html(b.render(true).el);return}$.get("core/api/users/count",function(e){var f={};f.users_count=e;f.plan="free";console.log(f);$("#subscription-stats").html(getTemplate("user-billing",f))})}})}$(function(){$("#dashboard-contacts-model-list > tr, #dashboard-campaign-logs-model-list > tr").live("click",function(b){var c=$(this).find(".data").attr("data");App_Contacts.navigate("contact/"+c,{trigger:true})})});$(function(){$(".upload_s3").live("click",function(b){b.preventDefault();uploadImage("upload-container")});$(".upload_pic").live("click",function(b){b.preventDefault();uploadImage("contact-container")});$(".upload_prefs_s3").live("click",function(b){b.preventDefault();uploadImage("upload-in-modal")})});function uploadImage(c){var b=window.open("upload.jsp?id="+c,"name","height=310,width=500");if(window.focus){b.focus()}return false}function setImageURLInModal(c){var d="upload-in-modal";$("#"+d).find(".imgholder").html("");$("#"+d).find(".imgholder").html('<img class="thumbnail" src="'+c+'" height="50" width="50"/>');var b=$("#"+d).closest(".modal").attr("id");$("#"+b).find(".modal-body input[type='hidden']").val(c);$("#"+b).closest(".modal").modal("hide")}function setImageURL(b){var c="upload-container";$("#"+c).find(".imgholder").html("");$("#"+c).find(".imgholder").html('<img class="thumbnail" src="'+b+'" height="75" width="75"/>');$("#"+c).find("#upload_url").val(b)}function setContactImageURL(b){var c="contact-container";$("#"+c).find(".imgholder").html("");$("#"+c).find(".imgholder").html('<img src="'+b+'" height="50" width="50"/>');$("#"+c).find("#upload_url").val(b);agile_crm_update_contact("image",b)}$(function(){$(".merge-field").die().live("click",function(c){c.preventDefault();var b=$(this).attr("name");var d=$("#email-template-html").val();var f=$("#email-template-html").data("wysihtml5");if(f){editor.focus();f.editor.composer.commands.exec("insertHTML","{{"+b+"}}")}})});function setupHTMLEditor(b,c){head.js(LIB_PATH+"lib/wysihtml5-0.3.0-min.js",LIB_PATH+"lib/bootstrap-wysihtml5-min.js",function(){console.log("setting up text");console.log(b.html());if(!$(b).data("wysihtml5")){b.wysihtml5()}if(c){b.data("wysihtml5").editor.setValue(c,false)}})}$(function(){$(".documents-add").die().live("click",function(c){c.preventDefault();var b=$("#uploadDocumentForm");$("#uploadDocumentModal").modal("show");agile_type_ahead("document_relates_to_contacts",b,contacts_typeahead);agile_type_ahead("document_relates_to_deals",b,deals_typeahead,false,null,null,"core/api/search/deals",false,true)});$("#uploadDocumentModal, #uploadDocumentUpdateModal").on("show",function(){$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error")});$("#uploadDocumentModal").on("hidden",function(){$(this).find("form").find("li").remove();$(this).find("form").find("#error").html("");remove_validation_errors("uploadDocumentModal")});$("#uploadDocumentUpdateModal").on("hidden",function(){$(this).find("form").find("li").remove();$(this).find("form").find("#network_type").closest(".controls").find(".icon-ok").css("display","none");$(this).find("form").find("#network_type").closest(".controls").find("div.link").css("background-color","#FFFFFF");$(this).find("form").find("#error").html("");remove_validation_errors("uploadDocumentUpdateModal")});$(".link").live("click",function(c){c.preventDefault();$(this).closest("form").find("#error").html("");var b=$(this).closest("form").attr("id");var f=$(this).find("a").attr("id");if(f&&f=="GOOGLE"){var d=window.open("upload-google-document.jsp?id="+b,"name","height=510,width=800")}else{if(f&&f=="S3"){var d=window.open("upload-custom-document.jsp?id="+b+"&t="+CURRENT_USER_PREFS.template+"&d="+CURRENT_DOMAIN_USER.domain,"name","height=310,width=500")}}if(window.focus){d.focus()}return false});$("#document_validate, #document_update_validate").live("click",function(f){f.preventDefault();var d=$(this).closest(".upload-document-modal").attr("id");var b=$(this).closest(".upload-document-modal").find("form").attr("id");var c=serializeForm(b);console.log(c);if(b=="uploadDocumentForm"){saveDocument(b,d,this,false,c)}else{saveDocument(b,d,this,true,c)}});$('#documents-model-list > tr > td:not(":first-child")').live("click",function(b){if(b.target.parentElement.attributes[0].name!="href"&&b.target.parentElement.attributes[1].name!="href"){b.preventDefault();updateDocument($(this).closest("tr").data())}})});function updateDocument(c){var b=c.toJSON();add_recent_view(new BaseModel(b));var d=$("#uploadDocumentUpdateForm");deserializeForm(b,$("#uploadDocumentUpdateForm"));$("#uploadDocumentUpdateForm").find("#"+b.network_type).closest(".link").find(".icon-ok").css("display","inline");$("#uploadDocumentUpdateForm").find("#"+b.network_type).closest(".link").css("background-color","#EDEDED");$("#uploadDocumentUpdateModal").modal("show");
agile_type_ahead("document_relates_to_contacts",d,contacts_typeahead);agile_type_ahead("document_relates_to_deals",d,deals_typeahead,false,null,null,"core/api/search/deals",false,true)}function saveDocumentURL(c,d,f){f=f.split("?id=")[1];var b=f.split("&")[0];var e=c.split("?");if(c.match("agilecrm/panel/uploaded-logo/")){e=e[0];e=e.substring(e.lastIndexOf("/")+1)}else{e="Google"}$("#"+b).find("#extension").val(e);$("#"+b).find("#network_type").val(d);$("#"+b).find("#network_type").closest(".controls").find("div.link").css("background-color","#FFFFFF");$("#"+b).find("#network_type").closest(".controls").find(".icon-ok").css("display","none");$("#"+b).find("#"+d).closest(".link").find(".icon-ok").css("display","inline");$("#"+b).find("#"+d).closest(".link").css("background-color","#EDEDED");$("#"+b).find("#upload_url").val(c)}function saveDocument(b,h,g,f,e){if($(g).attr("disabled")){return}disable_save_button($(g));if(b){if(!isValidForm("#"+b)){enable_save_button($(g));return false}var c=$("#"+b).find("#upload_url").val();if(c==""){$("#"+b).find("#network_type").closest(".controls").find(".icon-ok").css("display","none");$("#"+b).find("#network_type").closest(".controls").find("div.link").css("background-color","#FFFFFF");$("#"+b).find("#error").html('<div class="alert alert-error">Sorry! Document not attached properly.</div>');enable_save_button($(g));return}}var d=new Backbone.Model();d.url="core/api/documents";d.save(e,{success:function(k){enable_save_button($(g));if(b){$("#"+b).find("#network_type").val("");$("#"+b).find("#network_type").closest(".controls").find(".icon-ok").css("display","none");$("#"+b).find("#network_type").closest(".controls").find("div.link").css("background-color","#FFFFFF");$("#"+b).find("#upload_url").val("");$("#"+b).find("#extension").val("");$("#"+b).each(function(){this.reset()})}if(b){$("#"+h).modal("hide")}var j=k.toJSON();add_recent_view(new BaseModel(j));if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){$.each(j.contacts,function(m,l){if(l.id==App_Contacts.contactDetailView.model.get("id")){if(documentsView&&documentsView.collection){if(documentsView.collection.get(j.id)){documentsView.collection.get(j.id).set(new BaseModel(j))}else{documentsView.collection.add(new BaseModel(j),{sort:false});documentsView.collection.sort()}}return false}})}else{if(Current_Route=="documents"){if(f){App_Documents.DocumentCollectionView.collection.remove(e)}App_Documents.DocumentCollectionView.collection.add(k);App_Documents.DocumentCollectionView.render(true)}else{if(App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.id){$.each(j.deals,function(l,m){if(m.id==App_Deal_Details.dealDetailView.model.id){if(dealDocsView&&dealDocsView.collection){if(dealDocsView.collection.get(j.id)){dealDocsView.collection.get(j.id).set(new BaseModel(j))}else{dealDocsView.collection.add(new BaseModel(j),{sort:false});dealDocsView.collection.sort()}}return false}})}else{App_Documents.navigate("documents",{trigger:true})}}}}})}function load_urls_on_ajax_stop(b,c){if(!isActive()){setTimeout(function(){load_urls_on_ajax_stop(b,c)},5000);return}head.js(b,function(){if(c&&typeof c=="function"){c()}})}function loadMiscScripts(){load_urls_on_ajax_stop("lib/user-voice.js");load_urls_on_ajax_stop("//static.getclicky.com/js");load_urls_on_ajax_stop("//static.getclicky.com/js",function(){try{clicky.init(100729733)}catch(b){}});downloadAndRegisterForNotifications()}function isActive(){if($.active>0){return false}return true}$("#subscribe-ical").live("click",function(b){b.preventDefault();set_api_key()});function set_api_key(){var d=Backbone.Model.extend({url:"core/api/api-key"});var b=new d();var c=b.fetch({success:function(f){var e=f.get("api_key");set_url_domain(e)}})}function set_url_domain(c){var b=window.location.hostname.split(".")[0];set_url(c,b)}function set_url(d,c){var b="webcal://"+c+".agilecrm.com/ical/"+d;$("#ical-feed").attr("href",b);$("#ical-feed").text(b);console.log(b)}$("#send-ical-email").live("click",function(c){c.preventDefault();$("#icalModal").modal("hide");if($("#share-ical-by-email").size()!=0){$("#share-ical-by-email").remove()}var d=Backbone.Model.extend({url:"/core/api/users/current-user",restKey:"domainUser"});var b=new d();b.fetch({success:function(h){var e=h.toJSON();var g=$("#icalModal").find("#ical-feed").text();e.ical_url=g;var j=$(getTemplate("share-ical-by-email",e));var f=$(j).find("textarea").val();f=f.replace(/<br\/>/g,"\r\n");$(j).find("textarea").val(f);j.modal("show");send_ical_info_email(j)}})});function send_ical_info_email(b){$("#shareIcalMail").die().live("click",function(f){f.preventDefault();if(!isValidForm($("#shareIcalMailForm"))){return}var d=serializeForm("shareIcalMailForm");d.body=d.body.replace(/\r\n/g,"<br/>");var c="core/api/emails/send-email?from="+encodeURIComponent(d.from)+"&to="+encodeURIComponent(d.to)+"&subject="+encodeURIComponent(d.subject)+"&body="+encodeURIComponent(d.body);$save_info=$('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><p class="text-success" style="color:#008000; font-size:15px; display:inline-block"> <i>Sending mail...</i></p></span>');$("#msg",this.el).append($save_info);$save_info.show().delay(2000).fadeOut("slow");$.post(c,function(){b.modal("hide")})})}$(function(){$("#scheduleModal").on("hidden",function(b){$("#edit").show();$("#charlength").hide();$("#specialchar").hide()});$("#show-schedule-url").die().live("click",function(b){b.preventDefault();$("#scheduleModal").modal("show")});$("#scheduleModal").on("show",function(){var b=Backbone.Model.extend({url:"/core/api/users/current-user",restKey:"domainUser"});var c=new b();c.fetch({success:function(f){var e=f.toJSON();if($("#scheduleModal").size()>1){$("#scheduleModal").modal("hide").remove()}var g="https://"+e.domain+".agilecrm.com/calendar/"+e.schedule_id;var d="https://"+e.domain+".agilecrm.com/calendar/";$("#scheduleurl").attr("href",g);$("#hrefvalue").html(d);$("#schedule_id").html(e.schedule_id);$("#scheduleurl").removeClass("nounderline")}})});$("#edit-schedule-id").die().live("click",function(c){c.preventDefault();var b=$("#schedule_id").text();$("#edit").hide();$("#scheduleurl").removeAttr("href");$("#schedule_id").html("<input class='input-small' type='text' style='position: relative;top: 6px;left: 5px;margin-top:-9px;' name='url' id='url' value='"+b+"'/><buttion class='btn' style='display:inline-block;margin-left:30px;margin-bottom:5px;position: absolute;top:1px' id='save-scheduleurl'>Save</button>");$("#scheduleurl").addClass("nounderline");$("#scheduleModal").data("modal",null)});$("#save-scheduleurl").die().live("click",function(f){f.preventDefault();var d=$("#url").val();if(d.length<4){$("#charlength").fadeIn("slow");setTimeout(function(){$("#charlength").fadeOut("slow")},2000);return}var b=/^[0-9a-zA-Z\_]+$/;if(!(b.test(d))){$("#specialchar").fadeIn("slow");setTimeout(function(){$("#specialchar").fadeOut("slow")},2000);return}var c=$(this);disable_save_button($(c));$.ajax({url:"core/api/users/updatescheduleid?scheduleid="+d,type:"GET",success:function(e){var g="https://"+e.domain+".agilecrm.com/calendar/"+e.schedule_id;$("#scheduleurl").attr("href",g);$("#schedule_id").text(e.schedule_id);enable_save_button($(c));$("#edit").show();$("#specialchar").hide();$("#charlength").hide();$("#scheduleurl").removeClass("nounderline")},error:function(e){console.log(e);$("#schedule_error_message").html("Something went wrong as your schedule url was not updated. Please try again in few hours. Error: "+e.statusText);$("#schedule_error_message").fadeIn("slow");setTimeout(function(){$("#schedule_error_message").fadeOut("slow")},2000);enable_save_button($(c));return}})})});$("#send-schedule-url-email").live("click",function(c){c.preventDefault();$("#scheduleModal").modal("hide");if($("#scheduleModal").size()!=0){$("#scheduleModal").remove()}var d=$(getTemplate("share-schedule-url-by-email",{}));var b=$(d).find("textarea").val();b=b.replace(/<br\/>/g,"\r\n");$(d).find("textarea").val(b);d.modal("show")});function send_schedule_url_email(b){$("#share-url-email").die().live("click",function(f){f.preventDefault();if(!isValidForm($("#sharescheduleurlmailForm"))){return}var d=serializeForm("sharescheduleurlmailForm");d.body=d.body.replace(/\r\n/g,"<br/>");var c="core/api/emails/send-email?from="+encodeURIComponent(d.from)+"&to="+encodeURIComponent(d.to)+"&subject="+encodeURIComponent(d.subject)+"&body="+encodeURIComponent(d.body);$save_info=$('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><p class="text-success" style="color:#008000; font-size:15px; display:inline-block"> <i>Sending mail...</i></p></span>');$("#msg",this.el).append($save_info);$save_info.show().delay(2000).fadeOut("slow");$.post(c,function(){b.modal("hide")})})}function hasScope(b){var c=CURRENT_DOMAIN_USER.scopes;if(!c){return true}return jQuery.inArray(b,c)>-1}function showContactsImportAccessDeniedMessage(b){$(b).html("<h4>Access denied to sync contacts. Please contact Admin</h4>")}function hasScope(b){return(CURRENT_DOMAIN_USER.scopes&&$.inArray(b,CURRENT_DOMAIN_USER.scopes)!=-1)}function canEditContacts(){return hasScope("DELETE_CONTACTS")}function canEditContacts(){return hasScope("VIEW_CONTACTS")}function canCreateContacts(){return hasScope("CREATE_CONTACT")}function canImportContacts(){if(!hasScope("CREATE_CONTACT")){return false}return hasScope("IMPORT_CONTACTS")}function canEditContact(b){if((hasScope("UPDATE_CONTACTS")||hasScope("DELETE_CONTACTS"))||CURRENT_DOMAIN_USER.id==b){return true}return false}function canEditCurrentContact(){var c=App_Contacts.contactDetailView.model;if(!c){return}var b=c.toJSON();if(!b.owner){return true}return canEditContact(b.owner.id)}function canRunBulkOperations(){if(!hasScope("VIEW_CONTACTS")){return true}if(!(hasScope("UPDATE_CONTACTS")||hasScope("DELETE_CONTACTS"))){return false}return true}(function(b,c,e){b.DEAL_PER=false;b.REPORTS_PER=false;
b.ACTIVITY_PER=false;var d={};b.init_permissions=function(){if(!Current_Route){return}if(Current_Route.indexOf("deal")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("DEALS")>-1)){d.entity="Deals";b.DEAL_PER=true;App_ACL.notAllowed(d)}if(Current_Route.indexOf("activit")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("ACTIVITY")>-1)){d.entity="Acivities";b.ACTIVITY_PER=true;App_ACL.notAllowed(d)}if(Current_Route.indexOf("report")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("REPORT")>-1)){d.entity="Reports";b.REPORTS_PER=true;App_ACL.notAllowed(d)}if((Current_Route.indexOf("web-rules")>-1||Current_Route.indexOf("webrule")>-1)&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("WEBRULE")>-1)){d.entity="Webrules";b.REPORTS_PER=true;App_ACL.notAllowed(d)}if(Current_Route.indexOf("social")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("SOCIAL")>-1)){d.entity="Social";b.REPORTS_PER=true;App_ACL.notAllowed(d)}if(Current_Route.indexOf("documents")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("DOCUMENT")>-1)){d.entity="Documents";b.REPORTS_PER=true;App_ACL.notAllowed(d)}if(Current_Route.indexOf("cases")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("CASES")>-1)){d.entity="Cases";b.REPORTS_PER=true;App_ACL.notAllowed(d)}if((Current_Route.indexOf("workflow")>-1||Current_Route.indexOf("trigger")>-1)&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("CAMPAIGN")>-1)){d.entity="Campaigns";b.REPORTS_PER=true;App_ACL.notAllowed(d)}};b.checkPermission=function(f){return CURRENT_DOMAIN_USER.menu_scopes.indexOf(f)>-1}}(window.tight_acl=window.tight_acl||{},$));$(function(){$("#api_key_generate_icon").live("click",function(b){b.preventDefault();regenerate_api_key("core/api/api-key/key")});$("#jsapi_key_generate_icon").live("click",function(b){b.preventDefault();regenerate_api_key("core/api/api-key/jskey")})});function update_admin_settings_api_key_template(){$.ajax({url:"core/api/api-key",type:"GET",dataType:"json",success:function(b){$("#admin-prefs-tabs-content").html(getTemplate("admin-settings-api-key-model",b))}})}function regenerate_api_key(b){if(confirm("Resetting the API Key will break all existing integrations you may have setup using the current key. Are you sure you want to reset the API key?")){$.ajax({url:b,type:"POST",success:function(){update_admin_settings_api_key_template()}})}else{return}}function initChartsUI(b,c){head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){$("#reportrange").daterangepicker({ranges:{Today:["today","today"],Yesterday:["yesterday","yesterday"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 30 Days":[Date.today().add({days:-29}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})]}},function(f,d){var e=Math.abs(f.getMonth()-d.getMonth()+(12*(f.getFullYear()-d.getFullYear())));$("#reportrange span").html(f.toString("MMMM d, yyyy")+" - "+d.toString("MMMM d, yyyy"));$("#week-range").html(d.add({days:-6}).toString("MMMM d, yyyy")+" - "+d.add({days:6}).toString("MMMM d, yyyy"));get_email_table_reports(b);showEmailGraphs(b)})});get_email_table_reports(b);showEmailGraphs(b)}function showEmailGraphs(b){showBar("core/api/campaign-stats/email/reports/"+b+getOptions()+"&type=date","line-daily-chart","Daily Reports","Count",null);showBar("core/api/campaign-stats/email/reports/"+b+getOptions()+"&type=hour","line-hourly-chart","Hourly Reports","Count",null);showBar("core/api/campaign-stats/email/reports/"+b+getOptions()+"&type=day","line-weekly-chart","Weekly Reports","Count",null)}function getOptions(){var c="?";var b=$("#range").html().split("-");var f=Date.parse($.trim(b[0])).valueOf();var h=$.trim(b[1]);if(h){h=h+" 23:59:59"}var e=Date.parse(h).valueOf();c+=("start_time="+f+"&end_time="+e);var k=new Date();c+=("&time_zone="+k.getTimezoneOffset());if($("#frequency").length>0){var g=$("#frequency").val();c+=("&frequency="+g)}if($("#filter").length>0){var j=$("#filter").val();if(j!=""&&j!="ALL"){c+=("&filter="+j)}}return c}function get_email_table_reports(b){$("#email-table-reports").html(getRandomLoadingImg());$.getJSON("core/api/campaign-stats/email/table-reports/"+b+getOptions(),function(c){console.log(c);$("#email-table-reports").html(getTemplate("campaign-email-table-reports",c))})}var noAnimationBruteForce=true;var timeline_collection_view;var MONTH_YEARS;var month_years=[];var timeline_view=Backbone.View.extend({initialize:function(){_.bindAll(this,"render","appendItem","addItems");this.options.data=[];this.options.data.push(App_Contacts.contactDetailView.model.toJSON());console.log(App_Contacts.contactDetailView.model.toJSON().tagsWithTime);console.log(this.options.data);this.collection=new BaseCollection([],{});this.month_year_marker=[];this.month_year_marker_objects=[];configure_timeline_comparator(this.collection);this.collection.add(App_Contacts.contactDetailView.model.toJSON().tagsWithTime,{silent:true});this.collection.add(this.options.data,{silent:true});this.queue=new Queue;this.collection.bind("add",this.appendItem)},appendItem:function(c){if(c.get("entity_type")){if(c.get("entity_type")=="year-marker"){getTemplate("year-marker",c.toJSON(),"yes",function(e){$("#timeline",App_Contacts.contactDetailView.el).isotope("insert",$(e))});return}}this.collection.add(c,{silent:true});var b=[];b.push(c.toJSON());var d=getTemplate("timeline1",b,undefined,function(e){$("#timeline",App_Contacts.contactDetailView.el).isotope("insert",$(e))})},addItems:function(b){this.collection.add(b,{silent:true});this.buildTimlinePosts(b)},render:function(){this.buildTimlinePosts(this.collection.toJSON())},buildTimlinePosts:function(e){var d=e.length;if(!d){return}this.addToQueue(e);return;var c=0;while(c<d){var b=c+50;b=b>d?d:b;if(b==c){break}this.addToQueue(e.slice(c,b));c+=50}},addToQueue:function(b){this.queue.add_function(quedfunction,b)}});function quedfunction(c){var b;getTemplate("timeline1",c,undefined,function(d){$("#timeline",$(App_Contacts.contactDetailView.el)).isotope("insert",$(d),function(e){timeline_collection_view.queue.running=false;timeline_collection_view.queue.next()})})}function configure_timeline_comparator(b){b.comparator=function(f){var d=entity_created_month_year(f.toJSON());if(d){if(timeline_collection_view&&timeline_collection_view.month_year_marker.indexOf(d)==-1){timeline_collection_view.month_year_marker.push(d);var c=d.split("-");var g=getTimestamp(c[0],c[1])/1000;var e={year:monthArray[c[0]].split(" ")[0],timestamp:g,entity_type:"year-marker"};if(!b.where({year:monthArray[c[0]].split(" ")[0]})[0]){}b.add(e);console.log(e);timeline_collection_view.month_year_marker_objects.push(e)}}if(f.get("created_time")){return f.get("created_time")}else{if(f.get("createdTime")){return f.get("createdTime")/1000}else{if(f.get("time")){return f.get("time")/1000}else{if(f.get("date_secs")){return f.get("date_secs")/1000}else{if(f.get("timestamp")){return g}}}}}return f.get("id")}}$(function(){$("#tl-mail-popover").live("click",function(b){b.preventDefault();var c=$(this).closest("div").attr("data");$("#mail-in-detail").html("<div style='background:none;border:none;'>"+c+"</div>");$("#timelineMailModal").modal("show")});$("#tl-log-popover").live("click",function(c){c.preventDefault();var b=$(this).closest("div").attr("data");$("#log-in-detail").html("<div style='background:none;border:none;'>"+b+"</div>");$("#timelineLogModal").modal("show")});$("#tl-analytics-popover").live("click",function(c){c.preventDefault();var b=$(this).closest("div.body").html();var d=$(b).find("div.ellipsis-multi-line");$("#analytics-in-detail").html("<div'>"+$(d).html()+"</div>");$("#timelineAnalyticsModal").modal("show")});$("#tl-mail-to-popover").live("mouseenter",function(d){$(this).popover({template:'<div class="popover"><div class="arrow"></div><div class="popover-inner" style="padding:1px;width:340px;border-radius:2px"><div class="popover-content"><p></p></div></div></div>'});var b=$(this).text();var c=new Handlebars.SafeString(b.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/,/g,",</br>").replace("To:","To:</br>").replace("read more",""));$(this).attr("data-content",c);$(this).popover("show")});$("#timeline .item a.open-close").live("click",function(b){$(this).siblings(".body").slideToggle(function(){$("#timeline").isotope("reLayout")});$(this).parents(".post").toggleClass("closed");$("#expand-collapse-buttons a").removeClass("active");b.preventDefault()})});var monthArray=["January 31","February 28","March 31","April 30","May 31","June 30","July 31","August 31","September 30","October 31","November 30","December 31"];var MONTH_YEARS;function remove_loading_img(b){$("#time-line",b).find(".loading-img").remove()}function entity_created_month_year(b){if(b.created_time){return month_year=new Date(b.created_time*1000).getMonth()+"-"+new Date(b.created_time*1000).getFullYear()}if(b.createdTime){return month_year=new Date(b.createdTime).getMonth()+"-"+new Date(b.createdTime).getFullYear()}else{if(b.time){return month_year=new Date(b.time*1000).getMonth()+"-"+new Date(b.time*1000).getFullYear()}else{if(b.date_secs){return month_year=new Date(b.date_secs).getMonth()+"-"+new Date(b.date_secs).getFullYear()}}}}function getTimestamp(c,b){if((b%4)==0){monthArray[1]="February 29"}return Date.parse(monthArray[c]+", "+b)+86400000-1}var Queue=(function(){function b(){}b.prototype.running=false;b.prototype.queue=[];b.prototype.running=false;b.prototype.add_function=function(e,d){var c=this;this.queue.push(function(){e(d)});if(!this.running){this.next()}return this};b.prototype.next=function(){var c=this.queue.shift();if(c){this.running=true;c()}};return b})();function load_timeline_details(c,e,d,b){noAnimationBruteForce=true;timeline_entity_loader.init(App_Contacts.contactDetailView.model.toJSON())}function add_entity_to_timeline(b){var c=[];c.push(b.toJSON());if(!timeline_collection_view){return}if(!timeline_collection_view.collection.get(b.get("id"))){timeline_collection_view.addItems(c);
return}update_entity_template(b)}function update_entity_template(b){$("#"+b.get("id"),$("#timeline",App_Contacts.contactDetailView.el)).html(getTemplate("timeline1",[b.toJSON()]))}function removeItemFromTimeline(b){try{$("#timeline").isotope("remove",b,function(){$("#timeline").isotope("reLayout")})}catch(c){}}function addTagToTimelineDynamically(b,c){if(!timeline_collection_view||!timeline_collection_view.collection){return}$.each(c,function(e,d){if(d.tag==b){timeline_collection_view.collection.add(new BaseModel(d))}});console.log(c)}function timline_fetch_data(b,c){}var timeline_entity_loader={init:function(b){this.active_connections=0;MONTH_YEARS=[];var c=this;head.load("/lib/isotope.pkgd.js",LIB_PATH+"lib/jquery.event.resize.js","css/misc/agile-timline.css",function(){configure_timeline();timeline_collection_view=new timeline_view();console.log(c);c.load_other_timline_entities(b);timeline_collection_view.render()})},load_other_timline_entities:function(b){var c=b.id;this.load_related_entites(c);this.load_stats(b);this.load_campaign_logs(c);this.get_stats(getPropertyValue(b.properties,"email"),b,App_Contacts.contactDetailView.el)},load_related_entites:function(d){var b=["deals","notes","cases","tasks"];var c="core/api/contacts/related-entities/"+d;this.timline_fetch_data(c,function(f){var g=[];for(var e in b){if(f[b[e]].length==0){continue}g=g.concat(f[b[e]])}if(App_Contacts.contactDetailView.model.get("id")==d){timeline_collection_view.addItems(g)}})},load_stats:function(b){var c=getAllPropertyValuesByName(b.properties,"email",",");if(c){this.timline_fetch_data("core/api/emails/imap-email?e="+encodeURIComponent(c)+"&c=10&o=0",function(d){console.log(d);if(d&&d.emails){var e=[];$.each(d.emails,function(f,g){if(("errormssg" in g)||g.status==="error"){return}e.push(g)});if(App_Contacts.contactDetailView.model.get("id")==b.id){timeline_collection_view.addItems(e)}}})}},load_campaign_logs:function(c){var b="/core/api/campaigns/logs/contact/"+c+"?cursor=0&page_size=100";this.timline_fetch_data(b,function(e){if(!e||e.length==0){return}var d=[];$.each(e,function(g,f){if(f.log_type=="EMAIL_SENT"||f.log_type=="EMAIL_OPENED"||f.log_type=="EMAIL_CLICKED"||f.log_type=="SET_OWNER"||f.log_type=="SCORE"||f.log_type=="ADD_DEAL"||f.log_type=="TWEET"){d.push(f)}});if(App_Contacts.contactDetailView.model.get("id")==c){timeline_collection_view.addItems(d)}})},timline_fetch_data:function(b,d){$("#timeline-loading-img",App_Contacts.contactDetailView.el).show();console.log(this.active_connections);++this.active_connections;var c=this;$.getJSON(b,function(e){console.log("success : "+c.active_connections);--c.active_connections;console.log("success : "+c.active_connections);if(d&&typeof d==="function"){d(e)}if(!c.active_connections){$(".timeline-loading-img",App_Contacts.contactDetailView.el).hide()}}).error(function(){--c.active_connections;if(!c.active_connections){$(".timeline-loading-img",App_Contacts.contactDetailView.el).hide()}})},getOpenedEmailsFromEmails:function(c){var b=[];$.each(c,function(e,d){if(d.email_opened_at&&d.email_opened_at!==0){d.createdTime=(d.email_opened_at)*1000;d.agile_email="agile_email";d.date=undefined;b.push(d)}});return b},get_stats:function(c,b,d){if(!(readCookie("_agile_jsapi")!=null&&readCookie("_agile_jsapi")=="true")&&(NO_WEB_STATS_SETUP&&get_web_stats_count_for_domain()=="0")){$("#time-line",d).find(".loading-img-stats").remove();return}NO_WEB_STATS_SETUP=false;createCookie("_agile_jsapi",true,500);var e=Backbone.Collection.extend({});this.timline_fetch_data("core/api/web-stats?e="+encodeURIComponent(c),function(h){this.statsCollection=new e(h);h=statsCollection;is_mails_fetched=true;is_logs_fetched=false;is_array_urls_fetched=false;$("#time-line",d).find(".loading-img-stats").remove();if(h.toJSON()&&h.toJSON().length>0){var f=getPropertyValue(b.properties,"address");if(!f){var j={};if(h.toJSON()[0].city!=""){j.city=ucfirst(h.toJSON()[0].city);j.state=ucfirst(h.toJSON()[0].region);j.country=getCode(h.toJSON()[0].country);b.properties.push({name:"address",value:JSON.stringify(j)});var g=new Backbone.Model();g.url="core/api/contacts";g.save(b,{success:function(k){}})}}if(App_Contacts.contactDetailView.model.get("id")==b.id){timeline_collection_view.addItems(h.toJSON())}addTagAgile(CODE_SETUP_TAG)}})}};function customize_isotope(){$.Isotope.prototype._spineAlignReset=function(){this.spineAlign={colA:0,colB:0,lastY:-60}};$.Isotope.prototype._spineAlignLayout=function(f){var b=this,d=this.spineAlign,c=Math.round(this.options.spineAlign&&this.options.spineAlign.gutterWidth)||0,e=Math.round(this.element.width()/2);f.each(function(j,m){var l=$(this);l.removeClass("last").removeClass("top");if(j==f.length-1){l.addClass("last")}var g,o;if(l.hasClass("year-marker")){var k=l.width();g=e-(k/2);if(d.colA>=d.colB){o=d.colA;if(o==0){l.addClass("top")}d.colA+=l.outerHeight(true);d.colB=d.colA}else{o=d.colB;if(o==0){l.addClass("top")}d.colB+=l.outerHeight(true);d.colA=d.colB}}else{l.removeClass("left").removeClass("right");var h=d.colB>=d.colA;if(h){l.addClass("left")}else{l.addClass("right")}g=h?e-(l.outerWidth(true)+c/2):e+(c/2);o=h?d.colA:d.colB;if(o-d.lastY<=60){var n=60-Math.abs(o-d.lastY);l.find(".inner").css("marginTop",n);d.lastY=o+n}else{l.find(".inner").css("marginTop",0);d.lastY=o}d[(h?"colA":"colB")]+=l.outerHeight(true)}b._pushPosition(l,g,o)})};$.Isotope.prototype._spineAlignGetContainerSize=function(){var b={};b.height=this.spineAlign[(this.spineAlign.colB>this.spineAlign.colA?"colB":"colA")];return b};$.Isotope.prototype._spineAlignResizeChanged=function(){return true}}function configure_timeline(){customize_isotope();var b=$("#timeline",App_Contacts.contactDetailView.el);b.isotope({itemSelector:".item",transformsEnabled:true,layoutMode:"spineAlign",spineAlign:{gutterWidth:56},getSortData:{timestamp:function(c){var d=parseFloat(c.find(".timestamp").text());if(!d){return 0}if((d/100000000000)>1){return d/1000}return d}},sortBy:"timestamp",sortAscending:false,itemPositionDataEnabled:true})}function showSearchResults(){var b=$("#searchText").val();if(b==""){return}if(!App_Contacts){App_Contacts=new ContactsRouter()}App_Contact_Search.navigate("contacts/search/"+b,{trigger:true})}function navigateToDetailsPage(e,c){var b;for(var d=0;d<QUERY_RESULTS.length;d++){if(QUERY_RESULTS[d].id!=e){continue}b=QUERY_RESULTS[d];break}console.log(b);if(b.entity_type=="contact_entity"){App_Contacts.navigate("contact/"+e,{trigger:true});return}if(b.entity_type=="deal"){if(!tight_acl.checkPermission("DEALS")){var f={};f.entity="Deals";$(getTemplate("no-permission",f)).modal("show");return}console.log(b);var g=b;Backbone.history.navigate("deal/"+g.id,{trigger:true});return}if(b.entity_type=="document"){if(!tight_acl.checkPermission("DOCUMENT")){var f={};f.entity="Documents";$(getTemplate("no-permission",f)).modal("show");return}console.log(b);updateDocument(new BaseModel(b));return}if(!tight_acl.checkPermission("CASES")){var f={};f.entity="Cases";$(getTemplate("no-permission",f)).modal("show");return}updatecases(new BaseModel(b))}$(function(){agile_type_ahead("searchText",undefined,contacts_typeahead,navigateToDetailsPage,undefined,undefined,"core/api/search/all/keyword");$("#search-results").live("click",function(b){b.preventDefault();showSearchResults()})});var filter_name;var scrambled_index=0;function scramble_input_names(b){b.find("input").each(function(){$(this).attr("name","temp-"+scrambled_index);$(this).addClass("required");scrambled_index+=1})}$(function(){SEARCHABLE_CONTACT_CUSTOM_FIELDS=undefined;COMPANY_CUSTOM_FIELDS=undefined;$(".filter-contacts-multiple-add").die().live("click",function(b){b.preventDefault();var c=$($(getTemplate("filter-contacts",{})).find(".chained-table.contact")[0]).find("tr").clone();$(c).removeClass("hide");scramble_input_names($(c));chainFilters(c,function(){},false);$(c).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(c).find("#LHS select").find("optgroup[label='Activities']").remove();$(this).prev("table").find("tbody").append(c)});$(".filter-contacts-multiple-add-or-rules").die().live("click",function(b){b.preventDefault();var c=$($(getTemplate("filter-contacts",{})).find(".chained-table.contact")[1]).find("tr").clone();$(c).removeClass("hide");scramble_input_names($(c));chainFilters(c,function(){},false);$(c).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(c).find("#LHS select").find("optgroup[label='Activities']").remove();$(this).prev("table").find("tbody").append(c)});$(".filter-companies-multiple-add").die().live("click",function(b){b.preventDefault();var c=$($(getTemplate("filter-contacts",{})).find(".chained-table.company")[0]).find("tr").clone();$(c).removeClass("hide");scramble_input_names($(c));chainFilters(c,undefined,function(){},false,true);$(c).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(this).prev("table").find("tbody").append(c)});$(".filter-companies-multiple-add-or-rules").die().live("click",function(b){b.preventDefault();var c=$($(getTemplate("filter-contacts",{})).find(".chained-table.company")[1]).find("tr").clone();$(c).removeClass("hide");scramble_input_names($(c));chainFilters(c,undefined,function(){},false,true);$(c).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(this).prev("table").find("tbody").append(c)});$("i.filter-contacts-multiple-remove").die().live("click",function(b){$(this).closest("tr").remove()});$(".filter").live("click",function(c){c.preventDefault();eraseCookie("company_filter");eraseData("dynamic_contact_filter");eraseData("dynamic_company_filter");var d=$(this).attr("id");var b=$(this).attr("filter_type");createCookie("contact_filter",d);createCookie("contact_filter_type",b);filter_name=$(this).attr("data");CONTACTS_HARD_RELOAD=true;App_Contacts.contacts();return});$(".default_filter").live("click",function(b){b.preventDefault();revertToDefaultContacts()});$(".default_contact_remove_tag").die().live("click",function(b){b.preventDefault();
Backbone.history.navigate("contacts",{trigger:true})});$("#companies-filter").live("click",function(b){b.preventDefault();eraseCookie("contact_filter");eraseCookie("contact_filter_type");createCookie("company_filter","Companies");CONTACTS_HARD_RELOAD=true;App_Contacts.contacts();return});$(".lhs_chanined_parent").die().live("change",function(c){c.preventDefault();if(($(this).val()).indexOf("tags")!=-1){var b=$(this).closest("tr").find("div#RHS");addTagsDefaultTypeahead(b)}});$("#condition > select").die().live("change",function(c){c.preventDefault();if($(this).find("option:selected").hasClass("tags")){var b=$(this).parents().closest("tr").find("div#RHS");addTagsDefaultTypeahead(b)}});$("#contact_type").die().live("change",function(b){if($(this).val()=="COMPANY"){$("#companies-filter-wrapper").show();$("#contacts-filter-wrapper").hide()}else{$("#companies-filter-wrapper").hide();$("#contacts-filter-wrapper").show()}})});var contactFiltersListView;function setupContactFilterList(c,e){if(e){$(".filter-criteria",c).html('<ul id="added-tags-ul" class="tagsinput" style="display: inline; vertical-align: top; margin-bottom: 10px"><li style="display: inline-block;" class="tag" data="developer"><span style="margin-left:5px;float:left">'+decodeURI(e)+'</span><a class="close default_contact_remove_tag" style="margin-left:5px;float:left">&times</a></li></ul>').attr("_filter",e)}var d=null;contactFiltersListView=new Base_Collection_View({url:"/core/api/filters",sort_collection:false,restKey:"ContactFilter",templateKey:"contact-filter-list",individual_tag_name:"li",sort_collection:false,postRenderCallback:function(f){var g;if(g=readCookie("contact_filter")){if(g.toLowerCase().indexOf("recent")>=0){g="Recent"}else{if(g.toLowerCase().indexOf("contacts")>=0){g="My Contacts"}else{if(g.toLowerCase().indexOf("leads")>=0){g="Leads"}else{if(g.indexOf("system")<0){d=g;if(contactFiltersListView.collection.get(g)){g=contactFiltersListView.collection.get(g).toJSON().name}}}}}f.find(".filter-dropdown").append(g)}else{if(g=readCookie("company_filter")){f.find(".filter-dropdown").append(g)}}if(!g){return}$(".filter-criteria",c).html('<ul id="added-tags-ul" class="tagsinput" style="display: inline; vertical-align: top; margin-bottom: 10px"><li style="display: inline-block;" class="tag" data="developer"><span style="margin-left:5px;float:left">'+g+'</span><a class="close default_filter" style="margin-left:5px;float:left">&times</a></li></ul>');if(d){$(".filter-criteria",c).attr("_filter",d)}else{$(".filter-criteria",c).attr("_filter",g)}}});contactFiltersListView.collection.fetch();var b=contactFiltersListView.render().el;$("#filter-list",c).html(contactFiltersListView.render().el)}function revertToDefaultContacts(){eraseCookie("contact_filter");eraseCookie("contact_filter_type");eraseCookie("company_filter");eraseData("dynamic_filter");if(App_Contacts.contactsListView){App_Contacts.contactsListView=undefined}if(App_Contacts.contact_custom_view){App_Contacts.contact_custom_view=undefined}App_Contacts.contacts()}function chainFiltersForContactAndCompany(b,c,d){if(c&&c.contact_type){if(c.contact_type=="PERSON"){chainFilters($(b).find(".chained-table.contact.and_rules"),c.rules,undefined,false,false);chainFilters($(b).find(".chained-table.contact.or_rules"),c.or_rules,undefined,false,false);chainFilters($(b).find(".chained-table.company.and_rules"),undefined,undefined,false,true);chainFilters($(b).find(".chained-table.company.or_rules"),undefined,d,false,true)}else{if(c.contact_type=="COMPANY"){chainFilters($(b).find(".chained-table.company.and_rules"),c.rules,undefined,false,true);chainFilters($(b).find(".chained-table.company.or_rules"),c.or_rules,undefined,false,true);chainFilters($(b).find(".chained-table.contact.and_rules"),undefined,undefined,false,false);chainFilters($(b).find(".chained-table.contact.or_rules"),undefined,d,false,false)}}}else{chainFilters($(b).find(".chained-table.contact.and_rules"),undefined,undefined,false,false);chainFilters($(b).find(".chained-table.contact.or_rules"),undefined,undefined,false,false);chainFilters($(b).find(".chained-table.company.and_rules"),undefined,undefined,false,true);chainFilters($(b).find(".chained-table.company.or_rules"),undefined,d,false,true)}}function chainFilters(c,e,f,b,d){if(d){fillCompanyCustomFieldsInFilters(c,function(){show_chained_fields(c,e,true);if(f&&typeof(f)==="function"){f()}});return}else{if(!SEARCHABLE_CONTACT_CUSTOM_FIELDS){if(window.location.hash.indexOf("contact-filter")!=-1){$("#content").html(getRandomLoadingImg())}fillContactCustomFieldsInFilters(c,function(){show_chained_fields(c,e,true);if(f&&typeof(f)==="function"){f()}},b);return}fillCustomFields(SEARCHABLE_CONTACT_CUSTOM_FIELDS,c,undefined,false)}show_chained_fields(c,e);if(f&&typeof(f)==="function"){f()}}function show_chained_fields(e,g,k){var j=$(e).clone();var m,f,d,h,b,c,l;m=$("#LHS",e);f=$("#condition",e);d=$("#RHS",e);h=$("#RHS-NEW",e);b=$("#nested_condition",e);c=$("#nested_rhs",e);l=$("#nested_lhs",e);d.chained(f,function(s,o){var q=$(s).find("option:selected");var u=$(q).attr("placeholder");var n=$(q).hasClass("custom_field");var t=$(q).attr("field_type");$("select",o).each(function(v,w){if($("option",w).length==0){$(this).remove()}});if(u){$("input",o).attr("placeholder",u)}if(t&&t=="LIST"){var p=$(q).attr("field_name");$("input",o).remove();$($('select[name="'+p+'"]',o)[0]).show();$('select:not([name="'+p+'"])',o).remove()}});f.chained(m);h.chained(f);b.chained(m);l.chained(b);c.chained(b);if(g&&g.rules){deserializeChainedSelect(e,g.rules,j)}else{if(g){deserializeChainedSelect(e,g,j)}}if($(":selected",m).val()&&($(":selected",m).val()).indexOf("tags")!=-1){addTagsDefaultTypeahead(d)}$(".lhs",e).die().live("change",function(o){o.preventDefault();var n=$(this).val();if(n.indexOf("tags")!=-1){addTagsDefaultTypeahead($(this).closest("td").siblings("td.rhs-block"))}})}function addTagsDefaultTypeahead(c){var b=[];if(!TAGS){var d=Backbone.Collection.extend({url:"/core/api/tags",sortKey:"tag"});tagsCollection=new d();tagsCollection.fetch({success:function(e){TAGS=tagsCollection.models;addTagsArrayasTypeaheadSource(tagsCollection.toJSON(),c)}});return}addTagsArrayasTypeaheadSource(tagsCollection.toJSON(),c)}function addTagsArrayasTypeaheadSource(c,d){var b=[];$.each(c,function(e,f){b.push(f.tag.toString())});$("input",d).typeahead({source:b}).attr("placeholder","Enter Tag").width("92%")}function fillContactCustomFieldsInFilters(c,d,b){$.getJSON("core/api/custom-fields/searchable/scope?scope=CONTACT",function(e){console.log(e);SEARCHABLE_CONTACT_CUSTOM_FIELDS=e;fillCustomFields(e,c,d,b)})}function fillCompanyCustomFieldsInFilters(b,c){if(!COMPANY_CUSTOM_FIELDS){$.getJSON("core/api/custom-fields/searchable/scope?scope=COMPANY",function(d){console.log(d);COMPANY_CUSTOM_FIELDS=d;fillCustomFields(d,b,c,false)})}else{fillCustomFields(COMPANY_CUSTOM_FIELDS,b,c,false)}}function fillCustomFields(l,c,n,e){var h=$("#LHS > select > #custom-fields",c);var o=$("#RHS",c);var d=$("#condition > select",c);var k=" _AGILE_CUSTOM_DIVIDER_";for(var g=0;g<l.length;g++){if(g==0){h.show()}var m=l[g];m.field;if(m.field_type=="DATE"){h.append('<option value="'+m.field_label+'_time" field_type="'+m.field_type+'">'+m.field_label+"</option>");d.find("option.created_time").addClass(m.field_label+"_time")}else{if(m.field_type=="NUMBER"){h.append('<option value="'+m.field_label+'_number" field_type="'+m.field_type+'">'+m.field_label+"</option>");d.find("option.lead_score").addClass(m.field_label+"_number")}else{h.append('<option value="'+m.field_label+'" field_type="'+m.field_type+'" >'+m.field_label+"</option>")}}d.append('<option value="EQUALS" class="'+m.field_label+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+'">is</option>');d.append('<option value="NOTEQUALS" class="'+m.field_label+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+"\">isn't</option>");if(e){d.append('<option value="MATCHES" class="'+m.field_label+' custom_field" field_name="'+m.field_label+'">contains</option>');d.append('<option value="NOT_CONTAINS" class="'+m.field_label+' custom_field" field_name="'+m.field_label+"\">doesn't contain</option>")}if(m.field_type=="LIST"){var b=m.field_data.split(";");c="<select style='display:none' name='"+m.field_label+"'>";for(var f=0;f<b.length;f++){c=c+'<option value="'+b[f]+'" class="EQUALS NOTEQUALS MATCHES NOT_CONTAINS" field_type="'+m.field_type+'">'+b[f]+"</option>"}c=c+"</select>";o.append(c)}console.log(o[0])}if(n&&typeof(n)==="function"){n()}}var CANCELED="Canceled";var SIGN_UP="Signup";var CAMPAIGN_TAG="Campaigns";var CODE_SETUP_TAG="Code setup";var IMPORT_TAG="Import";var SOCIAL_TAG="Social";var WIDGET_TAG="Widgets";var DOMAIN_COOKIE_FOR_WEBSITE="_agile_login_domain";var ACCOUNT_CANCELED_NOTE_SUBJECT="Account Canceled";var ACCOUNT_CANCELED_CUSTOM_FIELD_NAME="Cancel Reason";function our_domain_set_account(){if(LOCAL_SERVER){_agile.set_account("7n7762stfek4hj61jnpce7uedi","local")}else{_agile.set_account("td2h2iv4njd4mbalruce18q7n4","our")}_agile.set_email(CURRENT_DOMAIN_USER.email);_agile.track_page_view()}function add_custom_fields_to_our_domain(b){add_init_tags(function(){get_new_custom_properties_to_add();add_referrar_info_as_note()})}function getDomainCustomField(){var b=getProperty(Agile_Contact.properties,"Domain");if(!b||b.value!=CURRENT_DOMAIN_USER.domain){return create_contact_custom_field("Domain",CURRENT_DOMAIN_USER.domain,"CUSTOM")}}function get_new_custom_properties_to_add(b){addLoggedInTime(function(){addDomain(b)})}function addDomain(c){var b=getDomainCustomField();if(!b){if(c&&typeof c==="function"){c()}return}property_request(b,c)}function addLoggedInTime(c){var b=new_current_loggedin_time();if(!b){processCallback(c);return}property_request(b,c)}function processCallback(b){if(b&&typeof b==="function"){b()}}function property_request(b,c){_agile.add_property(b,function(d){Agile_Contact=d;_agile_contact=d;processCallback(c)})}function add_init_tags(c){var b="";
b=SIGN_UP;if(CURRENT_DOMAIN_USER.is_account_owner){b+=",Domain Owner"}add_miltiple_tags(b,c)}function add_miltiple_tags(c,f){var b=c.split(",");var e="";for(var d=0;d<b.length;d++){if(hasTagInContact(b[d])){continue}if(e.length>0){e+=","+b[d]}else{e+=b[d]}}if(e.length==0){if(f&&typeof(f)==="function"){f()}return}add_multiple_tags_request(e.trim(),f)}function add_multiple_tags_request(b,c){_agile.add_tag(b,function(d){Agile_Contact=d;if(c&&typeof(c)==="function"){c(d)}})}function new_current_loggedin_time(){var c=new Date();var b=c.getUTCMonth()+1+"/"+c.getUTCDate()+"/"+c.getUTCFullYear();console.log(parseInt(c.getTime()/1000));var e=getProperty(Agile_Contact.properties,"Last login");var g="";var d=true;if(e){var f=new Date(parseFloat(e.value)*1000);g=f.getUTCMonth()+1+"/"+f.getUTCDate()+"/"+f.getUTCFullYear();d=false}if(g&&g==b){return}e=create_contact_custom_field("Last login",parseInt(c.getTime()/1000),"CUSTOM");return e}function create_contact_custom_field(c,f,e,b){if(!c){return}var d={};d.name=c;d.value=f;d.subtype=e;console.log(f);return d}function add_account_canceled_info(c,d){var b=create_contact_custom_field(ACCOUNT_CANCELED_CUSTOM_FIELD_NAME,c.reason,"CUSTOM");_agile.add_property(b,function(e){add_tag_our_domain(CANCELED,function(g){if(c.reason_info){var f={};f.subject=ACCOUNT_CANCELED_NOTE_SUBJECT;f.description=c.reason_info;_agile.add_note(f,function(h){console.log(h);Agile_Contact=h;if(d&&typeof(d)==="function"){d()}});return}if(d&&typeof(d)==="function"){d()}})})}function add_referrar_info_as_note(){var f=readCookie("_agile_utm_source");var c=readCookie("_agile_utm_campaign");var b=readCookie("_agile_utm_medium");var d=readCookie("agile_reference_domain");if(f&&c&&b&&d){var e={};e.subject="Referrer";e.description="Source - "+f+"\n Campaign -  "+c+"\n Medium - "+b+"\n Reference Domain -"+d;_agile.add_note(e,function(g){console.log(g);eraseCookie("agile_reference_domain")})}}function add_timezone_tag(){var b=new Date();var c=b.getUTCHours();if(c>=3&&c<=15){add_tag_our_domain("GMT")}}function our_domain_sync(){try{our_domain_set_account();var c=readCookie(DOMAIN_COOKIE_FOR_WEBSITE);if(!c||c!=CURRENT_DOMAIN_USER.domain){createCookieInAllAgileSubdomains(DOMAIN_COOKIE_FOR_WEBSITE,CURRENT_DOMAIN_USER.domain,365)}get_contact_from_our_domain(function(d){Agile_Contact=d;add_custom_fields_to_our_domain();initWebrules()},function(g){var e=CURRENT_DOMAIN_USER.name;e=e.trim();var f=e.split(" ")[0].trim();var d=(f.length<e.length)?e.substring(f.length+1).trim():"";_agile.create_contact({email:CURRENT_DOMAIN_USER.email,first_name:f,last_name:d},function(h){Agile_Contact=h;add_custom_fields_to_our_domain();initWebrules()})})}catch(b){}}function get_contact_from_our_domain(b,c){agile_getContact(CURRENT_DOMAIN_USER.email,{success:function(d){Agile_Contact=d;if(b&&typeof(b)==="function"){b(d)}},error:function(d){if(c&&typeof(c)==="function"){c(d)}}})}function add_signup_tag(b){if(!Agile_Contact.tags||Agile_Contact.tags.indexOf(SIGN_UP)<0){add_tag_our_domain(SIGN_UP,function(c){add_custom_fields_to_our_domain();if(b&&typeof(b)==="function"){b()}});return}add_custom_fields_to_our_domain()}function setup_our_domain_sync(){our_domain_sync()}function checkTagAgile(b){console.log(Agile_Contact);if(Agile_Contact&&Agile_Contact.tags){return Agile_Contact.tags.indexOf(b)>-1}return false}function hasTagInContact(b){if(!b){return false}if(Agile_Contact&&(!Agile_Contact.tags||Agile_Contact.tags.indexOf(b)<0)){return false}return true}function add_tag_our_domain(b,c){if(hasTagInContact(b)){if(c&&typeof(c)==="function"){c(Agile_Contact)}return}_agile.add_tag(b,function(d){Agile_Contact=d;if(c&&typeof(c)==="function"){c(d)}})}function addTagAgile(b){if(checkTagAgile(b)){return}_agile.add_tag(b,function(c){Agile_Contact=c;if(!checkTagAgile(b)){Agile_Contact.tags.push(b)}})}function add_property(b,e,c,f){var d=getProperty(Agile_Contact.properties,b);if(d&&d.value==e&&c==d.type){f(Agile_Contact);return false}_agile.add_property(create_contact_custom_field(b,e,c),function(g){Agile_Contact=g;_agile_contact=g;if(f&&typeof f=="function"){f(g)}})}var GLOBAL_WEBRULE_FLAG;function initWebrules(){_agile_execute_web_rules();GLOBAL_WEBRULE_FLAG=true}function add_properties_from_popup(c,b){_agile.add_property(create_contact_custom_field("Company Size",b,"CUSTOM"),function(d){_agile.add_property(create_contact_custom_field("phone",c,"SYSTEM","home"),function(e){console.log(e);_agile_contact=e;console.log(_agile_contact);window.setTimeout(initWebrules,4000)})})}function add_created_user_info_as_note_to_owner(b,d){var c={};c.subject="User created";c.description=" Domain - "+b.domain+"\n User Email -  "+b.created_user_email;_agile.add_note(c,function(e){if(d&&typeof d=="function"){d(e)}},b.email)}function add_cancel_subscription_info_as_note_to_owner(b,d){var c={};c.subject="Subscription Cancelled";c.description=" Subscription cancelled by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(e){if(d&&typeof d=="function"){d(e)}},b)}function add_delete_user_info_as_note_to_owner(b,d){var c={};c.subject="User Deleted ";c.description=" One user deleted by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(e){if(d&&typeof d=="function"){d(e)}},b)}function add_refunded_info_as_note_to_owner(b,c,e){var d={};d.subject="Amount Refunded ";d.description="Amount $"+c+" refunded by "+CURRENT_DOMAIN_USER.email;_agile.add_note(d,function(f){if(e&&typeof e=="function"){e(f)}},b)}function add_password_change_info_as_note_to_owner(b,d){var c={};c.subject="Password Changed ";c.description=" Password changed by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(e){if(d&&typeof d=="function"){d(e)}},b)}function add_plan_change_info_as_note_to_owner(b,e,c,f,g){var d={};d.subject="Plan Changed ";d.description=" Plan changed to "+e+" ("+c+"*"+f+") by "+CURRENT_DOMAIN_USER.email;_agile.add_note(d,function(h){if(g&&typeof g=="function"){g(h)}},b)}$(function(){try{if(_agile){setup_our_domain_sync();return}head.js("stats/min/agile-min.js",function(){setup_our_domain_sync()})}catch(b){console.log()}});function add_cancel_subscription_info_as_note_to_owner(b,d){var c={};c.subject="Subscription Cancelled";c.description=" Subscription cancelled by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(e){if(d&&typeof d=="function"){d(e)}},b)}function add_delete_user_info_as_note_to_owner(b,d){var c={};c.subject="User Deleted ";c.description=" One user deleted by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(e){if(d&&typeof d=="function"){d(e)}},b)}function add_refunded_info_as_note_to_owner(b,c,e){var d={};d.subject="Amount Refunded ";d.description="Amount $"+c+" refunded by "+CURRENT_DOMAIN_USER.email;_agile.add_note(d,function(f){if(e&&typeof e=="function"){e(f)}},b)}function add_password_change_info_as_note_to_owner(b,d){var c={};c.subject="Password Changed ";c.description=" Password changed by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(e){if(d&&typeof d=="function"){d(e)}},b)}function add_plan_change_info_as_note_to_owner(b,e,c,f,g){var d={};d.subject="Plan Changed ";d.description=" Plan changed to "+e+" ("+c+"*"+f+") by "+CURRENT_DOMAIN_USER.email;_agile.add_note(d,function(h){if(g&&typeof g=="function"){g(h)}},b)}var Widgets_View;var widget_template_loaded_map={};function loadWidgets(e,b){var f={contact:b};var d=false;if(!Widgets_View){d=true;Widgets_View=new Base_Collection_View({url:"/core/api/widgets",restKey:"widget",templateKey:"widgets",individual_tag_name:"li",sortKey:"position",modelData:f,postRenderCallback:function(h){head.load("css/misc/agile-widgets.css",function(){if(d){set_up_widgets(e,h)}d=false})}});Widgets_View.collection.fetch();var g=Widgets_View.render().el;$("#widgets",e).html(g)}else{var c=false;$(e).live("view_loaded",function(h){if(c==false){c=true;Widgets_View.collection.sort();$("#widgets",e).html(Widgets_View.render(true).el);set_up_widgets(e,Widgets_View.el)}})}$(".widget-minimize").die().live("click",function(m){m.preventDefault();var l=$(this).attr("widget");$("#"+l).collapse("hide");$(this).removeClass();$(this).addClass("collapsed");$(this).addClass("widget-maximize");$(this).addClass("icon-plus");var k=Widgets_View.collection.where({name:l})[0];var j=k.toJSON();k.set({is_minimized:true},{silent:true});j.is_minimized=true;var h=new BaseModel();h.url="core/api/widgets";h.save(j,{silent:true})});$(".widget-maximize").die().live("click",function(n){n.preventDefault();var m=$(this).attr("widget");var l=Widgets_View.collection.where({name:m})[0];var k=l.toJSON();k.is_minimized=false;l.set({is_minimized:false},{silent:true});var j=new BaseModel();j.url="core/api/widgets";j.save(k,{silent:true});var h=$(this).hasClass("collapsed");$(this).removeClass();$(this).addClass("widget-minimize");$(this).addClass("icon-minus");if(h){$("#"+m).collapse("show");return}$.get(l.get("url"),"script")})}function set_up_widgets(c,b){_(Widgets_View.collection.models).each(function(e){var g=e.get("id");var d=e.get("url");e.set("selector",e.get("name").replace(/ +/g,""));$("#"+e.get("selector"),b).data("model",e);var f=App_Contacts.contactDetailView.model.get("id");if(!e.get("is_minimized")&&e.get("widget_type")!="CUSTOM"){if(widget_template_loaded_map[e.get("name").toLowerCase()]){queueGetRequest("_widgets_"+f,d,"script")}else{downloadTemplate(e.get("name").toLowerCase()+".js",function(){widget_template_loaded_map[e.get("name").toLowerCase()]=true;queueGetRequest("_widgets_"+f,d,"script")})}}if(e.get("widget_type")=="CUSTOM"){if($("#"+e.get("selector")+"-container").length){setup_custom_widget(e,b)}else{$("#"+e.get("selector")+"-container",b).show("0",function(h){setup_custom_widget(e,b)})}}},this);enableWidgetSoring(b)}function setup_custom_widget(c,b){try{if(c.get("script")){$("#"+c.get("selector"),b).html(c.get("script"))}else{getScript(c,function(e){console.log(e);$("#"+c.get("selector"),b).html(e)})}}catch(d){console.log(d)}}function getScript(b,e){try{var d=agile_crm_get_contact()["id"];$.post("core/api/widgets/script/"+d+"/"+b.get("name"),function(f){if(e&&typeof(e)==="function"){e(f)
}}).error(function(f){console.log(f);console.log(f.responseText)})}catch(c){console.log(c)}}function enableWidgetSoring(b){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".widget-sortable",b).sortable();$(".widget-sortable",b).sortable("option","handle",".icon-move");$(".widget-sortable",b).on("sortstop",function(c,d){var e=[];$(".widget-sortable > li",b).each(function(h,j){var f=$(j).find(".widgets").attr("id");var g=$("#"+f).data("model");g.set({position:h},{silent:true});e.push({id:g.get("id"),position:h})});$.ajax({type:"POST",url:"/core/api/widgets/positions",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json"})})})}function queueGetRequest(f,e,d,b,c){console.log(f+", "+e);head.js("/js/lib/ajaxm/ajaxq.js",function(){try{$.ajaxq(f,{url:e,cache:false,dataType:d,success:function(h){console.log("Sucesses",e);if(b&&typeof(b)==="function"){b(h)}},error:function(h){console.log("error",e);if(c&&typeof(c)==="function"){c(h)}},complete:function(h){console.log("completed get")}})}catch(g){console.log(g)}})}function queuePostRequest(e,c,d,f,b){head.js("/js/lib/ajaxm/ajaxq.js",function(){try{$.ajaxq(e,{type:"POST",url:c,cache:false,data:d,success:function(h){if(f&&typeof(f)==="function"){f(h)}},error:function(h){if(b&&typeof(b)==="function"){b(h)}},complete:function(h){console.log("completed post")}})}catch(g){console.log(g)}})}function queueClear(b){console.log("clear queue.");if(document.ajaxq){document.ajaxq.q[b]=[]}}function showIcons(b){$(b).find("div.widget_header_icons").show();$(b).find("div.widget_header_name").css({width:"40%"})}function hideIcons(b){$(b).find("div.widget_header_icons").hide();$(b).find("div.widget_header_name").css({width:"80%"})}$(function(){$("#twilio_verify_settings").die().live("click",function(b){b.preventDefault();$("#widget-settings").html(getTemplate("twilio-initial",{}))});$("#twilio_verify").die().live("click",function(c){c.preventDefault();if(!isValidForm($("#twilio_call_form"))){return}var b=$("#twilio_from").val();console.log("Twilio verify from number: "+b);$.getJSON("core/api/widgets/Twilio",function(d){console.log(d);if(d){verifyNumberFromTwilio(b,d.id,function(e){e.settings=true;e.id=Math.floor((Math.random()*10)+1);console.log(e);console.log(getTemplate("twilio-verify",e));$("#widget-settings").html(getTemplate("twilio-verify",e))})}})})});function verifyNumberFromTwilio(b,d,c){$.getJSON("/core/api/widgets/twilio/verify/numbers/"+d+"/"+b,function(e){console.log("Twilio verified_data "+e);if(!e){return}if(c&&typeof(c)==="function"){c(e)}}).error(function(f){var e=Math.floor((Math.random()*10)+1);setUpError("Twilio","widget-settings-error",f.responseText,window.location.protocol+"//"+window.location.host+"/#Twilio/twilio"+e)});return}var Twilio_Call_Noty;var Twilio_Call_Noty_IMG="";var To_Number;var To_Name="";var Twilio_Token;var Verfied_Number;var globalconnection;var Twilio_Setup_Called=false;var Twilio_Start=false;var Restart_Twilio=false;TWILIO_CONTACT_ID=0;TWILIO_CALLTYPE="";TWILIO_DIRECTION="";TWILIO_CALLED_NO="";TWILIO_IS_VOICEMAIL=false;$(function(){setTimeout(function(){if(document.readyState==="complete"){globalTwilioIOSetup()}},10000);$(".noty_twilio_mute").die().live("click",function(b){b.preventDefault();console.log("Twilio call noty_twilio_mute from noty");globalconnection.mute(true);$(".noty_buttons").find(".noty_twilio_unmute").toggle();$(".noty_buttons").find(".noty_twilio_mute").toggle()});$(".noty_twilio_unmute").die().live("click",function(b){b.preventDefault();console.log("Twilio call noty_twilio_unmute from noty");globalconnection.mute(false);$(".noty_buttons").find(".noty_twilio_unmute").toggle();$(".noty_buttons").find(".noty_twilio_mute").toggle()});$(".noty_twilio_hangup").die().live("click",function(b){b.preventDefault();console.log("Twilio call hang up from noty");Twilio.Device.disconnectAll()});$(".noty_twilio_dialpad").die().live("click",function(b){b.preventDefault();console.log("Twilio call dailpad from noty");$(".noty_buttons").find("#dialpad_in_twilio").toggle()});$("#noty_twilio_voicemail").die().live("click",function(c){c.preventDefault();var b=parseInt($(this).attr("data-length"));if(b===1){sendVoiceAndEndCall($(this).attr("data-src"))}else{$("#splitButtonVoicemail").trigger("click")}});$(".voiceMailItem").die().live("click",function(b){b.preventDefault();sendVoiceAndEndCall($(this).attr("data-src"))});$(".noty_twilio_answer").die().live("click",function(b){b.preventDefault();console.log("Twilio call answered from noty");globalconnection.accept()});$(".noty_twilio_ignore").die().live("click",function(b){b.preventDefault();console.log("Twilio call ignore from noty");globalconnection.ignore()});$(".noty_twilio_cancel").die().live("click",function(b){b.preventDefault();console.log("Twilio call canceld from noty");Twilio.Device.disconnectAll()});$("#validate_account").die().live("click",function(d){d.preventDefault();console.log("In validate event");if($(this).text()=="Validating..."){console.log("Do not hit me again "+$(this).text());return}if(!isValidForm($("#twilioio_login_form"))){return}var b=$("#twilio_acc_sid").val();var c=$("#twilio_auth_token").val();$("#validate_account").text("Validating...");$("#validate_account").attr("disabled",true);getValidateAndVerfiedCallerId(b,c,null)});$("#twilio_number").die().live("change",function(c){c.preventDefault();$("#error-number-not-selected").hide();var b=$("#twilio_number option:selected").attr("data");console.log("twilio_number change");console.log("twilio_number "+$(this).val()+" clicked "+b);$("#twilio_number_sid").val(b)});$("#twilio_from_number").die().live("change",function(b){b.preventDefault();$("#error-number-not-selected").hide()});$(".contact-make-twilio-call").die().live("click",function(c){c.preventDefault();TWILIO_CALLTYPE="Outgoing";TWILIO_DIRECTION="outbound-dial";TWILIO_IS_VOICEMAIL=false;var b=agile_crm_get_contact();TWILIO_CONTACT_ID=b.id;if(Twilio.Device.status()=="busy"){alert("Already on call.");return}console.log("phone: "+$(this).attr("phone"));twiliocall($(this).attr("phone"),getContactName(b))});$("#twilio_acc_sid","#twilio_auth_token").die().live("click",function(b){b.preventDefault();$("#note-number-not-available").hide()});$(".twilioio-advance-settings").die().live("click",function(b){b.preventDefault();if("None"==$("#twilio_twimlet_url").val()){$("#twilio_twimlet_url").val("")}$(".twilioio-advance-settings-hide").toggle();$(".twilioio-advance-settings-show").toggle();$("#twilio_recording").toggle();$("#twilio_twimlet_url_controls").toggle()})});function globalTwilioIOSetup(){console.log("Twilio_Setup_Called: "+Twilio_Setup_Called);if(Twilio_Setup_Called){return}Twilio_Setup_Called=true;$.getJSON("/core/api/widgets/TwilioIO",function(twilioio_widget){console.log("twilioio_widget");console.log(twilioio_widget);if(twilioio_widget==null){return}if(twilioio_widget.prefs!=undefined){twilioio_widget.prefs=eval("("+twilioio_widget.prefs+")");if(twilioio_widget.prefs.twilio_from_number){Verfied_Number=twilioio_widget.prefs.twilio_from_number}else{Verfied_Number=twilioio_widget.prefs.twilio_number}getGlobalToken()}}).error(function(data){console.log("twilioio error");console.log(data)})}function getGlobalToken(){console.log("****** In getGlobalToken ******");Restart_Twilio=false;$.get("/core/api/widgets/twilio/getglobaltoken",function(b){console.log("Twilio token "+b);Twilio_Token=b;setUpGlobalTwilio();setTimeout(function(){if(Twilio.Device.status()=="busy"){Restart_Twilio=true}else{globalTwilioIOSetup()}},86400000)}).error(function(b){console.log("Twilio IO error ");console.log(b)})}function getValidateAndVerfiedCallerId(acc_sid,auth_token,callback){$.get("/core/api/widgets/twilio/validateaccount/"+acc_sid+"/"+auth_token,function(result){console.log("Twilio validate account "+result);console.log(result);result=eval("("+result+")");console.log("Twilio validate account "+result);if(result){getTwilioNumbers(acc_sid,auth_token,function(twilioNumbers){getVerifiedNumbers(acc_sid,auth_token,function(verifiedNumbers){addNumbersInUI(twilioNumbers,verifiedNumbers);if(callback&&typeof(callback)==="function"){callback(result)}})})}else{setToValidate(result,true)}}).error(function(data){console.log("Twilio validate account error");setToValidate(data,true)})}function addNumbersInUI(c,b){console.log("Twilio twilio number "+c+"  "+b);console.log("Twilio twilio number "+c.length+"  "+b.length);if(c.length==0&&b.length==0){setToValidate("no number",false);$("#note-number-not-available").html("You have no twilio numbers and verified numbers.");$("#note-number-not-available").show()}else{if(c.length!=0&&b.length==0){$("#note-number-not-available").html("You have no verified numbers. Please verify number in your Twilio account.");$("#note-number-not-available").show();if(!c[0].PhoneNumber){alert("You have no twilio numbers. Please buy or port a number in your Twilio account.");return}console.log("Twilio twilio number "+c[0].PhoneNumber);addTwilioNumbersInUI(c);$("#validate_account").hide();$("#save_prefs").show();$("#twilio_from_numbers").hide();$("#twilio_numbers").show();$("#twilio_number").addClass("required")}else{if(c.length==0&&b.length!=0){$("#note-number-not-available").html("You have no twilio numbers. Please buy or port a number in your Twilio account.");$("#note-number-not-available").show();if(!b[0].PhoneNumber){alert("You have no verified numbers. Please verify number in your Twilio account.");return}console.log("Twilio verified number "+b[0].PhoneNumber);addVerifiedCallerIdInUI(b);$("#validate_account").hide();$("#save_prefs").show();$("#twilio_from_numbers").show();$("#twilio_numbers").hide();$("#twilio_from_number").addClass("required")}else{if(c.length!=0&&b.length!=0){addTwilioNumbersInUI(c);addVerifiedCallerIdInUI(b);$("#validate_account").hide();$("#save_prefs").show();$("#twilio_from_numbers").show();$("#twilio_numbers").show()}}}}}function setToValidate(c,b){$("#validate_account").text("Validate");$("#validate_account").attr("disabled",false);
console.log("Twilio error ");console.log(c);if(b){alert("Please enter valid details.")}$("#twilioio_login_form").each(function(){this.reset()})}function getTwilioNumbers(acc_sid,auth_token,callback){$.get("/core/api/widgets/twilio/gettwilionumbers/"+acc_sid+"/"+auth_token,function(result){console.log("Twilio getTwilioNumbers "+result);console.log(result);result=eval("("+result+")");console.log("Twilio getTwilioNumbers "+result);if(callback&&typeof(callback)==="function"){callback(result)}}).error(function(data){console.log("error in getTwilioNumbers");setToValidate(data,true)})}function getVerifiedNumbers(acc_sid,auth_token,callback){$.get("/core/api/widgets/twilio/getverifiednumbers/"+acc_sid+"/"+auth_token,function(result){console.log("Twilio getVerifiedNumbers "+result);console.log(result);result=eval("("+result+")");console.log("Twilio getVerifiedNumbers "+result);if(callback&&typeof(callback)==="function"){callback(result)}}).error(function(data){console.log("error in getVerifiedNumbers");setToValidate(data,true)})}function addTwilioNumbersInUI(b){var d='<option value="" default selected style="display:none;">Select a Twilio number</option>';var c="";$.each(b,function(f,e){c='<option data="'+e.Sid+'" value="'+e.PhoneNumber+'">'+e.PhoneNumber+"</option>";d=d+c});c='<option data="" value="">None</option>';d=d+c;$("#twilio_number").html(d)}function addVerifiedCallerIdInUI(b){var d='<option value="" default selected style="display:none;">Select a verifed number</option>';var c="";$.each(b,function(f,e){c='<option value="'+e.PhoneNumber+'">'+e.PhoneNumber+"</option>";d=d+c});c='<option data="" value="">None</option>';d=d+c;$("#twilio_from_number").html(d)}function createAppSid(c,d){console.log("In createAppSid");var b="None";if(c.twilio_number_sid!=""){b=c.twilio_number_sid}if(c.twilio_twimlet_url==""){c.twilio_twimlet_url="None"}$.get("/core/api/widgets/twilio/createappsid/"+c.twilio_acc_sid+"/"+c.twilio_auth_token+"/"+b+"/"+c.twilio_record+"/"+encodeURIComponent(c.twilio_twimlet_url),function(e){console.log("Twilio createAppSid "+e);if(d&&typeof(d)==="function"){d(e)}}).error(function(e){console.log("Twilio get app sid error ");console.log(e);alert("Please try again with valid details.");$("#save_prefs").text("Save");$("#save_prefs").attr("disabled",false);$("#save_prefs").hide();$("#validate_account").text("Validate");$("#validate_account").attr("disabled",false);$("#validate_account").show();$("#twilio_from_numbers").hide();$("#twilio_numbers").hide();$("#twilioio_login_form").each(function(){this.reset()})})}function fill_twilioio_numbers(){$("#validate_account").hide();$("#save_prefs").show();$("#save_prefs").text("Loading...");$("#save_prefs").attr("disabled",true);$.getJSON("/core/api/widgets/TwilioIO",function(twilioio_widget){if(twilioio_widget==null){return}console.log("twilioio_widget");console.log(twilioio_widget);if(twilioio_widget.prefs!=undefined){twilioio_widget.prefs=eval("("+twilioio_widget.prefs+")");if((twilioio_widget.prefs.twilio_record=="true")||(twilioio_widget.prefs.twilio_twimlet_url!="None")){$(".twilioio-advance-settings").click()}getValidateAndVerfiedCallerId(twilioio_widget.prefs.twilio_acc_sid,twilioio_widget.prefs.twilio_auth_token,function(data){console.log("In callback getValidateAndVerfiedCallerId");$("#twilio_from_number").val(twilioio_widget.prefs.twilio_from_number);$("#twilio_number").val(twilioio_widget.prefs.twilio_number);$("#twilio_number_sid").val(twilioio_widget.prefs.twilio_number_sid);$("#save_prefs").text("Save");$("#save_prefs").attr("disabled",false)})}}).error(function(data){console.log("twilioio_widget error");console.log(data)})}function setUpGlobalTwilio(){head.js("https://static.twilio.com/libs/twiliojs/1.2/twilio.min.js",function(){Twilio.Device.setup(Twilio_Token);if(Twilio_Start){return}Twilio_Start=true;Twilio.Device.ready(function(b){console.log("ready");console.log("in twilio ready Twilio_Setup_Called: "+Twilio_Setup_Called);Twilio_Setup_Called=false;if(Sip_Stack!=undefined&&Sip_Register_Session!=undefined&&Sip_Start==true){$(".contact-make-sip-call").show();$(".contact-make-twilio-call").hide();$(".contact-make-call").hide()}else{if(Twilio.Device.status()=="ready"||Twilio.Device.status()=="busy"){$(".contact-make-sip-call").hide();$(".contact-make-twilio-call").show();$(".contact-make-call").hide()}}});Twilio.Device.error(function(b){console.log("Twilio error");console.log(b);console.log(b.code);if(Twilio.Device.status()=="busy"){alert("A connection is currently active.");return}closeTwilioNoty();if(b.code=="31205"){globalTwilioIOSetup()}});Twilio.Device.connect(function(b){console.log("Twilio call is connected");console.log(b);console.log(b._status);globalconnection=b;showCallNotyPopup("connected","Twilio",Twilio_Call_Noty_IMG+'<span class="noty_contact_details"><b>On call  </b>'+To_Number+'<br><a href="#contact/'+TWILIO_CONTACT_ID+'" style="color: inherit;">'+To_Name+'</a><br></span><div class="clearfix"></div>',false)});Twilio.Device.disconnect(function(f){console.log("Twilio call is disconnected");console.log(f);var o=To_Number;var d=f.message;if(Twilio.Device.status()!="busy"){closeTwilioNoty();if(Restart_Twilio==true){globalTwilioIOSetup()}}if(window.location.hash.indexOf("contact/")!=-1){if(typeof getTwilioIOLogs=="undefined"){return}getTwilioIOLogs(o);var e=$("#contact_number").val();if(e!=o){$("#contact_number").val(o)}}console.log("calSid new  "+f.parameters.CallSid);var g=twilioGetWidgetDetails();var m=$.parseJSON(g.prefs);var l=m.twilio_acc_sid;var j=m.twilio_auth_token;var h="true";if(TWILIO_CALLTYPE=="Incoming"){h="false"}var b="/core/api/widgets/twilio/getlastcall/"+l+"/"+j+"/"+f.parameters.CallSid+"/"+h;console.log(b);if(!g){return}var n=twilioApiRequest(b);console.log("Call Details : isParent "+h);console.log(n);if(!n){return}var k=$.parseJSON(n.responseText);if(h=="true"){var c=k.calls[0]}else{var c=k}if(typeof c!="undefined"){if(typeof c.status!="undefined"){console.log(c.status);showNoteAfterCall(c,d)}}else{return}});Twilio.Device.incoming(function(b){TWILIO_CALLTYPE="Incoming";TWILIO_DIRECTION="inbound";TWILIO_IS_VOICEMAIL=false;TWILIO_CONTACT_ID=0;console.log("Incoming connection from "+b.parameters.From);if(Twilio.Device.status()=="busy"){console.log("getting one more call.");showCallNotyPopup("missedCall","error",Twilio_Call_Noty_IMG+'<span class="noty_contact_details"><b>Missed call : </b><br>'+b.parameters.From+'<br></span><div class="clearfix"></div>',5000);b.reject();if(b){b.disconnect()}return}globalconnection=b;console.log("globalconnection");console.log(globalconnection);console.log("globalconnection status: "+globalconnection.status());To_Number=globalconnection.parameters.From;To_Name=searchForContact(To_Number);Twilio_Call_Noty_IMG=addContactImg("Incoming");showCallNotyPopup("incoming","Twilio",Twilio_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Incoming call </b>'+To_Number+'<br><a href="#contact/'+TWILIO_CONTACT_ID+'" style="color: inherit;">'+To_Name+'</a><br></span><div class="clearfix"></div>',false)});Twilio.Device.offline(function(){console.log("Twilio went offline");closeTwilioNoty()});Twilio.Device.cancel(function(e){console.log(e.parameters.From);closeTwilioNoty();console.log("Incoming call calSid new  "+e.parameters.CallSid);var d=e.message;var f=twilioGetWidgetDetails();var k=$.parseJSON(f.prefs);var j=k.twilio_acc_sid;var h=k.twilio_auth_token;var g="true";if(TWILIO_CALLTYPE=="Incoming"){g="false"}var b="/core/api/widgets/twilio/getlastcall/"+j+"/"+h+"/"+e.parameters.CallSid+"/"+g;console.log(b);if(!f){return}var l=twilioApiRequest(b);console.log(l);if(!l){return}var c=$.parseJSON(l.responseText);if(typeof c!="undefined"){if(typeof c.status!="undefined"){console.log(c.status);showNoteAfterCall(c,d)}}else{return}});Twilio.Device.presence(function(b){console.log(b.from);console.log(b.available)})})}function twiliocall(c,b){params={from:Verfied_Number,PhoneNumber:c};Twilio.Device.connect(params);To_Number=c;To_Name=b;TWILIO_CALLED_NO=To_Number;Twilio_Call_Noty_IMG=addContactImg("Outgoing");showCallNotyPopup("outgoing","Twilio",Twilio_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Calling </b>'+To_Number+'<br><a href="#contact/'+TWILIO_CONTACT_ID+'" style="color: inherit;">'+To_Name+'</a><br></span><div class="clearfix"></div>',false)}function twilioSendDTMF(b){console.log("twilioSendDTMF: "+b);if(Twilio.Device.status()=="busy"&&b){globalconnection.sendDigits(b)}}function closeTwilioNoty(){if(Twilio.Device.status()=="busy"){return}globalconnection=undefined;To_Number=undefined;To_Name="";if(Twilio_Call_Noty!=undefined){Twilio_Call_Noty.close();Twilio_Call_Noty=undefined}}function showNoteAfterCall(b,d){if(TWILIO_IS_VOICEMAIL==false){var c=$("#noteForm");if(TWILIO_CONTACT_ID){var j=$.parseJSON($.ajax({url:"core/api/contacts/"+TWILIO_CONTACT_ID,async:false,dataType:"json"}).responseText);console.log(b);if(j==null){return showNewContactModal(d)}var g=getContactName(j);var e="";var h="";var f=b.status;if(f!=404&&typeof b.duration!="undefined"){var k="";if(TWILIO_DIRECTION=="outbound-dial"){k=TWILIO_CALLED_NO;TWILIO_CALLED_NO=""}else{k=b.from}$.post("/core/api/widgets/twilio/savecallactivity",{direction:TWILIO_DIRECTION,phone:k,status:b.status,duration:b.duration});switch(f){case"canceled":e=TWILIO_CALLTYPE+" call - Declined";h="Declined";break;case"completed":e=TWILIO_CALLTYPE+" call - Done";h="Done";break;case"busy":e=TWILIO_CALLTYPE+" call - Busy";h="Received busy tone on number "+k;break;case"failed":e=TWILIO_CALLTYPE+" call - Failed";h=TWILIO_CALLTYPE+" call made to "+k+" has failed";break;case"no-answer":e=TWILIO_CALLTYPE+" call - No answer";h="No answer";break;default:return}if(f=="completed"){$(".tags",c).html('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+j.id+'">'+g+"</li>");$("#noteForm #subject").val(e);$("#noteForm #description").val("Call duration - "+twilioSecondsToFriendly(b.duration));
$("#noteForm").find("#description").focus();$("#noteModal").modal("show");agile_type_ahead("note_related_to",c,contacts_typeahead)}else{$.post("/core/api/widgets/twilio/autosavenote",{subject:e,message:"",contactid:TWILIO_CONTACT_ID})}}}else{var k="";if(TWILIO_DIRECTION=="outbound-dial"){k=b.to}else{k=b.from}$.post("/core/api/widgets/twilio/savecallactivity",{direction:TWILIO_DIRECTION,phone:k,status:b.status,duration:b.duration});return showNewContactModal(k)}}}function showNewContactModal(b){$("#personModal").modal("show");$("#personForm").find("#phone").val(b);return}function twilioSecondsToFriendly(e){var c=Math.floor(e/3600);if(c>0){e=e-c*60*60}var d=Math.floor(e/60);var f=e-d*60;var b="";if(c==1){b=c+"h "}if(c>1){b=c+"h "}if(d>0){b+=d+"m "}if(f>0){b+=f+"s "}if(b!=""){return b}}function searchForContact(d){console.log("searchForContact : "+d);var c="";var b=$.parseJSON($.ajax({url:"core/api/contacts/search/phonenumber/"+d,async:false,dataType:"json"}).responseText);console.log("**** responseJson ****");console.log(b);if(b!=null){TWILIO_CONTACT_ID=b.id;console.log("TWILIO_CONTACT_ID : "+TWILIO_CONTACT_ID);c=getContactName(b)}return c}function sendVoiceAndEndCall(m){console.log("Sending voice mail...");if(TWILIO_IS_VOICEMAIL==false){var e=globalconnection;var f=twilioGetWidgetDetails();var l=$.parseJSON(f.prefs);var k=l.twilio_acc_sid;var h=l.twilio_auth_token;var g="true";var b="/core/api/widgets/twilio/getlastcall/"+k+"/"+h+"/"+e.parameters.CallSid+"/"+g;if(!f){return}var n=twilioApiRequest(b);if(!n){return}var j=$.parseJSON(n.responseText);if(g=="true"){var c=j.calls[0]}else{var c=j}if(typeof c!="undefined"){if(typeof c.status!="undefined"&&c.status=="in-progress"){var d=globalconnection.message;if(twilioVoiceMailRedirect(m)){closeTwilioNoty();if(TWILIO_CONTACT_ID){$.post("/core/api/widgets/twilio/autosavenote",{subject:TWILIO_CALLTYPE+" call - Left voicemail",message:"",contactid:TWILIO_CONTACT_ID});if(TWILIO_CALLED_NO!=""){$.post("/core/api/widgets/twilio/savecallactivity",{direction:TWILIO_DIRECTION,phone:TWILIO_CALLED_NO,status:"voicemail",duration:0})}TWILIO_IS_VOICEMAIL=true}}}}else{return}}}function twilioVoiceMailRedirect(l){var e=twilioGetWidgetDetails();if(!e){return false}var k=$.parseJSON(e.prefs);var j=k.twilio_acc_sid;var g=k.twilio_auth_token;var f="true";if(TWILIO_CALLTYPE=="Incoming"){f="false"}var b="/core/api/widgets/twilio/getlastcall/"+j+"/"+g+"/"+globalconnection.parameters.CallSid+"/"+f;console.log(b);if(!e){return}var m=twilioApiRequest(b);console.log("Call Details : isParent "+f);console.log(m);if(!m){return}var h=$.parseJSON(m.responseText);if(f=="true"){var c=h.calls[0]}else{var c=h}b="/core/api/widgets/twilio/setvoicemail/"+j+"/"+g+"/"+c.sid+"/"+l;console.log("In ajax send voice mail : "+b);var d=twilioApiRequest(b);return true}function twilioGetWidgetDetails(){return $.parseJSON($.ajax({url:"/core/api/widgets/TwilioIO",async:false,dataType:"json"}).responseText)}function twilioApiRequest(b){return $.parseJSON($.ajax({url:b,async:false,dataType:"json"}).responseText)}function searchForContactImg(d){console.log("searchForContactImg : "+d);var b="";var c=$.parseJSON($.ajax({url:"core/api/contacts/search/phonenumber/"+d,async:false,dataType:"json"}).responseText);console.log("**** responseJson ****");console.log(c);return c}function addContactImg(f){var d="";if(f=="Outgoing"){var e=agile_crm_get_contact();var b=getGravatar(e.properties,40);d='<a href="#contact/'+TWILIO_CONTACT_ID+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+b+'" style="display:inline;"></a>';return d}else{var c=searchForContactImg(To_Number);if(c!=null){var b=getGravatar(c.properties,40);d='<a href="#contact/'+TWILIO_CONTACT_ID+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+b+'" style="display:inline;"></a>'}return d}}function getGravatar(c,e){if(c==undefined){return}var j=getPropertyValue(c,"image");if(j){return j}var b=DEFAULT_GRAVATAR_url;var h='&d=404" ';var g=text_gravatar_initials(c);if(g.length==0){h="&d="+DEFAULT_GRAVATAR_url+'" '}var f='onLoad="image_load(this)" onError="image_error(this)" _data-name="'+g;var d=getPropertyValue(c,"email");if(d){return("https://secure.gravatar.com/avatar/"+Agile_MD5(d)+".jpg?s="+e+h+f)}return("https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+e+""+h+f)}function organize_widgets(b){var c=new Base_List_View({model:b,template:this.options.templateKey+"-model",tagName:"div"});var d=b.get("widget_type");if(d=="SOCIAL"){$("#social",this.el).append($(c.render().el).addClass("span4").css("margin-left","0px"))}if(d=="SUPPORT"){$("#support",this.el).append($(c.render().el).addClass("span4").css("margin-left","0px"))}if(d=="EMAIL"){$("#email",this.el).append($(c.render().el).addClass("span4").css("margin-left","0px"))}if(d=="CALL"){if(b.get("name")=="Twilio"&&!b.get("is_added")){console.log("It is old twilio")}else{$("#call",this.el).append($(c.render().el).addClass("span4").css("margin-left","0px"))}}if(d=="BILLING"){$("#billing",this.el).append($(c.render().el).addClass("span4").css("margin-left","0px"))}if(d=="ECOMMERCE"){$("#ecommerce",this.el).append($(c.render().el).addClass("span4").css("margin-left","0px"))}if(d=="CUSTOM"){$("#custom",this.el).append($(c.render().el).addClass("span4").css("margin-left","0px"))}}$(function(){$(".install-custom-widget").live("click",function(d){d.preventDefault();console.log($(this));if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");var c=$(this).attr("widget-name");console.log("In add widget");console.log(c);if(App_Widgets.Catalog_Widgets_View==null){return}var f=App_Widgets.Catalog_Widgets_View.collection.where({name:c});var b=new Backbone.Model();console.log(b);b.url="/core/api/widgets";b.save(f[0].toJSON(),{success:function(e){if(Widgets_View&&Widgets_View.collection){Widgets_View.collection.add(new BaseModel(e.toJSON()))}e.set("is_added",true);f[0].set(e)}})});$("#delete-widget").die().live("click",function(c){var b=$(this).attr("widget-name");if(!confirm("Are you sure to delete "+b)){return}delete_widget(b);if(b=="Linkedin"){$("#Linkedin-container").hide()}if(b=="Twilio"){$("#Twilio-container").hide()}});$("#remove-widget").die().live("click",function(c){var b=$(this).attr("widget-name");if(!confirm("Are you sure to remove "+b)){return}$.ajax({type:"DELETE",url:"/core/api/widgets/remove?widget_name="+b,contentType:"application/json; charset=utf-8",success:function(d){update_collection(b);App_Widgets.Catalog_Widgets_View.collection.fetch()},dataType:"json"})})});function delete_widget(b){$.ajax({type:"DELETE",url:"/core/api/widgets?widget_name="+b,contentType:"application/json; charset=utf-8",success:function(c){App_Widgets.Catalog_Widgets_View.collection.where({name:b})[0].set("is_added",false);update_collection(b);console.log(App_Widgets.Catalog_Widgets_View.collection);_plan_restrictions.process_widgets(App_Widgets.Catalog_Widgets_View.collection);console.log(App_Widgets.Catalog_Widgets_View.collection);App_Widgets.Catalog_Widgets_View.render(true)},dataType:"json"})}function update_collection(c){if(Widgets_View&&Widgets_View.collection){var b=Widgets_View.collection.where({name:c});Widgets_View.collection.remove(b)}}function build_custom_widget_form(b){var c;$("#add-custom-widget").die().live("click",function(f){c=$("#custom-widget").clone();var d=new Base_Model_View({url:"/core/api/widgets/custom",template:"add-custom-widget",isNew:true,postRenderCallback:function(e){console.log("In post render callback");console.log(e);$("#script_type").die().live("change",function(h){var g=$("#script_type").val();if(g=="script"){$("#script_div").show();$("#url_div").hide();return}if(g=="url"){$("#script_div").hide();$("#url_div").show()}})},saveCallback:function(e){console.log("In save callback");console.log(e);if(e==null){alert("A widget with this name exists already. Please choose a different name")}App_Widgets.Catalog_Widgets_View.collection.add(e);$("#custom-widget").replaceWith(c)}});$("#custom-widget",b).html(d.render(true).el);$("#cancel_custom_widget").die().live("click",function(g){$("#custom-widget").replaceWith(c)})})}$(function(){$("#widget-prefs-save").die().live("click",function(h){h.preventDefault();if($(this).attr("disabled")=="disabled"){return}$(this).attr("disabled","disabled");var f=$(this).parents("form");var g=$(f).data("widget");var b=$(f).attr("id");if(!isValidForm($(f))){$(this).removeAttr("disabled");return}var j=serializeForm(b);try{if(g.prefs){g.prefs=JSON.parse(g.prefs)}else{g.prefs={}}console.log(g.prefs)}catch(d){}$.each(j,function(e,k){g.prefs[e]=k});if(g.prefs){g.prefs=JSON.stringify(g.prefs);update_collection_with_prefs(g)}var c=this;saveEntity(g,"core/api/widgets",function(e){$(f).data("widget",e.toJSON());$(c).removeAttr("disabled");Backbone.history.navigate("add-widget",{trigger:true})})})});function update_collection_with_prefs(b){console.log("In update_collection_with_prefs");console.log(b);if(App_Widgets.Catalog_Widgets_View&&App_Widgets.Catalog_Widgets_View.collection){var c=App_Widgets.Catalog_Widgets_View.collection.where({name:b.name});if(c&&c[0]){c[0].set({prefs:b.prefs});console.log(App_Widgets.Catalog_Widgets_View.collection.where({name:b.name})[0])}}if(Widgets_View&&Widgets_View.collection){var c=Widgets_View.collection.where({name:b.name});if(c&&c[0]){c[0].set({prefs:b.prefs});console.log(Widgets_View.collection.where({name:b.name})[0])}}}function clickdesk_save_widget_prefs(){$("#save_clickdesk_prefs").unbind("click");$("#save_clickdesk_prefs").die().live("click",function(b){b.preventDefault();if(!isValidForm($("#clickdesk_login_form"))){return}saveClickDeskWidgetPrefs()})}function saveClickDeskWidgetPrefs(){var b={};b.clickdesk_username=$("#clickdesk_username").val();b.clickdesk_api_key=$("#clickdesk_api_key").val();save_widget_prefs("ClickDesk",JSON.stringify(b),function(c){console.log("In clickdesk save success");console.log(c)})}function helpscout_save_widget_prefs(){$("#save_api_key").unbind("click");
$("#save_api_key").die().live("click",function(b){b.preventDefault();if(!isValidForm($("#helpscout_login_form"))){return}saveHelpScoutWidgetPrefs()})}function saveHelpScoutWidgetPrefs(){var b={};b.helpscout_api_key=$("#helpscout_api_key").val();save_widget_prefs("HelpScout",JSON.stringify(b),function(c){console.log("In HelpScout save success");console.log(c)})}function freshbook_save_widget_prefs(){$("#freshbooks_save_token").unbind("click");$("#freshbooks_save_token").die().live("click",function(b){b.preventDefault();if(!isValidForm($("#freshbooks_login_form"))){return}savefreshBooksWidgetPrefs()})}function savefreshBooksWidgetPrefs(){var b={};b.freshbooks_apiKey=$("#freshbooks_apiKey").val();b.freshbooks_url=$("#freshbooks_url").val();save_widget_prefs("FreshBooks",JSON.stringify(b),function(c){console.log("In freshbooks save success");console.log(c)})}function rapleaf_save_widget_prefs(){$("#save_api_key").unbind("click");$("#save_api_key").die().live("click",function(b){b.preventDefault();if(!isValidForm($("#rapleaf_login_form"))){return}saveRaplefWidgetPrefs()})}function saveRaplefWidgetPrefs(){var b={};b.rapleaf_api_key=$("#rapleaf_api_key").val();save_widget_prefs("Rapleaf",JSON.stringify(b),function(c){console.log("In Rapleaf save success");console.log(c)})}function zendesk_save_widget_prefs(){$("#save_prefs").unbind("click");$("#save_prefs").die().live("click",function(b){b.preventDefault();if(!isValidForm($("#zendesk_login_form"))){return}saveZendeskWidgetPrefs()})}function saveZendeskWidgetPrefs(){var c={};c.zendesk_username=$("#zendesk_username").val();c.zendesk_password=$("#zendesk_password").val();var b=$("#zendesk_url").val();if(b.indexOf("https")==-1){b=b.replace("http","https")}c.zendesk_url=b;save_widget_prefs("Zendesk",JSON.stringify(c),function(d){console.log("In zendesk save success");console.log(d)})}function sip_save_widget_prefs(){$("#save_prefs").unbind("click");$("#save_prefs").die().live("click",function(b){b.preventDefault();if(!isValidForm($("#sip_login_form"))){return}saveSipWidgetPrefs()})}function saveSipWidgetPrefs(){var b={};b.sip_username=$("#sip_username").val();b.sip_privateid=$("#sip_privateid").val();b.sip_realm=$("#sip_realm").val();b.sip_password=$("#sip_password").val();b.sip_publicid="sip:"+$("#sip_privateid").val()+"@"+$("#sip_realm").val();if($("#sip_wsenable").is(":checked")){b.sip_wsenable="true"}else{b.sip_wsenable="false"}console.log(b);save_widget_prefs("Sip",JSON.stringify(b),function(c){console.log("In sip save success");console.log(c)})}function twilioio_save_widget_prefs(){$("#save_prefs").unbind("click");$("#save_prefs").die().live("click",function(b){b.preventDefault();$("#error-number-not-selected").hide();if($(this).text()=="Saving..."||$(this).text()=="Loading..."){console.log("Do not hit me again "+$(this).text());return}if(!isValidForm($("#twilioio_login_form"))){return}if($("#twilio_from_numbers option:selected").val()==""&&$("#twilio_numbers option:selected").val()==""){$("#error-number-not-selected").show();return}saveTwilioIOWidgetPrefs()})}function saveTwilioIOWidgetPrefs(){$("#save_prefs").text("Saving...");$("#save_prefs").attr("disabled",true);var b={};b.twilio_acc_sid=$("#twilio_acc_sid").val();b.twilio_auth_token=$("#twilio_auth_token").val();b.twilio_from_number=$("#twilio_from_numbers option:selected").val();b.twilio_number=$("#twilio_numbers option:selected").val();b.twilio_number_sid=$("#twilio_number_sid").val();b.twilio_twimlet_url=$("#twilio_twimlet_url").val();if($("#twilio_record").is(":checked")){b.twilio_record="true"}else{b.twilio_record="false"}console.log(b);createAppSid(b,function(c){b.twilio_app_sid=c;console.log(b);save_widget_prefs("TwilioIO",JSON.stringify(b),function(d){console.log("In TwilioIO save success");console.log(d)})})}function callscript_save_widget_prefs(){$("#save_prefs").unbind("click");$("#save_prefs").die().live("click",function(b){b.preventDefault();if($(this).text()=="Saving..."||$(this).text()=="Loading..."){console.log("Do not hit me again "+$(this).text());return}if(!isValidForm($("#callscriptruleForm"))){return}saveCallScriptWidgetPrefs()})}function saveCallScriptWidgetPrefs(){$("#save_prefs").text("Saving...");$("#save_prefs").attr("disabled",true);var b=makeRule();console.log(b);save_widget_prefs("CallScript",JSON.stringify(b),function(c){console.log("In call script save success");console.log(c);window.location.href="#callscript/rules"})}function save_widget_prefs(d,b,f){console.log("In save_widget_prefs.");var e=App_Widgets.Catalog_Widgets_View.collection.where({name:d});var c=new Backbone.Model();console.log(c);c.url="/core/api/widgets";e[0].set("prefs",b);c.save(e[0].toJSON(),{success:function(g){if(Widgets_View&&Widgets_View.collection){Widgets_View.collection.add(new BaseModel(g.toJSON()))}g.set("is_added",true);e[0].set(g);if(d!="CallScript"){window.location.href="#add-widget"}console.log("data******");console.log(g);update_collection_with_prefs(g);if(d=="Sip"){if(Sip_Start==true){Sip_Updated=true;sipUnRegister()}sipStart()}if(d=="TwilioIO"){Twilio_Setup_Called=false;globalTwilioIOSetup()}if(f&&typeof(f)==="function"){f(g)}}})}function show_set_up_widget(f,b,d,c){$("#content").html(getTemplate("settings"),{});var e;var g;$("#prefs-tabs-content").html(getRandomLoadingImg());if(c){console.log(c);e=$(getTemplate("widget-settings",c))}else{if(!App_Widgets.Catalog_Widgets_View||App_Widgets.Catalog_Widgets_View.collection.length==0){App_Widgets.Catalog_Widgets_View=new Base_Collection_View({url:"/core/api/widgets/default"});App_Widgets.Catalog_Widgets_View.collection.fetch({success:function(){$.getJSON("core/api/widgets/"+f,function(h){show_set_up_widget(f,b,d,h)})}});return}g=App_Widgets.Catalog_Widgets_View.collection.where({name:f});e=$(getTemplate("widget-settings",g[0].toJSON()))}console.log(e);if(f=="Zendesk"){zendesk_save_widget_prefs()}else{if(f=="ClickDesk"){clickdesk_save_widget_prefs()}else{if(f=="HelpScout"){helpscout_save_widget_prefs()}else{if(f=="FreshBooks"){freshbook_save_widget_prefs()}else{if(f=="Rapleaf"){rapleaf_save_widget_prefs()}else{if(f=="Sip"){sip_save_widget_prefs()}else{if(f=="TwilioIO"){twilioio_save_widget_prefs()}else{if(f=="QuickBooks"){quickBooks_save_widget_prefs()}else{if(f=="Chargify"){chargify_save_widget_prefs()}else{if(f=="CallScript"){callscript_save_widget_prefs()}}}}}}}}}}if(d){$("#widget-settings",e).html(getTemplate(b,{url:d}));console.log(e)}else{if(f=="Shopify"&&(c||g[0].attributes.id)){if(c){$("#widget-settings",e).html(getTemplate(b,{data:jQuery.parseJSON(c.prefs)}))}else{if(g[0].attributes.id){$("#widget-settings",e).html(getTemplate(b,{data:jQuery.parseJSON(g[0].attributes.prefs)}))}}}else{$("#widget-settings",e).html(getTemplate(b,{}));console.log(e)}}$("#prefs-tabs-content").html(e);$("#PrefsTab .active").removeClass("active");$(".add-widget-prefs-tab").addClass("active")}function set_up_access(h,b,g,d,c){$("#content").html(getTemplate("settings"),{});var f;var e;var j;$("#prefs-tabs-content").html(getRandomLoadingImg());$("#PrefsTab .active").removeClass("active");$(".add-widget-prefs-tab").addClass("active");if(c){f=$(getTemplate("widget-settings",c));e=c}else{if(!App_Widgets.Catalog_Widgets_View||App_Widgets.Catalog_Widgets_View.collection.length==0){App_Widgets.Catalog_Widgets_View=new Base_Collection_View({url:"/core/api/widgets/default"});App_Widgets.Catalog_Widgets_View.collection.fetch({success:function(){$.getJSON("core/api/widgets/"+h,function(k){set_up_access(h,b,g,d,k)})}});return}j=App_Widgets.Catalog_Widgets_View.collection.where({name:h});e=j[0].toJSON();f=$(getTemplate("widget-settings",e))}if(e.name=="Twilio"){e.outgoing_numbers=g}else{if(e.name=="Linkedin"||e.name=="Twitter"){e.profile=g}else{e.custom_data=g}}console.log(e);$("#widget-settings",f).html(getTemplate(h.toLowerCase()+"-revoke-access",e));$("#prefs-tabs-content").html(f);$("#prefs-tabs-content").find("form").data("widget",e);console.log(e);console.log($("#prefs-tabs-content").find("form").data("widget"));$("#PrefsTab .active").removeClass("active");$(".add-widget-prefs-tab").addClass("active");$(".revoke-widget").die().live("click",function(k){console.log($(this).attr("widget-name"));delete_widget(h);show_set_up_widget(h,b,d,c)})}function fill_form(f,e,b){console.log("In fill_form");console.log(f+" "+e+" "+b);var c=App_Widgets.Catalog_Widgets_View.collection.get(f);console.log(c.get("prefs"));console.log(c.length);show_set_up_widget(e,b);if(c&&c.get("prefs")){var d=JSON.parse(c.get("prefs"));console.log("prefsJSON:");console.log(d);fill_fields(d)}}function show_shopify_prefs(d,c,b){console.log("In show pref  setting ");$("#prefs-tabs-content").html(getTemplate(b))}function fill_fields(b){for(i in b){if(i=="sip_wsenable"||i=="twilio_record"){if(b[i]=="true"){$("#"+i).attr("checked","checked")}}else{$("#"+i).val(b[i])}}}function widgetError(f,c,e,d){var b={};b.message=e;b.disable_check=d;$("#"+f).html(getTemplate(c,b))}function setUpError(g,b,d,h,c){$("#content").html(getTemplate("settings"),{});var f;var j;var e;$("#prefs-tabs-content").html(getRandomLoadingImg());$("#PrefsTab .active").removeClass("active");$(".add-widget-prefs-tab").addClass("active");if(c){f=$(getTemplate("widget-settings",c));e=c}else{if(!App_Widgets.Catalog_Widgets_View||App_Widgets.Catalog_Widgets_View.collection.length==0){App_Widgets.Catalog_Widgets_View=new Base_Collection_View({url:"/core/api/widgets/default"});App_Widgets.Catalog_Widgets_View.collection.fetch({success:function(){$.getJSON("core/api/widgets/"+g,function(k){setUpError(g,b,d,h,k)})}});return}j=App_Widgets.Catalog_Widgets_View.collection.where({name:g});e=j[0].toJSON();f=$(getTemplate("widget-settings",e))}e.error_message=d;e.error_url=h;$("#widget-settings",f).html(getTemplate(b,e));$("#prefs-tabs-content").html(f);$("#prefs-tabs-content").find("form").data("widget",e);$("#PrefsTab .active").removeClass("active");$(".add-widget-prefs-tab").addClass("active")}function xero_save_widget_prefs(){$("#xero_save_token").unbind("click");
alert("hello in xero save");$("#xero_save_token").die().live("click",function(c){c.preventDefault();var b={};save_widget_prefs("Xero",JSON.stringify(b),function(d){console.log("In xero save success");console.log(d)})})}function quickBooks_save_widget_prefs(b,c){head.js("https://appcenter.intuit.com/Content/IA/intuit.ipp.anywhere.js",function(){$("#widget-settings",el).html(getTemplate(b,{url:c}));console.log(el);intuit.ipp.anywhere.setup({menuProxy:"http://example.com/myapp/BlueDotMenu",grantUrl:c})})}function chargify_save_widget_prefs(){$("#chargify_save_api_key").unbind("click");$("#chargify_save_api_key").die().live("click",function(b){b.preventDefault();if(!isValidForm($("#chargify_login_form"))){return}saveChargifyWidgetPrefs()})}function saveChargifyWidgetPrefs(){var b={};b.chargify_api_key=$("#chargify_api_key").val();b.chargify_subdomain=$("#chargify_subdomain").val();save_widget_prefs("Chargify",JSON.stringify(b),function(c){console.log("In chargify save success");console.log(c)})}$("#revoke-shopify").die().live("click",function(b){if(confirm("Are you sure to delete Shopify?")){delete_widget("Shopify");window.location.href=window.location.origin+"/#Shopify"}return false});$("#widget_shopify").die().live("click",function(c){var d=$("#shop").val();if(d==""){alert("Enter Shop name");$("#shop").focus();return false}var b=window.location.origin;c.preventDefault();window.location="/scribe?service_type=shopify&url=shopify&shop="+d+"&domain="+b+""});function agile_crm_get_contact_property(d){var c=App_Contacts.contactDetailView.model;var e=c.get("properties");var b;$.each(e,function(f,g){if(g.name==d){b=g.value;return false}});if(b){return b}}function agile_crm_get_contact_properties_list(c){var b=App_Contacts.contactDetailView.model;var e=b.get("properties");var d=[];$.each(e,function(f,g){if(g.name==c){d.push(g)}});return d}function agile_crm_update_contact(d,f,g){var c=App_Contacts.contactDetailView.model;var e=c.toJSON()["properties"];var b=false;$.each(e,function(h,j){if(j.name==d){b=true;j.value=f;return false}});if(!b){e.push({name:d,value:f,type:"CUSTOM"})}c.set({properties:e},{silent:true});c.url="core/api/contacts";c.save({success:function(j,h){if(g&&typeof(g)=="function"){g()}}},{silent:true})}function agile_crm_update_contact_properties(f,g){var c=App_Contacts.contactDetailView.model;var e=c.toJSON()["properties"];for(var d in f){var b=false;$.each(e,function(h,j){if(j.name==f[d].name){b=true;if(f[d].subtype){if(f[d].subtype==j.subtype){j.value=f[d].value}else{b=false}}else{j.value=f[d].value}return false}});if(!b){e.push({name:f[d].name,value:f[d].value,subtype:f[d].subtype,type:"CUSTOM"})}}c.set({properties:e},{silent:true});c.url="core/api/contacts";c.save({success:function(j,h){console.log("contact saving ");if(g&&typeof(g)=="function"){g()}}},{silent:true})}function agile_crm_get_contact(){return App_Contacts.contactDetailView.model.toJSON()}function agile_crm_add_note(d,f){var c=App_Contacts.contactDetailView.model;var e=new Backbone.Model();var b=new Backbone.Model();e.url="core/api/notes";e.set("subject",d);e.set("description",f);e.set("contacts",[c.id.toString()]);e.save()}function agile_crm_get_widget(c){c=c.replace(/ +/g,"");console.log("plugin name "+c);console.log($("#"+c));var b=$("#"+c,App_Contacts.contactDetailView.el).data("model");console.log(b);return b.toJSON()}function agile_crm_get_widget_prefs(b){b=b.replace(/ +/g,"");console.log("in get widget prefs "+b);return $("#"+b,App_Contacts.contactDetailView.el).data("model").toJSON().prefs}function agile_crm_save_widget_prefs(e,c,f){console.log(e);e=e.replace(/ +/g,"");console.log(App_Contacts.contactDetailView.el);console.log($("#"+e,App_Contacts.contactDetailView.el));var d=$("#"+e,App_Contacts.contactDetailView.el).data("model");console.log(d);d.set({prefs:c},{silent:true});d.url="core/api/widgets";console.log(d);var b=new BaseModel();b.url="core/api/widgets";b.save(d.toJSON(),{success:function(g){console.log(g);console.log("Saved widget: "+g.toJSON());$("#"+e,App_Contacts.contactDetailView.el).data("model",d);if(f&&typeof(f)==="function"){console.log("in save callback");console.log(g.toJSON());f(g.toJSON())}}},{silent:true})}function agile_crm_delete_widget_prefs(b,c){agile_crm_save_widget_prefs(b,undefined,c)}function agile_crm_get_widget_property_from_contact(c){var b=App_Contacts.contactDetailView.model;var d=b.get("widget_properties");if(!d){return}d=JSON.parse(d);return d[c]}function agile_crm_delete_widget_property_from_contact(c){var b=App_Contacts.contactDetailView.model;var d=b.get("widget_properties");if(!d){return}d=JSON.parse(d);delete d[c];b.set("widget_properties",JSON.stringify(d));b.url="core/api/contacts";b.save()}function agile_crm_get_contact_property_by_subtype(d,b){var c=App_Contacts.contactDetailView.model;var e=c.get("properties");var f;$.each(e,function(g,h){if(h.name==d&&h.subtype==b){f=h}});if(f){return f.value}}function agile_crm_delete_contact_property_by_subtype(d,b,f,g){var c=App_Contacts.contactDetailView.model;var e=c.get("properties");$.each(e,function(h,j){if(j.name==d&&j.subtype==b&&j.value==f){e.splice(h,1);c.set({properties:e},{silent:true});c.url="core/api/contacts";c.save([],{silent:true,success:function(k){console.log("in success");if(g&&typeof g==="function"){g(k)}}});return false}})}function agile_crm_save_contact_property(d,b,h,f){var c=App_Contacts.contactDetailView.model;var e=c.get("properties");var g={};g.name=d;g.value=h;g.subtype=b;g.type=f;e.push(g);c.set("properties",e);console.log(e);c.url="core/api/contacts";c.save()}function agile_crm_save_widget_property_to_contact(c,e,f){var b=App_Contacts.contactDetailView.model;var d=b.get("widget_properties");if(!d){d={}}else{d=JSON.parse(d)}d[c]=e;b.set({widget_properties:JSON.stringify(d)},{silent:true});b.url="core/api/contacts";b.save(b.toJSON,{silent:true,success:function(g){console.log("in success");if(f&&typeof f==="function"){f(g)}}})}function agile_crm_add_event_to_timeline(d,f,b,e){var c={};c.id=d;c.body=b;c.title=f;if(e&&(e/100000000000)>1){c.created_time=e}else{c.created_time=e}c.entity_type="custom";add_entity_to_timeline(new BaseModel(c))}function agile_crm_get_current_view(){if(App_Contacts.contactDetailView){return App_Contacts.contactDetailView.el}return undefined}var CSRCOLLECTION;$(function(){$("#callscriptruleForm").live("click",function(b){makeWidgetTabActive()});$(".callscript-multiple-add").die().live("click",function(b){b.preventDefault();var c=$(getTemplate("callscript-rule",{})).find("tr").clone();scramble_input_names($(c));chainFilters(c,function(){},false);$(c).find("i.callscript-multiple-remove").css("display","inline-block");$(this).siblings("table").find("tbody").append(c)});$("i.callscript-multiple-remove").die().live("click",function(b){$(this).closest("tr").remove()});$(".edit-callscriptrule").die().live("click",function(c){c.preventDefault();$("#prefs-tabs-content").html(LOADING_HTML);var b=$(this).attr("data");window.location.href="#callscript/editrules/"+b;$("#prefs-tabs-content").html(LOADING_HTML)});$(".delete-callscriptrule").die().live("click",function(b){b.preventDefault();if(!confirm("Are you sure to delete a rule")){return}$(this).closest("tr").remove();deleteCallScriptRule($(this).attr("data"))});$(".row-callscriptrule").live("mouseenter",function(){$(this).find(".callscriptrule-actions").css("visibility","visible")});$(".row-callscriptrule").live("mouseleave",function(){$(this).find(".callscriptrule-actions").css("visibility","hidden")})});function adjust_form(){$("#add_csrule").text("Loading...");$("#add_csrule").attr("disabled",true);if(isCallScriptAdded()){var b=getCallScriptRuleCount();if(b>0){$(".rule-count").html(b);$("#add_csrule").hide();$(".rule-added").show();$("#show_csrules").show()}else{$(".no-rule-added").show()}}else{$(".no-rule-added").show()}$("#add_csrule").text("Add Rule");$("#add_csrule").attr("disabled",false)}function isCallScriptAdded(){var b=App_Widgets.Catalog_Widgets_View.collection.where({name:"CallScript"});console.log(b);if(b[0].get("is_added")==false){return false}return true}function getCallScriptJSON(){if(!App_Widgets||!App_Widgets.Catalog_Widgets_View||!App_Widgets.Catalog_Widgets_View.collection){window.location.href="#add-widget";return}var c=App_Widgets.Catalog_Widgets_View.collection.where({name:"CallScript"});if(c[0].get("is_added")==false){return null}var b=JSON.parse(c[0].get("prefs"));return b}function getCallScriptRuleCount(){var b=getCallScriptJSON();return b.csrules.length}function createCSRCollection(){var b=getCallScriptJSON();CSRCOLLECTION=new Base_Collection_View({data:b.csrules})}function makeRule(){var d=serializeForm("callscriptruleForm");var c=d.rulecount;var b=getCallScriptJSON();if(b!=null){if(c!=""){b.csrules[getRuleIndex(b,c)]=d}else{d.position=b.csrules.length;b.csrcount=b.csrcount+1;d.rulecount=b.csrcount;b.csrules.push(d)}return b}d.position=0;d.rulecount=1;b={};b.csrules=[d];b.csrcount=1;return b}function deleteCallScriptRule(b){var c=getCallScriptJSON();if(c!=null){console.log(c.csrules[b]);c.csrules.splice(b,1);save_widget_prefs("CallScript",JSON.stringify(c),function(d){console.log("In call script save success after delete");console.log(d)})}makeWidgetTabActive()}function showCallScriptRule(){makeWidgetTabActive();$("#prefs-tabs-content").html(LOADING_HTML);var b=getCallScriptJSON();if(b!=null){$("#prefs-tabs-content").html(getTemplate("callscript-table",b.csrules));setup_sortable_callscriptrules()}}function addCallScriptRule(){if(!App_Widgets||!App_Widgets.Catalog_Widgets_View||!App_Widgets.Catalog_Widgets_View.collection){window.location.href="#add-widget";return}makeWidgetTabActive();var b=new Base_Model_View({template:"callscript-rule",isNew:"true",postRenderCallback:function(c){head.js(LIB_PATH+"lib/agile.jquery.chained.min.js",function(){chainFilters(c,undefined,function(){$("#prefs-tabs-content").html(c);if(!isCallScriptAdded()){$(".redirect-to-addwidget").show();$(".redirect-to-showrules").hide()}})})}});$("#prefs-tabs-content").html(LOADING_HTML);
b.render()}function editCallScriptRule(d){makeWidgetTabActive();$("#prefs-tabs-content").html(LOADING_HTML);var b=getCallScriptJSON();if(b!=null){var c=getRule(b,d);$("#prefs-tabs-content").html(LOADING_HTML);head.js(LIB_PATH+"lib/agile.jquery.chained.min.js",function(){$("#prefs-tabs-content").html(getTemplate("callscript-rule"));$("#prefs-tabs-content").find("#filter-settings").find("#loading-img-for-table").html(LOADING_HTML).show();$("#prefs-tabs-content").find("#filter-settings").find(".chained-table").hide();chainFilters($("#prefs-tabs-content"),c,function(){$("#prefs-tabs-content").find("#filter-settings").find("#loading-img-for-table").hide();$("#prefs-tabs-content").find("#filter-settings").find(".chained-table").show();$(".callscript-multiple-remove").show();$(".callscript-multiple-remove")[0].style.display="none"});scramble_input_names($("#prefs-tabs-content").find("#filter-settings"));$(".addLable").html(" Edit Call Script Rule");$("#name").val(c.name);$("#displaytext").val(c.displaytext);$("#position").val(c.position);$("#rulecount").val(c.rulecount)})}}function getRule(b,e){var d=b.csrules;for(var c=0;c<d.length;c++){if(d[c].rulecount==e){return d[c]}}}function getRuleIndex(b,e){var d=b.csrules;for(var c=0;c<d.length;c++){if(d[c].rulecount==e){return c}}}function setup_sortable_callscriptrules(){$(".csr-sortable").append("<tr class='pseduo-row' style='border:none!important;'><td></td><td></td><td></td></tr>");head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".csr-sortable").sortable({axis:"y",forcePlaceholderSize:true,placeholder:"<tr><td></td></tr>",handle:".icon-move",containment:".csr-sortable",cursor:"move",forceHelperSize:true,scroll:false,items:"> tr",helper:function(d,b){var c=b.children();var f=b.clone();f.children().each(function(e){$(this).width(c.eq(e).width())});return f}}).disableSelection();$(".csr-sortable").on("sortstop",function(b,c){getRulesNewPosition(function(d){saveCSRAfterDrop(d)})})})}function getRulesNewPosition(d){var c=[];var b=getCallScriptJSON();$(".csr-sortable > tr").each(function(e,f){if(!$(f).hasClass("pseduo-row")){var h=$(f).attr("data");var g=b.csrules[h];if(h!=e){g.position=e;$(f).attr("data",e)}c.push(g)}});if(d&&typeof(d)==="function"){d(c)}}function saveCSRAfterDrop(c){var b=getCallScriptJSON();b.csrules=c;save_widget_prefs("CallScript",JSON.stringify(b),function(d){console.log("In call script save success after drag-drop");console.log(d)})}function makeWidgetTabActive(){$("#PrefsTab .active").removeClass("active");$(".add-widget-prefs-tab").addClass("active")}function includeTimeAgo(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time",b).timeago()})}function initOwnerslist(){$("ul#owner-tasks li a, ul#type-tasks li a").die().live("click",function(d){d.preventDefault();var c=$(this).html(),f=$(this).attr("href");$(this).closest("ul").data("selected_item",f);$(this).closest(".btn-group").find(".selected_name").text(c);var b=getParams();updateData(b)});$("ul#owner-tasks li a").die().live("click",function(){$(".task-heading").html($(this).html()+'&nbsp<small class="tasks-count"></small> <span style="font-size: small;color: #525252;  background-color: rgb(255,255,204);  border: 1px solid rgb(211,211,211);border-radius: 3px;padding: 3px 5px 3px 5px;">Try our <a href="#tasks-new">new look</a></span>');pieTasks(getParams())});updateData(getParams()+"&owner="+CURRENT_DOMAIN_USER.id+"&pending="+true);pieTasks(getParams()+"&owner="+CURRENT_DOMAIN_USER.id+"&pending="+true)}var allTasksListView;function updateData(b){$("#task-list-based-condition").html(LOADING_HTML);this.App_Calendar.allTasksListView=new Base_Collection_View({url:"/core/api/tasks/based"+b,restKey:"task",sort_collection:false,templateKey:"tasks-list",cursor:true,page_size:25,individual_tag_name:"tr",postRenderCallback:function(c){$(".tasks-count").html(getCount(this.App_Calendar.allTasksListView.collection.toJSON()));includeTimeAgo(c)},appendItemCallback:function(c){includeTimeAgo(c)}});this.App_Calendar.allTasksListView.collection.fetch();$("#task-list-based-condition").html(this.App_Calendar.allTasksListView.render().el)}function getParams(){var d="?";var c=$("#type-tasks").data("selected_item");if(c){d+=("&type="+c)}var b=$("#owner-tasks").data("selected_item");if(b=="my-pending-tasks"){d+=("&pending="+true);d+=("&owner="+CURRENT_DOMAIN_USER.id);return d}if(b){d+=("&owner="+b)}else{if(b==undefined){d+=("&owner="+CURRENT_DOMAIN_USER.id)}}return d}$(function(){$("#bulk-complete").live("click",function(f){f.preventDefault();var c=[];var g=[];var e=false;var d=$("body").find(".showCheckboxes");$(d).find("tr .tbody_check").each(function(h,j){if($(j).is(":checked")){$(j).closest("tr").on("mouseenter",false);c.push(h);g.push($(j).closest("tr").data().toJSON());e=true}});if(e){$(this).after('<img class="bulk-complete-loading" style="padding-right:5px;margin-bottom:15px" src= "img/21-0.gif"></img>');bulk_complete_operation("/core/api/tasks/bulk/complete",c,d,g)}else{$("body").find(".select-none").html('<div class="alert alert-error"><a class="close" data-dismiss="alert" href="#">&times;</a>You have not selected any records to complete. Please select at least one record to continue.</div>').show().delay(3000).hide(1)}var b=getDueTasksCount();$("#due_tasks_count").html(b)})});function bulk_complete_operation(b,c,d,e){var f=[];$.each(e,function(h,g){var j=g.contacts;g.contacts=[];$.each(j,function(l,k){g.contacts.push(k.id);f.push(g)});g.is_complete=true;g.owner_id=g.taskOwner.id});$.ajax({url:b,type:"POST",data:JSON.stringify(f),contentType:"application/json",success:function(){$(".bulk-complete-loading").remove();var g=$(d).find("tbody");for(var h=0;h<c.length;h++){$(g).find("tr:eq("+c[h]+")").find("div:lt(3)").css("text-decoration","line-through")}}})}$(".activity-deal-edit").live("click",function(d){d.preventDefault();var c=$(this).closest("a").attr("data");var b=getDealObject(c);updatedeals(b)});$(".activity-event-edit").live("click",function(c){c.preventDefault();var b=$(this).closest("a").attr("data");var d=getEventObject(b);update_event_activity(d)});$(".activity-edit-note").die().live("click",function(f){f.preventDefault();console.log($(this).attr("data"));var d=$(this).attr("data");var c=getNoteObject(d);console.log(c);$("#noteUpdateModal").remove();var b=$("#noteModal").clone();$("#noteForm > fieldset",b).prepend('<input name="id" type="hidden"/>');$("#noteForm",b).parent().parent().find(".modal-header > h3").html('<i class="icon-edit"></i>&nbsp;Edit Note');$("#noteForm",b).attr("id","noteUpdateForm");b.attr("id","noteUpdateModal");$("#note_validate",b).attr("id","note_update");deserializeForm(JSON.parse(c),$("#noteUpdateForm",b));b.modal("show")});$(".activity-task-edit").live("click",function(d){d.preventDefault();var c=$(this).closest("a").attr("data");var b=getTaskObject(c);updateactivity__task(b)});$(".email-details").live("click",function(f){f.preventDefault();var c=$(this).closest("a").attr("data");var d=getActivityObject(c);console.log(d);var b=$(getTemplate("infoModal",JSON.parse(d)));b.modal("show")});function getDealObject(b){return $.ajax({type:"GET",url:"core/api/opportunity/"+b,async:false}).responseText}function getEventObject(b){return $.ajax({type:"GET",url:"core/api/events/getEventObject/"+b,async:false}).responseText}function getTaskObject(b){return $.ajax({type:"GET",url:"core/api/tasks/getTaskObject/"+b,async:false}).responseText}function getNoteObject(b){return $.ajax({type:"GET",url:"core/api/notes/"+b,async:false}).responseText}function getActivityObject(b){return $.ajax({type:"GET",url:"core/api/activitylog/"+b,async:false}).responseText}function update_event_activity(c){var b=JSON.parse(c);deserializeForm(b,$("#updateActivityForm"));$("#updateActivityModal").modal("show");$(".update-start-timepicker").val(fillTimePicker(b.start));$(".update-end-timepicker").val(fillTimePicker(b.end));populateUsersInUpdateActivityModal(b)}function getModal(){var b=App_Activity_log.activitiesview.collection.models[this];alert(b);console.log(b)}function updateactivity__task(c){var b=JSON.parse(c);deserializeForm(b,$("#updateTaskForm"));$("#updateTaskModal").modal("show");populateUsers("owners-list",$("#updateTaskForm"),b,"taskOwner",function(d){$("#updateTaskForm").find("#owners-list").html(d);if(b.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+b.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()});showNoteOnForm("updateTaskForm",b.notes)}function updatedeals(d){var c=JSON.parse(d);console.log(c);add_recent_view(new BaseModel(c));var b=$("#opportunityUpdateForm");$("#opportunityUpdateForm")[0].reset();deserializeForm(c,$("#opportunityUpdateForm"));$("#opportunityUpdateModal").modal("show");agile_type_ahead("relates_to",b,contacts_typeahead);populateUsers("owners-list",b,c,"owner",function(e){b.find("#owners-list").html(e);if(c.owner){$("#owners-list",b).find("option[value="+c.owner.id+"]").attr("selected","selected");$("#owners-list",$("#opportunityUpdateForm")).closest("div").find(".loading-img").hide()}});populateTracks(b,undefined,c,function(e){populateMilestones(b,undefined,c.pipeline_id,c,function(f){b.find("#milestone").html(f);if(c.milestone){$("#milestone",b).find('option[value="'+c.milestone+'"]').attr("selected","selected")}$("#milestone",b).closest("div").find(".loading-img").hide()})});showNoteOnForm("opportunityUpdateForm",c.notes);add_custom_fields_to_form(c,function(f){var e=show_custom_fields_helper(f.custom_fields,[]);$("#custom-field-deals",b).html(fill_custom_fields_values_generic($(e),c.custom_data))},"DEAL")}function get_activity_created_time(c){var b=new Date();b.setHours(0,0,0,0);b=b.getTime()/1000;return Math.floor((c-b)/(24*3600))}function append_activity_log(b){var c=new Base_List_View({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"li"});var e=get_activity_created_time(b.get("time"));if(e==0){$("#earllier").show();$("#next-week-heading").addClass("ref-head");
var d=$("#today-heading",this.el);$("#today-activity",this.el).append(c.render().el);$("#today-activity",this.el).parent("table").css("display","block");$("#today-activity",this.el).show();$("#today-heading",this.el).show()}if(e==-1){$("#earllier").show();$("#next-week-heading").addClass("ref-head");var d=$("#tomorrow-heading",this.el);$("#tomorrow-activity",this.el).append(c.render().el);$("#tomorrow-activity",this.el).parent("table").css("display","block");$("#tomorrow-activity",this.el).show();$("#tomorrow-heading",this.el).show()}if(e<-1){var d=$("#next-week-heading",this.el);$("#next-week-activity",this.el).append(c.render().el);$("#next-week-activity",this.el).parent("table").css("display","block");$("#next-week-activity",this.el).show();$("#next-week-heading",this.el).show()}}$(function(){$("#show-activity").live("click",function(c){c.preventDefault();highlight_event();$("#activityModal").modal("show")});$(".add-event").live("click",function(c){c.preventDefault();$("#activityModal").modal("show");highlight_event();return});$("#update_event_validate").die().live("click",function(d){d.preventDefault();var c=$("#updateActivityModal").find("input[type='hidden']").val();save_event("updateActivityForm","updateActivityModal",true,this,function(f){console.log(f);var e=eventCollectionView.collection.get(c);e.set(f.toJSON(),{merge:true});eventCollectionView.render(true)})});$("#event_delete").die().live("click",function(g){g.preventDefault();if($(this).attr("disabled")=="disabled"){return}if(!confirm("Are you sure you want to delete?")){return}var f=$("#updateActivityForm input[name=id]").val();var c=$(this);disable_save_button(c);$.ajax({url:"core/api/events/"+f,type:"DELETE",success:function(){if(App_Portlets.currentPosition&&App_Portlets.todayEventsCollection&&App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)]&&(Current_Route==undefined||Current_Route=="dashboard")){App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.remove(App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.get(f));App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].render(true)}enable_save_button(c);$("#updateActivityModal").modal("hide");var e=$("#updateActivityModal").find("input[type='hidden']").val();$("#calendar_event").fullCalendar("removeEvents",e)}});if(readCookie("agile_calendar_view")){var d=eventCollectionView.collection.get(f);d.set(d,{remove:true});document.location.reload()}});var b=$("#event-date-1").datepicker({format:"mm/dd/yyyy"}).on("changeDate",function(c){var d=new Date($("#event-date-2").val());if(c.date.valueOf()>d.valueOf()){$("#event-date-2").val($("#event-date-1").val())}});$("#event-date-2").datepicker({format:"mm/dd/yyyy"});$("#update-event-date-1").datepicker({format:"mm/dd/yyyy"}).on("changeDate",function(c){var d=new Date($("#update-event-date-2").val());if(c.date.valueOf()>d.valueOf()){$("#update-event-date-2").val($("#update-event-date-1").val())}});$("#update-event-date-2").datepicker({format:"mm/dd/yyyy"});$(".start-timepicker").timepicker({defaultTime:"current",showMeridian:false,template:"modal"}).on("hide.timepicker",function(d){if($("#activityModal #allDay").is(":checked")){$("#event-time-1").closest(".control-group").hide();$("#event-date-2").closest(".row").hide()}var c=changeEndTime($(".start-timepicker").val().split(":"),$(".end-timepicker").val().split(":"));$(".end-timepicker").val(c);d.stopImmediatePropagation();return false});$(".end-timepicker").timepicker({defaultTime:get_hh_mm(true),showMeridian:false,template:"modal"});$(".update-start-timepicker").timepicker({defaultTime:"current",showMeridian:false,template:"modal"}).on("hide.timepicker",function(d){var c=changeEndTime($(".update-start-timepicker").val().split(":"),$(".update-end-timepicker").val().split(":"));$(".update-end-timepicker").val(c)});$(".update-end-timepicker").timepicker({defaultTime:get_hh_mm(true),showMeridian:false,template:"modal"});$("#activityModal, #activityTaskModal").on("shown",function(){var c=$("#activityForm");agile_type_ahead("event_related_to",c,contacts_typeahead);if($(".start-timepicker").val()==""){$(".start-timepicker").val(get_hh_mm())}if($(".end-timepicker").val()==""){$(".end-timepicker").val(get_hh_mm(true))}if($(".new-task-timepicker").val()==""){$(".new-task-timepicker").val("12:00")}$("input.date").datepicker("update")});$("#updateActivityModal").on("show",function(){var c=$("#updateActivityForm");agile_type_ahead("event_related_to",c,contacts_typeahead);if($("#updateActivityModal #allDay").is(":checked")){$("#update-event-time-1").closest(".control-group").hide();$("#update-event-date-2").closest(".row").hide()}$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error");$("input.date").datepicker("update")});$("#activityModal, #activityTaskModal").on("show",function(d){$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error");var c=$("#event-owners-list",$("#activityForm")).val();if(c==null){populateUsers("event-owners-list",$("#activityForm"),undefined,undefined,function(e){$("#activityForm").find("#event-owners-list").html(e);$("#event-owners-list",$("#activityForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#event-owners-list",$("#activityForm")).closest("div").find(".loading-img").hide()})}});$("#updateActivityModal").on("hidden",function(){if($(this).hasClass("in")){return}$("#updateActivityForm").find("li").remove();$("#update-event-time-1").closest(".control-group").show();$("#update-event-date-2").closest(".row").show()});$("#activityModal").on("hidden",function(){if($(this).hasClass("in")){return}remove_validation_errors("activityModal");$("#activityForm").find("li").remove();$("#event-time-1").closest(".control-group").show();$("#event-date-2").closest(".row").show()});$("#event").live("click",function(c){c.preventDefault();highlight_event()})});function highlight_event(){$("#hiddentask").val("event");$("#event").css({color:"black"});$("#task").css({color:"red"});$("#relatedTask").css("display","none");$("#relatedEvent").css("display","block");if($("#taskForm").find("#task_related_to").closest(".controls").find("ul").children()){$("#activityForm").find("#event_related_to").closest(".controls").find("ul").html($("#taskForm").find("#task_related_to").closest(".controls").find("ul").children())}$("input.date").val(new Date().format("mm/dd/yyyy"))}function is_valid_range(b,f,e,c,d){if(f-b>=86400000){return true}else{if(b>f){$("#"+d).find(".invalid-range").html('<div class="alert alert-error"><a class="close" data-dismiss="alert" href="#">&times</a>Start date should not be greater than end date. Please change.</div>');return false}else{if(e[0]>c[0]){$("#"+d).find(".invalid-range").html('<div class="alert alert-error"><a class="close" data-dismiss="alert" href="#">&times</a>Start time should not be greater than end time. Please change.</div>');return false}else{if(e[0]==c[0]&&e[1]>=c[1]){$("#"+d).find(".invalid-range").html('<div class="alert alert-error"><a class="close" data-dismiss="alert" href="#">&times</a>Start time should not be greater or equal to end time. Please change.</div>');return false}else{return true}}}}}function save_event(f,c,k,d,g){if($(d).attr("disabled")){return}disable_save_button($(d));if(!isValidForm("#"+f)){enable_save_button($(d));return false}var j=serializeForm(f);if(j.allDay){j.end=j.start;j.start_time="00:00";j.end_time="23:45"}if(!is_valid_range(j.start*1000,j.end*1000,(j.start_time).split(":"),(j.end_time).split(":"),c)){enable_save_button($(d));return}var b=(j.start_time).split(":");j.start=new Date(j.start*1000).setHours(b[0],b[1])/1000;var e=(j.end_time).split(":");j.end=new Date(j.end*1000).setHours(e[0],e[1])/1000;$("#"+c).modal("hide");$("#"+f).each(function(){this.reset()});delete j.start_time;delete j.end_time;var h=new Backbone.Model();h.url="core/api/events";h.save(j,{success:function(m){enable_save_button($(d));$("#"+f).each(function(){this.reset()});$("#"+c).modal("hide");var l=m.toJSON();if(Current_Route=="calendar"&&!readCookie("agile_calendar_view")){if(k){$("#calendar_event").fullCalendar("removeEvents",j.id)}$("#calendar_event").fullCalendar("renderEvent",m.toJSON())}else{if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){$.each(l.contacts,function(o,n){if(n.id==App_Contacts.contactDetailView.model.get("id")){if(eventsView&&eventsView.collection){if(eventsView.collection.get(m.id)){eventsView.collection.get(m.id).set(new BaseModel(m))}else{eventsView.collection.add(new BaseModel(m),{sort:false});eventsView.collection.sort()}}return false}})}else{if(App_Portlets.currentPosition&&App_Portlets.todayEventsCollection&&App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)]&&(Current_Route==undefined||Current_Route=="dashboard")){if(k){App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.remove(j)}App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.add(m);App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].render(true)}else{App_Calendar.navigate("calendar",{trigger:true})}}}if(g&&typeof g==="function"){g(m)}}})}function get_hh_mm(d,e){var b=new Date().getHours();var c=new Date().getMinutes();if(c%15!=0){c=c-(c%15)}if(d){if(c=="30"){b=b+1;c=0}else{if(c=="45"){b=b+1;c=15}else{c=c+30}}}if(b<10){b="0"+b}if(c<10){c="0"+c}return b+":"+c}function fillTimePicker(d){if(d){var b=new Date(d*1000).getHours();var c=new Date(d*1000).getMinutes();if(b<10){b="0"+b}if(c<10){c="0"+c}return b+":"+c}}function populateUsersInUpdateActivityModal(b){populateUsers("event-owners-list",$("#updateActivityForm"),b,"eventOwner",function(c){$("#updateActivityForm").find("#event-owners-list").html(c);if(b.owner){$("#event-owners-list",$("#updateActivityForm")).find('option[value="'+b.owner.id+'"]').attr("selected","selected")
}$("#event-owners-list",$("#updateActivityForm")).closest("div").find(".loading-img").hide()})}function changeEndTime(e,c){console.log("In changeEndTime");console.log(e);console.log(c);if(e[0]>c[0]||(e[0]==c[0]&&e[1]>=c[1])){var b=Number(e[0]);var d=Number(e[1]);if(d%15!=0){d=d-(d%15)}if(d=="30"){if(b==23){b=0}else{b=b+1}d=0}else{if(d=="45"){if(b==23){b=0}else{b=b+1}d=15}else{d=d+30}}if(b<10){b="0"+b}if(d<10){d="0"+d}console.log(b+":"+d);return b+":"+d}else{return c[0]+":"+c[1]}}
/*!
 * FullCalendar v1.6.4 Google Calendar Plugin
 * Docs & License: http://arshaw.com/fullcalendar/
 * (c) 2013 Adam Shaw
 */
;function isDefined(b){var c;return typeof b!==c}function _init_gcal_options(){var b=$.fullCalendar;b.sourceFetchers=[];b.sourceFetchers.push(function(d,e,c){if(d.dataType=="agile-gcal"){if(!readCookie("event-filters")||JSON.parse(readCookie("event-filters")).type!="agile"){$.getJSON("/core/api/users/agileusers",function(f){$.each(f,function(h,g){if(CURRENT_DOMAIN_USER.id==g.domain_user_id&&(JSON.parse(readCookie("event-filters")).owner_id==g.id||JSON.parse(readCookie("event-filters")).owner_id.length==0)){load_events_from_google(function(j){if(!j){return}return agile_transform_options(j,e,c)})}})})}}})}function agile_transform_options(c,d,b){if(typeof gapi!="undefined"&&isDefined(gapi)&&isDefined(gapi.client)&&isDefined(gapi.client.calendar)){_fetchGCAndAddEvents(c,d,b);return}head.js("https://apis.google.com/js/client.js","/lib/calendar/gapi-helper.js",function(){setupGC(function(){_fetchGCAndAddEvents(c,d,b)});return})}function setupGC(b){console.log("Set up GC");gapi_helper.configure({scopes:"https://www.googleapis.com/auth/calendar",services:{calendar:"v3"}});gapi_helper.when("calendarLoaded",b)}function _fetchGCAndAddEvents(c,e,b){gapi.auth.setToken({access_token:c.token,state:"https://www.googleapis.com/auth/calendar"});var d=gapi.client.calendar.events.list({calendarId:"primary",timeMin:ts2googleDate(e),timeMax:ts2googleDate(b),maxResults:10000,singleEvents:true});d.execute(function(h){console.log(h);for(var g=0;g<h.items.length;g++){var f=google2fcEvent(h.items[g]);if(f){$("#calendar_event").fullCalendar("renderEvent",f)}}})}function ts2googleDate(b){return $.fullCalendar.formatDate($.fullCalendar.parseDate(b),"u")}function google2fcEvent(b){var d={title:b.summary||"No title",start:b.start.date||b.start.dateTime,end:b.end.date||b.end.dateTime,allDay:b.start.date?true:false,google:b,color:"orange",editable:false};if(d.allDay){var c;if(d.end.length>10){c=$.fullCalendar.parseDate(d.end);d.end=$.fullCalendar.formatDate(c,"yyyy-MM-dd")}else{c=new Date(d.end)}c.setDate(c.getDate()-1);d.end=c.format("yyyy-MM-dd")}return d}var notesView;var contactRelatedView;var taskActivitiesView;var task_details_tab={load_timeline:function(){$("div.tab-content",App_Tasks.taskDetailView.el).find("div.active").removeClass("active");$("#time-line",App_Tasks.taskDetailView.el).addClass("active");if($("#timeline",App_Tasks.taskDetailView.el).hasClass("isotope")){$("#timeline",App_Task.taskDetailView.el).isotope("reLayout",function(){});return}load_timeline_details(App_Tasks.taskDetailView.el,App_Tasks.taskDetailView.model.get("id"))},load_notes:function(){var b=taskDetailView.id;notesView=new Base_Collection_View({url:"/core/api/tasks/"+b+"/notes",restKey:"note",templateKey:"task_notes",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(c){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".note-created-time",c).timeago()})}});notesView.collection.fetch();$("#task_tab_detail").find("#notes").html(notesView.el)},loadTaskRelatedContactsView:function(){var b=taskDetailView.id;contactRelatedView=new Base_Collection_View({url:"/core/api/tasks/"+b+"/contacts",templateKey:"task-related",individual_tag_name:"tr",sortKey:"created_time",descending:true,postRenderCallback:function(c){}});contactRelatedView.collection.fetch();$("#task_tab_detail").find("#contacts").html(contactRelatedView.el)},loadActivitiesView:function(){var c=taskDetailView.toJSON();var b=c.domain;taskActivitiesView=new Base_Collection_View({url:"/core/api/activitylog/getActivityByEntityId?entity_id="+c.id+"",templateKey:"task-related-activity",individual_tag_name:"li",sortKey:"time",descending:true,cursor:true,page_size:25});taskActivitiesView.collection.fetch();$("#task_tab_detail").find("#activity").html(taskActivitiesView.el)}};function includeTimeAgo(b){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time",b).timeago()})}function updateActivty(b){console.log("entered into update activity function  "+new Date().getTime()+"  time with milliseconds "+new Date());this.activitiesview=new Base_Collection_View({url:"/core/api/activitylog/getActivitiesOnSelectedCondition"+b,sortKey:"time",descending:true,templateKey:"activity-list-log",sort_collection:false,cursor:true,scroll_symbol:"scroll",page_size:20,individual_tag_name:"li",postRenderCallback:function(c){includeTimeAgo(c)},appendItemCallback:function(c){includeTimeAgo(c)}});activitiesview.appendItem=append_activity_log;this.activitiesview.collection.fetch();$("#activity-list-based-condition").html(this.activitiesview.render().el);console.log("completed update activity function  "+new Date().getTime()+"  time with milliseconds "+new Date())}function getParameters(){var h="?";var c=$("#activities_date_range #range").html().split("-");var b=$("#user-select").data("selected_item");var g=$("#entity_type").data("selected_item");if(b){h+=("user_id="+b)}if(c&&c!="Filter by date"){var e=Date.parse($.trim(c[0])).valueOf();var f=$.trim(c[1]);if(f){f=f+" 23:59:59"}var d=Date.parse(f).valueOf();h+=("&start_time="+e+"&end_time="+d)}if(g=="TASK"){h+=("&entity_type="+g);return h}else{if(g=="DEAL"){h+=("&entity_type="+g);return h}else{if(g=="EVENT"){h+=("&entity_type="+g);return h}else{if(g=="CONTACT"){h+=("&entity_type="+g);return h}else{if(g=="DOCUMENT"){h+=("&entity_type="+g);return h}else{if(g=="CALL"){h+=("&entity_type="+g);return h}else{h+=("&entity_type=ALL");return h}}}}}}return h}function initActivitiesDateRange(){$("#activities_date_range").daterangepicker({ranges:{Today:["today","today"],Yesterday:["yesterday","yesterday"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 30 Days":[Date.today().add({days:-29}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})]}},function(c,b){if(c&&b){createCookie("selectedStartTime",c.toString("MMMM d, yyyy"),90);createCookie("selectedEndTime",b.toString("MMMM d, yyyy"),90);$("#activities_date_range #range").html(c.toString("MMMM d, yyyy")+" - "+b.toString("MMMM d, yyyy"));updateActivty(getParameters())}else{eraseCookie("selectedStartTime");eraseCookie("selectedEndTime");$("#activities_date_range #range").html("Filter by date");updateActivty(getParameters())}})}$(function(){$("#task_event_validate").die().live("click",function(b){b.preventDefault();console.log(this);if($("#hiddentask").val()=="task"){save_task("taskForm","activityTaskModal",false,this)}else{save_event("activityForm","activityModal",false,this,function(c){eventCollectionView.collection.add(c.toJSON());eventCollectionView.collection.sort()})}});$("#activityTaskModal").on("hidden",function(b){if($(this).hasClass("in")){return}$("#taskForm").find("li").remove();remove_validation_errors("activityTaskModal");resetForm($("#taskForm"));$("#taskForm #forNoteForm").html("");$(".task-add-note",$("#taskForm")).show()});$("#activityForm #allDay").live("click",function(b){if($(this).is(":checked")){$("#activityForm #event-time-1").closest(".control-group").hide();$("#activityForm #event-date-2").closest(".row").hide()}else{$("#activityForm #event-time-1").closest(".control-group").show();$("#activityForm #event-date-2").closest(".row").show()}});$("#updateActivityForm #allDay").live("click",function(b){if($(this).is(":checked")){$("#updateActivityForm #update-event-time-1").closest(".control-group").hide();$("#updateActivityForm #update-event-date-2").closest(".row").hide()}else{$("#updateActivityForm #update-event-time-1").closest(".control-group").show();$("#updateActivityForm #update-event-date-2").closest(".row").show()}})});function isArray(b){return Object.prototype.toString.apply(b)==="[object Array]"}function load_events_from_google(e){if(readCookie("event-filters")){if(JSON.parse(readCookie("event-filters")).type=="agile"){return}if(JSON.parse(readCookie("event-filters")).owner_id.length>0&&CURRENT_AGILE_USER.id!=JSON.parse(readCookie("event-filters")).owner_id){return}}var d="_agile_google_calendar_prefs_"+CURRENT_DOMAIN_USER.id;var c=readCookie(d);if(c&&c!="null"){var b=JSON.parse(c);if(b.expires_at-(2*60*1000)>=new Date().getTime()){get_google_calendar_event_source(b,e);return}erase_google_calendar_prefs_cookie()}$.getJSON("/core/api/calendar-prefs/refresh-token",function(f){if(!f){return}createCookie(d,JSON.stringify(f));get_google_calendar_event_source(f,e)})}function erase_google_calendar_prefs_cookie(){var b="_agile_google_calendar_prefs_"+CURRENT_DOMAIN_USER.id;eraseCookie(b)}function get_google_calendar_event_source(b,c){if(c&&typeof(c)==="function"){c({token:b.access_token,dataType:"agile-gcal",className:"agile-gcal"})}}function showCalendar(){_init_gcal_options();var b=(!readCookie("calendarDefaultView"))?"month":readCookie("calendarDefaultView");$("#calendar_event").fullCalendar({eventSources:[{events:function(g,c,f){var d=JSON.parse(readCookie("event-filters"));if(readCookie("event-filters")&&d.type=="google"){$("#loading_calendar_events").hide();return}var e="/core/api/events?start="+g.getTime()/1000+"&end="+c.getTime()/1000;if(readCookie("event-filters")&&d.owner_id.length>0){e+="&owner_id="+d.owner_id}console.log("-----------------",e);$.getJSON(e,function(h){if(h){f(h)}})}},{dataType:"agile-gcal"}],header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},defaultView:b,viewDisplay:function(c){createCookie("calendarDefaultView",c.name,90)
},loading:function(c){if(c){$("#loading_calendar_events").remove();$(".fc-header-left").append('<span id="loading_calendar_events" style="margin-left:5px;vertical-align:middle">loading...</span>').show();$(".fc-header-left").show()}else{$("#loading_calendar_events").hide();start_tour("calendar")}},selectable:true,selectHelper:true,editable:true,theme:false,select:function(f,d,e){$("#activityModal").modal("show");highlight_event();var c="mm/dd/yyyy";$("#task-date-1").val(f.format(c));$("#event-date-1").val(f.format(c));$("#event-date-2").val(d.format(c));if((f.getHours()==0)&&(d.getHours()==0)&&(d.getMinutes()==0)){$("#event-time-1").val("");$("#event-time-2").val("")}else{$("#event-time-1").val((f.getHours()<10?"0":"")+f.getHours()+":"+(f.getMinutes()<10?"0":"")+f.getMinutes());$("#event-time-2").val((d.getHours()<10?"0":"")+d.getHours()+":"+(d.getMinutes()<10?"0":"")+d.getMinutes())}},eventDrop:function(h,d,g,l,f){if(!confirm("Are you sure about this change?")){f();return}var c=$.extend(true,{},h);c.start=new Date(c.start).getTime()/1000;c.end=new Date(c.end).getTime()/1000;if(c.end==null||c.end==0){c.end=c.start}var m=c.contacts;var k=[];for(var e in m){k.push(m[e].id)}delete c.contacts;delete c.owner;c.contacts=k;var j=new Backbone.Model();j.url="core/api/events";j.save(c)},eventClick:function(d){if(isNaN(d.id)){return}deserializeForm(d,$("#updateActivityForm"));$("#update-event-time-1").val((d.start.getHours()<10?"0":"")+d.start.getHours()+":"+(d.start.getMinutes()<10?"0":"")+d.start.getMinutes());$("#update-event-time-2").val((d.end.getHours()<10?"0":"")+d.end.getHours()+":"+(d.end.getMinutes()<10?"0":"")+d.end.getMinutes());var c="mm/dd/yyyy";$("#update-event-date-1").val((d.start).format(c));$("#update-event-date-2").val((d.end).format(c));if(d.allDay){$("#update-event-date-2").closest(".row").hide();$("#update-event-time-1").closest(".control-group").hide()}else{$("#update-event-time-1").closest(".control-group").show();$("#update-event-date-2").closest(".row").show()}$("#updateActivityModal").modal("show");populateUsersInUpdateActivityModal(d);return false}})}function showEventFilters(){$("#filter_options").show();if(readCookie("agile_calendar_view")){$("#filter_options .calendar-view").hide()}else{$("#filter_options .list-view").hide()}if(readCookie("event-filters")){var b=JSON.parse(readCookie("event-filters"));$("#event-owner").val(b.owner_id);$("#event_type").val(b.type)}}function buildEventFilters(){$.getJSON("/core/api/users/agileusers",function(d){var b="",c="";if(d){$.each(d,function(f,e){if(CURRENT_DOMAIN_USER.id==e.domain_user_id){c="<option value="+e.id+">Me</option>"}else{if(e.domainUser){b+="<option value="+e.id+">"+e.domainUser.name+"</option>"}}});b+='<option value="">Any</option>'}$("#event-owner").html(c+b)})}function loadDefaultFilters(b){if(!readCookie("event-filters")){$.getJSON("/core/api/users/agileusers",function(c){if(c){$.each(c,function(f,d){if(CURRENT_DOMAIN_USER.id==d.domain_user_id){var e={};e.owner_id=d.id.toString();e.type="";createCookie("event-filters",JSON.stringify(e))}})}if(b){b()}})}}$(function(){$("#sync-google-calendar").die().live("click",function(c){c.preventDefault();var b=window.location.href;window.location="/scribe?service=google_calendar&return_url="+encodeURIComponent(b)});$("#sync-google-calendar-delete").die().live("click",function(c){c.preventDefault();var b=$(this).attr("disabled");if(b){return}$(this).attr("disabled","disabled");$(this).after(getRandomLoadingImg());App_Widgets.calendar_sync_google.model.url="/core/api/calendar-prefs";console.log(App_Widgets.calendar_sync_google.model.destroy({success:function(){App_Widgets.calendar_sync_google.model.clear();App_Widgets.calendar_sync_google.model.url="/core/api/calendar-prefs/get";App_Widgets.calendar_sync_google.render(true);erase_google_calendar_prefs_cookie()}}))});$("#event-filter-button").live("click",function(b){b.preventDefault();showEventFilters()});$("#event-filter-validate").live("click",function(c){$("#filter_options").hide();var d="eventsFilterForm";var b=serializeForm(d);createCookie("event-filters",JSON.stringify(b));if(readCookie("agile_calendar_view")){if(b.time==="future"){createCookie("agile_calendar_view","calendar_list_view_future")}else{createCookie("agile_calendar_view","calendar_list_view")}}if(!readCookie("agile_calendar_view")){$("#calendar_event").html("");showCalendar()}else{loadAgileEvents();loadGoogleEvents()}});$("#clear-event-filters").live("click",function(b){b.preventDefault();$("#filter_options select").val("");eraseCookie("event-filters");loadDefaultFilters();showEventFilters()});$("#event_type").live("change",function(){console.log("----------",this.options[this.selectedIndex].text);var b=document.getElementById("event-owner");var c=$(this).val();if(c=="google"&&b.options[b.selectedIndex].text!="Any"){b.selectedIndex=0}});$("#event-owner").live("change",function(){console.log("----------",this.options[this.selectedIndex].text);var b=this.options[this.selectedIndex].text;if(b!="Me"&&b!="Any"){$("#event_type").val("agile")}});$(document).mouseup(function(c){var b=$("#filter_options");if(!b.is(c.target)&&b.has(c.target).length===0){b.hide()}});loadDefaultFilters();$.getJSON("/core/api/users/agileusers",function(b){$.each(b,function(d,c){if(CURRENT_DOMAIN_USER.id==c.domain_user_id){CURRENT_AGILE_USER=c}})})});$(function(){$(".update-task-timepicker").timepicker({defaultTime:get_hh_mm(true),showMeridian:false,template:"modal"});$(".new-task-timepicker").timepicker({defaultTime:"12:00",showMeridian:false,template:"modal"});loadProgressSlider($("#taskForm"));loadProgressSlider($("#updateTaskForm"));$("#task").live("click",function(d){d.preventDefault();var c=$("#taskForm");highlight_task();agile_type_ahead("task_related_to",c,contacts_typeahead);populateUsers("owners-list",$("#taskForm"),undefined,undefined,function(e){$("#taskForm").find("#owners-list").html(e);$("#owners-list",c).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#taskForm")).closest("div").find(".loading-img").hide()})});$(".add-task").live("click",function(c){c.preventDefault();showTaskModal(this)});$("#dashboard1-tasks-model-list > tr").live("click",function(c){c.preventDefault();b(this)});$("#update_task_validate").live("click",function(c){c.preventDefault();save_task("updateTaskForm","updateTaskModal",true,this)});$("#updateTaskModal").on("hidden",function(){if($(this).hasClass("in")){return}$("#updateTaskForm").find("li").remove();resetForm($("#updateTaskForm"));$("#updateTaskForm #forNoteForm").html("");$(".task-add-note",$("#updateTaskForm")).show()});$("#updateTaskModal").on("shown",function(){var c=$("#updateTaskForm");agile_type_ahead("update_task_related_to",c,contacts_typeahead);setForm(c)});$("#task-date-1").datepicker({format:"mm/dd/yyyy"});function b(d){var c=$(d).data().toJSON();deserializeForm(c,$("#updateTaskForm"));$("#updateTaskModal").modal("show");$(".update-task-timepicker").val(fillTimePicker(c.due));populateUsers("owners-list",$("#updateTaskForm"),c,"taskOwner",function(e){$("#updateTaskForm").find("#owners-list").html(e);if(c.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+c.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()});showNoteOnForm("updateTaskForm",c.notes)}$(".tasks-select").live("click",function(d){d.stopPropagation();if($(this).is(":checked")){var c=$(this).attr("data");complete_task(c,App_Calendar.tasksListView.collection,$(this).closest("tr"))}})});function highlight_task(){$("#hiddentask").val("task");$("#task").css({color:"black"});$("#event").css({color:"red"});$("#relatedEvent").css("display","none");$("#relatedTask").css("display","block");if($("#activityForm").find("#event_related_to").closest(".controls").find("ul").children()){$("#taskForm").find("#task_related_to").closest(".controls").find("ul").html($("#activityForm").find("#event_related_to").closest(".controls").find("ul").children())}$("input.date").val(new Date().format("mm/dd/yyyy")).datepicker("update")}function save_task(g,c,f,e){if($(e).attr("disabled")){return}disable_save_button($(e));if(!isValidForm("#"+g)){enable_save_button($(e));return false}var d=serializeForm(g);if(!f){d.due=new Date(d.due).getTime()}var h=(d.task_ending_time).split(":");d.due=new Date((d.due)*1000).setHours(h[0],h[1])/1000;var b=new Backbone.Model();b.url="core/api/tasks";b.save(d,{success:function(n){enable_save_button($(e));$("#"+g).each(function(){this.reset()});$("#"+c).modal("hide");var l=n.toJSON();var k=getDueTasksCount();if(k==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}$("#due_tasks_count").html(k);if(Current_Route=="calendar"){if(f){App_Calendar.tasksListView.collection.remove(d)}if(!n.toJSON().is_complete&&n.toJSON().owner_id==CURRENT_DOMAIN_USER.id){App_Calendar.tasksListView.collection.add(n)}App_Calendar.tasksListView.render(true)}else{if(Current_Route=="tasks-old"){var j=$("#content").find(".type-task-button").find(".selected_name").text();var m=$("#content").find(".owner-task-button").find(".selected_name").text();if(f){App_Calendar.allTasksListView.collection.remove(d)}if((j=="All Categories"||j.toUpperCase()==d.type)&&(m=="All Tasks"||d.owner_id==CURRENT_DOMAIN_USER.id)){App_Calendar.allTasksListView.collection.add(n)}App_Calendar.allTasksListView.render(true)}else{if(Current_Route=="tasks"){var o=getCriteria();if(o=="LIST"){if(f){App_Calendar.allTasksListView.collection.remove(d)}App_Calendar.allTasksListView.collection.add(n);App_Calendar.allTasksListView.render(true);return}updateTask(f,n,d)}else{if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){$.each(l.contacts,function(q,p){if(p.id==App_Contacts.contactDetailView.model.get("id")){if(tasksView&&tasksView.collection){if(tasksView.collection.get(n.id)){tasksView.collection.get(n.id).set(new BaseModel(n))
}else{tasksView.collection.add(new BaseModel(n),{sort:false});tasksView.collection.sort()}}add_entity_to_timeline(n);return false}})}else{if(App_Portlets.currentPosition&&App_Portlets.tasksCollection&&App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)]&&(Current_Route==undefined||Current_Route=="dashboard")){if(f){App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)].collection.remove(d)}App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)].collection.add(n);App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)].render(true)}else{if(App_Calendar.allTasksListView){App_Calendar.allTasksListView.collection.remove(n.toJSON());App_Calendar.allTasksListView.collection.add(n.toJSON());App_Calendar.allTasksListView.render(true)}else{if(App_Calendar.tasksListView){App_Calendar.tasksListView.collection.remove(n.toJSON());App_Calendar.tasksListView.collection.add(n.toJSON());App_Calendar.tasksListView.render(true)}}taskDetailView=n;$("#content").html(getTemplate("task-detail",n.toJSON()));task_details_tab.loadActivitiesView()}}}}}}})}function get_due(c){var b=new Date();b.setHours(0,0,0,0);b=b.getTime()/1000;return Math.floor((c-b)/(24*3600))}function increaseCount(c){var b=c.find(".count").attr("count");b=b?parseInt(b)+1:1;c.find(".count").attr("count",b);c.find(".count").text("("+b+")");return b}function append_tasks(b){var c=new Base_List_View({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"tr"});var e=get_due(b.get("due"));if(e<0){var f=$("#overdue-heading",this.el);var d=increaseCount(f);if(d>5){return}$("#overdue",this.el).append(c.render().el);if(d==5){$("#overdue",this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>')}$("#overdue",this.el).find("tr:last").data(b);$("#overdue",this.el).parent("table").css("display","block");f.show();$("#overdue",this.el).show()}if(e==0){var f=$("#today-heading",this.el);var d=increaseCount(f);if(d>5){return}if($("#today > tr",this.el).length>4){return}$("#today",this.el).append(c.render().el);if(d==5){$("#today",this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>')}$("#today",this.el).find("tr:last").data(b);$("#today",this.el).parent("table").css("display","block");$("#today",this.el).show();$("#today-heading",this.el).show()}if(e==1){var f=$("#tomorrow-heading",this.el);var d=increaseCount(f);if(d>5){return}$("#tomorrow",this.el).append(c.render().el);if(d==5){$("#tomorrow",this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>')}$("#tomorrow",this.el).find("tr:last").data(b);$("#tomorrow",this.el).parent("table").css("display","block");$("#tomorrow",this.el).show();$("#tomorrow-heading",this.el).show()}if(e>1){var f=$("#next-week-heading",this.el);var d=increaseCount(f);if(d>5){return}$("#next-week",this.el).append(c.render().el);if(d==5){$("#next-week",this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>')}$("#next-week",this.el).find("tr:last").data(b);$("#next-week",this.el).parent("table").css("display","block");$("#next-week",this.el).show();$("#next-week-heading",this.el).show()}}function append_tasks_dashboard(b){var d=new Base_List_View({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"tr"});var e=get_due(b.get("due"));var c=b.get("is_complete");if(c==false&&e<=0){$("#dashboard1-tasks-model-list",this.el).append(d.render().el)}}function complete_task(c,h,f,j){var g=h.get(c).toJSON();var e=[];$.each(g.contacts,function(l,k){e.push(k.id)});console.log(g.notes);var b=[];$.each(g.notes,function(k,l){b.push(l.id)});console.log(b);g.notes=b;g.note_description="";g.contacts=e;g.is_complete=true;g.status="COMPLETED";g.progress=100;g.owner_id=g.taskOwner.id;var d=new Backbone.Model();d.url="/core/api/tasks";d.save(g,{success:function(m,l){h.remove(m);var k=getDueTasksCount();if(k==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}$("#due_tasks_count").html(k);if(f){f.fadeOut(2000)}if(j&&typeof(j)==="function"){j(m)}}})}function getDueTasksCount(){var b=$.ajax({type:"GET",url:"core/api/tasks/overdue/uptotoday",async:false,dataType:"json"}).responseText;if(!isNaN(b)){return b}return 0}function showTaskModal(c){var b=$("#taskForm");agile_type_ahead("task_related_to",b,contacts_typeahead);$("#activityTaskModal").modal("show");highlight_task();populateUsers("owners-list",$("#taskForm"),undefined,undefined,function(d){$("#taskForm").find("#owners-list").html(d);$("#owners-list",b).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#taskForm")).closest("div").find(".loading-img").hide();addTasklListDetails(c)})}function displayTimeZone(c){console.log("In displayTimeZone");var e;var d;var b=0;$.each(c[0].geometry.location,function(f,g){console.log(g);if(b==0){e=g}else{if(b==1){d=g}}b++});if(!e||!d){return}$.ajax({url:"/core/api/contacts/gettz/"+e+"/"+d,type:"GET",dataType:"text",success:function(f){if(f==null||f==""){return}$(".contacts-time").html("Local time: "+f);$("#contacts-local-time").show();$("#map_view_action").html("<i class='icon-minus text-xxs c-p' title='Hide map' id='disable_map_view'></i>")},error:function(f,h,g){console.log("jqXHR: "+f.status+"\ntextStatus: "+h+"\nerrorThrown: "+g)}})}var CURRENT_VIEW_OBJECT;function contactTableView(e,d,f){var j=new Base_List_View({model:e,template:"contacts-custom-view-model",tagName:f.options.individual_tag_name});var h=f.options.modelData;var c=h.fields_set;var b=e.toJSON();var g=j.el;$.each(c,function(k,l){if(l.indexOf("CUSTOM_")!=-1){l=l.split("CUSTOM_")[1];var m=getProperty(b.properties,l);if(!m){$(g).append(getTemplate("contacts-custom-view-custom",{}));return}if(isDateCustomField(d,m)){console.log("got true");$(g).append(getTemplate("contacts-custom-view-custom-date",m))}else{$(g).append(getTemplate("contacts-custom-view-custom",m))}return}$(g).append(getTemplate("contacts-custom-view-"+l,b))});$(("#"+f.options.templateKey+"-model-list"),f.el).append(g);$(("#"+f.options.templateKey+"-model-list"),f.el).find("tr:last").data(e)}function isDateCustomField(b,d){var c=0;$.each(b,function(e,f){if(f.field_label==d.name){c++}});return c>0}function setupViews(c,b){head.load(CSS_PATH+"css/bootstrap_submenu.css",function(){var d=getTemplate("contact-view-collection");$("#view-list",c).html(d);$("#view-list",c).find(".dropdown-menu").find(".dropdown-submenu").on("click",function(f){f.stopImmediatePropagation()});if(b){$("#view-list",c).find(".custom_view").append(b)}updateSelectedSortKey($("#view-list",c));addClickEventsForSorting($("#view-list",c));if(readCookie("company_filter")||readCookie("contact_filter_type")=="COMPANY"){$("#contact-view-model-list>li").css("display","none");$("#contact-view-model-list>li:first").css("display","list-item")}})}function updateSelectedSortKey(d){var b=readCookie("sort_by_name");if(b&&b!=null){var e="-asc";if(b.indexOf("-")==0){b=b.substring(1);e="-desc"}var c="sort-by-"+b+e;$(d).find("#"+c).addClass("bold-text")}}function addClickEventsForSorting(b){$(b).find(".sort").on("click",function(c){c.preventDefault();eraseCookie("sort_by_name");sort_by=$(this).attr("data");createCookie("sort_by_name",sort_by);CONTACTS_HARD_RELOAD=true;if(!App_Contacts.tag_id){App_Contacts.contacts();return}App_Contacts.contacts(App_Contacts.tag_id);return})}$(function(){$(".ContactView").die().live("click",function(b){b.preventDefault();if(App_Contacts.contactViewModel){App_Contacts.contactViewModel=undefined}if(App_Contacts.contact_custom_view){App_Contacts.contact_custom_view=undefined}var c=$(this).attr("id");createCookie("contact_view",c);if(filter_id=readCookie("contact_filter")){App_Contacts.customView(c,undefined,"core/api/filters/query/"+filter_id);return}if(readCookie("company_filter")){App_Contacts.contacts();return}if(!App_Contacts.tag_id){App_Contacts.customView(c);return}App_Contacts.customView(c,undefined,"core/api/tags/"+App_Contacts.tag_id,App_Contacts.tag_id)});$(".DefaultView").die().live("click",function(b){b.preventDefault();eraseCookie("contact_view");eraseCookie("agile_contact_view");if(App_Contacts.contactViewModel){App_Contacts.contactViewModel=undefined}if(App_Contacts.contactsListView){App_Contacts.contactsListView=undefined}if(!App_Contacts.tag_id){App_Contacts.contacts();return}App_Contacts.contacts(App_Contacts.tag_id)});$(".GridView").die().live("click",function(b){b.preventDefault();eraseCookie("contact_view");createCookie("agile_contact_view","grid_view");if(App_Contacts.contactsListView){App_Contacts.contactsListView=undefined}App_Contacts.contacts(undefined,undefined,true)})});var dup_contacts1_array=[];$(function(){$("#duplicate-contacts-cancel").die().live("click",function(b){b.preventDefault();dup_contacts1_array.length=0;var c=App_Contacts.contactDetailView.model.toJSON();Backbone.history.navigate("contact/"+c.id,{trigger:true})});$("#contact-merge-cancel").die().live("click",function(b){b.preventDefault();dup_contacts1_array.length=0;var c=App_Contacts.contactDetailView.model.toJSON();Backbone.history.navigate("duplicate-contacts/"+c.id,{trigger:true})});$("#duplicate-contacts-checked-grid").die().live("click",function(e){e.preventDefault();var b=[];var f=[];var d=false;var c=$("body").find(".showCheckboxes");$(c).find(".tbody_check").each(function(g,h){if($(h).is(":checked")){dup_contacts1_array.push($(h).closest("tr").find("td.data").attr("data"));d=true}});if(d){if(dup_contacts1_array.length>2){alert("You can merge maximum of 2 records at a time with master record.");dup_contacts1_array.length=0;return}Backbone.history.navigate("merge-contacts",{trigger:true})}else{$("body").find(".select-none").html('<div class="alert alert-error"><a class="close" data-dismiss="alert" href="#">&times;</a>You have not selected any records to merge. Please select at least one record to continue.</div>').show().delay(3000).hide(1)}});$("#merge-contacts-model").die().live("click",function(c){c.preventDefault();
if(dup_contacts1_array.length>1){if(!confirm(" Delete "+dup_contacts1_array.length+" duplicate contacts and merge data to master record?")){return}}else{if(!confirm(" Delete 1 duplicate contact and merge data to master record?")){return}}$(this).attr("disabled","disabled");$("#contact-merge-cancel").attr("disabled","disabled");$("#contact-merge-cancel").after('<img class="contact-merge-loading" style="padding-right:5px;margin-bottom:15px" src= "img/21-0.gif"></img>');var m=false;var j=[];var p=$("body").find("#merge-contacts-table");var f=$(p).find("tbody");var e=[];var h=[];var d=[];var q=[];var g=[];var n=[];var o=App_Contacts.contactDetailView.model;var l=JSON.parse(JSON.stringify(o.toJSON()));var b=o.id;console.log(o.toJSON());f.children().each(function(s,t){$(t).find("[type=radio]:checked").each(function(w,x){if($(x).attr("oid")!=b){var z=$(x).attr("field");var y=$(x).attr("data");var u=$(x).attr("fieldtype");if(typeof u!==typeof undefined&&u!==false){if(y){custom_field={};custom_field.name=z;custom_field.value=y;custom_field.type="CUSTOM";g.push(custom_field)}else{remove_field={};remove_field.name=z;remove_field.type="CUSTOM";n.push(remove_field)}}else{if(y){selected_field={};selected_field.name=z;selected_field.value=y;j.push(selected_field);if(z.toLowerCase()=="company"){var v=$(x).attr("company_id");o.set({contact_company_id:v})}}else{remove_field={};remove_field.name=z;remove_field.type="SYSTEM";n.push(remove_field)}}}});$(t).find("[type=checkbox]:checked").each(function(w,x){var z=$(x).attr("field");var y=$(x).attr("data");var v=$(x).attr("fieldtype");if(z==="email"){var u=$(x).attr("subtype");email={};email.value=y;if(u){email.subtype=u}h.push(email)}else{if(z==="website"){var u=$(x).attr("subtype");website={};website.value=y;if(u){website.subtype=u}d.push(website)}else{if(z==="phone"){var u=$(x).attr("subtype");phone={};phone.value=y;if(u){phone.subtype=u}e.push(phone)}else{if(z==="tags"){q.push(y)}}}}})});var k=l.properties;o.set({tags:q});merge_duplicate_contacts(o,k,j,g,n,d,h,e)})});function merge_duplicate_contacts(s,o,n,m,q,b,l,c){for(var h=o.length-1;h>=0;h--){if(o[h].name.toLowerCase()==="email"||o[h].name.toLowerCase()==="website"||o[h].name.toLowerCase()==="phone"){o.splice(h,1)}}for(var h=0;h<q.length;h++){for(var f=0;f<o.length;f++){var p=o[f];if(p.name.toLowerCase()===q[h].name.toLowerCase()&&p.type.toLowerCase()===q[h].type.toLowerCase()){o.splice(f,1);break}}}for(var f=0;f<n.length;f++){var g=n[f];for(var e=0;e<o.length;e++){if(o[e].name.toLowerCase()===g.name.toLowerCase()){o[e].value=g.value;break}else{if(e==o.length-1){var d={};d.name=g.name;d.value=g.value;d.type="SYSTEM";o.push(d);break}}}}if(m.length>0){for(var h=0;h<m.length;h++){var g=m[h];for(var f=0;f<o.length;f++){if(o[f].name.toLowerCase()===g.name.toLowerCase()&&o[f].type==="CUSTOM"){o[f].value=g.value;break}else{if(f==o.length-1){if(m[h].value){var d={};d.name=m[h].name;d.value=m[h].value;d.type="CUSTOM";o.push(d);break}}}}}}if(l.length>0){for(var h=0;h<l.length;h++){var d={};d.name="email";d.value=l[h].value;d.type="SYSTEM";if(l[h].subtype){d.subtype=l[h].subtype}o.push(d)}}if(c.length>0){for(var h=0;h<c.length;h++){var d={};d.name="phone";d.value=c[h].value;d.type="SYSTEM";if(c[h].subtype){d.subtype=c[h].subtype}o.push(d)}}if(b.length>0){for(var h=0;h<b.length;h++){var d={};d.name="website";d.value=b[h].value;d.type="SYSTEM";if(b[h].subtype){d.subtype=b[h].subtype}o.push(d)}}s.set({properties:o});merge_related_entity_in_master_record(s,dup_contacts1_array)}function merge_related_entity_in_master_record(c,b){c.save({},{url:"/core/api/contacts/merge/"+b.toString(),success:function(){$(".contact-merge-loading").remove();CONTACTS_HARD_RELOAD=true;var d=c.toJSON().id;Backbone.history.navigate("contact/"+d,{trigger:true})}})}BLOB_KEY=undefined;$(function(){$("#import-cancel").die().live("click",function(b){$("#content").html(getTemplate("import-contacts",{}))});$("#deal-cancel").die().live("click",function(b){$("#content").html(getTemplate("import-deals",{}))});$(".upload").die().live("click",function(c){var b=$(this).parents("form").children("#type").val();c.preventDefault();var d=window.open("upload-contacts.jsp?type="+b+"","name","height=310,width=500");if(window.focus){d.focus()}return false});$("#import-contacts").die().live("click",function(j){if($(this).attr("disabled")){return}var l={first_name_missing:{error_message:"First Name is mandatory. Please select first name."},last_name_missing:{error_message:"Last Name is mandatory. Please select last name."},email_missing:{error_message:"Email is mandatory. Please select Email."},first_name_duplicate:{error_message:" You have assigned First Name to more than one element. Please ensure that first name is assigned to only one element. "},last_name_duplicate:{error_message:"You have assigned Last Name to more than one element. Please ensure that last name is assigned to only one element."},company_duplicate:{error_message:"You have assigned Company to more than one element. Please ensure that company is assigned to only one element."},job_title_duplicate:{error_message:"You have assigned job description to more than one element. Please ensure that job description is assigned to only one element."},invalid_tag:{error_message:"Tag name should start with an alphabet and can not contain special characters other than underscore and space."}};var b=[];$(".import_contact_error").hide();var o=0,d=0,n=0,c=0,f=0;$(".import-select").each(function(e,q){var s=$(q).val();if(s=="properties_first_name"){o+=1}else{if(s=="properties_last_name"){d+=1}else{if(s=="properties_company"){c+=0}else{if(s.indexOf("-email")!=-1){n+=1}else{if(s=="properties_title"){f+=1}}}}}});if(o==0){$("#import-validation-error").html(getTemplate("import-contacts-validation-message",l.first_name_missing));return false}else{if(n==0){$("#import-validation-error").html(getTemplate("import-contacts-validation-message",l.email_missing));return false}else{if(o>1){$("#import-validation-error").html(getTemplate("import-contacts-validation-message",l.first_name_duplicate));return false}else{if(d>1){$("#import-validation-error").html(getTemplate("import-contacts-validation-message",l.last_name_duplicate));return false}else{if(c>1){$("#import-validation-error").html(getTemplate("import-contacts-validation-message",l.company_duplicate));return false}else{if(f>1){$("#import-validation-error").html(getTemplate("import-contacts-validation-message",l.job_title_duplicate));return false}}}}}}var k=[];var g={};var p=get_tags("import-contact-tags");console.log(p);var m=true;if(p!=undefined){$.each(p[0].value,function(e,q){if(!isValidTag(q,false)){m=false;return false}if(!g.tags){g.tags=[]}console.log(g);g.tags.push(q)})}if(!m){$("#import-validation-error").html(getTemplate("import-contacts-validation-message",l.invalid_tag));return false}$(this).attr("disabled",true);$waiting=$('<div style="display:inline-block;padding-left:5px"><small><p class="text-success"><i><span id="status-message">Please wait</span></i></p></small></div>');$waiting.insertAfter($("#import-cancel"));$("td.import-contact-fields").each(function(s,t){console.log(this);console.log(s);var v={};var e=$(this).find("select");console.log(e);var q=$(e).val();var u=$(e).find(":selected").attr("class")=="CUSTOM"?"CUSTOM":"SYSTEM";console.log("name :"+q+", type"+u);if(q.indexOf("properties_")!=-1){q=q.split("properties_")[1];v.type=u;if(q.indexOf("address-")!=-1){var w=q.split("-");q="address";v.subtype="home";v.type=u;console.log(w);v.value=w[1]}else{if(q.indexOf("-")!=-1){var w=q.split("-");q=w[1];var x=w[0];if(x=="GOOGLE"){v.subtype="GOOGLE-PLUS"}else{v.subtype=x;console.log($(e).attr("class"));v.type=u}}}if(!v.value){v.value=q}v.name=q;console.log(v);if(q.indexOf("_ignore_")!=-1){v={}}}else{v.name=q}k.push(v)});g.properties=k;g.type="PERSON";$waiting.find("#status-message").html(getRandomLoadingImg());var h=g;console.log(h);$.ajax({type:"POST",url:"/core/api/upload/save?type=Contacts&key="+BLOB_KEY,data:JSON.stringify(h),contentType:"application/json",success:function(e){$("#content").html(getTemplate("import-contacts",{}));showNotyPopUp("information","Contacts are now being imported. You will be notified on email when it is done","top",5000);addTagAgile(IMPORT_TAG)}})})});$("#import-comp").die().live("click",function(g){if($(this).attr("disabled")){return}var c={company_name_missing:{error_message:"Company Name is mandatory. Please select Company name."},company_name_duplicated:{error_message:"Company Name is Duplicated."}};var h=[];$(".import_contact_error").hide();company_count=0;$(".import-select").each(function(e,j){var k=$(j).val();if(k=="properties_name"){company_count+=1}});if(company_count==0){$("#import-validation-error").html(getTemplate("import-company-validation-message",c.company_name_missing));return false}else{if(company_count>1){$("#import-validation-error").html(getTemplate("import-company-validation-message",c.company_name_duplicated));return false}}$(this).attr("disabled",true);$waiting=$('<div style="display:inline-block;padding-left:5px"><small><p class="text-success"><i><span id="status-message">Please wait</span></i></p></small></div>');$waiting.insertAfter($("#import-cancel"));var f=[];var d={};$("td.import-contact-fields").each(function(k,l){console.log(this);console.log(k);var n={};var e=$(this).find("select");console.log(e);var j=$(e).val();var m=$(e).find(":selected").attr("class")=="CUSTOM"?"CUSTOM":"SYSTEM";console.log("name :"+j+", type"+m);if(j.indexOf("properties_")!=-1){j=j.split("properties_")[1];n.type=m;if(j.indexOf("address-")!=-1){var o=j.split("-");j="address";n.subtype="office";n.type=m;console.log(o);n.value=o[1]}else{if(j.indexOf("-")!=-1){var o=j.split("-");j=o[1];var p=o[0];if(p=="GOOGLE"){n.subtype="GOOGLE-PLUS"}else{n.subtype=p;console.log($(e).attr("class"));n.type=m}}}if(!n.value){n.value=j}n.name=j;console.log(n);if(j.indexOf("_ignore_")!=-1){n={}}}else{n.name=j}f.push(n)});d.properties=f;d.type="COMPANY";$waiting.find("#status-message").html(getRandomLoadingImg());
var b=d;console.log(b);$.ajax({type:"POST",url:"/core/api/upload/save?type=Companies&key="+BLOB_KEY,data:JSON.stringify(b),contentType:"application/json",success:function(e){$("#content").html(getTemplate("import-contacts",{}));showNotyPopUp("information","Companies are now being imported. You will be notified on email when it is done","top",5000)}})});$("#import-deals").die().live("click",function(g){if($(this).attr("disabled")){return}var c={deal_name_missing:{error_message:"Deal Name is mandatory. Please select deal name."},deal_duplicated:{error_message:"Deal Name field is duplicated"},deal_value_duplicated:{error_message:"Deal value field is duplicated"},deal_track_duplicated:{error_message:"Deal track field is duplicated"},deal_milestone_duplicated:{error_message:"Milestone field is duplicated."},deal_related_contact_duplicated:{error_message:"Deal relatsTo field duplicated"},deal_probability_duplicated:{error_message:"Deal probability field is duplicated"},deal_close_date_duplicated:{error_message:"Deal close date field is duplicated"},deal_note_duplicated:{error_message:"Deal Note field duplicated"},deal_description_duplicated:{error_message:"Deal descriptions field is duplicated"}};var h=[];$(".import_contact_error").hide();deal_count=0,value_count=0,probability_count=0,milestone_count=0,track_count=0,close_date_count=0,related_count=0,note_count=0,description_count=0;$(".import-select").each(function(e,j){var k=$(j).val();if(k=="properties_name"){deal_count+=1}if(k=="properties_value"){value_count+=1}if(k=="properties_probability"){probability_count+=1}if(k=="properties_milestone"){milestone_count+=1}if(k=="properties_track"){track_count+=1}if(k=="properties_closeDate"){close_date_count+=1}if(k=="properties_relatedTo"){related_count+=1}if(k=="properties_note"){note_count+=1}if(k=="properties_description"){description_count+=1}});if(deal_count==0){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_name_missing));return false}else{if(deal_count>1){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_duplicated));return false}else{if(value_count>1){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_value_duplicated));return false}else{if(track_count>1){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_track_duplicated));return false}else{if(milestone_count>1){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_milestone_duplicated));return false}else{if(related_count>1){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_related_contact_duplicated));return false}else{if(probability_count>1){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_probability_duplicated));return false}else{if(close_date_count>1){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_close_date_duplicated));return false}else{if(note_count>1){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_note_duplicated));return false}else{if(description_count>1){$("#import-validation-error").html(getTemplate("import-deal-validation-message",c.deal_description_duplicated));return false}}}}}}}}}}$(this).attr("disabled",true);$waiting=$('<div style="display:inline-block;padding-left:5px"><small><p class="text-success"><i><span id="status-message">Please wait</span></i></p></small></div>');$waiting.insertAfter($("#import-cancel"));var f=[];var d={};$("td.import-contact-fields").each(function(k,l){console.log(this);console.log(k);var n={};var e=$(this).find("select");console.log(e);var j=$(e).val();var m=$(e).find(":selected").attr("class")=="CUSTOM"?"CUSTOM":"SYSTEM";console.log("name :"+j+", type"+m);if(j.indexOf("properties_")!=-1){j=j.split("properties_")[1];n.type=m;if(!n.value){n.value=j}n.name=j;console.log(n);if(j.indexOf("_ignore_")!=-1){n={}}}else{n.name=j}f.push(n)});d.properties=f;$waiting.find("#status-message").html(getRandomLoadingImg());var b=d;console.log(b);$.ajax({type:"POST",url:"/core/api/upload/save?type=Deals&key="+BLOB_KEY,data:JSON.stringify(b),contentType:"application/json",success:function(e){showNotyPopUp("information","Deals are now being imported. You will be notified on email when it is done","top",5000);location.href=window.location.origin+"#deals"}})});function parseCSV(b,c){BLOB_KEY=b;$("#upload_contacts").after(getRandomLoadingImg());$.getJSON("core/api/upload/process?blob-key="+b,function(e){var d;console.log(e);if(e==undefined){return}constructCustomfieldOptions(c,function(f,g){e.custom_fields=f.toJSON();if(c=="contacts"){d=$(getTemplate("import-contacts-2",e))}else{if(c=="company"){d=$(getTemplate("import-companies",e))}else{if(c=="deals"){d=$(getTemplate("import-deals2",e))}}}$("#content").html(d);setup_tags_typeahead()})}).error(function(d){$save_info=$('<div style="display:inline-block;margin-left:5px"><small><p style="color:#B94A48; font-size:14px"><i>'+d.responseText+"</i></p></small></div>");$(".loading").remove();$("#upload_contacts").after($save_info);$save_info.show().delay(3500).hide(1)})}function constructCustomfieldOptions(b,d){var c;if(b=="contacts"){c=Backbone.Collection.extend({url:"core/api/custom-fields/byscope?scope=CONTACT"})}else{if(b=="company"){c=Backbone.Collection.extend({url:"core/api/custom-fields/byscope?scope=COMPANY"})}else{if(b=="deals"){c=Backbone.Collection.extend({url:"core/api/custom-fields/byscope?scope=DEAL"})}}}new c().fetch({success:function(f){var e="";$.each(f.toJSON(),function(g,h){e=e+'<option value ="'+h.field_label+'" id="'+h.field_type+'">'+h.field_label+"</option>"});if(d&&typeof(d)==="function"){d(f,e)}}})}var scrambled_index=0;function scramble_filter_input_names(b){$(b).find("input[type=text],input[type=number]").each(function(){$(this).attr("name","temp-"+scrambled_index);$(this).attr("id","temp-"+scrambled_index);scrambled_index+=1})}function setupLhsFilters(c,d){var b="<option value='{{id}}'>{{name}}</option>";if(d){$("#lhs_filters_conatiner",c).html(getTemplate("companies-lhs-filters"));fillSelect("owner_select","/core/api/users",undefined,function(){if(!COMPANY_CUSTOM_FIELDS){$.getJSON("core/api/custom-fields/searchable/scope?scope=COMPANY",function(e){COMPANY_CUSTOM_FIELDS=e;loadCustomFiledsFilters(e,c,d);return})}else{loadCustomFiledsFilters(COMPANY_CUSTOM_FIELDS,c,d)}},b,false,$("#lhs_filters_conatiner",c))}else{$("#lhs_filters_conatiner",c).html(getTemplate("contacts-lhs-filters"));fillSelect("owner_select","/core/api/users",undefined,function(){fillSelect("campaign_select","/core/api/workflows",undefined,function(){$("#campaign_select").next(".loading").remove();if(!SEARCHABLE_CONTACT_CUSTOM_FIELDS){$.getJSON("core/api/custom-fields/searchable/scope?scope=CONTACT",function(e){SEARCHABLE_CONTACT_CUSTOM_FIELDS=e;loadCustomFiledsFilters(e,c,d);return})}else{loadCustomFiledsFilters(SEARCHABLE_CONTACT_CUSTOM_FIELDS,c,d)}},b,false,$("#lhs_filters_conatiner",c))},b,false,$("#lhs_filters_conatiner",c))}}function loadCustomFiledsFilters(b,c,d){$("#custom-filter-fields",c).html(getTemplate("contacts-lhs-filters-custom",b));addTagsTypeaheadLhs($("#tags-lhs-filter-table",c).find("div.lhs-contact-filter-row").find("#RHS"));$("input.date",c).datepicker({format:"mm/dd/yyyy",autoclose:true});$('select[name="CONDITION"]',c).die().live("change",function(g){var f=$(this).val();$(this).parent().find("div.condition_container").addClass("hide");$(this).parent().find("div.condition_container."+f).find("input").val("").attr("prev-val","");$(this).parent().find("div.condition_container."+f).find("select").val("").attr("prev-val","");$(this).parent().find("div.condition_container."+f).removeClass("hide");$(this).parent().find("div.condition_container."+f).find("#RHS :not(input.date)").focus()});scramble_filter_input_names(c);if(d&&readData("dynamic_company_filter")){deserializeLhsFilters($("#lhs-contact-filter-form"),readData("dynamic_company_filter"))}if(!d&&readData("dynamic_contact_filter")){deserializeLhsFilters($("#lhs-contact-filter-form"),readData("dynamic_contact_filter"))}}function submitLhsFilter(){var c=serializeLhsFilters($("#lhs-contact-filter-form"));eraseCookie("contact_filter");eraseCookie("contact_filter_type");var b=c.contact_type;if(b=="COMPANY"){eraseData("dynamic_company_filter");if(c!=null&&c.rules.length>0){storeData("dynamic_company_filter",JSON.stringify(c));createCookie("company_filter","Companies")}}else{eraseData("dynamic_contact_filter");if(c!=null&&c.rules.length>0){storeData("dynamic_contact_filter",JSON.stringify(c))}}CONTACTS_HARD_RELOAD=true;App_Contacts.contacts(undefined,undefined,undefined,true)}$("a.filter-multiple-add-lhs").die().live("click",function(b){b.preventDefault();var d=$(this).data("name");var c=$("#"+d+"-lhs-filter-table").find("div.hide.master-"+d+"-add-div").clone();c.removeClass("hide").addClass("lhs-contact-filter-row");if(d=="tags"){addTagsTypeaheadLhs(c)}scramble_filter_input_names(c);$(c).appendTo("#"+d+"-lhs-filter-table");$("#"+d+"-lhs-filter-table").find("div.lhs-contact-filter-row:last").find("#RHS:visible").find(":not(input.date)").focus()});$("i.filter-tags-multiple-remove-lhs").die().live("click",function(c){var b=$(this).parents(".lhs-contact-filter-row");$(b).find("#RHS").children().val("").trigger("blur").trigger("change");$(this).closest("div.lhs-contact-filter-row").remove()});$("a.clear-filter-condition-lhs").die().live("click",function(c){$(this).addClass("hide");var b=$(this).parents(".lhs-row-filter");$(b).find("#RHS").children().val("").attr("prev-val","");$(b).find("#RHS_NEW:visible").children().val("").attr("prev-val","");$(b).find("a#lhs-filters-header").find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o");$(b).find("a#lhs-filters-header").next().addClass("hide");submitLhsFilter()});$("#clear-lhs-contact-filters").die().live("click",function(b){b.preventDefault();eraseData("dynamic_contact_filter");
CONTACTS_HARD_RELOAD=true;App_Contacts.contacts()});$("#clear-lhs-company-filters").die().live("click",function(b){b.preventDefault();eraseData("dynamic_company_filter");CONTACTS_HARD_RELOAD=true;App_Contacts.contacts()});$("#lhs-filters-header").die().live("click",function(b){b.preventDefault();$(this).find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o");$(this).next().toggleClass("hide");$(this).next().find(".lhs-contact-filter-row:visible").find("#RHS:visible").find(":not(input.date)").focus()});$("#lhs-contact-filter-form #RHS input").die().live("blur keyup",function(d){if(d.type=="focusout"||d.keyCode=="13"){var f=$(this).attr("prev-val");var c=$(this).val().trim();if(f==c){return}else{$(this).attr("prev-val",c)}if($(this).parent().next().attr("id")=="RHS_NEW"){if($(this).parent().next().find("input").val()!=""&&c!=""){submitLhsFilter();$(this).blur()}}else{if(c==""){var b=$(this).parents(".lhs-contact-filter-row");$(b).find("a.clear-filter-condition-lhs").addClass("hide")}submitLhsFilter();$(this).blur()}}});$("#lhs-contact-filter-form #RHS select").die().live("change",function(d){if($(this).parent().next().attr("id")=="RHS_NEW"){if($(this).val()!=""&&$(this).parent().next().children().val()!=""){submitLhsFilter()}if($(this).val()==""&&$(this).parent().next().children().val()==""){var b=$(this).parents(".lhs-contact-filter-row");$(b).find("a.clear-filter-condition-lhs").addClass("hide");submitLhsFilter()}}else{var f=$(this).attr("prev-val");var c=$(this).val().trim();if(f==c){return}else{$(this).attr("prev-val",c)}if($(this).val()==""){var b=$(this).parents(".lhs-contact-filter-row");$(b).find("a.clear-filter-condition-lhs").addClass("hide")}submitLhsFilter()}$(this).blur()});$("#lhs-contact-filter-form #RHS_NEW select").die().live("change",function(b){if($(this).parent().prev().attr("id")=="RHS"){if($(this).val()!=""&&$(this).parent().prev().children().val()!=""){submitLhsFilter()}if($(this).val()==""&&$(this).parent().prev().children().val()==""){submitLhsFilter()}}else{submitLhsFilter()}$(this).blur()});$("#lhs-contact-filter-form #RHS_NEW input").die().live("blur keyup",function(c){if(c.type=="focusout"||c.keyCode=="13"){var d=$(this).attr("prev-val");var b=$(this).val().trim();if(d==b){return}else{$(this).attr("prev-val",b)}if($(this).parent().prev().attr("id")=="RHS"){if($(this).parent().prev().find("input").val()!=""){submitLhsFilter();$(this).blur()}}else{if(b!=""){submitLhsFilter();$(this).blur()}}}});function addTagsTypeaheadLhs(c){var b=[];if(!TAGS){var d=Backbone.Collection.extend({url:"/core/api/tags",sortKey:"tag"});tagsCollection=new d();tagsCollection.fetch({success:function(e){TAGS=tagsCollection.models;addTagsTypeaheadLhsFilters(tagsCollection.toJSON(),c)}});return}addTagsTypeaheadLhsFilters(tagsCollection.toJSON(),c)}function addTagsTypeaheadLhsFilters(c,d){var b=[];$.each(c,function(e,f){b.push(f.tag.toString())});$("input",d).typeahead({source:b,updater:function(e){this.$element.val(e);this.$element.trigger("blur");this.hide();return e}}).attr("placeholder","Enter Tag").width("92%")}$(function(){$("#zoho-import").die().live("click",function(b){b.preventDefault();var c=window.open("import_zoho.jsp","name","height=420,width=500");if(window.focus){c.focus()}return false});$("#zoho-prefs-delete").die().live("click",function(c){c.preventDefault();var b=$(this).attr("disabled");if(b){return}$(this).attr("disabled","disabled");$(this).after(getRandomLoadingImg());console.log(App_Widgets.zoho_sync.model.destroy({success:function(){App_Widgets.stripe_sync.model.clear();App_Widgets.stripe_sync.render(true)}}))})});$(function(){$("#import_shopify").die().live("click",function(c){var d=$("#shop").val();if(d==""){alert("Enter Shop name");$("#shop").focus();return false}var b=window.location.origin;c.preventDefault();window.location="/scribe?service_type=shopify&url=sync&shop="+d+"&domain="+b+""});$("#shopify-setting").die().live("click",function(f){f.preventDefault();var d=$(this).attr("disabled");if(d){return false}else{$(this).attr("disabled","disabled");$(this).text("Syncing")}var b=serializeForm("shopify-contact-import-form");b.inProgress=true;App_Widgets.shopify_sync_setting.model.set(b,{silent:true});var c=App_Widgets.shopify_sync_setting.model.url;$(this).after(getRandomLoadingImg());App_Widgets.shopify_sync_setting.model.url=c+"?sync=true";App_Widgets.shopify_sync_setting.model.save({},{success:function(e){App_Widgets.shopify_sync_setting.render(true);App_Widgets.shopify_sync_setting.model.url=c;show_success_message_after_save_button("Sync Initiated",App_Widgets.shopify_sync_setting.el);showNotyPopUp("information","Contacts sync initiated","top",1000)}})})});$(function(){$("#import_salesforce").die().live("click",function(b){b.preventDefault();var c=window.open("import_salesforce.jsp?id=import_from_salesforce","name","height=420,width=500");if(window.focus){c.focus()}return false})});$(function(){$("#stripe_import").die().live("click",function(c){var b=window.location.origin+"/#sync/stripe-import";console.log(b);window.location="/scribe?service=stripe_import&return_url="+encodeURIComponent(b);return false});$("#stripe-import-prefs-delete").die().live("click",function(c){c.preventDefault();var b=$(this).attr("disabled");if(b){return}$(this).attr("disabled","disabled");$(this).after(getRandomLoadingImg());console.log(App_Widgets.stripe_sync.model.destroy({success:function(){App_Widgets.stripe_sync.model.clear();App_Widgets.stripe_sync.render(true)}}))});$("#stripe_sync_prefs").die().live("click",function(f){f.preventDefault();var d=$(this).attr("disabled");if(d){return false}else{$(this).attr("disabled","disabled");$(this).text("Syncing")}var b=serializeForm("stripe-prefs-form");b.inProgress=true;App_Widgets.stripe_sync_setting.model.set(b,{silent:true});var c=App_Widgets.stripe_sync_setting.model.url;$(this).after(getRandomLoadingImg());App_Widgets.stripe_sync_setting.model.url=c+"?sync=true";App_Widgets.stripe_sync_setting.model.save({},{success:function(e){App_Widgets.stripe_sync_setting.render(true);App_Widgets.stripe_sync_setting.model.url=c;show_success_message_after_save_button("Sync Initiated",App_Widgets.stripe_sync_setting.el);showNotyPopUp("information","Contacts sync initiated","top",1000)}})})});$(function(){$("#freshbooks").die().live("click",function(g){g.preventDefault();var d=$("#freshbooks_url").val();var f=$("#freshbooks_apiKey").val();if(b(d)){$("#domainerror").removeClass("hide");$("#freshbooks_url").focus();$("#freshbooks_url").keypress(function(){$("#domainerror").addClass("hide")});return false}else{if(new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/.*)?").test(d)){alert("Please Enter Domain Name only");$("#domainerror").removeClass("hide");$("#freshbooks_url").focus();$("#freshbooks_url").keypress(function(){$("#domainerror").addClass("hide")});return false}}if(b(f)){$("#apierror").removeClass("hide");$("#freshbooks_apiKey").focus();$("#freshbooks_apiKey").keypress(function(){$("#apierror").addClass("hide")});return false}else{if(f.length!=32){$("#apierror").removeClass("hide");$("#freshbooks_apiKey").focus();$("#freshbooks_apiKey").keypress(function(){$("#apierror").addClass("hide")});return false}}$.ajax({url:"core/api/freshbooks/save/"+f+"/"+d+"",async:false,success:function(e){if(e){console.log(e)}}});var c=window.location.hash;if(c=="#sync/freshbooks/setting"){window.location.reload()}else{if(c=="#sync/freshbooks"){window.location=window.location.origin+"#sync/freshbooks/setting"}else{window.location=window.location.origin+"#sync"}}});function b(c){return(!c||/^\s*$/.test(c))}function b(c){return(!c||/^\s*$/.test(c))}});$(function(){$("#google-import").die().live("click",function(c){var b=window.location.href+"/contacts";console.log(b);window.location="/scribe?service=google&return_url="+encodeURIComponent(b)});$("#google-import-prefs-delete").die().live("click",function(c){c.preventDefault();var b=$(this).attr("disabled");if(b){return}$(this).attr("disabled","disabled");$(this).after(getRandomLoadingImg());console.log(App_Widgets.contact_sync_google.model.destroy({success:function(){App_Widgets.contact_sync_google.model.clear();App_Widgets.contact_sync_google.render(true)}}))});$("#sync-type").die().live("change",function(c){c.preventDefault();var b=$(this).val();if(b=="AGILE_TO_CLIENT"||b=="TWO_WAY"){$("#sync_to_group_controlgroup").show();$("#my_contacts_sync_group").show();if(b=="AGILE_TO_CLIENT"){$("#sync_from_group_controlgroup").hide();return}$("#sync_from_group_controlgroup").show()}else{$("#sync_from_group_controlgroup").show();$("#sync_to_group_controlgroup").hide();$("#my_contacts_sync_group").hide()}});$(".save-contact-prefs").die().live("click",function(f){f.preventDefault();var d=$(this).attr("disabled");if(d){return}if(!isValidForm("#google-contacts-import-form")){return}$(this).attr("disabled","disabled");$(this).text("Syncing");var b=serializeForm("google-contacts-import-form");b.inProgress=true;App_Widgets.setup_google_contacts.model.set(b,{silent:true});var c=App_Widgets.setup_google_contacts.model.url;$(this).after(getRandomLoadingImg());App_Widgets.setup_google_contacts.model.url=c+"?sync=true";App_Widgets.setup_google_contacts.model.save({},{success:function(e){App_Widgets.setup_google_contacts.render(true);App_Widgets.setup_google_contacts.model.url=c;show_success_message_after_save_button("Sync Initiated",App_Widgets.setup_google_contacts.el);showNotyPopUp("information","Contacts sync initiated","top",1000)}})});$("#quickbook_sync_prefs").die().live("click",function(d){d.preventDefault();var c=$(this).attr("disabled");if(c){return false}$(this).attr("disabled","disabled");$(this).text("Syncing");var f=serializeForm("quickbook-form");f.inProgress=true;App_Widgets.quickbook_import_settings.model.set(f,{silent:true});var b=App_Widgets.quickbook_import_settings.model.url;$(this).after(getRandomLoadingImg());App_Widgets.quickbook_import_settings.model.url=b+"?sync=true";
App_Widgets.quickbook_import_settings.model.save({},{success:function(e){App_Widgets.quickbook_import_settings.render(true);App_Widgets.quickbook_import_settings.model.url=b;show_success_message_after_save_button("Sync Initiated",App_Widgets.quickbook_import_settings.el);showNotyPopUp("information","Contacts sync initiated","top",1000)}})});$("#xero_sync_prefs").die().live("click",function(f){f.preventDefault();var d=$(this).attr("disabled");if(d){return false}$(this).attr("disabled","disabled");$(this).text("Syncing");var c=serializeForm("quickbook-form");c.inProgress=true;App_Widgets.xero_import_settings.model.set(c,{silent:true});var b=App_Widgets.xero_import_settings.model.url;$(this).after(getRandomLoadingImg());App_Widgets.xero_import_settings.model.url=b+"?sync=true";App_Widgets.xero_import_settings.model.save({},{success:function(e){App_Widgets.xero_import_settings.render(true);App_Widgets.xero_import_settings.model.url=b;show_success_message_after_save_button("Sync Initiated",App_Widgets.xero_import_settings.el);showNotyPopUp("information","Contacts sync initiated","top",1000)}})});$("#freshbooks_sync_prefs").die().live("click",function(f){f.preventDefault();var c=$(this).attr("disabled");if(c){return false}$(this).attr("disabled","disabled");$(this).text("Syncing");var d=serializeForm("freshbooks-form");d.inProgress=true;App_Widgets.freshbooks_import_settings.model.set(d,{silent:true});var b=App_Widgets.freshbooks_import_settings.model.url;$(this).after(getRandomLoadingImg());App_Widgets.freshbooks_import_settings.model.url=b+"?sync=true";App_Widgets.freshbooks_import_settings.model.save({},{success:function(e){App_Widgets.freshbooks_import_settings.render(true);App_Widgets.freshbooks_import_settings.model.url=b;show_success_message_after_save_button("Sync Initiated",App_Widgets.freshbooks_import_settings.el);showNotyPopUp("information","Contacts sync initiated","top",1000)}})})});function show_success_message_after_save_button(c,b){$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px" class="text-success"><i>'+c+"</i></p></small></div>");$(".form-actions",b).append($save_info);$save_info.show().delay(3000).hide(1)}$("#xeroconnect").die().live("click",function(c){var b=window.location.href;console.log(b);window.location="/scribe?service=xero&return_url="+encodeURIComponent(b);return false});function getEditDistance(d,c){if(d.length===0){return c.length}if(c.length===0){return d.length}var e=[];var g;for(g=0;g<=c.length;g++){e[g]=[g]}var f;for(f=0;f<=d.length;f++){e[0][f]=f}for(g=1;g<=c.length;g++){for(f=1;f<=d.length;f++){if(c.charAt(g-1)==d.charAt(f-1)){e[g][f]=e[g-1][f-1]}else{e[g][f]=Math.min(e[g-1][f-1]+1,Math.min(e[g][f-1]+1,e[g-1][f]+1))}}}return e[c.length][d.length]}$(function(){$(".fieldmodal").die().live("click",function(c){c.preventDefault();var b=$(this).attr("type");showCustomFieldModel({scope:b,position:$(this).parent().parent().find("table > tbody > tr").length+1})});$("#custom-field-type").die().live("change",function(c){c.preventDefault();var b=$(this).val();if(b=="LIST"){$("#custom-field-data").hide();$("input",$("#custom-field-data")).removeAttr("name");$("#custom-field-list-values").show();$("input",$("#custom-field-list-values")).attr("name","field_data");$("#custom-field-formula-data").hide();$("textarea",$("#custom-field-formula-data")).removeAttr("name")}else{if(b=="TEXTAREA"){$("#custom-field-data").show();$("input",$("#custom-field-data")).attr("name","field_data");$("#custom-field-list-values").hide();$("input",$("#custom-field-list-values")).removeAttr("name");$("#custom-field-formula-data").hide();$("textarea",$("#custom-field-formula-data")).removeAttr("name")}else{if(b=="FORMULA"){$("#custom-field-data").hide();$("input",$("#custom-field-data")).removeAttr("name");$("#custom-field-list-values").hide();$("input",$("#custom-field-list-values")).removeAttr("name");$("#custom-field-formula-data").show();$("textarea",$("#custom-field-formula-data")).attr("name","field_data")}else{$("#custom-field-data").hide();$("#custom-field-list-values").hide();$("#custom-field-formula-data").hide()}}}});$('#admin-settings-customfields-model-list > tr > td:not(":first-child")').live("click",function(c){c.preventDefault();var b=$(this).closest("tr").data();console.log(b);showCustomFieldModel(b.toJSON())});$("#edit-custom-field").live("click",function(c){c.preventDefault();var b=$(this).closest("tr").data();console.log(b);showCustomFieldModel(b.toJSON())});$("#delete-custom-field").live("click",function(d){if(confirm("Are you sure you want to delete?")){d.preventDefault();var c=$(this).closest("tr").data();console.log(c);var b=$(this);$.ajax({type:"DELETE",url:"/core/api/custom-fields/"+c.id,contentType:"application/json; charset=utf-8",success:function(e){if(c.get("scope")=="CONTACT"){App_Admin_Settings.contactCustomFieldsListView.collection.remove(c.id)}else{if(c.get("scope")=="COMPANY"){App_Admin_Settings.companyCustomFieldsListView.collection.remove(c.id)}else{if(c.get("scope")=="DEAL"){App_Admin_Settings.dealCustomFieldsListView.collection.remove(c.id)}else{if(c.get("scope")=="CASE"){App_Admin_Settings.caseCustomFieldsListView.collection.remove(c.id)}}}}b.closest("tr").remove()},dataType:"json"})}})});function showCustomFieldModel(c){var b=false;b=!c.id;var d=new Base_Model_View({url:"/core/api/custom-fields",template:"custom-field-add-modal",data:c,modal:"#custom-field-add-modal",isNew:b,postRenderCallback:function(e){$(".modal-backdrop").remove();console.log($("#custom-field-add-modal",e));$("#custom-field-add-modal",e).modal("show")},saveCallback:function(e){console.log(e);var f;if(e.scope=="CONTACT"){f=App_Admin_Settings.contactCustomFieldsListView.collection.get(e.id)}else{if(e.scope=="COMPANY"){f=App_Admin_Settings.companyCustomFieldsListView.collection.get(e.id)}else{if(e.scope=="DEAL"){f=App_Admin_Settings.dealCustomFieldsListView.collection.get(e.id)}else{if(e.scope=="CASE"){f=App_Admin_Settings.caseCustomFieldsListView.collection.get(e.id)}}}}if(f){f.set(new BaseModel(e),{silent:true});if(e.scope=="CONTACT"){App_Admin_Settings.contactCustomFieldsListView.render(true)}else{if(e.scope=="COMPANY"){App_Admin_Settings.companyCustomFieldsListView.render(true)}else{if(e.scope=="DEAL"){App_Admin_Settings.dealCustomFieldsListView.render(true)}else{if(e.scope=="CASE"){App_Admin_Settings.caseCustomFieldsListView.render(true)}}}}}else{if(e.scope=="CONTACT"){App_Admin_Settings.contactCustomFieldsListView.collection.add(e);App_Admin_Settings.contactCustomFieldsListView.render(true)}else{if(e.scope=="COMPANY"){App_Admin_Settings.companyCustomFieldsListView.collection.add(e);App_Admin_Settings.companyCustomFieldsListView.render(true)}else{if(e.scope=="DEAL"){App_Admin_Settings.dealCustomFieldsListView.collection.add(e);App_Admin_Settings.dealCustomFieldsListView.render(true)}else{if(e.scope=="CASE"){App_Admin_Settings.caseCustomFieldsListView.collection.add(e);App_Admin_Settings.caseCustomFieldsListView.render(true)}}}}}$(".modal-backdrop").remove();$("#custom-field-add-modal").modal("hide");$("#custom-field-add-modal").modal("hide")}});$("#custom-field-modal").html(d.render(true).el);$("#custom-field-type").trigger("change")}function add_custom_fields_to_form(c,f,d){if(d==undefined||d=="CONTACT"){$("#content").html(LOADING_HTML)}var b="core/api/custom-fields/scope?scope="+(d==undefined?"CONTACT":d);var e=Backbone.Model.extend({url:b});new e().fetch({success:function(g){var h=[];$.each(g.toJSON(),function(j,k){h.push(k)});App_Contacts.custom_fields=h;c.custom_fields=h;if(f&&typeof(f)==="function"){f(c)}}})}function show_custom_fields_helper(d,b){var c="";var e="text";$.each(d,function(g,k){if(!k.field_type){return}if(k.field_type.toLowerCase()=="list"){var f=[],h='<option value="">Select</option>';if(k.field_data){f=k.field_data.split(";")}$.each(f,function(l,m){if(m!=""){h=h.concat('<option value="'+m+'">'+m+"</option>")}});if(k.is_required){c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+' <span class="field_req">*</span></label><div class="controls"><select class="'+k.field_type.toLowerCase()+' custom_field required" id='+k.id+' name="'+k.field_label+'">'+h+"</select></div></div>")}else{c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+'</label><div class="controls"><select class="'+k.field_type.toLowerCase()+' custom_field" id='+k.id+' name="'+k.field_label+'">'+h+"</select></div></div>")}return}else{if(k.field_type.toLowerCase()=="checkbox"){e="checkbox";if(k.scope=="DEAL"){if(k.is_required){c=c.concat('<div class="control-group">	<label class="control-label"><span class="field_req">*</span><input type="'+e+'" class="'+k.field_type.toLowerCase()+'_input custom_field required" id='+k.id+' name="'+k.field_label+'" style="margin: 0px 5px;">'+k.field_label+"</label></div></div>")}else{c=c.concat('<div class="control-group">	<label class="control-label"><input type="'+e+'" class="'+k.field_type.toLowerCase()+'_input custom_field" id='+k.id+' name="'+k.field_label+'" style="margin: 0px 5px;">'+k.field_label+"</label></div>")}return}if(k.is_required){c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+' <span class="field_req">*</span></label><div class="controls"><input type="'+e+'" class="'+k.field_type.toLowerCase()+'_input custom_field required" id='+k.id+' name="'+k.field_label+'"></div></div>')}else{c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+'</label><div class="controls"><input type="'+e+'" class="'+k.field_type.toLowerCase()+'_input custom_field" id='+k.id+' name="'+k.field_label+'"></div></div>')}return}else{if(k.field_type.toLowerCase()=="textarea"){e="textarea";var j=3;if(k.field_data){j=parseInt(k.field_data)}if(k.is_required){c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+' <span class="field_req">*</span></label><div class="controls"><textarea style="max-width:420px;" rows="'+j+'" class="'+k.field_type.toLowerCase()+'_input custom_field required" id='+k.id+' name="'+k.field_label+'"></textarea></div></div>')
}else{c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+'</label><div class="controls"><textarea style="max-width:420px;" rows="'+j+'" class="'+k.field_type.toLowerCase()+'_input custom_field" id='+k.id+' name="'+k.field_label+'"></textarea></div></div>')}return}else{if(k.field_type.toLowerCase()=="number"){e="number";if(k.is_required){c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+' <span class="field_req">*</span></label><div class="controls custom-number-controls"><input type="number" style="max-width:420px;" class="'+k.field_type.toLowerCase()+'_input custom_field required" id="'+k.id+'" name="'+k.field_label+'" value="0"></input></div></div>')}else{c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+'</label><div class="controls custom-number-controls"><input type="number" style="max-width:420px;" class="'+k.field_type.toLowerCase()+'_input custom_field" id="'+k.id+'" name="'+k.field_label+'" value="0"></input></div></div>')}return}else{if(k.field_type.toLowerCase()=="formula"){return}}}}}if(k.is_required){c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+' <span class="field_req">*</span></label><div class="controls"><input type="text" class="'+k.field_type.toLowerCase()+'_input custom_field required" id='+k.id+' name="'+k.field_label+'"></div></div>')}else{c=c.concat('<div class="control-group">	<label class="control-label">'+k.field_label+'</label><div class="controls"><input type="text" class="'+k.field_type.toLowerCase()+'_input custom_field" id='+k.id+' name="'+k.field_label+'"></div></div>')}});return c}function show_custom_fields_helper_for_merge(c,d){var b="";$.each(c,function(k,l){var e=[];for(var h=0;h<d.length;h++){if(h===0){var n=false;e.push('<tr><td style="background-color:#f3f3f3">'+l.field_label+"</td>")}var q=d[h];for(var g=0;g<q.properties.length;g++){var o=q.properties[g];if(o.type=="CUSTOM"&&o.name==l.field_label){var m=o.value;if(m){n=true;if(l.field_type.toLowerCase()=="date"){try{m=new Date(o.value*1000).format("mm/dd/yyyy")}catch(f){}}if(h===0){var p='<td><input type="radio" name="'+l.field_label+'" class="'+l.field_type.toLowerCase()+'" checked="checked" fieldtype="custom" oid="'+q.id+'" id="'+l.id+'" field="'+l.field_label+'" data="'+m+'">'+m+"</td>";e.push(p);break}else{var p='<td><input type="radio" name="'+l.field_label+'" class="'+l.field_type.toLowerCase()+'" fieldtype="custom" oid="'+q.id+'" id="'+l.id+'" field="'+l.field_label+'" data="'+m+'">'+m+"</td>";e.push(p);break}}}else{if(g===q.properties.length-1){var p="<td></td>";e.push(p)}}}if(h===d.length-1){if(n){for(var h=0;h<e.length;h++){b=b.concat(e[h])}b=b.concat("</tr>")}e.length=0}}});return b}function fill_custom_field_values(c,b){console.log(b);$.each(b,function(d,e){if(e.type=="CUSTOM"){fill_custom_data(e,c)}});return $("<div>").append(c).html()}function fill_custom_fields_values_generic(c,b){$.each(b,function(d,e){fill_custom_data(e,c)});return $("<div>").append(c).html()}function fill_custom_data(g,f){if(!g.value){return}var c=$(f).find('*[name="'+g.name+'"]');console.log(c);if(!c[0]){return}console.log($(c[0]).hasClass("date_input"));var b=c[0].tagName.toLowerCase();var d=c.attr("type");console.log(g.value);console.log($(c[0]));if(b=="input"){if(d=="checkbox"&&g.value=="on"){c.attr("checked","checked");return}else{if($(c[0]).hasClass("date_input")){try{c.attr("value",new Date(g.value*1000).format("mm/dd/yyyy"));return}catch(e){}}}c.attr("value",g.value);console.log(c.val())}if(b=="textarea"){c.html(g.value)}if(b=="select"){if(g.value){c.find('option[value="'+g.value.trim()+'"]').attr("selected","selected")}}}function serialize_custom_fields(d){var c=$("#"+d).find(".custom_field");console.log(c.length);var b=[];$.each(c,function(e,g){name=$(g).attr("name");var f={};f.name=name;var h=$(g).attr("type");f.value=$(g).val();if(h=="checkbox"){f.value=$(g).is(":checked")?"on":"off"}if(!f.value){return}b.push(f)});return b}function groupingCustomFields(b){var c="admin-settings-customfields-"+b.get("scope").toLowerCase();if(b.get("scope")=="CONTACT"){App_Admin_Settings.contactCustomFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields/scope/position?scope="+b.get("scope"),sortKey:"position",restKey:"customFieldDefs",templateKey:c,individual_tag_name:"tr",postRenderCallback:function(d){enableCustomFieldsSorting(d,"custom-fields-"+b.get("scope").toLowerCase()+"-tbody","admin-settings-customfields-"+b.get("scope").toLowerCase()+"-model-list")}});App_Admin_Settings.contactCustomFieldsListView.collection.fetch();$("#customfields-contacts-accordion",this.el).append($(App_Admin_Settings.contactCustomFieldsListView.render().el))}else{if(b.get("scope")=="COMPANY"){App_Admin_Settings.companyCustomFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields/scope/position?scope="+b.get("scope"),sortKey:"position",restKey:"customFieldDefs",templateKey:c,individual_tag_name:"tr",postRenderCallback:function(d){enableCustomFieldsSorting(d,"custom-fields-"+b.get("scope").toLowerCase()+"-tbody","admin-settings-customfields-"+b.get("scope").toLowerCase()+"-model-list")}});App_Admin_Settings.companyCustomFieldsListView.collection.fetch();$("#customfields-companies-accordion",this.el).append($(App_Admin_Settings.companyCustomFieldsListView.render().el))}else{if(b.get("scope")=="DEAL"){App_Admin_Settings.dealCustomFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields/scope/position?scope="+b.get("scope"),sortKey:"position",restKey:"customFieldDefs",templateKey:c,individual_tag_name:"tr",postRenderCallback:function(d){enableCustomFieldsSorting(d,"custom-fields-"+b.get("scope").toLowerCase()+"-tbody","admin-settings-customfields-"+b.get("scope").toLowerCase()+"-model-list")}});App_Admin_Settings.dealCustomFieldsListView.collection.fetch();$("#customfields-deals-accordion",this.el).append($(App_Admin_Settings.dealCustomFieldsListView.render().el))}else{if(b.get("scope")=="CASE"){App_Admin_Settings.caseCustomFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields/scope/position?scope="+b.get("scope"),sortKey:"position",restKey:"customFieldDefs",templateKey:c,individual_tag_name:"tr",postRenderCallback:function(d){enableCustomFieldsSorting(d,"custom-fields-"+b.get("scope").toLowerCase()+"-tbody","admin-settings-customfields-"+b.get("scope").toLowerCase()+"-model-list")}});App_Admin_Settings.caseCustomFieldsListView.collection.fetch();$("#customfields-cases-accordion",this.el).append($(App_Admin_Settings.caseCustomFieldsListView.render().el))}}}}}function enableCustomFieldsSorting(b,c,d){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$("."+c).sortable({axis:"y",containment:"."+c,scroll:false,items:"tr",helper:function(h,f){var g=f.children();var j=f.clone();j.children().each(function(e){$(this).width(g.eq(e).width());$(this).css("background","#f5f5f5");$(this).css("border-bottom","1px solid #ddd")});return j},forceHelperSize:true,placeholder:"<tr><td></td></tr>",forcePlaceholderSize:true,handle:".icon-move",cursor:"move",tolerance:"intersect"});$("."+c,b).on("sortstop",function(e,f){var g=[];$("#"+d+" > tr").each(function(h){var j=$(this).data().id;g.push({id:j,position:h+1})});$.ajax({type:"POST",url:"/core/api/custom-fields/positions",data:JSON.stringify(g),contentType:"application/json; charset=utf-8",dataType:"json"})})})}function show_map(e){var b=App_Contacts.contactDetailView.model.toJSON();var c=getPropertyValue(b.properties,"address");if(!c){return}try{c=JSON.parse(c)}catch(f){return}if(!c.address&&!c.city&&!c.state&&!c.country){return}var d=localStorage.getItem("MAP_VIEW");if(d=="disabled"){$("#map_view_action").html("<i class='icon-plus text-xxs c-p' title='Show map' id='enable_map_view'></i>");return}try{if(google.maps){display_google_map()}}catch(f){load_gmap_script()}}function load_gmap_script(){var b=document.createElement("script");b.type="text/javascript";b.src="https://maps.googleapis.com/maps/api/js?&sensor=false&callback=display_google_map";document.body.appendChild(b)}function display_google_map(){var b=App_Contacts.contactDetailView.model.toJSON();var c=JSON.parse(getPropertyValue(b.properties,"address"));var d=new google.maps.Geocoder();if(!c.address){c.address=""}if(!c.city){c.city=""}if(!c.state){c.state=""}if(!c.country){c.country=""}if(!c.zip){c.zip=""}d.geocode({address:'"'+c.city+", "+c.state+", "+getNormalCountryNameFromShortName(c.country)+", "+c.zip+'"'},function(h,g){if(g==google.maps.GeocoderStatus.OK){console.log(h);displayTimeZone(h);$("#map").css("display","block");var f={zoom:4,center:h[0].geometry.location,mapTypeId:google.maps.MapTypeId.ROADMAP};var j=new google.maps.Map(document.getElementById("map"),f);var e=new google.maps.Marker({map:j,position:h[0].geometry.location})}})}function getNormalCountryNameFromShortName(c){if(!c){return}var b={AF:"Afghanistan",AX:"Aland Islands",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AQ:"Antarctica",AG:"Antigua And Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia And Herzegovina",BW:"Botswana",BV:"Bouvet Island",BR:"Brazil",IO:"British Indian Ocean Territory",BN:"Brunei Darussalam",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CX:"Christmas Island",CC:"Cocos (Keeling) Islands",CO:"Colombia",KM:"Comoros",CG:"Congo",CD:"Congo, Democratic Republic",CK:"Cook Islands",CR:"Costa Rica",CI:'Cote D"Ivoire',HR:"Croatia",CU:"Cuba",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands (Malvinas)",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",TF:"French Southern Territories",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GH:"Ghana",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GU:"Guam",GT:"Guatemala",GG:"Guernsey",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HM:"Heard Island & Mcdonald Islands",VA:"Holy See (Vatican City State)",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran, Islamic Republic Of",IQ:"Iraq",IE:"Ireland",IM:"Isle Of Man",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JE:"Jersey",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KR:"Korea",KW:"Kuwait",KG:"Kyrgyzstan",LA:'Lao People"s Democratic Republic',LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libyan Arab Jamahiriya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macao",MK:"Macedonia",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia, Federated States Of",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",MP:"Northern Mariana Islands",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PS:"Palestinian Territory, Occupied",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RE:"Reunion",RO:"Romania",RU:"Russian Federation",RW:"Rwanda",BL:"Saint Barthelemy",SH:"Saint Helena",KN:"Saint Kitts And Nevis",LC:"Saint Lucia",MF:"Saint Martin",PM:"Saint Pierre And Miquelon",VC:"Saint Vincent And Grenadines",WS:"Samoa",SM:"San Marino",ST:"Sao Tome And Principe",SA:"Saudi Arabia",SN:"Senegal",RS:"Serbia",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",GS:"South Georgia And Sandwich Isl.",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SJ:"Svalbard And Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syrian Arab Republic",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",TL:"Timor-Leste",TG:"Togo",TK:"Tokelau",TO:"Tonga",TT:"Trinidad And Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks And Caicos Islands",TV:"Tuvalu",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UM:"United States Outlying Islands",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VE:"Venezuela",VN:"Viet Nam",VG:"Virgin Islands, British",VI:"Virgin Islands, U.S.",WF:"Wallis And Futuna",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"};
c=c.trim();if(b[c]){return b[c]}return c}var notification_prefs;function downloadAndRegisterForNotifications(){var b=getDueTasksCount();if(b==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}$("#due_tasks_count").html(b);var d=Backbone.Model.extend({url:"core/api/notifications"});var c=new d();c.fetch({success:function(e){notification_prefs=e.toJSON();console.log(notification_prefs);getDomainFromCurrentUser()}})}function getDomainFromCurrentUser(){var b=CURRENT_DOMAIN_USER.domain;subscribeToPubNub(b,function(c){_setupNotification(c)})}function subscribeToPubNub(b){var c="https";load_urls_on_ajax_stop(c+"://pubnub.a.ssl.fastly.net/pubnub-3.4.min.js",function(){var d=PUBNUB.init({publish_key:"pub-c-e4c8fdc2-40b1-443d-8bb0-2a9c8facd274",subscribe_key:"sub-c-118f8482-92c3-11e2-9b69-12313f022c90",ssl:true,origin:"pubsub.pubnub.com"});d.ready();d.subscribe({channel:b,callback:function(g){console.log(g);if(g.type=="LOGIN_INSTANCE"){check_login_instance(g);return}if(g.type=="BULK_ACTIONS"){bulkActivitiesNoty("information",g);return}if(g.type=="EVENT_REMINDER"){if(CURRENT_DOMAIN_USER.email==g.useremail){var e=getTemplate("event-notification",g);showNoty("information",e,"bottomRight","EVENT_REMINDER",undefined,3000000);return}}if(g.type=="CALL"){var e=getTemplate("call-notification",g);showNoty("information",e,"bottomRight","CALL");return}if(g.type=="UNKNOWN_CALL"){var e=getTemplate("unknown-call-notification",g);showNoty("information",e,"bottomRight","UNKNOWN_CALL");return}if(g.notification=="CAMPAIGN_NOTIFY"){var f=JSON.parse(g.custom_value);if(f.owner_id=="ALL"){showNoty("information",getTemplate("campaign-notify",g),"bottomRight","CAMPAIGN_NOTIFY")}if(f.owner_id==CURRENT_DOMAIN_USER.id){showNoty("information",getTemplate("campaign-notify",g),"bottomRight","CAMPAIGN_NOTIFY")}return}_setupNotification(g)},connect:function(){console.log("connected");publishLoginEvent(d)}})})}function _setupNotification(b){if(b.notification=="CONTACT_DELETED"){b.id=""}var c=getTemplate("notify-html",b);notification_for_email_and_browsing(b,c);if("current_user_name" in b){if(notification_prefs.prefs.currentDomainUserName==b.current_user_name){return}}notification_for_contact_and_deal(b,c)}function notification_for_email_and_browsing(b,c){if(b.notification=="CLICKED_LINK"||b.notification=="OPENED_EMAIL"||b.notification=="IS_BROWSING"){var d=get_option(b.notification);notification_based_on_type_of_contact(d,b,c,b.notification);return}}function notification_for_contact_and_deal(b,c){$.each(notification_prefs,function(e,f){if(e==b.notification.toLowerCase()){if(notification_prefs[e]){if((b.notification=="CONTACT_ADDED"||b.notification=="CONTACT_DELETED")&&b.type=="COMPANY"){var d=b.notification.replace("CONTACT","COMPANY");b.notification=d}showNoty("information",c,"bottomRight",b.notification)}}})}function is_assigned(b){var c=notification_prefs.prefs.currentDomainUserName;var d=b.owner_name;if(c==d){return true}return false}function is_assigned_and_starred(b){if(is_assigned(b)&&b.star_value>0){return true}return false}function get_option(b){switch(b){case"CLICKED_LINK":return notification_prefs.link_clicked;case"OPENED_EMAIL":return notification_prefs.email_opened;case"IS_BROWSING":return notification_prefs.browsing}}function notification_based_on_type_of_contact(d,b,e,c){switch(d){case"CONTACT_ASSIGNED":if(is_assigned(b)){showNoty("information",e,"bottomRight",c)}break;case"CONTACT_ASSIGNED_AND_STARRED":if(is_assigned_and_starred(b)){showNoty("information",e,"bottomRight",c)}break;case"ANY_CONTACT":showNoty("information",e,"bottomRight",c);break}}function check_browser_notification_settings(b){if(notify&&!notify.isSupported){$("#set-desktop-notification").css("display","none")}if(notify&&notify.isSupported&&notify.permissionLevel()==notify.PERMISSION_GRANTED){$("#set-desktop-notification").css("display","none");$("#desktop-notification-content").html('<i>Desktop Notifications are now enabled. <a href="#" id="disable-notification" style="text-decoration:underline;">Disable</a></i>')}if(notify&&notify.isSupported&&notify.permissionLevel()==notify.PERMISSION_DENIED){$("#set-desktop-notification").css("display","none");$("#desktop-notification-content").html('<i>Desktop Notifications are now disabled. <a href="#" id="enable-notification" style="text-decoration:underline;">Enable</a></i>')}$("#enable-notification",b).die().live("click",function(c){c.preventDefault();$("#notification-enable-help-modal").modal("show")});$("#disable-notification",b).die().live("click",function(c){c.preventDefault();$("#notification-disable-help-modal").modal("show")})}function showSwitchChanges(b){$("#notification-switch",b).die().live("switch-change",function(){var c=$("#notification-switch").bootstrapSwitch("status");if(c){$(b).find("input[type=checkbox]").not("#control_notifications,#notification_sound").removeAttr("disabled");$(b).find("select").not("#control_notifications").removeAttr("disabled")}else{$(b).find("input[type=checkbox]").not("#control_notifications").attr("disabled","disabled");$(b).find("select").not("#control_notifications, #notification_sound").attr("disabled","disabled")}})}function showNoty(e,f,b,d,c,g){if(!g){g=30000}if(d!="EVENT_REMINDER"){if(d!="CAMPAIGN_NOTIFY"&&!notification_prefs.control_notifications){return}}if(notify&&notify.isSupported&&notify.permissionLevel()==notify.PERMISSION_GRANTED){if(d=="CALL"){show_desktop_notification($("span:eq(0)",f).attr("id"),$(f).find("#calling-contact-id").text(),$(f).find("#call-notification-text").text(),$(f).find("#calling-contact-id").attr("href"),$(f).find("#calling-contact-id").attr("href").split("/")[1]+"-CALL");return}if(d=="UNKNOWN_CALL"){show_desktop_notification($("span:eq(0)",f).attr("id"),$(f).find("#unknown-contact-name").text(),$(f).find("#unknown-call-notification-text").text(),$(f).find("#unknown-contact-name").attr("href"),$(f).find("#unknown-contact-name").attr("href").split("/")[2]+"-UNKNOWN_CALL");return}if(d=="CAMPAIGN_NOTIFY"){show_desktop_notification($("span:eq(0)",f).attr("id"),$(f).find("#campaign-contact-id").text(),$(f).find("#campaign-notify-text").text(),$(f).find("#campaign-contact-id").attr("href"),$(f).find("#campaign-contact-id").attr("href").split("/")[1]+"-CAMPAIGN_NOTIFY");return}if(d=="EVENT_REMINDER"){show_desktop_notification(getImageUrl(f,d),getNotificationType(d),getTextMessage(f),getId(f),getId(f).split("/")[1]+"-"+d,3000000);return}show_desktop_notification(getImageUrl(f,d),getNotificationType(d),getTextMessage(f),getId(f),getId(f).split("/")[1]+"-"+d);return}head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottomRight.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/themes/default.js",function(){var h=noty({text:f,layout:b,type:e,timeout:g,closeCallback:(c&&typeof c=="function")?c:undefined,callback:{onClose:function(){console.log(this);if(this.options.closeCallback&&typeof this.options.closeCallback=="function"){this.options.closeCallback()}}}});console.log(h);if(h.options.type=="information"){if(notification_prefs.notification_sound!="no_sound"){play_sound(notification_prefs.notification_sound)}}$(".noty_bar").die().live("click",function(){if(h.options.type=="information"){var j=$(this).find("a").attr("href");if(j){Backbone.history.navigate(j,{trigger:true})}}})})}function getTextMessage(d){var b;var c=$(d).find("#notification-type").text();if($(d).find("#notification-contact-id").text()!=""){b=$(d).find("#notification-contact-id").text();return b+" "+c}if($(d).find("#noty_text").text()!=""){b=$(d).find("#noty_text").text();return b}b=$(d).find("#notification-deal-id").text();return b+" "+c}function getNotificationType(b){if(b=="CONTACT_ADDED"||b=="COMPANY_ADDED"||b=="TAG_ADDED"||b=="DEAL_CREATED"){return"New "+ucfirst(b.split("_")[0])}if(b=="IS_BROWSING"){return ucfirst(b.split("_")[1])}return ucfirst(b.split("_")[0])+" "+ucfirst(b.split("_")[1])}function getId(b){if(($(b).find("#noty_text").text()!="")){return $(b).find("#noty_text").text()}if($(b).find("#notification-contact-id").text()!=""){return $(b).find("#notification-contact-id").attr("href")}return $(b).find("#notification-deal-id").attr("href")}function getImageUrl(c,b){if(b=="EVENT_REMINDER"){return"/img/eventreminder.png"}if($(c).find("#notification-contact-id").text()!=""){if(b==="COMPANY_ADDED"||b==="COMPANY_DELETED"){return $("span:eq(1)",c).attr("id")}return $("span:eq(0)",c).attr("id")}return"/img/deal.png"}function notification_play_button(){$("#notification-sound-play").live("click",function(c){c.preventDefault();var b=$("#notificationsForm #notification_sound").find(":selected").val();if(b=="no_sound"){return}play_sound(b)})}$(function(){request_notification_permission()});function show_desktop_notification(c,g,e,d,b,f){if(!f){f=30000}head.js(LIB_PATH+"lib/desktop-notify-min.js",function(){var h=notify.createNotification(g,{body:e,icon:c,tag:b,onClickCallback:function(){window.focus();Backbone.history.navigate(d,{trigger:true});h.close()}});setTimeout(function(){h.close()},f);if(!window.closed){if(notification_prefs.notification_sound!="no_sound"){play_sound(notification_prefs.notification_sound)}}})}function request_notification_permission(){head.js(LIB_PATH+"lib/desktop-notify-min.js",function(){if(notify.permissionLevel()==notify.PERMISSION_DEFAULT){$("#set-desktop-notification").live("click",function(){notify.requestPermission(function(){if(notify.permissionLevel()==notify.PERMISSION_GRANTED){$("#set-desktop-notification").css("display","none");$("#desktop-notification-content").html('<i>Desktop Notifications are now enabled. <a href="#" id="disable-notification" style="text-decoration:underline;">Disable</a></i>')}else{$("#set-desktop-notification").css("display","none");$("#desktop-notification-content").html('<i>Desktop Notifications are now disabled. <a href="#" id="enable-notification" style="text-decoration:underline;">Enable</a></i>')}})})}})}function removeWaiting(){var b=Streams_List_View.collection.toJSON();
if(b==null){return}$.each(b,function(d,e){var c=Streams_List_View.collection.get(e.id);if(c!=null||c!=undefined){if(c.get("tweetListView").length>=1){$("#stream-spinner-modal-"+e.id).hide()}}})}function fillStreamDetail(){Network_Type=null;Stream_Type=null;$("#twitter_account",$("#addStreamModal")).attr("value","");$("#stream_type",$("#addStreamModal")).attr("value","");$(".remove-keyword").remove();$("#domain_user_id",$("#addStreamModal")).attr("value",CURRENT_DOMAIN_USER.id);$("#client_channel",$("#addStreamModal")).attr("value",CURRENT_DOMAIN_USER.id+"_Channel");$("#add_twitter_stream").hide();document.getElementById("stream_description_label").className="description-hidden txt-mute";$("#twitter_profile_img_url").attr("src","")}function registerAll(c){var d=Streams_List_View.collection.toJSON();if(d==null||Register_All_Done==true||Pubnub==null||(Register_Counter!=null&&c==0)){console.log("Register_All_Done : "+Register_All_Done);return}var e=Streams_List_View.collection.at(c);if(e==null||e==undefined){return}if(c==0&&Register_Counter==null){Register_Counter=0;if(Add_Img_Done==false){addUserImgToColumn()}}var b={message_type:"register",stream:e};sendMessage(b);if(Register_Counter==(Streams_List_View.collection.length-1)){Register_All_Done=true}}function unregisterAll(){if(!Streams_List_View){return}if(Streams_List_View==undefined||Pubnub==null){return}var b={message_type:"unregister_all",client_channel:CURRENT_DOMAIN_USER.id+"_Channel"};sendMessage(b);Register_All_Done=false;Register_Counter=null;Add_Img_Done=false;Streams_List_View=undefined}function addUserImgToColumn(){var b=Streams_List_View.collection.toJSON();$.each(b,function(d,e){var c=Streams_List_View.collection.get(e.id);$.get("/core/social/getprofileimg/"+e.id,function(f){c.set("profile_img_url",f);socialsuitecall.streams(c)})});Add_Img_Done=true}function registerStreamAgain(c){var d=Streams_List_View.collection.get(c).toJSON();var b={message_type:"register",stream:d};sendMessage(b);$("#stream-spinner-modal-"+c).show()}function displayTimeAgo(b){head.js("lib/jquery.timeago.js",function(){$(".time-ago",b).timeago()})}function isNewUnreadTweet(c){var b=null;if(c.id=="000"||c.type=="ACK"){console.log("got 000")}else{c.isNew="true"}b=Streams_List_View.collection.get(c.stream_id);rebuildTweet(b,c)}function rebuildTweet(b,d){$("#stream-spinner-modal-"+d.stream_id).hide();if(d.text=="There is no tweets to show here."||d.text=="Dear you do not have any tweets."){d.msg_type="NoTweet";d.show=true;d.text="No Tweets to show here."}else{if(d.type=="ACK"){d.msg_type="ACK";d.text="ACK"}else{if(d.text==null||d.user==null){return}d.msg_type="Tweet";if(b.get("tweetListView").length==2){clearNoTweetNotification(b)}if(b.get("screen_name")!=d.user.screen_name){d.tweetowner_not_streamuser=true}if(d.stream_type=="Sent"||b.get("screen_name")==d.user.screen_name){d.deletable_tweet=true}if(d.stream_type=="DM_Inbox"||d.stream_type=="DM_Outbox"){d.direct_message=true;d.deletable_tweet=true}var c=b.get("screen_name")+" retweeted";if(d.retweeted==c){d.retweeted_by_user=true}d.original_text=d.text;d.text=convertTextToTweet(d)}}if(Scroll_Down_Call==true){checkPastTweetAdd(d,b);return}if(d.type=="ACK"){Register_Counter++;registerAll(Register_Counter)}addTweetToStream(d,b)}function addTweetToStream(c,b){b.get("tweetListView").comparator=function(d){if(d.get("id")){return -d.get("id")}};b.get("tweetListView").add(c);b.get("tweetListView").sort();displayTimeAgo($(".chirp-container"))}function mergeNewUnreadTweets(c){var d=Streams_List_View.collection.get(c);var b=d.get("tweetListView").where({isNew:"true"});$.each(b,function(f,e){e.unset("isNew")});displayTimeAgo($(".chirp-container"));removeWaiting()}function handleMessage(c){if(c["delete"]!=null){return}if(c.id=="001"){displayErrorInStream(c);return}var b=Streams_List_View.collection.get(c.stream_id);if(b!=undefined){if(Current_Route=="social"&&Focused==true){if($("#stream_notifications_"+c.stream_id).is(":empty")==false){isNewUnreadTweet(c);showNotification(b)}else{rebuildTweet(b,c)}}else{isNewUnreadTweet(c);if(Current_Route=="social"){showNotification(b)}}}$(".deleted").remove()}function convertTextToTweet(j){var e=new Array();var g=j.text;var f=new RegExp();var b;f=new RegExp("&amp;","g");g=g.replace(f,"&");e=g.split(/[\s,?&;.'":!)({}]+/);e=_.uniq(e);for(var d=0;d<e.length;d++){if(e[d].charAt(0)=="@"){f=new RegExp(e[d],"g");g=g.replace(f,"&lt;a href='https://twitter.com/"+e[d].substring(1)+"' target='_blank' class='cd_hyperlink'>"+e[d]+"&lt;/a>")}else{if(e[d].charAt(0)=="#"){f=new RegExp(e[d],"g");var c="https://twitter.com/search?q=%23"+e[d].substring(1)+"&src=hash";g=g.replace(f,"&lt;a href='"+c+"' target='_blank' class='cd_hyperlink'>"+e[d]+"&lt;/a>")}}}e=new Array();e=g.split(/\s/);var h="^(https?|ftp|file)://[-a-zA-Z0-9+&@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&@#/%=~_|]";$.each(e,function(k,l){if(l.match(h)){g=g.replace(l,"&lt;a href='"+l+"' target='_blank' class='cd_hyperlink'>"+l+"&lt;/a>")}});f=new RegExp("&lt;","g");g=g.replace(f,"<");return g}function isTimeInPast(){var j=document.getElementById("scheduled_date").value;var h=document.getElementById("scheduled_time").value;var l=new Date().format("mm/dd/yyyy");var b=new Date();var g=(b.getMinutes()<10?"0":"")+b.getMinutes();b=b.getHours()+":"+g;var c=(h).split(":");var d=new Date(j);var m=d.setHours(c[0],c[1])/1000;var n=(b).split(":");var f=new Date(l);var e=f.setHours(n[0],n[1])/1000;if(m>e){var c=(h).split(":");var d=new Date(j);d=d.setHours(c[0],c[1])/1000;document.getElementById("schedule").value=d;var k=new Date(d*1000);$("#send_tweet").removeAttr("disabled");Schedule_In_Future=true;$("#twit-tweet").keypress()}else{alert("Please select Date/Time in future.");$("#send_tweet").attr("disabled","disable");Schedule_In_Future=false}}function checkScheduledUpdates(){$.getJSON("/core/scheduledupdate/getscheduledupdatescount",function(b){if(b>0){$("#show_scheduled_updates").show()}}).error(function(b,d,c){$("#show_scheduled_updates").hide();console.log("Error occured in scheduled updates search.")})}function scheduledmessagesEdit(c){$("#socialsuite_twitter_messageModal").remove();var b=Scheduled_Updates_View.collection.get(c);Scheduled_Edit=true;Message_Model=new Base_Model_View({url:"/core/scheduledupdate",model:b,template:"socialsuite-twitter-message",modal:"#socialsuite_twitter_messageModal",window:"scheduledmessages",postRenderCallback:function(d){$(".modal-backdrop").remove();if(!b.hasChanged()){$("#socialsuite_twitter_messageModal",d).on("shown",function(){$("#tweet_scheduling",d).click();$("input.date",$("#schedule_controls")).val((new Date(b.toJSON().scheduled_date*1000)).toLocaleDateString());$("#send_tweet").removeAttr("disabled")});$("#socialsuite_twitter_messageModal",d).modal("show")}},saveCallback:function(d){$("#socialsuite_twitter_messageModal").modal("hide");$("#socialsuite_twitter_messageModal").remove();$(".modal-backdrop").remove();Scheduled_Edit=false;d.checkbox=true;b.set(d);displayTimeAgo($(".is-actionable"))}});$("#schedule-edit-modal").html(Message_Model.render().el)}$(function(){Stream_Type=null;Network_Type=null;Register_All_Done=false;Tweet_Owner_For_Add_Contact=null;Focused=true;Scheduled_Edit=false;Register_Counter=null;Add_Img_Done=false;Previous_URL=null;Schedule_In_Future=false;Scroll_Down_Call=false;Past_Tweets_Count=0});window.onfocus=function(){Focused=true};window.onblur=function(){Focused=false};window.onbeforeunload=unregisterAll;function initializeSocialSuite(){$(window).unload(function(){unregisterAll()});$("a").click(function(b){var c=$(this).attr("href");if(c=="/login"){unregisterAll()}});$(".add-stream").die().live("click",function(b){head.js("js/designer/ui.js",function(){});$("#streamDetail").each(function(){this.reset()});fillStreamDetail();$("#streamDetails").html(getTemplate("socialsuite-social-network"),{});$("#addStreamModal").modal("show")});$(".network-type").die().live("click",function(b){if(this.id=="twitter_option"){openTwitter();Network_Type="TWITTER"}$("#network_type",$("#addStreamModal")).attr("value",Network_Type)});$(".stream-type").die().live("click",function(b){b.preventDefault();if(this.className=="stream-type stream-type-button-color"){$(".remove-keyword").remove();$(".stream-type").removeClass("stream-type-button-color");this.className="stream-type";Stream_Type=null;$("#stream_type",$("#addStreamModal")).attr("value","")}else{$(".stream-type").removeClass("stream-type-button-color");this.className="stream-type stream-type-button-color";Stream_Type=$(this).attr("value").trim();$("#stream_type",$("#addStreamModal")).attr("value",Stream_Type);if(Stream_Type=="Search"){document.getElementById("search_stream_keyword").innerHTML='<div class="remove-keyword"><input id="keyword" name="keyword" type="text" class="required" required="required" autocapitalize="off" placeholder="Search Keyword..." value=""></div>'}else{$(".remove-keyword").remove()}}$(this).css("background-color","")});$(document).on("mouseover",".stream-type",function(c){document.getElementById("stream_description_label").className="txt-mute";mouseoverStream=$(this).attr("value");var b=$(this).css("background-color");if(b!="rgb(187, 187, 187)"){$(this).css("background-color","#EDEDED")}switch(mouseoverStream){case"Search":document.getElementById("stream_description_label").innerHTML='<i class="icon-search"></i> Relevant Tweets matching a specified Search Keyword.';break;case"Home":document.getElementById("stream_description_label").innerHTML='<i class="icon-home"></i> Tweets and retweets of user and followers.';break;case"Mentions":document.getElementById("stream_description_label").innerHTML='<img src="../img/socialsuite/mentions.png" style="width: 15px;height: 15px;"> Mentions (all tweets containing a users\'s @screen_name).';break;case"Retweets":document.getElementById("stream_description_label").innerHTML='<i class="icon-retweet"></i> User\'s tweets retweeted by others.';break;case"DM_Inbox":document.getElementById("stream_description_label").innerHTML='<i class="icon-download-alt"></i> Direct messages sent to the user.';
break;case"DM_Outbox":document.getElementById("stream_description_label").innerHTML='<i class="icon-upload-alt"></i> Direct messages sent by the user.';break;case"Favorites":document.getElementById("stream_description_label").innerHTML='<i class="icon-star"></i> User\'s favorite tweets.';break;case"Sent":document.getElementById("stream_description_label").innerHTML='<i class="icon-share-alt"></i> Tweets sent by the user.';break;case"Scheduled":document.getElementById("stream_description_label").innerHTML='<i class="icon-time"></i> Tweets scheduled for sending later.';break;case"All_Updates":document.getElementById("stream_description_label").innerHTML='<i class="icon-home"></i> Updates and shares from user\'s connections and groups.';break;case"My_Updates":document.getElementById("stream_description_label").innerHTML='<i class="icon-share-alt"></i> Updates authored by the user.';break}});$(document).on("mouseout",".stream-type",function(b){$(this).css("background-color","");document.getElementById("stream_description_label").className="description-hidden txt-mute"});$(".save-twitter-stream").die().live("click",function(d){if($("#addStreamModal").find("#add_twitter_stream").attr("disabled")){return}if($("#twitter_account").val()==null||$("#twitter_account").val()==""){alert("You have to give access to your social account.");$("#add-stream").click();return}if(Stream_Type==null||Stream_Type==""){document.getElementById("stream_description_label").className="txt-mute";document.getElementById("stream_description_label").innerHTML='<span style="color: red;"><i class="icon-exclamation"></i> You have to select your favorite stream type.</span>';return}if(!isValidForm("#streamDetail")){$("#streamDetail").find("input").focus();return false}$("#addStreamModal").find("#add_twitter_stream").attr("disabled","disabled");showNotyPopUp("information","Adding Stream...","top",2500);var c=jQuery(streamDetail).serializeArray();var b={};jQuery.each(c,function(){b[this.name]=this.value||""});b.column_index=Streams_List_View.collection.length+1;var f=new Backbone.Model();f.url="/core/social";f.save(b,{success:function(g){socialsuitecall.streams(g);$("html, body").animate({scrollTop:$(document).height()-$(window).height()});var e={message_type:"register",stream:g.toJSON()};sendMessage(e);showNotyPopUp("information","Stream added. You can add another Stream now.","top",4000);setTimeout(function(){var h=$("#addStreamModal").find("div[value='"+Stream_Type+"']").attr("id");$("#"+h).click();$("#addStreamModal").find("#add_twitter_stream").removeAttr("disabled");Stream_Type=""},4000);addTagAgile(SOCIAL_TAG)},error:function(e){console.log(e)}})});$(".stream-delete").die().live("click",function(c){if(!confirm("Are you sure you want to delete?")){return}var f=$(this).attr("id");var d=Streams_List_View.collection.get(f).toJSON();delete d.tweetListView;var b={message_type:"unregister",stream:d};sendMessage(b);Streams_List_View.collection.get(f).destroy()});$(".action-notify").die().live("click",function(d){var b=$(this).attr("rel");var c=$(this).attr("data");document.getElementById(this.id).innerHTML="";if(b=="add-new-tweet"){mergeNewUnreadTweets(c)}else{if(b=="retry"){registerStreamAgain(c)}}$(this).attr("rel","");$(".deleted").remove()})}function OnScrollDiv(elementDiv){if(($(elementDiv).scrollTop()+$(elementDiv).innerHeight()>=$(elementDiv)[0].scrollHeight)&&($(elementDiv).attr("data")=="0")){$(elementDiv).attr("data","1");var streamId=($(elementDiv).closest("li").attr("id"));var modelStream=Streams_List_View.collection.get(streamId);if(modelStream==undefined||modelStream==null){return}var stream=modelStream.toJSON();var modelTweet=modelStream.get("tweetListView").at(modelStream.get("tweetListView").length-2);var tweet=modelTweet.toJSON();var currMsg=$("#"+tweet.id);var curOffset=currMsg.offset().top-$(elementDiv).scrollTop();$(elementDiv).append('<span id="stream-waiting-modal-'+streamId+'" class="span6" style="margin-top: 3px;"><img class="pull-right" style="width:20px;height:20px;" src="img/ajax-spinner.gif"></span>');$.getJSON("/core/social/pasttweets/"+stream.id+"/"+tweet.id+"/"+tweet.id_str,function(data){if(data==null){showNotyPopUp("information","No more updates available for stream "+stream.stream_type+" of "+stream.screen_name,"top",5000);$("#stream-waiting-modal-"+streamId).remove();$(elementDiv).attr("data","1");$(elementDiv).append('<span id="past-tweet-end-'+streamId+'" class="span6" style="margin-top: 3px;color: #888;"><i class="pull-right icon icon-long-arrow-up"></i><i class="pull-right icon icon-twitter"></i></span>');return}if(data.length==0){showNotyPopUp("information","No more updates available for stream "+stream.stream_type+" of "+stream.screen_name,"top",5000);$("#stream-waiting-modal-"+streamId).remove();$(elementDiv).attr("data","1");$(elementDiv).append('<span id="past-tweet-end-'+streamId+'" class="span6" style="margin-top: 3px;color: #888;"><i class="pull-right icon icon-long-arrow-up"></i><i class="pull-right icon icon-twitter"></i></span>');return}var i;var myObject;Scroll_Down_Call=true;for(i=0;i<data.length;i++){myObject=eval("("+data[i]+")");handleMessage(myObject);if(i+1==data.length){Scroll_Down_Call=false}}if(Scroll_Down_Call==false&&Past_Tweets_Count!=0&&Past_Tweets.length!=0){addPastTweetsToStream(modelStream)}var scrollOnDiv=$("#"+streamId).find("#Column-model-list");scrollOnDiv.scrollTop((currMsg.offset().top-curOffset)+650);$("#stream-waiting-modal-"+streamId).remove();$(elementDiv).attr("data","0")}).error(function(data){$("#stream-waiting-modal-"+streamId).remove();$(elementDiv).attr("data","0");var result=data.responseText;if(data.responseText==""){showNotyPopUp("information","No more updates available for stream "+stream.stream_type+" of "+stream.screen_name,"top",7000)}else{if(result.indexOf("rate")!=-1){showNotyPopUp("information","Request rate limit exceeded, Retry after some time.","top",5000)}else{if(result.indexOf("Could not fetch URL")!=-1){showNotyPopUp("information","Please, check your internet connection.","top",5000)}else{showNotyPopUp("information",data.responseText,"top",5000)}}}})}$(".deleted").remove()}function checkPastTweetAdd(c,b){if(Past_Tweets_Count<5){Past_Tweets[Past_Tweets_Count]=c;Past_Tweets_Count++}else{if(Past_Tweets_Count==5){addPastTweetsToStream(b)}}}function addPastTweetsToStream(b){if(Past_Tweets.length==0){return}addTweetToStream(Past_Tweets,b);Past_Tweets_Count=0;Past_Tweets=[]}$(function(){$("#tweet_scheduling").die().live("click",function(b){if($("#schedule_controls").css("display")=="block"&&Scheduled_Edit){return}$("#schedule_controls").toggle();if($("#schedule_controls").css("display")=="block"){document.getElementById("send_tweet").innerHTML="Schedule";$("#send_tweet").attr("disabled","disable");this.className="tweet-scheduling tweet-scheduling-active";$("input.date").val(new Date().format("mm/dd/yyyy"));$("#scheduled_date").datepicker({startDate:"today",autoclose:true,todayHighlight:true,format:"mm/dd/yyyy"}).on("changeDate",function(c){console.log(new Date(c.date));isTimeInPast()});$("#scheduled_time").timepicker({template:"modal",showMeridian:false,defaultTime:"current"}).on("changeTime.timepicker",function(c){console.log(c.time.value);isTimeInPast()});Previous_URL=Message_Model.model.url;Message_Model.model.url="/core/scheduledupdate"}else{if(Scheduled_Edit){return}this.className="tweet-scheduling";$("#scheduled_time").attr("value","");Message_Model.model.url=Previous_URL;document.getElementById("send_tweet").innerHTML="Send";$("#send_tweet").removeAttr("disabled");Schedule_In_Future=false;$("#twit-tweet").keypress()}});$(".edit-scheduled-update").die().live("click",function(){var b=$(this).closest("tr").find(".data").attr("data");scheduledmessagesEdit(b)})});function showNotification(c){if(c){updateNotification(c)}else{var b=Streams_List_View.collection.toJSON();if(b==null){return}$.each(b,function(d,e){updateNotification(e)})}$(".deleted").remove()}function updateNotification(d){var b=Streams_List_View.collection.get(d.id);var c=b.get("tweetListView").where({isNew:"true"});if(c.length==0&&b.get("tweetListView").length>=1){clearNoTweetNotification(Streams_List_View.collection.get(d.id));return}else{if(c.length==1){document.getElementById("stream_notifications_"+d.id).innerHTML="<p>"+c.length+" new Tweet </p>"}else{if(c.length>1){document.getElementById("stream_notifications_"+d.id).innerHTML="<p>"+c.length+" new Tweets </p>"}}}$("#stream_notifications_"+d.id).attr("rel","add-new-tweet")}function clearNoTweetNotification(b){var c=b.get("tweetListView").get("000");if(c!=null||c!=undefined){c.set("show",false);b.get("tweetListView").add(c)}}function displayErrorInStream(c){var d=null;if(c.id=="001"){d=c.stream_id}else{d=c.id}$("#stream-spinner-modal-"+d).hide();var b=Streams_List_View.collection.get(d);if(b.get("tweetListView").length==0){document.getElementById("stream_notifications_"+d).innerHTML='<p>Request rate limit exceeded, Retry after some time. <i class="icon icon-refresh" title="Retry again."></i></p>';$("#stream_notifications_"+d).attr("rel","retry")}}$(function(){$(".favorite-status").die().live("click",function(d){var c=($(this).closest("article").attr("stream-id"));var b=($(this).closest("article").attr("id"));performTweetAction(c,b,null,"favorite")});$(".undo-favorite-status").die().live("click",function(d){var c=($(this).closest("article").attr("stream-id"));var b=($(this).closest("article").attr("id"));performTweetAction(c,b,null,"undofavorite")});$(".more-options").die().live("click",function(g){var b=($(this).closest("article").attr("stream-id"));var k=($(this).closest("article").attr("id"));var f=$(this).attr("id");var m=Streams_List_View.collection.get(b);var c=m.get("tweetListView").get(k);var h=c.toJSON();var j=h.id_str;var d=h.user.screen_name;var l=m.toJSON();$(".list-clear").remove();$(".more-options-list").toggle(false);$("#"+f+"_list",$("#"+b)).toggle("slow");if(l.screen_name==d){return}$.get("/core/social/checkrelationship/"+b+"/"+d,function(e){if(e.follow=="true"){$("#"+f+"_list",$("#"+b)).append('<li class="list-clear"><a href="#social" class="unfollow-user" tweet-owner='+d+">Unfollow @"+d+"</a></li>")
}else{if(e.follow=="false"){$("#"+f+"_list",$("#"+b)).append('<li class="list-clear"><a href="#social" class="follow-user" tweet-owner='+d+">Follow @"+d+"</a></li>")}}if(e.follower=="true"){$("#"+f+"_list",$("#"+b)).append('<li class="list-clear"><a href="#social" class="direct-message">Send Direct Message</a></li>')}if(e.blocked=="true"){$("#"+f+"_list",$("#"+b)).append('<li class="list-clear"><a href="#social" class="unblock-user" tweet-owner='+d+">Unblock @"+d+"</a></li>")}else{if(e.blocked=="false"){$("#"+f+"_list",$("#"+b)).append('<li class="list-clear"><a href="#social" class="block-user" tweet-owner='+d+">Block @"+d+"</a></li>")}}}).error(function(e){displayError(null,e)})});$(".follow-user").die().live("click",function(c){var b=($(this).closest("article").attr("stream-id"));var d=$(this).attr("tweet-owner");performTweetAction(b,null,d,"followuser")});$(".unfollow-user").die().live("click",function(c){var b=($(this).closest("article").attr("stream-id"));var d=$(this).attr("tweet-owner");performTweetAction(b,null,d,"unfollowuser")});$(".block-user").die().live("click",function(c){var b=($(this).closest("article").attr("stream-id"));var d=$(this).attr("tweet-owner");performTweetAction(b,null,d,"blockuser")});$(".unblock-user").die().live("click",function(c){var b=($(this).closest("article").attr("stream-id"));var d=$(this).attr("tweet-owner");performTweetAction(b,null,d,"unblockuser")});$(".delete-tweet").die().live("click",function(h){if(!confirm("Are you sure you want to delete this tweet?")){return}var g=($(this).closest("article").attr("stream-id"));var f=($(this).closest("article").attr("id"));var b=Streams_List_View.collection.get(g);var d=b.get("tweetListView").get(f);var j=d.toJSON();var c=j.id_str;var k=j.user.screen_name;$.get("/core/social/deletetweet/"+g+"/"+k+"/"+c,function(e){if(e=="Successful"){d.set("deleted_msg","deleted");b.get("tweetListView").add(d);showNotyPopUp("information","Your tweet has been deleted.","top",5000);$(".deleted").remove()}else{if(e=="Unsuccessful"){showNotyPopUp("information","Retry after sometime.","top",5000)}}}).error(function(e){displayError(null,e)})});$(".show-retweet").die().live("click",function(h){$(".more-options-list").toggle(false);var g=($(this).closest("article").attr("stream-id"));var f=($(this).closest("article").attr("id"));var b=Streams_List_View.collection.get(g);var d=b.get("tweetListView").get(f);var j=d.toJSON();delete j.id;displayModal("socialsuite_RT_userlistModal","socialsuite-RT-userlist",j,null,null,"/core/social/tweet/"+g);$("#spinner-modal").show();var c=new Base_Collection_View({url:function(){return"/core/social/getrtusers/"+g+"/"+j.id_str},restKey:"user",templateKey:"socialsuite-RT-userlist",individual_tag_name:"li"});c.collection.fetch({success:function(e){$("#spinner-modal").hide()},error:function(e){console.log("ON ERROR");console.log(e);var k={};k.responseText="Sorry, that page does not exist";displayError("socialsuite_RT_userlistModal",k)}});$("#RTuser_list").html(c.render(true).el);displayTimeAgo($("#socialsuite_RT_userlistModal"))})});function performTweetAction(b,h,e,d){var j=Streams_List_View.collection.get(b);if(h){var c=j.get("tweetListView").get(h);var f=c.toJSON();var g=f.id_str}var k=null;switch(d){case"favorite":k="/core/social/favorite/"+b+"/"+g;break;case"undofavorite":k="/core/social/undofavorite/"+b+"/"+g;break;case"followuser":k="/core/social/followuser/"+b+"/"+e;break;case"unfollowuser":k="/core/social/unfollowuser/"+b+"/"+e;break;case"blockuser":k="/core/social/blockuser/"+b+"/"+e;break;case"unblockuser":k="/core/social/unblockuser/"+b+"/"+e;break}requestAction(k,d,j,c,e)}function requestAction(e,c,b,d,f){$.get(e,function(g){if(g=="Unsuccessful"||g=="false"){showNotyPopUp("information","Retry after sometime.","top",5000);return}reflectActionOnTweet(g,c,b,d,f);displayTimeAgo($(".chirp-container"))}).error(function(g){displayError(null,g)})}function reflectActionOnTweet(e,c,b,d,g){if(d){var f=d.toJSON()}switch(c){case"favorite":d.set("favorited_by_user","true");b.get("tweetListView").add(d);break;case"undofavorite":d.unset("favorited_by_user");b.get("tweetListView").add(d);break;case"followuser":if(e=="true"){showNotyPopUp("information","Now you are following @"+g,"top",5000)}break;case"unfollowuser":if(e=="Unfollowed"){showNotyPopUp("information","Now you are not following @"+g,"top",5000)}break;case"blockuser":if(e=="true"){showNotyPopUp("information","You just blocked @"+g,"top",5000)}break;case"unblockuser":if(e=="Unblock"){showNotyPopUp("information","You just unblock @"+g,"top",5000)}break}}function displayError(d,c){$("#spinner-modal").hide();if(d!=null){$("#"+d).modal("hide")}var b=c.responseText;if(b.trim()=="Status is a duplicate."){showNotyPopUp("information","Whoops! You already tweeted that...","top",5000)}else{if(b.trim()=="Sorry, that page does not exist"){showNotyPopUp("information","Sorry, that tweet does not exist.","top",5000)}else{showNotyPopUp("information","Retry after sometime.","top",5000)}}console.log(c.responseText)}$(function(){$(".compose-message").die().live("click",function(c){$(".more-options-list").toggle(false);$("#socialsuite_twitter_messageModal").remove();var b=$(this).attr("stream-id");displayFilledModal(b,null,null,"Tweet")});$(".reply-message").die().live("click",function(d){$(".more-options-list").toggle(false);$("#socialsuite_twitter_messageModal").remove();var c=($(this).closest("article").attr("stream-id"));var b=($(this).closest("article").attr("id"));displayFilledModal(c,b,null,"Reply Tweet")});$(".tweet-to-user").die().live("click",function(c){$("#socialsuite_RT_userlistModal").modal("hide");$("#socialsuite_twitter_messageModal").remove();$(".more-options-list").toggle(false);var b=($(this).closest("article").attr("stream-id"));var d=$(this).attr("tweet-owner");displayFilledModal(b,null,d,"Reply Tweet")});$(".direct-message").die().live("click",function(d){$(".more-options-list").toggle(false);$("#socialsuite_twitter_messageModal").remove();var c=($(this).closest("article").attr("stream-id"));var b=($(this).closest("article").attr("id"));displayFilledModal(c,b,null,"Direct Message")});$(".retweet-status").die().live("click",function(d){$("#socialsuite_twitter_messageModal").remove();var c=($(this).closest("article").attr("stream-id"));var b=($(this).closest("article").attr("id"));displayFilledModal(c,b,null,"Retweet");$("#edit_retweet").click(function(f){f.preventDefault();if($("#send_retweet").hasClass("disabled")&&$("#edit_retweet").hasClass("disabled")){return}$("#send_retweet").remove();$("#edit_retweet").hide();$("#twit-retweet").hide();$("#send_tweet").show();$("#twit-tweet").show();$("#link-text").show();$("#tweet_scheduling").show();Message_Model.model.url="/core/social/tweet/"+c})});$(".undo-retweet-status").die().live("click",function(h){if(!confirm("Are you sure you want to undo retweet this status?")){return}var g=($(this).closest("article").attr("stream-id"));var f=($(this).closest("article").attr("id"));var d=null;var b=Streams_List_View.collection.get(g);var c=b.get("tweetListView").get(f);var j=c.toJSON();if(b.toJSON().stream_type=="Sent"){d=j.id_str}else{if(b.toJSON().stream_type=="Home"){d=j.retweet_id}}$.get("/core/social/undoretweet/"+g+"/"+f+"/"+d,function(e){if(e=="Unsuccessful"){showNotyPopUp("information","Retry after sometime.","top",5000);return}if(j.stream_type=="Sent"){c.set("deleted_msg","deleted")}else{c.unset("retweeted_by_user")}b.get("tweetListView").add(c);$(".deleted").remove();displayTimeAgo($(".chirp-container"))}).error(function(e){displayError(null,e)})});$("#twit-tweet").die().live("mouseleave",function(b){$("#twit-tweet").keypress()});$("#add_message").die().live("click",function(c){var b=" Sell & Market like Fortune 500 with @agilecrm";document.getElementById("twit-tweet").value+=b;$("#link-text").html("<b>Thank you.</b>");setTimeout(function(){$("#link-text").hide()},2000)});$("#socialsuite_twitter_messageModal").on("hidden",function(){if(this.id!="#socialsuite_twitter_messageModal"){return}$(".modal-backdrop").remove();Scheduled_Edit=false;$("#socialsuite_twitter_messageModal").remove()})});$(function(){$(".add-twitter-contact").die().live("click",function(g){var b=($(this).closest("article").attr("stream-id"));var j=($(this).closest("article").attr("id"));var n=Streams_List_View.collection.get(b);var h=n.get("tweetListView").get(j).toJSON();var d=h.user.name;var k=h.user.description;Tweet_Owner_For_Add_Contact=h.user.screen_name;var l=d.substr(0,d.indexOf(" "));var m=d.substr(d.indexOf(" ")+1);$("#fname",$("#personModal")).attr("value",l);$("#lname",$("#personModal")).attr("value",m);$("#job_title",$("#personModal")).attr("value",k);document.getElementById("network_handle").className="socialsuite-network-handle";$("#handle",$("#personModal")).attr("value",Tweet_Owner_For_Add_Contact);$("#website",$("#personModal")).attr("value",Tweet_Owner_For_Add_Contact);$("#image",$("#personModal")).attr("value",h.user.profile_image_url);$("div.website select").val("TWITTER");var f=h.user.profile_image_url;if(f!=undefined&&f!=null){var c=$('<img class="imgholder thumbnail person-img" onload="changeProperty()" style="display: inline;"  src="'+f+'"></img>');$("#pic").html(c).show();$("img").error(function(){$("#pic").css("display","none")})}changeProperty()});$("#personModal").on("hidden.bs.modal",function(){document.getElementById("network_handle").className="network-handle";document.getElementById("handle").className="";$("#pic").css("display","none");$("#pic").empty();changeProperty()});$("#personModal").on("shown.bs.modal",function(){changeProperty()});$("#personModal").on("show.bs.modal",function(){changeProperty()});$("#pic").change(function(){changeProperty()})});function onloadProfileImg(){$("#add_twitter_stream").show();$("#streamDetails").html(getTemplate("twitter-stream-type"),{});$("#twitter_profile_img").attr("src",document.getElementById("twitter_profile_img_url").src);document.getElementById("account_description_label").innerHTML="<b>"+$("#twitter_account").val()+"</b>"
}function socialsuite_add_website(){if(Tweet_Owner_For_Add_Contact!=null){$("#website",$("#continueform")).attr("value",Tweet_Owner_For_Add_Contact);$("div.website select").val("TWITTER");Tweet_Owner_For_Add_Contact=null}}function changeProperty(){var d=$("#network_handle",$("#personModal")).css("display");var b=$("#pic",$("#personModal")).css("display");var c=$("#pic",$("#personModal")).html();if((b=="inline"||b=="block")&&c!=""){if(d=="none"){document.getElementById("network_handle").className="after-img-load-hide"}else{if(d=="block"){document.getElementById("network_handle").className="after-img-load-show"}}document.getElementById("handle").className="add-form-input"}else{if((b=="none"||b==null||b=="")||(c==null||c=="")){if(d=="none"){document.getElementById("network_handle").className="network-handle"}else{if(d=="block"){document.getElementById("network_handle").className="socialsuite-network-handle"}}document.getElementById("handle").className=""}}}function displayFilledModal(b,h,d,f){var e="/core/social/tweet/"+b;var l=Streams_List_View.collection.get(b);var j=l.toJSON();if(h!=null){var c=l.get("tweetListView").get(h);var g=c.toJSON()}var k={};k.streamId=b;k.profileImg=$("#"+b+"-profile-img").prop("src");k.domain_user_id=CURRENT_DOMAIN_USER.id;k.screen_name=j.screen_name;k.network_type="TWITTER";k.token=j.token;k.secret=j.secret;k.schedule="0";switch(f){case"Tweet":k.headline="Tweet";k.info="Status from "+j.screen_name;k.description="What's happening?";break;case"Reply Tweet":if(f=="Reply Tweet"&&d==null){k.headline="Reply Tweet";k.info="Reply @"+g.user.screen_name+" from "+j.screen_name;k.description="@"+g.user.screen_name;k.tweetId=g.id_str;k.tweetOwner=g.user.screen_name}else{if(f=="Reply Tweet"&&d!=null){k.headline="Reply Tweet";k.info="Reply @"+d+" from "+j.screen_name;k.description="@"+d;k.tweetOwner=d;k.tweetId=null}}break;case"Direct Message":k.headline="Direct Message";k.info="Direct message from "+j.screen_name+" to "+g.user.screen_name;k.description="Tip: you can send a message to anyone who follows you.";k.tweetId=g.id_str;k.tweetOwner=g.user.screen_name;break;case"Retweet":k.headline="Retweet";k.info="Status of @"+g.user.screen_name;k.description=g.original_text;k.tweetId=g.id;k.tweetOwner=g.user.screen_name;e="/core/social/retweet/"+b+"/"+g.id_str;break}console.log(k);displayModal("socialsuite_twitter_messageModal","socialsuite-twitter-message",k,"twitter-counter","twit-tweet",e);$("#twit-tweet").on("cross",function(){$("#send_tweet").attr("disabled","disable")});$("#twit-tweet").on("uncross",function(){if(!Schedule_In_Future&&$("#schedule_controls").css("display")=="block"){return}$("#send_tweet").removeAttr("disabled")})}function displayModal(g,e,f,d,b,c){$("#"+g).remove();Schedule_In_Future=false;Message_Model=new Base_Model_View({data:f,url:c,template:e,modal:"#"+g,postRenderCallback:function(h){$(".modal-backdrop").remove();if(Message_Model.model.get("id")||Message_Model.model.get("response")=="Successful"){return}$("#"+g,h).modal("show")},saveCallback:function(h){displayNoty(h);$("#"+g).modal("hide");$("#"+g).remove()}});$("#content").append(Message_Model.render().el);if(d!=null&&b!=null){$("#"+g).on("shown",function(){head.js(LIB_PATH+"lib/bootstrap-limit.js",function(){$(".twit-tweet-limit").limit({maxChars:140,counter:"#"+d});$("#"+g).find("#"+b).focus()})})}}function displayNoty(b){if(b.response=="Successful"){if(Message_Model.model.get("headline")=="Tweet"){showNotyPopUp("information","Your Tweet was posted!","top",5000)}else{showNotyPopUp("information","Your Tweet to @"+Message_Model.model.get("tweetOwner")+" has been sent!","top",5000)}}else{if(b.response=="Unsuccessful"){$("#socialsuite_twitter_messageModal").find("span.save-status").html("Retry");showNotyPopUp("information","Retry after sometime.","top",5000)}else{if(Message_Model.model.get("headline")=="Retweet"&&b.response!=undefined){showEffectOfRT(b)}else{if(b.id!=undefined&&b.schedule!=undefined){$("#show_scheduled_updates").show()}}}}}function showEffectOfRT(d){var b=Streams_List_View.collection.get(Message_Model.model.get("streamId"));var c=b.get("tweetListView").get(Message_Model.model.get("tweetId"));if(b==undefined||c==undefined){return}c.set("retweeted_by_user","true");c.set("retweet_id",d.response);b.get("tweetListView").add(c);displayTimeAgo($(".chirp-container"))}function initToPubNub(){if(Pubnub!=undefined){if(Pubnub!=null){return}}var b="https";head.js(b+"://pubnub.a.ssl.fastly.net/pubnub-3.4.min.js",function(){Pubnub=PUBNUB.init({publish_key:"pub-c-e4c8fdc2-40b1-443d-8bb0-2a9c8facd274",subscribe_key:"sub-c-118f8482-92c3-11e2-9b69-12313f022c90",ssl:true,origin:"pubsub.pubnub.com"});subscribeClientChannel()})}function subscribeClientChannel(){Pubnub.subscribe({channel:CURRENT_DOMAIN_USER.id+"_Channel",restore:true,message:function(d,b,c){handleMessage(d)},presence:function(d,b,c){console.log(d)},connect:function(){console.log("Agile crm Connected");socialsuitecall.streams()},disconnect:function(b){console.log(b+" Disconnected")},reconnect:function(b){console.log(b+" Reconnected")},error:function(b){console.log(b+" Network Error")}})}function sendMessage(b){console.log("publish_message publishJSON: ");console.log(b);if(b==null){return}Pubnub.publish({channel:"agile_crm_Channel",message:b,callback:function(c){if(c[0]){console.log("publish_message Successfully Sent!")}else{console.log("publish_message unsuccessfull to Sent!");showNotyPopUp("information","You are not connected with Twitter server or you have problem with connection!","top",5000);displayErrorInStream(b.stream);Register_Counter++;registerAll(Register_Counter)}}})}var Agile_MD5=function(u){function N(c,b){return(c<<b)|(c>>>(32-b))}function M(x,c){var G,b,k,F,d;k=(x&2147483648);F=(c&2147483648);G=(x&1073741824);b=(c&1073741824);d=(x&1073741823)+(c&1073741823);if(G&b){return(d^2147483648^k^F)}if(G|b){if(d&1073741824){return(d^3221225472^k^F)}else{return(d^1073741824^k^F)}}else{return(d^k^F)}}function t(b,d,c){return(b&d)|((~b)&c)}function s(b,d,c){return(b&c)|(d&(~c))}function q(b,d,c){return(b^d^c)}function o(b,d,c){return(d^(b|(~c)))}function w(G,F,ac,ab,k,H,I){G=M(G,M(M(t(F,ac,ab),k),I));return M(N(G,H),F)}function f(G,F,ac,ab,k,H,I){G=M(G,M(M(s(F,ac,ab),k),I));return M(N(G,H),F)}function J(G,F,ac,ab,k,H,I){G=M(G,M(M(q(F,ac,ab),k),I));return M(N(G,H),F)}function v(G,F,ac,ab,k,H,I){G=M(G,M(M(o(F,ac,ab),k),I));return M(N(G,H),F)}function e(x){var H;var k=x.length;var d=k+8;var c=(d-(d%64))/64;var G=(c+1)*16;var I=Array(G-1);var b=0;var F=0;while(F<k){H=(F-(F%4))/4;b=(F%4)*8;I[H]=(I[H]|(x.charCodeAt(F)<<b));F++}H=(F-(F%4))/4;b=(F%4)*8;I[H]=I[H]|(128<<b);I[G-2]=k<<3;I[G-1]=k>>>29;return I}function D(d){var c="",k="",x,b;for(b=0;b<=3;b++){x=(d>>>(b*8))&255;k="0"+x.toString(16);c=c+k.substr(k.length-2,2)}return c}function L(d){d=d.replace(/\r\n/g,"\n");var b="";for(var x=0;x<d.length;x++){var k=d.charCodeAt(x);if(k<128){b+=String.fromCharCode(k)}else{if((k>127)&&(k<2048)){b+=String.fromCharCode((k>>6)|192);b+=String.fromCharCode((k&63)|128)}else{b+=String.fromCharCode((k>>12)|224);b+=String.fromCharCode(((k>>6)&63)|128);b+=String.fromCharCode((k&63)|128)}}}return b}var E=Array();var R,h,K,y,g,aa,Z,Y,X;var U=7,S=12,P=17,O=22;var C=5,B=9,A=14,z=20;var p=4,n=11,m=16,l=23;var W=6,V=10,T=15,Q=21;u=L(u);E=e(u);aa=1732584193;Z=4023233417;Y=2562383102;X=271733878;for(R=0;R<E.length;R+=16){h=aa;K=Z;y=Y;g=X;aa=w(aa,Z,Y,X,E[R+0],U,3614090360);X=w(X,aa,Z,Y,E[R+1],S,3905402710);Y=w(Y,X,aa,Z,E[R+2],P,606105819);Z=w(Z,Y,X,aa,E[R+3],O,3250441966);aa=w(aa,Z,Y,X,E[R+4],U,4118548399);X=w(X,aa,Z,Y,E[R+5],S,1200080426);Y=w(Y,X,aa,Z,E[R+6],P,2821735955);Z=w(Z,Y,X,aa,E[R+7],O,4249261313);aa=w(aa,Z,Y,X,E[R+8],U,1770035416);X=w(X,aa,Z,Y,E[R+9],S,2336552879);Y=w(Y,X,aa,Z,E[R+10],P,4294925233);Z=w(Z,Y,X,aa,E[R+11],O,2304563134);aa=w(aa,Z,Y,X,E[R+12],U,1804603682);X=w(X,aa,Z,Y,E[R+13],S,4254626195);Y=w(Y,X,aa,Z,E[R+14],P,2792965006);Z=w(Z,Y,X,aa,E[R+15],O,1236535329);aa=f(aa,Z,Y,X,E[R+1],C,4129170786);X=f(X,aa,Z,Y,E[R+6],B,3225465664);Y=f(Y,X,aa,Z,E[R+11],A,643717713);Z=f(Z,Y,X,aa,E[R+0],z,3921069994);aa=f(aa,Z,Y,X,E[R+5],C,3593408605);X=f(X,aa,Z,Y,E[R+10],B,38016083);Y=f(Y,X,aa,Z,E[R+15],A,3634488961);Z=f(Z,Y,X,aa,E[R+4],z,3889429448);aa=f(aa,Z,Y,X,E[R+9],C,568446438);X=f(X,aa,Z,Y,E[R+14],B,3275163606);Y=f(Y,X,aa,Z,E[R+3],A,4107603335);Z=f(Z,Y,X,aa,E[R+8],z,1163531501);aa=f(aa,Z,Y,X,E[R+13],C,2850285829);X=f(X,aa,Z,Y,E[R+2],B,4243563512);Y=f(Y,X,aa,Z,E[R+7],A,1735328473);Z=f(Z,Y,X,aa,E[R+12],z,2368359562);aa=J(aa,Z,Y,X,E[R+5],p,4294588738);X=J(X,aa,Z,Y,E[R+8],n,2272392833);Y=J(Y,X,aa,Z,E[R+11],m,1839030562);Z=J(Z,Y,X,aa,E[R+14],l,4259657740);aa=J(aa,Z,Y,X,E[R+1],p,2763975236);X=J(X,aa,Z,Y,E[R+4],n,1272893353);Y=J(Y,X,aa,Z,E[R+7],m,4139469664);Z=J(Z,Y,X,aa,E[R+10],l,3200236656);aa=J(aa,Z,Y,X,E[R+13],p,681279174);X=J(X,aa,Z,Y,E[R+0],n,3936430074);Y=J(Y,X,aa,Z,E[R+3],m,3572445317);Z=J(Z,Y,X,aa,E[R+6],l,76029189);aa=J(aa,Z,Y,X,E[R+9],p,3654602809);X=J(X,aa,Z,Y,E[R+12],n,3873151461);Y=J(Y,X,aa,Z,E[R+15],m,530742520);Z=J(Z,Y,X,aa,E[R+2],l,3299628645);aa=v(aa,Z,Y,X,E[R+0],W,4096336452);X=v(X,aa,Z,Y,E[R+7],V,1126891415);Y=v(Y,X,aa,Z,E[R+14],T,2878612391);Z=v(Z,Y,X,aa,E[R+5],Q,4237533241);aa=v(aa,Z,Y,X,E[R+12],W,1700485571);X=v(X,aa,Z,Y,E[R+3],V,2399980690);Y=v(Y,X,aa,Z,E[R+10],T,4293915773);Z=v(Z,Y,X,aa,E[R+1],Q,2240044497);aa=v(aa,Z,Y,X,E[R+8],W,1873313359);X=v(X,aa,Z,Y,E[R+15],V,4264355552);Y=v(Y,X,aa,Z,E[R+6],T,2734768916);Z=v(Z,Y,X,aa,E[R+13],Q,1309151649);aa=v(aa,Z,Y,X,E[R+4],W,4149444226);X=v(X,aa,Z,Y,E[R+11],V,3174756917);Y=v(Y,X,aa,Z,E[R+2],T,718787259);Z=v(Z,Y,X,aa,E[R+9],Q,3951481745);aa=M(aa,h);Z=M(Z,K);Y=M(Y,y);X=M(X,g)}var j=D(aa)+D(Z)+D(Y)+D(X);return j.toLowerCase()};$(function(){Handlebars.registerHelper("getPropertyValue",function(g,h){return getPropertyValue(g,h)});Handlebars.registerHelper("getPropertyValueInCheckbox",function(g,h,k,j){return getPropertyValueInCheckbox(g,h,k,j)});Handlebars.registerHelper("get_correct_count",function(g){return g-1});Handlebars.registerHelper("getPropertyValueBySubtype",function(h,j,g){return getPropertyValueBySubtype(h,j,g)
});Handlebars.registerHelper("getPropertyValueBytype",function(h,j,k,g){return getPropertyValueBytype(h,j,k,g)});Handlebars.registerHelper("getTwitterHandleByURL",function(g){g=g.substring(g.lastIndexOf("/")+1);console.log(g);return g});Handlebars.registerHelper("getContactCustomProperties",function(h,j){var g=getContactCustomProperties(h);if(g.length==0){return j.inverse(g)}return j.fn(g)});Handlebars.registerHelper("getContactCustomPropertiesExclusively",function(j,k){var m=["LINKEDIN","TWITTER"];var n=["title"];var h=getContactCustomProperties(j);var g=[];for(var l=0;l<h.length;l++){if(jQuery.inArray(h[l].name,n)!=-1||(h[l].subtype&&jQuery.inArray(h[l].subtype,m)!=-1)){continue}g.push(jQuery.extend(true,{},h[l]))}if(g.length==0){return k.inverse(g)}$.getJSON("core/api/custom-fields/type/DATE",function(t){if(t.length==0){return}for(var o=0;o<t.length;o++){for(var p=0;p<g.length;p++){if(g[p].name==t[o].field_label){try{var s=g[p].value;if(!isNaN(s)){g[p].value=s;g[p]["subtype"]=t[o].field_type}}catch(q){g[p].value=g[p].value}}}}updateCustomData(k.fn(g))});return k.fn(g)});Handlebars.registerHelper("urlEncode",function(h,j,l){var g="&";if(h.indexOf("?")!=-1){g="&"}var k=h+g+j+"="+escape(JSON.stringify(l));return k});Handlebars.registerHelper("encodeString",function(g){return encodeURIComponent(g)});Handlebars.registerHelper("gravatarurl",function(p,h){if(p==undefined){return}var g=getPropertyValue(p,"image");if(g){return g}var l=DEFAULT_GRAVATAR_url;var m='&d=404" ';var j="";try{j=text_gravatar_initials(p)}catch(n){console.log(n)}if(j.length==0){m="&d="+DEFAULT_GRAVATAR_url+'" '}var k='onLoad="image_load(this)" onError="image_error(this)" _data-name="'+j;var o=getPropertyValue(p,"email");if(o){return new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5(o)+".jpg?s="+h+m+k)}return new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+h+""+m+k)});Handlebars.registerHelper("defaultGravatarurl",function(h){var g=DEFAULT_GRAVATAR_url;return"https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+h+"&d="+escape(g)});Handlebars.registerHelper("emailGravatarurl",function(j,h){var g=DEFAULT_GRAVATAR_url;if(h){return"https://secure.gravatar.com/avatar/"+Agile_MD5(h)+".jpg?s="+j+"&d="+escape(g)}return"https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+j+"&d="+escape(g)});Handlebars.registerHelper("nameAvatar",function(g,j){if(g==undefined){return}var k=getPropertyValue(g,"image");if(k){return k}var h=getPropertyValue(g,"email");if(h){return"https://secure.gravatar.com/avatar/"+Agile_MD5(h)+".jpg?s="+j+"&d=404"}return"https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+j+"&d=404"});Handlebars.registerHelper("dataNameAvatar",function(g){if(g==undefined){return}return text_gravatar_initials(g)});Handlebars.registerHelper("icons",function(g){g=g.toLowerCase().trim();console.log(g);if(g=="email"){return"icon-envelope-alt"}if(g=="phone"){return"icon-headphones"}if(g=="url"){return"icon-home"}if(g=="call"){return"icon-phone-sign"}if(g=="follow_up"){return"icon-signout"}if(g=="meeting"){return"icon-group"}if(g=="milestone"){return"icon-cog"}if(g=="send"){return"icon-reply"}if(g=="tweet"){return"icon-share-alt"}if(g=="other"){return"icon-tasks"}if(g=="twitter"){return"icon-twitter"}if(g=="facebook"){return"icon-facebook"}});Handlebars.registerHelper("eachkeys",function(k,j){var l=j.fn,g=j.inverse;var h="";var m=true;for(key in k){m=false;break}if(!m){for(key in k){h=h+l({key:key,value:k[key]})}}else{h=g(this)}return h});Handlebars.registerHelper("ucfirst",function(g){return(g&&typeof g==="string")?(g.charAt(0).toUpperCase()+g.slice(1).toLowerCase()):""});Handlebars.registerHelper("contactShortName",function(){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var h=App_Contacts.contactDetailView.model.get("properties");if(App_Contacts.contactDetailView.model.get("type")=="PERSON"){var g;for(var j=0;j<h.length;j++){if(h[j].name=="last_name"){g=h[j].value}else{if(h[j].name=="first_name"){return h[j].value}}}if(g&&g!=null){return g}return"Contact"}else{for(var j=0;j<h.length;j++){if(h[j].name=="name"){return h[j].value}}return"Company"}}});Handlebars.registerHelper("workflowName",function(){if(App_Workflows.workflow_model){var g=App_Workflows.workflow_model.get("name");return"'"+g+"'"}return"this"});Handlebars.registerHelper("task_property",function(g){if(g=="FOLLOW_UP"){return"Follow Up"}else{return ucfirst(g)}});Handlebars.registerHelper("show_custom_fields_for_merge",function(h,j){var g=show_custom_fields_helper_for_merge(h,j);return new Handlebars.SafeString(g)});Handlebars.registerHelper("add_dots_end",function(h){if(h){if(h.length>100){var g=h.substr(0,100);g=g+"....";return g}}return h});Handlebars.registerHelper("tagslist",function(o){console.log(o);var n={};for(var j=0;j<o.length;j++){var p=o[j].tag;var h=p.charAt(0).toUpperCase();var l=new Array();if(n[h]!=undefined){l=n[h]}l.push(p);n[h]=l}var m=Object.keys(n);m.sort();var k="";for(var j in m){var l=n[m[j]];k+="<div class='tag-element'><div class='tag-key'>"+m[j]+"</div> ";k+="<div class='tag-values'>";for(var j=0;j<l.length;j++){console.log("************************");console.log(l[j]);var g="#tags/"+encodeURIComponent(l[j]);k+=('<a href="'+g+'" >'+l[j]+"</a> ")}k+="</div></div>"}return k});Handlebars.registerHelper("setupTags",function(h){console.log(h);var m={};var n=[];for(var l=0;l<h.length;l++){var g=h[l].tag;var k=g.charAt(0).toUpperCase();if(jQuery.inArray(k,n)==-1){n.push(k)}}n.sort();console.log(n);var j="";for(var l=0;l<n.length;l++){j+="<div class='tag-element' style='margin-right:10px;'><div class='tag-key'>"+n[l]+"</div><div class='tag-values' tag-alphabet=\""+encodeURI(n[l])+'"></div></div>'}return new Handlebars.SafeString(j)});Handlebars.registerHelper("deals_by_milestones",function(j){var g="";var h=Object.keys(j).length;$.each(j,function(l,m){if(h==1&&l==""){g+='<div class="slate" style="margin:0px;"><div class="slate-content"><div class="box-left"><img alt="Clipboard" src="/img/clipboard.png"></div><div class="box-right"><h3>You have no milestones defined</h3><br><a href="#milestones" class="btn"><i class="icon icon-plus-sign"></i> Add Milestones</a></div></div></div>'}else{g+="<div class='milestone-column'><div class='dealtitle-angular'><p class='milestone-heading'>"+l+"</p><span></span></div><ul class='milestones' milestone='"+l+"'>";for(var k in m){if(m[k].id){g+="<li id='"+m[k].id+"'>"+getTemplate("opportunities-grid-view",m[k])+"</li>"}}g+="</ul></div>"}});return g});Handlebars.registerHelper("milestone_ul",function(k){var j="";if(k){var h=k.split(",");for(var g in h){j+="<tr data='"+h[g]+"' style='display: table-row;'><td><div class='p-l-sm inline-block v-top text-ellipsis' style='width:80%'>";j+=h[g]+"</div></td><td class='p-r-none'><div class='m-b-n-xs' style='display:none;'><a class='text-l-none-hover c-p'><i title='Drag' class='icon-move'></i></a><a class='milestone-delete c-p m-l-sm text-l-none'  data-toggle='modal' role='button' href='#'><i title='Delete Milestone' class='task-action icon icon-trash'></i></a></div></td></tr>"}}return j});Handlebars.registerHelper("epochToHumanDate",function(h,g){if(!h){h="mmm dd yyyy HH:MM:ss"}if(!g){return}if((g/100000000000)>1){console.log(new Date(parseInt(g)).format(h));return new Date(parseInt(g)).format(h,0)}var j=new Date(parseInt(g)*1000).format(h);return j});Handlebars.registerHelper("toLocalTimezone",function(h){var g=new Date(h);return g.toDateString()+" "+g.toLocaleTimeString()});Handlebars.registerHelper("toLocalTimezoneFromUtc",function(h){var g=new Date(h+" GMT+0000");return g.toDateString()+" "+g.toLocaleTimeString()});Handlebars.registerHelper("epochToTaskDate",function(g){var j,k;if((g/100000000000)>1){j=new Date(g).getMonth();k=new Date(g).getDate()}else{j=new Date(parseInt(g)*1000).getMonth();k=new Date(parseInt(g)*1000).getDate()}var h=["Jan","Feb","March","April","May","June","July","Aug","Sept","Oct","Nov","Dec"];return(h[j]+" "+k)});Handlebars.registerHelper("task_label_color",function(g){if(g=="HIGH"||g=="red"){return"important"}if(g=="NORMAL"||g=="#36C"){return"info"}if(g=="LOW"){return""}if(g=="green"){return"success"}});Handlebars.registerHelper("event_priority",function(g){if(g=="red"){return"High"}if(g=="#36C"){return"Normal"}if(g=="green"){return"Low"}});Handlebars.registerHelper("network",function(g){if(g=="GOOGLE"){return"Google Drive"}if(g=="S3"){return"Uploaded Doc"}});Handlebars.registerHelper("epochToDate",function(g,j){var m=JSON.parse(g);if(!m[j]){return"-"}if(j!="created_time"){if((m[j]/100000000000)>1){return new Date(parseInt(m[j])).format("mmm dd yyyy HH:MM:ss",0)}return new Date(parseInt(m[j])*1000).format("mmm dd yyyy HH:MM:ss",0)}else{var l=new Date(parseInt(m[j])*1000).getMonth();var n=new Date(parseInt(m[j])*1000).getDate();var k=new Date(parseInt(m[j])*1000).getFullYear();var h=["Jan","Feb","March","April","May","June","July","Aug","Sept","Oct","Nov","Dec"];return(h[l]+" "+n+", "+k)}});Handlebars.registerHelper("currencySymbol",function(){var h=((CURRENT_USER_PREFS.currency!=null)?CURRENT_USER_PREFS.currency:"USD-$");var g=((h.length<4)?"$":h.substring(4,h.length));return g});Handlebars.registerHelper("mandrill_exist",function(g){if(IS_HAVING_MANDRILL){return g.fn(this)}else{return g.inverse(this)}});Handlebars.registerHelper("calculatePipeline",function(h,j){var g=parseInt(h)*parseInt(j)/100;return g});Handlebars.registerHelper("getRequiredLog",function(k,j){var g=JSON.parse(k);if(j=="t"){var h=new Date(g[0][j]*1000);return h}return g[0][j]});Handlebars.registerHelper("contactTableHeadings",function(h){var g="";$.each(App_Contacts.contactViewModel[h],function(j,k){if(k.indexOf("custom_")==0){k=k.split("custom_")[1]}k=k.replace("_"," ");g=g.concat("<th>"+ucfirst(k)+"</th>")});return new Handlebars.SafeString(g)});Handlebars.registerHelper("reportsContactTableHeadings",function(h){var g="";$.each(REPORT[h],function(j,k){if(k.indexOf("properties_")!=-1){k=k.split("properties_")[1]
}if(k.indexOf("custom_")==0){k=k.split("custom_")[1]}k=k.replace("_"," ");g=g.concat("<th>"+ucfirst(k)+"</th>")});return new Handlebars.SafeString(g)});Handlebars.registerHelper("if_entity",function(h,g){if(this.entity_type==h){return g.fn(this)}if(!this.entity&&this[h]!=undefined){return g.fn(this)}});Handlebars.registerHelper("titleFromEnums",function(g){if(!g){return}var h=g.replace(/_/g," ");return ucfirst(h.toLowerCase())});Handlebars.registerHelper("actionTemplate",function(j){if(!j){return}var g=j.length;var h='<div style="white-space: normal!important;word-break: break-word;">';$.each(j,function(k,l){if(--g==0){h=h.concat(titleFromEnums(l.action));return}h=h.concat(titleFromEnums(l.action)+", ")});h=h.concat("</div>");return new Handlebars.SafeString(h)});Handlebars.registerHelper("triggerType",function(g){if(g=="ADD_SCORE"){return g.replace("ADD_SCORE","Score (>=)")}return titleFromEnums(g)});Handlebars.registerHelper("if_notification_type",function(){if(this.type=="COMPANY"){var g=this.notification.split("_");var h=ucfirst(g[0].replace("CONTACT","COMPANY"))+" "+ucfirst(g[1]);return" - "+h}var k=this.notification.replace(/_/," ");switch(k){case"IS BROWSING":return k.toLowerCase()+" "+this.custom_value;case"CLICKED LINK":var j=JSON.parse(this.custom_value);if(j.workflow_name==undefined){return k.toLowerCase()+" "+j.url_clicked}return k.toLowerCase()+" "+j.url_clicked+'  of campaign "'+j.workflow_name+'"';case"OPENED EMAIL":var j=JSON.parse(this.custom_value);if(j.hasOwnProperty("workflow_name")){return k.toLowerCase()+'  of campaign "'+j.workflow_name+'"'}return k.toLowerCase()+' with subject "'+j.email_subject+'"';case"CONTACT ADDED":return" - "+ucfirst(k.split(" ")[0])+" "+ucfirst(k.split(" ")[1]);case"CONTACT DELETED":return" - "+ucfirst(k.split(" ")[0])+" "+ucfirst(k.split(" ")[1]);case"DEAL CREATED":return" - "+ucfirst(k.split(" ")[0])+" "+ucfirst(k.split(" ")[1]);case"DEAL CLOSED":return" - "+ucfirst(k.split(" ")[0])+" "+ucfirst(k.split(" ")[1]);case"TAG ADDED":return' - "'+this.custom_value+'" '+k.toLowerCase().split(" ")[0]+" has been "+k.toLowerCase().split(" ")[1];case"TAG DELETED":return' - "'+this.custom_value+'" '+k.toLowerCase().split(" ")[0]+" has been "+k.toLowerCase().split(" ")[1];default:return k.toLowerCase()}});Handlebars.registerHelper("epochToLogDate",function(g){return new Date(g*1000)});Handlebars.registerHelper("getCountryName",function(g){return getCode(g)});Handlebars.registerHelper("replace_plus_symbol",function(g){return g.replace(/\+/," ")});Handlebars.registerHelper("replace_minus_symbol",function(g){return g.replace(/\-/,"")});Handlebars.registerHelper("get_amount_with_possitive",function(g){if(g<0){return g/100*(-1)}else{return g/100}});Handlebars.registerHelper("removeSlash",function(g){if(g=="A/B"){return g.replace(/\//,"")}return g});Handlebars.registerHelper("if_property",function(h,n,m,o,j,l,k,g,p,q){if(this.name!=h&&this.name!=n&&this.name!=m&&this.name!=o&&this.name!=j&&this.name!=l&&this.name!=k&&this.name!=g&&this.name!=p){return q.fn(this)}});Handlebars.registerHelper("property_is_exists",function(h,j,g){if(getPropertyValue(j,h)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("online_schedule_URL",function(){return ONLINE_SCHEDULING_URL});Handlebars.registerHelper("get_current_domain",function(){return CURRENT_DOMAIN_USER.domain});Handlebars.registerHelper("comma_in_between_property",function(h,g,k,j){if(getPropertyValue(k,h)&&getPropertyValue(k,g)){return","}});Handlebars.registerHelper("property_subtype_is_exists",function(j,g,k,h){if(getPropertyValueBySubtype(k,j,g)){return h.fn(this)}return h.inverse(this)});Handlebars.registerHelper("multiple_Property_Element",function(h,j,g){var k=agile_crm_get_contact_properties_list(h);if(k.length>0){return g.fn(k)}});Handlebars.registerHelper("address_Element",function(m){var g=0;for(var k=0,j=m.length;k<j;k++){if(m[k].name=="address"){var n="";var h={};try{h=JSON.parse(m[k].value)}catch(p){h.address=m[k].value}var o=countJsonProperties(h);if(g!=0){n=n.concat('<div class="contact-addressview"><div><div class="pull-left" style="width:25px"><i class="icon icon-map-marker"></i></div><div class="pull-left" style="width:90%">')}else{n=n.concat('<div class="contact-addressview"><div><div class="pull-left" style="width:25px"><i class="icon icon-map-marker"></i></div><div class="pull-left" style="width:90%">')}$.each(h,function(l,q){if(--o==0){n=n.concat(q+".");return}n=n.concat(q+", ")});if(m[k].subtype){n=n.concat('<span class="label">'+m[k].subtype+"</span>")}n=n.concat('</span>&nbsp;<span id="map_view_action"></span></div></div>');return new Handlebars.SafeString(n)}else{if(m[k].name=="phone"||m[k].name=="email"){++g}}}});Handlebars.registerHelper("address_Template",function(k){for(var j=0,h=k.length;j<h;j++){if(k[j].name=="address"){var m="";var g={};try{g=JSON.parse(k[j].value)}catch(o){g.address=k[j].value}var n=countJsonProperties(g);$.each(g,function(l,p){if(--n==0){m=m.concat(p+".");return}m=m.concat(p+", ")});return new Handlebars.SafeString(m)}}});Handlebars.registerHelper("related_to_contacts",function(k,g){var h="";var j=k.length;$.each(k,function(m,n){var l=getTemplate("related-to-contacts",n);if(--j==0){h=h.concat(l);return}h=h.concat(l+", ")});return new Handlebars.SafeString(h)});Handlebars.registerHelper("related_to_one",function(k,g){var h="";var j=k.length;$.each(k,function(m,n){if(m<=3){var l=getTemplate("related-to-contacts",n);if(--j==0||m==3){h=h.concat(l);return}h=h.concat(l+", ")}});return new Handlebars.SafeString(h)});Handlebars.registerHelper("numberWithCommas",function(g){if(g==0){return g}if(g){return g.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}});Handlebars.registerHelper("field_Element",function(g){var h="";var j=g.length;$.each(g,function(k,l){if(l.indexOf("properties_")!=-1){l=l.split("properties_")[1]}else{if(l.indexOf("custom_")!=-1){l=l.split("custom_")[1]}else{if(l.indexOf("CUSTOM_")!=-1){l=l.split("CUSTOM_")[1]}else{if(l=="created_time"){l="Created Date"}else{if(l=="updated_time"){l="Updated Date"}}}}}l=l.replace("_"," ");if(--j==0){h=h.concat(l);return}h=h.concat(l+", ")});return new Handlebars.SafeString(h)});Handlebars.registerHelper("stringToJSON",function(h,j,g){console.log(h);console.log(j);if(j){try{h[j]=JSON.parse(h[j])}finally{return g.fn(h[j])}}try{return g.fn(JSON.parse(h))}catch(k){return g.fn(h)}});Handlebars.registerHelper("if_propertyName",function(h,g){var j=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;if(value.search(j)!=-1){return g.fn(this)}else{return g.inverse(this)}});Handlebars.registerHelper("show_link_in_statement",function(h){var j=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;try{h=h.replace(j,"<a href='$1' target='_blank' class='cd_hyperlink'>$1</a>");return new Handlebars.SafeString(h)}catch(g){return h}});Handlebars.registerHelper("displayPlan",function(g){return ucfirst(g).replaceAll("_"," ")});Handlebars.registerHelper("displayPlainText",function(g){return g.split("_").join(" ")});Handlebars.registerHelper("displayTaskStatus",function(g){var h=g.split("_").join("").trim().toLowerCase();if(h=="yettostart"){return"Not Started"}else{return ucfirst(g.split("_").join(" ").trim())}});Handlebars.registerHelper("getCurrentContactProperty",function(h){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var g=App_Contacts.contactDetailView.model.get("properties");console.log(App_Contacts.contactDetailView.model.toJSON());return getPropertyValue(g,h)}});Handlebars.registerHelper("safe_string",function(g){g=g.replace(/\n/,"<br/>");return new Handlebars.SafeString(g)});Handlebars.registerHelper("string_to_date",function(h,g){return new Date(g).format(h)});Handlebars.registerHelper("isArray",function(h,g){if(isArray(h)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("is_string",function(h,g){if(typeof h=="string"){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("bindData",function(g){return JSON.stringify(g)});Handlebars.registerHelper("getCurrentUserPrefs",function(g){if(CURRENT_USER_PREFS){}return g.fn(CURRENT_USER_PREFS)});Handlebars.registerHelper("getCurrentDomain",function(h){var g=window.location.host;var j=/(\.)/;if(g.search(j)>=0){return g.split(j)[0]}return" "});Handlebars.registerHelper("date-range",function(j,h,k){var l=Date.parse(j);var g=Date.today().add({days:parseInt(h)});return g.toString("MMMM d, yyyy")+" - "+l.toString("MMMM d, yyyy")});Handlebars.registerHelper("extractEmail",function(h,g){console.log(h);return g.fn(h.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)[0])});Handlebars.registerHelper("getCurrentContactPropertyBlock",function(j,h){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var g=App_Contacts.contactDetailView.model.get("properties");console.log(App_Contacts.contactDetailView.model.toJSON());return h.fn(getPropertyValue(g,j))}});Handlebars.registerHelper("isDuplicateContactProperty",function(l,k,j){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var h=App_Contacts.contactDetailView.model.get("properties");var g=getPropertyValue(h,k);var m=getPropertyValue(l,k);if(!g||!m){g=getPropertyValue(h,"first_name")+" "+getPropertyValue(h,"last_name");m=getPropertyValue(l,"first_name")+" "+getPropertyValue(l,"last_name")}if(g==m){return j.fn(this)}return j.inverse(this)}});Handlebars.registerHelper("containString",function(h,j,g){if(j.search(h)!=-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("is_emailPlan",function(h,g){if(h.search("email")!=-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("is_userPlan",function(h,g){if(h.search("email")!=-1){return g.inverse(this)}return g.fn(this)});Handlebars.registerHelper("numeric_operation",function(k,j,h){var g="/*-+";if(g.indexOf(h)==-1){return""}if(h=="+"){return k+j}if(h=="-"){return k-j}if(h=="*"){return k*j
}if(h=="/"){return k/j}});Handlebars.registerHelper("get_total_amount",function(h,g){return(h/100)*g});Handlebars.registerHelper("check_length",function(j,h,g){if(parseInt(j.length)>parseInt(h)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("get_unrefunded_amount",function(h,g){return(h-g)/100});Handlebars.registerHelper("check_json_length",function(j,h,g){var l=0;for(var k in j){l++}if(l==parseInt(h)){for(var k in j){return g.fn({property:k,value:j[k],last:true})}}return g.inverse(j)});Handlebars.registerHelper("iterate_json",function(j,h){var g="";var l=0;var k=0;for(var m in j){k++}for(var m in j){l++;if(l==k){g=g+h.fn({property:m,value:j[m],last:true})}else{g=g+h.fn({property:m,value:j[m],last:false})}}console.log(g);return g});Handlebars.registerHelper("get_social_icon",function(g){return get_social_icon(g)});Handlebars.registerHelper("each_with_index",function(n,k){var g="";for(var l=0,h=n.length;l<h;l++){var m=n[l];m.index=l+1;console.log(m);g+=k.fn(m)}return g});Handlebars.registerHelper("if_json",function(j,g){try{var h=$.parseJSON(j);if(typeof h==="object"){return g.fn(this)}return g.inverse(this)}catch(k){return g.inverse(this)}});Handlebars.registerHelper("add_tag",function(g){addTagAgile(g)});Handlebars.registerHelper("set_up_dashboard_padcontent",function(g){return new Handlebars.SafeString(getTemplate("empty-collection-model",CONTENT_JSON.dashboard[g]))});Handlebars.registerHelper("removeSquareBrackets",function(g){return g.replace(/[\[\]]+/g,"")});Handlebars.registerHelper("removeDoubleCoutes",function(j){var g=j.replace(/[\[\]]+/g,"");var h=g.replace(/"/g,"'");return h});Handlebars.registerHelper("toLinkTrigger",function(m,k){var h="";for(var l=0,g=m.length;l<g;l++){h=h+k.fn(m[l]);if(l<g-1){h=h+", "}}return h});Handlebars.registerHelper("millSecondsToMinutes",function(h){if(isNaN(h)){return}var j=h/1000;var g=Math.floor(j/60);if(g<1){return Math.ceil(j)+" secs"}var k=Math.ceil(j%60);return g+" mins, "+k+" secs"});Handlebars.registerHelper("if_overflow",function(k,g,h){if(!k){return}console.log($("#Linkedin").width());k=k.trim();var j=$("<div style='width:"+$("#Linkedin").width()+"px;word-break:normal;word-wrap:break-word;display:none;'>"+k+"</div>");$("#content").append(j);console.log(j.height()+" "+parseInt(g));if(j.height()>parseInt(g)){return h.fn(this)}return h.inverse(this)});Handlebars.registerHelper("setupRating",function(j){var h="";for(var g=0;g<5;g++){if(g<parseInt(j)){h=h.concat('<li style="display: inline;"><img src="img/star-on.png" alt="'+g+'"></li>');continue}h=h.concat('<li style="display: inline;"><img src="img/star-off.png" alt="'+g+'"></li>')}return new Handlebars.SafeString(h)});Handlebars.registerHelper("setupCSVUploadOptions",function(k,n,g){var m;if(k=="contacts"){m=$(getTemplate("csv_upload_options",g))}else{if(k=="company"){m=$(getTemplate("csv_companies_upload_options",g))}else{if(k=="deals"){m=$(getTemplate("csv_deals_options",g))}}}n=n.replace("_"," ");var o=false;var p=0;var l=n.length;var n=n.toLowerCase();var h;var q;m.find("option").each(function(s,t){if($(t).text().toLowerCase().indexOf(n)!=-1){var u=l/$(t).text().length;if(p>=u){return}q=$(t);h=$(t).text();p=u}});console.log(h+", "+n+" : "+p);for(var j=0;j<n.length-3;j++){m.find("option").each(function(s,t){if($(t).text().toLowerCase().indexOf(n.substr(0,n.length-j).toLowerCase())!=-1){console.log(n.substr(0,n.length-j)+" , "+$(t).text());var u=n.substr(0,n.length-j).length/$(t).text().length;console.log(u);if(p>=u){return}q=$(t);h=$(t).text();p=u}})}$(q).attr("selected",true);return new Handlebars.SafeString($("<div>").html(m).html())});Handlebars.registerHelper("convertSecondsToHour",function(k){var h=parseInt(k/3600)%24;var j=parseInt(k/60)%60;var l=k%60;if(h==0&&j==0){return(l+"s")}if(h==0){return(j+"m ")+(l+"s")}var g=(h+"h ")+(j+"m ")+(l+"s");return g});Handlebars.registerHelper("checkOriginalRef",function(h){if(!getCurrentContactProperty(h)){return"unknown"}var g=getCurrentContactProperty(h);g=g.split("/");g=(g[0]+"//"+g[2]);return new Handlebars.SafeString('<a style="text-decoration: none" target="_blank" href="'+getCurrentContactProperty(h)+'">'+g+"</a>")});Handlebars.registerHelper("queryWords",function(o){if(getCurrentContactProperty(o)){var m=getCurrentContactProperty(o);var g="www.google.";var l=m.split("/");l=l[2].slice(0,11);if(l===g){var n=document.createElement("a");n.href=m;var j=n.search;if(j.length>1){j=j.split("&");var k=j.length;for(var h=0;h<k;h++){if(j[h].indexOf("q=")!=-1){j=j[h].split("=");return new Handlebars.SafeString("( Keyword : "+j[1].split("+").join(" ")+" )")}}}}else{return}}});Handlebars.registerHelper("contact_name",function(h,j){if(j==="PERSON"){for(var g=0;g<h.length;g++){if(h[g].name==="last_name"){return(getPropertyValue(h,"first_name")+" "+h[g].value)}else{if(h[g].name==="first_name"){return h[g].value}}}return"Contact"}for(var g=0;g<h.length;g++){if(h[g].name==="name"){return h[g].value}}return"Company"});Handlebars.registerHelper("contact_name_necessary",function(g){return getContactName(g)});Handlebars.registerHelper("is_blank",function(h,g){h=h.trim();if(h==""){return g.fn(h)}else{return g.inverse(h)}});Handlebars.registerHelper("each_with_index1",function(n,k){console.log(n);var g="";for(var l=0,h=n.length;l<h;l++){var m={};m.value=n[l];console.log(m);m.index=l+1;console.log(m);g+=k.fn(m)}return g});Handlebars.registerHelper("if_log_type_equals",function(h,j,k,g){if(h[j]==k){return g.fn(h)}return g.inverse(h)});Handlebars.registerHelper("if_email_sent",function(g,m,p){var h="_aGiLeCrM";if(g[m]==="EMAIL_SENT"){var k=g.message.split(h,4);var n={};if(k===undefined){return p.inverse(g)}for(var j=0;j<k.length;j++){var o=k[j].split(":");var m=o[0];m=m.trim();var l=o.slice(1).join(":");l=l.trim();n[m]=l}n.time=g.time;return p.fn(n)}return p.inverse(g)});Handlebars.registerHelper("remove_spaces",function(g){return g.replace(/ +/g,"")});Handlebars.registerHelper("replace_spaces",function(g){return g.replace(/ +/g,"_")});Handlebars.registerHelper("if_same_campaign",function(k,n,j){var h=k[n];if(n===undefined||h===undefined){return}var m=getIdFromHash();for(var l=0,g=h.length;l<g;l++){if(h[l].campaign_id===m){return j.fn(h[l])}}});Handlebars.registerHelper("if_other_active_campaigns",function(h,k,p){if(h===undefined||h[k]===undefined){return}var g={};var l=[];var n=[];var q=h[k];var o=getIdFromHash();for(var j=0,m=q.length;j<m;j++){if(o===q[j].campaign_id){continue}if(q[j].status.indexOf("ACTIVE")!==-1){l.push(q[j])}if(q[j].status.indexOf("DONE")!==-1){n.push(q[j])}}g.active=l;g.done=n;return p.fn(g)});Handlebars.registerHelper("contact_model",function(g){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){if(CONTACT_ASSIGNED_TO_CAMPAIGN){CONTACT_ASSIGNED_TO_CAMPAIGN=false;var h=$.ajax({type:"GET",url:"/core/api/contacts/"+App_Contacts.contactDetailView.model.get("id"),async:false,dataType:"json"}).responseText;App_Contacts.contactDetailView.model.set(JSON.parse(h));return g.fn(JSON.parse(h))}return g.fn(App_Contacts.contactDetailView.model.toJSON())}});Handlebars.registerHelper("contact_campaigns",function(k,l,o){if(k===undefined||k[l]===undefined){return}var g={};var j=[];var h=[];var p=k[l];for(var m=0,n=p.length;m<n;m++){if(p[m].status.indexOf("ACTIVE")!==-1){j.push(p[m])}if(p[m].status.indexOf("DONE")!==-1){h.push(p[m])}}g.active=j;g.done=h;return o.fn(g)});Handlebars.registerHelper("if_more_urls",function(m,k,h){var g=3;var n=[];var l={};if(k<g){return h.inverse(m)}for(var j=0;j<m.length;j++){if(j===g){break}n.push(m[j])}l.urls=n;l.more=k-g;return h.fn(l)});Handlebars.registerHelper("normalize_os",function(g){if(g===undefined||g.indexOf("_")===-1){return g}return g.split("_")[0]});Handlebars.registerHelper("safe_tweet",function(g){g=g.trim();return new Handlebars.SafeString(g)});Handlebars.registerHelper("get_stream_icon",function(h){if(!h){return}var g={Home:"icon-home",Retweets:"icon-retweet",DM_Inbox:"icon-download-alt",DM_Outbox:"icon-upload-alt",Favorites:"icon-star",Sent:"icon-share-alt",Search:"icon-search",Scheduled:"icon-time",All_Updates:"icon-home",My_Updates:"icon-share-alt"};h=h.trim();if(g[h]){return g[h]}return"icon-globe"});Handlebars.registerHelper("get_normal_name",function(h){if(!h){return}var g={HIGH:"High",LOW:"Low",NORMAL:"Normal",EMAIL:"Email",CALL:"Call",SEND:"Send",TWEET:"Tweet",FOLLOW_UP:"Follow Up",MEETING:"Meeting",MILESTONE:"Milestone",OTHER:"Other",YET_TO_START:"Yet To Start",IN_PROGRESS:"In Progress",COMPLETED:"Completed",TODAY:"Today",TOMORROW:"Tomorrow",OVERDUE:"Overdue",LATER:"Later"};h=h.trim();if(g[h]){return g[h]}return h});Handlebars.registerHelper("user_location",function(){var g=this.city=="?"?"":(this.city+", ");var j=this.region=="?"?"":(this.region+", ");var h=this.country;if(this.city=="?"&&this.region=="?"){h=this.country=="?"?this.city_lat_long:(this.city_lat_long+" ( "+this.country+" )")}return(g+j+h).trim()});Handlebars.registerHelper("trim_space",function(g){if(g===undefined){return g}return g.trim()});Handlebars.registerHelper("get_subaccount_reputation",function(j){var h="";var g="Unknown";if(j>1&&j<40){h="important";g="Poor"}else{if(j>=40&&j<75){h="";g="Ok"}else{if(j>=75&&j<90){h="success";g="Good"}else{if(j>=90){h="success";g="Excellent"}}}}return"<span style='font-size:13px;position: relative;top: -3px' class='label label-"+h+"'>"+g+"</span> <!--<span class='badge badge-"+h+"'>"+j+"</span>-->"});Handlebars.registerHelper("get_id_from_hash",function(){return getIdFromHash()});Handlebars.registerHelper("get_subscribers_type_from_hash",function(){var g=window.location.hash.substr(1);if(g.indexOf("all")!=-1){return"All"}if(g.indexOf("active")!=-1){return"Active"}if(g.indexOf("completed")!=-1){return"Completed"}if(g.indexOf("removed")!=-1){return"Removed"}if(g.indexOf("unsubscribed")!=-1){return"Unsubscribed"}if(g.indexOf("hardbounced")!=-1){return"Hard Bounced"}if(g.indexOf("softbounced")!=-1){return"Soft Bounced"}if(g.indexOf("spam-reported")!=-1){return"Spam Reported"}});Handlebars.registerHelper("check_plan",function(h,g){console.log(h);
if(!_billing_restriction){return g.fn(this)}if(_billing_restriction.currentLimits.planName==h){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("isSafariBrowser",function(g){if(navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Chrome")===-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("xeroType",function(g){return(g=="ACCPAY")?"Payable":"Receivable"});Handlebars.registerHelper("xeroTypeToolTip",function(g){return(g=="ACCPAY")?"Payable":"Receivable"});Handlebars.registerHelper("capFirstLetter",function(h){if(h==="DEFAULT"){return""}else{var g=h.toLowerCase();return g.charAt(0).toUpperCase()+g.slice(1)}});Handlebars.registerHelper("qbStatus",function(g){console.log(this);console.log(this.TotalAmt);if(g==0){return"Paid"}else{return"Due"}});Handlebars.registerHelper("currencyFormat",function(g){return Number(g).toLocaleString("en")});Handlebars.registerHelper("QbDateFormat",function(h){var g=[];g=h.split("-");return g[0]+"-"+g[2]+"-"+g[1]});Handlebars.registerHelper("hasScope",function(g,h){if(CURRENT_DOMAIN_USER.scopes&&$.inArray(g,CURRENT_DOMAIN_USER.scopes)!=-1){return h.fn(this)}return h.inverse(this)});Handlebars.registerHelper("hasMenuScope",function(g,h){if(CURRENT_DOMAIN_USER.menu_scopes&&$.inArray(g,CURRENT_DOMAIN_USER.menu_scopes)!=-1){return h.fn(this)}return h.inverse(this)});Handlebars.registerHelper("canSyncContacts",function(g){if(canImportContacts()){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("hasMenuScope",function(h,g){if((CURRENT_DOMAIN_USER.menu_scopes).indexOf(h)!=-1){return g.fn(this)}else{return g.inverse(this)}});Handlebars.registerHelper("fetchXeroUser",function(g){return JSON.parse(g).xeroemail});Handlebars.registerHelper("getfbreturndomain",function(h){var g=window.location.href.split("/");return g[2]});Handlebars.registerHelper("tagManagementCollectionSetup",function(j){console.log(j);var m={};var n=[];for(var l=0;l<j.length;l++){var h=j[l].tag;var k=h.charAt(0).toUpperCase();if(jQuery.inArray(k,n)==-1){n.push(k)}}console.log(n);var g="";for(var l=0;l<n.length;l++){g+="<div class=\"clearfix\"></div><div style='margin-right:10px;'><div class='tag-key tag-management-key'>"+n[l]+'</div><div class="clearfix"></div><div class=\'left\' tag-alphabet="'+encodeURI(n[l])+'"><ul class="tags-management tag-cloud" style="list-style:none;"></ul></div></div>'}console.log(g);return new Handlebars.SafeString(g)});Handlebars.registerHelper("containsScope",function(h,j,g){if(j.length==0||!h){return g.inverse(this)}if(jQuery.inArray(h,j)==-1){return g.inverse(this)}return g.fn(this)});Handlebars.registerHelper("isOwnerOfContact",function(h,g){if(CURRENT_DOMAIN_USER.id==h){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("canEditContact",function(h,g){if(canEditContact(h)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("canEditCurrentContact",function(h,g){if(canEditCurrentContact()){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("gateway_exists",function(k,l,h){for(var j=0;j<l.length;j++){var g=JSON.parse(l[j].prefs);if(l[j].name=="EmailGateway"){if(g.email_api==k){return h.fn(l[j])}}if(l[j].name=="SMS-Gateway"){if(g.sms_api==k){return h.fn(l[j])}}}return h.inverse(this)});Handlebars.registerHelper("each_index_slice",function(m,j,h){var g="";for(var k=j;k<m.length;k++){var l=m[k];console.log(l);g+=h.fn(l)}return g});Handlebars.registerHelper("gateway_exists",function(k,l,h){for(var j=0;j<l.length;j++){var g=JSON.parse(l[j].prefs);if(l[j].name=="EmailGateway"){if(g.email_api==k){return h.fn(l[j])}}if(l[j].name=="SMS-Gateway"){if(g.sms_api==k){return h.fn(l[j])}}}return h.inverse(this)});Handlebars.registerHelper("isOwnerOfContact",function(h,g){if(CURRENT_DOMAIN_USER.id==h){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("canEditContact",function(h,g){if((hasScope("UPDATE_CONTACTS")||hasScope("DELETE_CONTACTS"))||CURRENT_DOMAIN_USER.id==h){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("getAccountPlanName",function(g){if(!g){return"Free"}var h=g.split("_");return ucfirst(h[0])});Handlebars.registerHelper("getAccountPlanInteval",function(g){if(!g){return"Monthly"}var h=g.split("_");return ucfirst(h[1])});Handlebars.registerHelper("getSubscriptionBasedOnPlan",function(k,j,g){var h=getSubscriptionWithAmount(k,j);if(h!=null){return g.fn(h)}return g.inverse(this)});Handlebars.registerHelper("iso_date_to_normalizeDate",function(h){if(h.length<=0){return}var g=h.split("T");console.log("normalize date "+g[0]);return g[0]});Handlebars.registerHelper("getMonthFromIndex",function(h){var g=["January","february","March","April","May","June","July","August","September","October","November","December"];if(h>12){return g[11]}return g[h-1]});Handlebars.registerHelper("xeroOrganisationShortCode",function(g){if(typeof SHORT_CODE=="undefined"||SHORT_CODE==""){return false}else{return SHORT_CODE}});Handlebars.registerHelper("if_id",function(h,g){if(this.type==h){return g.fn(this)}});Handlebars.registerHelper("getTime",function(j){if(!j){return}if((j/100000000000)>1){var l=new Date(parseInt(j));var g=l.getHours();if(g>12){g=g-12}var k=l.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";return g+":"+k+" "+h}var l=new Date(parseInt(j)*1000);var g=l.getHours();if(g>12){g=g-12}var k=l.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";return g+":"+k+" "+h});Handlebars.registerHelper("getCustomDateWithTime",function(n,g){var m=b(n);var l=b(g);var j=d(n);var h=d(g);var k=c(g);if(m!=l){return j+" - "+h}else{return j+" - "+k}});function d(k){var g=["Jan","Feb","March","April","May","Jun","July","Aug","Sept","Oct","Nov","Dec"];if(!k){return}if((k/100000000000)>1){var o=new Date(parseInt(k));var h=o.getHours();var m=o.getFullYear();var k=o.getDate();var n=o.getMonth();var l=o.getMinutes();if(l==0){l="00"}var j=h>=12?"PM":"AM";if(h>12){h=h-12}return g[n]+" "+k+", "+m+" "+h+":"+l+" "+j}var o=new Date(parseInt(k)*1000);var h=o.getHours();var m=o.getFullYear();var k=o.getDate();var n=o.getMonth();var l=o.getMinutes();if(l==0){l="00"}var j=h>=12?"PM":"AM";if(h>12){h=h-12}return g[n]+" "+k+", "+m+" "+h+":"+l+" "+j}function c(j){if(!j){return}if((j/100000000000)>1){var l=new Date(parseInt(j));var g=l.getHours();var k=l.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";if(g>12){g=g-12}return g+":"+k+" "+h}var l=new Date(parseInt(j)*1000);var g=l.getHours();var k=l.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";if(g>12){g=g-12}return g+":"+k+" "+h}function b(g){if((g/100000000000)>1){var h=new Date(parseInt(g));return h.getDate()}else{var h=new Date(parseInt(g)*1000);return h.getDate()}}Handlebars.registerHelper("buildOptions",function(j){var g=j.split(";");var h="";$.each(g,function(k,l){if(l!=""){h=h.concat('<option value="'+l+'">'+l+"</option>")}});return h});Handlebars.registerHelper("address_Template",function(k){for(var j=0,h=k.length;j<h;j++){if(k[j].name=="address"){var m="";var g={};try{g=JSON.parse(k[j].value)}catch(o){g.address=k[j].value}var n=countJsonProperties(g);$.each(g,function(l,p){if(--n==0){m=m.concat(p+".");return}m=m.concat(p+", ")});return new Handlebars.SafeString(m)}}});Handlebars.registerHelper("related_to_contacts",function(k,g){var h="";var j=k.length;$.each(k,function(m,n){var l=getTemplate("related-to-contacts",n);if(--j==0){h=h.concat(l);return}h=h.concat(l+", ")});return new Handlebars.SafeString(h)});Handlebars.registerHelper("related_to_one",function(k,g){var h="";var j=k.length;$.each(k,function(m,n){if(m<=3){var l=getTemplate("related-to-contacts",n);if(--j==0||m==3){h=h.concat(l);return}h=h.concat(l+", ")}});return new Handlebars.SafeString(h)});Handlebars.registerHelper("numberWithCommas",function(g){if(g){return g.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}});Handlebars.registerHelper("field_Element",function(g){var h="";var j=g.length;$.each(g,function(k,l){if(l.indexOf("properties_")!=-1){l=l.split("properties_")[1]}else{if(l.indexOf("custom_")!=-1){l=l.split("custom_")[1]}else{if(l.indexOf("CUSTOM_")!=-1){l=l.split("CUSTOM_")[1]}else{if(l=="created_time"){l="Created Date"}else{if(l=="updated_time"){l="Updated Date"}}}}}l=l.replace("_"," ");if(--j==0){h=h.concat(l);return}h=h.concat(l+", ")});return new Handlebars.SafeString(h)});Handlebars.registerHelper("stringToJSON",function(h,j,g){console.log(h);console.log(j);if(j){try{h[j]=JSON.parse(h[j])}finally{return g.fn(h[j])}}try{return g.fn(JSON.parse(h))}catch(k){return g.fn(h)}});Handlebars.registerHelper("if_propertyName",function(j,g){for(var h=0;h<this.properties.length;h++){if(this.properties[h].name==j){return g.fn(this.properties[h])}}return g.inverse(this)});Handlebars.registerHelper("getCompanyImage",function(l,k){var g=parseInt(l);var j=4+((g-32)/2);var n="src='img/company.png' style='width:"+g+"px; height="+g+"px;"+k+"'";var h="";for(var m=0;m<this.properties.length;m++){if(this.properties[m].name=="image"){n="src='"+this.properties[m].value+"' style='width:"+g+"px; height="+g+"px;"+k+";'";h="this.src='img/company.png'; this.onerror=null;";break}if(this.properties[m].name=="url"){n="src='https://www.google.com/s2/favicons?domain="+this.properties[m].value+"' style='width:32px; height:32px; padding:"+j+"px; "+k+" ;'";h="this.src='img/company.png'; $(this).css('width','"+l+"px'); $(this).css('height','"+l+"px');$(this).css('padding','4px'); this.onerror=null;"}}return new Handlebars.SafeString(n+' onError="'+h+'"')});Handlebars.registerHelper("getHyperlinkFromURL",function(g){if(g.match(/((http|http[s]|ftp|file):\/\/)/)!=null){return g}return"http://"+g});Handlebars.registerHelper("getSkypeURL",function(g){if(g.match("skype:")!=null){return g}return"skype:"+g});Handlebars.registerHelper("getFacebookURL",function(g){return g.replace("@","")});Handlebars.registerHelper("count",function(){return getCount(this)});Handlebars.registerHelper("contacts_count",function(){var g;if(this[0]&&this[0].count&&(this[0].count!=-1)){if(this[0].count>9999&&(readCookie("contact_filter")||readData("dynamic_contact_filter"))){g="<small> ("+10000+'+ Total) </small><span style="vertical-align: text-top; margin-left: -5px"><img border="0" src="/img/help.png"style="height: 10px; vertical-align: middle" rel="popover"data-placement="bottom" data-title="Lead Score"data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."id="element" data-trigger="hover"></span>'
}else{g="<small> ("+this[0].count+" Total) </small>"}}else{g="<small> ("+this.length+" Total) </small>"}return new Handlebars.SafeString(g)});Handlebars.registerHelper("duplicate_contacts_count",function(){var h;if(this[0]&&this[0].count&&(this[0].count!=-1)){var g=this[0].count-1;h="<small> ("+g+" Total) </small>"}else{h="<small> ("+this.length+" Total) </small>"}return new Handlebars.SafeString(h)});Handlebars.registerHelper("subscribers_count",function(){if(this[0]&&this[0].count&&(this[0].count!=-1)){return this[0].count}return this.length});Handlebars.registerHelper("toLowerCase",function(g){if(!g){return}return g.toLowerCase()});Handlebars.registerHelper("toUpperCase",function(g){if(!g){return}return g.toUpperCase()});Handlebars.registerHelper("if_contact_type",function(h,g){if(this.type==h){return g.fn(this)}});Handlebars.registerHelper("collection_contact_type",function(h,g){if(this&&this[0]&&this[0].type==h){return g.fn(this)}});Handlebars.registerHelper("wrap_entity",function(h,g){if(h){return g.fn(h)}});Handlebars.registerHelper("tl_log_string",function(g){return g.replace("Sending email From:","Email sent From:")});Handlebars.registerHelper("lead_score",function(g){if(this.lead_score>0){return this.lead_score}else{return""}});Handlebars.registerHelper("task_status",function(g){if(g){return true}return"false"});Handlebars.registerHelper("if_equals",function(h,j,g){if((typeof j==="undefined")||(typeof h==="undefined")){return g.inverse(this)}if(h.toString().trim()==j.toString().trim()){return g.fn(this)}else{return g.inverse(this)}});Handlebars.registerHelper("if_not_equals",function(h,j,g){if((typeof j==="undefined")||(typeof h==="undefined")){return g.inverse(this)}if(h.toString().trim()!=j.toString().trim()){return g.fn(this)}else{return g.inverse(this)}});Handlebars.registerHelper("if_greater",function(h,j,g){if(parseInt(j)>h){return g.inverse(this)}else{return g.fn(this)}});Handlebars.registerHelper("if_less_than",function(h,j,g){if(j<h){return g.inverse(this)}else{return g.fn(this)}});Handlebars.registerHelper("campaigns_heading",function(h,g){var j=0;if(h&&h[0]&&h[0].count){j=h[0].count}if(j<=20){return"Workflows"}return"("+j+" Total)"});Handlebars.registerHelper("show_custom_fields",function(j,g){var h=show_custom_fields_helper(j,g);return new Handlebars.SafeString(fill_custom_field_values($(h),g))});Handlebars.registerHelper("is_link",function(h,g){var j=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;if(h.search(j)!=-1){return g.fn(this)}else{return g.inverse(this)}});Handlebars.registerHelper("show_link_in_statement",function(h){var j=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;try{h=h.replace(j,"<a href='$1' target='_blank' class='cd_hyperlink'>$1</a>");return new Handlebars.SafeString(h)}catch(g){return h}});Handlebars.registerHelper("displayPlan",function(g){return ucfirst(g).replaceAll("_"," ")});Handlebars.registerHelper("displayPlainText",function(g){return ucfirst(g).replace("_"," ")});Handlebars.registerHelper("getCurrentContactProperty",function(h){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var g=App_Contacts.contactDetailView.model.get("properties");console.log(App_Contacts.contactDetailView.model.toJSON());return getPropertyValue(g,h)}});Handlebars.registerHelper("safe_string",function(g){g=g.replace(/\n/,"<br/>");return new Handlebars.SafeString(g)});Handlebars.registerHelper("string_to_date",function(h,g){return new Date(g).format(h)});Handlebars.registerHelper("isArray",function(h,g){if(isArray(h)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("is_string",function(h,g){if(typeof h=="string"){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("bindData",function(g){return JSON.stringify(g)});Handlebars.registerHelper("getCurrentUserPrefs",function(g){if(CURRENT_USER_PREFS){}return g.fn(CURRENT_USER_PREFS)});Handlebars.registerHelper("getCurrentDomain",function(h){var g=window.location.host;var j=/(\.)/;if(g.search(j)>=0){return g.split(j)[0]}return" "});Handlebars.registerHelper("date-range",function(j,h,k){var l=Date.parse(j);var g=Date.today().add({days:parseInt(h)});return g.toString("MMMM d, yyyy")+" - "+l.toString("MMMM d, yyyy")});Handlebars.registerHelper("extractEmail",function(h,g){console.log(h);return g.fn(h.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)[0])});Handlebars.registerHelper("getCurrentContactPropertyBlock",function(j,h){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var g=App_Contacts.contactDetailView.model.get("properties");console.log(App_Contacts.contactDetailView.model.toJSON());return h.fn(getPropertyValue(g,j))}});Handlebars.registerHelper("isDuplicateContactProperty",function(l,k,j){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var h=App_Contacts.contactDetailView.model.get("properties");var g=getPropertyValue(h,k);var m=getPropertyValue(l,k);if(!g||!m){g=getPropertyValue(h,"first_name")+" "+getPropertyValue(h,"last_name");m=getPropertyValue(l,"first_name")+" "+getPropertyValue(l,"last_name")}if(g==m){return j.fn(this)}return j.inverse(this)}});Handlebars.registerHelper("containString",function(h,j,g){if(j.search(h)!=-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("is_emailPlan",function(h,g){if(h.search("email")!=-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("is_userPlan",function(h,g){if(h.search("email")!=-1){return g.inverse(this)}return g.fn(this)});Handlebars.registerHelper("numeric_operation",function(k,j,h){var g="/*-+";if(g.indexOf(h)==-1){return""}if(h=="+"){return k+j}if(h=="-"){return k-j}if(h=="*"){return k*j}if(h=="/"){return k/j}});Handlebars.registerHelper("get_total_amount",function(h,g){return(h/100)*g});Handlebars.registerHelper("check_length",function(j,h,g){if(parseInt(j.length)>parseInt(h)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("check_json_length",function(j,h,g){var l=0;for(var k in j){l++}if(l==parseInt(h)){for(var k in j){return g.fn({property:k,value:j[k],last:true})}}return g.inverse(j)});Handlebars.registerHelper("iterate_json",function(j,h){var g="";var l=0;var k=0;for(var m in j){k++}for(var m in j){l++;if(l==k){g=g+h.fn({property:m,value:j[m],last:true})}else{g=g+h.fn({property:m,value:j[m],last:false})}}console.log(g);return g});Handlebars.registerHelper("get_social_icon",function(g){return get_social_icon(g)});Handlebars.registerHelper("each_with_index",function(n,k){var g="";for(var l=0,h=n.length;l<h;l++){var m=n[l];m.index=l+1;console.log(m);g+=k.fn(m)}return g});Handlebars.registerHelper("if_json",function(j,g){try{var h=$.parseJSON(j);if(typeof h==="object"){return g.fn(this)}return g.inverse(this)}catch(k){return g.inverse(this)}});Handlebars.registerHelper("add_tag",function(g){addTagAgile(g)});Handlebars.registerHelper("set_up_dashboard_padcontent",function(g){return new Handlebars.SafeString(getTemplate("empty-collection-model",CONTENT_JSON.dashboard[g]))});Handlebars.registerHelper("removeSquareBrackets",function(g){return g.replace(/[\[\]]+/g,"")});Handlebars.registerHelper("removeDoubleCoutes",function(j){var g=j.replace(/[\[\]]+/g,"");var h=g.replace(/"/g,"'");return h});Handlebars.registerHelper("toLinkTrigger",function(m,k){var h="";for(var l=0,g=m.length;l<g;l++){h=h+k.fn(m[l]);if(l<g-1){h=h+","}}return h});Handlebars.registerHelper("millSecondsToMinutes",function(h){if(isNaN(h)){return}var j=h/1000;var g=Math.floor(j/60);if(g<1){return Math.ceil(j)+" secs"}var k=Math.ceil(j%60);return g+" mins, "+k+" secs"});Handlebars.registerHelper("if_overflow",function(k,g,h){if(!k){return}console.log($("#Linkedin").width());k=k.trim();var j=$("<div style='width:"+$("#Linkedin").width()+"px;word-break:normal;word-wrap:break-word;display:none;'>"+k+"</div>");$("#content").append(j);console.log(j.height()+" "+parseInt(g));if(j.height()>parseInt(g)){return h.fn(this)}return h.inverse(this)});Handlebars.registerHelper("setupRating",function(j){var h="";for(var g=0;g<5;g++){if(g<parseInt(j)){h=h.concat('<li style="display: inline;"><img src="img/star-on.png" alt="'+g+'"></li>');continue}h=h.concat('<li style="display: inline;"><img src="img/star-off.png" alt="'+g+'"></li>')}return new Handlebars.SafeString(h)});Handlebars.registerHelper("setupCSVUploadOptions",function(k,n,g){var m;if(k=="contacts"){m=$(getTemplate("csv_upload_options",g))}else{if(k=="company"){m=$(getTemplate("csv_companies_upload_options",g))}else{if(k=="deals"){m=$(getTemplate("csv_deals_options",g))}}}n=n.replace("_"," ");var o=false;var p=0;var l=n.length;var n=n.toLowerCase();var h;var q;m.find("option").each(function(s,t){if($(t).text().toLowerCase().indexOf(n)!=-1){var u=l/$(t).text().length;if(p>=u){return}q=$(t);h=$(t).text();p=u}});console.log(h+", "+n+" : "+p);for(var j=0;j<n.length-3;j++){m.find("option").each(function(s,t){if($(t).text().toLowerCase().indexOf(n.substr(0,n.length-j).toLowerCase())!=-1){console.log(n.substr(0,n.length-j)+" , "+$(t).text());var u=n.substr(0,n.length-j).length/$(t).text().length;console.log(u);if(p>=u){return}q=$(t);h=$(t).text();p=u}})}$(q).attr("selected",true);return new Handlebars.SafeString($("<div>").html(m).html())});Handlebars.registerHelper("convertSecondsToHour",function(k){var h=parseInt(k/3600)%24;var j=parseInt(k/60)%60;var l=k%60;if(h==0&&j==0){return(l+"s")}if(h==0){return(j+"m ")+(l+"s")}var g=(h+"h ")+(j+"m ")+(l+"s");return g});Handlebars.registerHelper("checkOriginalRef",function(h){if(!getCurrentContactProperty(h)){return"unknown"}var g=getCurrentContactProperty(h);g=g.split("/");g=(g[0]+"//"+g[2]);return new Handlebars.SafeString('<a style="text-decoration: none" target="_blank" href="'+getCurrentContactProperty(h)+'">'+g+"</a>")});Handlebars.registerHelper("queryWords",function(o){if(getCurrentContactProperty(o)){var m=getCurrentContactProperty(o);var g="www.google.";var l=m.split("/");l=l[2].slice(0,11);
if(l===g){var n=document.createElement("a");n.href=m;var j=n.search;if(j.length>1){j=j.split("&");var k=j.length;for(var h=0;h<k;h++){if(j[h].indexOf("q=")!=-1){j=j[h].split("=");return new Handlebars.SafeString("( Keyword : "+j[1].split("+").join(" ")+" )")}}}}else{return}}});Handlebars.registerHelper("contact_name",function(h,j){if(j==="PERSON"){for(var g=0;g<h.length;g++){if(h[g].name==="last_name"){return(getPropertyValue(h,"first_name")+" "+h[g].value)}else{if(h[g].name==="first_name"){return h[g].value}}}return"Contact"}for(var g=0;g<h.length;g++){if(h[g].name==="name"){return h[g].value}}return"Company"});Handlebars.registerHelper("contact_name_necessary",function(g){return getContactName(g)});Handlebars.registerHelper("is_blank",function(h,g){h=h.trim();if(h==""){return g.fn(h)}else{return g.inverse(h)}});Handlebars.registerHelper("each_with_index1",function(n,k){console.log(n);var g="";for(var l=0,h=n.length;l<h;l++){var m={};m.value=n[l];console.log(m);m.index=l+1;console.log(m);g+=k.fn(m)}return g});Handlebars.registerHelper("if_log_type_equals",function(h,j,k,g){if(h[j]==k){return g.fn(h)}return g.inverse(h)});Handlebars.registerHelper("if_email_sent",function(g,m,p){var h="_aGiLeCrM";if(g[m]==="EMAIL_SENT"){var k=g.message.split(h,4);var n={};if(k===undefined){return p.inverse(g)}for(var j=0;j<k.length;j++){var o=k[j].split(":");var m=o[0];m=m.trim();var l=o.slice(1).join(":");l=l.trim();n[m]=l}n.time=g.time;return p.fn(n)}return p.inverse(g)});Handlebars.registerHelper("remove_spaces",function(g){return g.replace(/ +/g,"")});Handlebars.registerHelper("replace_spaces",function(g){return g.replace(/ +/g,"_")});Handlebars.registerHelper("if_same_campaign",function(k,n,j){var h=k[n];if(n===undefined||h===undefined){return}var m=getIdFromHash();for(var l=0,g=h.length;l<g;l++){if(h[l].campaign_id===m){return j.fn(h[l])}}});Handlebars.registerHelper("if_other_active_campaigns",function(h,k,p){if(h===undefined||h[k]===undefined){return}var g={};var l=[];var n=[];var q=h[k];var o=getIdFromHash();for(var j=0,m=q.length;j<m;j++){if(o===q[j].campaign_id){continue}if(q[j].status.indexOf("ACTIVE")!==-1){l.push(q[j])}if(q[j].status.indexOf("DONE")!==-1){n.push(q[j])}}g.active=l;g.done=n;return p.fn(g)});Handlebars.registerHelper("contact_model",function(g){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){if(CONTACT_ASSIGNED_TO_CAMPAIGN){CONTACT_ASSIGNED_TO_CAMPAIGN=false;var h=$.ajax({type:"GET",url:"/core/api/contacts/"+App_Contacts.contactDetailView.model.get("id"),async:false,dataType:"json"}).responseText;App_Contacts.contactDetailView.model.set(JSON.parse(h));return g.fn(JSON.parse(h))}return g.fn(App_Contacts.contactDetailView.model.toJSON())}});Handlebars.registerHelper("contact_campaigns",function(k,l,o){if(k===undefined||k[l]===undefined){return}var g={};var j=[];var h=[];var p=k[l];for(var m=0,n=p.length;m<n;m++){if(p[m].status.indexOf("ACTIVE")!==-1){j.push(p[m])}if(p[m].status.indexOf("DONE")!==-1){h.push(p[m])}}g.active=j;g.done=h;return o.fn(g)});Handlebars.registerHelper("if_more_urls",function(m,k,h){var g=3;var n=[];var l={};if(k<g){return h.inverse(m)}for(var j=0;j<m.length;j++){if(j===g){break}n.push(m[j])}l.urls=n;l.more=k-g;return h.fn(l)});Handlebars.registerHelper("normalize_os",function(g){if(g===undefined||g.indexOf("_")===-1){return g}return g.split("_")[0]});Handlebars.registerHelper("safe_tweet",function(g){g=g.trim();return new Handlebars.SafeString(g)});Handlebars.registerHelper("get_stream_icon",function(h){if(!h){return}var g={Home:"icon-home",Retweets:"icon-retweet",DM_Inbox:"icon-download-alt",DM_Outbox:"icon-upload-alt",Favorites:"icon-star",Sent:"icon-share-alt",Search:"icon-search",Scheduled:"icon-time",All_Updates:"icon-home",My_Updates:"icon-share-alt"};h=h.trim();if(g[h]){return g[h]}return"icon-globe"});Handlebars.registerHelper("get_normal_name",function(h){if(!h){return}var g={HIGH:"High",LOW:"Low",NORMAL:"Normal",EMAIL:"Email",CALL:"Call",SEND:"Send",TWEET:"Tweet",FOLLOW_UP:"Follow Up",MEETING:"Meeting",MILESTONE:"Milestone",OTHER:"Other",YET_TO_START:"Yet To Start",IN_PROGRESS:"In Progress",COMPLETED:"Completed",TODAY:"Today",TOMORROW:"Tomorrow",OVERDUE:"Overdue",LATER:"Later"};h=h.trim();if(g[h]){return g[h]}return h});Handlebars.registerHelper("get_normal_activity_type",function(h){if(!h){return}var g={DEAL_ADD:"Deal Created",DEAL_EDIT:"Deal Edited",DEAL_CLOSE:"Deal Closed",DEAL_LOST:"Deal Lost",DEAL_RELATED_CONTACTS:" Deal Contacts Changed",DEAL_OWNER_CHANGE:"Deal Owner Changed",DEAL_MILESTONE_CHANGE:"Deal Milestone Changed",DEAL_ARCHIVE:"Deal Archived",DEAL_RESTORE:"Deal Restored",NOTE_ADD:"Note Added",TASK_ADD:"Task Created",TASK_EDIT:"Task Updated",TASK_PROGRESS_CHANGE:"Progress Changed",TASK_OWNER_CHANGE:"Owner Changed",TASK_STATUS_CHANGE:"Status Changed",TASK_COMPLETED:"Task Completed",TASK_DELETE:"Task Deleted",TASK_RELATED_CONTACTS:"Contacts Modified"};h=h.trim();if(g[h]){return g[h]}return h});Handlebars.registerHelper("user_location",function(){var g=this.city=="?"?"":(this.city+", ");var j=this.region=="?"?"":(this.region+", ");var h=this.country;if(this.city=="?"&&this.region=="?"){h=this.country=="?"?this.city_lat_long:(this.city_lat_long+" ( "+this.country+" )")}return(g+j+h).trim()});Handlebars.registerHelper("trim_space",function(g){if(g===undefined){return g}return g.trim()});Handlebars.registerHelper("get_subaccount_reputation",function(j){var h="";var g="Unknown";if(j>1&&j<40){h="important";g="Poor"}else{if(j>=40&&j<75){h="";g="Ok"}else{if(j>=75&&j<90){h="success";g="Good"}else{if(j>=90){h="success";g="Excellent"}}}}return"<span style='top: -3px' class='text-sm pos-rlt label label-"+h+"'>"+g+"</span> <!--<span class='badge badge-"+h+"'>"+j+"</span>-->"});Handlebars.registerHelper("get_id_from_hash",function(){return getIdFromHash()});Handlebars.registerHelper("get_subscribers_type_from_hash",function(){var g=window.location.hash.substr(1);if(g.indexOf("all")!=-1){return"All"}if(g.indexOf("active")!=-1){return"Active"}if(g.indexOf("completed")!=-1){return"Completed"}if(g.indexOf("removed")!=-1){return"Removed"}if(g.indexOf("unsubscribed")!=-1){return"Unsubscribed"}if(g.indexOf("hardbounced")!=-1){return"Hard Bounced"}if(g.indexOf("softbounced")!=-1){return"Soft Bounced"}if(g.indexOf("spam-reported")!=-1){return"Spam Reported"}});Handlebars.registerHelper("check_plan",function(h,g){console.log(h);if(!_billing_restriction){return g.fn(this)}if(_billing_restriction.currentLimits.planName==h){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("isSafariBrowser",function(g){if(navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Chrome")===-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("xeroType",function(g){return(g=="ACCPAY")?"Payable":"Receivable"});Handlebars.registerHelper("xeroTypeToolTip",function(g){return(g=="ACCPAY")?"Payable":"Receivable"});Handlebars.registerHelper("capFirstLetter",function(h){if(h==="DEFAULT"){return""}else{var g=h.toLowerCase();return g.charAt(0).toUpperCase()+g.slice(1)}});Handlebars.registerHelper("qbStatus",function(g){console.log(this);console.log(this.TotalAmt);if(g==0){return"Paid"}else{return"Due"}});Handlebars.registerHelper("currencyFormat",function(g){return Number(g).toLocaleString("en")});Handlebars.registerHelper("QbDateFormat",function(h){var g=[];g=h.split("-");return g[0]+"-"+g[2]+"-"+g[1]});Handlebars.registerHelper("hasScope",function(g,h){if(CURRENT_DOMAIN_USER.scopes&&$.inArray(g,CURRENT_DOMAIN_USER.scopes)!=-1){return h.fn(this)}return h.inverse(this)});Handlebars.registerHelper("hasMenuScope",function(g,h){if(CURRENT_DOMAIN_USER.menu_scopes&&$.inArray(g,CURRENT_DOMAIN_USER.menu_scopes)!=-1){return h.fn(this)}return h.inverse(this)});Handlebars.registerHelper("canSyncContacts",function(g){if(canImportContacts()){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("hasMenuScope",function(h,g){if((CURRENT_DOMAIN_USER.menu_scopes).indexOf(h)!=-1){return g.fn(this)}else{return g.inverse(this)}});Handlebars.registerHelper("fetchXeroUser",function(g){return JSON.parse(g).xeroemail});Handlebars.registerHelper("isContactType",function(j,h,g){if(!j&&h=="PERSON"){return g.fn(this)}else{if(j==h){return g.fn(this)}}return g.inverse(this)});Handlebars.registerHelper("getfbreturndomain",function(h){var g=window.location.href.split("/");return g[2]});Handlebars.registerHelper("tagManagementCollectionSetup",function(j){console.log(j);var m={};var n=[];for(var l=0;l<j.length;l++){var h=j[l].tag;var k=h.charAt(0).toUpperCase();if(jQuery.inArray(k,n)==-1){n.push(k)}}console.log(n);var g="";for(var l=0;l<n.length;l++){g+="<div class=\"clearfix\"></div><div style='margin-right:10px;'><div class='tag-key tag-management-key'>"+n[l]+'</div><div class="clearfix"></div><div class=\'left\' tag-alphabet="'+encodeURI(n[l])+'"><ul class="tags-management tag-cloud" style="list-style:none;"></ul></div></div>'}console.log(g);return new Handlebars.SafeString(g)});Handlebars.registerHelper("containsScope",function(h,j,g){if(j.length==0||!h){return g.inverse(this)}if(jQuery.inArray(h,j)==-1){return g.inverse(this)}return g.fn(this)});Handlebars.registerHelper("isOwnerOfContact",function(h,g){if(CURRENT_DOMAIN_USER.id==h){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("canEditContact",function(h,g){if(canEditContact(h)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("canEditCurrentContact",function(h,g){if(canEditCurrentContact()){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("gateway_exists",function(k,l,h){for(var j=0;j<l.length;j++){var g=JSON.parse(l[j].prefs);if(l[j].name=="EmailGateway"){if(g.email_api==k){return h.fn(l[j])}}if(l[j].name=="SMS-Gateway"){if(g.sms_api==k){return h.fn(l[j])}}}return h.inverse(this)});Handlebars.registerHelper("each_index_slice",function(m,j,h){var g="";for(var k=j;k<m.length;k++){var l=m[k];console.log(l);g+=h.fn(l)}return g});Handlebars.registerHelper("gateway_exists",function(k,l,h){for(var j=0;
j<l.length;j++){var g=JSON.parse(l[j].prefs);if(l[j].name=="EmailGateway"){if(g.email_api==k){return h.fn(l[j])}}if(l[j].name=="SMS-Gateway"){if(g.sms_api==k){return h.fn(l[j])}}}return h.inverse(this)});Handlebars.registerHelper("isOwnerOfContact",function(h,g){if(CURRENT_DOMAIN_USER.id==h){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("canEditContact",function(h,g){if((hasScope("UPDATE_CONTACTS")||hasScope("DELETE_CONTACTS"))||CURRENT_DOMAIN_USER.id==h){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("getAccountPlanName",function(g){if(!g){return"Free"}var h=g.split("_");return ucfirst(h[0])});Handlebars.registerHelper("getAccountPlanInteval",function(g){if(!g){return"Monthly"}var h=g.split("_");return ucfirst(h[1])});Handlebars.registerHelper("getSubscriptionBasedOnPlan",function(k,j,g){var h=getSubscriptionWithAmount(k,j);if(h!=null){return g.fn(h)}return g.inverse(this)});Handlebars.registerHelper("iso_date_to_normalizeDate",function(h){if(h.length<=0){return}var g=h.split("T");console.log("normalize date "+g[0]);return g[0]});Handlebars.registerHelper("getMonthFromIndex",function(h){var g=["January","february","March","April","May","June","July","August","September","October","November","December"];if(h>12){return g[11]}return g[h-1]});Handlebars.registerHelper("xeroOrganisationShortCode",function(g){if(typeof SHORT_CODE=="undefined"||SHORT_CODE==""){return false}else{return SHORT_CODE}});Handlebars.registerHelper("buildOptions",function(j){var g=j.split(";");var h="";$.each(g,function(k,l){if(l!=""){h=h.concat('<option value="'+l+'">'+l+"</option>")}});return h});Handlebars.registerHelper("get_avatars_template",function(g){var h=getTemplate("choose-avatar-images-modal",{});return h});Handlebars.registerHelper("if_email_type_is_agile",function(j,g){var h=email_server_type;if(h){if(j===h){return g.fn(this)}else{return g.inverse(this)}}else{return g.fn(this)}});Handlebars.registerHelper("read_global_var",function(){var g=email_server_type;if(g){return g}else{return"agilecrm"}});Handlebars.registerHelper("pick_random_avatar_url",function(g){return choose_random_avatar()});Handlebars.registerHelper("getRemaininaEmails",function(){return getPendingEmails()});Handlebars.registerHelper("inboundMail",function(){var g=$.ajax({type:"GET",url:"/core/api/api-key",async:false,dataType:"json"}).responseText;g=JSON.parse(g);var h=window.location.hostname.split(".")[0]+"-"+g.api_key+"@agle.cc";return new Handlebars.SafeString(h)});Handlebars.registerHelper("getTime",function(j){if(!j){return}if((j/100000000000)>1){var l=new Date(parseInt(j));var g=l.getHours();if(g>12){g=g-12}var k=l.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";return g+":"+k+" "+h}var l=new Date(parseInt(j)*1000);var g=l.getHours();if(g>12){g=g-12}var k=l.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";return g+":"+k+" "+h});Handlebars.registerHelper("getCustomDateWithTime",function(n,g){var m=b(n);var l=b(g);var j=d(n);var h=d(g);var k=c(g);if(m!=l){return j+" - "+h}else{return j+" - "+k}});function d(k){var g=["Jan","Feb","March","April","May","Jun","July","Aug","Sept","Oct","Nov","Dec"];if(!k){return}if((k/100000000000)>1){var o=new Date(parseInt(k));var h=o.getHours();var m=o.getFullYear();var k=o.getDate();var n=o.getMonth();var l=o.getMinutes();if(l==0){l="00"}var j=h>=12?"PM":"AM";if(h>12){h=h-12}return g[n]+" "+k+", "+m+" "+h+":"+l+" "+j}var o=new Date(parseInt(k)*1000);var h=o.getHours();var m=o.getFullYear();var k=o.getDate();var n=o.getMonth();var l=o.getMinutes();if(l==0){l="00"}var j=h>=12?"PM":"AM";if(h>12){h=h-12}return g[n]+" "+k+", "+m+" "+h+":"+l+" "+j}function c(j){if(!j){return}if((j/100000000000)>1){var l=new Date(parseInt(j));var g=l.getHours();var k=l.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";if(g>12){g=g-12}return g+":"+k+" "+h}var l=new Date(parseInt(j)*1000);var g=l.getHours();var k=l.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";if(g>12){g=g-12}return g+":"+k+" "+h}function b(g){if((g/100000000000)>1){var h=new Date(parseInt(g));return h.getDate()}else{var h=new Date(parseInt(g)*1000);return h.getDate()}}Handlebars.registerHelper("getContactDisplayValue",function(g){var h;var n=g.type;var l=g.properties;if(l){if(n=="COMPANY"){for(var k=0;k<l.length;k++){if(l[k].name=="name"){h=l[k].value;break}}}else{var m;var j;for(var k=0;k<l.length;k++){if(l[k].name=="first_name"){m=l[k].value}if(l[k].name=="last_name"){j=l[k].value}}if(!m){m=""}if(!j){j==""}h=m+" "+j}}return h});Handlebars.registerHelper("getGoogleEventCustomTime",function(k,h){var g=new Date(k);var j=new Date(h);return f(g.getTime(),j.getTime())});function f(j,l){var p=b(j);var o=b(l);var h=d(j);var g=d(l);var k=c(l);var q=e(j);if(q==0||q==1){var n=c(j);var m=c(l);if(n&&m){return n+" - "+m}if(m){return n+" - "+m}else{return n}}else{if(p!=o){if(g){return h+" - "+g}else{return h}}else{return h+" - "+k}}}Handlebars.registerHelper("displayCustomDateTime",function(o,g){var j=get_activity_created_time(o);var n=b(o);var m=b(g);var k=d(o);var h=d(g);var l=c(g);if(j==0||eventCreatedTime==1){return l}else{if(n!=m){return k+" - "+h}else{return k+" - "+l}}});function e(j){var h=new Date(j);j=h.getTime()/1000;var g=new Date();g.setHours(0,0,0,0);g=g.getTime()/1000;return Math.floor((j-g)/(24*3600))}Handlebars.registerHelper("arrayToCamelcase",function(h){var g="";for(var j=0;j<h.length;j++){g+=ucfirst(h[j]);if(j+1<h.length){g+=", "}}return g});Handlebars.registerHelper("namesFromObject",function(j,k){var g="";console.log(j.length);for(var h=0;h<j.length;h++){g+=j[h][k];if(h+1<j.length){g+=", "}}return g});Handlebars.registerHelper("secondsToFriendlyTime",function(k){var h=Math.floor(k/3600);if(h>0){k=k-h*60*60}var j=Math.floor(k/60);var l=k-j*60;var g="";if(h==1){g=h+"h "}if(h>1){g=h+"h "}if(j>0){g+=j+"m "}if(l>0){g+=l+"s "}if(g!=""){return" - "+g}return g});Handlebars.registerHelper("pick_random_avatar_url",function(g){return choose_random_avatar()});Handlebars.registerHelper("choose_custom_field_font_icon",function(h){var g="";if(h=="TEXT"){g="icon-text-height"}else{if(h=="TEXTAREA"){g="icon-file-alt"}else{if(h=="DATE"){g="icon-calendar"}else{if(h=="CHECKBOX"){g="icon-check"}else{if(h=="LIST"){g="icon-list-ul"}else{if(h=="NUMBER"){g="icon-text-height"}}}}}}return g});Handlebars.registerHelper("choose_custom_field_type",function(h){var g="";if(h=="TEXT"){g="Text Field"}else{if(h=="TEXTAREA"){g="Text Area"}else{if(h=="DATE"){g="Date"}else{if(h=="CHECKBOX"){g="Checkbox"}else{if(h=="LIST"){g="List"}else{if(h=="NUMBER"){g="Number"}else{if(h=="FORMULA"){g="Formula"}}}}}}}return g});Handlebars.registerHelper("ifCond",function(k,h,j,g){switch(h){case"greaterthan":if(parseInt(k)>parseInt(j)){return g.fn(this)}break;case"lessthan":if(parseInt(k)<parseInt(j)){return g.fn(this)}break;case"equals":if(parseInt(k)===parseInt(j)){return g.fn(this)}break}return g.inverse(this)});Handlebars.registerHelper("callActivityFriendlyStatus",function(g,h){switch(g){case"completed":case"answered":return"Call duration";break;case"busy":case"no-answer":if(h=="outgoing"){return"Contact busy"}else{return"Not answered"}break;case"failed":return"Failed";break;case"in-progress":case"voicemail":return"Left voicemail";break;default:return""}});Handlebars.registerHelper("shopifyWebhook",function(){var h=$.ajax({type:"GET",url:"/core/api/api-key",async:false,dataType:"json"}).responseText;h=JSON.parse(h);var g=window.location.origin+"/shopifytrigger?api-key="+h.api_key;return new Handlebars.SafeString(g)});Handlebars.registerHelper("toProperFormat",function(g){if(g=="0"){return"0 s"}return twilioSecondsToFriendly(g)});Handlebars.registerHelper("get_portlet_name",function(g){var h="";if(g=="Filter Based"){h="Contact List"}else{if(g=="Emails Opened"){h="Email Opens"}else{if(g=="Emails Sent"){h="Emails"}else{if(g=="Growth Graph"){h="Tag Graph"}else{if(g=="Calls Per Person"){h="Calls"}else{if(g=="Pending Deals"){h="Pending Deals"}else{if(g=="Deals By Milestone"){h="Deals by Milestone"}else{if(g=="Closures Per Person"){h="Closures per Person"}else{if(g=="Deals Won"){h="Deals Won"}else{if(g=="Deals Funnel"){h="Deals Funnel"}else{if(g=="Deals Assigned"){h="Deals Assigned"}else{if(g=="Agenda"){h="Today's Events"}else{if(g=="Today Tasks"){h="Today's Tasks"}else{if(g=="Agile CRM Blog"){h="Agile CRM Blog"}else{if(g=="Task Report"){h="Task Report"}}}}}}}}}}}}}}}return h});Handlebars.registerHelper("get_portlet_icon",function(g){var h="";if(g=="Filter Based"){h="icon-user"}else{if(g=="Emails Opened"){h="icon-envelope"}else{if(g=="Emails Sent"){h="icon-envelope"}else{if(g=="Growth Graph"){h="icon-bar-chart"}else{if(g=="Calls Per Person"){h="icon-phone"}else{if(g=="Pending Deals"){h="icon-time"}else{if(g=="Deals By Milestone"){h="icon-flag-checkered"}else{if(g=="Closures Per Person"){h="icon-thumbs-up"}else{if(g=="Deals Won"){h="icon-briefcase"}else{if(g=="Deals Funnel"){h="icon-filter"}else{if(g=="Deals Assigned"){h="icon-user"}else{if(g=="Agenda"){h="icon-calendar"}else{if(g=="Today Tasks"||g=="Task Report"){h="icon-tasks"}else{if(g=="Agile CRM Blog"){h="icon-rss-sign"}}}}}}}}}}}}}}return h});Handlebars.registerHelper("get_flitered_contact_portlet_header",function(j){var g="";if(j=="contacts"){g="All Contacts"}else{if(j=="companies"){g="All Companies"}else{if(j=="recent"){g="Recent Contacts"}else{if(j=="myContacts"){g="My Contacts"}else{if(j=="leads"){g="Leads"}else{var h=$.ajax({type:"GET",url:"/core/api/filters/"+j,async:false,dataType:"json",success:function(k){if(k!=null&&k!=undefined){g=""+k.name}}})}}}}}return g});Handlebars.registerHelper("if_equals_or",function(){var g=arguments[arguments.length-1];try{for(var h=0;h<arguments.length-1;h=h+2){value=arguments[h];target=arguments[h+1];if((typeof target==="undefined")||(typeof value==="undefined")){return g.inverse(this)}if(value.toString().trim()==target.toString().trim()){return g.fn(this)}}return g.inverse(this)}catch(j){console.log("error while if_equals_or of handlebars helper : "+j.message);return g.inverse(this)
}});Handlebars.registerHelper("buildFacebookProfileURL",function(g){return buildFacebookProfileURL(g)});Handlebars.registerHelper("getTracksCount",function(g){if(parseInt(DEAL_TRACKS_COUNT)>1){return g.fn(this)}else{return g.inverse(this)}});Handlebars.registerHelper("get_deals_funnel_portlet_header",function(j){var g="";App_Portlets.track_length=0;$.ajax({type:"GET",url:"/core/api/milestone/pipelines",async:false,dataType:"json",success:function(k){App_Portlets.track_length=k.length;App_Portlets.deal_tracks=k}});if(App_Portlets.track_length>1){if(j==0){g="(Default)"}else{var h=$.ajax({type:"GET",url:"/core/api/milestone/"+j,async:false,dataType:"json",success:function(k){if(k!=null&&k!=undefined){g="("+k.name+")"}}})}}return g});Handlebars.registerHelper("get_AM_PM_format",function(h){var k=new Date(h*1000);var g=k.getHours();var l=k.getMinutes();var j=g>=12?"PM":"AM";g=g%12;g=g?g:12;l=l<10?"0"+l:l;var m=g+":"+l+" "+j;return m});Handlebars.registerHelper("get_duration",function(g,m){var l="";var n=0;var j=0;var k=0;var h=m-g;n=Math.floor(h/(24*60*60));j=Math.floor((h%(24*60*60))/(60*60));k=Math.floor(((h%(24*60*60))%(60*60))/60);if(n!=0&&n==1){l+=""+n+" Day "}else{if(n!=0&&n>1){l+=""+n+" Days "}}if(j!=0&&j==1){l+=""+j+" Hour "}else{if(j!=0&&j>1){l+=""+j+" Hours "}}if(k!=0&&k==1){l+=""+k+" Minute"}else{if(k!=0&&k>1){l+=""+k+" Minutes"}}return l});Handlebars.registerHelper("displayActivityFieldText",function(j){var g=j.replace(/[^a-zA-Z ^,]/g," ").split(",");var k="";if(g.length>1){for(var h=0;h<g.length-1;h++){k+=" "+g[h].trim();if(h!=g.length-2){k+=","}}k+=" and "+g[g.length-1].trim()}else{k=g[g.length-1].trim()}k=k.replace("subject","Title");k=k.replace("priority type","Priority");k=k.replace("task type","Category");k=k.replace("due date","Due date");k=k.replace("name","Name");k=k.replace("probability","Probability");k=k.replace("expected value","Expected value");k=k.replace("close date","Close date");k=k.replace("close date","Close date");k=k.replace("end date","End time");k=k.replace("priority","Priority");k=k.replace("title","Title");return k});Handlebars.registerHelper("numberWithCommasForActivities",function(g){g=parseFloat(g);if(g==0){return g}if(g){return g.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}});Handlebars.registerHelper("get_event_rescheduled",function(l,j){console.log(l);var h=l.replace(/[^a-zA-Z ^,]/g," ").split(",");var g=[];if(h){for(var k=0;k<h.length;k++){g.push(h[k].trim())}}if(g.indexOf("start date")!=-1){return j.fn(l)}if(g.indexOf("due date")!=-1){return j.fn(l)}return j.inverse(l)});Handlebars.registerHelper("getDueDateOfTask",function(g,h){var n=g.replace(/[^a-zA-Z ^,]/g," ").split(",");var m=h.replace(/[^a-zA-Z0-9 ^,]/g," ").split(",");var k={};for(var o=0;o<n.length;o++){n[o]=n[o].trim();m[o]=m[o].trim()}for(var j=0;j<n.length;j++){k[n[j]]=m[j]}if(n.indexOf("due date")!=-1){var l=parseFloat(k["due date"]);return convertToHumanDate("ddd mmm dd yyyy h:MM TT",l)}if(n.indexOf("start date")!=-1){var l=parseFloat(k["start date"]);return convertToHumanDate("ddd mmm dd yyyy h:MM TT",l)}});Handlebars.registerHelper("getDealCustomProperties",function(h,j){var g=getDealCustomProperties(h);if(g.length==0){return j.inverse(g)}return j.fn(g)});Handlebars.registerHelper("getFormNameFromId",function(k){var g="/core/api/forms/form?formId="+k;var j=$.ajax({type:"GET",url:g,async:false,dataType:"json"}).responseText;j=JSON.parse(j);var h=j.formName;return new Handlebars.SafeString(h)});Handlebars.registerHelper("isEmailIntegration",function(g){console.log(g);if(_plan_restrictions.is_email_gateway_allowed()){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("isAllowedInCurrentPlan",function(h,g){if(_plan_restrictions[h]&&_plan_restrictions[h][0]&&_plan_restrictions[h][0]()){return g.fn(this)}else{if(_plan_restrictions[h]&&_plan_restrictions[h][1]){return g.inverse(_plan_restrictions[h][1]())}else{return g.inverse(this)}}});Handlebars.registerHelper("isTracksEligible",function(h){var g=_billing_restriction.currentLimits.planName;if(g=="PRO"||g=="REGULAR"){return h.fn(this)}return h.inverse(this)});Handlebars.registerHelper("getTemplate",function(h,g){if(!g){g={}}return new Handlebars.SafeString(getTemplate(h,g,"no"))});Handlebars.registerHelper("aclsWithPlans",function(g,h){var j=getDomainUserFromDeserialize(g);return h.fn(j)});Handlebars.registerHelper("hasSingleTrack",function(g){try{var h=App_Admin_Settings.pipelineGridView.collection.length;if(h>1){return g.fn(this)}}catch(j){console.log(j)}return g.inverse(this)});Handlebars.registerHelper("get_subject",function(h){var g="Email subject: ";try{if(h){return h.slice(h.indexOf(g)+g.length,h.length)}}catch(j){return h}return h});Handlebars.registerHelper("isCurrentDeal",function(h,g){var j=App_Deal_Details.dealDetailView.model.id;if(h&&h==j){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("getDealNames",function(j){var h="";var g=0;if(App_Deal_Details.dealDetailView){g=App_Deal_Details.dealDetailView.model.id}$.each(j,function(k,l){if(l.id!=g){h+='<a href="#deal/'+l.id+'">'+l.name+"</a>";if(k+1<j.length){h+=", "}}});return h});Handlebars.registerHelper("toSafeString",function(g){return new Handlebars.SafeString(g)});Handlebars.registerHelper("getRandomNumber",function(){return Math.floor((Math.random()*100)+1)})});function getEventCreatedTime(d){var c=new Date(d);d=c.getTime()/1000;var b=new Date();b.setHours(0,0,0,0);b=b.getTime()/1000;return Math.floor((d-b)/(24*3600))}var Handlebars_Compiled_Templates={};function getTemplate(d,e,c,j){var b=j&&typeof(j)=="function";if(Handlebars_Compiled_Templates[d]){if(j){return j(Handlebars_Compiled_Templates[d](e))}else{return Handlebars_Compiled_Templates[d](e)}}else{Handlebars_Compiled_Templates={}}if(HANDLEBARS_PRECOMPILATION){var g=Handlebars.templates[d+"-template"];if(g){if(b){j(g(e));return}return g(e)}}else{var h=$("#"+d+"-template").html();if(h){var g=Handlebars.compile(h);Handlebars_Compiled_Templates[d]=g;if(b){j(g(e));return}return g(e)}}if(c=="no"){console.log("Not found "+d);return}var f=getTemplateUrls(d);if(b){load_templates_async(d,e,f,j);return}load_templates_sync(f);return getTemplate(d,e,"no")}function getTemplateUrls(b){var c=[];if(b.indexOf("settings")==0){c.push("settings.js")}if(b.indexOf("admin-settings")==0){c.push("admin-settings.js")}if(b.indexOf("continue")==0){c.push("continue.js")}if(b.indexOf("all-domain")==0){c.push("admin.js")}if(b.indexOf("contact-detail")==0||b.indexOf("timeline")==0||b.indexOf("company-detail")==0){c.push("contact-detail.js");if(HANDLEBARS_PRECOMPILATION){c.push("contact-detail.html")}}if(b.indexOf("contact-filter")==0||b.indexOf("filter-contacts")==0){c.push("contact-filter.js")}if(b.indexOf("contact-view")==0||b.indexOf("contact-custom")==0||b.indexOf("contacts-custom")==0||b.indexOf("contacts-grid")==0){c.push("contact-view.js")}if(b.indexOf("bulk-actions")==0){c.push("bulk-actions.js")}if(b.indexOf("case")==0){c.push("case.js")}if(b.indexOf("document")==0){c.push("document.js")}if(b.indexOf("voice-mail")==0){c.push("voice-mail.js")}if(b.indexOf("gmap")==0){c.push("gmap.js")}if(b.indexOf("report")==0){c.push("report.js")}if(b.indexOf("webrule")==0){c.push("web-rules.js")}if(b.indexOf("workflow")==0||b.indexOf("campaign")==0||b.indexOf("trigger")==0||b.indexOf("automation")==0){c.push("workflow.js")}if(b.indexOf("purchase")==0||b.indexOf("subscription")==0||b.indexOf("subscribe")==0||b.indexOf("invoice")==0){c.push("billing.js")}if(b.indexOf("widget")==0){c.push("widget.js")}if(b.indexOf("helpscout")==0){c.push("helpscout.js")}else{if(b.indexOf("clickdesk")==0){c.push("clickdesk.js")}else{if(b.indexOf("zendesk")==0){c.push("zendesk.js")}else{if(b.indexOf("freshbooks")==0){c.push("freshbooks.js")}else{if(b.indexOf("linkedin")==0){c.push("linkedin.js")}else{if(b.indexOf("rapleaf")==0){c.push("rapleaf.js")}else{if(b.indexOf("stripe")==0){c.push("stripe.js")}else{if(b.indexOf("twilioio")==0){c.push("twilioio.js")}else{if(b.indexOf("twilio")==0){c.push("twilio.js")}else{if(b.indexOf("sip")==0){c.push("sip.js")}else{if(b.indexOf("twitter")==0){c.push("twitter.js")}else{if(b.indexOf("googleplus")==0){c.push("googleplus.js")}else{if(b.indexOf("xero")==0){c.push("xero.js")}else{if(b.indexOf("quickbooks")==0){c.push("quickbooks.js")}else{if(b.indexOf("facebook")==0){c.push("facebook.js")}else{if(b.indexOf("callscript")==0){c.push("callscript.js")}}}}}}}}}}}}}}}}if(b.indexOf("chargify")==0){c.push("chargify.js")}if(b.indexOf("shopify")==0){c.push("shopify.js")}if(b.indexOf("socialsuite")==0){c.push("socialsuite.js");if(HANDLEBARS_PRECOMPILATION){c.push("socialsuite.html")}}if(b.indexOf("portlet")==0){c.push("portlets.js")}if(b.indexOf("deal-detail")==0){c.push("deal-detail.js")}return c}function load_templates_async(b,d,e,f){var c=e.pop();if(!c){getTemplate(b,d,"no",f);return}downloadTemplate(c,function(){load_templates_async(b,d,e,f)})}function load_templates_sync(c){for(var b in c){downloadTemplate(c[b])}}String.prototype.endsWith=function(b){return this.indexOf(b,this.length-b.length)!==-1};var TEMPLATE_LIB_PATH=LIB_PATH;function downloadTemplate(d,e){var c="html";if(HANDLEBARS_PRECOMPILATION){d="tpl/min/precompiled/"+d}else{d="tpl/min/"+d}if(d.endsWith("js")&&HANDLEBARS_PRECOMPILATION){c="script";d=TEMPLATE_LIB_PATH+d}console.log(d+" "+c);var b=false;if(e&&typeof(e)==="function"){b=true}jQuery.ajax({url:d,dataType:c,success:function(f){if(c=="html"){$("body").append((f))}if(b){e(f)}},async:b});return""}function getPropertyValue(c,d){if(c==undefined){return}for(var e=0,b=c.length;e<b;e++){if(c[e].name==d){return c[e].value}}}function getAllPropertyValuesByName(c,d,h){if(c==undefined){return}var j="";for(var e=0,b=c.length;e<b;e++){if(c[e].name==d){var g=c[e].value;j+=g+h}}var f=new RegExp("(^"+h+")|("+h+"$)","g");j=j.replace(f,"");console.log(j);return j}function getProperty(c,d){if(c==undefined){return}for(var e=0,b=c.length;e<b;e++){if(c[e].name==d){return c[e]}}}function getPropertyValueBySubtype(d,e,c){if(d==undefined){return
}for(var f=0,b=d.length;f<b;f++){if(d[f].name==e&&d[f].subtype==c){return d[f].value}}}function getPropertyValueBytype(d,e,g,c){if(d==undefined){return}for(var f=0,b=d.length;f<b;f++){if(d[f].name==e){if(g&&g==d[f].type){if(c&&c==d[f].subtype){return d[f].value}}if(c&&c==d[f].subtype){return d[f].value}}}}function getPropertyValueInCheckbox(c,d,h,g){if(c==undefined){return}var f="";for(var e=0,b=c.length;e<b;e++){if(c[e].name===d){if(d==="website"){if(g==="checked"){f=f.concat('<input type="checkbox" field="'+d+'" subtype="'+get_subtype_value(c[e])+'" data="'+c[e].value+'" oid="'+h+'" checked="'+g+'">'+c[e].value)}else{f=f.concat('<input type="checkbox" field="'+d+'" subtype="'+get_subtype_value(c[e])+'" data="'+c[e].value+'" oid="'+h+'">'+c[e].value)}f=f.concat(get_website_icon(c[e]))}else{if(d==="phone"){if(g==="checked"){f=f.concat('<input type="checkbox" field="'+d+'" subtype="'+get_subtype_value(c[e])+'" data="'+c[e].value+'" oid="'+h+'" checked="'+g+'">'+c[e].value)}else{f=f.concat('<input type="checkbox" field="'+d+'" subtype="'+get_subtype_value(c[e])+'" data="'+c[e].value+'" oid="'+h+'">'+c[e].value)}f=f.concat(get_subtype(c[e]))}else{if(d==="email"){if(g==="checked"){f=f.concat('<input type="checkbox" field="'+d+'" subtype="'+get_subtype_value(c[e])+'" data="'+c[e].value+'" oid="'+h+'" checked="'+g+'">'+c[e].value)}else{f=f.concat('<input type="checkbox" field="'+d+'" subtype="'+get_subtype_value(c[e])+'" data="'+c[e].value+'" oid="'+h+'">'+c[e].value)}f=f.concat(get_subtype(c[e]))}}}}}return f}function get_website_icon(c){var b=get_social_icon(c.subtype);var d='<i class="'.concat(b).concat('"').concat(' style="font-size: 1.3em !important; margin-left:10px "></i> <br>');return d}function get_social_icon(c){if(!c){return}var b={TWITTER:"icon-twitter-sign",LINKEDIN:"icon-linkedin-sign",URL:"icon-globe","GOOGLE-PLUS":"icon-google-plus-sign",FACEBOOK:"icon-facebook-sign",GITHUB:"icon-github",FEED:"icon-rss",XING:"icon-xing-sign",SKYPE:"icon-skype",YOUTUBE:"icon-youtube",FLICKR:"icon-flickr"};c=c.trim();if(b[c]){return b[c]}return"icon-globe"}function get_subtype(b){if(b.subtype!=undefined&&b.subtype!=""){var c='<span class="label" style="margin:3px 0px 3px 10px">'.concat(b.subtype).concat("</span> <br>");return c}else{return"<br>"}}function get_subtype_value(b){if(b.subtype!=undefined&&b.subtype!=""){var c=b.subtype;return c}else{return""}}function getContactCustomProperties(items){if(items==undefined){return items}var fields=[];var fieldName="";var datajson={};for(var i=0;i<items.length;i++){if(items[i].type=="CUSTOM"&&items[i].name!="image"){if(fieldName==""){fieldName=items[i].name}fields.push(items[i]);datajson[""+items[i].name]=items[i].value}}var type="";if(App_Contacts.customFieldsList!=undefined&&App_Contacts.customFieldsList!=null){for(var i=0;i<App_Contacts.customFieldsList.collection.models.length;i++){if(App_Contacts.customFieldsList.collection.models[i].get("field_label")==fieldName){type=App_Contacts.customFieldsList.collection.models[i].get("scope");break}}}var formulaFields=[];var allCustomFields=[];var finalFields=[];if(App_Contacts.customFieldsList!=undefined&&App_Contacts.customFieldsList!=null){if(type==""){type="CONTACT"}for(var i=0;i<App_Contacts.customFieldsList.collection.models.length;i++){var json={};if(App_Contacts.customFieldsList.collection.models[i].get("scope")==type&&App_Contacts.customFieldsList.collection.models[i].get("field_type")=="FORMULA"){var tplEleData=Mustache.render(App_Contacts.customFieldsList.collection.models[i].get("field_data"),datajson);var evalFlag=true;var tplEleDataAftEval;try{tplEleDataAftEval=eval(tplEleData)}catch(err){console.log(err.message);evalFlag=false}if(!evalFlag){tplEleDataAftEval=tplEleData}if(evalFlag&&tplEleDataAftEval!=undefined&&tplEleDataAftEval!=null){json.name=App_Contacts.customFieldsList.collection.models[i].get("field_label");json.type="CUSTOM";json.position=App_Contacts.customFieldsList.collection.models[i].get("position");json.value=tplEleDataAftEval;json.field_type=App_Contacts.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json);formulaFields.push(json)}}else{if(App_Contacts.customFieldsList.collection.models[i].get("scope")==type){json.name=App_Contacts.customFieldsList.collection.models[i].get("field_label");json.type="CUSTOM";json.position=App_Contacts.customFieldsList.collection.models[i].get("position");json.field_type=App_Contacts.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json)}}}}if(fields.length>0){if(allCustomFields.length>0){for(var i=0;i<allCustomFields.length;i++){if(allCustomFields[i].field_type=="FORMULA"){finalFields.push(allCustomFields[i])}else{for(var j=0;j<fields.length;j++){if(allCustomFields[i].name==fields[j].name){finalFields.push(fields[j]);break}}}}}else{for(var k=0;k<fields.length;k++){finalFields.push(fields[k])}}}else{for(var k=0;k<formulaFields.length;k++){finalFields.push(formulaFields[k])}}return finalFields}function ucfirst(b){return(b&&typeof b==="string")?(b.charAt(0).toUpperCase()+b.slice(1).toLowerCase()):""}function titleFromEnums(b){if(!b){return}var c=b.replace(/_/g," ");return ucfirst(c.toLowerCase())}function countJsonProperties(c){var d;var b=0;for(d in c){b++}return b}function getCurrentContactProperty(c){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var b=App_Contacts.contactDetailView.model.get("properties");return getPropertyValue(b,c)}}function getCount(b){if(b[0]&&b[0].count&&(b[0].count!=-1)){return"("+b[0].count+" Total)"}else{return"("+b.length+" Total)"}}function getIdFromHash(){var b=window.location.hash.substr(1);if(b.substr(-1)==="/"){b=b.replace(/\/$/,"")}var c=b.split("/").pop();return c}function updateCustomData(b){$(".custom-data",App_Contacts.contactDetailView.el).html(b)}function getDealCustomProperties(items){if(items==undefined){return items}var fields=[];var datajson={};for(var i=0;i<items.length;i++){fields.push(items[i]);datajson[""+items[i].name]=items[i].value}var formulaFields=[];var allCustomFields=[];var finalFields=[];if(App_Deals.customFieldsList!=undefined&&App_Deals.customFieldsList!=null){for(var i=0;i<App_Deals.customFieldsList.collection.models.length;i++){var json={};if(App_Deals.customFieldsList.collection.models[i].get("field_type")=="FORMULA"){var tplEleData=Mustache.render(App_Deals.customFieldsList.collection.models[i].get("field_data"),datajson);var evalFlag=true;var tplEleDataAftEval;try{tplEleDataAftEval=eval(tplEleData)}catch(err){console.log(err.message);evalFlag=false}if(!evalFlag){tplEleDataAftEval=tplEleData}if(evalFlag&&tplEleDataAftEval!=undefined&&tplEleDataAftEval!=null){json.name=App_Deals.customFieldsList.collection.models[i].get("field_label");json.position=App_Deals.customFieldsList.collection.models[i].get("position");json.value=tplEleDataAftEval;json.field_type=App_Deals.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json);formulaFields.push(json)}}else{json.name=App_Deals.customFieldsList.collection.models[i].get("field_label");json.position=App_Deals.customFieldsList.collection.models[i].get("position");json.field_type=App_Deals.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json)}}}if(fields.length>0){if(allCustomFields.length>0){for(var i=0;i<allCustomFields.length;i++){if(allCustomFields[i].field_type=="FORMULA"){finalFields.push(allCustomFields[i])}else{for(var j=0;j<fields.length;j++){if(allCustomFields[i].name==fields[j].name){finalFields.push(fields[j]);break}}}}}else{for(var k=0;k<fields.length;k++){finalFields.push(fields[k])}}}else{for(var k=0;k<formulaFields.length;k++){finalFields.push(formulaFields[k])}}return finalFields}var Is_Profile_Guider_Closed=false;var Profile_Settings={Email:""};var Profile_Setup_Messages={};Profile_Setup_Messages.Welcome="Welcome to Agile - the next generation CRM. I will be your tour guide.<a href='#' id='noty-welcome-user' style='text-decoration: none;'> Let's get you started.";Profile_Setup_Messages.Email="Shake Hands. <a href='#email' style='text-decoration: none;'> Let's sync your emails first</a>. It's simple and secure.";Profile_Setup_Messages.User_invited="Emails will show up in the awesome timeline. It's time to invite your colleague";Profile_Setup_Messages.Share="Are you liking Agile? Spread the love.";var Initial_Total=65;var Profile_Info={Welcome:false,Email:false,total:Initial_Total};function calculate_profile(){var b=Agile_Contact.tags;if(!b||b.length==0){return Profile_Info}var d=Initial_Total;var c=true;$.each(Profile_Settings,function(e,f){var g=e.indexOf("_")!=-1?e.replace("_"," "):e;if(b.indexOf(g)!=-1){Profile_Info[e]=true;d=d+f;c=false;return}});if(!c){Profile_Info.Welcome=!c}Profile_Info.total=d;return Profile_Info}function set_profile_noty(){}function set_profile_noty1(){console.log(Agile_Contact);if(jQuery.isEmptyObject(Agile_Contact)){return}var b=calculate_profile();remove_profile_noty();$.each(b,function(d,e){console.log(b);if(e==false){var c={};c.message=Profile_Setup_Messages[d];c.route=Profile_Settings[d];show_noty_on_top_of_panel(c);return false}})}function show_noty_on_top_of_panel(b){if(Is_Profile_Guider_Closed){return}$("body").find("#wrap").find("#notify-container").remove();$("body").find("#wrap").find(".navbar-fixed-top").css("margin-top","0px");$("body").find("#wrap").find("#agilecrm-container").css("padding-top","60px");$("body").find("#wrap").find("#notify-container").remove();$("body").find("#wrap").prepend(getTemplate("sticky-noty",b));$("body").find("#wrap").find(".navbar-fixed-top").css("margin-top","34px");$("body").find("#wrap").find("#agilecrm-container").css("padding-top","96px")}function remove_profile_noty(){$("body").find("#wrap").find("#notify-container").remove();$("body").find("#wrap").find(".navbar-fixed-top").css("margin-top","0px");$("body").find("#wrap").find("#agilecrm-container").css("padding-top","60px")}$(function(){$("span.notify-close").die().live("click",function(){Is_Profile_Guider_Closed=true;
$(this).parent().slideUp("slow",function(){$("body").find("#wrap").find(".navbar-fixed-top").css("margin-top","0px");$("body").find("#wrap").find("#agilecrm-container").css("padding-top","60px")})});$("#noty-welcome-user").die().live("click",function(b){b.preventDefault();delete Profile_Info.Welcome;set_profile_noty()})});function check_login_instance(b){current_user_id=get_current_user_id();console.log(b);if(b.id&&b.id==current_user_id){JSESSIONID=readCookie("JSESSIONID");console.log(JSESSIONID);session_id_in_message=b.session_id;if(session_id_in_message==JSESSIONID){return}if(b.login_time<get_current_user_loggedin_time()){return}b.email=get_current_user_email();createCookie("_multiple_login",JSON.stringify(b),0.0025);window.location="/login?ml=true"}}function get_current_user_loggedin_time(){var b=CURRENT_DOMAIN_USER.info_json_string;b=JSON.parse(b);return b.logged_in_time}function get_current_user_id(){return CURRENT_DOMAIN_USER.id}function get_current_user_email(){return CURRENT_DOMAIN_USER.email}function publishLoginEvent(c){var b={};b.type="LOGIN_INSTANCE";b.id=CURRENT_DOMAIN_USER.id;b.session_id=readCookie("JSESSIONID");b.login_time=get_current_user_loggedin_time();b.userAgent=getBrowserDetails();console.log(getBrowserDetails());c.publish({channel:CURRENT_DOMAIN_USER.domain,message:b,callback:function(d){console.log(d)}})}function getBrowserDetails(){var j=navigator.appVersion;var f=navigator.userAgent;var g=navigator.appName;var h=""+parseFloat(navigator.appVersion);var d=parseInt(navigator.appVersion,10);var k,b,c;if((b=f.indexOf("Opera"))!=-1){g="Opera";h=f.substring(b+6);if((b=f.indexOf("Version"))!=-1){h=f.substring(b+8)}}else{if((b=f.indexOf("MSIE"))!=-1){g="Microsoft Internet Explorer";h=f.substring(b+5)}else{if((b=f.indexOf("Chrome"))!=-1){g="Chrome";h=f.substring(b+7)}else{if((b=f.indexOf("Safari"))!=-1){g="Safari";h=f.substring(b+7);if((b=f.indexOf("Version"))!=-1){h=f.substring(b+8)}}else{if((b=f.indexOf("Firefox"))!=-1){g="Firefox";h=f.substring(b+8)}else{if((k=f.lastIndexOf(" ")+1)<(b=f.lastIndexOf("/"))){g=f.substring(k,b);h=f.substring(b+1);if(g.toLowerCase()==g.toUpperCase()){g=navigator.appName}}}}}}}if((c=h.indexOf(";"))!=-1){h=h.substring(0,c)}if((c=h.indexOf(" "))!=-1){h=h.substring(0,c)}d=parseInt(""+h,10);if(isNaN(d)){h=""+parseFloat(navigator.appVersion);d=parseInt(navigator.appVersion,10)}var e="Unknown OS";if(navigator.appVersion.indexOf("Win")!=-1){e="Windows"}if(navigator.appVersion.indexOf("Mac")!=-1){e="MacOS"}if(navigator.appVersion.indexOf("X11")!=-1){e="UNIX"}if(navigator.appVersion.indexOf("Linux")!=-1){e="Linux"}var l={};l.browser_name=g;l.full_version=h;l.major_version=d;l.app_name=navigator.appName;l["navigator.userAgent"]=navigator.userAgent;l.OSName=e;return l}function sipStart(){setTimeout(function(){if(document.readyState==="complete"){if(Sip_Start==true){return}$.getJSON("/core/api/widgets/Sip",function(b){if(b==null){return}Sip_Widget_Object=b;if(b.prefs!=undefined){head.js(LIB_PATH+"lib/telephony/SIPml-api.js",function(){SIPml.setDebugLevel("error");if(SIPml.isInitialized()){sipRegister()}else{SIPml.init(sipRegister)}})}}).error(function(b){console.log("Sip error");console.log(b)})}},15000)}function sipRegister(){addAudio();Config_Call={audio_remote:document.getElementById("audio_remote"),events_listener:{events:"*",listener:sipSessionEventsListener}};if(Sip_Start==true){return}Sip_Start=true;var url=null;var credentials=eval("("+Sip_Widget_Object.prefs+")");var message=null;try{var o_impu=tsip_uri.prototype.Parse(credentials.sip_publicid);if(!o_impu||!o_impu.s_user_name||!o_impu.s_host){Sip_Start=false;message=credentials.sip_publicid+" is not a valid Public identity. Please provide valid credentials.";showCallNotyPopup("failed","error",message,5000)}else{if(credentials.sip_wsenable=="true"){console.log(window.location.protocol);if(window.location.protocol!="https:"){url="ws://rtc.agilecrm.com:10060/ws"}else{url="wss://rtc.agilecrm.com:10062/wss"}}Sip_Stack=new SIPml.Stack({realm:credentials.sip_realm,impi:credentials.sip_privateid,impu:credentials.sip_publicid,password:credentials.sip_password,display_name:credentials.sip_username,websocket_proxy_url:url,enable_rtcweb_breaker:true,events_listener:{events:"*",listener:sipStackEventsListener}});if(Sip_Stack.start()!=0){Sip_Start=false;message="Failed to start the SIP stack. Please provide valid credentials.";showCallNotyPopup("failed","error",message,5000)}}}catch(e){Sip_Start=false;message=e+" Please provide valid credentials.";showCallNotyPopup("failed","error",message,5000)}}function sipLogin(){try{Sip_Register_Session=Sip_Stack.newSession("register",{events_listener:{events:"*",listener:sipSessionEventsListener}});Sip_Register_Session.register()}catch(b){Sip_Start=false}}function sipUnRegister(){if(Sip_Stack){var b=Sip_Stack.stop();console.log("Sip_Stack.stop() :"+b);if(b!=0){sipUnRegister()}}}function sipStackEventsListener(b){switch(b.type){case"started":sipLogin();break;case"failed_to_start":showCallNotyPopup("disconnected","error","SIP: There was an error registering your account. Please modify and try again.",false);case"failed_to_stop":case"stopping":case"stopped":Sip_Start=false;Sip_Stack=null;Sip_Register_Session=null;Sip_Session_Call=null;User_Name=null;User_Number=null;User_Img=null;User_ID=null;SIP_Call_Noty_IMG="";Show_Add_Contact=false;stopRingTone();break;case"i_new_call":newIncomingCall(b);break;case"starting":break;case"m_permission_requested":break;case"m_permission_accepted":break;case"m_permission_refused":stopRingTone();showCallNotyPopup("mediaDeny","warning","SIP: Media stream permission denied.",false);hangupCall();break;default:console.log("In sipStack event Listner. "+b.type);break}}function sipSessionEventsListener(c){switch(c.type){case"connecting":break;case"sent_request":break;case"connected":if(c.session==Sip_Register_Session){play_sound();showCallNotyPopup("register","information","SIP: You are now registered to make and receive calls successfully.",5000);$(".contact-make-sip-call").show();$(".contact-make-call").hide();$(".contact-make-twilio-call").hide();if(window.webkitNotifications&&window.webkitNotifications.checkPermission()!=0){window.webkitNotifications.requestPermission()}}else{if(c.session==Sip_Session_Call){stopRingTone();showCallNotyPopup("connected","success",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>On call  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false);if(Notify_Call){Notify_Call.cancel();Notify_Call=null}}}break;case"terminating":case"terminated":if(c.session==Sip_Register_Session){Sip_Start=false;Sip_Session_Call=null;Sip_Register_Session=null;User_Name=null;User_Number=null;User_Img=null;User_ID=null;SIP_Call_Noty_IMG="";Show_Add_Contact=false;if(Sip_Updated==true&&c.description=="Disconnecting..."){Sip_Updated=false;showCallNotyPopup("disconnected","warning","SIP : Terminated for modifications. Registering again...",5000)}else{if(No_Internet==true&&c.description=="Disconnecting..."){No_Internet=false;showCallNotyPopup("disconnected","error","SIP : Terminated because no internet connectivity.",5000)}else{showCallNotyPopup("disconnected","error","SIP : Terminated because "+c.description,5000)}}}else{if(c.session==Sip_Session_Call){Sip_Session_Call=null;stopRingTone();if(c.description=="Request Cancelled"){showCallNotyPopup("missedCall","error",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Missed call </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false)}else{if(c.description=="PSTN calls are forbidden"){showCallNotyPopup("forbidden","error","SIP: PSTN calls are forbidden.",false)}else{if(c.description=="Not acceptable here"){showCallNotyPopup("noresponce","error","SIP: Not acceptable here.",false)}else{if(c.description=="Media stream permission denied"){showCallNotyPopup("permissiondenied","error","SIP: Media stream permission denied.")}else{if(c.description=="Call terminated"){showCallNotyPopup("hangup","information",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Call ended with  <b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false)}else{if(c.description=="Decline"){showCallNotyPopup("decline","error","Call Decline.",false)}else{if(c.description=="Request Timeout"){showCallNotyPopup("requestTimeout","error","SIP: Request Timeout.",false)}else{if(c.description=="Hackers Forbidden"){showCallNotyPopup("hackersForbidden","error","SIP: Hackers Forbidden.",false)}else{if(c.description=="User not found"){showCallNotyPopup("userNotFound","error","SIP: User not found.",false)}else{if(c.description=="Call terminating..."){console.log("SIP : Terminated because "+c.description)}else{if(!Is_Ignore){showCallNotyPopup("disconnected","error","SIP : Terminated because "+c.description,5000)}}}}}}}}}}}if(Show_Add_Contact==true){$("#personModal").modal("show");$("#personForm").find("#phone").val(User_Number)}User_Name=null;User_Number=null;User_Img=null;User_ID=null;SIP_Call_Noty_IMG="";Is_Ignore=false;Show_Add_Contact=false;if(Notify_Call){Notify_Call.cancel();Notify_Call=null}}}break;case"i_ao_request":if(c.session==Sip_Session_Call){var b=c.getSipResponseCode();if(b==180||b==183){startRingTone("ringbacktone")}}break;case"media_added":break;case"media_removed":break;case"i_request":break;case"o_request":break;case"cancelled_request":break;case"sent_request":break;case"transport_error":break;case"global_error":break;case"message_error":break;case"webrtc_error":break;case"m_early_media":stopRingTone();break;case"m_stream_audio_local_added":break;case"m_stream_audio_local_removed":break;case"m_stream_audio_remote_added":break;case"m_stream_audio_remote_removed":break;case"i_info":break;default:console.log("Sip Session event Listner. "+c.type);break}}$(function(){$(".dialpad").die().live("click",function(c){c.preventDefault();
if($(".noty_buttons").find(".dialpad_btns").html()==null){var b=$(getTemplate("dialpad"),{});$(".noty_buttons").prepend(b)}else{$("#dialpad_btns").remove()}});$(".make-call").die().live("click",function(b){b.preventDefault();if(makeCall("sip:farah@sip2sip.info")){User_Name="farah";User_Number="sip:farah@sip2sip.info";showCallNotyPopup("outgoing","confirm",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Calling </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false)}});$(".contact-make-sip-call").die().live("click",function(d){d.preventDefault();var c=$(this).attr("userid");var b=$(this).attr("phone");if(b==""||b==null){alert(name+"'s contact number not added.");return}if(makeCall(b)){var f=App_Contacts.contactDetailView.model.toJSON();User_Name=getContactName(f);User_Number=removeBracesFromNumber(b);User_Img=getGravatar(f.properties,40);User_ID=f.id;SIP_Call_Noty_IMG=addSipContactImg();Show_Add_Contact=false;showCallNotyPopup("outgoing","confirm",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Calling  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false)}});$(".hangup").die().live("click",function(b){b.preventDefault();showCallNotyPopup("hangup","information",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Call ended with  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false);hangupCall()});$(".ignore").die().live("click",function(b){showCallNotyPopup("ignored","error",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Ignored call  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',5000);Sip_Session_Call.reject(Config_Call);Is_Ignore=true;if(Notify_Call){Notify_Call.cancel();Notify_Call=null}});$(".answer").die().live("click",function(b){Sip_Session_Call.accept(Config_Call)})});function addSipContactImg(){console.log("User_Img:");console.log(User_Img);Contact_Link="";if(User_ID){Contact_Link=Contact_Link+"contact/"+User_ID}var b='<a href="#'+Contact_Link+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+DEFAULT_GRAVATAR_url+'" style="display:inline;"></a>';if(User_Img){b='<a href="#'+Contact_Link+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+User_Img+'" style="display:inline;"></a>'}console.log("notyContactImg: "+b);return b}function removeBracesFromNumber(b){console.log("number: "+b);if(b.match("^<")&&b.match(">$")){b=b.substr(1,b.length-2)}return b}function findContact(){console.log("FindContact. "+Sip_Session_Call.getRemoteUri());$.getJSON("/core/api/contacts/search/phonenumber/"+Sip_Session_Call.getRemoteUri(),function(b){console.log(b);if(b!=null){User_ID=b.id;User_Name=getContactName(b);User_Number=removeBracesFromNumber(Sip_Session_Call.getRemoteUri());User_Img=getGravatar(b.properties,40);SIP_Call_Noty_IMG=addSipContactImg();if(CALL!=undefined){CALL.setText(SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Incoming call  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>')}}else{Show_Add_Contact=true}}).error(function(b){console.log("Find contact : "+b.responseText)})}var Sip_Stack;var Sip_Register_Session;var Sip_Session_Call;var Config_Call;var Sip_Widget_Object;var User_Name;var User_Img;var User_Number;var User_ID;var SIP_Call_Noty_IMG="";var Contact_Link="";var Show_Add_Contact=false;var Is_Ignore=false;var CALL;var Notify_Call;var Sip_Start=false;var Sip_Updated=false;var No_Internet=false;var Sip_Audio;window.addEventListener("offline",function(b){No_Internet=true;sipUnRegister()},false);window.addEventListener("online",function(b){No_Internet=false;sipStart()},false);$(function(){sipStart()});function addAudio(){var b=document.getElementById("audio_remote");if(b!=undefined){return}else{if(b==undefined){$("body").append('<!-- Sip Audios --><audio id="audio_remote" autoplay="autoplay" />')}}}function startRingTone(d){try{Sip_Audio=new Audio("../res/"+d+".mp3");if(typeof Sip_Audio.loop=="boolean"){Sip_Audio.loop=true}else{var b=function(){this.play()};Sip_Audio.addEventListener("ended",b,false)}Sip_Audio.play()}catch(c){console.log("Error Sip_Audio can not play.")}}function stopRingTone(){try{Sip_Audio.pause()}catch(b){console.log("Error Sip_Audio can not stop.")}}function newIncomingCall(c){if(Sip_Session_Call!=null){alert("Already on call.");c.newSession.hangup()}else{Sip_Session_Call=c.newSession;Sip_Session_Call.setConfiguration(Config_Call);var b=(Sip_Session_Call.getRemoteFriendlyName()||"unknown");User_Name=b;User_Number=removeBracesFromNumber(Sip_Session_Call.getRemoteUri());showIncomingCall()}}function showIncomingCall(){if(notification_prefs&&notification_prefs.call===false){return}showCallNotyPopup("incoming","confirm",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Incoming call </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false);startRingTone("ringtone");show_desktop_notification("../img/plugins/sipIcon.png","Incoming Call :",User_Name+" "+User_Number,undefined,"SipCall");findContact()}function sipSendDTMF(b){if(Sip_Session_Call&&b){play_sound("dtmf");if(Sip_Session_Call.dtmf(b)==0){}}}function showCallNotyPopup(d,b,c,e){if(d==="incoming"||d==="missedCall"){if(notification_prefs&&notification_prefs.call===false){return}}head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/layouts/bottomRight.js",LIB_PATH+"lib/noty/themes/default.js",LIB_PATH+"lib/noty/packaged/jquery.noty.packaged.min.js",function(){if(d=="incoming"){incomingCallNoty(c,b)}else{if(d=="connected"){connectedCallNoty(c,b)}else{if(d=="outgoing"){outgoingCallNoty(c,b)}else{showCallNoty(b,c,e)}}}})}function showCallNoty(b,c,d){if(CALL!=undefined){CALL.close()}CALL=noty({text:c,type:b,layout:"bottomLeft",timeout:d})}function incomingCallNoty(c,b){if(b=="Twilio"){if(Twilio_Call_Noty!=undefined){Twilio_Call_Noty.close()}Twilio_Call_Noty=noty({text:c,type:"confirm",layout:"bottomLeft",buttons:[{addClass:"btn btn-primary noty_twilio_answer",text:"Answer"},{addClass:"btn btn-danger noty_twilio_ignore",text:"Ignore"}]});return}if(CALL!=undefined){CALL.close()}CALL=noty({text:c,type:"confirm",layout:"bottomLeft",buttons:[{addClass:"btn btn-primary answer",text:"Answer"},{addClass:"btn btn-danger ignore",text:"Ignore"}]})}function connectedCallNoty(f,e){if(e=="Twilio"){if(Twilio_Call_Noty!=undefined){Twilio_Call_Noty.close()}Twilio_Call_Noty=noty({text:f,type:"success",layout:"bottomLeft",buttons:[{addClass:"btn noty_twilio_mute",text:'<i class="icon-microphone"></i>'},{addClass:"btn noty_twilio_unmute",text:'<i class="icon-microphone-off"></i>'},{addClass:"btn noty_twilio_dialpad",text:'<i class="icon-th"></i>'},{addClass:"btn btn-danger noty_twilio_hangup",text:"Hangup"}]});if(TWILIO_DIRECTION=="outbound-dial"){var c=$.parseJSON($.ajax({url:"core/api/voicemails",async:false,dataType:"json"}).responseText);var b=$(getTemplate("twilioio-voicemail",c),{});$(".noty_buttons").prepend(b)}var d=$(getTemplate("twilioio-dialpad"),{});$(".noty_buttons").prepend(d);return}if(CALL!=undefined){CALL.close()}CALL=noty({text:f,type:"success",layout:"bottomLeft",buttons:[{addClass:"btn dialpad noty_sip_dialpad",text:'<i class="icon-th"></i>'},{addClass:"btn btn-danger hangup",text:"Hangup"}]})}function outgoingCallNoty(c,b){if(b=="Twilio"){if(Twilio_Call_Noty!=undefined){Twilio_Call_Noty.close()}Twilio_Call_Noty=noty({text:c,type:"confirm",layout:"bottomLeft",buttons:[{addClass:"btn btn-danger noty_twilio_cancel",text:"Cancel"}]});return}if(CALL!=undefined){CALL.close()}CALL=noty({text:c,type:"confirm",layout:"bottomLeft",buttons:[{addClass:"btn btn-danger hangup",text:"Cancel"}]})}function voiceMailDropAction(){$("div.noty_bar").parent().css("overflow","visible")}function makeCall(b){if(Sip_Stack&&!Sip_Session_Call&&!tsk_string_is_null_or_empty(b)){Sip_Session_Call=Sip_Stack.newSession("call-audio",Config_Call);if(Sip_Session_Call.call(b)!=0){Sip_Session_Call=null;showCallNotyPopup("failed","error","Failed to make call.",false);return false}return true}else{if(Sip_Stack!=null&&Sip_Session_Call!=null){alert("Already on call.");return false}else{if(!Sip_Stack){showNotyPopUp("information","You are not register with SIP server, Please refresh the page.","top",5000);return false}}}}function hangupCall(){if(Sip_Session_Call!=null){stopRingTone();Sip_Session_Call.hangup({events_listener:{events:"*",listener:sipSessionEventsListener}})}if(Notify_Call){Notify_Call.cancel();Notify_Call=null}}var recent_view;var recent_view_update_required=false;var MAX_RECENT=6;function populate_recent_menu(){if(!recent_view){var b=[];try{b=JSON.parse(localStorage.recentItems)}catch(c){}recent_view=new Base_Collection_View({restKey:"contacts",templateKey:"recent-menu",data:b,individual_tag_name:"li",sort_collection:false,postRenderCallback:function(d){$("#recent-menu").append($(d).html())}});recent_view.render(true);if(recent_view.collection.length==0){$("#recent-menu>ul").html('<li style="text-align:center;"><a class="disabled">No Recent Activity</a></li>')}else{recent_view.render(true)}}}function add_recent_view(d){if(recent_view==undefined){populate_recent_menu()}if(!recent_view.collection.get(d.get("id"))){if(recent_view.collection.length>=MAX_RECENT){recent_view.collection.pop({silent:true})}recent_view.collection.unshift(d)}else{recent_view.collection.remove(d,{silent:true});recent_view.collection.unshift(d)}recent_view_update_required=true;var b=[];
for(var c=0;c<recent_view.collection.models.length;++c){b.push(recent_view.collection.models[c].attributes)}localStorage.recentItems=JSON.stringify(b)}function modelAction(d){var e=d.dataset.id;var b=recent_view.collection.get(e);var c=b.attributes.entity_type;if(c=="contact_entity"){App_Contacts.navigate("contact/"+e,{trigger:true});$("#contactsmenu").parent().find(".active").removeClass("active");$("#contactsmenu").addClass("active")}else{if(c=="deal"){App_Deal_Details.navigate("deal/"+e,{trigger:true});$("#contactsmenu").parent().find(".active").removeClass("active");$("#contactsmenu").addClass("active")}else{if(c=="case"){updatecases(b)}else{if(c=="document"||b.attributes.network_type){updateDocument(b)}}}}recent_view_update_required=true}$(function(){$("#recent-menu").on("click",function(b){if(recent_view==undefined){populate_recent_menu()}else{if(recent_view_update_required){recent_view.render(true)}}recent_view_update_required=false});$("#recent-menu li:first").mouseenter(function(b){b.stopPropagation();b.preventDefault();$(this).css("background-color","white")});$("#recent-menu").on("click","ul>li",function(c){c.stopPropagation();var b=$(c.target).closest("[data-id]",$(this));if(b.length){modelAction(b[0])}$("#recent-menu").removeClass("open");return false})});var QUERY_RESULTS;var TYPEHEAD_TAGS={};var TYPEHEAD_EMAILS={};function agile_type_ahead(c,d,l,g,e,k,b,m,j){$("#"+c,d).attr("autocomplete","off");if(!b){b="core/api/search/"}var f={};var h=$("#"+c,d).typeahead({timedelay:250,searchAJAXRequest:undefined,source:function(p,q){f={};var o=this;this.options.showLoading(this);var n="";if(e&&e.length){n="&"+e}this.options.searchAJAXRequest=$.getJSON(b+"?q="+encodeURIComponent(p)+"&page_size=10"+n,function(v){var t=$("#"+c,d).val();if(p!=t){return}f=v;QUERY_RESULTS=v;if(v.length==0){var s="<b>No Results Found</b>";if(k&&k.length){s=k}if(s=="email-search"){o.$menu.hide();return}o.$menu.html('<div style="margin-top:10px"><p align="center">'+s+"<p></div>");o.render();return}var u=[];if(l&&typeof(l)==="function"){u=l(v)}$.each(v,function(w,x){tag_name=u[w];TYPEHEAD_TAGS[tag_name]=x.id;TYPEHEAD_EMAILS[tag_name]=getContactEmail(x)});q(u)})},showLoading:function(n){n.$menu.empty();n.$menu.css("width",300);if(!$(n.$menu.find("li").last()).hasClass("loading-results")){n.$menu.html('<li class="divider"></li><li class="loading-results"><p align="center">'+LOADING_ON_CURSOR+"</p></li>");n.render()}},matcher:function(n){if(~n.toLowerCase().indexOf(this.query.toLowerCase())!=0){return ~n.toLowerCase().indexOf(this.query.toLowerCase())}else{return -1}},render:function(){var n=this;if(!f.length){this.show();return}items=buildcategorizedResultDropdown(f,n.options);items.css("overflow","hidden");this.$menu.html(items).show();this.shown=true;return this},updater:function(n){var o=true;var p=true;if(n){var q=n.substr(0,n.lastIndexOf("-"))}if(n){n=n.split(" ").join("")}if(g&&typeof(g)==="function"){if(!n){showSearchResults();return this.query}g(TYPEHEAD_TAGS[n],q);return}if(!n){return}if(m){$.each($("#"+c,d).closest("div.controls").find(".tags").children("li"),function(t,s){if($(s).attr("data")==TYPEHEAD_EMAILS[n]){p=false;return}});if(p&&(TYPEHEAD_EMAILS[n]!="No email")){$("#"+c,d).closest("div.controls").find(".tags").append('<li class="tag"  style="display: inline-block;" data="'+TYPEHEAD_EMAILS[n]+'"><a href="#contact/'+TYPEHEAD_TAGS[n]+'">'+q+'</a><a class="close" id="remove_tag">&times</a></li>')}}else{if(j){$.each($(".deal_tags",d).children("li"),function(t,s){if($(s).attr("data")==TYPEHEAD_TAGS[n]){o=false;return}});if(o){$(".deal_tags",d).append('<li class="tag"  style="display: inline-block;" data="'+TYPEHEAD_TAGS[n]+'"><a href="#deal/'+TYPEHEAD_TAGS[n]+'">'+q+'</a><a class="close" id="remove_tag">&times</a></li>')}}else{$.each($(".tags",d).children("li"),function(t,s){if($(s).attr("data")==TYPEHEAD_TAGS[n]){o=false;return}});if(o){$(".tags",d).append('<li class="tag"  style="display: inline-block;" data="'+TYPEHEAD_TAGS[n]+'"><a href="#contact/'+TYPEHEAD_TAGS[n]+'">'+q+'</a><a class="close" id="remove_tag">&times</a></li>')}}}},keyup:function(q){switch(q.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:case 13:if(!this.shown){return}if(m&&!f.length){this.hide()}else{this.select()}break;case 27:if(!this.shown){return}this.hide();break;case 188:if(m){if(checkEmailValidation(($("#"+c,d).val()).slice(0,-1))){var p=true;var n=($("#"+c,d).val()).slice(0,-1);$.each($("#"+c,d).closest("div.controls").find(".tags").children("li"),function(t,s){if($(s).attr("data")==n){p=false;return}});if(p){$("#"+c,d).closest("div.controls").find(".tags").append('<li class="tag"  style="display: inline-block;" data="'+n+'"><a style="cursor:pointer;">'+n+'</a><a class="close" id="remove_tag">&times</a></li>')}this.select()}else{this.hide()}}break;default:if(this.options.searchAJAXRequest!=null&&(this.options.searchAJAXRequest&&this.options.searchAJAXRequest.readystate!=4)){this.options.searchAJAXRequest.abort()}if(this.timer){clearTimeout(this.timer)}var o=this;f={};this.options.showLoading(o);this.timer=setTimeout(function(){o.lookup()},this.options.timedelay)}q.stopPropagation();q.preventDefault()},hide:function(){this.$menu.hide();this.shown=false;return this},blur:function(o){var n=this;o.stopPropagation();o.preventDefault();setTimeout(function(){if(!n.$menu.is(":focus")){n.hide()}},150)},minLength:2})}$("#remove_tag").die().live("click",function(b){b.preventDefault();$(this).parent().remove()});function contacts_typeahead(c){if(c==null){return}var b=[];$.each(c,function(e,d){var f;if(d.entity_type=="deal"){f=d.name+"-"+d.id}else{f=getContactName(d)+"-"+d.id}b.push(f.split(" ").join(""))});return b}function deals_typeahead(c){if(c==null){return}var b=[];$.each(c,function(d,f){var e;e=f.name.split(" ").join("")+"-"+f.id;b.push(e)});return b}function getContactEmail(b){var c=getPropertyValue(b.properties,"email");c=c!=undefined?c.trim():"";if(c.length){return c}else{return"No email"}}function checkEmailValidation(b){return/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/i.test(b)}function getContactName(c){var f="";if(!c.type||c.type=="PERSON"){var g=getPropertyValue(c.properties,"first_name");var d=getPropertyValue(c.properties,"last_name");d=d!=undefined?d.trim():"";g=g!=undefined?g.trim():"";f=(g+" "+d).trim()}else{if(c.type=="COMPANY"){var b=getPropertyValue(c.properties,"name");b=b!=undefined?b.trim():"";f=b.trim()}}if(f.length){return f}var e=getPropertyValue(c.properties,"email");e=e!=undefined?e.trim():"";if(e.length){return e}return"Company "+c.id}function buildcategorizedResultDropdown(b,c){var e=new Base_Collection_View({data:b,templateKey:"typeahead-contacts",individual_tag_name:"li",typeahead_options:c});e.appendItem=appendItemInResult;var d=e.render(true).el;return $(d)}function appendItemInResult(e){var b=getContactName(e.toJSON())+"-"+e.id;var d=e.toJSON().entity_type;if(d&&d=="deal"){b=e.toJSON().name+"-"+e.id}var c=new Base_List_View({model:e,view:"inline",template:this.options.templateKey+"-model",tagName:"tr"});i=$(this.options.typeahead_options.item).attr("data-value",b);i.addClass("typeahead-border");i.find("a").html(c.render(true).el);if(d){if(d=="contact_entity"){$("#contact-typeahead-heading",this.el).show();$("#contact-results",this.el).append(i)}if(d=="deal"){$("#deal-typeahead-heading",this.el).show();$("#deals-results",this.el).append(i)}if(d=="case"){$("#case-typeahead-heading",this.el).show();$("#case-results",this.el).append(i)}if(d=="document"){$("#document-typeahead-heading",this.el).show();$("#document-results",this.el).append(i)}}}var TAGS;var tagsCollection;var isTagsTypeaheadActive;var tagsTemplate;var tagsCollectionView;function setup_tags_typeahead(){var b=[];if(!TAGS){init_tags_collection();return}TAGS=tagsCollection.models;_(TAGS).each(function(d){var c=d.get("tag");if($.inArray(c,b)==-1){b.push(c)}});if(!$(".tags-typeahead").attr("placeholder")){$(".tags-typeahead").attr("placeholder","Separate tags with commas")}$(".tags-typeahead").attr("autocomplete","off");$(".tags-typeahead").typeahead({source:function(c,d){isTagsTypeaheadActive=false;(this.$menu).empty();d(b);if(this.$menu.find(".active").length>0){isTagsTypeaheadActive=true}},updater:function(c){if(!c||(/^\s*$/).test(c)){return}c=c.trim();if((this.$element).closest(".control-group").hasClass("save-tag")){var d=App_Contacts.contactDetailView.model.toJSON();if($.inArray(c,d.tags)>=0){return}d.tagsWithTime.push({tag:c});saveEntity(d,"core/api/contacts",function(g){$("#addTagsForm").css("display","none");$("#add-tags").css("display","block");var f=[];$.each($("#added-tags-ul").children(),function(h,j){f.push($(j).attr("data"))});App_Contacts.contactDetailView.model.set(g.toJSON(),{silent:true});addTagToTimelineDynamically(c,g.get("tagsWithTime"));if($.inArray(c,f)==-1){$("#added-tags-ul").append('<li style="display:inline-block;" class="tag" data="'+c+'"><span><a class="anchor" href="#tags/'+c+'" >'+c+'</a><a class="close remove-tags" id="'+c+'" tag="'+c+'">&times</a></span></li>')}});return}var e=[];$.each((this.$element).closest(".control-group").find("ul.tags").children("li"),function(g,f){e.push($(f).attr("data"))});if($.inArray(c,e)==-1){(this.$element).closest(".control-group").find("ul.tags").append('<li class="tag"  style="display: inline-block;" data="'+c+'">'+c+'<a class="close" id="remove_tag">&times</a></li>')}}});$("#addTags").die().live("keydown",function(g){if(g.which==13&&!isTagsTypeaheadActive){g.preventDefault();var f=App_Contacts.contactDetailView.model.toJSON();var c=$(this).val().trim();if(!c||c.length<=0||(/^\s*$/).test(c)){return}if(!isValidTag(c,true)){return false}$("#addTags").val("");c=c.trim();var d=[];$.each($("#added-tags-ul").children(),function(e,h){d.push($(h).attr("data"))});if($.inArray(c,d)!=-1){return}f.tagsWithTime.push({tag:c});saveEntity(f,"core/api/contacts",function(e){App_Contacts.contactDetailView.model.set(e.toJSON(),{silent:true});addTagToTimelineDynamically(c,e.get("tagsWithTime"));
tagsCollection.add(new BaseModel({tag:c}));$("#addTagsForm").css("display","none");$("#add-tags").css("display","block");$("#added-tags-ul").append('<li style="display:inline-block;" class="tag" data="'+c+'" ><span><a class="anchor" href="#tags/'+c+'">'+c+'</a><a class="close remove-tags" id="'+c+'" tag="'+c+'">&times</a></span></li>')})}});$(".tags-typeahead").bind("keydown",function(g){if($(this).hasClass("ignore-comma-keydown")){return}var c=$(this).val().trim();if(!c||c.length<=0||(/^\s*$/).test(c)){return}if(g.which==188&&c!=""){g.preventDefault();$(this).val("");var d=$(this).closest(".control-group").find("ul.tags");var f=true;d.find("li").each(function(e,h){if(h.getAttribute("data")==c){f=false;return false}});if(f){d.append('<li class="tag"  style="display: inline-block;" data="'+c+'">'+c+'<a class="close" id="remove_tag" tag="'+c+'">&times</a></li>')}}})}function setup_tags(b){if(!tagsCollection||!tagsCollectionView){init_tags_collection(b,function(c){$("#tagslist",b).html(c)});return}$("#tagslist",b).html(tagsCollectionView.render(true).el)}function get_tags(b){var e=$("#"+b+" .tags").map(function(){var f=[];$.each($(this).children(),function(g,h){f.push(($(h).attr("data")).toString())});return{name:$(this).attr("name"),value:f}}).get();var c=$("#"+b+" input.tags-typeahead");if(c!=null){var d=$(c).val();if(d){d=d.trim();e[0].value.push(d)}}return e}function get_related_deals(b){var c=$("#"+b+" .deal_tags").map(function(){var d=[];$.each($(this).children(),function(e,f){d.push(($(f).attr("data")).toString())});return{name:$(this).attr("name"),value:d}}).get();return c}function get_new_tags(c){if(isValidField(c)){var b=$("#"+c).val();b=b.replace(/ +(?= )/g,"");b=b.replace(", "," ");b=b.replace(","," ");return b}}function init_tags_collection(c,d,b){b=b?b:"/core/api/tags";tagsCollectionView=new Base_Collection_View({url:b,sortKey:"tag",templateKey:"tags"});tagsCollectionView.appendItem=append_tag;tagsCollection=tagsCollectionView.collection;tagsCollectionView.collection.fetch({success:function(e){TAGS=tagsCollection.models;setup_tags_typeahead();if(d&&typeof(d)==="function"){d(tagsCollectionView.render(true).el)}}})}function append_tag(c){var b=c.get("tag");var d=b.charAt(0).toUpperCase();tag_encoded=encodeURIComponent(b);$('div[tag-alphabet="'+encodeURI(d)+'"]',this.el).append('<a href="#tags/'+tag_encoded+'" id="'+tag_encoded.replace(/ +/g,"")+'-in-list">'+b+"</a>&nbsp;")}function remove_tags(b){console.log("removed")}$(function(){$("#refresh-tags").die().live("click",function(b){b.preventDefault();$("#tagslist",App_Contacts.contactsListView.el).html(getRandomLoadingImg());init_tags_collection(App_Contacts.contactsListView.el,function(c){setup_tags(App_Contacts.contactsListView.el);pieTags(App_Contacts.contactsListView.el,true)},"core/api/tags?reload=true")})});$(function(){$("#choose-avatar-modal table td a").die().live("click",function(d){d.preventDefault();var b=$(this).closest(".modal").attr("id");var c=$(this).find("img").attr("src");$(this).closest(".modal-body").find("input[type='hidden']").val(c);$(this).closest(".modal").modal("hide")});$("#choose-avatar-modal").die().live("hide",function(){var b=$(this).find(".modal-body input[type='hidden']").val();if(b){$("input[name='custom_image']").val(b);setImageURL(b)}})});function choose_random_avatar(){var b=["https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/86.png","https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/72.png","https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/17.png","https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/5.png","https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/3.png"];var c=Math.floor((Math.random()*b.length));return b[c]}var businessHoursManager;$(function(){$("#btnSerialize").die().live("click",function(f){f.preventDefault();var d=$(this);disable_save_button($(d));if(!$.trim($("#15mins").val())&&!$.trim($("#30mins").val())&&!$.trim($("#60mins").val())){enable_save_button($(d));$("#meeting_duration_message").fadeIn("slow");setTimeout(function(){$("#meeting_duration_message").fadeOut("slow")},5000);return}if($("#15mins").val().charCodeAt(0)==" "&&$("#30mins").val().charCodeAt(0)==" "&&$("#60mins").val().charCodeAt(0)==" "){enable_save_button($(d));$("#meeting_duration_message").fadeIn("slow");setTimeout(function(){$("#meeting_duration_message").fadeOut("slow")},5000);return}var c=serializeForm("scheduleform");var g=formToJSON();console.log(g);var b=JSON.stringify(businessHoursManager.serialize());c.businesshours_prefs=b;c.meeting_durations=g;console.log(b);$.ajax({url:"/core/api/scheduleprefs",type:"PUT",contentType:"application/json",async:false,data:JSON.stringify(c),success:function(){setTimeout(function(){enable_save_button($(d))},2000);$("#error_message").empty()},error:function(e){$("#error_message").html("There was an error in saving your settings. Please try again in a minute.");enable_save_button($(d))}})})});function formToJSON(){return JSON.stringify({"15mins":$("#15mins").val().trim(),"30mins":$("#30mins").val().trim(),"60mins":$("#60mins").val().trim()})}$(function(){$(".voice-mail-add").die().live("click",function(b){b.preventDefault();$("#uploadVoiceMailModal").modal("show")});$("#uploadVoiceMailModal").on("show",function(){$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error")});$(".addFileLink").live("click",function(c){c.preventDefault();$(this).closest("form").find("#error").html("");var b=$(this).closest("form").attr("id");var f=$(this).find("a").attr("id");if(f&&f=="S3"){var d=window.open("upload-voice-mail.jsp?id="+b+"&t="+CURRENT_USER_PREFS.template+"&d="+CURRENT_DOMAIN_USER.domain,"name","height=310,width=500")}if(window.focus){d.focus()}return false});$("#voicemail_validate").live("click",function(f){f.preventDefault();var d=$(this).closest(".voice-mail-modal").attr("id");var b=$(this).closest(".voice-mail-modal").find("form").attr("id");if(!isValidForm("#"+b)){return false}var c=serializeForm(b);if(b=="uploadVoiceMaiForm"){saveVoiceMail(b,d,this,c)}});$("#uploadVoiceMaiForm").submit(function(b){b.preventDefault()});$(".audioPlay").live("click",function(c){c.preventDefault();audio=$(this).find("audio");$(this).addClass("audioPause");$(this).removeClass("audioPlay");$(this).find("i").removeClass("icon-play");$(this).find("i").addClass("icon-stop");audio.trigger("play");var b=this;audio.bind("ended",function(){$(b).addClass("audioPlay");$(b).removeClass("audioPause");$(b).find("i").removeClass("icon-stop");$(b).find("i").addClass("icon-play")})});$(".audioPause").live("click",function(b){b.preventDefault();audio=$(this).find("audio");$(this).addClass("audioPlay");$(this).removeClass("audioPause");$(this).find("i").removeClass("icon-stop");$(this).find("i").addClass("icon-play");audio.trigger("pause");audio.prop("currentTime",0)})});function saveVoiceMailFileURL(c,d,g){g=g.split("?id=")[1];var b=g.split("&")[0];var f=c.split("?");if(c.match("audiofiles/")){f=f[0];f=f.substring(f.lastIndexOf("/")+1)}else{f=""}$("#"+b).find("#extension").val(f);$("#"+b).find("#network_type").val(d);var e=c.substring(0,c.indexOf("?"));$("#"+b).find("#upload_url").val(e);$(".addFileLink").empty();if(f!=""){$(".addFileLink").html(f)}}function saveVoiceMail(b,g,f,d){if($(f).attr("disabled")){return}disable_save_button($(f));if(b){if(!isValidForm("#"+b)){enable_save_button($(f));return false}var c=$("#"+b).find("#upload_url").val();if(c==""){$("#"+b).find("#error").html('<div class="alert alert-error">Sorry! Voice file not uploaded properly.</div>');enable_save_button($(f));return}}var e=new Backbone.Model();e.url="core/api/voicemails";e.save(d,{success:function(h){App_VoiceMailRouter.VoiceMailCollectionView.collection.add(h);App_VoiceMailRouter.VoiceMailCollectionView.render(true);enable_save_button($(f));if(b){$("#"+b).find("#network_type").val("");$("#"+b).find("#upload_url").val("");$("#"+b).find("#extension").val("");$("#"+b).find(".addFileLink").empty();$("#"+b).find("#error").empty();$("#"+b).find(".addFileLink").html('<a href="#" id="S3"><i class="icon-plus-sign"></i> <span>Add File</span></a>');$("#"+b).each(function(){this.reset()});$("#"+g).modal("hide")}}})}$(function(){var c=null;$(".choose").die().live("click",function(f){f.preventDefault();Selected_Time=$(this).attr("data");var d=JSON.parse(meeting_duration);console.log(d);if(Selected_Time==15){appointmenttype=d["15mins"]}else{if(Selected_Time==30){appointmenttype=d["30mins"]}else{if(Selected_Time==60){appointmenttype=d["60mins"]}}}$(".activemin").removeClass("activemin");$(this).find(".minutes").addClass("activemin");$(".segment2").removeClass("me-disable");$(".segment2").fadeIn("slow");$("#one").addClass("green-bg").html('<i class="fa fa-check"></i>');b(".segment2");var g=typeof InstallTrigger!=="undefined";if(g){$("#datepick").DatePickerSetDate(current_date_mozilla,true)}$(".checkbox-main-grid").html('<img class="loading-img" src="../../img/21-0.gif" style="width: 40px;margin-left: 216px;"></img>');if(!selecteddate){selecteddate=new Date()}if(selecteddate){get_slots(selecteddate,Selected_Time)}});$("#confirm").click(function(d){d.preventDefault();save_web_event("addEventForm",this)});$(".selected-slot").die().live("click",function(f){var d=$(this).attr("id");$(".selected-slot").each(function(){if($(this).attr("id")!=d){$(this).attr("checked",false)}});enableSegment3();$(".segment3").fadeIn("slow");$("#confirm").show();$("#two").addClass("green-bg").html('<i class="fa fa-check"></i>');b(".segment3")});$("#user_timezone").die().change(function(){SELECTED_TIMEZONE=$("#user_timezone").val();$(".timezone1").text(SELECTED_TIMEZONE);$(".timezone1").show();$("#hidetimezone").addClass("hide");if(!selecteddate||!Selected_Time){return}$("#current_local_time").html("Current Time: "+getConvertedTimeFromEpoch(new Date().getTime()/1000));$(".checkbox-main-grid").html('<img class="loading-img" src="../../img/21-0.gif" style="width: 40px;margin-left: 216px;"></img>');get_slots(selecteddate,Selected_Time)});$(".timezone1").die().click(function(){$("#hidetimezone").removeClass("hide");
$(".timezone1").hide()});$("#user_timezone").die().blur(function(){if(SELECTED_TIMEZONE==$("#user_timezone").val()){$(".timezone1").text(SELECTED_TIMEZONE);$(".timezone1").show();$("#hidetimezone").addClass("hide")}});function b(d){console.log($(d).offset().top);$("body,html").animate({scrollTop:$(d).offset().top},1000)}});function getEpochTimeFromDate(b){console.log("in getEpochTimeFromDate");var c=new Date(b);console.log(c);return getGMTTimeFromDate(c)/1000}function getGMTTimeFromDate(c){var b=new Date();console.log(new Date().getHours());console.log(new Date().getMinutes());console.log(new Date().getSeconds());console.log(c.getYear()+","+c.getMonth()+","+c.getDate());c=new Date(c.getFullYear(),c.getMonth(),c.getDate(),0,0,0);return c.getTime()}function GetTimezoneShort(c){if(c==null){return""}var f=c.toString();var d=f.split("(");if(d.length==2){var g=d[1].replace(")","");var e=g.split(" ");var b="";for(i=0;i<e.length;i++){b+=e[i].charAt(0).toUpperCase()}return b}}function createNormalTime(h){var c=0;var d=new Date(h*1000);var f=d.getHours();var g=d.getHours();var e=d.getMinutes();var b=new Array();if(f>12){g=f-12}else{if(f==0){g="12"}}if(g<10){b[c++]="0"}b[c++]=g;b[c++]=":";if(e<10){b[c++]="0"}b[c++]=e;if(f>=12){b[c++]=" pm"}else{b[c++]=" am"}return b.join("")}function getSelectedTimeFromDate(b){b=new Date(b.getFullYear(),b.getMonth(),b.getDate(),b.getHours(),b.getMinutes(),b.getSeconds());return b.getTime()}function getConvertedTimeFromEpoch(c){var b=moment.unix(c);var d=b.tz(SELECTED_TIMEZONE).format("hh:mm a");return d}function getTimezoneOffset(b){return moment.tz.zone(SELECTED_TIMEZONE).offset(new Date().getTime())}function change_availability_date(c){console.log("In change_availability_date");console.log(c);var b=new Date(c);console.log(b);$(".availability").html("Availability on "+b.getDayName()+", "+b.getMonthName()+", "+b.getDate())}function getSlotDurations(){var b="/core/api/webevents/getslotdetails?userid="+User_Id;$.getJSON(b,function(k){var d=k;var h=[];if(slot_array&&slot_array.length>0){for(var g=0;g<slot_array.length;g++){if((parseInt(slot_array[g])-1)<k.length&&parseInt(slot_array[g])!=0){h[g]=slot_array[g]}}if(h.length>0){slot_array=[];slot_array=h}else{$(".segment1").append('<div class="col-sm-12" align="center"><p class="lead" style="color: #777;font-size: 19px;text-align: center;font-weight:normal">please enter valid slot number </p> </div>');return}}if(slot_array&&k.length>=slot_array.length&&slot_array.length>0){k=[];var e=0;for(var g=0;g<slot_array.length;g++){if((parseInt(slot_array[g])-1)<d.length){k[e]=d[parseInt(slot_array[g])-1];e++}}}if(k.length==3){for(var c in k){var f=JSON.parse(k[c]);$(".segment1").append('<div class="col-sm-4"><p title="'+f.title+'" class="choose timeslot-view" data="'+f.time+'"><span class="minutes">'+f.time+" mins</span><br />"+addDotsAtEnd(f.title)+"</p></div>")}$(".segment1").append('<div class="clearfix"></div>')}if(k.length==2){for(var c in k){var f=JSON.parse(k[c]);$(".segment1").append('<div class="col-sm-5 col-md-4" style="margin-left: 99px;"><p title="'+f.title+'" class="choose" data="'+f.time+'"><span class="minutes">'+f.time+" mins</span><br />"+addDotsAtEnd(f.title)+"</p></div>")}$(".segment1").append('<div class="clearfix"></div>')}if(k.length==1){for(var c in k){var f=JSON.parse(k[c]);$(".segment1").append('<div class="col-sm-12" align="center"><p title="'+f.title+'" class="choose" data="'+f.time+'"><span class="minutes">'+f.time+" mins</span><br />"+addDotsAtEnd(f.title)+"</p></div>")}}})}function enableSegment3(){$(".me-disable").removeAttr("disabled");$(".me-disable").removeClass("me-disable")}function resetAll(){var c=new Date();var d=(c.getMonth()+1);if(d<10){d="0"+d}var b=c.getFullYear()+"-"+d+"-"+c.getDate();Selected_Date=b;$("#datepick").DatePickerSetDate(Selected_Date,true);change_availability_date(Selected_Date);$(".checkbox-main-grid").html("");document.getElementById("addEventForm").reset();Available_Slots=null}function get_slots(f,n){console.log("in get_slots");console.log(f+" "+n);var e=getSelectedTimeFromDate(f);var g=$("#user_timezone").val();console.log(g);var m=getEpochTimeFromDate(f);console.log(m);var l=new Date(f);var j=m+l.getSeconds()+(60*l.getMinutes())+(60*60*l.getHours());console.log(j);var h=getEpochTimeFromDate(l);l.setDate(l.getDate()+1);var c=getEpochTimeFromDate(l);console.log(h+"  "+c);var k=getTimezoneOffset();var b="/core/api/webevents/getslots?&user_id="+User_Id+"&date="+f+"&slot_time="+n+"&timezone_name="+g+"&epoch_time="+m+"&selected_time_epoch="+e+"&agile_user_id="+Agile_User_Id+"&timezone="+k;$.getJSON(b,function(d){if(d.length==0){displayNoSlotsMsg();return}Available_Slots=d;displaySlots()})}function displayNoSlotsMsg(){$(".checkbox-main-grid").html("");var b=new Date(selecteddate);console.log(b);$(".availability").html("No slots available for "+b.getDayName()+", "+b.getMonthName()+", "+b.getDate())}function displaySlots(){var e=0,d=0,b=0;$(".checkbox-main-grid").html("");console.log(Available_Slots.length);var h=[];var c=new Date();for(var f=0;f<Available_Slots.length;f++){if(Available_Slots[f][0]*1000>c.getTime()){h.push(Available_Slots[f])}}console.log(h.length);Available_Slots="";Available_Slots=h;if(Available_Slots.length==0){displayNoSlotsMsg();return}var g=Available_Slots.length/5;g++;var l=function(){var j="";for(e=0;e<=g;e++){if(b<Available_Slots.length){j=j+'<li><input class="selected-slot" type="checkbox" id="startTime_'+b+'"name="startTime_'+b+'" value="'+Available_Slots[b][0]+'" /><label for="'+Available_Slots[b][0]+'">'+getConvertedTimeFromEpoch(Available_Slots[b][0])+"</label></li>"}b++}return j};for(d=0;d<5;d++){$(".checkbox-main-grid").append('<li><ul class="checkbox-grid">'+l()+"<ul><li>")}}function isValid(b){console.log(b);$(b).validate();return $(b).valid()}function save_web_event(j,c){if(!isValid("#"+j)){$("#"+j).find("input").focus();return false}var d=$("#"+j).serializeArray();console.log(d);var f={};$.each(d,function(){if(f[this.name]){if(!f[this.name].push){f[this.name]=[f[this.name]]}f[this.name].push(this.value||"")}else{f[this.name]=this.value||""}});console.log(f);f.name="Save in DB";f.slot_time=Selected_Time;f.domainUserId=User_Id;f.agileUserId=Agile_User_Id;f.selectedSlotsString=[];f.timezone=-new Date().getTimezoneOffset();var e=0;for(var b in f){console.log(b);if(b.indexOf("startTime")!=-1){console.log(f[b]);var g=b.split("_");var k={};k.start=Available_Slots[g[1]][0];k.end=Available_Slots[g[1]][1];f.selectedSlotsString[e]=k;e++;console.log(k.start);var h=new Date(k.start*1000);f.date=h.toString()}}console.log(f.selectedSlotsString.length);if(f.selectedSlotsString.length==0){alert("Please select appointment time.");return false}$("#confirm").attr("disabled","disabled");$("#three").addClass("green-bg").html('<i class="fa fa-check"></i>');f.selectedSlotsString=JSON.stringify(f.selectedSlotsString);console.log(f);console.log(JSON.stringify(f));$.ajax({url:"/core/api/webevents/save",type:"PUT",contentType:"application/json; charset=utf-8",data:JSON.stringify(f),dataType:"",complete:function(n,l){console.log(l);var o=JSON.parse(f.selectedSlotsString);var p=o[0];var s=convertToHumanDateUsingMoment("",p.start);if(l=="success"&&n.response!="Sorry. This slot is booked by some one else. Please try another."){$("#mainwrap").addClass("appointment-wrap");var q="/img/appointment_confirmation.png";var m='<div style="margin: 26px;font-size:15px;"><div id="info" ><h3 style="border-bottom: 1px solid #ddd;padding-bottom:8px;margin-bottom:15px;"><img style="margin-right: 8px;margin-top: -4px;" src='+q+"><b>Appointment Scheduled</b></h3><p >Your appointment ("+appointmenttype+") has been scheduled with <b>"+User_Name+"</b> for "+f.slot_time+" mins on "+s+'. </div><div class="row"><div class="col-md-12"><div class="row"><div class="col-md-12"><div class="left"><a class="btn btn-primary" id="create_new_appointment" style="margin-top:20px;">Schedule Another Appointment</a></div></div></div></div><div align="right" style="position: absolute;right: 280px;bottom: -80px;"><span style="display: inherit;font-style: italic; font-family: Times New Roman; font-size: 10px; padding-right: 71px;">Powered by</span> <a href="https://www.agilecrm.com?utm_source=powered-by&amp;medium=event_scheduler&amp;utm_campaign='+domainname+'" rel="nofollow" target="_blank"><img src="https://s3.amazonaws.com/agilecrm/panel/uploaded-logo/1383722651000?id=upload-container" alt="Logo for AgileCRM" style="border: 0;background: white;padding: 0px 10px 5px 2px;height: auto;width: 135px;"></a></div>';resetAll();$(".container").html(m)}else{alert("Something went wrong as your appointment was not scheduled. Please try again in few hours. Error: "+n.statusText);resetAll();location.reload(true)}}})}function convertToHumanDate(c,b){if(!c){c="ddd, mmmm d yyyy, h:MM TT"}if(!b){return}if((b/100000000000)>1){console.log(new Date(parseInt(b)).format(c));return new Date(parseInt(b)).format(c,0)}var e=new Date(parseInt(b)*1000).format(c);return e}function convertToHumanDateUsingMoment(d,c){if(!d){d="ddd, MMM DD YYYY, hh:mm A"}if(!c){return}var c=moment.unix(c);var b=c.tz(SELECTED_TIMEZONE).format(d);return b}$("#create_new_appointment").die().live("click",function(b){location.reload(true)});function addDotsAtEnd(c){if(c){if(c.length>50){var b=c.substr(0,50);b=b+"....";return b}}return c}var Nagger_Noty;function showUpgradeNoty(){if(!_billing_restriction.currentLimits.freePlan){return}if(Current_Route=="subscribe"||Current_Route=="subscribe-plan"||Current_Route=="purchase-plan"){if(Nagger_Noty){$.noty.close(Nagger_Noty)}return}if(Nagger_Noty&&$("#"+Nagger_Noty).length>0){return}showNotyPopUp("warning",get_random_message(),"bottom","none",function(){Nagger_Noty=null;Backbone.history.navigate("subscribe",{trigger:true})})}var CONTACTS_HARD_RELOAD=false;function bulkActivitiesNoty(c,d,b){CONTACTS_HARD_RELOAD=true;if(!b){showNotyPopUp(c,d.message,"bottomRight");return}showNotyPopUp(c,d.message,b)}function showNotyPopUp(d,e,b,f,c){if(b=="top"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/top.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(d,e,b,f,c)
})}if(b=="bottomRight"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/layouts/bottomRight.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(d,e,b,f,c)})}if(b=="bottomLeft"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottomLeft.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(d,e,b,f,c)})}if(b=="bottom"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(d,e,b,f,c)})}}function notySetup(e,f,b,c,d){$.noty.closeAll();var g=noty({text:f,layout:b,type:e,animation:{open:{height:"toggle"},close:{height:"toggle"},easing:"swing",speed:500},timeout:c!=undefined?(c=="none"?undefined:c):20000});if(d&&typeof d=="function"&&g.options.id){Nagger_Noty=g.options.id;$("#"+g.options.id).die().live("click",function(h){d()})}}function get_random_message(){var c=["Thanks for trying Agile CRM. You can upgrade here."];var b=Math.floor((Math.random()*c.length));return c[b]}var TRAIL_PENDING_DAYS;var _TRAIL_DAYS=14;function getPendingdaysIntrail(){if(b){return b}if(!_billing_restriction||!_billing_restriction.createdtime){return(b=14)}var c=(new Date().getTime()/1000)-_billing_restriction.createdtime;var d=c/(24*60*60);var b=_TRAIL_DAYS-d;if(b<0){b=0}b=Math.round(b);return b}function storeData(b,c,d){if(typeof(Storage)!=="undefined"){if(islocalStorageHasSpace()){localStorage.setItem(b,c)}}else{createCookie(b,c,d)}}function readData(b){if(typeof(Storage)!=="undefined"){return localStorage.getItem(b)}else{return raedCookie(b)}}function eraseData(b){if(typeof(Storage)!=="undefined"){return localStorage.removeItem(b)}else{return eraseCookie(b)}}function clearLocalStorage(){var b=new Date();var e=false;var c=1024*1024*5-unescape(encodeURIComponent(JSON.stringify(localStorage))).length;if(c<1242597){localStorage.clear();e=true}else{var d=localStorage.getItem("localStorageExpireDate");if(d){d=new Date(Date.parse(d));if(b>=d){localStorage.clear();e=true}}else{e=true}}if(e){var f=b.getDate()+30;b.setDate(f);localStorage.setItem("localStorageExpireDate",b)}}function islocalStorageHasSpace(){var b=false;var d=1242597;var c=1024*1024*5-unescape(encodeURIComponent(JSON.stringify(localStorage))).length;if(c){if(c>d){b=true}}else{b=true}return b}(function(b){clearLocalStorage()})(jQuery);$(function(){$("#track_visitors").die().live("click",function(b){b.preventDefault();$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/CWMelsl70H4" frameborder="0" allowfullscreen></iframe></p>')});$("#sync_new_signups").die().live("click",function(b){b.preventDefault();$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/CWMelsl70H4" frameborder="0" allowfullscreen></iframe></p>')});$("#automate_email").die().live("click",function(b){b.preventDefault();$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/RXOqougExkM" frameborder="0" allowfullscreen></iframe></p>')});$("#app_messages_popups").die().live("click",function(b){b.preventDefault();$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/XGouq0B_7G8" frameborder="0" allowfullscreen></iframe></p>')})});function initFunnelCharts(b){head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){$("#reportrange").daterangepicker({ranges:{Today:["today","today"],Yesterday:["yesterday","yesterday"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 30 Days":[Date.today().add({days:-29}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})]}},function(e,c){var d=Math.abs(e.getMonth()-c.getMonth()+(12*(e.getFullYear()-c.getFullYear())));$("#reportrange span").html(e.toString("MMMM d, yyyy")+" - "+c.toString("MMMM d, yyyy"));$("#week-range").html(c.add({days:-6}).toString("MMMM d, yyyy")+" - "+c.add({days:6}).toString("MMMM d, yyyy"));b()})});if($("#frequency").length>0){b();$("#frequency").change(function(){b()})}fillSelect("filter","core/api/filters",undefined,function(){$("#filter").change(function(){b()})},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined,"All");b()}function showFunnelGraphs(b){console.log("Showing funnel logs");showFunnel("core/api/reports/funnel/"+b+getOptions(),"funnel-chart","Funnel Reports",true)}function showGrowthGraphs(b){showLine("core/api/reports/growth/"+b+getOptions(),"growth-chart","","",true)}function showCohortsGraphs(c,b){showCohorts("core/api/reports/cohorts/"+c+"/"+b+"/"+getOptions(),"cohorts-chart","Cohort Analysis",c+" vs "+b,true)}function showRatioGraphs(c,b){showLine("core/api/reports/ratio/"+c+"/"+b+"/"+getOptions(),"ratio-chart","Ratio Analysis",c+" vs "+b,true)}function gmap_add_marker(c){gmap_delete_marker();for(var f in c){var e=(c[f].city_lat_long).split(",");var b=new google.maps.LatLng(e[0],e[1]);var d=new google.maps.Marker({position:b,map:window.map,zIndex:c[f].z_index});window.gmap_marker_list.push(d)}map.setZoom(2)}function gmap_set_map(b){for(var c=0;c<window.gmap_marker_list.length;c++){window.gmap_marker_list[c].setMap(b)}}function gmap_delete_marker(){gmap_set_map(null);window.gmap_marker_list=[]}function gmap_initialize(c){console.log("Map API has been loaded.");google.maps.visualRefresh=true;var b={center:new google.maps.LatLng(39,22),zoom:7,mapTypeId:google.maps.MapTypeId.ROADMAP};window.map=new google.maps.Map(document.getElementById("google_map"),b);window.gmap_marker_list=[];gmap_date_range(c,function(){gmap_search_by_date($("#gmap_date_range span").text())})}function gmap_load_script(c){var b=document.createElement("script");b.type="text/javascript";b.src="https://maps.google.com/maps/api/js?sensor=false&callback=gmap_initialize";document.body.appendChild(b)}function gmap_create_table_view(b,c){this.gmapContactsListView=new Base_Collection_View({url:b,data:c,templateKey:"gmap-table",individual_tag_name:"tr",cursor:false,page_size:25,sort_collection:false,postRenderCallback:function(d){console.log("post callback")}});$("#gmap-table-view").html(this.gmapContactsListView.render(true).el)}function gmap_date_range(b,c){$("#gmap_date_range",b).daterangepicker({ranges:{Today:["today","today"],Yesterday:["yesterday","yesterday"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 30 Days":[Date.today().add({days:-29}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})]}},function(e,d){$("#gmap_date_range span").html(e.toString("MMMM d, yyyy")+" - "+d.toString("MMMM d, yyyy"));gmap_search_by_date($("#gmap_date_range span").text())});if(c&&typeof(c)=="function"){c()}}function gmap_search_by_date(k){console.clear();console.log(k);var c="our";var g="&";var f=k.split("-");var e=Date.parse($.trim(f[0])).valueOf();var j=Date.parse($.trim(f[1])).valueOf();g+=("start_date="+e+"&end_date="+j);var h=new Date();g+=("&time_zone="+h.getTimezoneOffset());var b="core/api/gmap/daterange?user_domain="+encodeURIComponent(c)+g;console.log("url: "+b);$("#map-tab-waiting").fadeIn();$.getJSON(b,function(l){console.log("Response: ",l);$("#map-tab-waiting").fadeOut();if(l!=null){for(var d in l){l[d].z_index=parseInt(d)}gmap_add_marker(l);gmap_create_table_view("",l)}else{console.log("No recent visitors available for this date range.")}})}$(function(){var b=false;if(typeof console==="undefined"||typeof console.log==="undefined"){console={};if(b){console.log=function(c){alert(c)}}else{console.log=function(){}}}if(!IS_CONSOLE_ENABLED){console.log=function(){}}});function isRoute(b){if(!Current_Route){return false}return(Current_Route.indexOf(b)==0)}function isModalVisible(){return $(".modal").is(":visible")}$(function(){if(CURRENT_USER_PREFS.keyboard_shotcuts){enableKeyboardShotcuts()}$("#keyboard-shortcuts").die().live("click",function(c){var b=$(getTemplate("shortcut-keys"),{});b.modal("show")})});function enableKeyboardShotcuts(){head.js(LIB_PATH+"lib/mousetrap.min.js",function(){Mousetrap.bind("shift+p",function(){if(isModalVisible()){return}App_Settings.navigate("user-prefs",{trigger:true})});Mousetrap.bind("shift+n",function(){if(!isModalVisible()){$("#personModal").modal("show")}});Mousetrap.bind("shift+t",function(){if(!isModalVisible()){showTaskModal("")}});Mousetrap.bind("shift+e",function(){if(isRoute("contact/")&&!isModalVisible()){App_Contacts.navigate("contact-edit",{trigger:true})}});Mousetrap.bind("shift+m",function(){if(isRoute("contact/")&&!isModalVisible()){App_Contacts.navigate("send-email/"+getCurrentContactProperty("email"),{trigger:true})}});Mousetrap.bind("/",function(b){if(isModalVisible()){return}document.getElementById("searchText").focus();if(b.preventDefault){b.preventDefault()}else{b.returnValue=false}});Mousetrap.bind("n",function(){if(isModalVisible()){return}if(isRoute("contact")){$("#personModal").modal("show")}else{if(isRoute("cases")){showCases()}else{if(isRoute("deals")){show_deal()}else{if(isRoute("workflow")){App_Workflows.navigate("workflow-add",{trigger:true})}else{if(isRoute("report")){App_Reports.navigate("report-add",{trigger:true})}else{if(isRoute("tasks")){showTaskModal("")}else{if(isRoute("calendar")){$("#activityModal").modal("show");highlight_event()}}}}}}}})})}$(function(){$(".stop-propagation").die().live("click",function(b){b.stopPropagation()});$(".log-filters").die().live("click",function(b){b.preventDefault();var c=$(this).data("log-type");var d=$(this).data("campaign-id");App_Workflows.logsToCampaign(d,c,$(this).text())});$("#campaign-reports-select").live("change",function(c){c.preventDefault();var b=$("#campaign-tabs .active").data("campaign-tab-active");if(b=="STATS"){Backbone.history.navigate("email-reports/"+$(this).val(),{trigger:true})
}if(b=="SUBSCRIBERS"){Backbone.history.navigate("workflow/all-subscribers/"+$(this).val(),{trigger:true})}if(b=="LOGS"){Backbone.history.navigate("workflows/logs/"+$(this).val(),{trigger:true})}});$("#save-workflow-top, #save-workflow-bottom, #duplicate-workflow-top, #duplicate-workflow-bottom").live("click",function(g,c){g.preventDefault();var j=$(this);if($(this).attr("disabled")){return}if(!isValidForm("#workflowform")){$("#workflowform").find("input.required").focus();return false}var l=window.frames.designer.serializePhoneSystem();var b=$("#workflow-name").val();var k=$("#unsubscribe-tag").val().trim();var f=$("#unsubscribe-action").val();var h={tag:k,action:f};if(isNotValid(b)){alert("Name not valid");return}disable_save_button($(this));var d={};if(App_Workflows.workflow_model===undefined||$(this).attr("id")==="duplicate-workflow-top"||$(this).attr("id")==="duplicate-workflow-bottom"){create_new_workflow(b,l,h,j,c)}else{d=App_Workflows.workflow_model;App_Workflows.workflow_model.set("name",b);App_Workflows.workflow_model.set("rules",l);App_Workflows.workflow_model.set("unsubscribe",h);App_Workflows.workflow_model.save({},{success:function(){enable_save_button(j);show_campaign_save();add_tag_our_domain(CAMPAIGN_TAG);$("#workflow-edit-msg").hide();if(c&&c.navigate){Backbone.history.navigate("workflows",{trigger:true})}},error:function(m,e,n){enable_save_button(j);alert(e.responseText)}})}});$("#delete_campaign_logs").live("click",function(c){c.preventDefault();var b=$("#logs-table").find("input.campaign").val();if(!b){return}if(!confirm("Are you sure you want to delete all logs?")){return}$.ajax({url:"core/api/campaigns/logs/"+b,type:"DELETE",success:function(){location.reload(true)}})});$("#workflow-designer-help").die().live("click",function(c){c.preventDefault();if($("#workflow-designer-help-modal").size()!=0){$("#workflow-designer-help-modal").remove()}var b=$(getTemplate("workflow-designer-help-modal"),{});b.modal("show");$(b).on("shown",function(){$(this).children("div.modal-body").find("div#workflow-help-detail").html('<h3 style="margin-left:165px">Easy. Peasy.</h3><iframe width="420" height="345" src="//www.youtube.com/embed/0Z-oqK6mWiE?enablejsapi=10&amp;autoplay=1" frameborder="0" allowfullscreen></iframe>')});$(b).on("hide",function(){$(this).children("div.modal-body").find("iframe").removeAttr("src")})});$("#workflow-unsubscribe-option").die().live("click",function(b){b.preventDefault()});$("#workflow-unsubscribe-block").live("shown",function(){$("#workflow-unsubscribe-option").html('<span><i class="icon-minus"></i></span> Manage Unsubscription')});$("#workflow-unsubscribe-block").live("hidden",function(){$("#workflow-unsubscribe-option").html('<span><i class="icon-plus"></i></span> Manage Unsubscription')});$("#unsubscribe-action").die().live("change",function(g){g.preventDefault();var c="Contact will not receive any further emails from any campaign (i.e., the 'Send Email' option will not work. However, other actions in campaign will work as expected)";var f="Contact will be removed from this campaign";var b="Prompts the user with options to either unsubscribe from this campaign or all communication";var d=$(this).closest("div.controls").parent().find("small");if($(this).val()=="UNSUBSCRIBE_FROM_ALL"){d.html(c)}if($(this).val()=="UNSUBSCRIBE_FROM_THIS_CAMPAIGN"){d.html(f)}if($(this).val()=="ASK_USER"){d.html(b)}})});function create_new_workflow(e,g,f,d,c){var b={};b.name=e;b.rules=g;b.unsubscribe=f;var h=new Backbone.Model(b);App_Workflows.workflow_list_view.collection.create(h,{success:function(){enable_save_button(d);show_campaign_save();$("#workflow-edit-msg").hide();if(c&&c.navigate){Backbone.history.navigate("workflows",{trigger:true})}App_Workflows.workflow_model=h},error:function(k,j,l){enable_save_button(d);if(j.status!=406){if(d.attr("id")==="duplicate-workflow-bottom"||d.attr("id")==="duplicate-workflow-top"){if(j.responseText==="Please change the given name. Same kind of name already exists."){alert("Please change the name and click on 'Create a Copy' again.");return}}alert(j.responseText)}else{console.log(j);$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+j.responseText+"</i></p></small></div>");$("#workflow-msg").html($save_info).show()}}})}function fill_logs_slate(d,b){if(b==undefined){b="ALL"}var c={ALL:{title:"No logs for this campaign yet",image:"/img/clipboard.png"},EMAIL_SENT:{title:"No emails sent yet",image:"/img/clipboard.png"},EMAIL_OPENED:{title:"No emails opened in this campaign",image:"/img/clipboard.png"},EMAIL_CLICKED:{title:"No emails clicked in this campaign",image:"/img/clipboard.png"},UNSUBSCRIBED:{title:"No one unsubscribed from this campaign",image:"/img/clipboard.png"},EMAIL_HARD_BOUNCED:{title:"No hard bounces seen for  this campaign",image:"/img/clipboard.png"},EMAIL_SOFT_BOUNCED:{title:"No soft bounces seen for this campaign",image:"/img/clipboard.png"},EMAIL_SPAM:{title:"No spam reports seen for this campaign",image:"/img/clipboard.png"}};$("#"+d).html(getTemplate("empty-collection-model",c[b]))}function show_campaign_save(){var b='<span style="color: green; margin-left: 85px;">Campaign saved.</span>';$("#workflow-msg").html(b).show().fadeOut(3000)}function campaignAlert(d){if(d==null){return}var c={};var b;if(d=="nodeLimit"){c=_billing_restriction.currentLimits;b=$(getTemplate("campaign-node-limit-modal",c))}if(d=="Empty"){c.title="No Twilio Number";c.message="The Twilio SMS gateway you configured does not have a purchased number. Please purchase a number from Twilio to start sending SMS.";b=$(getTemplate("SMSGateway-integration-alert-modal",c))}if(d=="Unauthorised"){c.title="SMS Gateway not Configured";c.message="You need to enable SMS Gateway integration to use this option. Please enable it in Admin Settings -> Integrations";b=$(getTemplate("SMSGateway-integration-alert-modal",c))}b.modal("show")}$(function(){$("#trigger-type").die("change").live("change",function(b){b.preventDefault();if($(this).val()!=="DEAL_MILESTONE_IS_CHANGED"){$("form#addTriggerForm").find("select#trigger-deal-milestone").closest("div.control-group").css("display","none")}if($(this).val()!=="RUNS_DAILY"||$(this).val()!=="RUNS_WEEKLY"||$(this).val()!=="RUNS_MONTHLY"){$("form#addTriggerForm").find("select#contact-filter").closest("div.control-group").css("display","none")}if($(this).val()!=="STRIPE_CHARGE_EVENT"){$("form#addTriggerForm").find("select#trigger-stripe-event").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("select#trigger-stripe-event").val("");$("#trigger-run-on-new-contacts").css("display","none")}if($(this).val()!=="SHOPIFY_EVENT"){$("form#addTriggerForm").find("select#trigger-shopify-event").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("select#trigger-shopify-event").val("");$("#trigger-run-on-new-contacts").css("display","none")}if($(this).val()!=="INBOUND_MAIL_EVENT"){$("form#addTriggerForm").find("div#trigger-inbound-mail-event").css("display","none");$("#new-mail-trigger-run-on-new-contacts").css("display","none")}if($(this).val()!="EMAIL_OPENED"||$(this).val()!="EMAIL_LINK_CLICKED"){$("form#addTriggerForm").find("select#email-tracking-type").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("#custom-link-clicked").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("select#email-tracking-campaign-id").closest("div.control-group").css("display","none")}if($(this).val()!="UNSUBSCRIBED"){$("form#addTriggerForm").find("select#email-tracking-campaign-id").closest("div.control-group").css("display","none")}if($(this).val()!="EVENT_IS_ADDED"){$("form#addTriggerForm").find("select#event-owner-id").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("select#event-type").closest("div.control-group").css("display","none")}if($(this).val()!=="INBOUND_CALL"||$(this).val()!=="OUTBOUND_CALL"){$("form#addTriggerForm").find("div#CALL").closest("div.control-group").css("display","none")}if($(this).val()!="FORM_SUBMIT"){$("form#addTriggerForm").find("select#trigger-form-event").closest("div.control-group").css("display","none");$("#trigger-run-on-new-contacts").css("display","none")}if($(this).val()=="TAG_IS_ADDED"||$(this).val()=="TAG_IS_DELETED"){$("form#addTriggerForm").find("#trigger-custom-tags").closest("div.control-group").css("display","");addTagsDefaultTypeahead($("form#addTriggerForm").find("div#RHS"))}if($(this).val()=="RUNS_DAILY"||$(this).val()=="RUNS_WEEKLY"||$(this).val()=="RUNS_MONTHLY"){populate_contact_filters_in_trigger($("form#addTriggerForm"),"contact-filter")}if($(this).val()=="ADD_SCORE"){$("form#addTriggerForm").find("#trigger-custom-score").closest("div.control-group").css("display","")}if($(this).val()=="DEAL_MILESTONE_IS_CHANGED"){populate_milestones_in_trigger($("form#addTriggerForm"),"trigger-deal-milestone")}if($(this).val()=="STRIPE_CHARGE_EVENT"){populate_stripe_events_in_trigger($("form#addTriggerForm"),"trigger-stripe-event")}if($(this).val()=="SHOPIFY_EVENT"){populate_shopify_events_in_trigger($("form#addTriggerForm"),"trigger-shopify-event")}if($(this).val()=="INBOUND_MAIL_EVENT"){populate_inbound_mail_events_in_trigger($("form#addTriggerForm"),"trigger-inbound-mail-event")}if($(this).val()=="EMAIL_OPENED"||$(this).val()=="EMAIL_LINK_CLICKED"){$("form#addTriggerForm").find("#email-tracking-type").closest("div.control-group").css("display","");if($(this).val()=="EMAIL_LINK_CLICKED"){$("form#addTriggerForm").find("#custom-link-clicked").closest("div.control-group").css("display","")}}if($(this).val()=="EVENT_IS_ADDED"){$("form#addTriggerForm").find("select#event-type").closest("div.control-group").css("display","");populate_owners_in_trigger($("form#addTriggerForm"),"event-owner-id")}if($(this).val()=="INBOUND_CALL"||$(this).val()=="OUTBOUND_CALL"){populate_call_trigger_options($("form#addTriggerForm"))}if($(this).val()=="FORM_SUBMIT"){populate_forms_in_trigger($("form#addTriggerForm"),"trigger-form-event")
}if($(this).val()=="UNSUBSCRIBED"){show_email_tracking_campaigns()}});$("#trigger-cancel").die().live("click",function(b){b.preventDefault();if(history!==undefined){history.back(-1)}});$("#email-tracking-type").die().live("change",function(b){b.preventDefault();if($(this).val()=="ANY"||$(this).val()=="PERSONAL"){$("form#addTriggerForm").find("select#email-tracking-campaign-id").closest("div.control-group").css("display","none");return}show_email_tracking_campaigns()})});function populate_milestones_in_trigger(b,d,c){b.find("select#"+d).closest("div.control-group").css("display","");$("select#"+d).after(getRandomLoadingImg());populateMilestones(b,undefined,0,undefined,function(e){$(".loading").remove();b.find("select#"+d).html(e);if(c!==undefined){b.find("select#"+d).val(c).attr("selected","selected").trigger("change")}},"Select new milestone...")}function populate_contact_filters_in_trigger(c,e,f){c.find("select#"+e).closest("div.control-group").css("display","");var d="<option value='{{id}}'>{{name}}</option>";fillSelect("contact-filter","/core/api/filters","workflow",function b(){if(f){$("#contact-filter",c).find("option[value="+f+"]").attr("selected","selected")}},d,false,undefined,"Select Contact filter")}function populate_stripe_events_in_trigger(c,b,d,e){c.find("select#"+b).closest("div.control-group").css("display","");c.find("#trigger-run-on-new-contacts").css("display","");if(e){c.find("#trigger-run-on-new-contacts").val(e)}if(d!==undefined){c.find("select#"+b).val(d).attr("selected","selected").trigger("change")}}function populate_shopify_events_in_trigger(b,c,d,e){b.find("select#"+c).closest("div.control-group").css("display","");b.find("#trigger-run-on-new-contacts").css("display","");if(e){b.find("#trigger-run-on-new-contacts").val(e)}if(d!==undefined){b.find("select#"+c).val(d).attr("selected","selected").trigger("change")}}function populate_inbound_mail_events_in_trigger(b,c,d){b.find("div#"+c).css("display","");b.find("#new-mail-trigger-run-on-new-contacts").css("display","");if(d){b.find("#new-mail-trigger-run-on-new-contacts").val(d)}}function populate_owners_in_trigger(b,c,e){b.find("select#"+c).closest("div.control-group").css("display","");var d="<option value='{{id}}'>{{name}}</option>";fillSelect(c,"/core/api/users","users",function(){$("#"+c+" option:first").after('<option value="ANY">Any Owner</option>');if(e){$("#"+c,b).find("option[value="+e+"]").attr("selected","selected")}},d,false,undefined,"Select Event Owner")}function populate_call_trigger_options(b,c){b.find("div#CALL").closest("div.control-group").css("display","");if(c&&c.call_disposition){b.find("div#CALL select").find("option[value="+c.call_disposition+"]").attr("selected","selected").trigger("change")}}function populate_forms_in_trigger(b,d,c,f){b.find("#trigger-run-on-new-contacts").css("display","");if(f){b.find("#trigger-run-on-new-contacts").val(f)}b.find("select#"+d).closest("div.control-group").css("display","");var e="<option value='{{id}}'>{{formName}}</option>";fillSelect(d,"core/api/forms","forms",function(){if(c){$("#"+d,b).find("option[value="+c+"]").attr("selected","selected")}},e,false,undefined,"Select Form")}function show_triggers_of_each_workflow(b){if(App_Workflows.triggersCollectionView!=undefined&&App_Workflows.triggersCollectionView.collection.length!=0){append_triggers_to_workflow(b);return}App_Workflows.triggersCollectionView=new Base_Collection_View({url:"/core/api/triggers",restKey:"triggers",templateKey:"triggers",individual_tag_name:"tr"});App_Workflows.triggersCollectionView.collection.fetch({success:function(c){if(App_Workflows.triggersCollectionView==undefined||App_Workflows.triggersCollectionView.collection.length==0){$("#triggers-verification",b).css("display","block");return}append_triggers_to_workflow(b)}})}function append_triggers_to_workflow(b){$(".workflow-triggers",b).each(function(e,f){var d=App_Workflows.triggersCollectionView.collection.where({campaign_id:parseInt($(f).attr("workflow-id"))});var c=new BaseCollection(d,{});if(c.length!==0){$(f).html(getTemplate("workflow-triggers",{triggers:c.toJSON()}))}})}function show_email_tracking_campaigns(){$("form#addTriggerForm").find("select#email-tracking-campaign-id").closest("div.control-group").css("display","");var b="<option value='{{id}}'>{{name}}</option>";fillSelect("email-tracking-campaign-id","/core/api/workflows","workflow",function(){$("#email-tracking-campaign-id option:first").after('<option value="0">All</option>')},b,false)}$(function(){$("#select-all-active-contacts").die().live("click",function(b){b.preventDefault();SUBSCRIBERS_SELECT_ALL=true;$("body").find("#subscribers-bulk-select").css("display","block").html("Selected All "+getAvailableActiveContacts()+' contacts. <a hrer="#" id="select-all-active-contacts-revert" style="cursor:pointer">Select chosen contacts only</a>');$.each($(".tbody_check"),function(c,d){$(d).attr("checked","checked")})});$("#select-all-active-contacts-revert").die().live("click",function(b){b.preventDefault();SUBSCRIBERS_SELECT_ALL=false;$("body").find("#subscribers-bulk-select").css("display","block").html("Selected "+App_Workflows.active_subscribers_collection.collection.length+" contacts. <a href='#'  id='select-all-active-contacts' >Select all "+getAvailableActiveContacts()+" contacts</a>")})});function toggle_active_contacts_bulk_actions_dropdown(e,d){SUBSCRIBERS_SELECT_ALL=false;var b;if(e){b=getAvailableActiveContacts()}$("body").find("#subscribers-bulk-select").css("display","none");if($(e).attr("checked")=="checked"){$("body").find("#remove-active-from-campaign").css("display","inline-block");if(d&&b!=App_Workflows.active_subscribers_collection.collection.length){$("body").find("#subscribers-bulk-select").css("display","block").html("Selected "+App_Workflows.active_subscribers_collection.collection.length+" contacts. <a id='select-all-active-contacts' href='#'>Select all "+b+" contacts</a>")}}else{if(d){$("#remove-active-from-campaign").css("display","none");return}var c=0;$.each($(".tbody_check"),function(f,g){if($(g).is(":checked")){c++;return false}});if(c==0){$("#remove-active-from-campaign").css("display","none")}}}function getAvailableActiveContacts(){if(App_Workflows.active_subscribers_collection.collection.toJSON()[0]&&App_Workflows.active_subscribers_collection.collection.toJSON()[0].count){var b=App_Workflows.active_subscribers_collection.collection.toJSON()[0].count;return b}return App_Workflows.active_subscribers_collection.collection.toJSON().length}function get_campaign_subscribers_collection(c,b,d){var e=new Base_Collection_View({url:b,templateKey:d,individual_tag_name:"tr",cursor:true,page_size:20,postRenderCallback:function(f){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time.campaign-started-time",f).timeago();$("time.campaign-completed-time",f).timeago()})},appendItemCallback:function(f){$("time.campaign-started-time",f).timeago();$("time.campaign-completed-time",f).timeago()}});return e}function fill_subscribers_slate(d,b){var c={"active-subscribers":{title:"Campaign does not have any active subscriber",description:"You can add subscribers from Contacts tab - using the Bulk Actions option",button_text:"Add subscribers",route:"#contacts",image:"/img/clipboard.png"},"completed-subscribers":{title:"No contact assigned to this campaign",description:"You can add subscribers from Contacts tab - using the Bulk Actions option",button_text:"Add subscribers",route:"#contacts",image:"/img/clipboard.png"},"removed-subscribers":{title:"No contact removed from this campaign",description:"Removed subscribers are the contacts deleted from the active campaign",image:"/img/clipboard.png"},"all-subscribers":{title:"No current or past subscribers for this campaign",description:"You can add subscribers from Contacts tab - using the Bulk Actions option",button_text:"Add subscribers",route:"#contacts",image:"/img/clipboard.png"},"unsubscribe-subscribers":{title:"No unsubscriptions for this campaign",description:"Great! No one unsubscribed from this campaign",image:"/img/clipboard.png"},"hardbounced-subscribers":{title:"No hard bounces for this campaign",description:"Great! No email get hardbounced",image:"/img/clipboard.png"},"softbounced-subscribers":{title:"No soft bounces for this campaign",description:"Great! No email get softbounced",image:"/img/clipboard.png"},"spam-reported-subscribers":{title:"No one reported spam for this campaign",description:"Great! No one reported spam yet",image:"/img/clipboard.png"}};$("#"+d).html(getTemplate("empty-collection-model",c[b]))}$(function(){$("body").live("agile_collection_loaded",function(b,c){var j=$("table:not(.ignore-collection)",c);if($(j).find("tbody").attr("route")){$(j).find("tbody").addClass("agile-edit-row")}if($(j).hasClass("onlySorting")){sort_tables(j);return}if($(".grid-view",c).hasClass("showCheckboxes")){if($(this).find("#delete-checked-grid").length==0){var f=$(".showCheckboxes").after('<div class="row-fluid"><div class="span6 select-none"></div></div><a href="#" class="btn btn-danger left" id="delete-checked-grid" style="margin-bottom: 15px"> Delete</a>')}console.log(f);return}var k=$(c).find("table.showCheckboxes");$(k).removeClass("table-bordered");$(k).closest("div.data-block").removeClass("data-block");var g=$(k).find("tbody tr");var d=$(k).find("thead tr");var h=$(d).find(".thead_check");var e=$(g).find(".tbody_check");if(h.length==0){$(d).prepend('<th><input class="thead_check" type="checkbox"/></th>')}if(e.length==0){$(g).prepend('<td style="cursor:default;"><input class="tbody_check" type="checkbox"/></td>')}$(c).find("#delete-checked").remove();if(!$(j).hasClass("noDelete")){$(k).after('<div class="row-fluid"><div class="span6  select-none"></div></div><a href="#" class="btn btn-danger left" id="delete-checked" style="margin-bottom: 15px"> Delete</a>')}if($(j).hasClass("no-sorting")){console.log(j);return}sort_tables(j)});$(".thead_check").live("click",function(b){console.log($(this).is(":checked"));if(!$(this).attr("checked")){$(".tbody_check").removeAttr("checked");
if(Current_Route=="deals"){deal_bulk_actions.toggle_deals_bulk_actions_dropdown(undefined,true,$(this).parents("table").attr("id"))}else{toggle_contacts_bulk_actions_dropdown(undefined,true,$(this).parents("table").attr("id"))}}else{$(".tbody_check").attr("checked","checked")}console.log($(this).attr("checked"));if(Current_Route=="deals"){deal_bulk_actions.toggle_deals_bulk_actions_dropdown(this,true,$(this).parents("table").attr("id"))}else{toggle_contacts_bulk_actions_dropdown(this,true,$(this).parents("table").attr("id"))}});$(".tbody_check").live("click",function(b){b.stopPropagation();if(Current_Route=="deals"){deal_bulk_actions.toggle_deals_bulk_actions_dropdown(this,false,$(this).parents("table").attr("id"))}else{toggle_contacts_bulk_actions_dropdown(this,false,$(this).parents("table").attr("id"))}})});function append_checkboxes(c){var b=$("tr:last > td.select_checkbox",c);if(b.length!=0){if(SELECT_ALL==true||(Current_Route=="deals"&&deal_bulk_actions.SELECT_ALL_DEALS==true)){$(".tbody_check",b).attr("checked","checked")}return}if(SELECT_ALL==true||(Current_Route=="deals"&&deal_bulk_actions.SELECT_ALL_DEALS==true)){$("tr:last",c).prepend('<td><input class="tbody_check" type="checkbox" checked="checked"/></td>')}else{$("tr:last",c).prepend('<td><input class="tbody_check" type="checkbox"/></td>')}}function sort_tables(b){head.js(LIB_PATH+"lib/jquery.tablesorter.min.js",function(){$.tablesorter.addParser({id:"priority",is:function(d){return false},format:function(d){return d.toLowerCase().replace(/high/,2).replace(/normal/,1).replace(/low/,0)},type:"numeric"});$.tablesorter.addParser({id:"time-ago",is:function(d){return false},format:function(f,g,d,e){var h=d.getElementsByTagName("time");if(h){return $(h).attr("value")}},type:"numeric"});$.tablesorter.addParser({id:"money",is:function(d){return false},format:function(e,f,d){return d.getAttribute("value")},type:"numeric"});var c=$(b).attr("id");if(c=="deal-list"){sort_deals(b);return}if(c=="document-list"){sort_documents(b);return}if(c=="case-list"){sort_cases(b);return}if(c=="schedule-updates"){sort_schedule_updates(b);return}if(c=="contact-filter-list"){sort_filters(b);return}basic_table_sort(b)})}function basic_table_sort(b){$(b).tablesorter({headers:{0:{sorter:false}}})}function sort_tasks(b){$(b).tablesorter({headers:{0:{sorter:false},1:{sorter:false},2:{sorter:"text"},3:{sorter:"text"},4:{sorter:"priority"},5:{sorter:"time-ago"},6:{sorter:false}}})}function sort_deals(b){$(b).tablesorter({headers:{0:{sorter:false},1:{sorter:"text"},2:{sorter:false},3:{sorter:"money"},4:{sorter:"text"},5:{sorter:"time-ago"},6:{sorter:false}}})}function sort_documents(b){$(b).tablesorter({headers:{0:{sorter:false},1:{sorter:"text"},2:{sorter:false},3:{sorter:"time-ago"},4:{sorter:false}}})}function sort_cases(b){$(b).tablesorter({headers:{0:{sorter:false},1:{sorter:false},2:{sorter:"text"},3:{sorter:"time-ago"},4:{sorter:false},5:{sorter:"text"}}})}function sort_schedule_updates(b){$(b).tablesorter({headers:{0:{sorter:false},1:{sorter:"text"},2:{sorter:"text"},3:{sorter:"time-ago"},4:{sorter:"text"}}})}function sort_filters(b){$(b).tablesorter({headers:{0:{sorter:false},1:{sorter:"text"},2:{sorter:false}}})}var SCROLL_POSITION;$(function(){$('.agile-edit-row > tr > td:not(":first-child")').live("click",function(d){d.preventDefault();var b=$(".agile-edit-row").attr("route");var c=$(this).closest("tr").find(".data").attr("data");if(b=="contact/"){SCROLL_POSITION=window.pageYOffset}console.log(c);if(c){Backbone.history.navigate(b+c,{trigger:true})}})});var _BULK_CONTACTS=undefined;var current_view_contacts_count=0;var SELECT_ALL=false;$(function(){$("#bulk-owner").live("click",function(g){g.preventDefault();if(!canRunBulkOperations()){showModalConfirmation("Bulk Change Owner","You may not have permission to update some of the contacts selected. Proceeding with this operation will change the owner for only the contacts you are allowed to update.<br/><br/> Do you want to proceed?",b,function(){return},function(){})}else{b()}});function b(){var h,g=[];if(SELECT_ALL==true){h=getSelectionCriteria()}else{g=get_contacts_bulk_ids()}$("body").die("fill_owners").live("fill_owners",function(k){var j="<option value='{{id}}'>{{name}}</option>";fillSelect("ownerBulkSelect","/core/api/users","domainUsers","no-callback ",j)});Backbone.history.navigate("bulk-owner",{trigger:true});$("#changeOwnerToBulk").die().live("click",function(o){o.preventDefault();var j=$("#ownerBulkForm");if($(this).attr("disabled")=="disabled"||!isValidForm(j)){return}var m=$(this);disable_save_button(m);var k;var n=$("#ownerBulkSelect option:selected").attr("value");k="/core/api/bulk/update?action_type=CHANGE_OWNER&owner="+n;var l={};l.contact_ids=g;postBulkOperationData(k,l,j,undefined,function(p){enable_save_button(m)},"Contacts owner change scheduled")})}$("#bulk-campaigns").live("click",function(m){m.preventDefault();var g=get_contacts_bulk_ids();if(g.length===0){count=getAvailableContacts()}else{count=g.length}var k=true;if(!canRunBulkOperations()){k=false;showModalConfirmation("Bulk Assign Campaign","You may not have permission to update some of the contacts selected. Proceeding with this operation will add only your contacts to the campaign.<br/><br/>Do you want to proceed?",e,function(){},function(){return})}if(is_free_plan()&&has_more_than_limit()){k=false;showModalConfirmation("Add to Campaign","You can apply this bulk action only on 25 contacts in the FREE Plan. Please choose lesser number of contacts or upgrade your account.",function(){Backbone.history.navigate("subscribe",{trigger:true})},function(){return},function(){return},"Upgrade","Close")}if(!canSendEmails(count)){k=false;var l=getPendingEmails();var h="Yes";var o="No";var p="";var j=' You may <a href="#subscribe" class="action" data-dismiss="modal" subscribe="subscribe" action="deny">purchase more emails </a> if this does not suffice your bulk action.';var n="Low on emails";if(l<=0){n="Low on emails";h="";o="Ok";p="You have used up all emails in your quota. "+j}else{p="You have only "+l+" emails left as per your quota. "+j+" Continuing with this operation will stop sending emails once it crosses the quota.<br/><br/>Do you want to proceed?"}showModalConfirmation(n,p,e,function(q){if(!q){return}if($(q).attr("subscribe")){Backbone.history.navigate("subscribe",{trigger:true})}return},function(q){},h,o);return}else{if(k){e()}}});function e(){var h=[];var g;if(SELECT_ALL==true){g=getSelectionCriteria()}else{h=get_contacts_bulk_ids()}console.log(g);$("body").die("fill_campaigns").live("fill_campaigns",function(k){var j="<option value='{{id}}'>{{name}}</option>";fillSelect("campaignBulkSelect","/core/api/workflows","workflow","no-callback ",j)});Backbone.history.navigate("bulk-campaigns",{trigger:true});$("#addBulkTocampaign").die().live("click",function(o){o.preventDefault();var j=$("#campaignsBulkForm");if($(this).attr("disabled")=="disabled"||!isValidForm(j)){return}var n=$(this);disable_save_button(n);var m=$("#campaignBulkSelect option:selected").attr("value");var k="/core/api/bulk/update?workflow_id="+m+"&action_type=ASIGN_WORKFLOW";var l={};l.contact_ids=h;postBulkOperationData(k,l,j,undefined,function(p){enable_save_button(n)},"Campaign assigning scheduled")})}$("#bulk-tags").live("click",function(g){g.preventDefault();if(!canRunBulkOperations()){showModalConfirmation("Bulk Add Tag","You may not have permission to update some of the contacts selected. Proceeding with this operation will add tag to only the contacts you are allowed to update.<br/><br/> Do you want to proceed?",f,function(){return},function(){return})}else{f()}});function f(){var g=get_contacts_bulk_ids();Backbone.history.navigate("bulk-tags",{trigger:true});setup_tags_typeahead();$("#addBulkTags").on("focusout",function(j){j.preventDefault();var h=$(this).val().trim();$(this).val("");if(h&&h.length>=0&&!(/^\s*$/).test(h)){$("#addBulkTags").closest(".control-group").find("ul.tags").append('<li class="tag" style="display: inline-block;" data="'+h+'">'+h+'<a class="close" id="remove_tag" tag="'+h+'">&times</a></li>')}});$("#addTagsToContactsBulk").die().live("click",function(o){o.preventDefault();var j=get_tags("tagsBulkForm");var l=$("#addBulkTags").val().trim();$("#addBulkTags").val("");if(l&&l.length>=0&&!(/^\s*$/).test(l)){$("#addBulkTags").closest(".control-group").find("ul.tags").append('<li class="tag" style="display: inline-block;" data="'+l+'">'+l+'<a class="close" id="remove_tag" tag="'+l+'">&times</a></li>')}if(l!=""){j[0].value.push(l)}if(j[0].value.length>0){var n=true;$.each(j[0].value,function(p,q){if(!isValidTag(q,false)){n=false;return false}});if(!n){$(".invalid-tags").show().delay(6000).hide(1);return false}var m=$(this);disable_save_button(m);var h="/core/api/bulk/update?action_type=ADD_TAG";var k={};k.data=JSON.stringify(j[0].value);k.contact_ids=g;postBulkOperationData(h,k,$("#tagsBulkForm"),undefined,function(p){enable_save_button(m);$.each(j[0].value,function(s,q){tagsCollection.add({tag:q})})},"Tags add scheduled")}else{$("#addBulkTags").focus();$(".error-tags").show().delay(3000).hide(1);return}})}$("#bulk-tags-remove").live("click",function(g){g.preventDefault();if(!canRunBulkOperations()){showModalConfirmation("Bulk Remove Tag","You may not have permission to update some of the contacts selected. Proceeding with this operation will delete tag to only the contacts you are allowed to update.<br/><br/> Do you want to proceed?",d,function(){return},function(){return})}else{d()}});function d(){var g=get_contacts_bulk_ids();Backbone.history.navigate("bulk-tags-remove",{trigger:true});setup_tags_typeahead();$("#removeBulkTags").on("focusout",function(j){j.preventDefault();var h=$(this).val().trim();$(this).val("");if(h&&h.length>=0&&!(/^\s*$/).test(h)){$(this).closest(".control-group").find("ul.tags").append('<li class="tag" style="display: inline-block;" data="'+h+'">'+h+'<a class="close" id="remove_tag" tag="'+h+'">&times</a></li>')}});$("#removeTagsToContactsBulk").die().live("click",function(n){n.preventDefault();
var j=get_tags("tagsRemoveBulkForm");var l=$("#removeBulkTags").val().trim();$("#removeBulkTags").val("");if(l&&l.length>=0&&!(/^\s*$/).test(l)){$("#removeBulkTags").closest(".control-group").find("ul.tags").append('<li class="tag" style="display: inline-block;" data="'+l+'">'+l+'<a class="close" id="remove_tag" tag="'+l+'">&times</a></li>')}if(l!=""){j[0].value.push(l)}if(j[0].value.length>0){var m=$(this);disable_save_button(m);var h="/core/api/bulk/update?action_type=REMOVE_TAG";var k={};k.data=JSON.stringify(j[0].value);k.contact_ids=g;postBulkOperationData(h,k,$("#tagsRemoveBulkForm"),undefined,function(o){enable_save_button(m);$.each(j[0].value,function(q,p){tagsCollection.add({tag:p})})},"Tags delete scheduled")}else{$("#removeBulkTags").focus();$(".error-tags").show().delay(3000).hide(1);return}})}$("#bulk-email").live("click",function(l){l.preventDefault();if(!canRunBulkOperations()){showModalConfirmation("Bulk Email","You may not be the owner for some of the contacts selected. Proceeding with this operation will send email to only your contacts.<br/><br/> Do you want to proceed?",c,function(){return},function(){return})}if(is_free_plan()&&has_more_than_limit()){showModalConfirmation("Send Email","You can apply this bulk action only on 25 contacts in the FREE Plan. Please choose lesser number of contacts or upgrade your account.",function(){Backbone.history.navigate("subscribe",{trigger:true})},function(){return},function(){return},"Upgrade","Close")}else{var j=get_contacts_bulk_ids();if(j.length===0){count=getAvailableContacts()}else{count=j.length}if(!canSendEmails(count)){var h=getPendingEmails();var o="Yes";var n="No";var k="";var g='Please <a href="#subscribe" class="action" data-dismiss="modal" subscribe="subscribe" action="deny">upgarde your email subscription.</a>';var m="Not enough emails left";if(h<=0){m="Emails limit";o="";n="Ok";k="You have used up all emails in your quota. "+g}else{k="You have only "+h+" emails remaining as per your quota. "+g+" Continuing with this operation may not send the email to some contacts. <br/><br/>Do you want to proceed?"}showModalConfirmation(m,k,c,function(p){if(!p){return}if($(p).attr("subscribe")){Backbone.history.navigate("subscribe",{trigger:true})}},function(p){},o,n);return}c()}});function c(){var h=0;var g=get_contacts_bulk_ids();$("body").die("fill_emails").live("fill_emails",function(k){var j=$("#emailForm");populate_send_email_details();setupTinyMCEEditor("textarea#email-body",false,undefined,function(){set_tinymce_content("email-body","")});if(g.length===0){h=getAvailableContacts()}else{h=g.length}j.find("div#bulk-count").css("display","inline-block");j.find("div#bulk-count p").html("Selected <b>"+h+" contacts</b> for sending email.");j.find('input[name="to"]').closest(".control-group").attr("class","hidden");j.find("a#cc-link").closest(".control-group").attr("class","hidden");j.find(".form-actions a#sendEmail").removeAttr("id").attr("id","bulk-send-email");j.find(".form-actions a#send-email-close").removeAttr("id")});Backbone.history.navigate("bulk-email",{trigger:true});$("#bulk-send-email").die().live("click",function(n){n.preventDefault();if($(this).attr("disabled")){return}var j=$("#emailForm");if(!isValidForm(j)){return}disable_send_button($(this));save_content_to_textarea("email-body");var m=serializeForm("emailForm");if(m.from_email!=CURRENT_DOMAIN_USER.email&&m.from_name==CURRENT_DOMAIN_USER.name){m.from_name=""}var k="/core/api/bulk/update?action_type=SEND_EMAIL";var l={};l.contact_ids=g;l.data=JSON.stringify(m);postBulkOperationData(k,l,j,null,function(){enable_send_button($("#bulk-send-email"))},"Emails have been queued for "+h+" contacts. They will be sent shortly.")})}$("#bulk-contacts-export").live("click",function(k){k.preventDefault();if($("#contacts-export-csv-modal").size()!=0){$("#contacts-export-csv-modal").remove()}var h=get_contacts_bulk_ids();var j=0;if(h.length===0){j=getAvailableContacts()}else{j=h.length}var g=$(getTemplate("contacts-export-csv-modal"),{});g.modal("show");$("#contacts-export-csv-confirm").die().live("click",function(n){n.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");$save_info=$('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>Email will be sent shortly.</i></small></span>');$(this).parent(".modal-footer").find(".contacts-export-csv-message").append($save_info);$save_info.show();var l="/core/api/bulk/update?action_type=EXPORT_CONTACTS_CSV";var m={};m.contact_ids=h;m.data=JSON.stringify(CURRENT_DOMAIN_USER);postBulkOperationData(l,m,undefined,undefined,function(){setTimeout(function(){g.modal("hide")},3000);$("body").find("#bulk-actions").css("display","none");$("body").find("#bulk-select").css("display","none");$("table#contacts-table").find(".thead_check").removeAttr("checked");$("table#contacts-table").find(".tbody_check").removeAttr("checked")},"no_noty")})});$("#bulk-companies-export").live("click",function(k){k.preventDefault();if($("#companies-export-csv-modal").size()!=0){$("#companies-export-csv-modal").remove()}var h=get_contacts_bulk_ids();var j=0;if(h.length===0){j=getAvailableContacts()}else{j=h.length}var g=$(getTemplate("companies-export-csv-modal"),{});g.modal("show");$("#companies-export-csv-confirm").die().live("click",function(n){n.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");$save_info=$('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>Email will be sent shortly.</i></small></span>');$(this).parent(".modal-footer").find(".companies-export-csv-message").append($save_info);$save_info.show();var l="/core/api/bulk/update?action_type=EXPORT_COMPANIES_CSV";var m={};m.contact_ids=h;m.data=JSON.stringify(CURRENT_DOMAIN_USER);postBulkOperationData(l,m,undefined,undefined,function(){setTimeout(function(){g.modal("hide")},3000);$("body").find("#bulk-actions").css("display","none");$("body").find("#bulk-select").css("display","none");$("table#companies").find(".thead_check").removeAttr("checked");$("table#companies").find(".tbody_check").removeAttr("checked")},"no_noty")})});$("#select-all-available-contacts").die().live("click",function(g){g.preventDefault();SELECT_ALL=true;_BULK_CONTACTS=window.location.hash;$("body").find("#bulk-select").css("display","block").html("Selected All "+getAvailableContacts()+' contacts. <a hrer="#" id="select-all-revert" style="cursor:pointer">Select chosen contacts only</a>');$.each($(".tbody_check"),function(h,j){$(j).attr("checked","checked")})});$("#select-all-revert").die().live("click",function(g){g.preventDefault();SELECT_ALL=false;_BULK_CONTACTS=undefined;$("body").find("#bulk-select").css("display","block").html("Selected "+App_Contacts.contactsListView.collection.length+" contacts. <a href='#'  id='select-all-available-contacts' >Select all "+getAvailableContacts()+" contacts</a>")})});function get_contacts_bulk_ids(){var b=[];if(SELECT_ALL==true){return b}var c=$("body").find(".showCheckboxes");if($(".grid-view").length!=0){$(c).find(".tbody_check").each(function(d,e){if($(e).is(":checked")){b.push($(e).parent("div").attr("id"))}});return b}$(c).find("tr .tbody_check").each(function(d,e){if($(e).is(":checked")){b.push($(e).closest("tr").data().get("id"))}});return b}function toggle_contacts_bulk_actions_dropdown(f,e,d){SELECT_ALL=false;_BULK_CONTACTS=undefined;if(d==="active-campaign"){toggle_active_contacts_bulk_actions_dropdown(f,e);return}var b=getAvailableContacts();console.log(readCookie("contact_filter"));$("body").find("#bulk-select").css("display","none");if($(f).attr("checked")=="checked"){$("body").find("#bulk-actions").css("display","block");if(e&&b!=App_Contacts.contactsListView.collection.length){$("body").find("#bulk-select").css("display","block").html("Selected "+App_Contacts.contactsListView.collection.length+" contacts. <a id='select-all-available-contacts' href='#'>Select all "+b+" contacts</a>")}}else{if(e){$("#bulk-actions").css("display","none");return}var c=0;$.each($(".tbody_check"),function(g,h){if($(h).is(":checked")){c++;return false}});if(c==0){$("#bulk-actions").css("display","none")}}}function getAvailableContacts(){if(App_Contacts.contactsListView.collection.toJSON()[0]&&App_Contacts.contactsListView.collection.toJSON()[0].count){current_view_contacts_count=App_Contacts.contactsListView.collection.toJSON()[0].count;return current_view_contacts_count}return App_Contacts.contactsListView.collection.toJSON().length}function getSelectionCriteria(){var b=$(".filter-criteria",$(App_Contacts.contactsListView.el)).attr("_filter");if(b&&_BULK_CONTACTS=="#contacts"){return b}if(_BULK_CONTACTS){return _BULK_CONTACTS}}function postBulkOperationData(b,f,e,h,g,d){var c=getDynamicFilters();if(c!=null){f.dynamic_filter=c}if(f.contact_ids&&f.contact_ids.length==0){console.log(f.contact_ids);console.log(getSelectionCriteria());if(c==null){b=b+"&filter="+encodeURIComponent(getSelectionCriteria())}console.log(b)}else{f.contact_ids=JSON.stringify(f.contact_ids)}f.tracker=Math.floor(Math.random()*(10000-1))+1;h=h!=undefined?h:"application/x-www-form-urlencoded";$.ajax({url:b,type:"POST",data:f,contentType:h,success:function(k){$save_info=$('<div style="display:inline-block"><small><p class="text-success"><i>Task Scheduled.</i></p></small></div>');if(e!==undefined){var j=$(e).find(".form-actions");if(j.find(".text-success")){j.find(".text-success").parent().parent().remove()}j.append($save_info)}if(g&&typeof(g)==="function"){g(k)}Backbone.history.navigate("contacts",{trigger:true});if(d==="no_noty"){return}if(!d){showNotyPopUp("information","Task scheduled","top",5000);return}showNotyPopUp("information",d,"top",5000)}})}function getDynamicFilters(){var b=null;if(readCookie("company_filter")){b=readData("dynamic_company_filter")}else{b=readData("dynamic_contact_filter")
}if(!b||b==null){return null}else{if(JSON.parse(b).rules.length>0){return b}else{return null}}}function bulkOperationContactsCount(){if(SELECT_ALL==true){return getAvailableContacts()}else{var b=get_contacts_bulk_ids();return b.length}}function has_more_than_limit(){if(bulkOperationContactsCount()>25){return true}return false}$(function(){$("#delete-checked, .delete-checked-contacts").die().live("click",function(h){h.preventDefault();var e=[];var d=[];var j=[];var g=false;var f=$("body").find(".showCheckboxes");$(f).find("tr .tbody_check").each(function(k,l){if($(l).is(":checked")){$(l).closest("tr").on("mouseenter",false);d.push(k);if(!$(l).closest("tr").hasClass("pseduo-row")){e.push($(l).closest("tr").data().get("id"));j.push($(l).closest("tr").data().toJSON());g=true}}});if(g){if(!canRunBulkOperations()){showModalConfirmation("Bulk Delete","You may not have permission to delete some of the contacts selected. Proceeding with this operation will delete only the contacts that you are permitted to delete.<br/><br/> Do you want to proceed?",function(){if(!customize_bulk_delete(e,j)){return}$(this).after('<img class="bulk-delete-loading" style="padding-right:5px;margin-bottom:15px" src= "img/21-0.gif"></img>');var k=$(f).attr("url");if(SELECT_ALL==true){if($(f).attr("id")=="contacts-table"||$(f).attr("id")=="companies"){var l=getDynamicFilters();if(l==null){k=k+"&filter="+encodeURIComponent(getSelectionCriteria())}}}if(SUBSCRIBERS_SELECT_ALL==true){if($(f).attr("id")=="active-campaign"){k=k+"&filter=all-active-subscribers"}}bulk_delete_operation(k,e,d,f,undefined,j)},function(){return},function(){})}else{if(!customize_delete_message(f)){return}if(!customize_bulk_delete(e,j)){return}$(this).after('<img class="bulk-delete-loading" style="padding-right:5px;margin-bottom:15px" src= "img/21-0.gif"></img>');var b=$(f).attr("url");if(SELECT_ALL&&SELECT_ALL==true){if($(f).attr("id")=="contacts-table"||$(f).attr("id")=="companies"){var c=getDynamicFilters();if(c==null){b=b+"&filter="+encodeURIComponent(getSelectionCriteria())}}}if(SUBSCRIBERS_SELECT_ALL&&SUBSCRIBERS_SELECT_ALL==true){if($(f).attr("id")=="active-campaign"){b=b+"&filter=all-active-subscribers"}}bulk_delete_operation(b,e,d,f,undefined,j)}}else{if($(this).attr("disabled")==="disabled"){return}$("body").find(".select-none").html('<div class="alert alert-error"><a class="close" data-dismiss="alert" href="#">&times;</a>You have not selected any records to delete. Please select at least one record to continue.</div>').show().delay(3000).hide(1)}});$("#delete-checked-grid").die().live("click",function(f){f.preventDefault();var c=[];var b=[];var g=[];var e=false;var d=$("body").find(".showCheckboxes");$(d).find(".tbody_check").each(function(h,j){if($(j).is(":checked")){console.log($(j).parent("div").attr("id"));b.push(h);console.log(b);c.push($(j).parent("div").attr("id"));e=true}});if(e){if(!canRunBulkOperations()){showModalConfirmation("Bulk Delete","You may not have permission to delete some of the contacts selected. Proceeding with this operation will delete only the contacts that you are permitted to delete.<br/><br/> Do you want to proceed?",function(){if(!customize_bulk_delete(c,g)){return}bulk_delete_operation($(d).attr("url"),c,b,d,true,g)},function(){return},function(){})}else{if(!confirm("Are you sure you want to delete?")){return}if(!customize_bulk_delete(c,g)){return}bulk_delete_operation($(d).attr("url"),c,b,d,true,g)}}else{$("body").find(".select-none").html('<div class="alert alert-error"><a class="close" data-dismiss="alert" href="#">&times;</a>You have not selected any records to delete. Please select at least one record to continue.</div>').show().delay(3000).hide(1)}})});function customize_bulk_delete(b,c){if(Current_Route=="users"){$.each(c,function(e,d){if(d.is_admin){b.splice(b.indexOf(d.id),1)}});if(b.length==0){$("body").find(".select-none").html('<div class="alert alert-error"><a class="close" data-dismiss="alert" href="#">&times;</a>Sorry, can not delete user with <i>admin</i> privilege.</div>').show().delay(5000).hide(1);return false}}return true}function bulk_delete_operation(b,f,e,g,j,h){var d={};if(!SELECT_ALL){d.ids=JSON.stringify(f)}var c=getDynamicFilters();if(c!=null){d.dynamic_filter=c}$.ajax({url:b,type:"POST",data:d,contentType:"application/x-www-form-urlencoded",success:function(){if(b=="core/api/tasks/bulk"){var k=getDueTasksCount();if(k==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}$("#due_tasks_count").html(k)}$(".bulk-delete-loading").remove();if($(g).attr("id")=="contacts-table"){showNotyPopUp("information","Your contacts deletion will be processed shortly","top",5000)}if($(g).attr("id")=="companies"){showNotyPopUp("information","Your companies deletion will be processed shortly","top",5000)}if(!j){var l=$(g).find("tbody");for(var m=0;m<e.length;m++){$(l).find("tr:eq("+e[m]+")").fadeOut(300,function(){$(this).remove()})}}else{for(var m=0;m<f.length;m++){$("."+f[m]).fadeOut(300,function(){$(this).remove()})}}$(".thead_check").attr("checked",false);toggle_contacts_bulk_actions_dropdown(undefined,true,$(".thead_check").parents("table").attr("id"));if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){activate_timeline_tab();$.each(h,function(n,o){var p=$("#"+o.id);$("#timeline").isotope("remove",p)})}}})}function customize_delete_message(c){var b="Are you sure you want to delete?";if($(c).attr("id")==="active-campaign"){b="Delete selected contacts from "+$("#subscribers-campaign-name").text()+" Campaign?"}if(!confirm(b)){return false}return true}$(function(){$("#email").live("focusout",function(d){d.preventDefault();var f=$("#email").val();if(f.length==0){$("#pic").css("display","none");changeProperty();return}var b=getPicByEmail(f,45);if(b!=undefined&&b!=null){var c=$('<img class="imgholder thumbnail person-img" onload="changeProperty()" style="display: inline;"  src="'+b+'"></img>');$("#pic").html(c).show();$("img").error(function(){$("#pic").css("display","none");changeProperty()})}})});function getPicByEmail(b,c){if(b){return"https://secure.gravatar.com/avatar/"+Agile_MD5(b)+".jpg?s="+c+"&d=404"}}$(function(){$("#helpMail").die().live("click",function(d){d.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm($("#helpmailForm"))){return}disable_send_button($(this));var c=serializeForm("helpmailForm");c.body=c.body.replace(/\r\n/g,"<br/>");var b="core/api/emails/contact-us?from="+encodeURIComponent(CURRENT_DOMAIN_USER.email)+"&to="+encodeURIComponent(c.to)+"&subject="+encodeURIComponent(c.subject)+"&body="+encodeURIComponent(c.body);$.post(b,function(){$("#helpmailForm").each(function(){this.reset()});$save_info=$('<span class="text-success" style="color:#008000; font-size:15px; display:inline-block"><i> Email Sent</i></span>');$("#msg").append($save_info);$save_info.show().delay(1000).fadeOut("slow",function(){enable_send_button($("#helpMail"));window.history.back()})})})});var LOADING_HTML='<img class="loading" style="padding-right:5px;" height="32px" width="32px" src= "img/21-0.gif"></img>';LOADING_HTML_IMAGES=[LOADING_HTML];var LOADING_ON_CURSOR='<img class="loading" style="padding-right:5px" src= "img/ajax-loader-cursor.gif"></img>';var DEFAULT_GRAVATAR_url="https://dpm72z3r2fvl4.cloudfront.net/css/images/user-default.png";function getRandomLoadingImg(){var b=LOADING_HTML_IMAGES.length;return LOADING_HTML_IMAGES[Math.round(Math.random()*(LOADING_HTML_IMAGES.length-1))]}function getUrlVars(){var e=[],d;var b=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");for(var c=0;c<b.length;c++){d=b[c].split("=");e.push(d[0]);e[d[0]]=d[1]}return e}function fillSelect(d,c,b,l,k,g,e,j){var f=Backbone.Collection.extend({url:c});$loading=$(getRandomLoadingImg());$("#"+d,e).after($loading);var h=new f();h.fetch({success:function(){$loading.remove();if(g){$("#"+d,e).empty()}else{if(!j){j="Select..."}$("#"+d,e).empty().append('<option class="default-select" value="">'+j+"</option>")}var m=h.toJSON();m.sort(function(p,o){if(p.name<o.name){return -1}if(o.name<p.name){return 1}return 0});var n=Handlebars.compile(k);$.each(m,function(q,p){var o=n(p);$("#"+d,e).append(o)});if(l&&typeof(l)==="function"){l()}}})}function fillTokenizedSelect(b,e,d,c){if(!c){c="Select..."}$("#"+b).empty().append('<option value="">'+c+"</option>");$.each(e,function(f,g){$("#"+b).append('<option value="'+g+'">'+g+"</option>")});if(d&&typeof(d)==="function"){d()}}function fillMilestones(c,b){$("#"+c).empty();$.each(b,function(d,e){$("#"+c).append('<a href="#"><li value="'+e+'">'+e+"</li></a>")})}function btnDropDown(c,b){}function delete_contact_property(b,c){for(var d=0;d<b.properties.length;d++){if(b.properties[d].name==c){b.properties.splice(d,1);--d}}return b}function delete_contact_tag(b,c){$.each(b.tagsWithTime,function(e,d){if(d.tag==c){b.tags.splice(e,1);b.tagsWithTime.splice(e,1);return false}b.tags.push(d.tag)});return b}function add_contact_tags(b,c){for(var d=0;d<c.length;d++){b.tags.push(c[d])}return b}function property_JSON(b,h,e){var c={};if(e==undefined){c.type="SYSTEM"}else{c.type=e}c.name=b;var g=$("#"+h),d=g.attr("type"),f;if(d=="checkbox"){f=g.is(":checked")?"on":"off"}else{f=g.val()}c.value=f;return c}function saveEntity(d,c,e){var b=new Backbone.Model();b.url=c;b.save(d,{success:function(f){if(e&&typeof(e)==="function"){e(f)}}})}function getGMTEpochFromDate(c){var b=new Date();console.log(new Date().getHours());console.log(new Date().getMinutes());console.log(new Date().getSeconds());console.log(c.getYear()+","+c.getMonth()+","+c.getDate());c=new Date(c.getFullYear(),c.getMonth(),c.getDate(),0,0,0);return c.getTime()+(c.getTimezoneOffset()*60*1000)}function getLocalTimeFromGMTMilliseconds(c){var b=new Date(parseInt(c));return b.getTime()-(b.getTimezoneOffset()*60*1000)}function showTextGravatar(b,c){var d=$(b,$(c));$(d).closest("img").error(function(){var e=$(this).attr("_data-name");if(!e){return
}$(this).attr("data-name",e);$(this).initial({charCount:2})})}function text_gravatar_initials(c){if(c==undefined){return}var e="";var g;var b;var e="";if(getPropertyValue(c,"first_name")){g=getPropertyValue(c,"first_name")}if(getPropertyValue(c,"last_name")){b=getPropertyValue(c,"last_name")}if(g&&b){e=g.substr(0,1);e+=b.substr(0,1)}else{if(g){var f=g.length;if(f>1){e=g.substr(0,2)}else{e=g.substr(0,1)}}else{if(b){var h=b.length;if(h>1){e=b.substr(0,2)}else{e=b.substr(0,1)}}}}if(e.length==0){var d=getPropertyValue(c,"email");if(d){if(d.length>1){e=d.substr(0,2)}}}if(e.length==0){e="X"}console.log(e);return e}function buildFacebookProfileURL(b){b=b.replace("@","");var c=(b.indexOf("http://")===0||b.indexOf("https://")===0);var d=(b.indexOf("facebook.com")!==-1);if(b&&!c&&!d){b="https://www.facebook.com/"+b}else{if(b&&d&&b.indexOf("www.facebook.com")===-1){b=b.replace("facebook.com","www.facebook.com")}else{if(b&&!c){b="http://"+b}}}return b}audio=null;function play_sound(d,e){var b;if(d){b="../res/"+d+".mp3"}else{b="../res/sound.wav"}if(e){b=d}try{audio=new Audio(b);audio.play()}catch(c){console.log("Error occured while playing sound "+c)}}$(function(){$("#domainSearchForm").submit(function(c){c.preventDefault(c);var b=$("#domainSearchText").val();console.log(" in all -domain users.js "+b);Backbone.history.navigate("getDomainUserDetails/"+b,{trigger:true})});$(".delete_user").die().live("click",function(b){b.preventDefault();if(!confirm("Are you sure you want to delete ?")){return}var c=$(this).closest("a").attr("data");$.ajax({url:"/core/api/admin_panel/deleteuser?id="+c,type:"DELETE",success:function(d){add_delete_user_info_as_note_to_owner(email);alert("user deleted");location.reload(true)},error:function(d){alert("error in deletion ")}})});$("#all-domain-users-model-list > tr").live("click",function(c){c.preventDefault();var b=$(this).find(".data").attr("data");Backbone.history.navigate("getDomainUserDetails/"+b,{trigger:true})});$(".delete-namespace").die().live("click",function(c){c.preventDefault();var b=$(this).closest("a").attr("data");if(b!=""){if(!confirm("Are you sure you want to delete ?")){return}$("#content").html(getRandomLoadingImg());$.ajax({type:"DELETE",url:"core/api/admin_panel/deletedomain/"+b,success:function(d){alert("account deleted");Backbone.history.navigate("all-domain-users",{trigger:true})}})}});$(".refundpopup").live("click",function(b){b.preventDefault();var f=$(this).attr("chargeid");var d=$(this).attr("totalamount");var c=$(this).attr("refundedAmount");$("#errormsg").html("");$("#amount").val(d-c);$("#hchargeid").val(f);$("#totamount").val(d);$("#partialrefund").button("reset");$("#refundModal").modal("show")});$("#partialrefund").die().live("click",function(c){c.preventDefault();if(!isValidForm($("#CCform"))){return}$(this).button("loading");var b=$("#amount").val();var d=$(".totamount").val();var f=$("#hchargeid").val();if(parseFloat(b)<=0){$("#errormsg").html("Amount should be > 0").show().delay(1500).hide(1);$("#partialrefund").button("reset");return}if(parseFloat(b)>parseFloat(d)){$("#errormsg").html("Amount Should not exceed "+d).show().delay(1500).hide(1);$("#partialrefund").button("reset");return}b=100*b;b=parseInt(b.toPrecision(12));$.ajax({url:"/core/api/admin_panel/applypartialrefund?chargeid="+f+"&amount="+b,type:"GET",success:function(e){alert("successfully applied for refund");location.reload(true)},error:function(e){$("#partialrefund").button("reset");showNotyPopUp("information","error occured please try again","top")}})});$(".refund").die().live("click",function(b){b.preventDefault();if(!confirm("Are you sure you want to apply for refund ?")){return}var c=$(this).attr("data");$.ajax({url:"/core/api/admin_panel/applyrefund?chargeid="+c,type:"GET",success:function(e){var d=e.refunds.data[0].amount/100;add_refunded_info_as_note_to_owner(email,d);alert("successfully applied for refund");location.reload(true)},error:function(d){showNotyPopUp("information","error occured please try again","top")}})});$("#delete_userplan").die().live("click",function(d){d.preventDefault();if(!confirm("Are you sure you want to cancel this subscription ?")){return}var c=$("#delete_userplan").attr("sub_id");var b=$("#delete_userplan").attr("cus_id");$.ajax({url:"core/api/admin_panel/deletesubscription?subscription_id="+c+"&cus_id="+b,type:"DELETE",success:function(){add_cancel_subscription_info_as_note_to_owner(email);location.reload(true)},error:function(e){console.log(e)}})});$("#delete_emailplan").die().live("click",function(d){d.preventDefault();if(!confirm("Are you sure you want to cancel this subscription ?")){return}var c=$("#delete_emailplan").attr("sub_id");var b=$("#delete_emailplan").attr("cus_id");$.ajax({url:"core/api/admin_panel/deletesubscription?subscription_id="+c+"&cus_id="+b,type:"DELETE",success:function(){add_cancel_subscription_info_as_note_to_owner(email);location.reload(true)},error:function(e){console.log(e)}})});$("#unpause_mandrill").die().live("click",function(c){c.preventDefault();if(!confirm("Are you sure you want to UnPause Mandrill?")){return}var b=$(this).attr("domain");$.ajax({url:"core/api/admin_panel/resumeMandrill?domain="+b,type:"PUT",success:function(){location.reload(true)},error:function(d){console.log(d);showNotyPopUp("information","Error occured please try again","top")}})})});$(".deal-edit-note").die().live("click",function(c){c.preventDefault();var b=dealNotesView.collection.get($(this).attr("data"));console.log(b);deserializeForm(b.toJSON(),$("#dealnoteUpdateForm",$("#dealnoteupdatemodal")));fill_relation_deal($("#dealnoteUpdateForm"));$("#dealnoteupdatemodal").modal("show")});$("#dealnote_update").live("click",function(c){c.preventDefault();if($(this).attr("disabled")){return}disable_save_button($(this));if(!isValidForm("#dealnoteUpdateForm")){enable_save_button($(this));return}var b=serializeForm("dealnoteUpdateForm");saveDealUpdateNote($("#dealnoteUpdateForm"),$("#dealnoteupdatemodal"),this,b)});$("#dealnote_validate").live("click",function(c){c.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm("#dealnoteForm")){return}disable_save_button($(this));var b=serializeForm("dealnoteForm");console.log(b);saveDealNote($("#dealnoteForm"),$("#deal-note-modal"),this,b)});$("#dealshow-note").live("click",function(c){if(App_Deal_Details.dealDetailView.model.get("archived")==true){return}c.preventDefault();$("#deal-note-modal").modal("show");var b=$("#dealnoteForm")});$("#deal-note-modal").on("hidden",function(){$("#dealnoteForm").find("li").remove();$("#from_task","#dealnoteForm").val("");$("#task_form","#dealnoteForm").val("");remove_validation_errors("dealnoteModal")});function saveDealNote(e,d,b,c){console.log(c);var f=new Backbone.Model();f.url="core/api/opportunity/deals/notes";f.save(c,{success:function(g){enable_save_button($(b));e.each(function(){this.reset()});d.modal("hide");App_Deal_Details.dealDetailView.model=g;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+g.toJSON().id,{trigger:true})}})}function saveDealUpdateNote(e,d,b,c){console.log(c);var f=new Backbone.Model();f.url="core/api/opportunity/deals/notes";f.save(c,{success:function(g){enable_save_button($(b));e.each(function(){this.reset()});d.modal("hide");App_Deal_Details.dealDetailView.model=g;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+g.toJSON().id,{trigger:true})}})}var deal_tab_position_cookie_name="deal_tab_position";$(function(){var b;$('#deal-details-tab a[href="#dealnotes"]').live("click",function(c){c.preventDefault();save_deal_tab_position_in_cookie("dealnotes");deal_details_tab.load_deal_notes()});$('#deal-details-tab a[href="#dealrelated"]').live("click",function(c){c.preventDefault();save_deal_tab_position_in_cookie("dealrelated");deal_details_tab.loadDealRelatedContactsView()});$('#deal-details-tab a[href="#dealactivities"]').live("click",function(c){c.preventDefault();save_deal_tab_position_in_cookie("dealactivities");deal_details_tab.load_deal_activities()});$('#deal-details-tab a[href="#dealdocs"]').live("click",function(c){c.preventDefault();save_deal_tab_position_in_cookie("dealdocs");deal_details_tab.load_deal_docs()});$(".activity-delete").die().live("click",function(k){k.preventDefault();var f=$(this).parents("li").data();if(f&&f.collection){f.collection.remove(f)}var c=$(this).attr("id");var j=$(this).attr("url");if(!j){return}var g=[];var d={};g.push(c);d.ids=JSON.stringify(g);var h=this;if($(this).find(".loading").length==0){$(this).prepend($(LOADING_HTML).addClass("pull-left").css("width","20px"))}$.ajax({url:j,type:"POST",data:d,success:function(){$(h).parents(".activity").fadeOut(400,function(){$(this).remove()});removeItemFromTimeline($("#"+c,$("#timeline")))}})})});function save_deal_tab_position_in_cookie(c){var b=readCookie(deal_tab_position_cookie_name);if(b==c){return}createCookie(deal_tab_position_cookie_name,c)}function load_deal_tab(c,d){var b=readCookie(deal_tab_position_cookie_name);if(b){if(b=="dealactivities"){$('#deal-details-tab a[href="#dealactivities"]',c).tab("show");deal_details_tab.load_deal_activities()}else{if(b=="dealrelated"){$('#deal-details-tab a[href="#dealrelated"]',c).tab("show");deal_details_tab.loadDealRelatedContactsView()}else{if(b=="dealnotes"){$('#deal-details-tab a[href="#dealnotes"]',c).tab("show");deal_details_tab.load_deal_notes()}else{if(b=="dealdocs"){$('#deal-details-tab a[href="#dealdocs"]',c).tab("show");deal_details_tab.load_deal_docs()}}}}}else{$('#deal-details-tab a[href="#dealactivities"]',c).tab("show");deal_details_tab.load_deal_activities()}}var dealrelatedView;var dealNotesView;var dealActivitiesView;var existingDealDocumentsView;var deal_details_tab={loadDealRelatedContactsView:function(){var b=App_Deal_Details.dealDetailView.model.id;if(b){dealrelatedView=new Base_Collection_View({url:"/core/api/opportunity/"+b+"/related_to",templateKey:"deal-related",individual_tag_name:"tr",sortKey:"created_time",cursor:true,descending:true,postRenderCallback:function(c){}});
dealrelatedView.collection.fetch();$("#dealrelated").html(dealrelatedView.el)}},load_deal_notes:function(){var b=App_Deal_Details.dealDetailView.model.id;if(b){dealNotesView=new Base_Collection_View({url:"/core/api/opportunity/"+b+"/notes",restKey:"note",templateKey:"deal-notes",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(c){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".note-created-time",c).timeago()})}});dealNotesView.collection.fetch();$("#dealnotes").html(dealNotesView.el)}},load_deal_docs:function(){var b=App_Deal_Details.dealDetailView.model.id;if(b){dealDocsView=new Base_Collection_View({url:"/core/api/documents/opportunity/"+b+"/docs",restKey:"document",templateKey:"deal-docs",individual_tag_name:"li",sortKey:"uploaded_time",descending:true,postRenderCallback:function(c){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".document-created-time",c).timeago()})}});dealDocsView.collection.fetch();$("#dealdocs").html(dealDocsView.el)}},load_deal_activities:function(){var b=App_Deal_Details.dealDetailView.model.id;if(b){dealActivitiesView=new Base_Collection_View({url:"/core/api/opportunity/"+b+"/activities",templateKey:"deal-detail-activities",individual_tag_name:"li",scroll_symbol:"scroll",sortKey:"time",descending:true,cursor:true,page_size:20,postRenderCallback:function(c){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".note-created-time",c).timeago()})}});dealActivitiesView.collection.fetch();$("#dealactivities").html(dealActivitiesView.el)}}};$(".document-edit-deal-tab").die().live("click",function(b){b.preventDefault();var c=$(this).attr("data");updateDocument(dealDocsView.collection.get(c))});$(".document-unlink-deal-tab").die().live("click",function(f){f.preventDefault();var g=$(this).attr("data");var c=dealDocsView.collection.get(g).toJSON();var d=App_Deal_Details.dealDetailView.model.id+"";c.deal_ids.splice(c.deal_ids.indexOf(d),1);var b=new Backbone.Model();b.url="core/api/documents";b.save(c,{success:function(e){dealDocsView.collection.remove(c);dealDocsView.render(true)}})});$(".add-deal-document-select").die().live("click",function(f){f.preventDefault();var d=$(this).closest("div");$(this).css("display","none");d.find(".deal-document-select").css("display","inline");var b="<option value='{{id}}'>{{name}}</option>";fillSelect("document-select","core/api/documents","documents",function c(){d.find("#document-select").append("<option value='new'>Add New Doc</option>")},b,false,d)});$(".add-deal-document-confirm").die().live("click",function(g){g.preventDefault();var b=$(this).closest(".deal-document-select").find("#document-select").val();var d=$(this);if(b==""){d.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>This field is required.</span>");d.closest("span").find("span.save-status").find("span").fadeOut(5000);return}else{if(b=="new"){var c=$("#uploadDocumentForm");$("#uploadDocumentModal").modal("show");agile_type_ahead("document_relates_to_contacts",c,contacts_typeahead);agile_type_ahead("document_relates_to_deals",c,deals_typeahead,false,null,null,"core/api/search/deals",false,true);var h=App_Deal_Details.dealDetailView.model.toJSON();var f=h.name;$(".deal_tags",c).append('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="'+h.id+'">'+f+"</li>")}else{if(b!=undefined&&b!=null){if(!existingDealDocumentsView){existingDealDocumentsView=new Base_Collection_View({url:"core/api/documents",restKey:"documents"});existingDealDocumentsView.collection.fetch({success:function(e){existing_deal_document_attach(b,d)}})}else{existing_deal_document_attach(b,d)}}}}});$(".add-deal-document-cancel").die().live("click",function(c){c.preventDefault();var b=$(this).closest("div");b.find(".deal-document-select").css("display","none");b.find(".add-deal-document-select").css("display","inline")});function existing_deal_document_attach(b,e){var c=existingDealDocumentsView.collection.get(b).toJSON();var d=App_Deal_Details.dealDetailView.model.id+"";if((c.deal_ids).indexOf(d)<0){c.deal_ids.push(d);saveDocument(null,null,e,false,c)}else{e.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>Linked Already</span>");e.closest("span").find("span.save-status").find("span").fadeOut(5000);return}}$(function(){$("#email-gateway-delete").die().live("click",function(b){b.preventDefault();if(!confirm("Are you sure you want to delete?")){return false}$.ajax({url:"core/api/email-gateway",type:"DELETE",success:function(){if(App_Admin_Settings.email_gateway&&App_Admin_Settings.email_gateway.model){var c=App_Admin_Settings.email_gateway.model.toJSON();if(c.email_api=="MANDRILL"){$.getJSON("core/api/email-gateway/delete-webhook?api_key="+c.api_key+"&type="+c.email_api,function(d){console.log(d)})}}location.reload(true)}})});$("#sms-gateway-delete").die().live("click",function(b){b.preventDefault();if(!confirm("Are you sure you want to delete?")){return false}var c=$(this).attr("data");$.ajax({url:"core/api/widgets/integrations/"+c,type:"DELETE",success:function(){location.reload(true)}})})});function modalAlert(b,e,f){if(b==undefined||e==undefined||f==undefined){return}var c={};c.title=f;c.message=e;var d=$(getTemplate(b,c));d.modal("show");return}function load_admin_account_prefs(c){var b=new Base_Model_View({url:"/core/api/account-prefs",template:"admin-settings-account-prefs"});c.find("#admin-account-prefs").html(b.render().el)}function load_account_email_activity(b){var c=new Base_Model_View({url:"core/api/emails/email-activity",template:"admin-settings-email-activity"});b.find("#account-email-activity").html(c.render().el)}$(function(){$("#email-gateway-delete").die().live("click",function(b){b.preventDefault();if(!confirm("Are you sure you want to delete?")){return false}$.ajax({url:"core/api/email-gateway",type:"DELETE",success:function(){if(App_Admin_Settings.email_gateway&&App_Admin_Settings.email_gateway.model){var c=App_Admin_Settings.email_gateway.model.toJSON();if(c.email_api=="MANDRILL"){$.getJSON("core/api/email-gateway/delete-webhook?api_key="+c.api_key+"&type="+c.email_api,function(d){console.log(d)})}}location.reload(true)}})})});function bindAdminChangeAction(b,c){if(!_plan_restrictions){init_acl_restriction()}if(!_plan_restrictions.is_ACL_allowed[0]()){return}$('input[name="is_admin"]',b).die().live("change",function(g){var f=$(this).is(":checked");if(f==false){$("input[type=checkbox]",$('div[name="newscopes"]',b)).removeAttr("disabled")}else{$("input[type=checkbox]",$('div[name="newscopes"]',b)).attr("checked","checked").attr("disabled","disabled")}});$("input[type=checkbox]",$('div[name="newscopes"]',b)).die().live("change",function(f){if(!this.checked){$(this).removeAttr("checked")}});var d=$('input[value="IMPORT_CONTACTS"]',b);if(!d){return}if(c&&c.scopes){if(jQuery.inArray("IMPORT_CONTACTS",c.scopes)>=0){$('input[value="CREATE_CONTACT"]',b).attr("checked","checked").attr("disabled","disabled")}}d.die().live("change",function(f){var g=$(this).is(":checked");if(g==true){$('input[value="CREATE_CONTACT"]',b).attr("checked","checked").attr("disabled","disabled")}else{$('input[value="CREATE_CONTACT"]',b).removeAttr("disabled")}})}var CONTACT_CUSTOM_FIELDS=undefined;function setupTinyMCEEditor(c,e,d,g){if(c===undefined){console.log("selector is undefined...");return}$("#loading-editor").html(getRandomLoadingImg());var b="bullist numlist | outdent indent blockquote | forecolor backcolor | merge_fields | preview | code";if(e){b="bullist numlist | outdent indent blockquote | forecolor backcolor | preview | code"}var f=["textcolor link image preview code fullpage"];if(!d){d=f}if(typeof(tinymce)==="undefined"){head.js("/js/designer/tinymce/tinymce.min.js",function(){if(typeof(tinymce)==="undefined"){console.log("Reloading script...");if(confirm("Unable to load editor. Click OK to Reload.")){location.reload()}return}$(c).css("display","");$("#loading-editor").html("");tinymce.init({mode:"exact",selector:c,plugins:d,menubar:false,toolbar1:"bold italic underline | alignleft aligncenter alignright alignjustify | link image | formatselect | fontselect | fontsizeselect",toolbar2:b,valid_elements:"*[*]",toolbar_items_size:"small",browser_spellcheck:true,relative_urls:false,convert_urls:false,gecko_spellcheck:true,forced_root_block:false,extended_valid_elements:"*[*]",setup:function(h){h.addButton("merge_fields",{type:"menubutton",text:"Agile Contact Fields",icon:false,menu:set_up_merge_fields(h)})}});setTimeout(function(){if(g!=undefined&&typeof(g)==="function"){g()}},500)});return}if(c.indexOf("#")!==-1){c=c.split("#")[1]}tinymce.settings.toolbar2=b;tinymce.settings.plugins=d;reinitialize_tinymce_editor_instance(c,g)}function set_tinymce_content(b,d){try{if(typeof(tinymce)!=="undefined"){tinymce.get(b).setContent(d)}}catch(c){console.log("error occured while setting content...");console.log(c)}}function save_content_to_textarea(b){try{if(typeof(tinymce)!=="undefined"){tinymce.get(b).save()}}catch(c){console.log("error occured while saving content to textarea...");console.log(c)}}function trigger_tinymce_save(){try{if(typeof(tinymce)!=="undefined"){tinymce.triggerSave()}}catch(b){console.log("error occured while triggering tiny save...");console.log(b)}}function reinitialize_tinymce_editor_instance(b,d){try{remove_tinymce_editor_instance(b);setTimeout(function(){$("#loading-editor").html("");$("#"+b).css("display","");tinymce.EditorManager.execCommand("mceAddEditor",true,b);if(d!=undefined&&typeof(d)==="function"){d()}$(".mce-tinymce").css("display","")},100)}catch(c){console.log("error occured while reinitializing tinymce...");console.log(c)}}function remove_tinymce_editor_instance(b){try{for(var c=0;c<tinymce.editors.length;c++){tinyMCE.remove(tinyMCE.editors[c])}}catch(d){console.log("error occured while removing tinymce editor instance...");console.log(d)}}function set_up_merge_fields(b){var d=[];var c;if(App_Contacts.contactDetailView!=undefined&&App_Contacts.contactDetailView.model!=undefined){c=get_contact_json_for_merge_fields()
}$.each(get_merge_fields(),function(f,g){var e={};e.text=f;e.onclick=function(){if(Current_Route==="bulk-email"||Current_Route==="send-email"||Current_Route.indexOf("email-template")!=-1){b.insertContent(g)}else{var j=Handlebars.compile(g);var h;try{h=j(c)}catch(k){console.log("error.....");g="{{["+f+"]}}";j=Handlebars.compile(g);h=j(c)}b.insertContent(h+"")}};d.push(e)});return d}function get_merge_fields(){var c={"First Name":"{{first_name}}","Last Name":"{{last_name}}",Score:"{{score}}",Email:"{{email}}",Company:"{{company}}",Title:"{{title}}",Address:"{{location.address}}",City:"{{location.city}}",State:"{{location.state}}",Country:"{{location.country}}","Owner Name":"{{owner.name}}","Owner Email":"{{owner.email}}","Calendar URL":"{{owner.calendar_url}}"};var d=get_custom_merge_fields();var b=merge_jsons({},c,d);return b}function get_custom_fields(){if(CONTACT_CUSTOM_FIELDS!=undefined){return CONTACT_CUSTOM_FIELDS}var b=$.ajax({type:"GET",url:"/core/api/custom-fields/scope?scope=CONTACT",async:false,dataType:"json"}).responseText;CONTACT_CUSTOM_FIELDS=JSON.parse(b);return CONTACT_CUSTOM_FIELDS}function get_custom_merge_fields(){var b={};$.each(get_custom_fields(),function(c,d){b[d.field_label]="{{"+d.field_label+"}}"});return b}function merge_jsons(d,c,b){return $.extend(d,c,b)}function get_contact_json_for_merge_fields(){if(App_Contacts.contactDetailView!=undefined&&App_Contacts.contactDetailView.model!=undefined){var f=App_Contacts.contactDetailView.model.toJSON();var d=get_property_JSON(f);try{d.score=f.lead_score;var b=get_custom_field_labels_by_type(get_custom_fields(),"DATE");for(var c in b){d[b[c]]=get_formatted_date(d[b[c]])}d.location=JSON.parse(d.address)}catch(e){console.log("Error occured while parsing json");console.log(e)}return merge_jsons({},{owner:f.owner},d)}}function add_square_brackets_to_merge_fields(d){var c=d.match(/{{[a-zA-Z0-9 ]*[a-zA-Z0-9 ]}}/g);if(c){for(var b=0;b<c.length;b++){d=d.replace(c[b],"{{["+c[b].match(/{{(.*?)}}/)[1]+"]}}")}}return d}function get_custom_field_labels_by_type(d,c){var b=[];$.each(d,function(e,f){if(f.field_type==c){b.push(f.field_label)}});return b}function get_formatted_date(e,h){if(!e){return}var j=undefined;if((e/100000000000)>1){j=new Date(parseInt(e))}else{j=new Date(parseInt(e)*1000)}var c=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");var b=j.getDate();var g=j.getMonth();var f=j.getFullYear();return b+" "+c[g]+" "+f}function register_focus_on_tinymce(c){var b=$("iframe#"+c+"_ifr").contents()[0];if(!b){return}$(b).die().live("click",function(d){d.preventDefault();$(this).find("body").focus()})}function deserializeForm(c,b){$.each(c,function(f,h){var e=b.find('*[name="'+f+'"]'),g="",d="";if(e.length>0){d=e[0].tagName.toLowerCase();if(d=="select"||d=="textarea"){$(e).val(h)}else{if(d=="input"){g=$(e[0]).attr("type");if(e.hasClass("date")){try{e.val(new Date(h*1000).format("mm/dd/yyyy"))}catch(j){}e.datepicker({format:"mm/dd/yyyy"})}else{if(g=="text"||g=="password"||g=="hidden"||g=="number"){e.val(h)}else{if(d=="select"){e.val(h).trigger("change")}else{if(g=="checkbox"){if(h){if(h==true){e.attr("checked","checked")}}else{e.removeAttr("checked")}}else{if(g=="radio"){e.filter('[value="'+h+'"]').attr("checked","checked")}}}}}}else{if(e.hasClass("multiSelect")&&d=="ul"){$.each(h,function(k,l){$("#multipleSelect",b).multiSelect("select",l)})}else{if(e.hasClass("tagsinput")&&d=="ul"&&e.hasClass("contacts")){$.each(c.contacts,function(l,k){var n;var m=k.id;n=getContactName(k);e.append('<li class="tag" data="'+m+'" class="tag"  style="display: inline-block; "><a href="#contact/'+k.id+'">'+n+'</a><a class="close" id="remove_tag">&times</a></li>')})}else{if(e.hasClass("tagsinput")&&d=="ul"&&e.hasClass("deals")){$.each(c.deals,function(k,l){var n;var m=l.id;n=l.name.split(" ").join("");e.append('<li class="tag" data="'+m+'" class="tag"  style="display: inline-block; "><a href="#deal/'+l.id+'">'+n+'</a><a class="close" id="remove_tag">&times</a></li>')})}else{if(e.hasClass("multiSelect")&&d=="ul"){$.each(h,function(k,l){$("#multipleSelect",b).multiSelect("select",l)})}else{if(e.hasClass("multiple-checkbox")){for(var f=0;f<h.length;f++){$('input:checkbox[value="'+h[f]+'"]',e).attr("checked","checked")}}else{if(e.hasClass("chainedSelect")){}}}}}}}}}})}function deserializeMultipleForms(c,b){$.each(b,function(d,f){var e=$(f).attr("name");if(e&&c[e]){deserializeForm(c[e],$(f))}else{deserializeForm(c,$(f))}})}function deserializeChainedSelect(d,c,b){$.each(c,function(e,f){var j=($(d).find(".chained"))[0];if(e>0){var g=$(j).parent();j=$($(b).clone().find(".chained"))[0];$(j).find("i.filter-contacts-multiple-remove").css("display","inline-block");var h=$(j).find("i.filter-contacts-multiple-remove").css("display","inline-block");chainFilters(j);$(g).append(j);deserializeChainedElement(f,j);return}deserializeChainedElement(f,j)})}function deserializeChainedElement(b,c){$(c).removeClass("hide");if(b&&b.LHS&&b.LHS!="campaign_status"){$(c).find("#LHS select").find("optgroup[label='Activities']").remove()}$.each(b,function(d,f){var g=($(c).find('*[name="'+d+'"]').children())[0];if(!g){return}if(g.tagName.toLowerCase()=="input"){if($(g).hasClass("date")){f=getLocalTimeFromGMTMilliseconds(f);$(g).val(new Date(parseInt(f)).format("mm/dd/yyyy"));$(g).datepicker({format:"mm/dd/yyyy"});$(g).datepicker("update");return}$(g).val(f);return}var e=$("option",g);$.each(e,function(j,k){if($(k).attr("value")==f){$(k).attr("selected","selected");var h=$(k).attr("url");if(h){$(k).attr("data",b.RHS);console.log($(k))}$(g).trigger("change");return}})})}function deserializeChainedElementWebrule(b,c){$.each(b,function(d,g){if(g.value){g=g.value}var f=$(c).find('*[name="'+d+'"]').children();var j=f[0];if(!j){return}var h=j.tagName.toLowerCase();if(h!="input"&&h!="textarea"&&h!="select"&&f.length>1){$.each(f,function(l,k){if(l==0){return}h=k.tagName.toLowerCase();if(h=="input"||h=="textarea"||h=="select"){j=k;return false}})}if(!j){return}if(j.tagName.toLowerCase()=="input"||j.tagName.toLowerCase()=="textarea"){$(j).val(g);if($(j).hasClass("custom_html")){if(g.value){$(j).val(g.value)}}return}var e=$("option",j);$.each(e,function(k,l){if($(l).attr("value")==g){if((g=="UNSUBSCRIBE_CAMPAIGN"||g=="ASSIGN_CAMPAIGN")&&b.RHS){$(l).attr("data",b.RHS)}$(l).attr("selected","selected");$(j).trigger("change");return}})})}function deserializeChainedSelect1(f,e,d){var b=$(d).find(".webrule-actions")[0];var c=$(b).html();var g=($(f).find(".webrule-actions"))[0];$.each(e,function(j,k){if(j>0){var h=$(c).clone();$(h).find("i.webrule-multiple-remove").css("display","inline-block");var l=[];l.push(k);chainWebRules(h,e,false,l);deserializeChainedElementWebrule(k,h);$(g).append(h);return}deserializeChainedElementWebrule(k,g)})}function deserializeLhsFilters(c,e){var d=JSON.parse(e);var b=0;var f=0;$.each(d.rules,function(n,g){var p=g.LHS;var m=g.CONDITION;var j=g.RHS;var l=g.RHS_NEW;var q=p.replace(/ +/g,"_");q=q.replace(/#/g,"\\#").replace(/@/g,"\\@");var s=$(c).find("#"+q+"_div");if(p=="tags"||p=="campaign_status"){$("#"+p+"_div").parent().find("a").addClass("bold-text");$("#"+p+"_div").removeClass("hide");if((b==0&&p=="tags")||(f==0&&p=="campaign_status")){s=$("#"+p+"-lhs-filter-table").find("div.lhs-contact-filter-row:last");$("#"+p+"_div").prev().find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o")}else{var k=$("#"+p+"-lhs-filter-table").find("div.hide.master-"+p+"-add-div").clone();k.removeClass("hide").addClass("lhs-contact-filter-row");addTagsDefaultTypeahead(k);$(k).appendTo("#"+p+"-lhs-filter-table");s=$("#"+p+"-lhs-filter-table").find("div.lhs-contact-filter-row:last")}if(p=="tags"){b++}if(p=="campaign_status"){f++}}else{$(s).prev().find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o")}$(s).parent().find("a#lhs-filters-header").addClass("bold-text");$(s).find("a.clear-filter-condition-lhs").removeClass("hide");$(s).removeClass("hide");$(s).find('[name="CONDITION"]').val(m);$(s).find('[name="CONDITION"]').trigger("change");var o=$(s).find("."+m).find("#RHS").children();var h=$(s).find("."+m).find("#RHS_NEW").children();if($(o).hasClass("date")){j=getLocalTimeFromGMTMilliseconds(j);$(o).val(new Date(parseInt(j)).format("mm/dd/yyyy"));$(o).attr("prev-val",new Date(parseInt(j)).format("mm/dd/yyyy"))}else{$(o).val(j);$(o).attr("prev-val",j)}if(h){if($(h).hasClass("date")){l=getLocalTimeFromGMTMilliseconds(l);$(h).val(new Date(parseInt(l)).format("mm/dd/yyyy"));$(h).attr("prev-val",new Date(parseInt(l)).format("mm/dd/yyyy"))}else{$(h).val(l);$(h).attr("prev-val",l)}}})}function isValidForm(b){jQuery.validator.addMethod("atleastThreeMonths",function(g,e){var h=$(e).siblings("select.exp_month").val(),f=g;var d=new Date().setFullYear(f,h-1);var c=1000*60*60*24;return this.optional(e)||(((d-new Date().getTime())/c)>90)},"Card should be atleast 3 months valid");jQuery.validator.addMethod("multipleEmails",function(e,d){if(this.optional(d)){return true}var f=e.split(/[,]+/);valid=true;for(var c in f){e=f[c];valid=valid&&jQuery.validator.methods.email.call(this,$.trim(e),d)}return valid},"Please enter valid email each separated by comma.");jQuery.validator.addMethod("noSpecialChars",function(d,c){return isAlphaNumeric(d)},"Should start with an alphabet and special characters are not allowed.");jQuery.validator.addMethod("email",function(d,c){if(this.optional(c)){return true}return/^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/i.test(d)}," Please enter a valid email.");jQuery.validator.addMethod("phone",function(d,c){if(this.optional(c)){return true}return/^[^a-zA-Z]+$/.test(d)}," Please enter a valid phone number.");jQuery.validator.addMethod("multi-tags",function(e,c){var d=$(c).val();$(c).val("");if(d&&d.length>=0&&!(/^\s*$/).test(d)){$(c).closest(".control-group").find("ul.tags").append('<li class="tag" style="display: inline-block;" data="'+d+'">'+d+'<a class="close" id="remove_tag" tag="'+d+'">&times</a></li>')}return $(c).closest(".control-group").find("ul.tags > li").length>0?true:false
}," This field is required.");jQuery.validator.addMethod("formulaData",function(g,d){var f=$(d).val();var c;var h=true;try{c=Handlebars.precompile(f)}catch(e){e.message;h=false}return h?true:false}," Please enter a valid formula.");jQuery.validator.addMethod("number_input",function(d,c){if(d==""){return false}return/^[0-9\-]+$/.test(d)}," Please enter a valid number.");jQuery.validator.addMethod("multi-select",function(f,e){var d=0;$(e).find(":selected").each(function(g,h){d++});var c=$(e).attr("limit");if(d>c){return false}return true}," You can select maximum 3 folders only.");$(b).validate({rules:{atleastThreeMonths:true,multipleEmails:true,email:true,phone:true},debug:true,errorElement:"span",errorClass:"help-inline",highlight:function(d,c){$(d).closest(".controls").addClass("single-error")},unhighlight:function(d,c){$(d).closest(".controls").removeClass("single-error")},invalidHandler:function(d,c){var e=c.numberOfInvalids()}});return $(b).valid()}function isNotValid(b){if(b==undefined){return true}if(b.length==0){return true}return false}function isValidField(c){var b=$("#"+c).val();return !isNotValid(b)}function isAlphaNumeric(c){c=c.toString();var b=new RegExp(/^[A-Za-z][a-zA-Z0-9]{3,20}$/);if(!b.test(c)){error="Domain should start with an alphabet and special characters are not allowed.";return false}return true}function isAlphaNumeric(c){c=c.toString();var b=new RegExp(/^[A-Za-z#@][A-Za-z0-9_:&@;/\s/g]*$/);if(!b.test(c)){return false}return true}function serializeForm(c){var b=$("#"+c).serializeArray(),f={};b=b.concat($("#"+c+" input[type=checkbox]").map(function(){return{name:this.name,value:$(this).is(":checked")}}).get());b=b.concat($("#"+c+" input.date").map(function(){return{name:this.name,value:new Date(this.value).getTime()/1000}}).get());b=b.concat($("#"+c+" select.multi-select").map(function(){console.log($(this).val());return{name:this.name,value:$(this).val()}}).get());console.log(b);b=b.concat(get_tags(c));b=b.concat(get_notes(c));b=b.concat(get_related_deals(c));b=b.concat($("#"+c+" .multiSelect").map(function(){var g=[];$.each($(this).children("li"),function(h,j){g.push(($(j).attr("ms-value")))});return{name:$(this).attr("name"),value:g}}).get());b=b.concat($("#"+c+" .multiple-checkbox").map(function(){var g=[];$("input:checkbox:checked",this).each(function(j,h){g.push($(h).val())});console.log(g);return{name:$(this).attr("name"),value:g}}).get());var e=$("#"+c+" .chained-table:visible");$.each(e,function(g,h){var j=[];b=b.concat($(h).find(".chained:visible").map(function(){var k=serializeChainedElement(this);j.push(k);return{name:$(this).attr("name"),value:j}}).get())});for(var d=0;d<b.length;++d){f[b[d].name]=b[d].value}return f}function serializeChainedElement(b){var c={};$.each($(b).find("div").children(),function(f,j){var g=$(j)[0].tagName;if(!(g=="TEXTAREA"||g=="INPUT"||g=="SELECT")){return}var e=$(j).parent().attr("name");var h;if($(j).hasClass("date")){var d=new Date($(j).val());h=getGMTEpochFromDate(d)}else{if(!c[e]){h=$(j).val()}}if(h!=null&&h!=""){c[e]=h}});return c}$(function(){$.fn.focus_first=function(){var c=$(this).find("input:visible").not(".hide").get(0);var b=$("textarea:visible",this).get(0);if(b&&c){if(b.offsetTop<c.offsetTop){c=b}}if(c){$(c).focus()}return this};$(".modal").on("shown",function(b){$("form",this).focus_first()})});function serializeLhsFilters(b){var d=[];var c={};$(b).find("a#lhs-filters-header").removeClass("bold-text");$.each($(b).find(".lhs-contact-filter-row"),function(m,h){var n={};var k=$(h)[0];var g,j;var l=$(k).find('[name="CONDITION"]').val();var o=$(k).find("."+l).find("#RHS").children();var f=$(k).find("."+l).find("#RHS_NEW").children();g=$(o).val().trim();if($(o).hasClass("date")&&g&&g!=""){var e=new Date($(o).val());g=getGMTEpochFromDate(e)}j=$(f).val();if($(f).hasClass("date")&&j&&j!=""){var e=new Date($(f).val());j=getGMTEpochFromDate(e)}if(j&&typeof j=="string"){j=j.trim()}if(g&&g!=null&&g!=""){if(f&&f.length>0){if(!j||j==null||j==""){return}}var p=$(k).find('[name="LHS"]').val();n.LHS=p;n.CONDITION=l;n.RHS=g;n.RHS_NEW=j;d.push(n);var q=p.replace(/ +/g,"_");q=q.replace(/#/g,"\\#").replace(/@/g,"\\@");var s=$(b).find("#"+q+"_div");$(s).parent().find("a#lhs-filters-header").addClass("bold-text");$(s).find("a.clear-filter-condition-lhs").removeClass("hide")}});c.rules=d;c.contact_type=$(b).find("#contact_type").val();return c}var Portlets_View;var portlet_template_loaded_map={};function loadPortlets(b){App_Portlets.todayEventsCollection=new Array();App_Portlets.tasksCollection=new Array();App_Portlets.pendingDeals=new Array();App_Portlets.dealsWon=new Array();App_Portlets.filteredCompanies=new Array();App_Portlets.filteredContacts=new Array();App_Portlets.emailsOpened=new Array();if(!Portlets_View){head.load("css/misc/agile-portlet.css");is_portlet_view_new=true;Portlets_View=new Base_Collection_View({url:"/core/api/portlets",sortKey:"row_position",sort_collection:false,restKey:"portlet",templateKey:"portlets",individual_tag_name:"div",postRenderCallback:function(d){head.load("css/jquery.gridster.css",function(){set_up_portlets(b,d);if(Portlets_View.collection.length==0){$(".gridster > div:visible > div",b).removeClass("gs-w")}})}});this.Portlets_View.appendItem=set_p_portlets;Portlets_View.collection.fetch();var c=Portlets_View.render().el;$("#portlets",b).html(c)}else{this.Portlets_View.appendItem=set_p_portlets;Portlets_View.collection.fetch();var c=Portlets_View.render().el;$("#portlets",b).html(c)}}var gridster;function set_up_portlets(c,f){var e;var b=Math.round($(".gridster-portlets").width()/3)-20;var d=200;e=[b,d];gridster=$(".gridster > div:visible",f).gridster({widget_selector:"div",widget_margins:[10,5],widget_base_dimensions:e,min_cols:3,autogenerate_stylesheet:true,draggable:{limit:true,ignore_dragging:[".portlet_body",".portlet_body *"],stop:function(g,h){var j=[];$("#portlet-res > div > .gs-w").each(function(){$(this).attr("id","ui-id-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));$(this).find("div.portlet_body").attr("id","p-body-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));var l=$(this).find(".portlets").attr("id");var k=Portlets_View.collection.get(l);k.set({column_position:parseInt($(this).attr("data-col"))},{silent:true});k.set({row_position:parseInt($(this).attr("data-row"))},{silent:true});j.push({id:k.get("id"),column_position:parseInt($(this).attr("data-col")),row_position:parseInt($(this).attr("data-row"))})});$.ajax({type:"POST",url:"/core/api/portlets/positions",data:JSON.stringify(j),contentType:"application/json; charset=utf-8",dataType:"json"})}},resize:{enabled:true,max_size:[3,3],stop:function(g,h){if($("#"+this.$resized_widget.attr("id")).height()<=200){$("#"+this.$resized_widget.attr("id")+" > .portlet_body").css("height","160px");$("#"+this.$resized_widget.attr("id")+" > .portlet_body").css("max-height","160px")}else{$("#"+this.$resized_widget.attr("id")+" > .portlet_body").css("height",this.$resize_preview_holder.height()-40+"px");$("#"+this.$resized_widget.attr("id")+" > .portlet_body").css("max-height",this.$resize_preview_holder.height()-40+"px")}$(window).trigger("resize");$("#"+this.$resized_widget.attr("id")+" > div.portlet_body").css("overflow-x","hidden").css("overflow-y","auto");var j=[];$("#portlet-res > div > .gs-w").each(function(){$(this).attr("id","ui-id-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));$(this).find("div.portlet_body").attr("id","p-body-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));var l=$(this).find(".portlets").attr("id");var k=Portlets_View.collection.get(l);k.set({size_x:parseInt($(this).attr("data-sizex"))},{silent:true});k.set({size_y:parseInt($(this).attr("data-sizey"))},{silent:true});k.set({column_position:parseInt($(this).attr("data-col"))},{silent:true});k.set({row_position:parseInt($(this).attr("data-row"))},{silent:true});j.push({id:k.get("id"),size_x:parseInt($(this).attr("data-sizex")),size_y:parseInt($(this).attr("data-sizey")),column_position:parseInt($(this).attr("data-col")),row_position:parseInt($(this).attr("data-row"))})});$.ajax({type:"POST",url:"/core/api/portlets/widthAndHeight",data:JSON.stringify(j),contentType:"application/json; charset=utf-8",dataType:"json"})}}}).data("gridster");$(window).resize(function(){if(gridster!=undefined){$(".gridster-portlets").css("height","auto")}if($(window).width()<768&&gridster!=undefined){gridster.disable();gridster.disable_resize()}else{if(gridster!=undefined){gridster.enable();gridster.enable_resize();gridster.set_dom_grid_height()}}});if($(window).width()<768&&gridster!=undefined){gridster.disable();gridster.disable_resize()}else{if(gridster!=undefined){gridster.enable();gridster.enable_resize()}}$(window).trigger("resize")}function showPortletIcons(b){$(b).find("div.portlet_header_icons").show();$(b).find("div.portlet_header_name").css({width:"65%"})}function hidePortletIcons(b){$(b).find("div.portlet_header_icons").hide();$(b).find("div.portlet_header_name").css({width:"80%"})}function enablePortletSorting(b){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".row-fluid",b).on("sortstop",function(c,d){var e=[];$("#portlet-res").children().each(function(f){$(this).children().each(function(j){var h=$(this).find(".portlets").attr("id");var g=Portlets_View.collection.get(h);g.set({column_position:f+1},{silent:true});g.set({row_position:j+1},{silent:true});e.push({id:g.get("id"),column_position:f+1,row_position:j+1})})});$.ajax({type:"POST",url:"/core/api/portlets/positions",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json"})})})}function showPortletSettings(j){var h;var c=Portlets_View.collection.get(j.split("-settings")[0]);$(".help-inline").hide();if(c.get("portlet_type")=="CONTACTS"&&c.get("name")=="Filter Based"){$("#portletsContactsFilterBasedSettingsModal").modal("show");$("#portletsContactsFilterBasedSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsContactsFilterBasedSettingsModal")).val(c.get("portlet_type"));
$("#portlet-name",$("#portletsContactsFilterBasedSettingsModal")).val(c.get("name"));h=$("#portletsContactsFilterBasedSettingsForm");var g='<option value="">Select...</option><option value="contacts">All Contacts</option><option value="myContacts">My Contacts</option>';$.ajax({type:"GET",url:"/core/api/filters",async:false,dataType:"json",success:function(k){$.each(k,function(l,m){g+="<option value="+m.id+">"+m.name+"</option>"});$("#filter",h).html(g);$("#filter",h).find("option[value="+c.get("settings").filter+"]").attr("selected","selected");$(".loading-img").hide()}})}else{if(c.get("portlet_type")=="CONTACTS"&&c.get("name")=="Emails Opened"){$("#portletsContactsEmailsOpenedSettingsModal").modal("show");$("#portletsContactsEmailsOpenedSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsContactsEmailsOpenedSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsContactsEmailsOpenedSettingsModal")).val(c.get("name"));h=$("#portletsContactsEmailsOpenedSettingsForm");$("#duration",h).find("option[value="+c.get("settings").duration+"]").attr("selected","selected")}else{if(c.get("portlet_type")=="USERACTIVITY"&&c.get("name")=="Emails Sent"){$("#portletsContactsEmailsSentSettingsModal").modal("show");$("#portletsContactsEmailsSentSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsContactsEmailsSentSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsContactsEmailsSentSettingsModal")).val(c.get("name"));h=$("#portletsContactsEmailsSentSettingsForm");$("#duration",h).find("option[value="+c.get("settings").duration+"]").attr("selected","selected")}else{if(c.get("portlet_type")=="CONTACTS"&&c.get("name")=="Growth Graph"){$("#portlet-ul-tags > li").remove();$("#cancel-modal").attr("disabled",false);$("#portletsContactsGrowthGraphSettingsModal").modal("show");$("#portletsContactsGrowthGraphSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsContactsGrowthGraphSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsContactsGrowthGraphSettingsModal")).val(c.get("name"));h=$("#portletsContactsGrowthGraphSettingsForm");var f=c.get("settings").tags.split(",");var b="";$.each(f,function(k,l){if(l!=""){b+="<li data='"+l+"' style='display: inline-block;' class='tag'>"+l+"<a id='remove_tag' class='close'>&times</a></li>"}});$("#portlet-ul-tags").append(b);setup_tags_typeahead();$("#frequency",h).find("option[value="+c.get("settings").frequency+"]").attr("selected","selected");$("#duration",h).find("option[value="+c.get("settings").duration+"]").attr("selected","selected")}else{if(c.get("portlet_type")=="DEALS"&&c.get("name")=="Pending Deals"){$("#portletsPendingDealsSettingsModal").modal("show");$("#portletsPendingDealsSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsPendingDealsSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsPendingDealsSettingsModal")).val(c.get("name"));h=$("#portletsPendingDealsSettingsForm");$("#deals",h).find("option[value="+c.get("settings").deals+"]").attr("selected","selected")}else{if(c.get("portlet_type")=="DEALS"&&c.get("name")=="Deals By Milestone"){$("#portletsDealsByMilestoneSettingsModal").modal("show");$("#portletsDealsByMilestoneSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsDealsByMilestoneSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsDealsByMilestoneSettingsModal")).val(c.get("name"));h=$("#portletsDealsByMilestoneSettingsForm");var e="/core/api/portlets/portletDealsByMilestone?deals="+c.get("settings").deals+"&track="+c.get("settings").track;if(App_Portlets.track_length!=undefined&&App_Portlets.track_length>1){$("#portletsDealsByMilestoneTrack",h).show()}var d=[];if(App_Portlets.deal_tracks!=undefined&&App_Portlets.deal_tracks!=null){d=App_Portlets.deal_tracks}else{$.ajax({type:"GET",url:"/core/api/milestone/pipelines",async:false,dataType:"json",success:function(k){App_Portlets.track_length=k.length;App_Portlets.deal_tracks=k;d=App_Portlets.deal_tracks}})}var g="";$.each(d,function(k,l){if(c.get("settings").track==0&&l.name=="Default"){g+="<option value="+l.id+" selected='selected'>"+l.name+"</option>"}else{if(c.get("settings").track==l.id){g+="<option value="+l.id+" selected='selected'>"+l.name+"</option>"}else{g+="<option value="+l.id+">"+l.name+"</option>"}}});$("#track",h).html(g);$(".loading-img").hide();$("#deals",h).find("option[value="+c.get("settings").deals+"]").attr("selected","selected")}else{if(c.get("portlet_type")=="DEALS"&&c.get("name")=="Closures Per Person"){$("#portletsDealsClosuresPerPersonSettingsModal").modal("show");$("#portletsDealsClosuresPerPersonSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsDealsClosuresPerPersonSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsDealsClosuresPerPersonSettingsModal")).val(c.get("name"));h=$("#portletsDealsClosuresPerPersonSettingsForm");$("#group-by",h).find("option[value="+c.get("settings")["group-by"]+"]").attr("selected","selected");$("#due-date",h).val(new Date(c.get("settings")["due-date"]*1000).format("mm/dd/yyyy"))}else{if(c.get("portlet_type")=="DEALS"&&c.get("name")=="Deals Won"){$("#portletsDealsWonSettingsModal").modal("show");$("#portletsDealsWonSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsDealsWonSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsDealsWonSettingsModal")).val(c.get("name"));h=$("#portletsDealsWonSettingsForm");$("#duration",h).find("option[value="+c.get("settings").duration+"]").attr("selected","selected")}else{if(c.get("portlet_type")=="DEALS"&&c.get("name")=="Deals Funnel"){$("#portletsDealsFunnelSettingsModal").modal("show");$("#portletsDealsFunnelSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsDealsFunnelSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsDealsFunnelSettingsModal")).val(c.get("name"));h=$("#portletsDealsFunnelSettingsForm");var e="/core/api/portlets/portletDealsFunnel?deals="+c.get("settings").deals+"&track="+c.get("settings").track;if(App_Portlets.track_length!=undefined&&App_Portlets.track_length>1){$("#portletsDealsFunnelTrack",h).show()}var d=[];if(App_Portlets.deal_tracks!=undefined&&App_Portlets.deal_tracks!=null){d=App_Portlets.deal_tracks}else{$.ajax({type:"GET",url:"/core/api/milestone/pipelines",async:false,dataType:"json",success:function(k){App_Portlets.track_length=k.length;App_Portlets.deal_tracks=k;d=App_Portlets.deal_tracks}})}var g="";$.each(d,function(k,l){if(c.get("settings").track==0&&l.name=="Default"){g+="<option value="+l.id+" selected='selected'>"+l.name+"</option>"}else{if(c.get("settings").track==l.id){g+="<option value="+l.id+" selected='selected'>"+l.name+"</option>"}else{g+="<option value="+l.id+">"+l.name+"</option>"}}});$("#track",h).html(g);$(".loading-img").hide();$("#deals",h).find("option[value="+c.get("settings").deals+"]").attr("selected","selected")}else{if(c.get("portlet_type")=="DEALS"&&c.get("name")=="Deals Assigned"){$("#portletsDealsAssignedSettingsModal").modal("show");$("#portletsDealsAssignedSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsDealsAssignedSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsDealsAssignedSettingsModal")).val(c.get("name"));h=$("#portletsDealsAssignedSettingsForm");$("#duration",h).find("option[value="+c.get("settings").duration+"]").attr("selected","selected")}else{if(c.get("portlet_type")=="USERACTIVITY"&&c.get("name")=="Calls Per Person"){$("#portletsCallsPerPersonSettingsModal").modal("show");$("#portletsCallsPerPersonSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsCallsPerPersonSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsCallsPerPersonSettingsModal")).val(c.get("name"));h=$("#portletsCallsPerPersonSettingsForm");$("#group-by",h).find("option[value="+c.get("settings")["group-by"]+"]").attr("selected","selected");$("#duration",h).find("option[value="+c.get("settings").duration+"]").attr("selected","selected")}else{if(c.get("portlet_type")=="TASKSANDEVENTS"&&c.get("name")=="Task Report"){$("#portletsTaskReportSettingsModal").modal("show");$("#portletsTaskReportSettingsModal > .modal-footer > .save-modal").attr("id",c.get("id")+"-save-modal");$("#portlet-type",$("#portletsTaskReportSettingsModal")).val(c.get("portlet_type"));$("#portlet-name",$("#portletsTaskReportSettingsModal")).val(c.get("name"));h=$("#portletsTaskReportSettingsForm");$("#group-by-task-report",h).find("option[value="+c.get("settings")["group-by"]+"]").attr("selected","selected");$("#split-by-task-report",h).find("option[value="+c.get("settings")["split-by"]+"]").attr("selected","selected");$("#duration",h).find("option[value="+c.get("settings").duration+"]").attr("selected","selected");$("#"+c.get("settings")["group-by"]+"",h).hide()}}}}}}}}}}}}if(c.get("name")=="Pending Deals"||c.get("name")=="Deals By Milestone"||c.get("name")=="Closures Per Person"||c.get("name")=="Deals Funnel"){$("#due-date",h).datepicker({format:"mm/dd/yyyy"})}}function hidePortletSettings(b){$("#"+b.id.split("-cancel-modal")[0]+"-portlet-settings").modal("hide")}function hidePortletSettingsAfterSave(b){$("#"+b+"> .modal-footer > a").text("Save");$("#"+b+"> .modal-footer > a").attr("disabled",false);$("#"+b).modal("hide");$(".modal-backdrop").hide()}$(".portlet-minimize").die().live("click",function(c){c.preventDefault();var g=$(this).attr("id").split("-collapse")[0];$("#"+$(this).attr("id")).collapse("hide");
$(this).removeClass();$(this).addClass("collapsed");$(this).addClass("portlet-maximize");$(this).addClass("icon-plus");var d=Portlets_View.collection.get(g);var f=d.toJSON();d.set({is_minimized:true},{silent:true});f.is_minimized=true;var b=new BaseModel();b.url="core/api/portlets";b.save(f,{silent:true});$("#"+g).parent().find(".portlet_body").hide()});$(".portlet-maximize").die().live("click",function(c){c.preventDefault();var g=$(this).attr("id").split("-collapse")[0];$("#"+$(this).attr("id")).collapse("hide");$(this).removeClass();$(this).addClass("collapsed");$(this).addClass("portlet-minimize");$(this).addClass("icon-minus");var d=Portlets_View.collection.get(g);var f=d.toJSON();d.set({is_minimized:false},{silent:true});f.is_minimized=false;var b=new BaseModel();b.url="core/api/portlets";b.save(f,{silent:true});$("#"+g).parent().find(".portlet_body").show()});$(".portlet-settings-save-modal").live("click",function(j){j.preventDefault();$(this).attr("disabled",true);$(this).text("Saving...");var m=$(window).scrollTop();var n=$(this).parent().prev().find("form:visible").attr("id");var g=$(this).parent().parent().attr("id");if(!isValidForm("#"+n)){return false}var c=this.id;var k=true;var p={};var f={};var d=$("#portlet-type",$("#"+g)).val();var l=$("#portlet-name",$("#"+g)).val();p=serializeForm(n);if(d=="CONTACTS"&&l=="Growth Graph"){var s="";if($("#addPortletBulkTags").val()!=""){var q=$("#addPortletBulkTags").val();if($("#portlet-ul-tags > li").length==0){$("#portlet-ul-tags").append("<li data='"+q+"' style='display: inline-block;' class='tag'>'"+q+"'<a tag='"+q+"' id='remove_tag' class='close'>&time</a></li>")}else{$("#portlet-ul-tags > li:last").after("<li data='"+q+"' style='display: inline-block;' class='tag'>'"+q+"'<a tag='"+q+"' id='remove_tag' class='close'>&time</a></li>")}}$("#portlet-ul-tags > li").each(function(){if($(this).is(":last")){s+=$(this).attr("data")}else{s+=$(this).attr("data")+","}});p.tags=s}var b=$("#"+$(this).attr("id").split("-save-modal")[0]).parent().find(".portlet_body").attr("id");var o=Portlets_View.collection.get(c.split("-save-modal")[0]);o.set({prefs:JSON.stringify(p)},{silent:true});o.url="core/api/portlets";var h=new BaseModel();h.url="core/api/portlets";if(k){h.save(o.toJSON(),{success:function(U){hidePortletSettingsAfterSave(g);$(window).scrollTop(m);var w=U.toJSON();Portlets_View.collection.get(w).set(new BaseModel(w));var z=""+U.get("column_position")+""+U.get("row_position");var P;if(U.get("portlet_type")=="CONTACTS"&&U.get("name")=="Filter Based"){if(U.get("settings").filter=="companies"){App_Portlets.filteredCompanies[parseInt(z)]=new Base_Collection_View({url:"/core/api/portlets/portletContacts?filter="+U.get("settings").filter+"&sortKey=-created_time",templateKey:"portlets-companies",sort_collection:false,individual_tag_name:"tr",sortKey:"-created_time"})}else{App_Portlets.filteredContacts[parseInt(z)]=new Base_Collection_View({url:"/core/api/portlets/portletContacts?filter="+U.get("settings").filter+"&sortKey=-created_time",templateKey:"portlets-contacts",sort_collection:false,individual_tag_name:"tr",sortKey:"-created_time"})}}else{if(U.get("portlet_type")=="CONTACTS"&&U.get("name")=="Emails Opened"){var t="";var v="";if(U.get("settings").duration=="yesterday"){t=""+U.get("settings").duration;v="today"}else{t=""+U.get("settings").duration;v="TOMORROW"}App_Portlets.emailsOpened[parseInt(z)]=new Base_Collection_View({url:"/core/api/portlets/portletEmailsOpened?duration="+U.get("settings").duration+"&start-date="+getStartAndEndDatesOnDue(t)+"&end-date="+getStartAndEndDatesOnDue(v),templateKey:"portlets-contacts-email-opens",sort_collection:false,individual_tag_name:"tr",postRenderCallback:function(V){displayTimeAgo(V)}})}else{if(U.get("portlet_type")=="DEALS"&&U.get("name")=="Pending Deals"){App_Portlets.pendingDeals[parseInt(z)]=new Base_Collection_View({url:"/core/api/portlets/portletPendingDeals?deals="+U.get("settings").deals,templateKey:"portlets-opportunities",individual_tag_name:"tr",postRenderCallback:function(V){displayTimeAgo(V)}})}else{if(U.get("portlet_type")=="DEALS"&&U.get("name")=="Deals Won"){App_Portlets.dealsWon[parseInt(z)]=new Base_Collection_View({url:"/core/api/portlets/portletDealsWon?duration="+U.get("settings").duration,templateKey:"portlets-opportunities",individual_tag_name:"tr",postRenderCallback:function(V){displayTimeAgo(V)}})}}}}if(P!=undefined){P.collection.fetch()}if(U.get("name")!="Deals By Milestone"&&U.get("name")!="Closures Per Person"&&U.get("name")!="Deals Funnel"&&U.get("name")!="Emails Sent"&&U.get("name")!="Growth Graph"&&U.get("name")!="Deals Assigned"&&U.get("name")!="Calls Per Person"&&U.get("name")!="Pending Deals"&&U.get("name")!="Deals Won"&&U.get("name")!="Filter Based"&&U.get("name")!="Emails Opened"&&U.get("name")!="Task Report"){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html(getRandomLoadingImg());$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html($(P.render().el))}else{if(U.get("portlet_type")=="CONTACTS"&&U.get("name")=="Filter Based"){if(U.get("settings").filter=="companies"){App_Portlets.filteredCompanies[parseInt(z)].collection.fetch();$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html(getRandomLoadingImg());$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html($(App_Portlets.filteredCompanies[parseInt(z)].render().el))}else{App_Portlets.filteredContacts[parseInt(z)].collection.fetch();$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html(getRandomLoadingImg());$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html($(App_Portlets.filteredContacts[parseInt(z)].render().el))}}else{if(U.get("portlet_type")=="CONTACTS"&&U.get("name")=="Emails Opened"){App_Portlets.emailsOpened[parseInt(z)].collection.fetch();$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html(getRandomLoadingImg());$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html($(App_Portlets.emailsOpened[parseInt(z)].render().el))}else{if(U.get("portlet_type")=="DEALS"&&U.get("name")=="Pending Deals"){App_Portlets.pendingDeals[parseInt(z)].collection.fetch();$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html(getRandomLoadingImg());$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html($(App_Portlets.pendingDeals[parseInt(z)].render().el))}else{if(U.get("portlet_type")=="DEALS"&&U.get("name")=="Deals Won"){App_Portlets.dealsWon[parseInt(z)].collection.fetch();$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html(getRandomLoadingImg());$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").html($(App_Portlets.dealsWon[parseInt(z)].render().el))}else{if(U.get("portlet_type")=="DEALS"&&U.get("name")=="Deals By Milestone"){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").attr("id",b);var I=b;var y="/core/api/portlets/portletDealsByMilestone?deals="+U.get("settings").deals+"&track="+U.get("settings").track;var Q=[];var A=[];var S=[];var M=[];$("#"+I).html(getRandomLoadingImg());fetchPortletsGraphData(y,function(V){if(V.status==403){$("#"+I).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}Q=V.milestonesList;A=V.milestoneValuesList;S=V.milestoneNumbersList;M=V.milestoneMap;dealsByMilestoneBarGraph(I,Q,A,S);var W="";$.each(M,function(X,Y){if(U.get("settings").track==0&&Y=="Default"){W+="<option value="+X+" selected='selected'>"+Y+"</option>"}else{if(U.get("settings").track==X){W+="<option value="+X+" selected='selected'>"+Y+"</option>"}else{W+="<option value="+X+">"+Y+"</option>"}}});$("#"+U.get("id")+"-track-options").append(W)})}else{if(U.get("portlet_type")=="DEALS"&&U.get("name")=="Closures Per Person"){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").attr("id",b);var I=b;var y="/core/api/portlets/portletClosuresPerPerson?due-date="+U.get("settings")["due-date"];var S=[];var A=[];var u=[];$("#"+I).html(getRandomLoadingImg());fetchPortletsGraphData(y,function(V){if(V.status==403){$("#"+I).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}S=V.milestoneNumbersList;A=V.milestoneValuesList;u=V.domainUsersList;var Y=[];$.each(u,function(ab,aa){Y.push(aa)});var Z=[];var X="";var W="";if(U.get("settings")["group-by"]=="number-of-deals"){$.each(S,function(aa,ab){Z.push(ab)});X="No. of Deals Won";W="Deals Won"}else{$.each(A,function(aa,ab){Z.push(ab)});X="Deals Won Value";W="Won Deal Value"}closuresPerPersonBarGraph(I,Y,Z,X,W)})}else{if(U.get("portlet_type")=="DEALS"&&U.get("name")=="Deals Funnel"){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").attr("id",b);var I=b;var y="/core/api/portlets/portletDealsFunnel?deals="+U.get("settings").deals+"&track="+U.get("settings").track;var Q=[];var A=[];var M=[];$("#"+I).html(getRandomLoadingImg());fetchPortletsGraphData(y,function(V){if(V.status==403){$("#"+I).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}Q=V.milestonesList;A=V.milestoneValuesList;M=V.milestoneMap;var Z=[];var X;$.each(Q,function(ac,ad){var ab=[];if(ad!="Lost"){if(ad!="Won"){ab.push(ad,A[ac])}else{X=ac}if(ab!=""){Z.push(ab)}}});var aa=[];if(X!=undefined){aa.push(Q[X],A[X]);Z.push(aa)}var W=false;$.each(Z,function(ab,ac){if(ac[1]>0){W=true}});if(W){Z=Z}else{Z=[]}dealsFunnelGraph(I,Z);var Y="";$.each(M,function(ab,ac){if(U.get("settings").track==0&&ac=="Default"){Y+="<option value="+ab+" selected='selected'>"+ac+"</option>"}else{if(U.get("settings").track==ab){Y+="<option value="+ab+" selected='selected'>"+ac+"</option>"}else{Y+="<option value="+ab+">"+ac+"</option>"}}});$("#"+U.get("id")+"-track-options").append(Y)})}else{if(U.get("portlet_type")=="USERACTIVITY"&&U.get("name")=="Emails Sent"){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").attr("id",b);
var I=b;var y="/core/api/portlets/portletEmailsSent?duration="+U.get("settings").duration;var u=[];var T=[];var N=[];$("#"+I).html(getRandomLoadingImg());fetchPortletsGraphData(y,function(X){if(X.status==403){$("#"+I).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}u=X.domainUsersList;T=X.mailsCountList;N=X.mailsOpenedCountList;var W=[];var Z="";var V;var Y={};Y.name="Emails Not Opened";Y.data=T;W[0]=Y;Y={};Y.name="Emails Opened";Y.data=N;W[1]=Y;Z="No. of Emails";V=["gray","green"];emailsSentBarGraph(I,u,W,T,N,Z,V)})}else{if(U.get("portlet_type")=="CONTACTS"&&U.get("name")=="Growth Graph"){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").attr("id",b);var I=b;var y="/core/api/portlets/portletGrowthGraph?tags="+U.get("settings").tags+"&frequency="+U.get("settings").frequency+"&duration="+U.get("settings").duration+"&start-date="+getStartAndEndDatesOnDue(U.get("settings").duration)+"&end-date="+getStartAndEndDatesOnDue("TOMORROW");$("#"+I).html(getRandomLoadingImg());fetchPortletsGraphData(y,function(V){if(V.status==406){$save_info=$('<div class="portlet-error-message" style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+V.responseText+"</i></p></small></div>");$("#"+I).html($save_info).show();return}var W=[];$.each(V,function(aa,Z){W.push(aa)});W.sort();var Y={};$.each(W,function(Z,aa){Y[""+aa]=V[""+aa]});var X;$.each(Y,function(aa,Z){if(X==undefined){var ab=0;X=[];$.each(Z,function(ae,ad){var ac={};ac.name=ae;ac.data=[];X[ab++]=ac})}$.each(Z,function(ae,ad){var ac=find_series_with_name(X,ae);ac.data.push([aa*1000,ad])})});portletGrowthGraph(I,X,U)});var L=U.get("settings");var R=L.tags;var F=R.split(",");var E="";$.each(F,function(V,W){if(W!=""){E+="<li data='"+W+"' style='display: inline-block;' class='tag'>"+W+"<a id='remove_tag' class='close'>&times</a></li>"}});$("#"+U.get("id")+"-portlet-ul-tags").append(E);setup_tags_typeahead()}else{if(U.get("portlet_type")=="DEALS"&&U.get("name")=="Deals Assigned"){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").attr("id",b);var I=b;var y="/core/api/portlets/portletDealsAssigned?duration="+U.get("settings").duration;var u=[];var x=[];$("#"+I).html(getRandomLoadingImg());fetchPortletsGraphData(y,function(V){if(V.status==403){$("#"+I).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}u=V.domainUsersList;x=V.assignedOpportunitiesCountList;dealsAssignedBarGraph(I,u,x)})}else{if(U.get("portlet_type")=="USERACTIVITY"&&U.get("name")=="Calls Per Person"){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").attr("id",b);var t="";var v="";if(U.get("settings").duration=="yesterday"){t=""+U.get("settings").duration;v="today"}else{t=""+U.get("settings").duration;v="TOMORROW"}var I=b;var y="/core/api/portlets/portletCallsPerPerson?duration="+U.get("settings").duration+"&start-date="+getStartAndEndDatesOnDue(t)+"&end-date="+getStartAndEndDatesOnDue(v);var C=[];var B=[];var e=[];var D=[];var J=[];var H=[];var u=[];$("#"+I).html(getRandomLoadingImg());fetchPortletsGraphData(y,function(aa){if(aa.status==403){$("#"+I).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}C=aa.answeredCallsCountList;B=aa.busyCallsCountList;e=aa.failedCallsCountList;D=aa.voiceMailCallsCountList;J=aa.callsDurationList;H=aa.totalCallsCountList;u=aa.domainUsersList;var X=[];var Z="";var W;if(U.get("settings")["group-by"]=="number-of-calls"){var Y={};Y.name="Answered";Y.data=C;X[0]=Y;Y={};Y.name="Busy";Y.data=B;X[1]=Y;Y={};Y.name="Failed";Y.data=e;X[2]=Y;Y={};Y.name="Voicemail";Y.data=D;X[3]=Y;Z="No. of Calls";W=["green","blue","red","violet"]}else{var Y={};Y.name="Total Duration";var V=[];$.each(J,function(ab,ac){V[ab]=ac/60});Y.data=V;X[0]=Y;Z="Calls Duration (Mins)";W=["green"]}callsPerPersonBarGraph(I,u,X,H,J,Z,W)})}else{if(U.get("portlet_type")=="TASKSANDEVENTS"&&U.get("name")=="Task Report"){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").attr("id",b);var t="";var v="";if(U.get("settings").duration=="yesterday"){t=""+U.get("settings").duration;v="today"}else{t=""+U.get("settings").duration;v="TOMORROW"}var I=b;var y="/core/api/portlets/portletTaskReport?group-by="+U.get("settings")["group-by"]+"&split-by="+U.get("settings")["split-by"]+"&start-date="+getStartAndEndDatesOnDue(t)+"&end-date="+getStartAndEndDatesOnDue(v);var G=[];var O=[];var K=[];$("#"+I).html(getRandomLoadingImg());fetchPortletsGraphData(y,function(ab){if(ab.status==403){$("#"+I).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}G=ab.groupByList;O=ab.splitByList;var X=[];var Z="";var V;$.each(O,function(ad,ac){if(K.length==0){$.each(ac,function(ae,af){K.push(ae)})}});for(var W=0;W<K.length;W++){var Y={};var aa=[];$.each(O,function(ad,ac){$.each(ac,function(ae,af){if(ae==K[W]){aa.push(af)}})});Y.name=K[W];Y.data=aa;X[W]=Y}Z="Task Report";taskReportBarGraph(I,G,X,Z)})}}}}}}}}}}}}}setPortletContentHeight(U);$("#"+U.get("id")).parent().find("div:last").after('<span class="gs-resize-handle gs-resize-handle-both"></span>');if(U.get("is_minimized")){$("#"+c.split("-save-modal")[0]).parent().find(".portlet_body").hide()}},error:function(t,e){}})}});function showPortletSettingsForm(b){$("#portletSettingsModal > .modal-body > form").each(function(){if($(this).attr("id")==b){$(this).show()}else{$(this).hide()}})}function initBlogPortletSync(b){head.js(LIB_PATH+"lib/jquery.feeds.min.js",function(){$("#portlet_blog_sync_container",b).feeds({feeds:{blog:"https://www.agilecrm.com/blog/feed/"},max:3,entryTemplate:function(c){return'<strong><a href="'+c.link+'" title = "'+c.title+'" target="_blank" >'+c.title+'</a></strong><div style="color:#999;font-size:11px;line-height: 13px;margin-bottom:5px">'+new Date(c.publishedDate).format("mmm d, yyyy")+'</div><p style="padding-top:5px;margin-bottom:15px">'+c.contentSnippet.replace("<a",'<a target="_blank"')+"</p>"},onComplete:function(c){$("#portlet_blog_sync_container",b).append('<span class="pull-right"><a href="https://www.agilecrm.com/blog" target="_blank">Agile CRM Blog</a></span>')}})})}$("#group-by-task-report").live("change",function(b){$("#split-by-task-report > option").each(function(c){if($(this).val()==$("#group-by-task-report").val()){$(this).hide()}else{$(this).show();$(this).attr("selected",true)}})});var itemCollection;var itemCollection1;var tasksCollection;function organize_portlets(c){var d=new Base_List_View({model:c,template:this.options.templateKey+"-model",tagName:"div"});var e=c.get("portlet_type");var b=c.get("is_added");if(e=="CONTACTS"){$("#contacts",this.el).append($(d.render().el))}else{if(e=="DEALS"){$("#deals",this.el).append($(d.render().el))}else{if(e=="TASKSANDEVENTS"){$("#taksAndEvents",this.el).append($(d.render().el))}else{if(e=="USERACTIVITY"){$("#userActivity",this.el).append($(d.render().el))}else{if(e=="RSS"){$("#rssFeed",this.el).append($(d.render().el))}}}}}}function set_p_portlets(b){var d;if(b.get("portlet_type")=="CONTACTS"&&b.get("name")=="Filter Based"){App_Portlets.filteredContactsView=new Base_Model_View({model:b,template:"portlets-contacts-filterbased-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.filteredContactsView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.filteredContactsView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="CONTACTS"&&b.get("name")=="Emails Opened"){App_Portlets.emailsOpenedView=new Base_Model_View({model:b,template:"portlets-contacts-emails-opened-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.emailsOpenedView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.emailsOpenedView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="USERACTIVITY"&&b.get("name")=="Emails Sent"){App_Portlets.emailsSentView=new Base_Model_View({model:b,template:"portlets-contacts-emails-sent-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.emailsSentView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.emailsSentView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))
}}else{if(b.get("portlet_type")=="CONTACTS"&&b.get("name")=="Growth Graph"){App_Portlets.growthGraphView=new Base_Model_View({model:b,template:"portlets-contacts-growth-graph-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.growthGraphView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.growthGraphView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="DEALS"&&b.get("name")=="Pending Deals"){App_Portlets.pendingDealsView=new Base_Model_View({model:b,template:"portlets-deals-pending-deals-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.pendingDealsView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.pendingDealsView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="DEALS"&&b.get("name")=="Deals By Milestone"){App_Portlets.dealsByMilestoneView=new Base_Model_View({model:b,template:"portlets-deals-deals-by-milestone-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.dealsByMilestoneView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.dealsByMilestoneView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="DEALS"&&b.get("name")=="Closures Per Person"){App_Portlets.closuresPerPersonView=new Base_Model_View({model:b,template:"portlets-deals-closures-per-person-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.emailsOpenedView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.emailsOpenedView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="DEALS"&&b.get("name")=="Deals Won"){App_Portlets.dealsWonView=new Base_Model_View({model:b,template:"portlets-deals-deals-won-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.dealsWonView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.dealsWonView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="DEALS"&&b.get("name")=="Deals Funnel"){App_Portlets.dealsFunnelView=new Base_Model_View({model:b,template:"portlets-deals-deals-funnel-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.dealsFunnelView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.dealsFunnelView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="DEALS"&&b.get("name")=="Deals Assigned"){App_Portlets.dealsAssignedView=new Base_Model_View({model:b,template:"portlets-deals-deals-assigned-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.dealsAssignedView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.dealsAssignedView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="TASKSANDEVENTS"&&b.get("name")=="Agenda"){App_Portlets.agendaView=new Base_Model_View({model:b,template:"portlets-tasksandevents-agenda-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.agendaView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.agendaView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="TASKSANDEVENTS"&&b.get("name")=="Today Tasks"){App_Portlets.todayTasksView=new Base_Model_View({model:b,template:"portlets-tasksandevents-today-tasks-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.todayTasksView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.todayTasksView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="USERACTIVITY"&&b.get("name")=="Calls Per Person"){App_Portlets.callsPerPersonView=new Base_Model_View({model:b,template:"portlets-contacts-calls-per-person-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.callsPerPersonView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.callsPerPersonView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}else{if(b.get("portlet_type")=="RSS"&&b.get("name")=="Agile CRM Blog"){App_Portlets.agileCRMBlogView=new Base_Model_View({model:b,template:"portlets-useractivity-blog-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.agileCRMBlogView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.agileCRMBlogView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))
}}else{if(b.get("portlet_type")=="TASKSANDEVENTS"&&b.get("name")=="Task Report"){App_Portlets.taskReportView=new Base_Model_View({model:b,template:"portlets-tasksandevents-task-report-model",tagName:"div"});if($(".gridster > div:visible > div",this.el).length==0){$(".gridster > div:visible",this.el).html($(App_Portlets.taskReportView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}else{$(".gridster > div:visible > div:last",this.el).after($(App_Portlets.taskReportView.render().el).attr("id","ui-id-"+b.get("column_position")+"-"+b.get("row_position")).attr("data-sizey",b.get("size_y")).attr("data-sizex",b.get("size_x")).attr("data-col",b.get("column_position")).attr("data-row",b.get("row_position")).addClass("gs-w"))}}}}}}}}}}}}}}}}var j=b.get("column_position");var c=b.get("row_position");var h=b.get("settings");var g=""+j+""+c;if(b.get("portlet_type")=="CONTACTS"&&b.get("name")=="Filter Based"){if(b.get("settings").filter=="companies"){App_Portlets.filteredCompanies[parseInt(g)]=new Base_Collection_View({url:"/core/api/portlets/portletContacts?filter="+b.get("settings").filter+"&sortKey=-created_time",templateKey:"portlets-companies",sort_collection:false,individual_tag_name:"tr",sortKey:"-created_time"})}else{App_Portlets.filteredContacts[parseInt(g)]=new Base_Collection_View({url:"/core/api/portlets/portletContacts?filter="+b.get("settings").filter+"&sortKey=-created_time",templateKey:"portlets-contacts",sort_collection:false,individual_tag_name:"tr",sortKey:"-created_time",postRenderCallback:function(k){addWidgetToGridster(b)}})}}else{if(b.get("portlet_type")=="CONTACTS"&&b.get("name")=="Emails Opened"){var e="";var f="";if(b.get("settings").duration=="yesterday"){e=""+b.get("settings").duration;f="today"}else{e=""+b.get("settings").duration;f="TOMORROW"}App_Portlets.emailsOpened[parseInt(g)]=new Base_Collection_View({url:"/core/api/portlets/portletEmailsOpened?duration="+b.get("settings").duration+"&start-date="+getStartAndEndDatesOnDue(e)+"&end-date="+getStartAndEndDatesOnDue(f),templateKey:"portlets-contacts-email-opens",sort_collection:false,individual_tag_name:"tr",postRenderCallback:function(k){displayTimeAgo(k);addWidgetToGridster(b)}})}else{if(b.get("portlet_type")=="DEALS"&&b.get("name")=="Pending Deals"){App_Portlets.pendingDeals[parseInt(g)]=new Base_Collection_View({url:"/core/api/portlets/portletPendingDeals?deals="+b.get("settings").deals,templateKey:"portlets-opportunities",individual_tag_name:"tr",postRenderCallback:function(k){displayTimeAgo(k);addWidgetToGridster(b)}});App_Portlets.pendingDeals[parseInt(g)].collection.fetch()}else{if(b.get("portlet_type")=="DEALS"&&b.get("name")=="Deals Won"){App_Portlets.dealsWon[parseInt(g)]=new Base_Collection_View({url:"/core/api/portlets/portletDealsWon?duration="+b.get("settings").duration,templateKey:"portlets-opportunities",individual_tag_name:"tr",postRenderCallback:function(k){displayTimeAgo(k);addWidgetToGridster(b)}});App_Portlets.dealsWon[parseInt(g)].collection.fetch()}else{if(b.get("portlet_type")=="TASKSANDEVENTS"&&b.get("name")=="Agenda"){App_Portlets.todayEventsCollection[parseInt(g)]=new Base_Collection_View({url:"/core/api/portlets/portletAgenda?start_time="+getNewDueDate("TODAY")+"&end_time="+getNewDueDate("TOMORROW"),templateKey:"portlets-events",individual_tag_name:"tr",postRenderCallback:function(k){addWidgetToGridster(b)}});App_Portlets.todayEventsCollection[parseInt(g)].collection.fetch()}else{if(b.get("portlet_type")=="TASKSANDEVENTS"&&b.get("name")=="Today Tasks"){App_Portlets.tasksCollection[parseInt(g)]=new Base_Collection_View({url:"/core/api/portlets/portletTodayTasks?start_time="+getNewDueDate("TODAY")+"&end_time="+getNewDueDate("TOMORROW"),templateKey:"portlets-tasks",individual_tag_name:"tr",postRenderCallback:function(k){addWidgetToGridster(b)}});App_Portlets.tasksCollection[parseInt(g)].collection.fetch()}}}}}}if(itemCollection!=undefined){itemCollection.collection.fetch()}$(".portlet_body",this.el).each(function(){if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")!="Deals By Milestone"&&b.get("name")!="Closures Per Person"&&b.get("name")!="Deals Funnel"&&b.get("name")!="Emails Sent"&&b.get("name")!="Growth Graph"&&b.get("name")!="Today Tasks"&&b.get("name")!="Deals Assigned"&&b.get("name")!="Calls Per Person"&&b.get("name")!="Agile CRM Blog"&&b.get("name")!="Agenda"&&b.get("name")!="Pending Deals"&&b.get("name")!="Deals Won"&&b.get("name")!="Filter Based"&&b.get("name")!="Emails Opened"&&b.get("name")!="Task Report"){$(this).html(getRandomLoadingImg());$(this).html($(itemCollection.render().el));setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Filter Based"){if(b.get("settings").filter=="companies"){App_Portlets.filteredCompanies[parseInt(g)].collection.fetch();$(this).html(getRandomLoadingImg());$(this).html($(App_Portlets.filteredCompanies[parseInt(g)].render().el))}else{App_Portlets.filteredContacts[parseInt(g)].collection.fetch();$(this).html(getRandomLoadingImg());$(this).html($(App_Portlets.filteredContacts[parseInt(g)].render().el))}setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Emails Opened"){App_Portlets.emailsOpened[parseInt(g)].collection.fetch();$(this).html(getRandomLoadingImg());$(this).html($(App_Portlets.emailsOpened[parseInt(g)].render().el));setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Pending Deals"){$(this).html(getRandomLoadingImg());$(this).html($(App_Portlets.pendingDeals[parseInt(g)].render().el));setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Deals Won"){$(this).html(getRandomLoadingImg());$(this).html($(App_Portlets.dealsWon[parseInt(g)].render().el));setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Agenda"){$(this).html(getRandomLoadingImg());$(this).html($(App_Portlets.todayEventsCollection[parseInt(g)].render().el));setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Today Tasks"){$(this).html(getRandomLoadingImg());$(this).html($(App_Portlets.tasksCollection[parseInt(g)].render().el));setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Deals By Milestone"){$(this).attr("id","p-body-"+j+"-"+c);var z=$(this).attr("id");var p="/core/api/portlets/portletDealsByMilestone?deals="+b.get("settings").deals+"&track="+b.get("settings").track;var G=[];var q=[];var I=[];var D=[];$("#"+z).html(getRandomLoadingImg());fetchPortletsGraphData(p,function(K){if(K.status==403){$("#"+z).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}G=K.milestonesList;q=K.milestoneValuesList;I=K.milestoneNumbersList;D=K.milestoneMap;dealsByMilestoneBarGraph(z,G,q,I);addWidgetToGridster(b)});if(b.get("is_minimized")){$(this).hide()}setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Closures Per Person"){$(this).attr("id","p-body-"+j+"-"+c);var z=$(this).attr("id");var p="/core/api/portlets/portletClosuresPerPerson?due-date="+b.get("settings")["due-date"];var I=[];var q=[];var m=[];$("#"+z).html(getRandomLoadingImg());fetchPortletsGraphData(p,function(L){if(L.status==403){$("#"+z).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}I=L.milestoneNumbersList;q=L.milestoneValuesList;m=L.domainUsersList;var N=[];$.each(m,function(Q,P){N.push(P)});var O=[];var M="";var K="";if(b.get("settings")["group-by"]=="number-of-deals"){$.each(I,function(P,Q){O.push(Q)});M="No. of Deals Won";K="Deals Won"}else{$.each(q,function(P,Q){O.push(Q)});M="Deals Won Value";K="Won Deal Value"}closuresPerPersonBarGraph(z,N,O,M,K);addWidgetToGridster(b)});if(b.get("is_minimized")){$(this).hide()}setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Deals Funnel"){$(this).attr("id","p-body-"+j+"-"+c);var z=$(this).attr("id");var p="/core/api/portlets/portletDealsFunnel?deals="+b.get("settings").deals+"&track="+b.get("settings").track;var G=[];var q=[];var D=[];$("#"+z).html(getRandomLoadingImg());fetchPortletsGraphData(p,function(N){if(N.status==403){$("#"+z).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}G=N.milestonesList;q=N.milestoneValuesList;D=N.milestoneMap;var M=[];var L;$.each(G,function(Q,R){var P=[];if(R!="Lost"){if(R!="Won"){P.push(R,q[Q])}else{L=Q}if(P!=""){M.push(P)}}});var O=[];if(L!=undefined){O.push(G[L],q[L]);M.push(O)}var K=false;$.each(M,function(P,Q){if(Q[1]>0){K=true}});if(K){M=M}else{M=[]}dealsFunnelGraph(z,M);addWidgetToGridster(b)});if(b.get("is_minimized")){$(this).hide()}setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Emails Sent"){$(this).attr("id","p-body-"+j+"-"+c);var z=$(this).attr("id");var p="/core/api/portlets/portletEmailsSent?duration="+b.get("settings").duration;var m=[];var J=[];var E=[];$("#"+z).html(getRandomLoadingImg());fetchPortletsGraphData(p,function(M){if(M.status==403){$("#"+z).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}m=M.domainUsersList;J=M.mailsCountList;E=M.mailsOpenedCountList;var L=[];var O="";var K;var N={};N.name="Emails Not Opened";N.data=J;L[0]=N;N={};N.name="Emails Opened";N.data=E;L[1]=N;O="No. of Emails";K=["gray","green"];emailsSentBarGraph(z,m,L,J,E,O,K);
addWidgetToGridster(b)});if(b.get("is_minimized")){$(this).hide()}setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Growth Graph"){$(this).attr("id","p-body-"+j+"-"+c);var z=$(this).attr("id");var p="/core/api/portlets/portletGrowthGraph?tags="+b.get("settings").tags+"&frequency="+b.get("settings").frequency+"&duration="+b.get("settings").duration+"&start-date="+getStartAndEndDatesOnDue(b.get("settings").duration)+"&end-date="+getStartAndEndDatesOnDue("TOMORROW");$("#"+z).html(getRandomLoadingImg());fetchPortletsGraphData(p,function(N){if(N.status==406){$save_info=$('<div class="portlet-error-message" style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+N.responseText+"</i></p></small></div>");$("#"+z).html($save_info).show();return}var K=[];$.each(N,function(P,O){K.push(P)});K.sort();var M={};$.each(K,function(O,P){M[""+P]=N[""+P]});var L;$.each(M,function(P,O){if(L==undefined){var Q=0;L=[];$.each(O,function(T,S){var R={};R.name=T;R.data=[];L[Q++]=R})}$.each(O,function(T,S){var R=find_series_with_name(L,T);R.data.push([P*1000,S])})});portletGrowthGraph(z,L,b);addWidgetToGridster(b)});if(b.get("is_minimized")){$(this).hide()}setPortletContentHeight(b);var C=b.get("settings");var H=C.tags;var w=H.split(",");var v="";$.each(w,function(K,L){if(L!=""){v+="<li data='"+L+"' style='display: inline-block;' class='tag'>"+L+"<a id='remove_tag' class='close'>&times</a></li>"}});$("#"+b.get("id")+"-portlet-ul-tags").append(v);setup_tags_typeahead()}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Deals Assigned"){$(this).attr("id","p-body-"+j+"-"+c);var z=$(this).attr("id");var p="/core/api/portlets/portletDealsAssigned?duration="+b.get("settings").duration;var m=[];var o=[];$("#"+z).html(getRandomLoadingImg());fetchPortletsGraphData(p,function(K){if(K.status==403){$("#"+z).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}m=K.domainUsersList;o=K.assignedOpportunitiesCountList;dealsAssignedBarGraph(z,m,o);addWidgetToGridster(b)});if(b.get("is_minimized")){$(this).hide()}setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Calls Per Person"){$(this).attr("id","p-body-"+j+"-"+c);var l="";var n="";if(b.get("settings").duration=="yesterday"){l=""+b.get("settings").duration;n="today"}else{l=""+b.get("settings").duration;n="TOMORROW"}var z=$(this).attr("id");var p="/core/api/portlets/portletCallsPerPerson?duration="+b.get("settings").duration+"&start-date="+getStartAndEndDatesOnDue(l)+"&end-date="+getStartAndEndDatesOnDue(n);var t=[];var s=[];var k=[];var u=[];var A=[];var y=[];var m=[];$("#"+z).html(getRandomLoadingImg());fetchPortletsGraphData(p,function(N){if(N.status==403){$("#"+z).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}t=N.answeredCallsCountList;s=N.busyCallsCountList;k=N.failedCallsCountList;u=N.voiceMailCallsCountList;A=N.callsDurationList;y=N.totalCallsCountList;m=N.domainUsersList;var M=[];var P="";var L;if(b.get("settings")["group-by"]=="number-of-calls"){var O={};O.name="Answered";O.data=t;M[0]=O;O={};O.name="Busy";O.data=s;M[1]=O;O={};O.name="Failed";O.data=k;M[2]=O;O={};O.name="Voicemail";O.data=u;M[3]=O;P="No. of Calls";L=["green","blue","red","violet"]}else{var O={};O.name="Total Duration";var K=[];$.each(A,function(Q,R){K[Q]=R/60});O.data=K;M[0]=O;P="Calls Duration (Mins)";L=["green"]}callsPerPersonBarGraph(z,m,M,y,A,P,L);addWidgetToGridster(b)});if(b.get("is_minimized")){$(this).hide()}setPortletContentHeight(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Agile CRM Blog"){$(this).find("div").html(getRandomLoadingImg());initBlogPortletSync($(this));if(b.get("is_minimized")){$(this).hide()}setPortletContentHeight(b);addWidgetToGridster(b)}else{if($(this).parent().attr("id")=="ui-id-"+j+"-"+c&&b.get("name")=="Task Report"){$(this).attr("id","p-body-"+j+"-"+c);var l="";var n="";if(b.get("settings").duration=="yesterday"){l=""+b.get("settings").duration;n="today"}else{l=""+b.get("settings").duration;n="TOMORROW"}var z=$(this).attr("id");var p="/core/api/portlets/portletTaskReport?group-by="+b.get("settings")["group-by"]+"&split-by="+b.get("settings")["split-by"]+"&start-date="+getStartAndEndDatesOnDue(l)+"&end-date="+getStartAndEndDatesOnDue(n);var x=[];var F=[];var B=[];$("#"+z).html(getRandomLoadingImg());fetchPortletsGraphData(p,function(N){if(N.status==403){$("#"+z).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}x=N.groupByList;F=N.splitByList;var M=[];var P="";var K;$.each(F,function(S,R){if(B.length==0){$.each(R,function(T,U){B.push(T)})}});for(var L=0;L<B.length;L++){var O={};var Q=[];$.each(F,function(S,R){$.each(R,function(T,U){if(T==B[L]){Q.push(U)}})});O.name=B[L];O.data=Q;M[L]=O}P="Task Report";taskReportBarGraph(z,x,M,P);addWidgetToGridster(b)});if(b.get("is_minimized")){$(this).hide()}setPortletContentHeight(b)}}}}}}}}}}}}}}}}addWidgetToGridster(b)})}function fetchPortletsGraphData(c,b){$("#plan-limit-error").hide();$.getJSON(c,function(d){if(b&&typeof(b)==="function"){b(d)}}).error(function(d){if(d.status!=406&&d.status!=403){return}if(b&&typeof(b)==="function"){b(d)}})}function dealsByMilestoneBarGraph(b,d,e,c){head.js(LIB_PATH+"lib/flot/highcharts-3.js",LIB_PATH+"lib/flot/no-data-to-display.js",function(){if(d.length==0){$("#"+b).highcharts({chart:{type:"bar",marginRight:20},title:{text:""},xAxis:{categories:[]},yAxis:{min:0,title:{text:""}},series:[],exporting:{enabled:false}})}else{$("#"+b).highcharts({chart:{type:"bar",marginRight:20},title:{text:""},xAxis:{categories:d},yAxis:{min:0,title:{text:"Deal Value"},allowDecimals:false},legend:{enabled:false},tooltip:{formatter:function(){return'<table><tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+'s: </td><td style="padding:0"><b>'+c[this.points[0].point.x]+'</b></td></tr><tr><td style="color:'+this.points[0].series.color+';padding:0">Total Value: </td><td style="padding:0"><b>'+getPortletsCurrencySymbol()+""+e[this.points[0].point.x].toLocaleString()+"</b></td></tr></table>"},shared:true,useHTML:true},plotOptions:{column:{pointPadding:0.2,borderWidth:0}},series:[{name:"Deal",data:e}],exporting:{enabled:false}})}})}function closuresPerPersonBarGraph(b,f,d,e,c){head.js(LIB_PATH+"lib/flot/highcharts-3.js",function(){$("#"+b).highcharts({chart:{type:"bar",marginRight:20},title:{text:""},xAxis:{categories:f},yAxis:{min:0,title:{text:e},allowDecimals:false},legend:{enabled:false},tooltip:{formatter:function(){return'<span style="font-size:10px">'+this.points[0].key+'</span><table><tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+': </td><td style="padding:0"><b>'+d[this.points[0].point.x]+"</b></td></tr></table>"},shared:true,useHTML:true},plotOptions:{column:{pointPadding:0.2,borderWidth:0}},series:[{name:c,data:d}],exporting:{enabled:false}})})}function dealsFunnelGraph(b,c){head.js(LIB_PATH+"lib/flot/highcharts-3.js",LIB_PATH+"lib/flot/funnel.js",LIB_PATH+"lib/flot/no-data-to-display.js",function(){$("#"+b).highcharts({chart:{type:"funnel",marginRight:20,className:"deals-funnel-portlet"},title:{text:""},plotOptions:{series:{dataLabels:{enabled:true,format:"<b>{point.name}</b> ("+getPortletsCurrencySymbol()+"{point.y:,.0f})",color:"black",softConnector:true},neckWidth:"20%",neckHeight:"20%",height:"100%",width:"50%"}},tooltip:{pointFormat:"<span>{series.name}:<b>"+getPortletsCurrencySymbol()+"{point.y:,.0f}</b></span>",shared:true,useHTML:true},series:[{name:"Value",data:c}],exporting:{enabled:false}})})}function emailsSentBarGraph(b,e,g,d,f,h,c){head.js(LIB_PATH+"lib/flot/highcharts-3.js",function(){$("#"+b).highcharts({chart:{type:"bar",marginRight:20},title:{text:""},xAxis:{categories:e},yAxis:{min:0,title:{text:h},allowDecimals:false},tooltip:{formatter:function(){return'<table><tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+': </td><td style="padding:0"><b>'+d[this.points[0].point.x]+'</b></td></tr><tr><td style="color:'+this.points[1].series.color+';padding:0">'+this.points[1].series.name+': </td><td style="padding:0"><b>'+f[this.points[1].point.x]+"</b></td></tr></table>"},shared:true,useHTML:true},plotOptions:{series:{stacking:"normal"},column:{pointPadding:0.2,borderWidth:0}},series:g,exporting:{enabled:false},colors:c})})}function portletGrowthGraph(c,e,b){var d=true;if(b.get("settings").tags==""){$("#"+c).html("<div class='portlet-error-message'>Please <a href='#' id='"+b.get("id")+"-settings' class='portlet-settings' dada-toggle='modal'>configure</a> the dashlet and add the Tags.</div>");d=false}if(d){head.js(LIB_PATH+"lib/flot/highcharts-3.js",function(){$("#"+c).highcharts({chart:{type:"line",marginRight:20},title:{text:""},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%e.%b"},minTickInterval:24*3600*1000},yAxis:{min:0,title:{text:""}},ongraphtooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.dateFormat("%e.%b",this.x)+": "+this.y.toFixed(2)},shared:true,useHTML:true},plotOptions:{column:{pointPadding:0.2,borderWidth:0}},series:e,exporting:{enabled:false}})})}}function dealsAssignedBarGraph(c,d,b){head.js(LIB_PATH+"lib/flot/highcharts-3.js",function(){$("#"+c).highcharts({chart:{type:"bar",marginRight:20},title:{text:""},xAxis:{categories:d},yAxis:{min:0,title:{text:"No. of deals assigned"},allowDecimals:false},legend:{enabled:false},tooltip:{formatter:function(){return'<span style="font-size:10px">'+this.points[0].key+'</span><table><tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+': </td><td style="padding:0"><b>'+b[this.points[0].point.x]+"</b></td></tr></table>"
},shared:true,useHTML:true},plotOptions:{column:{pointPadding:0.2,borderWidth:0}},series:[{name:"Assigned Deals",data:b}],exporting:{enabled:false}})})}function callsPerPersonBarGraph(b,d,f,e,g,h,c){head.js(LIB_PATH+"lib/flot/highcharts-3.js",function(){$("#"+b).highcharts({chart:{type:"bar",marginRight:20},title:{text:""},xAxis:{categories:d},yAxis:{min:0,title:{text:h},allowDecimals:false},tooltip:{formatter:function(){var j="";if(h=="Calls Duration (Mins)"){j='<table><tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+': </td><td style="padding:0"><b>'+getPortletsTimeConversion(g[this.points[0].point.x])+'</b></td></tr><tr><td style="color:'+this.points[0].series.color+';padding:0">Calls: </td><td style="padding:0"><b>'+e[this.points[0].point.x]+"</b></td></tr></table>"}else{j+="<table>";if(this.points[0]!=undefined&&this.points[0].series!=undefined){j+='<tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+': </td><td style="padding:0"><b>'+this.points[0].point.y+"</b></td></tr>"}if(this.points[1]!=undefined&&this.points[1].series!=undefined){j+='<tr><td style="color:'+this.points[1].series.color+';padding:0">'+this.points[1].series.name+': </td><td style="padding:0"><b>'+this.points[1].point.y+"</b></td></tr>"}if(this.points[2]!=undefined&&this.points[2].series!=undefined){j+='<tr><td style="color:'+this.points[2].series.color+';padding:0">'+this.points[2].series.name+': </td><td style="padding:0"><b>'+this.points[2].point.y+"</b></td></tr>"}if(this.points[3]!=undefined&&this.points[3].series!=undefined){j+='<tr><td style="color:'+this.points[3].series.color+';padding:0">'+this.points[3].series.name+': </td><td style="padding:0"><b>'+this.points[3].point.y+"</b></td></tr>"}j+="</table>"}return j},shared:true,useHTML:true},plotOptions:{series:{stacking:"normal"},column:{pointPadding:0.2,borderWidth:0}},series:f,exporting:{enabled:false},colors:c})})}function enablePortletTimeAndDates(b){if(b.get("name")=="Growth Graph"){head.js(LIB_PATH+"lib/date-charts.js",LIB_PATH+"lib/date-range-picker.js",CSS_PATH+"css/misc/date-picker.css",function(){$("#portlet-reportrange").daterangepicker({ranges:{Today:["today","today"],Yesterday:["yesterday","yesterday"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 30 Days":[Date.today().add({days:-29}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})]}},function(d,c){$("#portlet-reportrange span").html(d.toString("MMMM d, yyyy")+" - "+c.toString("MMMM d, yyyy"));$("#start-date").val(d.getTime());$("#end-date").val(c.getTime())})})}}function setPortletContentHeight(b){if(b.get("size_y")==1){$("#"+b.get("id")).parent().find(".portlet_body").css("height",(b.get("size_y")*200)-40+"px");$("#"+b.get("id")).parent().find(".portlet_body").css("max-height",(b.get("size_y")*200)-40+"px")}else{if(b.get("size_y")==2){$("#"+b.get("id")).parent().find(".portlet_body").css("height",(b.get("size_y")*200)+10-40+"px");$("#"+b.get("id")).parent().find(".portlet_body").css("max-height",(b.get("size_y")*200)+10-40+"px")}else{if(b.get("size_y")==3){$("#"+b.get("id")).parent().find(".portlet_body").css("height",(b.get("size_y")*200)+20-40+"px");$("#"+b.get("id")).parent().find(".portlet_body").css("max-height",(b.get("size_y")*200)+20-40+"px")}}}$("#"+b.get("id")).parent().find(".portlet_body").css("overflow-x","hidden");$("#"+b.get("id")).parent().find(".portlet_body").css("overflow-y","auto")}function getPortletsCurrencySymbol(){var c=((CURRENT_USER_PREFS.currency!=null)?CURRENT_USER_PREFS.currency:"USD-$");var b=((c.length<4)?"$":c.substring(4,c.length));return b}function getPortletsTimeConversion(b){if(b==undefined||b==null){return}var f="";var g=0;var d=0;var e=0;var c=0;g=Math.floor(b/(24*60*60));d=Math.floor((b%(24*60*60))/(60*60));e=Math.floor(((b%(24*60*60))%(60*60))/60);c=Math.floor(((b%(24*60*60))%(60*60))%60);if(d!=0){f+=""+((g*24)+d)+"h"}if(e!=0){f+=" "+e+"m"}if(c!=0){f+=" "+c+"s"}return f}function taskReportBarGraph(b,d,c,e){head.js(LIB_PATH+"lib/flot/highcharts-3.js",function(){$("#"+b).highcharts({chart:{type:"bar",marginRight:20},title:{text:""},xAxis:{categories:d},yAxis:{min:0,title:{text:e},allowDecimals:false},plotOptions:{series:{stacking:"normal"},column:{pointPadding:0.2,borderWidth:0}},series:c,exporting:{enabled:false}})})}$(function(){$("#cases-model-list > tr").live("mouseenter",function(){var d=$(this).find(".data").attr("data");var b=App_Cases.casesCollectionView.collection.get(d);var c=getTemplate("cases-detail-popover",b.toJSON());$(this).attr({rel:"popover","data-placement":"right","data-original-title":b.toJSON().title,"data-content":c});$("#cases-model-list > tr:last").attr({rel:"popover","data-placement":"top","data-original-title":b.toJSON().name,"data-content":c});$("#cases-model-list > tr:first").attr({rel:"popover","data-placement":"right","data-original-title":b.toJSON().name,"data-content":c});$(this).popover("show")});$("#cases-model-list > tr").live("mouseleave",function(){$(this).popover("hide")});$("#close-case").live("click",function(b){b.preventDefault()})});$(function(){$(".cases-add").live("click",function(b){b.preventDefault();showCases()});$("#cases_validate").live("click",function(f){f.preventDefault();var d=$(this).closest(".cases-modal").attr("id");var b=$(this).closest(".cases-modal").find("form").attr("id");var c=serializeForm(b);savecases(b,d,this,c)});$("#casesModal, #casesUpdateModal").on("show",function(c){$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error");var b=$(c.target);add_custom_fields_to_form({},function(e){var d=show_custom_fields_helper(e.custom_fields,[]);$("#custom-field-case",b).html($(d))},"CASE")});$("#casesModal, #casesUpdateModal").on("shown",function(){$(".date_input").attr("placeholder","MM/DD/YYYY");$(".date_input").datepicker({format:"mm/dd/yyyy"})});$("#casesModal").on("hidden",function(){$("#casesForm").find("li").remove();remove_validation_errors("casesModal")});$("#casesUpdateModal").on("hidden",function(){$("#casesUpdateForm").find("li").remove();remove_validation_errors("casesUpdateModal")});$('#cases-model-list > tr > td:not(":first-child")').live("click",function(b){b.preventDefault();updatecases($(this).closest("tr").data())})});function updatecases(d){var c=d.toJSON();add_recent_view(new BaseModel(c));var b=$("#casesUpdateForm");deserializeForm(c,$("#casesUpdateForm"));agile_type_ahead("contacts-typeahead-input",b,contacts_typeahead);$("#casesUpdateModal").modal("show");add_custom_fields_to_form(c,function(f){var e=show_custom_fields_helper(f.custom_fields,[]);console.log(c);console.log(e);console.log(c.custom_data);fill_custom_fields_values_generic($(e),c.custom_data);$("#custom-field-case",b).html(fill_custom_fields_values_generic($(e),c.custom_data))},"CASE");populateUsers("owners-list",b,c,"owner",function(e){b.find("#owners-list").html(e);if(c.owner){$("#owners-list",b).find("option[value="+c.owner.id+"]").attr("selected","selected")}})}function showCases(){var b=$("#casesForm");add_custom_fields_to_form({},function(d){var c=show_custom_fields_helper(d.custom_fields,[]);$("#custom-field-case",$("#casesModal")).html($(c))},"CASE");populateUsers("owners-list",b,undefined,undefined,function(c){$("#casesForm").find("#owners-list").html(c);$("#owners-list",$("#casesForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");agile_type_ahead("contacts-typeahead-input",b,contacts_typeahead)});$("#close_date",b).datepicker({format:"mm/dd/yyyy"});$("#casesModal").modal("show")}function savecases(g,b,f,d){if($(f).attr("disabled")){return}disable_save_button($(f));if(!isValidForm("#"+g)){enable_save_button($(f));return false}var e=false;if(d.id===undefined){e=true}d.custom_data=serialize_custom_fields(g);var c=new Backbone.Model();c.url="core/api/cases";c.save(d,{success:function(j){enable_save_button($(f));$("#"+b).modal("hide");$("#"+g).each(function(){this.reset()});var h=j.toJSON();add_recent_view(new BaseModel(h));if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){if(casesView&&casesView.collection){if(casesView.collection.get(h.id)){casesView.collection.get(h.id).set(new BaseModel(h))}else{casesView.collection.add(new BaseModel(h),{sort:false});casesView.collection.sort()}}if(App_Contacts.contactDetailView.model.get("type")=="COMPANY"){activate_timeline_tab();fill_company_related_contacts(App_Contacts.contactDetailView.model.id,"company-contacts");return}$.each(h.contacts,function(l,k){if(k.id==App_Contacts.contactDetailView.model.get("id")){add_entity_to_timeline(j);return false}})}else{if(Current_Route=="cases"){if(e==true){App_Cases.casesCollectionView.collection.add(j)}else{App_Cases.casesCollectionView.collection.remove(d);App_Cases.casesCollectionView.collection.add(j)}App_Cases.casesCollectionView.render(true)}else{App_Calendar.navigate("cases",{trigger:true})}}},error:function(j,h){enable_save_button($(f))}})}$(function(){$("#invoice-model-list > tr").live("click",function(b){b.preventDefault();var c=$(this).find(".data").attr("data");if(c){Backbone.history.navigate("invoice/"+c,{trigger:true})}});$("#charge-model-list > tr").live("click",function(b){b.preventDefault();var c=$(this).find(".data").attr("data");if(c){window.document.location="#getInvoiceDetails/"+c}})});var AGILE_COUPONS_JSON={},AGILE_COUPON_INVALID_MESSAGE="Coupon is either expired or invalid for the selected plan.";function showCouponCodeContainer(b){if(b){$("#content").find("#coupon_code_container").show()}b=(b)?"payment_selection_container":"payment_selection_container1";$("#"+b).remove()}function showCouponDiscountAmount(b,d){var c=$(".coupon_code_discount_amount",d);var e=b.cost;if(!e){return c.html("")}checkValidCoupon(b.coupon_code,function(g){var m=(!g)?{}:AGILE_COUPONS_JSON[b.coupon_code];
var k=$(".coupon_code_discount_amount",d);var l="0%";if(!m||!(m.percentOff||m.amountOff)){k.find("#total_cost_with_discount").html(e);return k.find("#coupon_code_discount_percent").html("$0 ("+l+")")}var h=m.amountOff;if(h){e=e-(h/100);l="$"+(h/100)}var j=m.percentOff;if(!h&&j){var f=e*(j/100);e=e-f;l="$"+(f.toFixed(2))+" ("+j+"%)"}k.find("#total_cost_with_discount").html(e.toFixed(2));k.find("#coupon_code_discount_percent").html(l)})}function getCouponJSON(b,d){if(!b){return false}var c='<img src="img/1-0.gif" height="20px" width="20px" />';$("#coupon_code_container form i").before(c);$.get("corea/subscription/coupon/"+b,{},function(e){$("#coupon_code_container form img").remove();if(!e.id){AGILE_COUPONS_JSON[b]="null"}else{AGILE_COUPONS_JSON[e.id]=e}if(d){d(b)}})}function checkValidCoupon(b,c){if(!b){return c(false)}if(AGILE_COUPONS_JSON[b]){return c(AGILE_COUPONS_JSON[b]!="null")}console.log(AGILE_COUPONS_JSON[b]);getCouponJSON(b,function(d){checkValidCoupon(d,c)})}function getCouponJSON(b,d){if(!b){return false}var c='<img src="img/1-0.gif" height="20px" width="20px" />';$("#coupon_code_container form i").before(c);$.getJSON("core/api/subscription/coupon/"+b,{},function(e){console.log(e);$("#coupon_code_container form img").remove();if(!e.id){AGILE_COUPONS_JSON[b]="null"}else{AGILE_COUPONS_JSON[e.id]=e}if(d){d(b)}})}function showCouponStatus(b){var c='<img src="img/1-0.gif" height="15px" width="15px" />';$("#check_valid_coupon").remove(c)}var _plan_restrictions={};$(function(){init_acl_restriction()});function init_acl_restriction(){_plan_restrictions={billing_restriction:_billing_restriction,plan:_billing_restriction.currentLimits,is_social_suite:[function(){return _plan_restrictions.plan.socialSuite},function(){return{message:"Please <a href='#subscribe'>upgrade</a> to Regular or Pro plan to use this feature."}}],is_email_gateway_allowed:[function(){return _plan_restrictions.plan.emailGateway},function(){return{message:"Please <a href='#subscribe'>upgrade</a> to Pro plan to use this feature"}}],is_sms_gateway_allowed:[function(){return _plan_restrictions.plan.smsgateway},function(){return{message:"Please <a href='#subscribe'>upgrade</a> to Pro or Regular plan"}}],is_ecommerce_sync_allowed:[function(){return _plan_restrictions.plan.ecommerceSync},function(){return{message:"Please <a href='#subscribe'>upgrade</a> to Pro or Regular plan"}}],is_accounting_sync_allowed:[function(){return _plan_restrictions.plan.accountingSync},function(){return{message:"Please <a href='#subscribe'>upgrade</a> to Pro or Regular plan"}}],is_ACL_allowed:[function(){return _plan_restrictions.plan.acl},function(){return{message:' Please <a href="#subscribe">upgrade</a> to Regular or Pro plan to use this feature. '}}],is_calling_widget:[function(){return _plan_restrictions.plan.callingWidget},function(){return{message:'Please <a href="#subscribe">upgrade</a> to Regular or Pro plan to use this feature. '}}],is_custom_widget:[function(){return _plan_restrictions.plan.customWidget},function(){return{message:'Please <a href="#subscribe">upgrade</a> to Regular or Pro plan to use this feature. '}}],online_appointment:[function(){return _plan_restrictions.plan.onlineAppointment},function(){return}],is_mobile_integration:[function(){return _plan_restrictions.plan.mobileIntegration},function(){}],is_google_sync:function(){return this.plan.googleSync},is_ecommerce_sync:function(){return this.plan.ecommerceSync},is_payment_sync:function(){return this.plan.paymentSync},is_activity_reports_enabled:[function(){return _plan_restrictions.plan.activityReports},function(){return{message:"Please <a href='#subscribe'>upgrade</a> <br/> to Pro plan"}}],is_cohort_reports_enabled:[function(){return _plan_restrictions.plan.cohortReports},function(){return{message:"Regular/Pro plan only"}}],process_widgets:function(e){var g=e.where({is_added:true});if(g&&g.length>=_plan_restrictions.plan.widgetsLimit){var d=e.where({is_added:false});for(var b=0;b<d.length;b++){d[b].set("allowedToAdd",false)}}else{if(g&&g.length==0){var d=e.where({allowedToAdd:false});for(var b=0;b<d.length;b++){d[b].set("allowedToAdd",true)}}}console.log(e);if(!this.is_calling_widget[0]()){var c=e.where({is_added:false,widget_type:"CALL"});if(c&&c.length){for(var b=0;b<c.length;b++){var f=c[b].get("name");if(f=="Twilio"||f=="Sip"){c[b].set("allowedToAdd",false)}}}}}};$("._upgrade").die().live("click",function(c){c.preventDefault();var d=$(this).attr("id");if(!d){return}var b=$("."+d);if(!b||b.length==0){return}$(b).show().delay(3000).hide(1)})}function getDomainUserFromDeserialize(b){var c={};c.menu_scopes={};c.user_scopes={};c.menu_scopes.checked=true;c.menu_scopes.disabled=false;c.user_scopes.checked=true;c.user_scopes.disabled=false;if(!_plan_restrictions.is_ACL_allowed[0]()){c.menu_scopes.disabled=true;c.user_scopes.disabled=true;return c}if(b&&b.id){c.menu_scopes.checked=false;c.menu_scopes.disabled=false;c.user_scopes.checked=false;c.user_scopes.disabled=false}if(b!=null&&b.id&&b.is_admin){c.user_scopes.disabled=true}console.log(b);console.log(c);return c}function getSubscription(f,e){if(!e){return null}if(!f){return null}if(typeof f!="object"){f=JSON.parse(f)}var g=f.subscriptions;if(!g){if(!f.subscription){return null}else{return f.subscription}return null}var c=false;if(e.subscription_id){c=true}for(var b=0;b<g.data.length;b++){var d=g.data[b];if(c){if(d.id!=e.subscription_id){continue}return d}else{if(d.plan.id==e.plan_id){return d}}}return null}function getSubscriptionWithAmount(f,e){var c=getSubscription(f,e);if(!c){return null}if(!c.plan){return c}var b=c.plan.amount/100;var d=c.quantity;c.total=b*d;return c}function getActiveCard(b){if(!b){return null}if(typeof b!="object"){b=JSON.parse(b)}return b.cards.data[0]}var PLANS_COSTS_JSON={};var PLANS_DISCOUNTS_JSON_NEW={};var PLANS_DISCOUNTS_JSON={};function config_version_2_plans(){PLANS_COSTS_JSON.starter="24.99";PLANS_COSTS_JSON.regular="49.99";PLANS_COSTS_JSON.pro="119.99";PLANS_DISCOUNTS_JSON.monthly="0";PLANS_DISCOUNTS_JSON.yearly="20";PLANS_DISCOUNTS_JSON.biennial="40";PLANS_DISCOUNTS_JSON_NEW.starter={};PLANS_DISCOUNTS_JSON_NEW.starter.monthly="0";PLANS_DISCOUNTS_JSON_NEW.starter.yearly=PLANS_DISCOUNTS_JSON.yearly;PLANS_DISCOUNTS_JSON_NEW.starter.biennial=PLANS_DISCOUNTS_JSON.biennial;PLANS_DISCOUNTS_JSON_NEW.regular={};PLANS_DISCOUNTS_JSON_NEW.regular.monthly="0";PLANS_DISCOUNTS_JSON_NEW.regular.yearly=PLANS_DISCOUNTS_JSON.yearly;PLANS_DISCOUNTS_JSON_NEW.regular.biennial=PLANS_DISCOUNTS_JSON.biennial;PLANS_DISCOUNTS_JSON_NEW.pro={};PLANS_DISCOUNTS_JSON_NEW.pro.monthly="0";PLANS_DISCOUNTS_JSON_NEW.pro.yearly="16.66";PLANS_DISCOUNTS_JSON_NEW.pro.biennial="33.336";if(_billing_restriction&&_billing_restriction.currentLimits&&_billing_restriction.currentLimits.plan){if(_billing_restriction.currentLimits.plan.version=="v1"){getLegacyPlanDetails(_billing_restriction.currentLimits.plan.plan_type)}}}var LEGACY_PLAN_COSTS_JSON={};LEGACY_PLAN_COSTS_JSON.starter="14.99";LEGACY_PLAN_COSTS_JSON.regular="49.99";LEGACY_PLAN_COSTS_JSON.pro="79.99";var LEGACY_PLANS_DISCOUNTS_JSON={};LEGACY_PLANS_DISCOUNTS_JSON.monthly="0";LEGACY_PLANS_DISCOUNTS_JSON.yearly="20";LEGACY_PLANS_DISCOUNTS_JSON.biennial="40";var LEGACY_PLANS_DISCOUNTS_JSON_NEW={};LEGACY_PLANS_DISCOUNTS_JSON_NEW.starter={};LEGACY_PLANS_DISCOUNTS_JSON_NEW.starter.monthly="0";LEGACY_PLANS_DISCOUNTS_JSON_NEW.starter.yearly="33.355";LEGACY_PLANS_DISCOUNTS_JSON_NEW.starter.biennial="40";LEGACY_PLANS_DISCOUNTS_JSON_NEW.regular={};LEGACY_PLANS_DISCOUNTS_JSON_NEW.regular.monthly="0";LEGACY_PLANS_DISCOUNTS_JSON_NEW.regular.yearly="20";LEGACY_PLANS_DISCOUNTS_JSON_NEW.regular.biennial="40";LEGACY_PLANS_DISCOUNTS_JSON_NEW.pro={};LEGACY_PLANS_DISCOUNTS_JSON_NEW.pro.monthly="0";LEGACY_PLANS_DISCOUNTS_JSON_NEW.pro.yearly="18.75";LEGACY_PLANS_DISCOUNTS_JSON_NEW.pro.biennial="40";function getLegacyPlanDetails(b){var c=b.split("_")[0].toLowerCase();PLANS_COSTS_JSON[c]=LEGACY_PLAN_COSTS_JSON[c];PLANS_DISCOUNTS_JSON_NEW[c]=LEGACY_PLANS_DISCOUNTS_JSON_NEW[c]}function is_new_signup_payment(){return IS_NEW_USER&&_plan_on_signup}function card_expiry(e){var g={};g[1]="01 (Jan)";g[2]="02 (Feb)";g[3]="03 (Mar)";g[4]="04 (Apr)";g[5]="05 (May)";g[6]="06 (Jun)";g[7]="07 (Jul)";g[8]="08 (Aug)";g[9]="09 (Sep)";g[10]="10 (Oct)";g[11]="11 (Nov)";g[12]="12 (Dec)";var b=$("#exp_month",e),f=new Date().getMonth()+1;for(var c=1;c<=12;c++){b.append($("<option value='"+c+"' "+(f===c?"selected":"")+">"+g[c]+"</option>"))}var b=$("#exp_year",e),d=new Date().getFullYear();for(var c=0;c<22;c++){b.append($("<option value='"+(c+d)+"' "+(c===0?"selected":"")+">"+(c+d)+"</option>"))}}function deserialize_card_details(c,b){$.each(c,function(e,f){var d;if(e.indexOf("name")!=-1){d=b.find('*[name="name"]')}else{if(e=="addressCountry"){d=b.find('*[name="address_country"]')}else{if(e=="addressState"){d=b.find('*[name="address_state"]')}else{if(e=="addressState"){d=b.find('*[name="address_state"]')}else{if(e=="addressLine1"){d=b.find('*[name="address_line1"]')}else{if(e=="addressLine2"){d=b.find('*[name="address_line2"]')}else{if(e=="addressZip"){d=b.find('*[name="address_zip"]')}}}}}}}if(d&&d.length>0){tag=d[0].tagName.toLowerCase();if(tag=="input"){$(d).val(f)}else{if(tag=="select"&&e=="addressCountry"){$("#country").val(f).prop("selected",true).trigger("change");$("#state").val(c.addressState).prop("selected",true).trigger("change")}}}})}var plan_json={};var INTERVALS=["monthly","yearly","biennial"];var PLAN_DETAILS={getPlanPrice:function(b){return PLANS_COSTS_JSON[b]},getDiscountedPrice:function(c,b){var d=this.getPlanPrice(c);var e=PLANS_DISCOUNTS_JSON_NEW[c][b];return d*(100-e)/100},getDiscount:function(c,b){return PLANS_DISCOUNTS_JSON_NEW[c][b]}};var user_existing_plan_name="";var USER_CREDIRCARD_DETAILS={};var USER_BILLING_PREFS;var USER_DETAILS={getCurrentPlanName:function(b){if(b.plan.plan_type=="FREE"){return"free"}return b.plan.plan_type},getDomainName:function(b){if(b.plan.plan_type=="FREE"){return"free"}return b.domain_name
},getCurrentPlanId:function(b){if(b.plan.plan_type=="FREE"){return"free"}return b.plan.plan_id},getPlanType:function(b){if(b.plan.plan_type=="FREE"){return"free"}if(b.plan.plan_type){if(b.plan.plan_type.split("_").length==1){return b.plan.plan_type}return b.plan.plan_type.split("_")[0]}return"LITE"},getPlanInterval:function(b){if(!b||!b.plan.plan_type||b.plan.plan_type=="FREE"){return"MONTHLY"}var c=b.plan.plan_type;if(c){return c.split("_")[1]}},getQuantity:function(b){if(!b||!b.plan||b.plan.plan_type=="FREE"){return 2}return b.plan.quantity}};function load_slider(b){$("#users_select_slider",b).slider({from:1,to:20,step:1,skin:"plastic",onstatechange:function(c){$("#users_quantity",b).text(c);price=update_price();$("#users_total_cost",b).text((c*price).toFixed(2))}})}function setCost(b){return $("#users_total_cost").text(($("#users_quantity").text()*b).toFixed(2))}function update_price(){var b=$("[name='pro_vs_lite']:checked").val();return $("#"+b+"_plan_price").text()}function setPriceTemplete(c,d){var b="yearly",e="pro",f=1;if(c!="free"&&c!="super"){e=USER_DETAILS.getPlanType(USER_BILLING_PREFS);b=USER_DETAILS.getPlanInterval(USER_BILLING_PREFS);f=USER_DETAILS.getQuantity(USER_BILLING_PREFS);e=e.toLowerCase();b=b.toLowerCase()}if(IS_NEW_USER&&_plan_on_signup){f=_plan_on_signup.quantity}$(d).find("#"+e+"_plan_select").attr("checked","checked");$(d).find("."+b).addClass("plan-select");$(d).find("#users_select_slider").attr("value",f);return d}function setPlan(c){try{var b="yearly",e="regular";if(IS_NEW_USER&&_plan_on_signup){e=_plan_on_signup.plan_type.toLowerCase();b="MONTHLY"}else{if(c!="free"&&c!="super"){e=USER_DETAILS.getPlanType(USER_BILLING_PREFS);b=USER_DETAILS.getPlanInterval(USER_BILLING_PREFS);e=e.toLowerCase();b=b.toLowerCase()}}$("input[value='"+e+"']").trigger("click");$("ul.tagsli a."+b).trigger("click")}catch(d){console.log(d)}}$(function(){$(".plan-collection-in").die().live("click",function(d){$(this).find("[name='pro_vs_lite']").attr("checked","checked");var b="";$(".plan-collection-in").each(function(e,f){b=$(f).find("#plan_name").text().toLowerCase();$(f).find("span.plan-collection-icon").removeClass(b+"_selected")});b=$(this).find("#plan_name").text().toLowerCase();$(this).find("span.plan-collection-icon").addClass(b+"_selected");var c=$(this).find("[name='pro_vs_lite']").val();setCost(update_price())});$("ul.tagsli a").die().live("click",function(g){g.preventDefault();$("ul.tagsli a").removeClass("plan-select");$(this).addClass("plan-select");var f=$(this).attr("class");f=f.replace("plan-select","");f=f.trim();for(var c in PLANS_COSTS_JSON){var b=PLANS_COSTS_JSON[c];var h=PLAN_DETAILS.getDiscount(c,f);var d=b-((h/100)*b);$("#"+c+"_plan_price").html(d.toFixed(2))}setCost(update_price())});$("#purchase-plan").die().live("click",function(t){t.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");var l=$("#users_quantity").text();var s=$("#users_total_cost").text();var d=$("input[name='pro_vs_lite']:checked");var f=$(d).val();var g=$(d).attr("version");var c="",m="";if(g==undefined){g="v2"}if(!f){alert("Please select a plan to proceed");$(this).removeAttr("disabled");return false}if($(".monthly").hasClass("plan-select")){cycle="Monthly";m=1;c=PLAN_DETAILS.getDiscount(f,"monthly")}else{if($(".yearly").hasClass("plan-select")){cycle="Yearly";m=12;c=PLAN_DETAILS.getDiscount(f,"yearly")}else{if($(".biennial").hasClass("plan-select")){cycle="biennial";m=24;c=PLAN_DETAILS.getDiscount(f,"biennial")}}}var q=[];var h=PLANS_COSTS_JSON[f];for(var u in PLANS_DISCOUNTS_JSON_NEW[f]){var b=PLAN_DETAILS.getDiscount(f,u);var p=PLAN_DETAILS.getDiscountedPrice(f,u);q[u]=p.toFixed(2)}user_existing_plan_name=USER_DETAILS.getCurrentPlanId(USER_BILLING_PREFS);var v=h+"-"+m;if(v.toLowerCase()+"-"+l==user_existing_plan_name+"-"+USER_DETAILS.getQuantity(USER_BILLING_PREFS)){alert("Please change your plan to proceed");$(this).removeAttr("disabled");return false}var n=new Date();plan_json.date=n.setMonth(n.getMonth()+m)/1000;plan_json.new_signup=is_new_signup_payment();plan_json.price=update_price();plan_json.cost=(s*m).toFixed(2);plan_json.months=m;plan_json.plan=f;plan_json.version=g;plan_json.plan_type=f.toUpperCase()+"_"+cycle.toUpperCase();plan_json.cycle=cycle;delete plan_json.coupon_code;var j=$("#coupon_code").val();if(j){plan_json.coupon_code=j}if(cycle!="biennial"){plan_json.yearly_discount=([s*12]-[q.yearly*l*12]).toFixed(2);plan_json.bi_yearly_discount=([s*24]-[q.biennial*l*24]).toFixed(2)}if((USER_DETAILS.getPlanType(USER_BILLING_PREFS)+"-"+USER_DETAILS.getQuantity(USER_BILLING_PREFS)+"-"+USER_DETAILS.getPlanInterval(USER_BILLING_PREFS))==(f.toUpperCase()+"-"+l+"-"+cycle.toUpperCase())){alert("Please change the plan to proceed");$(this).removeAttr("disabled");return false}var o=(m>1)?PLANS_COSTS_JSON[f]+"-"+m:PLANS_COSTS_JSON[f];plan_json.plan_id=o;plan_json.discount=c;plan_json.quantity=l;plan_json.current_plan=USER_DETAILS.getCurrentPlanName(USER_BILLING_PREFS);plan_json.domain_name=USER_DETAILS.getDomainName(USER_BILLING_PREFS);console.log(JSON.stringify(plan_json));if(!$.isEmptyObject(USER_CREDIRCARD_DETAILS)){plan_json.customer=JSON.parse(USER_CREDIRCARD_DETAILS)}console.log(plan_json);var k=$(this);$.get("/core/api/subscription/plan-limits?plan="+plan_json.plan_type,function(e){console.log(e);k.removeAttr("disabled");if(e&&e.error){alert("test");$("#proceed-error").html(e.message);showModalConfirmation("Limits exceeded",getTemplate("subscribe-downgrade",e),function(){alert("success")},function(){alert("fail")},undefined,undefined,"Ok")}else{Backbone.history.navigate("purchase-plan",{trigger:true})}})});$("#check_valid_coupon").die().live("click",function(){var d=$("#coupon_code").val();if(!d){$("#coupon_code_container").find(".error").html("Invalid Coupon");return false}$("#coupon_code_container i").removeAttr("class");var b="icon-",c=$(this);checkValidCoupon(d,function(e){b+=(e)?"ok":"remove";$("#coupon_code_container i").removeAttr("class").addClass(b)})})});var ACCOUNT_STATS;function set_up_account_stats(c,d){var b=new Base_Model_View({url:"core/api/namespace-stats",template:"account-stats",postRenderCallback:function(e){ACCOUNT_STATS=b.model.toJSON();if(d&&typeof(d)==="function"){d(ACCOUNT_STATS)}}});$("#account-stats",c).html(b.render(true).el)}$(function(){ACCOUNT_DELETE_REASON_JSON=undefined;$("#confirm-delete-account").die().live("click",function(b){b.preventDefault();$(".modal-body").html(getRandomLoadingImg());$.ajax({type:"DELETE",url:"core/api/delete/account",success:function(){add_account_canceled_info(ACCOUNT_DELETE_REASON_JSON,function(c){$("#warning-deletion-feedback").modal("hide");$("#content").html(getRandomLoadingImg());window.location.href=window.location.href.split("#")[0]+"login"})}})});$("#cancel-account").die().live("click",function(c){c.preventDefault();$("#warning-deletion-feedback").remove();var b=getTemplate("warning-feedback",{});$("#content").append(b);$("#warning-deletion-feedback").modal("show");$("#warning-deletion-feedback").on("hidden",function(){ACCOUNT_DELETE_REASON_JSON=undefined});$("#warning-feedback-save").die().live("click",function(h){h.preventDefault();var g=$("#cancelation-feedback-form");if(!isValidForm(g)){return}var f=$("input[name=cancellation_reason]:checked");ACCOUNT_DELETE_REASON_JSON={};ACCOUNT_DELETE_REASON_JSON.reason=$(f).val();ACCOUNT_DELETE_REASON_JSON.reason_info=$("#account_delete_reason").val();$(".modal-body").html(getRandomLoadingImg());var d="";if(ACCOUNT_STATS){d=$(getTemplate("warning",ACCOUNT_STATS))}else{set_up_account_stats(b,function(e){d=$(getTemplate("warning",e));$(".modal-body").css("padding",0).html($(".modal-body",$(d)));$(".modal-footer").html($(".modal-footer",$(d)).html())});return}$(".modal-body").css("padding",0).html($(".modal-body",$(d)));$(".modal-footer").html($(".modal-footer",$(d)).html())})});$("#cancel-account-request").die().live("click",function(c){c.preventDefault();$("#send-cancellation").remove();var b=getTemplate("send-cancellation-request",{});$("#content").append(b);$("#send-cancellation").modal("show");$("#send-cancellation").on("hidden",function(){$("#account_cancel_reason").val()});$("#send-delete-request").die().live("click",function(j){j.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm($("#cancelation-request-form"))){return}disable_send_button($(this));var f=serializeForm("cancelation-request-form");var h=f.account_cancel_reason;var g=h.replace(/\r\n/g,"<br/>");var d="core/api/emails/send-email?from="+encodeURIComponent(CURRENT_DOMAIN_USER.email)+"&to="+encodeURIComponent("care@agilecrm.com")+"&subject="+encodeURIComponent("Cancellation Request")+"&body="+encodeURIComponent(g);$.post(d,function(){$("#cancelation-request-form").each(function(){this.reset()});add_tag_our_domain("Cancellation Request");var e={};e.subject="Cancellation Request";e.description=h;agile_addNote(e,"",CURRENT_DOMAIN_USER.email);$.ajax({type:"DELETE",url:"core/api/subscription/delete/account",success:function(){enable_send_button($("#send-delete-request"));$("#send-cancellation").modal("hide");showNotyPopUp("information","Cancellation request sent. You should hear back from us in one working day.","top",3000)}})})})})});$(function(){$("#show-filter-button").live("click",function(b){b.preventDefault();if($("#filter_options").is(":visible")){$("#filter_options").hide()}else{showFilters()}});$("#deals-filter-validate").live("click",function(b){b.preventDefault();filterDeals($(this))});$("#filter_options .filter_type").live("change",function(f){var b=$(this).closest(".control-group").attr("id");if($(this).val()=="equals"){$("#"+b+" .equals").show();$("#"+b+" .between").hide()}else{var g="You can only use one 'between' condition for filtering. Press Ok to change other conditions to equal.";var d=$("#filter_options").find('select option[value="between"]:selected').length;var c=true;if(d>1){c=false}if(c){$("#filter_options .filter_type").val("equal");$(this).val("between");$("#sort_field").val($(this).attr("data"));
$("#filter_options .between").hide();$("#filter_options .equals").show();$("#"+b+" .equals").hide();$("#"+b+" .between").show()}else{alert("Sorry. You can't have multiple 'Between' conditions.");$(this).val("equals")}}});$("#clear-deal-filters").live("click",function(b){$("#dealsFilterForm input").val("");$("#dealsFilterForm select").filter(":visible").val("");$("#dealsFilterForm select.filter_type").val("equals");$("#filter_options .between").hide();$("#filter_options .equals").show();$("#dealsFilterForm #archived").val("false");$("#filter_options").find(".control-group").each(function(c){if($(this).find(".controls").height()>0){$(this).find("a.changeIcon").trigger("click")}});eraseCookie("deal-filters");$("#show-filter-button").removeClass("btn-primary")});$("#filter_options a.changeIcon").live("click",function(b){$(this).find("i").toggleClass("icon-plus icon-minus")})});function setupDealFilters(c){$("#deal-list-filters").html(getTemplate("deal-filter"));var b=$("#filter_options");populateUsers("owners-list-filters",b,undefined,undefined,function(e){$("#deals-filter").find("#owners-list-filters").html(e);if(readCookie("deal-filters")){var d=$.parseJSON(readCookie("deal-filters"))}$("#owners-list-filters",$("#dealsFilterForm")).closest("div").find(".loading-img").hide();$("#deal_owner_change_modal").find("#owners-list-bulk").html(e);$("#owners-list-bulk",$("#deal_owner_change_modal")).closest("div").find(".loading").hide();populateTracks(b,undefined,undefined,function(g){$("#pipeline").val("");deal_bulk_actions.fillPipelineList(g);$("#owners-list-filters").val("");if(readCookie("deal-filters")){var f=$.parseJSON(readCookie("deal-filters"));$.each(f,function(h,j){if(j){if($('[name="'+h+'"]').closest(".controls").height()==0&&h.indexOf("_filter")<0){$('[name="'+h+'"]').closest(".controls").addClass("in");$('[name="'+h+'"]').closest(".control-group").find("a.changeIcon").find("i").toggleClass("icon-plus icon-minus")}if(h=="pipeline_id"){populateMilestones(b,undefined,f.pipeline_id,undefined,function(k){$("#milestone",b).html(k);$("#milestone",b).closest("div").find(".loading-img").hide();$("#milestone",b).val(f.milestone)})}$("#"+h).val(j);if(h=="pipeline_id"){$("#pipeline").val(j)}else{if(h=="owner_id"){$("#owners-list-filters").val(j)}else{if($("#"+h).hasClass("date")){$("#"+h).val(new Date(j*1000).format("mm/dd/yyyy"))}}}if(h.indexOf("_filter")>0){$("#"+h).trigger("change")}}});updateFilterColor()}$("#filter_options .date").datepicker({format:"mm/dd/yyyy"});if(!readCookie("agile_deal_view")){$("#pipeline").closest(".control-group").hide();$("#milestone").closest(".control-group").hide()}$("#filter_options select").find('option[value=""]').text("Any")})})}function updateFilterColor(){var c=0;var b=$.parseJSON(readCookie("deal-filters"));if(b.owner_id.length>0){c++}if(b.value_filter=="equals"){if(b.value.length>0){c++}}else{if(b.value_start.length>0||b.value_end.length>0){c++}}if(readCookie("agile_deal_view")){if(b.pipeline_id.length>0){c++}}if(b.archived!="false"){c++}if(c>0){$("#show-filter-button").addClass("btn-primary")}}function showFilters(){var b=$("#filter_options");b.show()}function filterDeals(c){if(c.attr("disabled")){return}c.attr("disabled","disabled");$("#filter_options").hide();var d="dealsFilterForm";var b=serializeForm(d);if(readCookie("agile_deal_track")&&b.pipeline_id.length>1&&readCookie("agile_deal_track")!=b.pipeline_id){createCookie("agile_deal_track",b.pipeline_id)}createCookie("deal-filters",JSON.stringify(b));c.removeAttr("disabled");App_Deals.deals()}function getDealFilters(){var c="";if(readCookie("deal-filters")){c=readCookie("deal-filters");if(!readCookie("agile_deal_view")){var b=$.parseJSON(c);if(b.pipeline_id.length==0){b.pipeline_id=readCookie("agile_deal_track")}b.milestone="";return JSON.stringify(b)}}return c}$(function(){$(".deals-list-view").die().live("click",function(b){b.preventDefault();createCookie("agile_deal_view","list_view");App_Deals.deals()});$("#opportunity-track-list-model-list a.pipeline").live("click",function(d){d.preventDefault();createCookie("agile_deal_track",$(this).attr("id"));if(readCookie("deal-filters")){var c=$.parseJSON(readCookie("deal-filters"));var b=$(this).attr("id");if(b=="1"){c.pipeline_id=""}else{c.pipeline_id=$(this).attr("id")}createCookie("deal-filters",JSON.stringify(c))}App_Deals.deals()});$(".deals-pipelined-view").die().live("click",function(b){b.preventDefault();eraseCookie("agile_deal_view");App_Deals.deals()});$(".deals-export-csv").die().live("click",function(b){b.preventDefault();console.log("Exporting ...");var c=$(getTemplate("deals-export-csv-modal"),{});c.modal("show");$("#deals-export-csv-confirm").die().live("click",function(d){d.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");$save_info=$('<img src="img/1-0.gif" height="18px" width="18px" style="opacity:0.5;"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>Email will be sent shortly.</i></small></span>');$(this).parent(".modal-footer").find(".deals-export-csv-message").append($save_info);$save_info.show();$.ajax({url:"/core/api/opportunity/export",type:"GET",success:function(){console.log("Exported!");c.modal("hide")}})})});$(".add-pipeline").die().live("click",function(b){$("#pipelineForm input").val("");$("#pipelineForm input#milestones").val("New,Prospect,Proposal,Won,Lost");$("#pipelineModal").find(".save-status").html("")});$(".pipeline-edit").die().live("click",function(c){var d=$(this).attr("id");var b=App_Admin_Settings.pipelineGridView.collection.get(d).toJSON();deserializeForm(b,$("#pipelineForm"))});$(".pipeline-delete").die().live("click",function(c){c.preventDefault();var d=$(this).attr("id");var b=$(this).attr("data");$("#track-name").text(b);$("#pipeline-delete-confirm").die().live("click",function(g){g.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");var f=$(this);$save_info=$('<img src="img/1-0.gif" height="18px" width="18px" style="opacity:0.5;"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>Deleting track.</i></small></span>');$(this).parent(".modal-footer").find(".pipeline-delete-message").append($save_info);$save_info.show();$.ajax({url:"/core/api/milestone/pipelines/"+d,type:"DELETE",success:function(){console.log("Deleted!");$("#pipeline-delete-modal").modal("hide");if(readCookie("agile_deal_track")&&readCookie("agile_deal_track")==d){eraseCookie("agile_deal_track")}if(readCookie("deal-filters")){var e=$.parseJSON(readCookie("deal-filters"));if(e.pipeline_id=d){eraseCookie("deal-filters")}}App_Admin_Settings.milestones()},error:function(h,e,j){console.log(h);$("#pipeline-delete-modal").find(".pipeline-delete-message").text(h.responseText);f.removeAttr("disabled")}})})});$(".milestone-delete").die().live("click",function(b){b.preventDefault();if(!confirm("Are you sure you want to delete ?")){return}$(this).closest("tr").css("display","none");fill_ordered_milestone($(this).closest("form").attr("id"))});$(".show_milestone_field").die().live("click",function(c){c.preventDefault();var b=$(this).closest("form");console.log("New Milestone to - ",b.attr("id"));$(this).closest("div").css("display","none");b.find(".show_field").css("display","block");b.find(".add_new_milestone").focus()});$(".add_milestone").die().live("click",function(f){f.preventDefault();var c=$(this).closest("form");var b=c.find(".add_new_milestone").val().trim();if(!b||b.length<=0||!(/^[a-zA-Z0-9-_ ]*$/).test(b)){$("#milestone-error-modal").modal("show");return}c.find(".show_field").css("display","none");c.find(".show_milestone_field").closest("div").css("display","inline-block");if(!b||b.length<=0||(/^\s*$/).test(b)){return}if(b!=""){f.preventDefault();c.find(".add_new_milestone").val("");var d=c.find("tbody");var g=true;d.find("tr").each(function(e,h){if($(h).is(":visible")&&h.getAttribute("data").toLowerCase()==b.toLowerCase()){g=false;return false}});if(g){d.append("<tr data='"+b+"' style='display: table-row;'><td><div class='p-l-sm' style='display:inline-block;vertical-align:top;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;width:80%'>"+b+"</div></td><td><div class='m-b-n-xs' style='display:none;'><a class='text-l-none-hover c-p'><i title='Drag' class='icon-move'></i></a><a class='milestone-delete' style='cursor: pointer;margin-left:10px; text-decoration: none;' data-toggle='modal' role='button' href='#'><i title='Delete Milestone' class='task-action icon icon-trash'></i></a></div></td></tr>");fill_ordered_milestone(c.attr("id"))}}});$(".add_new_milestone").die().live("keypress",function(c){if(c.keyCode==13){var b=$(this).closest("form");b.find(".add_milestone").click()}});$(".save-pipelines").die().live("click",function(b){b.preventDefault();$("#admin-settings-milestones-model-list").find("form").each(function(d){var e=serializeForm($(this).attr("id"));console.log("---------",e);var c=new Backbone.Model();c.url="/core/api/milestone";c.save(e,{success:function(g,f){App_Admin_Settings.milestones()},error:function(g,f){console.log(f)}})})});$("#pipeline_validate").die().live("click",function(d){d.preventDefault();if($(this).attr("disabled")){return}disable_save_button($(this));if(!isValidForm("#pipelineForm")){enable_save_button($(this));return false}var c=serializeForm("pipelineForm");console.log(c);var b=new Backbone.Model();b.url="/core/api/milestone/pipelines";b.save(c,{success:function(f,e){enable_save_button($(this));$("#pipelineModal").modal("hide");App_Admin_Settings.milestones()},error:function(f,e){console.log(e,f);$("#pipelineModal").find(".save-status").html('<span style="color:red;">'+e.responseText+"</span>");setTimeout(function(){$("#pipelineModal").find(".save-status").html("")},5000);enable_save_button($("#pipeline_validate"))}})})});function setup_deals_in_milestones(b){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$("ul.milestones").sortable({connectWith:"ul",cursor:"move",containment:"#"+b,scroll:false,change:function(d,e){var c=$("#"+b+" > div").width();
var f=$("#"+b+" > div").scrollLeft();if(d.pageX>(c*0.9)){$("#"+b+" > div").scrollLeft(f+10)}else{if(d.pageX<(c*0.1)){$("#"+b+" > div").scrollLeft(f-15)}}},update:function(f,g){console.log(">>>>>>>>>>>>>>>>>> deals id");console.log(g);console.log(g.item[0]);console.log(g.item[0].id);var j=g.item[0].children[0].id;console.log("paging...",j);var e=$("#"+j).attr("data");console.log("old...",e);var h=DEALS_LIST_COLLECTION.collection.where({heading:e});if(!h){return}var d=h[0].get("dealCollection").get(j);var c=($("#"+j).closest("ul").attr("milestone")).trim();console.log("new...",c);update_milestone(d,j,c,e);$("#"+j).attr("data",c)}})})}function update_milestone(f,h,c,d){var g=f.toJSON();console.log(g);g.milestone=c;var b=[];$.each(g.notes,function(j,k){b.push(k.id)});console.log(b);g.notes=b;if(g.note_description){delete g.note_description}if(!g.close_date||g.close_date==0){g.close_date=null}g.owner_id=g.owner.id;var e=new Backbone.Model();e.url="/core/api/opportunity";e.save(g,{success:function(k,j){console.log("moved deal----",k);update_deal_collection(k.toJSON(),h,c,d)}})}function update_deal_collection(d,g,b,c){var f=DEALS_LIST_COLLECTION.collection.where({heading:c});if(!f){return}try{$("#"+b.replace(/ +/g,"")+"_count").text(parseInt($("#"+b.replace(/ +/g,"")+"_count").text())+1);$("#"+c.replace(/ +/g,"")+"_count").text(parseInt($("#"+c.replace(/ +/g,"")+"_count").text())-1)}catch(e){console.log(e)}f[0].get("dealCollection").remove(f[0].get("dealCollection").get(g));f=DEALS_LIST_COLLECTION.collection.where({heading:b});if(!f){return}f[0].get("dealCollection").add(copyCursor(f,d),{silent:true})}function setup_milestones(b){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(b).find("tbody").each(function(c){var d=$(this).closest("form").find('input[name="id"]').val();$(this).sortable({containment:"#milestone-values-"+d,items:"tr",helper:function(h,f){var g=f.children();var j=f.clone();j.children().each(function(e){$(this).width(g.eq(e).width());$(this).css("background","#f5f5f5");$(this).css("border-bottom","1px solid #ddd")});return j},forceHelperSize:true,placeholder:"<tr><td></td></tr>",forcePlaceholderSize:true,handle:".icon-move",cursor:"move",tolerance:"intersect",update:function(e,f){console.log($(f.item).attr("data"));fill_ordered_milestone($(f.item).closest("form").attr("id"))}})})})}function capitalize_string(b){b=b.trim().replace(/\b[a-z]/g,function(c){return c.toUpperCase()});return b}function fill_ordered_milestone(c){var b;$("#"+c).find("tbody").find("tr").each(function(d,e){if($(e).is(":visible")){if(b!=undefined){b=b+","+capitalize_string(($(e).attr("data")).toString())}else{b=capitalize_string(($(e).attr("data")).toString())}}});if(b&&b.charAt((b.length)-1)==","){b=b.slice(0,-1)}$("#"+c).find('input[name="milestones"]').val(b);$("#admin-settings-milestones-model-list").find("form").each(function(e){var f=serializeForm($(this).attr("id"));console.log("---------",f);App_Admin_Settings.pipelineGridView.collection.get(f.id).set("milestones",f.milestones,{silent:true});var d=new Backbone.Model();d.url="/core/api/milestone";d.save(f)})}$(function(){$("#opportunities-model-list > tr").live("mouseenter",function(){var e=$(this).find(".data").attr("data");var c=App_Deals.opportunityCollectionView.collection.get(e);var d=getTemplate("opportunity-detail-popover",c.toJSON());$(this).attr({rel:"popover","data-placement":"right","data-original-title":c.toJSON().name,"data-content":d});$("#opportunities-model-list > tr:last").attr({rel:"popover","data-placement":"top","data-original-title":c.toJSON().name,"data-content":d});$(this).popover("show")});$("#opportunities-model-list > tr").live("mouseleave",function(){$(this).popover("hide")});$("#opportunities-model-list > tr, .hide-popover").live("click",function(){$(this).closest("tr").popover("hide")});$("#close-deal").live("click",function(c){c.preventDefault();window.history.back()});$("#deal-milestone-regular").live("click",function(c){c.preventDefault();eraseCookie("deal-milestone-view");App_Deals.deals()});$("#deal-milestone-compact").live("click",function(c){c.preventDefault();createCookie("deal-milestone-view","compact");App_Deals.deals()});$("#deal-milestone-fit").live("click",function(c){c.preventDefault();createCookie("deal-milestone-view","fit");App_Deals.deals()});if(readCookie("deal-filters")){var b=$.parseJSON(readCookie("deal-filters"));if(!b.archived){b.archived="false";createCookie("deal-filters",JSON.stringify(b))}}else{var b={owner_id:"",pipeline_id:"",milestone:"",value_filter:"equals",value:"",value_start:"",value_end:"",archived:"false","":false,contact_ids:[]};b.archived="false";createCookie("deal-filters",JSON.stringify(b))}});function populateUsers(h,d,e,c,g){var b="<option value='{{id}}'>{{name}}</option>";fillSelect(h,"/core/api/users","domainUser",function f(){if(e){if(e[c]){$("#"+h,d).find("option[value="+e[c].id+"]").attr("selected","selected")}}else{$("#"+h,d).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected")}if(g&&typeof(g)==="function"){g($("#"+h).html())}},b)}function populateTrackMilestones(c,f,d,g,e){var b=new Base_Collection_View({url:"/core/api/milestone/pipelines"});b.collection.fetch({success:function(l){var h=l.toJSON();var j='<option value="">Select...</option>';console.log(h);if(h.length==1){var k=h[0];$.each(k.milestones.split(","),function(m,n){if(d&&k.id==d.pipeline_id&&n==d.milestone){j+='<option value="'+k.id+"_"+n+'" selected="selected">'+n+"</option>"}else{j+='<option value="'+k.id+"_"+n+'">'+n+"</option>"}});$("#pipeline_milestone",c).closest(".control-group").find("label b").text("Milestone")}else{$.each(h,function(m,n){console.log(n.milestones,d);var o=[];j+='<optgroup label="'+n.name+'">';$.each(n.milestones.split(","),function(p,q){o.push($.trim(this));if(d&&n.id==d.pipeline_id&&q==d.milestone){j+='<option value="'+n.id+"_"+q+'" selected="selected">'+n.name+" - "+q+"</option>"}else{j+='<option value="'+n.id+"_"+q+'">'+n.name+" - "+q+"</option>"}});j+="</optgroup>"});$("#pipeline_milestone",c).closest(".control-group").find("label b").text("Track & Milestone")}$("#pipeline_milestone",c).html(j);console.log("adding");$("#pipeline_milestone",c).closest("div").find(".loading-img").hide();if(g&&typeof(g)==="function"){g(h)}}})}function populateTracks(c,f,d,g,e){var b=new Base_Collection_View({url:"/core/api/milestone/pipelines"});b.collection.fetch({success:function(k){var h=k.toJSON();var j='<option value="">Select..</option>';console.log(h);if(h.length==1){j+='<option value="'+h[0].id+'" selected="selected">'+h[0].name+"</option>"}else{$.each(h,function(l,m){console.log(m.milestones,d);if(!m.name){m.name="Default"}if(d&&m.id==d.pipeline_id){j+='<option value="'+m.id+'" selected="selected">'+m.name+"</option>"}else{j+='<option value="'+m.id+'">'+m.name+"</option>"}})}$("#pipeline",c).html(j);console.log("adding");$("#pipeline",c).closest("div").find(".loading-img").hide();if(h.length==1){$("#pipeline",c).closest("div.control-group").hide();$("#milestone",c).closest("div.control-group").css("margin-left","0px");$("#dealsFilterForm #pipeline",c).closest("div.control-group").show()}if(g&&typeof(g)==="function"){g(h)}}})}function populateMilestones(e,h,d,f,j,g){var c=Backbone.Model.extend({url:"/core/api/milestone/"+d});var b=new c();b.fetch({success:function(m){var k=m.toJSON();var l=k.milestones;console.log("------",m);var n=[];$.each(l.split(","),function(){n.push($.trim(this))});if(h){fillMilestones("move",n);return}fillTokenizedSelect("pipeline_milestone",n,function(){if(f&&f.milestone){$("#pipeline_milestone",e).find('option[value="'+f.milestone+'"]').attr("selected","selected")}if(j&&typeof(j)==="function"){var o='<option value="">Select...</option>';$.each(n,function(p,q){o+='<option value="'+q+'">'+q+"</option>"});j($(o))}},g)}})}function setupDealsTracksList(b){this.trackListView=new Base_Collection_View({url:"/core/api/milestone/pipelines",templateKey:"opportunity-track-list",individual_tag_name:"li",postRenderCallback:function(c){var d=trackListView.collection.models;$.each(d,function(e,f){console.log(f.toJSON());if(pipeline_id==0&&f.toJSON().isDefault){pipeline_id=f.id;console.log("default pipeline set.");createCookie("agile_deal_track",pipeline_id)}if(f.id==pipeline_id){$("#deals-tracks .filter-dropdown").append(f.attributes.name)}});if(readCookie("agile_deal_view")){$("#deals-tracks .dropdown-menu").append('<li><a id="1" class="pipeline" data="All" style="cursor: pointer;">All</a></li>')}else{startGettingDeals()}if(d.length<=1){$("#deals-tracks",b).hide()}}});this.trackListView.collection.fetch();$("#deals-tracks",b).append(this.trackListView.render().el)}function copyCursor(c,b){var d=c[0].get("dealCollection");if(d.length>0&&d.at(d.length-1).get("cursor")){b.cursor=d.at(d.length-1).get("cursor")}return b}function appendCustomfieldsHeaders(b){$.ajax({url:"core/api/custom-fields/scope?scope=DEAL",type:"GET",dataType:"json",success:function(c){var d="";$.each(c,function(f,e){d+="<th>"+e.field_label+"</th>"});$(b).find("#deal-list thead tr").append(d)}})}function appendCustomfields(b){$.ajax({url:"core/api/custom-fields/scope?scope=DEAL",type:"GET",dataType:"json",success:function(c){var d=App_Deals.opportunityCollectionView.collection.models;$(b).find("td.deal_custom_replace").remove();$(b).find("#opportunities-model-list tr").each(function(e,f){var g="";$.each(c,function(j,h){g+='<td class="deal_custom_replace"><div style="width:6em;text-overflow:ellipsis;">'+dealCustomFieldValue(h.field_label,d[e].attributes.custom_data)+"</div></td>"});$(this).append(g)})}})}function dealCustomFieldValue(b,d){var c="";$.each(d,function(e,f){if(f.name==b){c=f.value}});return c}(function(v,f,h){var q=null;var d=null;var g=null;var k=null;var b=null;v.SELECT_ALL_DEALS=false;var o="Bulk operation is in progress. You will be notified when it is done.";var c=null;var p=function(w){return w.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};var m=function(y,w,A,z){var x={};if(!v.SELECT_ALL_DEALS){x.ids=JSON.stringify(s())
}x.filter=JSON.stringify(b);if(w){x.form=JSON.stringify(serializeForm(w))}console.log(x);f.ajax({url:y,type:"POST",data:x,contentType:"application/x-www-form-urlencoded",success:function(C){$save_info=f('<div style="display:inline-block"><small><p class="text-success"><i>Task Scheduled.</i></p></small></div>');if(w!==h){var B=f("#"+w).find(".form-actions");if(B.find(".text-success")){B.find(".text-success").parent().parent().remove()}B.append($save_info)}if(A&&typeof(A)==="function"){A(C)}App_Deals.deals();if(z==="no_noty"){return}if(!z){showNotyPopUp("information","Task scheduled","top",5000);return}showNotyPopUp("information",z,"top",5000)}})};var l=function(){console.log("restore",s());console.log("archive",s());var w="/core/api/opportunity/bulk/restore";m(w,h,function(){f("#deal_bulk_restore_modal").modal("hide")},o)};var j=function(){console.log("archive",s());var w="/core/api/opportunity/bulk/archive";m(w,h,function(){f("#deal_bulk_archive_modal").modal("hide")},o)};var n=function(){console.log("change owner",s());console.log("archive",s());var x=f("#owners-list-bulk",f("#deal_owner_change_modal")).val();var w="/core/api/opportunity/bulk/change-owner/"+x;m(w,h,function(){f("#deal_owner_change_modal").modal("hide")},o)};var t=function(){console.log("Delete",s());var w="/core/api/opportunity/bulk";m(w,h,function(){f("#deal_bulk_delete_modal").modal("hide")},o)};var u=function(y){if(y.attr("disabled")){return}disable_save_button(y);var x="bulk_mile_Form";if(!isValidForm("#"+x)){enable_save_button(y);return false}var w="/core/api/opportunity/bulk/change-milestone";m(w,x,function(){enable_save_button(y);f("#deal_mile_change_modal").modal("hide")},o)};var e=function(){if(App_Deals.opportunityCollectionView&&App_Deals.opportunityCollectionView.collection.length>0){var w=App_Deals.opportunityCollectionView.collection.models[0].toJSON();if(w.count){return w.count}}return App_Deals.opportunityCollectionView.collection.length};var s=function(){var x=0;var w=[];f.each(f(".tbody_check",c),function(y,z){if(f(z).is(":checked")){x++;w.push(f(z).closest("tr").data().get("id"))}});console.log("Number of deals selected = ",x);return w};v.init_dom=function(w){c=w;changeOwner=f("#deal-bulk-owner");d=f("#deal-bulk-archive");g=f("#deal-bulk-restore");k=f("#deal-bulk-delete");b=f.parseJSON(readCookie("deal-filters"));changeOwner.die().live("click",function(x){x.preventDefault();n()});d.die().live("click",function(x){x.preventDefault();j()});g.die().live("click",function(x){x.preventDefault();l()});k.die().live("click",function(x){x.preventDefault();t()});f("#deal_bulk_delete_modal,#deal_owner_change_modal,#deal_mile_change_modal,#deal_bulk_archive_modal,#deal_bulk_restore_modal").on("show",function(){if(v.SELECT_ALL_DEALS){f(this).find("span.count").text(p(e()))}else{f(this).find("span.count").text(p(s().length))}});f("#pipeline-list-bulk").die().live("change",function(x){populateMilestones(f("#deal_mile_change_modal"),h,f(this).val(),h,function(y){f("#milestone-list-bulk").html(y);f("#milestone-list-bulk").closest("div").find(".loading-img").hide();f("#pipeline-name").val(f("#pipeline-list-bulk option:selected").text())})});f("#deal-bulk-mile").die().live("click",function(x){x.preventDefault();u(f(this))});f("#select-all-available-deals").die().live("click",function(x){x.preventDefault();v.SELECT_ALL_DEALS=true;f("body").find("#bulk-select").html("Selected "+p(e())+" deals. <a id='select-choosen-deals' href='#'>Select choosen deals only.</a>")});f("#select-choosen-deals").die().live("click",function(x){x.preventDefault();v.SELECT_ALL_DEALS=false;f("body").find("#bulk-select").html("Selected "+p(App_Deals.opportunityCollectionView.collection.length)+" deals. <a id='select-all-available-deals' href='#'>Select all "+p(e())+" deals</a>")})};v.fillPipelineList=function(w){var x='<option value="">Select</option>';f.each(w,function(y,z){x+='<option value="'+z.id+'" data="'+z.milestones+'">'+z.name+"</option>"});f("#deal_mile_change_modal").find("#pipeline-list-bulk").html(x)};v.toggle_deals_bulk_actions_dropdown=function(z,y,x){if(!readCookie("agile_deal_view")){return}v.SELECT_ALL_DEALS=false;_BULK_DEALS=h;console.log("deal bulk actions.");var A=e();console.log(b);if(f(z).attr("checked")=="checked"){f("body").find("#bulk-actions").css("display","block");if(y&&A!=App_Deals.opportunityCollectionView.collection.length){f("body").find("#bulk-select").show().html("Selected "+p(App_Deals.opportunityCollectionView.collection.length)+" deals. <a id='select-all-available-deals' href='#'>Select all "+p(A)+" deals</a>")}}else{if(y){f("#bulk-actions,#bulk-select").css("display","none");return}else{if(f("#bulk-select").is(":visible")){f("#bulk-select").css("display","none")}}var w=0;f.each(f(".tbody_check"),function(B,C){if(f(C).is(":checked")){w++;return false}});if(w==0){f("#bulk-actions").css("display","none")}}}}(window.deal_bulk_actions=window.deal_bulk_actions||{},$));$(function(){$(".deals-add").live("click",function(b){b.preventDefault();show_deal()});$("#opportunity_validate").live("click",function(f){f.preventDefault();var d=$(this).closest(".opportunity-modal").attr("id");var b=$(this).closest(".opportunity-modal").find("form").attr("id");var c=serializeForm(b);c.custom_data=serialize_custom_fields(b);console.log(c);if(b=="opportunityForm"){saveDeal(b,d,this,c,false)}else{saveDeal(b,d,this,c,true)}});$("#opportunityModal, #opportunityUpdateModal").on("show",function(){$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error")});$("#opportunityModal, #opportunityUpdateModal").on("shown",function(){$(".date_input").attr("placeholder","MM/DD/YYYY");$(".date_input").datepicker({format:"mm/dd/yyyy"})});$("#opportunityModal").on("hidden",function(){$("#opportunityForm").find("li").remove();remove_validation_errors("opportunityModal");$("#opportunityModal #forNoteForm").html("");$(".deal-add-note",$("#opportunityModal")).show();$(".deal-note-label").hide()});$("#opportunityUpdateModal").on("hidden",function(){$("#opportunityUpdateForm").find("li").remove();remove_validation_errors("opportunityUpdateModal");$("#opportunityUpdateModal #forNoteForm").html("");$(".deal-add-note",$("#opportunityUpdateModal")).show();$("#deal-note-label").hide()});$('#opportunities-model-list > tr > td:not(":first-child")').live("click",function(b){b.preventDefault();$(".popover").remove();var c=$(this).closest("tr").data();Backbone.history.navigate("deal/"+c.id,{trigger:true})});$("#dashboard-opportunities-model-list > tr").live("click",function(b){b.preventDefault();var c=$(this).closest("tr").data();Backbone.history.navigate("deal/"+c.id,{trigger:true})});$(".milestones > li").live("mouseenter",function(){$(this).find(".deal-options").css("visibility","visible")});$(".milestones > li").live("mouseleave",function(){$(this).find(".deal-options").css("visibility","hidden")});$(".deal-edit").live("click",function(d){d.preventDefault();var g=$(this).closest(".data").attr("id");var f=($(this).closest("ul").attr("milestone")).trim();var b;var c=DEALS_LIST_COLLECTION.collection.where({heading:f});if(!c){return}b=c[0].get("dealCollection").get(g).toJSON();if(b){updateDeal(b,true)}});$(".deal-delete").live("click",function(f){f.preventDefault();if(!confirm("Are you sure you want to delete?")){return}var h=$(this).closest(".data").attr("id");var g=($(this).closest("ul").attr("milestone")).trim();var c=[];var b={};c.push(h);b.ids=JSON.stringify(c);var d=this;$.ajax({url:"core/api/opportunity/"+h,type:"DELETE",success:function(){var e=DEALS_LIST_COLLECTION.collection.where({heading:g});if(!e){return}e[0].get("dealCollection").remove(e[0].get("dealCollection").get(h));$(d).closest("li").css("display","none");pieMilestones();dealsLineChart()}})});$("#pipeline").live("change",function(c){var b=$(this).closest("form");$("#milestone",b).closest("div").find(".loading-img").show();populateMilestones(b,undefined,$(this).val(),undefined,function(d){$("#milestone",b).html(d);$("#milestone",b).closest("div").find(".loading-img").hide()})});$("#opportunity_archive").die().live("click",function(b){b.preventDefault();$("#archived",$("#opportunityUpdateForm")).attr("checked","checked");$("#opportunityUpdateModal #opportunity_validate").trigger("click")});$("#opportunity_unarchive").die().live("click",function(b){b.preventDefault();$("#archived",$("#opportunityUpdateForm")).removeAttr("checked");$("#opportunityUpdateModal #opportunity_validate").trigger("click")});$("#deal-quick-archive").live("click",function(g){g.preventDefault();if($(this).attr("disabled")){return}disable_save_button($(this));var k=$("#archived-deal-id",$("#deal_archive_confirm_modal")).val();var j=$("#archived-deal-milestone",$("#deal_archive_confirm_modal")).val();var d;var f;if(Current_Route!="deals"){d=App_Deal_Details.dealDetailView.model.toJSON()}else{f=DEALS_LIST_COLLECTION.collection.where({heading:j});if(!f){return}d=f[0].get("dealCollection").get(k).toJSON()}d.archived=true;var c=$(this);var b=[];$.each(d.notes,function(e,l){b.push(l.id)});d.notes=b;if(d.note_description){delete d.note_description}if(!d.close_date||d.close_date==0){d.close_date=null}d.owner_id=d.owner.id;var h=new Backbone.Model();h.url="/core/api/opportunity";h.save(d,{success:function(l,e){if(Current_Route!="deals"){$("#deal_archive_confirm_modal").modal("hide");App_Deal_Details.dealDetailView.model=l;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+l.toJSON().id,{trigger:true});return}if(removeArchive(e)){f[0].get("dealCollection").remove(f[0].get("dealCollection").get(k));$("#"+k).parent().remove()}else{$("#"+k+" .deal-options").find(".deal-archive").remove();$("#"+k+" .deal-options").find(".deal-edit").remove();$("#"+k+" .deal-options").prepend('<a title="Restore" class="deal-restore" style="cursor:pointer;text-decoration:none;"> <i style="width: 0.9em!important;" class="icon-mail-reply"></i> </a>')}console.log("archived deal----",l);pieMilestones();enable_save_button(c);
$("#deal_archive_confirm_modal").modal("hide");dealsLineChart();update_deal_collection(l.toJSON(),k,j,j)}})});$("#deal-quick-restore").live("click",function(g){g.preventDefault();var k=$("#restored-deal-id",$("#deal_restore_confirm_modal")).val();var j=$("#restored-deal-milestone",$("#deal_restore_confirm_modal")).val();var d;var f;if($(this).attr("disabled")){return}disable_save_button($(this));if(Current_Route!="deals"){d=App_Deal_Details.dealDetailView.model.toJSON()}else{f=DEALS_LIST_COLLECTION.collection.where({heading:j});if(!f){return}d=f[0].get("dealCollection").get(k).toJSON()}d.archived=false;var c=$(this);var b=[];$.each(d.notes,function(e,l){b.push(l.id)});d.notes=b;if(d.note_description){delete d.note_description}if(!d.close_date||d.close_date==0){d.close_date=null}d.owner_id=d.owner.id;var h=new Backbone.Model();h.url="/core/api/opportunity";h.save(d,{success:function(m,l){if(Current_Route!="deals"){$("#deal_restore_confirm_modal").modal("hide");App_Deal_Details.dealDetailView.model=m;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+m.toJSON().id,{trigger:true});return}if(removeArchive(l)){f[0].get("dealCollection").remove(f[0].get("dealCollection").get(k));$("#"+k).parent().remove()}else{$("#"+k+" .deal-options").find(".deal-restore").remove();var e='<a title="Archive" class="deal-archive" style="cursor:pointer;text-decoration:none;"> <i style="width: 0.9em!important;" class="icon-archive"></i> </a>';e+='<a title="Edit" class="deal-edit" style="cursor:pointer;text-decoration:none;"> <i style="width: 0.9em!important;" class="icon-pencil"></i> </a>';$("#"+k+" .deal-options").prepend(e)}console.log("archived deal----",m);pieMilestones();enable_save_button(c);$("#deal_restore_confirm_modal").modal("hide");dealsLineChart();update_deal_collection(m.toJSON(),k,j,j)}})});$(".deal-archive").live("click",function(c){c.preventDefault();var b={};b.id=$(this).closest(".data").attr("id");b.milestone=($(this).closest("ul").attr("milestone")).trim();$("#archived-deal-id",$("#deal_archive_confirm_modal")).val(b.id);$("#archived-deal-milestone",$("#deal_archive_confirm_modal")).val(b.milestone);$("#deal_archive_confirm_modal").modal("show")});$(".deal-restore").live("click",function(c){c.preventDefault();var b={};b.id=$(this).closest(".data").attr("id");b.milestone=($(this).closest("ul").attr("milestone")).trim();$("#restored-deal-id",$("#deal_restore_confirm_modal")).val(b.id);$("#restored-deal-milestone",$("#deal_restore_confirm_modal")).val(b.milestone);$("#deal_restore_confirm_modal").modal("show")});$("#pipeline_milestone").live("change",function(d){var c=$(this).val();var b=c.substring(0,c.indexOf("_"));var f=c.substring(c.indexOf("_")+1,c.length+1);$(this).closest("form").find("#pipeline").val(b);$(this).closest("form").find("#milestone").val(f);console.log(b,"-----------",f)})});function updateDeal(e,c){var d=(c?e:e.toJSON());add_recent_view(new BaseModel(d));var b=$("#opportunityUpdateForm");$("#opportunityUpdateForm")[0].reset();deserializeForm(d,$("#opportunityUpdateForm"));$("#opportunityUpdateModal").modal("show");if(d.archived){$("#opportunity_archive").hide();$("#opportunity_unarchive").show()}else{$("#opportunity_unarchive").hide();$("#opportunity_archive").show()}agile_type_ahead("relates_to",b,contacts_typeahead);populateUsers("owners-list",b,d,"owner",function(f){b.find("#owners-list").html(f);if(d.owner){$("#owners-list",b).find("option[value="+d.owner.id+"]").attr("selected","selected");$("#owners-list",$("#opportunityUpdateForm")).closest("div").find(".loading-img").hide()}});populateTrackMilestones(b,undefined,d,function(f){});$("#close_date",b).datepicker({format:"mm/dd/yyyy"});showNoteOnForm("opportunityUpdateForm",d.notes);add_custom_fields_to_form(d,function(g){var f=show_custom_fields_helper(g.custom_fields,[]);$("#custom-field-deals",b).html(fill_custom_fields_values_generic($(f),d.custom_data))},"DEAL")}function show_deal(){var b=$("#opportunityForm");$("#opportunityModal").modal("show");add_custom_fields_to_form({},function(d){var c=show_custom_fields_helper(d.custom_fields,[]);$("#custom-field-deals",$("#opportunityModal")).html($(c))},"DEAL");populateUsers("owners-list",b,undefined,undefined,function(c){$("#opportunityForm").find("#owners-list").html(c);$("#owners-list",$("#opportunityForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#opportunityForm")).closest("div").find(".loading-img").hide()});agile_type_ahead("relates_to",b,contacts_typeahead);populateTrackMilestones(b,undefined,undefined,function(c){console.log(c);$.each(c,function(d,e){if(e.isDefault){var f=e.id+"_";if(e.milestones.length>0){f+=e.milestones.split(",")[0];$("#pipeline_milestone",b).val(f);$("#pipeline",b).val(e.id);$("#milestone",b).val(e.milestones.split(",")[0])}}})});$("#close_date",b).datepicker({format:"mm/dd/yyyy"})}function checkPipeline(b){var c=0;if(readCookie("agile_deal_track")){c=readCookie("agile_deal_track")}if(c==b){return true}return false}function removeArchive(d){var b=false;if(readCookie("deal-filters")){var c=$.parseJSON(readCookie("deal-filters")).archived;if(c=="false"&&d.archived==true){return true}else{if(c=="true"&&d.archived==false){return true}else{return false}}}else{return b}}function saveDeal(j,b,h,d,g){if($(h).attr("disabled")){return}disable_save_button($(h));if(!isValidForm("#"+j)){var c=$("#"+j).closest(".modal-body");var f=$("#"+j).find(".single-error").first();c.scrollTop(f.offset().top-c.offset().top+c.scrollTop());enable_save_button($(h));return false}if(d.close_date==0){d.close_date=null}var e=new Backbone.Model();e.url="core/api/opportunity";e.save(d,{success:function(p){enable_save_button($(h));$("#"+b).modal("hide");$("#"+j).each(function(){this.reset()});var o=p.toJSON();add_recent_view(new BaseModel(o));if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){$.each(o.contacts,function(v,u){if(u.id==App_Contacts.contactDetailView.model.get("id")){if(dealsView&&dealsView.collection){if(o.archived==true){dealsView.collection.remove(o.id);dealsView.collection.sort()}else{if(dealsView.collection.get(o.id)){dealsView.collection.get(o.id).set(new BaseModel(o))}else{dealsView.collection.add(new BaseModel(o),{sort:false});dealsView.collection.sort()}}}add_entity_to_timeline(p);return false}})}else{if(Current_Route=="deals"){if(!readCookie("agile_deal_view")){var k=o.milestone;if(g){var l=o.id;var m=$("#"+l).attr("data");var t=DEALS_LIST_COLLECTION.collection.where({heading:m});if(!t){return}t[0].get("dealCollection").remove(t[0].get("dealCollection").get(l));if(!checkPipeline(o.pipeline_id)){console.log("removing the deal");$("#"+m.replace(/ +/g,"")).find("#"+l).parent().remove();try{$("#"+m.replace(/ +/g,"")+"_count").text(parseInt($("#"+m.replace(/ +/g,"")+"_count").text())-1)}catch(n){console.log(n)}}else{if(k!=m){t=DEALS_LIST_COLLECTION.collection.where({heading:k});if(!t){return}t[0].get("dealCollection").add(copyCursor(t,o));$("#"+m.replace(/ +/g,"")).find("#"+l).parent().remove();try{$("#"+k.replace(/ +/g,"")+"_count").text(parseInt($("#"+k.replace(/ +/g,"")+"_count").text())+1);$("#"+m.replace(/ +/g,"")+"_count").text(parseInt($("#"+m.replace(/ +/g,"")+"_count").text())-1)}catch(n){console.log(n)}}else{t=DEALS_LIST_COLLECTION.collection.where({heading:k});if(!t){return}t[0].get("dealCollection").add(copyCursor(t,o),{silent:true});console.log("Updating html - ",o);var s="deals-by-paging-model";if(!readCookie("deal-milestone-view")){s="deals-by-paging-relax-model"}$("#"+k.replace(/ +/g,"")).find("#"+l).parent().html(getTemplate(s,o))}}if(removeArchive(o)){console.log("removing the deal when archived");$("#"+m.replace(/ +/g,"")).find("#"+l).parent().remove();try{$("#"+m.replace(/ +/g,"")+"_count").text(parseInt($("#"+m.replace(/ +/g,"")+"_count").text())-1)}catch(n){console.log(n)}}}else{if(checkPipeline(o.pipeline_id)){var t=DEALS_LIST_COLLECTION.collection.where({heading:k});if(!t){return}var q=$.parseJSON(readCookie("deal-filters"));console.log(o.owner.id.toString()!=q.owner_id,o.owner.id.toString(),q.owner_id);if(q.owner_id.length>0&&o.owner.id.toString()!=q.owner_id){return}console.log(q.archived!="all"&&o.archived!=q.archived,o.archived);if(q.archived){console.log(q.archived);if(q.archived!="all"&&o.archived.toString()!=q.archived){return}}t[0].get("dealCollection").add(copyCursor(t,o));try{$("#"+k.replace(/ +/g,"")+"_count").text(parseInt($("#"+k.replace(/ +/g,"")+"_count").text())+1)}catch(n){console.log(n)}}}includeTimeAgo($("#"+k.replace(/ +/g,"")));$("a.deal-notes").tooltip()}else{if(g){App_Deals.opportunityCollectionView.collection.remove(d)}p.attributes.cursor=App_Deals.opportunityCollectionView.collection.last().toJSON().cursor;App_Deals.opportunityCollectionView.collection.add(p);App_Deals.opportunityCollectionView.render(true)}}else{if(Current_Route==undefined||Current_Route=="dashboard"){if(App_Portlets.currentPosition&&App_Portlets.pendingDeals&&App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)]){if(g){App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)].collection.remove(d)}if(d.milestone!="Won"&&d.milestone!="Lost"){App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)].collection.add(p)}App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)].render(true)}if(App_Portlets.currentPosition&&App_Portlets.dealsWon&&App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)]){if(g){App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)].collection.remove(d)}App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)].collection.add(p);App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)].render(true)}}else{App_Deal_Details.dealDetailView.model=p;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+p.toJSON().id,{trigger:true})}}}},error:function(k,l){enable_save_button($(h));$("#"+b).find("span.error-status").html(l.responseText);
setTimeout(function(){$("#"+b).find("span.error-status").html("")},2000);console.log("-----------------",l.responseText)}})}function startGettingDeals(f,e){console.log("------started-----",pipeline_id);var d=trackListView.collection.get(pipeline_id).toJSON().milestones;if(d.trim().length==0){var c='<div class="slate" style="margin:0px;"><div class="slate-content"><div class="box-left"><img alt="Clipboard" src="/img/clipboard.png"></div><div class="box-right"><h3>You have no milestones defined</h3><br><a href="#milestones" class="btn"><i class="icon icon-plus-sign"></i> Add Milestones</a></div></div></div>';$("#new-opportunity-list-paging").html(c);return}if(readCookie("agile_deal_track")){if(readCookie("agile_deal_track")!=pipeline_id){createCookie("agile_deal_track",pipeline_id)}}var b=trackListView.collection.get(pipeline_id).toJSON().milestones.split(",");console.log(b);createDealsNestedCollection(pipeline_id,b)}function dealFiltersForCollection(b){if(b=="CATEGORY"){getArraySortOnCount(b,GROUPING_MAP[b].type,pending)}else{createNestedCollection(b,GROUPING_MAP[b].type,pending)}}function createDealsNestedCollection(f,e){console.log("In createNestedCollection");initDealListCollection(e);var c="/core/api/opportunity/based?pipeline_id="+f+"&order_by=close_date";if(readCookie("deal-filters")){c+="&filters="+encodeURIComponent(getDealFilters())}for(var d in e){var g;var b=c+"&milestone="+e[d];g={heading:e[d],url:b};if(!g){return}DEALS_LIST_COLLECTION.collection.add(g)}$("#new-opportunity-list-paging").html(DEALS_LIST_COLLECTION.render(true).el);pipeline_count=0;fetchForNextDealsList(e)}function initDealListCollection(b){DEALS_LIST_COLLECTION=new Base_Collection_View({restKey:"deal",templateKey:"opportunities-by-paging",individual_tag_name:"div",sort_collection:false,postRenderCallback:function(d){$(".loading-img",d).remove();$(".loading",d).remove();var e=b.length;if(!e){return}var c=(100/e);if(readCookie("deal-milestone-view")){if(readCookie("deal-milestone-view")=="compact"&&e>8){c=100/8}}else{if(e>5){c=100/5}}$("#opportunities-by-paging-model-list",d).find(".milestone-column").width(c+"%")}});DEALS_LIST_COLLECTION.appendItem=dealAppend}function dealAppend(b){var d=new Base_List_View({model:b,view:"inline",template:"opportunities-by-paging-model",tagName:"div",className:"milestone-column",id:b.get("heading").replace(/ +/g,"")});var c=d.render().el;$("#opportunities-by-paging-model-list > div",this.el).append(c)}function fetchForNextDealsList(b){if(deal_fetching){return}if(pipeline_count<b.length){dealsFetch(pipeline_count,b)}if(pipeline_count>=b.length){deal_fetching=true}}function dealsFetch(c,d){console.log("index: "+c);var b=DEALS_LIST_COLLECTION.collection.at(c);if(!b){return}var e="deals-by-paging";if(!readCookie("deal-milestone-view")){e="deals-by-paging-relax"}var f=new Base_Collection_View({url:b.get("url"),templateKey:e,individual_tag_name:"li",sort_collection:false,cursor:true,page_size:20,postRenderCallback:function(g){$("ul.milestones",g).attr("milestone",b.get("heading"));if(!readCookie("agile_deal_view")){deal_infi_scroll($("#"+b.get("heading").replace(/ +/g,"")+"-list-container")[0],f)}includeTimeAgo(g)}});f.collection.fetch({success:function(j){b.set("dealCollection",f.collection);$("#"+b.get("heading").replace(/ +/g,"")+"-list-container").html(f.render(true).el);console.log($("#"+b.get("heading").replace(/ +/g,"")).find("img.loading_img").length);$("#"+b.get("heading").replace(/ +/g,"")).find("img.loading_img").hide();try{var h=j.at(0)?j.at(0).toJSON().count:0;$("#"+b.get("heading").replace(/ +/g,"")+"_count").text(j.at(0)?j.at(0).toJSON().count:0)}catch(g){console.log(g)}$("a.deal-notes").tooltip();pipeline_count++;setup_deals_in_milestones("opportunities-by-paging-model-list");fetchForNextDealsList(d)}})}function deal_infi_scroll(c,b){console.log("initialize_infinite_scrollbar",c);if(c==undefined||c==null){console.log("no elmnt");return}console.log(b);b.infiniScroll=new Backbone.InfiniScroll(b.collection,{target:c,untilAttr:"cursor",param:"cursor",strict:false,pageSize:b.page_size,success:function(e,d){console.log("in success");if(!e.last().get("cursor")){this.strict=true;b.infiniScroll.disableFetch()}$(b.infiniScroll.options.target).find(".scroll-loading").remove();includeTimeAgo($(b.infiniScroll.options.target));$("a.deal-notes").tooltip()},onFetch:function(){console.log("in fetch");$(b.infiniScroll.options.target).append('<div class="scroll-loading"> <img src="/img/ajax-loader-cursor.gif" style="margin-left: 44%;"> </div>')}})}$(function(){$(".agile-menu > li").click(function(b){console.log("Collapsing before ul");$nav_collapse=$(this).closest(".nav-collapse");console.log($nav_collapse.attr("class"));if($nav_collapse.hasClass("collapse")){console.log("Collapsing");$nav_collapse.collapse("hide")}});$(window).load(function(){$("#top").click(function(){$("body, html").animate({scrollTop:0},300);return false})})});function loadZoomifierDocSelector(){var d=CURRENT_DOMAIN_USER.email;var c=getPropertyValue(App_Contacts.contactDetailView.model.attributes.properties,"email");var b=new Zoomifier.PickerBuilder().setPartnerKey("dwqs4rxjksqpldwqklnpes8hs=").setCallback(zoomifierDocSelectionCallback).setSalesUser(d).setTargetCustomer(c).build()}function zoomifierDocSelectionCallback(b){b="</br>"+b+"</br>";var c=$("#body").data("wysihtml5");if(c){editor.focus();c.editor.composer.commands.exec("insertHTML",b)}}var CONTENT_JSON={contacts:{title:"You do not have any contacts currently.",description:"Contacts are your customers or prospects that you interact with using Agile.",button_text:"Add Contacts",route:"#",modal_id:"personModal",image:"/img/clipboard.png"},filter_results:{title:"No contacts matching this criteria.",route:"#",image:"/img/clipboard.png"},tag_results:{title:"No contacts available with this tag.",route:"#",image:"/img/clipboard.png"},companies:{title:"You do not have any companies currently.",description:"companies are prospects that you interact with using Agile.",button_text:"Add Companies",route:"#",modal_id:"companyModal",image:"/img/clipboard.png"},workflows:{title:"You do not have any Campaigns currently.",description:"Campaign or workflow is an intelligent sales and marketing automation process for sending your contacts relevant information at the right time.",button_text:"Add Campaign",route:"#workflow-templates",image:"/img/clipboard.png"},deals:{title:"No deals found.",description:"You either do not have any deals currently, or there are none matching the filter conditions. <br/>Deals are sales opportunities you track continuously throughout its lifecycle.",button_text:"Add Deal",route:"#",modal_id:"opportunityModal",image:"/img/clipboard.png"},reports:{title:"You do not have any reports currently.",description:"Reports are based on a variety of tags and filters and receive them periodically to constantly be in touch with your sales cycle and pipeline.",button_text:"Add Report",route:"#report-add",image:"/img/clipboard.png"},"activity-reports":{title:"You do not have any activity reports currently.",description:"Get a periodic  email digest of various activities by users in Agile.",button_text:"Add Report",route:"#activity-report-add",image:"/img/clipboard.png"},"contact-filters":{title:"You do not have any filters currently.",description:"Filters are used to sort contacts with a specific criteria to find patterns.",button_text:"Add Filter",route:"#contact-filter-add",image:"/img/clipboard.png"},"contact-views":{title:"You do not have any custom views currently.",description:"View is collection of different fields and the order in which you would like them to appear.",button_text:"Add View",route:"#contact-view-add",image:"/img/clipboard.png"},dashboard:{contacts:{title:"There is no recent activity",description:"Perhaps, you may want to create a <a href='#' modal_id='personModal' class='modal-form'>new contact</a>.",icon:"icon-group icon-3x"},tasks:{title:"You have no tasks due",icon:"icon-edit icon-3x"},deals:{title:"No ongoing deals for you",icon:"icon-money icon-3x"},workflows:{title:"No campaign activity yet",description:"Campaigns help you automate your communication with your customers.<br/>You can create a <a href='#workflow-add'>new campaign</a>.",icon:"icon-sitemap icon-3x"}},"email-templates":{title:"You do not have any Email templates currently.",description:"Personalize and customize email templates for every scenario in the sales cycle.",button_text:"Add Email Template",route:"#email-template-add",image:"/img/clipboard.png"},"contact-activities":{title:"No Contact activity recorded yet.",description:"Web and Campaign activity of your contacts is shown here.",image:"/img/clipboard.png"},"contact-activities/All_Activities":{title:"No Contact activity recorded yet.",description:"Web and Campaign activity of your contacts is shown here.",image:"/img/clipboard.png"},"contact-activities/Page_Views":{title:"No web activity recorded yet.",image:"/img/clipboard.png"},"contact-activities/Email_Opened":{title:"No email opens recorded yet.",image:"/img/clipboard.png"},"contact-activities/Email_Clicked":{title:"No email clicks recorded yet.",image:"/img/clipboard.png"},"contact-activities/Unsubscribed":{title:"No unsubscriptions recorded yet.",image:"/img/clipboard.png"},"contact-activities/Spam_Reports":{title:"No spam reports recorded yet.",image:"/img/clipboard.png"},"contact-activities/Email_Hard_Bounced":{title:"No hard bouces recorded yet.",image:"/img/clipboard.png"},"contact-activities/Email_Soft_Bounced":{title:"No soft bounces recorded yet.",image:"/img/clipboard.png"}};function fill_slate(e,c,b){var d=b;if(!d){d=window.location.hash.split("#")[1]}if(CONTENT_JSON[d]){if((d=="contacts")&&readCookie("company_filter")){$("#"+e,c).html(getTemplate("empty-collection-model",CONTENT_JSON.companies))}else{$("#"+e,c).html(getTemplate("empty-collection-model",CONTENT_JSON[d]))}}}function getContactPadcontentKey(b){if(!b){return}if(b.indexOf("tag")>0){return"tag_results"}if(b.indexOf("filter")>0){return"filter_results"
}return"contacts"}$(function(){$(".modal-form").live("click",function(b){b.preventDefault();var c=$(this).attr("modal_id");if(c=="opportunityModal"){show_deal()}else{$("#"+c).modal("show")}})});(function(b){c();function c(){var e=b("#scroll-top");e.on("click",function(f){f.preventDefault();b("html, body").animate({scrollTop:0},700)}).data("hidden",1).hide();var d=false;b(window).on("scroll",function(){d=true});setInterval(function(){if(d){d=false;var f=e.data("hidden");if(b(this).scrollTop()>b(this).height()/2){if(f){e.fadeIn(600).data("hidden",0)}}else{if(!f){e.slideUp().data("hidden",1)}}}},300)}b("#help-page").die().live("click",function(d){var f=b(getTemplate("show-help"),{});f.modal("show");b(".hide-modal",f).click(function(){f.modal("hide")})});b(".email-share").die().live("click",function(g){g.preventDefault();var d=500;var h=b(this).closest("a").attr("data");if(h=="Linkedin"){d=700}var f=b(this).closest("a").attr("href");window.open(f,h,"width="+d+",height=500,left=200%,top=100%")});b("#share-email").die().live("click",function(f){f.preventDefault();if(b("#share-by-email").size()!=0){b("#share-by-email").remove()}var g=b(getTemplate("share-by-email",CURRENT_DOMAIN_USER));var d=b(g).find("textarea").val();d=d.replace(/<br\/>/g,"\r\n");b(g).find("textarea").val(d);g.modal("show");b("#shareMail").die().live("click",function(k){k.preventDefault();if(!isValidForm(b("#sharemailForm"))){return}var j=serializeForm("sharemailForm");j.body=j.body.replace(/\r\n/g,"<br/>");var h="core/api/emails/send-email?from="+encodeURIComponent(j.from)+"&to="+encodeURIComponent(j.to)+"&subject="+encodeURIComponent(j.subject)+"&body="+encodeURIComponent(j.body);$save_info=b('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><p class="text-success" style="color:#008000; font-size:15px; display:inline-block"> <i>Sending mail...</i></p></span>');b("#msg",this.el).append($save_info);$save_info.show().delay(2000).fadeOut("slow");b.post(h,function(){g.modal("hide")})})})})(jQuery);var Agile_Tour={};function create_tour_steps(b){Agile_Tour.contacts=[{element:"#contacts",title:"Contact & Account Management",content:"View your contacts, leads and accounts (companies) all at one place.<br/>",placement:"bottom",el:b,backdrop:true},{element:"#filters-tour-step",title:"Companies (Accounts)",content:"Accounts are stored as Companies in Agile.<br/><br/> You can switch between contacts and companies  here.<br/>",placement:"bottom",el:b,backdrop:true},{element:"#tags",title:"Tags",content:"Tags help you effectively manage your contacts and companies.<br/><br/> For eg: you can add a lead tag to your contacts for leads.<br/>",placement:"right",el:b,backdrop:true}];Agile_Tour["contact-details"]=[{element:"#contact-tab-content",title:"Facebook-Style Timeline",content:"Notice the awesome timeline with dates, emails exchanged, social messages & site visits.<br/>",placement:"right",el:b,backdrop:true},{element:"#score",container:"#score",title:"Score your leads",content:"Assign lead scores for every contact to keep high quality leads swimming on top. <br/><br/> Use workflows to automate the process based on user behavior.<br/>",placement:"bottom",el:b,backdrop:true},{element:"#widgets",title:"Widgets & Integrations",content:"Get more information about the contact from social media, helpdesk tickets, chats, and from billing systems.<br/>",placement:"left",el:b,backdrop:true}];Agile_Tour.calendar=[{element:"#calendar_event",title:"Calendar Events",content:"Events are time based such as meetings.<br/> They show up in calendar.<br/>",placement:"left",backdrop:true},{element:".todo-block",title:"To Do Tasks",content:"Tasks are like to-dos. Result oriented.<br/><br/> You can assign a category such as call, email.<br/>",placement:"right",backdrop:true},{element:"#subscribe-ical",title:"Calendar Sync",content:"You can sync your Agile calendar with  Outlook, Google calendar or your mobile phone.<br/>",placement:"top",backdrop:true}];Agile_Tour.workflows=[{element:"#learn-workflows",title:"Learn about Campaigns",content:"Our customers love campaign workflows. You would too!<br/><br/>  <p class='text-error'><strong>Take a few mins and learn more about campaigns.</strong></p>",placement:"left",el:b,backdrop:true},{element:"#add-trigger",title:"Triggers",content:"Create conditions to trigger your campaigns automatically. <br/><br/> <strong>Eg:</strong> when a tag is added or when a contact reaches a score.<br/>",placement:"bottom",el:b,backdrop:true}]}var tour;function start_tour(b,c){if(!b){b=Current_Route}console.log(tour);if(tour&&tour._options){var d=tour._current;console.log(d);console.log(tour._options.name);console.log(b+"-tour");if(tour._options.name!=b+"-tour"){tour.end();tour=undefined}else{tour.end();tour.setCurrentStep(d);tour.start(true);return}}tour=undefined;var e=false;if(!c){if(e){return}initiate_tour(b,c);e=true}$("body").live("agile_collection_loaded",function(g,f){if(e){return}initiate_tour(b,f);e=true})}function initiate_tour(b,c){var d=readCookie("agile_tour");if(!d){return}if(!b){if(!Current_Route){return}b=Current_Route}d=JSON.parse(JSON.parse(d));tourStatus=d[b];if(!tourStatus){return}if($.isEmptyObject(Agile_Tour)){create_tour_steps(c)}if(Agile_Tour[b]){head.load(CSS_PATH+"css/bootstrap-tour.min.css","lib/bootstrap-tour-agile.min.js",function(){tour=new Tour({name:b+"-tour",debug:true,useLocalStorage:true,endOnLast:true,onEnd:function(e){$("."+b+"-tour").remove();delete d[b];if($.isEmptyObject(d)){eraseCookie("agile_tour");return}createCookie("agile_tour",JSON.stringify(JSON.stringify(d)))}});tour.addSteps(Agile_Tour[b]);tour.setCurrentStep(0);tour.start(true)})}}function reinitialize_tour_on_current_route(){console.log(tour);var c=readCookie("agile_tour");var b=Current_Route;if(Current_Route.indexOf("contact/")!=-1){b="contact-details"}if(c){c=JSON.parse(JSON.parse(c));if(c[b]==true){return}localStorage.removeItem(b+"-tour_current_step")}else{c={}}c[b]=true;console.log(JSON.stringify(c));localStorage.removeItem(b+"-tour_current_step");createCookie("agile_tour",JSON.stringify(JSON.stringify(c)));initiate_tour(b)}$(function(){$("#agile-page-tour").click(function(b){b.preventDefault();reinitialize_tour_on_current_route()})});$(function(b){b.fn.initial=function(d){var c=["#1abc9c","#16a085","#f1c40f","#f39c12","#2ecc71","#27ae60","#e67e22","#d35400","#3498db","#2980b9","#e74c3c","#c0392b","#9b59b6","#8e44ad","#bdc3c7","#34495e","#2c3e50","#95a5a6","#7f8c8d","#ec87bf","#d870ad","#f69785","#9ba37e","#b49255","#b49255","#a94136"];return this.each(function(){var k=b(this);var h=b.extend({name:"Name",charCount:1,textColor:"#ffffff",height:100,width:100,fontSize:60,fontWeight:400,fontFamily:"HelveticaNeue-Light,Helvetica Neue Light,Helvetica Neue,Helvetica, Arial,Lucida Grande, sans-serif"},d);h=b.extend(h,k.data());h.name=""+h.name;var m=h.name.substr(0,h.charCount).toUpperCase();var j=b('<text text-anchor="middle"></text>').attr({y:"50%",x:"50%",dy:"0.35em","pointer-events":"auto",fill:h.textColor,"font-family":h.fontFamily}).html(m).css({"font-weight":h.fontWeight,"font-size":h.fontSize+"px"});var l=null;if(m.length>1){l=Math.abs(Math.floor((((m.charCodeAt(0)-65)+(m.charCodeAt(1)-65))/2)%c.length))}else{l=Math.abs(Math.floor((m.charCodeAt(0)-65)%c.length))}var f=b("<svg></svg>").attr({xmlns:"http://www.w3.org/2000/svg","pointer-events":"none",width:h.width,height:h.height}).css({"background-color":c[l],width:h.width+"px",height:h.height+"px"});f.append(j);var g=window.btoa(unescape(encodeURIComponent(b("<div>").append(f.clone()).html())));k.attr("src","data:image/svg+xml;base64,"+g)})}});function image_error(c){var b=$(c).attr("_data-name");if(!b){return}$(c).attr("data-name",b);$(c).initial({charCount:2,fontWeight:"normal"})}function image_load(c){var b=$(c).attr("_data-name");var d=$(c).attr("src");if(!d){$(c).attr("src",DEFAULT_GRAVATAR_url);return}if(d.indexOf(DEFAULT_GRAVATAR_url)>=0){$(c).attr("data-name",b);$(c).removeAttr("onLoad")}}function load_imap_folders(b){var c=$(".imap-folders-settings-click",b).closest("div");$(".imap-folders-settings-click",b).css("display","none");c.find(".imap-folders-settings-txt").css("display","none");c.find(".imap-folders-select").css("display","inline")}function createCookie(d,e,f){if(f){var c=new Date();c.setTime(c.getTime()+(f*24*60*60*1000));var b="; expires="+c.toGMTString()}else{var b=""}document.cookie=d+"="+escape(e)+b+"; path=/"}function createCookieInAllAgileSubdomains(d,e,f){if(f){var c=new Date();c.setTime(c.getTime()+(f*24*60*60*1000));var b="; expires="+c.toGMTString()}else{var b=""}document.cookie=d+"="+escape(e)+b+"; path=/; domain=agilecrm.com"}function readCookie(d){var f=d+"=";var b=document.cookie.split(";");for(var e=0;e<b.length;e++){var g=b[e];while(g.charAt(0)==" "){g=g.substring(1,g.length)}if(g.indexOf(f)==0){return unescape(g.substring(f.length,g.length))}}return null}function eraseCookie(b){createCookie(b,"",-1)}var _agile_contact;var _agile_webrules;var rules={tags_in:function(h,d){if(h.tags_in&&d){var c=0;var g=h.tags_in.length;var f=d.tags.length;if(g<=f){for(var e=0;e<g;e++){for(var b=0;b<f;b++){if(h.tags_in[e]===d.tags[b]){c++}}}}if(c==g&&c!==0&&g!==0){return true}}},tags_out:function(h,c){if(c&&h.tags_out){var g=0;var f=h.tags_out.length;var e=c.tags.length;for(var d=0;d<f;d++){for(var b=0;b<e;b++){if(c.tags[b]!==h.tags_out[d]){g++}}}if(g==f*e&&g!==0&&f!==0&&e!==0){return true}}},tags_time:function(n,b){if(n.tags_time&&b){var k=0;var e=n.tags_time.tags.length;var c=b.tagsWithTime.length;var m=new Date().getTime();if(e<=c){for(var l=0;l<e;l++){for(var g=0;g<c;g++){if(n.tags_time.tags[l]==b.tagsWithTime[g].tag){if((n.tags_time.condition=="LAST"&&(0<=(m-b.tagsWithTime[g].createdTime)&&(m-b.tagsWithTime[g].createdTime)<=(n.tags_time.time*86400000)))||(n.tags_time.condition=="BEFORE"&&(n.tags_time.time>=b.tagsWithTime[g].createdTime))||(n.tags_time.condition=="AFTER"&&(n.tags_time.time<=b.tagsWithTime[g].createdTime))||(n.tags_time.condition=="EQUALS"&&(n.tags_time.time<=b.tagsWithTime[g].createdTime&&b.tagsWithTime[g].createdTime<=(n.tags_time.time+86400000)))||(n.tags_time.condition=="BETWEEN"&&(n.tags_time.time_min<=b.tagsWithTime[g].createdTime&&b.tagsWithTime[g].createdTime<=n.tags_time.time_max))){k++
}}}}}if(k==e&&k!==0&&e!==0){return true}}},min_score:function(c,b){if(b&&c.min_score&&b.lead_score>=c.min_score){return true}},max_score:function(c,b){if(b&&c.max_score&&b.lead_score<=c.max_score){return true}},referrer_is:function(b){if(b.referrer_is===document.referrer){return true}},referrer_matches:function(c){var b=document.referrer;if(b.indexOf(c.referrer_matches)!==-1){return true}},page_view_is:function(b){if(b.page_view_is===document.location.href){return true}},page_view_matches:function(c){var b=document.location.href;if(b.indexOf(c.page_view_matches)!==-1){return true}},session_type:function(b){if(b.session_type==="first"){return agile_session.new_session}if(b.session_type==="ongoing"){return !agile_session.new_session}},visit_type:function(b){if(b.visit_type==="repeat"){return !agile_guid.new_guid}if(b.visit_type==="first"){return agile_guid.new_guid}},contact_properties_in:function(h,d){if(d&&h.contact_properties_in){var c=0;var b=h.contact_properties_in.length;var e=d.properties.length;for(var g=0;g<b;g++){for(var f=0;f<e;f++){if(h.contact_properties_in[g].name===d.properties[f].name&&h.contact_properties_in[g].value===d.properties[f].value){c++}}}if(c==b&&c!==0&&b!==0){return true}}},contact_properties_out:function(m,c){if(c&&m.contact_properties_out){var j=0;var b=m.contact_properties_out.length;var d=c.properties.length;for(var f=0;f<b;f++){for(var e=0;e<d;e++){if(m.contact_properties_out[f].name===c.properties[e].name&&m.contact_properties_out[f].value!==c.properties[e].value){j++}}}if(j==b&&j!==0&&b!==0&&d!==0){return true}}},contact_time:function(f,b){if(b&&f.contact_time){var e=new Date().getTime();var d=(b.created_time*1000);var c=(e-d);if((f.contact_time.condition=="LAST"&&(0<=c&&c<=(f.contact_time.time*86400000)))||(f.contact_time.condition=="AFTER"&&(f.contact_time.time<=d))||(f.contact_time.condition=="BEFORE"&&(f.contact_time.time>=d))||(f.contact_time.condition=="ON"&&(f.contact_time.time<=d&&d<=(86400000+f.contact_time.time)))||(f.contact_time.condition=="BETWEEN"&&(f.contact_time.time_min<=d&&d<=f.contact_time.time_max))){return true}}}};function show_modal(d,e,c){var b=new SimpleModal(e);b.addButton("Ok","simple_modal_btn primary",function(){if(e.form_id&&(document.id(e.form_id))){var f={};var h=document.id("modal-form");for(var g=0;g<h.length;g++){if(h[g].name.toLowerCase()=="firstname"||h[g].name.toLowerCase()=="first_name"||h[g].name.toLowerCase()=="first name"||h[g].name.toLowerCase()=="name"||h[g].name.toLowerCase()=="first"){f.first_name=h[g].value}if(h[g].name.toLowerCase()=="lastname"||h[g].name.toLowerCase()=="last_name"||h[g].name.toLowerCase()=="last name"||h[g].name.toLowerCase()=="last"){f.last_name=h[g].value}if(h[g].name.toLowerCase().indexOf("email")!=-1){f.email=h[g].value}}_agile.create_contact(f,{success:function(j){_agile.set_email(f.email);_agile.add_tag("signup",{success:function(){console.log("tag added")},error:function(){console.log("error")}});console.log("success")},error:function(j){console.log("error")}})}this.hide()});if(e.show_btn_cancel){b.addButton("Cancel","simple_modal_btn")}b.show({model:"modal",title:d.title,contents:function(){if(e.form_id&&(document.id(e.form_id))){return"<form id=modal-form>"+document.id(e.form_id).innerHTML+"</form>"}else{return d.contents}}})}function show_noty(d,c,b){head.js("lib/noty/jquery.noty.js","/lib/noty/layouts/"+c.position+".js","lib/noty/themes/default-custom.js",function(){var e={};if(b&&typeof(b)==="function"){e.onClose=b}var f=noty({text:d,type:c.type,dismissQueue:c.dismiss_queue,layout:c.position,theme:c.theme,callback:e,timeout:2000})})}function execute_action(l,k,g,q,c,f,b,e,j,o,d,p,h){if(k.btn_ok){show_modal(l,k,g)}if(c.type){show_noty(q,c,f)}if(b.length!==0&&h){for(var n=0;n<b.length;n++){_agile.add_campaign({id:b[n]},{success:function(){console.log("campaign assigned")},error:function(){console.log("error in assigning campaign")}},h)}}if(d.length!==0&&h){_agile.add_tag(d.toString(),{success:function(){console.log("tags added")},error:function(){console.log("failed to add tags")}},h)}if(j&&h){_agile.add_score(j,{success:function(){console.log("score added")},error:function(){console.log("failed to add score")}},h)}if(e.length!==0&&h){for(var m=0;m<e.length;m++){_agile.unsubscribe_campaign({id:e[m]},{success:function(){console.log("unsubscribed")},error:function(){console.log("error in unsubscribing")}},h)}}if(o&&h){_agile.add_score(o,{success:function(){console.log("score")},error:function(){console.log("failed to subtract score")}},h)}if(p.length!==0&&h){_agile.remove_tag(p.toString(),{success:function(){console.log("tags removed")},error:function(){console.log("failed to remove tags")}},h)}}function perform_action(x,u,y,e,d,q,g,b,s,p,f,n,w,l){var o=0;var v=0;var h=0;for(var m in u){if(u.hasOwnProperty(m)){h++}}for(var c in x){o++;if(x.hasOwnProperty(c)&&rules[c](x)){v++}}var k;agile_getEmail({success:function(j){k=j.email;if(k=="null"||k==undefined){if(h==0){if(o==v&&o!==0&&v!==0){execute_action(y,e,d,q,g,b,s,p,f,n,w,l)}}}else{if(k){_agile.get_contact(k,{success:function(z){_agile_contact=z;var t=0;for(var A in u){if(u.hasOwnProperty(A)&&rules[A](u,_agile_contact)){t++}}if((h==0&&o!==0&&o==v)||(h!==0&&h==t&&o==0)||(h!=0&&h==t&&o==v&&o!==0)){execute_action(y,e,d,q,g,b,s,p,f,n,w,l,k)}},error:function(){if(h==0&&o!==0&&o==v){execute_action(y,e,d,q,g,b,s,p,f,n,w,l)}}})}}}})}function execute_webrules(){setTimeout(function(){_agile.web_rules({success:function(e){var d=_agile_webrules[i].rules.length;for(var c=0;c<d;c++){if(_agile_webrules[i].rules[c].LHS=="tags"){if(_agile_webrules[i].rules[c].CONDITION=="EQUALS"){webrules.tags_in=_agile_webrules[i].rules[c].RHS.replace(", ",",").split(",")}if(_agile_webrules[i].rules[c].CONDITION=="NOTEQUALS"){webrules.tags_out=_agile_webrules[i].rules[c].RHS.replace(", ",",").split(",")}}if(_agile_webrules[i].rules[c].LHS=="page"){if(_agile_webrules[i].rules[c].CONDITION=="EQUALS"){anon_webrules.page_view_is=_agile_webrules[i].rules[c].RHS}if(_agile_webrules[i].rules[c].CONDITION=="MATCHES"){anon_webrules.page_view_matches=_agile_webrules[i].rules[c].RHS}}if(_agile_webrules[i].rules[c].LHS=="visit"){if(_agile_webrules[i].rules[c].CONDITION=="FIRST_TIME"){anon_webrules.visit_type="first"}if(_agile_webrules[i].rules[c].CONDITION=="REPEAT"){anon_webrules.visit_type="repeat"}}if(_agile_webrules[i].rules[c].LHS=="referrer"){if(_agile_webrules[i].rules[c].CONDITION=="EQUALS"){anon_webrules.referrer_is=_agile_webrules[i].rules[c].RHS}if(_agile_webrules[i].rules[c].CONDITION=="MATCHES"){anon_webrules.referrer_matches=_agile_webrules[i].rules[c].RHS}}if(_agile_webrules[i].rules[c].LHS=="tags_time"&&_agile_webrules[i].rules[c].CONDITION=="EQUALS"){webrules.tags_time={};if(_agile_webrules[i].rules[c].nested_condition=="BETWEEN"){webrules.tags_time.tags=_agile_webrules[i].rules[c].RHS.replace(", ",",").split(",");webrules.tags_time.time_min=_agile_webrules[i].rules[c].nested_lhs;webrules.tags_time.time_max=_agile_webrules[i].rules[c].nested_rhs;webrules.tags_time.condition=_agile_webrules[i].rules[c].nested_condition}if(_agile_webrules[i].rules[c].nested_condition=="BEFORE"||_agile_webrules[i].rules[c].nested_condition=="AFTER"||_agile_webrules[i].rules[c].nested_condition=="EQUALS"||_agile_webrules[i].rules[c].nested_condition=="NEXT"||_agile_webrules[i].rules[c].nested_condition=="LAST"){webrules.tags_time.tags=_agile_webrules[i].rules[c].RHS.replace(", ",",").split(",");webrules.tags_time.time=_agile_webrules[i].rules[c].nested_lhs;webrules.tags_time.condition=_agile_webrules[i].rules[c].nested_condition}}if(_agile_webrules[i].rules[c].LHS=="created_time"){webrules.contact_time={};if(_agile_webrules[i].rules[c].CONDITION=="BEFORE"||_agile_webrules[i].rules[c].CONDITION=="AFTER"||_agile_webrules[i].rules[c].CONDITION=="ON"||_agile_webrules[i].rules[c].CONDITION=="LAST"||_agile_webrules[i].rules[c].CONDITION=="NEXT"){webrules.contact_time.time=_agile_webrules[i].rules[c].RHS;webrules.contact_time.condition=_agile_webrules[i].rules[c].CONDITION}if(_agile_webrules[i].rules[c].CONDITION=="BETWEEN"){webrules.contact_time.time_max=_agile_webrules[i].rules[c].RHS_NEW;webrules.contact_time.time_min=_agile_webrules[i].rules[c].RHS;webrules.contact_time.condition=_agile_webrules[i].rules[c].CONDITION}}if(_agile_webrules[i].rules[c].LHS=="title"||_agile_webrules[i].rules[c].LHS=="company"||_agile_webrules[i].rules[c].LHS=="owner_id"){var b={};b.name=_agile_webrules[i].rules[c].LHS;b.value=_agile_webrules[i].rules[c].RHS;if(_agile_webrules[i].rules[c].CONDITION=="EQUALS"){if(!webrules.contact_properties_in){webrules.contact_properties_in=[]}webrules.contact_properties_in.push(b)}if(_agile_webrules[i].rules[c].CONDITION=="NOTEQUALS"){if(!webrules.contact_properties_out){webrules.contact_properties_out=[]}webrules.contact_properties_out.push(b)}}}perform_actions(e)},error:function(){console.log("error")}})},150)}function perform_actions(B,k){_agile_webrules=B;console.log(_agile_webrules);var n=_agile_webrules.length;for(var p=0;p<n;p++){var w={};var z={};var A={};var d={};var c;var b;var s={};var g={};var v=[];var q=[];var y=[];var m=[];var f;var o;console.log(_agile_webrules[p]);var h=_agile_webrules[p].actions.length;console.log();console.log(h);console.log(B);for(var j=0;j<h;j++){console.log(_agile_webrules[p].actions[j]);if(_agile_webrules[p].actions[j].action=="MODAL_POPUP"){if(_agile_webrules[p].actions[j].popup_pattern=="confirmation"){d.show_btn_cancel=true;A.title=_agile_webrules[p].actions[j].title;A.contents=_agile_webrules[p].actions[j].popup_text}if(_agile_webrules[p].actions[j].popup_pattern=="information"){d.show_btn_cancel=false;A.title=_agile_webrules[p].actions[j].title;A.contents=_agile_webrules[p].actions[j].popup_text;d.hideHeader=false}if(_agile_webrules[p].actions[j].popup_pattern=="form"){d.form_id=_agile_webrules[p].actions[j].title;d.hideHeader=true;d.show_btn_cancel=true}if(_agile_webrules[p].actions[j].popup_pattern=="custom_html"){var x=document.createElement("div");
x.innerHTML=_agile_webrules[p].actions[j].popup_text;var B=x.childNodes[0].nodeValue;if(B){A.contents=B}else{A.contents=x.innerHTML}d.hideHeader=true;d.hideFooter=true}d.btn_ok="Subscribe";d.btn_cancel="Cancel";d.width=275;d.overlayOpacity=0.6;d.onAppend=function(){document.id("simple-modal").fade("hide");setTimeout((function(){document.id("simple-modal").fade("show")}),200);var e=new Fx.Tween(document.id("simple-modal"),{duration:0,link:"cancel",property:"top"}).start(-400,150)};c=function(){test("this_is_modal_callback")}}console.log(_agile_webrules[p].actions[j].action);if(_agile_webrules[p].actions[j].action=="CORNER_NOTY"&&_agile_webrules[p].actions[j].popup_pattern=="information"){if(_agile_webrules[p].actions[j].position=="RIGHT_BOTTOM"){g.position="bottomRight"}if(_agile_webrules[p].actions[j].position=="RIGHT_TOP"){g.position="topRight"}if(_agile_webrules[p].actions[j].position=="LEFT_BOTTOM"){g.position="bottomLeft"}if(_agile_webrules[p].actions[j].position=="LEFT_TOP"){g.position="topLeft"}if(_agile_webrules[p].actions[j].position=="TOP"){g.position="top"}if(_agile_webrules[p].actions[j].position=="BOTTOM"){g.position="bottom"}s=_agile_webrules[p].actions[j].popup_text;g.theme="defaultTheme";g.dismiss_queue="true";g.type="information";b=function(){test("this_is_noty_callback")}}if(_agile_webrules[p].actions[j].action=="ASSIGN_CAMPAIGN"){v.push(_agile_webrules[p].actions[j].RHS)}if(_agile_webrules[p].actions[j].action=="UNSUBSCRIBE_CAMPAIGN"){q.push(_agile_webrules[p].actions[j].RHS)}if(_agile_webrules[p].actions[j].action=="ADD_TAG"){y.push(_agile_webrules[p].actions[j].popup_pattern)}if(_agile_webrules[p].actions[j].action=="REMOVE_TAG"){m.push(_agile_webrules[p].actions[j].popup_pattern)}if(_agile_webrules[p].actions[j].action=="ADD_SCORE"){f=_agile_webrules[p].actions[j].popup_pattern}if(_agile_webrules[p].actions[j].action=="SUBTRACT_SCORE"){o=_agile_webrules[p].actions[j].popup_pattern}}if(!k){execute_action(A,d,c,s,g,b,v,q,f,o,y,m);return}perform_action(z,w,A,d,c,s,g,b,v,q,f,o,y,m)}}function test(b){console.log(b)}function chainWebRules(d,e,c,f){var b=$(d).clone();$("#campaign-actions",d).chained($("#action",d),function(){});$("#action-details",d).chained($("#action",d),function(){});$("#WEB_RULE_RHS",d).chained($("#action",d),function(k,h){var g=$("select",$(h));if(e){$.each(e,function(l,m){if(l=="actions"&&(m[0].action=="ASSIGN_CAMPAIGN"||m[0].action=="UNSUBSCRIBE_CAMPAIGN")){$(g).find("option[value="+m[0].RHS+"]").attr("selected","selected");return false}})}var j=$(".tags",h);if(j.length>0){addTagsDefaultTypeahead(h)}});$("#campaign",d).chained($("#action",d));$("#possition",d).chained($("#action",d));$("#timer",d).chained($("#delay",d));$("#delay",d).chained($("#action",d));$("#noty-message",d).chained($("#action",d),function(g,h){var j=$("select",g).val();$(h).show();console.log(j);if(j=="MODAL_POPUP"||j=="CORNER_NOTY"){if(j=="MODAL_POPUP"){$("#tiny_mce_webrules_link",h).show()}h.find(".web-rule-preview").show();return}h.find(".web-rule-preview").hide()});if(e&&e.actions){deserializeChainedSelect1($(d).find("form"),e.actions,b,e.actions[0])}scramble_input_names($(".reports-condition-table",b))}$(function(){$(".web-rule-multiple-add").die().live("click",function(b){b.preventDefault();var c=$(getTemplate("webrules-add",{})).find(".webrule-actions > div").clone();chainWebRules($(c)[0],undefined,true);$(c).find("i.webrule-multiple-remove").css("display","inline-block");$(".webrule-actions").append(c)});$("i.webrule-multiple-remove").die().live("click",function(b){$(this).closest(".chained-table > div").remove()});$("i.filter-contacts-web-rule-multiple-add").die().live("click",function(b){var c=$(getTemplate("webrules-add",{})).find(".web-rule-contact-condition-table tr").clone();scramble_input_names($(c));$(this).hide();chainFilters(c,undefined,undefined,true);$(c).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(this).parents("tbody").append(c)});$(".web-rule-preview").die().live("click",function(c){c.preventDefault();var b=this;_agile_require_js("https://s3.amazonaws.com/agilewebgrabbers/scripts/agile-webrules-min.js",function(){var e=serializeChainedElement($(b).closest("table"));var d={};d.value=e.popup_text;e.popup_text=d;e.delay="IMMEDIATE";_agile_execute_action(e)})})});function loadTinyMCE(b){var c="height=650, width=800,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes";var d=window.open("cd_tiny_mce.jsp?id="+b,"name",c);if(window.focus){d.focus()}return false}$("#tiny_mce_webrules_link").die().live("click",function(c){c.preventDefault();if($("#tinyMCEhtml_email").val()!==""){if($(".custom_html").length>1){alert("Only one popup is allowed per webrule. You have already set a popup action for this webrule.");$(this).closest(".alert").remove();return}loadTinyMCE("tinyMCEhtml_email");return}var b="height=650, width=800,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes";var d=window.open("templates.jsp?id=tinyMCEhtml_email&t=web_rules","name",b);if(window.focus){d.focus()}return false});function tinyMCECallBack(b,c){$("#"+b).val(c)}function getMergeFields(d){var c={"Select Merge Field":"","First Name":"{{first_name}}","Last Name":"{{last_name}}",Email:"{{email}}",Company:"{{company}}",Title:"{{title}}",Website:"{{website}}",Phone:"{{phone}}",City:"{{city}}",State:"{{state}}",Country:"{{country}}",Zip:"{{zip}}",Domain:"{{domain}}",Address:"{{address}}",Score:"{{score}}","Created Time":"{{created_time}}","Modified Time":"{{modified_time}}","Owner Name":"{{owner_name}}","Owner Email":"{{owner_email}}"};var e=get_webrules_custom_fields();console.log("Custom Fields are");console.log(e);var b=merge_webrules_jsons({},c,e);return b}function get_webrules_custom_fields(){var c=window.location.protocol+"//"+window.location.host;var e=$.ajax({type:"GET",url:c+"/core/api/custom-fields",async:false,dataType:"json"}).responseText;var d=JSON.parse(e);var b={};$.each(d,function(f,g){$.each(g,function(h,j){if(h=="field_label"){b[j]="{{["+j+"]}}"}})});return b}function merge_webrules_jsons(d,c,b){return $.extend(d,c,b)}function enableWebrulesSorting(b){$("#webrule-model-list").append("<tr class='pseduo-row' style='border:none!important;'><td></td><td></td><td></td><td></td><td></td></tr>");head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".webrule-sortable",b).sortable({axis:"y",forcePlaceholderSize:true,placeholder:"<tr><td></td></tr>",handle:".icon-move",containment:"#webrule-model-list",cursor:"move",forceHelperSize:true,scroll:false,items:"> tr",helper:function(f,c){var d=c.children();var g=c.clone();g.children().each(function(e){$(this).width(d.eq(e).width())});return g}});$(".webrule-sortable",b).on("sortstop",function(c,d){var e=[];$(".webrule-sortable > tr",b).each(function(g,h){if(!$(h).hasClass("pseduo-row")){var j=$(h).find(".data").attr("data");var f=App_WebReports.webrules.collection.get(j);f.set({position:g+1},{silent:true});e.push({id:f.get("id"),position:g+1})}});$.ajax({type:"POST",url:"/core/api/webrule/positions",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json"})})})}var TAG_MODEL_VIEW=Backbone.View.extend({events:{"click .delete":"deleteItem","click .edit":"edit","delete-checked .agile_delete":"deleteItem","keypress .edit-input":"renameTag","blur .edit-input":"updateTag",mouseover:"showActionButtons",mouseout:"hideActionButtons","click .details":"showDetails","click #add-new-tag":"addNewTag"},initialize:function(){_.bindAll(this,"render","deleteItem","edit");this.model.bind("destroy",this.close,this);this.model.bind("change",this.render,this)},showDetails:function(d){d.preventDefault();var c=this;var b=$(".details",this.el);$(this.el).attr({rel:"popover","data-original-title":'"'+this.model.get("tag")+'" Stats',"data-content":LOADING_HTML});$(this.el).popover({show:true,"data-container":this.el});$.getJSON("core/api/tags/getstats/"+this.model.get("tag"),function(e){c.model.set("availableCount",e.availableCount);console.log(c.model.toJSON());$(c.el).attr("data-content",c.model.get("availableCount")+" Contacts");$(c.el).popover("show")})},renameTag:function(b){if(b.keyCode==13){$(b.currentTarget).blur()}},updateTag:function(k){if(this.model.get("tag")==this.input.val()){$("#tag-solid-state",this.el).show();$("#editing",this.el).hide();$(this.el).addClass("tag");return}if(!isValidTag(this.input.val(),true)){this.input.val(this.model.get("tag")).focus();return}var f=this.input.val().trim();var c=this.model.get("tag");var j=false;var h={};h.tag=f;var d=isMergeTag(h);var g="";if(d){g='<p>Tag "'+f+'" exists already. Do you want to merge "'+c+'" and "'+f+'" ?</p>'}else{g='<p>Rename tag "'+c+'" to "'+f+'" ?</p>'}var b=this;j=showModalConfirmation("Tag Management Action",g,function(){b.model.url="core/api/tags/bulk/rename?tag="+f;b.model.save([],{success:function(e){if(d){showNotyPopUp("information",'Merging tags "'+c+'" and "'+f+'". This may take a while.  You may see the merged tag on some contacts cc',"top",5000)}else{showNotyPopUp("information",'Renaming tag "'+c+'" to "'+f+'". This may take a while. You may see the renamed tag on some contacts while this happens',"top",5000)}}});if(d){b.remove();return}b.model.set("tag",b.input.val().trim());$(b.el).addClass("tag");if(isValidTag(b.input.val().trim(),false)){$(b.el).removeClass("error")}},function(){b.reset();return},function(){b.reset();return})},reset:function(){$("#tag-solid-state",this.el).show();$("#editing",this.el).hide();$(this.el).addClass("tag")},showActionButtons:function(b){b.preventDefault();$("#actions",this.el).show();$("a",this.el).popover("toggle")},hideActionButtons:function(b){b.preventDefault();$("#actions",this.el).hide();$(this.el).popover("hide")},addNewTag:function(b){b.preventDefault();$("#new_tag_field_block",this.el).show()},deleteItem:function(c){c.preventDefault();var b=this;showModalConfirmation("Tag Management",'<p>Delete "'+this.model.get("tag")+'" tag ?</p>',function(){b.model.url="core/api/tags/bulk/delete?tag="+escape(b.model.get("tag"));
b.model.set({id:b.model.get("tag")});b.model.destroy({success:function(d,e){showNotyPopUp("information",'Deleting tag "'+b.model.get("tag")+'".  You may see the deleted tag on some contacts while this happens',"top",5000)}})})},edit:function(b){b.preventDefault();$("#tag-solid-state",this.el).hide();$(this.el).removeClass("tag");$("#editing",this.el).show();addTagsDefaultTypeahead($("#editing",this.el));this.input.attr("width","100%").focus();this.input.val(this.model.get("tag"))},render:function(b){$(this.el).html(getTemplate(this.options.template,this.model.toJSON()));$(this.el).data(this.model);this.input=$(".edit-input",this.el);return this}});function append_tag_management(b){var f=new TAG_MODEL_VIEW({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"li"});console.log(f);var d=b.get("tag").charAt(0).toUpperCase();console.log($('div[tag-alphabet="'+encodeURI(d)+'"]',this.el));var e=f.render().el;$(e).addClass("tag");var g=b.get("tag");if(!isValidTag(g,false)){$(e).addClass("error")}var c=$('div[tag-alphabet="'+encodeURI(d)+'"] ul',this.el);console.log(c.length);if(c.length>0){$('div[tag-alphabet="'+encodeURI(d)+'"] ul',this.el).append($(e))}else{$(this.model_list_element).append("<div class='clearfix'></div>").append($(e))}}$("#add-new-tag").die().live("click",function(b){b.preventDefault();toggleAddTag(true)});$("#new_tag").die().live("keydown",function(b){console.log(b.which);if(b.which==0){blur_out_input_field(this);return}else{if(b.which!=13){return}}saveTag(this)});function blur_out_input_field(b){var c=$(b).val().trim();if(c==""){toggleAddTag(false);return}saveTag(b)}function toggleAddTag(b){if(b){$("#add-new-tag").hide();$("#new_tag_field_block").show();$("#add_new_tag").removeAttr("disabled");$("#new_tag").focus();console.log($("#add_new_tag").attr("disabled"));return}$("#add-new-tag").show();$("#new_tag_field_block").hide()}$("#add_new_tag").die().live("click",function(c){c.preventDefault();var b=$().val();blur_out_input_field("#new_tag")});function saveTag(g){var f=$(g).val();if($(g).attr("disabled")){return}if(!isValidTag(f,true)){$(g).focus();return}var j=App_Admin_Settings.tagsview1.collection.where({tag:f.trim()});if(j&&j.length>0){var e='<p>Tag "'+f.trim()+'" exists already. Please choose a different name.</p>';var d=this;r=showModalConfirmation("Tag Management Action",e,function(){return},function(){return},function(){return},"Ok");return}var b={};b.tag=f.trim();var h=App_Admin_Settings.tagsview1.collection.where({tag:b.tag});if(h&&h.length>0){return}$(g).attr("disabled","disabled");var c=new BaseModel(b);c.url="core/api/tags";c.save([],{success:function(k){$(g).val("");$(g).removeAttr("disabled");toggleAddTag(false);showNotyPopUp("information",'New tag "'+c.get("tag")+'" created.',"top",5000)}});console.log(App_Admin_Settings);App_Admin_Settings.tagsview1.collection.add(c)}function isValidTag(b,f){var e="\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA793\uA7A0-\uA7AA\uA7F8-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC";var d="^["+e+"]["+e+" 0-9_]*$";var c=new RegExp(d).test(b);if(f&&!c){alert("Tag name should start with an alphabet and can not contain special characters other than underscore and space")}return c}function addTagsDefaultTypeaheadTagManagement(c){var b=[];if(!TAGS){var d=Backbone.Collection.extend({url:"/core/api/tags",sortKey:"tag"});tagsCollection=new d();tagsCollection.fetch({success:function(e){TAGS=tagsCollection.models;addTagsArrayasTypeaheadSource(tagsCollection.toJSON(),c)}});return}addTagsArrayasTypeaheadSourceTagManagement(tagsCollection.toJSON(),c)}function isMergeTag(b){console.log(App_Admin_Settings.tagsview1.collection.where({tag:b.tag}));return(App_Admin_Settings.tagsview1.collection.where({tag:b.tag}).length>0)}function addTagsArrayasTypeaheadSource(c,d){var b=[];$.each(c,function(e,f){b.push(f.tag.toString())});$("input",d).typeahead({source:b}).attr("placeholder","Enter Tag")}function showModalConfirmation(j,g,d,k,c,e,l){if(!e&&!l){e="Yes";l="No"}var f="";var h="";if(e){f='<a href="#" id="confirm" class="action btn btn-primary" action="confirm">'+e+"</a>"}if(l){h='<a  href="#" id="deny" class="btn action" data-dismiss="modal" action="deny">'+l+"</a>"}var b=$('<div id="confirmation" class="modal fade in"><div class="modal-header" ><a href="#" data-dismiss="modal" class="close">&times;</a><h3>'+j+'</h3></div><div class="modal-body">'+g+'</div><div class="modal-footer"><div>'+h+f+"</div></div></div></div>");b.modal("show");b.focus();b.on("hidden",function(m){if(c&&typeof c=="function"){c()}});$(".action",b).click(function(n){n.preventDefault();var m=$(this).attr("action");b.modal("hide");if(m=="confirm"&&d&&typeof d=="function"){d();return}if(k&&typeof k=="function"){k(this)}})}$(function(){$(".report-chorts").die().live("click",function(j){j.preventDefault();var h=$(this).parents("form");if(!isValidForm($(h))){return false}var f=serializeForm($(h).attr("id"));var g=f.report_chart_type;var d="";if(f.tags&&isArray(f.tags)){$.each(f.tags,function(k,e){if(k==0){d+=e}else{d+=", "+e}})}console.log(d);if(g=="GROWTH"){Backbone.history.navigate("report-growth/"+d,{trigger:true})}else{if(g=="FUNNEL"){Backbone.history.navigate("report-funnel/"+d,{trigger:true})}else{if(g=="RATIO"){var c=f.tag1;var b=f.tag2;Backbone.history.navigate("report-ratio/"+c+"/"+b,{trigger:true})}else{if(g=="COHORTS"){var c=f.tag1;var b=f.tag2;Backbone.history.navigate("report-cohorts/"+c+"/"+b,{trigger:true})}}}}})});var REPORT;$(function(){$("#reports-email-now").die().live("click",function(c){c.stopPropagation();var d=$(this).attr("data");var b=$('<div id="report-send-confirmation" class="modal fade in"><div class="modal-header" ><a href="#" data-dismiss="modal" class="close">&times;</a><h3>Send Report</h3></div><div class="modal-body"><p>You are about to send report.</p><p>Do you want to proceed?</p></div><div class="modal-footer"><div><span class="report-message" style="margin-right:5px"></span></div><div><a href="#" id="report-send-confirm" class="btn btn-primary">Yes</a><a  href="#" class="btn close" data-dismiss="modal" >No</a></div></div></div></div>');
b.modal("show");$("#report-send-confirm",b).click(function(e){e.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");$.get("core/api/reports/send/"+d,function(f){console.log("sending email");$save_info=$('<div style="display:inline-block"><small><p class="text-success"><i>Report will be sent shortly</i></p></small></div>');$(".report-message").html($save_info);$save_info.show();setTimeout(function(){(b).modal("hide")},2000)}).fail(function(f){$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+f.responseText+"</i></p></small></div>");$(".report-message").html($save_info);$save_info.show();setTimeout(function(){(b).modal("hide")},2000)})})});$("#campaign_id").die().live("click",function(b){b.preventDefault();b.stopPropagation();$.ajax({url:"/core/api/workflows?page_size=1",type:"GET",dataType:"json",accept:{json:"application/json",xml:"application/xml"},success:function(c){if(c[0]){window.document.location="#email-reports/"+c[0].id;$(window).scrollTop(0)}else{window.document.location="#workflows"}return},error:function(c){alert("error occured Please try again");window.document.location="#reports"}})});$("#report-instant-results").die().live("click",function(b){b.stopPropagation();var c=$(this).attr("data");console.log(c)});$("#frequency").die().live("change",function(c){var b=$("#frequency").val();if(b=="DAILY"){$("#activity_report_weekday").css("display","none");$("#activity_report_day").css("display","none");$("#activity_report_time").css("display","block")}else{if(b=="WEEKLY"){$("#activity_report_day").css("display","none");$("#activity_report_time").css("display","block");$("#activity_report_weekday").css("display","block")}else{if(b=="MONTHLY"){$("#activity_report_weekday").css("display","none");$("#activity_report_time").css("display","block");$("#activity_report_day").css("display","block")}}}});$("#activity_advanced").die().live("click",function(b){b.preventDefault()});$("#activity-advanced-block").live("shown",function(){$("#activity_advanced").html('<span><i class="icon-minus"></i></span> Advanced')});$("#activity-advanced-block").live("hidden",function(){$("#activity_advanced").html('<span><i class="icon-plus"></i></span> Advanced')});$("#report_advanced").die().live("click",function(b){b.preventDefault()});$("#report-advanced-block").live("shown",function(){$("#report_advanced").html('<span><i class="icon-minus"></i></span> Advanced')});$("#report-advanced-block").live("hidden",function(){$("#report_advanced").html('<span><i class="icon-plus"></i></span> Advanced')});$("#duration").die().live("change",function(c){var b=$("#duration").val();if(b=="DAILY"){$("#contact_report_weekday").css("display","none");$("#contact_report_day").css("display","none");$("#contact_report_time").css("display","block")}else{if(b=="WEEKLY"){$("#contact_report_day").css("display","none");$("#contact_report_time").css("display","block");$("#contact_report_weekday").css("display","block")}else{if(b=="MONTHLY"){$("#contact_report_weekday").css("display","none");$("#contact_report_time").css("display","block");$("#contact_report_day").css("display","block")}}}})});function reportsContactTableView(g,h,d){var j=d.options.modelData;var b=j.fields_set;var c=g.toJSON();var k="";var e=d.options.individual_tag_name;var f=d.options.templateKey;$.each(b,function(l,m){if(m.indexOf("custom_")!=-1){m=m.split("custom_")[1];var n=getProperty(c.properties,m);if(!n){n={}}if(isDateCustomField(h,n)){k+=getTemplate("contacts-custom-view-custom-date",n)}else{k+=getTemplate("contacts-custom-view-custom",n)}return}if(m.indexOf("properties_")!=-1){m=m.split("properties_")[1]}k+=getTemplate("contacts-custom-view-"+m,c)});$(("#"+f+"-model-list"),d.el).append("<"+e+">"+k+"</"+e+">");$(("#"+f+"-model-list"),d.el).find("tr:last").data(g)}function deserialize_multiselect(c,b){$("#content").html(b);if(!c.fields_set){return}$.each(c.fields_set,function(d,e){$("#multipleSelect",b).multiSelect("select",e)});$(".ms-selection",b).children("ul").addClass("multiSelect").attr("name","fields_set").attr("id","fields_set").sortable()}function getEpochTimeFromReport(e,n,m){var b=new Array();var l=new Date();var g,h;if(e){b=e.toString().split(":");g=b[0];h=b[1]}if(m=="DAILY"){var f=new Date();var c=f.getDate();f.setDate(c+1);f.setHours(g);f.setMinutes(h);return(f.getTime())/1000}if(m=="WEEKLY"){var f=new Date();var k=f.getDay();var c=f.getDate();if(n>k){c+=(parseInt(n)-k)}else{c=(c-(k-parseInt(n)))+7}f.setDate(c);f.setHours(g);f.setMinutes(h);return(f.getTime())/1000}if(m=="MONTHLY"){var f=new Date();var c=f.getDate();var j=f.getMonth();if(n>c){j=j}else{j=j+1}f.setMonth(j);f.setDate(n);f.setHours(g);f.setMinutes(h);return(f.getTime())/1000}}function getNextMonthEppoch(d,k,j){var b=new Array();var f,g;if(d){b=d.toString().split(":");f=b[0];g=b[1]}var e=new Date();var c=e.getDate();var h=e.getMonth();if(k>c){h=h+1}else{h=h+2}e.setMonth(h);e.setDate(k);e.setHours(f);e.setMinutes(g);return(e.getTime())/1000}function saveActivityReport(d){if($(d).attr("disabled")){return}disable_save_button(d);var b=serializeForm("activityReportsForm");b.activity=$("#activity-type-list").val();b.user_ids=$("#users-list").val();console.log(b);var c=new Backbone.Model();c.url="/core/api/activity-reports";c.save(b,{success:function(f,e){console.log(f);App_Reports.activityReports.collection.add(f);$("#activityReportModal").modal("hide")},error:function(f,e){enable_save_button(d);console.log(e)}})}function updateActivityReport(c){alert(c);var b=App_Reports.activityReports.collection.get(6528900045733888).toJSON();$("#activityReportModal").modal("show");deserializeForm(b,$("#activityReportsForm"));$.each(b.user_ids,function(e,d){$("#users-list").multiSelect("select",d)});$.each(b.activity,function(d,e){$("#activity-type-list").multiSelect("select",e)})}$(function(){$("#activityReportModal").live("hidden.bs.modal",function(b){$("#users-list, #activity-type-list").multiSelect("deselect_all")});$("#activity-reports-email-now").die().live("click",function(d){d.preventDefault();d.stopPropagation();var f=$(this).attr("data");var b=$('<div id="report-send-confirmation" class="modal fade in"><div class="modal-header" ><a href="#" data-dismiss="modal" class="close">&times;</a><h3>Send Report</h3></div><div class="modal-body"><p>You are about to send report.</p><p>Do you want to proceed?</p></div><div class="modal-footer"><div><span class="report-message" style="margin-right:5px"></span></div><div><a href="#" id="report-send-confirm" class="btn btn-primary">Yes</a><a  href="#" class="btn close" data-dismiss="modal" >No</a></div></div></div></div>');b.modal("show");var c=Math.floor(Date.now()/1000);$("#report-send-confirm",b).click(function(e){e.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");$.get("/core/api/activity-reports/email/"+f+"?end_time="+c,function(g){console.log("sending email");$save_info=$('<div style="display:inline-block"><small><p class="text-success"><i>Report will be sent shortly</i></p></small></div>');$(".report-message").html($save_info);$save_info.show();setTimeout(function(){(b).modal("hide")},2000)}).fail(function(g){$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+g.responseText+"</i></p></small></div>");$(".report-message").html($save_info);$save_info.show();setTimeout(function(){(b).modal("hide")},2000)})})});$("#activity-type-list-select-all").die().live("click",function(b){b.preventDefault();$("#activity-type-list").multiSelect("select_all")});$("#activity-type-list-select-none").die().live("click",function(b){b.preventDefault();$("#activity-type-list").multiSelect("deselect_all")});$("#users-list-select-all").die().live("click",function(b){b.preventDefault();$("#users-list").multiSelect("select_all")});$("#users-list-select-none").die().live("click",function(b){b.preventDefault();$("#users-list").multiSelect("deselect_all")})});var App_Contacts,App_Contact_Search,App_Contact_Bulk_Actions,App_Contact_Filters,App_Contact_Views,App_Workflows,App_Deals,App_Admin_Settings,App_Calendar,App_Settings,App_Reports,App_Cases,App_Subscription,App_Visitors,App_WebReports,App_Documents,App_Widgets,App_ShopifyApp,App_Portlets,App_VoiceMailRouter,App_Deal_Details,App_Forms,App_ACL;var Collection_View={};$(function(){App_Contacts=new ContactsRouter();App_Contact_Views=new ContactViewsRouter();App_Contact_Filters=new ContactFiltersRouter();App_Contact_Bulk_Actions=new ContactBulkActionRouter();App_Contact_Search=new ContactSearchRouter();App_Workflows=new WorkflowsRouter();App_Deals=new DealsRouter();App_Admin_Settings=new AdminSettingsRouter();App_Settings=new SettingsRouter();App_Calendar=new CalendarRouter();App_Subscription=new SubscribeRouter();App_Reports=new ReportsRouter();App_Cases=new CasesRouter();App_Visitors=new VisitorsRouter();App_WebReports=new WebreportsRouter();App_Documents=new DocumentsRouter();App_Widgets=new WidgetsRouter();App_Configuration=new AgileConfigRouter();App_Adminpanel=new AdminPanelRouter();App_ReferelRouter=new ReferelRouter();App_Activity_log=new ActivitylogRouter();App_ShopifyApp=new ShopifyRouter();App_Deal_Details=new DealDetailsRouter();App_VoiceMailRouter=new VoiceMailRouter();App_Portlets=new PortletsRouter;App_Tasks=new TaskDetailsRouter();App_Forms=new FormsRouter();App_ACL=new ACLRestriction();Backbone.history.bind("all",currentRoute);Backbone.history.start();checkAndNavigateToSubscription()});var Current_Route;function currentRoute(c){Current_Route=window.location.hash.split("#")[1];if(SCROLL_POSITION){var b=Current_Route;if(!b.match("contact")){SCROLL_POSITION=0}}activateInfiniScroll();SELECT_ALL=false;SUBSCRIBERS_SELECT_ALL=false;if(tour){tour.end();tour=null}if(GLOBAL_WEBRULE_FLAG){_agile_execute_web_rules()}showUpgradeNoty();if(CURRENT_DOMAIN_USER){tight_acl.init_permissions()}}function load_clickdesk_code(){if(CLICKDESK_CODE_LOADED){return}console.log("loading clickdesk..");
CLICKDESK_CODE_LOADED=true;var c=document.createElement("script");c.type="text/javascript";c.async=true;c.src=glcpath+"livechat-new.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(c,b)}function checkAndNavigateToSubscription(){if(IS_NEW_USER&&_plan_on_signup){Backbone.history.navigate("#subscribe-plan",{trigger:true})}};