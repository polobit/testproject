var Ticket_Base_Model=Base_Model_View.extend({events:{"change .ticket_status":"changeStatus","click .ticket_assignee_name":"changeAssignee","change #ticket-assignee":"changeAssignee","click .assign-to-me":"assignToMe","click .remove-date":"removeTicketDuedate","change .ticket_type":"changeTicketType","change .ticket_priority":"changeTicketPriority","click .delete-ticket":"deleteTicket","click .close-current-ticket":"closeTicket","click .show-workflows":"workflows","click #workflows_list li a":"executeWorkflows","click .toggle-timeline":"toggleTimeline","click .toggle-activities-notes":"toggleActivitiesAndNotes","click .contact-deals":"showContactDeals","mouseover .hover-edit":"showEditIcon","mouseout  .hover-edit":"hideEditIcon","click .to-emails":"toEmails","click .clone-filter-ticket-conditions":"cloneTicketFiltersRow","click .remove-filter-ticket-conditions":"removeTicketFiltersRow","click .show-tags-field":"showTagsField","click .remove-ticket-tags":"removeTicketTags","click .remove-ticket-cc-emails":"removeTicketCCEmails","click .add-me-to-cc":"addMeToCC","change .status":"toggleGroupAssigneeFields","click .nt-reqester_email":"showContactTypeAhead","click .toggle-options":"toggleOptions","click .toggle-docs-dropdown":"toggleDocsDropdown","click .add-document":"addDocument","click .cancel-docs-dropdown":"cancelDocsDropdown","click .remove-attachment":"removeAttachment","click .send-reply":"sendReply","click .reply-btn":"repltBtn","click .discard-reply":"discardReply","click .timeline":"renderTicketTimeline","click .canned-messages":"showCannedMessages","click .toggle-favorite":"toggleFavorite","click .toggle-spam":"toggleSpam","click .toggle-widgets":"toggleWidgets",'click [name="save-type"]':"toggleFields",'change [name="filter-collection"]':"changViewName","click #toggle_previous_tickets":"togglePreviousTickets"},changeStatus:function(b){b.preventDefault();var a=$(b.target).val();Tickets_Rest.changeStatus(a)},changeGroup:function(a){a.preventDefault();Tickets.changeGroup(a)},changeAssignee:function(a){a.preventDefault();Tickets_Rest.changeAssignee(a)},assignToMe:function(f){f.preventDefault();var c=App_Ticket_Module.ticketView.model.toJSON().groupID;var d=CURRENT_AGILE_USER.domainUser.id;var a="/core/api/tickets/"+Current_Ticket_ID+"/assign-ticket/"+c+"/"+d;var b={id:Current_Ticket_ID};Tickets.updateModel(a,b,function(e){Ticket_Utils.showNoty("information","Assignee has been changed to "+CURRENT_AGILE_USER.domainUser.name,"bottomRight",5000);$("#ticket-assignee option:selected").attr("selected",false);$("#ticket-assignee").find("optgroup[data-group-id='"+c+"']").find("option[data-assignee-id='"+d+"']").prop("selected",true);$(".assign-to-me").hide()})},addMeToCC:function(a){a.preventDefault();Tickets.addMeToCC()},changeTicketType:function(a){a.preventDefault();Tickets_Rest.changeTicketType(a)},changeTicketPriority:function(a){a.preventDefault();Tickets_Rest.changeTicketPriority(a)},toEmails:function(a){a.preventDefault();Tickets.toEmails()},cloneTicketFiltersRow:function(a){a.preventDefault();Ticket_Filters.cloneTicketFiltersRow(a)},removeTicketFiltersRow:function(a){a.preventDefault();Ticket_Filters.removeTicketFiltersRow(a)},showTagsField:function(a){a.preventDefault();Ticket_Tags.showTagsField()},removeTicketTags:function(a){a.preventDefault();Ticket_Tags.removeTag(a)},removeTicketCCEmails:function(a){a.preventDefault();Tickets.removeCCEmails(a)},removeTicketDuedate:function(a){a.preventDefault();Tickets_Rest.removeDuedate(a)},showCCEmailsField:function(a){a.preventDefault();$("div.form-group.cc_emails_container").show();$("#cc_email_field").focus()},toggleGroupAssigneeFields:function(a){a.preventDefault();var b=($(a.target).val()=="OPEN")?false:true;$(".grp-assigee").attr("disabled",b)},showContactTypeAhead:function(a){a.preventDefault();$("#reqester_email").hide();$("#reqester_email_typeahead").show().val($("#reqester_email").val()).focus()},toggleOptions:function(c){c.preventDefault();var b=$(".d-nt-show");var a=$(".toggle-options").find("i");if(b.is(":visible")){b.hide();a.attr("data-original-title","Show fields");a.removeClass("fa-angle-double-up").addClass("fa-angle-double-down")}else{b.show();a.attr("data-original-title","Hide fields");a.removeClass("fa-angle-double-down").addClass("fa-angle-double-up")}},sendReply:function(a){a.preventDefault();Tickets_Notes.sendReply(a)},repltBtn:function(b){b.preventDefault();var a=$(b.target);Tickets_Notes.repltBtn(a.attr("rel"))},discardReply:function(a){a.preventDefault();Tickets_Notes.discardReply(a)},toggleTimeline:function(b){var a="Show Timeline";if($(".ticket-timeline-container").is(":visible")){App_Ticket_Module.renderNotesCollection(Current_Ticket_ID,$("#notes-collection-container",App_Ticket_Module.ticketView.el),function(){});Tickets.toggleActivitiesUI("show")}else{Ticket_Timeline.render_individual_ticket_timeline();a="Show Comments";Tickets.toggleActivitiesUI("hide")}$(".toggle-timeline").text(a)},toggleActivitiesAndNotes:function(b){var a=$(".toggle-activities-notes").attr("rel");if(a&&a=="notes"){Tickets.toggleActivitiesUI("hide");if($(".ticket-timeline-container").length>0){$(".ticket-timeline-container").find(".activity").show();return}App_Ticket_Module.renderActivitiesCollection(Current_Ticket_ID,$("#notes-collection-container",App_Ticket_Module.ticketView.el),function(){})}else{Tickets.toggleActivitiesUI("show");if($(".ticket-timeline-container").length>0){$(".ticket-timeline-container").find(".activity").hide();return}App_Ticket_Module.renderNotesCollection(Current_Ticket_ID,$("#notes-collection-container",App_Ticket_Module.ticketView.el),function(){})}},showContactDeals:function(d){d.preventDefault();var a=App_Ticket_Module.ticketView.model.toJSON();var c=a.contact.id;if(!c){$("div#contact-deals").html("No Deals Found");return}var b=Backbone.Collection.extend({url:"/core/api/contacts/"+c+"/deals"});new b().fetch({success:function(e){$("div#contact-deals").html(getTemplate("ticket-deals-list",e.toJSON()))}})},renderTicketTimeline:function(a){a.preventDefault();Ticket_Timeline.render_individual_ticket_timeline()},showCannedMessages:function(a){a.preventDefault();Tickets_Notes.showCannedMessages(a)},toggleFavorite:function(a){a.preventDefault();Tickets_Rest.toggleFavorite(a)},toggleSpam:function(a){a.preventDefault();Tickets_Rest.toggleSpam(a)},toggleWidgets:function(a){a.preventDefault();Tickets.toggleWidgets(a)},deleteTicket:function(a){a.preventDefault();Tickets_Rest.deleteTicket()},closeTicket:function(a){a.preventDefault();Tickets_Rest.closeTicket()},workflows:function(a){a.preventDefault();Tickets_Rest.showWorkflows(a)},executeWorkflows:function(a){a.preventDefault();Tickets_Notes.executeWorkflow(a)},showEditIcon:function(a){a.preventDefault();$(a.target).find(".icon-edit").removeClass("hide")},hideEditIcon:function(a){a.preventDefault();$(a.target).find(".icon-edit").addClass("hide")},toggleDocsDropdown:function(a){a.preventDefault();Ticket_Attachments.toggleDocsDropdown()},addDocument:function(a){a.preventDefault();Ticket_Attachments.addDocument()},cancelDocsDropdown:function(a){a.preventDefault();Ticket_Attachments.cancelDocsDropdown()},removeAttachment:function(a){a.preventDefault();Ticket_Attachments.removeAttachment(a)},toggleFields:function(a){Ticket_Custom_Filters.toggleFields()},changViewName:function(a){a.preventDefault();Ticket_Custom_Filters.changViewName()},togglePreviousTickets:function(b){b.preventDefault();var a=App_Ticket_Module.ticketView.model.toJSON();Tickets.togglePreviousTickets(a.requester_email)}});var Helcenter_Events={categorieDelete:function(a){$(".remove_categorie",a).on("click",function(b){b.preventDefault();var c=$(this).data("id");showModalConfirmation("Delete Category","Are you sure you want to delete Category",function(){console.log(c);$.ajax({url:"/core/api/knowledgebase/categorie/"+c,type:"DELETE",contentType:"application/json",success:function(d){model=App_Helpcenter_Module.categoriesCollection.collection.get(c);model.destroy()}})},null,null,"Yes","No")})},articleDelete:function(a){$(".remove_article",a).on("click",function(b){b.preventDefault();var c=$(this).data("id");showModalConfirmation("Delete Article","Are you sure, you want to delete article",function(){console.log(c);$.ajax({url:"/core/api/knowledgebase/article/"+c,type:"DELETE",contentType:"application/json",success:function(d){model=App_Ticket_Module.articlesCollection.collection.get(c);model.destroy()}})},null,null,"Yes","No")})},sectionDelete:function(a){$(".remove_section",a).on("click",function(b){b.preventDefault();var c=$(this).data("id");showModalConfirmation("Delete Section","Are you sure, you want to delete section",function(){console.log(c);$.ajax({url:"/core/api/knowledgebase/section?id="+c,type:"DELETE",contentType:"application/json",success:function(d){model=App_Ticket_Module.sectionsCollection.collection.get(c);model.destroy()}})},null,null,"Yes","No")})}};var Ticket_Attachments={renderExistingDocs:function(b,c){var a=Backbone.Collection.extend({url:"core/api/documents"});var d=new a();d.fetch({success:function(){var f=d.toJSON();f.sort(function(i,h){if(i.name<h.name){return -1}if(h.name<i.name){return 1}return 0});var e="<option value='{{id}}' network_type='{{titleFromEnums network_type}}' file-name='{{name}}' size='{{size}}' url='{{url}}'>{{name}}</option>";var g=Handlebars.compile(e);$("#"+b).empty();$.each(f,function(i,h){$("#"+b).append(g(h))});$("#"+b).append("<option value='new'>"+_agile_get_translated_val("others","upload-new-doc")+"</option>")}})},toggleDocsDropdown:function(){$(".docs-container").css("display","inline");$(".toggle-docs-dropdown").hide();this.renderExistingDocs("choose-document")},addDocument:function(){var b=$("select.choose-document").find(":selected");var a={};a.name=b.attr("file-name");a.url=b.attr("url");a.size=b.attr("size");$("ul.attachments-list").append(getTemplate("ticket-attachment-li",a))},cancelDocsDropdown:function(){$(".toggle-docs-dropdown").show();$(".docs-container").hide()},removeAttachment:function(a){$(a.target).closest("li").remove()
},serializeList:function(a){var c=[];var b=$("#"+a+" ul.attachments-list").map(function(){$.each($(this).children(),function(f,d){var h=$(d);var e={};e.name=h.attr("file-name");e.url=h.attr("url");e.size=h.attr("size");c.push(e)});return{name:"attachments_list",value:c}}).get();return b}};var Ticket_Bulk_Ops={selected_all_filter_tickets:false,selected_ticket_ids:new Array(),initEvents:function(b){var a=$(".tickets-div",b);$("label.select-all",b).off("click","input.select-all");$("label.select-all",b).on("click","input.select-all",function(c){var d=$(this).is(":checked");d?Ticket_Bulk_Ops.checkAllTickets(a):Ticket_Bulk_Ops.clearSelection()});a.off("click",".bulk-ticket-close");a.on("click",".bulk-ticket-close",function(c){c.preventDefault();Ticket_Bulk_Ops.renderTemplate("close-tickets")});a.off("click",".bulk-favorite-tickets");a.on("click",".bulk-favorite-tickets",function(c){c.preventDefault();Ticket_Bulk_Ops.renderTemplate("mark-favorite")});a.off("click",".bulk-spam-tickets");a.on("click",".bulk-spam-tickets",function(c){c.preventDefault();Ticket_Bulk_Ops.renderTemplate("mark-spam")});a.off("click",".bulk-ticket-delete");a.on("click",".bulk-ticket-delete",function(c){c.preventDefault();Ticket_Bulk_Ops.renderTemplate("delete-tickets")});a.off("click","a#select-all-tickets");a.on("click","a#select-all-tickets",function(c){c.preventDefault();Ticket_Bulk_Ops.selected_all_filter_tickets=true;$(".ticket-checkbox").prop("checked",true);$("#tickets-bulk-select").html(getTemplate("ticket-bulk-ops-text",{total_tickets_selected:true}))});a.off("click","a#clear-ticket-selection");a.on("click","a#clear-ticket-selection",function(c){c.preventDefault();Ticket_Bulk_Ops.clearSelection()})},checkAllTickets:function(){$(".each-ticket.ticket-checkbox").each(function(){$(this).prop("checked",true);var a=$(this).data("ticket-id");if(!a){return false}if(Ticket_Bulk_Ops.selected_ticket_ids.indexOf(a)==-1){Ticket_Bulk_Ops.selected_ticket_ids.push(a)}});$(".bulk-action-btn").removeClass("disabled");Ticket_Bulk_Ops.showText()},clearSelection:function(){$(".ticket-checkbox").prop("checked",false);$(".bulk-action-btn").addClass("disabled");$("#tickets-bulk-select").html("");Ticket_Bulk_Ops.selected_all_filter_tickets=false;Ticket_Bulk_Ops.selected_ticket_ids=[]},showText:function(){var a=Ticket_Bulk_Ops.selected_ticket_ids.length;if(a>0){var c=Tickets_Count.ticketsCount[Ticket_Filter_ID],b={};if(a==c){Ticket_Bulk_Ops.selected_all_filter_tickets=true;$(".ticket-checkbox.select-all").prop("checked",true);b.total_tickets_selected=true;b.total_tickets_count=c;$("#tickets-bulk-select").html(getTemplate("ticket-bulk-ops-text",b))}else{if(a==App_Ticket_Module.ticketsCollection.collection.length){b.tickets_count=a;b.total_tickets_count=c;$("#tickets-bulk-select").html(getTemplate("ticket-bulk-ops-text",b))}else{Ticket_Bulk_Ops.selected_all_filter_tickets=false}}$(".bulk-action-btn").removeClass("disabled")}else{Ticket_Bulk_Ops.clearSelection()}},addOrRemoveTicketID:function(b){var c=$(b).data("ticket-id");if($(b).is(":checked")){Ticket_Bulk_Ops.selected_ticket_ids.push(c)}else{var a=Ticket_Bulk_Ops.selected_ticket_ids.indexOf(c);if(a>-1){Ticket_Bulk_Ops.selected_ticket_ids.splice(a,1)}}},getSelectedTickesObj:function(){return Ticket_Bulk_Ops.selected_ticket_ids.toString()},renderTemplate:function(b){if(!App_Ticket_Module.ticketsCollection||App_Ticket_Module.ticketsCollection.collection.length==0){Backbone.history.navigate("tickets",{trigger:true});return}switch(b){case"manage-labels":var a=new Ticket_Base_Model({isNew:true,template:"ticket-bulk-actions-add-labels",url:"/core/api/tickets/bulk-actions/manage-labels",saveCallback:function(){Tickets.renderExistingCollection()},prePersist:function(c){var d={};d.ticketIDs=Ticket_Bulk_Ops.getSelectedTickesObj();if(Ticket_Bulk_Ops.selected_all_filter_tickets){d.conditions=Ticket_Custom_Filters.customFilters}c.set(d,{silent:true})},postRenderCallback:function(c){Ticket_Labels.showSelectedLabels(new Array(),$(c))}});$("#content").html(a.render(true).el);break;case"change-assignee":var a=new Ticket_Base_Model({isNew:true,template:"ticket-bulk-actions-change-assignee",url:"/core/api/tickets/bulk-actions/change-assignee",saveCallback:function(){Tickets.renderExistingCollection()},prePersist:function(c){var d={};d.ticketIDs=Ticket_Bulk_Ops.getSelectedTickesObj();if(Ticket_Bulk_Ops.selected_all_filter_tickets){d.conditions=Ticket_Custom_Filters.customFilters}d.assigneeID=$('[name="groupID"]').find("option:selected").data("assignee-id");c.set(d,{silent:true})},postRenderCallback:function(c){fillSelect("groupID","/core/api/tickets/new-ticket","",function(d){$("#groupID").html(getTemplate("select-assignee-dropdown",d.toJSON()))},"",false,c)}});$("#content").html(a.render().el);break;case"execute-workflows":var a=new Ticket_Base_Model({isNew:true,template:"ticket-bulk-actions-execute-workflow",url:"/core/api/tickets/bulk-actions/execute-workflow",saveCallback:function(){Tickets.renderExistingCollection()},prePersist:function(c){var d={};d.ticketIDs=Ticket_Bulk_Ops.getSelectedTickesObj();if(Ticket_Bulk_Ops.selected_all_filter_tickets){d.conditions=Ticket_Custom_Filters.customFilters}c.set(d,{silent:true})},postRenderCallback:function(d){var c='<option value="{{id}}" {{#is_disabled}}disabled{{/is_disabled}}>{{name}}</option>';fillSelect("workflowID","/core/api/workflows","",null,c,false,d)}});$("#content").html(a.render().el);break;case"close-tickets":var a=new Ticket_Base_Model({isNew:true,template:"ticket-bulk-actions-close-tickets",url:"/core/api/tickets/bulk-actions/close-tickets",saveCallback:function(){Ticket_Bulk_Ops.clearSelection();Ticket_Utils.resetModalSettings($("#ticketsModal"))},prePersist:function(c){var d={};d.ticketIDs=Ticket_Bulk_Ops.getSelectedTickesObj();if(Ticket_Bulk_Ops.selected_all_filter_tickets){d.conditions=Ticket_Custom_Filters.customFilters}c.set(d,{silent:true})}});$("#ticketsModal").html(a.render().el).modal("show");break;case"delete-tickets":var a=new Ticket_Base_Model({isNew:true,template:"ticket-bulk-actions-delete-tickets",url:"/core/api/tickets/bulk-actions/delete-tickets",saveCallback:function(){if(Ticket_Bulk_Ops.selected_all_filter_tickets){Tickets_Count.ticketsCount[Ticket_Filter_ID]=0}else{Tickets_Count.ticketsCount[Ticket_Filter_ID]=Tickets_Count.ticketsCount[Ticket_Filter_ID]-Ticket_Bulk_Ops.selected_ticket_ids.length}Tickets_Rest.removeTicketsFromCollection(Ticket_Bulk_Ops.getSelectedTickesObj());Ticket_Bulk_Ops.clearSelection();Ticket_Utils.resetModalSettings($("#ticketsModal"))},prePersist:function(c){var d={};d.ticketIDs=Ticket_Bulk_Ops.getSelectedTickesObj();if(Ticket_Bulk_Ops.selected_all_filter_tickets){d.conditions=Ticket_Custom_Filters.customFilters}c.set(d,{silent:true})}});$("#ticketsModal").html(a.render().el).modal("show");break;case"mark-spam":var a=new Ticket_Base_Model({isNew:true,template:"ticket-bulk-actions-spam-tickets",url:"/core/api/tickets/bulk-actions/spam-tickets",saveCallback:function(){Ticket_Bulk_Ops.clearSelection();Ticket_Utils.resetModalSettings($("#ticketsModal"))},prePersist:function(c){var d={};d.ticketIDs=Ticket_Bulk_Ops.getSelectedTickesObj();if(Ticket_Bulk_Ops.selected_all_filter_tickets){d.conditions=Ticket_Custom_Filters.customFilters}c.set(d,{silent:true})}});$("#ticketsModal").html(a.render().el).modal("show");break;case"mark-favorite":var a=new Ticket_Base_Model({isNew:true,template:"ticket-bulk-actions-favorite-tickets",url:"/core/api/tickets/bulk-actions/favorite-tickets",saveCallback:function(){Ticket_Bulk_Ops.clearSelection();Ticket_Utils.resetModalSettings($("#ticketsModal"))},prePersist:function(c){var d={};d.ticketIDs=Ticket_Bulk_Ops.getSelectedTickesObj();if(Ticket_Bulk_Ops.selected_all_filter_tickets){d.conditions=Ticket_Custom_Filters.customFilters}c.set(d,{silent:true})}});$("#ticketsModal").html(a.render().el).modal("show");break}},ajax_call:function(a,b,c){$.ajax({url:a,type:"POST",data:b,ContentType:"application/x-www-form-urlencoded",success:function(d){if(c){c(d)}}})}};var Ticket_Canned_Response={cannedResponseCollection:undefined,fetchCollection:function(b){if(this.cannedResponseCollection){if(b){b(this.cannedResponseCollection)}return}var a=Backbone.Collection.extend({url:"/core/api/tickets/canned-messages"});new a().fetch({success:function(c){console.log("cannedResponses collection length: "+c.length);Ticket_Canned_Response.cannedResponseCollection=c;if(b){b(c)}}})},};function initTicketCannedResponseEvents(a){$("#canned-response-merge-fields",a).on("click","li > a",function(d){var c=$(this).attr("data-field-val");var b=$("#canned-response-message",a);b.val(b.val()+"{{"+c+"}}")})}var Ticket_Custom_Filters={customFilters:new Array(),filters:[],reset:function(){this.customFilters=new Array()},initEvents:function(){var c=$("#custom-filters-container");Ticket_Utils.loadDateChartAndDatePicker(function(){var d=$(".due-date-input",c);d.datepicker({drops:"down",dateFormat:CURRENT_USER_PREFS.dateFormat,autoclose:true}).on("changeDate",function(e){$("#clear-due-date").show();d.blur();d.datepicker("hide");Ticket_Custom_Filters.changeDueDate(Date.parse(d.val()).getTime())});$(".daterangepicker").remove();$("#created-date-input").daterangepicker({drops:"up",locale:{applyLabel:"Apply",clearLabel:"Clear",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",daysOfWeek:$.fn.datepicker.dates.en.daysExactMin,monthNames:$.fn.datepicker.dates.en.months,firstDay:parseInt(CALENDAR_WEEK_START_DAY)}},function(h,e){var f=$("#created-date-input").val();if(!f){return}var g=f.split("-");$("#clear-created-date").show();Ticket_Custom_Filters.changeCreatedDate(g[0],g[1])})});var b=[];c.off("click","a#clear-due-date");c.on("click","a#clear-due-date",function(d){$(this).hide();$("input.due-date-input").val("");Ticket_Custom_Filters.changeDueDate()});c.off("click","a#clear-created-date");c.on("click","a#clear-created-date",function(d){$(this).hide();$("input.created-date-input").val("");Ticket_Custom_Filters.changeCreatedDate()});c.off("click","a.choose-due-date");
c.on("click","a.choose-due-date",function(e){var f=$(this).data("value"),d=new Date();var g=$(".due-date-input",c);$("#clear-due-date").show();g.blur();g.datepicker("hide");switch(f){case"overdue":d.setDate(d.getDate());break;case"tomorrow":d.setDate(d.getDate()+1);break;case"next_two_days":d.setDate(d.getDate()+2);break;case"next_three_days":d.setDate(d.getDate()+3);break;case"next_five_days":d.setDate(d.getDate()+5);break}g.val(d.format("mm/dd/yyyy"));Ticket_Custom_Filters.changeDueDate(d.getTime())});c.off("click",".save-new-filter");c.on("click",".save-new-filter",function(f){var d=new Ticket_Base_Model({isNew:true,template:"ticket-create-filter-modal",url:"/core/api/tickets/filters",saveCallback:function(e){$("#ticketsModal").modal("hide");App_Ticket_Module.ticketFiltersList.collection.add(e);App_Ticket_Module.ticketsByFilter(e.id);$("body").removeClass("modal-open").animate({scrollTop:0},"slow")},prePersist:function(g){var h={};h.conditions=Ticket_Custom_Filters.customFilters;var e=g.toJSON();if(e["save-type"]=="replace"){h.id=$('[name="filter-collection"]').val()}g.set(h,{silent:true})}});$("#ticketsModal").html(d.render().el).modal("show")});c.off("click",".clear-custom-filter");c.on("click",".clear-custom-filter",function(d){d.preventDefault();if(!Ticket_Custom_Filters.isFilterChanged()){return}App_Ticket_Module.ticketsByFilter(Ticket_Filter_ID);Ticket_Bulk_Ops.clearSelection()});var a=$(".chosen-select");a.off("change");a.on("change",function(d,f){if(f&&f.deselected){for(var e=0;e<Ticket_Custom_Filters.customFilters.length;e++){var g=Ticket_Custom_Filters.customFilters[e];if(g.LHS!="labels"||g.RHS!=f.deselected){continue}Ticket_Custom_Filters.customFilters.splice(e,1);break}}else{var g={};g.LHS="labels";g.RHS=f.selected;g.CONDITION="TICKET_LABEL_IS";Ticket_Custom_Filters.customFilters.push(g)}Tickets.fetchTicketsCollection()})},initCheckboxEvents:function(){var a=$("#custom-filters-container");$('[type="checkbox"]',a).off("change");$('[type="checkbox"]',a).on("change",function(b){var d=$(this).is(":checked");var c=$(this).attr("name");if(d){var f={};f.LHS=c;f.RHS=$(this).val();switch(f.LHS){case"status":f.CONDITION="TICKET_STATUS_IS";break;case"priority":f.CONDITION="TICKET_PRIORITY_IS";break;case"assignee_id":case"group_id":f.CONDITION="EQUALS";break;case"ticket_type":f.CONDITION="TICKET_TYPE_IS";break;case"ticket_favorite":case"ticket_spam":f.CONDITION="TICKET_IS";break}Ticket_Custom_Filters.customFilters.push(f)}else{for(var e=0;e<Ticket_Custom_Filters.customFilters.length;e++){var f=Ticket_Custom_Filters.customFilters[e];if(f.LHS==c&&f.RHS==$(this).val()){Ticket_Custom_Filters.customFilters.splice(e,1);break}}}Tickets.fetchTicketsCollection()})},renderLayout:function(){getTemplate("ticket-custom-filters",{},undefined,function(b){if(!b){return}var a=$("#custom-filters-container");a.html($(b));Ticket_Labels.loadChosenLibrary(function(){Ticket_Labels.fetchCollection(function(e){var d="";$.each(e.toJSON(),function(g,f){d+=getTemplate("ticket-label-option",f)});var c=$(".chosen-select");c.html(d);c.chosen({no_results_text:"No labels found"});Ticket_Custom_Filters.initEvents()})});Ticket_Utils.fetchAssignees(function(){var c=new Base_Collection_View({data:Assingees_Collection.collection.toArray(),url:"/core/api/users/partial",templateKey:"ticket-lhs-assignees",individual_tag_name:"div"});$(".assignee-select",a).html(c.render(true).el);Ticket_Utils.fetchGroups(function(){var d=new Base_Collection_View({data:Groups_Collection.collection.toArray(),url:"/core/api/tickets/groups",templateKey:"ticket-lhs-groups",individual_tag_name:"div"});$(".group-select",a).html(d.render(true).el);Ticket_Custom_Filters.checkSelectedConditions();Ticket_Custom_Filters.initCheckboxEvents()})})})},checkSelectedConditions:function(){if(Ticket_Custom_Filters.customFilters.length==0){var a=App_Ticket_Module.ticketFiltersList.collection.get(Ticket_Filter_ID).toJSON();var e=$.extend(true,{},a);Ticket_Custom_Filters.customFilters=e.conditions}for(var c=0;c<Ticket_Custom_Filters.customFilters.length;c++){var g=Ticket_Custom_Filters.customFilters[c];switch(g.LHS){case"labels":var b=$(".chosen-select");var d=b.find('option[value="'+g.RHS+'"]');d.attr("selected","selected");b.trigger("chosen:updated");break;case"status":if(g.CONDITION=="TICKET_STATUS_IS"){$('input[value="'+g.RHS+'"]').attr("checked","checked")}break;case"priority":if(g.CONDITION=="TICKET_PRIORITY_IS"){$('input[value="'+g.RHS+'"]').attr("checked","checked")}break;case"ticket_type":if(g.CONDITION=="TICKET_TYPE_IS"){$('input[value="'+g.RHS+'"]').attr("checked","checked")}break;case"assignee_id":if(g.CONDITION=="EQUALS"){if(g.RHS=="0"){g.RHS=CURRENT_DOMAIN_USER.id}$('input[value="'+g.RHS+'"]').attr("checked","checked")}break;case"group_id":if(g.CONDITION=="EQUALS"){$('input[value="'+g.RHS+'"]').attr("checked","checked")}break;case"ticket_favorite":if(g.CONDITION=="TICKET_IS"){$('input[name="ticket_favorite"]').attr("checked","checked")}break;case"ticket_spam":if(g.CONDITION=="TICKET_IS"){$('input[name="ticket_spam"]').attr("checked","checked")}case"due_date":if(g.CONDITION=="IS_LESS_THAN"){$('input[name="due-date-input"]').val(new Date(parseInt(g.RHS)*1000).format(CURRENT_USER_PREFS.dateFormat));$("#clear-due-date").show()}case"created_between":if(g.CONDITION=="BETWEEN"){var f=new Date(parseInt(g.RHS)*1000).format(CURRENT_USER_PREFS.dateFormat)+" - "+new Date(parseInt(g.RHS_NEW)*1000).format(CURRENT_USER_PREFS.dateFormat);$('input[name="created-date-input"]').val(f);$("#clear-created-date").show()}}}},changeDueDate:function(c){for(var b=0;b<Ticket_Custom_Filters.customFilters.length;b++){var d=Ticket_Custom_Filters.customFilters[b];if(d.LHS!="due_date"){continue}Ticket_Custom_Filters.customFilters.splice(b,1)}if(c){var a=new Date(c);a.setHours(23);a.setMinutes(59);a.setSeconds(59);var d={};d.LHS="due_date";d.CONDITION="IS_LESS_THAN";d.RHS=Math.floor(a.getTime()/1000);Ticket_Custom_Filters.customFilters.push(d)}Tickets.fetchTicketsCollection()},changeCreatedDate:function(d,a){for(var b=0;b<Ticket_Custom_Filters.customFilters.length;b++){var c=Ticket_Custom_Filters.customFilters[b];if(c.LHS!="created_between"){continue}Ticket_Custom_Filters.customFilters.splice(b,1);break}if(d&&a){var c={};c.CONDITION="BETWEEN";c.LHS="created_between";c.RHS=Math.floor(new Date(d).getTime()/1000);c.RHS_NEW=Math.floor(new Date(a).getTime()/1000);c.RHS_NEW+=86400;Ticket_Custom_Filters.customFilters.push(c)}Tickets.fetchTicketsCollection()},isFilterChanged:function(){var b=App_Ticket_Module.ticketFiltersList.collection.get(Ticket_Filter_ID).toJSON();var f=b.conditions;if(f.length!=Ticket_Custom_Filters.customFilters.length){return true}for(var e=0;e<f.length;e++){var g=f[e];var a=false;for(var d=0;d<Ticket_Custom_Filters.customFilters.length;d++){var c=Ticket_Custom_Filters.customFilters[d];if(g.CONDITION==c.CONDITION&&g.RHS==c.RHS){a=true}}if(!a){return true}}return false},toggleFields:function(){$("div.choose-filter").toggle();$("div.update-name").toggle()},changViewName:function(){var a=$('[name="filter-collection"] option:selected').text();$('input[name="name"]',$("form#saveFilterForm")).val(a)}};var Ticket_Filters={initChaining:function(b,d){var a=$(b).clone();var e,f,c;e=$("#LHS",b);f=$("#condition",b);c=$("#RHS",b);c.chained(f,function(i,g){var h=$(i).find("option:selected");var j=$(":selected",e).attr("placeholder");$("select",g).each(function(k,l){if($("option",l).length==0){$(this).remove()}});if(j){$("input",g).attr("placeholder",j)}});f.chained(e);if(d&&d.conditions){deserializeChainedSelect(b,d.conditions,a)}else{if(d){deserializeChainedSelect(b,d,a)}}if($(":selected",e).val()&&($(":selected",e).val()).indexOf("tags")!=-1){addTagsDefaultTypeahead(c)}},cloneTicketFiltersRow:function(a){getTemplate("ticket-filter-add-edit",{},undefined,function(b){if(!b){return}var c=$(b).find(".ticket-filter-conditions-table tr").clone();scramble_input_names($(c));Ticket_Filters.initChaining(c);$(c).find("i.remove-filter-ticket-conditions").show();$(".ticket-filter-conditions-table").find("tbody").append(c)},null)},removeTicketFiltersRow:function(b){var a=$(b.currentTarget);a.closest("tr").remove()},fetchFiltersCollection:function(b){var a=true;App_Ticket_Module.ticketFiltersList=new Base_Collection_View({url:"/core/api/tickets/filters",sortKey:"updated_time",descending:true,customLoader:true,preserveAcrossRoutes:true,customLoaderTemplate:"ticket-filters-loader",templateKey:"ticket-filters-list",individual_tag_name:"li",postRenderCallback:function(d){Tickets_Count.fetchFilterTicketsCount();if(!App_Ticket_Module.ticketFiltersList.collection||App_Ticket_Module.ticketFiltersList.collection.length==0){$("div.tickets-collection-pane").html(getTemplate("ticket-collection"));return}if(!Ticket_Filter_ID){Ticket_Filter_ID=App_Ticket_Module.ticketFiltersList.collection.at(0).id}var c="#tickets/filter/"+Ticket_Filter_ID;Backbone.history.navigate(c,{trigger:false});if(a){a=false;if(b){b()}}}});App_Ticket_Module.ticketFiltersList.collection.fetch();$("div.filters-drp-down").html(App_Ticket_Module.ticketFiltersList.el)},renderFiltersCollection:function(a){$("div.filters-drp-down").html(App_Ticket_Module.ticketFiltersList.render(true).el);if(a){a()}},updateFilterName:function(){var a={};if(!Ticket_Filter_ID){a=App_Ticket_Module.ticketFiltersList.collection.at(0).toJSON();Ticket_Filter_ID=!Ticket_Filter_ID?a.id:Ticket_Filter_ID}else{a=App_Ticket_Module.ticketFiltersList.collection.get(Ticket_Filter_ID).toJSON()}$("ul.ticket-types").find("li").removeClass("active");$(".filter-name-btn").text(a.name);$('a[filter-id="'+Ticket_Filter_ID+'"]').closest("li").addClass("active")},getCurrentFilterName:function(){return App_Ticket_Module.ticketFiltersList.collection.get(Ticket_Filter_ID).toJSON().name}};var Current_Ticket_ID=null;var Current_Ticket_Contact=null;var Ticket_Filter_ID=null;var Tickets_Util={};var Sort_By="-";var Sort_Field="last_updated_time";var Ticket_Position=null;var Popover_Function=undefined;var Helpdesk_Enabled=false;
var Assingees_Collection=null,Groups_Collection=null;var Ticket_Groups={};var Ticket_Labels={labelsCollection:undefined,initChoosenSelect:function(a,b){this.loadChosenLibrary(function(){var c=$(".chosen-select",a);c.chosen({no_results_text:"No labels found"});if(b){c.off("change");c.on("change",function(d,e){if(e&&e.deselected){Ticket_Labels.updateLabel(e.deselected,"remove");return}Ticket_Labels.updateLabel(e.selected,"add")})}})},fetchCollection:function(b){if(this.labelsCollection&&this.labelsCollection.length>0&&this.labelsCollection.toJSON()&&b){b(this.labelsCollection);return}var a=Backbone.Collection.extend({url:"/core/api/tickets/labels"});new a().fetch({success:function(c){console.log("Label collection length: "+c.length);Ticket_Labels.labelsCollection=c;if(b){b(c)}}})},showSelectedLabels:function(c,a,b){this.fetchCollection(function(){Ticket_Labels.prepareOptionsList(c,a,b)});return},prepareOptionsList:function(e,b,d){if(!this.labelsCollection){return}var a={};var c="";$.each(this.labelsCollection.toJSON(),function(f,g){if($.inArray(g.id,e)!=-1){c+="<option value='"+g.id+"' selected='selected'>"+g.label+"</option>"}else{c+="<option value='"+g.id+"'>"+g.label+"</option>"}});$(".chosen-select",b).html(c);this.initChoosenSelect(b,d)},updateLabel:function(b,d,e){if(!b||!Current_Ticket_ID||Current_Route.indexOf("edit-canned-response")!=-1){if(e){e()}return}var a="/core/api/tickets/"+Current_Ticket_ID+"/activity/update-labels";var c={command:d,labelID:b,id:Current_Ticket_ID};Tickets.updateModel(a,c,function(h){var i=$('.chosen-select option[value="'+c.labelID+'"]',App_Ticket_Module.ticketView.el).text();if(App_Ticket_Module.ticketsCollection){var f=App_Ticket_Module.ticketsCollection.collection.get(Current_Ticket_ID);var g=f.get("labels");if(!g){g=[]}if(d=="add"){g.push(parseInt(b))}else{g=jQuery.grep(g,function(k){return k!=b})}f.set({labels:g},{silent:true})}var j="Label "+i+" has been deleted from ticket";if(c.command=="add"){j="Label "+i+" has been added to ticket"}Ticket_Utils.showNoty("information",j,"bottomRight",5000);if(e){e()}})},loadChosenLibrary:function(a){head.js("/flatfull/css/misc/chosen.css","/lib/chosen.jquery.min.js",function(){if(a){a()}})}};var Tickets_Notes={sendReply:function(g){g.preventDefault();var f=$(g.target);$("#send-reply").validate({debug:true,highlight:function(h,e){$(h).closest("div").addClass("has-error")},unhighlight:function(h,e){$(h).closest("div").removeClass("has-error")},errorPlacement:function(e,h){$(h).closest("div").addClass("has-error")}});if(!$("#send-reply").valid()){if($(g.target).hasClass("forward")){this.forwardTicket(c,f,false)}return}var c=serializeForm("send-reply");c.html_text=c.html_text.trim()+"\r\n\r\n"+CURRENT_USER_PREFS.signature;if($(g.target).hasClass("forward")){this.forwardTicket(c,f,true);return}var b=$(g.target).hasClass("private")?"PRIVATE":"PUBLIC";c.note_type=b;var d=$(g.target).hasClass("close-ticket");if(d){c.close_ticket="true"}disable_save_button(f);var a=new BaseModel();a.url="/core/api/tickets/notes/"+Current_Ticket_ID;a.save(c,{success:function(j){enable_save_button(f);var i=j.toJSON();$("textarea#reply_textarea").val("");Tickets.remove_draft_message(Current_Ticket_ID,((b=="PUBLIC")?"reply":"comment"));if(i.note_type=="PRIVATE"){Ticket_Utils.showNoty("information","Comment has been added"+((d)?" and status changed to Closed":""),"bottomRight",5000)}else{var m="Comment has been added and ticket status changed to "+((d)?"Closed":"Pending");Ticket_Utils.showNoty("information",m,"bottomRight",5000)}var l={};if(d){$(".ticket_status").val("CLOSED");l.status="CLOSED";$(".remove-date").css("display","none");$("#ticket_change_sla").attr("disabled","disabled")}else{$("#ticket_change_sla").removeAttr("disabled")}if(App_Ticket_Module.ticketsCollection){var h=App_Ticket_Module.ticketsCollection.collection.get(Current_Ticket_ID);if(h){if(i.note_type!="PRIVATE"){var k=new Date().getTime();l.status=(d)?"CLOSED":"PENDING";l.last_updated_time=k;l.closed_time=(d)?k:"";l.last_reply_text=i.plain_text;l.last_updated_by="AGENT";l.user_replies_count=i.user_replies_count}h.set(l,{silent:true})}var e=$(".navigation .next-ticket").attr("href");if(e){Backbone.history.navigate(e,{trigger:true})}else{Tickets.renderExistingCollection()}return}Tickets.renderExistingCollection();return},error:function(h,e){$(".error-msg").html(e.responseText);enable_save_button(f);setTimeout(function(){$(".error-msg").html("")},3000)}})},forwardTicket:function(b,a,c){var d=[];$("ul.forward-emails > li").each(function(f){var e=$(this).find("a.anchor").text();if(e){d.push(e)}});if(d.length==0){$("ul.forward-emails").addClass("ticket-input-border-error");return}if(!c){return}b.email=d.join();$.ajax({url:"/core/api/tickets/forward-ticket",method:"POST",data:b,contentType:"application/x-www-form-urlencoded",accept:"application/json",success:function(f){Ticket_Utils.showNoty("information","Ticket has been forwarded","bottomRight",5000);$("textarea#reply_textarea").val("");Tickets.remove_draft_message(Current_Ticket_ID,"forward");var e=$(".navigation .next-ticket").attr("href");if(e){Backbone.history.navigate(e,{trigger:true});return}Tickets.renderExistingCollection()}})},repltBtn:function(c,a){var b=App_Ticket_Module.ticketView.model;var d=b.toJSON();d.reply_type=(c)?c:"reply";if(d.reply_type=="forward"){d.notes=this.constructTextComments(App_Ticket_Module.notesCollection.collection.toJSON())}if(Ticket_Canned_Response.cannedResponseCollection&&Ticket_Canned_Response.cannedResponseCollection.toJSON()){d.canned_responses=Ticket_Canned_Response.cannedResponseCollection.toJSON()}d.label_matched_canned_responses=this.getMatchedCannedResponses(d.labels);d.draft_message=(Tickets.get_draft_message())[d.id];var e=(a)?$("#send-reply-container",a):$("#send-reply-container");e.html(getTemplate("create-ticket-notes",d));if(d.reply_type=="forward"){$("#macro_list",e).addClass("disabled text-muted");$("#macro_list").css("cursor","no-drop")}Ticket_Utils.loadTextExpander(function(){try{$("textarea#reply_textarea",e).TextAreaExpander({padding:"8px 8px 1px 8px"});$("textarea#reply_textarea",e).css({height:"60px"})}catch(f){}});Tickets.start_ticket_draft_timer(d.id,"textarea#reply_textarea");$(e).on("keypress","#forward_email_input",function(g){g.stopImmediatePropagation();if(g.which==13){var f=$("#forward_email_input").val();if(!f){return}var h=!Tickets.isValidEmail(f);$("ul.forward-emails").prepend(getTemplate("forward-email-li",{email:f,err_email:h}));$("#forward_email_input").val("");var i=[];$("ul.forward-emails > li").each(function(k){var j=$(this).find("a.anchor").text();if(j){i.push(j)}});if(i.length>0){$("ul.forward-emails").removeClass("ticket-input-border-error")}return false}});if($("#forward_email_input",e).length>0){agile_type_ahead("forward_email_input",e,Tickets_Typeahead.contact_typeahead,function(h,f){f=f.split(" ").join("");var g=TYPEHEAD_EMAILS[f+"-"+h];if(!g||g=="No email"){return}$("ul.forward-emails").prepend(getTemplate("forward-email-li",{email:g}));$("#forward_email_input").val("");$("ul.forward-emails").removeClass("ticket-input-border-error")},undefined,undefined,"core/api/search/")}$(e).on("click",".remove-ticket-forward-emails",function(){$(this).closest("li").remove()});$(e).on("click","#ticket_canned_response",function(){var l=App_Ticket_Module.ticketView.model;var h=$(this).attr("rel");var k;var f=(Ticket_Canned_Response.cannedResponseCollection)?Ticket_Canned_Response.cannedResponseCollection.toJSON():[];for(var g=0;g<f.length;g++){if(f[g].id==h){var j=Handlebars.compile(f[g].message);k=j(d);break}}if(!k){return}Ticket_Utils.loadInsertCursor(function(){e.find("#reply_textarea").insertAtCaret(k)})})},getMatchedCannedResponses:function(b){var a=[];if(!Ticket_Canned_Response.cannedResponseCollection){return}$.each(Ticket_Canned_Response.cannedResponseCollection.toJSON(),function(d,f){cannedResponseLabels=f.labels;if(!cannedResponseLabels){return true}var c=(cannedResponseLabels.length==0)?false:true;for(var e=0;e<cannedResponseLabels.length;e++){if($.inArray(cannedResponseLabels[e],b)==-1){c=false;break}}if(c){a.push(f)}});return a},constructTextComments:function(a){var b="";if(!a||a.length==0){return b}$.each(a,function(c,d){if(d.note_type=="PRIVATE"){return}var e=d.attachments_list;b+=d.plain_text;if(e.length>0){b+="\n\nAttachments:"}$.each(e,function(g,f){b+='\n <a href="'+encodeURI(f.url)+'">'+f.name+"</a>"});b+="\n\n-----------------------------------------\n\n";b=b.replace(/<br\s*[\/]?>/gi,"\n")});return b},showCannedMessages:function(b){var a=new Base_Model_View({isNew:true,url:"/core/api/tickets/delete-ticket?id="+Current_Ticket_ID,template:"ticket-delete",saveCallback:function(){$("#ticketsModal").modal("hide");var c="#tickets/group/"+(!Group_ID?DEFAULT_GROUP_ID:Group_ID)+"/"+(Ticket_Status?Ticket_Status:"new");Backbone.history.navigate(c,{trigger:true})}});$("#ticketsModal").html(a.render().el).modal("show")},executeWorkflow:function(c){var d=$(c.target).attr("id");if(!d){return}var a={};a.workflow_id=d;a.ticket_id=Current_Ticket_ID;var b=new BaseModel();b.url="core/api/tickets/execute-workflow";b.save(a,{success:function(e){Ticket_Utils.showNoty("information","Workflow execution has been started successfully","bottomRight",5000)}})},showOriginal:function(c,a){var b="width=550";b+=", height="+(screen.height-200);b+=", scrollbars=yes, top=0, left=0";a=(!a)?"html":a;newwin=window.open("ticket-notes.jsp?id="+c+"&type="+a,"Help Desk | Agile CRM",b);if(window.focus){newwin.focus()}return false}};var Ticket_Reports={tickets:function(){var b=$("#range").html().split("-");var e=getUTCMidNightEpochFromDate(new Date(b[0]));var h=new Date();e=e+(h.getTimezoneOffset()*60*1000);e=e/1000;var g=$.trim(b[1]);if(g){g=g+" 23:59:59"}var a=$("#status").find("option:selected").val();var c=getUTCMidNightEpochFromDate(new Date(g));c+=(((23*60*60)+(59*60)+59)*1000);c=c+(h.getTimezoneOffset()*60*1000);c=c/1000;var f=$("#frequency").find("option:selected").val();$("#frequency").off("change");
$("#frequency").change(function(){f=$(this).find("option:selected").val();showBar("/core/api/tickets/reports/daily?start_time="+e+"&end_time="+c+"&frequency="+f+"&status="+a,"tickets-chart","","Tickets count",false)});$("#status").change(function(){a=$(this).find("option:selected").val();showBar("/core/api/tickets/reports/daily?start_time="+e+"&end_time="+c+"&frequency="+f+"&status="+a,"tickets-chart","","Tickets count",false,((a=="NEW")?["#f0ad4e"]:["#5cb85c"]))});showBar("/core/api/tickets/reports/daily?start_time="+e+"&end_time="+c+"&frequency="+f+"&status="+a,"tickets-chart","","Tickets count",false,((a=="NEW")?["#f0ad4e"]:["#5cb85c"]))},priorityReports:function(){var a=$("#range").html().split("-");var f=getUTCMidNightEpochFromDate(new Date(a[0]));var h=new Date();f=f+(h.getTimezoneOffset()*60*1000);f=f/1000;var g=$.trim(a[1]);if(g){g=g+" 23:59:59"}var e=getUTCMidNightEpochFromDate(new Date(g));e+=(((23*60*60)+(59*60)+59)*1000);e=e+(h.getTimezoneOffset()*60*1000);e=e/1000;var c=$("#report_type").find("option:selected").val();$("#report_type").off("change");$("#report_type").change(function(){c=$(this).find("option:selected").val();var d="/core/api/tickets/reports/priority?start_time="+f+"&end_time="+e,j="Priority Report";if(c=="status"){d="/core/api/tickets/reports/status?start_time="+f+"&end_time="+e;j="Status report"}Ticket_Reports.pieforReports(d,"report-chart","",true);$(".report_name").text(j)});var b="/core/api/tickets/reports/priority?start_time="+f+"&end_time="+e,i="Priority Report";if(c=="status"){b="/core/api/tickets/reports/status?start_time="+f+"&end_time="+e;i="Status report"}Ticket_Reports.pieforReports(b,"report-chart","",true);$(".report_name").text(i)},avgFirstRespTime:function(){var a=$("#range").html().split("-");var c=getUTCMidNightEpochFromDate(new Date(a[0]));var f=new Date();c=c+(f.getTimezoneOffset()*60*1000);c=c/1000;var e=$.trim(a[1]);if(e){e=e+" 23:59:59"}var b=getUTCMidNightEpochFromDate(new Date(e));b+=(((23*60*60)+(59*60)+59)*1000);b=b+(f.getTimezoneOffset()*60*1000);b=b/1000;Ticket_Reports.pieforReports("/core/api/tickets/reports/first-response-time?start_time="+c+"&end_time="+b,"avg-first-resp-time-chart","",true)},slaReport:function(){var a=$("#range").html().split("-");var c=getUTCMidNightEpochFromDate(new Date(a[0]));var f=new Date();c=c+(f.getTimezoneOffset()*60*1000);c=c/1000;var e=$.trim(a[1]);if(e){e=e+" 23:59:59"}var b=getUTCMidNightEpochFromDate(new Date(e));b+=(((23*60*60)+(59*60)+59)*1000);b=b+(f.getTimezoneOffset()*60*1000);b=b/1000;Ticket_Reports.pieforReports("/core/api/tickets/reports/sla?start_time="+c+"&end_time="+b,"sla-report-chart","",true)},pieforReports:function(c,a,b){$("#"+a).html("<div class='text-center v-middle opa-half'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");var e;var d=[];setupCharts(function(){fetchReportData(c,function(i){var j=[];var g=0;var f=0;$.each(i,function(m,l){var n=[];n.push(m);n.push(l.count);n.push(l.total);d.push(n);g+=l.count;f++});d.push(g);console.log(i,g);$.each(i,function(m,l){var n=[];n.push(m);n.push(l.count/g*100);n.push(g);j.push(n)});var h=f>20?false:true;Ticket_Reports.createAPieChart(a,b,h,d,j)})})},createAPieChart:function(a,b,d,c,e){chart=new Highcharts.Chart({chart:{renderTo:a,type:"pie",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,marginBottom:30,marginTop:20,marginLeft:70,marginRight:70},colors:["#7266ba","#23b7e5","#27c24c","#fad733","#f05050","#FF9900","#7AF168","#167F80","#0560A2","#D3E6C7"],title:{text:b},tooltip:{formatter:function(){return'<div><div class="p-n">'+this.series.name+": <b>"+getNumberWithCommasForCharts(c[this.point.x][1])+'</b></div></div><div class="p-n">Total: <b>'+c[3]+"</b></div>"},shared:true,useHTML:true,borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"}},legend:{itemWidth:75},plotOptions:{pie:{animation:d,allowPointSelect:true,cursor:"pointer",borderWidth:0,dataLabels:{enabled:true,useHTML:true,formatter:function(){return'<div class="text-center text-cap"><span style="color:'+this.point.color+';display:block"><b>'+this.point.name+'</b></span><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage)+"%</b></span></div>"},distance:25},showInLegend:false,size:"90%",innerSize:"65%",shadow:false,borderWidth:0},series:{events:{mouseOver:function(){$(".tooltip-default-message").hide()},mouseOut:function(f){$(".tooltip-default-message").show()}},borderWidth:0}},series:[{type:"pie",name:"Tickets",data:e,startAngle:90}],exporting:{enabled:false},lang:{noData:"No Data found"},noData:{style:{fontSize:"14px",fontWeight:"normal",color:"#98A6AD"},position:{y:5},}})}};var ticket_timeline_collection_view=null;var Ticket_Timeline={render_ticket_timeline:function(d){var a=$("#timeline",App_Ticket_Module.ticketView.el);try{var b=a.data("isotope").$allAtoms;a.isotope("remove",b)}catch(c){}head.load(FLAT_FULL_PATH+"lib/isotope.pkgd.js",FLAT_FULL_PATH+"lib/jquery.event.resize.js",FLAT_FULL_PATH+"css/misc/agile-timline.css",function(){configure_timeline(App_Ticket_Module.ticketView.el);ticket_timeline_collection_view=new ticket_timeline_view();var e="core/api/tickets/activity?id="+d;showTransitionBar();$.getJSON(e,function(f){ticket_timeline_collection_view.addItems(f);hideTransitionBar()}).error(function(){hideTransitionBar()});ticket_timeline_collection_view.render()})},render_individual_ticket_timeline:function(){$("#notes-collection-container").html(getRandomLoadingImg());var a=Backbone.Collection.extend({url:"core/api/tickets/activity?id="+Current_Ticket_ID});var b=new a();b.fetch({success:function(){var d=new BaseCollection(b.toJSON(),{sortKey:"time",descending:true}).toJSON();var c=$(getTemplate("ticket-timeline",d));agileTimeAgoWithLngConversion($("time",c));$('[data-toggle="tooltip"]',c).tooltip();$("#notes-collection-container").html(c)}})}};var ticket_timeline_view=Backbone.View.extend({initialize:function(){_.bindAll(this,"render","appendItem","addItems");this.options.data=[];this.collection=new BaseCollection([],{});this.month_year_marker=[];this.month_year_marker_objects=[];configure_timeline_comparator(this.collection);this.queue=new Queue;this.collection.bind("add",this.appendItem)},appendItem:function(b){this.collection.add(b,{silent:true});var a=[];a.push(b.toJSON());var c=getTemplate("timeline1",a,undefined,function(d){$("#timeline",App_Ticket_Module.ticketView.el).isotope("insert",$(d))})},addItems:function(a){this.collection.add(a,{silent:true});this.buildTimlinePosts(a)},render:function(){this.buildTimlinePosts(this.collection.toJSON())},buildTimlinePosts:function(d){var c=d.length;if(!c){return}this.addToQueue(d);return;var b=0;while(b<c){var a=b+50;a=a>c?c:a;if(a==b){break}this.addToQueue(d.slice(b,a));b+=50}},addToQueue:function(a){this.queue.add_function(function(b){getTemplate("timeline1",b,undefined,function(c){$("#timeline",$(App_Ticket_Module.ticketView.el)).isotope("insert",$(c),function(d){ticket_timeline_collection_view.queue.running=false;ticket_timeline_collection_view.queue.next()})})},a)}});var Ticket_Utils={fetchAssignees:function(a){if(Assingees_Collection&&Assingees_Collection.collection){if(a){a()}return}Assingees_Collection=new Base_Collection_View({url:"/core/api/users/partial",preserveAcrossRoutes:true});Assingees_Collection.collection.fetch({success:function(){if(a){a()}}})},fetchGroups:function(a){if(Groups_Collection&&Groups_Collection.collection){if(a){a()}return}Groups_Collection=new Base_Collection_View({url:"/core/api/tickets/groups",preserveAcrossRoutes:true});Groups_Collection.collection.fetch({success:function(b){if(a){a()}}})},fetchContact:function(b,c){var a=Backbone.Model.extend({url:"/core/api/contacts/"+b});new a().fetch({success:function(d){Ticket_Utils.Current_Ticket_Contact=d;if(c){c()}}})},dateDiff:function(c,d){var f=Math.abs(c-d)/1000;var e=Math.floor(f/86400);f-=e*86400;var b=Math.floor(f/3600)%24;f-=b*3600;var a=(e>0)?(e+" day"+(e>1?"s":"")+" "):"";a+=(b>0)?(b+" hr"+(b>1?"s":"")):"";return a.trim()},resetModalSettings:function(b){if(b){b.modal("hide")}var a=$("body");if(a.hasClass("modal-open")){a.removeClass("modal-open").animate({scrollTop:0},"slow");a.css("padding-right","")}},loadDateChartAndDatePicker:function(a){head.js(LIB_PATH+"lib/date-charts-en.js",LIB_PATH+"lib/date-range-picker.js?_="+_agile_get_file_hash("date-range-picker.js"),function(){if(a){a()}})},loadTextExpander:function(a){head.js("/flatfull/lib/jquery.textarea-expander.js?_="+_agile_get_file_hash("jquery.textarea-expander.js"),function(){if(a){a()}})},loadInsertCursor:function(a){head.js("/flatfull/lib/jquery.insertatcursor.js?_="+_agile_get_file_hash("jquery.insertatcursor.js"),function(){if(a){a()}})},enableTooltips:function(a){$('[data-toggle="tooltip"]',a).tooltip()},loadTimeAgoPlugin:function(a){agileTimeAgoWithLngConversion(undefined,function(){if(a){a()}})},getPropertyFromTicket:function(a){if(!App_Ticket_Module.ticketView.model){return""}var b=App_Ticket_Module.ticketView.model.toJSON();return b[a]},isTicketAttributesChanged:function(d,c){var e=App_Ticket_Module.ticketsCollection.collection.get(d).toJSON();var b=false;for(var a in c){if(c[a]===e[a]){continue}b=true}return b},showNoty:function(b,c,a,d){head.js(LIB_PATH+"lib/noty/jquery.noty.js",function(){$.noty.clearQueue();head.js("lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/layouts/bottomRight.js",LIB_PATH+"lib/noty/themes/default.js",function(){noty({text:c,layout:a,type:b,animation:{open:{height:"toggle"},close:{height:"toggle"},easing:"swing",speed:500},timeout:d,})})})},getInitials:function(a){if(!a){return"X"}var c=a.split(" ");if(c.length>=2){var b=c[0].substr(0,1);b+=c[1].substr(0,1);return b}return a},getInitialsEmptyMethod:function(a){return a}};var Tickets_Count={ticketsCount:{},fetchFilterTicketsCount:function(a){if(!App_Ticket_Module.ticketFiltersList){return}var c=App_Ticket_Module.ticketFiltersList.collection.toJSON();for(var b=0;b<c.length;
b++){this.showFiltersTicketCount(c[b].id)}},showFiltersTicketCount:function(b){var a="/core/api/tickets/fitered-tickets-count?filter_id="+b;this.ajax_call(a,function(c){Tickets_Count.ticketsCount[b]=c.count;$('a[filter-id="'+b+'"]').find("badge").html(c.count)})},ajax_call:function(a,b){$.ajax({url:a,accept:"application/json",success:function(c){if(b){b(c)}}})}};var Tickets_Rest={removeTicketsFromCollection:function(c){var a=c.split(",");if(!a||a.length==0){return}for(var b=0;b<a.length;b++){$("td#"+a[b]).closest("tr").remove();App_Ticket_Module.ticketsCollection.collection.remove(a[b])}},changeStatus:function(a,e){var b="/core/api/tickets/"+Current_Ticket_ID+"/activity/change-status";var c={status:a};var d=new Date().getTime();Tickets.updateModel(b,c,function(f){Ticket_Utils.showNoty("information","Ticket status has been changed to "+a.toLowerCase(),"bottomRight",5000);if(a!="NEW"){$('.ticket_status option[value="NEW"]').hide()}if(a!="CLOSED"){$(".ticket-addnote-close").removeAttr("disabled");$(".ticket-send-reply .btn").removeAttr("disabled");$(".ticket_change_slatime").removeAttr("disabled");$("#ticket_change_sla").removeAttr("disabled");$(".close-current-ticket").removeAttr("disabled");if($("#ticket_change_sla").val()!=""){$(".remove-date").css("display","block")}}else{$(".remove-date").css("display","none");$(".ticket-addnote_close").attr("disabled","disabled");$(".ticket-send-reply .btn").attr("disabled","disabled");$("#ticket_change_sla").attr("disabled","disabled");$(".ticket_change_slatime").attr("disabled","disabled");$(".close-current-ticket").attr("disabled","disabled");$(".ticket_status").val("CLOSED");c.closed_time=d}Tickets_Rest.updateDataInModelAndCollection(Current_Ticket_ID,c);if(e){e(f.toJSON())}},null)},closeTicket:function(a){this.changeStatus("CLOSED")},deleteTicket:function(a){getTemplate("ticket-delete",{},undefined,function(b){if(!b){return}$("#ticketsModal").html($(b)).modal("show").on("shown.bs.modal",function(){$("#ticketsModal").on("click","a.delete-ticket",function(){disable_save_button($(this));App_Ticket_Module.ticketView.model.destroy({success:function(e,c){Ticket_Utils.showNoty("information","Ticket has been deleted","bottomRight",5000);var d="#tickets/filter/"+Ticket_Filter_ID;Backbone.history.navigate(d,{trigger:true})}});$("#ticketsModal").modal("hide")})})})},showWorkflows:function(c){var b=$(c.target);b.siblings("#workflows_list").html('<li><a href="javascript:void(0);">Loading...</a></li>');var a=Backbone.Collection.extend({url:"core/api/workflows"});new a().fetch({success:function(d){$("#workflows_list").html(getTemplate("ticket-show-workflows-list",d.toJSON()))}})},toggleFavorite:function(d){var a=true;if($(d.target).hasClass("fa-star text-warning")){$(d.target).removeClass("fa-star text-warning").addClass("fa-star-o text-light");a=false}else{$(d.target).addClass("fa-star text-warning").removeClass("fa-star-o text-light")}var b="/core/api/tickets/"+Current_Ticket_ID+"/activity/toggle-favorite";var c={};Tickets.updateModel(b,c,function(e){var f="Ticket marked favourite";if(!a){f="Ticket marked as unfavourite"}Tickets_Rest.updateDataInModelAndCollection(Current_Ticket_ID,{is_favorite:a});Ticket_Utils.showNoty("information",f,"bottomRight",5000)},null)},toggleSpam:function(c){var a="/core/api/tickets/"+Current_Ticket_ID+"/activity/toggle-spam";var b={};Tickets.updateModel(a,b,function(d){var f="";var e=true;if(d.toJSON().is_spam){$(c.target).addClass("btn-danger").removeClass("btn-default");f="Ticket marked as spam"}else{$(c.target).removeClass("btn-danger").addClass("btn-default");f="Ticket marked as unspam";e=false}Ticket_Utils.showNoty("information",f,"bottomRight",5000);Tickets_Rest.updateDataInModelAndCollection(Current_Ticket_ID,{is_spam:e})},null)},changeTicketType:function(e){var c=$(".ticket_type");var a=c.find("option:selected").val();var b="/core/api/tickets/"+Current_Ticket_ID+"/activity/change-ticket-type";var d={type:a};Tickets.updateModel(b,d,function(){Tickets_Rest.updateDataInModelAndCollection(Current_Ticket_ID,{type:a});Ticket_Utils.showNoty("information","Ticket Type has been changed to "+a.toLowerCase(),"bottomRight",5000)})},changeTicketPriority:function(e){var b=$(".ticket_priority");var a=b.find("option:selected").val();var c="/core/api/tickets/"+Current_Ticket_ID+"/activity/change-priority";var d={priority:a};Tickets.updateModel(c,d,function(){Tickets_Rest.updateDataInModelAndCollection(Current_Ticket_ID,d);Ticket_Utils.showNoty("information","Ticket priority has been changed to "+a.toLowerCase(),"bottomRight",5000)})},changeAssignee:function(h){var f=h.target;var d=$(f).val();if(!d){return}var g=$(f.options[f.selectedIndex]).attr("data-assignee-id");if(!g){g=0}var a=App_Ticket_Module.ticketView.model.toJSON();if(a.assigneeID==g&&a.groupID==d){return}var b="/core/api/tickets/"+a.id+"/assign-ticket/"+d+"/"+g;var c={id:a.id};Tickets.updateModel(b,c,function(n){var l=n.toJSON();try{if(l.assigneeID!=CURRENT_DOMAIN_USER.id&&Tickets.isCurrentUserExistInGroup(d,Tickets.groupsList)){$(".assign-to-me").show()}else{$(".assign-to-me").hide()}}catch(o){console.log(o)}var i=(l.assigneeID)?(l.assignee.name):l.group.group_name;var k=true;var m="Ticket group has been changed to "+i;if(l.assigneeID){m="Assignee has been changed to "+i;k=false}Ticket_Utils.showNoty("information",m,"bottomRight",5000);l.assignee=((l.assignee)?l.assignee:"");l.group=((l.group)?l.group:"");Tickets_Rest.updateDataInModelAndCollection(l.id,l);if(!App_Ticket_Module.ticketsCollection){return}var j=App_Ticket_Module.ticketsCollection.collection.get(l.id);if(k){j.unset("assigneeID",{silent:true})}j.set(n,{silent:true})})},removeDuedate:function(){var a="/core/api/tickets/"+Current_Ticket_ID+"/activity/remove-due-date";var b={};Tickets.updateModel(a,b,function(c){$("#ticket_change_sla").val("");$(".ticket_change_slatime").timepicker("setTime","");$(".remove-date").css("display","none");App_Ticket_Module.ticketView.model.set({due_time:""},{silent:true});Tickets_Rest.updateDataInModelAndCollection(Current_Ticket_ID,{due_time:""});Ticket_Utils.showNoty("information","Due date has been removed","bottomRight",5000)},null)},updateDataInModelAndCollection:function(c,b){if(!App_Ticket_Module.ticketsCollection){return}var a=App_Ticket_Module.ticketsCollection.collection.get(c);a.set(b,{silent:true})},loadTicketsByContactId:function(b){$("div.tab-content",App_Contacts.contactDetailView.el).find("div.active").removeClass("active");$("#tickets",App_Contacts.contactDetailView.el).addClass("active");var a=new Base_Collection_View({url:"/core/api/tickets/contact/"+b,templateKey:"tickets-by-contacts",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(c){agileTimeAgoWithLngConversion($(".note-created-time",c))}});a.collection.fetch();$("#tickets",App_Contacts.contactDetailView.el).html(a.el)}};var Tickets_Typeahead={contact_typeahead:function(b){if(b==null){return}var a=[];$.each(b,function(d,c){var e;e=getContactName(c)+"-"+c.id;a.push(e.split(" ").join(""))});return a},cc_emails_typeahead:function(b){if(b==null){return}var a=[];$.each(b,function(d,c){var e;e=getContactName(c)+"-"+c.id;a.push(e.split(" ").join(""))});return a}};var Group_ID=null,Current_Ticket_ID=null,Ticket_Filter_ID=null,Tickets_Util={},Sort_By="-",Sort_Field="last_updated_time",Ticket_Position=null;var popoverFunction=undefined,Helpdesk_Enabled=false;var Tickets={renderLayout:function(a){if($("#tickets-container").length==0){getTemplate("tickets-container",{},undefined,function(c){if(!c){return}$("#content").html($(c));Ticket_Utils.resetModalSettings();var b={};b.sort_by=Sort_By;b.sort_field=Sort_Field;getTemplate("tickets-toolbar-container",b,undefined,function(e){if(!e){return}$("#right-pane").html($(e));var d=$(getRandomLoadingImg());$(".tickets-collection-pane").html(d.css("margin","10px"));if(a){a()}},"#right-pane")},"#content")}else{if(!Ticket_Filter_ID){if(a){a()}}else{Ticket_Filters.updateFilterName();Ticket_Custom_Filters.reset();Ticket_Custom_Filters.renderLayout();Tickets.fetchTicketsCollection()}}},fetchTicketModel:function(b,c){var a=Backbone.Model.extend({url:"/core/api/tickets/"+b});new a().fetch({success:function(d){if(c){c(d)}}})},fetchTicketsCollection:function(){Ticket_Labels.fetchCollection(function(){App_Ticket_Module.ticketsCollection=new Base_Collection_View({url:"/core/api/tickets/filter?filter_id="+Ticket_Filter_ID+"&custom_filters="+encodeURI(JSON.stringify(Ticket_Custom_Filters.customFilters)),global_sort_key:Sort_By+Sort_Field,sort_collection:false,templateKey:Tickets.isSingleRowView()?"ticket-single-row":"ticket",customLoader:true,preserveAcrossRoutes:true,custom_scrollable_element:".ticket-collection-container",customLoaderTemplate:"ticket-collection-loader",individual_tag_name:"tr",cursor:true,page_size:20,slateKey:"no-tickets",infini_scroll_cbk:function(){Tickets.setCountText()},postRenderCallback:function(a){Tickets.initEvents(a);Ticket_Utils.enableTooltips($("#tickets-container"));Ticket_Utils.loadTimeAgoPlugin(function(){$("time",a).timeago()});Ticket_Bulk_Ops.clearSelection();Ticket_Bulk_Ops.initEvents(a);if(!Tickets.isSingleRowView()){var b=Backbone.Collection.extend({url:"/core/api/tickets/groups"});new b().fetch({success:function(e,c,d){$("ul.ul-select-assignee").html(getTemplate("ticket-model-change-assignee",e.toJSON()))}})}Tickets.setCountText();if(Tickets.isSingleRowView()){Tickets.setMinHeight()}}});$("nav").find(".active").removeClass("active");$("#tickets").addClass("active");App_Ticket_Module.ticketsCollection.collection.fetch();$(".tickets-collection-pane").html(App_Ticket_Module.ticketsCollection.el)})},setCountText:function(){if(!App_Ticket_Module.ticketsCollection||!App_Ticket_Module.ticketsCollection.collection||App_Ticket_Module.ticketsCollection.collection.length==0){$(".ticket-count-text").html("0 tickets found");return}var b=App_Ticket_Module.ticketsCollection.collection.last().toJSON();var a=(b.count)?b.count:App_Ticket_Module.ticketsCollection.collection.length;
$(".ticket-count-text").html("Showing "+App_Ticket_Module.ticketsCollection.collection.length+" of "+a)},renderExistingCollection:function(){if(!App_Ticket_Module.ticketsCollection){App_Ticket_Module.ticketsByFilter(Ticket_Filter_ID)}else{this.renderLayout(function(){Ticket_Custom_Filters.renderLayout();Ticket_Filters.renderFiltersCollection(function(){Ticket_Filters.updateFilterName();$(".tickets-collection-pane").html(App_Ticket_Module.ticketsCollection.render(true).el);Tickets.setCountText();Tickets.initEvents(App_Ticket_Module.ticketsCollection.el);Ticket_Bulk_Ops.clearSelection();Ticket_Bulk_Ops.initEvents(App_Ticket_Module.ticketsCollection.el);Backbone.history.navigate("#tickets/filter/"+Ticket_Filter_ID,{render:false});App_Ticket_Module.ticketsCollection.infiniScroll.enableFetch();$(window).scrollTop(Ticket_Position);Current_Ticket_ID=null})})}},initEvents:function(a){$("div.assignee-change",a).off("click");$("div.assignee-change",a).on("show.bs.dropdown",function(h){var c=$(this).find("ul.ul-select");var i=c.data("ticket-id");var j=App_Ticket_Module.ticketsCollection.collection.get(i).toJSON();var g=$(this).data("action");switch(g){case"status":c.find("li").removeClass("active");var f=c.find("li").find('a[value="'+j.status+'"]');f.closest("li").addClass("active");break;case"priority":c.find("li").removeClass("active");var f=c.find("li").find('a[value="'+j.priority+'"]');f.closest("li").addClass("active");break;case"assignee":c.find("li").removeClass("active");var d=j.assigneeID,b=j.groupID;if(!d){var f=c.find("li").find('a[data-group-id="'+b+'"][value="0"]');f.closest("li").addClass("active")}else{var f=c.find("li").find('a[data-group-id="'+b+'"][value="'+d+'"]');f.closest("li").addClass("active")}}});$("div.assignee-change",a).off("click");$("div.assignee-change",a).on("hidden.bs.dropdown",function(b){$(this).removeClass("bg-light");$(this).find("a.caret-btn").removeClass("inline-block")});$("ul.ul-select",a).off("click");$("ul.ul-select",a).on("click","li a",function(f){f.stopPropagation();f.preventDefault();var c=$(this);if($(this).closest("li").hasClass("active")){c.closest("div").find(".dropdown-menu").dropdown("toggle");return}var i=c.data("field"),g=c.attr("value");var d=c.closest("ul").data("ticket-id");var b="/core/api/tickets",l="";var j={};var k=false;switch(i){case"status":b+="/"+d+"/activity/change-status";j={status:g,id:d};l="Status has been updated to "+get_ticket_translated_text("status",g);break;case"priority":b+="/"+d+"/activity/change-priority";j={priority:g,id:d};l="Priority has been updated to "+get_ticket_translated_text("priority",g);break;case"assignee":k=true;var h=c.data("group-id");j={id:d};b+="/"+d+"/assign-ticket/"+h+"/"+g;if(g==0){l="Ticket group has been changed to "+c.data("name")}else{l="Assignee has been changed to "+c.data("name")}g=c.data("name")}Tickets.updateModel(b,j,function(n){var m=n.toJSON();Ticket_Utils.showNoty("information",l,"bottomRight",5000);c.closest("tr").find("a."+i).html(get_ticket_translated_text(i,g));c.closest("div").find(".dropdown-menu").dropdown("toggle");if(i=="priority"){if(g=="HIGH"){$("td#"+d).addClass("b-l b-l-3x high-priority")}else{$("td#"+d).removeClass("b-l b-l-3x high-priority")}}c.closest("div").removeClass("bg-light");c.closest("div").find(".caret-btn").removeClass("inline-block").addClass("display-none");var e=App_Ticket_Module.ticketsCollection.collection.get(d);if(k){e.unset("assigneeID",{silent:true})}e.set(m,{silent:true})})});$(".tickets-collection",a).off("change");$(".tickets-collection",a).on("change","input.ticket-checkbox",function(b){b.stopPropagation();b.preventDefault();Ticket_Bulk_Ops.addOrRemoveTicketID(this);Ticket_Bulk_Ops.showText()});$(".tickets-collection",a).off("click");$(".tickets-collection",a).on("click","tr > td.open-ticket",function(c){if(Tickets.isSingleRowView()){$("div.ticket-last-notes").remove()}else{$(".ticket-last-notes").css("display","none").css("top",top)}var b="#tickets/filter/"+Ticket_Filter_ID+"/ticket/";Ticket_Position=$(window).scrollTop();Backbone.history.navigate(b+$(this).closest("tr").find("td.data").data("id"),{trigger:true})});$(a).off("mouseover mouseout");$(a).on("mouseover mouseout","td.show-notes",function(d){clearTimeout(popoverFunction);var e="60px";if(d.type=="mouseover"){var c=$(this).closest("tr"),b=c.find("td.notes-container");popoverFunction=setTimeout(function(){if(Current_Ticket_ID||Current_Route.indexOf("ticket")==-1){return}var f=b.find("#ticket-last-notes").height();if(window.innerHeight-(c.offset().top-$(window).scrollTop())<=(f+100)){e="-"+f+"px"}b.find("#ticket-last-notes").css("top",e).css("left","0").css("display","block")},600)}else{$(".ticket-last-notes").css("display","none").css("top",e)}});$(a).on("mouseover mouseout","tbody.ticket-single-row-model-list > tr",function(c){clearTimeout(popoverFunction);if(c.type=="mouseover"){var b=$(this);popoverFunction=setTimeout(function(){var e=b.find("td.data").data("id");var d=App_Ticket_Module.ticketsCollection.collection.get(e).toJSON();getTemplate("ticket-single-row-popup",d,undefined,function(i){if(!i){return}$("body").append($(i));if(Current_Ticket_ID||Current_Route.indexOf("ticket")==-1){return}var f=b.closest("div.row");var h=0,g=f.offset().left+70+"px";if(window.innerHeight-(b.offset().top-$(window).scrollTop())>=250){h=b.offset().top+35+"px"}else{h=b.offset().top-$("#ticket-last-notes").height()+"px"}Ticket_Utils.loadTimeAgoPlugin(function(){var j=$("time","#ticket-last-notes").timeago()});$("#ticket-last-notes").css("top",h).css("left",g).css("display","block")})},600)}else{$("div.ticket-last-notes").remove()}});$(".show-caret").off("click");$(a).on("click",".show-caret",function(b){b.preventDefault();b.stopPropagation();$(this).find(".dropdown-menu").dropdown("toggle");$(this).addClass("bg-light open");$(this).find(".caret-btn").addClass("inline-block")});$(".tickets-toolbar").off("click");$(".tickets-toolbar").on("click",".refresh-tickets",function(b){b.preventDefault();App_Ticket_Module.ticketsByFilter(Ticket_Filter_ID);Tickets_Count.fetchFilterTicketsCount();Ticket_Bulk_Ops.clearSelection()});$(".tickets-toolbar").on("click",".toggle-custom-filters",function(b){b.preventDefault();var c=$("div#custom-filters-container").closest("div.col");if(_agile_get_prefs("hide_ticket_lhs_filter")){_agile_delete_prefs("hide_ticket_lhs_filter");$(this).find("i").attr("data-original-title","Hide Filters").css("opacity",1)}else{_agile_set_prefs("hide_ticket_lhs_filter",true);$(this).find("i").attr("data-original-title","Show Filters").css("opacity",0.7)}c.toggle("slow")});$(".tickets-toolbar").on("click","a.sort-field",function(b){b.preventDefault();if($(this).data("sort-key")==Sort_Field){return}Sort_Field=$(this).data("sort-key");$(".sort-field-check").addClass("display-none");$(this).find("i").removeClass("display-none");$(".sort-field-txt").html($(this).text());App_Ticket_Module.ticketsByFilter(Ticket_Filter_ID)});$(".tickets-toolbar").on("click","a.sort-by",function(b){b.preventDefault();if($(this).data("sort-key")==Sort_By){return}Sort_By=$(this).data("sort-by");$(".sort-by-check").addClass("display-none");$(this).find("i").removeClass("display-none");App_Ticket_Module.ticketsByFilter(Ticket_Filter_ID)});$(a).off("click mouseover mouseout",".toggle-collection-view");$(a).on("click",".toggle-collection-view",function(d){d.preventDefault();var c=Tickets.isSingleRowView()?"MULTILINE":"SINGLELINE",b=$(this);$.post("/core/api/users/helpdesk-settings/toggle-view?view_type="+c,{},function(){CURRENT_DOMAIN_USER.helpdeskSettings.ticket_view_type=c;App_Ticket_Module.ticketsCollection.options.templateKey=Tickets.isSingleRowView()?"ticket-single-row":"ticket";App_Ticket_Module.ticketsCollection.render(true);if(c=="SINGLELINE"){$("ul.choose-columns").closest("div").addClass("open")}})});$(a).on("mouseover mouseout",".toggle-collection-view.single-line, ul.choose-columns",function(b){b.preventDefault();if(b.type=="mouseover"){$("ul.choose-columns").closest("div").addClass("open");return}$("ul.choose-columns").closest("div").removeClass("open")});$(a).off("click","ul.choose-columns > li > a");$(a).on("click","ul.choose-columns > li > a",function(b){b.preventDefault();b.stopPropagation();var c=$(b.currentTarget);$(b.target).blur();var e=c.find('input[type="checkbox"]');var d=e.is(":checked")?false:true;e.prop("checked",d);var f=e.attr("name");var k=$(".choose-column-chbx:checked"),g=[];for(var h=0;h<k.length;h++){g.push($(k[h]).attr("name"))}var l={};l.choosed_columns=g;var j=new BaseModel();j.url="/core/api/users/helpdesk-settings/choose-columns";j.save(l,{success:function(i){CURRENT_DOMAIN_USER.helpdeskSettings=i.toJSON();$(".tickets-collection-pane").html(App_Ticket_Module.ticketsCollection.render(true).el);Tickets.setCountText();Tickets.initEvents(App_Ticket_Module.ticketsCollection.el)}});return false})},fillAssigneeAndGroup:function(a){fillSelect("ticket-assignee","/core/api/tickets/groups","",function(e){Tickets.groupsList=e.toJSON();$("#ticket-assignee",a).html(getTemplate("select-assignee-ticket-dropdown",e.toJSON()));var c=App_Ticket_Module.ticketView.model.toJSON().assigneeID;var b=App_Ticket_Module.ticketView.model.toJSON().groupID;if(!c){$("#ticket-assignee",a).find("option[group_id='"+b+"']").attr("selected","selected")}else{var d=$("#ticket-assignee",a).find("option[data-assignee-id='"+c+"']").length;if(d==0){$("#ticket-assignee",a).find("option[value=0]").attr("selected","selected")}else{$("#ticket-assignee",a).find("optgroup[data-group-id='"+b+"']").find("option[data-assignee-id='"+c+"']").attr("selected","selected")}}if(c!=CURRENT_DOMAIN_USER.id&&Tickets.isCurrentUserExistInGroup(b,Tickets.groupsList)){$(".assign-to-me",a).show()}else{$(".assign-to-me",a).hide()}},"",false,a)},isCurrentUserExistInGroup:function(b,c){var a=false;$.each(c,function(d,e){$.each(e.group_users,function(g,f){if(e.id==b&&f.id==CURRENT_DOMAIN_USER.id){a=true}})});return a},updateModel:function(b,c,e,a){var d=new BaseModel();d.url=b;if(!c.id){c.id=Current_Ticket_ID
}d.save(c,{success:function(f){if(App_Ticket_Module.ticketView){App_Ticket_Module.ticketView.model.set(f,{silent:true})}if(e){e(f)}},error:function(){if(a){a(model)}}})},toEmails:function(){$(".to-emails").hide();$(".ticket-email").show(function(){$("#cc_emails").focus()})},hideDropDowns:function(a){if(!Current_Ticket_ID){return}if($(a.target).closest("div.ticket-details-dropdown").length>0||$(a.target).hasClass("ticket-details-value")){return}$(".ticket-details-dropdown").hide();$(".ticket-details-value").show()},initCCEmailsListeners:function(a){$(a).on("keypress","#cc_email_field",function(b){Tickets.ccEmailsList(b)})},ccEmailsList:function(c,b){c.stopImmediatePropagation();if(c.which==13||b){var a=$("#cc_email_field").val();if(!a){return}var d=!Tickets.isValidEmail(a);$("#cc_email_field").val("");if(!d){Tickets.updateCCEmails(a,"add")}}},addMeToCC:function(){var a=CURRENT_DOMAIN_USER.email;$("#cc_email_field").val("");Tickets.updateCCEmails(a,"add");$(".add-me-to-cc").hide()},removeCCEmails:function(a){Tickets.updateCCEmails($(a.target).closest("li").attr("data"),"remove",function(c){var b=CURRENT_DOMAIN_USER.email;var d=(c)?c.toJSON().cc_emails:[];if(!d||d.length==0||$.inArray(b,d)==-1){$(".add-me-to-cc").show()}});$(a.target).closest("li").remove()},updateCCEmails:function(b,d,e){var a="/core/api/tickets/"+Current_Ticket_ID+"/activity/update-cc-emails";var c={command:d,email:b,id:Current_Ticket_ID};this.updateModel(a,c,function(f){Tickets_Rest.updateDataInModelAndCollection(Current_Ticket_ID,c);var g=(d=="remove")?b+" removed from CC emails":b+" added to CC emails";if(d!="remove"){$("ul.cc-emails").prepend(getTemplate("cc-email-li",{email:b}))}Ticket_Utils.showNoty("information",g,"bottomRight",5000);if(e){e(f)}})},isValidEmail:function(b){var a=/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,9}$/;if(!a.test(b)){return false}return true},getCCEmailsList:function(a){return $("#"+a+' [name="cc_emails"]').map(function(){var b=[];$.each($(this).children(),function(d,c){if($(c).attr("data")){b.push(($(c).attr("data")).toString())}});return{name:"cc_emails",value:b}}).get()},ticket_detail_view_navigation:function(h,d){var b=App_Ticket_Module.ticketsCollection;if(!b){return}var c=b.collection;var e=c.length;var g=c.indexOf(c.get(h));var f;var a;if(e<=g+5){App_Ticket_Module.ticketsCollection.infiniScroll.fetchNext()}if(e>1&&g<e&&c.at(g+1)&&c.at(g+1).has("id")){a=c.at(g+1).id}if(e>0&&g!=0&&c.at(g-1)&&c.at(g-1).has("id")){f=c.at(g-1).id}if(f!=null){$(".navigation .previous-ticket",d).attr("href","#tickets/filter/"+Ticket_Filter_ID+"/ticket/"+f)}else{$(".navigation .previous-ticket",d).replaceWith("<span class='pull-left text-disabled text-xs'><i class='icon icon-chevron-left v-middle'></i></span>")}if(a!=null){$(".navigation .next-ticket",d).attr("href","#tickets/filter/"+Ticket_Filter_ID+"/ticket/"+a)}else{$(".navigation .next-ticket",d).replaceWith("<span class='pull-right text-disabled text-xs'><i class='icon icon-chevron-right v-middle'></i></span>")}},ticketsloadWidgets:function(){var c=_agile_get_prefs("hide_ticket_details_widgets");if(c&&c=="true"){return}var b=0;var a=App_Ticket_Module.ticketView.model.toJSON();if(a&&a.contactID){App_Contacts.contactDetailView=new Base_Model_View({isNew:false,url:"/core/api/contacts/"+a.contactID,template:"contact-detail",postRenderCallback:function(e,d){b++;if(b>1){return}clearContactWidetQueues(a.contactID);loadWidgets(App_Contacts.contactDetailView.el,d,"widgets")}})}},isSingleRowView:function(){return(CURRENT_DOMAIN_USER.helpdeskSettings&&CURRENT_DOMAIN_USER.helpdeskSettings.ticket_view_type=="SINGLELINE")?true:false},toggleWidgets:function(a){$(".contact-right-widgetsview").toggle("slow",function(){var b=true;if($(".contact-right-widgetsview").is(":visible")){b=false}_agile_set_prefs("hide_ticket_details_widgets",b);if($(a.target).hasClass("fa-dedent")){$(a.target).addClass("fa-indent").removeClass("fa-dedent")}else{$(a.target).addClass("fa-dedent").removeClass("fa-indent")}if(b==false&&$("#widgets-model-list").length==0){Tickets.ticketsloadWidgets()}})},setMinHeight:function(){var a=$(".ticket-collection-row");if(a&&a.offset()&&a.offset().top){a.css("min-height",window.innerHeight-a.offset().top+"px")}},updateDueDate:function(e,b,h){var f=App_Ticket_Module.ticketView.model.toJSON();var c=new Date();if(Math.floor(f.due_time/1000)==Math.floor(e/1000)){return}if(e<c.getTime()){var g=null;if(f.due_time){g=new Date(f.due_time)}getTemplate("ticket-sla-error",{},undefined,function(j){if(!j){return}$("#ticket_change_sla",b).datepicker("hide");if(g){$("#ticket_change_sla").val(new Date(g).format("mm/dd/yyyy"));$(".ticket_change_slatime").val(new Date(g).format("HH:MM"))}else{$("#ticket_change_sla").val("");$(".ticket_change_slatime").val("")}$("#ticketsModal").html($(j)).modal("show")});return}var d=f.due_time?true:false;var a="/core/api/tickets/"+Current_Ticket_ID+"/activity/change-due-date";var i={due_time:Math.floor(e)};Tickets.updateModel(a,i,function(j){var k=new Date(e).format("mmm dd, yyyy HH:MM");App_Ticket_Module.ticketView.model.set(i,{silent:true});Tickets_Rest.updateDataInModelAndCollection(Current_Ticket_ID,i);$(".remove-date").css("display","block");var l=(d)?("due date has been changed to "+k):("due date has been set to "+k);Ticket_Utils.showNoty("information",l,"bottomRight",5000);if(h){h()}},null)},initializeTicketSLA:function(a){var b=App_Ticket_Module.ticketView.model.toJSON();head.load(LIB_PATH+"lib/date-charts-en.js",function(){$("#ticket_change_sla",a).datepicker({drops:"down",dateFormat:CURRENT_USER_PREFS.dateFormat,autoclose:true}).on("changeDate",function(g){var e=$("#ticket_change_sla",a).val();var c=Date.parse(e).getTime();var i=$(".ticket_change_slatime",a).val();if(i){var h=i.split(":");if(!h[0]&&!h[1]){c+=86399000}else{var d=parseInt(h[0]);var f=parseInt(h[1]);c=Date.parse(e).getTime()+(d*3600*1000)+(f*60*1000)}}else{c+=86399000}Tickets.updateDueDate(c,a,function(){$("#ticket_change_sla",a).datepicker("hide");$("#ticket_change_sla",a).blur();var j=new Date(c);$(".ticket_change_slatime",a).timepicker("setTime",j.format("HH:MM"))})})});$(a).on("click",".choose-due-date",function(c){var g=App_Ticket_Module.ticketView.model.toJSON();if(g.status=="CLOSED"){return}console.log("Ticket status: "+g.status);var j=$(this).data("value"),d=new Date();d.setHours(0);d.setMinutes(0);d.setSeconds(0);switch(j){case"tomorrow":d.setDate(d.getDate()+1);break;case"next_two_days":d.setDate(d.getDate()+2);break;case"next_three_days":d.setDate(d.getDate()+3);break;case"next_five_days":d.setDate(d.getDate()+5);break}var f=d.getTime();var i=$(".ticket_change_slatime",a).val();if(i){var k=i.split(":");if(!k[0]&&!k[1]){f+=86399000}else{var h=parseInt(k[0]);var e=parseInt(k[1]);f=Date.parse(d).getTime()+(h*3600*1000)+(e*60*1000)}}else{f+=86399000}$("#ticket_change_sla",a).val(new Date(f).format(CURRENT_USER_PREFS.dateFormat));$(".ticket_change_slatime",a).timepicker("setTime",new Date(f).format("HH:MM"));Tickets.updateDueDate(f)})},showPreviousTicketCount:function(a,b){$.get("/core/api/tickets/"+a+"/count",{},function(c){if(c&&c>1){$(".previous-tickets-panel",b).find("#count").html("("+(c-1)+")");$(".previous-tickets-panel",b).show()}})},togglePreviousTickets:function(b){if($("#previous_tickets_container").is(":visible")){$("#previous_tickets_container").toggle();$("#toggle_previous_tickets").addClass("fa-plus").removeClass("fa-minus");return}$("#previous_tickets_container").toggle();$("#toggle_previous_tickets").removeClass("fa-plus").addClass("fa-minus");if($("#previous_tickets_container").find(".each-previous-ticket").length>0){return}var a=Backbone.Model.extend({url:"/core/api/tickets/email/"+b});new a().fetch({success:function(c){if(c.toJSON().length>1){$(".previous-tickets-panel").hide();return}$("#previous_tickets_container").html(getTemplate("previous-tickets-list",c.toJSON())).show();Tickets.initPreviousTicketEvents($("#previous_tickets_container"))}})},initPreviousTicketEvents:function(a){$(a).off("mouseover mouseout");$(a).on("mouseover mouseout",".show-notes",function(d){clearTimeout(popoverFunction);var e="20px";if(d.type=="mouseover"){var c=$(this).closest(".each-previous-ticket"),b=c.find("#ticket-last-notes");popoverFunction=setTimeout(function(){var f=b.height();if(window.innerHeight-(c.offset().top-$(window).scrollTop())<=(f+100)){e="-"+(f+20)+"px"}b.css("top",e).css("left","25px").css("display","block")},600)}else{$(".ticket-last-notes").css("display","none").css("top",e)}})},toggleActivitiesUI:function(c){var b=$(".toggle-activities-notes");var a=b.attr("rel");if(c&&c=="hide"){b.attr("rel","activities");b.attr("data-original-title","Hide Activities");b.html("<i class='fa fa-ellipsis-v'></i>")}else{b.attr("rel","notes");b.attr("data-original-title","Show Activities");b.html("<i class='fa fa-ellipsis-h'></i>")}},updateIframeHeight:function(a){$(a).height($(a).contents().height());$(a).contents().find("body").css({"font-family":'"Source Sans Pro","Helvetica Neue",Helvetica,Arial,sans-serif',"font-size":"14px","-webkit-font-smoothing":"antialiased","line-height":"1.42857143",color:"#58666e","background-color":"transparent",margin:"0",padding:"0"})},message_draft_timer:undefined,start_ticket_draft_timer:function(a,b){if(Tickets.message_draft_timer){clearInterval(Tickets.message_draft_timer)}if(!b||$(b).hasClass("forward")||$(b).hasClass("create_ticket_textarea")){return}Tickets.message_draft_timer=setInterval(function(){var c=$(b);if(!c||c.length==0){clearInterval(Tickets.message_draft_timer);return}Tickets.draft_typed_message(a,Tickets.get_typed_message_json(c))},2000)},get_typed_message_json:function(b){var a=b.val();if(b.hasClass("forward")){return{forward:a}}else{if(b.hasClass("comment")){return{comment:a}}else{return{reply:a}}}},draft_typed_message:function(c,b){if(!c||!b){return}var a=Tickets.get_draft_message();var d=a[c];if(!d){d={}}for(typeKey in b){d[typeKey]=b[typeKey]}a[c]=d;try{sessionStorage.setItem("ticket-draft-message",JSON.stringify(a))}catch(f){a={key:d};
sessionStorage.setItem("ticket-draft-message",JSON.stringify(a))}},get_draft_message:function(b){var a=sessionStorage.getItem("ticket-draft-message");if(!a){return{}}return JSON.parse(a)},remove_draft_message:function(c,d){var a=Tickets.get_draft_message();var b=a[c];delete b[d];a[c]=b;sessionStorage.setItem("ticket-draft-message",JSON.stringify(a))},initNewTicketTypeahead:function(a){fillSelect("groupID","/core/api/tickets/new-ticket","",function(b){$("#groupID").html(getTemplate("select-assignee-dropdown",b.toJSON()))},"",false,a);Ticket_Labels.showSelectedLabels(new Array(),$(a));agile_type_ahead("cc_email_field",a,Tickets_Typeahead.contact_typeahead,function(d,b){b=b.split(" ").join("");var c=TYPEHEAD_EMAILS[b+"-"+d];if(!c||c=="No email"){return}$("ul.cc-emails").prepend(getTemplate("cc-email-li",{email:c,new_ticket:true}));$("#cc_email_field").val("")},undefined,undefined,"core/api/search/");agile_type_ahead("requester_email",a,Tickets_Typeahead.contact_typeahead,function(e,c){var f=c;c=c.split(" ").join("");var d=TYPEHEAD_EMAILS[c+"-"+e];if(!d||d=="No email"){var b=$(".form-action-error");b.html("No email address found.");setTimeout(function(){b.html("")},4000)}else{setTimeout(function(){$("#requester_email",a).val(d);$("#requester_name",a).val(f);$("#contact_id",a).val(e)},0)}},undefined,undefined,"core/api/search/");$("div#ticketsModal").on("click","a.close",function(b){$(b.target).closest("li").remove()})},initializeTicketSLAinHours:function(e){var f=App_Ticket_Module.ticketView.model.toJSON();var c=f.due_time;var a,d;$(".ticket_change_slatime",e).timepicker({showMeridian:false,defaultTime:false});if(c){var b=new Date(c);$(".ticket_change_slatime",e).timepicker("setTime",b.format("HH:MM"))}$(".ticket_change_slatime",e).timepicker().on("hide.timepicker",function(j){console.log(j.time);var k=App_Ticket_Module.ticketView.model.toJSON();var h=k.due_time;console.log(h);if(j.time.hours==0&&j.time.minutes==0&&!h){$(".ticket_change_slatime",e).val("");return}var g=new Date();if(h){g=new Date(h)}g.setHours(0);g.setMinutes(0);g.setSeconds(0);var i=g.getTime()+(j.time.hours*3600*1000)+(j.time.minutes*60*1000);Tickets.updateDueDate(i,e,function(){$("#ticket_change_sla",e).val(new Date(i).format(CURRENT_USER_PREFS.dateFormat));$(".ticket_change_slatime",e).timepicker("setTime",new Date(i).format("HH:MM"))})})}};