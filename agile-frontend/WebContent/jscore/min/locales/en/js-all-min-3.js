(function(b,d,e){b.CATEGORIES={};b.isValid=function(k,j){var h="\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA793\uA7A0-\uA7AA\uA7F8-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC";var g="^["+h+"]["+h+" 0-9_-]*$";var f=new RegExp(g).test(k);if(j&&!f){showAlertModal("activity_error")}return f};b.getCategoriesHtml=function(g,h){var f="";if(g!=e&&g.type!=e){f=g.type}b.getCategories(function(j){var k="";d.each(j,function(n,l){var m=l.label;if(m){m=getTranslatedPortletName(m.toUpperCase())}if(f==l.name){k+='<option value="'+l.name+'" selected="selected">'+m+"</option>"}else{k+='<option value="'+l.name+'">'+m+"</option>"}});if(h&&typeof(h)==="function"){h(k)}})};b.getGroupingMap=function(f){b.getCategories(function(g){var h={};h.searchKey="type";var j=[];d.each(g,function(l,k){j.push(k.name)});h.type=j;if(f&&typeof(f)==="function"){f(h)}})};b.getCategories=function(f){d.ajax({url:"core/api/categories?entity_type=TASK",type:"GET",dataType:"json",success:function(g){var h={};d.each(g,function(k,j){h[j.name]=j.label});b.CATEGORIES=h;if(f&&typeof(f)==="function"){f(g)}return g}})};var a=function(h,j,f,g){queuePostRequest("task_categories",h,j,function(k){if(f&&typeof(f)==="function"){f(k)}},function(k){if(g&&typeof(g)==="function"){g(k)}})};var c=function(j){var g=d("#add_new_task_category").val();if(d(j).attr("disabled")){return}disable_save_button(d(j));if(!b.isValid(g)){if(g.length===0){d(j).parent().find(".save-status").html('<span style="color:red;">'+_agile_get_translated_val("validation-msgs","required")+"</span>")}else{d(j).parent().find(".save-status").html('<span style="color:red;">'+_agile_get_translated_val("category","name-error")+"</span>")}setTimeout(function(){d(j).parent().find(".save-status").html()},3000);enable_save_button(d(j));return false}var f={};f.label=g;f.order=d("#admin-settings-categories-model-list").find("tr").length;f.entity_type="TASK";console.log(f);var h=new Backbone.Model();h.url="/core/api/categories";h.save(f,{success:function(l,k){enable_save_button(d(j));App_Admin_Settings.categories()},error:function(l,k){console.log(k,l);d(j).parent().find(".save-status").html('<span style="color:red;">'+k.responseText+"</span>");enable_save_button(d(j))}})};deleteCategory=function(h){var f="/core/api/categories/delete";var g={};g.id=h;console.log("------------",g);a(f,g,function(){App_Admin_Settings.categoryGridView.collection.remove(App_Admin_Settings.categoryGridView.collection.get(h));d("#category-delete-modal").modal("hide");d("#"+h).closest("tr").remove()})};b.saveCategoryOrder=function(){var f="/core/api/categories/order";var g=[];d("#admin-settings-categories-model-list").find("tr").each(function(j){g[j]=d(this).find('input[name="id"]').val()});var h={};h.ids=JSON.stringify(g);console.log("------------",h);a(f,h)};b.setup_categories=function(f){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){d(f).find("tbody").each(function(g){d(this).sortable({containment:"#admin-settings-categories-model-list",items:"tr",helper:function(k,h){var j=h.children();var l=h.clone();l.children().each(function(m){d(this).width(j.eq(m).width());d(this).css("background","#f5f5f5");d(this).css("border-bottom","1px solid #ddd")});return l},start:function(h,j){d.each(j.item.children(),function(k,l){j.helper.children().eq(k).width(j.helper.children().eq(k).width()-d(this).width())});j.helper.width(j.helper.width())},sort:function(h,j){j.helper.css("top",(j.helper.offset().top+j.item.offset().top)+"px")},forceHelperSize:true,placeholder:"<tr><td></td></tr>",forcePlaceholderSize:true,handle:".icon-move",cursor:"move",tolerance:"intersect",update:function(h,j){console.log(d(j.item).attr("data"));b.saveCategoryOrder()}})})})};b.init=function(){d("#category-tracks-accordion").on("click",".show_task_category_field",function(f){f.preventDefault();d(this).parent().hide();d("#task-category").find(".show_field").show();d("#add_new_task_category").focus()});d("#category-tracks-accordion").on("click","#add_task_category",function(f){f.preventDefault();c(this)});d("#category-tracks-accordion").on("click",".category-delete",function(f){f.preventDefault();d("#delete-category-confirm-dialog input").val(d(this).attr("id"));d("#category-name").text(d(this).attr("data"));d("#category-delete-modal").modal("show")});d("body").on("click","#category-delete-confirm",function(f){f.preventDefault();var g=d("#delete-category-confirm-dialog input").val();deleteCategory(g)});d("#category-tracks-accordion").on("keypress","#add_new_task_category",function(f){if(f.keyCode==13){d("#add_task_category").click()}})}}(window.categories=window.categories||{},$));function get_allowed_domains(){var c=$("#allowed_domains_list").children();var b="";for(var a=0;a<c.length;a++){b=b?b+", "+$(c[a]).attr("data"):$(c[a]).attr("data")}return b}function put_allowed_domains(a){$.ajax({url:"/core/api/api-key/allowed-domains?allowed_domains="+encodeURIComponent(a),method:"PUT",success:function(c){$("#allowed_domains_list").empty();var b=Handlebars.helpers.allowed_domain_list(c.allowed_domains);$("#allowed_domains_list").append(b);$(".allowed-domain-delete").on("click",function(f){f.preventDefault();$(this).closest("tr").remove();var d=get_allowed_domains();put_allowed_domains(d)});$("#update_allowed_domains").removeAttr("disabled");$("#new_allowed_domain").val("")}})}function is_duplicate_allowed_domain(c,b){b=b.split(",");for(var a in b){b[a]=b[a].trim();if(b[a]==c){return true}}return false}var Widgets_View;var widget_template_loaded_map={};var WIDGET_LOADED_CONTACT;var WIDGET_PARENT_ID;var WIDGET_PARENT_ELEMENT;function loadWidgets(d,e,c){var f={contact:e};WIDGET_LOADED_CONTACT=e;WIDGET_PARENT_ID=c;WIDGET_PARENT_ELEMENT=d;var b=false;if(!Widgets_View){b=true;Widgets_View=new Base_Collection_View({url:"/core/api/widgets",restKey:"widget",templateKey:WIDGET_PARENT_ID,individual_tag_name:"li",sortKey:"position",modelData:f,postRenderCallback:function(h){head.load(FLAT_FULL_UI+"css/misc/agile-widgets.css",function(){if(b){set_up_widgets(d,h)
}b=false})}});Widgets_View.collection.fetch();var g=Widgets_View.render().el;$("#"+c,d).html(g);widgetBindingsLoader()}else{var a=false;$(d).off("view_loaded");$(d).on("view_loaded",function(h){if(a==false){a=true;Widgets_View.collection.sort();$("#"+c,d).html(Widgets_View.render(true).el);set_up_widgets(d,Widgets_View.el,f.contact.id)}widgetBindingsLoader()})}}function widgetBindingsLoader(){$("#"+WIDGET_PARENT_ID).off("click",".widget-minimize");$("#"+WIDGET_PARENT_ID).on("click",".widget-minimize",function(e){e.preventDefault();var widget_name=$(this).attr("widget");$("#"+widget_name).collapse("hide");$(this).removeClass();$(this).addClass("collapsed");$(this).addClass("widget-maximize");$(this).addClass("fa");$(this).addClass("fa-plus");$(this).addClass("text-muted");var widget=Widgets_View.collection.where({name:widget_name})[0];var widgetJSON=widget.toJSON();widget.set({is_minimized:true},{silent:true});widgetJSON.is_minimized=true;var model=new BaseModel();model.url="core/api/widgets";model.save(widgetJSON,{silent:true})});$("#"+WIDGET_PARENT_ID).off("click",".widget-maximize");$("#"+WIDGET_PARENT_ID).on("click",".widget-maximize",function(e){e.preventDefault();var widget_name=$(this).attr("widget");var widget=Widgets_View.collection.where({name:widget_name})[0];var widgetJSON=widget.toJSON();widgetJSON.is_minimized=false;widget.set({is_minimized:false},{silent:true});var model=new BaseModel();model.url="core/api/widgets";model.save(widgetJSON,{silent:true});var is_collapsed=$(this).hasClass("collapsed");$(this).removeClass();$(this).addClass("widget-minimize");$(this).addClass("text-muted");$(this).addClass("fa");$(this).addClass("fa-minus");$(this).addClass("c-p");if(is_collapsed){$("#"+widget_name).collapse("show")}else{queueGetRequest("_widgets_","flatfull/"+widget.get("url"),"script",function(data,queueName){try{console.log("start"+model.get("name")+"Widget");eval("start"+model.get("name")+"Widget")(queueName.replace("_widgets_",""));$("#"+widget_name).collapse("show")}catch(err){console.log(err)}},undefined,"true")}})}function process_url(a){return a=FLAT_FULL_UI+a}function set_up_widgets(el,widgets_el){_(Widgets_View.collection.models).each(function(model){var id=model.get("id");var url=process_url(model.get("url"));model.set("selector",model.get("name").replace(/ +/g,""));$("#"+model.get("selector"),widgets_el).data("model",model);var contact_id=WIDGET_LOADED_CONTACT.id;if(!model.get("is_minimized")&&model.get("widget_type")!="CUSTOM"){if(widget_template_loaded_map[model.get("name").toLowerCase()]){queueGetRequest("_widgets_"+contact_id,url,"script",function(data,queueName){try{console.log("start"+model.get("name")+"Widget");eval("start"+model.get("name")+"Widget")(queueName.replace("_widgets_",""))}catch(err){console.log(err)}},undefined,"true")}else{var download_tpl_js_path=model.get("name").toLowerCase()+".js";downloadTemplate(download_tpl_js_path,function(){widget_template_loaded_map[model.get("name").toLowerCase()]=true;queueGetRequest("_widgets_"+contact_id,url,"script",function(data,queueName){try{console.log("start"+model.get("name")+"Widget");eval("start"+model.get("name")+"Widget")(queueName.replace("_widgets_",""))}catch(err){console.log(err)}},undefined,"true")})}}if(model.get("widget_type")=="CUSTOM"){if($("#"+model.get("selector")+"-container").length){$("#"+model.get("selector")+"-container",widgets_el).show("0",function(e){setup_custom_widget(model,widgets_el)})}else{$("#"+model.get("selector")+"-container",widgets_el).show("0",function(e){setup_custom_widget(model,widgets_el)})}}},this);enableWidgetSoring(widgets_el)}function setup_custom_widget(b,a){try{var d;if(b&&b.get("script_type")){d=b.get("script_type")}else{if(b.get("url")){d="url"}else{d="script"}}if(d=="script"){$("#"+b.get("selector"),a).html(b.get("script"))}else{if(d=="url"){getScript(b,function(e){console.log(e);$("#"+b.get("selector"),a).html(e)})}}}catch(c){console.log(c)}}function getScript(a,d){try{var c=agile_crm_get_contact()["id"];$.post("core/api/widgets/script/"+c+"/"+a.get("name"),function(e){if(d&&typeof(d)==="function"){d(e)}}).error(function(e){$("#"+a.get("selector")).html(e.statusText);console.log(e);console.log(e.responseText)})}catch(b){console.log(b)}}function enableWidgetSoring(a){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".widget-sortable",a).sortable();$(".widget-sortable",a).sortable("option","handle",".icon-widget-move");$(".widget-sortable",a).off("sortstop");$(".widget-sortable",a).on("sortstop",function(b,c){var d=[];$(".widget-sortable > li",a).each(function(g,h){var e=$(h).find(".collapse").attr("id");if(!e){e=$(h).find(".widgets").attr("id")}var f=$("#"+e).data("model");f.set({position:g},{silent:true});d.push({id:f.get("id"),position:g})});$.ajax({type:"POST",url:"/core/api/widgets/positions",data:JSON.stringify(d),contentType:"application/json; charset=utf-8",dataType:"json"})})})}function queueGetRequest(f,e,d,a,c,b){console.log(f+", "+e);head.js("/js/lib/ajaxm/ajaxq.js",function(){try{b=(b)?true:false;$.ajaxq(f,{url:e,cache:b,dataType:d,success:function(h){console.log("Sucesses",e);if(a&&typeof(a)==="function"){a(h,f)}},error:function(h){console.log("error",e);if(c&&typeof(c)==="function"){c(h,f)}},complete:function(h){console.log("completed get")},})}catch(g){console.log(g)}})}function queuePostRequest(d,b,c,e,a){head.js("/js/lib/ajaxm/ajaxq.js",function(){try{$.ajaxq(d,{type:"POST",url:b,cache:false,data:c,success:function(g){if(e&&typeof(e)==="function"){e(g)}},error:function(g){if(a&&typeof(a)==="function"){a(g)}},complete:function(g){console.log("completed post")}})}catch(f){console.log(f)}})}function queueClear(a){console.log("clear queue.");if(document.ajaxq){document.ajaxq.q[a]=[];try{document.ajaxq.qr[a].abort();document.ajaxq.qr[a]=null}catch(b){console.log(b)}}}function showIcons(a){$(a).find("div.widget_header_icons").show();$(a).find("div.widget_header_name").css({width:"40%"})}function hideIcons(a){$(a).find("div.widget_header_icons").hide();$(a).find("div.widget_header_name").css({width:"80%"})}var Widget_Collection_Events=Base_Collection_View.extend({events:{"click .install-custom-widget":"addCustomWidgetClicked",},addCustomWidgetClicked:function(a){},});var Widget_Model_Events=Base_Model_View.extend({options:{saveCallback:function(b){var a=$("#widget-settings").attr("widget-type");if(a=="CUSTOM"){if(b){showNotyPopUp("success","Custom widget saved successfully","bottomRight");window.location.href="#add-widget"}else{showNotyPopUp("error","Widget name already in use.","bottomRight")}}}},events:{"click #stripe_url":"stripeUrl","click .save-agile-widget":"saveWidgetPrefs","click .connect_shopify":"connectShopify","click .revoke-widget":"revokeWidget","change #script_type":"scriptType","click #cancel_custom_widget":"cancelWidget"},scriptType:function(){var a=$("#script_type").val();if(a=="script"){$("#script_div").show();$("#url_div").hide();return}if(a=="url"){$("#script_div").hide();$("#url_div").show()}},cancelWidget:function(){Backbone.history.navigate("add-widget",{trigger:true})},stripeUrl:function(){var a=$("#stripe_url").attr("url");$("#stripe_url").attr("disabled","disabled");var b=$("input:radio[name='scope']:checked").val();a+="&scope="+b+"&return_url="+encodeURIComponent(window.location.href);window.location.assign(a)},revokeWidget:function(c){c.preventDefault();var b=$(c.currentTarget);var a=$(b).closest("#widget-settings").attr("widget-name");delete_widget(a);window.location.href="#add-widget";location.reload()},saveWidgetPrefs:function(d){d.preventDefault();var c=$(d.currentTarget);var b=$(c).closest("#widget-settings").attr("widget-name");if(!b){return}if(!isValidForm($(c).closest("form"))){return}var a=serializeForm($(c).closest("form").attr("id"));console.log(a);if(b=="Sip"){a.sip_publicid="sip:"+a.sip_privateid+"@"+a.sip_realm}if($(c).attr("disabled")){return}$(c).attr("disabled","disabled").val("Saving...");if(b!="TwilioIO"){save_widget_prefs(b,JSON.stringify(a),function(e){console.log(e);$(c).removeAttr("disabled").val("Save")})}else{createAppSid(a,function(e){console.log(e);a.twilio_app_sid=e;save_widget_prefs(b,JSON.stringify(a),function(f){console.log(f);$(c).removeAttr("disabled").val("Save")})})}},connectShopify:function(b){b.preventDefault();var c=$("#shop").val();if(c!=""&&!validateEmail(c)){var a=window.location.origin;window.location="/scribe?service_type=shopify&url=shopify&isForAll="+isForAll+"&shop="+c+"&domain="+a+""}else{showAlertModal("enter_shop_name",undefined,function(){$("#shop").focus()});return false}}});function validateEmail(a){var b=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)}function organize_sync_widgets(a){var c=new Base_List_View({model:a,template:"admin-settings-import-skeleton",tagName:"div",});var b=a.get("type");if(b=="GOOGLE"){$("#contact-prefs",this.el).append($(c.render().el))}if(b=="STRIPE"){$("#stripe",this.el).append($(c.render().el))}if(b=="FRESHBOOKS"){$("#freshbook",this.el).append($(c.render().el))}if(b=="OFFICE365"){$("#office365",this.el).append($(c.render().el))}if(b=="SHOPIFY"){$("#shopify",this.el).append($(c.render().el))}if(b=="QUICKBOOK"){$("#quickbook",this.el).append($(c.render().el))}if(b=="SALESFORCE"){$("#salesforce",this.el).append($(c.render().el))}}function initializeDataSyncListners(){$("#prefs-tabs-content #data-sync-type").off();$("#prefs-tabs-content").on("click","#data-sync-type",function(c){var b=$(this).attr("sync_type");if(b=="GOOGLE"){var a=window.location.href+"/contacts";console.log(a);window.open("/scribe?service=google&window_opened=true&return_url="+encodeURIComponent(a),"dataSync","height=1000,width=500")}if(b=="STRIPE"){var a=agileWindowOrigin()+"/#sync/stripe-import";window.open("/scribe?service=stripe_import&window_opened=true&return_url="+encodeURIComponent(a),"dataSync","height=1000,width=500");return false}if(b=="SHOPIFY"){Backbone.history.navigate("#sync/shopify",{trigger:true})
}if(b=="QUICKBOOK"){window.open("/OAuthServlet?service=quickbook-import&window_opened=true&return_url="+encodeURIComponent(window.location.href)+"quickbooks","dataSync","height=1000,width=500");return false}if(b=="FRESHBOOKS"){Backbone.history.navigate("#sync/freshbooks",{trigger:true})}if(b=="OFFICE365"){Backbone.history.navigate("#sync/officeCalendar",{trigger:true})}});$("#prefs-tabs-content #sync-import-prefs-delete").off();$("#prefs-tabs-content").on("click","#sync-import-prefs-delete",function(b){var a=$(this);showAlertModal("delete","confirm",function(){var d=a.attr("data_sync_type");var e=a.attr("data_sync_id");if(!d){return}var c="core/api/contactprefs/delete/"+d+"/"+e;$.ajax({url:c,type:"DELETE",success:function(){console.log("success");if(d=="SALESFORCE"){DATA_SYNC_FORCE_FETCH=true;App_Datasync.salesforce()}else{App_Datasync.dataSync()}}})})})}function executeDataSyncReturnCallback(b,a){if(a=="google_calendar"){App_Datasync.google_calendar();return}DATA_SYNC_FORCE_FETCH=true;if(a=="shopify"){App_Datasync.shopify();return}b=b.substr(b.indexOf("#"));if(window.location.hash==b&&(a=="quickbook-import"||a=="stripe_import")){window.location.reload();return}Backbone.history.navigate(b,{trigger:true})}function executeCloseWindowCallback(a){Backbone.history.navigate(a,{trigger:true})}var DATA_SYNC_FORCE_FETCH=false;function getSyncModelFromName(b,e,d){if(d&&!DATA_SYNC_FORCE_FETCH){var c=Backbone.Model.extend({url:"/core/api/contactprefs/"+b});var a=new c();a.fetch({success:function(f){App_Datasync.agile_sync_collection_view.collection.get(f.toJSON().id).set("inProgress",f.toJSON().inProgress);e(getModalfromName(App_Datasync.agile_sync_collection_view.collection.toJSON(),b))}});return}if(DATA_SYNC_FORCE_FETCH){DATA_SYNC_FORCE_FETCH=false;App_Datasync.agile_sync_collection_view=new Base_Collection_View({url:"/core/api/contactprefs/allPrefs"});App_Datasync.agile_sync_collection_view.collection.fetch({success:function(f){e(getModalfromName(f.toJSON(),b))}});return}if(App_Datasync.agile_sync_collection_view){return e(getModalfromName(App_Datasync.agile_sync_collection_view.collection.toJSON(),b))}else{DATA_SYNC_FORCE_FETCH=true;e(getSyncModelFromName(b,e))}}function getModalfromName(d,b){for(var c in d){var a=d[c];if(a.type==b){return a}}}function renderInnerSyncView(c,b,e,g,a){var f=new DataSync_Event_Modal_View({url:c,template:b,data:e,form_custom_validate:a,saveCallback:function(h){g(h)}});var d=$("#data-sync-settings-tab-content");if(d.length==0){d=$("#data-import-settings-tab-content")}d.html(f.render().el)}var CSRCOLLECTION;function initializeCallScriptListeners(){$("#prefs-tabs-content").off();$("#prefs-tabs-content #callscriptruleForm").off("click");$("#prefs-tabs-content").on("click","#callscriptruleForm",function(a){makeWidgetTabActive()});$("#prefs-tabs-content .callscript-multiple-add").off("click");$("#prefs-tabs-content").on("click",".callscript-multiple-add",function(c){c.preventDefault();var b=this;var a={};a.customFields=get_merge_fields();getTemplate("callscript-rule",a,undefined,function(d){if(!d){return}var e=$(d).find("tr").clone();scramble_input_names($(e));chainFilters(e,function(){},false);$(e).find("i.callscript-multiple-remove").css("display","inline-block");$(b).siblings("table").find("tbody").append(e)},null)});$("#prefs-tabs-content i.callscript-multiple-remove").off("click");$("#prefs-tabs-content").on("click","i.callscript-multiple-remove",function(a){$(this).closest("tr").remove()});$("#prefs-tabs-content .edit-callscriptrule").off("click");$("#prefs-tabs-content").on("click",".edit-callscriptrule",function(b){b.preventDefault();$("#prefs-tabs-content").html(LOADING_HTML);var a=$(this).attr("data");window.location.href="#callscript/editrules/"+a;$("#prefs-tabs-content").html(LOADING_HTML)});$("#prefs-tabs-content .delete-callscriptrule").off("click");$("#prefs-tabs-content").on("click",".delete-callscriptrule",function(b){b.preventDefault();var a=$(this);showAlertModal("delete_rule","confirm",function(){a.closest("tr").remove();deleteCallScriptRule($(this).attr("data"))})});$("#prefs-tabs-content .row-callscriptrule").off("mouseenter");$("#prefs-tabs-content").on("mouseenter",".row-callscriptrule",function(a){$(this).find(".callscriptrule-actions").css("visibility","visible")});$("#prefs-tabs-content .row-callscriptrule").off("mouseleave");$("#prefs-tabs-content").on("mouseleave",".row-callscriptrule",function(a){$(this).find(".callscriptrule-actions").css("visibility","hidden")});$("#prefs-tabs-content #save_prefs").off("click");$("#prefs-tabs-content").on("click","#save_prefs",function(b){b.preventDefault();if($(this).text()=="Saving..."||$(this).text()=="Loading..."){console.log("Do not hit me again "+$(this).text());return}try{if(!isValidForm($("#callscriptruleForm"))){return}}catch(a){return}saveCallScriptWidgetPrefs()});$("#prefs-tabs-content").on("click","#callscript-customField-li",function(b){b.preventDefault();var a=$(this).attr("value");insertValueInAt("#displaytext",a)})}function adjust_form(){$("#add_csrule").text("Loading...");$("#add_csrule").attr("disabled",true);if(isCallScriptAdded()){var a=getCallScriptRuleCount();if(a>0){$(".rule-count").html(a);$("#add_csrule").hide();$(".rule-added").show();$("#show_csrules").show()}else{$(".no-rule-added").show()}}else{$(".no-rule-added").show()}$("#add_csrule").text("Add Rule");$("#add_csrule").attr("disabled",false)}function isCallScriptAdded(){var a=App_Widgets.Catalog_Widgets_View.collection.where({name:"CallScript"});console.log(a);if(a[0].get("is_added")==false){return false}return true}function getCallScriptJSON(){if(!App_Widgets||!App_Widgets.Catalog_Widgets_View||!App_Widgets.Catalog_Widgets_View.collection){window.location.href="#add-widget";return}var b=App_Widgets.Catalog_Widgets_View.collection.where({name:"CallScript"});if(b[0].get("is_added")==false){return null}var a=JSON.parse(b[0].get("prefs"));return a}function getCallScriptRuleCount(){var a=getCallScriptJSON();return a.csrules.length}function createCSRCollection(){var a=getCallScriptJSON();CSRCOLLECTION=new Base_Collection_View({data:a.csrules})}function makeRule(){var c=serializeForm("callscriptruleForm");var b=c.rulecount;var a=getCallScriptJSON();if(a!=null){if(b!=""){a.csrules[getRuleIndex(a,b)]=c}else{c.position=a.csrules.length;a.csrcount=a.csrcount+1;c.rulecount=a.csrcount;a.csrules.push(c)}return a}c.position=0;c.rulecount=1;a={};a.csrules=[c];a.csrcount=1;return a}function deleteCallScriptRule(a){var b=getCallScriptJSON();if(b!=null){console.log(b.csrules[a]);b.csrules.splice(a,1);save_widget_prefs("CallScript",JSON.stringify(b),function(c){console.log("In call script save success after delete");console.log(c)})}initializeCallScriptListeners();makeWidgetTabActive()}function showCallScriptRule(){makeWidgetTabActive();$("#prefs-tabs-content").html(LOADING_HTML);var a=getCallScriptJSON();if(a!=null){getTemplate("callscript-table",a.csrules,undefined,function(b){if(!b){return}$("#prefs-tabs-content").html($(b));initializeSubscriptionListeners();setup_sortable_callscriptrules()},null)}initializeCallScriptListeners()}function addCallScriptRule(){if(!App_Widgets||!App_Widgets.Catalog_Widgets_View||!App_Widgets.Catalog_Widgets_View.collection){window.location.href="#add-widget";return}makeWidgetTabActive();var a={};get_merge_fields(function(c){a.customFields=c;var b=new Base_Model_View({template:"callscript-rule",data:a,isNew:"true",postRenderCallback:function(d){head.js(LIB_PATH+"lib/agile.jquery.chained.min.js",function(){chainFilters(d,undefined,function(){$("#prefs-tabs-content").html(d);initializeSubscriptionListeners();if(!isCallScriptAdded()){$(".redirect-to-addwidget").show();$(".redirect-to-showrules").hide()}})})}});$("#prefs-tabs-content").html(LOADING_HTML);initializeCallScriptListeners();b.render()})}function editCallScriptRule(d){makeWidgetTabActive();$("#prefs-tabs-content").html(LOADING_HTML);var a=getCallScriptJSON();if(a!=null){var c=getRule(a,d);var b={};b.customFields=get_merge_fields();$("#prefs-tabs-content").html(LOADING_HTML);initializeCallScriptListeners();head.js(LIB_PATH+"lib/agile.jquery.chained.min.js?_="+_agile_get_file_hash("agile.jquery.chained.min.js"),function(){getTemplate("callscript-rule",b,undefined,function(e){if(!e){return}$("#prefs-tabs-content").html($(e));$("#prefs-tabs-content").find("#filter-settings").find("#loading-img-for-table").html(LOADING_HTML).show();$("#prefs-tabs-content").find("#filter-settings").find(".chained-table").hide();chainFilters($("#prefs-tabs-content"),c,function(){$("#prefs-tabs-content").find("#filter-settings").find("#loading-img-for-table").hide();$("#prefs-tabs-content").find("#filter-settings").find(".chained-table").show();initializeSubscriptionListeners();$(".callscript-multiple-remove").show();$(".callscript-multiple-remove")[0].style.display="none"});scramble_input_names($("#prefs-tabs-content").find("#filter-settings"));$(".addLable").html(" Edit Call Script Rule");$("#name").val(c.name);$("#displaytext").val(c.displaytext);$("#position").val(c.position);$("#rulecount").val(c.rulecount)},"#prefs-tabs-content")})}}function getRule(a,d){var c=a.csrules;for(var b=0;b<c.length;b++){if(c[b].rulecount==d){return c[b]}}}function getRuleIndex(a,d){var c=a.csrules;for(var b=0;b<c.length;b++){if(c[b].rulecount==d){return b}}}function setup_sortable_callscriptrules(){$(".csr-sortable").append("<tr class='pseduo-row' style='border:none!important;'><td></td><td></td><td></td></tr>");head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".csr-sortable").sortable({axis:"y",forcePlaceholderSize:true,placeholder:"<tr><td></td></tr>",handle:".icon-move",containment:".csr-sortable",cursor:"move",forceHelperSize:true,scroll:false,items:"> tr",helper:function(c,a){var b=a.children();var d=a.clone();d.children().each(function(e){$(this).width(b.eq(e).width())});return d}}).disableSelection();$(".csr-sortable").off("sortstop");$(".csr-sortable").on("sortstop",function(a,b){getRulesNewPosition(function(c){saveCSRAfterDrop(c)
})})})}function getRulesNewPosition(c){var b=[];var a=getCallScriptJSON();$(".csr-sortable > tr").each(function(d,e){if(!$(e).hasClass("pseduo-row")){var g=$(e).attr("data");var f=a.csrules[g];if(g!=d){f.position=d;$(e).attr("data",d)}b.push(f)}});if(c&&typeof(c)==="function"){c(b)}}function saveCSRAfterDrop(b){var a=getCallScriptJSON();a.csrules=b;save_widget_prefs("CallScript",JSON.stringify(a),function(c){console.log("In call script save success after drag-drop");console.log(c)})}function makeWidgetTabActive(){$("#PrefsTab .select").removeClass("select");$(".add-widget-prefs-tab").addClass("select")}function saveCallScriptWidgetPrefs(){$("#save_prefs").text("Saving...");$("#save_prefs").attr("disabled",true);var a=makeRule();console.log(a);save_widget_prefs("CallScript",JSON.stringify(a),function(b){console.log("In call script save success");console.log(b);window.location.href="#callscript/rules"})}function callscript_save_widget_prefs(){}function build_custom_widget_form(a){var b;$("#prefs-tabs-content").off("click","#add-custom-widget");$("#prefs-tabs-content").on("click","#add-custom-widget",function(d){$("#custom-widget-btn").removeClass("open");b=$("#custom-widget").clone();var c=new Base_Model_View({url:"/core/api/widgets/custom",template:"add-custom-widget",isNew:true,postRenderCallback:function(e){console.log("In post render callback");console.log(e);$("#custom-widget").off("change").on("change","#script_type",function(g){var f=$("#script_type").val();if(f=="script"){$("#script_div").show();$("#url_div").hide();return}if(f=="url"){$("#script_div").hide();$("#url_div").show()}})},saveCallback:function(e){console.log("In save callback");console.log(e);if(e==null){showAlertModal("duplicate_widget");return}App_Widgets.Catalog_Widgets_View.collection.add(e);$("#custom-widget").replaceWith(b)}});$("#custom-widget",a).html(c.render(true).el);if(!($(this).hasClass("add_to_all"))){isForAll=false}$("#custom_isForAll").val(isForAll);$("#prefs-tabs-content").off("click","#cancel_custom_widget");$("#prefs-tabs-content").on("click","#cancel_custom_widget",function(f){$("#custom-widget").replaceWith(b)})})}function insertValueInAt(f,l){var j=$(f);var k=j.val();var g=document.selection?"ie":"other";var b=j.scrollTop;var d=0;if(g=="ie"){j.focus();var h=document.selection.createRange();h.moveStart("character",-j.value.length);d=h.text.length}else{d=j.prop("selectionStart")}var c=(k).substring(0,d);var e=(k).substring(d,k.length);var a=c+l+e;j.val(a);d=d+l.length;if(g=="ie"){j.focus();var h=document.selection.createRange();h.moveStart("character",-j.value.length);h.moveStart("character",d);h.moveEnd("character",0);h.select()}else{j.prop("selectionStart",d);j.prop("selectionEnd",d);j.focus()}j.scrollTop=b}function agile_crm_get_contact_property(c){var b=App_Contacts.contactDetailView.model;var d=b.get("properties");var a;$.each(d,function(e,f){if(f.name==c){a=f.value;return false}});if(a){return a}}function agile_crm_get_contact_properties_list(b){var a=App_Contacts.contactDetailView.model;var d=a.get("properties");var c=[];$.each(d,function(e,f){if(f.name==b){c.push(f)}});return c}function agile_crm_update_contact(c,f,g){var b=agile_crm_get_contact_model();var e=b.toJSON()["properties"];var a=false;$.each(e,function(h,j){if(j.name==c){a=true;j.value=f;return false}});if(!a){e.push({name:c,value:f,type:"CUSTOM"})}b.set({properties:e},{silent:true});var d=new Backbone.Model();d.url="core/api/contacts";d.save(b.toJSON(),{success:function(j,h){b.set(j.toJSON(),{silent:true});if(g&&typeof(g)=="function"){g(j.toJSON())}}},{silent:true})}function agile_crm_get_contact_model(){if(company_util.isCompany()){return App_Companies.companyDetailView.model}else{return App_Contacts.contactDetailView.model}}function agile_crm_is_model_property_changed(b,d){var e=true;var a=agile_crm_get_contact_model();var c=a.toJSON()["properties"];$.each(c,function(f,g){if(g.name==b&&g.value==d){e=false}});return e}function agile_crm_update_contact_properties(h,j){var g=App_Contacts.contactDetailView.model;var e=g.toJSON()["properties"];for(var c in h){var f=false;$.each(e,function(k,l){if(l.name==h[c].name){f=true;if(h[c].subtype){if(h[c].subtype==l.subtype){l.value=h[c].value}else{f=false}}else{l.value=h[c].value}return false}});if(!f){e.push({name:h[c].name,value:h[c].value,subtype:h[c].subtype,type:"CUSTOM"})}}g.set({properties:e},{silent:true});var d=new Backbone.Model();d.url="core/api/contacts";d.save(g.toJSON(),{success:function(l,k){g.set(l.toJSON(),{silent:true});if(j&&typeof(j)=="function"){j()}}},{silent:true});var e=g.get("properties");var c;for(c=0;c<e.length;c++){if(e[c].name=="image"){var a=e[c].value;var b="contact-container";$("#"+b).find(".contact-image-view").html("");$("#"+b).find(".contact-image-view").html('<img src="'+a+'" class="upload_pic imgholder submit w-full img-circle" style="width:75px;height:75px;" type="submit" />');if($(".toggle-contact-image .contact-delete-option").length==0){$("#"+b).find(".toggle-contact-image").append('|<div style="float:right" class="contact-delete-option"><a name="Delete" value="Delete" onClick="deleteConfirmation();" class="tooltip_info" data-placement="bottom" data-toggle="tooltip" title="Delete"><i class="glyphicon glyphicon-trash" style="color:red"></i></a></div>');$("#"+b).find(".toggle-contact-image").find(".contact-edit-option").removeAttr("style");$("#"+b).find(".toggle-contact-image").find(".contact-edit-option").css("float","left")}}}}function agile_crm_get_contact(){return App_Contacts.contactDetailView.model.toJSON()}function agile_crm_add_note(c,e){var b=App_Contacts.contactDetailView.model;var d=new Backbone.Model();var a=new Backbone.Model();d.url="core/api/notes";d.set("subject",c);d.set("description",e);d.set("contacts",[b.id.toString()]);d.save()}function agile_crm_get_widget(b){b=b.replace(/ +/g,"");console.log("plugin name "+b);console.log($("#"+b));var a=$("#"+b,get_current_view_el()).data("model");console.log(a);return a.toJSON()}function agile_crm_get_widget_prefs(b){b=b.replace(/ +/g,"");console.log("in get widget prefs "+b);var a=$("#"+b).data("model").toJSON().prefs;return a}function agile_crm_save_widget_prefs(d,b,e){console.log(d);d=d.replace(/ +/g,"");console.log(get_current_view_el());console.log($("#"+d,get_current_view_el()));var c=$("#"+d).data("model");console.log(c);c.set({prefs:b},{silent:true});c.url="core/api/widgets";console.log(c);var a=new BaseModel();a.url="core/api/widgets";a.save(c.toJSON(),{success:function(f){console.log(f);console.log("Saved widget: "+f.toJSON());$("#"+d).data("model",c);if(e&&typeof(e)==="function"){console.log("in save callback");console.log(f.toJSON());e(f.toJSON())}}},{silent:true})}function agile_crm_delete_widget_prefs(a,b){agile_crm_save_widget_prefs(a,undefined,b)}function agile_crm_get_widget_property_from_contact(b){var a=App_Contacts.contactDetailView.model;var c=a.get("widget_properties");if(!c){return}c=JSON.parse(c);return c[b]}function agile_crm_delete_widget_property_from_contact(b){var a=App_Contacts.contactDetailView.model;var c=a.get("widget_properties");if(!c){return}c=JSON.parse(c);delete c[b];a.set("widget_properties",JSON.stringify(c));a.url="core/api/contacts";a.save()}function agile_crm_get_contact_property_by_subtype(c,a){var b=App_Contacts.contactDetailView.model;var d=b.get("properties");var e;$.each(d,function(f,g){if(g.name==c&&g.subtype==a){e=g}});if(e){return e.value}}function agile_crm_delete_contact_property_by_subtype(c,a,e,f){var b=App_Contacts.contactDetailView.model;var d=b.get("properties");$.each(d,function(g,h){if(h.name==c&&h.subtype==a&&h.value==e){d.splice(g,1);b.set({properties:d},{silent:true});b.url="core/api/contacts";b.save([],{silent:true,success:function(j){console.log("in success");if(f&&typeof f==="function"){f(j)}}});return false}})}function agile_crm_save_contact_property(c,a,g,e){var b=App_Contacts.contactDetailView.model;var d=b.get("properties");var f={};f.name=c;f.value=g;f.subtype=a;f.type=e;d.push(f);b.set("properties",d);console.log(d);b.url="core/api/contacts";b.save()}function agile_crm_save_widget_property_to_contact(b,d,e){var a=App_Contacts.contactDetailView.model;var c=a.get("widget_properties");if(!c){c={}}else{c=JSON.parse(c)}c[b]=d;a.set({widget_properties:JSON.stringify(c)},{silent:true});a.url="core/api/contacts";a.save(a.toJSON,{silent:true,success:function(f){console.log("in success");if(e&&typeof e==="function"){e(f)}}})}function agile_crm_add_event_to_timeline(c,e,a,d){var b={};b.id=c;b.body=a;b.title=e;if(d&&(d/100000000000)>1){b.created_time=d}else{b.created_time=d}b.entity_type="custom";add_entity_to_timeline(new BaseModel(b))}function agile_crm_get_current_view(){if(App_Contacts.contactDetailView){return App_Contacts.contactDetailView.el}return undefined}function get_current_view_el(){if(Current_Route.indexOf("contact")!=-1&&App_Contacts.contactDetailView){return App_Contacts.contactDetailView.el}if(Current_Route.indexOf("ticket")!=-1&&App_Ticket_Module.ticketView){return App_Ticket_Module.ticketView.el}return undefined}function verifyNumberFromTwilio(a,c,b){$.getJSON("/core/api/widgets/twilio/verify/numbers/"+c+"/"+a,function(d){console.log("Twilio verified_data "+d);if(!d){return}if(b&&typeof(b)==="function"){b(d)}}).error(function(e){var d=Math.floor((Math.random()*10)+1);setUpError("Twilio","widget-settings-error",e.responseText,window.location.protocol+"//"+window.location.host+"/#Twilio/twilio"+d)});return}var Twilio_Call_Noty;var Twilio_Call_Noty_IMG="";var To_Number;var To_Name="";var Twilio_Token;var Verfied_Number;var globalconnection;var Twilio_Setup_Called=false;var Twilio_Start=false;var Restart_Twilio=false;TWILIO_CONTACT_ID=0;TWILIO_CALLTYPE="";TWILIO_DIRECTION="";TWILIO_CALLED_NO="";TWILIO_IS_VOICEMAIL=false;var TWILIO_CONTACT;function initializeTwilioGlobalListeners(){}$(function(){setTimeout(function(){if(document.readyState==="complete"){globalTwilioIOSetup()}},10000);$("body").off("click",".noty_twilio_mute");$("body").on("click",".noty_twilio_mute",function(a){a.preventDefault();
console.log("Twilio call noty_twilio_mute from noty");globalconnection.mute(true);$(".noty_buttons").find(".noty_twilio_unmute").css("display","inline");$(".noty_buttons").find(".noty_twilio_mute").toggle()});$("body").off("click",".noty_twilio_unmute");$("body").on("click",".noty_twilio_unmute",function(a){a.preventDefault();console.log("Twilio call noty_twilio_unmute from noty");globalconnection.mute(false);$(".noty_buttons").find(".noty_twilio_unmute").toggle();$(".noty_buttons").find(".noty_twilio_mute").toggle()});$("body").off("click",".noty_twilio_hangup");$("body").on("click",".noty_twilio_hangup",function(a){a.preventDefault();console.log("Twilio call hang up from noty");Twilio.Device.disconnectAll()});$("body").off("click",".noty_twilio_dialpad");$("body").on("click",".noty_twilio_dialpad",function(a){a.preventDefault();console.log("Twilio call dailpad from noty");$(".noty_buttons").find("#dialpad_in_twilio").toggle();if($("#dialpad_in_twilio:visible").length>0){$("#panel-body1, #draggable-noty").css({height:"150px"})}else{$("#panel-body1, #draggable-noty").css({height:"45px"})}});$("body").off("click","#noty_twilio_voicemail");$("body").on("click","#noty_twilio_voicemail",function(b){b.preventDefault();var a=parseInt($(this).attr("data-length"));if(a===1){sendVoiceAndEndCall($(this).attr("data-src"))}else{$("#splitButtonVoicemail").trigger("click")}});$("body").off("click",".voiceMailItem");$("body").on("click",".voiceMailItem",function(a){a.preventDefault();sendVoiceAndEndCall($(this).attr("data-src"))});$("body").off("click",".noty_twilio_answer");$("body").on("click",".noty_twilio_answer",function(a){a.preventDefault();console.log("Twilio call answered from noty");globalconnection.accept()});$("body").off("click",".noty_twilio_ignore");$("body").on("click",".noty_twilio_ignore",function(a){a.preventDefault();console.log("Twilio call ignore from noty");globalconnection.ignore();if(CALL_CAMPAIGN.start){CALL_CAMPAIGN.state="START";dialNextCallManually()}});$("body").off("click",".noty_twilio_cancel");$("body").on("click",".noty_twilio_cancel",function(a){a.preventDefault();console.log("Twilio call canceld from noty");Twilio.Device.disconnectAll()});$("body").off("click","#validate_account");$("body").on("click","#validate_account",function(c){c.preventDefault();console.log("In validate event");if($(this).text()=="Validating..."){console.log("Do not hit me again "+$(this).text());return}if(!isValidForm($("#twilioio_login_form"))){return}var a=$("#twilio_acc_sid").val();var b=$("#twilio_auth_token").val();$("#validate_account").text("Validating...");$("#validate_account").attr("disabled",true);getValidateAndVerfiedCallerId(a,b,null)});$("body").off("change","#twilio_number");$("body").on("change","#twilio_number",function(b){b.preventDefault();$("#error-number-not-selected").hide();var a=$("#twilio_number option:selected").attr("data");console.log("twilio_number change");console.log("twilio_number "+$(this).val()+" clicked "+a);$("#twilio_number_sid").val(a)});$("body").off("change","#twilio_from_number");$("body").on("change","#twilio_from_number",function(a){a.preventDefault();$("#error-number-not-selected").hide()});$("body").off("click",".contact-make-twilio-call,.TwilioIO_call");$("body").on("click",".contact-make-twilio-call, .TwilioIO_call",function(c){c.preventDefault();if($(this).closest(".contact-make-call").hasClass("popover-call")){var d;var b=App_Contacts.contact_popover.toJSON();callToNumber($(this).closest(".contact-make-call").attr("phone"),d,"Twilio",b,"");return}var a=agile_crm_get_contact();TWILIO_CONTACT_ID=a.id;TWILIO_CONTACT=a;if(Twilio.Device.status()=="busy"||checkForActiveCall()){showAlertModal("on_call");return}var a=agile_crm_get_contact();TWILIO_CONTACT_ID=a.id;console.log("phone: "+$(this).closest(".contact-make-call").attr("phone"));if(CALL_CAMPAIGN.start){if(CALL_CAMPAIGN.state=="PAUSE"){showAlertModal("on_call");return}CALL_CAMPAIGN.state="PAUSE"}TWILIO_CALLTYPE="Outgoing";TWILIO_DIRECTION="outbound-dial";TWILIO_IS_VOICEMAIL=false;twiliocall($(this).closest(".contact-make-call").attr("phone"),getContactName(a))});$("body").off("click","#twilio_acc_sid, #twilio_auth_token");$("body").on("click","#twilio_acc_sid, #twilio_auth_token",function(a){a.preventDefault();$("#note-number-not-available").hide()});$("body").off("click",".twilioio-advance-settings");$("body").on("click",".twilioio-advance-settings",function(a){a.preventDefault();if("None"==$("#twilio_twimlet_url").val()){$("#twilio_twimlet_url").val("")}$(".twilioio-advance-settings-hide").toggle();$(".twilioio-advance-settings-show").toggle();$("#twilio_recording").toggle();$("#twilio_twimlet_url_controls").toggle()});$("body").off("click","#twilio_verify_settings");$("body").on("click","#twilio_verify_settings",function(a){a.preventDefault();getTemplate("twilio-initial",{},undefined,function(b){if(!b){return}$("#widget-settings").html($(b))},"#widget-settings")});$("body").off("click","#twilio_verify");$("body").on("click","#twilio_verify",function(b){b.preventDefault();if(!isValidForm($("#twilio_call_form"))){return}var a=$("#twilio_from").val();console.log("Twilio verify from number: "+a);$.getJSON("core/api/widgets/Twilio",function(c){console.log(c);if(c){verifyNumberFromTwilio(a,c.id,function(d){d.settings=true;d.id=Math.floor((Math.random()*10)+1);console.log(d);getTemplate("twilio-verify",d,undefined,function(e){if(!e){return}$("#widget-settings").html($(e))},"#widget-settings")})}})});$("body").off("click",".play-twilio-record");$("body").on("click",".play-twilio-record",function(b){var c=$(".audio-inside-sound:visible").length;while(c>0){$($(".audio-inside-sound:visible")[0]).closest(".twilio-sound").find(".text-inside-sound").show();$($(".audio-inside-sound:visible")[0]).find(".twilio_audio")[0].pause();$($(".audio-inside-sound:visible")[0]).hide();c=c-1}var a=$(this).closest(".twilio-sound");a.find(".audio-inside-sound").show();a.find(".text-inside-sound").hide();a.find(".twilio_audio")[0].play()});$("body").off("click",".close-twilio-record");$("body").on("click",".close-twilio-record",function(b){var a=$(this).closest(".twilio-sound");a.find(".twilio_audio")[0].pause();a.find(".audio-inside-sound").hide();a.find(".text-inside-sound").show()})});function globalTwilioIOSetup(){console.log("Twilio_Setup_Called: "+Twilio_Setup_Called);if(Twilio_Setup_Called){return}Twilio_Setup_Called=true;$.getJSON("/core/api/widgets/TwilioIO",function(twilioio_widget){console.log("twilioio_widget");console.log(twilioio_widget);if(twilioio_widget==null){return}if(twilioio_widget.prefs!=undefined){twilioio_widget.prefs=eval("("+twilioio_widget.prefs+")");if(twilioio_widget.prefs.twilio_from_number){Verfied_Number=twilioio_widget.prefs.twilio_from_number}else{Verfied_Number=twilioio_widget.prefs.twilio_number}getGlobalToken()}}).error(function(data){console.log("twilioio error");console.log(data)})}function getGlobalToken(){console.log("****** In getGlobalToken ******");Restart_Twilio=false;$.get("/core/api/widgets/twilio/getglobaltoken",function(a){console.log("Twilio token "+a);Twilio_Token=a;setUpGlobalTwilio();setTimeout(function(){if(Twilio.Device.status()=="busy"){Restart_Twilio=true}else{globalTwilioIOSetup()}},86400000)}).error(function(a){console.log("Twilio IO error ");console.log(a)})}function getValidateAndVerfiedCallerId(acc_sid,auth_token,callback){$.get("/core/api/widgets/twilio/validateaccount/"+acc_sid+"/"+auth_token,function(result){console.log("Twilio validate account "+result);console.log(result);result=eval("("+result+")");console.log("Twilio validate account "+result);if(result){getTwilioNumbers(acc_sid,auth_token,function(twilioNumbers){getVerifiedNumbers(acc_sid,auth_token,function(verifiedNumbers){addNumbersInUI(twilioNumbers,verifiedNumbers);if(callback&&typeof(callback)==="function"){callback(result)}})})}else{setToValidate(result,true)}}).error(function(data){console.log("Twilio validate account error");setToValidate(data,true)})}function addNumbersInUI(b,a){console.log("Twilio twilio number "+b+"  "+a);console.log("Twilio twilio number "+b.length+"  "+a.length);if(b.length==0&&a.length==0){setToValidate("no number",false);$("#note-number-not-available").html("You have no twilio numbers and verified numbers.");$("#note-number-not-available").show()}else{if(b.length!=0&&a.length==0){$("#note-number-not-available").html("You have no verified numbers. Please verify number in your Twilio account.");$("#note-number-not-available").show();if(!b[0].PhoneNumber){showAlertModal("no_twilio_numbers");return}console.log("Twilio twilio number "+b[0].PhoneNumber);addTwilioNumbersInUI(b);$("#validate_account").hide();$("#save_prefs").show();$("#twilio_from_numbers").hide();$("#twilio_numbers").show();$("#twilio_number").addClass("required")}else{if(b.length==0&&a.length!=0){$("#note-number-not-available").html("You have no twilio numbers. Please buy or port a number in your Twilio account.");$("#note-number-not-available").show();if(!a[0].PhoneNumber){showAlertModal("no_verified_num");return}console.log("Twilio verified number "+a[0].PhoneNumber);addVerifiedCallerIdInUI(a);$("#validate_account").hide();$("#save_prefs").show();$("#twilio_from_numbers").show();$("#twilio_numbers").hide();$("#twilio_from_number").addClass("required")}else{if(b.length!=0&&a.length!=0){addTwilioNumbersInUI(b);addVerifiedCallerIdInUI(a);$("#validate_account").hide();$("#save_prefs").show();$("#twilio_from_numbers").show();$("#twilio_numbers").show()}}}}}function setToValidate(b,a){$("#validate_account").text("Validate");$("#validate_account").attr("disabled",false);console.log("Twilio error ");console.log(b);if(a){showAlertModal("valid_details");return}$("#twilioio_login_form").each(function(){this.reset()})}function getTwilioNumbers(acc_sid,auth_token,callback){$.get("/core/api/widgets/twilio/gettwilionumbers/"+acc_sid+"/"+auth_token,function(result){console.log("Twilio getTwilioNumbers "+result);console.log(result);result=eval("("+result+")");
console.log("Twilio getTwilioNumbers "+result);if(callback&&typeof(callback)==="function"){callback(result)}}).error(function(data){console.log("error in getTwilioNumbers");setToValidate(data,true)})}function getVerifiedNumbers(acc_sid,auth_token,callback){$.get("/core/api/widgets/twilio/getverifiednumbers/"+acc_sid+"/"+auth_token,function(result){console.log("Twilio getVerifiedNumbers "+result);console.log(result);result=eval("("+result+")");console.log("Twilio getVerifiedNumbers "+result);if(callback&&typeof(callback)==="function"){callback(result)}}).error(function(data){console.log("error in getVerifiedNumbers");setToValidate(data,true)})}function addTwilioNumbersInUI(a){var c='<option value="" default selected style="display:none;">Select a Twilio number</option>';var b="";$.each(a,function(e,d){b='<option data="'+d.Sid+'" value="'+d.PhoneNumber+'">'+d.PhoneNumber+"</option>";c=c+b});b='<option data="" value="">None</option>';c=c+b;$("#twilio_number").html(c)}function addVerifiedCallerIdInUI(a){var c='<option value="" default selected style="display:none;">Select a verifed number</option>';var b="";$.each(a,function(e,d){b='<option value="'+d.PhoneNumber+'">'+d.PhoneNumber+"</option>";c=c+b});b='<option data="" value="">None</option>';c=c+b;$("#twilio_from_number").html(c)}function createAppSid(b,c){console.log("In createAppSid");var a="None";if(b.twilio_number_sid!=""){a=b.twilio_number_sid}if(b.twilio_twimlet_url==""){b.twilio_twimlet_url="None"}$.get("/core/api/widgets/twilio/createappsid/"+b.twilio_acc_sid+"/"+b.twilio_auth_token+"/"+a+"/"+b.twilio_record+"/"+encodeURIComponent(b.twilio_twimlet_url),function(d){console.log("Twilio createAppSid "+d);if(c&&typeof(c)==="function"){c(d)}}).error(function(e){console.log("Twilio get app sid error ");console.log(e);var d=this;showAlertModal("valid_details_try_again",undefined,function(){$("#save_prefs").text("Save");$("#save_prefs").attr("disabled",false);$("#save_prefs").hide();$("#validate_account").text("Validate");$("#validate_account").attr("disabled",false);$("#validate_account").show();$("#twilio_from_numbers").hide();$("#twilio_numbers").hide();$("#twilioio_login_form").each(function(){d.reset()})})})}function fill_twilioio_numbers(){$("#validate_account").hide();$("#save_prefs").show();$("#save_prefs").text("Loading...");$("#save_prefs").attr("disabled",true);$.getJSON("/core/api/widgets/TwilioIO",function(twilioio_widget){if(twilioio_widget==null){return}console.log("twilioio_widget");console.log(twilioio_widget);if(twilioio_widget.prefs!=undefined){twilioio_widget.prefs=eval("("+twilioio_widget.prefs+")");if((twilioio_widget.prefs.twilio_record=="true")||(twilioio_widget.prefs.twilio_twimlet_url!="None")){$(".twilioio-advance-settings").click()}getValidateAndVerfiedCallerId(twilioio_widget.prefs.twilio_acc_sid,twilioio_widget.prefs.twilio_auth_token,function(data){console.log("In callback getValidateAndVerfiedCallerId");$("#twilio_from_number").val(twilioio_widget.prefs.twilio_from_number);$("#twilio_number").val(twilioio_widget.prefs.twilio_number);$("#twilio_number_sid").val(twilioio_widget.prefs.twilio_number_sid);$("#save_prefs").text("Save");$("#save_prefs").attr("disabled",false)})}}).error(function(data){console.log("twilioio_widget error");console.log(data)})}function setUpGlobalTwilio(){head.js("https://static.twilio.com/libs/twiliojs/1.2/twilio.min.js",function(){Twilio.Device.setup(Twilio_Token);if(Twilio_Start){return}Twilio_Start=true;Twilio.Device.ready(function(a){console.log("ready");console.log("in twilio ready Twilio_Setup_Called: "+Twilio_Setup_Called);Twilio_Setup_Called=false});Twilio.Device.error(function(a){console.log("Twilio error");console.log(a);console.log(a.code);if(Twilio.Device.status()=="busy"){if(!(CALL_CAMPAIGN.start&&CALL_CAMPAIGN.call_from_campaign)){showAlertModal("active_connection");return}}Twilio.Device.disconnectAll();closeTwilioNoty();if(a.code=="31205"){globalTwilioIOSetup()}if(a.code=="31000"){Twilio_Start=false;setUpGlobalTwilio()}});Twilio.Device.connect(function(b){console.log("Twilio call is connected after sending the request to twilio to dial");console.log(b);console.log(b._status);globalconnection=b;if(CALL_CAMPAIGN.start&&CALL_CAMPAIGN.call_from_campaign){console.log("call campaign is calling and we are changing the conatiner");CALL_CAMPAIGN.call_status="CONNECTED";editCallContainer();return}else{console.log("calling call noty");var a=[{id:"","class":"btn btn-sm btn-default p-xs noty_twilio_mute icon-microphone",title:""},{id:"","class":"btn btn-sm btn-default p-xs noty_twilio_unmute icon-microphone-off",title:""},{id:"","class":"btn btn-xs btn-default noty_twilio_dialpad icon-th",title:""},{id:"","class":"btn btn-sm btn-danger noty_twilio_hangup",title:"Hangup"}];showDraggableNoty("Twilioio",TWILIO_CONTACT,"connected",To_Number,a)}});Twilio.Device.disconnect(function(d){console.log("Twilio call is disconnected");if(CALL_CAMPAIGN.start){CALL_CAMPAIGN.call_status="DISCONNECTED"}console.log(d);var a=To_Number;var e=d.message;if(Twilio.Device.status()!="busy"){closeTwilioNoty();if(globalconnection){globalconnection.mute(false)}if(Restart_Twilio==true){globalTwilioIOSetup()}}try{console.log("Get all call logs for widget only on cotact detail page in disconnected function");if(window.location.hash.indexOf("contact/")!=-1){if(typeof getTwilioIOLogs=="undefined"){return}getTwilioIOLogs(a);var c=$("#contact_number").val();if(c!=a){$("#contact_number").val(a)}}}catch(b){console.log("error in log fetching"+b.message)}try{console.log("calSid new  "+d.parameters.CallSid);console.log("getting twilio widget iin disconnect");twilioGetWidgetDetails(function(l){console.log("after getting twilio widget in disconnect");var m=l;var j=$.parseJSON(l.prefs);var h=j.twilio_acc_sid;var k=j.twilio_auth_token;var f="true";if(TWILIO_CALLTYPE=="Incoming"){f="false"}var g="/core/api/widgets/twilio/getlastcall/"+h+"/"+k+"/"+d.parameters.CallSid+"/"+f;console.log(g);if(!m){return}twilioApiRequest(g,function(n){var s=n;console.log("Call Details : isParent "+f);console.log(s);if(!s){return}var p=$.parseJSON(s.responseText);if(f=="true"){var o=p.calls[0]}else{var o=p}var q=false;if(typeof o!="undefined"){q=true;if(typeof o.status!="undefined"){if(o.status!="completed"&&CALL_CAMPAIGN.start){CALL_CAMPAIGN.state="DISCONNECTED";q=false}console.log(o.status);showNoteAfterCall(o,e)}}else{if(CALL_CAMPAIGN.start){CALL_CAMPAIGN.state="DISCONNECTED"}}if(!q){if(CALL_CAMPAIGN.start){if(CALL_CAMPAIGN.call_from_campaign){if(TWILIO_IS_VOICEMAIL){TWILIO_IS_VOICEMAIL=false}CALL_CAMPAIGN.state="START";if(CALL_CAMPAIGN.autodial){dialNextCallAutomatically()}else{if(CALL_CAMPAIGN.last_clicked=="NEXT"||CALL_CAMPAIGN.last_clicked=="PREVIOUS"){dialNextCallAutomatically()}else{dialNextCallManually()}}}else{CALL_CAMPAIGN.state="START";dialNextCallManually()}}}})})}catch(b){console.log("error in geting twilio widget --> "+b.message);console.log("dialing next call for call campaign");if(CALL_CAMPAIGN.start){CALL_CAMPAIGN.state="START";dialNextCallAutomatically()}}});Twilio.Device.incoming(function(a){TWILIO_CALLTYPE="Incoming";TWILIO_DIRECTION="inbound";TWILIO_IS_VOICEMAIL=false;TWILIO_CONTACT_ID=0;TWILIO_CONTACT=null;globalconnection=a;var b;if(To_Number){b=To_Number}To_Number=globalconnection.parameters.From;console.log("Incoming connection from "+a.parameters.From);console.log("globalconnection status: "+globalconnection.status());addContactImg("Incoming",function(c){Twilio_Call_Noty_IMG=c;if(Twilio.Device.status()=="busy"||(CALL_CAMPAIGN.call_status=="CONNECTED"||CALL_CAMPAIGN.call_status=="CALLING"||CALL_CAMPAIGN.autodial==true)){console.log("getting one more call.");var d=[];showDraggableNoty("Twilioio",TWILIO_CONTACT,"missedCall",a.parameters.From,d);if(b){To_Number=b}a.reject();if(a){a.disconnect()}return}if(CALL_CAMPAIGN.start){CALL_CAMPAIGN.state="PAUSE"}searchForContact(To_Number,function(e){To_Name=e;var f=[{id:"","class":"btn btn-primary noty_twilio_answer",title:"Answer"},{id:"","class":"btn btn-danger noty_twilio_ignore",title:"Ignore"}];showDraggableNoty("Twilioio",TWILIO_CONTACT,"incoming",To_Number,f)})})});Twilio.Device.offline(function(){console.log("Twilio went offline");closeTwilioNoty()});Twilio.Device.cancel(function(a){console.log(a.parameters.From);closeTwilioNoty();console.log("Incoming call calSid new  "+a.parameters.CallSid);var b=a.message;twilioGetWidgetDetails(function(h){var j=h;var f=$.parseJSON(j.prefs);var e=f.twilio_acc_sid;var g=f.twilio_auth_token;var c="true";if(TWILIO_CALLTYPE=="Incoming"){c="false"}var d="/core/api/widgets/twilio/getlastcall/"+e+"/"+g+"/"+a.parameters.CallSid+"/"+c;console.log(d);if(!j){return}twilioApiRequest(d,function(k){var m=k;console.log(m);if(!m){return}var l=$.parseJSON(m.responseText);if(typeof l!="undefined"){if(typeof l.status!="undefined"){console.log(l.status);showNoteAfterCall(l,b)}}if(CALL_CAMPAIGN.start){CALL_CAMPAIGN.state="START";if(CALL_CAMPAIGN.autodial){dialNextCallAutomatically()}else{dialNextCallManually()}}})})});Twilio.Device.presence(function(a){console.log(a.from);console.log(a.available)})})}function twiliocall(d,c,b,a){console.log("In twilio call finction after makingcall function and starting call");params={from:Verfied_Number,PhoneNumber:d};try{if(CALL_CAMPAIGN.start){if(Twilio.Device.status()=="busy"||CALL_CAMPAIGN.call_status=="CONNECTED"||CALL_CAMPAIGN.call_status=="CALLING"){return}if(CALL_CAMPAIGN.call_from_campaign){TWILIO_CALLTYPE="Outgoing";TWILIO_DIRECTION="outbound-dial";CALL_CAMPAIGN.call_status="CALLING";$("#pauseCallDiv").hide();$("#callStartText").html("");$("#callStartTime").html("");$("#callPauseText").hide()}}}catch(e){console.log("error happened while calling from campaign --> "+e.message);Twilio.Device.disconnectAll();$("#callStartText").html("");$("#callStartTime").html("");return}Twilio.Device.connect(params);console.log("calling request sent to twilio to start call");To_Number=d;To_Name=c;TWILIO_CALLED_NO=To_Number;if(!CALL_CAMPAIGN.call_from_campaign){addContactImg("Outgoing",function(f){Twilio_Call_Noty_IMG=f;
console.log("calling call noty");var g=[{id:"","class":"btn btn-default btn-sm noty_twilio_cancel",title:"Cancel"}];showDraggableNoty("Twilioio",TWILIO_CONTACT,"outgoing",To_Number,g)},a)}}function twilioSendDTMF(a){console.log("twilioSendDTMF: "+a);if(Twilio.Device.status()=="busy"&&a){globalconnection.sendDigits(a)}}function closeTwilioNoty(){if(Twilio.Device.status()=="busy"){return}globalconnection=undefined;To_Number=undefined;To_Name="";closeCallNoty(true);if(Twilio_Call_Noty!=undefined){Twilio_Call_Noty.close();Twilio_Call_Noty=undefined}}function showNoteAfterCall(a,c,e){if(!(TWILIO_IS_VOICEMAIL==false)){return}var b=$("#noteForm");if(CALL_CAMPAIGN.start){if(TWILIO_CALLTYPE=="Outgoing"&&CALL_CAMPAIGN.call_from_campaign){getContactDetails()}}var f=a.status;var j="";var d="";var h="";var k="";if(TWILIO_DIRECTION=="outbound-dial"){k=TWILIO_CALLED_NO}else{k=a.from}if(f!=404&&typeof a.duration!="undefined"){switch(f){case"canceled":d=TWILIO_CALLTYPE+" call - Declined";h="Declined";j="failed";break;case"completed":d=TWILIO_CALLTYPE+" call - Done";h="Done";j="answered";break;case"busy":d=TWILIO_CALLTYPE+" call - Busy";h="Received busy tone on number "+k;j="busy";break;case"failed":d=TWILIO_CALLTYPE+" call - Failed";h=TWILIO_CALLTYPE+" call made to "+k+" has failed";j="failed";break;case"no-answer":d=TWILIO_CALLTYPE+" call - No answer";h="No answer";j="busy";break;default:return}}else{return}if(TWILIO_CONTACT_ID){accessUrlUsingAjax("core/api/contacts/"+TWILIO_CONTACT_ID,function(o){console.log(a);var l=o;if(l==null){return showNewContactModal(k)}var m=getContactName(l);if(TWILIO_DIRECTION=="outbound-dial"){k=TWILIO_CALLED_NO;TWILIO_CALLED_NO=""}else{k=a.from}if(f=="completed"){var n={};n.url="/core/api/widgets/twilio/";n.subject=d;n.number=k;n.callType=TWILIO_DIRECTION;n.status="answered";n.duration=a.duration;n.contId=l.id;n.contact_name=m;n.widget="Twilio";showDynamicCallLogs(n);if(TWILIO_DIRECTION=="outbound-dial"){twilioIOSaveContactedTime();if(CALL_CAMPAIGN.start&&CALL_CAMPAIGN.call_from_campaign){updateTotalTime(a.duration);saveTagForCampaign()}}}else{$.post("/core/api/widgets/twilio/autosavenote",{subject:d,message:"",contactid:TWILIO_CONTACT_ID,phone:k,callType:TWILIO_DIRECTION,status:j,duration:0},function(p){if(TWILIO_DIRECTION=="outbound-dial"){if(f!="completed"){$.post("/core/api/widgets/twilio/savecallactivityById?note_id="+p.id,{id:TWILIO_CONTACT_ID,direction:p.callType,phone:p.phone,status:p.status,duration:p.duration})}}else{try{if(e){if(!jQuery.isEmptyObject(e)){if(e.cnf_started){k=TWILIO_CALLED_NO}}}}catch(q){}if(f!="completed"){$.post("/core/api/widgets/twilio/savecallactivity?note_id="+p.id,{direction:p.callType,phone:p.phone,status:p.status,duration:p.duration})}}TWILIO_CONTACT_ID=null})}})}else{resetCallLogVariables();if(f=="completed"){var g={};g.url="/core/api/widgets/twilio/";g.subject=d;g.number=k;g.callType=TWILIO_DIRECTION;g.status="answered";g.duration=a.duration;g.contId=null;g.contact_name="";g.widget="Twilio";CallLogVariables.dynamicData=g}CallLogVariables.callWidget="Twilio";CallLogVariables.callType=TWILIO_DIRECTION;CallLogVariables.phone=k;CallLogVariables.duration=a.duration;CallLogVariables.status=a.status;return showNewContactModal(k)}}function showNewContactModal(a){$("#personModal").modal("show");$("#personForm").find("#phone").val(a);$("#personForm").find("#phone").removeClass("phone");return}function twilioSecondsToFriendly(d){var b=Math.floor(d/3600);if(b>0){d=d-b*60*60}var c=Math.floor(d/60);var e=d-c*60;var a="";if(b==1){a=b+"h "}if(b>1){a=b+"h "}if(c>0){a+=c+"m "}if(e>0){a+=e+"s "}if(a!=""){return a}}function searchForContact(d,c){console.log("searchForContact : "+d);var a="";try{accessUrlUsingAjax("core/api/contacts/search/phonenumber/"+d,function(e){if(!e){c(a)}TWILIO_CONTACT_ID=e.id;TWILIO_CONTACT=e;console.log("TWILIO_CONTACT_ID : "+TWILIO_CONTACT_ID);c(getContactName(e))})}catch(b){c(a)}}function sendVoiceAndEndCall(a){console.log("Sending voice mail...");if(TWILIO_IS_VOICEMAIL==false){var b=globalconnection;twilioGetWidgetDetails(function(h){var j=h;var f=$.parseJSON(j.prefs);var e=f.twilio_acc_sid;var g=f.twilio_auth_token;var c="true";var d="/core/api/widgets/twilio/getlastcall/"+e+"/"+g+"/"+b.parameters.CallSid+"/"+c;if(!j){return}twilioApiRequest(d,function(k){var o=k;if(!o){return}var m=$.parseJSON(o.responseText);if(c=="true"){var l=m.calls[0]}else{var l=m}if(typeof l!="undefined"){if(typeof l.status!="undefined"&&l.status=="in-progress"){var n=globalconnection.message;twilioVoiceMailRedirect(a,function(p){if(!p){return}closeTwilioNoty();if(CALL_CAMPAIGN.start){if(TWILIO_CALLTYPE=="Outgoing"&&CALL_CAMPAIGN.call_from_campaign){getContactDetails()}}if(TWILIO_CONTACT_ID){$.post("/core/api/widgets/twilio/autosavenote",{subject:TWILIO_CALLTYPE+" call - Left voicemail",message:"",contactid:TWILIO_CONTACT_ID,phone:TWILIO_CALLED_NO,callType:TWILIO_DIRECTION,status:"voicemail",duration:0},function(q){if(TWILIO_CALLED_NO!=""){$.post("/core/api/widgets/twilio/savecallactivityById?note_id="+q.id,{id:TWILIO_CONTACT_ID,direction:TWILIO_DIRECTION,phone:TWILIO_CALLED_NO,status:"voicemail",duration:0},function(s){console.log(s)})}});TWILIO_IS_VOICEMAIL=true}})}}else{return}})})}}function twilioVoiceMailRedirect(a,b){twilioGetWidgetDetails(function(h){var j=h;if(!j){return b(false)}var f=$.parseJSON(j.prefs);var e=f.twilio_acc_sid;var g=f.twilio_auth_token;var c="true";if(TWILIO_CALLTYPE=="Incoming"){c="false"}var d="/core/api/widgets/twilio/getlastcall/"+e+"/"+g+"/"+globalconnection.parameters.CallSid+"/"+c;console.log(d);twilioApiRequest(d,function(k){var o=k;console.log("Call Details : isParent "+c);console.log(o);if(!o){return}var m=$.parseJSON(o.responseText);if(c=="true"){var l=m.calls[0]}else{var l=m}d="/core/api/widgets/twilio/setvoicemail/"+e+"/"+g+"/"+l.sid+"/"+a;console.log("In ajax send voice mail : "+d);var n=twilioApiRequest(d);if(CALL_CAMPAIGN.start){$("#noty_twilio_voicemail").attr("disabled","disabled");$("#splitButtonVoicemail").attr("disabled","disabled")}return b(true)})})}function twilioGetWidgetDetails(a){accessUrlUsingAjax("/core/api/widgets/TwilioIO",function(b){return a(b)})}function twilioApiRequest(a,b){accessUrlUsingAjax(a,function(c){return b(c)})}function searchForContactImg(d,c){console.log("searchForContactImg : "+d);var a="";try{accessUrlUsingAjax("core/api/contacts/search/phonenumber/"+d,function(f){var e=f;console.log("**** responseJson ****");console.log(e);return c(e)})}catch(b){return c(null)}}function addContactImg(h,g,a){var d="";try{if(h=="Outgoing"){var f;if(a){f=a}else{try{f=agile_crm_get_contact()}catch(c){}}if(!f){return g(d)}var b=getGravatar(f.properties,40);d='<a href="#contact/'+TWILIO_CONTACT_ID+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+b+'" style="display:inline;"></a>';return g(d)}else{searchForContactImg(To_Number,function(e){var k=e;if(k!=null){var j=getGravatar(k.properties,40);d='<a href="#contact/'+TWILIO_CONTACT_ID+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+j+'" style="display:inline;"></a>'}return g(d)})}}catch(c){console.log("error occured in getting image "+c);return g(d)}}function getGravatar(b,d){if(b==undefined){return}var h=getPropertyValue(b,"image");if(h){return h}var a=DEFAULT_GRAVATAR_url;var g='&d=404" ';var f=text_gravatar_initials(b);if(f.length==0){g="&d="+DEFAULT_GRAVATAR_url+'" '}var e='onLoad="image_load(this)" onError="image_error(this)" _data-name="'+f;var c=getPropertyValue(b,"email");if(c){return("https://secure.gravatar.com/avatar/"+Agile_MD5(c)+".jpg?s="+d+g+e)}return("https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+d+""+g+e)}var widgetDisplayname={Rapleaf:"TowerData",Twilio:"Twilio Call Log",HelpScout:"Help Scout",TwilioIO:"Twilio",GooglePlus:"Google+",CallScript:"Call Script",Uservoice:"UserVoice"};var isForAll=false;function initializeTabListeners(b,a){$("#prefs-tabs-content .widgets_inner ul li").off("click");$("#prefs-tabs-content").on("click",".tab-container ul li",function(){var c=$(this).find("a").attr("href").split("#");_agile_set_prefs(b,c[1]);Backbone.history.navigate(a,{trigger:true})})}function update_collection_with_prefs(a){console.log("In update_collection_with_prefs");console.log(a);if(App_Widgets.Catalog_Widgets_View&&App_Widgets.Catalog_Widgets_View.collection){var b=App_Widgets.Catalog_Widgets_View.collection.where({name:a.name});if(b&&b[0]){b[0].set({prefs:a.prefs});console.log(App_Widgets.Catalog_Widgets_View.collection.where({name:a.name})[0])}}if(Widgets_View&&Widgets_View.collection){var b=Widgets_View.collection.where({name:a.name});if(b&&b[0]){b[0].set({prefs:a.prefs});console.log(Widgets_View.collection.where({name:a.name})[0])}}}function save_widget_prefs(e,c,h){console.log("In save_widget_prefs.");var b="success";var a;var f;var g=App_Widgets.Catalog_Widgets_View.collection.where({name:e});var d=new Backbone.Model();console.log(d);d.url="/core/api/widgets";g[0].set("prefs",c);g[0].set("isForAll",isForAll);d.save(g[0].toJSON(),{success:function(k){if(Widgets_View&&Widgets_View.collection){Widgets_View.collection.add(new BaseModel(k.toJSON()))}k.set("is_added",true);g[0].set(k);var j=k.id;a=widgetDisplayname[e];if(!a){a=e}f=a+" widget saved successfully";if(j){if(e!="CallScript"){window.location.href=("#"+e+"/"+k.id)}console.log("data******");console.log(k);update_collection_with_prefs(k);if(e=="Sip"){if(Sip_Start==true){Sip_Updated=true;sipUnRegister()}sipStart();globalCallWidgetSet()}if(e=="TwilioIO"){Twilio_Setup_Called=false;globalTwilioIOSetup();globalCallWidgetSet()}if(e=="Bria"){globalCallWidgetSet()}if(e=="Skype"){globalCallWidgetSet()}}else{b="error";if(e=="Braintree"||a=="Uservoice"){f="Invalid  "+a+" credentials"}else{f=("Error occurred while saving "+a)}}showNotyPopUp(b,f,"bottomRight");$("#stripe_url").removeAttr("disabled");if(h&&typeof(h)==="function"){h(k)}},error:function(j){console.log(j);b="error";if(e=="Braintree"||e=="Uservoice"){f="Invalid  "+e+" credentials"
}else{f="Error occurred while saving "+e}$("#stripe_url").removeAttr("disabled");showNotyPopUp(b,f,"bottomRight");$("#save_prefs").removeAttr("disabled")}})}function setUpError(f,a,c,g,b){$("#content").html(getTemplate("settings"),{});var e;var h;var d;if(b){e=$(getTemplate("widget-settings",b));d=b}else{if(!App_Widgets.Catalog_Widgets_View||App_Widgets.Catalog_Widgets_View.collection.length==0){if(callback){callback(e)}App_Widgets.Catalog_Widgets_View.collection.fetch({success:function(){$.getJSON("core/api/widgets/"+f,function(j){setUpError(f,a,c,g,j)})}});return}h=App_Widgets.Catalog_Widgets_View.collection.where({name:f});d=h[0].toJSON();e=$(getTemplate("widget-settings",d))}d.error_message=c;d.error_url=g}function set_up_access(e,a,d,c,b){getTemplate("settings",{},undefined,function(h){if(!h){return}$("#content").html($(h));var g;var f;var j;$("#prefs-tabs-content").html(getRandomLoadingImg());$("#PrefsTab .select").removeClass("select");$(".add-widget-prefs-tab").addClass("select");if(b){getTemplate("widget-settings",b,undefined,function(l){if(!l){return}g=$(l);var k=_agile_get_prefs("widget_tab");g.find('a[href="#'+k+'"]').closest("li").addClass("active");initializeTabListeners("widget_tab","add-widget");f=b;setup_widget_revoke_access(g,f,d,e,a,c,b)},null);return}else{$("#widget-settings",g).html(getTemplate(a,f));App_Widgets.Catalog_Widgets_View=new Base_Collection_View({url:"/core/api/widgets/default"});$("#prefs-tabs-content").find("form").data("widget",f);$.getJSON("core/api/widgets/"+e,function(k){set_up_access(e,a,d,c,k)})}})}function addWidgetProfile(d,c,b,a){loadSettingsUI(function(){getWidgetModelFromName(d,"",function(e){$.getJSON((a),function(f){getTemplate("widget-settings",e,undefined,function(k){$("#prefs-tabs-content").html(k);if(c=="GooglePlus"){var h=JSON.parse(e.prefs);$.getJSON("https://www.googleapis.com/plus/v1/people/me?access_token="+h.access_token).success(function(l){e.profile=l;renderWidgetView(b,a,e,"#widget-settings");return}).error(function(){e.profile={};renderWidgetView(b,a,e,"#widget-settings");return});return}else{if(c=="Stripe"){if(e){e.prefs=JSON.parse(e.prefs)}$.getJSON("core/api/custom-fields/type/scope?scope=CONTACT&type=TEXT",function(l){e.custom_data=l;renderWidgetView(b,a,e,"#widget-settings");return});try{e.profile=JSON.parse(e.prefs)}catch(g){console.log("stripe try error");e.profile=e.prefs}}else{if(f){if($.isArray(f)){e.profile=jQuery.parseJSON(e.prefs)}else{try{f.prefs=jQuery.parseJSON(f.prefs)}catch(j){console.log("Error occured while parsing widget prefs")}e.profile=f}}renderWidgetView(b,a,e,"#widget-settings")}}})})})})}function addOAuthWidget(c,b,a){loadSettingsUI(function(){getWidgetModelFromName(c,"name",function(d){if(d){d.url=a}getTemplate("widget-settings",d,undefined,function(e){$("#prefs-tabs-content").html(e);renderWidgetView(b,"core/api/widgets",d,"#widget-settings");$('[data-toggle="tooltip"]').tooltip()})})})}function addConfigurableWidget(c,b,a){loadSettingsUI(function(){var e="";var d="";if(!c){e="name";d=b}else{d=c}getWidgetModelFromName(d,e,function(f){var g=getTemplate("widget-settings",f);$("#prefs-tabs-content").html(g);if(b=="Braintree"){$.get("/core/api/custom-fields/type/scope?scope=CONTACT&type=TEXT",function(h){f.custom_fields=h;renderWidgetView(a,"core/api/widgets",f,"#widget-settings")},"json").error(function(h){})}else{renderWidgetView(a,"core/api/widgets",f,"#widget-settings")}if(f.name=="TwilioIO"&&f.is_added){fill_twilioio_numbers()}})})}function loadSettingsUI(a){getTemplate("settings",{},undefined,function(b){if(!b){return}$("#content").html($(b));$("#prefs-tabs-content").html(getRandomLoadingImg());$("#PrefsTab .select").removeClass("select");$(".add-widget-prefs-tab").addClass("select");if(a){a()}},"#content")}function getWidgetModelFromName(b,a,c){getAgileConfiguredWidgetCollection(function(e){var d="";if(a=="name"){models=e.where({name:b});d=models[0]}else{d=e.get(b)}if(!d){Backbone.history.navigate("add-widget",{trigger:true});return}c(d.toJSON())})}function deserializeWidget(b,a){if(!b.prefs){return}deserializeForm(JSON.parse(b.prefs),$(a).find("form"))}function organize_widgets(a){var c=new Base_List_View({model:a,template:this.options.templateKey+"-model",tagName:"div",});var d=a.get("widget_type");var b="";if(d=="SOCIAL"){b="social"}if(d=="SUPPORT"){b="support"}if(d=="EMAIL"){b="email"}if(d=="CALL"){if(a.get("name")=="Twilio"&&!a.get("is_added")){console.log("It is old twilio")}else{b="call"}}if(d=="BILLING"){b="billing"}if(d=="ECOMMERCE"){b="ecommerce"}if(d=="CUSTOM"){b="custom"}if(b){$("#"+b,this.el).append($(c.render().el).addClass("col-md-4 col-sm-6 col-xs-12"))}}function initializeWidgetSettingsListeners(){$("#prefs-tabs-content").off();$("#prefs-tabs-content .install-custom-widget").off("click");$("#prefs-tabs-content, #custom-widget").on("click",".install-custom-widget",function(c){c.preventDefault();console.log($(this));if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");var b=$(this).attr("widget-name");console.log("In add widget");console.log(b);if(App_Widgets.Catalog_Widgets_View==null){return}var d=App_Widgets.Catalog_Widgets_View.collection.where({name:b});var a=new Backbone.Model();console.log(a);a.url="/core/api/widgets";a.save(d[0].toJSON(),{success:function(e){if(Widgets_View&&Widgets_View.collection){Widgets_View.collection.add(new BaseModel(e.toJSON()))}e.set("is_added",true);d[0].set(e)}})});$("#prefs-tabs-content .acl_widget").off("click");$("#prefs-tabs-content").on("click",".acl_widget",function(b){var c=$(this).attr("widget-data");var a=$(this);$.getJSON("core/api/users/agileusers",function(g){var e={};e.widget=JSON.parse(c);var d=JSON.stringify(e.widget.listOfUsers);for(var f=0;f<g.length;f++){var h=g[f];if(h){if(d){if(d.indexOf(h.id)>0){h.isChecked=true;g[f]=h}else{g[f]=h}}}}e.data=g;getTemplate("widget-acls-modal-content",e,undefined,function(j){$("#widget-acls-modal").html(j).modal("show");$("#widget-acls-modal").off("click",".agileUserChk_all");$("#widget-acls-modal").on("click",".agileUserChk_all",function(k){if($(this).is(":checked")){$("#widget-acls-modal .agileUserChk").prop("checked",true)}else{$("#widget-acls-modal .agileUserChk").prop("checked",false)}});$("#widget-acls-modal").off("click",".widget_acl_save");$("#widget-acls-modal").on("click",".widget_acl_save",function(n){var k=$(this).attr("widget-id");var m=e.widget;var l=[];$("input:checkbox[name=agileUserChk]:checked").each(function(o){l.push($(this).val())});m.listOfUsers=l;$.ajax({type:"POST",url:"/core/api/widgets/saveWidgetPrivilages",data:JSON.stringify(m),success:function(o){var p=e.widget;p.listOfUsers=m.listOfUsers;a.attr("widget-data",JSON.stringify(p));console.log("Widget ACL updated");Widgets_View=undefined;$("#widget-acls-modal").html(j).modal("hide");showNotyPopUp("success","Widgets updated successfully","bottomRight")},error:function(){showNotyPopUp("error","Widgets update failed","bottomRight")}})})})})});$("#prefs-tabs-content #delete-widget").off("click");$("#prefs-tabs-content").on("click","#delete-widget",function(d){var c=$(this).attr("widget-name");var b=$(this).attr("widget-displayname");var a;if(b){a=b}else{a=widgetDisplayname[c];if(!a){a=c}}showAlertModal("Are you sure to delete "+a+"?","confirm",function(){delete_widget(c);if(c=="Linkedin"){$("#Linkedin-container").hide()}if(c=="Twilio"){$("#Twilio-container").hide()}},undefined,"Delete Widget")});$("#prefs-tabs-content .add_to_all").off("click");$("#prefs-tabs-content").on("click",".add_to_all",function(a){isForAll=true});$("#prefs-tabs-content .add-widget").off("click");$("#prefs-tabs-content").on("click",".add-widget",function(a){isForAll=false});$("#prefs-tabs-content #remove-widget").off("click");$("#prefs-tabs-content").on("click","#remove-widget",function(b){var a=$(this).attr("widget-name");showAlertModal("delete","confirm",function(){delete_widget(a);$.ajax({type:"DELETE",url:"/core/api/widgets/remove?widget_name="+a,contentType:"application/json; charset=utf-8",success:function(c){update_collection(a);App_Widgets.Catalog_Widgets_View.collection.fetch()},dataType:"json"})},undefined,"Delete Widget")})}function delete_widget(a){$.ajax({type:"DELETE",url:"/core/api/widgets?widget_name="+a,contentType:"application/json; charset=utf-8",success:function(b){App_Widgets.Catalog_Widgets_View.collection.where({name:a})[0].set({is_added:false},{silent:true}).unset("prefs");update_collection(a);location.reload()},dataType:"json"})}function update_collection(b){if(Widgets_View&&Widgets_View.collection){var a=Widgets_View.collection.where({name:b});Widgets_View.collection.remove(a)}}var businessHoursManager;function initializeOnlineCalendarListners(a){$("#online-cal-listners").off();$("#online-cal-listners #btnSerialize").off("click");$("#online-cal-listners").on("click","#btnSerialize",function(j){j.preventDefault();var g=$(this);disable_save_button($(g));if(!$.trim($("#15mins").val())&&!$.trim($("#30mins").val())&&!$.trim($("#60mins").val())){enable_save_button($(g));$("#meeting_duration_message").fadeIn("slow");setTimeout(function(){$("#meeting_duration_message").fadeOut("slow")},5000);return}if($("#15mins").val().charCodeAt(0)==" "&&$("#30mins").val().charCodeAt(0)==" "&&$("#60mins").val().charCodeAt(0)==" "){enable_save_button($(g));$("#meeting_duration_message").fadeIn("slow");setTimeout(function(){$("#meeting_duration_message").fadeOut("slow")},5000);return}var f=$("#scheduleurl").text();var h=f.substr(f.lastIndexOf("/")+1);var b=f.substr(0,f.lastIndexOf("/")+1);var d=serializeForm("scheduleform");var k=formToJSON();console.log(k);var c=JSON.stringify(businessHoursManager.serialize());d.business_hours=c;d.meeting_durations=k;d.schedule_id=h;d.bufferTime=$("#bufferTime").val();d.bufferTimeUnit=$("#bufferTimeUnit").val();d.user_calendar_title=$(".online_summer_note").code();console.log(c);$.ajax({url:"/core/api/scheduleprefs",type:"PUT",contentType:"application/json",data:JSON.stringify(d),success:function(){setTimeout(function(){enable_save_button($(g))
},2000);$("#error_message").empty()},error:function(e){$("#error_message").html("There was an error in saving your settings.");enable_save_button($(g))}})});$("#online-cal-listners #edit-schedule-id").off("click");$("#online-cal-listners").on("click","#edit-schedule-id",function(f){f.preventDefault();var c=$("#scheduleurl").text();var d=c.substr(c.lastIndexOf("/")+1);var b=c.substr(0,c.lastIndexOf("/")+1);console.log(b+"   "+d);$("#edit").hide();$("#scheduleurl").removeAttr("href");$("#scheduleurl").html(b+"<input class='input-sm inline-block form-control' style='width:140px' type='text'  name='url' id='url' value='"+d+"'/><buttion class='btn btn-primary btn-sm inline-block m-l-sm' id='save-scheduleurl'>Save</button>");$("#scheduleurl").addClass("nounderline");$("#scheduleModal").data("modal",null)});$("#online-cal-listners #save-scheduleurl").off("click");$("#online-cal-listners").on("click","#save-scheduleurl",function(f){f.preventDefault();var d=$("#url").val();if(d.length<4){$("#charlength").fadeIn("slow");setTimeout(function(){$("#charlength").fadeOut("slow")},2000);return}var b=/^[0-9a-zA-Z\_]+$/;if(!(b.test(d))){$("#specialchar").fadeIn("slow");setTimeout(function(){$("#specialchar").fadeOut("slow")},2000);return}var c=$(this);disable_save_button($(c));$.ajax({url:"/core/api/scheduleprefs/updateId?scheduleid="+d+"&domainId="+CURRENT_DOMAIN_USER.id,type:"GET",datatype:"json",success:function(e){var g="https://"+CURRENT_DOMAIN_USER.domain+".agilecrm.com/calendar/"+e.schedule_id;$("#scheduleurl").attr("href",g);$("#scheduleurl").text(g);$("#scheduleurl").removeClass("nounderline");enable_save_button($(c));$("#edit").show();$("#specialchar").hide();$("#charlength").hide();$("#scheduleurl").removeClass("nounderline")},error:function(e){console.log(e);$("#schedule_error_message").html("Something went wrong as your schedule url was not updated."+e.statusText);$("#schedule_error_message").fadeIn("slow");setTimeout(function(){$("#schedule_error_message").fadeOut("slow")},2000);enable_save_button($(c));return}})});$("#online-cal-listners #calendar_advanced").off("click");$("#online-cal-listners").on("click","#calendar_advanced",function(b){b.preventDefault();$("#calendar_advanced span i").toggleClass("fa-minus");$("#calendar_advanced span i").toggleClass("fa-plus")});$("#online-cal-listners #calendar_advanced_block").off("shown");$("#online-cal-listners").on("shown","#calendar_advanced_block",function(b){$("#calendar_advanced").html('<span><i class="icon-minus"></i></span> Advanced')});$("#online-cal-listners #calendar_advanced_block").off("hidden");$("#online-cal-listners").on("hidden","#calendar_advanced_block",function(b){$("#calendar_advanced").html('<span><i class="icon-plus"></i></span> Advanced')});$("#online-cal-listners #bufferTime").off("keypress");$("#online-cal-listners").on("keypress","#bufferTime",function(b){if(b.which!=8&&b.which!=0&&(b.which<48||b.which>57)){$("#errmsg").html("Digits Only").show().fadeOut(3000);return false}});$("#online-cal-listners .onlineCalendarAddToSite").off("click");$("#online-cal-listners").on("click",".onlineCalendarAddToSite",function(b){b.preventDefault();console.log("asadfas");$("body #onlineCalendarAddToSite").remove();getTemplate("online-calendar-addtosite",{},undefined,function(c){if(!c){return}onlineCalendarModel=$(c);onlineCalendarModel.modal("show")},null)})}$("body").on("click",".getStartedToAddToSite",function(a){a.preventDefault();Backbone.history.navigate("webrules-add",{trigger:true});if(onlineCalendarModel){onlineCalendarModel.modal("hide")}onlineCalendarModel=null;getHtmlContent(function(b){setTimeout(function(){tinyMCECallBack("tinyMCEhtml_email",b)},1000)})});function getHtmlContent(a){$.get("/misc/modal-templates/schedule/popout/pop-out.html",function(b){return a(b)})}function formToJSON(){return JSON.stringify({"15mins":$("#15mins").val().trim(),"30mins":$("#30mins").val().trim(),"60mins":$("#60mins").val().trim()})}function organize_portlets(a){var b=new Base_List_View({model:a,template:this.options.templateKey+"-model",tagName:"div",className:"col-md-3 col-sm-6 col-xs"});var d=a.get("portlet_type");var c={CONTACTS:"contacts",DEALS:"deals",TASKSANDEVENTS:"taksAndEvents",USERACTIVITY:"userActivity",RSS:"rssFeed",ACCOUNT:"accountInfo",WEBSTATS:"webstats"};$("#"+c[d],this.el).append($(b.render().el))}function set_p_portlets(a){console.log("collection----"+Portlets_View.collection.length);var c={Contacts:"contacts",Deals:"deals",Tasks:"tasks",Events:"calendar",DashBoard:"dashboard"};if((a.toJSON().column_position==-1&&a.toJSON().row_position==-1)&&isNaN(a.toJSON().portlet_route)){App_Portlets.RoutePortlets.push(a);return}if(a.toJSON().isForAll){App_Portlets.adminPortlets.push(a);return}if(a.toJSON().portlet_route!="DashBoard"&&!isNaN(a.toJSON().portlet_route)&&a.get("row_position")==-1&&a.get("column_position")==-1){App_Portlets.DashboardPortlets.push(a);return}if(Current_Route!=undefined&&Current_Route.toUpperCase()!=("DashBoard").toUpperCase()&&Portlets_View.collection.length!=0&&!$(".route_Portlet").is(":visible")){$("#portlets").parents(".route_Portlet").show()}var b=this;portlet_utility.getOuterViewOfPortlet(a,this.el,function(){portlet_utility.getInnerViewOfPortlet(a,b.el)})}function setPortletContentHeight(c){if(c.get("name")=="Stats Report"||c.get("name")=="Deal Goals"){var b=$("#"+c.get("id")).parent().find(".stats_report_portlet");var d=c.get("size_y"),a=0;if(d==1){a=(d*200)}else{if(d==2){a=(d*200)+10}else{if(d==3){a=(d*200)+20}}}var e={"overflow-x":"hidden","overflow-y":"hidden",height:a+"px","max-height":a+"px"};b.css(e)}else{if(c.get("name")=="Mini Calendar"){var b=$("#"+c.get("id")).parent().find(".portlet_body_calendar");var d=c.get("size_y"),a=0;if(d==1){a=(d*200)}else{if(d==2){a=(d*200)+25}else{if(d==3){a=(d*200)+50}}}var e={height:a+"px","max-height":a+"px"};b.css(e)}else{var b=$("#"+c.get("id")).parent().find(".portlet_body");var d=c.get("size_y"),a=0;if(d==1){a=(d*200)-45}else{if(d==2){a=(d*200)+25-45}else{if(d==3){a=(d*200)+50-45}}}var e={"overflow-x":"hidden","overflow-y":"auto",height:a+"px","max-height":a+"px"};b.css(e)}}}function append_activity(a){var c=new Base_List_View({model:a,view:"inline",template:this.options.templateKey+"-model"});var f=get_activity_created_time(a.get("time"));if(f==0){$("#earllier",this.el).show();var b=$("#today-activity",this.el);b.append(c.render().el);b.parent("table").css("display","block");b.show();$("#today-heading",this.el).show()}if(f==-1){$("#earllier",this.el).show();var e=$("#tomorrow-heading",this.el);var d=$("#tomorrow-activity",this.el);d.append(c.render().el);d.parent("table").css("display","block");d.show();e.show()}if(f<-1){var g=$("#next-week-activity",this.el);g.append(c.render().el);g.parent("table").css("display","block");g.show();$("#next-week-heading",this.el).show()}if($("#tomorrow-heading",this.el).css("display")=="none"&&$("#today-heading",this.el).css("display")=="none"){$("#next-week-heading",this.el).hide()}}var callschart=new Array();var taskReport=new Array();var portlet_graph_utility={dealsByMilestonePieGraph:function(a,c,d,b){setupCharts(function(){var e=true;$.each(d,function(g,h){if(h>0){e=false}});if(c.length==0||e){$("#"+a).html('<div class="portlet-error-message">No Deals Found</div>')}else{var f=[];$.each(c,function(g,h){f.push([h,d[g]])});$("#"+a).highcharts({chart:{type:"pie",marginRight:20},colors:["#7266ba","#23b7e5","#fad733","#27c24c","#f05050","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353","#7798BF","#aaeeee"],title:{text:""},tooltip:{formatter:function(){return'<table><tr><td class="p-n">'+this.series.name+'s: </td><td class="p-n"><b>'+b[this.point.x]+'</b></td></tr><tr><td style="padding-right:1px">Total Value: </td><td class="p-n"><b>'+portlet_utility.getPortletsCurrencySymbol()+""+d[this.point.x].toLocaleString()+"</b></td></tr></table>"},shared:true,useHTML:true,borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"}},plotOptions:{series:{borderWidth:0},pie:{borderWidth:0,innerSize:"35%",size:"45%",dataLabels:{enabled:true,useHTML:true,softConnector:true,formatter:function(){return'<div class="text-center"><span style="color:'+this.point.color+'"><b>'+this.point.name+'</b></span><br/><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage)+"%</b></span></div>"},distance:30,x:2,y:-10},showInLegend:false}},series:[{name:"Deal",data:f}],})}})},campaignStatsPieGraph:function(b,a,c){setupCharts(function(){var d=true;$.each(c,function(f,g){if(g>0){d=false}});if(a.length==0||d){$("#"+b).html('<div class="portlet-error-message">No Subscribers Found</div>')}else{var e=[];$.each(a,function(f,g){e.push([g,c[f]])});$("#"+b).highcharts({chart:{type:"pie",marginRight:20},colors:["#55BF3B","#23b7e5","#ff0000","#27c24c","#f05050","#aaeeee","#ff0066","#eeaaee","#7266ba","#DF5353","#7798BF","#aaeeee"],title:{text:""},tooltip:{formatter:function(){return'<table><tr> <td class="p-n"><b>'+a[this.point.x]+'</b> Subscribers</td></tr><tr><td class="p-n">Total Count: <b> '+c[this.point.x].toLocaleString()+"</b></td></tr></table>"},shared:true,useHTML:true,borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"}},plotOptions:{series:{borderWidth:0},pie:{borderWidth:0,innerSize:"35%",size:"45%",dataLabels:{enabled:true,useHTML:true,softConnector:true,formatter:function(){return'<div class="text-center"><span style="color:'+this.point.color+'"><b>'+this.point.name+'</b></span><br/><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage)+"%</b></span></div>"},distance:30,x:2,y:-10},showInLegend:false}},series:[{name:"Contact",data:e}],})}})},closuresPerPersonBarGraph:function(b,f,d,e,c,a){setupCharts(function(){$("#"+b).highcharts({chart:{type:"bar",marginRight:20},title:{text:""},xAxis:{categories:f},yAxis:{min:0,title:{text:e},allowDecimals:false},legend:{enabled:portlet_utility.is_legend_enable(a),},tooltip:{formatter:function(){return'<span class="text-xxs">'+this.points[0].key+'</span><table><tr><td class="p-n" style="color:'+this.points[0].series.color+';">'+this.points[0].series.name+': </td><td class="p-n"><b>'+d[this.points[0].point.x]+"</b></td></tr></table>"
},shared:true,useHTML:true},plotOptions:{column:{pointPadding:0.2,borderWidth:0}},series:[{name:c,data:d}],})})},dealsFunnelGraph:function(b,e,a){var c="";var d="Revenue";if(a&&a.get("settings")["split-by"]&&a.get("settings")["split-by"]=="count"){d="Deals"}else{c=portlet_utility.getPortletsCurrencySymbol()}setupCharts(function(){if(e==undefined||(e!=undefined&&e.length==0)){$("#"+b).html('<div class="portlet-error-message">No Deals Found</div>');return}$("#"+b).highcharts({chart:{type:"funnel",marginLeft:-85,marginBottom:20,className:"deals-funnel-portlet"},colors:["#23b7e5","#27c24c","#7266ba","#fad733","#f05050","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353"],title:{text:""},plotOptions:{series:{dataLabels:{enabled:true,useHTML:true,format:'<div class="text-center"><span style="color:{point.color}">{point.name}</span><br><span style="color:{point.color}">('+c+"{point.y:,.0f})</span></div>",softConnector:true},neckWidth:"20%",neckHeight:"25%",height:"100%",width:"50%",borderWidth:1,borderColor:"white"}},tooltip:{pointFormat:"<span>{series.name}: <b>"+c+"{point.y:,.0f}</b></span>",shared:true,useHTML:true,borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"}},series:[{name:d,data:e}],})})},emailsSentBarGraph:function(a,d,f,c,e,g,b){setupCharts(function(){$("#"+a).highcharts({chart:{type:"bar",marginRight:20},title:{text:""},xAxis:{categories:d},yAxis:{min:0,title:{text:g},allowDecimals:false},tooltip:{formatter:function(){return'<table><tr><td class="p-n" style="color:'+this.points[0].series.color+';">'+this.points[0].series.name+': </td><td class="p-n"><b>'+c[this.points[0].point.x]+'</b></td></tr><tr><td class="p-n" style="color:'+this.points[1].series.color+';">'+this.points[1].series.name+': </td><td class="p-n"><b>'+e[this.points[1].point.x]+"</b></td></tr></table>"},shared:true,useHTML:true},plotOptions:{series:{stacking:"normal"},column:{pointPadding:0.2,borderWidth:0}},series:f,colors:b})})},portletGrowthGraph:function(c,f,b,e,a){var d=true;if(b.get("settings").tags==""){$("#"+c).html("<div class='portlet-error-message'>Please <a href='#' id='"+b.get("id")+"-settings' class='portlet-settings text-info' dada-toggle='modal'>configure</a> the dashlet and add the Tags.</div>");d=false}if(d){setupCharts(function(){$("#"+c).highcharts({chart:{type:"areaspline",marginRight:20,events:{load:function(){console.log("load");portlet_utility.toggle_chart_legends(this,b)},redraw:function(){console.log("redraw");portlet_utility.toggle_chart_legends(this,b)}},},title:{text:""},xAxis:{categories:e,tickmarkPlacement:"on",minTickInterval:a,gridLineWidth:1,gridLineColor:"#F4F4F5",labels:{style:{color:"#98a6ad",fontSize:"11px"}},lineWidth:0,tickWidth:0},yAxis:{min:0,title:{text:""},gridLineWidth:1,gridLineColor:"#F4F4F5",labels:{style:{color:"#98a6ad",fontSize:"11px"}}},plotOptions:{series:{borderWidth:2,borderColor:"#23b7e5",marker:{symbol:"circle"}},areaspline:{marker:{lineWidth:1,lineColor:null,radius:2}}},series:f,tooltip:{borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"}},legend:{itemStyle:{fontSize:"10px",color:"#98a6ad"},borderWidth:0,layout:"vertical",floating:true,align:"right",enabled:portlet_utility.is_legend_enable(b),verticalAlign:"top",y:30},colors:["#23b7e5","#27c24c","#7266ba","#fad733","#f05050","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353"],})})}},dealsAssignedBarGraph:function(c,d,b,a){setupCharts(function(){$("#"+c).highcharts({chart:{type:"bar",marginRight:20,events:{load:function(){console.log("load");portlet_utility.toggle_chart_legends(this,a)},redraw:function(){console.log("redraw");portlet_utility.toggle_chart_legends(this,a)}},},title:{text:""},xAxis:{categories:d},yAxis:{min:0,title:{text:"No. of deals assigned"},allowDecimals:false},legend:{enabled:portlet_utility.is_legend_enable(a),},tooltip:{formatter:function(){return'<span class="text-xxs">'+this.points[0].key+'</span><table><tr><td class="p-n" style="color:'+this.points[0].series.color+';">'+this.points[0].series.name+': </td><td class="p-n"><b>'+b[this.points[0].point.x]+"</b></td></tr></table>"},shared:true,useHTML:true},plotOptions:{column:{pointPadding:0.2,borderWidth:0}},series:[{name:"Assigned Deals",data:b}],})})},callsPerPersonBarGraph:function(c,f,d,g,n,m,a,j,l,e){var k=$("#"+c).parent().attr("data-col"),b=$("#"+c).parent().attr("data-row");var h=""+k+""+b;setupCharts(function(){callschart[parseInt(h)]=new Highcharts.Chart({chart:{renderTo:c,type:"bar",marginRight:100,plotBorderWidth:1,plotBorderColor:"#F4F4F5",events:{load:function(){console.log("load");if(l!=undefined){portlet_utility.toggle_chart_legends(this,l)}},redraw:function(){console.log("redraw");if(l!=undefined){portlet_utility.toggle_chart_legends(this,l)}}},},title:{text:""},xAxis:{categories:j,labels:{formatter:function(){var p=0;for(var o=0;o<j.length;o++){if(this.value==j[o]&&j[o].substring(0,8)!="no image"){p=o}else{if(this.value==j[o]&&j[o].substring(0,8)=="no image"){p=parseInt(j[o].substring(9,10))}}}if(this.value!=undefined&&this.value!=""&&this.value.substring(0,8)!="no image"){return'<img src="'+this.value+'" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'+f[p]+'"/>'}else{return'<img src="'+gravatarImgForPortlets(25)+'" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'+f[p]+'"/>'}},style:{color:"#98a6ad",fontSize:"11px"},useHTML:true,},gridLineWidth:0,gridLineColor:"#F4F4F5",lineWidth:0,tickWidth:0,tickPixelInterval:50},yAxis:{min:0,title:{text:m},allowDecimals:false,gridLineWidth:1,gridLineColor:"#F4F4F5",labels:{style:{color:"#98a6ad",fontSize:"11px"}}},tooltip:{formatter:function(){var o="";if(m=="Calls Duration (Sec)"){o='<table><tr><td  class="b-b-none"><u style="text-decoration:none;border-bottom:1px solid">'+f[this.points[0].point.x]+'</u></td></tr><tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+':&nbsp; </td><td style="padding:0"><b>'+portlet_utility.getPortletsTimeConversion(n[this.points[0].point.x])+'</b></td></tr><tr><td style="color:'+this.points[0].series.color+';padding:0">Calls:&nbsp; </td><td style="padding:0"><b>'+g[this.points[0].point.x]+"</b></td></tr></table>"}else{if(m=="Average Call Duration (Sec)"){o+="<table>";if(this.points[0]!=undefined&&this.points[0].series!=undefined){o+='<tr><td class="b-b-none"><u style="text-decoration:none;border-bottom:1px solid">'+f[this.points[0].point.x]+'</u></td></tr><tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+':&nbsp; </td><td style="padding:0"><b>'+portlet_utility.getPortletsTimeConversion(Math.round(e[this.points[0].point.x]))+"</b></td></tr>"}o+="</table>"}else{o+='<table><tr><td class="b-b-none"><u style="text-decoration:none;border-bottom:1px solid">'+f[this.points[0].point.x]+"</u></td></tr>";if(this.points[0]!=undefined&&this.points[0].series!=undefined){o+='<tr><td style="color:'+this.points[0].series.color+';padding:0">'+this.points[0].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[0].point.y+"</b></td></tr>"}if(this.points[1]!=undefined&&this.points[1].series!=undefined){o+='<tr><td style="color:'+this.points[1].series.color+';padding:0">'+this.points[1].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[1].point.y+"</b></td></tr>"}if(this.points[2]!=undefined&&this.points[2].series!=undefined){o+='<tr><td style="color:'+this.points[2].series.color+';padding:0">'+this.points[2].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[2].point.y+"</b></td></tr>"}if(this.points[3]!=undefined&&this.points[3].series!=undefined){o+='<tr><td style="color:'+this.points[3].series.color+';padding:0">'+this.points[3].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[3].point.y+"</b></td></tr>"}if(this.points[4]!=undefined&&this.points[4].series!=undefined){o+='<tr><td style="color:'+this.points[4].series.color+';padding:0">'+this.points[4].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[4].point.y+"</b></td></tr>"}if(this.points[5]!=undefined&&this.points[5].series!=undefined){o+='<tr><td style="color:'+this.points[5].series.color+';padding:0">'+this.points[5].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[5].point.y+"</b></td></tr>"}if(this.points[6]!=undefined&&this.points[6].series!=undefined){o+='<tr><td style="color:'+this.points[6].series.color+';padding:0">'+this.points[6].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[6].point.y+"</b></td></tr>"}if(this.points[7]!=undefined&&this.points[7].series!=undefined){o+='<tr><td style="color:'+this.points[7].series.color+';padding:0">'+this.points[7].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[7].point.y+"</b></td></tr>"}if(this.points[8]!=undefined&&this.points[8].series!=undefined){o+='<tr><td style="color:'+this.points[8].series.color+';padding:0">'+this.points[8].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[8].point.y+"</b></td></tr>"}if(this.points[9]!=undefined&&this.points[9].series!=undefined){o+='<tr><td style="color:'+this.points[9].series.color+';padding:0">'+this.points[9].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[9].point.y+"</b></td></tr>"}if(this.points[10]!=undefined&&this.points[10].series!=undefined){o+='<tr><td style="color:'+this.points[10].series.color+';padding:0">'+this.points[10].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[10].point.y+"</b></td></tr>"}if(this.points[11]!=undefined&&this.points[11].series!=undefined){o+='<tr><td style="color:'+this.points[11].series.color+';padding:0">'+this.points[11].series.name+':&nbsp; </td><td style="padding:0"><b>'+this.points[11].point.y+"</b></td></tr>"}o+='<tr><td>Total:&nbsp; </td><td class="b-b-none">'+g[this.points[0].point.x]+"</td></tr></table>"}}return o},shared:true,useHTML:true,borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"}},plotOptions:{series:{pointWidth:10,stacking:"normal",borderWidth:0},column:{pointPadding:0.5,borderWidth:0},bar:{shadow:false}},series:d,colors:["#27c24c","#23b7e5","#f05050","#7266ba","#fad733","#FF9900","#7AF168","#167F80","#0560A2","#D3E6C7","#7798BF"],legend:{itemStyle:{fontSize:"10px",color:"#98a6ad"},borderWidth:0,layout:"vertical",floating:true,align:"right",enabled:portlet_utility.is_legend_enable(l),verticalAlign:"top",y:30}},function(s){if(c=="calls-chart"){s.setSize(s.chartWidth,f.length*30+120)
}else{var p=s.xAxis[0].max,q=s.xAxis[0].min,o=s.xAxis[0].height;if(o-(p-q)*27<=0){s.setSize(s.chartWidth,s.chartHeight+(p-q)*20)}}})})},callsByPersonPieGraph:function(b,a,c){setupCharts(function(){var d=true;$.each(c,function(f,g){if(g>0){d=false}});if(a.length==0||d){if(b=="calls-chart-user"){$("#"+b).html('<div class="portlet-error-message" style="font-size: 14px;font-style: normal;padding-top: 174px">No Calls Found</div>')}else{if(b==="calls-chart"){$("#"+b).html('<div class="portlet-error-message" style="padding: 190px;font-style: normal">No Calls Found</div>')}else{$("#"+b).html('<div class="portlet-error-message">No Calls Found</div>')}}}else{var e=[];$.each(a,function(f,g){e.push([g,c[f]])});$("#"+b).highcharts({chart:{type:"pie",marginRight:20},colors:["#27c24c","#23b7e5","#f05050","#7266ba","#fad733","#FF9900","#7AF168","#167F80","#0560A2","#D3E6C7","#7798BF"],title:{text:""},tooltip:{formatter:function(){return'<table><tr><td class="p-n">Total '+a[this.point.x]+':&nbsp; </td><td class="p-n"><b>'+c[this.point.x]+"</b></td></tr></table>"},shared:true,useHTML:true,borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"}},plotOptions:{series:{borderWidth:0},pie:{size:"50%",borderWidth:0,innerSize:"65%",dataLabels:{enabled:true,useHTML:true,softConnector:true,formatter:function(){return'<div class="text-center"><span style="color:'+this.point.color+'"><b>'+this.point.name+'</b></span><br/><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage)+"%</b></span></div>"},distance:30,},showInLegend:false}},series:[{name:"",data:e}],})}})},taskReportBarGraph:function(d,e,f,j,k,a,l,b){var h=$("#"+d).parent().attr("data-col"),c=$("#"+d).parent().attr("data-row");var g=""+h+""+c;setupCharts(function(){taskReport[parseInt(g)]=new Highcharts.Chart({colors:["#23b7e5","#27c24c","#7266ba","#fad733","#f05050","#aaeeee","#f4a460","#eeaaee","#55BF3B","#DF5353"],chart:{renderTo:d,type:"bar",marginRight:80,height:e.length*30+($("#"+d).height()-30),events:{load:function(){console.log("load");portlet_utility.toggle_chart_legends(this,k)},redraw:function(){console.log("redraw");portlet_utility.toggle_chart_legends(this,k)}},},title:{text:""},xAxis:{categories:e,labels:{formatter:function(){if(k.get("name")=="Average Deviation"){var n=0;for(var m=0;m<e.length;m++){if(this.value==e[m]&&e[m].substring(0,8)!="no image"){n=m}else{if(this.value==e[m]&&e[m].substring(0,8)=="no image"){n=parseInt(e[m].substring(9,10))}}}if(this.value!=undefined&&this.value!=""&&this.value.substring(0,8)!="no image"){return'<img src="'+this.value.split("#")[0]+'" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'+a[n]+'"/>'}else{return'<img src="'+gravatarImgForPortlets(25)+'" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'+a[n]+'"/>'}}else{if(k.get("settings")["group-by"]=="user"){var n=0;for(var m=0;m<e.length;m++){if(this.value==e[m]&&e[m].substring(0,8)!="no image"){n=m}else{if(this.value==e[m]&&e[m].substring(0,8)=="no image"){n=parseInt(e[m].substring(9,10))}}}if(this.value!=undefined&&this.value!=""&&this.value.substring(0,8)!="no image"){return'<img src="'+this.value.split("#")[0]+'" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'+a[n]+'"/>'}else{return'<img src="'+gravatarImgForPortlets(25)+'" alt="" style="vertical-align: middle; width: 25px; height: 25px;border-radius:15px;" title="'+a[n]+'"/>'}}else{if(this.value.length>12){return this.value.slice(0,12)+"..."}else{return this.value}}}},style:{color:"#98a6ad",fontSize:"11px"},useHTML:true},gridLineWidth:1,gridLineColor:"#F4F4F5",lineWidth:0,tickWidth:0},yAxis:{min:0,title:{text:b},allowDecimals:false,gridLineWidth:1,gridLineColor:"#F4F4F5",labels:{style:{color:"#98a6ad",fontSize:"11px"}}},plotOptions:{series:{stacking:"normal",borderWidth:0},column:{pointPadding:0.2,borderWidth:0},bar:{shadow:false}},series:f,tooltip:{borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"},formatter:function(){if(k.get("name")=="Average Deviation"){var n=0;for(var m=0;m<e.length;m++){if(this.key==e[m]){n=m}}return'<div><div class="p-n">'+a[n]+' </div><div class="p-n" style="color:'+this.series.color+';">Deviation Time:'+portlet_utility.getPortletsTimeConversion(Math.round(this.y))+' </div><div class="p-n" style="color:'+this.series.color+';">'+this.series.name+": "+portlet_utility.getNumberWithCommasForPortlets(l[this.series.index][this.point.x])+" </div></div>"}else{if(k.get("settings")["group-by"]=="user"){var n=0;for(var m=0;m<e.length;m++){if(this.key==e[m]){n=m}}return'<div><div class="p-n">'+a[n]+' </div><div class="p-n" style="color:'+this.series.color+';">'+this.series.name+":"+this.y+" </div></div>"}else{return'<div><div class="p-n" style="color:'+this.series.color+';">'+this.x+' </div><div class="p-n" style="color:'+this.series.color+';">'+this.series.name+":"+this.y+" </div></div>"}}},useHTML:true},legend:{itemStyle:{fontSize:"10px",color:"#98a6ad"},borderWidth:0,layout:"vertical",floating:true,align:"right",verticalAlign:"top",y:30,enabled:portlet_utility.is_legend_enable(k),labelFormatter:function(){if(this.name.length>12){return this.name.slice(0,12)+"..."}else{return this.name}}}})})},portletDealRevenueGraph:function(b,d,a,c){setupCharts(function(){if(d==undefined&&c!=undefined&&c.length==0){$("#"+b).html('<div class="portlet-error-message">No Deals Found</div>');return}$("#"+b).highcharts({chart:{type:"areaspline",marginRight:20,events:{load:function(){console.log("load");portlet_utility.toggle_chart_legends(this,a)},redraw:function(){console.log("redraw");portlet_utility.toggle_chart_legends(this,a)}},},title:{text:""},xAxis:{categories:c,gridLineWidth:1,gridLineColor:"#F4F4F5",labels:{style:{color:"#98a6ad",fontSize:"11px"},formatter:function(){return Highcharts.dateFormat("%b",this.value)},},lineWidth:0,tickWidth:0,tickmarkPlacement:"on"},yAxis:{min:0,title:{text:""},gridLineWidth:1,gridLineColor:"#F4F4F5",labels:{style:{color:"#98a6ad",fontSize:"11px"}}},plotOptions:{series:{borderWidth:2,borderColor:"#23b7e5",marker:{symbol:"circle"}},areaspline:{marker:{lineWidth:1,lineColor:null,radius:2}}},series:d,tooltip:{borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"},formatter:function(){return'<div><div class="p-n">'+Highcharts.dateFormat("%b",this.x)+'</div><div class="p-n"><font color='+this.series.color+">"+this.series.name+"</font>: "+portlet_utility.getPortletsCurrencySymbol()+""+portlet_utility.getNumberWithCommasForPortlets(this.y)+"</div></div>"},useHTML:true},legend:{itemStyle:{fontSize:"10px",color:"#98a6ad"},borderWidth:0,layout:"vertical",floating:true,align:"right",enabled:portlet_utility.is_legend_enable(a),verticalAlign:"top",y:30,},colors:["#23b7e5","#27c24c","#7266ba","#fad733","#f05050","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353"],})})},emailsOpenedPieChart:function(a,d,b,c){setupCharts(function(){if(b==0&&c==0){$("#"+a).html('<div class="portlet-error-message">No email activity</div>');return}$("#"+a).highcharts({chart:{type:"pie",marginLeft:-150,height:150},colors:["#e8eff0","#27C24C"],title:{text:""},tooltip:{enabled:false},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-20,y:40,labelFormatter:function(){if(this.name=="Emails Opened"){return"<div><span>Opened:"+c+"</span></div>"}else{if(this.name=="Emails Sent"){return"<div><span>Sent:"+b+"</span></div>"}}},itemStyle:{color:"#ccc",cursor:"",fontSize:"12px",fontWeight:"bold"},borderWidth:0,floating:true,},plotOptions:{series:{borderWidth:0,states:{hover:{enabled:false}}},pie:{borderWidth:0,innerSize:95,dataLabels:{enabled:true,useHTML:true,connectorWidth:0,formatter:function(){var e="";if(this.point.name=="Emails Opened"){e='<div class="text-center"><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage).toString()+"%</b></span></div>"}return e},distance:-55},showInLegend:true,enableMouseTracking:false,point:{events:{legendItemClick:function(){return false}}}}},series:[{name:"Deal",data:d}],})})},campstatsPieChart:function(){setupCharts(function(){var b;var a=0;if(data[1][0]=="Emails Opened"){b="rgb(250, 215, 51)"}if(data[1][0]=="Emails Clicked"){b="rgb(18, 209, 18)"}if(data[1][0]=="Emails Unsubscribed"){b="rgb(240, 80, 80)"}$(selector).find(".graph").highcharts({chart:{type:"pie",labelsEnabled:false,autoMargins:false,marginTop:0,marginBottom:-6,marginLeft:0,marginRight:0,pullOutRadius:0,events:{load:function(c){console.log(this);this.options.plotOptions.series.dataLabels.distance=((this.chartHeight+this.chartWidth)/7.5)*-1;this.series[0].update(this.options)},redraw:function(g){console.log(this);var c,d;var f=this;if($(selector).parents(".portlet_body").height()<=200){d=f.chartHeight/2.72}else{if($(selector).parents(".portlet_body").height()>200&&$(selector).parents(".portlet_body").height()<=450){d=f.chartHeight/2.16}else{d=f.chartHeight/2.04}}if($(selector).parents(".portlet_body").width()<=405){c=f.chartWidth/2}else{if($(selector).parents(".portlet_body").width()>405&&$(selector).parents(".portlet_body").width()<=836){c=f.chartWidth/2.05}else{c=f.chartWidth/2}}f.series[0].data[1].dataLabel.attr({x:c,y:d})}},},colors:["#e8eff0",b],title:{text:""},tooltip:{enabled:false},legend:{enabled:false,},plotOptions:{series:{dataLabels:{align:"center",enabled:true,useHTML:true,connectorWidth:0,formatter:function(){var c="";if(this.point.name=="Emails Opened"){c='<div class="text-center"><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage).toString()+"%</b></span></div>"}if(this.point.name=="Emails Clicked"){c='<div class="text-center"><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage).toString()+"%</b></span></div>"}if(this.point.name=="Emails Unsubscribed"){c='<div class="text-center"><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage).toString()+"%</b></span></div>"
}return c},distance:0,},borderWidth:0,states:{hover:{enabled:false}}},pie:{borderWidth:0,size:"100%",innerSize:"100%",},showInLegend:true,enableMouseTracking:false,point:{events:{legendItemClick:function(){return false}}}},series:[{data:data}],})})},dealGoalsPieGraph:function(b,a,e,c){var d=[];d.push(["Goals Left",e-a]);d.push(["Won",a]);setupCharts(function(){$("#"+b).highcharts({chart:{type:"pie",backgroundColor:"transparent",},colors:c,title:{text:""},tooltip:{backgroundColor:"#313030",borderColor:"#000",borderRadius:3,enabled:true,formatter:function(){return'<div class="p-n"><b><font color='+this.point.color+">"+this.point.name+" "+Math.round(this.point.percentage).toString()+"%</font></b></div>"},useHTML:true,},legend:{itemStyle:{fontSize:"10px",color:"#98a6ad"},borderWidth:0,layout:"vertical",floating:true,align:"right",verticalAlign:"top",symbolHeight:0,symbolWidth:0,symbolRadius:0,labelFormatter:function(){if(this.name=="Won"){var f="<div> "+(this.percentage).toFixed(2)+"%<b></div>";return f}},},plotOptions:{series:{borderWidth:0,states:{hover:{enabled:false}}},pie:{borderWidth:0,dataLabels:{enabled:false,},showInLegend:true,point:{events:{legendItemClick:function(){return false}}}}},exporting:{enabled:false,},series:[{name:"Goal",data:d}],})})},webstatVisitsPieGraph:function(a,d,e){var c=[];c.push(["Known",d]);c.push(["Unknown",e]);var b=d+e;setupCharts(function(){if(d==0&&e==0){$("#"+a).html('<div class="portlet-error-message">No Visits Found</div>');return}$("#"+a).highcharts({chart:{type:"pie",marginRight:20},colors:["#55BF3B","#23b7e5","#ff0000","#27c24c","#f05050","#aaeeee","#ff0066","#eeaaee","#7266ba","#DF5353","#7798BF","#aaeeee"],title:{text:""},tooltip:{formatter:function(){return'<table><tr> <td class="p-n">'+(this.point.name)+" Visits:<b> "+(this.point.y)+'</b></td></tr><tr><td class="p-n">Total Visits: <b> '+b+"</b></td></tr></table>"},shared:true,useHTML:true,borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"}},plotOptions:{series:{borderWidth:0},pie:{borderWidth:0,innerSize:"35%",size:"45%",dataLabels:{enabled:true,useHTML:true,softConnector:true,formatter:function(){return'<div class="text-center"><span style="color:'+this.point.color+'"><b>'+this.point.name+'</b></span><br/><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage)+"%</b></span></div>"},distance:30,x:2,y:-10},showInLegend:false}},series:[{name:"Visits",data:c}],})})},};var portlet_utility={addTracks:function(e,a,d){var c="";var b=a.get("settings").track;$.each(e,function(f,g){if(b==0&&g.name=="Default"){c+="<option value="+g.id+" selected='selected'>Default</option>"}else{if(b==g.id){c+="<option value="+g.id+" selected='selected'>"+g.name+"</option>"}else{c+="<option value="+g.id+">"+g.name+"</option>"}}});$("#track",d).html(c);$(".loading-img").hide();$("#deals",d).find("option[value="+a.get("settings").deals+"]").attr("selected","selected");if(a.get("name")=="Deals Funnel"&&a.get("settings")["split-by"]){$("#deals-funnel-split-by",d).find("option[value="+a.get("settings")["split-by"]+"]").attr("selected","selected")}else{if(a.get("name")=="Deals Funnel"){$("#deals-funnel-split-by",d).find("option[value=revenue]").attr("selected","selected")}}},get_filtered_contact_header:function(a,c){if(a.get("settings").filter=="contacts"){return c("All Contacts")}else{if(a.get("settings").filter=="companies"){return c("All Companies")}else{if(a.get("settings").filter=="recent"){return c="Recent Contacts"}else{if(a.get("settings").filter=="myContacts"){return c("My Contacts")}else{if(a.get("settings").filter=="leads"){return c("Leads")}else{var b=$.ajax({type:"GET",url:"/core/api/filters/"+a.get("settings").filter,dataType:"json",success:function(e){var d="";if(e!=null&&e!=undefined){d=""+e.name}if(!d){d="Contact List"}return c(d)}})}}}}}},get_deals_funnel_portlet_header:function(a,c){var b=a.get("settings").track;App_Portlets.track_length=0;$.ajax({type:"GET",url:"/core/api/milestone/pipelines",dataType:"json",success:function(d){App_Portlets.track_length=d.length;App_Portlets.deal_tracks=d;if(App_Portlets.track_length>1){if(b==0){return c("Default")}else{var e=$.ajax({type:"GET",url:"/core/api/milestone/"+b,dataType:"json",success:function(f){if(f!=null&&f!=undefined){return c(""+f.name+"")}}})}}}})},get_campaign_stats_portlet_header:function(a,d){var b=a.get("settings").campaign_type;if(b=="All"){return d("All Campaigns")}else{var c=$.ajax({type:"GET",url:"/core/api/workflows/"+b,dataType:"json",success:function(e){if(e){return d(""+e.name)}}})}},getDefaultPortletSettings:function(d,a){var b={};if(d=="CONTACTS"&&a=="Filter Based"){b.filter="myContacts"}else{if(d=="CONTACTS"&&a=="Emails Opened"){b.duration="2-days"}else{if(d=="USERACTIVITY"&&a=="Emails Sent"){b.duration="1-day"}else{if(d=="CONTACTS"&&a=="Growth Graph"){b.tags="";b.frequency="daily";b.duration="1-week"}else{if(d=="DEALS"&&a=="Pending Deals"){b.deals="my-deals"}else{if(d=="DEALS"&&(a=="Deals By Milestone"||a=="Deals Funnel")){b.deals="my-deals";b.track=0}else{if(d=="DEALS"&&a=="Closures Per Person"){b["group-by"]="number-of-deals";b["due-date"]=Math.round((new Date()).getTime()/1000)}else{if(d=="DEALS"&&a=="Deals Won"){b.duration="1-week"}else{if(d=="DEALS"&&a=="Deals Assigned"){b.duration="1-day"}else{if(d=="USERACTIVITY"&&a=="Calls Per Person"){b["group-by"]="number-of-calls";b.duration="1-day"}else{if(d=="TASKSANDEVENTS"&&a=="Task Report"){b["group-by"]="user";b["split-by"]="category";b.duration="1-week";b.tasks="all-tasks"}else{if(d=="USERACTIVITY"&&a=="Stats Report"){b.duration="yesterday"}else{if(d=="TASKSANDEVENTS"&&(a=="Agenda"||a=="Today Tasks")){b.duration="today-and-tomorrow"}else{if(d=="USERACTIVITY"&&a=="Leaderboard"){b.duration="this-month";var c={};c.revenue=true;c.dealsWon=true;c.calls=true;c.tasks=true;b.category=c}else{if(d=="DEALS"&&a=="Revenue Graph"){b.duration="this-quarter";b.track="anyTrack"}else{if(d=="USERACTIVITY"&&a=="Campaign stats"){b.duration="yesterday";b.campaign_type="All"}else{if(d=="USERACTIVITY"&&a=="Campaign graph"){b.duration="1-month";b.campaign_type="All"}else{if(d=="DEALS"&&a=="Deal Goals"){b.duration="this-month"}else{if(d=="DEALS"&&a=="Incoming Deals"){b.type="deals";b.frequency="daily";b.duration="1-week"}else{if(d=="DEALS"&&a=="Lost Deal Analysis"){b.duration="1-week"}else{if(d=="TASKSANDEVENTS"&&a=="Average Deviation"){b.duration="1-day"}else{if(d=="USERACTIVITY"&&a=="User Activities"){b.activity_type="ALL";b.duration="this-quarter"}else{if(d=="USERACTIVITY"&&a=="Referralurl stats"){b.duration="yesterday"}}}}}}}}}}}}}}}}}}}}}}}return b},getStartAndEndDurations:function(a,d){var b={};if(!a.get("settings")){return}var c=a.get("settings").duration;b.start_date_str=""+a.get("settings").duration;b.end_date_str=""+a.get("settings").duration;if(c=="yesterday"){b.end_date_str="today"}else{if(c=="this-week"){b.end_date_str="this-week-end"}else{if(c=="this-month"){b.end_date_str="this-month-end"}else{if(c=="next-7-days"){b.start_date_str="TOMORROW"}else{if(c=="today-and-tomorrow"){b.start_date_str="today"}else{if(c=="last-week"){b.end_date_str="last-week-end"}else{if(c=="last-month"){b.end_date_str="last-month-end"}else{if(c=="24-hours"){b.end_date_str="now"}else{if(c=="today"||c=="1-day"||c=="2-days"||c=="1-week"||c=="1-month"||c=="all-over-due"){b.end_date_str="TOMORROW"}else{if(c=="Custom"){if(a.get("name")=="Deal Goals"){b.start_date_str="custom-start-goals";b.end_date_str="custom-end-goals"}else{b.start_date_str="custom-start";b.end_date_str="custom-end"}}else{b.start_date_str=""+a.get("settings").duration+"-start";b.end_date_str=""+a.get("settings").duration+"-end"}}}}}}}}}}return d(b)},getDurationForPortlets:function(a,c){var b="Today";if(a=="yesterday"){b="Yesterday"}else{if(a=="1-day"||a=="today"){b="Today"}else{if(a=="2-days"){b="Last 2 Days"}else{if(a=="this-week"){b="This Week"}else{if(a=="last-week"){b="Last Week"}else{if(a=="1-week"){b="Last 7 Days"}else{if(a=="this-month"){b="This Month"}else{if(a=="last-month"){b="Last Month"}else{if(a=="1-month"){b="Last 30 Days"}else{if(a=="this-quarter"){b="This Quarter"}else{if(a=="last-quarter"){b="Last Quarter"}else{if(a=="3-months"){b="Last 3 Months"}else{if(a=="6-months"){b="Last 6 Months"}else{if(a=="12-months"){b="Last 12 Months"}else{if(a=="today-and-tomorrow"){b="Today and Tomorrow"}else{if(a=="all-over-due"){b="All Over Due"}else{if(a=="next-7-days"){b="Next 7 Days"}else{if(a=="24-hours"){b="Last 24 Hours"}}}}}}}}}}}}}}}}}}return c(b)},getOuterViewOfPortlet:function(h,a,e){var d={"Filter Based":"portlets-contacts-filterbased","Emails Opened":"portlets-contacts-emails-opened","Emails Sent":"portlets-contacts-emails-sent","Growth Graph":"portlets-contacts-growth-graph","Pending Deals":"portlets-deals-pending-deals","Deals By Milestone":"portlets-deals-deals-by-milestone","Closures Per Person":"portlets-deals-closures-per-person","Deals Won":"portlets-deals-deals-won","Deals Funnel":"portlets-deals-deals-funnel","Deals Assigned":"portlets-deals-deals-assigned",Agenda:"portlets-tasksandevents-agenda","Today Tasks":"portlets-tasksandevents-today-tasks","Calls Per Person":"portlets-contacts-calls-per-person","Agile CRM Blog":"portlets-useractivity-blog","Task Report":"portlets-tasksandevents-task-report","Stats Report":"portlets-status-report",Onboarding:"portlets-user-onboarding",Leaderboard:"portlets-leader-board","Revenue Graph":"portlets-deals-revenue-graph","Account Details":"portlets-account","Mini Calendar":"portlets-minicalendar","User Activities":"portlets-activites","Campaign stats":"portlets-campaign-stats-report","Campaign graph":"portlets-campaign-graph-report","Deal Goals":"portlets-deal-goals","Incoming Deals":"portlets-incoming-deals","Lost Deal Analysis":"portlets-lost-deal-analysis","Average Deviation":"portlets-Tasks-Deviation","Webstat Visits":"portlets-webstat-visits","Referralurl stats":"portlets-Referralurl-stats-report","Marketing Onboarding":"portlets-marketing-onboarding",};
var g=d[h.get("name")];if(CURRENT_DOMAIN_USER.is_admin&&h.get("name")=="Onboarding"){g="portlets-admin-onboarding"}var c=this;App_Portlets.portletOuterView=new Base_Model_View({model:h,template:g+"-model",tagName:"div",postRenderCallback:function(l){c.invokeOuterViewCallback(h,l)}});var f=h.get("column_position");var b=h.get("row_position");var k=h.get("size_x");var j=h.get("size_y");if($(".gridster > div:visible > div",a).length==0){$(".gridster > div:visible",a).html($(App_Portlets.portletOuterView.render().el).attr("id","ui-id-"+f+"-"+b).attr("data-sizey",j).attr("data-sizex",k).attr("data-col",f).attr("data-row",b).addClass("gs-w panel panel-default"))}else{$(".gridster > div:visible > div:last",a).after($(App_Portlets.portletOuterView.render().el).attr("id","ui-id-"+f+"-"+b).attr("data-sizey",j).attr("data-sizex",k).attr("data-col",f).attr("data-row",b).addClass("gs-w panel panel-default"))}return e()},invokeOuterViewCallback:function(a,b){var c=this;switch(a.get("name")){case"Filter Based":c.get_filtered_contact_header(a,function(e){$(b).find(".flitered_contact_portlet_header").html(e)});break;case"Deals By Milestone":c.get_deals_funnel_portlet_header(a,function(e){$(b).find(".deals_funnel_portlet_header").html(e)});break;case"Deals Funnel":c.get_deals_funnel_portlet_header(a,function(e){$(b).find(".deals_funnel_portlet_header").html(e)});break;case"Campaign stats":c.get_campaign_stats_portlet_header(a,function(e){$(b).find(".campaign_stats_header").html(e)});break;case"Campaign graph":c.get_campaign_stats_portlet_header(a,function(e){$(b).find(".campaign_graph_header").html(e)});break;case"Deal Goals":$(b).find(".portlet_body").parent().css("background","#f0f3f4");break;case"Stats Report":$(b).find(".stats_report_portlet_body").parent().css("background","#f0f3f4");break;case"User Activities":var d=a.get("column_position")+""+a.get("row_position");App_Portlets.activitiesView[parseInt(d)]=b;break}},getInnerViewOfPortlet:function(a,N){var M=a.get("column_position"),G=a.get("row_position");var v=""+M+""+G;var E=a.get("name"),m=$("#ui-id-"+M+"-"+G,N).find(".portlet_body");m.attr("id","p-body-"+M+"-"+G);var B="",x="",d="",k=m.attr("id");portlet_utility.getStartAndEndDurations(a,function(P){B=P.start_date_str;x=P.end_date_str});if(a.get("settings")&&a.get("settings").user!=undefined){d=JSON.stringify(a.get("settings").user)}switch(E){case"Filter Based":App_Portlets.filteredContacts[parseInt(v)]=new Base_Collection_View({url:"/core/api/portlets/contacts?filter="+a.get("settings").filter+"&sortKey=-created_time",templateKey:"portlets-contacts",sort_collection:false,individual_tag_name:"tr",sortKey:"-created_time",postRenderCallback:function(P){portlet_utility.addWidgetToGridster(a);contactListener(P)}});portlet_utility.renderPortletsInnerCollection(App_Portlets.filteredContacts[parseInt(v)],m,a);break;case"Emails Opened":App_Portlets.emailsOpened[parseInt(v)]=new Base_Collection_View({url:"/core/api/portlets/emails-opened?duration="+a.get("settings").duration+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"]),templateKey:"portlets-contacts-email-opens",descending:true,sortKey:"openedTime",individual_tag_name:"tr",postRenderCallback:function(P){agileTimeAgoWithLngConversion($(".time-ago",P));initializePortletsListeners();portlet_utility.addWidgetToGridster(a)}});App_Portlets.emailsOpened[parseInt(v)].collection.fetch();m.find("#emails-opened-contacts-list").attr("id","emails-opened-contacts-list-"+M+"-"+G);m.find("#emails-opened-contacts-list-"+M+"-"+G).html(getRandomLoadingImg());m.find("#emails-opened-contacts-list-"+M+"-"+G).html($(App_Portlets.emailsOpened[parseInt(v)].render().el));m.find("#emails-opened-pie-chart").attr("id","emails-opened-pie-chart-"+M+"-"+G);k="emails-opened-pie-chart-"+M+"-"+G;var g="/core/api/portlets/emails-opened-pie-chart?duration="+a.get("settings").duration+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"]);portlet_graph_data_utility.emailsOpenedGraphData(a,k,g);setPortletContentHeight(a);break;case"Pending Deals":var s="";if(a.get("settings").track!=undefined&&a.get("settings").track!="anyTrack"){s+="&track="+a.get("settings").track}if(a.get("settings").milestone!=undefined&&a.get("settings").milestone!="anyMilestone"){s+="&milestone="+a.get("settings").milestone}App_Portlets.pendingDeals[parseInt(v)]=new Base_Collection_View({url:"/core/api/portlets/pending-deals?deals="+a.get("settings").deals+s,templateKey:"portlets-opportunities",sort_collection:false,individual_tag_name:"tr",postRenderCallback:function(P){agileTimeAgoWithLngConversion($(".time-ago",P));initializePortletsListeners();portlet_utility.addWidgetToGridster(a)}});portlet_utility.renderPortletsInnerCollection(App_Portlets.pendingDeals[parseInt(v)],m,a);break;case"Deals Won":App_Portlets.dealsWon[parseInt(v)]=new Base_Collection_View({url:"/core/api/portlets/deals-won?duration="+a.get("settings").duration,templateKey:"portlets-opportunities",individual_tag_name:"tr",postRenderCallback:function(P){agileTimeAgoWithLngConversion($(".time-ago",P));portlet_utility.addWidgetToGridster(a)}});portlet_utility.renderPortletsInnerCollection(App_Portlets.dealsWon[parseInt(v)],m,a);break;case"Agenda":App_Portlets.todayEventsCollection[parseInt(v)]=new Base_Collection_View({url:"/core/api/portlets/agenda?duration="+a.get("settings").duration+"&start_time="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end_time="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"]),templateKey:"portlets-events",sort_collection:false,individual_tag_name:"tr",postRenderCallback:function(P){portlet_utility.addWidgetToGridster(a);loadGoogleEventsForPortlets(P,portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"]),portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"]));initializePortletsListeners()}});portlet_utility.renderPortletsInnerCollection(App_Portlets.todayEventsCollection[parseInt(v)],m.find("#normal-events"),a);break;case"Today Tasks":App_Portlets.tasksCollection[parseInt(v)]=new Base_Collection_View({url:"/core/api/portlets/today-tasks?duration="+a.get("settings").duration+"&start_time="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end_time="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"]),templateKey:"portlets-tasks",sort_collection:false,individual_tag_name:"tr",postRenderCallback:function(P){portlet_utility.addWidgetToGridster(a);initializePortletsListeners()}});portlet_utility.renderPortletsInnerCollection(App_Portlets.tasksCollection[parseInt(v)],m,a);break;case"Leaderboard":var K=a.get("settings").category;App_Portlets.leaderboard[parseInt(v)]=new Base_Model_View({url:"/core/api/portlets/leaderboard?duration="+a.get("settings").duration+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&revenue="+K.revenue+"&dealsWon="+K.dealsWon+"&calls="+K.calls+"&tasks="+K.tasks+"&user="+d,template:"portlets-leader-board-body-model",tagName:"div",portletSizeX:a.get("size_x"),portletSizeY:a.get("size_y"),postRenderCallback:function(P){portlet_utility.addWidgetToGridster(a);$("#ui-id-"+M+"-"+G+" > .portlet_header").find("ul").width(($("#ui-id-"+M+"-"+G+" > .portlet_body").find("ul").width()/$("#ui-id-"+M+"-"+G+" > .portlet_body").width()*100)+"%");$(".calls_popover",("#p-body-"+a.get("column_position")+"-"+a.get("row_position"))).tooltip({html:"true",placement:"right",container:"body",template:'<div class="tooltip leaderboard_calls"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'})}});m.html($(App_Portlets.leaderboard[parseInt(v)].render().el));setPortletContentHeight(a);break;case"Account Details":App_Portlets.accountInfo[parseInt(v)]=new Base_Model_View({url:"/core/api/portlets/account-details",template:"portlets-account-body-model",postRenderCallback:function(P){portlet_utility.addWidgetToGridster(a)}});m.html(getRandomLoadingImg());m.html($(App_Portlets.accountInfo[parseInt(v)].render().el));setPortletContentHeight(a);break;case"User Activities":var s="?";if(a.get("settings").activity_type==undefined){s+="&entity_type=ALL"}else{s+="&entity_type="+a.get("settings").activity_type}if(a.get("settings").duration==undefined){B="this-quarter-start";x="this-quarter-end";a.get("settings").duration="this-quarter"}if(a.get("settings").owner!=undefined&&a.get("settings").owner!=""){s+="&user_id="+a.get("settings").owner}App_Portlets.activity[parseInt(v)]=new Base_Collection_View({url:"/core/api/portlets/customer-activity"+s+"&start_time="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end_time="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"]),sortKey:"time",descending:true,templateKey:"portlets-activities-list-log",cursor:true,page_size:20,individual_tag_name:"div",postRenderCallback:function(P){portlet_utility.addWidgetToGridster(a);agileTimeAgoWithLngConversion($("time",P));contact_detail_page_infi_scroll($(".activity_body",App_Portlets.activitiesView[parseInt(v)].el),App_Portlets.activity[parseInt(v)])},appendItemCallback:function(P){includeTimeAgo(P)}});App_Portlets.activity[parseInt(v)].appendItem=append_activity;portlet_utility.renderPortletsInnerCollection(App_Portlets.activity[parseInt(v)],m,a);break;case"Campaign stats":var I,D,b,h,e,j,L,c,A=m;var g="/core/api/portlets/campaign-stats?duration="+a.get("settings").duration+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&time_zone="+(new Date().getTimezoneOffset())+"&campaign_type="+a.get("settings").campaign_type;
setTimeout(function(){if(A.find("#emails-sent-count").text().trim()==""){A.find("#emails-sent-count").html("<img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' />")}},1000);portlet_graph_data_utility.fetchPortletsGraphData(g,function(P){I=P.emailsent;D=P.emailopened;b=P.emailclicked;h=P.emailunsubscribed;e=P.emailSpam;j=P.emailSkipped;L=P.hardBounce;c=P.softBounce;A.find("#emails-opened").css("display","block").addClass("pull-left p-xs b-b b-r b-light w-half");A.find("#emails-clicked").css("display","block").addClass("pull-left p-xs b-b b-light w-half");A.find("#emails-hard-bounce").css("display","block").addClass("pull-left p-xs b-r b-light w-half");A.find("#emails-soft-bounce").css("display","block").addClass("pull-left p-xs b-r b-light w-half");A.find("#emails-unsubscribed").css("display","block").addClass("pull-left p-xs b-r b-light w-half");A.find("#emails-sent").addClass("pull-left p-xs b-r b-b b-light w-half overflow-hidden");A.find("#emails-sent-count").text(portlet_utility.getNumberWithCommasForPortlets(I));A.find("#emails-sent-label").text("Emails sent");A.find("#emails-skipped").addClass("pull-left p-xs b-b b-r b-light w-half overflow-hidden");A.find("#emails-skipped-count").text(portlet_utility.getNumberWithCommasForPortlets(j));A.find("#emails-skipped-label").text("Skipped");A.find("#emails-spam").addClass("pull-left p-xs b-r b-light w-half overflow-hidden");A.find("#emails-spam-count").text(portlet_utility.getNumberWithCommasForPortlets(e));A.find("#emails-spam-label").text("Spam");A.find("#emails-opened").html('<div class="pull-left text-light stats_text"><div class="text-sm text-ellipsis">Opened</div><div class="text-count text-center" style="color:#08C;">'+portlet_utility.getNumberWithCommasForPortlets(D)+"</div></div>");A.find("#emails-clicked").html('<div class="pull-left text-light stats_text"><div class="text-sm text-ellipsis">Clicked</div><div class="text-count text-center" style="color:rgb(18, 209, 18);">'+portlet_utility.getNumberWithCommasForPortlets(b)+"</div></div>");A.find("#emails-hard-bounce").html('<div class="pull-left text-light stats_text"><div class="text-sm text-ellipsis">Hard Bounced</div><div class="text-count text-center" style="color:#009688;">'+portlet_utility.getNumberWithCommasForPortlets(L)+"</div></div>");A.find("#emails-soft-bounce").html('<div class="pull-left text-light stats_text"><div class="text-sm text-ellipsis">Soft Bounced</div><div class="text-count text-center" style="color:#9C27B0;">'+portlet_utility.getNumberWithCommasForPortlets(c)+"</div></div>");A.find("#emails-unsubscribed").html('<div class="pull-left text-light stats_text"><div class="text-sm text-ellipsis">Unsubscribed</div><div class="text-count text-center" style="color:rgb(205,15,0);">'+portlet_utility.getNumberWithCommasForPortlets(h)+"</div></div>");portlet_utility.addWidgetToGridster(a)});setPortletContentHeight(a);break;case"Campaign graph":var g="/core/api/portlets/campaign-graph?start-date="+portlet_utility.getStartAndEndDatesOnDue(B)+"&campaign_type="+a.get("settings").campaign_type;portlet_graph_data_utility.campaignStatsGraphData(a,k,g);setPortletContentHeight(a);break;case"Deals By Milestone":var g="/core/api/portlets/deals-by-milestone?deals="+a.get("settings").deals+"&track="+a.get("settings").track;portlet_graph_data_utility.dealsByMilestoneGraphData(a,k,g);setPortletContentHeight(a);break;case"Closures Per Person":var g="/core/api/portlets/deals-closed-per-person?due-date="+a.get("settings")["due-date"];portlet_graph_data_utility.closuresPerPersonGraphData(a,k,g);setPortletContentHeight(a);break;case"Deals Funnel":var g="/core/api/portlets/deals-funnel?deals="+a.get("settings").deals+"&track="+a.get("settings").track;portlet_graph_data_utility.dealsFunnelGraphData(a,k,g);setPortletContentHeight(a);break;case"Emails Sent":var g="/core/api/portlets/emails-sent?duration="+a.get("settings").duration;portlet_graph_data_utility.emailsSentGrapgData(a,k,g);setPortletContentHeight(a);break;case"Growth Graph":var g="/core/api/portlets/growth-graph?tags="+a.get("settings").tags+"&frequency="+a.get("settings").frequency+"&duration="+a.get("settings").duration+"&start-date="+getUTCMidNightEpochFromDate(new Date(portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])*1000))+"&end-date="+getUTCMidNightEpochFromDate(new Date(portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])*1000));portlet_graph_data_utility.growthGraphData(a,k,g);setPortletContentHeight(a);var y=a.get("settings");var q=y.tags;var t=q.split(",");var z="";$.each(t,function(P,Q){if(Q!=""){z+="<li data='"+Q+"' class='tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block'>"+Q+"<a id='remove_tag' class='close m-l-xs'>&times</a></li>"}});$("#"+a.get("id")+"-portlet-ul-tags").append(z);setup_tags_typeahead();break;case"Deals Assigned":var g="/core/api/portlets/deals-assigned?duration="+a.get("settings").duration;portlet_graph_data_utility.dealsAssignedGraphData(a,k,g);setPortletContentHeight(a);break;case"Calls Per Person":if(a.get("settings")["calls-user-list"]!=undefined){d=JSON.stringify(a.get("settings")["calls-user-list"])}var g="/core/api/portlets/calls-per-person?duration="+a.get("settings").duration+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&user="+d;portlet_graph_data_utility.callsPerPersonGraphData(a,k,g);setPortletContentHeight(a);break;case"Agile CRM Blog":m.find("div").html(getRandomLoadingImg());initBlogPortletSync(m);setPortletContentHeight(a);break;case"Task Report":if(a.get("settings")["task-report-user-list"]!=undefined){d=JSON.stringify(a.get("settings")["task-report-user-list"])}var g="/core/api/portlets/task-report?group-by="+a.get("settings")["group-by"]+"&split-by="+a.get("settings")["split-by"]+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&tasks="+a.get("settings").tasks+"&user="+d;portlet_graph_data_utility.taskReportGraphData(a,k,g);setPortletContentHeight(a);break;case"Revenue Graph":var H=0;if(a.get("settings").track!=undefined&&a.get("settings").track!="anyTrack"){H=a.get("settings").track}var g="core/api/opportunity/stats/details/"+H+"?min="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&max="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"";portlet_graph_data_utility.revenueGraphData(a,k,g);setPortletContentHeight(a);break;case"Stats Report":m=$("#ui-id-"+M+"-"+G,N).find(".stats_report_portlet_body");var A=m;var p="/core/api/portlets/activity-overview-report?reportType=newContacts&duration="+a.get("settings").duration+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&time_zone="+(new Date().getTimezoneOffset());setTimeout(function(){if(A.find("#new-contacts-count").text().trim()==""){A.find("#new-contacts-count").html("<img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' />")}},1000);portlet_graph_data_utility.fetchPortletsGraphData(p,function(P){A.find("#new-contacts-count").text(portlet_utility.getNumberWithCommasForPortlets(P.newContactsCount));A.find("#new-contacts-label").text("New Contacts")});var o="/core/api/portlets/activity-overview-report?reportType=wonDeals&duration="+a.get("settings").duration+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&time_zone="+(new Date().getTimezoneOffset());setTimeout(function(){if(A.find("#won-deal-value").text().trim()==""){A.find("#won-deal-value").html("<img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' />")}},1000);portlet_graph_data_utility.fetchPortletsGraphData(o,function(P){A.find("#won-deal-value").text(portlet_utility.getPortletsCurrencySymbol()+""+portlet_utility.getNumberWithCommasForPortlets(P.wonDealValue));A.find("#won-deal-count").text("Won From "+portlet_utility.getNumberWithCommasForPortlets(P.wonDealsCount)+" deals")});var f="/core/api/portlets/activity-overview-report?reportType=newDeals&duration="+a.get("settings").duration+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&time_zone="+(new Date().getTimezoneOffset());setTimeout(function(){if(A.find("#new-deal-value").text().trim()==""){A.find("#new-deal-value").html("<img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' />")}},1000);portlet_graph_data_utility.fetchPortletsGraphData(f,function(P){A.find("#new-deal-value").text(portlet_utility.getNumberWithCommasForPortlets(P.newDealsCount));A.find("#new-deal-count").text("New deals worth "+portlet_utility.getPortletsCurrencySymbol()+""+portlet_utility.getNumberWithCommasForPortlets(P.newDealValue)+"")});var l="/core/api/portlets/activity-overview-report?reportType=campaignEmailsSent&duration="+a.get("settings").duration+"&start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&time_zone="+(new Date().getTimezoneOffset());setTimeout(function(){if(A.find("#emails-sent-count").text().trim()==""){A.find("#emails-sent-count").html("<img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' />")}},1000);var I=0;if(_agile_get_prefs("dashboard_campaign_count_"+CURRENT_DOMAIN_USER.id)){I=_agile_get_prefs("dashboard_campaign_count_"+CURRENT_DOMAIN_USER.id)
}A.find("#emails-sent-count").text(portlet_utility.getNumberWithCommasForPortlets(I));A.find("#emails-sent-label").text("Campaign emails sent");portlet_graph_data_utility.fetchPortletsGraphData(l,function(P){if(I>P.emailsSentCount){A.find("#emails-sent-count").text(portlet_utility.getNumberWithCommasForPortlets(P.emailsSentCount))}else{A.find("#emails-sent-count").prop("number",I).animateNumber({number:P.emailsSentCount},2000)}A.find("#emails-sent-label").text("Campaign emails sent");_agile_set_prefs("dashboard_campaign_count_"+CURRENT_DOMAIN_USER.id,P.emailsSentCount)});setPortletContentHeight(a);break;case"Mini Calendar":$(".portlet_body_calendar",$("#ui-id-"+M+"-"+G)).attr("id","p-body-calendar"+M+"-"+G);$("#p-body-calendar"+M+"-"+G,$("#portlet-res")).each(function(){$(this).find(".events_show").html(getRandomLoadingImg());setPortletContentHeight(a);App_Portlets.refetchEvents=false;App_Portlets.eventCalendar=$(this);var P=$(this);_agile_library_loader.load_fullcalendar_libs(function(){minicalendar(P)})});break;case"Onboarding":setPortletContentHeight(a);break;case"Deal Goals":m=$("#ui-id-"+M+"-"+G,N).find(".goals_portlet_body");m.attr("id","p-body-"+M+"-"+G);var A=m;k=m.attr("id");var g="/core/api/portlets/goals/"+CURRENT_DOMAIN_USER.id+"?start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&time_zone="+(new Date().getTimezoneOffset());portlet_graph_data_utility.fetchPortletsGraphData(g,function(P){A.find(".deal_count").html(portlet_utility.getNumberWithCommasForPortlets(P.dealcount));A.find(".goal_count").html("Won Deals <br> from "+portlet_utility.getNumberWithCommasForPortlets(P.goalCount)+" Goals");A.find(".deal_amount").html(portlet_utility.getPortletsCurrencySymbol()+""+portlet_utility.getNumberWithCommasForPortlets(P.dealAmount));A.find(".goal_amount").html("Revenue <br> from "+portlet_utility.getPortletsCurrencySymbol()+""+portlet_utility.getNumberWithCommasForPortlets(P.goalAmount)+" Goals");portlet_graph_data_utility.dealGoalsGraphData(k,P,M,G)});setPortletContentHeight(a);break;case"Incoming Deals":var u=0;if(a.get("settings").owner){u=a.get("settings").owner}var g="core/api/portlets/incomingDeals/"+u+"?min="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&max="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])+"&frequency="+a.get("settings").frequency+"&type="+a.get("settings").type;portlet_graph_data_utility.incomingDealsGraphData(a,k,g);setPortletContentHeight(a);break;case"Lost Deal Analysis":var u=0;var O=0;var J=0;if(a.get("settings").owner){u=a.get("settings").owner}if(a.get("settings").track){O=a.get("settings").track}if(a.get("settings").source){J=a.get("settings").source}var g="core/api/portlets/lossReason/"+u+"/"+O+"/"+J+"?min="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&max="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"]);var n=parseInt($("#"+k).parent().attr("data-sizey"));var C=50*n;if(n==2||n==3){C+=50}$("#"+k).html("<div class='text-center v-middle opa-half' style='margin-top:"+C+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");$("#"+k).addClass("lost-deal-analysis-portlet-pie");pieforReports(g,k,"",undefined,true);setPortletContentHeight(a);break;case"Average Deviation":var g="/core/api/portlets/averageDeviation?start-date="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])+"&end-date="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"]);portlet_graph_data_utility.taskDeviationGraphData(a,k,g);setPortletContentHeight(a);break;case"Webstat Visits":var g="/core/api/web-stats/reports?start_time="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])*1000+"&end_time="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])*1000;portlet_graph_data_utility.webstatVisitsGraphData(a,k,g);setPortletContentHeight(a);break;case"Referralurl stats":var w,F;k="referralurl-stats-portlet-body-"+M+"-"+G;var n=parseInt($("."+k).parent().attr("data-sizey"));var C=50*n;if(n==2||n==3){C+=50}$("."+k).html("<div class='text-center v-middle opa-half' style='margin-top:"+C+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");var g="/core/api/web-stats/refurl-stats?start_time="+portlet_utility.getStartAndEndDatesOnDue(B,a.get("settings")["start-date"])*1000+"&end_time="+portlet_utility.getStartAndEndDatesOnDue(x,a.get("settings")["end-date"])*1000+"&time_zone="+(new Date().getTimezoneOffset());portlet_graph_data_utility.fetchPortletsGraphData(g,function(R){if(R.length==0){$("."+k).html('<div class="portlet-error-message">No Referral URL Found</div>');return}var Q;var P=$("<div style=' padding-top: 2px;'></div>");$.each(R,function(U){var S;if(U==0){S=75}else{S=(R[U].count/R[0].count)*100}if(U!=0&&S>75){S=100-S;S=75-S}Q=$("<div style='margin: 0px 20px -21px 15px; padding-bottom: 1px;'/>");var T=R[U].ref_url.substring(R[U].ref_url.indexOf("/")+2,R[U].ref_url.lastIndexOf("/"));if(T.startsWith("www")){T=T.substring(T.indexOf("www")+4)}Q.append("<a data-toggle='popover' class='text-ellipsis' title="+R[U].ref_url+" style='font-size: 14px; position: absolute;width: 75%;'>"+T+"</a>");Q.append("<div  style='margin-left: 90%;width: 15%;'>"+R[U].count+"</div>");Q.append("<div class='bar' style='width: "+S+"%; margin: 1px;height: .8rem; background: #03A9F4;'></div>");Q.append("<br/>");P.append(Q)});$("."+k).html(P)});setPortletContentHeight(a);break}},renderPortletsInnerCollection:function(b,c,a){b.collection.fetch();c.html(getRandomLoadingImg());c.html($(b.render().el));setPortletContentHeight(a)},showPortletSettings:function(b){var c,j=Portlets_View.collection.get(b.split("-settings")[0]);var h=j.get("name"),d=this;$(".help-inline").hide();switch(h){case"Filter Based":$("#filter",c).find("option").remove();$(".loading-img",c).show();d.addPortletSettingsModalContent(j,"portletsContactsFilterBasedSettingsModal");c=$("#portletsContactsFilterBasedSettingsForm");var k=j.get("settings").filter;var l='<option value="">Select...</option>';if(k=="contacts"){l+="<option selected='selected' value='contacts'>All Contacts</option>"}else{l+="<option value='contacts'>All Contacts</option>"}if(k=="myContacts"){l+="<option selected='selected' value='myContacts'>My Contacts</option>"}else{l+="<option value='myContacts'>My Contacts</option>"}$.ajax({type:"GET",url:"/core/api/filters?type=PERSON",dataType:"json",success:function(n){$.each(n,function(o,p){if(p.id==k){l+="<option selected='selected' value="+p.id+">"+p.name+"</option>"}else{l+="<option value="+p.id+">"+p.name+"</option>"}});$("#filter",c).html(l);$(".loading-img").hide()}});break;case"Emails Opened":d.addPortletSettingsModalContent(j,"portletsContactsEmailsOpenedSettingsModal");c=$("#portletsContactsEmailsOpenedSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Emails Sent":d.addPortletSettingsModalContent(j,"portletsContactsEmailsSentSettingsModal");c=$("#portletsContactsEmailsSentSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Growth Graph":$("#portlet-ul-tags > li").remove();$("#cancel-modal").attr("disabled",false);d.addPortletSettingsModalContent(j,"portletsContactsGrowthGraphSettingsModal");c=$("#portletsContactsGrowthGraphSettingsModal");var m=j.get("settings").tags.split(",");var g="";$.each(m,function(n,o){if(o!=""){g+="<li data='"+o+"' class='tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block'>"+o+"<a id='remove_tag' class='close m-l-xs'>&times</a></li>"}});$("#portlet-ul-tags").append(g);setup_tags_typeahead();$("#frequency",c).find("option[value="+j.get("settings").frequency+"]").attr("selected","selected");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Pending Deals":d.addPortletSettingsModalContent(j,"portletsPendingDealsSettingsModal");c=$("#portletsPendingDealsSettingsModal");$("#deals",c).find("option[value="+j.get("settings").deals+"]").attr("selected","selected");if(j.get("settings").track=="anyTrack"){l+='<option value="anyTrack" selected="selected">Any</option>'}else{l+='<option value="anyTrack">Any</option>'}$.ajax({type:"GET",url:"/core/api/milestone/pipelines",dataType:"json",success:function(o){$.each(o,function(p,q){if(j.get("settings").track==q.id){l+="<option value="+q.id+" selected='selected'>"+q.name+"</option>"}else{l+="<option value="+q.id+">"+q.name+"</option>"}});$("#track",c).html(l);$(".loading-img").hide();var n=$("#track",c).val();if(n!="anyTrack"){$.ajax({type:"GET",url:"/core/api/milestone/"+n,dataType:"json",success:function(s){var p=s.milestones.split(",");var q=s.lost_milestone;var t=s.won_milestone;$("#milestone").html("");if(p.length>1){$("#milestone",c).html('<option value="anyMilestone">Any</option>')}$.each(p,function(u,v){if(q!=null&&t!=null){if(!(v==q)&&!(v==t)){$("#milestone",c).append('<option value="'+v+'">'+v+"</option>")}}else{if(!(v=="Won")&&!(v=="Lost")){$("#milestone",c).append('<option value="'+v+'">'+v+"</option>")}}});if(j.get("settings").milestone&&n==j.get("settings").track){$("#milestone",c).find('option[value="'+j.get("settings").milestone+'"]').attr("selected","selected")}}})}else{$("#milestone",c).html('<option value="anyMilestone">Any</option>')}}});break;case"Campaign graph":d.addPortletSettingsModalContent(j,"portletsCampaignGraphSettingsModal");c=$("#portletsCampaignGraphSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");var l="<option value='All'>All Campaigns</option>";
$.ajax({type:"GET",url:"/core/api/workflows",dataType:"json",success:function(n){$.each(n,function(o,p){l+="<option value="+p.id+">"+p.name+"</option>"});$("#campaign_type",c).html(l);$("#campaign_type",c).find("option[value="+j.get("settings").campaign_type+"]").attr("selected","selected");$(".loading-img").hide()}});break;case"Deals By Milestone":d.addPortletSettingsModalContent(j,"portletsDealsByMilestoneSettingsModal");c=$("#portletsDealsByMilestoneSettingsModal");var d=this;var a="/core/api/portlets/deals-by-milestone?deals="+j.get("settings").deals+"&track="+j.get("settings").track;if(App_Portlets.track_length!=undefined&&App_Portlets.track_length>1){$("#portletsDealsByMilestoneTrack",c).show()}var f=[];if(App_Portlets.deal_tracks!=undefined&&App_Portlets.deal_tracks!=null){f=App_Portlets.deal_tracks}else{$.ajax({type:"GET",url:"/core/api/milestone/pipelines",dataType:"json",success:function(n){App_Portlets.track_length=n.length;App_Portlets.deal_tracks=n;f=App_Portlets.deal_tracks;d.addTracks(f,j,c)}});return}d.addTracks(f,j,c);break;case"Closures Per Person":d.addPortletSettingsModalContent(j,"portletsDealsClosuresPerPersonSettingsModal");c=$("#portletsDealsClosuresPerPersonSettingsModal");$("#group-by",c).find("option[value="+j.get("settings")["group-by"]+"]").attr("selected","selected");$("#due-date",c).val(getDateInFormatFromEpoc(j.get("settings")["due-date"]));break;case"Deals Won":d.addPortletSettingsModalContent(j,"portletsDealsWonSettingsModal");c=$("#portletsDealsWonSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Deals Funnel":d.addPortletSettingsModalContent(j,"portletsDealsFunnelSettingsModal");c=$("#portletsDealsFunnelSettingsModal");var d=this;var a="/core/api/portlets/deals-funnel?deals="+j.get("settings").deals+"&track="+j.get("settings").track;if(App_Portlets.track_length!=undefined&&App_Portlets.track_length>1){$("#portletsDealsFunnelTrack",c).show()}var f=[];if(App_Portlets.deal_tracks!=undefined&&App_Portlets.deal_tracks!=null){f=App_Portlets.deal_tracks}else{$.ajax({type:"GET",url:"/core/api/milestone/pipelines",dataType:"json",success:function(n){App_Portlets.track_length=n.length;App_Portlets.deal_tracks=n;f=App_Portlets.deal_tracks;d.addTracks(f,j,c)}});return}d.addTracks(f,j,c);break;case"Deals Assigned":d.addPortletSettingsModalContent(j,"portletsDealsAssignedSettingsModal");c=$("#portletsDealsAssignedSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Calls Per Person":c=$("#portletsCallsPerPersonSettingsModal");$("#group-by",c).find("option[value="+j.get("settings")["group-by"]+"]").attr("selected","selected");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");portlet_utility.setUsersInPortletSettings("calls-user-list",j,"calls-user-list","calls-user",c,function(){d.addPortletSettingsModalContent(j,"portletsCallsPerPersonSettingsModal")});initializeCustomRangeInModal(j,c);break;case"Task Report":c=$("#portletsTaskReportSettingsModal");$("#group-by-task-report",c).find("option[value="+j.get("settings")["group-by"]+"]").attr("selected","selected");if(j.get("settings").tasks!=undefined){$("#tasks-task-report",c).find("option[value="+j.get("settings").tasks+"]").attr("selected","selected")}$("#split-by-task-report",c).find("option[value="+j.get("settings")["split-by"]+"]").attr("selected","selected");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");$("#"+j.get("settings")["group-by"]+"",c).hide();if(j.get("settings")["group-by"]=="status"){$("#tasks-control-group").hide()}if(j.get("settings").tasks=="completed-tasks"){$("#split-by-task-report > option#status").hide()}portlet_utility.setUsersInPortletSettings("task-report-user-list",j,"task-report-user-list","task-report-user",c,function(){d.addPortletSettingsModalContent(j,"portletsTaskReportSettingsModal")});initializeCustomRangeInModal(j,c);break;case"Stats Report":d.addPortletSettingsModalContent(j,"portletsStatsReportSettingsModal");c=$("#portletsStatsReportSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Agenda":d.addPortletSettingsModalContent(j,"portletsAgendaSettingsModal");c=$("#portletsAgendaSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Today Tasks":d.addPortletSettingsModalContent(j,"portletsTodayTasksSettingsModal");c=$("#portletsTodayTasksSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Leaderboard":c=$("#portletsLeaderboardSettingsModal");var e=j.get("settings").category;$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);if(e&&e.revenue){$("#category-list",c).find("option[value=revenue]").attr("selected","selected")}if(e&&e.dealsWon){$("#category-list",c).find("option[value=dealsWon]").attr("selected","selected")}if(e&&e.calls){$("#category-list",c).find("option[value=calls]").attr("selected","selected")}if(e&&e.tasks){$("#category-list",c).find("option[value=tasks]").attr("selected","selected")}portlet_utility.setUsersInPortletSettings("user-list",j,"user-list","user",c,function(){d.addPortletSettingsModalContent(j,"portletsLeaderboardSettingsModal")});$("#ms-category-list",c).remove();head.js(LIB_PATH+"lib/jquery.multi-select.js",function(){$("#category-list, #user-list",c).multiSelect();$("#ms-category-list .ms-selection",c).children("ul").addClass("multiSelect").attr("name","category-list").attr("id","category");$("#ms-category-list .ms-selectable .ms-list",c).css("height","105px");$("#ms-category-list .ms-selection .ms-list",c).css("height","105px");$("#ms-category-list",c).addClass("portlet-category-ms-container")});break;case"Revenue Graph":d.addPortletSettingsModalContent(j,"portletsDealsRevenueGraphSettingsModal");c=$("#portletsDealsRevenueGraphSettingsModal");var l="";if(j.get("settings").track=="anyTrack"){l+='<option value="anyTrack" selected="selected">Any</option>'}else{l+='<option value="anyTrack">Any</option>'}$.ajax({type:"GET",url:"/core/api/milestone/pipelines",dataType:"json",success:function(n){$.each(n,function(o,p){if(j.get("settings").track==p.id){l+="<option value="+p.id+" selected='selected'>"+p.name+"</option>"}else{l+="<option value="+p.id+">"+p.name+"</option>"}});$("#track",c).html(l);$(".loading-img").hide()}});$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Campaign stats":d.addPortletSettingsModalContent(j,"portletsCampaignStatsSettingsModal");c=$("#portletsCampaignStatsSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");var l="<option value='All'>All Campaigns</option>";$.ajax({type:"GET",url:"/core/api/workflows",dataType:"json",success:function(n){$.each(n,function(o,p){l+="<option value="+p.id+">"+p.name+"</option>"});$("#campaign_type",c).html(l);$("#campaign_type",c).find("option[value="+j.get("settings").campaign_type+"]").attr("selected","selected");$(".loading-img").hide()}});initializeCustomRangeInModal(j,c);break;case"Deal Goals":d.addPortletSettingsModalContent(j,"portletsGoalsSettingsModal");c=$("#portletsGoalsSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Incoming Deals":d.addPortletSettingsModalContent(j,"portletsIncomingDealsSettingsModal");c=$("#portletsIncomingDealsSettingsModal");$("#duration-incoming-deals",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");$("#split-by-incoming-deals",c).find("option[value="+j.get("settings")["type"]+"]").attr("selected","selected");$("#frequency-incoming-deals",c).find("option[value="+j.get("settings")["frequency"]+"]").attr("selected","selected");portlet_utility.setOwners("owner",j,c);initializeCustomRangeInModal(j,c);break;case"Lost Deal Analysis":d.addPortletSettingsModalContent(j,"portletsLostDealAnalysisSettingsModal");c=$("#portletsLostDealAnalysisSettingsModal");$("#duration-lost-deal-analysis",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");portlet_utility.setOwners("owner-lost-deal-analysis",j,c);portlet_utility.setTracks("track-lost-deal-analysis",j,c);portlet_utility.setSources("source-lost-deal-analysis",j,c);initializeCustomRangeInModal(j,c);break;case"Average Deviation":d.addPortletSettingsModalContent(j,"portletsTaskClosureSettingsModal");c=$("#portletsTaskClosureSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"User Activities":d.addPortletSettingsModalContent(j,"portletsUserActivitiesSettingsModal");c=$("#portletsUserActivitiesSettingsModal");portlet_utility.setOwners("owner-user-activities",j,c);$("#duration-user-activities",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Webstat Visits":d.addPortletSettingsModalContent(j,"portletsWebstatVisitsSettingsModal");c=$("#portletsWebstatVisitsSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);break;case"Referralurl stats":d.addPortletSettingsModalContent(j,"portletsReferralurlStatsSettingsModal");c=$("#portletsReferralurlStatsSettingsModal");$("#duration",c).find("option[value="+j.get("settings").duration+"]").attr("selected","selected");initializeCustomRangeInModal(j,c);
break}if(j.get("name")=="Pending Deals"||j.get("name")=="Deals By Milestone"||j.get("name")=="Closures Per Person"||j.get("name")=="Deals Funnel"){$("#due-date",c).datepicker({format:CURRENT_USER_PREFS.dateFormat,autoclose:true})}},addPortletSettingsModalContent:function(a,b){$("#"+b).modal("show");$(".datepicker").hide();$("#"+b+" > .modal-dialog > .modal-content > .modal-footer > .save-modal").attr("id",a.get("id")+"-save-modal");$("#portlet-type",$("#"+b)).val(a.get("portlet_type"));$("#portlet-name",$("#"+b)).val(a.get("name"))},setUsersInPortletSettings:function(e,a,c,d,b,f){head.js(LIB_PATH+"lib/jquery.multi-select.js",function(){var h=a.get("settings")[e];if(h){var g="";$.ajax({type:"GET",url:"/core/api/users/partial",dataType:"json",success:function(j){$.each(j,function(l,k){if(!k.is_disabled){g+="<option value="+k.id+">"+k.name+"</option>"}});$("#"+e,b).html(g);$.each(h,function(){$("#"+e,b).find("option[value="+this+"]").attr("selected","selected")});$(".loading-img").hide();$("#ms-"+e,b).remove();$("#"+e,b).multiSelect();$("#ms-"+e+" .ms-selection",b).children("ul").addClass("multiSelect").attr("name",c).attr("id",d);$("#ms-"+e+" .ms-selectable .ms-list",b).css("height","130px");$("#ms-"+e+" .ms-selection .ms-list",b).css("height","130px");$("#ms-"+e,b).addClass("portlet-user-ms-container")}})}else{var g="";$.ajax({type:"GET",url:"/core/api/users/partial",dataType:"json",success:function(j){$.each(j,function(l,k){if(!k.is_disabled){g+="<option value="+k.id+" selected='selected'>"+k.name+"</option>"}});$("#"+e,b).html(g);$(".loading-img").hide();$("#ms-"+e,b).remove();$("#"+e,b).multiSelect();$("#ms-"+e+" .ms-selection",b).children("ul").addClass("multiSelect").attr("name",c).attr("id",d);$("#ms-"+e+" .ms-selectable .ms-list",b).css("height","130px");$("#ms-"+e+" .ms-selection .ms-list",b).css("height","130px");$("#ms-"+e,b).addClass("portlet-user-ms-container")}})}});return f()},getPortletsCurrencySymbol:function(){var b=((CURRENT_USER_PREFS.currency!=null)?CURRENT_USER_PREFS.currency:"USD-$");var a=((b.length<4)?"$":b.substring(4,b.length));return a},getNumberWithCommasForPortlets:function(a){a=parseFloat(a);a=Math.round(a);if(a==0){return a}if(a){return a.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}},getNumberWithCommasAndDecimalsForPortlets:function(a){a=parseFloat(a);if(a==0){return a}if(a){return a.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}},getPortletsTimeConversion:function(a){if(!a){return 0}var e="";var f=Math.floor(a/(24*60*60));var c=Math.floor((a%(24*60*60))/(60*60));var d=Math.floor(((a%(24*60*60))%(60*60))/60);var b=Math.floor(((a%(24*60*60))%(60*60))%60);if(f!=0){e+=" "+f+"d"}if(c!=0){e+=" "+c+"h"}if(d!=0){e+=" "+d+"m"}if(b!=0){e+=" "+b+"s"}return e},getPortletNormalName:function(a){if(!a){return}return getTranslatedPortletName(a)},getStartAndEndDatesOnDue:function(f,c){var g=new Date();if(f=="custom-start"||f=="custom-start-goals"){return c}if(f=="custom-end"){c=c+(24*60*60)-1;return c}if(f=="custom-end-goals"){var a=new Date(c*1000);a.setMonth(a.getMonth()+1);c=(a.setMilliseconds(0)/1000)-1;return c}if(f=="24-hours"){var b=(g.setMilliseconds(0)/1000)-(24*60*60);return b}if(f=="now"){return(g.setMilliseconds(0)/1000)}if(f=="1-day"||f=="today"){getGMTTimeFromDate(g)/1000}if(f=="this-week"||f=="this-week-start"){if(new Date().getDay()!=0){g.setDate(g.getDate()-(new Date().getDay()-1))}else{g.setDate(g.getDate()-(new Date().getDay()+6))}}if(f=="this-week-end"){if(new Date().getDay()!=0){g.setDate((g.getDate()-(new Date().getDay()-1))+7)}else{g.setDate((g.getDate()-(new Date().getDay()+6))+7)}}if(f=="last-week"||f=="last-week-start"){g.setDate(g.getDate()-g.getDay()-6)}if(f=="last-week-end"){g.setDate((g.getDate()-g.getDay())+1)}if(f=="1-week"){g.setDate(g.getDate()-6)}if(f=="1-month"){g.setDate(g.getDate()-29)}if(f=="this-month"||f=="this-month-start"){g.setDate(1)}if(f=="last-month"||f=="last-month-start"){g.setDate(1);g.setMonth(g.getMonth()-1)}if(f=="last-month-end"){g.setDate((g.getDate()-g.getDate())+1);g.setMonth(g.getMonth())}if(f=="TOMORROW"){g.setDate(g.getDate()+1)}if(f=="yesterday"){g.setDate(g.getDate()-1)}if(f=="2-days"){g.setDate(g.getDate()-1)}if(f=="next-7-days"){g.setDate(g.getDate()+8)}if(f=="today-and-tomorrow"){g.setDate(g.getDate()+2)}if(f=="this-quarter-start"||f=="this-and-next-quarter-start"){var e=g.getMonth();if(e<3){g.setMonth(0)}else{if(e>=3&&e<6){g.setMonth(3)}else{if(e>=6&&e<9){g.setMonth(6)}else{if(e>=9&&e<12){g.setMonth(9)}}}}g.setDate(1)}if(f=="this-quarter-end"){var e=g.getMonth();if(e<3){g.setMonth(3)}else{if(e>=3&&e<6){g.setMonth(6)}else{if(e>=6&&e<9){g.setMonth(9)}else{if(e>=9&&e<12){g.setFullYear(g.getFullYear()+1);g.setMonth(0)}}}}g.setDate(1)}if(f=="last-quarter-start"){var e=g.getMonth();if(e<3){g.setFullYear(g.getFullYear()-1);g.setMonth(9)}else{if(e>=3&&e<6){g.setMonth(0)}else{if(e>=6&&e<9){g.setMonth(3)}else{if(e>=9&&e<12){g.setMonth(6)}}}}g.setDate(1)}if(f=="last-quarter-end"){var e=g.getMonth();if(e<3){g.setMonth(0)}else{if(e>=3&&e<6){g.setMonth(3)}else{if(e>=6&&e<9){g.setMonth(6)}else{if(e>=9&&e<12){g.setMonth(9)}}}}g.setDate(1)}if(f=="this-month-end"){g.setDate(1);g.setMonth(g.getMonth()+1)}if(f=="next-quarter-start"){var e=g.getMonth();if(e<3){g.setMonth(3)}else{if(e>=3&&e<6){g.setMonth(6)}else{if(e>=6&&e<9){g.setMonth(9)}else{if(e>=9&&e<12){g.setFullYear(g.getFullYear()+1);g.setMonth(0)}}}}g.setDate(1)}if(f=="next-quarter-end"||f=="this-and-next-quarter-end"){var e=g.getMonth();if(e<3){g.setMonth(6)}else{if(e>=3&&e<6){g.setMonth(9)}else{if(e>=6&&e<9){g.setFullYear(g.getFullYear()+1);g.setMonth(0)}else{if(e>=9&&e<12){g.setFullYear(g.getFullYear()+1);g.setMonth(3)}}}}g.setDate(1)}if(f=="this-year-start"){g.setMonth(g.getMonth()-g.getMonth());g.setDate(1)}if(f=="this-year-end"){g.setFullYear(g.getFullYear()+1);g.setMonth(g.getMonth()-g.getMonth());g.setDate(1)}if(f=="next-year-start"){g.setFullYear(g.getFullYear()+1);g.setMonth(g.getMonth()-g.getMonth());g.setDate(1)}if(f=="next-year-end"){g.setFullYear(g.getFullYear()+2);g.setMonth(g.getMonth()-g.getMonth());g.setDate(1)}if(f=="last-year-start"){g.setFullYear(g.getFullYear()-1);g.setMonth(g.getMonth()-g.getMonth());g.setDate(1)}if(f=="last-year-end"){g.setFullYear(g.getFullYear());g.setMonth(g.getMonth()-g.getMonth());g.setDate(1)}return(getGMTTimeFromDate(g)/1000)},addWidgetToGridster:function(a){if(!gridster){return}var b=true;var c="ui-id-"+a.get("column_position")+"-"+a.get("row_position")+"";gridster.$widgets.each(function(d,e){if(e.id==c){b=false}});if(!b){return}gridster.add_widget($("#"+c),a.get("size_x"),a.get("size_y"),a.get("column_position"),a.get("row_position"))},getActivityObject:function(b,a){$.ajax({type:"GET",url:"core/api/activitylog/"+b,success:function(c){return a(c)}})},is_legend_enable_in_desktop:function(a){if(!a.get("size_x")||a.get("size_x")>1){return true}return false},is_legend_enable:function(a){return(!agile_is_mobile_browser())?true:false},toggle_chart_legends:function(d,a){if(!d.series){return}var b=d.series;for(var c=0;c<b.length;c++){this.toggle_legend_item(d,b[c],a)}},toggle_legend_item:function(b,c,a){if(this.is_legend_enable_in_desktop(a)){c.options.showInLegend=true;try{b.legend.renderItem(c)}catch(d){}try{b.legend.render()}catch(d){}}else{c.options.showInLegend=false;c.legendItem=null;try{b.legend.destroyItem(c)}catch(d){}try{b.legend.render()}catch(d){}}},setOwners:function(d,a,c){var b='<option value="">All</option>';$.ajax({type:"GET",url:"/core/api/users/partial",dataType:"json",success:function(e){$.each(e,function(g,f){b+="<option value="+f.id+">"+f.name+"</option>"});$("#"+d,c).html(b);$("#"+d,c).find("option[value="+a.get("settings")["owner"]+"]").attr("selected","selected");$(".loading-img").hide()}})},setSources:function(d,a,c){var b=new Base_Collection_View({url:"/core/api/categories?entity_type=DEAL_SOURCE",sort_collection:false});b.collection.fetch({success:function(g){var e=g.toJSON();var f='<option class="default-select" value="">'+_agile_get_translated_val("report-add","all-sources")+'</option><option class="default-select" value="1">'+_agile_get_translated_val("report-add","unknown")+"</option>";$.each(e,function(j,h){f+='<option class="default-select" value="'+h.id+'">'+h.label+"</option>"});$("#"+d,c).html(f);$("#"+d,c).find("option[value="+a.get("settings")["source"]+"]").attr("selected","selected");hideTransitionBar()}})},setTracks:function(c,a,b){fillSelect(c,"/core/api/milestone/pipelines",undefined,function(){$("#"+c,b).find("option[value="+a.get("settings")["track"]+"]").attr("selected","selected")},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined,"All Tracks")}};function initializeCustomRangeInModal(a,c){if(a.get("settings").duration=="Custom"){$(".daterange",c).removeClass("hide");if(a.get("name")=="Deal Goals"){$("#start_date",c).val(stringToDate(a.get("settings")["start-date"]*1000,"mmm yyyy")).blur();$("#end_date",c).val(stringToDate(a.get("settings")["end-date"]*1000,"mmm yyyy")).blur();$("#start_date",c).datepicker("remove");$("#end_date",c).datepicker("remove");$("#start_date",c).datepicker({format:"MM yyyy",minViewMode:"months",weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});$("#end_date",c).datepicker({format:"MM yyyy",minViewMode:"months",weekStart:CALENDAR_WEEK_START_DAY,autoclose:true})}else{$("#start_date",c).val(getDateInFormatFromEpoc(a.get("settings")["start-date"]));$("#end_date",c).val(getDateInFormatFromEpoc(a.get("settings")["end-date"]));$("#start_date",c).datepicker("remove");$("#end_date",c).datepicker("remove");var b=$("#start_date",c).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true}).on("changeDate",function(d){var e;if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy")!=-1||CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy")!=-1){e=new Date(convertDateFromUKtoUS($("#end_date",c).val()))}else{e=new Date($("#end_date",c).val())}if(d.date.valueOf()>e.valueOf()){$("#end_date",c).val($("#start_date",c).val())
}});$("#end_date",c).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true},"hide")}}else{$(c).find(".daterange").addClass("hide")}$(c).find(".invalid-range").parents(".form-group").hide()}function stringToDate(a,b){return new Date(a).format(b)}function getTranslatedPortletName(b){var a={HIGH:"High",LOW:"Low",NORMAL:"Normal",EMAIL:"Email",CALL:"Call",SEND:"Send",TWEET:"Tweet",FOLLOW_UP:"Follow Up",MEETING:"Meeting",MILESTONE:"Milestone",OTHER:"Other",YET_TO_START:"Yet To Start",IN_PROGRESS:"In Progress",COMPLETED:"Completed",TODAY:"Today",TOMORROW:"Tomorrow",OVERDUE:"Overdue",LATER:"Later",};b=b.trim();return(a[b]?a[b]:b)}var jso=[];var mini_fullCal;var mini_popover_call;function minicalendar(b){_agile_delete_prefs("current_date_calendar");init_cal(b);var c=0;var d=0;var a=[];mini_fullCal=$("#calendar_container",b).fullCalendar({aspectRatio:getaspectratio(b),selectable:true,header:{left:"prev",right:"next",center:"title"},weekMode:"liquid",titleFormat:{month:"MMM yyyy",},monthNames:$.fn.datepicker.dates.en.months,monthNamesShort:$.fn.datepicker.dates.en.monthsShort,dayNames:$.fn.datepicker.dates.en.days,dayNamesShort:$.fn.datepicker.dates.en.daysShort,eventSources:[{events:function(e,h,q){App_Portlets.eventCalendar=$(b);var m=$(b).parent().attr("data-sizey");if(m==2){$(b).find(".fc-header").css("height","145px")}else{if(m==3){$(b).find(".fc-header").css("height","250px")}}$(b).find(".fc-border-separate").addClass("ignore-collection");if($(b).find("#calendar_container").width()<185){$(b).find("#calendar_container").find(".fc-widget-header").each(function(){$(this).text($(this).text().substring(0,1))})}var g=new Date();var j=new Date(g.getFullYear(),g.getMonth(),g.getDate(),0,0,0);var l=new Date(g.getFullYear(),g.getMonth(),g.getDate(),23,59,59);var f='<div class="show p-t-xs text-md text-center">Today </div><ul class="list"></ul>';if(_agile_get_prefs("current_date_calendar")!=null){var p=$.fn.datepicker.dates.en.daysShort;var k=new Date(_agile_get_prefs("current_date_calendar"));if(k.getTime()!=j.getTime()){j=k;l=new Date(k.getFullYear(),k.getMonth(),k.getDate(),23,59,59);$(b).find(".events_show").empty().append('<div class="show p-t-xs text-md text-center">'+p[k.getDay()]+", "+k.format("dd mmm")+' </div><ul class="list"></ul>')}else{$(b).find(".events_show").empty().append(f)}}else{if(e<j&&j<h){$(b).find(".events_show").empty().append(f)}}if(m==2){$(b).find(".show").css("padding-top","70px")}else{if(m==3){$(b).find(".show").css("padding-top","120px")}}var o=parseInt($(b).find(".fc-widget-content").css("height"))/2-7;$(b).find(".fc-day-number").css("top",o);var n="/core/api/events?start="+e.getTime()/1000+"&end="+h.getTime()/1000+"&owner_id="+CURRENT_AGILE_USER.id;$.getJSON(n,function(s){jso=[];$.each(s,function(z,w){if(w.color=="red"||w.color=="#f05050"){w.color="#f05050"}else{if(w.color=="#36C"||w.color=="#23b7e5"||w.color=="blue"){w.color="#7266ba"}else{if(w.color=="green"||w.color=="#bbb"){w.color="#fad733"}}}var C=new Date(w.start*1000);var t=new Date(w.end*1000);var B=(t.getMonth()-C.getMonth())+(t.getDate()-C.getDate());if(B==0){var A=JSON.parse(JSON.stringify(w));jso.push(A)}else{for(var x=0;x<=B;x++){var u=JSON.parse(JSON.stringify(w));var v=new Date(C.getFullYear(),C.getMonth(),C.getDate()+x,0,0,0).getTime()/1000;var y=new Date(C.getFullYear(),C.getMonth(),C.getDate()+x,23,59,59).getTime()/1000;if(x==0){u.start=C.getTime()/1000;u.end=y}else{if(x<B){u.start=v;u.end=y}else{u.start=v;u.end=t.getTime()/1000}}jso.push(u)}}});if(s){console.log(jso);$.each(jso,function(w,x){if(x.start>=(j.getTime()/1000)&&x.start<=(l.getTime()/1000)){if($(b).find(".portlet-calendar-error-message").length!=0){$(b).find(".portlet-calendar-error-message").css("display","none");$(b).find(".minical-portlet-event-add").css("display","none")}var v=new Date(x.start*1000);var t=$(b).find(".list").find("li").length;var u='<li class="p-t-xs p-r-xs" style="color:'+x.color+'"><span style="color : #58666e" class="text-cap word-break"><a class="minical-portlet-event" id='+x.id+" data-date="+j.getTime()+">"+x.title+'</a><br><small class="block m-t-n-xxs">'+v.format("HH:MM")+" </small></span></li>";if(t!=0){$(b).find(".list").find("small").each(function(y){if(v.format("HH:MM")<$(this).text()){$(this).parents("li").before(u);return false}if(y==t-1){$(this).parents(".list").append(u)}})}else{$(b).find(".list").append(u)}}});q(jso)}})}},{dataType:"agile-events-mini"}],eventRender:function(l,h,f){var j=l.start.getFullYear(),m=l.start.getMonth()+1,g=l.start.getDate();var e=j+"-"+(m<10?"0"+m:m)+"-"+(g<10?"0"+g:g);$(h).addClass(e);$(h).attr("id",l.id);a.push(e);$(".fc-event",".portlet_body_calendar").find(".fc-event-inner").css("display","none");var k=$(b).find("."+e).length;if(k>3){return false}},eventAfterRender:function(f,j,n){d++;if(c==0){c=$(b).find("#calendar_container").find(".fc-event").length}var k=parseInt($(b).find(".fc-widget-content").css("height"));var m=parseInt($(b).find(".fc-header").css("height"));var l=j.position().top+k-25;var g=j.position().left+5;$(j).css("top",l);$(j).css("left",g);if(d==c||d==(2*c)){var p;var e=c;c=0;d=0;jso=[];var o=[];$(b).find("#calendar_container").find(".fc-event").each(function(h){if($.inArray($(this).attr("class").split(" ")[$(this).attr("class").split(" ").length-1],o)==-1){o.push($(this).attr("class").split(" ")[$(this).attr("class").split(" ").length-1])}});$.each(o,function(q,t){var s=0;$.each(a,function(y,x){if(a[y]==o[q]){s++}});if(d==(2*e)){s=s/2}var w=$("."+this,b).eq(0).position();var h=$("."+this,b).length;var v=Math.round(($(b).find(".fc-widget-header").eq(1).width()-10)/2);if(h==1){w.left+=v}else{if(h==2){w.left+=v;w.left-=3}else{if(h==3){w.left+=v;w.left-=6}else{w.left+=v;w.left-=10}}}w.top+=8;$("."+this,b).each(function(x){if(x>0){$(this,b).css({top:w.top,left:w.left+(6*x)});if(x>2){$(this,b).hide()}}else{if(x==0){$(this,b).css({top:w.top,left:w.left})}}});if(s>3){var u=w.left+(3*6);$("."+this,b).eq(h-1).after('<div class="plus-button pos-abs c-p" style="top: '+(w.top-7)+"px;left: "+u+'px; color:lightgray;" title="'+(s-3)+' more">&nbsp;</div>')}});a=[]}},eventMouseover:function(e,l,n){$(b).find(".portlet_header_icons").removeClass("vis-hide");$(b).find(".fc-button").css("visibility","visible");b.parent().css("z-index",3);var o="";var j="";var h=$(this);if(CURRENT_AGILE_USER.domainUser.ownerPic==""||CURRENT_AGILE_USER.domainUser.ownerPic=="no image"){e.owner.pic=gravatarImgForPortlets(25)}if(h.data("data_fetched")){$(".fc-overlay").hide();$(".fc-overlay").remove();e.contacts=h.data("data_fetched");var k="bottom";var q="";var p="";var s={};s.leftorright=k;s.pullupornot=q;s.event=e;if(e.type=="AGILE"){h.append($(getTemplate("calendar-mouseover-popover-miniCalendar",s)));h.find(".fc-overlay").find(".arrow").css("top","70px")}var f=h.find(".fc-overlay");if(e.start.getDay()==4||e.start.getDay()==5||e.start.getDay()==6){f.css("left","-180px");f.find(".arrow").css("left","91%")}if(e.contacts.length>1){if(j!=""){f.css("top","-108px");f.find(".arrow").css("top","98px")}else{f.css("top","-95px");f.find(".arrow").css("top","84px")}}else{if(e.contacts.length>0){var m=f.height();var g=m-22;m=m-9;f.css("top","-"+m+"px");f.find(".arrow").css("top",g+"px")}}f.show();return}if(e.id!=undefined){mini_popover_call=$.ajax({url:"/core/api/events/contacts-related?id="+e.id,dataType:"json",success:function(z){console.log(z);e.contacts=z;h.data("data_fetched",z);$(".fc-overlay").hide();$(".fc-overlay").remove();var y="bottom";var w="";var x="";var t={};t.leftorright=y;t.pullupornot=w;t.event=e;if(e.type=="AGILE"){h.append($(getTemplate("calendar-mouseover-popover-miniCalendar",t)));h.find(".fc-overlay").find(".arrow").css("top","70px")}var v=h.find(".fc-overlay");if(e.start.getDay()==4||e.start.getDay()==5||e.start.getDay()==6){v.css("left","-180px");v.find(".arrow").css("left","91%")}if(e.contacts.length>1){if(j!=""){v.css("top","-108px");v.find(".arrow").css("top","98px")}else{v.css("top","-95px");v.find(".arrow").css("top","84px")}}else{if(e.contacts.length>0){var A=v.height();var u=A-22;A=A-9;v.css("top","-"+A+"px");v.find(".arrow").css("top",u+"px")}}v.show()}})}},eventMouseout:function(g,f,e){mini_popover_call.abort();b.parent().css("z-index",2);$(this).find(".fc-overlay").hide();$(this).find(".fc-overlay").remove()},dayClick:function(g,j,f,e){App_Portlets.refetchEvents=false;var m=$.fn.datepicker.dates.en.daysShort;var h=new Date();if(g.getFullYear()==h.getFullYear()&&g.getMonth()==h.getMonth()&&g.getDate()==h.getDate()){$(b).find(".events_show").empty().append('<div class="show p-t-xs text-md text-center">Today</div><ul class="list"></ul>')}else{$(b).find(".events_show").empty().append('<div class="show p-t-xs text-md text-center">'+m[g.getDay()]+", "+g.format("dd mmm")+' </div><ul class="list"></ul>')}if($(b).parent().attr("data-sizey")==2){$(b).find(".show").css("padding-top","70px")}else{if($(b).parent().attr("data-sizey")==3){$(b).find(".show").css("padding-top","120px")}}var k=new Date(g.getFullYear(),g.getMonth(),g.getDate(),23,59,59);var l=$("#calendar_container",b).fullCalendar("clientEvents",function(n){return(n.start>=g&&n.start<k)});if(l.length!=0){$.each(l,function(p){var n=$(b).find(".list").find("li").length;var o='<li class="p-t-xs p-r-xs" style="color : '+l[p].color+'"><span style="color : #58666e" class="text-cap word-break"><a class="minical-portlet-event" id='+l[p].id+" data-date="+g.getTime()+">"+l[p].title+'</a><br><small class="block m-t-n-xxs">'+l[p].start.format("HH:MM")+" </small></span></li>";if(n!=0){$(b).find(".list").find("small").each(function(q){if(l[p].start.format("HH:MM")<$(this).text()){$(this).parents("li").before(o);return false}if(q==n-1){$(this).parents(".list").append(o)}})}else{$(b).find(".list").append(o)}})}else{if(!App_Portlets.refetchEvents){$(b).find(".events_show").append('<div class="portlet-calendar-error-message">No appointments for the day</div><div class="text-center"><a class="minical-portlet-event-add text-info" id='+g.getTime()+" data-date="+g.getTime()+">+Add</a></div>")
}}}})}function loadingGoogleEvents(c,b,a){$.getJSON("core/api/calendar-prefs/type/GOOGLE",function(d){if(d==undefined){setTimeout(function(){if($(c).find(".list").find("li").length==0&&$(c).find(".portlet-calendar-error-message").length==0){var e=new Date();$(c).find(".events_show").append('<div class="portlet-calendar-error-message">No appointments for the day</div><div class="text-center"><a class="minical-portlet-event-add text-info" id='+e.getTime()+" data-date="+e.getTime()+">+Add</a></div>")}},7000);_agile_delete_prefs("current_date_calendar")}console.log(d);if(d){if(typeof gapi!="undefined"&&isDefined(gapi)&&isDefined(gapi.client)&&isDefined(gapi.client.calendar)){googledata(c,d,b,a);return}head.js("https://apis.google.com/js/client.js","/lib/calendar/gapi-helper.js?t=27",function(){setupGC(function(){googledata(c,d,b,a);return})})}})}var isSet=false;function init_cal(b){if(isSet){return}var a=$.fullCalendar;isSet=true;a.sourceFetchers.push(function(d,e,c){if(d.dataType=="agile-events-mini"){loadingGoogleEvents(App_Portlets.eventCalendar,e.getTime()/1000,c.getTime()/1000);getOfficeEvents(App_Portlets.eventCalendar,e.getTime(),c.getTime())}})}function googledata(a,j,b,m){try{gapi.auth.setToken({access_token:j.access_token,state:"https://www.googleapis.com/auth/calendar"});var h=new Date();var o=h.getTimezoneOffset();var d=new Date((b*1000)-(o*60*1000));var c=d.toISOString();var l=new Date((m*1000)-(o*60*1000));var f=l.toISOString();var k=gapi.client.calendar.events.list({calendarId:"primary",maxResults:1000,singleEvents:true,orderBy:"startTime",timeMin:c,timeMax:f});k.execute(function(e){head.js("flatfull/lib/web-calendar-event/moment.min.js",function(){head.js("flatfull/lib/web-calendar-event/moment-timezone-with-data.js",function(){var v=new Array();console.log(e);if(e.items){for(var u=0;u<e.items.length;u++){var q=google2fcEvent(e.items[u]);renderGoogleEvents(v,q,a)}}console.log($("#calendar_container",a).fullCalendar("getView").visStart);$("#calendar_container",a).fullCalendar("removeEventSource",functions["event_mini_google"+$(a).attr("id")]);var s=v.slice(0);functions["event_mini_google"+$(a).attr("id")]=function(y,w,x){console.log(this);console.log($("#calendar_container",a).fullCalendar("getView").visStart);if($("#calendar_container",a).fullCalendar("getView").visStart.getTime()!=y.getTime()){return}x(s)};$("#calendar_container",a).fullCalendar("addEventSource",functions["event_mini_google"+$(a).attr("id")]);s=[];var p=$(".events_show",a).find(".list").find("li").length;var t=new Date();$.each(v,function(y,z){if($(a).find(".portlet-calendar-error-message").length!=0){$(a).find(".portlet-calendar-error-message").css("display","none");$(a).find(".minical-portlet-event-add").css("display","none")}var x=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0);var B=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59);if(_agile_get_prefs("current_date_calendar")!=null){var A=new Date(_agile_get_prefs("current_date_calendar"));x=A;B=new Date(A.getFullYear(),A.getMonth(),A.getDate(),23,59,59)}if(z.start.getTime()>=(x.getTime())&&z.start.getTime()<=(B.getTime())){var w='<li class="p-t-xs p-r-xs" style="color:'+z.color+'"><span style="color : #58666e" class="text-cap word-break"><a class="minical-portlet-event" id='+z.id+" data-date="+t.getTime()+">"+z.title+'</a><br><small class="block m-t-n-xxs">'+z.start.format("HH:MM")+" </small></span></li>";if(p!=0){$(a).find(".list").find("small").each(function(C){if(z.start.format("HH:MM")<$(this).text()){$(this).parents("li").before(w);return false}if(C==p-1){$(this).parents(".list").append(w)}})}else{$(a).find(".list").append(w)}}});_agile_delete_prefs("current_date_calendar");setTimeout(function(){if($(a).find(".list").find("li").length==0&&$(a).find(".portlet-calendar-error-message").length==0){$(a).find(".events_show").append('<div class="portlet-calendar-error-message">No appointments for the day</div><div class="text-center"><a class="minical-portlet-event-add text-info" id='+t.getTime()+" data-date="+t.getTime()+">+Add</a></div>")}},7000)})})})}catch(n){if($(a).find(".list").find("li").length==0&&$(a).find(".portlet-calendar-error-message").length==0){var g=new Date();$(a).find(".events_show").append('<div class="portlet-calendar-error-message">No appointments for the day</div><div class="text-center"><a class="minical-portlet-event-add text-info" id='+g.getTime()+" data-date="+g.getTime()+">+Add</a></div>")}}}function renderGoogleEvents(j,f,b){f.startDate=new Date(f.start);f.end=new Date(f.end);f.color="#3a3f51";f.backgroundColor="#3a3f51";if(f.allDay==true){f.startDate=new Date(f.start);f.end=new Date(f.end);f.start=new Date(f.startDate.getTime()+f.startDate.getTimezoneOffset()*60*1000);f.end=new Date(new Date(f.google.end.date).getTime()+f.startDate.getTimezoneOffset()*60*1000);var g;if(f.start.getMonth()<f.end.getMonth()){g=Math.round((f.end-f.start)/(60*60*1000*24))}else{g=(f.end.getMonth()-f.start.getMonth())+(f.end.getDate()-f.start.getDate())}if(g==1){f.start=f.start.getTime()/1000;f.end=(f.end.getTime()-1)/1000;j.push(f)}else{for(var e=0;e<g;e++){var c={};c=JSON.parse(JSON.stringify(f));if(e==0){c.start=f.start.getTime()/1000;c.end=new Date(f.start.getFullYear(),f.startDate.getMonth(),f.startDate.getDate()+e,23,59,59).getTime()/1000}else{if(e<g){c.start=new Date(f.start.getFullYear(),f.start.getMonth(),f.start.getDate()+e,0,0,0).getTime()/1000;c.end=new Date(f.start.getFullYear(),f.start.getMonth(),f.start.getDate()+e,23,59,59).getTime()/1000}else{c.start=new Date(f.start.getFullYear(),f.start.getMonth(),f.start.getDate()+e,0,0,0).getTime()/1000;c.end=f.end.getTime()/1000}}console.log(c);j.push(c)}}}else{console.log("Start : "+f.start);var k=new Date(f.start).toUTCString();var d=moment.tz(k,CURRENT_USER_PREFS.timezone);var h=d.format("YYYY-MM-DD HH:mm:ss");f.startDate=new Date(h);console.log("Start Modified : "+h);console.log("End : "+f.end);k=new Date(f.end).toUTCString();d=moment.tz(k,CURRENT_USER_PREFS.timezone);h=d.format("YYYY-MM-DD HH:mm:ss");f.end=new Date(h);console.log("End Modified : "+f.end);var g;if(f.startDate.getMonth()<f.end.getMonth()){g=Math.round((f.end-f.startDate)/(60*60*1000*24))}else{g=(f.end.getMonth()-f.startDate.getMonth())+(f.end.getDate()-f.startDate.getDate())}if(g==0){f.start=f.startDate.getTime()/1000;f.end=f.end.getTime()/1000;j.push(f)}else{for(var e=0;e<=g;e++){var c={};c=JSON.parse(JSON.stringify(f));if(e==0){c.start=f.startDate.getTime()/1000;c.end=new Date(f.startDate.getFullYear(),f.startDate.getMonth(),f.startDate.getDate()+e,23,59,59).getTime()/1000}else{if(e<g){c.start=new Date(f.startDate.getFullYear(),f.startDate.getMonth(),f.startDate.getDate()+e,0,0,0).getTime()/1000;c.end=new Date(f.startDate.getFullYear(),f.startDate.getMonth(),f.startDate.getDate()+e,23,59,59).getTime()/1000}else{c.start=new Date(f.startDate.getFullYear(),f.startDate.getMonth(),f.startDate.getDate()+e,0,0,0).getTime()/1000;c.end=f.end.getTime()/1000}}console.log(c);j.push(c)}}}}function getOfficeEvents(e,a,d){var c="core/api/officecalendar/office365-appointments?startDate="+a+"&endDate="+d;var b=new Array();$.getJSON(c,function(g){if(g){for(var j=0;j<g.length;j++){var k=g[j];k.allDay=false;renderOfficeEvents(b,k,e)}var f=$(".events_show",e).find(".list").find("li").length;var h=new Date();$.each(b,function(n,o){var m=new Date(h.getFullYear(),h.getMonth(),h.getDate(),0,0,0);var q=new Date(h.getFullYear(),h.getMonth(),h.getDate(),23,59,59);if(_agile_get_prefs("current_date_calendar")!=null){var p=new Date(_agile_get_prefs("current_date_calendar"));m=p;q=new Date(p.getFullYear(),p.getMonth(),p.getDate(),23,59,59)}if(o.start.getTime()>=(m.getTime())&&o.start.getTime()<=(q.getTime())){var l='<li class="p-t-xs p-r-xs" style="color:'+o.color+'"><span style="color : #58666e" class="text-cap word-break"><a class="minical-portlet-event" id='+o.id+" data-date="+h.getTime()+">"+o.title+'</a><br><small class="block m-t-n-xxs">'+o.start.format("HH:MM")+" </small></span></li>";if(f!=0){$(e).find(".list").find("small").each(function(s){if(o.start.format("HH:MM")<$(this).text()){$(this).parents("li").before(l);return false}if(s==f-1){$(this).parents(".list").append(l)}})}else{$(e).find(".list").append(l)}}});_agile_delete_prefs("current_date_calendar");setTimeout(function(){if($(e).find(".list").find("li").length==0&&$(e).find(".portlet-calendar-error-message").length==0){$(e).find(".events_show").append('<div class="portlet-calendar-error-message">No appointments for the day</div><div class="text-center"><a class="minical-portlet-event-add text-info" id='+h.getTime()+" data-date="+h.getTime()+">+Add</a></div>")}},7000)}else{console.log("Error occurred while fetching office records.")}})}function renderOfficeEvents(d,c,f){c.startDate=new Date(c.start);c.end=new Date(c.end);c.color="#74ceff";c.backgroundColor="#74ceff";if(c.allDay==true){c.start=new Date(c.startDate.getTime()+c.startDate.getTimezoneOffset()*60*1000);c.end=new Date(new Date(c.google.end.date).getTime()+c.startDate.getTimezoneOffset()*60*1000);var b;if(c.start.getMonth()<c.end.getMonth()){b=Math.round((c.end-c.start)/(60*60*1000*24))}else{b=(c.end.getMonth()-c.start.getMonth())+(c.end.getDate()-c.start.getDate())}if(b==1){c.start=c.start.getTime()/1000;c.end=(c.end.getTime()-1)/1000;$("#calendar_container",f).fullCalendar("renderEvent",c);d.push(c)}else{for(var e=0;e<b;e++){var g={};g=JSON.parse(JSON.stringify(c));if(e==0){g.start=c.start.getTime()/1000;g.end=new Date(c.start.getFullYear(),c.startDate.getMonth(),c.startDate.getDate()+e,23,59,59).getTime()/1000}else{if(e<b){g.start=new Date(c.start.getFullYear(),c.start.getMonth(),c.start.getDate()+e,0,0,0).getTime()/1000;g.end=new Date(c.start.getFullYear(),c.start.getMonth(),c.start.getDate()+e,23,59,59).getTime()/1000}else{g.start=new Date(c.start.getFullYear(),c.start.getMonth(),c.start.getDate()+e,0,0,0).getTime()/1000;g.end=c.end.getTime()/1000}}console.log(g);$("#calendar_container",f).fullCalendar("renderEvent",g);d.push(g)
}}}else{var b;if(c.startDate.getMonth()<c.end.getMonth()){b=Math.round((c.end-c.startDate)/(60*60*1000*24))}else{b=(c.end.getMonth()-c.startDate.getMonth())+(c.end.getDate()-c.startDate.getDate())}if(b==0){c.start=c.startDate.getTime()/1000;c.end=c.end.getTime()/1000;$("#calendar_container",f).fullCalendar("renderEvent",c);d.push(c)}else{for(var e=0;e<=b;e++){var g={};g=JSON.parse(JSON.stringify(c));if(e==0){g.start=c.startDate.getTime()/1000;g.end=new Date(c.startDate.getFullYear(),c.startDate.getMonth(),c.startDate.getDate()+e,23,59,59).getTime()/1000}else{if(e<b){g.start=new Date(c.startDate.getFullYear(),c.startDate.getMonth(),c.startDate.getDate()+e,0,0,0).getTime()/1000;g.end=new Date(c.startDate.getFullYear(),c.startDate.getMonth(),c.startDate.getDate()+e,23,59,59).getTime()/1000}else{g.start=new Date(c.startDate.getFullYear(),c.startDate.getMonth(),c.startDate.getDate()+e,0,0,0).getTime()/1000;g.end=c.end.getTime()/1000}}console.log(g);$("#calendar_container",f).fullCalendar("renderEvent",g);d.push(g)}}}}function getaspectratio(e){var d;var b;var c=$(e).parent().attr("data-sizex");var a=$(e).parent().attr("data-sizey");if(c==1){$(e).find("#calendar_container").css("padding","0px")}if(c==2){$(e).find("#calendar_container").css("padding","0px 50px 0px")}if(c==3){$(e).find("#calendar_container").css("padding","0px 100px 0px")}if(a==1){b=$(e).height()-25}else{if(a==2){b=$(e).height()-200}else{b=$(e).height()-350}}d=$(e).find("#calendar_container").width();return(d/b)}function initializePortletsListeners(){$(".modal-footer").off("click").on("click",".portlet-settings-save-modal",function(s){s.preventDefault();var f=$(window).scrollTop();var p=$(this).parent().prev().find("form:visible").attr("id");var b=$(this).parent().parent().parent().parent().attr("id");if(!isValidForm("#"+p)){return false}$(this).attr("disabled",true);$(this).text("Saving...");var a=this.id;var o=true;var q={};var j={};var k=$("#portlet-type",$("#"+b)).val();var h=$("#portlet-name",$("#"+b)).val();q=serializeForm(p);if($("#duration,#duration-incoming-deals,#duration-lost-deal-analysis,#duration-user-activities","#"+b)!=null&&$("#duration,#duration-incoming-deals,#duration-lost-deal-analysis,#duration-user-activities","#"+b).val()!="Custom"){delete q["start-date"];delete q["end-date"]}if($("#duration,#duration-incoming-deals,#duration-lost-deal-analysis,#duration-user-activities","#"+b)!=null&&$("#duration,#duration-incoming-deals,#duration-lost-deal-analysis,#duration-user-activities","#"+b).val()=="Custom"){if(!is_valid_custom_range(q["start-date"]*1000,q["end-date"]*1000,b)){$(this).attr("disabled",false);$(this).text("Save");return}}if($("#"+b).find(".invalid-range").is(":visible")){$("#"+b).find(".invalid-range").parents(".form-group").hide()}if(k=="CONTACTS"&&h=="Growth Graph"){var l="";if($("#addPortletBulkTags").val()!=""){var v=$("#addPortletBulkTags").val();if($("#portlet-ul-tags > li").length==0){$("#portlet-ul-tags").append("<li data='"+v+"' class='tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block'>'"+v+"'<a tag='"+v+"' id='remove_tag' class='close m-l-xs'>&time</a></li>")}else{$("#portlet-ul-tags > li:last").after("<li data='"+v+"' class='tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block'>'"+v+"'<a tag='"+v+"' id='remove_tag' class='close m-l-xs'>&time</a></li>")}}$("#portlet-ul-tags > li").each(function(){if($(this).is(":last")){l+=$(this).attr("data")}else{l+=$(this).attr("data")+","}});q.tags=l}if(k=="USERACTIVITY"&&h=="Leaderboard"){var t={};var m=[];$("#category-list",$("#"+a).parent().parent()).find("option").each(function(){if($(this).is(":selected")){t[""+$(this).val()]=true}else{t[""+$(this).val()]=false}});$("#user-list",$("#"+a).parent().parent()).find("option:selected").each(function(){m.push($(this).val())});q.duration=$("#duration",$("#"+a).parent().parent()).val();q.category=t;q.user=m}var u=$("#"+$(this).attr("id").split("-save-modal")[0]).parent().find(".portlet_body").attr("id");var n=Portlets_View.collection.get(a.split("-save-modal")[0]);var g=n.get("column_position");var d=n.get("row_position");n.set({prefs:JSON.stringify(q)},{silent:true});n.url="core/api/portlets";var c=new BaseModel();c.url="core/api/portlets";if(o){c.save(n.toJSON(),{success:function(w){hidePortletSettingsAfterSave(b);$(window).scrollTop(f);f=0;var e=w.toJSON();Portlets_View.collection.get(e).set(new BaseModel(e));var x=""+w.get("column_position")+""+w.get("row_position");portlet_utility.getInnerViewOfPortlet(w,$("#portlet-res"));setPortletContentHeight(w);$("#"+w.get("id")).parent().find("div:last").after('<span class="gs-resize-handle gs-resize-handle-both"></span>')},})}});$("#portletsTaskReportSettingsModal").off("change").on("change","#group-by-task-report",function(a){$("#tasks-task-report").trigger("change");$("#split-by-task-report > option").each(function(b){if($(this).val()==$("#group-by-task-report").val()){$(this).hide()}else{if($("#tasks-task-report").val()=="completed-tasks"&&$(this).val()!="status"){$(this).show();$(this).attr("selected",true)}else{if($("#tasks-task-report").val()=="all-tasks"){$(this).show();$(this).attr("selected",true)}}}});if($("#group-by-task-report").val()=="status"){$("#tasks-task-report > option#all-tasks").attr("selected",true);$("#tasks-control-group").hide()}else{$("#tasks-control-group").show()}});$(".modal-content").off("change").on("change","#tasks-task-report",function(a){var b=$("#split-by-task-report > option#status");if($("#tasks-task-report").val()=="completed-tasks"){if(b.is(":selected")){b.attr("selected",false)}b.hide()}else{b.show()}});$("#portletsPendingDealsSettingsModal").off("change","#track");$("#portletsPendingDealsSettingsModal").on("change","#track",function(c){var b=$(this).closest("form");var a=$("#track",b).val();if(a!="anyTrack"){$.ajax({type:"GET",url:"/core/api/milestone/"+a,dataType:"json",success:function(f){var d=f.milestones.split(",");$("#milestone").html("");var e=f.lost_milestone;var g=f.won_milestone;if(d.length>1){$("#milestone",b).html('<option value="anyMilestone">Any</option>')}$.each(d,function(h,j){if(e!=null&&g!=null){if(!(j==e)&&!(j==g)){$("#milestone",b).append('<option value="'+j+'">'+j+"</option>")}}else{if(!(j=="Won")&&!(j=="Lost")){$("#milestone",b).append('<option value="'+j+'">'+j+"</option>")}}})}})}else{$("#milestone",b).html('<option value="anyMilestone">Any</option>')}});$(".gridster-portlets").off("mouseover").on("mouseover",".stats_report_portlet_body",function(a){if($(".stats_report_portlet_body").parent().find(".gs-resize-handle")){$(".stats_report_portlet_body").parent().find(".gs-resize-handle").remove()}});$(".portlet_body").off("change").on("change",".onboarding-check",function(d){var c=$(this);var f=$(this).parent().parent().parent().find(".portlets").attr("id");var a=Portlets_View.collection.get(f);var b={};$(this).parent().parent().find("label").each(function(){var e={};if($(this).find("input:checkbox").is(":checked")){e.done=true;e.skip=false}else{e.done=false;e.skip=false}b[""+$(this).attr("value")]=e});a.set({prefs:JSON.stringify(b)},{silent:true});$.ajax({type:"POST",url:"/core/api/portlets/save-onboarding-prefs",data:JSON.stringify(a.toJSON()),contentType:"application/json; charset=utf-8",dataType:"json",success:function(){if(c.find("input:checkbox").is(":checked")){c.parent().find("span").css("text-decoration","line-through")}else{c.parent().find("span").css("text-decoration","none")}}})});$("#chrome-extensions").popover({placement:$(this).attr("data-placement"),html:true,container:"body",content:function(){return getTemplate("extensions-download-model")}});$(".modal-body").off("click").on("click","#category-select-all",function(a){a.preventDefault();$("#category-list").multiSelect("select_all")});$("#chrome-extension").popover({placement:$(this).attr("data-placement"),html:true,container:"body",content:function(){return $(getTemplate("extensions-download-model")).html()}});$(".modal-content").off("click").on("click","#category-select-none",function(a){a.preventDefault();$("#category-list").multiSelect("deselect_all")});$(".modal-body").on("click","#user-select-all",function(a){a.preventDefault();$("#user-list").multiSelect("select_all")});$(".modal-content").on("click","#user-select-none",function(a){a.preventDefault();$("#user-list").multiSelect("deselect_all")});$(".modal-body").on("click","#calls-user-select-all",function(a){a.preventDefault();$("#calls-user-list").multiSelect("select_all")});$(".modal-content").on("click","#calls-user-select-none",function(a){a.preventDefault();$("#calls-user-list").multiSelect("deselect_all")});$(".modal-body").on("click","#task-report-user-select-all",function(a){a.preventDefault();$("#task-report-user-list").multiSelect("select_all")});$(".modal-content").on("click","#task-report-user-select-none",function(a){a.preventDefault();$("#task-report-user-list").multiSelect("deselect_all")});$(".gridster-portlets").on("mouseover",".portlet_body_calendar",function(a){$(this).find(".portlet_header_icons").removeClass("vis-hide");$(this).find(".fc-button").css("visibility","visible")});$(".gridster-portlets").on("mouseout",".portlet_body_calendar",function(a){$(this).find(".portlet_header_icons").addClass("vis-hide");$(this).find(".fc-button").css("visibility","hidden")});$(".portlet_body_calendar").on("click",".fc-button-content",function(a){App_Portlets.eventCalendar=$(this).parents(".portlet_body_calendar")});$(".events_show").off("click",".minical-portlet-event");$(".events_show").on("click",".minical-portlet-event",function(d){App_Portlets.currentPosition=""+$(this).parents(".gs-w").find(".column_position").text().trim()+""+$(this).parents(".gs-w").find(".row_position").text().trim();App_Portlets.currentPortletName="Mini Calendar";var g=$(this).attr("id");if(g&&!isNaN(g)){var a=$("#calendar_container",$(this).parents(".portlet_body_calendar")).fullCalendar("clientEvents",g,function(e){return(e.start>=date&&e.start<endDate)});var b=a[0];App_Portlets.currentEventObj=b;var f="/core/api/events/"+a[0].id;
var c;$.getJSON(f,function(l){c=l;var n=getDate(c.start);var e=getDate(c.end);if(!b){return}if(b.color=="#f05050"||b.color=="red"){b.color="red"}else{if(b.color=="#7266ba"||b.color=="#36C"){b.color="#36C"}else{b.color="green"}}$("#updateActivityModal").html(getTemplate("update-activity-modal"));deserializeForm(b,$("#updateActivityForm"));$("#current_div","#updateActivityModal").val("Mini Calendar");$("#update-event-date-1").val(getDateInFormat(n));$("#update-event-date-2").val(getDateInFormat(e));$("#update-event-time-1").val((n.getHours()<10?"0":"")+n.getHours()+":"+(n.getMinutes()<10?"0":"")+n.getMinutes());$("#update-event-time-2").val((e.getHours()<10?"0":"")+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes());if(b.allDay){$("#update-event-date-2").closest(".row").hide();$("#update-event-time-1").closest(".control-group").hide()}else{$("#update-event-time-1").closest(".control-group").show();$("#update-event-date-2").closest(".row").show()}if(b.type=="WEB_APPOINTMENT"&&(b.start.getTime()/1000)>parseInt(new Date().getTime()/1000)){$("[id='event_delete']").attr("id","delete_web_event");web_event_title=b.title;if(b.contacts.length>0){var k=getPropertyValue(b.contacts[0].properties,"first_name");if(k==undefined){k=""}var j=getPropertyValue(b.contacts[0].properties,"last_name");if(j==undefined){j=""}web_event_contact_name=k+" "+j}}else{$("[id='delete_web_event']").attr("id","event_delete")}if(b.description){var h='<label class="control-label"><b>'+_agile_get_translated_val("misc-keys","description")+' </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div>';$("#event_desc").html(h);$("textarea#description").val(b.description)}else{var m='<div class="row-fluid"><div class="control-group form-group m-b-none"><a href="#" id="add_event_desctiption"><i class="icon-plus"></i> '+_agile_get_translated_val("misc-keys","add-description")+' </a><div class="controls event_discription hide"><textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div></div></div>';$("#event_desc").html(m)}populateUsersInUpdateActivityModal(b);$("#updateActivityModal").modal("show");$("#"+g,$("#calendar_container")).trigger("click");return false})}});$(".events_show").off("click",".minical-portlet-event-add");$(".events_show").on("click",".minical-portlet-event-add",function(a){App_Portlets.currentPosition=""+$(this).parents(".gs-w").find(".column_position").text().trim()+""+$(this).parents(".gs-w").find(".row_position").text().trim();App_Portlets.currentPortletName="Mini Calendar";var b=new Date(parseInt($(this).attr("id")));$("#activityModal").html(getTemplate("new-event-modal")).modal("show");highlight_event();$("#task-date-1").val(getDateInFormat(b));$("#event-date-1").val(getDateInFormat(b));$("#event-date-2").val(getDateInFormat(b));$("#current_div","#activityModal").val("Mini Calendar");$("#event-time-1").val("");$("#event-time-2").val("")});$("#portletDeleteModal").off("click").on("click",".portlet-delete-modal",function(a){a.preventDefault();var b=Portlets_View.collection.get($(this).attr("id"));$.ajax({type:"DELETE",url:"/core/api/portlets/"+b.get("id"),contentType:"application/json; charset=utf-8",success:function(c){Portlets_View.collection.remove(b);gridster.remove_widget($("#"+b.get("id")).parent(),false);setTimeout(function(){var e=gridster.$changed.attr("id","ui-id-"+gridster.$changed.attr("data-col")+"-"+gridster.$changed.attr("data-row"));var d=[];e.each(function(){var g=$(this).find(".portlets").attr("id");var f=Portlets_View.collection.get(g);if(f!=undefined){f.set({column_position:parseInt($(this).attr("data-col"))},{silent:true});f.set({row_position:parseInt($(this).attr("data-row"))},{silent:true});d.push({id:f.get("id"),column_position:parseInt($(this).attr("data-col")),row_position:parseInt($(this).attr("data-row"))})}});$.ajax({type:"POST",url:"/core/api/portlets/positions",data:JSON.stringify(d),contentType:"application/json; charset=utf-8",dataType:"json"})},500);$("#"+b.get("id")).parent().remove();if(b.get("portlet_route")!="DashBoard"&&isNaN(b.get("portlet_route"))){if($(".gridster-portlets > div").length==0){$("#no-portlets").parents(".route_Portlet").hide()}}if($(".gridster-portlets > div").length==0){$("#no-portlets").show()}$("#portletDeleteModal").modal("hide")},dataType:"json"})});$("#dashlet_heading").off("click","#tutotial_modal");$("#dashlet_heading").on("click","#tutotial_modal",function(a){a.preventDefault();$("#tutorialModal").html(getTemplate("tutorial-modal"));$("#tutorialModal").modal("show")});$(".portlet_body #portlets-contacts-model-list > tr, #portlets-companies-model-list > tr, #portlets-contacts-email-opens-model-list > tr").off();$(".portlet_body").on("click","#portlets-contacts-model-list > tr, #portlets-companies-model-list > tr, #portlets-contacts-email-opens-model-list > tr",function(a){var b=$(this).find(".data").attr("data");App_Contacts.navigate("contact/"+b,{trigger:true})});$(".portlet_body .email-details").off();$(".portlet_body").on("click",".email-details",function(b){b.preventDefault();var a=$(this).closest("a").attr("data");portlet_utility.getActivityObject(a,function(c){console.log(c);getTemplate("infoModal",c,undefined,function(e){if(!e){return}var d=$(e);d.modal("show")},null)})});$(".portlet_body .activity-event-edit").off();$(".portlet_body").on("click",".activity-event-edit",function(b){b.preventDefault();var a=$(this).closest("a").attr("data");getEventObject(a,function(c){update_event_activity(c)})});$(".portlet_body #portlets-opportunities-model-list > tr").off();$(".portlet_body").on("click","#portlets-opportunities-model-list > tr",function(b){var a=false;if(b.target.attributes!=undefined&&b.target.attributes!=null&&b.target.attributes.length==0){a=true}$.each(b.target.attributes,function(){if(this.name=="href"){a=true}});if(!a){var c=$(this).find(".data").attr("data");App_Deal_Details.navigate("deal/"+c,{trigger:true})}});$(".portlet_body").off("click","#portlets-events-model-list > tr");$(".portlet_body").on("click","#portlets-events-model-list > tr",function(l){var c=false;if(l.target.attributes&&l.target.attributes.length==0){c=true}$.each(l.target.attributes,function(){if(this.name=="href"){c=true}});if(!c){App_Portlets.currentPosition=""+$(this).parents(".gs-w").find(".column_position").text().trim()+""+$(this).parents(".gs-w").find(".row_position").text().trim();var b=$(this).find(".data").attr("data");var f=$(this).data().collection.get(b);if(isNaN(b)){return}$("#updateActivityModal").html(getTemplate("update-activity-modal"));deserializeForm(f.toJSON(),$("#updateActivityForm"));var d=new Date(f.get("start")*1000);var g=new Date(f.get("end")*1000);$("#current_div","#updateActivityModal").val("Events Dashlet");$("#update-event-time-1").val((d.getHours()<10?"0":"")+d.getHours()+":"+(d.getMinutes()<10?"0":"")+d.getMinutes());$("#update-event-time-2").val((g.getHours()<10?"0":"")+g.getHours()+":"+(g.getMinutes()<10?"0":"")+g.getMinutes());var a=CURRENT_USER_PREFS.dateFormat;$("#update-event-date-1").val(d.format(a));$("#update-event-date-2").val(g.format(a));if(f.toJSON().allDay){$("#update-event-date-2").closest(".row").hide();$("#update-event-time-1").closest(".control-group").hide()}else{$("#update-event-time-1").closest(".control-group").show();$("#update-event-date-2").closest(".row").show()}if(f.toJSON().type=="WEB_APPOINTMENT"&&parseInt(f.toJSON().start)>parseInt(new Date().getTime()/1000)){$("[id='event_delete']").attr("id","delete_web_event");web_event_title=f.toJSON().title;if(f.toJSON().contacts.length>0){var h=getPropertyValue(f.toJSON().contacts[0].properties,"first_name");if(h==undefined){h=""}var k=getPropertyValue(f.toJSON().contacts[0].properties,"last_name");if(k==undefined){k=""}web_event_contact_name=h+" "+k}}else{$("[id='delete_web_event']").attr("id","event_delete")}populateUsersInUpdateActivityModal(f.toJSON());if(f.toJSON().description){var m='<label class="control-label"><b>'+_agile_get_translated_val("misc-keys","description")+' </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div>';$("#event_desc").html(m);$("textarea#description").val(f.toJSON().description)}else{var j='<div class="row-fluid"><div class="control-group form-group m-b-none"><a href="#" id="add_event_desctiption"><i class="icon-plus"></i> '+_agile_get_translated_val("misc-keys","add-description")+' </a><div class="controls event_discription hide"><textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div></div></div>';$("#event_desc").html(j)}$("#updateActivityModal").modal("show");return false}});$(".portlet_body").on("click","#portlets-tasks-model-list > tr",function(b){var a=false;if(b.target.tagName.toLowerCase()=="a"||b.target.tagName.toLowerCase()=="i"||b.target.tagName.toLowerCase()=="input"){a=true}$.each(b.target.attributes,function(){if(this.name=="href"){a=true}});if(!a){var c=$(this).find(".data").attr("data");App_Tasks.navigate("task/"+c,{trigger:true})}});$(".portlet_body").on("click",".portlets-tasks-select",function(d){d.stopPropagation();if($(this).is(":checked")){var c=$(this).attr("data");var a=$(this).parentsUntil(".gs-w").last().parent().find(".column_position").text().trim();var b=$(this).parentsUntil(".gs-w").last().parent().find(".row_position").text().trim();var f=a+""+b;complete_task(c,App_Portlets.tasksCollection[parseInt(f)].collection,$(this).closest("tr"));if($(this).parentsUntil("table").last().find("tr:visible").length==1){$(this).parentsUntil("table").parent().parent().html('<div class="portlet-error-message">No tasks found.</div>')
}}});$(".gridster-portlets").off("click").on("click",".portlet-settings",function(a){a.preventDefault();portlet_utility.showPortletSettings(this.id)});$(".gridster-portlets").on("mouseover",".goals_portlet_body",function(a){if($(".goals_portlet_body").parent().find(".gs-resize-handle")){$(".goals_portlet_body").parent().find(".gs-resize-handle").remove()}});$("#dashlet_heading .user-defined-dashboard").off("click");$("#dashlet_heading").on("click",".user-defined-dashboard",function(b){b.preventDefault();var a=_agile_get_prefs("dashboard_"+CURRENT_DOMAIN_USER.id);var c=$(this).attr("id");_agile_set_prefs("selected_dashboard_"+CURRENT_DOMAIN_USER.id,c);$(".user-defined-dashboard").parent().removeClass("active");$(this).parent().addClass("active");if(c!=$("#dashboard-name").attr("data-value")){App_Portlets.DashboardPortlets=new Array();if($(this).hasClass("predefined-dashboard")&&a&&a!="Dashboard"){b.preventDefault();_agile_delete_prefs("dashboard_"+CURRENT_DOMAIN_USER.id);loadPortlets("DashBoard",$("#content"))}else{if(c=="MarketingDashboard"||c=="SalesDashboard"){b.preventDefault();_agile_set_prefs("dashboard_"+CURRENT_DOMAIN_USER.id,c);gridster=undefined;loadPortlets(c,$("#content"))}else{if(!$(this).hasClass("predefined-dashboard")&&a&&a!=c){b.preventDefault();_agile_set_prefs("dashboard_"+CURRENT_DOMAIN_USER.id,c);gridster=undefined;loadPortlets(c,$("#content"))}else{if(!$(this).hasClass("predefined-dashboard")){b.preventDefault();_agile_set_prefs("dashboard_"+CURRENT_DOMAIN_USER.id,c);gridster=undefined;loadPortlets(c,$("#content"))}}}}$("#dashboard-name").text($(this).text());$("#dashboard-name").attr("data-value",c);$("#dashboard-name").attr("title",$(this).attr("title"));$.each(CURRENT_USER_DASHBOARDS,function(d,e){if(c==this.id){$("#dashboard-desc").text(this.description);$("#dashboard-desc").attr("title",this.description)}});if(c=="MarketingDashboard"){$("#dashboard-desc").text(_agile_get_translated_val("dashboards","marketing-help"));$("#dashboard-desc").attr("title",_agile_get_translated_val("dashboards","marketing-help"))}if(c=="SalesDashboard"){$("#dashboard-desc").text(_agile_get_translated_val("dashboards","sales-help"));$("#dashboard-desc").attr("title",_agile_get_translated_val("dashboards","sales-help"))}if(c=="Dashboard"){$("#dashboard-desc").text("Welcome to Agile CRM");$("#dashboard-desc").attr("title","");$("#dashboard-name").attr("title","")}}});$(".modal-body").off("change","#duration,#duration-lost-deal-analysis,#duration-incoming-deals,#duration-user-activities");$(".modal-body").on("change","#duration,#duration-lost-deal-analysis,#duration-incoming-deals,#duration-user-activities",function(d){var b=$(this).closest("form");var c=$(this,b).val();if(c=="Custom"){$("#start_date",b).val("");$("#end_date",b).val("");$(".daterange",b).removeClass("hide");if(b.attr("id")=="portletsGoalsSettingsForm"){$("#start_date",b).datepicker({format:"MM yyyy",minViewMode:"months",weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});$("#end_date",b).datepicker({format:"MM yyyy",minViewMode:"months",weekStart:CALENDAR_WEEK_START_DAY,autoclose:true})}else{var a=$("#start_date",b).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true}).on("changeDate",function(e){var f;if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy")!=-1||CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy")!=-1){f=new Date(convertDateFromUKtoUS($("#end_date",b).val()))}else{f=new Date($("#end_date",b).val())}if(e.date.valueOf()>f.valueOf()){var g=e.date.valueOf();$("#end_date",elData).val($("#start_date",elData).val())}});$("#end_date",b).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true})}}else{$(b).find(".daterange").addClass("hide");$(".daterange span:not(.field_req)",b).each(function(){$(this).hide()})}if($(b).find(".invalid-range").is(":visible")){$(b).find(".invalid-range").parents(".form-group").hide()}})}function initializeAddPortletsListeners(){$(".col-md-3").on("mouseenter",".show_screeshot",function(g){var b=$(this).attr("id");var f;var c="right";var a={FilterBased:updateImageS3Path("flatfull/img/dashboard_images/My-contacts.png"),EmailsOpened:updateImageS3Path("flatfull/img/dashboard_images/Email-opened.png"),GrowthGraph:updateImageS3Path("flatfull/img/dashboard_images/Tag-Graph.png"),PendingDeals:updateImageS3Path("flatfull/img/dashboard_images/Pending-Deals.png"),DealsByMilestone:updateImageS3Path("flatfull/img/dashboard_images/Milestone.png"),DealsFunnel:updateImageS3Path("flatfull/img/dashboard_images/Deals-Funnel.png"),Agenda:updateImageS3Path("flatfull/img/dashboard_images/Events.png"),TodayTasks:updateImageS3Path("flatfull/img/dashboard_images/Task.png"),CallsPerPerson:updateImageS3Path("flatfull/img/dashboard_images/Calls.png"),AgileCRMBlog:updateImageS3Path("flatfull/img/dashboard_images/Agile-Blog.png"),TaskReport:updateImageS3Path("flatfull/img/dashboard_images/Task-report.png"),StatsReport:updateImageS3Path("flatfull/img/dashboard_images/stats.png"),Leaderboard:updateImageS3Path("flatfull/img/dashboard_images/Leaderboard.png"),RevenueGraph:updateImageS3Path("flatfull/img/dashboard_images/Revenue-graph.png"),AccountDetails:updateImageS3Path("flatfull/img/dashboard_images/account-information.png"),MiniCalendar:updateImageS3Path("flatfull/img/dashboard_images/Mini-Calendar.jpg"),UserActivities:updateImageS3Path("flatfull/img/dashboard_images/User-Activities.png"),Campaignstats:updateImageS3Path("flatfull/img/dashboard_images/Campaign-stats-new.jpg"),Campaigngraph:updateImageS3Path("flatfull/img/dashboard_images/Campaign-status.jpg"),DealGoals:updateImageS3Path("flatfull/img/dashboard_images/Quota.png"),IncomingDeals:updateImageS3Path("flatfull/img/dashboard_images/incoming-deals-new.png"),LostDealAnalysis:updateImageS3Path("flatfull/img/dashboard_images/lost-deal-analysis-new.png"),AverageDeviation:updateImageS3Path("flatfull/img/dashboard_images/Average_deviation.png"),WebstatVisits:updateImageS3Path("flatfull/img/dashboard_images/Webstat-Visits.png"),Referralurlstats:updateImageS3Path("flatfull/img/dashboard_images/Refferalurl-Stats-new.png"),};var d={GrowthGraph:"left",DealsFunnel:"left",CallsPerPerson:"left",TaskReport:"left",RevenueGraph:"left",MiniCalendar:"left",UserActivities:"left",Campaignstats:"",LostDealAnalysis:"left",Referralurlstats:"left"};if(d[b]){c="left"}$(this).popover({rel:"popover",trigger:"hover",placement:c,html:"true",content:function(){return"<img src="+a[b]+">"}});$(this).popover("show")});$(".show_screeshot").off("click touchstart").on("click touchstart",".add-portlet-direct",function(){var a=[];var b="core/api/portlets/add";a.push("DashBoard");var c=false;clickfunction($(this),b,c,a)});$(".col-md-3").off("click touchstart").on("click touchstart",".add_to_all",function(){var a=[];a.push("DashBoard");var c=true;var b="core/api/portlets/addforAll";clickfunction($(this),b,c,a)});$("#portlets-add-listener").on("click",".configure-portlets",function(c){c.preventDefault();var d=$(this).attr("portlet_type");var a=$(this).attr("portlet_name");var b={};b.name=a;$("#portletStreamModalNew").html(getTemplate("portletStreamModalInfo",b));head.js(LIB_PATH+"lib/jquery.multi-select.js",function(){$("#ms-route-list").remove();$("#route-list",$("#portletStreamModalNew")).multiSelect();$("#ms-route-list .ms-selection").children("ul").addClass("multiSelect").attr("name","route-list").attr("id","route");$("#ms-route-list .ms-selectable .ms-list").css("height","200px");$("#ms-route-list .ms-selection .ms-list").css("height","200px")});$(".add-portlet").attr("portlet_type",d);$(".add-portlet").attr("portlet_name",a);$(".add_to_all").attr("portlet_type",d);$(".add_to_all").attr("portlet_name",a);$("#portletStreamModalNew").modal("show")});$("#portletStreamModalNew").on("shown.bs.modal",function(a){insideAddListener()})}function insideAddListener(){$(".modal-content").off("click","#route-select-all");$(".modal-content").on("click","#route-select-all",function(a){a.preventDefault();$("#route-list").multiSelect("select_all")});$(".modal-content").off("click","#route-select-none");$(".modal-content").on("click","#route-select-none",function(a){a.preventDefault();$("#route-list").multiSelect("deselect_all")});$(".modal-content").off("click",".add-portlet");$(".modal-content").on("click",".add-portlet",function(){var d=$(this).parents(".modal-footer").prev().find("form:visible").attr("id");if(!isValidForm("#"+d)){return false}var a=[];var b="core/api/portlets/add";$("#route-list",$(this).parents(".modal")).find("option").each(function(){if($(this).is(":selected")){a.push($(this).val())}});var c=false;clickfunction($(this),b,c,a)});$(".modal-footer").off("click touchstart").on("click touchstart",".add_to_all",function(){var d=$(this).parents(".modal-footer").prev().find("form:visible").attr("id");if(!isValidForm("#"+d)){return false}var a=[];$("#route-list",$(this).parents(".modal")).find("option").each(function(){if($(this).is(":selected")){a.push($(this).val())}});var c=true;var b="core/api/portlets/addforAll";clickfunction($(this),b,c,a)});$(".modal-content").on("change","#route-list",function(){var a=false;$(this).parent().find("ul#route > li").each(function(){if($(this).hasClass("ms-elem-selected")&&$(this).hasClass("user-dashboard")){a=true}});if(a){$(".add_to_all",$("#portletStreamModalNew")).attr("disabled",true)}else{$(".add_to_all",$("#portletStreamModalNew")).attr("disabled",false)}});$(".modal-content").on("click",'ul[name="route-list"] > li',function(){$(".add_to_all",$("#portletStreamModalNew")).attr("disabled",false)})}function clickfunction(g,b,h,j){$("#portletStreamModalNew").modal("hide");$(".modal-backdrop").hide();var f=g.attr("portlet_type");var c=g.attr("portlet_name");var k=portlet_utility.getDefaultPortletSettings(f,c);var e={};e.name=c;var d=new Date();e.portlet_type=f;var l=0;e.column_position=-1;e.row_position=-1;e.size_x=1;e.size_y=1;if(!isNaN(j)){e.column_position=-1;e.row_position=-1}if(f=="RSS"&&c=="Agile CRM Blog"){e.size_y=2
}else{if(f=="USERACTIVITY"&&c=="Leaderboard"){e.size_y=2;e.size_x=2}}var a=[];$.each(j,function(o){var p=new BaseModel();p.url=b;p.set({prefs:JSON.stringify(k),isForAll:h,portlet_route:this.toString(),},{silent:true});var n;var m;p.save(e,{success:function(q){n=new BaseModel(q.toJSON());if($("#zero-portlets").is(":visible")){$("#zero-portlets").hide()}if($("#no-portlets").is(":visible")){$("#no-portlets").hide()}},error:function(s,q){showAlertModal("add_error")}})})}function is_valid_custom_range(a,c,b){if(c-a>=0){return true}else{if(a>c){$("#"+b).find(".invalid-range").html('<div class="alert alert-danger m-t-sm" style="margin-bottom:5px;"><a class="close" data-dismiss="alert" href="#">&times</a>Start date should not be greater than end date. Please change.</div>');$("#"+b).find(".invalid-range").parents(".form-group").show();return false}}}var portlet_graph_data_utility={fetchPortletsGraphData:function(b,a){$("#plan-limit-error").hide();$.getJSON(b,function(c){if(a&&typeof(a)==="function"){a(c)}}).error(function(c){if(c.status!=406&&c.status!=403){return}if(a&&typeof(a)==="function"){a(c)}})},dealsByMilestoneGraphData:function(j,c,a){var b=[];var f=[];var d=[];var g=[];var h=parseInt($("#"+c).parent().attr("data-sizey"));var e=50*h;if(h==2||h==3){e+=50}$("#"+c).html("<div class='text-center v-middle opa-half' style='margin-top:"+e+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");this.fetchPortletsGraphData(a,function(k){if(k.status==403){$("#"+c).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}b=k.milestonesList;f=k.milestoneValuesList;d=k.milestoneNumbersList;g=k.milestoneMap;portlet_graph_utility.dealsByMilestonePieGraph(c,b,f,d);portlet_utility.addWidgetToGridster(j)})},campaignStatsGraphData:function(d,c,f){var b=[];var g=[];var a=parseInt($("#"+c).parent().attr("data-sizey"));var e=50*a;if(a==2||a==3){e+=50}$("#"+c).html("<div class='text-center v-middle opa-half' style='margin-top:"+e+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");this.fetchPortletsGraphData(f,function(h){if(h.status==403){$("#"+c).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}b=h.campaignStatusList;g=h.campaignValuesList;portlet_graph_utility.campaignStatsPieGraph(c,b,g);portlet_utility.addWidgetToGridster(d)})},closuresPerPersonGraphData:function(b,a,e){var d=[];var f=[];var c=[];$("#"+a).html(getRandomLoadingImg());this.fetchPortletsGraphData(e,function(h){if(h.status==403){$("#"+a).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}d=h.milestoneNumbersList;f=h.milestoneValuesList;c=h.domainUsersList;var k=[];$.each(c,function(n,m){k.push(m)});var l=[];var j="";var g="";if(b.get("settings")["group-by"]=="number-of-deals"){$.each(d,function(m,n){l.push(n)});j="No. of Deals Won";g="Deals Won"}else{$.each(f,function(m,n){l.push(n)});j="Deals Won Value";g="Won Deal Value"}portlet_graph_utility.closuresPerPersonBarGraph(a,k,l,j,g);portlet_utility.addWidgetToGridster(b)})},dealsFunnelGraphData:function(c,b,f){var g=[];var h=[];var d=[];var a=parseInt($("#"+b).parent().attr("data-sizey"));var e=50*a;if(a==2||a==3){e+=50}$("#"+b).html("<div class='text-center v-middle opa-half' style='margin-top:"+e+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");this.fetchPortletsGraphData(f,function(m){if(m.status==403){$("#"+b).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}g=m.milestonesList;h=m.milestoneValuesList;d=m.milestoneMap;wonMilestone=m.wonMilestone;lostMilestone=m.lostMilestone;milestoneNumbersList=m.milestoneNumbersList;var l=[];var k;$.each(g,function(p,q){var o=[];if(q!=lostMilestone){if(q!=wonMilestone){if(c.get("settings")["split-by"]&&c.get("settings")["split-by"]=="count"){o.push(q,milestoneNumbersList[p])}else{o.push(q,h[p])}}else{k=p}if(o!=""){l.push(o)}}});var n=[];if(k!=undefined){if(c.get("settings")["split-by"]&&c.get("settings")["split-by"]=="count"){n.push(g[k],milestoneNumbersList[k])}else{n.push(g[k],h[k])}l.push(n)}var j=false;$.each(l,function(o,p){if(p[1]>0){j=true}});if(j){l=l}else{l=[]}portlet_graph_utility.dealsFunnelGraph(b,l,c);portlet_utility.addWidgetToGridster(c)})},emailsSentGrapgData:function(b,a,e){var d=[];var c=[];var f=[];$("#"+a).html(getRandomLoadingImg());this.fetchPortletsGraphData(e,function(j){if(j.status==403){$("#"+a).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}d=j.domainUsersList;c=j.mailsCountList;f=j.mailsOpenedCountList;var h=[];var l="";var g;var k={};k.name="Emails Not Opened";k.data=c;h[0]=k;k={};k.name="Emails Opened";k.data=f;h[1]=k;l="No. of Emails";g=["gray","green"];portlet_graph_utility.emailsSentBarGraph(a,d,h,c,f,l,g);portlet_utility.addWidgetToGridster(b)})},growthGraphData:function(c,b,e){var a=parseInt($("#"+b).parent().attr("data-sizey"));var d=50*a;if(a==2||a==3){d+=50}$("#"+b).html("<div class='text-center v-middle opa-half' style='margin-top:"+d+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");this.fetchPortletsGraphData(e,function(l){if(l.status==406){$save_info=$('<div class="portlet-error-message inline-block"><small><p class="text-base" style="color:#B94A48;"><i>'+l.responseText+"</i></p></small></div>");$("#"+b).html($save_info).show();return}var m=[];var f=[];var g=0;var n=1;var o=c.get("settings").frequency;var j=[];$.each(l,function(s,q){j.push(s)});j.sort();var p={};$.each(j,function(q,s){p[""+s]=l[""+s]});var k;$.each(p,function(s,q){if(k==undefined){var t=0;k=[];$.each(q,function(w,v){var u={};u.name=w;u.data=[];k[t++]=u})}$.each(q,function(x,w){var v=find_series_with_name(k,x);var u=new Date(s*1000);v.data.push(w)});f.push(s*1000);g++});var h=0;if(Math.ceil(g/10)>0){n=Math.ceil(g/10);if(n==3){n=4}}head.js(LIB_PATH+"lib/flot/highcharts-3.js",function(){_agile_library_loader.localize_highcharts();$.each(p,function(t,s){var x=new Date(f[h]);if(o!=undefined){if(o=="daily"){m.push(Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))+"")}else{if(o=="weekly"){if(h!=g-1){var u=new Date(f[h+1]);m.push(Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()-1)))}else{var z=new Date();m.push(Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate())))}}else{if(o=="monthly"){if(h!=g-1){var u=new Date(f[h+1]);var w=new Date();var y="";var q="";if(h!=0){if(w.getUTCFullYear()!=x.getUTCFullYear()){y=Highcharts.dateFormat("%b.%Y",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))}else{y=Highcharts.dateFormat("%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))}m.push(y)}else{if(w.getUTCFullYear()!=x.getUTCFullYear()){y=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))}else{y=Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))}if(w.getUTCFullYear()!=u.getUTCFullYear()){q=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()-1))}else{q=Highcharts.dateFormat("%e.%b",Date.UTC(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()-1))}m.push(y+" - "+q)}}else{var w=new Date();var y="";var q="";var z=new Date();if(w.getUTCFullYear()!=x.getUTCFullYear()){y=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()));q=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate()))}else{y=Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()));q=Highcharts.dateFormat("%e.%b",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate()))}m.push(y+" - "+q)}}}}h++}})});portlet_graph_utility.portletGrowthGraph(b,k,c,m,n);portlet_utility.addWidgetToGridster(c)})},dealsAssignedGraphData:function(b,a,e){var d=[];var c=[];$("#"+a).html(getRandomLoadingImg());this.fetchPortletsGraphData(e,function(f){if(f.status==403){$("#"+a).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}d=f.domainUsersList;c=f.assignedOpportunitiesCountList;portlet_graph_utility.dealsAssignedBarGraph(a,d,c,b);portlet_utility.addWidgetToGridster(b)})},callsPerPersonGraphData:function(j,s,e){var l=[];var g=[];var b=[];var n=[];var o=[];var h=[];var d=[];var p=[];var u=[];var k=[];var f=[];var w=[];var t=[];var q=[];var c=[];var m=[];var v=parseInt($("#"+s).parent().attr("data-sizey"));var a=50*v;if(v==2||v==3){a+=50}$("#"+s).html("<div class='text-center v-middle opa-half' style='margin-top:"+a+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");this.fetchPortletsGraphData(e,function(A){if(A.status==403){$("#"+s).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}l=A.answeredCallsCountList;g=A.busyCallsCountList;b=A.failedCallsCountList;n=A.voiceMailCallsCountList;o=A.missedCallsCountList;h=A.inquiryCallsCountList;d=A.interestCallsCountList;
p=A.noInterestCallsCountList;u=A.incorrectReferralCallsCountList;f=A.meetingScheduledCallsCountList;k=A.newOpportunityCallsCountList;w=A.queuedCallsCountList;t=A.callsDurationList;q=A.totalCallsCountList;c=A.domainUsersList;m=A.domainUserImgList;var z=[];var C="";var y;if(j.get("settings")["group-by"]=="number-of-calls"){var B={};B.name="Answered";B.data=l;z[0]=B;B={};B.name="Busy";B.data=g;z[1]=B;B={};B.name="Failed";B.data=b;z[2]=B;B={};B.name="Voicemail";B.data=n;z[3]=B;B={};B.name="Missed ";B.data=o;z[4]=B;B={};B.name="Inquiry";B.data=h;z[5]=B;B={};B.name="Interest";B.data=d;z[6]=B;B={};B.name="No Interest";B.data=p;z[7]=B;B={};B.name="Incorrect Referral";B.data=u;z[8]=B;B={};B.name="Meeting Scheduled";B.data=f;z[9]=B;B={};B.name="New Opportunity";B.data=k;z[10]=B;B={};B.name="Other";B.data=w;z[11]=B;C="No. of Calls";y=["green","blue","red","violet"]}else{var B={};B.name="Total Duration";var x=[];$.each(t,function(D,E){x[D]=E/60});B.data=x;z[0]=B;C="Calls Duration (Sec)";y=["green"]}portlet_graph_utility.callsPerPersonBarGraph(s,c,z,q,t,C,y,m,j);portlet_utility.addWidgetToGridster(j)})},taskReportGraphData:function(j,c,a){var e=[];var d=[];var g=[];var b=[];var h=parseInt($("#"+c).parent().attr("data-sizey"));var f=50*h;if(h==2||h==3){f+=50}$("#"+c).html("<div class='text-center v-middle opa-half' style='margin-top:"+f+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");this.fetchPortletsGraphData(a,function(o){if(o.status==403){$("#"+c).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}e=o.groupByList;d=o.splitByList;b=o.domainUserNamesList;var m=[];var q="";var k;$.each(d,function(u,t){if(g.length==0){$.each(t,function(v,w){g.push(portlet_utility.getPortletNormalName(v))})}});for(var l=0;l<g.length;l++){var p={};var s=[];$.each(d,function(u,t){$.each(t,function(v,w){if(portlet_utility.getPortletNormalName(v)==g[l]){s.push(w)}})});p.name=g[l];p.data=s;m[l]=p}q="Task Report";var n=[];$.each(e,function(u,t){n[u]=portlet_utility.getPortletNormalName(t+"#"+u)});portlet_graph_utility.taskReportBarGraph(c,n,m,q,j,b,undefined,"");portlet_utility.addWidgetToGridster(j)})},revenueGraphData:function(b,a,c){this.fetchPortletsGraphData(c,function(h){if(h.status==406){$save_info=$('<div class="portlet-error-message inline-block"><small><p class="text-base" style="color:#B94A48;"><i>'+h.responseText+"</i></p></small></div>");$("#"+a).html($save_info).show();return}var e=[];var d=[];$.each(h,function(l,j){e.push(l)});e.sort();var g={};$.each(e,function(j,k){g[""+k]=h[""+k]});var f;$.each(g,function(l,j){if(f==undefined){var m=0;f=[];$.each(j,function(p,o){var k={};k.name=p;k.data=[];f[m++]=k})}$.each(j,function(p,o){var k=find_series_with_name(f,p);k.data.push(o)});var n=new Date(l*1000);d.push(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()))});portlet_graph_utility.portletDealRevenueGraph(a,f,b,d);portlet_utility.addWidgetToGridster(b)})},emailsOpenedGraphData:function(c,b,e){var f=0;var g=0;var a=parseInt($("#"+b).parent().attr("data-sizey"));var d=50*a;$("#"+b).html("<div class='text-center v-middle opa-half' style='margin-top:"+d+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");this.fetchPortletsGraphData(e,function(j){if(j.status==403){$("#"+b).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}f=j.emailsSentCount;g=j.emailsOpenedCount;var h=[];h.push(["Emails Sent",f-g]);h.push(["Emails Opened",g]);portlet_graph_utility.emailsOpenedPieChart(b,h,f,g);portlet_utility.addWidgetToGridster(c)})},dealGoalsGraphData:function(d,e,j,c){var b=["#ffffff","#27C24C"];var a=["#ffffff","#fad733"];var h=$("#"+d).find(".dealGraph");h.attr("id","dealGraph-"+j+"-"+c);var g=$("#"+d).find(".dealGraph").attr("id");var k=$("#"+d).find(".revenueGraph");k.attr("id","revenueGraph-"+j+"-"+c);var f=$("#"+d).find(".revenueGraph").attr("id");if(e.goalCount==0){$("#"+g).html('<div class="portlet-error-message" style="padding:30px 15px">No Deals Goals set  </div>')}else{if(e.dealcount>=e.goalCount){$("#"+d).find(".goal_count_success").show()}portlet_graph_utility.dealGoalsPieGraph(g,e.dealcount,e.goalCount,b)}if(e.goalAmount==0){$("#"+f).html('<div class="portlet-error-message" style="padding:30px 15px">No Revenue Goals set</div>')}else{if(e.dealAmount>=e.goalAmount){$("#"+d).find(".goal_amount_success").show()}portlet_graph_utility.dealGoalsPieGraph(f,e.dealAmount,e.goalAmount,a)}},incomingDealsGraphData:function(c,b,e){var f=this;var a=parseInt($("#"+b).parent().attr("data-sizey"));var d=50*a;if(a==2||a==3){d+=50}$("#"+b).html("<div class='text-center v-middle opa-half' style='margin-top:"+d+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");setupCharts(function(){f.fetchPortletsGraphData(e,function(k){var m=[];var g=[];var q=c.get("settings").type;if(!q){q=0}var p=c.get("settings").frequency;if(!p){p="daily"}var l;var s=[];var j=[];$.each(k,function(u,t){j.push(u)});j.sort();var o={};$.each(j,function(t,u){o[""+u]=k[""+u]});var n=1;var h=0;$.each(o,function(u,t){var x=[];x.push(u);var y=0;if(l==undefined){var w=0;l=[];$.each(t,function(A,z){var v={};v.name=A;v.data=[];l[w++]=v})}$.each(t,function(A,z){y=y+z;var v=find_series_with_name(l,A);v.data.push(z)});x.push(y);g.push(u*1000);h++;s.push(x)});f.dateRangeonXaxis(o,g,m,p,h);if(Math.ceil((h-1)/10)>0){n=Math.ceil(h/10);if(n==3){n=4}}if(l==undefined){chartRenderforIncoming(b,m,name,"",n,q,l,s,0,30,c)}else{$.ajax({type:"GET",url:"/core/api/categories?entity_type=DEAL_SOURCE",dataType:"json",success:function(t){$.each(t,function(u,w){for(var v=0;v<l.length;v++){if(l[v].name=="0"){l[v].name="Unknown"}else{if(w.id==l[v].name){l[v].name=w.label}}}});chartRenderforIncoming(b,m,"","",n,q,l,s,0,30,c)}})}})})},dateRangeonXaxis:function(c,f,a,e,d){var b=0;$.each(c,function(j,h){var n=new Date(f[b]);if(e!=undefined){if(e=="daily"){a.push(Highcharts.dateFormat("%e.%b",Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()))+"")}else{if(e=="weekly"){if(b!=d-1){var l=new Date(f[b+1]);a.push(Highcharts.dateFormat("%e.%b",Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(l.getFullYear(),l.getMonth(),l.getDate()-1)))}else{var p=new Date();a.push(Highcharts.dateFormat("%e.%b",Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(p.getFullYear(),p.getMonth(),p.getDate())))}}else{if(e=="monthly"){if(b!=d-1){var l=new Date(f[b+1]);var m=new Date();var o="";var g="";if(b!=0){if(m.getFullYear()!=n.getFullYear()){o=Highcharts.dateFormat("%b.%Y",Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()))}else{o=Highcharts.dateFormat("%b",Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()))}a.push(o)}else{if(m.getUTCFullYear()!=n.getUTCFullYear()){o=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()))}else{o=Highcharts.dateFormat("%e.%b",Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()))}if(m.getUTCFullYear()!=l.getUTCFullYear()){g=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(l.getFullYear(),l.getMonth(),l.getDate()-1))}else{g=Highcharts.dateFormat("%e.%b",Date.UTC(l.getFullYear(),l.getMonth(),l.getDate()-1))}a.push(o+" - "+g)}}else{var m=new Date();var o="";var g="";var p=new Date();if(m.getUTCFullYear()!=n.getUTCFullYear()){o=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()));g=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(p.getFullYear(),p.getMonth(),p.getDate()))}else{o=Highcharts.dateFormat("%e.%b",Date.UTC(n.getFullYear(),n.getMonth(),n.getDate()));g=Highcharts.dateFormat("%e.%b",Date.UTC(p.getFullYear(),p.getMonth(),p.getDate()))}a.push(o+" - "+g)}}}}b++}})},taskDeviationGraphData:function(j,c,a){var e=[];var d=[];var g=[];var b=[];var h=parseInt($("#"+c).parent().attr("data-sizey"));var f=50*h;if(h==2||h==3){f+=50}$("#"+c).html("<div class='text-center v-middle opa-half' style='margin-top:"+f+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");this.fetchPortletsGraphData(a,function(n){if(n.status==403){$("#"+c).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}e=n.groupByList;d=n.splitByList;b=n.domainUserNamesList;var o=[];var u=[];var t="";var l;$.each(d,function(w,v){if(g.length==0){$.each(v,function(x,y){g.push(portlet_utility.getPortletNormalName(x))})}});for(var p=0;p<g.length;p++){var q={};var m=[];var k=[];$.each(d,function(w,v){$.each(v,function(x,y){if(portlet_utility.getPortletNormalName(x)==g[p]){k.push(y[0]);m.push(y[1])}})});q.name=g[p];q.data=m;o[p]=q;u[p]=k}t="Average Deviation";var s=[];$.each(e,function(w,v){s[w]=portlet_utility.getPortletNormalName(v+"#"+w)});portlet_graph_utility.taskReportBarGraph(c,s,o,t,j,b,u,"In Seconds");portlet_utility.addWidgetToGridster(j)})},webstatVisitsGraphData:function(d,c,f){var b=0;var g=0;var a=parseInt($("#"+c).parent().attr("data-sizey"));var e=50*a;if(a==2||a==3){e+=50}$("#"+c).html("<div class='text-center v-middle opa-half' style='margin-top:"+e+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");this.fetchPortletsGraphData(f,function(h){if(h.status==403){$("#"+c).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}b=h[0];g=h[1];portlet_graph_utility.webstatVisitsPieGraph(c,b,g);portlet_utility.addWidgetToGridster(d)})},};var Portlets_View,gridster;$(function(){$.getJSON("/core/api/users/current-agile-user",function(a){CURRENT_AGILE_USER=a
})});function loadPortlets(a,b){App_Portlets.todayEventsCollection=new Array();App_Portlets.tasksCollection=new Array();App_Portlets.pendingDeals=new Array();App_Portlets.dealsWon=new Array();App_Portlets.filteredCompanies=new Array();App_Portlets.filteredContacts=new Array();App_Portlets.emailsOpened=new Array();App_Portlets.statsReport=new Array();App_Portlets.leaderboard=new Array();App_Portlets.accountInfo=new Array();App_Portlets.activity=new Array();App_Portlets.activitiesView=new Array();App_Portlets.campaignstats=new Array();App_Portlets.dealGoals=new Array();App_Portlets.adminPortlets=new Array();App_Portlets.RoutePortlets=new Array();App_Portlets.taskAverage=new Array();App_Portlets.DashboardPortlets=new Array();if(Portlets_View!=undefined){console.log("before initialized"+a+Portlets_View.collection.length)}$("#portlets",b).html(getRandomLoadingImg());Portlets_View=new Base_Collection_View({url:"/core/api/portlets?route="+a,sortKey:"row_position",sort_collection:false,restKey:"portlet",templateKey:"portlets",individual_tag_name:"div",postRenderCallback:function(d){if(a!="DashBoard"&&Portlets_View.collection.length!=0&&!$(".route_Portlet").is(":visible")&&isNaN(a)){$("#portlets").parents(".route_Portlet").show()}set_up_portlets(b,d);var f=[];$.each(App_Portlets.RoutePortlets,function(j,h){var l={};var g=gridster.next_position(1,1);l.column_position=g.col;l.row_position=g.row;h.set({column_position:l.column_position},{silent:true});h.set({row_position:l.row_position},{silent:true});h.set({isForAll:false});portlet_utility.getOuterViewOfPortlet(h,d,function(){portlet_utility.getInnerViewOfPortlet(h,d)});portlet_utility.addWidgetToGridster(h);var k=$("#"+h.id).parent();if(!(k.attr("data-col")==h.get("column_position"))||!(k.attr("data-row")==h.get("row_position"))){h.set({column_position:parseInt(k.attr("data-col"))},{silent:true});h.set({row_position:parseInt(k.attr("data-row"))},{silent:true});k.attr("id","ui-id-"+k.attr("data-col")+"-"+k.attr("data-row"));k.find("div.portlet_body").attr("id","p-body-"+k.attr("data-col")+"-"+k.attr("data-row"))}f.push({id:h.get("id"),column_position:l.column_position,row_position:l.row_position,isForAll:false})});$.ajax({type:"POST",url:"/core/api/portlets/positions",data:JSON.stringify(f),contentType:"application/json; charset=utf-8",dataType:"json"});if(a!="DashBoard"&&App_Portlets.DashboardPortlets.length!=0){var f=[];$.each(App_Portlets.DashboardPortlets,function(j,h){var l={};var g=gridster.next_position(1,1);l.column_position=g.col;l.row_position=g.row;h.set({column_position:l.column_position},{silent:true});h.set({row_position:l.row_position},{silent:true});h.set({isForAll:false});portlet_utility.getOuterViewOfPortlet(h,d,function(){portlet_utility.getInnerViewOfPortlet(h,d)});portlet_utility.addWidgetToGridster(h);var k=$("#"+h.id).parent();if(!(k.attr("data-col")==h.get("column_position"))||!(k.attr("data-row")==h.get("row_position"))){h.set({column_position:parseInt(k.attr("data-col"))},{silent:true});h.set({row_position:parseInt(k.attr("data-row"))},{silent:true});k.attr("id","ui-id-"+k.attr("data-col")+"-"+k.attr("data-row"));k.find("div.portlet_body").attr("id","p-body-"+k.attr("data-col")+"-"+k.attr("data-row"))}f.push({id:h.get("id"),column_position:l.column_position,row_position:l.row_position,isForAll:false})});$.ajax({type:"POST",url:"/core/api/portlets/positions",data:JSON.stringify(f),contentType:"application/json; charset=utf-8",dataType:"json"})}if(App_Portlets.adminPortlets.length!=0){var f=[];$.each(App_Portlets.adminPortlets,function(j,h){var l={};var g=gridster.next_position(1,1);l.column_position=g.col;l.row_position=g.row;h.set({column_position:l.column_position},{silent:true});h.set({row_position:l.row_position},{silent:true});h.set({isForAll:false});set_p_portlets(h);portlet_utility.addWidgetToGridster(h);var k=$("#"+h.id).parent();if(!(k.attr("data-col")==h.get("column_position"))||!(k.attr("data-row")==h.get("row_position"))){h.set({column_position:parseInt(k.attr("data-col"))},{silent:true});h.set({row_position:parseInt(k.attr("data-row"))},{silent:true});k.attr("id","ui-id-"+k.attr("data-col")+"-"+k.attr("data-row"));k.find("div.portlet_body").attr("id","p-body-"+k.attr("data-col")+"-"+k.attr("data-row"))}f.push({id:h.get("id"),column_position:l.column_position,row_position:l.row_position,isForAll:false})});$.ajax({type:"POST",url:"/core/api/portlets/positions",data:JSON.stringify(f),contentType:"application/json; charset=utf-8",dataType:"json"})}App_Portlets.adminPortlets=new Array();var e=[];$("#portlet-res > div > .gs-w").each(function(){$(this).attr("id","ui-id-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));$(this).find("div.portlet_body").attr("id","p-body-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));var h=$(this).find(".portlets").attr("id");var g=Portlets_View.collection.get(h);if(!($(this).attr("data-col")==g.get("column_position"))||!($(this).attr("data-row")==g.get("row_position"))){g.set({column_position:parseInt($(this).attr("data-col"))},{silent:true});g.set({row_position:parseInt($(this).attr("data-row"))},{silent:true})}e.push({id:g.get("id"),column_position:parseInt($(this).attr("data-col")),row_position:parseInt($(this).attr("data-row"))})});$.ajax({type:"POST",url:"/core/api/portlets/positions",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json"});if(Portlets_View.collection.length==0){$(".gridster > div:visible > div",b).removeClass("gs-w")}initializePortletsListeners();contactListener()}});this.Portlets_View.appendItem=set_p_portlets;Portlets_View.collection.fetch();var c=Portlets_View.render().el;$("#portlets",b).html(c)}function set_up_portlets(b,e){$(".gridster > div:visible",e);var d;var a=Math.round($(".gridster-portlets").width()/3)-20;var c=200;d=[a,c];gridster=$(".gridster > div:visible",e).gridster({widget_selector:"div",widget_margins:[10,12],widget_base_dimensions:d,min_cols:3,autogenerate_stylesheet:true,draggable:{limit:true,ignore_dragging:[".portlet_body",".portlet_body *",".portlet-panel",".portlet-panel *",".fc-content *",".events_show *"],stop:function(f,g){var h=[];$("#portlet-res > div > .gs-w").each(function(){$(this).attr("id","ui-id-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));$(this).find("div.portlet_body").attr("id","p-body-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));var k=$(this).find(".portlets").attr("id");var j=Portlets_View.collection.get(k);j.set({column_position:parseInt($(this).attr("data-col"))},{silent:true});j.set({row_position:parseInt($(this).attr("data-row"))},{silent:true});h.push({id:j.get("id"),column_position:parseInt($(this).attr("data-col")),row_position:parseInt($(this).attr("data-row"))})});$.ajax({type:"POST",url:"/core/api/portlets/positions",data:JSON.stringify(h),contentType:"application/json; charset=utf-8",dataType:"json"})}},resize:{enabled:true,max_size:[3,3],resize:function(k,l){var g=Portlets_View.collection.get($("#"+this.$resized_widget.attr("id")+" > div.portlets").attr("id"));if(g.get("name")=="Mini Calendar"){var j=this.$resized_widget.find("#calendar_container");var f=$("#"+this.$resized_widget.attr("id")).height();if(f<=200){$(j).find(".fc-header").css("height","25px");$(j).parent().find(".show").css("padding-top","5px")}else{if(f>200&&f<=450){$(j).find(".fc-header").css("height","145px");$(j).find(".show").css("padding-top","70px")}else{$(j).find(".fc-header").css("height","250px");$(j).find(".show").css("padding-top","120px")}}var h={height:f+"px","max-height":f+"px"};$("#"+this.$resized_widget.attr("id")+" > .portlet_body_calendar").css(h);$(j).fullCalendar("option","aspectRatio",getaspectratio($(j).parent()));var m=parseInt($(j).find(".fc-widget-content").css("height"))/2-7;$(j).find(".fc-day-number").css("top",m)}},stop:function(g,u){$(window).trigger("resize");$("#"+this.$resized_widget.attr("id")+" > div.portlet_body").css("overflow-x","hidden").css("overflow-y","auto");var p=Portlets_View.collection.get($("#"+this.$resized_widget.attr("id")+" > div.portlets").attr("id"));var o=this;if(p.get("name")=="Leaderboard"){$("#"+this.$resized_widget.attr("id")+" > .portlet_header").find("ul").width(($("#"+this.$resized_widget.attr("id")+" > .portlet_body").find("ul").width()/$("#"+this.$resized_widget.attr("id")+" > .portlet_body").width()*100)+"%")}else{if(p.get("name")=="Mini Calendar"){var k=this.$resized_widget.find(".portlet_body_calendar");var j,v=this.$resized_widget.attr("data-sizey");if(v==1){v=v*200;$(k).find(".fc-header").css("height","25px");$(k).find(".show").css("padding-top","5px")}else{if(v==2){v=v*200+25;$(k).find(".fc-header").css("height","145px");$(k).find(".show").css("padding-top","70px")}else{if(v==3){v=v*200+50;$(k).find(".fc-header").css("height","250px");$(k).find(".show").css("padding-top","120px")}}}var n={height:v+"px","max-height":v+"px"};$("#"+this.$resized_widget.attr("id")+" > .portlet_body_calendar").css(n);$("#calendar_container",$(k)).fullCalendar("option","aspectRatio",getaspectratio(k));var t=parseInt($(k).find(".fc-widget-content").css("height"))/2-7;$(k).find(".fc-day-number").css("top",t)}else{if(p.get("name")=="Calls Per Person"){var s=""+this.$resized_widget.attr("data-col")+""+this.$resized_widget.attr("data-row");var v=this.$resized_widget.find(".portlet_body").height();var h=this.$resized_widget.find(".portlet_body").width();callschart[parseInt(s)].setSize(h,v);var q=callschart[parseInt(s)].xAxis[0].max,l=callschart[parseInt(s)].xAxis[0].min,m=callschart[parseInt(s)].xAxis[0].height;if(m-(q-l)*28<=0){callschart[parseInt(s)].setSize(h,v+(q-l)*20)}}else{if(p.get("name")=="Task Report"){var s=""+this.$resized_widget.attr("data-col")+""+this.$resized_widget.attr("data-row");var v=this.$resized_widget.find(".portlet_body").height();var h=this.$resized_widget.find(".portlet_body").width();taskReport[parseInt(s)].setSize(h,taskReport[parseInt(s)].xAxis[0].categories.length*30+(v-30),false)}}}}var f=[];$("#portlet-res > div > .gs-w").each(function(){$(this).attr("id","ui-id-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));
$(this).find("div.portlet_body").attr("id","p-body-"+$(this).attr("data-col")+"-"+$(this).attr("data-row"));var x=$(this).find(".portlets").attr("id");var w=Portlets_View.collection.get(x);w.set({size_x:parseInt($(this).attr("data-sizex"))},{silent:true});w.set({size_y:parseInt($(this).attr("data-sizey"))},{silent:true});w.set({column_position:parseInt($(this).attr("data-col"))},{silent:true});w.set({row_position:parseInt($(this).attr("data-row"))},{silent:true});f.push({id:w.get("id"),size_x:parseInt($(this).attr("data-sizex")),size_y:parseInt($(this).attr("data-sizey")),column_position:parseInt($(this).attr("data-col")),row_position:parseInt($(this).attr("data-row"))})});$.ajax({type:"POST",url:"/core/api/portlets/save-width-height",data:JSON.stringify(f),contentType:"application/json; charset=utf-8",dataType:"json"})}}}).data("gridster");$(window).resize(function(){if(gridster!=undefined){$(".gridster-portlets").css("height","auto")}if($(window).width()<768&&gridster!=undefined){gridster.disable();gridster.disable_resize();if($(".portlet_body_calendar").is(":visible")){$(".portlet_body_calendar").each(function(){var f=$(this);if($("#calendar_container",f).find(".fc-widget-header").length!=0){$("#calendar_container",f).fullCalendar("option","aspectRatio",getaspectratio(f))}})}}else{if(gridster!=undefined){gridster.enable();gridster.enable_resize();gridster.set_dom_grid_height()}}if($(window).width()<975&&$(window).width()>768&&$(".portlet_body_calendar").is(":visible")){$(".portlet_body_calendar").each(function(){var f=$(this);if($("#calendar_container",f).find(".fc-widget-header").length!=0){$("#calendar_container",f).fullCalendar("option","aspectRatio",getaspectratio(f))}$(this).find("#calendar_container").find(".fc-widget-header").each(function(){$(this).text($(this).text().substring(0,1))})})}else{if($(window).width()>975&&$(".portlet_body_calendar").is(":visible")){$(".portlet_body_calendar").each(function(){var f=$(this);if($("#calendar_container",f).find(".fc-widget-header").length!=0){$("#calendar_container",f).fullCalendar("option","aspectRatio",getaspectratio(f))}if($(b).find("#calendar_container").width()<185){$(b).find("#calendar_container").find(".fc-widget-header").each(function(){$(this).text($(this).text().substring(0,1))})}else{var g=$.fn.datepicker.dates.en.daysShort;$(this).find("#calendar_container").find(".fc-widget-header").each(function(h){$(this).text(g[h])})}})}}});if($(window).width()<768&&gridster!=undefined){gridster.disable();gridster.disable_resize();$(".gridster-portlets").css("height","auto")}else{if(gridster!=undefined){gridster.enable();gridster.enable_resize()}}}function hidePortletSettingsAfterSave(b){var a=$("#"+b+"> .modal-dialog > .modal-content > .modal-footer > a");a.text("Save");a.attr("disabled",false);$("#"+b).modal("hide");$(".modal-backdrop").hide()}function initBlogPortletSync(a){head.js(LIB_PATH+"lib/jquery.feeds.min.js",function(){$("#portlet_blog_sync_container",a).feeds({feeds:{blog:"https://www.agilecrm.com/blog/feed/"},max:3,entryTemplate:function(b){return'<a href="'+b.link+'" title = "'+b.title+'" target="_blank" >'+b.title+'</a><div style="color:#999;font-size:11px;line-height: 13px;margin-bottom:5px">'+new Date(b.publishedDate).format("mmm d, yyyy")+'</div><p style="padding-top:5px;margin-bottom:15px">'+b.contentSnippet.replace("<a",'<a target="_blank"')+"</p>"},onComplete:function(b){$("#portlet_blog_sync_container",a).append('<span class="pull-right"><a href="https://www.agilecrm.com/blog" target="_blank">Agile CRM Blog</a></span>')}})})}$("body").on("click",".onboarding-skip",function(b){var a=$(this).parent();a.find("span").css("text-decoration","line-through");if(!a.find("small").hasClass("onboarding-undo")){a.find("span").after("<small class='p-l-sm onboarding-undo c-p'>(undo)</small>")}$(this).remove()});$("body").on("click",".onboarding-undo",function(b){var a=$(this).parent();a.find("span").css("text-decoration","none");a.find("label").remove();a.find("span").before("<label class='i-checks i-checks-sm onboarding-check' style='padding-right:4px;'><input type='checkbox'><i></i></label>");if(!a.find("small").hasClass("onboarding-skip")){a.find("span").after("<small class='p-l-sm onboarding-skip c-p'>(skip)</small>")}$(this).remove()});function gravatarImgForPortlets(b){var a=DEFAULT_GRAVATAR_url;var e='&d=404" ';var d="";if(d.length==0){e="&d="+DEFAULT_GRAVATAR_url+'" '}var c="";return new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+b+""+e+c)}function loadGoogleEventsForPortlets(b,c,a){$.getJSON("core/api/calendar-prefs/type/GOOGLE",function(d){console.log(d);if(d){if(typeof gapi!="undefined"&&isDefined(gapi)&&isDefined(gapi.client)&&isDefined(gapi.client.calendar)){googledataforEvents(b,d,c,a);return}_load_gapi(function(){googledataforEvents(b,d,c,a)})}else{setTimeout(function(){if($(b).parent().parent().find("#normal-events").find("table").find("tr").length==0&&$(b).parent().parent().find("#google-events").find("table").find("tr").length==0){$(b).parent().parent().find("#normal-events").html('<div class="portlet-error-message">No calendar events</div>')}},1000)}})}function googledataforEvents(k,f,b,j){var m=new Array();gapi.auth.setToken({access_token:f.access_token,state:"https://www.googleapis.com/auth/calendar"});var e=new Date();var l=e.getTimezoneOffset();var c=new Date(b*1000);var a=c.toISOString();var h=new Date(j*1000);var d=h.toISOString();var g=gapi.client.calendar.events.list({calendarId:"primary",maxResults:25,singleEvents:true,orderBy:"startTime",timeMin:a,timeMax:d});g.execute(function(p){console.log(p);if(p.items){for(var o=0;o<p.items.length;o++){var n=google2fcEvent(p.items[o]);n.startEpoch=new Date(n.start).getTime()/1000;n.endEpoch=new Date(n.end).getTime()/1000;if(isNaN(n.endEpoch)){n.endEpoch=new Date(n.google.end.date).getTime()/1000}console.log(n);m.push(n)}}App_Portlets.googleEventCollectionView=new Base_Collection_View({data:m,templateKey:"portlets-google-events",individual_tag_name:"tr",sort_collection:true,sortKey:"start",descending:false,postRenderCallback:function(q){if($(k).parent().parent().find("#normal-events").find("table").find("tr").length>0){$(k).parent().parent().find("#google-events").addClass("m-t-n-md").css("border-top","1px solid #eee")}setTimeout(function(){if($(k).parent().parent().find("#normal-events").find("table").find("tr").length==0&&$(k).parent().parent().find("#google-events").find("table").find("tr").length==0){$(k).parent().parent().find("#normal-events").html('<div class="portlet-error-message">No calendar events</div>')}},1000)}});if($(k).parent().parent().find("#google-events").find("table").find("tr").length==0){$(k).parent().parent().find("#google-events").html(App_Portlets.googleEventCollectionView.render(true).el)}hideTransitionBar()})}var LOADING_HTML='<img class="loading" style="padding-left:10px;padding-right:5px;opacity:0.5;" src= "'+updateImageS3Path("/flatfull/img/ajax-loader-cursor.gif")+'"></img>';LOADING_HTML_IMAGES=[LOADING_HTML];var LOADING_ON_CURSOR='<img class="loading" style="padding-left:10px;padding-right:5px" src= "'+updateImageS3Path("img/ajax-loader-cursor.gif")+'"></img>';var DEFAULT_GRAVATAR_url=agileWindowOrigin()+"/"+FLAT_FULL_PATH+"images/user-default.jpg";var DEFAULT_GRAVARTAR_IMG="https://doxhze3l6s7v9.cloudfront.net/img/default-404.png";var ONBOARDING_SCHEDULE_URL="http://supportcal.agilecrm.com";var SALES_SCHEDULE_URL="http://salescal.agilecrm.com";var SUPPORT_SCHEDULE_URL="http://supportcal.agilecrm.com";var CALENDAR_WEEK_START_DAY=CURRENT_USER_PREFS.calendar_wk_start_day;var AVOID_PAGEBLOCK_URL=["subscribe","purchase-plan","updateCreditCard"];var PAGEBLOCK_REASON=["BILLING_FAILED_2","BILLING_FAILED_3","SUBSCRIPTION_DELETED","SUB&#x73;criptION_DELETED"];var PAYMENT_FAILED_REASON=["BILLING_FAILED_0","BILLING_FAILED_1"];function getRandomLoadingImg(){var a=LOADING_HTML_IMAGES.length;return LOADING_HTML_IMAGES[Math.round(Math.random()*(LOADING_HTML_IMAGES.length-1))]}function getUrlVars(){var d=[],c;var a=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");for(var b=0;b<a.length;b++){c=a[b].split("=");d.push(c[0]);d[c[0]]=c[1]}return d}var _agile_owners_collection=null;function fillSelect(c,b,a,k,j,f,d,h){var e=Backbone.Collection.extend({url:b,});$loading='<img class="loading" style="padding-right:5px;opacity:0.5;" src= "'+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+'"></img>';if($("#"+c,d).next().hasClass("select-loading")){$("#"+c,d).next().html($loading)}else{$("#"+c,d).after($loading)}var g=new e();if(b=="/core/api/users/partial"&&_agile_owners_collection!=null){_fillSelectCallback(_agile_owners_collection,c,k,j,f,d,h)}else{g.fetch({success:function(){_fillSelectCallback(g,c,k,j,f,d,h);if(b=="/core/api/users/partial"){_agile_owners_collection=g}}})}}function _fillSelectCallback(f,a,k,j,d,c,h){if($("#"+a,c).next().hasClass("select-loading")){$("#"+a,c).next().html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")}else{$("#"+a,c).next().remove()}if(d){$("#"+a,c).empty()}else{if(!h){h="Select..."}$("#"+a,c).empty().append('<option class="default-select" value="">'+h+"</option>")}var e=f.toJSON();e.sort(function(m,l){if(m.name<l.name){return -1}if(l.name<m.name){return 1}return 0});var b=Handlebars.compile(j);var g="";$.each(e,function(m,l){if(l&&l.field_type&&l.field_type=="FORMULA"){}else{g+=b(l);$("#"+a,c).append(b(l))}});if(k&&typeof(k)==="function"){k(f,g)}}function fillTokenizedSelect(a,d,c,b){if(!b){b="Select..."}$("#"+a).empty().append('<option value="">'+b+"</option>");$.each(d,function(e,f){$("#"+a).append('<option value="'+f+'">'+f+"</option>")});if(c&&typeof(c)==="function"){c()}}function fillMilestones(b,a){$("#"+b).empty();$.each(a,function(c,d){$("#"+b).append('<a href="#"><li value="'+d+'">'+d+"</li></a>")})}function btnDropDown(b,a){}function delete_contact_property(a,b){for(var c=0;c<a.properties.length;c++){if(a.properties[c].name==b){a.properties.splice(c,1);
--c}}return a}function delete_contact_tag(a,b){$.each(a.tagsWithTime,function(d,c){if(c.tag==b){a.tags.splice(d,1);a.tagsWithTime.splice(d,1);return false}a.tags.push(c.tag)});return a}function add_contact_tags(a,b){for(var c=0;c<b.length;c++){a.tags.push(b[c])}return a}function property_JSON(a,g,d){var b={};if(d==undefined){b.type="SYSTEM"}else{b.type=d}b.name=a;var f=$("#"+g),c=f.attr("type"),e;if(c=="checkbox"){e=f.is(":checked")?"on":"off"}else{e=f.val()}b.value=e;return b}function saveEntity(d,c,e,a){var b=new Backbone.Model();b.url=c;b.save(d,{success:function(f){if(e&&typeof(e)==="function"){e(f)}},error:function(g,f){console.log(f);if(a){a(g,f)}}})}function getGMTEpochFromDate(b){var a=new Date();console.log(new Date().getHours());console.log(new Date().getMinutes());console.log(new Date().getSeconds());console.log(b.getYear()+","+b.getMonth()+","+b.getDate());b=new Date(b.getFullYear(),b.getMonth(),b.getDate(),0,0,0);return b.getTime()+(b.getTimezoneOffset()*60*1000)}function getGMTEpochFromDateForCustomFilters(b){var a=new Date();b=new Date(b.getFullYear(),b.getMonth(),b.getDate(),0,0,0);var c=(b.getTimezoneOffset()*60*1000);return b.getTime()-(b.getTimezoneOffset()*60*1000)}function getGMTEpochFromDateForDynamicFilters(b){var a=new Date();b=new Date(b.getFullYear(),b.getMonth(),b.getDate(),0,0,0);var c=(b.getTimezoneOffset()*60*1000);return b.getTime()}function getLocalTimeFromGMTMilliseconds(b){var a=new Date(parseInt(b));return a.getTime()-(a.getTimezoneOffset()*60*1000)}function getLocalTimeFromGMTMillisecondsforDynamicFilters(b){var a=new Date(parseInt(b));return a.getTime()}function showTextGravatar(a,b){var c=$(a,$(b));$(c).closest("img").error(function(){var d=$(this).attr("_data-name");if(!d){return}$(this).attr("data-name",d);$(b).initial({charCount:2,fontWeight:"normal"})})}function text_gravatar_initials(b,h){if(b==undefined){return}var d="";var f;var a;var d="";if(getPropertyValue(b,"first_name")){f=getPropertyValue(b,"first_name")}if(getPropertyValue(b,"last_name")){a=getPropertyValue(b,"last_name")}if(f&&a){d=f.substr(0,1);d+=a.substr(0,1)}else{if(f){var e=f.length;if(e>1){d=f.substr(0,2)}else{d=f.substr(0,1)}}else{if(a){var g=a.length;if(g>1){d=a.substr(0,2)}else{d=a.substr(0,1)}}}}if(d.length==0){var c=getPropertyValue(b,"email");if(c){if(c.length>1){d=c.substr(0,2)}}}if(d.length==0){d="X"}if(!isNaN(h)&&h<d.length){d=d.substr(0,h)}return d}function buildFacebookProfileURL(a){a=a.replace("@","");var b=(a.indexOf("http://")===0||a.indexOf("https://")===0);var c=(a.indexOf("facebook.com")!==-1);if(a&&!b&&!c){a="https://www.facebook.com/"+a}else{if(a&&c&&a.indexOf("www.facebook.com")===-1){a=a.replace("facebook.com","www.facebook.com")}else{if(a&&!b){a="http://"+a}}}return a}function visibleFilter(){return $(this).css("display")!="none"}function showTransitionBar(){if(agile_is_mobile_browser()){return}if($(".butterbar").hasClass("hide")){$(".butterbar").removeClass("hide")}if(!$(".butterbar").hasClass("animation-active")){$(".butterbar").addClass("animation-active")}}function hideTransitionBar(){setTimeout(function(){if($(".butterbar").hasClass("animation-active")){$(".butterbar").removeClass("animation-active")}if(!$(".butterbar").hasClass("hide")){$(".butterbar").addClass("hide")}},10)}$("body").on("shown.bs.modal",".modal:visible",function(a){setTimeout(function(){if($(".modal-backdrop",$(".modal:visible")).height()<=$(".modal-dialog",$(".modal:visible")).height()){$(".modal-backdrop",$(".modal:visible")).height($(".modal-dialog",$(".modal:visible")).height()+70)}},500)});function getUTCMidNightEpochFromDate(a){a=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0));return a.getTime()}function getDateInFormatFromEpoc(a){if(!a){return}if((a/100000000000)>1){1;return en.dateFormatter({raw:getGlobalizeFormat()})(new Date(parseInt(a)))}return en.dateFormatter({raw:getGlobalizeFormat()})(new Date(parseInt(a)*1000))}function getDateInFormatFromEpocForContactFilters(b){if(!b){return}var a=new Date(parseInt(b));var c=new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds());if((b/100000000000)>1){1;return en.dateFormatter({raw:getGlobalizeFormat()})(c)}return en.dateFormatter({raw:getGlobalizeFormat()})(c*1000)}function getDateInFormat(a){if(!a){return}return en.dateFormatter({raw:getGlobalizeFormat()})(a)}function getGlobalizeFormat(){var a=CURRENT_USER_PREFS.dateFormat;if(a.search("MM")!=-1){a=a.replace(/MM/g,"MMMM")}else{if(a.search("M")!=-1){a=a.replace(/M/g,"MMM")}}if(a.search("DD")!=-1){a=a.replace(/DD/g,"EEEE")}else{if(a.search("D")!=-1){a=a.replace(/D/g,"EEE")}}a=a.replace(/m/g,"M");return a}function convertDateFromUKtoUS(c){if(!c){return""}var b;if(c.search("/")!=-1){b=c.split("/")}else{b=c.split(".")}if(b.length==3){if(b[2].length==2){b[2]="20"+b[2]}var a=new Date(b[1]+"/"+b[0]+"/"+b[2]);if(!/Invalid|NaN/.test(a)){return a.format("mm/dd/yyyy")}else{return""}}else{return""}}function getFormattedDateObjectWithString(a){if(!a){return new Date("")}a=a.replace(/\./g,"/");if(CURRENT_USER_PREFS.dateFormat.indexOf("yyyy")==-1){a=a.substring(0,a.length-2)+"20"+a.substring(a.length-2)}if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy")!=-1||CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy")!=-1){a=convertDateFromUKtoUS(a)}return new Date(a)}function isIE(){var a=(window.navigator.userAgent.indexOf("MSIE")!=-1);var b=(window.navigator.userAgent.indexOf("rv:11")!=-1);if(a||b){return true}return false}function agileWindowOrigin(){if(!window.location.origin){return window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}return window.location.origin}$(function(){$(document).ajaxError(function(b,a){if(a.status&&a.status==401){handleAjaxError()}})});function handleAjaxError(){var b=window.location.hash;try{unregisterAll()}catch(a){}sipUnRegister();window.location.href=window.location.protocol+"//"+window.location.host+"/login"+b}function showPageBlockModal(){$("#user-blocked-modal").modal("hide");$("#alert-message").html("").hide();if(USER_BILLING_PREFS.status=="BILLING_PAUSED"){getTemplate("pause-user",{},undefined,function(b){if(!b){return}$("body").append(b);$("#user-blocked-modal").modal("show")},null)}else{if($.inArray(Current_Route,AVOID_PAGEBLOCK_URL)!=-1||USER_BILLING_PREFS==undefined||USER_BILLING_PREFS.status==undefined||USER_BILLING_PREFS.status==null||USER_BILLING_PREFS.updated_time==undefined||USER_BILLING_PREFS.updated_time==null||USER_BILLING_PREFS.updated_time<1456803000){return}else{if($.inArray(USER_BILLING_PREFS.status,PAYMENT_FAILED_REASON)!=-1){getTemplate("user-alert",{},undefined,function(b){if(!b){return}$("#alert-message").html(b).show()},null)}else{if($.inArray(USER_BILLING_PREFS.status,PAGEBLOCK_REASON)!=-1&&USER_BILLING_PREFS.updated_time>1457494200){var a="block-payment-failed-user";if(USER_BILLING_PREFS.status=="SUBSCRIPTION_DELETED"||USER_BILLING_PREFS.status=="SUB&#x73;criptION_DELETED"){a="block-cancelled-user"}getTemplate(a,{},undefined,function(b){if(!b){return}$("body").append(b);$("#user-blocked-modal").modal("show")},null)}}}}}function printCurrentDateMillis(a){console.info(a+" "+new Date().getTime())}function startFunctionTimer(a){try{console.time(a)}catch(b){}}function endFunctionTimer(a){try{console.timeEnd(a)}catch(b){}}function loadServiceLibrary(a){if(!tight_acl.checkPermission("HELPDESK")){tight_acl.init_permissions();hideTransitionBar();return}head.js(CLOUDFRONT_PATH+"jscore/min/locales/"+_LANGUAGE+"/tickets-min.js?_="+(_AGILE_VERSION+"1"),function(){if(a){a()}})}function sendEmail(a,b){$.ajax({type:"POST",data:a,url:"core/api/emails/contact-us",success:function(){if(b&&typeof(b=="function")){b()}},error:function(c){showNotyPopUp("warning",data.responseText,"top")}})}function showAlertModal(d,c,a,f,b){var e={};if(MODAL_MESSAGES[d]!=undefined){e.title=MODAL_MESSAGES[d]["title"];e.message=MODAL_MESSAGES[d]["message"]}else{e.title=b;e.message=d}if(c==undefined){c="alert"}e.type=c;getTemplate("modal-confirm",e,undefined,function(g){if(!g){return}$("#alertModal").html($(g)).modal("show");$("#alertModal #success_callback").click(function(h){h.preventDefault();$("#alertModal").modal("hide");if(a&&typeof(a==="function")){a()}});$("#alertModal #decline_callback").click(function(h){h.preventDefault();$("#alertModal").modal("hide");if(f&&typeof(f==="function")){f()}})},null)}function printSortByName(a,b){$(b).find(".sort-field-txt").html(a)}function getFormattedDateObjectForMonthWithString(a){if(!a){return new Date("")}if(window.navigator.userAgent.indexOf("Mozilla")!=-1&&window.navigator.userAgent.indexOf("Chrome")==-1){a="01 "+a}a=a.replace(/\./g,"/");return new Date(a)}function updateSortKeyTemplate(a,c){$(".sort-field-check",c).addClass("display-none");$(".sort-by-check",c).addClass("display-none");if(a&&a!=null){var b=a.split("-");if(b[0]==""){$(".order-by[data='-']",c).find("i").removeClass("display-none")}else{$(".order-by[data='']",c).find("i").removeClass("display-none")}if(b.length>1){a=b[1]}$(".sort-field[data='"+a+"']",c).find("i").removeClass("display-none");printSortByName($(".sort-field[data='"+a+"']",c).attr("label_name"),c)}}function make_menu_item_active(a){$(".active",$("#agile-menu-navigation-container")).removeClass("active");$("#"+a).addClass("active")}function agileTimeAgoWithLngConversion(a,b){head.js(LIB_PATH+"lib/jquery.timeago.js",LIB_PATH+"lib/jquery.timeago."+_LANGUAGE+".js",function(){if(a){$(a).each(function(c,d){$(d).timeago()})}if(b){b()}})}$(function(a){a.fn.initial=function(c){var b=["#1abc9c","#16a085","#f1c40f","#f39c12","#2ecc71","#27ae60","#e67e22","#d35400","#3498db","#2980b9","#e74c3c","#c0392b","#9b59b6","#8e44ad","#bdc3c7","#34495e","#2c3e50","#95a5a6","#7f8c8d","#ec87bf","#d870ad","#f69785","#9ba37e","#b49255","#b49255","#a94136"];return this.each(function(){var j=a(this);var g=a.extend({name:"Name",charCount:1,textColor:"#ffffff",height:100,width:100,fontSize:40,fontWeight:400,fontFamily:"HelveticaNeue-Light,Helvetica Neue Light,Helvetica Neue,Helvetica, Arial,Lucida Grande, sans-serif"},c);
g=a.extend(g,j.data());g.name=""+g.name;var l=g.name.substr(0,g.charCount).toUpperCase();var h=a('<text text-anchor="middle"></text>').attr({y:"50%",x:"50%",dy:"0.35em","pointer-events":"auto",fill:g.textColor,"font-family":g.fontFamily}).html(l).css({"font-weight":g.fontWeight,"font-size":g.fontSize+"px",});var k=null;if(l.length>1){k=Math.abs(Math.floor((((l.charCodeAt(0)-65)+(l.charCodeAt(1)-65))/2)%b.length))}else{k=Math.abs(Math.floor((l.charCodeAt(0)-65)%b.length))}var d=a("<svg></svg>").attr({xmlns:"http://www.w3.org/2000/svg","pointer-events":"none",width:g.width,height:g.height}).css({"background-color":b[k],width:g.width+"px",height:g.height+"px"});d.append(h);var f=window.btoa(unescape(encodeURIComponent(a("<div>").append(d.clone()).html())));j.attr("src","data:image/svg+xml;base64,"+f)})}});function image_error(c){var a=$(c).attr("_data-name");if(!a){return}$(c).attr("data-name",a);var b={charCount:2,fontWeight:"normal"};if(isIE()){b.fontSize=20;b.width=$(c).width();b.height=$(c).height()}$(c).initial(b)}function image_load(b){var a=$(b).attr("_data-name");var c=$(b).attr("src");if(!c){$(b).attr("src",DEFAULT_GRAVATAR_url);return}if(c.indexOf(DEFAULT_GRAVATAR_url)>=0){$(b).attr("data-name",a);$(b).removeAttr("onLoad")}if(c.indexOf(DEFAULT_GRAVARTAR_IMG)>-1&&is_agile_default_image_loaded(c)){image_error(b)}}function is_agile_default_image_loaded(c){try{var b=document.createElement("img");b.src=c;return((b.width==9&&b.height==9)||(b.width==1&&b.height==1))}catch(a){}return true}audio=null;function play_sound(c,d){var a;if(c){a="../res/"+c+".mp3"}else{a="../res/sound.wav"}if(d){a=c}try{audio=new Audio(a);audio.autoplay=true;audio.play()}catch(b){console.log("Error occured while playing sound "+b)}}function isValidForm(a){jQuery.validator.addMethod("choosen-select-input",function(d,c){if(!$("#bulk-labels").length){return true}var b=$("#bulk-labels .chosen-select").val();if(b){return true}return false},_agile_get_translated_val("validation-msgs","required"));jQuery.validator.addMethod("tickets_email",function(c,b){if(this.optional(b)){return true}return/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(c)},_agile_get_translated_val("validation-msgs","pls-enter-valid-email"));jQuery.validator.addMethod("atleastThreeMonths",function(f,d){var g=$(d).siblings("select.exp_month").val(),e=f;var c=new Date().setFullYear(e,g-1);var b=1000*60*60*24;return this.optional(d)||(((c-new Date().getTime())/b)>90)},_agile_get_translated_val("validation-msgs","card-3months-valid"));jQuery.validator.addMethod("multipleEmails",function(d,c){if(this.optional(c)){return true}var e=d.split(/[,]+/);valid=true;for(var b in e){d=e[b];valid=valid&&jQuery.validator.methods.email.call(this,$.trim(d),c)}return valid},_agile_get_translated_val("validation-msgs","pls-enter-valid-email-sep-by-comma"));jQuery.validator.addMethod("noSpecialChars",function(c,b){return isAlphaNumeric(c)},_agile_get_translated_val("validation-msgs","email-should-start-with-an-alphabet"));jQuery.validator.addMethod("email",function(c,b){if(this.optional(b)){return true}return/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(c)},_agile_get_translated_val("validation-msgs","pls-enter-valid-email"));jQuery.validator.addMethod("phone",function(c,b){if(this.optional(b)){return true}return/^[^a-zA-Z]+$/.test(c)},_agile_get_translated_val("validation-msgs","Pls-enter-a-valid-ph-no"));jQuery.validator.addMethod("allow-char-phone",function(c,b){if(this.optional(b)){return true}return/^((\+)(\d)+)$/.test(c)},_agile_get_translated_val("validation-msgs","Pls-enter-valid-ph-no"));jQuery.validator.addMethod("multi-tags",function(e,b){var d=$(b).val();$(b).val("");if(d&&d.length>=0&&!(/^\s*$/).test(d)){var c=Handlebars.compile('<li class="tag" style="display: inline-block;" data="{{name}}">{{name}}<a class="close" id="remove_tag" tag="{{name}}">&times</a></li>');$(b).closest(".control-group").find("ul.tags").append(c({name:d}))}return $(b).closest(".control-group").find("ul.tags > li").length>0?true:false},_agile_get_translated_val("validation-msgs","this-field-is-required"));jQuery.validator.addMethod("ipValidation",function(c,b){if(this.optional(b)){return true}if(!c){return false}return is_valid_ip(c.trim())},_agile_get_translated_val("validation-msgs","ipaddress"));jQuery.validator.addMethod("formulaData",function(f,c){var e=$(c).val();var b;var g=true;try{b=Handlebars.precompile(e)}catch(d){d.message;g=false}return g?true:false},_agile_get_translated_val("validation-msgs","pls-enter-a-valid-formula"));jQuery.validator.addMethod("number_input",function(c,b){if(c==""){return false}return/^[0-9\-]+$/.test(c)},_agile_get_translated_val("validation-msgs","Pls-enter-valid-no"));jQuery.validator.addMethod("positive_number",function(c,b){if(c==""){return true}if(isNaN(c)){return false}if(!isNaN(c)&&parseFloat(c)>=0){return true}},_agile_get_translated_val("validation-msgs","value-validation"));jQuery.validator.addMethod("multi-select",function(e,d){var c=0;$(d).find(":selected").each(function(f,g){c++});var b=$(d).attr("limit");if(c>b){return false}return true},_agile_get_translated_val("validation-msgs","folder-select-validation"));jQuery.validator.addMethod("checkedMultiSelect",function(d,c){var b=$(c).find("option:selected").length;if(b==0){return false}return true},_agile_get_translated_val("validation-msgs","pls-select-atleast-one-option"));jQuery.validator.addMethod("checkedMultiCheckbox",function(d,c){console.log("value = "+d);console.log("element = "+c);var b=$(c).find("input:checked").length;if(b==0){return false}return true},_agile_get_translated_val("validation-msgs","pls-select-atleast-one-option"));jQuery.validator.addMethod("date",function(c,b){if(c==""){return true}return !/Invalid|NaN/.test(getFormattedDateObjectWithString(c))},_agile_get_translated_val("validation-msgs","Pls-enter-a-valid-date"));jQuery.validator.addMethod("isHttpsURL",function(d,c){var b=new RegExp("^(https://){1}([0-9A-Za-z]+.)");return b.test(d)},_agile_get_translated_val("validation-msgs","pls-enter-a-valid-https-url"));jQuery.validator.addMethod("date_input",function(c,b){if(c==""){return true}return !/Invalid|NaN/.test(getFormattedDateObjectWithString(c))},_agile_get_translated_val("validation-msgs","Pls-enter-a-valid-date"));jQuery.validator.addMethod("field_length",function(d,c){if(d==""){return true}var b=0;var e=$(c).attr("max_len");if(e==""){return true}if(d.length>e){return false}return true},function(c,b){return getTemplate("js-max-length-error",{length:$(b).attr("max_len")})});jQuery.validator.addMethod("domain_format",function(c,b){return/^[a-zA-Z][a-zA-Z0-9-_\.]{3,20}$/.test(c)},_agile_get_translated_val("validation-msgs","domain-validation"));jQuery.validator.addMethod("customFieldSpecialCharacter",function(d,c){var b=/^\s*[_a-zA-Z0-9\s]+\s*$/;return b.test(d)},_agile_get_translated_val("validation-msgs","formlabel-validation"));jQuery.validator.addMethod("duplicateWithSystemName",function(f,d){var b=[];b.cases="title,owner_id,status,description";b.contact="fname,lname,email,company,title,name,url,website,address,phone,skypephone,image,city,state,zip,country,tags";b.deal="name,probability,description,pipeline_milestone,close_date,deal_source_id,color1,relates_to,tags,expected_value";var e=$("#textModalForm").find("input[name='scope']").val();var c;if(e&&(e=="CONTACT"||e=="COMPANY")){var g=b.contact.split(",");for(c=0;c<g.length;c++){if(f.toLowerCase()==g[c]){return false}}}else{if(e&&e=="DEAL"){var g=b.deal.split(",");for(c=0;c<g.length;c++){if(f.toLowerCase()==g[c]){return false}}}else{if(e&&e=="CASE"){var g=b.cases.split(",");for(c=0;c<g.length;c++){if(f.toLowerCase()==g[c]){return false}}}}}return true},"Given name is a system field name. Please choose another name.");jQuery.validator.addMethod("tickets_group_name",function(c,b){return/^[a-zA-Z0-9._]*$/.test(c)},_agile_get_translated_val("validation-msgs","pls-use-only-letters"));jQuery.validator.addMethod("custom_field_keyword",function(c,b){if(c=="image"){return false}else{return true}},_agile_get_translated_val("validation-msgs","image-is-a-keyword-desc"));jQuery.validator.addMethod("verified-email",function(c,b){if($(b).find("option").length!=0){if(typeof($(b).find('option[value="'+c+'"]').attr("unverified"))=="undefined"){return true}return false}},_agile_get_translated_val("validation-msgs","verify-email"));jQuery.validator.addMethod("month_date",function(c,b){if(c==""){return true}return !/Invalid|NaN/.test(getFormattedDateObjectForMonthWithString(c))},_agile_get_translated_val("validation-msgs","date"));$(a).validate({ignoreTitle:true,rules:{atleastThreeMonths:true,multipleEmails:true,email:true,checkedMultiSelect:true,phone:true},debug:true,errorElement:"span",errorClass:"help-inline",ignore:":hidden:not(.checkedMultiSelect)",highlight:function(c,b){$(c).closest(".controls").addClass("single-error")},unhighlight:function(c,b){$(c).closest(".controls").removeClass("single-error")},invalidHandler:function(c,b){var d=b.numberOfInvalids()},errorPlacement:function(b,c){if(c.hasClass("checkedMultiSelect")){b.appendTo($(c).parent())}else{if(c.hasClass("choosen-select-input")){b.appendTo($("#bulk-labels .chosen-container"))}else{b.insertAfter(c)}}}});return $(a).valid()}function isNotValid(a){if(a==undefined){return true}if(a.length==0){return true}return false}function isValidField(b){var a=$("#"+b).val();return !isNotValid(a)}function isAlphaNumeric(b){b=b.toString();var a=new RegExp(/^[A-Za-z][a-zA-Z0-9]{3,20}$/);if(!a.test(b)){error=_agile_get_translated_val("validation-msgs","domain-validation");return false}return true}function isAlphaNumeric(b){b=b.toString();var a=new RegExp(/^[A-Za-z#@][A-Za-z0-9_:&@;/\s/g]*$/);if(!a.test(b)){return false}return true}function isValidContactCustomField(b){var a=$("#"+b).attr("name");if($('ul[name="'+a+'"]').find("li").length==0){return false
}else{return true}}jQuery.extend(jQuery.validator.messages,{required:_agile_get_translated_val("validation-msgs","required"),remote:_agile_get_translated_val("validation-msgs","remote"),email:_agile_get_translated_val("validation-msgs","email"),url:_agile_get_translated_val("validation-msgs","url"),date:_agile_get_translated_val("validation-msgs","date"),dateISO:_agile_get_translated_val("validation-msgs","dateISO"),number:_agile_get_translated_val("validation-msgs","number"),digits:_agile_get_translated_val("validation-msgs","digits"),creditcard:_agile_get_translated_val("validation-msgs","creditcard"),equalTo:_agile_get_translated_val("validation-msgs","equalTo"),accept:_agile_get_translated_val("validation-msgs","accept"),maxlength:jQuery.validator.format(_agile_get_translated_val("validation-msgs","maxlength")),minlength:jQuery.validator.format(_agile_get_translated_val("validation-msgs","minlength")),rangelength:jQuery.validator.format(_agile_get_translated_val("validation-msgs","rangelength")),range:jQuery.validator.format(_agile_get_translated_val("validation-msgs","range")),max:jQuery.validator.format(_agile_get_translated_val("validation-msgs","max")),min:jQuery.validator.format(_agile_get_translated_val("validation-msgs","min"))});function deserializeForm(b,a){$.each(b,function(e,g){var d=a.find('*[name="'+e+'"]'),f="",c="";if(d.length>0){c=d[0].tagName.toLowerCase();if(c=="select"||c=="textarea"){$(d).val(g)}else{if(c=="input"){f=$(d[0]).attr("type");if(d.hasClass("date")){try{d.val(getDateInFormatFromEpoc(g))}catch(h){}d.datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true})}else{if(f=="text"||f=="password"||f=="hidden"||f=="number"||f=="url"){d.val(g)}else{if(c=="select"){d.val(g).trigger("change")}else{if(f=="checkbox"){if(g){if(g==true){d.attr("checked","checked")}}else{d.removeAttr("checked")}}else{if(f=="radio"){d.filter('[value="'+g+'"]').attr("checked","checked")}}}}}}else{if(d.hasClass("multiSelect")&&c=="ul"){$.each(g,function(j,k){$("#multipleSelect",a).multiSelect("select",k)})}else{if(d.hasClass("tagsinput")&&c=="ul"&&d.hasClass("contacts")){$.each(b.contacts,function(k,j){var o;var n=j.id;o=getContactName(j);var m="#contact/"+j.id;if(j.type=="COMPANY"){m="#company/"+j.id}var l=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="{{id}}"  style="display: inline-block; "><a class="text-white v-middle" href="{{link}}">{{name}}</a><a class="close m-l-xs" id="remove_tag">&times</a></li>');d.append(l({name:o,id:n,link:m}))})}else{if(d.hasClass("tagsinput")&&c=="ul"&&d.hasClass("deals")){$.each(b.deals,function(j,l){var n;var m=l.id;n=l.name.split(" ").join("");var k=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="{{id}}"><a href="#deal/{{id}}" class="text-white v-middle">{{name}}</a><a class="close m-l-xs" id="remove_tag">&times</a></li>');d.append(k({name:n,id:m}))})}else{if(d.hasClass("multiSelect")&&c=="ul"){$.each(g,function(j,k){$("#multipleSelect",a).multiSelect("select",k)})}else{if(d.hasClass("multiple-checkbox")){for(var e=0;e<g.length;e++){$('input:checkbox[value="'+g[e]+'"]',d).attr("checked","checked")}}else{if(d.hasClass("multiple-checkbox-adminprefs")){for(var e=0;e<g.length;e++){$('input:checkbox[value="'+g[e]+'"]',d).attr("checked","checked")}}else{if(d.hasClass("chainedSelect")){}}}}}}}}}}})}function deserializecontactsForm(b,a){$.each(b,function(e,g){var d=a.find('*[name="'+g+'"]'),f="",c="";if(d.length>0){$('input:checkbox[value="'+g+'"]',a).attr("checked","checked")}})}function deserializeMultipleForms(b,a){$.each(a,function(c,e){var d=$(e).attr("name");if(d&&b[d]){deserializeForm(b[d],$(e))}else{deserializeForm(b,$(e))}})}function deserializeChainedSelect(c,b,a){$.each(b,function(d,e){var h=($(c).find(".chained"))[0];if(d>0){var f=$(h).parent();h=$($(a).clone().find(".chained"))[0];$(h).find("i.filter-contacts-multiple-remove").css("display","inline-block");var g=$(h).find("i.filter-contacts-multiple-remove").css("display","inline-block");if($(c).hasClass("opportunity")){chainDealFilters(h)}else{chainFilters(h)}$(f).append(h);deserializeChainedElement(e,h);return}deserializeChainedElement(e,h)})}function deserializeChainedElement(a,b){$(b).removeClass("hide");$.each(a,function(k,o){var d=($(b).find('*[name="'+k+'"]').children())[0];if(!d){return}if(d.tagName.toLowerCase()=="input"){if($(d).hasClass("date")){$(d).val(getDateInFormatFromEpoc(o));$(d).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});$(d).datepicker("update");return}if(($(d).closest("td").siblings("td.lhs-block").find("option:selected").attr("field_type")=="CONTACT"||$(d).closest("td").siblings("td.lhs-block").find("option:selected").attr("field_type")=="COMPANY")&&o!="Contact"&&o!="Company"){var n=Backbone.Model.extend({url:"/core/api/contacts/references?references="+o});var m=new n();m.fetch({success:function(s){$(d).val(getPropertyValue(s.get(0).properties,"first_name"))}});return}$(d).val(o);return}if($(d).closest("td").siblings("td.lhs-block").find("option:selected").val()=="track_milestone"&&a.LHS=="track_milestone"){var l=$(d).closest("td").siblings("td.rhs-block").find("#RHS");var h=l.find("input").attr("name");var p=a.RHS;var g=p.substring(0,p.indexOf("_"));var c=p.substring(p.indexOf("_")+1,p.length+1);var q={};q.pipeline_id=g;q.milestone=c;populateTrackMilestones(undefined,undefined,q,undefined,undefined,undefined,l,h);$(d).find('option[value="'+a.CONDITION+'"]').attr("selected","selected");return}if($(d).closest("td").siblings("td.lhs-block").find("option:selected").val()=="archived"&&a.LHS=="archived"){var l=$(d).closest("td").siblings("td.rhs-block").find("#RHS");var h=l.find("input").attr("name");var f=a.RHS;l.html(getTemplate("js-deal-filters",{field_name:h}));l.find("option[value='"+f+"']").attr("selected","selected");return}if($(d).closest("td").siblings("td.lhs-block").find("option:selected").val()=="country"&&a.LHS=="country"){var e="";if(a.CONDITION!="DEFINED"&&a.CONDITION!="NOT_DEFINED"){e=getTemplate("country-list",{})}$(d).closest("td").siblings("td.rhs-block").find("div").html(e);$(d).closest("td").siblings("td.rhs-block").find("div").find("select").find('option[value="'+a.RHS+'"]').attr("selected","selected");$(d).find('option[value="'+a.CONDITION+'"]').attr("selected","selected");return}var j=$("option",d);$.each(j,function(t,u){if($(u).prop("value")==o){$(u).attr("selected","selected");var s=$(u).attr("url");if(s){$(u).attr("data",a.RHS);console.log($(u))}$(d).trigger("change");return}})})}function deserializeChainedElementWebrule(a,b){$.each(a,function(c,f){if(f.value){f=f.value}var e=$(b).find('*[name="'+c+'"]').children();var h=e[0];if(!h){return}var g=h.tagName.toLowerCase();if(g!="input"&&g!="textarea"&&g!="select"&&e.length>1){$.each(e,function(k,j){if(k==0){return}g=j.tagName.toLowerCase();if(g=="input"||g=="textarea"||g=="select"){h=j;return false}})}if(!h){return}if(h.tagName.toLowerCase()=="input"||h.tagName.toLowerCase()=="textarea"){$(h).val(f);if($(h).hasClass("custom_html")){if(f.value){$(h).val(f.value)}}return}var d=$("option",h);$.each(d,function(j,k){if($(k).prop("value")==f){if((f=="UNSUBSCRIBE_CAMPAIGN"||f=="ASSIGN_CAMPAIGN")&&a.RHS){$(k).attr("data",a.RHS)}$(k).attr("selected","selected");$(h).trigger("change");return}})})}function deserializeChainedSelect1(e,d,c){var a=$(c).find(".webrule-actions")[0];var b=$(a).html();var f=($(e).find(".webrule-actions"))[0];$.each(d,function(h,j){if(h>0){var g=$(b).clone();$(g).find("i.webrule-multiple-remove").css("display","inline-block");var k=[];k.push(j);chainWebRules(g,d,false,k);deserializeChainedElementWebrule(j,g);$(f).append(g);return}deserializeChainedElementWebrule(j,f)})}function deserializeLhsFilters(b,d){var c=JSON.parse(d);var a=0;var e=0;$.each(c.rules,function(m,f){var o=f.LHS;var l=f.CONDITION;var h=f.RHS;var k=f.RHS_NEW;var p=o.replace(/ +/g,"_");p=p.replace(/#/g,"\\#").replace(/@/g,"\\@");var q=$(b).find("#"+p+"_div");$(".custom_contact").each(function(){if($(this).attr("name")==o){var t=this;var s=new Base_Collection_View({url:"/core/api/contacts/references?references="+h,sort_collection:false});s.collection.fetch({success:function(v){var u="";if(getPropertyValue(v.get(h).get("properties"),"first_name")){u+=getPropertyValue(v.get(h).get("properties"),"first_name")}if(getPropertyValue(v.get(h).get("properties"),"last_name")){u+=" "+getPropertyValue(v.get(h).get("properties"),"last_name")}$(t).parent().find("input").val(u);$(t).parent().find("input").attr("data",h);hideTransitionBar()}})}});$(".custom_company").each(function(){if($(this).attr("name")==o){var t=this;var s=new Base_Collection_View({url:"/core/api/contacts/references?references="+h,sort_collection:false});s.collection.fetch({success:function(u){$(t).parent().find("input").val(getPropertyValue(u.get(h).get("properties"),"name"));$(t).parent().find("input").attr("data",h);hideTransitionBar()}})}});if(o=="tags"||o=="campaign_status"){$("#"+o+"_div").parent().find("a").addClass("bold-text");$("#"+o+"_div").removeClass("hide");$("#"+o+"_div").prev().find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o");if((a==0&&o=="tags")||(e==0&&o=="campaign_status")){q=$("#"+o+"-lhs-filter-table").find("div.lhs-contact-filter-row:last");$("#"+o+"_div").prev().find("i").toggleClass("fa-plus").toggleClass("fa-minus")}else{var j=$("#"+o+"-lhs-filter-table").find("div.hide.master-"+o+"-add-div").clone();j.removeClass("hide").addClass("lhs-contact-filter-row");addTagsDefaultTypeahead(j);$(j).appendTo("#"+o+"-lhs-filter-table");q=$("#"+o+"-lhs-filter-table").find("div.lhs-contact-filter-row:last")}if(o=="tags"){a++}if(o=="campaign_status"){e++}}else{$(q).prev().find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o")}$(q).parent().find("a#lhs-filters-header").addClass("bold-text");$(q).find("a.clear-filter-condition-lhs").removeClass("hide");$(q).removeClass("hide");
$(q).find('[name="CONDITION"]').val(l);$(q).find('[name="CONDITION"]').trigger("change");var n=$(q).find("."+l).find("#RHS").children();var g=$(q).find("."+l).find("#RHS_NEW").children();if($(n).hasClass("date")){h=getLocalTimeFromGMTMillisecondsforDynamicFilters(h);$(n).val(getDateInFormatFromEpoc(h));$(n).attr("prev-val",getDateInFormatFromEpoc(h))}else{$(n).val(h);$(n).attr("prev-val",h)}if(g){if($(g).hasClass("date")){k=getLocalTimeFromGMTMillisecondsforDynamicFilters(k);$(g).val(getDateInFormatFromEpoc(k));$(g).attr("prev-val",getDateInFormatFromEpoc(k))}else{$(g).val(k);$(g).attr("prev-val",k)}}});if(c.or_rules){$(".custom_contacts").each(function(){var j="";var f=[];var h=this;$.each(c.or_rules,function(l,m){var p=m.LHS;var o=m.CONDITION;var k=m.RHS;var n=m.RHS_NEW;var s=p.replace(/ +/g,"_");s=s.replace(/#/g,"\\#").replace(/@/g,"\\@");var q=$(b).find("#"+s+"_div");if($(h).attr("name")==p){j+=m.RHS+",";f.push(m.RHS);$(q).parent().find("a#lhs-filters-header").addClass("bold-text");$(q).find("a.clear-filter-condition-lhs").removeClass("hide");$(q).removeClass("hide");$(q).find('[name="CONDITION"]').val("IN");$(q).find('[name="CONDITION"]').trigger("change");$(q).prev().find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o")}});if(j){var g=new Base_Collection_View({url:"/core/api/contacts/references?references="+j,sort_collection:false});g.collection.fetch({success:function(k){$.each(f,function(m){var n=f[m];var l="";if(getPropertyValue(k.get(n).get("properties"),"first_name")){l=getPropertyValue(k.get(n).get("properties"),"first_name")}if(getPropertyValue(k.get(n).get("properties"),"last_name")){l+=" "+getPropertyValue(k.get(n).get("properties"),"last_name")}$(h).append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="'+k.get(n).id+'"><a href="#contact/'+k.get(n).id+'" class="text-white v-middle">'+l+'</a><a class="close m-l-xs" id="remove_contact_in_lhs"></a></li>')});hideTransitionBar()}})}});$(".custom_companies").each(function(){var j="";var f=[];var h=this;$.each(c.or_rules,function(l,m){var p=m.LHS;var o=m.CONDITION;var k=m.RHS;var n=m.RHS_NEW;var s=p.replace(/ +/g,"_");s=s.replace(/#/g,"\\#").replace(/@/g,"\\@");var q=$(b).find("#"+s+"_div");if($(h).attr("name")==p){j+=m.RHS+",";f.push(m.RHS);$(q).parent().find("a#lhs-filters-header").addClass("bold-text");$(q).find("a.clear-filter-condition-lhs").removeClass("hide");$(q).removeClass("hide");$(q).find('[name="CONDITION"]').val("IN");$(q).find('[name="CONDITION"]').trigger("change");$(q).prev().find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o")}});if(j){var g=new Base_Collection_View({url:"/core/api/contacts/references?references="+j,sort_collection:false});g.collection.fetch({success:function(k){$.each(f,function(l){var m=f[l];$(h).append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="'+k.get(m).id+'"><a href="#company/'+k.get(m).id+'" class="text-white v-middle">'+getPropertyValue(k.get(m).get("properties"),"name")+'</a><a class="close m-l-xs" id="remove_contact_in_lhs"></a></li>')});hideTransitionBar()}})}})}}function serializeForm(b){var a=$("#"+b).serializeArray(),e={};a=a.concat($("#"+b+" input[type=checkbox]").map(function(){return{name:this.name,value:$(this).is(":checked")}}).get());a=a.concat($("#"+b+" input.date").map(function(){if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy")!=-1||CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy")!=-1){return{name:this.name,value:getFormattedDateObjectWithString(this.value).getTime()/1000}}else{return{name:this.name,value:getFormattedDateObjectWithString(this.value).getTime()/1000}}}).get());a=a.concat($("#"+b+" select.multi-select").map(function(){console.log($(this).val());return{name:this.name,value:$(this).val()}}).get());console.log(a);a=a.concat($("#"+b+' div[contenteditable="true"]').map(function(){var f=$('div[contenteditable="true"]');return{name:f.attr("data-name"),value:f.html()}}).get());a=a.concat($("#"+b+' [name="cc_emails"]').map(function(){var f=[];$.each($(this).children(),function(k,j){if($(j).attr("data")){f.push(($(j).attr("data")).toString())}});return{name:"cc_emails",value:f}}).get());a=a.concat($("#"+b+" .selected_columns").map(function(){return{name:$(this).attr("name"),value:$(this).sortable("toArray")}}).get());a=a.concat($("#"+b+" .array-input-fields").map(function(){console.log($(this).val());return{name:this.name,value:$(this).val()}}).get());a=a.concat(get_tags(b));a=a.concat(get_notes(b));a=a.concat(get_related_deals(b));a=a.concat($("#"+b+" .multiSelect").map(function(){var f=[];$.each($(this).children("li"),function(g,h){f.push(($(h).attr("ms-value")))});return{name:$(this).attr("name"),value:f}}).get());a=a.concat($("#"+b+" .chosen-select").map(function(){var f=[];return{name:$(this).attr("name"),value:$(this).val()}}).get());a=a.concat($("#"+b+" .multiple-input").map(function(){var f=[];$.each($(this).find("input"),function(g,h){if($(h).val()){f.push($(h).val())}});return{name:$(this).attr("name"),value:f}}).get());a=a.concat($("#"+b+" .multiple-checkbox").map(function(){var f=[];$("input:checkbox:checked",this).each(function(h,g){f.push($(g).val())});console.log(f);return{name:$(this).attr("name"),value:f}}).get());a=a.concat($("#"+b+" .multiple-checkbox-adminprefs").map(function(){var f=[];$("input:checkbox:checked",this).each(function(h,g){if(!($(this).closest(".multiple-checkbox"))==undefined){console.log("admin-prefs")}else{if(($(this).closest(".multiple-checkbox")).length==0){f.push($(g).val())}}});console.log(f);return{name:$(this).attr("name"),value:f}}).get());a=a.concat($("#"+b+" input.month_date").map(function(){return{name:this.name,value:getFormattedDateObjectForMonthWithString(this.value).getTime()/1000}}).get());var d=$("#"+b+" .chained-table:visible");$.each(d,function(f,g){var h=[];a=a.concat($(g).find(".chained:visible").map(function(){var j=serializeChainedElement(this);h.push(j);return{name:$(this).attr("name"),value:h}}).get())});for(var c=0;c<a.length;++c){e[a[c].name]=a[c].value}return e}function serializeChainedElement(b){var c={};$.each($(b).find("div").children(),function(f,j){var g=$(j)[0].tagName;if(!(g=="TEXTAREA"||g=="INPUT"||g=="SELECT")){return}var e=$(j).parent().attr("name");var h;if($(j).hasClass("date")){if($(j).closest("td").siblings("td.lhs-block").find("select#LHS").val()=="closed_time"&&$(j).closest("tr").parent().parent().hasClass("opportunity")){var d=getFormattedDateObjectWithString($(j).val());if(d){h=d.getTime()}}else{var d=getFormattedDateObjectWithString($(j).val());h=getGMTEpochFromDateForDynamicFilters(d)}}else{if($(j).hasClass("contact_custom_field")||$(j).hasClass("company_custom_field")){h=$(j).attr("data")}else{if(!c[e]){h=$(j).val()}}}if(h!=null&&h!=""){c[e]=h}});if(c.CONDITION=="BETWEEN"){var a=(c.RHS_NEW+(24*60*60*1000)-1);c.RHS_NEW=a}if(c.nested_condition=="BETWEEN"){var a=(c.nested_rhs+(24*60*60*1000)-1);c.nested_rhs=a}return c}$(function(){$.fn.focus_first=function(){var b=$(this).find("input:visible").not(".hide").get(0);var a=$("textarea:visible",this).get(0);if(a&&b){if(a.offsetTop<b.offsetTop){b=a}}if(b){$(b).focus()}return this};$(".modal").on("shown.bs.modal",function(a){var b=a.target.classList.length;if(a.target.classList[b-2]=="focusRelatedTo"){$("#opportunityUpdateForm").find("input[name='relates_to']").focus()}else{$("form",this).focus_first()}})});function serializeLhsFilters(a){var c=[];var d=[];var b={};$(a).find("a#lhs-filters-header").removeClass("bold-text");$.each($(a).find(".lhs-contact-filter-row"),function(m,h){var n={};var k=$(h)[0];var g,j;var l=$(k).find('[name="CONDITION"]').val();var o=$(k).find("."+l).find("#RHS").children();var f=$(k).find("."+l).find("#RHS_NEW").children();if($(o).val()!=undefined){g=$(o).val().trim()}if($(o).hasClass("date")&&g&&g!=""){var e=getFormattedDateObjectWithString($(o).val());g=getGMTEpochFromDateForDynamicFilters(e)}if($(o).hasClass("custom_contact")||$(o).hasClass("custom_company")){g=$(o).parent().find("input").attr("data")}if($(o).hasClass("custom_contacts")||$(o).hasClass("custom_companies")){$(o).find("li").each(function(){var t={};var x=$(this).attr("data");var u=$(k).find('[name="LHS"]').val();if(x){t.LHS=u;t.CONDITION="EQUALS";t.RHS=x;t.RHS_NEW="";d.push(t);var w=u.replace(/ +/g,"_");w=w.replace(/#/g,"\\#").replace(/@/g,"\\@").replace(/[\/]/g,"\\/");var v=$(a).find("#"+w+"_div");$(v).parent().find("a#lhs-filters-header").addClass("bold-text");$(v).find("a.clear-filter-condition-lhs").removeClass("hide")}})}j=$(f).val();if($(f).hasClass("date")&&j&&j!=""){var e=getFormattedDateObjectWithString($(f).val());if(l!="BETWEEN"){j=getGMTEpochFromDateForDynamicFilters(e)}else{e=new Date(getGMTEpochFromDateForDynamicFilters(e)+(24*60*60*1000)-1);j=e.getTime()}}if(j&&typeof j=="string"){j=j.trim()}if((g&&g!=null&&g!="")||l=="DEFINED"||l=="NOT_DEFINED"){if(f&&f.length>0){if(!j||j==null||j==""){return}}var p=$(k).find('[name="LHS"]').val();n.LHS=p;n.CONDITION=l;n.RHS=g;n.RHS_NEW=j;c.push(n);var q=p.replace(/ +/g,"_");q=q.replace(/#/g,"\\#").replace(/@/g,"\\@").replace(/[\/]/g,"\\/");var s=$(a).find("#"+q+"_div");$(s).parent().find("a#lhs-filters-header").addClass("bold-text");$(s).find("a.clear-filter-condition-lhs").removeClass("hide")}});b.rules=c;if(d){b.or_rules=d}b.contact_type=$(a).find("#contact_type").val();return b}var Form_Collection_Events=Base_Collection_View.extend({events:{"click .codeshare":"codePublish",},codePublish:function(a){$("#modal-backdrop").hide();a.preventDefault();var b=$("#codeShareModal");getTemplate("formbuilder-codeshare",{},undefined,function(g){b.html(g).modal("show");var c=App_Forms.formsListView.collection.get($(a.currentTarget).data("formid"));c.attributes.formHtml=c.get("formHtml").replace('name="_agile_form_id" value="">','name="_agile_form_id" value="'+c.id+'">');b.find("#fullsourceArea").text(c.get("formHtml"));var f=window.location.protocol+"//"+window.location.host+"/forms/"+$(a.currentTarget).data("formid");b.find("#linkArea").text(f);
var e='<iframe width="100%" height="100%" src="'+f+'" frameborder="0"></iframe>';b.find("#iframeArea").text(e);var d={};d.host=window.location.hostname.split(".")[0];d.formid=$(a.currentTarget).data("formid");d.link=f;b.find("#embedCodeArea").text(getTemplate("js-form-embed",d))})},});$("body").on("mouseenter","#forms-model-list tr",function(a){$(this).find("#formcode_manager").removeClass("hide")});$("body").on("mouseleave","#forms-model-list tr",function(a){$(this).find("#formcode_manager").addClass("hide")});$("#codeShareModal").on("focus",".form-control",function(){var a=$(this);a.select();a.mouseup(function(){a.unbind("mouseup");return false})});function setTinyMCEImageUploadURL(a){var b=$(".mce-abs-layout").find("input")[0];$(b).val(a).trigger("change")}(function(a){b();function b(){var d=a("#scroll-top");d.on("click",function(e){e.preventDefault();a("html, body").animate({scrollTop:0},700)}).data("hidden",1).hide();var c=false;a(window).on("scroll",function(){c=true});setInterval(function(){if(c){c=false;var e=d.data("hidden");if(a(this).scrollTop()>a(this).height()/2){if(e){d.fadeIn(600).data("hidden",0)}}else{if(!e){d.slideUp().data("hidden",1)}}}},300)}a("body").on("click","#help-page",function(c){getTemplate("show-help",{},undefined,function(d){if(!d){return}var e=a(d);e.modal("show");a(".hide-modal",e).click(function(){e.modal("hide")})},null)});a("body").on("click",".email-share",function(f){f.preventDefault();var c=500;var g=a(this).closest("a").attr("data");if(g=="Linkedin"){c=700}var d=a(this).closest("a").attr("href");window.open(d,g,"width="+c+",height=500,left=200%,top=100%")});a("body").on("click","#share-email",function(c){c.preventDefault();if(a("#share-by-email").size()!=0){a("#share-by-email").remove()}getTemplate("share-by-email",CURRENT_DOMAIN_USER,undefined,function(f){if(!f){return}var e=a(f);var d=a(e).find("textarea").val();d=d.replace(/<br\/>/g,"\r\n");a(e).find("textarea").val(d);e.modal("show");a("body").on("click","#shareMail",function(j){j.preventDefault();if(!isValidForm(a("#sharemailForm"))){return}var h=serializeForm("sharemailForm");h.body=h.body.replace(/\r\n/g,"<br/>");var g="core/api/emails/send-email?from="+encodeURIComponent(h.from)+"&to="+encodeURIComponent(h.to)+"&subject="+encodeURIComponent(h.subject)+"&body="+encodeURIComponent(h.body);$save_info=a('<img src="'+updateImageS3Path("img/1-0.gif")+'" height="18px" width="18px"></img>&nbsp;&nbsp;<span><p class="text-success" style="color:#008000; font-size:15px; display:inline-block"> <i>'+_agile_get_translated_val("admin-settings-integrations","sending-emails")+"</i></p></span>");a("#msg",this.el).append($save_info);$save_info.show().delay(2000).fadeOut("slow");a.post(g,function(){e.modal("hide")})})},"#content")})})(jQuery);function initializeEmailBuilderListeners(){$("#emailbuilder-listeners").off();$("#emailbuilder-listeners").on("click",".saveEmailBuilderButton",function(a){a.preventDefault();if(isValidForm("#emailBuilderForm")){$(".saveEmailBuilderButton").prop("disabled",true);$(".saveEmailBuilderButtonText").html("Saving...");document.getElementById("emailBuilderFrame").contentWindow.$("#save").trigger("click")}});$("#emailbuilder-listeners").on("click",".sendTestEmailButton",function(a){a.preventDefault();if(isValidForm("#emailBuilderForm")){document.getElementById("emailBuilderFrame").contentWindow.$("#sendTestEmail").trigger("click")}});$("#emailbuilder-listeners").on("click","#emailBuilderOptionsLink",function(a){a.preventDefault();$(this).find("i").toggleClass("icon-plus").toggleClass("icon-minus");$("#emailBuilderOptions").slideToggle("fast")});$("#emailbuilder-listeners").on("click","#mainsourcepreview",function(a){a.preventDefault();document.getElementById("emailBuilderFrame").contentWindow.$("#sourcepreview").trigger("click")});$("#emailbuilder-listeners").on("click",".addAttachmentLink",function(d){d.preventDefault();var c=$(this).closest("div");$(this).css("display","none");c.find("#attachmentSelectBoxHolder").css("display","inline");var a="<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}'>{{name}}</option>";fillSelect("attachmentSelectBox","core/api/documents","documents",function b(){c.find("#attachmentSelectBox option:first").after("<option value='new'>"+_agile_get_translated_val("others","upload-new-doc")+"</option>")},a,false,c);$("#attachmentSelectBoxRequired").hide();$(this).hide()});$("#emailbuilder-listeners").on("click",".attachmentAddBtn,.add-tpl-attachment-confirm",function(b){b.preventDefault();var a=$("#attachmentSelectBox").val();if(a=="new"){$("#uploadDocumentModal").html(getTemplate("upload-document-modal",{})).modal("show");$("#GOOGLE",$("#uploadDocumentModal")).parent().hide()}else{if(a!=""){$("#attachmentSelectBoxHolder").hide();$("#attachmentHolder").show();$("#attachment_id").val(a);$("#attachment_text").html($("#attachmentSelectBox option:selected").text())}else{if(a==""){$("#attachmentSelectBoxRequired").show()}}}});$("#emailbuilder-listeners").on("click",".attachmentCancelBtn",function(a){a.preventDefault();$(".addAttachmentLink").show();$("#attachmentHolder").hide();$("#attachmentSelectBoxHolder").hide();$("#attachment_id").val("");$("#attachment_text").html("")});$("#emailbuilder-listeners").on("change","#attachmentSelectBox",function(a){if($(this).val()==""){$("#attachmentSelectBoxRequired").show()}else{$("#attachmentSelectBoxRequired").hide()}});$("#emailbuilder-listeners").on("click","#bringYourCodeBtn",function(a){a.preventDefault();BRING_YOUR_CODE_BTN=true;window.location.hash="#email-template-add"})}function saveEmailTemplateFromBuilder(f,e){var c={name:$("#nameoftemplate").val(),subject:$("#subject").val(),text:f,text_email:$("#text_email").val(),html_for_builder:e,is_template_built_using_builder:true,attachment_id:($("#attachment_id").val())?$("#attachment_id").val():""};var a="post";var d="Template saved.";var b=$("#templateid").val();if(b){var a="put";c.id=b;d="Template updated."}$.ajax({type:a,url:"core/api/email/templates",data:JSON.stringify(c),dataType:"json",contentType:"application/json; charset=utf-8",success:function(g){$("#nameoftemplate-msg",parent.document).html('<br><span style="color: green;">'+d+"</span>").show().fadeOut(3000);$(".saveEmailBuilderButton",parent.document).prop("disabled",false);$(".saveEmailBuilderButtonText",parent.document).html("Save");if(a=="post"){window.location.hash="email-templates"}},})}function sendTestEmailTemplate(e,d){var b={name:$("#nameoftemplate").val(),from_name:CURRENT_DOMAIN_USER.name,from_email:CURRENT_DOMAIN_USER.email,to_email:CURRENT_DOMAIN_USER.email,replyto_email:CURRENT_DOMAIN_USER.email,subject:$("#subject").val(),text_email:$("#text_email").val(),html_email:e};if(check_merge_fields_and_send(b)){var a="post";var c="Test Email Sent.";$.ajax({type:a,url:"core/api/emails/send-test-email",data:b,success:function(f){$("#nameoftemplate-msg",parent.document).html('<br><span style="color: green;">'+c+"</span>").show().fadeOut(3000)},})}}function redirectToOldEditor(a){window.location.hash="email-template/"+a}function onEmailBuilderLoad(){$("#loadingImgHolder").hide();$("#emailBuilderTopOptionsHolder").show();$("#attachmentsHolderElement").show();$("#emailBuilderFrame").prop("height",680)}function setAttachmentInTemplateEdit(a){$(".addAttachmentLink").hide();$("#attachmentSelectBoxHolder").hide();$("#attachmentHolder").show();$.getJSON("core/api/documents/"+a,function(b){if(b){$("#attachment_id").val(a);$("#attachment_text").html(b.name)}else{$("#attachmentHolder").hide();$(".addAttachmentLink").show()}})}function check_merge_fields_and_send(b){var a=$("#subject").val();var c=b.text_email;var d=b.html_email;if((a&&a.indexOf("{{")!=-1)||(c&&c.indexOf("{{")!=-1)||(d&&d.indexOf("{{")!=-1)){if(show_test_email_alert(b)){return true}else{return false}}else{return true}}function show_test_email_alert(a){var c=_agile_get_translated_val("emailbuilder","send-testemail");var b=_agile_get_translated_val("emailbuilder","observe-merge-fields");window.parent.workflow_alerts(c,b,"workflow-alert-modal",function(d){var e=$(d).find("a");e.off("click");e.on("click",function(h){h.preventDefault();$(this).attr("disabled","disabled").text("Sending...");var f="post";var g=_agile_get_translated_val("emailbuilder","sent-testemail");$.ajax({type:f,url:"core/api/emails/send-test-email",data:a,success:function(j){$("#nameoftemplate-msg",parent.document).html('<br><span style="color: green;">'+g+"</span>").show().fadeOut(3000)},});return true});d.on("hidden.bs.modal",function(f){})})}(function(a,b,d){a.DEAL_PER=false;a.REPORTS_PER=false;a.ACTIVITY_PER=false;var c={};a.init_permissions=function(){if(!Current_Route){return}if(Current_Route.indexOf("deal")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("DEALS")>-1)){c.entity=_agile_get_translated_val("menu","menu-deals");a.DEAL_PER=true;App_ACL.notAllowed(c)}if(Current_Route.indexOf("tasks")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("CALENDAR")>-1)){c.entity=_agile_get_translated_val("menu","tasks");a.ACTIVITY_PER=true;App_ACL.notAllowed(c)}if(Current_Route.indexOf("calendar")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("CALENDAR")>-1)){c.entity=_agile_get_translated_val("menu","calendar");a.ACTIVITY_PER=true;App_ACL.notAllowed(c)}if(Current_Route.indexOf("activit")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("ACTIVITY")>-1)){c.entity=_agile_get_translated_val("menu","menu-activities");a.ACTIVITY_PER=true;App_ACL.notAllowed(c)}if(Current_Route.indexOf("report")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("REPORT")>-1)){c.entity=_agile_get_translated_val("menu","menu-reports");a.REPORTS_PER=true;App_ACL.notAllowed(c)}if((Current_Route.indexOf("web-rules")>-1||Current_Route.indexOf("webrule")>-1)&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("WEBRULE")>-1)){c.entity=_agile_get_translated_val("menu","menu-web-rules");a.REPORTS_PER=true;App_ACL.notAllowed(c)}if(Current_Route.indexOf("social")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("SOCIAL")>-1)){c.entity=_agile_get_translated_val("menu","menu-social");
a.REPORTS_PER=true;App_ACL.notAllowed(c)}if(Current_Route.indexOf("documents")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("DOCUMENT")>-1)){c.entity=_agile_get_translated_val("menu","menu-documents");a.REPORTS_PER=true;App_ACL.notAllowed(c)}if(Current_Route.indexOf("cases")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("CASES")>-1)){c.entity=_agile_get_translated_val("menu","menu-cases");a.REPORTS_PER=true;App_ACL.notAllowed(c)}if((Current_Route.indexOf("workflow")>-1||Current_Route.indexOf("trigger")>-1)&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("CAMPAIGN")>-1)){c.entity=_agile_get_translated_val("menu","menu-campaigns");a.REPORTS_PER=true;App_ACL.notAllowed(c)}if(Current_Route.indexOf("tickets")>-1&&!(CURRENT_DOMAIN_USER.menu_scopes.indexOf("HELPDESK")>-1)){c.entity=_agile_get_translated_val("menu","service");a.REPORTS_PER=true;c.ERR_CONTAINER=".ticket-settings";App_ACL.notAllowed(c)}};a.checkPermission=function(e){return CURRENT_DOMAIN_USER.menu_scopes.indexOf(e)>-1}}(window.tight_acl=window.tight_acl||{},$));(function(b,c,e){b.canAddTag=function(f,k,j){if(CURRENT_DOMAIN_USER.is_admin||ACCOUNT_PREFS.tagsPermission){if(k){k(true)}else{return true}return}if(tagsCollectionView){if(f.indexOf("[")<0){if(tagsCollectionView.collection.where({tag:f}).length==0){showAlertModal(_agile_get_translated_val("tags","no-perm-to-add"),e,function(){if(j){j(_agile_get_translated_val("tags","no-perm-to-add"))}},e,_agile_get_translated_val("others","alert"));return}else{if(k){k(tagsCollectionView.collection.where({tag:f}).length>0)}}}else{var h=JSON.parse(f);var g="";c.each(h,function(l,m){if(tagsCollectionView.collection.where({tag:m}).length==0){if(g.length==0){g=m}else{g+=", "+m}}});if(g.length>0){showAlertModal(_agile_get_translated_val("tags","no-perm-to-add"),e,function(){if(j){j(_agile_get_translated_val("tags","no-perm-to-add"))}},e,_agile_get_translated_val("others","alert"));return}else{if(k){k(true)}}}}else{c.ajax({url:"core/api/tags/can_add_tag?tag="+f,type:"GET",success:function(l){if(k){k(l)}else{return l}},error:function(l){if(l.responseText.indexOf("don't have permissions")!=-1){l.responseText=_agile_get_translated_val("tags","no-perm-to-add")}showAlertModal(l.responseText,e,function(){if(j){j(l.responseText)}},e,_agile_get_translated_val("others","alert"));return}})}};var a=function(f){if(ACCOUNT_PREFS){if(ACCOUNT_PREFS.tagsPermission){c("#new_tag_acl",f).attr("checked","checked")}}else{c.ajax({type:"GET",url:"/core/api/account-prefs",dataType:"json",success:function(g){if(isCheck){c("#new_tag_acl",f).attr("checked","checked")}}})}};var d=function(f){var g={};g.is_enable=f;queuePostRequest("tag_acl","/core/api/account-prefs/allow-new-tag",g,function(){if(ACCOUNT_PREFS){ACCOUNT_PREFS.tagsPermission=f}},function(){})};b.initTagACL=function(f){c("#disable_new_tags").on("click",function(g){if(c("#disable_new_tags").text().trim()==_agile_get_translated_val("tags","enable-access")){c("#disable_new_tags").text(_agile_get_translated_val("tags","disable-access"));d(true);console.log(false)}else{if(c("#disable_new_tags").text().trim()==_agile_get_translated_val("tags","disable-access")){c("#disable_new_tags").text(_agile_get_translated_val("tags","enable-access"));d(false)}}});a(f)}}(window.acl_util=window.acl_util||{},$));function hasScope(a){var b=CURRENT_DOMAIN_USER.scopes;if(!b){return true}return jQuery.inArray(a,b)>-1}function showContactsImportAccessDeniedMessage(a){$(a).html("<h4>"+_agile_get_translated_val("acls","access-denied")+"</h4>")}function hasScope(a){return(CURRENT_DOMAIN_USER.scopes&&$.inArray(a,CURRENT_DOMAIN_USER.scopes)!=-1)}function canEditContacts(){return hasScope("EDIT_CONTACT")}function canEditContacts(){return hasScope("VIEW_CONTACTS")}function canCreateContacts(){return hasScope("CREATE_CONTACT")}function canImportContacts(){if(!hasScope("CREATE_CONTACT")){return false}return hasScope("IMPORT_CONTACTS")}function canExportContacts(){return hasScope("EXPORT_CONTACTS")}function canEditContact(a){if((hasScope("UPDATE_CONTACTS")||hasScope("EDIT_CONTACT"))||CURRENT_DOMAIN_USER.id==a){return true}return false}function canEditCurrentContact(){var b=App_Contacts.contactDetailView.model;if(!b){return}var a=b.toJSON();if(!a.owner){return true}return canEditContact(a.owner.id)}function canRunBulkOperations(){if(!hasScope("VIEW_CONTACTS")){return true}if(!(hasScope("UPDATE_CONTACTS")||hasScope("EDIT_CONTACT"))){return false}return true}$(function(){Handlebars.registerHelper("checkSpamScore",function(a){if(a>5){return"danger"}else{if(a<1){return"success"}}return"info"});Handlebars.registerHelper("checkSpamScoreError",function(a){if(a>=1){return"danger"}else{if(a<=0){return"success"}}return"warning"});Handlebars.registerHelper("checkSpamMessage",function(a){if(a>5){return"Your email template needs 'Rework'"}else{if(a<1){return"Your email template looks 'Good Score'"}}return"Your email template looks 'OK'"})});var TEMPLATE_LIB_PATH="";function downloadTemplate(c,g){var b="html",e=CLOUDFRONT_PATH;if(HANDLEBARS_PRECOMPILATION){c="tpl/min/precompiled/locales/"+_LANGUAGE+"/"+c}else{c="tpl/min/locales/"+_LANGUAGE+"/"+c}if(c.endsWith("js")&&HANDLEBARS_PRECOMPILATION){b="script";e=e.replace("flatfull/","");c=e+c}var f=c.split("/");f=f.length>0?f[f.length-1]:f;c+="?_="+_agile_get_file_hash(f);var a=false;if(g&&typeof(g)==="function"){a=true}console.log(c+" "+b+" "+a);var d=!LOCAL_SERVER;jQuery.ajax({url:c,dataType:b,cache:d,success:function(h){if(b=="html"){$("body").append((h))}if(a){g(h)}},async:a});return""}if(typeof String.prototype.endsWith!=="function"){String.prototype.endsWith=function(a){return this.indexOf(a,this.length-a.length)!==-1}}Handlebars.registerHelper("is_filtered_ticket",function(a){if(Ticket_Filter_ID){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("get_ticket_filter_id",function(a){return Ticket_Filter_ID});Handlebars.registerHelper("ticket_collection_exists",function(a){if(App_Ticket_Module.ticketsCollection&&App_Ticket_Module.ticketsCollection.collection&&App_Ticket_Module.ticketsCollection.collection.length>0){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("get_ticket_id",function(b,a){return Tickets.get_next_prev_ticket_id(b)});Handlebars.registerHelper("calculate_due_date",function(c,a){var b=new Date().getTime();if(c<b){return"Overdue by "+Ticket_Utils.dateDiff(b,c)}return"Due in "+Ticket_Utils.dateDiff(b,c)});Handlebars.registerHelper("getInitials",function(b,a){return Ticket_Utils.getInitials(b)});Handlebars.registerHelper("ticket_contact_exists",function(a){if(Ticket_Utils.Current_Ticket_Contact&&!($.isEmptyObject(Ticket_Utils.Current_Ticket_Contact.toJSON()))){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("get_contact_image",function(b){if(Ticket_Utils.Current_Ticket_Contact&&!($.isEmptyObject(Ticket_Utils.Current_Ticket_Contact.toJSON()))){var g=Ticket_Utils.Current_Ticket_Contact.toJSON();var l=g.properties;var a=getPropertyValue(l,"image");if(a){return a}var k=getPropertyValue(l,"email");var f=DEFAULT_GRAVATAR_url;var j='&d=404" ';var c="";try{c=text_gravatar_initials(l)}catch(h){console.log(h)}if(c.length==0){j="&d="+DEFAULT_GRAVATAR_url+'" '}var d="";d='onLoad="image_load(this)" onError="image_error(this)"_data-name="'+c;var k=getPropertyValue(l,"email");if(k){return new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5(k)+".jpg?s="+b+j+d)}}return new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+b+""+j+d)});Handlebars.registerHelper("get_due_date_badge",function(c,a){var b=new Date().getTime();if(c<b){return'<span class="label bg-danger first-letter-cap inline-block" title="Overdue by '+Ticket_Utils.dateDiff(b,c)+'">Overdue</span>'}return'<span class="label bg-light first-letter-cap inline-block">Due in '+Ticket_Utils.dateDiff(b,c)+"</span>"});Handlebars.registerHelper("get_current_ticket_filter",function(a){return Ticket_Filter_ID});Handlebars.registerHelper("contains_string",function(b,c,a){if(c.search(b)!=-1){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("array_contains",function(c,b,a){if(c.indexOf(b)!=-1){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("is_labels_collection_empty",function(a){if(!Ticket_Labels.labelsCollection||Ticket_Labels.labelsCollection.toJSON().length==0){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("selected_all_tickets",function(a){if(Ticket_Bulk_Ops.selected_all_filter_tickets){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("get_ticket_labels_from_ids",function(e,c,b){if(!Ticket_Labels.labelsCollection||!e){return}var d={};$.each(Ticket_Labels.labelsCollection.toJSON(),function(f,g){d[g.id]=g});var a=[];$.each(e,function(f,g){if(d[g]){a.push(d[g])}});c.labelsJSON=a;return b.fn(c)});Handlebars.registerHelper("get_label_from_label_id",function(d,a){if(!Ticket_Labels.labelsCollection||!d){return}for(var b=0;b<Ticket_Labels.labelsCollection.toJSON().length;b++){var c=Ticket_Labels.labelsCollection.toJSON()[b];if([c.id]==d){return c.label}}return});Handlebars.registerHelper("compile_template",function(d,c,a){var b=Handlebars.compile(d);return b(c)});Handlebars.registerHelper("get_template",function(a,c,b){return getTemplate(a,c)});Handlebars.registerHelper("is_ticket_reply_activity",function(a,b){var c=["TICKET_CREATED","TICKET_REQUESTER_REPLIED","TICKET_ASSIGNEE_REPLIED"];if(a&&$.inArray(a,c)!=-1){return b.fn(this)}return b.inverse(this)});Handlebars.registerHelper("is_ticket_requester_activity",function(a,b){var c=["TICKET_CREATED","TICKET_REQUESTER_REPLIED"];if(a&&$.inArray(a,c)!=-1){return b.fn(this)}return b.inverse(this)});Handlebars.registerHelper("is_single_row_view",function(a){if(Tickets.isSingleRowView()){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("get_status_label",function(a,b){switch(a){case"NEW":return'<span class="label label-warning cus-pad">N</span>';break;case"OPEN":return'<span class="label label-danger cus-pad">O</span>';
break;case"PENDING":return'<span class="label label-info cus-pad">P</span>';break;case"CLOSED":return'<span class="label label-success cus-pad">C</span>';break}});Handlebars.registerHelper("get_palin_text_from_html",function(c,a){var b=document.createElement("DIV");b.innerHTML=c;return b.textContent||b.innerText||""});Handlebars.registerHelper("get_current_user_prefs",function(b,a){b.current_logged_in_user=CURRENT_DOMAIN_USER;return a.fn(b)});Handlebars.registerHelper("agile_compare_prefs",function(c,d,b){var a=_agile_get_prefs(c);console.log(a==d);if(a&&a==d){return b.fn(this)}return b.inverse(this)});Handlebars.registerHelper("is_lhs_filter_disabled",function(a){if(_agile_get_prefs("hide_ticket_lhs_filter")){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("is_column_selected",function(c,b){var a=CURRENT_DOMAIN_USER.helpdeskSettings.choosed_columns;if(!a||!a.length){a=["id","subject","requester_name","due_date","priority","status","assignee","group",]}if(a.indexOf(c)!=-1){return b.fn(this)}return b.inverse(this)});Handlebars.registerHelper("is_ticket_collection_available",function(a){try{if(App_Ticket_Module.ticketsCollection&&App_Ticket_Module.ticketsCollection.collection.toJSON().length>0&&App_Ticket_Module.ticketsCollection.collection.get(Current_Ticket_ID)){return a.fn(this)}}catch(b){}return a.inverse(this)});Handlebars.registerHelper("convert_to_html",function(c,a){if(!c){return""}c=c.trim();try{}catch(b){}return c});Handlebars.registerHelper("replace_newline_with_br",function(b,a){if(!b){return""}b=b.trim();b=b.replace(/(?:\r\n|\r|\n)/g,"<br />");return b});Handlebars.registerHelper("get_ticket_uri",function(b,a){if(Ticket_Filter_ID){return"#tickets/filter/"+Ticket_Filter_ID}return"#tickets"});Handlebars.registerHelper("getGravatarFromEmail",function(a,b){if(a){return"https://secure.gravatar.com/avatar/"+Agile_MD5(a)+".jpg?s="+b+"&d=404"}return"https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+b+"&d=404"});Handlebars.registerHelper("get_current_filter_name",function(a){return Ticket_Filters.getCurrentFilterName()});Handlebars.registerHelper("get_filters_select_options",function(b){var d=App_Ticket_Module.ticketFiltersList.collection.toJSON();var a='<option value="{{id}}">{{name}}</option>',c="";d.forEach(function(e){c+=a.replace("{{id}}",e.id).replace("{{name}}",e.name)});return c});Handlebars.registerHelper("is_current_opend_ticket",function(b,a){if(b==Current_Ticket_ID){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("is_helpdesk_enabled",function(a){if(Helpdesk_Enabled){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("is_current_logged_in_user",function(b,a){if(CURRENT_DOMAIN_USER.id==b){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("replace_br_with_space",function(c,a){if(!c){return}var b=/<br\s*[\/]?>/gi;return c.replace(b," ")});Handlebars.registerHelper("gravatarurl",function(k,b){if(k==undefined){return}var a=getPropertyValue(k,"image");if(a){return a}var f=DEFAULT_GRAVATAR_url;var g='&d=404" ';var c="";try{c=text_gravatar_initials(k)}catch(h){console.log(h)}if(c.length==0){g="&d="+DEFAULT_GRAVATAR_url+'" '}var d="";d='onLoad="image_load(this)" onError="image_error(this)"_data-name="'+c;var j=getPropertyValue(k,"email");if(j){return new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5(j)+".jpg?s="+b+g+d)}return new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+b+""+g+d)});Handlebars.registerHelper("uc_first",function(b,a){return ucfirst(b)});Handlebars.registerHelper("helpcenter_url",function(c){if(!App_Ticket_Module.sectionsCollection){return""}var e=App_Ticket_Module.sectionsCollection.collection;console.log(e);var b=e.url;var a=b.split("/");var d=a[a.length-1];return"/"+d});Handlebars.registerHelper("helpcenter_url_section",function(d){if(!App_Ticket_Module.articlesCollection){return""}var f=App_Ticket_Module.articlesCollection.collection;console.log(f);var c=f.url;var b=c.split("/");var e=b[b.length-1];var a=e.split("=");var g=a[a.length-1];return"/"+g});Handlebars.registerHelper("get_ticket_translated_text",function(c,b,a){return get_ticket_translated_text(c,b)});function get_ticket_translated_text(c,b){var a={priority:{LOW:"Low",MEDIUM:"Medium",HIGH:"High",},status:{OPEN:"Open",PENDING:"Pending",CLOSED:"Closed",},};if(a[c]&&a[c][b]){return a[c][b]}return b}function getTemplateUrls(a){var b=[];if(a.indexOf("settings")==0){b.push("settings.js")}if(a.indexOf("admin-settings")==0){b.push("admin-settings.js")}if(a.indexOf("continue")==0){b.push("continue.js")}if(a.indexOf("all-domain")==0){b.push("admin.js")}if(a.indexOf("contact-detail")==0||a.indexOf("timeline")==0||a.indexOf("company-detail")==0){b.push("contact-detail.js");if(HANDLEBARS_PRECOMPILATION){b.push("contact-detail.html")}}if(a.indexOf("contact-filter")==0||a.indexOf("filter-contacts")==0){b.push("contact-filter.js")}if(a.indexOf("contact-view")==0||a.indexOf("contact-custom")==0||a.indexOf("contacts-custom")==0||a.indexOf("contacts-grid")==0||a.indexOf("company-view")==0||a.indexOf("companies-custom")==0){b.push("contact-view.js")}if(a.indexOf("bulk-actions")==0){b.push("bulk-actions.js")}if(a.indexOf("case")==0){b.push("case.js")}if(a.indexOf("document")==0){b.push("document.js")}if(a.indexOf("voice-mail")==0){b.push("voice-mail.js")}if(a.indexOf("gmap")==0){b.push("gmap.js")}if(a.indexOf("report")==0){b.push("report.js")}if(a.indexOf("webrule")==0){b.push("web-rules.js")}if(a.indexOf("workflow")==0||a.indexOf("campaign")==0||a.indexOf("trigger")==0||a.indexOf("automation")==0){b.push("workflow.js")}if(a.indexOf("purchase")==0||a.indexOf("subscription")==0||a.indexOf("subscribe")==0||a.indexOf("invoice")==0){b.push("billing.js")}if(a.indexOf("widget")==0){b.push("widget.js")}if(a.indexOf("helpscout")==0){b.push("helpscout.js")}else{if(a.indexOf("clickdesk")==0){b.push("clickdesk.js")}else{if(a.indexOf("zendesk")==0){b.push("zendesk.js")}else{if(a.indexOf("freshbooks")==0){b.push("freshbooks.js")}else{if(a.indexOf("linkedin")==0){b.push("linkedin.js")}else{if(a.indexOf("rapleaf")==0){b.push("rapleaf.js")}else{if(a.indexOf("stripe")==0){b.push("stripe.js")}else{if(a.indexOf("twilioio")==0){b.push("twilioio.js")}else{if(a.indexOf("twilio")==0){b.push("twilio.js")}else{if(a.indexOf("sip")==0){b.push("sip.js")}else{if(a.indexOf("twitter")==0){b.push("twitter.js")}else{if(a.indexOf("googleplus")==0){b.push("googleplus.js")}else{if(a.indexOf("paypal")==0){b.push("paypal.js")}else{if(a.indexOf("xero")==0){b.push("xero.js")}else{if(a.indexOf("braintree")==0){b.push("braintree.js")}else{if(a.indexOf("quickbooks")==0){b.push("quickbooks.js")}else{if(a.indexOf("facebook")==0){b.push("facebook.js")}else{if(a.indexOf("callscript")==0){b.push("callscript.js")}}}}}}}}}}}}}}}}}}if(a.indexOf("chargify")==0){b.push("chargify.js")}if(a.indexOf("shopify")==0){b.push("shopify.js")}if(a.indexOf("socialsuite")==0){b.push("socialsuite.js")}if(a.indexOf("portlet")==0){b.push("portlets.js")}if(a.indexOf("deal-detail")==0){b.push("deal-detail.js")}if(a.indexOf("fbpagetab")==0){b.push("facebookpage.js")}if(a.indexOf("landingpages")==0){b.push("landingpages.js")}if(a.indexOf("emailbuilder")==0){b.push("emailbuilder.js")}if(a.indexOf("segmentation")==0){b.push("segmentation.js")}if(a.indexOf("ticket")==0){b.push("tickets.js")}if(a.indexOf("billing-settings")==0||a.indexOf("creditcard-update")==0){b.push("settings.js")}if(a.indexOf("bria")==0){b.push("bria.js")}if(a.indexOf("skype")==0){b.push("skype.js")}if(a.indexOf("formbuilder")==0){b.push("formbuilder.js")}if(a.indexOf("uservoice")==0){b.push("uservoice.js")}if(a.indexOf("dashboard")==0){b.push("dashboards.js")}if(a.indexOf("refer")==0){b.push("referals.js")}if(a.indexOf("helpcenter")==0){b.push("helpcenter.js")}if(a.indexOf("affiliate")==0){b.push("affiliate.js")}return b}function load_templates_async(a,c,d,e){var b=d.pop();if(!b){getTemplate(a,c,"no",e);return}downloadTemplate(b,function(){load_templates_async(a,c,d,e)})}function load_templates_sync(b){for(var a in b){downloadTemplate(b[a])}}String.prototype.endsWith=function(a){return this.indexOf(a,this.length-a.length)!==-1};function getPropertyValue(b,c){if(b==undefined){return}for(var d=0,a=b.length;d<a;d++){if(b[d].name==c){if(b[d].value!=null){b[d].value=b[d].value.trim()}return b[d].value}}}function getSystemPropertyValue(b,c){if(b==undefined){return}for(var d=0,a=b.length;d<a;d++){if(b[d].name==c&&b[d].type=="SYSTEM"){if(b[d].value!=null){b[d].value=b[d].value.trim()}return b[d].value}}}function getPropertyValueByCheckingExistance(d,g,a){if(d==undefined){return}var c=false;var f=false;for(var e=0,b=d.length;e<b;e++){if(d[e].name==g){if(d[e].value){c=true}}else{if(d[e].name==a){if(d[e].value){f=true}}}}if(c&&f){return","}}function getMarginLength(b,d){if(b==undefined){return}for(var c=0,a=b.length;c<a;c++){if(b[c].name==d){return"3px"}}return"0px"}function checkPropertyValueExistance(b,c,f){if(b==undefined){return"none"}var e=false;for(var d=0,a=b.length;d<a;d++){if(b[d].name==c||b[d].name==f){if(b[d].value){e=true}}}if(e==true){return"block"}else{return"none"}}function getAllPropertyValuesByName(b,c,g){if(b==undefined){return}var h="";for(var d=0,a=b.length;d<a;d++){if(b[d].name==c){var f=b[d].value;h+=f+g}}var e=new RegExp("(^"+g+")|("+g+"$)","g");h=h.replace(e,"");console.log(h);return h}function getProperty(b,c){if(b==undefined){return}for(var d=0,a=b.length;d<a;d++){if(b[d].name==c){return b[d]}}}function getCustomProperty(b,c){if(b==undefined){return}for(var d=0,a=b.length;d<a;d++){if(b[d].name==c&&b[d].type=="CUSTOM"){return b[d]}}}function getPropertyValueBySubtype(c,d,b){if(c==undefined){return}for(var e=0,a=c.length;e<a;e++){if(c[e].name==d&&c[e].subtype==b){return c[e].value}}}function getPropertyValueBytype(c,d,f,b){if(c==undefined){return}for(var e=0,a=c.length;e<a;e++){if(c[e].name==d){if(f&&f==c[e].type){if(b&&b==c[e].subtype){return c[e].value}}if(b&&b==c[e].subtype){return c[e].value
}}}}function getPropertyValueInCheckbox(b,c,g,f){if(b==undefined){return}var e="";for(var d=0,a=b.length;d<a;d++){if(b[d].name===c){if(c==="website"){if(f==="checked"){e=e.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+c+'" subtype="'+get_subtype_value(b[d])+'" data="'+b[d].value+'" oid="'+g+'" checked="'+f+'"><i></i></label>'+b[d].value)}else{e=e.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+c+'" subtype="'+get_subtype_value(b[d])+'" data="'+b[d].value+'" oid="'+g+'"><i></i></label>'+b[d].value)}e=e.concat(get_website_icon(b[d]))}else{if(c==="phone"){if(f==="checked"){e=e.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+c+'" subtype="'+get_subtype_value(b[d])+'" data="'+b[d].value+'" oid="'+g+'" checked="'+f+'"><i></i></label>'+b[d].value)}else{e=e.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+c+'" subtype="'+get_subtype_value(b[d])+'" data="'+b[d].value+'" oid="'+g+'"><i></i></label>'+b[d].value)}e=e.concat(get_subtype(b[d]))}else{if(c==="email"){if(f==="checked"){e=e.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+c+'" subtype="'+get_subtype_value(b[d])+'" data="'+b[d].value+'" oid="'+g+'" checked="'+f+'"><i></i></label>'+b[d].value)}else{e=e.concat('<label class="i-checks i-checks-sm"><input type="checkbox" field="'+c+'" subtype="'+get_subtype_value(b[d])+'" data="'+b[d].value+'" oid="'+g+'"><i></i></label>'+b[d].value)}e=e.concat(get_subtype(b[d]))}}}}}return e}function get_website_icon(b){var a=get_social_icon(b.subtype);var c='<i class="'.concat(a).concat('"').concat(' style="font-size: 1.3em !important; margin-left:10px "></i> <br>');return c}function get_social_icon(b){if(!b){return"fa fa-globe"}var a={TWITTER:"fa fa-twitter",LINKEDIN:"fa fa-linkedin-square",URL:"fa fa-globe","GOOGLE-PLUS":"fa fa-google-plus-square",FACEBOOK:"fa fa-facebook-square",GITHUB:"fa fa-github",FEED:"icon-rss",XING:"fa fa-xing-square",SKYPE:"icon-skype",YOUTUBE:"fa fa-youtube-square",FLICKR:"fa fa-flickr"};b=b.trim();if(a[b]){return a[b]}return"fa fa-globe"}function get_subtype(a){if(a.subtype!=undefined&&a.subtype!=""){var b='<span style="margin:3px 0px 3px 10px">'.concat(a.subtype).concat("</span> <br>");return b}else{return"<br>"}}function get_subtype_value(a){if(a.subtype!=undefined&&a.subtype!=""){var b=a.subtype;return b}else{return""}}function getContactCustomProperties(items){if(items==undefined){return items}var fields=[];var fieldName="";var datajson={};for(var i=0;i<items.length;i++){if(items[i].type=="CUSTOM"&&items[i].name!="image"){if(fieldName==""){fieldName=items[i].name}fields.push(items[i]);datajson[""+items[i].name]=items[i].value}}var type="";if(App_Contacts.customFieldsList!=undefined&&App_Contacts.customFieldsList!=null){for(var i=0;i<App_Contacts.customFieldsList.collection.models.length;i++){if(App_Contacts.customFieldsList.collection.models[i].get("field_label")==fieldName){type=App_Contacts.customFieldsList.collection.models[i].get("scope");break}}}var formulaFields=[];var allCustomFields=[];var finalFields=[];if(App_Contacts.customFieldsList!=undefined&&App_Contacts.customFieldsList!=null){if(type==""){type="CONTACT"}for(var i=0;i<App_Contacts.customFieldsList.collection.models.length;i++){var json={};if(App_Contacts.customFieldsList.collection.models[i].get("scope")==type&&App_Contacts.customFieldsList.collection.models[i].get("field_type")=="FORMULA"){var tplEleData=Mustache.render(App_Contacts.customFieldsList.collection.models[i].get("field_data"),datajson);var evalFlag=true;var tplEleDataAftEval;try{tplEleDataAftEval=eval(tplEleData)}catch(err){console.log(err.message);evalFlag=false}if(!evalFlag){tplEleDataAftEval=tplEleData}if(evalFlag&&tplEleDataAftEval!=undefined&&tplEleDataAftEval!=null){json.name=App_Contacts.customFieldsList.collection.models[i].get("field_label");json.type="CUSTOM";json.position=App_Contacts.customFieldsList.collection.models[i].get("position");json.value=tplEleDataAftEval;json.field_type=App_Contacts.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json);formulaFields.push(json)}}else{if(App_Contacts.customFieldsList.collection.models[i].get("scope")==type){json.name=App_Contacts.customFieldsList.collection.models[i].get("field_label");json.type="CUSTOM";json.position=App_Contacts.customFieldsList.collection.models[i].get("position");json.field_type=App_Contacts.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json)}}}}if(fields.length>0){if(allCustomFields.length>0){for(var i=0;i<allCustomFields.length;i++){var isFieldExist=false;if(allCustomFields[i].field_type=="FORMULA"){if($.inArray(allCustomFields[i],finalFields)==-1){finalFields.push(allCustomFields[i])}}else{for(var j=0;j<fields.length;j++){if(allCustomFields[i].name==fields[j].name){if($.inArray(fields[j],finalFields)==-1){for(var m=0;m<allCustomFields.length;m++){if(fields[j].name==allCustomFields[m].name&&(allCustomFields[m].field_type=="CONTACT"||allCustomFields[m].field_type=="COMPANY")){fields[j].custom_field_type=allCustomFields[m].field_type}}finalFields.push(fields[j])}isFieldExist=true;break}if(!isFieldExist){if($.inArray(fields[j],finalFields)==-1){for(var m=0;m<allCustomFields.length;m++){if(fields[j].name==allCustomFields[m].name&&(allCustomFields[m].field_type=="CONTACT"||allCustomFields[m].field_type=="COMPANY")){fields[j].custom_field_type=allCustomFields[m].field_type}}finalFields.push(fields[j])}}}}}}else{for(var k=0;k<fields.length;k++){if($.inArray(fields[k],finalFields)==-1){finalFields.push(fields[k])}}}}else{for(var k=0;k<formulaFields.length;k++){if($.inArray(formulaFields[k],finalFields)==-1){finalFields.push(formulaFields[k])}}}return finalFields}function getCompanyCustomProperties(items){if(items==undefined){return items}var fields=[];var fieldName="";var datajson={};for(var i=0;i<items.length;i++){if(items[i].type=="CUSTOM"&&items[i].name!="image"){if(fieldName==""){fieldName=items[i].name}fields.push(items[i]);datajson[""+items[i].name]=items[i].value}}var type="";if(App_Companies.customFieldsList!=undefined&&App_Companies.customFieldsList!=null){for(var i=0;i<App_Companies.customFieldsList.collection.models.length;i++){if(App_Companies.customFieldsList.collection.models[i].get("field_label")==fieldName){type=App_Companies.customFieldsList.collection.models[i].get("scope");break}}}var formulaFields=[];var allCustomFields=[];var finalFields=[];if(App_Companies.customFieldsList!=undefined&&App_Companies.customFieldsList!=null){if(type==""){type="CONTACT"}for(var i=0;i<App_Companies.customFieldsList.collection.models.length;i++){var json={};if(App_Companies.customFieldsList.collection.models[i].get("scope")==type&&App_Companies.customFieldsList.collection.models[i].get("field_type")=="FORMULA"){var tplEleData=Mustache.render(App_Companies.customFieldsList.collection.models[i].get("field_data"),datajson);var evalFlag=true;var tplEleDataAftEval;try{tplEleDataAftEval=eval(tplEleData)}catch(err){console.log(err.message);evalFlag=false}if(!evalFlag){tplEleDataAftEval=tplEleData}if(evalFlag&&tplEleDataAftEval!=undefined&&tplEleDataAftEval!=null){json.name=App_Companies.customFieldsList.collection.models[i].get("field_label");json.type="CUSTOM";json.position=App_Companies.customFieldsList.collection.models[i].get("position");json.value=tplEleDataAftEval;json.field_type=App_Companies.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json);formulaFields.push(json)}}else{if(App_Companies.customFieldsList.collection.models[i].get("scope")==type){json.name=App_Companies.customFieldsList.collection.models[i].get("field_label");json.type="CUSTOM";json.position=App_Companies.customFieldsList.collection.models[i].get("position");json.field_type=App_Companies.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json)}}}}if(fields.length>0){if(allCustomFields.length>0){for(var i=0;i<allCustomFields.length;i++){var isFieldExist=false;if(allCustomFields[i].field_type=="FORMULA"){finalFields.push(allCustomFields[i])}else{for(var j=0;j<fields.length;j++){if($.inArray(fields[j],finalFields)==-1){if(allCustomFields[i].name==fields[j].name){for(var m=0;m<allCustomFields.length;m++){if(fields[j].name==allCustomFields[m].name&&(allCustomFields[m].field_type=="CONTACT"||allCustomFields[m].field_type=="COMPANY")){fields[j].custom_field_type=allCustomFields[m].field_type}}finalFields.push(fields[j]);isFieldExist=true;break}}if(!isFieldExist){if($.inArray(fields[j],finalFields)==-1){for(var m=0;m<allCustomFields.length;m++){if(fields[j].name==allCustomFields[m].name&&(allCustomFields[m].field_type=="CONTACT"||allCustomFields[m].field_type=="COMPANY")){fields[j].custom_field_type=allCustomFields[m].field_type}}finalFields.push(fields[j])}}}}}}else{for(var k=0;k<fields.length;k++){if($.inArray(fields[k],finalFields)==-1){finalFields.push(fields[k])}}}}else{for(var k=0;k<formulaFields.length;k++){if($.inArray(fields[k],finalFields)==-1){finalFields.push(formulaFields[k])}}}return finalFields}function ucfirst(a){return(a&&typeof a==="string")?(a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()):""}function titleFromEnums(a){if(!a){return}var b=a.replace(/_/g," ");return ucfirst(b.toLowerCase())}function countJsonProperties(b){var c;var a=0;for(c in b){a++}return a}function getCurrentContactProperty(b){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var a=App_Contacts.contactDetailView.model.get("properties");return getPropertyValue(a,b)}}function getCount(a){if(a[0]&&a[0].count&&(a[0].count!=-1)){return"("+a[0].count+" "+_agile_get_translated_val("other","total")+")"}else{return"("+a.length+" "+_agile_get_translated_val("other","total")+")"}}function getTaskCount(a){if(a[0]&&a[0].count&&(a[0].count!=-1)){return a[0].count}else{return a.length}}function getIdFromHash(){var a=window.location.hash.substr(1);if(a.substr(-1)==="/"){a=a.replace(/\/$/,"")}var b=a.split("/").pop();
return b}function updateCustomData(a){$(".custom-data",App_Contacts.contactDetailView.el).html(a)}function updateCompanyCustomData(a){$(".custom-data",App_Companies.companyDetailView.el).html(a)}function getDealCustomProperties(items){if(items==undefined){return items}var fields=[];var datajson={};for(var i=0;i<items.length;i++){fields.push(items[i]);datajson[""+items[i].name]=items[i].value}var formulaFields=[];var allCustomFields=[];var finalFields=[];if(App_Deals.customFieldsList!=undefined&&App_Deals.customFieldsList!=null){for(var i=0;i<App_Deals.customFieldsList.collection.models.length;i++){var json={};if(App_Deals.customFieldsList.collection.models[i].get("field_type")=="FORMULA"){var tplEleData=Mustache.render(App_Deals.customFieldsList.collection.models[i].get("field_data"),datajson);var evalFlag=true;var tplEleDataAftEval;try{tplEleDataAftEval=eval(tplEleData)}catch(err){console.log(err.message);evalFlag=false}if(!evalFlag){tplEleDataAftEval=tplEleData}if(evalFlag&&tplEleDataAftEval!=undefined&&tplEleDataAftEval!=null){json.name=App_Deals.customFieldsList.collection.models[i].get("field_label");json.position=App_Deals.customFieldsList.collection.models[i].get("position");json.value=tplEleDataAftEval;json.field_type=App_Deals.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json);formulaFields.push(json)}}else{json.name=App_Deals.customFieldsList.collection.models[i].get("field_label");json.position=App_Deals.customFieldsList.collection.models[i].get("position");json.field_type=App_Deals.customFieldsList.collection.models[i].get("field_type");allCustomFields.push(json)}}}if(fields.length>0){if(allCustomFields.length>0){for(var i=0;i<allCustomFields.length;i++){if(allCustomFields[i].field_type=="FORMULA"){finalFields.push(allCustomFields[i])}else{if(allCustomFields[i].field_type=="DATE"){for(var j=0;j<fields.length;j++){if(allCustomFields[i].name==fields[j].name){fields[j].is_date=true;if(!fields[j].value){return""}finalFields.push(fields[j]);break}}}else{for(var j=0;j<fields.length;j++){if(allCustomFields[i].name==fields[j].name){if(allCustomFields[i].field_type=="CONTACT"){fields[j].custom_field_type="CONTACT"}else{if(allCustomFields[i].field_type=="COMPANY"){fields[j].custom_field_type="COMPANY"}}finalFields.push(fields[j]);break}}}}}}else{for(var k=0;k<fields.length;k++){finalFields.push(fields[k])}}}else{for(var k=0;k<formulaFields.length;k++){finalFields.push(formulaFields[k])}}return finalFields}$(function(){Handlebars.registerHelper("getPropertyValue",function(f,g){return getPropertyValue(f,g)});Handlebars.registerHelper("getSystemPropertyValue",function(f,g){return getSystemPropertyValue(f,g)});Handlebars.registerHelper("stripeCreditConvertion",function(f){if(f==0){return(f)}else{if(f>0){return("-"+parseFloat(f/100))}else{return(Math.abs(parseFloat(f/100)))}}});Handlebars.registerHelper("getPropertyValueExists",function(g,h,f){return getPropertyValueByCheckingExistance(g,h,f)});Handlebars.registerHelper("checkPropertyValueExistance",function(f,g,h){return checkPropertyValueExistance(f,g,h)});Handlebars.registerHelper("getMarginLength",function(f,g){return getMarginLength(f,g)});Handlebars.registerHelper("getPropertyValueInCheckbox",function(f,g,j,h){return getPropertyValueInCheckbox(f,g,j,h)});Handlebars.registerHelper("get_correct_count",function(f){return f-1});Handlebars.registerHelper("getPropertyValueBySubtype",function(g,h,f){return getPropertyValueBySubtype(g,h,f)});Handlebars.registerHelper("getPropertyValueBytype",function(g,h,j,f){return getPropertyValueBytype(g,h,j,f)});Handlebars.registerHelper("getTwitterHandleByURL",function(f){f=f.substring(f.lastIndexOf("/")+1);console.log(f);return f});Handlebars.registerHelper("getContactCustomProperties",function(g,h){var f=getContactCustomProperties(g);if(f.length==0){return h.inverse(f)}return h.fn(f)});Handlebars.registerHelper("getContactCustomPropertiesExclusively",function(h,j){var l=["LINKEDIN","TWITTER"];var m=["title"];var g=getContactCustomProperties(h);var f=[];for(var k=0;k<g.length;k++){if(jQuery.inArray(g[k].name,m)!=-1||(g[k].subtype&&jQuery.inArray(g[k].subtype,l)!=-1)){continue}f.push(jQuery.extend(true,{},g[k]))}if(f.length==0){return j.inverse(f)}$.getJSON("core/api/custom-fields/type/DATE",function(s){if(s.length==0){return}for(var n=0;n<s.length;n++){for(var o=0;o<f.length;o++){if(f[o].name==s[n].field_label){try{var q=f[o].value;if(!isNaN(q)){f[o].value=q;f[o]["subtype"]=s[n].field_type}}catch(p){f[o].value=f[o].value}}}}updateCustomData(j.fn(f))});return j.fn(f)});Handlebars.registerHelper("getCompanyCustomPropertiesExclusively",function(h,j){var l=["LINKEDIN","TWITTER"];var m=["title"];var g=getCompanyCustomProperties(h);var f=[];for(var k=0;k<g.length;k++){if(jQuery.inArray(g[k].name,m)!=-1||(g[k].subtype&&jQuery.inArray(g[k].subtype,l)!=-1)){continue}f.push(jQuery.extend(true,{},g[k]))}if(f.length==0){return j.inverse(f)}$.getJSON("core/api/custom-fields/type/DATE",function(s){if(s.length==0){return}for(var n=0;n<s.length;n++){for(var o=0;o<f.length;o++){if(f[o].name==s[n].field_label){try{var q=f[o].value;if(!isNaN(q)){f[o].value=q;f[o]["subtype"]=s[n].field_type}}catch(p){f[o].value=f[o].value}}}}updateCompanyCustomData(j.fn(f))});return j.fn(f)});Handlebars.registerHelper("urlEncode",function(g,h,k){var f="&";if(g.indexOf("?")!=-1){f="&"}var j=g+f+h+"="+escape(JSON.stringify(k));return j});Handlebars.registerHelper("hasTagPermission",function(f){if(ACCOUNT_PREFS.tagsPermission){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("encodeString",function(f){return encodeURIComponent(f)});Handlebars.registerHelper("gravatarurl",function(o,g,p){if(o==undefined){return}var f=getPropertyValue(o,"image");if(f){return f}var k=DEFAULT_GRAVATAR_url;var l="&d="+DEFAULT_GRAVARTAR_IMG+'" ';var h="";try{h=text_gravatar_initials(o,p)}catch(m){console.log(m)}if(h.length==0){l="&d="+DEFAULT_GRAVATAR_url+'" '}var j="";j='onLoad="image_load(this)" _data-name="'+h;var n=getPropertyValue(o,"email");if(n){return new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5(n)+".jpg?s="+g+l+j)}return new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+g+""+l+j)});Handlebars.registerHelper("defaultGravatarurl",function(g){var f=DEFAULT_GRAVATAR_url;return"https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+g+"&d="+escape(f)});Handlebars.registerHelper("emailGravatarurl",function(h,g){var f=DEFAULT_GRAVATAR_url;if(g){return"https://secure.gravatar.com/avatar/"+Agile_MD5(g)+".jpg?s="+h+"&d="+escape(f)}return"https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+h+"&d="+escape(f)});Handlebars.registerHelper("nameAvatar",function(f,h){if(f==undefined){return}var j=getPropertyValue(f,"image");if(j){return j}var g=getPropertyValue(f,"email");if(g){return"https://secure.gravatar.com/avatar/"+Agile_MD5(g)+".jpg?s="+h+"&d=404"}return"https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+h+"&d=404"});Handlebars.registerHelper("dataNameAvatar",function(f,g){if(f==undefined){return}return text_gravatar_initials(f,g)});Handlebars.registerHelper("icons",function(f){if(!f){return""}f=f.toLowerCase().trim();console.log(f);if(f=="email"){return"fa-envelope-o"}if(f=="phone"){return"fa-headphones"}if(f=="url"){return"fa-home"}if(f=="call"){return"fa-phone"}if(f=="follow_up"){return"fa-sign-out"}if(f=="meeting"){return"fa-group"}if(f=="milestone"){return"fa-cog"}if(f=="send"){return"fa-reply"}if(f=="tweet"){return"fa-share-square-o"}if(f=="other"){return"fa-tasks"}if(f=="twitter"){return"fa-twitter"}if(f=="facebook"){return"fa-facebook"}});Handlebars.registerHelper("eachkeys",function(j,h){var k=h.fn,f=h.inverse;var g="";var l=true;for(key in j){l=false;break}if(!l){for(key in j){g=g+k({key:key,value:j[key]})}}else{g=f(this)}return g});Handlebars.registerHelper("ucfirst",function(f){return(f&&typeof f==="string")?(f.charAt(0).toUpperCase()+f.slice(1).toLowerCase()):""});Handlebars.registerHelper("contactShortName",function(){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model&&!company_util.isCompany()){var g=App_Contacts.contactDetailView.model.get("properties");if(App_Contacts.contactDetailView.model.get("type")=="PERSON"){var f;for(var h=0;h<g.length;h++){if(g[h].name=="last_name"){f=g[h].value}else{if(g[h].name=="first_name"){return g[h].value}}}if(f&&f!=null){return f}return"Contact"}else{for(var h=0;h<g.length;h++){if(g[h].name=="name"){return g[h].value}}return"Company"}}else{if(App_Companies.companyDetailView&&App_Companies.companyDetailView.model){var g=App_Companies.companyDetailView.model.get("properties");for(var h=0;h<g.length;h++){if(g[h].name=="name"){return g[h].value}}return"Company"}}});Handlebars.registerHelper("isCompany",function(f){if(company_util.isCompany()){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("workflowName",function(){if(App_Workflows.workflow_model){var f=App_Workflows.workflow_model.get("name");return"'"+f+"'"}return"this"});Handlebars.registerHelper("task_property",function(f){if(f=="FOLLOW_UP"){return"Follow Up"}else{return ucfirst(f)}});Handlebars.registerHelper("show_custom_fields_for_merge",function(g,h){var f=show_custom_fields_helper_for_merge(g,h);return new Handlebars.SafeString(f)});Handlebars.registerHelper("add_dots_end",function(g){if(g){if(g.length>100){var f=g.substr(0,100);f=f+"....";return f}}return g});Handlebars.registerHelper("tagslist",function(n){console.log(n);var m={};for(var h=0;h<n.length;h++){var o=n[h].tag;var g=o.charAt(0).toUpperCase();var k=new Array();if(m[g]!=undefined){k=m[g]}k.push(o);m[g]=k}var l=Object.keys(m);l.sort();var j="";for(var h in l){var k=m[l[h]];j+="<div class='tag-element'><div class='tag-key'>"+l[h]+"</div> ";j+="<div class='tag-values'>";for(var h=0;h<k.length;h++){console.log("************************");console.log(k[h]);var f="#tags/"+encodeURIComponent(k[h]);j+=('<a href="'+f+'" >'+k[h]+"</a> ")}j+="</div></div>"
}return j});Handlebars.registerHelper("setupTags",function(g){console.log(g);var l={};var m=[];for(var k=0;k<g.length;k++){var f=g[k].tag;var j=f.charAt(0).toUpperCase();if(jQuery.inArray(j,m)==-1){m.push(j)}}m.sort();console.log(m);var h="";for(var k=0;k<m.length;k++){h+="<div class='tag-element' style='margin-right:10px;'><div class='tag-key'>"+m[k]+"</div><div class='tag-values' tag-alphabet=\""+encodeURI(m[k])+'"></div></div>'}return new Handlebars.SafeString(h)});Handlebars.registerHelper("deals_by_milestones",function(h){var f="";var g=Object.keys(h).length;$.each(h,function(k,l){if(g==1&&k==""){f+='<div class="alert-info alert"><div class="slate-content"><div class="box-left pull-left m-r-md"><img alt="Clipboard" src="'+updateImageS3Path("/img/clipboard.png")+'"></div><div class="box-right pull-left"><h4 class="m-t-none">You have no milestones defined</h4><br><a href="#milestones" class="btn btn-default btn-sm m-t-xs"><i class="icon icon-plus-sign"></i> Add Milestones</a></div><div class="clearfix"></div></div></div>'}else{f+="<div class='milestone-column'><div class='dealtitle-angular'><p class='milestone-heading'>"+k+"</p><span></span></div><ul class='milestones' milestone='"+k+"'>";for(var j in l){if(l[j].id){f+="<li id='"+l[j].id+"'>"+getTemplate("opportunities-grid-view",l[j])+"</li>"}}f+="</ul></div>"}});return f});Handlebars.registerHelper("milestone_ul",function(l){var j="";var h="Deals with this milestone are considered as Won.";var k="Deals with this milestone are considered as Lost.";if(l){var g=l.milestones.split(",");for(var f in g){j+="<tr data='"+g[f]+"' style='display: table-row;'><td><div class='milestone-name-block inline-block v-top text-ellipsis' style='width:80%'>";if(g[f]==l.won_milestone){j+=g[f]+"<i data-toogle='tooltip' title='"+h+"' class='icon-like mark-won m-l-sm'></i></div></td><td class='b-r-none'><div class='m-b-n-xs'>";j+="<a class='milestone-won text-l-none-hover c-p text-xs hover-show disabled' style='visibility:hidden;' data-toggle='tooltip' title='Set as Won Milestone'><i class='icon-like'></i></a>";j+="<a class='milestone-lost text-l-none-hover c-p text-xs m-l-sm not-applicable hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Lost Milestone'><i class='icon-dislike'></i></a>"}else{if(g[f]==l.lost_milestone){j+=g[f]+"<i data-toogle='tooltip' title='"+k+"' class='icon-dislike mark-lost m-l-sm'></i></div></td><td class='b-r-none'><div class='m-b-n-xs'>";j+="<a class='milestone-won text-l-none-hover c-p text-xs not-applicable hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Won Milestone'><i class='icon-like'></i></a>";j+="<a class='milestone-lost text-l-none-hover c-p text-xs m-l-sm hover-show disabled' style='visibility:hidden;' data-toggle='tooltip' title='Set as Lost Milestone'><i class='icon-dislike'></i></a>"}else{j+=g[f]+"</div></td><td class='b-r-none'><div class='m-b-n-xs'>";j+="<a class='milestone-won text-l-none-hover c-p text-xs hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Won Milestone'><i class='icon-like'></i></a>";j+="<a class='milestone-lost text-l-none-hover c-p text-xs m-l-sm hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Set as Lost Milestone'><i class='icon-dislike'></i></a>"}}j+="<a class='milestone-delete c-p m-l-sm text-l-none text-xs hover-show' style='visibility:hidden;' data-toggle='tooltip' title='Delete Milestone'><i class='icon icon-trash'></i></a><a class='text-l-none-hover c-p text-xs m-l-sm hover-show' style='visibility:hidden;'><i title='Drag' class='icon-move'></i></a></div></td></tr>"}}return j});Handlebars.registerHelper("epochToHumanDate",function(h,f){if(!h){h="mmm dd yyyy HH:MM:ss"}if(!f){return}console.log(h+" : "+f);if((f/100000000000)>1){return new Date(parseInt(f)).format(h,0)}var j="";try{j=new Date(parseInt(f)*1000).format(h)}catch(g){console.log("Invalid date for custom field.")}return j});Handlebars.registerHelper("paypalInvoiceDate",function(h,f){if(f){var g=f.replace(/-/g,"//");if(!h){h="ddd mmm dd yyyy"}var j=new Date(g).format(h);return j}});Handlebars.registerHelper("decodeString",function(f){return f});Handlebars.registerHelper("uservoicedate",function(g){if(g){var f=new Date(g);f=(f.getMonth()+1)+"/"+f.getDate()+"/"+f.getFullYear()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();return f}});Handlebars.registerHelper("epochToHumanDateInFormat",function(f){if(!f){return}return getDateInFormatFromEpoc(f)});Handlebars.registerHelper("dateFormat",function(){return _agile_get_translated_val("contacts","select-date")});Handlebars.registerHelper("currentDateInFormat",function(f){if(!f){return}f=f.replace(/MM/g,"mmmm").replace(/M/g,"mmm").replace(/DD/g,"dddd").replace(/D/g,"ddd");return new Date().format(f)});Handlebars.registerHelper("stringToHumanDateInFormat",function(f){if(!f){return}var g=new Date(f);if(g=="Invalid Date"){return getDateInFormatFromEpoc(f)}else{return en.dateFormatter({raw:getGlobalizeFormat()})(g)}});Handlebars.registerHelper("toLocalTimezone",function(g){var f=new Date(g);return f.toDateString()+" "+f.toLocaleTimeString()});Handlebars.registerHelper("toLocalTimezoneFromUtc",function(g){var f=new Date(g+" GMT+0000");return f.toDateString()+" "+f.toLocaleTimeString()});Handlebars.registerHelper("epochToTaskDate",function(f){try{f=parseInt(f)}catch(j){}var h,k;if((f/100000000000)>1){h=new Date(f).getMonth();k=new Date(f).getDate()}else{h=new Date(parseInt(f)*1000).getMonth();k=new Date(parseInt(f)*1000).getDate()}var g=["Jan","Feb","March","April","May","June","July","Aug","Sept","Oct","Nov","Dec"];return(_agile_get_translated_val("months-xs",g[h])+" "+k)});Handlebars.registerHelper("task_label_color",function(f){if(f=="HIGH"||f=="red"){return"danger"}if(f=="NORMAL"||f=="#36C"){return"info"}if(f=="LOW"){return"label bg-light dk"}if(f=="green"){return"success"}});Handlebars.registerHelper("event_priority",function(f){if(f=="red"||f=="#f05050"){return"High"}if(f=="#36C"||f=="#23b7e5"||f=="blue"){return"Normal"}if(f=="green"||f=="#bbb"){return"Low"}});Handlebars.registerHelper("event_label_color",function(f){if(f=="red"||f=="#f05050"){return"danger"}if(f=="#36C"||f=="#23b7e5"||f=="blue"){return"primary"}if(f=="green"||f=="#bbb"){return"warning"}});Handlebars.registerHelper("network",function(f){if(f=="GOOGLE"){return"Google Drive"}if(f=="S3"){return"Uploaded Doc"}});Handlebars.registerHelper("epochToDate",function(f,h){var l=JSON.parse(f);if(!l[h]){return"-"}if(h){if((l[h]/100000000000)>1){return new Date(parseInt(l[h])).format("mmm dd yyyy HH:MM:ss",0)}return new Date(parseInt(l[h])*1000).format("mmm dd yyyy HH:MM:ss",0)}else{var k=new Date(parseInt(l[h])*1000).getMonth();var m=new Date(parseInt(l[h])*1000).getDate();var j=new Date(parseInt(l[h])*1000).getFullYear();var g=["Jan","Feb","March","April","May","June","July","Aug","Sept","Oct","Nov","Dec"];return(_agile_get_translated_val("months-xs",g[k])+" "+m+", "+j)}});Handlebars.registerHelper("currencySymbol",function(){var g=((CURRENT_USER_PREFS.currency!=null)?CURRENT_USER_PREFS.currency:"USD-$");var f=((g.length<4)?"$":g.substring(4,g.length));if(f=="Rs"){f="Rs."}return f});Handlebars.registerHelper("mandrill_exist",function(f){if(IS_HAVING_MANDRILL){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("calculatePipeline",function(g,h){var f=parseInt(g)*parseInt(h)/100;return f});Handlebars.registerHelper("getRequiredLog",function(j,h){var f=JSON.parse(j);if(h=="t"){var g=new Date(f[0][h]*1000);return g}return f[0][h]});Handlebars.registerHelper("iscompactTabel",function(h,f){var g=(h!="PERSON")?_agile_get_prefs("companyTabelView"):_agile_get_prefs("contactTabelView");if(g){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("iscompactContactTabel",function(f){if(_agile_get_prefs("contactTabelView")){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("contactTableHeadings",function(h){var g="",f="";$.each(App_Contacts.contactViewModel[h],function(j,k){if(k=="basic_info"||k=="image"){if(_agile_get_prefs("contactTabelView")){if(k=="basic_info"){return}if(k=="image"){k="";f=""}}else{if(k=="image"){k="";f="compactcontact"}if(k=="basic_info"){k="Basic Info"}}}else{if(k.indexOf("CUSTOM_")==0){k=k.split("_")[1];f="text-muted"}else{k=k.replace("_"," ");f=""}}k=getTableLanguageConvertHeader(k);g=g.concat('<th class="'+f+'">'+ucfirst(k)+"</th>")});return new Handlebars.SafeString(g)});Handlebars.registerHelper("reportsContactTableHeadings",function(g){var f="";$.each(REPORT[g],function(h,j){if(j.indexOf("properties_")!=-1){j=j.split("properties_")[1]}if(j.indexOf("custom_")==0){j=j.split("custom_")[1]}j=j.replace("_"," ");f=f.concat("<th>"+ucfirst(j)+"</th>")});return new Handlebars.SafeString(f)});Handlebars.registerHelper("if_entity",function(g,f){if(this.entity_type==g){return f.fn(this)}if(!this.entity&&this[g]!=undefined){return f.fn(this)}});Handlebars.registerHelper("titleFromEnums",function(f){if(!f){return}var g=f.replace(/_/g," ");return ucfirst(g.toLowerCase())});Handlebars.registerHelper("actionTemplate",function(j){if(!j){return}var h={MODAL_POPUP:"Modal Popup",CORNER_NOTY:"Noty Message",CALL_POPUP:"Call Popup",SITE_BAR:"Site Bar",ASSIGN_CAMPAIGN:"Add to Campaign",UNSUBSCRIBE_CAMPAIGN:"Remove from Campaign",ADD_TAG:"Add Tag",REMOVE_TAG:"Remove Tag",ADD_SCORE:"Add Score",SUBTRACT_SCORE:"Substract Score",JAVA_SCRIPT:"Java Script",};var f=j.length;var g='<div class="table-resp">';$.each(j,function(k,l){if(--f==0){g=g.concat(titleFromEnums(h[l.action]?h[l.action]:l.action));return}g=g.concat(titleFromEnums(h[l.action]?h[l.action]:l.action)+", ")});g=g.concat("</div>");return new Handlebars.SafeString(g)});Handlebars.registerHelper("triggerType",function(g){var f={TAG_IS_ADDED:"Tag is added",TAG_IS_DELETED:"Tag is deleted",CONTACT_IS_ADDED:"Contact is added",DEAL_IS_ADDED:"Deal is added",DEAL_IS_DELETED:"Deal is deleted",DEAL_MILESTONE_IS_CHANGED:"Deal milestone is changed",RUNS_DAILY:"Daily",RUNS_WEEKLY:"Weekly",RUNS_MONTHLY:"Monthly",STRIPE_CHARGE_EVENT:"Stripe Event",INBOUND_MAIL_EVENT:"New Email",EMAIL_OPENED:"Email Opened",EMAIL_LINK_CLICKED:"Email Link Clicked",UNSUBSCRIBED:"Unsubscribed",SOFT_BOUNCE:"Soft Bounce",HARD_BOUNCE:"Hard Bounce",SPAM_REPORT:"Spam Report",EVENT_IS_ADDED:"Event is added",INBOUND_CALL:"Inbound Call",OUTBOUND_CALL:"Outbound Call",SHOPIFY_EVENT:"Shopify Event",FORM_SUBMIT:"Form Submit",NEW_TICKET_IS_ADDED:"New ticket is added",TICKET_NOTE_ADDED_BY_USER:"Note is added by user",TICKET_NOTE_ADDED_BY_CUSTOMER:"Note is added by customer",TICKET_IS_CLOSED:"Ticket is closed",TICKET_SLA_REACHED:"SLA reached",TICKET_ASSIGNEE_CHANGED:"Ticket assignee changed",TICKET_LABEL_IS_ADDED:"Ticket label is added",TICKET_LABEL_IS_DELETED:"Ticket label is deleted",};
if(g=="ADD_SCORE"){return g.replace("ADD_SCORE","Score (>=)")}if(f[g]){return titleFromEnums(f[g])}return titleFromEnums(g)});Handlebars.registerHelper("if_notification_type",function(){if(this.type=="COMPANY"){var f=this.notification.split("_");var g=ucfirst(f[0].replace("CONTACT","COMPANY"))+" "+ucfirst(f[1]);return" - "+g}var j=this.notification.replace(/_/," ");switch(j){case"IS BROWSING":return j.toLowerCase()+" "+this.custom_value;case"CLICKED LINK":var h=JSON.parse(this.custom_value);if(h.workflow_name==undefined){return j.toLowerCase()+" "+h.url_clicked}return j.toLowerCase()+" "+h.url_clicked+'  of campaign "'+h.workflow_name+'"';case"OPENED EMAIL":var h=JSON.parse(this.custom_value);if(h.hasOwnProperty("workflow_name")){return j.toLowerCase()+'  of campaign "'+h.workflow_name+'"'}return j.toLowerCase()+' with subject "'+h.email_subject+'"';case"CONTACT ADDED":return" - "+ucfirst(j.split(" ")[0])+" "+ucfirst(j.split(" ")[1]);case"CONTACT DELETED":return" - "+ucfirst(j.split(" ")[0])+" "+ucfirst(j.split(" ")[1]);case"DEAL CREATED":return" - "+ucfirst(j.split(" ")[0])+" "+ucfirst(j.split(" ")[1]);case"DEAL CLOSED":return" - "+ucfirst(j.split(" ")[0])+" "+ucfirst(j.split(" ")[1]);case"TAG ADDED":return' - "'+this.custom_value+'" '+j.toLowerCase().split(" ")[0]+" has been "+j.toLowerCase().split(" ")[1];case"TAG DELETED":return' - "'+this.custom_value+'" '+j.toLowerCase().split(" ")[0]+" has been "+j.toLowerCase().split(" ")[1];default:return j.toLowerCase()}});Handlebars.registerHelper("epochToLogDate",function(f){return new Date(f*1000)});Handlebars.registerHelper("getCountryName",function(f){return getCode(f)});Handlebars.registerHelper("replace_plus_symbol",function(f){return f.replace(/\+/," ")});Handlebars.registerHelper("replace_minus_symbol",function(f){return f.replace(/\-/,"")});Handlebars.registerHelper("get_amount_with_possitive",function(f){if(f<0){return f/100*(-1)}else{return f/100}});Handlebars.registerHelper("removeSlash",function(f){if(f=="A/B"){return f.replace(/\//,"")}return f});Handlebars.registerHelper("if_property",function(g,m,l,n,h,k,j,f,o,p){if(this.name!=g&&this.name!=m&&this.name!=l&&this.name!=n&&this.name!=h&&this.name!=k&&this.name!=j&&this.name!=f&&this.name!=o){return p.fn(this)}});Handlebars.registerHelper("property_is_exists",function(g,h,f){if(getPropertyValue(h,g)){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("property_json_is_not_empty",function(g,h,f){var j=getPropertyValue(h,g);if(!j){return f.inverse(this)}try{j=JSON.parse(j)}catch(k){}if(j&&Object.keys(j)&&Object.keys(j).length>0){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("online_schedule_URL",function(){return ONLINE_SCHEDULING_URL});Handlebars.registerHelper("get_current_domain",function(){return CURRENT_DOMAIN_USER.domain});Handlebars.registerHelper("get_current_domain_email",function(){return CURRENT_DOMAIN_USER.email});Handlebars.registerHelper("get_current_domain_pic",function(){return CURRENT_DOMAIN_USER.pic});Handlebars.registerHelper("get_current_domain_name",function(){var f=CURRENT_DOMAIN_USER.name;return f.charAt(0).toUpperCase()+f.slice(1)});Handlebars.registerHelper("getPropertyFromUser",function(f){if(f){return CURRENT_DOMAIN_USER[f]}else{return""}});Handlebars.registerHelper("getAffiliateLink",function(f){var g="<a href='https://my.agilecrm.com/register?utm_affiliate="+CURRENT_DOMAIN_USER.id+"' target='_blank'><img alt='AgileCRM' src='"+f+"'/></a>";return g});Handlebars.registerHelper("comma_in_between_property",function(g,f,j,h){if(getPropertyValue(j,g)&&getPropertyValue(j,f)){return","}});Handlebars.registerHelper("property_subtype_is_exists",function(h,f,j,g){if(getPropertyValueBySubtype(j,h,f)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("multiple_Property_Element",function(g,h,f){var j=agile_crm_get_contact_properties_list(g);if(j.length>0){return f.fn(j)}});Handlebars.registerHelper("multiple_Company_Property_Element",function(g,h,f){var j=company_util.agile_crm_get_company_properties_list(g);if(j.length>0){return f.fn(j)}});Handlebars.registerHelper("address_Element",function(k){var f=0;for(var j=0,h=k.length;j<h;j++){if(k[j].name=="address"){var m="";var g={};try{g=JSON.parse(k[j].value)}catch(o){g.address=k[j].value}var n=countJsonProperties(g);if(f!=0){m=m.concat('<div class="contact-addressview text-xs"><div><div class="pull-left hide text-xs" style="width:18px"><i class="icon icon-pointer"></i></div><div class="custom-color text-xs">')}else{m=m.concat('<div class="contact-addressview text-xs"><div><div class="pull-left hide text-xs" style="width:18px"><i class="icon icon-pointer"></i></div><div class="custom-color text-xs">')}if(g.address!==undefined){m=m.concat(g.address+", ")}if(g.city!==undefined){m=m.concat(g.city+", ")}if(g.state!==undefined){m=m.concat(g.state+", ")}if(g.zip!==undefined){m=m.concat(g.zip+", ")}if(g.country!==undefined){m=m.concat(g.country+".")}if(k[j].subtype){m=m.concat('<span class="label bg-light dk text-tiny">'+k[j].subtype+"</span>")}m=m.concat('</span>&nbsp;<span id="map_view_action"></span></div></div>');return new Handlebars.SafeString(m)}else{if(k[j].name=="phone"||k[j].name=="email"){++f}}}});Handlebars.registerHelper("address_Template",function(j){for(var h=0,g=j.length;h<g;h++){if(j[h].name=="address"){var k="";var f={};try{f=JSON.parse(j[h].value)}catch(n){f.address=j[h].value}var m=countJsonProperties(f);$.each(f,function(l,o){if(--m==0){k=k.concat(o+".");return}k=k.concat(o+", ")});return new Handlebars.SafeString(k)}}});Handlebars.registerHelper("numberWithCommas",function(f){if(f==0){return f}if(f){return f.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}});Handlebars.registerHelper("field_Element",function(f){var g="";var h=f.length;$.each(f,function(j,k){if(k.indexOf("properties_")!=-1){k=k.split("properties_")[1]}else{if(k.indexOf("custom_")!=-1){k=k.split("custom_")[1]}else{if(k.indexOf("CUSTOM_")!=-1){k=k.split("CUSTOM_")[1]}else{if(k=="created_time"){k="Created Date"}else{if(k=="updated_time"){k="Updated Date"}}}}}k=k.replace("_"," ");k=getTableLanguageConvertHeader(k);if(--h==0){g=g.concat(k);return}g=g.concat(k+", ")});return new Handlebars.SafeString(g)});Handlebars.registerHelper("stringToJSON",function(g,h,f){console.log(g);console.log(h);if(h){try{g[h]=JSON.parse(g[h])}finally{return f.fn(g[h])}}try{return f.fn(JSON.parse(g))}catch(j){return f.fn(g)}});Handlebars.registerHelper("if_propertyName",function(g,f){var h=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;if(value.search(h)!=-1){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("show_link_in_statement",function(g){if(g){g=g.replace(/</g,"&lt;").replace(/>/g,"&gt;")}var h=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;try{g=g.replace(h,"<a href='$1' target='_blank' class='cd_hyperlink'>$1</a>");return new Handlebars.SafeString(g)}catch(f){return g}});Handlebars.registerHelper("displayPlan",function(f){return ucfirst(f).replaceAll("_"," ")});Handlebars.registerHelper("displayPlainText",function(f){return f.split("_").join(" ")});Handlebars.registerHelper("displayTaskStatus",function(f){var g=f.split("_").join("").trim().toLowerCase();if(g=="yettostart"){return _agile_get_translated_val("misc-keys","yet-to-start")}else{return ucfirst(f.split("_").join(" ").trim())}});Handlebars.registerHelper("getCurrentContactProperty",function(g){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var f=App_Contacts.contactDetailView.model.get("properties");console.log(App_Contacts.contactDetailView.model.toJSON());return getPropertyValue(f,g)}});Handlebars.registerHelper("getCurrentCompanyProperty",function(g){if(App_Companies.companyDetailView&&App_Companies.companyDetailView.model){var f=App_Companies.companyDetailView.model.get("properties");console.log(App_Companies.companyDetailView.model.toJSON());return getPropertyValue(f,g)}});Handlebars.registerHelper("safe_string",function(f){if(f&&f.indexOf("Tweet about Agile")==-1&&f.indexOf("Like Agile on Facebook")==-1){f=f.replace(/</g,"&lt;").replace(/>/g,"&gt;")}f=f.replace(/\n/,"<br/>");return new Handlebars.SafeString(f)});Handlebars.registerHelper("string_to_date",function(g,f){return new Date(f).format(g)});Handlebars.registerHelper("isArray",function(g,f){if(isArray(g)){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("is_string",function(g,f){if(typeof g=="string"){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("bindData",function(f){return JSON.stringify(f)});Handlebars.registerHelper("getCurrentUserPrefs",function(f){if(CURRENT_USER_PREFS){}return f.fn(CURRENT_USER_PREFS)});Handlebars.registerHelper("getCurrentDomain",function(g){var f=window.location.host;var h=/(\.)/;if(f.search(h)>=0){return f.split(h)[0]}return" "});Handlebars.registerHelper("getBase64Domain",function(){return window.btoa(window.location.host.split(".")[0])});Handlebars.registerHelper("getBase64ActualDomain",function(){return window.btoa(CURRENT_DOMAIN_USER.domain)});Handlebars.registerHelper("extractEmail",function(g,f){console.log(g);return f.fn(g.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)[0])});Handlebars.registerHelper("getCurrentContactPropertyBlock",function(h,g){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var f=App_Contacts.contactDetailView.model.get("properties");console.log(App_Contacts.contactDetailView.model.toJSON());return g.fn(getPropertyValue(f,h))}});Handlebars.registerHelper("isDuplicateContactProperty",function(k,j,h){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model&&Current_Route.indexOf("contact/")==0){var g=App_Contacts.contactDetailView.model.get("properties");var f=getPropertyValue(g,j);var l=getPropertyValue(k,j);if(!f||!l){f=getPropertyValue(g,"first_name")+" "+getPropertyValue(g,"last_name");l=getPropertyValue(k,"first_name")+" "+getPropertyValue(k,"last_name")
}if(App_Contacts.contactDetailView.model.get("type")=="COMPANY"){f=getPropertyValue(g,"name");l=getPropertyValue(k,"name")}if(f==l){return h.fn(this)}return h.inverse(this)}if(App_Companies.companyDetailView&&App_Companies.companyDetailView.model&&Current_Route.indexOf("company/")==0){var g=App_Companies.companyDetailView.model.get("properties");var f=getPropertyValue(g,j);var l=getPropertyValue(k,j);if(!f||!l){f=getPropertyValue(g,"first_name")+" "+getPropertyValue(g,"last_name");l=getPropertyValue(k,"first_name")+" "+getPropertyValue(k,"last_name")}if(App_Companies.companyDetailView.model.get("type")=="COMPANY"){f=getPropertyValue(g,"name");l=getPropertyValue(k,"name")}if(f&&l&&f.toLowerCase()==l.toLowerCase()){return h.fn(this)}return h.inverse(this)}});Handlebars.registerHelper("containString",function(g,h,f){if(h.search(g)!=-1){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("is_emailPlan",function(g,f){if(g.search("email")!=-1){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("is_userPlan",function(g,f){if(g.search("email")!=-1){return f.inverse(this)}return f.fn(this)});Handlebars.registerHelper("numeric_operation",function(j,h,g){var f="/*-+";if(f.indexOf(g)==-1){return""}if(g=="+"){return j+h}if(g=="-"){return j-h}if(g=="*"){return j*h}if(g=="/"){return j/h}});Handlebars.registerHelper("get_total_amount",function(g,f){return(g/100)*f});Handlebars.registerHelper("check_length",function(h,g,f){if(parseInt(h.length)>parseInt(g)){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("get_unrefunded_amount",function(g,f){return(g-f)/100});Handlebars.registerHelper("check_json_length",function(h,g,f){var k=0;for(var j in h){k++}if(k==parseInt(g)){for(var j in h){return f.fn({property:j,value:h[j],last:true})}}return f.inverse(h)});Handlebars.registerHelper("iterate_json",function(h,g){var f="";var k=0;var j=0;for(var l in h){j++}for(var l in h){k++;if(k==j){f=f+g.fn({property:l,value:h[l],last:true})}else{f=f+g.fn({property:l,value:h[l],last:false})}}console.log(f);return f});Handlebars.registerHelper("get_social_icon",function(f){return get_social_icon(f)});Handlebars.registerHelper("each_with_index",function(m,h){var f="";for(var k=0,g=m.length;k<g;k++){var l=m[k];l.index=k+1;console.log(l);f+=h.fn(l)}return f});Handlebars.registerHelper("if_json",function(h,f){try{var g=$.parseJSON(h);if(typeof g==="object"){return f.fn(this)}return f.inverse(this)}catch(j){return f.inverse(this)}});Handlebars.registerHelper("add_tag",function(f){addTagAgile(f)});Handlebars.registerHelper("set_up_dashboard_padcontent",function(f){return new Handlebars.SafeString(getTemplate("empty-collection-model",CONTENT_JSON.dashboard[f]))});Handlebars.registerHelper("removeSquareBrackets",function(f){return f.replace(/[\[\]]+/g,"")});Handlebars.registerHelper("removeDoubleCoutes",function(h){var f=h.replace(/[\[\]]+/g,"");var g=f.replace(/"/g,"'");return g});Handlebars.registerHelper("toLinkTrigger",function(l,h){var g="";for(var k=0,f=l.length;k<f;k++){g=g+h.fn(l[k]);if(k<f-1){g=g+", "}}return g});Handlebars.registerHelper("millSecondsToMinutes",function(g){if(isNaN(g)){return}var h=g/1000;var f=Math.floor(h/60);if(f<1){return Math.ceil(h)+" mins"}var j=Math.ceil(h%60);return f+" mins, "+j+" secs"});Handlebars.registerHelper("if_overflow",function(j,f,g){if(!j){return}console.log($("#Linkedin").width());j=j.trim();var h=$("<div style='width:"+$("#Linkedin").width()+"px;word-break:normal;word-wrap:break-word;display:none;'>"+j+"</div>");$("#content").append(h);console.log(h.height()+" "+parseInt(f));if(h.height()>parseInt(f)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("setupRating",function(h){var g="";for(var f=0;f<5;f++){if(f<parseInt(h)){g=g.concat('<li style="display: inline;"><img src="'+updateImageS3Path("img/star-on.png")+'" alt="'+f+'"></li>');continue}g=g.concat('<li style="display: inline;"><img src="'+updateImageS3Path("img/star-off.png")+'" alt="'+f+'"></li>')}return new Handlebars.SafeString(g)});Handlebars.registerHelper("setupCSVUploadOptions",function(j,m,f){var l;if(j=="contacts"){l=$(getTemplate("csv_upload_options",f))}else{if(j=="company"){l=$(getTemplate("csv_companies_upload_options",f))}else{if(j=="deals"){l=$(getTemplate("csv_deals_options",f))}}}m=m.replace("_"," ");var n=false;var o=0;var k=m.length;var m=m.toLowerCase();var g;var p;l.find("option").each(function(q,s){if($(s).text().toLowerCase().indexOf(m)!=-1){var t=k/$(s).text().length;if(o>=t){return}p=$(s);g=$(s).text();o=t}});console.log(g+", "+m+" : "+o);for(var h=0;h<m.length-3;h++){l.find("option").each(function(q,s){if($(s).text().toLowerCase().indexOf(m.substr(0,m.length-h).toLowerCase())!=-1){console.log(m.substr(0,m.length-h)+" , "+$(s).text());var t=m.substr(0,m.length-h).length/$(s).text().length;console.log(t);if(o>=t){return}p=$(s);g=$(s).text();o=t}})}$(p).attr("selected",true);return new Handlebars.SafeString($("<div>").html(l).html())});Handlebars.registerHelper("convertSecondsToHour",function(j){var g=parseInt(j/3600)%24;var h=parseInt(j/60)%60;var k=j%60;if(g==0&&h==0){return(k+"s")}if(g==0){return(h+"m ")+(k+"s")}var f=(g+"h ")+(h+"m ")+(k+"s");return f});Handlebars.registerHelper("checkOriginalRef",function(g){if(!getCurrentContactProperty(g)){return"unknown"}var f=getCurrentContactProperty(g);f=f.split("/");f=(f[0]+"//"+f[2]);return new Handlebars.SafeString('<a style="text-decoration: none" target="_blank" href="'+getCurrentContactProperty(g)+'">'+f+"</a>")});Handlebars.registerHelper("queryWords",function(n){if(getCurrentContactProperty(n)){var l=getCurrentContactProperty(n);var f="www.google.";var k=l.split("/");k=k[2].slice(0,11);if(k===f){var m=document.createElement("a");m.href=l;var h=m.search;if(h.length>1){h=h.split("&");var j=h.length;for(var g=0;g<j;g++){if(h[g].indexOf("q=")!=-1){h=h[g].split("=");return new Handlebars.SafeString("( Keyword : "+h[1].split("+").join(" ")+" )")}}}}else{return}}});Handlebars.registerHelper("contact_name",function(g,h){if(h==="PERSON"){for(var f=0;f<g.length;f++){if(g[f].name==="last_name"){return(getPropertyValue(g,"first_name")+" "+g[f].value)}else{if(g[f].name==="first_name"){return g[f].value}}}return"Contact"}for(var f=0;f<g.length;f++){if(g[f].name==="name"){return g[f].value}}return"Company"});Handlebars.registerHelper("contact_name_necessary",function(f){return getContactName(f)});Handlebars.registerHelper("is_blank",function(g,f){g=g.trim();if(g==""){return f.fn(g)}else{return f.inverse(g)}});Handlebars.registerHelper("each_with_index1",function(m,h){console.log(m);var f="";for(var k=0,g=m.length;k<g;k++){var l={};l.value=m[k];console.log(l);l.index=k+1;console.log(l);f+=h.fn(l)}return f});Handlebars.registerHelper("if_log_type_equals",function(g,h,j,f){if(g[h]==j){return f.fn(g)}return f.inverse(g)});Handlebars.registerHelper("if_email_sent",function(f,l,o){var g="_aGiLeCrM";if(f[l]==="EMAIL_SENT"){var j=f.message.split(g,4);var m={};if(j===undefined){return o.inverse(f)}for(var h=0;h<j.length;h++){var n=j[h].split(":");var l=n[0];l=l.trim();var k=n.slice(1).join(":");k=k.trim();m[l]=k}m.time=f.time;return o.fn(m)}return o.inverse(f)});Handlebars.registerHelper("remove_spaces",function(f){if(f){f=f.replace(/ +/g,"")}return f});Handlebars.registerHelper("replace_spaces",function(f){if(f){f=f.replace(/ +/g,"_")}return f});Handlebars.registerHelper("if_same_campaign",function(j,m,h){var g=j[m];if(m===undefined||g===undefined){return}var l=getIdFromHash();for(var k=0,f=g.length;k<f;k++){if(g[k].campaign_id===l){return h.fn(g[k])}}});Handlebars.registerHelper("if_other_active_campaigns",function(g,j,o){if(g===undefined||g[j]===undefined){return}var f={};var k=[];var m=[];var p=g[j];var n=getIdFromHash();for(var h=0,l=p.length;h<l;h++){if(n===p[h].campaign_id){continue}if(p[h].status.indexOf("ACTIVE")!==-1){k.push(p[h])}if(p[h].status.indexOf("DONE")!==-1){m.push(p[h])}}f.active=k;f.done=m;return o.fn(f)});Handlebars.registerHelper("contact_campaigns",function(k,n,u){if(k===undefined||k[n]===undefined){return}var f={};var j=[];var g=[];var q=[];var v={};var t=k[n];var h=k.campaignStatus;var p={};for(var m=0,o=h.length;m<o;m++){var l=h[m];if(l){p[l.campaign_id]=l.campaign_name}}for(var m=0,o=t.length;m<o;m++){if(t[m].status){if(t[m].status.indexOf("ACTIVE")!==-1){j.push(t[m])}if(t[m].status.indexOf("DONE")!==-1){g.push(t[m])}}var s=false;if(t[m].unsubscribeType){if(typeof email_workflows_list!="undefined"){t[m].campaign_name=email_workflows_list[t[m].campaign_id]}if(t[m].unsubscribeType=="ALL"){if(!s){v.isAll=true;s=true}}q.push(t[m])}}if(q&&q.length>0){v.unsubscribed_campaigns=q}f.active=j;f.done=g;f.unsubscribed=v;return u.fn(f)});Handlebars.registerHelper("normalize_os",function(f){if(f===undefined||f.indexOf("_")===-1){return f}return f.split("_")[0]});Handlebars.registerHelper("hasKey",function(h,g,f){if(h.indexOf(g)==-1){return f.inverse(this)}return f.fn(this)});Handlebars.registerHelper("get_normal_name",function(f){if(!f){return}return getTranslatedPortletName(f)});Handlebars.registerHelper("referedUsersPlan",function(j){var h=[];h=j.plan_type.split("_");var f=h[0].toLowerCase();if(h.length==1){var g=j.quantity+" Users  "+f.charAt(0).toUpperCase()+f.slice(1)}else{var k=h[1].toLowerCase();var g=j.quantity+" Users  "+f.charAt(0).toUpperCase()+f.slice(1)+" ("+k.charAt(0).toUpperCase()+k.slice(1)+")"}return g});Handlebars.registerHelper("user_location",function(){var f=this.city=="?"?"":(this.city+", ");var h=this.region=="?"?"":(this.region+", ");var g=this.country;if(this.city=="?"&&this.region=="?"){g=this.country=="?"?this.city_lat_long:(this.city_lat_long+" ( "+this.country+" )")}return(f+h+g).trim()});Handlebars.registerHelper("trim_space",function(f){if(f===undefined){return f}return f.trim()});Handlebars.registerHelper("get_subaccount_reputation",function(l){var j="bg-light dk text-tiny";var g="Unknown";var f="";if(l>1&&l<40){j="label-danger text-tiny";g="Poor";f="progress-bar-danger"}else{if(l>=40&&l<75){j="label-warning text-tiny";
g="Ok";f="progress-bar-warning"}else{if(l>=75&&l<90){j="label-primary text-tiny";g="Good";f="progress-bar-info"}else{if(l>=90){j="label-success text-tiny";g="Excellent";f="progress-bar-success"}}}}var k={type:j,reputation:g,value:l,badge:f};var h=getTemplate("reputation-progress",k);return h});Handlebars.registerHelper("get_id_from_hash",function(){return getIdFromHash()});Handlebars.registerHelper("isAdmin",function(f){if(CURRENT_DOMAIN_USER.is_admin){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("isNewVersionDomainUser",function(f){if(CURRENT_DOMAIN_USER.version){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("check_plan",function(g,f){console.log(g);if(!_billing_restriction){return f.fn(this)}if(_billing_restriction.currentLimits.planName==g){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("isSafariBrowser",function(f){if(navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Chrome")===-1){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("xeroType",function(f){return(f=="ACCPAY")?"Payable":"Receivable"});Handlebars.registerHelper("xeroTypeToolTip",function(f){return(f=="ACCPAY")?"Payable":"Receivable"});Handlebars.registerHelper("capFirstLetter",function(g){if(g){if(g==="DEFAULT"){return""}else{var f=g.toLowerCase();return f.charAt(0).toUpperCase()+f.slice(1)}}});Handlebars.registerHelper("qbStatus",function(f){console.log(this);console.log(this.TotalAmt);if(f==0){return"Paid"}else{return"Due"}});Handlebars.registerHelper("currencyFormat",function(f){return Number(f).toLocaleString("en")});Handlebars.registerHelper("formatAmount",function(f){f=parseFloat(f);return f.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")});Handlebars.registerHelper("QbDateFormat",function(g){var f=[];f=g.split("-");return f[0]+"-"+f[2]+"-"+f[1]});Handlebars.registerHelper("hasScope",function(f,g){if(CURRENT_DOMAIN_USER.scopes&&$.inArray(f,CURRENT_DOMAIN_USER.scopes)!=-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("hasMenuScope",function(f,g){if(CURRENT_DOMAIN_USER.menu_scopes&&$.inArray(f,CURRENT_DOMAIN_USER.menu_scopes)!=-1){return g.fn(this)}console.log("menuscope "+g.fn(this));return g.inverse(this)});Handlebars.registerHelper("hasRestrictedMenuScope",function(f,g){if(CURRENT_DOMAIN_USER.restricted_scopes&&$.inArray(f,CURRENT_DOMAIN_USER.restricted_scopes)!=-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("isRestrictedMenuScope",function(f,g){if(CURRENT_DOMAIN_USER.restricted_menu_scopes&&$.inArray(f,CURRENT_DOMAIN_USER.restricted_menu_scopes)!=-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("canSyncContacts",function(f){if(canImportContacts()){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("hasMenuScope",function(g,f){if((CURRENT_DOMAIN_USER.menu_scopes).indexOf(g)!=-1){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("fetchXeroUser",function(f){return JSON.parse(f).xeroemail});Handlebars.registerHelper("getfbreturndomain",function(g){var f=window.location.href.split("/");return f[2]});Handlebars.registerHelper("tagManagementCollectionSetup",function(h){console.log(h);var l={};var m=[];for(var k=0;k<h.length;k++){var g=h[k].tag;var j=g.charAt(0).toUpperCase();if(jQuery.inArray(j,m)==-1){m.push(j)}}console.log(m);var f="";for(var k=0;k<m.length;k++){f+="<div class='row b-b p-b-md'><div class='col-md-1 p-t' style='font-size:16px;padding-top:20px;'>"+m[k]+"</div><div class='col-md-10'><div tag-alphabet=\""+encodeURI(m[k])+'"><ul class="tags-management tag-cloud" style="list-style:none;"></ul></div></div></div>'}console.log(f);return new Handlebars.SafeString(f)});Handlebars.registerHelper("containsScope",function(g,h,f){if(h.length==0||!g){return f.inverse(this)}if(jQuery.inArray(g,h)==-1){return f.inverse(this)}return f.fn(this)});Handlebars.registerHelper("isOwnerOfContact",function(g,f){if(CURRENT_DOMAIN_USER.id==g){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("canEditContact",function(g,f){if(canEditContact(g)){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("canEditCurrentContact",function(g,f){if(canEditCurrentContact()){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("gateway_exists",function(j,k,g){for(var h=0;h<k.length;h++){var f=JSON.parse(k[h].prefs);if(k[h].name=="EmailGateway"){if(f.email_api==j){return g.fn(k[h])}}if(k[h].name=="SMS-Gateway"){if(f.sms_api==j){return g.fn(k[h])}}}return g.inverse(this)});Handlebars.registerHelper("each_index_slice",function(l,h,g){var f="";for(var j=h;j<l.length;j++){var k=l[j];console.log(k);f+=g.fn(k)}return f});Handlebars.registerHelper("gateway_exists",function(j,k,g){for(var h=0;h<k.length;h++){var f=JSON.parse(k[h].prefs);if(k[h].name=="EmailGateway"){if(f.email_api==j){return g.fn(k[h])}}if(k[h].name=="SMS-Gateway"){if(f.sms_api==j){return g.fn(k[h])}}}return g.inverse(this)});Handlebars.registerHelper("isOwnerOfContact",function(g,f){if(CURRENT_DOMAIN_USER.id==g){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("canEditContact",function(g,f){if((hasScope("UPDATE_CONTACTS")||hasScope("EDIT_CONTACT"))||CURRENT_DOMAIN_USER.id==g){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("getAccountPlanName",function(f){if(!f){return"Free"}var g=f.split("_");return ucfirst(g[0])});Handlebars.registerHelper("getFullAccountPlanName",function(f){if(!f){return"Free"}var g=f.split("_");return ucfirst(g[0])+" ("+ucfirst(g[1])+")"});Handlebars.registerHelper("getAccountPlanInteval",function(f){if(!f){return"Monthly"}var g=f.split("_");return ucfirst(g[1])});Handlebars.registerHelper("getSubscriptionBasedOnPlan",function(j,h,f){var g=getSubscriptionWithAmount(j,h);if(g!=null){return f.fn(g)}return f.inverse(this)});Handlebars.registerHelper("iso_date_to_normalizeDate",function(g){if(g.length<=0){return}var f=g.split("T");console.log("normalize date "+f[0]);return f[0]});Handlebars.registerHelper("getMonthFromIndex",function(h){var g=["January","february","March","April","May","June","July","August","September","October","November","December"];var f="";if(h>12){f=g[11]}f=g[h-1];return _agile_get_translated_val("months",f)});Handlebars.registerHelper("xeroOrganisationShortCode",function(f){if(typeof SHORT_CODE=="undefined"||SHORT_CODE==""){return false}else{return SHORT_CODE}});Handlebars.registerHelper("if_id",function(g,f){if(this.type==g){return f.fn(this)}});Handlebars.registerHelper("getTime",function(h){if(!h){return}if((h/100000000000)>1){var k=new Date(parseInt(h));var f=k.getHours();if(f>12){f=f-12}var j=k.getMinutes();if(j==0){j="00"}var g=f>=12?"PM":"AM";return f+":"+j+" "+g}var k=new Date(parseInt(h)*1000);var f=k.getHours();if(f>12){f=f-12}var j=k.getMinutes();if(j==0){j="00"}var g=f>=12?"PM":"AM";return f+":"+j+" "+g});Handlebars.registerHelper("getCustomDateWithTime",function(m,f){var l=a(m);var k=a(f);var h=b(m);var g=b(f);var j=c(f);if(l!=k){return h+" - "+g}else{return h+" - "+j}});function c(h){if(!h){return}if((h/100000000000)>1){var k=new Date(parseInt(h));var f=k.getHours();var j=k.getMinutes();if(j==0){j="00"}var g=f>=12?"PM":"AM";if(f>12){f=f-12}return f+":"+j+" "+g}var k=new Date(parseInt(h)*1000);var f=k.getHours();var j=k.getMinutes();if(j==0){j="00"}var g=f>=12?"PM":"AM";if(f>12){f=f-12}return f+":"+j+" "+g}function a(f){if((f/100000000000)>1){var g=new Date(parseInt(f));return g.getDate()}else{var g=new Date(parseInt(f)*1000);return g.getDate()}}Handlebars.registerHelper("buildOptions",function(h){var f=h.split(";");var g="";$.each(f,function(j,k){if(k!=""){g=g.concat('<option value="'+k+'">'+k+"</option>")}});return g});Handlebars.registerHelper("address_Template",function(j){for(var h=0,g=j.length;h<g;h++){if(j[h].name=="address"){var k="";var f={};try{f=JSON.parse(j[h].value)}catch(n){f.address=j[h].value}var m=countJsonProperties(f);$.each(f,function(l,o){if(--m==0){k=k.concat(o+".");return}k=k.concat(o+", ")});return new Handlebars.SafeString(k)}}});Handlebars.registerHelper("related_to_contacts",function(j,f){var g="";var h=j.length;$.each(j,function(l,m){var k=getTemplate("related-to-contacts",m);if(--h==0){g=g.concat(k);return}g=g.concat(k+",")});return new Handlebars.SafeString(g)});Handlebars.registerHelper("related_to_one",function(j,f){var g="";var h=j.length;$.each(j,function(l,m){if(l<=3){var k=getTemplate("related-to-contacts",m);k=k.trim();if(--h==0||l==3){g=g.concat(k);return}g=g.concat(k+", ")}});return new Handlebars.SafeString(g)});Handlebars.registerHelper("numberWithCommas",function(f){if(f){return f.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}});Handlebars.registerHelper("stringToJSON",function(g,h,f){console.log(g);console.log(h);if(h){try{g[h]=JSON.parse(g[h])}finally{return f.fn(g[h])}}try{return f.fn(JSON.parse(g))}catch(j){return f.fn(g)}});Handlebars.registerHelper("if_propertyName",function(h,f){for(var g=0;g<this.properties.length;g++){if(this.properties[g].name==h){return f.fn(this.properties[g])}}return f.inverse(this)});Handlebars.registerHelper("getCompanyImage",function(k,j){var f=parseInt(k);var h=4+((f-32)/2);var m="src='"+updateImageS3Path("img/com-default-img.png")+"' style='width:"+f+"px; height="+f+"px;"+j+"'";var g="";for(var l=0;l<this.properties.length;l++){if(this.properties[l].name=="image"){m="src='"+this.properties[l].value+"' style='width:"+f+"px; height="+f+"px;"+j+";'";g="this.src='"+updateImageS3Path("img/com-default-img.png")+"'; this.onerror=null;";break}if(this.properties[l].name=="url"){m="src='https://www.google.com/s2/favicons?domain="+this.properties[l].value+"' style='width:"+f+"px; height="+f+"px; padding:"+h+"px; "+j+" ;'";g="this.src='"+updateImageS3Path("img/com-default-img.png")+"'; $(this).css('width','"+k+"px'); $(this).css('height','"+k+"px');$(this).css('padding','4px'); this.onerror=null;"}}return new Handlebars.SafeString(m+' onError="'+g+'"')
});Handlebars.registerHelper("getHyperlinkFromURL",function(f){if(f.match(/((http|http[s]|ftp|file):\/\/)/)!=null){return f}return"http://"+f});Handlebars.registerHelper("getSkypeURL",function(f){if(f.match("skype:")!=null){return f}return"skype:"+f});Handlebars.registerHelper("getFacebookURL",function(f){return f.replace("@","")});Handlebars.registerHelper("count",function(){return getCount(this)});Handlebars.registerHelper("contacts_count",function(){var f;if(this[0]&&this[0].count&&(this[0].count!=-1)){if(this[0].count>9999&&(_agile_get_prefs("contact_filter")||_agile_get_prefs("dynamic_contact_filter"))){f="<small> ("+10000+"+ "+_agile_get_translated_val("other","total")+' ) </small><span style="vertical-align: text-top; margin-left: -5px"><img border="0" src="'+updateImageS3Path("/img/help.png")+'"style="height: 10px; vertical-align: middle" rel="popover"data-placement="bottom" data-title="Lead Score"data-content="'+_agile_get_translated_val("results","over-count")+'"id="element" data-trigger="hover"></span>'}else{f="<small> ("+this[0].count+" "+_agile_get_translated_val("other","total")+" ) </small>"}}else{f="<small> ("+this.length+" "+_agile_get_translated_val("other","total")+" ) </small>"}return new Handlebars.SafeString(f)});Handlebars.registerHelper("duplicate_contacts_count",function(){var g;if(this[0]&&this[0].count&&(this[0].count!=-1)){var f=this[0].count-1;g="<small> ("+f+" "+_agile_get_translated_val("other","total")+" ) </small>"}else{g="<small> ("+this.length+" "+_agile_get_translated_val("other","total")+" ) </small>"}return new Handlebars.SafeString(g)});Handlebars.registerHelper("subscribers_count",function(){if(this[0]&&this[0].count&&(this[0].count!=-1)){return this[0].count}return this.length});Handlebars.registerHelper("toLowerCase",function(f){if(!f){return}return f.toLowerCase()});Handlebars.registerHelper("toUpperCase",function(f){if(!f){return}return f.toUpperCase()});Handlebars.registerHelper("if_contact_type",function(g,f){if(this.type==g){return f.fn(this)}});Handlebars.registerHelper("collection_contact_type",function(g,f){if(this&&this[0]&&this[0].type==g){return f.fn(this)}});Handlebars.registerHelper("wrap_entity",function(g,f){if(g){return f.fn(g)}});Handlebars.registerHelper("tl_log_string",function(f){return f.replace("Sending email From:","Email sent From::")});Handlebars.registerHelper("lead_score",function(f){return this.lead_score});Handlebars.registerHelper("task_status",function(f){if(f){return true}return"false"});Handlebars.registerHelper("if_equals",function(g,h,f){if((typeof h==="undefined")||(typeof g==="undefined")){return f.inverse(this)}if(g.toString().trim()==h.toString().trim()){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("if_hasWriteAccess",function(h){var g=false;var k=agile_crm_get_widget("Stripe");if(k!=undefined){if(k.prefs!=undefined){var f=JSON.parse(k.prefs);var j=f.scope;if(j=="read_write"){g=true}}}if(g){return h.fn(this)}else{return h.inverse(this)}});Handlebars.registerHelper("if_not_equals",function(g,h,f){if((typeof h==="undefined")||(typeof g==="undefined")){return f.inverse(this)}if(g.toString().trim()!=h.toString().trim()){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("if_greater",function(g,h,f){if(parseInt(h)>g){return f.inverse(this)}else{return f.fn(this)}});Handlebars.registerHelper("if_less_than",function(g,h,f){if(h<g){return f.inverse(this)}else{return f.fn(this)}});Handlebars.registerHelper("if_keyboard_shortcuts_enabled",function(f){if(CURRENT_USER_PREFS.keyboard_shotcuts){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("campaigns_heading",function(g,f){var h=0;if(g&&g[0]&&g[0].count){h=g[0].count}if(h<=20){return"Workflows"}return"("+h+_agile_get_translated_val("other","total")+" )"});Handlebars.registerHelper("show_custom_fields",function(h,f){var g=show_custom_fields_helper(h,f);return new Handlebars.SafeString(fill_custom_field_values($(g),f))});Handlebars.registerHelper("is_property_custom_field",function(g,f){if(g.indexOf("CUSTOM_")!=-1){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("is_property_custom_field_date_type",function(j,g,h,f){if(h){h=h.split("CUSTOM_")[1]}var k=getProperty(g,h);if(isDateCustomField(j,k)){return f.fn(k)}else{return f.inverse(k)}});Handlebars.registerHelper("is_link",function(g,f){var h=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;if(g&&g.search(h)!=-1){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("displayPlan",function(f){return ucfirst(f).replaceAll("_"," ")});Handlebars.registerHelper("displayPlainText",function(f){return ucfirst(f).replace("_"," ")});Handlebars.registerHelper("getCurrentContactProperty",function(g){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var f=App_Contacts.contactDetailView.model.get("properties");console.log(App_Contacts.contactDetailView.model.toJSON());return getPropertyValue(f,g)}});Handlebars.registerHelper("string_to_date",function(g,f){return new Date(f).format(g)});Handlebars.registerHelper("isArray",function(g,f){if(isArray(g)){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("is_string",function(g,f){if(typeof g=="string"){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("bindData",function(f){return JSON.stringify(f)});Handlebars.registerHelper("getCurrentUserPrefs",function(f){if(CURRENT_USER_PREFS){}return f.fn(CURRENT_USER_PREFS)});Handlebars.registerHelper("getCurrentDomain",function(g){var f=window.location.host;var h=/(\.)/;if(f.search(h)>=0){return f.split(h)[0]}return" "});Handlebars.registerHelper("date-range",function(h,g,j){var k=Date.parse(h);var f=Date.today().add({days:parseInt(g)});return f.toString("MMMM d, yyyy")+" - "+k.toString("MMMM d, yyyy")});Handlebars.registerHelper("month-range",function(g){var h=Date.today().moveToFirstDayOfMonth();var f=Date.today().moveToLastDayOfMonth();return h.toString("MMMM d, yyyy")+" - "+f.toString("MMMM d, yyyy")});Handlebars.registerHelper("extractEmail",function(g,f){console.log(g);return f.fn(g.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi)[0])});Handlebars.registerHelper("if_keyboard_shortcuts_enabled",function(f){if(CURRENT_USER_PREFS.keyboard_shotcuts){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("getCurrentContactPropertyBlock",function(h,g){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var f=App_Contacts.contactDetailView.model.get("properties");console.log(App_Contacts.contactDetailView.model.toJSON());return g.fn(getPropertyValue(f,h))}});Handlebars.registerHelper("containString",function(g,h,f){if(h.search(g)!=-1){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("is_emailPlan",function(g,f){if(g.search("email")!=-1){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("is_userPlan",function(g,f){if(g.search("email")!=-1){return f.inverse(this)}return f.fn(this)});Handlebars.registerHelper("numeric_operation",function(j,h,g){var f="/*-+";if(f.indexOf(g)==-1){return""}if(g=="+"){return j+h}if(g=="-"){return j-h}if(g=="*"){return j*h}if(g=="/"){return j/h}});Handlebars.registerHelper("get_total_amount",function(g,f){return(g/100)*f});Handlebars.registerHelper("check_length",function(h,g,f){if(parseInt(h.length)>parseInt(g)){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("check_json_length",function(h,g,f){var k=0;for(var j in h){k++}if(k==parseInt(g)){for(var j in h){return f.fn({property:j,value:h[j],last:true})}}return f.inverse(h)});Handlebars.registerHelper("iterate_json",function(h,g){var f="";var k=0;var j=0;for(var l in h){j++}for(var l in h){k++;if(k==j){f=f+g.fn({property:l,value:h[l],last:true})}else{f=f+g.fn({property:l,value:h[l],last:false})}}console.log(f);return f});Handlebars.registerHelper("get_social_icon",function(f){return get_social_icon(f)});Handlebars.registerHelper("each_with_index",function(m,h){var f="";for(var k=0,g=m.length;k<g;k++){var l=m[k];l.index=k+1;console.log(l);f+=h.fn(l)}return f});Handlebars.registerHelper("if_json",function(h,f){try{var g=$.parseJSON(h);if(typeof g==="object"){return f.fn(this)}return f.inverse(this)}catch(j){return f.inverse(this)}});Handlebars.registerHelper("add_tag",function(f){addTagAgile(f)});Handlebars.registerHelper("set_up_dashboard_padcontent",function(f){return new Handlebars.SafeString(getTemplate("empty-collection-model",CONTENT_JSON.dashboard[f]))});Handlebars.registerHelper("removeSquareBrackets",function(f){return f.replace(/[\[\]]+/g,"")});Handlebars.registerHelper("removeDoubleCoutes",function(h){var f=h.replace(/[\[\]]+/g,"");var g=f.replace(/"/g,"'");return g});Handlebars.registerHelper("toLinkTrigger",function(l,h){var g="";for(var k=0,f=l.length;k<f;k++){g=g+h.fn(l[k]);if(k<f-1){g=g+", "}}return g});Handlebars.registerHelper("if_overflow",function(j,f,g){if(!j){return}console.log($("#Linkedin").width());j=j.trim();var h=$("<div style='width:"+$("#Linkedin").width()+"px;word-break:normal;word-wrap:break-word;display:none;'>"+j+"</div>");$("#content").append(h);console.log(h.height()+" "+parseInt(f));if(h.height()>parseInt(f)){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("setupRating",function(h){var g="";for(var f=0;f<5;f++){if(f<parseInt(h)){g=g.concat('<li style="display: inline;"><img src="'+updateImageS3Path("img/star-value-on.png")+'" alt="'+f+'"></li>');continue}g=g.concat('<li style="display: inline;"><img src="'+updateImageS3Path("img/star-value-off.png")+'" alt="'+f+'"></li>')}return new Handlebars.SafeString(g)});Handlebars.registerHelper("setupCSVUploadOptions",function(j,m,f){var l;if(j=="contacts"){getTemplate("csv_upload_options",f,undefined,function(q){if(!q){return}l=$(q)},null)}else{if(j=="company"){getTemplate("csv_companies_upload_options",f,undefined,function(q){if(!q){return}l=$(q)},null)}else{if(j=="deals"){getTemplate("csv_deals_options",f,undefined,function(q){if(!q){return
}l=$(q)},null)}}}m=m.replace("_"," ");var n=false;var o=0;var k=m.length;var m=m.toLowerCase();var g;var p;l.find("option").each(function(q,s){if($(s).text().toLowerCase().indexOf(m)!=-1){var t=k/$(s).text().length;if(o>=t){return}p=$(s);g=$(s).text();o=t}});console.log(g+", "+m+" : "+o);for(var h=0;h<m.length-3;h++){l.find("option").each(function(q,s){if($(s).text().toLowerCase().indexOf(m.substr(0,m.length-h).toLowerCase())!=-1){console.log(m.substr(0,m.length-h)+" , "+$(s).text());var t=m.substr(0,m.length-h).length/$(s).text().length;console.log(t);if(o>=t){return}p=$(s);g=$(s).text();o=t}})}$(p).attr("selected",true);return new Handlebars.SafeString($("<div>").html(l).html())});Handlebars.registerHelper("convertSecondsToHour",function(j){var g=parseInt(j/3600)%24;var h=parseInt(j/60)%60;var k=j%60;if(g==0&&h==0){return(k+"s")}if(g==0){return(h+"m ")+(k+"s")}var f=(g+"h ")+(h+"m ")+(k+"s");return f});Handlebars.registerHelper("checkOriginalRef",function(g){if(!getCurrentContactProperty(g)){return"unknown"}var f=getCurrentContactProperty(g);f=f.split("/");f=(f[0]+"//"+f[2]);return new Handlebars.SafeString('<a style="text-decoration: none" target="_blank" href="'+getCurrentContactProperty(g)+'">'+f+"</a>")});Handlebars.registerHelper("queryWords",function(n){if(getCurrentContactProperty(n)){var l=getCurrentContactProperty(n);var f="www.google.";var k=l.split("/");k=k[2].slice(0,11);if(k===f){var m=document.createElement("a");m.href=l;var h=m.search;if(h.length>1){h=h.split("&");var j=h.length;for(var g=0;g<j;g++){if(h[g].indexOf("q=")!=-1){h=h[g].split("=");return new Handlebars.SafeString("( Keyword : "+h[1].split("+").join(" ")+" )")}}}}else{return}}});Handlebars.registerHelper("contact_name",function(g,h){if(h==="PERSON"){for(var f=0;f<g.length;f++){if(g[f].name==="last_name"){return(getPropertyValue(g,"first_name")+" "+g[f].value)}else{if(g[f].name==="first_name"){return g[f].value}}}return"Contact"}for(var f=0;f<g.length;f++){if(g[f].name==="name"){return g[f].value}}return"Company"});Handlebars.registerHelper("contact_name_necessary",function(f){return getContactName(f)});Handlebars.registerHelper("is_blank",function(g,f){g=g.trim();if(g==""){return f.fn(g)}else{return f.inverse(g)}});Handlebars.registerHelper("each_with_index1",function(m,h){console.log(m);var f="";for(var k=0,g=m.length;k<g;k++){var l={};l.value=m[k];console.log(l);l.index=k+1;console.log(l);f+=h.fn(l)}return f});Handlebars.registerHelper("if_log_type_equals",function(g,h,j,f){if(g[h]==j){return f.fn(g)}return f.inverse(g)});Handlebars.registerHelper("if_email_sent",function(f,l,o){var g="_aGiLeCrM";if(f[l]==="EMAIL_SENT"){var j=f.message.split(g,4);var m={};if(j===undefined){return o.inverse(f)}for(var h=0;h<j.length;h++){var n=j[h].split(":");var l=n[0];l=l.trim();var k=n.slice(1).join(":");k=k.trim();m[l]=k}m.time=f.time;return o.fn(m)}return o.inverse(f)});Handlebars.registerHelper("remove_spaces",function(f){if(f){f=f.replace(/ +/g,"")}return f});Handlebars.registerHelper("replace_spaces",function(f){if(f){f=f.replace(/ +/g,"_")}return f});Handlebars.registerHelper("if_same_campaign",function(j,m,h){var g=j[m];if(m===undefined||g===undefined){return}var l=getIdFromHash();for(var k=0,f=g.length;k<f;k++){if(g[k].campaign_id===l){return h.fn(g[k])}}});Handlebars.registerHelper("if_other_active_campaigns",function(g,j,o){if(g===undefined||g[j]===undefined){return}var f={};var k=[];var m=[];var p=g[j];var n=getIdFromHash();for(var h=0,l=p.length;h<l;h++){if(n===p[h].campaign_id){continue}if(p[h].status.indexOf("ACTIVE")!==-1){k.push(p[h])}if(p[h].status.indexOf("DONE")!==-1){m.push(p[h])}}f.active=k;f.done=m;return o.fn(f)});Handlebars.registerHelper("contact_model",function(f){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){return f.fn(App_Contacts.contactDetailView.model.toJSON())}});Handlebars.registerHelper("if_more_urls",function(l,j,g){var f=3;var m=[];var k={};if(j<f){return g.inverse(l)}for(var h=0;h<l.length;h++){if(h===f){break}m.push(l[h])}k.urls=m;k.more=j-f;return g.fn(k)});Handlebars.registerHelper("safe_tweet",function(f){f=f.trim();return new Handlebars.SafeString(f)});Handlebars.registerHelper("get_stream_icon",function(g){if(!g){return}var f={Home:"icon-home",Retweets:"icon-retweet",DM_Inbox:"icon-download-alt",DM_Outbox:"icon-upload-alt",Favorites:"icon-star",Sent:"icon-share-alt",Search:"icon-search",Scheduled:"icon-time",All_Updates:"icon-home",My_Updates:"icon-share-alt"};g=g.trim();if(f[g]){return f[g]}return"icon-globe"});Handlebars.registerHelper("get_normal_activity_type",function(g){if(!g){return}g=g.trim();var f=_agile_get_translated_val("activity_type");if(f[g]){return f[g]}return g});Handlebars.registerHelper("user_location",function(){var f=this.city=="?"?"":(this.city+", ");var h=this.region=="?"?"":(this.region+", ");var g=this.country;if(this.city=="?"&&this.region=="?"){g=this.country=="?"?this.city_lat_long:(this.city_lat_long+" ( "+this.country+" )")}return(f+h+g).trim()});Handlebars.registerHelper("trim_space",function(f){if(f===undefined){return f}return f.trim()});Handlebars.registerHelper("get_subaccount_reputation_duplicate",function(h){var g="bg-light dk text-tiny";var f="Unknown";if(h>1&&h<40){g="label-danger text-tiny";f="Poor"}else{if(h>=40&&h<75){g="bg-light text-tiny";f="Ok"}else{if(h>=75&&h<90){g="label-success";f="Good"}else{if(h>=90){g="label-success";f="Excellent"}}}}f=_agile_get_translated_val("reputation",f);return"<span style='top: -3px' class='text-sm pos-rlt label "+g+"'>"+f+"</span> <!--<span class='badge badge-"+g+"'>"+h+"</span>-->"});Handlebars.registerHelper("get_id_from_hash",function(){return getIdFromHash()});Handlebars.registerHelper("get_subscribers_type_from_hash",function(){var h=window.location.hash.substr(1);var g=_agile_get_translated_val("subscriber_type");for(var f in g){if(h.indexOf(f)!=-1){return g[f]}}});Handlebars.registerHelper("check_plan",function(g,f){console.log(g);if(!_billing_restriction){return f.fn(this)}if(_billing_restriction.currentLimits.planName==g){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("isSafariBrowser",function(f){if(navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Chrome")===-1){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("xeroType",function(f){return(f=="ACCPAY")?"Payable":"Receivable"});Handlebars.registerHelper("xeroTypeToolTip",function(f){return(f=="ACCPAY")?"Payable":"Receivable"});Handlebars.registerHelper("capFirstLetter",function(g){if(g){if(g==="DEFAULT"){return""}else{var f=g.toLowerCase();return f.charAt(0).toUpperCase()+f.slice(1)}}});Handlebars.registerHelper("qbStatus",function(f){console.log(this);console.log(this.TotalAmt);if(f==0){return"Paid"}else{return"Due"}});Handlebars.registerHelper("currencyFormat",function(f){return Number(f).toLocaleString("en")});Handlebars.registerHelper("QbDateFormat",function(g){var f=[];f=g.split("-");return f[0]+"-"+f[2]+"-"+f[1]});Handlebars.registerHelper("hasScope",function(f,g){if(CURRENT_DOMAIN_USER.scopes&&$.inArray(f,CURRENT_DOMAIN_USER.scopes)!=-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("hasMenuScope",function(f,g){if(CURRENT_DOMAIN_USER.menu_scopes&&$.inArray(f,CURRENT_DOMAIN_USER.menu_scopes)!=-1){return g.fn(this)}return g.inverse(this)});Handlebars.registerHelper("canSyncContacts",function(f){if(canImportContacts()){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("hasMenuScope",function(g,f){if((CURRENT_DOMAIN_USER.menu_scopes).indexOf(g)!=-1){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("fetchXeroUser",function(f){return JSON.parse(f).xeroemail});Handlebars.registerHelper("isContactType",function(h,g,f){if(!h&&g=="PERSON"){return f.fn(this)}else{if(h==g){return f.fn(this)}}return f.inverse(this)});Handlebars.registerHelper("getfbreturndomain",function(g){var f=window.location.href.split("/");return f[2]});Handlebars.registerHelper("tagManagementCollectionSetup",function(h){console.log(h);var l={};var m=[];for(var k=0;k<h.length;k++){var g=h[k].tag;var j=g.charAt(0).toUpperCase();if(jQuery.inArray(j,m)==-1){m.push(j)}}console.log(m);m.sort();var f="";for(var k=0;k<m.length;k++){f+="<div class='row b-b p-b-md'><div class='col-md-1' style='font-size:16px;padding-top:20px;'>"+m[k]+"</div><div class='col-md-10'><div tag-alphabet=\""+encodeURI(m[k])+'"><ul class="tags-management tag-cloud" style="list-style:none;"></ul></div></div></div>'}console.log(f);return new Handlebars.SafeString(f)});Handlebars.registerHelper("containsScope",function(g,h,f){if(h.length==0||!g){return f.inverse(this)}if(jQuery.inArray(g,h)==-1){return f.inverse(this)}return f.fn(this)});Handlebars.registerHelper("isOwnerOfContact",function(g,f){if(CURRENT_DOMAIN_USER.id==g){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("getAccountOwnerId",function(f){return CURRENT_DOMAIN_USER.id});Handlebars.registerHelper("canEditContact",function(g,f){if(canEditContact(g)){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("canEditCurrentContact",function(g,f){if(canEditCurrentContact()){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("gateway_exists",function(j,k,g){for(var h=0;h<k.length;h++){var f=JSON.parse(k[h].prefs);if(k[h].name=="EmailGateway"){if(f.email_api==j){return g.fn(k[h])}}if(k[h].name=="SMS-Gateway"){if(f.sms_api==j){return g.fn(k[h])}}}return g.inverse(this)});Handlebars.registerHelper("each_index_slice",function(l,h,g){var f="";for(var j=h;j<l.length;j++){var k=l[j];console.log(k);f+=g.fn(k)}return f});Handlebars.registerHelper("gateway_exists",function(j,k,g){for(var h=0;h<k.length;h++){var f=JSON.parse(k[h].prefs);if(k[h].name=="EmailGateway"){if(f.email_api==j){return g.fn(k[h])}}if(k[h].name=="SMS-Gateway"){if(f.sms_api==j){return g.fn(k[h])}}}return g.inverse(this)});Handlebars.registerHelper("isOwnerOfContact",function(g,f){if(CURRENT_DOMAIN_USER.id==g){return f.fn(this)
}return f.inverse(this)});Handlebars.registerHelper("canEditContact",function(g,f){if((hasScope("UPDATE_CONTACTS")||hasScope("EDIT_CONTACT"))||CURRENT_DOMAIN_USER.id==g){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("getAccountPlanName",function(f){if(!f){return"Free"}var g=f.split("_");return ucfirst(g[0])});Handlebars.registerHelper("getAccountPlanInteval",function(f){if(!f){return"Monthly"}var g=f.split("_");return ucfirst(g[1])});Handlebars.registerHelper("getSubscriptionBasedOnPlan",function(j,h,f){var g=getSubscriptionWithAmount(j,h);if(g!=null){return f.fn(g)}return f.inverse(this)});Handlebars.registerHelper("iso_date_to_normalizeDate",function(g){if(g.length<=0){return}var f=g.split("T");console.log("normalize date "+f[0]);return f[0]});Handlebars.registerHelper("getMonthFromIndex",function(h){var g=["January","February","March","April","May","June","July","August","September","October","November","December"];var f="";if(h>12){f=g[11]}else{f=g[h-1]}return _agile_get_translated_val("months",f)});Handlebars.registerHelper("xeroOrganisationShortCode",function(f){if(typeof SHORT_CODE=="undefined"||SHORT_CODE==""){return false}else{return SHORT_CODE}});Handlebars.registerHelper("buildOptions",function(h){var f=h.split(";");var g="";$.each(f,function(j,k){if(k!=""){g=g.concat('<option value="'+k+'">'+k+"</option>")}});return g});Handlebars.registerHelper("get_avatars_template",function(f){var g=getTemplate("choose-avatar-images-modal",{});getTemplate("choose-avatar-images-modal",{},undefined,function(j){if(!j){return}var h=$(j)},null);return g});Handlebars.registerHelper("if_email_type_is_agile",function(h,f){var g=email_server_type;if(g){if(h===g){return f.fn(this)}else{return f.inverse(this)}}else{return f.fn(this)}});Handlebars.registerHelper("read_global_var",function(){var f=email_server_type;if(f){return f}else{return"agilecrm"}});Handlebars.registerHelper("if_non_pro_plan",function(f){if(!_billing_restriction){return f.inverse(this)}if(_billing_restriction.currentLimits.planName!=="PRO"){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("has_email_account_limit_reached",function(f){var g=HAS_EMAIL_ACCOUNT_LIMIT_REACHED;if(g){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("pick_random_avatar_url",function(f){return choose_random_avatar()});Handlebars.registerHelper("getRemaininaEmails",function(){return getPendingEmails()});Handlebars.registerHelper("getLastPurchasedCount",function(){var f=getMaxEmailsLimit();if(f==0){return"-"}else{return getPendingEmails()}});Handlebars.registerHelper("getFreeEmailsCount",function(){var f=getMaxEmailsLimit();if(f==0){return"5000"}else{return"-"}});Handlebars.registerHelper("getEmailCreditsCount",function(){return getEmailCreditsCount()});Handlebars.registerHelper("inboundMail",function(){var f=window.location.hostname.split(".")[0]+"-"+_AGILE_API_KEY+"@agle.cc";return new Handlebars.SafeString(f)});Handlebars.registerHelper("getTime",function(h){if(!h){return}if((h/100000000000)>1){var k=new Date(parseInt(h));var f=k.getHours();if(f>12){f=f-12}var j=k.getMinutes();if(j==0){j="00"}var g=f>=12?"PM":"AM";return f+":"+j+" "+g}var k=new Date(parseInt(h)*1000);var f=k.getHours();if(f>12){f=f-12}var j=k.getMinutes();if(j==0){j="00"}var g=f>=12?"PM":"AM";return f+":"+j+" "+g});Handlebars.registerHelper("getCustomDateWithTime",function(m,f){var l=a(m);var k=a(f);var h=b(m);var g=b(f);var j=c(f);if(l!=k){return h+" - "+g}else{return h+" - "+j}});function b(j){var f=["Jan","Feb","March","April","May","Jun","July","Aug","Sept","Oct","Nov","Dec"];if(!j){return}if((j/100000000000)>1){var n=new Date(parseInt(j));var g=n.getHours();var l=n.getFullYear();var j=n.getDate();var m=n.getMonth();var k=n.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";if(g>12){g=g-12}return _agile_get_translated_val("months-xs",f[m])+" "+j+", "+l+" "+g+":"+k+" "+h}var n=new Date(parseInt(j)*1000);var g=n.getHours();var l=n.getFullYear();var j=n.getDate();var m=n.getMonth();var k=n.getMinutes();if(k==0){k="00"}var h=g>=12?"PM":"AM";if(g>12){g=g-12}return _agile_get_translated_val("months-xs",f[m])+" "+j+", "+l+" "+g+":"+k+" "+h}function c(h){if(!h){return}if((h/100000000000)>1){var k=new Date(parseInt(h));var f=k.getHours();var j=k.getMinutes();if(j==0){j="00"}var g=f>=12?"PM":"AM";if(f>12){f=f-12}return f+":"+j+" "+g}var k=new Date(parseInt(h)*1000);var f=k.getHours();var j=k.getMinutes();if(j==0){j="00"}var g=f>=12?"PM":"AM";if(f>12){f=f-12}return f+":"+j+" "+g}function a(f){if((f/100000000000)>1){var g=new Date(parseInt(f));return g.getDate()}else{var g=new Date(parseInt(f)*1000);return g.getDate()}}Handlebars.registerHelper("getContactDisplayValue",function(f){var g;var m=f.type;var k=f.properties;if(k){if(m=="COMPANY"){for(var j=0;j<k.length;j++){if(k[j].name=="name"){g=k[j].value;break}}}else{var l;var h;for(var j=0;j<k.length;j++){if(k[j].name=="first_name"){l=k[j].value}if(k[j].name=="last_name"){h=k[j].value}}if(!l){l=""}if(!h){h==""}g=l+" "+h}}return g});Handlebars.registerHelper("getGoogleEventCustomTime",function(j,g){var f=new Date(j);var h=new Date(g);return e(f.getTime(),h.getTime())});function e(h,k){var o=a(h);var n=a(k);var g=b(h);var f=b(k);var j=c(k);var p=d(h);if(p==0||p==1){var m=c(h);var l=c(k);if(m&&l){return m+" - "+l}if(l){return m+" - "+l}else{return m}}else{if(o!=n){if(f){return g+" - "+f}else{return g}}else{return g+" - "+j}}}Handlebars.registerHelper("displayCustomDateTime",function(n,f){var h=get_activity_created_time(n);var m=a(n);var l=a(f);var j=b(n);var g=b(f);var k=c(f);if(h==0||eventCreatedTime==1){return k}else{if(m!=l){return j+" - "+g}else{return j+" - "+k}}});function d(h){var g=new Date(h);h=g.getTime()/1000;var f=new Date();f.setHours(0,0,0,0);f=f.getTime()/1000;return Math.floor((h-f)/(24*3600))}Handlebars.registerHelper("arrayToCamelcase",function(g){var f="";for(var h=0;h<g.length;h++){f+=ucfirst(g[h]);if(h+1<g.length){f+=", "}}return f});Handlebars.registerHelper("namesFromObject",function(h,j){var f="";console.log(h.length);for(var g=0;g<h.length;g++){f+=h[g][j];if(g+1<h.length){f+=", "}}return f});Handlebars.registerHelper("secondsToFriendlyTime",function(j){var g=Math.floor(j/3600);if(g>0){j=j-g*60*60}var h=Math.floor(j/60);var k=j-h*60;var f="";if(g==1){f=g+"h "}if(g>1){f=g+"h "}if(h>0){f+=h+"m "}if(k>0){f+=k+"s "}if(f!=""){return" - "+f}return f});Handlebars.registerHelper("pick_random_avatar_url",function(f){return choose_random_avatar()});Handlebars.registerHelper("choose_custom_field_font_icon",function(g){var f="";if(g=="TEXT"){f="icon-text-height"}else{if(g=="TEXTAREA"){f="icon-file-alt"}else{if(g=="DATE"){f="icon-calendar"}else{if(g=="CHECKBOX"){f="icon-check"}else{if(g=="LIST"){f="icon-list-ul"}else{if(g=="NUMBER"){f="icon-text-height"}}}}}}return f});Handlebars.registerHelper("choose_custom_field_type",function(g){var f="";if(g=="TEXT"){f="Text Field"}else{if(g=="TEXTAREA"){f="Text Area"}else{if(g=="DATE"){f="Date Field"}else{if(g=="CHECKBOX"){f="Checkbox"}else{if(g=="LIST"){f="List"}else{if(g=="NUMBER"){f="Number"}else{if(g=="FORMULA"){f="Formula"}}}}}}}return f});Handlebars.registerHelper("ifCond",function(j,g,h,f){if(!j||!h){return f.inverse(this)}switch(g){case"greaterthan":if(parseInt(j)>parseInt(h)){return f.fn(this)}break;case"lessthan":if(parseInt(j)<parseInt(h)){return f.fn(this)}break;case"equals":if(parseInt(j)===parseInt(h)){return f.fn(this)}break}return f.inverse(this)});Handlebars.registerHelper("callActivityFriendlyStatus",function(f,g){switch(f){case"completed":case"answered":case"inquiry":case"interest":case"no interest":case"incorrect referral":case"meeting scheduled":case"new oppurtunity":return _agile_get_translated_val("call_activity","duration");break;case"busy":case"no-answer":if(g=="outgoing"){return _agile_get_translated_val("call_activity","busy")}else{return _agile_get_translated_val("call_activity","no_answer")}break;case"failed":return _agile_get_translated_val("call_activity","fail");break;case"missed":return _agile_get_translated_val("call_activity","missed");break;case"in-progress":case"voicemail":return _agile_get_translated_val("call_activity","voicemail");break;case"missed":return _agile_get_translated_val("call_activity","missed");break;default:return""}});Handlebars.registerHelper("shopifyWebhook",function(){var f=agileWindowOrigin()+"/shopifytrigger?api-key="+_AGILE_API_KEY;return new Handlebars.SafeString(f)});Handlebars.registerHelper("toProperFormat",function(f){if(f=="0"){return"0 s"}return twilioSecondsToFriendly(f)});Handlebars.registerHelper("get_portlet_name",function(f){var g="";if(f=="Filter Based"){g="contact-list"}else{if(f=="Emails Opened"){g="email-opens"}else{if(f=="Emails Sent"){g="emails"}else{if(f=="Growth Graph"){g="tag-graph"}else{if(f=="Calls Per Person"){g="calls"}else{if(f=="Pending Deals"){g="pending-deals"}else{if(f=="Deals By Milestone"){g="deals-by-milestone"}else{if(f=="Closures Per Person"){g="closures-per-person"}else{if(f=="Deals Won"){g="deals-won"}else{if(f=="Deals Funnel"){g="deals-funnel"}else{if(f=="Deals Assigned"){g="deals-assigned"}else{if(f=="Agenda"){g="events"}else{if(f=="Today Tasks"){g="tasks"}else{if(f=="Agile CRM Blog"){g="agile-crm-blog"}else{if(f=="Task Report"){g="task-report"}else{if(f=="Stats Report"){g="activity-overview"}else{if(f=="Campaign stats"){g="campaign-stats"}else{if(f=="Campaign graph"){g="campaign-status"}else{if(f=="Average Deviation"){g="task_deviation"}else{if(f=="Webstat Visits"){g="visits"}else{if(f=="Referralurl stats"){g="ref-url-stats"}else{if(f=="Lost Deal Analysis"){g="deals-lost-reason"}else{if(f=="Revenue Graph"){g="revenue-graph"}else{if(f=="Mini Calendar"){g="mini-calendar"}else{if(f=="Deal Goals"){g="deal-goals"}else{if(f=="Incoming Deals"){g="incoming-deals"}else{if(f=="Leaderboard"){g="leaderboard"}else{if(f=="Account Details"){g="account-details"}else{if(f=="User Activities"){g="user-activities"}else{g=f}}}}}}}}}}}}}}}}}}}}}}}}}}}}}return _agile_get_translated_val("portlets",g)
});Handlebars.registerHelper("get_portlet_icon",function(f){var g="";if(f=="Filter Based"){g="icon-user"}else{if(f=="Emails Opened"){g="icon-envelope"}else{if(f=="Emails Sent"){g="icon-envelope"}else{if(f=="Growth Graph"||f=="Incoming Deals"){g="icon-graph"}else{if(f=="Calls Per Person"){g="icon-call-end"}else{if(f=="Pending Deals"||f=="Average Deviation"){g="icon-clock"}else{if(f=="Deals By Milestone"){g="icon-flag"}else{if(f=="Closures Per Person"){g="icon-thumbs-up"}else{if(f=="Deals Won"){g="icon-briefcase"}else{if(f=="Deals Funnel"){g="icon-filter"}else{if(f=="Deals Assigned"){g="icon-user"}else{if(f=="Agenda"||f=="Mini Calendar"){g="icon-calendar"}else{if(f=="Today Tasks"||f=="Task Report"||f=="Referralurl stats"){g="icon-tasks"}else{if(f=="Agile CRM Blog"){g="icon-feed"}else{if(f=="Stats Report"){g="icon-speedometer"}else{if(f=="Leaderboard"){g="icon-trophy"}else{if(f=="User Activities"){g="icon-cogs"}else{if(f=="Account Details"){g="icon-info"}else{if(f=="Revenue Graph"){g="icon-graph"}else{if(f=="Campaign stats"){g="icon-sitemap"}else{if(f=="Campaign graph"){g="icon-pie-chart"}else{if(f=="Deal Goals"){g="icon-flag"}else{if(f=="Lost Deal Analysis"){g="icon-pie-chart"}else{if(f=="Webstat Visits"){g="icon-globe"}}}}}}}}}}}}}}}}}}}}}}}}return g});Handlebars.registerHelper("if_equals_or",function(){var f=arguments[arguments.length-1];try{for(var g=0;g<arguments.length-1;g=g+2){value=arguments[g];target=arguments[g+1];if((typeof target==="undefined")||(typeof value==="undefined")){return f.inverse(this)}if(value.toString().trim()==target.toString().trim()){return f.fn(this)}}return f.inverse(this)}catch(h){console.log("error while if_equals_or of handlebars helper : "+h.message);return f.inverse(this)}});Handlebars.registerHelper("buildFacebookProfileURL",function(f){return buildFacebookProfileURL(f)});Handlebars.registerHelper("getTracksCount",function(f){if(parseInt(DEAL_TRACKS_COUNT)>1){return f.fn(this)}else{return f.inverse(this)}});Handlebars.registerHelper("get_AM_PM_format",function(g){var j=new Date(g*1000);var f=j.getHours();var k=j.getMinutes();var h=f>=12?"pm":"am";f=f%12;f=f?f:12;k=k<10?"0"+k:k;if(f<10){f="0"+f}var l=f+":"+k+""+h;return l});Handlebars.registerHelper("get_duration",function(f,l){var k="";var m=0;var h=0;var j=0;var g=l-f;m=Math.floor(g/(24*60*60));h=Math.floor((g%(24*60*60))/(60*60));j=Math.floor(((g%(24*60*60))%(60*60))/60);if(m!=0&&m==1){k+=""+m+"d "}else{if(m!=0&&m>1){k+=""+m+"d "}}if(h!=0&&h==1){k+=""+h+"h "}else{if(h!=0&&h>1){k+=""+h+"h "}}if(j!=0&&j==1){k+=""+j+"m"}else{if(j!=0&&j>1){k+=""+j+"m"}}return k});Handlebars.registerHelper("displayActivityFieldText",function(h){var f=h.replace(/[^a-zA-Z ^,]/g," ").split(",");var j="";if(f.length>1){for(var g=0;g<f.length-1;g++){j+=" "+f[g].trim();if(g!=f.length-2){j+=","}}j+=" and "+f[f.length-1].trim()}else{j=f[f.length-1].trim()}j=j.replace("subject","Title");j=j.replace("priority type","Priority");j=j.replace("task type","Category");j=j.replace("due date","Due date");j=j.replace("name","Name");j=j.replace("probability","Probability");j=j.replace("expected value","Expected value");j=j.replace("close date","Close date");j=j.replace("close date","Close date");j=j.replace("end date","End time");j=j.replace("priority","Priority");j=j.replace("title","Title");j=j.replace("task description","Description");j=j.replace("description","Description");return j});Handlebars.registerHelper("numberWithCommasForActivities",function(f){f=parseFloat(f);if(f==0){return f}if(f){return f.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}});Handlebars.registerHelper("get_event_rescheduled",function(k,h){console.log(k);var g=k.replace(/[^a-zA-Z ^,]/g," ").split(",");var f=[];if(g){for(var j=0;j<g.length;j++){f.push(g[j].trim())}}if(f.indexOf("start date")!=-1){return h.fn(k)}if(f.indexOf("due date")!=-1){return h.fn(k)}return h.inverse(k)});Handlebars.registerHelper("getDueDateOfTask",function(f,g){var m=f.replace(/[^a-zA-Z ^,]/g," ").split(",");var l=g.replace(/[^a-zA-Z0-9 ^,]/g," ").split(",");var j={};for(var n=0;n<m.length;n++){m[n]=m[n].trim();l[n]=l[n].trim()}for(var h=0;h<m.length;h++){j[m[h]]=l[h]}if(m.indexOf("due date")!=-1){var k=parseFloat(j["due date"]);return convertToHumanDate("ddd mmm dd yyyy h:MM TT",k)}if(m.indexOf("start date")!=-1){var k=parseFloat(j["start date"]);return convertToHumanDate("ddd mmm dd yyyy h:MM TT",k)}});Handlebars.registerHelper("getDealCustomProperties",function(g,h){var f=getDealCustomProperties(g);if(f.length==0){return h.inverse(f)}return h.fn(f)});Handlebars.registerHelper("getFormNameFromId",function(g){var f="<div id='"+getFormNameCellIDForFormSubmitTriggers(g)+"'></div>";return new Handlebars.SafeString(f)});Handlebars.registerHelper("isTracksEligible",function(f){if(_billing_restriction.currentLimits.addTracks){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("hasSingleTrack",function(f){try{var g=App_Admin_Settings.pipelineGridView.collection.length;if(g>1){return f.fn(this)}}catch(h){console.log(h)}return f.inverse(this)});Handlebars.registerHelper("get_subject",function(g){var f="Email subject: ";try{if(g){return g.slice(g.indexOf(f)+f.length,g.length)}}catch(h){return g}return g});Handlebars.registerHelper("isCurrentDeal",function(g,f){var h="";if(App_Deal_Details.dealDetailView){h=App_Deal_Details.dealDetailView.model.id}if(g&&g==h){return f.fn(this)}return f.inverse(this)});Handlebars.registerHelper("trigger_milestone",function(g,f){if(!g){return g}var h=g.split("_");if(h.length==1){return g}if(h.length>1&&h[0]!=" "&&!isNaN(Number(h[0]))){h.splice(0,1);return h.join("_")}});Handlebars.registerHelper("get_url",function(g){if(g){if(g.indexOf("fwd=cd")==-1){return new Handlebars.SafeString(g)}var f;if(g.indexOf("?fwd=cd")!=-1){f="?fwd=cd"}else{f="&fwd=cd"}try{if(f){return new Handlebars.SafeString(g.split(f)[0])}}catch(h){console.log("Error in get_limiter:"+h);return new Handlebars.SafeString(g)}}return new Handlebars.SafeString(g)});Handlebars.registerHelper("get_limiter",function(g,f){try{if(g&&f){return g.slice(g.indexOf(f)+f.length,g.length)}}catch(h){console.log("Error in get_limiter:"+h);return g}return g});Handlebars.registerHelper("isAllowedInCurrentPlan",function(g,f){if(_plan_restrictions[g]&&_plan_restrictions[g][0]&&_plan_restrictions[g][0]()){return f.fn(this)}else{if(_plan_restrictions[g]&&_plan_restrictions[g][1]){return f.inverse(_plan_restrictions[g][1]())}else{return f.inverse(this)}}});Handlebars.registerHelper("toSafeString",function(f){return new Handlebars.SafeString(f)});Handlebars.registerHelper("getPlanLimits",function(f){if(_billing_restriction.currentLimits.planName=="PRO"||_billing_restriction.currentLimits.planName=="ENTERPRISE"){return"Unlimited"}else{return _billing_restriction.currentLimits[f]}});Handlebars.registerHelper("getLeaderboardCateCount",function(f){var g=0;if(f.revenue){g++}if(f.dealsWon){g++}if(f.calls){g++}if(f.tasks){g++}return g});Handlebars.registerHelper("getIndexIncrementByOne",function(f){return ++f});Handlebars.registerHelper("get_portlet_duration",function(f){console.log("duration = "+f);if(!f){f="today"}return _agile_get_translated_val("portlets",f)});Handlebars.registerHelper("get_campaign_reports_duration",function(g){console.log("duration = "+g);var f={DAILY:"Daily",WEEKLY:"Weekly",MONTHLY:"Monthly",};return f[g]});Handlebars.registerHelper("timeAgo",function(k){var g=new Date();try{var m="-";var h=new RegExp(m,"g");k=k.replace(h,"/");k=k.match(/[^:]+(\:[^:]+)?/g);g=new Date(k[0]+" UTC")}catch(j){console.log("Error in parsing date")}var l=Math.floor((new Date()-g)/1000);var f=Math.floor(l/31536000);if(f>1){return f+" "+_agile_get_translated_val("misc-keys","yrs_ago")}f=Math.floor(l/2592000);if(f>1){return f+" "+_agile_get_translated_val("misc-keys","mnths_ago")}f=Math.floor(l/86400);if(f>1){return f+" "+_agile_get_translated_val("misc-keys","days_ago")}f=Math.floor(l/3600);if(f>1){return f+" "+_agile_get_translated_val("misc-keys","hrs_ago")}f=Math.floor(l/60);if(f>1){return f+" "+_agile_get_translated_val("misc-keys","mins_ago")}return new Handlebars.SafeString(Math.floor(l)+" "+_agile_get_translated_val("misc-keys","secs_ago"))});Handlebars.registerHelper("capitalizeFirstLetter",function(g,f){return new Handlebars.SafeString(g.charAt(0).toUpperCase()+g.slice(1)+", "+f)});Handlebars.registerHelper("getDefaultImage",function(){return new Handlebars.SafeString(updateImageS3Path(FLAT_FULL_PATH+"images/flatfull/user-default.jpg"))});Handlebars.registerHelper("companyTableHeadings",function(h){var g="",f="";$.each(App_Companies.companyViewModel[h],function(j,k){if(k=="basic_info"||k=="image"){if(_agile_get_prefs("companyTabelView")){if(k=="basic_info"){return}if(k=="image"){k="";f=""}}else{if(k=="image"){k="";f="compactcontact"}if(k=="basic_info"){k="Basic Info"}}}else{if(k=="url"){g=g.concat('<th class="'+f+'">URL</th>');return}else{if(k.indexOf("CUSTOM_")==0){k=k.split("_")[1];f="text-muted"}else{k=k.replace("_"," ");f=""}}}k=getTableLanguageConvertHeader(k);g=g.concat('<th class="'+f+'">'+ucfirst(k)+"</th>")});return new Handlebars.SafeString(g)});Handlebars.registerHelper("companies_count",function(){var f;if(this[0]&&this[0].count&&(this[0].count!=-1)){if(this[0].count>9999&&(_agile_get_prefs("company_filter")||_agile_get_prefs("dynamic_company_filter"))){f="<small> ("+10000+"+ "+_agile_get_translated_val("other","total")+') </small><span style="vertical-align: text-top; margin-left: -5px"><img border="0" src="'+updateImageS3Path("/img/help.png")+'"style="height: 10px; vertical-align: middle" rel="popover"data-placement="bottom" data-title="Lead Score"data-content="'+_agile_get_translated_val("results","over-count")+'"id="element" data-trigger="hover"></span>'}else{f="<small> ("+this[0].count+" "+_agile_get_translated_val("other","total")+") </small>"}}else{f="<small> ("+this.length+" "+_agile_get_translated_val("other","total")+") </small>"}return new Handlebars.SafeString(f)});Handlebars.registerHelper("getSubscriptionDate",function(j,g){if(!j){return 0
}var f=getLastDateOfSubscription(j);if(!f){return 0}var h=Math.round(new Date().getTime()/1000);if(f<h){return 0}return f})});function getEventCreatedTime(c){var b=new Date(c);c=b.getTime()/1000;var a=new Date();a.setHours(0,0,0,0);a=a.getTime()/1000;return Math.floor((c-a)/(24*3600))}Handlebars.registerHelper("getcircle",function(a){prec=(360*a)/100;if(prec<=180){return"background-image :linear-gradient("+(prec+90)+"deg, transparent 50%, #e8eff0 50%),linear-gradient(90deg, #e8eff0  50%, transparent 50%)"}else{return"background-image :linear-gradient("+(prec-90)+"deg, transparent 50%, #39B4CC 50%), linear-gradient(90deg, #e8eff0 50%, transparent 50%)"}});Handlebars.registerHelper("ONBOARDING_CALENDAR_URL",function(){return ONBOARDING_SCHEDULE_URL});Handlebars.registerHelper("SUPPORT_CALENDAR_URL",function(){return SUPPORT_SCHEDULE_URL});Handlebars.registerHelper("SALES_CALENDAR_URL",function(){return SALES_SCHEDULE_URL});Handlebars.registerHelper("get_portlet_description",function(a){var b="";if(a=="Filter Based"){b="contact-list-desc"}else{if(a=="Emails Opened"){b="email-opens-desc"}else{if(a=="Growth Graph"){b="tag-graph-desc"}else{if(a=="Calls Per Person"){b="calls-desc"}else{if(a=="Pending Deals"){b="pending-deals-desc"}else{if(a=="Deals By Milestone"){b="deals-by-milestone-desc"}else{if(a=="Deals Funnel"){b="deals-funnel-desc"}else{if(a=="Agenda"){b="events-desc"}else{if(a=="Today Tasks"){b="tasks-desc"}else{if(a=="Task Report"){b="task-report-desc"}else{if(a=="Agile CRM Blog"){b="agile-crm-blog-desc"}else{if(a=="Stats Report"){b="stats-report-desc"}else{if(a=="Leaderboard"){b="leaderboard-desc"}else{if(a=="User Activities"){b="user-activities-desc"}else{if(a=="Account Details"){b="account-details-desc"}else{if(a=="Revenue Graph"){b="revenue-graph-desc"}else{if(a=="Mini Calendar"){b="mini-calendar-desc"}else{if(a=="Campaign stats"){b="campaign-stats-desc"}else{if(a=="Campaign graph"){b="campaign-graph-desc"}else{if(a=="Deal Goals"){b="deal-goals-desc"}else{if(a=="Incoming Deals"){b="incoming-deals-desc"}else{if(a=="Lost Deal Analysis"){b="lost-deals-description"}else{if(a=="Average Deviation"){b="average-deviation-desc"}else{if(a=="Webstat Visits"){b="webstat-visits-desc"}else{if(a=="Referralurl stats"){b="top-ref-url-desc"}}}}}}}}}}}}}}}}}}}}}}}}}return _agile_get_translated_val("portlets",b)});Handlebars.registerHelper("trialEndDate",function(e,j){var h={};var a=new Date().getTime()/1000;a=Math.round(a);if(!e){return j.inverse(this)}console.log(e);if(e.metadata&&e.metadata.trial_end&&e.metadata.trial_end>a){var g=(parseInt(e.metadata.trial_end)-a)/(24*60*60);g=Math.round(g);var f=(e.metadata.trial_end)/(24*60*60);if(g>0){h.trial_exists=true;h.days_left=g;var d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var b=new Date();b.setDate(b.getDate()+g);var c=b.getDate()+" "+(d[b.getMonth()])+" "+b.getFullYear();h.trial_date=c;console.log("trial in json is:"+h.trial_date)}else{h.trial_exists=false}}else{h.trial_exists=false}return j.fn(h)});Handlebars.registerHelper("trialEnd",function(g,d){var e={};var f=new Date().getTime()/1000;f=Math.round(f);if(!g){return d.inverse(this)}console.log(g);if(g.metadata&&g.metadata.trial_end&&g.metadata.trial_end>f){var a=(parseInt(g.metadata.trial_end)-f)/(24*60*60);a=Math.floor(a);if(a>0){e.trial_exists=true;e.days_left=a;var c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var b=new Date();b.setDate(b.getDate()+a);var h=b.getDate()+" "+(c[b.getMonth()])+" "+b.getFullYear();h=JSON.stringify(h);console.log(h);e.trial_date=h}else{e.trial_exists=false}}else{e.trial_exists=false}return d.fn(e)});Handlebars.registerHelper("toggle_contacts_filter",function(a){if(_agile_get_prefs(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS)=="hide"){return"none"}});Handlebars.registerHelper("toggle_companies_filter",function(a){return _agile_get_prefs("companiesFilterStatus")});Handlebars.registerHelper("contact_filter_tooltip",function(a){if(_agile_get_prefs(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS)=="hide"){return"Show Filters"}else{return"Hide Filters"}});Handlebars.registerHelper("company_filter_tooltip",function(a){if(_agile_get_prefs("companiesFilterStatus")=="display:none"){return"Show Filters"}else{return"Hide Filters"}});Handlebars.registerHelper("totalTimeFormat",function(a){if(a=="0"){return"0 sec"}return SecondsToCampaignTime(a)});Handlebars.registerHelper("allowed_domain_list",function(d){var c="";if(d){var b=d.split(",");for(var a in b){b[a]=b[a].trim();c+="<tr data='"+b[a]+"' style='display: table-row;'><td><div class='inline-block v-top text-ellipsis' style='width:80%'>";c+=b[a]+"</div></td><td class='b-r-none'><div class='m-b-n-xs' style='display:none;'><a class='allowed-domain-delete c-p m-l-sm text-l-none text-xs'  data-toggle='modal' role='button' href='#'><i title='Delete Allowed Domain' class='task-action icon icon-trash'></i></a></div></td></tr>"}}return c});Handlebars.registerHelper("blocked_ips_list",function(d){var c="";if(d){var a=d.split(",");for(var b in a){a[b]=a[b].trim();c+="<tr data='"+a[b]+"' style='display: table-row;'><td><div class='inline-block v-top text-ellipsis' style='width:80%'>";c+=a[b]+"</div></td><td class='b-r-none'><div class='m-b-n-xs' style='display:none;'><a class='blocked-ip-delete c-p m-l-sm text-l-none text-xs'  data-toggle='modal' role='button' href='#'><i title='Delete Blocked IP' class='task-action icon icon-trash'></i></a></div></td></tr>"}}return c});Handlebars.registerHelper("hide_allowed_domains_text",function(b,a){if(b&&b!="localhost, *"){return a.inverse(this)}return a.fn(this)});Handlebars.registerHelper("proToEnterprise",function(e,d){var c="Free";if(e.indexOf("PRO")>=0){e=e.replace("PRO","ENTERPRISE")}var a=e.split("_");var b="Monthly";if(a.length>1){b=ucfirst(a[1]);c=ucfirst(a[0]);return c+" ("+b+")"}});Handlebars.registerHelper("invoice_description",function(a){console.log(a);if(!a){return a}if(a.indexOf("Unused time on")!=-1){a=_agile_get_translated_val("billing","invoice-bal-from")}else{if(a.indexOf("Remaining")!=-1){a=_agile_get_translated_val("billing","invoice-changed-on")+a.substring(a.indexOf("after")+5)}}return a+" "});Handlebars.registerHelper("is_unsubscribed_all",function(d){var c=App_Contacts.contactDetailView.model.toJSON();var f=getPropertyValue(c.properties,"first_name");if(c&&c.unsubscribeStatus&&c.unsubscribeStatus.length>0){var g=c.unsubscribeStatus;for(var e=0,a=g.length;e<a;e++){var b=g[e];if(b.unsubscribeType&&b.unsubscribeType=="ALL"){return d.fn({first_name:f,campaign_id:b.campaign_id})}}}return d.inverse(this)});Handlebars.registerHelper("is_mobile",function(a){if(agile_is_mobile_browser()){return a.fn(this)}else{return a.inverse(this)}});Handlebars.registerHelper("getS3ImagePath",function(a){return new Handlebars.SafeString(updateImageS3Path(a))});Handlebars.registerHelper("is_trial_exist",function(b,a){if(b&&b.subscriptions){var c=false;$.each(b.subscriptions.data,function(e,f){if(!f.plan.id.indexOf("email")>-1&&f.trialStart&&f.trialEnd&&f.trialEnd>=(new Date().getTime()/1000)){var g=f.trialStart;var d=f.trialEnd;if(d-g<=864000){c=true;return false}}});if(c){return a.fn(this)}else{return a.inverse(this)}}else{return a.inverse(this)}});Handlebars.registerHelper("is_greater",function(b,c,a){if(parseInt(c)<b){return a.fn(this)}else{return a.inverse(this)}});Handlebars.registerHelper("is_domain_owner",function(a){if(CURRENT_DOMAIN_USER.is_account_owner){return a.fn(this)}else{return a.inverse(this)}});Handlebars.registerHelper("is_not_allowed_trial",function(a){if(IS_TRIAL&&IS_ALLOWED_TRIAL){return a.inverse(this)}else{return a.fn(this)}});Handlebars.registerHelper("getContactTypeCustomFields",function(d,h,a,b){if(d!="CONTACT"&&d!="COMPANY"){return h}var f="";var c;try{c=$.parseJSON(h)}catch(e){}var g="";if(c){$.each(c,function(j,k){if(j!=c.length-1){g+=k+","}else{g+=k}});App_Contacts.referenceContactsCollection=new Base_Collection_View({url:"/core/api/contacts/references?references="+g,sort_collection:false});App_Contacts.referenceContactsCollection.collection.fetch({success:function(j){if(j&&j.length>0){if(d=="CONTACT"){$.each(c,function(q,x){var w=j.get(x).get("properties");var l=40;var p="";if(w==undefined){return}var k=getPropertyValue(w,"image");if(k){p=k}else{var o=DEFAULT_GRAVATAR_url;var t='&d=404" ';var m="";try{m=text_gravatar_initials(w)}catch(s){console.log(s)}if(m.length==0){t="&d="+DEFAULT_GRAVATAR_url+'" '}var n="";n='onLoad="image_load(this)" onError="image_error(this)"_data-name="'+m;var v=getPropertyValue(w,"email");if(v){p=new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5(v)+".jpg?s="+l+t+n)}p=new Handlebars.SafeString("https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s="+l+""+t+n)}var u=getPropertyValue(j.get(x).get("properties"),"first_name");var y=getPropertyValue(j.get(x).get("properties"),"last_name");if(y){u+=" "+y}f+='<a href="#contact/'+x+'" class="activate-link thumb m-b-xs m-r-xs"><img  data-name="" src="'+p+'"  title="'+u+'" /></a>'})}else{if(d=="COMPANY"){$.each(c,function(o,v){var p="50";var u="display:inline";var s=parseInt(p);var t=4+((s-32)/2);var q=j.get(v).get("properties");var n="";var k="src='"+updateImageS3Path("img/com-default-img.png")+"' style='width:"+s+"px; height="+s+"px;"+u+"'";var l="";for(var m=0;m<q.length;m++){if(q[m].name=="image"){k="src='"+q[m].value+"' style='width:"+s+"px; height="+s+"px;"+u+";'";l="this.src='"+updateImageS3Path("img/com-default-img.png")+"'; this.onerror=null;";break}if(q[m].name=="url"){k="src='https://www.google.com/s2/favicons?domain="+q[m].value+"' style='width:"+s+"px; height="+s+"px; padding:"+t+"px; "+u+" ;'";l="this.src='"+updateImageS3Path("img/com-default-img.png")+"'; $(this).css('width','"+p+"px'); $(this).css('height','"+p+"px');$(this).css('padding','4px'); this.onerror=null;"}}n=new Handlebars.SafeString(k+' onError="'+l+'"');f+='<a href="#company/'+v+'" class="activate-link thumb m-b-xs m-r-xs"><img  '+n+' title="'+getPropertyValue(j.get(v).get("properties"),"name")+'"/></a>'
})}}$('.custom-value[name="'+a+'"]').html(f)}hideTransitionBar()}})}});Handlebars.registerHelper("convert_toISOString",function(b,a){try{return new Date(b).toISOString()}catch(c){}return b});Handlebars.registerHelper("emails_next_renewal_time",function(a,b){return getEmailsNextRenewalTime()});Handlebars.registerHelper("is_paid_emails",function(b){var a=getMaxEmailsLimit();if(a>0){return b.fn(this)}else{return b.inverse(this)}});Handlebars.registerHelper("getCurrentUserDashboards",function(d,b){var e="";if(d=="portlet"){e+=getTemplate("js-dashboards-options")}if(CURRENT_USER_DASHBOARDS){CURRENT_USER_DASHBOARDS.sort(function(g,f){return g.name.trim()<f.name.trim()?-1:g.name.trim()>f.name.trim()?1:0});var a=false;var c=_agile_get_prefs("dashboard_"+CURRENT_DOMAIN_USER.id);$.each(CURRENT_USER_DASHBOARDS,function(f,g){if(c==this.id){a=true}});$.each(CURRENT_USER_DASHBOARDS,function(g,h){if(d=="portlet"){var f=this.name;if(f){f=f.trim()}if(f&&f.length>15){f=f.substring(0,15)+"..."}if(this.name){e+="<option value="+this.id+" class='user-dashboard' title='"+this.name.trim()+"'>"+f+"</option>"}}else{var f=this.name;if(f){f=f.trim()}if(f&&f.length>30){f=f.substring(0,30)+"..."}if(g==0&&(!c||!a)){e+="<li class='active'><a id='Dashboard' class='user-defined-dashboard predefined-dashboard' href='#'>Dashboard</a></li>"}else{if(g==0){e+="<li><a id='Dashboard' class='user-defined-dashboard predefined-dashboard' href='#'>Dashboard</a></li>"}}if(c==this.id){e+="<li class='active'><a id="+this.id+" title='"+this.name.trim()+"' class='user-defined-dashboard' href='#'>"+f+"</a></li>"}else{e+="<li><a id="+this.id+" title='"+this.name.trim()+"' class='user-defined-dashboard' href='#'>"+f+"</a></li>"}if(g==CURRENT_USER_DASHBOARDS.length-1){e+=getTemplate("js-dashboards-options-newui")}}});if(CURRENT_USER_DASHBOARDS.length==0&&d=="dashboard"){e+="<li><a id='Dashboard' class='user-defined-dashboard predefined-dashboard' href='#'>Dashboard</a></li>";e+=getTemplate("js-dashboards-options-newui")}}return e});Handlebars.registerHelper("getTruncatedDashboardName",function(a){if(a&&a.trim().length>30){return a.trim().substring(0,30)+"..."}return a});Handlebars.registerHelper("is_acl_allowed",function(a){if(_plan_restrictions.is_ACL_allowed[0]()||checkForACLExceptionalUsers()){return a.inverse(this)}else{return a.fn(this)}});Handlebars.registerHelper("check_plan_interval",function(a,b){var d=USER_BILLING_PREFS.plan.plan_type;var c=d.split("_");if(!c[1]||!a){return b.inverse(this)}if(c[1]==a.toUpperCase()){return b.fn(this)}return b.inverse(this)});Handlebars.registerHelper("check_admin_ip",function(a){if($.inArray(CURRENTIP,IPCHECK)!=-1){return a.fn(this)}else{return a.inverse(this)}});Handlebars.registerHelper("getCredit",function(b,a){if(!b){return 0}return(b/100)*(-1).toFixed(2)});Handlebars.registerHelper("event_format_time",function(c,b,a){return c.format(b)});Handlebars.registerHelper("dottedEventDescription",function(b,a){return addDotsAtEnd(b)});Handlebars.registerHelper("get_template_type",function(a){return new Handlebars.SafeString(getTemplate(a,this))});Handlebars.registerHelper("is_IE_browser",function(a){return(isIEBrowser()?a.fn(this):a.inverse(this))});Handlebars.registerHelper("brainTreeStatus",function(b){var a={AUTHORIZED:"Authorized",VOIDED:"Voided",SUBMITTED_FOR_SETTLEMENT:"Submitted For Settlement",SETTLED:"Settled",AUTHORIZATION_EXPIRED:"Authorization Expired",AUTHORIZING:"Authorizing",SETTLEMENT_PENDING:"Settlement Pending",SETTLEMENT_CONFIRMED:"Settlement Confirmed",SETTLEMENT_DECLINED:"Settlement Declined",FAILED:"Failed",GATEWAY_REJECTED:"Gateway Rejected",PROCESSOR_DECLINED:"Processor Declined",SETTLING:"Settling"};return a[b]});function agile_is_mobile_browser(){return(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))}function isIEBrowser(){var a=(window.navigator.userAgent.indexOf("MSIE")!=-1);var b=(window.navigator.userAgent.indexOf("rv:11")!=-1);if(a||b){return true}return false}Handlebars.registerHelper("multiple_Property_Element_List",function(b,c,e,a){var d=agile_crm_get_List_contact_properties_list(b);if(d.length>0){return a.fn(d)}});Handlebars.registerHelper("getAliasFromArry",function(b,a){return b[0]});Handlebars.registerHelper("stringToHumanDateInFormat",function(a){if(!a){return}var b=new Date(a);if(b=="Invalid Date"){return getDateInFormatFromEpoc(a)}else{return en.dateFormatter({raw:getGlobalizeFormat()})(b)}});Handlebars.registerHelper("getSuggestionName",function(a){if(a){return uservoiceOBJ.suggestions[a]}});Handlebars.registerHelper("stringifyObject",function(a){var b={};b.id=a.id;b.name=a.name;if(a.display_name){b.display_name=a.display_name}else{b.display_name=a.name}b.listOfUsers=a.listOfUsers;return JSON.stringify(b)});Handlebars.registerHelper("removeSpecialCharacter",function(a){var a=a.replace(/[^\w\s]/gi,"-");return a});Handlebars.registerHelper("canDeleteContact",function(b,a){if(hasScope("DELETE_CONTACT")){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("isInCurrentView",function(f,d,c){try{var b;var g;if(window.location.hash.indexOf("#contact/")!=-1||window.location.hash.indexOf("#company/")!=-1){var a=window.location.hash.split("/")[1];var j=this.id;if(a==j){return c.fn(this)}}}catch(h){}return c.inverse(this)});function getLastDateOfSubscription(b){if(b.subscriptions&&b.subscriptions.data.length>0){var a;$.each(b.subscriptions.data,function(c,d){if(d.plan.id.indexOf("email")==-1){if(d.trial_end&&d.trialEnd!=null){a=d.trialEnd}else{a=d.currentPeriodEnd;var e=d.plan.id.split("-");if(e.length>0&&e[1]==24){a=a+31557600}}}});return a}return}Handlebars.registerHelper("validateSendgridWhitelabel",function(a){if(a){return"<i class='fa fa-check icon-2x' style='color:green;'></i>"}return"<i class='fa fa-times icon-2x' style='color:red;'></i>"});Handlebars.registerHelper("scope_type",function(b,a){if(b=="CONTACT"||b=="COMPANY"){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("if_equals_lowerCase",function(b,c,a){if((typeof c==="undefined")||(typeof b==="undefined")){return a.inverse(this)}if(b.toString().trim().toLowerCase()==c.toString().trim().toLowerCase()){return a.fn(this)}else{return a.inverse(this)}});Handlebars.registerHelper("if_equals_sork_key",function(b,c,a){if(b&&b.lastIndexOf("-",0)===0){b=b.substr(1)}if(b&&c&&c==b){return a.fn(this)}else{return a.inverse(this)}});Handlebars.registerHelper("if_asc_sork_key",function(b,a){if(b&&b.lastIndexOf("-",0)===0){return a.inverse(this)}else{return a.fn(this)}});Handlebars.registerHelper("affiliateCommission",function(a,b){if(!a||!b){return 0}return(((a/100)*b)/100).toFixed(2)});Handlebars.registerHelper("get_default_label",function(c,d,b){var a="admin-settings-tasks";if(d=="category"){a="admin-settings-tasks"}if(_Agile_Resources_Json[a]&&_Agile_Resources_Json[a][c]){return _Agile_Resources_Json[a][c]}else{return c}});Handlebars.registerHelper("get_widget_translation",function(c,b,a){if(!b){b="content"}var d=_agile_get_translated_val("widgets",c+"-"+b);if(!d){return c}return d});Handlebars.registerHelper("get_datasync_translation",function(b,c,a){if(!c){c="content"}return _agile_get_translated_val("prefs-data-sync",b+"-"+c)});function getTableLanguageConvertHeader(a){if(!a){return a}if(_agile_get_translated_val("contacts-view",a)){return _agile_get_translated_val("contacts-view",a)}a=ucfirst(a);if(_agile_get_translated_val("contacts-view",a)){return _agile_get_translated_val("contacts-view",a)}a=a.replace(/\w\S*/g,function(b){return b.charAt(0).toUpperCase()+b.substr(1).toLowerCase()});if(_agile_get_translated_val("contacts-view",a)){return _agile_get_translated_val("contacts-view",a)}return a}Handlebars.registerHelper("is_Particular_Domain",function(a){if(CURRENT_DOMAIN_USER.domain=="fieldglobal"){return a.fn(this)}else{return a.inverse(this)}});$(function(){var a=false;if(typeof console==="undefined"||typeof console.log==="undefined"){console={};if(a){console.log=function(b){alert(b)}}else{console.log=function(){}}}if(!IS_CONSOLE_ENABLED){console.log=function(){};if(console.warn){console.warn=function(){}}}});var recent_view;var recent_view_update_required=false;var MAX_RECENT=6;function populate_recent_menu(){if(!recent_view){var a=[];try{a=JSON.parse(localStorage.recentItems)}catch(b){}recent_view=new Base_Collection_View({restKey:"contacts",templateKey:"recent-menu",data:a,individual_tag_name:"li",sort_collection:false,postRenderCallback:function(c){$("#recent-menu").append($(c).html())}});if(recent_view.collection.length==0){$("#recent-menu>ul").html('<li class="list-group-item"><a class="disabled" style="color:black;">No Recent Activity</a></li>')}else{recent_view.render(true)}}}function add_recent_view(c){if(recent_view==undefined){populate_recent_menu()}if(!recent_view.collection.get(c.get("id"))){if(recent_view.collection.length>=MAX_RECENT){recent_view.collection.pop({silent:true})}recent_view.collection.unshift(c)}else{recent_view.collection.remove(c,{silent:true});recent_view.collection.unshift(c)}recent_view_update_required=true;var a=[];for(var b=0;b<recent_view.collection.models.length;++b){a.push(recent_view.collection.models[b].attributes)}localStorage.recentItems=JSON.stringify(a)}function modelAction(c){var d=c.dataset.id;var a=recent_view.collection.get(d);var b=a.attributes.entity_type;if(b=="contact_entity"){App_Contacts.navigate("contact/"+d,{trigger:true});$("#contactsmenu").parent().find(".active").removeClass("active");$("#contactsmenu").addClass("active")}else{if(b=="company_entity"){App_Contacts.navigate("company/"+d,{trigger:true});$("#companiesmenu").parent().find(".active").removeClass("active");$("#companiesmenu").addClass("active")}else{if(b=="deal"){App_Deal_Details.navigate("deal/"+d,{trigger:true});$("#contactsmenu").parent().find(".active").removeClass("active");$("#contactsmenu").addClass("active")}else{if(b=="case"){updatecases(a)}else{if(b=="document"||a.attributes.network_type){updateDocument(a)}}}}}recent_view_update_required=true
}$(function(){$("#recent-menu").on("click",function(a){if(recent_view==undefined){populate_recent_menu()}else{if(recent_view_update_required){recent_view.render(true)}}recent_view_update_required=false});$("#recent-menu li:first").mouseenter(function(a){a.stopPropagation();a.preventDefault();$(this).css("background-color","white")});$("#recent-menu").on("click","ul>li",function(b){b.stopPropagation();var a=$(b.target).closest("[data-id]",$(this));if(a.length){modelAction(a[0])}$("#recent-menu").removeClass("open");return false})});function loadZoomifierDocSelector(){var c=CURRENT_DOMAIN_USER.email;var b=getPropertyValue(App_Contacts.contactDetailView.model.attributes.properties,"email");var a=new Zoomifier.PickerBuilder().setPartnerKey("dwqs4rxjksqpldwqklnpes8hs=").setCallback(zoomifierDocSelectionCallback).setSalesUser(c).setTargetCustomer(b).build()}function zoomifierDocSelectionCallback(a){a="</br>"+a+"</br>";var b=$("#body").data("wysihtml5");if(b){editor.focus();b.editor.composer.commands.exec("insertHTML",a)}}$(function(){$("body_removed_event").on("click","#track_visitors",function(a){a.preventDefault();$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/CWMelsl70H4" frameborder="0" allowfullscreen></iframe></p>')});$("body_removed_event").on("click","#sync_new_signups",function(a){a.preventDefault();$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/CWMelsl70H4" frameborder="0" allowfullscreen></iframe></p>')});$("body_removed_event").on("click","#automate_email",function(a){a.preventDefault();$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/RXOqougExkM" frameborder="0" allowfullscreen></iframe></p>')});$("body_removed_event").on("click","#app_messages_popups",function(a){a.preventDefault();$("#setupContent").html('<p><iframe width="560" height="390" src="//www.youtube.com/embed/XGouq0B_7G8" frameborder="0" allowfullscreen></iframe></p>')})});var Nagger_Noty;function showUpgradeNoty(){if(!_billing_restriction.currentLimits.freePlan||agile_is_mobile_browser()){$("#free_plan_alert_info").hide();return}if(Current_Route=="subscribe"||Current_Route=="subscribe-plan"||Current_Route=="purchase-plan"){$("#free_plan_alert_info").hide()}else{$("#free_plan_alert_info").show()}}var CONTACTS_HARD_RELOAD=false;function bulkActivitiesNoty(b,c,a){CONTACTS_HARD_RELOAD=true;c=c.message;c=Handlebars.compile("{{message}}")({message:c});if(!a){showNotyPopUp(b,c,"bottomRight");return}showNotyPopUp(b,c,a)}function showNotyPopUp(c,d,a,e,b){if(c!="null"&&d!="null"){if(a=="top"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/top.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(c,d,a,e,b)})}if(a=="topCenter"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/topCenter.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(c,d,a,e,b)})}if(a=="bottomRight"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/layouts/bottomRight.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(c,d,a,e,b)})}if(a=="bottomLeft"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottomLeft.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(c,d,a,e,b)})}if(a=="bottomCenter"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottomCenter.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(c,d,a,e,b)})}if(a=="topCenter"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/topCenter.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(c,d,a,e,b)})}if(a=="bottom"){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/themes/default.js",function(){notySetup(c,d,a,e,b)})}}}function notySetup(d,e,a,b,c){$.noty.closeAll();var f=noty({text:e,layout:a,type:d,animation:{open:{height:"toggle"},close:{height:"toggle"},easing:"swing",speed:500},timeout:b!=undefined?(b=="none"?undefined:b):20000,});if(c&&typeof c=="function"&&f.options.id){Nagger_Noty=f.options.id;$("#"+f.options.id).on("click",function(g){c()})}}function get_random_message(){var b=["You are using FREE limited version of Agile CRM. <span> Upgrade Now </span> "];var a=Math.floor((Math.random()*b.length));return b[a]}var TRAIL_PENDING_DAYS;var _TRAIL_DAYS=14;function getPendingdaysIntrail(){if(a){return a}if(!_billing_restriction||!_billing_restriction.createdtime){return(a=14)}var b=(new Date().getTime()/1000)-_billing_restriction.createdtime;var c=b/(24*60*60);var a=_TRAIL_DAYS-c;if(a<0){a=0}a=Math.round(a);return a}function showSearchResults(){var a=$("#searchText").val();if(a==""){return}if(!App_Contacts){App_Contacts=new ContactsRouter()}App_Contact_Search.navigate("contacts/search/"+a,{trigger:true})}function navigateToDetailsPage(e,c){var b;for(var d=0;d<QUERY_RESULTS.length;d++){if(QUERY_RESULTS[d].id!=e){continue}b=QUERY_RESULTS[d];break}console.log(b);if(b.entity_type=="contact_entity"||b.entity_type=="company_entity"){if(b.type=="COMPANY"){App_Companies.navigate("company/"+e,{trigger:true})}else{App_Contacts.navigate("contact/"+e,{trigger:true})}return}if(b.entity_type=="deal"){if(!tight_acl.checkPermission("DEALS")){var f={};f.entity="Deals";getTemplate("no-permission",f,undefined,function(h){if(!h){return}$(h).modal("show")},null);return}console.log(b);var g=b;Backbone.history.navigate("deal/"+g.id,{trigger:true});return}if(b.entity_type=="document"){if(!tight_acl.checkPermission("DOCUMENT")){var f={};f.entity="Documents";getTemplate("no-permission",f,undefined,function(h){if(!h){return}$(h).modal("show")},null);return}console.log(b);updateDocument(new BaseModel(b));return}if(b.entity_type=="tickets"){var a="#ticket/"+b.id;Backbone.history.navigate(a,{trigger:true});return}if(!tight_acl.checkPermission("CASES")){var f={};f.entity="Cases";getTemplate("no-permission",f,undefined,function(h){if(!h){return}$(h).modal("show")},null);return}updatecases(new BaseModel(b))}$(function(){agile_type_ahead("searchText",undefined,contacts_typeahead,navigateToDetailsPage,undefined,undefined,"core/api/search/all/keyword",undefined,undefined,undefined,5,function(){var d=_agile_get_prefs("agile_search_filter_"+CURRENT_DOMAIN_USER.id);var b=JSON.parse(d);var c="type=";if(b){for(var a=0;a<b.length;a++){if(b[a]!=undefined&&b[a]!=""){c+=b[a]+","}}}console.log("checked elements  first are = "+b);return c});$("body").on("click","#search-results",function(a){showSearchResults()})});var filter_name;var CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS="toggle_dynamic_filter_"+CURRENT_DOMAIN_USER.id;var scrambled_index=0;function scramble_input_names(a){a.find("input").each(function(){$(this).attr("name","temp-"+scrambled_index);$(this).addClass("required");scrambled_index+=1})}SEARCHABLE_CONTACT_CUSTOM_FIELDS=undefined;COMPANY_CUSTOM_FIELDS=undefined;var Report_Filters_Event_View=Base_Model_View.extend({events:{"click .filter-contacts-multiple-add":"contactsFilterMultipleAdd","click .filter-contacts-multiple-add-or-rules":"contactsFilterAddOrRules","click .filter-companies-multiple-add":"companiesFilterMultipleAdd","click .filter-companies-multiple-add-or-rules":"companiesFilterAddOrRules","click i.filter-contacts-multiple-remove":"contactsFilterRemove","click .filter":"filterResults","click .default_filter":"defaultFilterResults","click #companies-filter":"companyFilterResults","change .lhs_chanined_parent":"onParentLHSChanged","change #condition > select":"onConditionChanged","change #contact_type":"onChangeContactType",},contactsFilterMultipleAdd:function(b){b.preventDefault();var c=$(b.currentTarget);var a=c;getTemplate("filter-contacts",{},undefined,function(d){if(!d){return}var e=$($(d).find(".chained-table.contact")[0]).find("tr").clone();$(e).removeClass("hide");scramble_input_names($(e));chainFilters(e,function(){},false);$(e).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(a).prev("table").find("tbody").append(e)},null)},contactsFilterAddOrRules:function(b){b.preventDefault();var c=$(b.currentTarget);var a=c;getTemplate("filter-contacts",{},undefined,function(d){if(!d){return}var e=$($(d).find(".chained-table.contact")[1]).find("tr").clone();$(e).removeClass("hide");scramble_input_names($(e));chainFilters(e,function(){},false);$(e).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(a).prev("table").find("tbody").append(e)},null)},companiesFilterMultipleAdd:function(b){b.preventDefault();var c=$(b.currentTarget);var a=c;getTemplate("filter-contacts",{},undefined,function(d){if(!d){return}var e=$($(d).find(".chained-table.company")[0]).find("tr").clone();$(e).removeClass("hide");scramble_input_names($(e));chainFilters(e,undefined,function(){},false,true);$(e).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(a).prev("table").find("tbody").append(e)},null)},companiesFilterAddOrRules:function(b){b.preventDefault();var c=$(b.currentTarget);var a=c;getTemplate("filter-contacts",{},undefined,function(d){if(!d){return}var e=$($(d).find(".chained-table.company")[1]).find("tr").clone();$(e).removeClass("hide");scramble_input_names($(e));chainFilters(e,undefined,function(){},false,true);$(e).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(a).prev("table").find("tbody").append(e)},null)},contactsFilterRemove:function(a){var b=$(a.currentTarget);$(b).closest("tr").remove()},filterResults:function(a){contact_filters_util.filterResults(a)},defaultFilterResults:function(a){a.preventDefault();revertToDefaultContacts()},companyFilterResults:function(a){contact_filters_util.companyFilterResults(a)},onParentLHSChanged:function(b){b.preventDefault();var c=$(b.currentTarget);if(($(c).val()).indexOf("tags")!=-1){var a=$(c).closest("tr").find("div#RHS");addTagsDefaultTypeahead(a)}},onConditionChanged:function(j){j.preventDefault();var l=$(j.currentTarget);if($(l).closest("td").siblings("td.lhs-block").find("option:selected").parent().attr("label")=="Properties"){var c=$(l).closest("td").siblings("td.rhs-new-block").find("#RHS-NEW");
var d=l.parents("tr").find("#LHS > select").find(":selected").text();c.find("input").attr("placeholder","Enter "+d)}if($(l).find("option:selected").hasClass("tags")){var f=$(l).parents().closest("tr").find("div#RHS");addTagsDefaultTypeahead(f)}if($(l).closest("tr").find("td.lhs-block").find("option:selected").attr("field_type")=="CONTACT"){var h=l;var g=function(m,e){setTimeout(function(){$("input",$(h).closest("tr").find("td.rhs-block")).val(e);$("input",$(h).closest("tr").find("td.rhs-block")).attr("data",m)},10)};$("input",$(l).closest("tr").find("td.rhs-block")).attr("id",$(l).closest("tr").find("td.lhs-block").find("option:selected").attr("id"));$("input",$(l).closest("tr").find("td.rhs-block")).attr("placeholder","Contact Name");$("input",$(l).closest("tr").find("td.rhs-block")).addClass("contact_custom_field");agile_type_ahead($("input",$(l).closest("tr").find("td.rhs-block")).attr("id"),$(l).closest("tr").find("td.rhs-block"),contacts_typeahead,g,"type=PERSON")}if($(l).closest("tr").find("td.lhs-block").find("option:selected").attr("field_type")=="COMPANY"){var h=l;var b=function(m,e){setTimeout(function(){$("input",$(h).closest("tr").find("td.rhs-block")).val(e);$("input",$(h).closest("tr").find("td.rhs-block")).attr("data",m)},10)};$("input",$(l).closest("tr").find("td.rhs-block")).attr("id",$(l).closest("tr").find("td.lhs-block").find("option:selected").attr("id"));$("input",$(l).closest("tr").find("td.rhs-block")).attr("placeholder","Company Name");$("input",$(l).closest("tr").find("td.rhs-block")).addClass("company_custom_field");agile_type_ahead($("input",$(l).closest("tr").find("td.rhs-block")).attr("id"),$(l).closest("tr").find("td.rhs-block"),contacts_typeahead,b,"type=COMPANY")}var k=$(l).closest("td").siblings("td.lhs-block").find("div").find("select").find("option:selected").val();if(k=="country"){var a=getTemplate("country-list",{});$(l).closest("td").siblings("td.rhs-block").find("div").html(a)}},onChangeContactType:function(a){var b=$(a.currentTarget);if($(b).val()=="COMPANY"){$("#companies-filter-wrapper").show();$("#contacts-filter-wrapper").hide()}else{$("#companies-filter-wrapper").hide();$("#contacts-filter-wrapper").show()}},});var contactFiltersListView;function setupContactFilterList(b,d){if(d){var a=Handlebars.compile('<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li  class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="m-l-xs pull-left">{{name}}</span><a class="close default_contact_remove_tag m-l-xs pull-left">&times</a></li></ul>');$(".filter-criteria",b).html(a({name:decodeURI(d)})).attr("_filter",d)}var c=null;setTimeout(function(){contactFiltersListView=new Base_Collection_View({url:"/core/api/filters?type=PERSON",sort_collection:false,restKey:"ContactFilter",templateKey:"contact-filter-list",individual_tag_name:"li",sort_collection:false,no_transition_bar:true,postRenderCallback:function(f){contactFiltersListeners("lhs_filters_conatiner");var g;if(g=_agile_get_prefs("contact_filter")){c=g;if(g.toLowerCase().indexOf("recent")>=0){g="Recent"}else{if(g.toLowerCase().indexOf("contacts")>=0){g="My Contacts"}else{if(g.toLowerCase().indexOf("leads")>=0){g="Leads"}else{if(g.indexOf("system")<0){if(contactFiltersListView.collection.get(g)){g=contactFiltersListView.collection.get(g).toJSON().name}}}}}f.find(".filter-dropdown").append(Handlebars.compile("{{name}}")({name:g}))}if(!g){return}var e=Handlebars.compile('<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="inline-block m-r-xs v-middle">{{name}}</span><a class="close default_filter">&times</a></li></ul>');$(".filter-criteria",b).html(e({name:g}));if(c){$(".filter-criteria",b).attr("_filter",c)}else{$(".filter-criteria",b).attr("_filter",g)}}});contactFiltersListView.collection.fetch();$("#filter-list",b).html(contactFiltersListView.render().el)},500)}function revertToDefaultContacts(){_agile_delete_prefs("contact_filter");_agile_delete_prefs("contact_filter_type");_agile_delete_prefs("company_filter");_agile_delete_prefs("dynamic_filter");if(App_Contacts.contactsListView){App_Contacts.contactsListView=undefined}if(App_Contacts.contact_custom_view){App_Contacts.contact_custom_view=undefined}contacts_view_loader.getContacts(App_Contacts.contactViewModel,$("#contacts-listener-container"))}function chainFiltersForContactAndCompany(a,b,c){if(b&&b.contact_type){if(b.contact_type=="PERSON"){chainFilters($(a).find(".chained-table.contact.and_rules"),b.rules,undefined,false,false);chainFilters($(a).find(".chained-table.contact.or_rules"),b.or_rules,undefined,false,false);chainFilters($(a).find(".chained-table.company.and_rules"),undefined,undefined,false,true);chainFilters($(a).find(".chained-table.company.or_rules"),undefined,c,false,true)}else{if(b.contact_type=="COMPANY"){chainFilters($(a).find(".chained-table.company.and_rules"),b.rules,undefined,false,true);chainFilters($(a).find(".chained-table.company.or_rules"),b.or_rules,undefined,false,true);chainFilters($(a).find(".chained-table.contact.and_rules"),undefined,undefined,false,false);chainFilters($(a).find(".chained-table.contact.or_rules"),undefined,c,false,false)}}}else{chainFilters($(a).find(".chained-table.contact.and_rules"),undefined,undefined,false,false);chainFilters($(a).find(".chained-table.contact.or_rules"),undefined,undefined,false,false);chainFilters($(a).find(".chained-table.company.and_rules"),undefined,undefined,false,true);chainFilters($(a).find(".chained-table.company.or_rules"),undefined,c,false,true)}}function chainFiltersForContact(a,b,c){if(b){chainFilters($(a).find(".chained-table.contact.and_rules"),b.rules,undefined,false,false);chainFilters($(a).find(".chained-table.contact.or_rules"),b.or_rules,c,false,false)}else{chainFilters($(a).find(".chained-table.contact.and_rules"),undefined,undefined,false,false);chainFilters($(a).find(".chained-table.contact.or_rules"),undefined,c,false,false)}}function chainFilters(b,d,e,a,c){if(c){fillCompanyCustomFieldsInFilters(b,function(){show_chained_fields(b,d,true);if(e&&typeof(e)==="function"){e()}});return}else{if(!SEARCHABLE_CONTACT_CUSTOM_FIELDS){fillContactCustomFieldsInFilters(b,function(){show_chained_fields(b,d,true);if(e&&typeof(e)==="function"){e()}},a);return}fillCustomFields(SEARCHABLE_CONTACT_CUSTOM_FIELDS,b,undefined,false)}show_chained_fields(b,d);if(e&&typeof(e)==="function"){e()}}function show_chained_fields(d,g,l){var k=$(d).clone();var n,f,c,j,a,b,m;n=$("#LHS",d);f=$("#condition",d);c=$("#RHS",d);j=$("#RHS-NEW",d);a=$("#nested_condition",d);b=$("#nested_rhs",d);m=$("#nested_lhs",d);c.chained(f,function(o,x){n=$("#LHS",d);c=$("#RHS",d);j=$("#RHS-NEW",d);var p=$(":selected",n).closest("optgroup").prop("label");if(p=="Properties"||p=="UTM Parameter"){var u=n.find("> select").find(":selected").text();$("input",$(n).closest("td").siblings("td.rhs-block")).attr("placeholder","Enter "+u);$($(n).closest("td").siblings("td.rhs-new-block").find("#RHS-NEW")).attr("placeholder","Enter ")}var t=$(o).find("option:selected");var s=$(t).attr("placeholder");var v=$(t).hasClass("custom_field");var w=$(t).attr("field_type");$("select",x).each(function(y,z){if($("option",z).length==0){$(this).remove()}});if(s){$("input",x).attr("placeholder",s)}if(w&&w=="LIST"){var q=$(t).attr("field_name");$("input",x).remove();$($('select[name="'+q+'"]',x)[0]).show();$('select:not([name="'+q+'"])',x).remove()}});f.chained(n);j.chained(f);a.chained(n);m.chained(a);b.chained(a);if(g&&g.rules){deserializeChainedSelect(d,g.rules,k)}else{if(g){deserializeChainedSelect(d,g,k)}}if($(":selected",n).val()&&($(":selected",n).val()).indexOf("tags")!=-1){addTagsDefaultTypeahead(c)}$(d).on("change",".lhs",function(x){x.preventDefault();var t=$(this).val();var s=$(":selected",n).closest("optgroup").prop("label");if(s=="Properties"||s=="UTM Parameter"){var o=$(":selected",this).text();$("input",$(this).closest("td").siblings("td.rhs-block")).attr("placeholder","Enter "+o)}if(t=="country"){var w=getTemplate("country-list",{});$(this).closest("td").siblings("td.rhs-block").find("div").html(w)}if(t.indexOf("tags")!=-1){addTagsDefaultTypeahead($(this).closest("td").siblings("td.rhs-block"))}if($(this).find("option:selected").attr("field_type")=="CONTACT"){var q=this;var p=function(y,v){setTimeout(function(){$("input",$(q).closest("td").siblings("td.rhs-block")).val(v);$("input",$(q).closest("td").siblings("td.rhs-block")).attr("data",y)},10)};$("input",$(this).closest("td").siblings("td.rhs-block")).attr("id",$(this).find("option:selected").attr("id"));$("input",$(this).closest("td").siblings("td.rhs-block")).attr("placeholder","Contact Name");$("input",$(this).closest("td").siblings("td.rhs-block")).addClass("contact_custom_field");agile_type_ahead($("input",$(this).closest("td").siblings("td.rhs-block")).attr("id"),$(this).closest("td").siblings("td.rhs-block"),contacts_typeahead,p,"type=PERSON")}if($(this).find("option:selected").attr("field_type")=="COMPANY"){var q=this;var u=function(y,v){setTimeout(function(){$("input",$(q).closest("td").siblings("td.rhs-block")).val(v);$("input",$(q).closest("td").siblings("td.rhs-block")).attr("data",y)},10)};$("input",$(this).closest("td").siblings("td.rhs-block")).attr("id",$(this).find("option:selected").attr("id"));$("input",$(this).closest("td").siblings("td.rhs-block")).attr("placeholder","Company Name");$("input",$(this).closest("td").siblings("td.rhs-block")).addClass("company_custom_field");agile_type_ahead($("input",$(this).closest("td").siblings("td.rhs-block")).attr("id"),$(this).closest("td").siblings("td.rhs-block"),contacts_typeahead,u,"type=COMPANY")}});if($(":selected",n).val()&&$(":selected",n).attr("field_type")=="CONTACT"){var h=function(p,o){setTimeout(function(){$("input",c).val(o);$("input",c).attr("data",p)},10)};$("input",c).attr("id",n.find("option:selected").attr("id"));$("input",c).attr("placeholder","Contact Name");$("input",c).addClass("contact_custom_field");
agile_type_ahead($("input",c).attr("id"),c,contacts_typeahead,h,"type=PERSON")}if($(":selected",n).val()&&$(":selected",n).attr("field_type")=="COMPANY"){var e=function(p,o){setTimeout(function(){$("input",c).val(o);$("input",c).attr("data",p)},10)};$("input",c).attr("id",n.find("option:selected").attr("id"));$("input",c).attr("placeholder","Company Name");$("input",c).addClass("company_custom_field");agile_type_ahead($("input",c).attr("id"),c,contacts_typeahead,e,"type=COMPANY")}}function addTagsDefaultTypeahead(b){var a=[];if(!TAGS){var c=Backbone.Collection.extend({url:"/core/api/tags",sortKey:"tag"});tagsCollection=new c();tagsCollection.fetch({success:function(d){TAGS=tagsCollection.models;addTagsArrayasTypeaheadSource(tagsCollection.toJSON(),b)}});return}addTagsArrayasTypeaheadSource(tagsCollection.toJSON(),b)}function addTagsArrayasTypeaheadSource(b,c){var a=[];$.each(b,function(d,e){a.push(e.tag.toString())});$("input",c).typeahead({source:a}).attr("placeholder","Enter Tag").width("92%")}function fillContactCustomFieldsInFilters(b,c,a){$.getJSON("core/api/custom-fields/searchable/scope?scope=CONTACT",function(d){console.log(d);SEARCHABLE_CONTACT_CUSTOM_FIELDS=d;fillCustomFields(d,b,c,a)})}function fillCompanyCustomFieldsInFilters(a,b){if(!COMPANY_CUSTOM_FIELDS){$.getJSON("core/api/custom-fields/searchable/scope?scope=COMPANY",function(c){console.log(c);COMPANY_CUSTOM_FIELDS=c;fillCustomFields(c,a,b,false)})}else{fillCustomFields(COMPANY_CUSTOM_FIELDS,a,b,false)}}var _AGILE_CUSTOM_DIVIDER_=" _AGILE_CUSTOM_DIVIDER_";var custom_chained_filter="custom_chained_class";function fillCustomFields(l,b,n,d){var h=$("#LHS > select > #custom-fields",b);var o=$("#RHS",b);var c=$("#condition > select",b);var k=" _AGILE_CUSTOM_DIVIDER_";for(var g=0;g<l.length;g++){if(g==0){h.removeClass("hide")}var m=l[g];c.append('<option value="EQUALS" custom_chained_class= "'+m.field_label+" "+k+'  custom_field" class="'+m.field_label+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+'">is</option>');c.append('<option value="NOTEQUALS" custom_chained_class= "'+m.field_label+" "+k+'  custom_field" class="'+m.field_label+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+'">isnt</option>');if(m.field_type=="DATE"){h.append('<option value="'+m.field_label+'_time" field_type="'+m.field_type+'">'+m.field_label+"</option>");var f=c.find("option.created_time");add_custom_class_to_filter_elements(f,m.field_label+"_time");$(f).addClass(m.field_label+"_time"+k);if(!d){c.append('<option value="DEFINED" custom_chained_class= "'+m.field_label+"_time "+k+'  custom_field" class="'+m.field_label+"_time "+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+'">is defined</option>');c.append('<option value="NOT_DEFINED" custom_chained_class= "'+m.field_label+"_time "+k+'  custom_field" class="'+m.field_label+"_time																																				 "+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+'">is not defined</option>')}}else{if(m.field_type=="NUMBER"){h.append('<option value="'+m.field_label+'_number" field_type="'+m.field_type+'">'+m.field_label+"</option>");var f=c.find("option.lead_score");add_custom_class_to_filter_elements(f,m.field_label+"_number");$(f).addClass(m.field_label+"_number"+k);if(!d){c.append('<option value="DEFINED" custom_chained_class= "'+m.field_label+"_number "+k+'  custom_field" class="'+m.field_label+"_number "+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+'">is defined</option>');c.append('<option value="NOT_DEFINED" custom_chained_class= "'+m.field_label+"_number "+k+'  custom_field" class="'+m.field_label+"_number "+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+'">is not defined</option>')}}else{if(m.field_type=="CONTACT"||m.field_type=="COMPANY"){h.append('<option value="'+m.field_label+'" field_type="'+m.field_type+'" id="'+m.id+'">'+m.field_label+"</option>")}else{h.append('<option value="'+m.field_label+'" field_type="'+m.field_type+'" >'+m.field_label+"</option>");if(!d){c.append('<option value="DEFINED" custom_chained_class= "'+m.field_label+" "+k+'  custom_field" class="'+m.field_label+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+'">is defined</option>');c.append('<option value="NOT_DEFINED" custom_chained_class= "'+m.field_label+" "+k+'  custom_field" class="'+m.field_label+k+' custom_field" field_type="'+m.field_type+'" field_name="'+m.field_label+'">is not defined</option>')}}}}if(d){c.append('<option value="MATCHES" custom_chained_class= "'+m.field_label+" "+k+'  custom_field" class="'+m.field_label+' custom_field" field_name="'+m.field_label+'">contains</option>');c.append('<option value="NOT_CONTAINS"  custom_chained_class= "'+m.field_label+" "+k+'  custom_field" class="'+m.field_label+' custom_field" field_name="'+m.field_label+'">doesnt contain</option>')}if(m.field_type=="LIST"){var a=m.field_data.split(";");b="<select class='form-control' style='display:none' name='"+m.field_label+"'>";for(var e=0;e<a.length;e++){b=b+'<option value="'+a[e]+'" class="EQUALS NOTEQUALS MATCHES NOT_CONTAINS" field_type="'+m.field_type+'">'+a[e]+"</option>"}b=b+"</select>";o.append(b)}console.log(o[0])}if(n&&typeof(n)==="function"){n()}}function add_custom_class_to_filter_elements(d,e){var b=$(d).attr(custom_chained_filter);var f=$(d).attr("class");if(!b){b=""}else{var a=f.split(" ");if(a&&a.length>0){for(var c=0;c<a.length;c++){b+=(_AGILE_CUSTOM_DIVIDER_+" "+a[c])}}}b+=(_AGILE_CUSTOM_DIVIDER_+" "+e);console.log(b);$(d).attr("custom_chained_class",b)}function showDynamicFilters(a){if(_agile_get_prefs(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS)=="hide"){$("#contacts-lhs-filters-toggle").hide()}else{$("#contacts-lhs-filters-toggle").show()}}var contact_filters_util={filterResults:function(b){b.preventDefault();var d=$(b.currentTarget);_agile_delete_prefs("dynamic_contact_filter");var c=$(d).attr("id");var a=$(d).attr("filter_type");_agile_set_prefs("contact_filter",c);_agile_set_prefs("contact_filter_type",a);filter_name=$(d).attr("data");CONTACTS_HARD_RELOAD=true;contacts_view_loader.getContacts(App_Contacts.contactViewModel,$("#contacts-listener-container"));return},companyFilterResults:function(a){a.preventDefault();_agile_delete_prefs("contact_filter");_agile_delete_prefs("contact_filter_type");_agile_set_prefs("company_filter","Companies");CONTACTS_HARD_RELOAD=true;App_Contacts.contacts();return},};function setupContactFields(a){$("#contact-static-fields-group",a).html(getTemplate("contact-custom-fields"));get_custom_fields(function(b){for(i=0;i<b.length;i++){getTemplate("contact-custom-fields-append",b[i],undefined,function(c){if(!c){return}$("#custom-fields-group",a).append(c)})}$.ajax({url:"core/api/contact-view-prefs",type:"GET",dataType:"json",success:function(d){console.log("");var c=$("#contact-static-fields");deserializecontactsForm(d.fields_set,c);console.log(d)}})})}var CALL_CAMPAIGN={};function campaignVariableToInitialState(){CALL_CAMPAIGN={start:false,state:"START",total_count:0,current_count:0,temp_count:0,contact_id_list:null,cursor:0,select_all:false,autodial:false,total_time:0,user_timer:0,current_contact:null,current_contact_name:null,current_contact_img:null,current_contact_email:null,current_contact_phonenumber:null,countdown_timer:0,call_duration:0,call_status:"IDEAL",contact_update:false,selected_number:null,call_from_campaign:false,remember_phone:[],last_clicked:null,tag:null,has_tag:false,callObject:null,timeObject:null}}function startCallCampaign(a){try{console.log("In startCallCampaign");console.log("Contact Ids for call campaign are "+a);if(!App_Contacts.contactsListView||!App_Contacts.contactsListView.collection){return}console.log("Collection found for starting call campaign");console.log("step1 - start call campaign is true");CALL_CAMPAIGN.start=true;console.log("step2 - showing container for call camapign");addCallContainer();console.log("step3 - updating contact in campaign");updateContactInCampaignVariable();console.log("step4 - starting call functionality");startCall()}catch(b){console.log("error-->"+b.message);CALL_CAMPAIGN.start=false;$("#startCampaignAgain").modal("show")}}function stopCallCampaign(){console.log("In stopCallCampaign");disconnectAnyTwilioCall();removeCallContainer();campaignVariableToInitialState();routeToPage("contacts")}function showSettingPage(){campaignVariableToInitialState();CALL_CAMPAIGN.contact_id_list=get_contacts_bulk_ids();if(CALL_CAMPAIGN.contact_id_list.length===0){console.log("all are selected");CALL_CAMPAIGN.select_all=true;CALL_CAMPAIGN.contact_id_list=getIdOfContacts(App_Contacts.contactsListView.collection.toJSON());CALL_CAMPAIGN.total_count=getAvailableContacts()}else{console.log("some are selected");CALL_CAMPAIGN.total_count=CALL_CAMPAIGN.contact_id_list.length}console.log(CALL_CAMPAIGN.contact_id_list);Backbone.history.loadUrl("#call-contacts")}function routeToPage(a){if(window.location.hash==("#"+a)){return}if(window.location.hash.indexOf("#"+a)!=-1){Backbone.history.loadUrl("#"+a)}else{Backbone.history.navigate(a,{trigger:true})}}function disconnectAnyTwilioCall(){if(Twilio.Device.status()=="busy"){Twilio.Device.disconnectAll()}}function hasMoreContactLeftToDial(){var a=CALL_CAMPAIGN.total_count-1;if(CALL_CAMPAIGN.current_count>=a){return false}else{return true}}function getNextContactIdSet(){console.log("in getNextContactIdSet");var a=CALL_CAMPAIGN.current_count;var b=CALL_CAMPAIGN.contact_id_list.length;if((CALL_CAMPAIGN.select_all==true)&&(a<=(b-1))&&a>=(b-3)){if(CALL_CAMPAIGN.current_count==(CALL_CAMPAIGN.total_count-1)){return}console.log("fetch next 25 contacts id in getNextContactIdSet");getNextContactsId(function(c){console.log("fetched next 25 contacts id in getNextContactIdSet");CALL_CAMPAIGN.contact_id_list=CALL_CAMPAIGN.contact_id_list.concat(c)})}}function dialNextCallAutomatically(){console.log("in dialNextCallAutomatically fu");if(hasMoreContactLeftToDial()){console.log("in dialNextCallAutomatically fu - hasMoreContactLeftToDial is true ");
console.log("setting next contact");pointToNextContact();console.log("updateContactInCampaignVariable from dialNextCallAutomatically");updateContactInCampaignVariable();console.log("changeContactDeatilView from dialNextCallAutomatically ");changeContactDeatilView();console.log("startCall from dialNextCallAutomatically ");startCall();console.log("gettine next contact set");getNextContactIdSet()}else{console.log("in dialNextCallAutomatically fu - no more contact to dail");console.log("Last call done");stopCallCampaign();var b='<center><div class="alert alert-success fade in" style="z-index:10000;margin-bottom:0px;margin-right:-4px;font-size: 14px;"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close"></a><strong>Congrats!</strong> Your call campaign has been completed successfully.</div></center>';var a=5000;showCampaignAlert(b,a);return}}function dialNextCallManually(){console.log("dialing manually next call");restartCalling();getNextContactIdSet()}function startCall(){console.log("In startCall function");console.log(CALL_CAMPAIGN.total_count);console.log(CALL_CAMPAIGN.current_count);console.log(CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count]);console.log("step1A : check if campaign is already started");if(!CALL_CAMPAIGN.start){return}console.log("step2A: reset some variable to make next call without error");resetSomeCampaignVariable();console.log("step3A : Edit call container value");editCallContainer();console.log("step4A: After 2 sec procedure will start.");setTimeout(function(){console.log("step4B: Procedure will start after 2 sec.");if(CALL_CAMPAIGN.state=="START"&&CALL_CAMPAIGN.autodial==true){makeCampaignCall()}},2000)}function updateContactInCampaignVariable(){try{console.log("inside updatecontactincampaign");console.log("CALL_CAMPAIGN.current_count "+CALL_CAMPAIGN.current_count);CALL_CAMPAIGN.current_contact=getContact(CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count]);console.log("CALL_CAMPAIGN.current_contact "+CALL_CAMPAIGN.current_contact);console.log("getting contact detail in updatecontactincampaign");getContactDetails();console.log(CALL_CAMPAIGN.current_contact)}catch(a){console.log("error"+a.message)}}function pointToNextContact(){var a=CALL_CAMPAIGN.last_clicked;if(a!="CONTINUE"&&a!="STOP"){if(CALL_CAMPAIGN.current_count<=CALL_CAMPAIGN.total_count){CALL_CAMPAIGN.current_count++}}console.log("pointToNextContact - current_count now becomes"+CALL_CAMPAIGN.current_count)}function showCampaignAlert(c,a){try{$("#call-campaign-content").show();$("div#call-campaign-content center:first").remove();$("#call-campaign-content").prepend(c);removeAlertAutomaticallyAfter(a)}catch(b){console.log("error in showCampaignAlert"+b.message)}}function makeCampaignCall(){console.log("In makeCampaignCall");console.log("Step1B: check whether to make a call or not (state)- "+CALL_CAMPAIGN.state);if(Twilio.Device.status()=="busy"){$("#alreadyOnCall").modal("show");return}if(CALL_CAMPAIGN.state==="PAUSE"){$("#pleaseWait").modal("show");return}console.log("Step2B: get selected phone number to call otherwise select default phone");if($("#call_campaign_contact_number").length){CALL_CAMPAIGN.selected_number=$("#call_campaign_contact_number option:selected").attr("value");$("#call_campaign_contact_number").attr("disabled","disabled")}else{CALL_CAMPAIGN.selected_number=getPropertyValue(CALL_CAMPAIGN.current_contact.properties,"phone")}console.log("Step2B: selected_number is "+CALL_CAMPAIGN.selected_number);console.log("Step3B: If selected number is present then dial");if(CALL_CAMPAIGN.selected_number){TWILIO_CALLTYPE="Outgoing";TWILIO_DIRECTION="outbound-dial";TWILIO_IS_VOICEMAIL=false;CALL_CAMPAIGN.call_from_campaign=true;var a=0;if(CALL_CAMPAIGN.autodial){var b=(CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count]);var d=CALL_CAMPAIGN.contact_id_list[0];if(b!=d){a=CALL_CAMPAIGN.user_timer*1000;var c=" Next call starts in ";CALL_CAMPAIGN.countdown_timer=CALL_CAMPAIGN.user_timer;changeHtml("#callStartText",c);changeHtml("#callStartTime",CALL_CAMPAIGN.countdown_timer);Tick();$("#pauseCallDiv").show();$("#campaign_resumeCall").hide();$("#campaign_pauseCall").show();$("#start").show()}}CALL_CAMPAIGN.state="PAUSE";console.log("CALL will start after -- >"+a+"sec.");console.log("Step3B.9: twiliocall function is called after n sec, where n= "+a);CALL_CAMPAIGN.callObject=setTimeout(function(){console.log("Step3B.10: Now dialing the phone number after "+a);CALL_CAMPAIGN.last_clicked=null;CALL_CAMPAIGN.state="START";twiliocall(CALL_CAMPAIGN.selected_number,getContactName(CALL_CAMPAIGN.current_contact));CALL_CAMPAIGN.callObject=null},a)}}function changeHtml(a,b){$(a).html(b)}function restartCalling(){console.log("in restartcalling function");resetSomeCampaignVariable();editCallContainer();if(CALL_CAMPAIGN.autodial==true){makeCampaignCall()}}function resetSomeCampaignVariable(){console.log("In resetSomeCampaignVariable");if($(".call_campaign_dialpad_btns").length!=0){$(".call_campaign_dialpad_btns").remove()}CALL_CAMPAIGN.call_duration=0;CALL_CAMPAIGN.countdown_timer=0;CALL_CAMPAIGN.selected_number=null;CALL_CAMPAIGN.callObject=null;CALL_CAMPAIGN.timeObject=null;CALL_CAMPAIGN.call_from_campaign=false;CALL_CAMPAIGN.contact_update=false;CALL_CAMPAIGN.call_status="IDEAL"}function getIdOfContacts(c){console.log("In getIdOfContacts");console.log(c);var b=[];for(var a=0;a<c.length;a++){b[b.length]=c[a].id}return b}function getContact(a){console.log("In getContact");return App_Contacts.contactsListView.collection.where({id:a})[0].toJSON()}function getContactDetails(){console.log("Inside getcontactdetail");To_Name=getContactName(CALL_CAMPAIGN.current_contact);console.log("name is  "+To_Name);TWILIO_CONTACT_ID=CALL_CAMPAIGN.current_contact.id;console.log("id is  "+TWILIO_CONTACT_ID);CALL_CAMPAIGN.current_contact_name=To_Name;CALL_CAMPAIGN.current_contact_email=getPropertyValue(CALL_CAMPAIGN.current_contact.properties,"email");CALL_CAMPAIGN.current_contact_phonenumber=getPhoneNumbersInArray(CALL_CAMPAIGN.current_contact.properties)}function getPhoneNumbersInArray(b){var e=[];var c="phone";for(var d=0,a=b.length;d<a;d++){if(b[d].name==c){if(b[d].value!=""||b[d].value!=null){e[e.length]=b[d].value}}}return e}function getNextContactsId(e){console.log("In getNextContactsId");var b=null;var a=_agile_get_prefs("sort_by_name");if(!a||a==null){a="-created_time";_agile_set_prefs("sort_by_name",a)}console.log("1. CALL_CAMPAIGN.cursor");console.log(CALL_CAMPAIGN.cursor);if(CALL_CAMPAIGN.cursor==0||CALL_CAMPAIGN.cursor==undefined){CALL_CAMPAIGN.cursor=getCursor()}console.log("after getcursor() CALL_CAMPAIGN.cursor");console.log(CALL_CAMPAIGN.cursor);if(!CALL_CAMPAIGN.cursor){return}var c={};var d="";if(_agile_get_prefs("dynamic_contact_filter")){b="core/api/filters/filter/dynamic-filter";c.filterJson=_agile_get_prefs("dynamic_contact_filter");c.cursor=CALL_CAMPAIGN.cursor;c.page_size=25;c.global_sort_key=a;d="POST"}else{if(_agile_get_prefs("contact_filter")){c={};b="core/api/filters/query/"+_agile_get_prefs("contact_filter")+"?cursor="+CALL_CAMPAIGN.cursor+"&page_size=25&global_sort_key="+a;d="GET"}else{c={};b="/core/api/contacts?cursor="+CALL_CAMPAIGN.cursor+"&page_size=25&global_sort_key="+a;d="GET"}}makeAjaxCall(b,false,d,c,"json",function(f){console.log("nextContacts");console.log(f);CALL_CAMPAIGN.cursor=0;console.log("after contacts fetch CALL_CAMPAIGN.cursor");var g=getIdOfContacts(f);return e(g)})}function getCursor(){try{console.log("In getCursor");var a=App_Contacts.contactsListView.collection.toJSON();var c=CALL_CAMPAIGN.contact_id_list.length-1;return a[c].cursor}catch(b){return 0}}function addCallContainer(){$("#call-campaign-content").show();$("#call-campaign-content").html(getTemplate("call-campaign-start"));$("body").find("#wrap").addClass("call-campaign-running")}function removeCallContainer(){try{$("#call-campaign-content").find("#callnoty-container").remove();$("body").find("#wrap").removeClass("call-campaign-running");if($(".call_campaign_dialpad_btns").length!=0){$(".call_campaign_dialpad_btns").remove()}}catch(a){console.log("error"+a.message)}}function removeAlertAutomaticallyAfter(b){if(CALL_CAMPAIGN.alertObject!=null){clearTimeout(CALL_CAMPAIGN.alertObject)}CALL_CAMPAIGN.alertObject=setTimeout(function a(){$("div#call-campaign-content center:first").remove()},b)}function editCallContainer(){console.log("In edit call container");CALL_CAMPAIGN.temp_count=CALL_CAMPAIGN.current_count+1;$("#call-campaign-content").find("#callnoty-container").html(getTemplate("call-campaign-body",CALL_CAMPAIGN));var a=$(getTemplate("campaign-dialpad"),{});$(".campaign_noty_buttons").append(a);console.log("In edit call container appending voicemail");accessUrlUsingAjax("core/api/voicemails",function(c){console.log("In edit call container after appended voicemail--");var b=c;getTemplate("campaign-voicemail",b,undefined,function(d){if(!d){return}$(".campaign_voicemail_buttons").html($(d))},null)});lookForSelectedNumber()}function lookForSelectedNumber(){console.log("in lookForSelectedNumber fu");CALL_CAMPAIGN.selected_number=null;CALL_CAMPAIGN.remember_phone=setSelectedPhone(CALL_CAMPAIGN.remember_phone,TWILIO_CONTACT_ID);if(CALL_CAMPAIGN.selected_number==null){if($("#call_campaign_contact_number")){if($("#call_campaign_contact_number > option").length>1){$("#call_campaign_contact_number option:selected").next().attr("selected","selected")}}}$("#call_campaign_contact_number").change(function(){console.log("In call_campaign_contact_number change function");console.log($(".noty_twilio_call"));CALL_CAMPAIGN.selected_number=$("#call_campaign_contact_number").val();CALL_CAMPAIGN.remember_phone=setValueInArray(CALL_CAMPAIGN.remember_phone,TWILIO_CONTACT_ID,CALL_CAMPAIGN.selected_number)})}function Tick(){if(CALL_CAMPAIGN.countdown_timer<=0){$("#callStartText").html("");$("#callStartTime").html("");return}CALL_CAMPAIGN.countdown_timer-=1;$("#callStartTime").html(CALL_CAMPAIGN.countdown_timer+"  sec");CALL_CAMPAIGN.timeObject=window.setTimeout("Tick()",1000)
}function setValueInArray(c,e,b){var d=c;var a=false;if(d!=undefined){$.each(d,function(f,g){if(g.id==e){a=true;g.number=b}})}else{d=[]}if(!a){d.push({id:e,number:b})}return d}function setSelectedPhone(a,c){var b=a;if(b!=undefined){$.each(b,function(d,e){if(e.id==c){if($("#call_campaign_contact_number").find('option[value="'+e.number+'"]')){$("#call_campaign_contact_number").find('option[value="'+e.number+'"]').prop("selected",true);CALL_CAMPAIGN.selected_number=e.number}else{b.splice(d,1)}}})}return b}function changeContactDeatilView(){var a=(CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count]);routeToPage("contact/"+a)}function secToColonFormat(e){var a=null;var c=0;var b=0;var d=0;if(e>=3600){b=Math.floor(e/3600);e=e-b*3600;if(b<10){b="0"+b}a=b}if(e>=60){c=Math.floor(e/60);e=e-c*60}if(c<10){c="0"+c}if(a!=null){a+=":"+c}else{a=c}d=e;if(d<10){d="0"+d}if(a!=null){a+=":"+d}else{a="00:"+d}return a}function SecondsToCampaignTime(d){if(d==0){return"0 sec"}var b=Math.floor(d/3600);if(b>0){d=d-b*60*60}var c=Math.floor(d/60);var e=d-c*60;var a="";if(b==1){a=b+" hour"}if(b>1){a=b+" hour"}if(c>0){a+=c+" min"}if(e>0){a+=e+" sec"}if(a!=""){return a}}function holdCurrentCall(){var e=twilioGetWidgetDetails();var c=$.parseJSON(e.prefs);var b=c.twilio_acc_sid;var d=c.twilio_auth_token;var a="/core/api/widgets/twilio/holdtone/"+b+"/"+d+"/"+globalconnection.parameters.CallSid}function saveTagForCampaign(){console.log("inside saveTagForCampaign --->");if(CALL_CAMPAIGN.has_tag){var b=CALL_CAMPAIGN.tag;var c=CALL_CAMPAIGN.current_contact;c.tagsWithTime.push({tag:b.toString()});var a=new Backbone.Model();a.url="core/api/contacts";a.save(c,{success:function(d){addTagToTimelineDynamically(b,d.get("tagsWithTime"));tagsCollection.add(new BaseModel({tag:b}))}});console.log("Tag added to campaign call")}}function updateTotalTime(a){CALL_CAMPAIGN.total_time=CALL_CAMPAIGN.total_time+parseInt(a);$("#totalTime").html("("+SecondsToCampaignTime(CALL_CAMPAIGN.total_time)+")")}function getTimeInArray(d){var a=0;var b=0;var e=0;var c=[0,0,0];if(d==0){return c}a=Math.floor(d/3600);if(a>0){d=d-a*60*60}b=Math.floor(d/60);e=d-b*60;c=[a,b,e];return c}function makeAjaxCall(b,d,g,e,c,a,f){if(!(a&&typeof a==="function")){a=function(){}}if(!(f&&typeof f==="function")){f=function(){}}$.ajax({url:b,async:d,method:g,data:e,dataType:c,success:a,error:f})}$(function(){$("body").on("click",".dialpad,.noty_sip_dialpad",function(a){a.preventDefault();if($(".noty_buttons").find(".dialpad_btns").html()==null){getTemplate("dialpad",{},undefined,function(b){if(!b){return}$(".noty_buttons").prepend($(b))},null)}else{$("#dialpad_btns").remove()}});$("body").on("click",".make-call",function(a){a.preventDefault();if(makeCall("sip:farah@sip2sip.info")){User_Name="farah";User_Number="sip:farah@sip2sip.info";showCallNotyPopup("outgoing","confirm",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Calling </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false)}});$("body").on("click",".contact-make-sip-call, .Sip_call",function(c){c.preventDefault();var b=$(this).closest(".contact-make-call").attr("userid");var a=$(this).closest(".contact-make-call").attr("phone");if(a==""||a==null){showAlertModal(name+"'s contact number not added.",undefined,undefined,undefined,"Error");return}if(makeCall(a)){var d=App_Contacts.contactDetailView.model.toJSON();User_Name=getContactName(d);User_Number=removeBracesFromNumber(a);User_Img=getGravatar(d.properties,40);User_ID=d.id;SIP_Call_Noty_IMG=addSipContactImg();Show_Add_Contact=false;showCallNotyPopup("outgoing","confirm",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Calling  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false)}});$("body").on("click",".hangup",function(a){a.preventDefault();showCallNotyPopup("hangup","information",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Call ended with  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',5000);hangupCall()});$("body").on("click",".ignore",function(a){showCallNotyPopup("ignored","error",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Ignored call  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',5000);Sip_Session_Call.reject(Config_Call);Is_Ignore=true;if(Notify_Call){Notify_Call.cancel();Notify_Call=null}});$("body").on("click",".answer",function(a){Sip_Session_Call.accept(Config_Call)})});function addSipContactImg(){console.log("User_Img:");console.log(User_Img);Contact_Link="";if(User_ID){Contact_Link=Contact_Link+"contact/"+User_ID}var a='<a href="#'+Contact_Link+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+DEFAULT_GRAVATAR_url+'" style="display:inline;"></a>';if(User_Img){a='<a href="#'+Contact_Link+'" style="float:left;margin-right:10px;"><img class="thumbnail" width="40" height="40" alt="" src="'+User_Img+'" style="display:inline;"></a>'}console.log("notyContactImg: "+a);return a}function removeBracesFromNumber(b){console.log("number: "+b);if(b.match("^<")&&b.match(">$")){b=b.substr(1,b.length-2)}var a=/\:([^@]+)\@/;var c=a.exec(b);if(c){console.log(c[1]);b=c[1]}return b}function newIncomingCall(c){if(Sip_Session_Call!=null){var b=c.newSession;b.setConfiguration(Config_Call);console.log(c);console.log(b);showMissedNotyPopUp("warning","<b>Missed call : </b><br>"+(b.getRemoteFriendlyName()||"unknown")+" "+removeBracesFromNumber(b.getRemoteUri()),"bottomRight");c.newSession.hangup()}else{Sip_Session_Call=c.newSession;Sip_Session_Call.setConfiguration(Config_Call);var a=(Sip_Session_Call.getRemoteFriendlyName()||"unknown");User_Name=a;User_Number=removeBracesFromNumber(Sip_Session_Call.getRemoteUri());showIncomingCall()}}function showIncomingCall(){if(notification_prefs&&notification_prefs.call===false){return}showCallNotyPopup("incoming","confirm",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Incoming call </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false);startRingTone("ringtone");show_desktop_notification("../img/plugins/sipIcon.png","Incoming Call :",User_Name+" "+User_Number,undefined,"SipCall");findContact()}function showCallNotyPopup(c,a,b,d){if(c==="incoming"||c==="missedCall"){if(notification_prefs&&notification_prefs.call===false){return}}head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/layouts/bottomRight.js",LIB_PATH+"lib/noty/themes/default.js",LIB_PATH+"lib/noty/packaged/jquery.noty.packaged.min.js",function(){if(c=="incoming"){incomingCallNoty(b,a)}else{if(c=="connected"){connectedCallNoty(b,a)}else{if(c=="outgoing"){outgoingCallNoty(b,a)}else{showCallNoty(a,b,d)}}}})}function showCallNoty(a,b,c){if(CALL!=undefined){CALL.close()}CALL=noty({text:b,type:a,layout:"bottomLeft",timeout:c,})}function incomingCallNoty(b,a){if(a=="Twilio"){if(Twilio_Call_Noty!=undefined){Twilio_Call_Noty.close()}Twilio_Call_Noty=noty({text:b,type:"confirm",layout:"bottomLeft",buttons:[{addClass:"btn btn-primary noty_twilio_answer",text:"Answer"},{addClass:"btn btn-danger noty_twilio_ignore",text:"Ignore"}]});return}if(CALL!=undefined){CALL.close()}CALL=noty({text:b,type:"confirm",layout:"bottomLeft",buttons:[{addClass:"btn btn-sm btn-primary answer",text:"Answer"},{addClass:"btn btn-danger ignore",text:"Ignore"}]})}function connectedCallNoty(b,a){if(a=="Twilio"){if(Twilio_Call_Noty!=undefined){Twilio_Call_Noty.close()}Twilio_Call_Noty=noty({text:b,type:"success",layout:"bottomLeft",buttons:[{addClass:"btn btn-sm btn-default noty_twilio_mute",text:'<i class="icon-microphone"></i>'},{addClass:"btn btn-sm btn-default noty_twilio_unmute",text:'<i class="icon-microphone-off"></i>'},{addClass:"btn btn-sm btn-default noty_twilio_dialpad",text:'<i class="icon-th"></i>'},{addClass:"btn btn-sm btn-danger noty_twilio_hangup",text:"Hangup"}]});if(TWILIO_DIRECTION=="outbound-dial"){accessUrlUsingAjax("core/api/voicemails",function(d){var c=d;getTemplate("twilioio-voicemail",c,undefined,function(e){if(!e){return}$(".noty_buttons").prepend($(e));$(".noty_buttons").prepend(getTemplate("twilioio-dialpad"))},null)})}else{getTemplate("twilioio-dialpad",{},undefined,function(c){if(!c){return}$(".noty_buttons").prepend($(c))},null)}return}if(CALL!=undefined){CALL.close()}CALL=noty({text:b,type:"success",layout:"bottomLeft",buttons:[{addClass:"btn dialpad noty_sip_dialpad",text:'<i class="icon-th"></i>'},{addClass:"btn btn-danger hangup",text:"Hangup"}]})}function outgoingCallNoty(b,a){if(a=="Twilio"){if(Twilio_Call_Noty!=undefined){Twilio_Call_Noty.close()}Twilio_Call_Noty=noty({text:b,type:"confirm",layout:"bottomLeft",buttons:[{addClass:"btn btn-default btn-sm noty_twilio_cancel",text:"Cancel"}]});return}if(CALL!=undefined){CALL.close()}CALL=noty({text:b,type:"confirm",layout:"bottomLeft",buttons:[{addClass:"btn btn-default btn-sm hangup",text:"Cancel"}]})}function voiceMailDropAction(){$("div.noty_bar").parent().css("overflow","visible")}function showMissedNotyPopUp(b,d,a,c){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/themes/default.js",function(){var e=noty({text:d,layout:a,type:b,animation:{open:{height:"toggle"},close:{height:"toggle"},easing:"swing",speed:500},timeout:c==undefined?c:(c=="none"?undefined:20000),})})}function ShowWidgetCallNoty(g){var h=g.state;var f=g.number;var d=g.callId;var b=g.displayName;var a=(g.callType).toLowerCase();console.log("calling call noty");if(g.state=="connected"){var e=[];if(a!="skype"){e.push({id:"","class":"btn btn-sm btn-default p-8 noty_"+a+"_mute icon-microphone",title:""});
e.push({id:"","class":"btn btn-sm btn-default p-8 noty_"+a+"_unmute icon-microphone-off none",title:""})}e.push({id:"","class":"btn btn-sm btn-default noty_"+a+"_dialpad icon-th",title:""});e.push({id:"","class":"btn btn-sm btn-danger noty_"+a+"_hangup",title:"Hangup"});var c={callId:d};showDraggableNoty(a,globalCall.contactedContact,"connected",globalCall.callNumber,e,c)}else{if(g.state=="ringing"){searchForContactImg(f,function(l){if(!l){globalCall.contactedContact={};globalCall.contactedId=""}else{globalCall.contactedContact=l;globalCall.contactedId=l.id}var k=[{id:"","class":"btn btn-primary noty_"+a+"_answer",title:"Answer"},{id:"","class":"btn btn-danger noty_"+a+"_ignore",title:"Ignore"}];var j={callId:d};showDraggableNoty(a,globalCall.contactedContact,"incoming",f,k,j)})}else{if(g.state=="missed"){var e=[];showDraggableNoty(a,globalCall.contactedContact,"missedCall",globalCall.callNumber,e)}else{if(g.state=="connecting"){var e=[{id:"","class":"btn btn-default btn-sm noty_"+a+"_cancel",title:"Cancel"}];var c={callId:d};showDraggableNoty(a,globalCall.contactedContact,"outgoing",f,e,c)}else{if(g.state=="failed"){var e=[];showDraggableNoty(a,globalCall.contactedContact,"failed",globalCall.callNumber,e)}else{if(g.state=="busy"){var e=[];showDraggableNoty(a,globalCall.contactedContact,"busy",globalCall.callNumber,e)}else{if(g.state=="ended"||g.state=="refused"||g.state=="missed"){closeCallNoty(true)}}}}}}}}function showBriaCallNoty(d){var e=d.state;var c=d.number;var b=d.callId;var a=d.displayName;if(!globalCall.lastReceived){}else{if(globalCall.lastReceived==d.state){console.log("duplicate message recived");return}}globalCall.lastReceived=d.state;if(d.state=="ringing"){if(checkForActiveCall()){sendCommandToClient("busy","Bria");return}}else{if(!globalCall.contactedContact){console.log("contact or id not found to make popup..");return}}if(globalCall.callDirection&&globalCall.callDirection=="Incoming"){if(!globalCallForActivity.answeredByTab){closeCallNoty(true);resetglobalCallVariables();resetglobalCallForActivityVariables();return}}_getMessageBria(d);ShowWidgetCallNoty(d);return}function showSkypeCallNoty(a){if(a.state=="ringing"){if(checkForActiveCall()){sendCommandToClient("busy","Skype");return}}else{if(!globalCall.contactedContact){console.log("contact or id not found to make popup..");return}}if(globalCall.callDirection&&globalCall.callDirection=="Incoming"){if(!globalCallForActivity.answeredByTab){closeCallNoty(true);resetglobalCallVariables();resetglobalCallForActivityVariables();return}}_getMessageSkype(a);ShowWidgetCallNoty(a);return}function showCallNotyMessage(c,b,a,d){head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/layouts/bottomRight.js",LIB_PATH+"lib/noty/themes/default.js",LIB_PATH+"lib/noty/packaged/jquery.noty.packaged.min.js",function(){noty({text:c,type:"error",layout:"bottomRight",timeout:3000})})}function showDraggableNoty(j,k,f,d,e,o){var m=j;var l={};$.extend(l,k);var p=f;var b=d;var h=e;if(!l){l={}}if(o){l.callId=o.callId}var g=makeDraggableMessage(p);l.phone=b;var a={};a.buttons=h;l.msg=a;showDraggablePopup(l);$("#noty_text_msg").html(g);if(p=="connected"){if(j=="Twilioio"){makeDraggableVoicemail();makeDraggableDialpad("twilioio-dialpad",{},$(".noty_buttons"))}else{if(j=="bria"||j=="skype"){makeDraggableDialpad("bria-widgetdialpad",{},$(".noty_buttons"))}}if(containsOption(default_call_option.callOption,"name","CallScript")!=-1&&!jQuery.isEmptyObject(k)){$("#draggable_noty #call-noty-l2").find(".internal-col").prepend("<div id='' class='noty_call_callScript btn btn-sm btn-default p-xs'>CS</div>");$(".noty_call_callScript","#draggable_noty").data("contact",k)}}else{if(p=="dialing"){$("#draggable_noty .draggable_noty_notes").html("")}else{if(p=="connecting"||p=="outgoing"||p=="ringing"||p=="incoming"){$("#draggable_noty .draggable_noty_notes").html($(getTemplate("call-noty-notes")));if(containsOption(default_call_option.callOption,"name","CallScript")!=-1&&!jQuery.isEmptyObject(k)){$("#draggable_noty #call-noty-l2").find(".internal-col").prepend("<div id='' class='noty_call_callScript btn btn-sm btn-default p-xs'>CS</div>");$(".noty_call_callScript","#draggable_noty").data("contact",k)}}}}if(p=="missedCall"||p=="missed"||p=="busy"||p=="failed"){$("#draggable_noty").show().delay(5000).hide(1)}}function showDraggablePopup(g){var c=_agile_get_prefs("dragableNotyPosition");var f=false;var h=$(window).height()-200;var b=200;if(c){var e=c.split("-");b=e[0]*1;h=e[1]*1}var d=$(getTemplate("call-noty",g));$("#draggable_noty .draggable_noty_info").html(d);$("#draggable_noty").css({left:b,top:h});$("#draggable_noty").show();$("#draggable_noty").draggableTouch();$("#draggable_noty").bind("dragstart",function(a,j){f=true}).bind("dragend",function(k,l){if(f){f=false;var j=_agile_get_prefs("dragableNotyPosition");var q=($(window).width())-190;var s=$(window).height()-100;var t=$(this).css("top").split("px")[0];var p=$(this).css("left").split("px")[0];if(p<50||p>q||t<50||t>s){var m=$(window).height()-200;var o=200;if(j){var n=j.split("-");o=n[0]*1;m=n[1]*1}if(t>s){$("#draggable_noty").animate({top:m,left:o},500)}return}else{_agile_set_prefs("dragableNotyPosition",p+"-"+t)}}})}function makeDraggableMessage(a){if(a=="connecting"||a=="outgoing"){return"Calling"}else{if(a=="ringing"||a=="incoming"){return"Incoming call"}else{if(a=="connected"){return"On call"}else{if(a=="missedCall"||a=="missed"){return"Missed call"}else{if(a=="failed"){return"Call Failed"}else{if(a=="busy"){return"Call Busy"}else{if(a=="dialing"){return"Dialing <img src='/img/ajax-loader-cursor.gif' width='15px' height='5px'  style='margin-left:8px;margin-right:-3px;'></img>"}else{return""}}}}}}}}function makeDraggableDialpad(a,c,b){getTemplate(a,c,undefined,function(d){if(!d){return}b.prepend($(d))},null)}function makeDraggableVoicemail(a){accessUrlUsingAjax("core/api/voicemails",function(b){$("#call-noty-l1").html($(getTemplate("twilioio-voicemail",b)))})}function sipStart(){setTimeout(function(){if(document.readyState==="complete"){if(Sip_Start==true){return}$.getJSON("/core/api/widgets/Sip",function(a){if(a==null){return}Sip_Widget_Object=a;if(a.prefs!=undefined){head.js(LIB_PATH+"lib/telephony/SIPml-api.js?_=v3",function(){if(SIPml.isInitialized()){sipRegister()}else{SIPml.init(sipRegister)}})}}).error(function(a){console.log("Sip error");console.log(a)})}},15000)}function sipRegister(){addAudio();Config_Call={audio_remote:document.getElementById("audio_remote"),events_listener:{events:"*",listener:sipSessionEventsListener}};if(Sip_Start==true){return}Sip_Start=true;var url=null;var credentials=eval("("+Sip_Widget_Object.prefs+")");var message=null;try{var o_impu=tsip_uri.prototype.Parse(credentials.sip_publicid);if(!o_impu||!o_impu.s_user_name||!o_impu.s_host){Sip_Start=false;message=credentials.sip_publicid+" is not a valid Public identity. Please provide valid credentials.";showCallNotyPopup("failed","error",message,5000)}else{if(credentials.sip_wsenable=="true"){console.log(window.location.protocol);if(window.location.protocol!="https:"){url="ws://rtc.agilecrm.com:10060/ws"}else{url="wss://rtc.agilecrm.com:10062/wss"}}Sip_Stack=new SIPml.Stack({realm:credentials.sip_realm,impi:credentials.sip_privateid,impu:credentials.sip_publicid,password:credentials.sip_password,display_name:credentials.sip_username,websocket_proxy_url:url,enable_rtcweb_breaker:true,events_listener:{events:"*",listener:sipStackEventsListener}});if(Sip_Stack.start()!=0){Sip_Start=false;message="Failed to start the SIP stack. Please provide valid credentials.";showCallNotyPopup("failed","error",message,5000)}}}catch(e){Sip_Start=false;message=e+" Please provide valid credentials.";showCallNotyPopup("failed","error",message,5000)}}function sipLogin(){try{Sip_Register_Session=Sip_Stack.newSession("register",{events_listener:{events:"*",listener:sipSessionEventsListener}});Sip_Register_Session.register()}catch(a){Sip_Start=false}}function sipUnRegister(){if(Sip_Stack){var a=Sip_Stack.stop();console.log("Sip_Stack.stop() :"+a);if(a!=0){sipUnRegister()}}}function addAudio(){var a=document.getElementById("audio_remote");if(a!=undefined){return}else{if(a==undefined){$("body").append('<!-- Sip Audios --><audio id="audio_remote" autoplay="autoplay" />')}}}function startRingTone(c){try{Sip_Audio=new Audio("../res/"+c+".mp3");if(typeof Sip_Audio.loop=="boolean"){Sip_Audio.loop=true}else{var a=function(){this.play()};Sip_Audio.addEventListener("ended",a,false)}Sip_Audio.play()}catch(b){console.log("Error Sip_Audio can not play.")}}function stopRingTone(){try{Sip_Audio.pause()}catch(a){console.log("Error Sip_Audio can not stop.")}}$(function(){$("body").on("click",".noty_bria_mute",function(c){c.preventDefault();var a={command:"mute"};var b=makeCallAction(a);sendActionToClient(b);$(".noty_buttons").find(".noty_bria_unmute").css("display","inline");$(".noty_buttons").find(".noty_bria_mute").toggle()});$("body").on("click",".noty_bria_unmute",function(c){c.preventDefault();var a={command:"unMute"};var b=makeCallAction(a);sendActionToClient(b);$(".noty_buttons").find(".noty_bria_unmute").toggle();$(".noty_buttons").find(".noty_bria_mute").toggle()});$("#briaInfoModal").on("click","#bria_info_ok",function(a){a.preventDefault();$("#briaInfoModal").modal("hide")});$("#briaInfoModal").on("click","#bria_status_ok",function(a){a.preventDefault();$("#briaInfoModal").modal("hide")})});function _getMessageBria(m,l){var a=m.state;var c=m.number;var g=m.callId;var j=m.displayName;var m="";try{var f=/^\s/;var d=f.test(c);if(d){c="+"+c.trimLeft()}}catch(h){}console.log("state--"+a+" number --"+c+"   briaCallId"+g+"  displayName"+j);if(a=="ringing"){globalCall.callDirection="Incoming";globalCall.callStatus="Ringing";globalCall.calledFrom="Bria";globalCall.callId=g;globalCall.callNumber=c;globalCallForActivity.justCalledId=g}else{if(a=="connected"){globalCall.callStatus="Connected"}else{if(a=="missed"){globalCall.callDirection="Incoming";globalCall.callStatus="Missed";
globalCall.callId=g;globalCall.callNumber=c;globalCallForActivity.justCalledId=g}else{if(a=="connecting"){globalCall.callDirection="Outgoing";globalCall.callStatus="Connecting";globalCall.callId=g;globalCall.callNumber=c;globalCallForActivity.justCalledId=g}else{if(a=="failed"){globalCall.callStatus="Failed";globalCallForActivity.justCalledId=g}else{if(a=="ended"){if(globalCall.callStatus&&globalCall.callStatus=="Connected"){globalCall.callStatus="Answered"}else{if(globalCall.callStatus&&globalCall.callStatus=="Connecting"){globalCall.callStatus="Busy"}else{if(globalCall.callStatus&&globalCall.callStatus=="Ringing"){globalCall.callStatus="Missed"}}}c=globalCall.callNumber;replicateglobalCallVariable();resetglobalCallVariables();if(!g){g=""}var b={command:"getLastCallDetail",number:c,callId:g};sendActionToClient(b)}}}}}}}function saveCallNoteBria(m){if(globalCallForActivity.justCalledId==globalCallForActivity.justSavedCalledIDForNote){return}globalCallForActivity.justSavedCalledIDForNote=globalCallForActivity.justCalledId;if(!globalCallForActivity.callDirection||!globalCallForActivity.callStatus||!globalCallForActivity.callNumber){return}var e=globalCallForActivity.callStatus;var l=globalCallForActivity.callDirection;var d=globalCallForActivity.callNumber;var g=globalCallForActivity.callId;var c=globalCallForActivity.duration;var a=globalCallForActivity.contactedId;var j;var h;resetglobalCallForActivityVariables();var b=l+" Call - "+e;if(l=="Incoming"){accessUrlUsingAjax("core/api/contacts/search/phonenumber/"+d,function(n){if(!n){resetCallLogVariables();if(e=="Answered"){var p={};p.url="/core/api/widgets/bria/";p.subject=b;p.number=d;p.callType="inbound";p.status="answered";p.duration=c;p.contId=null;p.contact_name="";p.widget="Bria";CallLogVariables.dynamicData=p}CallLogVariables.callWidget="Bria";CallLogVariables.callType="inbound";CallLogVariables.phone=d;CallLogVariables.duration=c;CallLogVariables.status=e;return showNewContactModal(d)}j=n;contact_name=getContactName(j);if(e=="Answered"){var p={};p.url="/core/api/widgets/bria/";p.subject=b;p.number=d;p.callType="inbound";p.status="answered";p.duration=c;p.contId=j.id;p.contact_name=contact_name;p.widget="Bria";showDynamicCallLogs(p)}else{var o={subject:b,message:"",contactid:j.id,phone:d,callType:"inbound",status:e,duration:0};autosaveNoteByUser(o,m,"/core/api/widgets/bria")}})}else{if(a){if(e=="Answered"){twilioIOSaveContactedTime(a);accessUrlUsingAjax("core/api/contacts/"+a,function(p){var n=p;if(n==null){return}contact_name=getContactName(n);var o={};o.url="/core/api/widgets/bria/";o.subject=b;o.number=d;o.callType="outbound-dial";o.status="answered";o.duration=c;o.contId=a;o.contact_name=contact_name;o.widget="Bria";showDynamicCallLogs(o)})}else{var k={subject:b,message:"",contactid:a,phone:d,callType:"outbound-dial",status:e,duration:0};autosaveNoteByUser(k,m,"/core/api/widgets/bria")}}else{resetCallLogVariables();if(e=="Answered"){var f={};f.url="/core/api/widgets/bria/";f.subject=b;f.number=d;f.callType="outbound-dial";f.status="answered";f.duration=c;f.contId=null;f.contact_name="";f.widget="Bria";CallLogVariables.dynamicData=f}CallLogVariables.callWidget="Bria";CallLogVariables.callType="outbound-dial";CallLogVariables.phone=d;CallLogVariables.duration=c;CallLogVariables.status=e;return showNewContactModal(d)}}}function autosaveNoteByUser(c,b,a){$.post("/core/api/widgets/twilio/autosavenote",{subject:c.subject,message:c.message,contactid:c.contactid,phone:c.phone,callType:c.callType,status:c.status,duration:c.duration},function(e){if(b.direction=="Outgoing"||b.direction=="outgoing"){var d=b.contactId;if(!d){return}$.post(a+"/savecallactivityById?note_id="+e.id,{id:d,direction:b.direction,phone:b.phone,status:b.status,duration:b.duration})}else{$.post(a+"/savecallactivity?note_id="+e.id,{direction:b.direction,phone:b.phone,status:b.status,duration:b.duration})}})}function saveCallActivityBria(a){if(globalCallForActivity.justCalledId==globalCallForActivity.justSavedCalledIDForActivity){return}globalCallForActivity.justSavedCalledIDForActivity=globalCallForActivity.justCalledId;if(a.status=="Answered"){return}var b=a.contactId;if(!b){return}if(a.direction=="Outgoing"||a.direction=="outgoing"){$.post("/core/api/widgets/bria/savecallactivityById",{id:b,direction:a.direction,phone:a.phone,status:a.status,duration:a.duration})}else{$.post("/core/api/widgets/bria/savecallactivity",{direction:a.direction,phone:a.phone,status:a.status,duration:a.duration})}}function getLogsForBria(b){if(window.location.hash.indexOf("contact/")==-1){return}var a;var e={};e.error_message=_agile_get_translated_val("widgets","no-phone-number-to-contact")+" <a href='#contact-edit' class='text-info' style='color:#23b7e5'>"+_agile_get_translated_val("campaigns","add-phone-number")+"</a>";e.num=agile_crm_get_contact_properties_list("phone");if($("#bria-logs-panel").length>0){$("#bria_logs_load").show()}else{getTemplate("bria-logs",e,undefined,function(f){if(!f){return}$("#Bria").html($(f));if(e.num.length==0){$("#bria_no_phone").html(e.error_message)}$("body").on("change","#bria_contact_number",function(g){$("#bria_logs_load").show();getLogsForBria($("#bria_contact_number").val())})},"#Bria")}if(b){a=b}else{$("#bria_contact_number option:eq(0)").attr("selected","selected");a=$("#bria_contact_number option:selected").val()}if(e.num.length>0){if(!a){a=e.num[0].value}var d=globalCall.calledFrom;var c={command:"getLogs",number:a,callId:""};globalCall.calledFrom="Bria";sendActionToClient(c);globalCall.calledFrom=d}}function handleLogsForBria(a){$("#bria_logs_load").hide();getTemplate("bria-logs-fetch",a.data,undefined,function(c){if(!c){return}var b=$(c);$("#bria-logs-panel").html(b);agileTimeAgoWithLngConversion($(".time-ago",b))},"#bria-logs-panel")}$(function(){$("body").on("click",".contact-make-bria-call, .Bria_call",function(c){c.preventDefault();if(checkForActiveCall()){$("#briaInfoModal").html(getTemplate("briaCallStatusModal"));$("#briaInfoModal").modal("show");return}var b={};b.command="startCall";b.number=$(this).closest(".contact-make-call").attr("phone");b.callId="";try{closeCallNoty(true);resetglobalCallVariables();resetglobalCallForActivityVariables();globalCall.callStatus="dialing";globalCall.calledFrom="Bria";setTimerToCheckDialing("bria");var a=agile_crm_get_contact();globalCall.contactedId=a.id;globalCall.contactedContact=a;sendActionToClient(b)}catch(c){}});$("body").on("click",".Skype_call",function(c){c.preventDefault();var b={};b.command="startCall";b.number=$(this).closest(".contact-make-call-div").children().first().attr("phone");b.callId="";if(checkForActiveCall()){$("#skypeInfoModal").html(getTemplate("skypeCallStatusModal"));$("#skypeInfoModal").modal("show");return}try{closeCallNoty(true);resetglobalCallVariables();resetglobalCallForActivityVariables()}catch(c){}globalCall.callStatus="dialing";globalCall.calledFrom="Skype";setTimerToCheckDialing("skype");try{var a=agile_crm_get_contact();globalCall.contactedId=a.id;globalCall.contactedContact=a;sendActionToClient(b)}catch(c){}});$("body #wrap #agilecrm-container").on("click",".noty_call_callScript",function(b){b.preventDefault();$("#draggable_noty").find(".draggable_noty_callScript").toggle();if($("#draggable_noty").find(".draggable_noty_callScript").is(":visible")){$("#draggable_noty").find(".draggable_noty_callScript").html($(getTemplate("callScript")));var a=$(this).data("contact");showvalue(a)}});$("body #wrap #agilecrm-container").on("click",".noty_bria_answer, .noty_skype_answer",function(c){c.preventDefault();var a={command:"answerCall"};var b=makeCallAction(a);sendActionToClient(b);globalCallForActivity.answeredByTab=true;play_sound("dtmf")});$("body #wrap #agilecrm-container").on("click",".noty_bria_ignore, .noty_skype_ignore",function(c){c.preventDefault();var a={command:"ignoreCall"};var b=makeCallAction(a);sendActionToClient(b);globalCallForActivity.answeredByTab=true;play_sound("dtmf")});$("body #wrap #agilecrm-container").on("click",".noty_bria_hangup, .noty_skype_hangup",function(c){c.preventDefault();if(globalCall.lastSent){if(globalCall.lastSent=="endCall"){console.log("duplicate command recived endCall");closeCallNoty(true);return}}var a={command:"endCall"};var b=makeCallAction(a);sendActionToClient(b);play_sound("dtmf")});$("body #wrap #agilecrm-container").on("click",".noty_bria_cancel, .noty_skype_cancel",function(c){c.preventDefault();if(globalCall.lastSent){if(globalCall.lastSent=="endCall"){console.log("duplicate command recived endCall");closeCallNoty(true);return}}var a={command:"cancelCall"};var b=makeCallAction(a);sendActionToClient(b);play_sound("dtmf")});$("body #wrap #agilecrm-container").on("click",".noty_bria_dialpad, .noty_skype_dialpad",function(a){a.preventDefault();a.stopPropagation();$("#dialpad_btns").toggle();if($("#dialpad_btns:visible").length>0){$("#panel-body1, #draggable-noty").css({height:"150px"})}else{$("#panel-body1, #draggable-noty").css({height:"45px"})}});$(document).on("click",function(a){if($("#dialpad_btns").length!=0){$("#dialpad_btns").hide();$("#panel-body1, #draggable-noty").css({height:"45px"})}});$("body #wrap #agilecrm-container").on("click","#dialpad_btns",function(a){a.stopPropagation()})});function makeCallAction(a){var b={};b.command=a.command;try{b.number=$("#notyCallDetails").attr("number");b.callId=$("#notyCallDetails").attr("callId")}catch(c){}return b}function sendDTMF(c){var a;a=$("#notyCallDetails").attr("callId");if(c){play_sound("dtmf");var b={command:"sendDTMF",number:c,callId:a};sendActionToClient(b);return}}function sendActionToClient(e){var g=CURRENT_DOMAIN_USER.domain;var a=CURRENT_DOMAIN_USER.id;var d=e.command;var f=e.number;var j=e.callId;var b=globalCall.calledFrom;if(d=="startCall"){var h=[];showDraggableNoty(b,globalCall.contactedContact,"dialing",globalCall.callNumber,h)}var c=new Image();c.onload=function(k){console.log("client sucess");globalCall.lastSent=d;window.focus()};c.onerror=function(l){console.log("client failure");
window.focus();resetglobalCallVariables();if(d=="getLogs"){var k={};k.data="";if(b=="Bria"){handleLogsForBria(k)}else{if(b=="Skype"){handleLogsForSkype(k)}}showCallNotyMessage("Executable file is not running");return}if(b=="Bria"){$("#briaInfoModal").html(getTemplate("briaInfoModal"));$("#briaInfoModal").modal("show");closeCallNoty(true);return}else{if(b=="Skype"){$("#skypeInfoModal").html(getTemplate("skypeInfoModal"));$("#skypeInfoModal").modal("show");closeCallNoty(true);return}}};c.src="http://localhost:33333/"+new Date().getTime()+"?command="+d+";number="+f+";callid="+j+";domain="+g+";userid="+a+";type="+b+"?"}function sipSendDTMF(a){if(Sip_Session_Call&&a){play_sound("dtmf");if(Sip_Session_Call.dtmf(a)==0){}}}var default_call_option={callOption:[]};var callOptionDiv="";var globalCall={callDirection:null,callStatus:"Ideal",callId:null,callNumber:null,timeObject:null,lastReceived:null,lastSent:null,calledFrom:null,contactedId:null,contactedContact:null};var globalCallForActivity={callDirection:null,callId:null,callNumber:null,callStatus:null,duration:0,requestedLogs:false,justCalledId:null,justSavedCalledIDForNote:null,justSavedCalledIDForActivity:null,contactedId:null,answeredByTab:false};var widgetCallName={Sip:"Sip",TwilioIO:"Twilio",Bria:"Bria",Skype:"Skype",CallScript:"CallScript"};var dialled={using:"default"};var CallLogVariables={callActivitySaved:false,id:null,callType:null,status:null,callWidget:null,duration:null,phone:null,url:null,description:null,dynamicData:null,processed:false};$(function(){initToPubNub();globalCallWidgetSet()});function getContactImage(b,a,f){try{if(a){if(a=="Outgoing"){var d=agile_crm_get_contact();getTemplate("contact-image",d,undefined,function(e){if(!e){f("")}f(e)})}else{searchForContactImg(b,function(e){if(!e){f("");return}getTemplate("contact-image",e,undefined,function(g){if(!g){f("");return}f(g)})})}}}catch(c){if(f&&typeof f==="function"){f("");return}else{return""}}}function agile_is_iPhone(){return(/iPhone/i.test(navigator.userAgent))}function globalCallWidgetSet(){$.getJSON("/core/api/widgets/availableCallWidgets",function(f){console.log("default call option selected is :"+f);$("body .contact-make-call").off("click");$("body .contact-make-call").off("dblclick");if(agile_is_mobile_browser()){if(agile_is_iPhone()){$("body").on("click",".contact-make-call",function(h){h.preventDefault();var g=$(this).attr("phone");window.location.href="tel://"+g});return}else{$("body").on("dblclick",".contact-make-call",function(h){h.preventDefault();var g=$(this).attr("phone");window.location.href="tel://"+g})}}if(f.length==0){if(agile_is_mobile_browser()){$("body").on("click",".contact-make-call",function(h){h.preventDefault();var g=$(this).attr("phone");window.location.href="tel://"+g})}return}callOptionDiv="<span class='inner-call-option m-l-sm'>";$.each(f,function(j,k){if(k!=undefined){var g={name:k.name,logo:k.mini_logo_url};addtoCallOption(g);var h=k.name;if(h!="CallScript"){callOptionDiv=callOptionDiv.concat("<img class ='"+h+"_call c-p active' src='"+k.mini_logo_url+"' style='width: 20px; height: 20px; margin-right: 5px;' data-toggle='tooltip' data-placement='top' title='' data-original-title='"+widgetCallName[h]+"'>")}}});callOptionDiv=callOptionDiv.concat("</span>");var e="";var d=_agile_get_prefs("dial-default-widget");var a=false;if(d){if(d=="Twilio"){d="TwilioIO"}var c=containsOption(default_call_option.callOption,"name",d);if(c==-1){e=""}else{a=true;e=widgetCallName[d]}}var b=false;$.each(default_call_option.callOption,function(h,j){if(!a){if(widgetCallName[j.name]=="Twilio"){e="Twilio"}else{if(e!="Twilio"&&j.name!="CallScript"){e=widgetCallName[j.name]}}}if((j.name=="Bria"||j.name=="Skype")&&!b){b=true;sendTestCommand()}var g=widgetCallName[j.name];$(".dialler-widget-name-"+g).show()});_agile_set_prefs("dial-default-widget",e);$("body").on({mouseenter:function(g){if(!Pubnub){return}else{if(!Pubnub.is_connected_call){return}}if($(".contact-make-call").hasClass("c-progress")){$(".contact-make-call").removeClass("c-progress")}$(".inner-call-option").remove();$(this).append(callOptionDiv);$('[data-toggle="tooltip"]').tooltip();if(Twilio_Start!=true){$(".TwilioIO_call").removeClass("active");$(".TwilioIO_call").addClass("disable")}if(Sip_Stack!=undefined&&Sip_Register_Session!=undefined&&Sip_Start==true){$(".Sip_call").removeClass("active");$(".Sip_call").addClass("disable")}},mouseleave:function(){$(".inner-call-option").remove()}},".contact-make-call");$("body").on({mouseenter:function(j){if(!Pubnub){return}else{if(!Pubnub.is_connected_call){return}}if($(".contact-make-skype-call").hasClass("c-progress")){$(".contact-make-skype-call").removeClass("c-progress")}$(".inner-call-option").remove();var k=default_call_option.callOption;var g=containsOption(k,"name","Skype");if(g!=-1){var h="<span class='inner-call-option m-l-sm'>";h=h.concat("<img class ='"+k[g].name+"_call c-p active' src='"+k[g].logo+"' style='width: 20px; height: 20px; margin-right: 5px;' data-toggle='tooltip' data-placement='top' title='' data-original-title='"+k[g].name+"'>");h=h.concat("</span>");$(this).append(h)}$('[data-toggle="tooltip"]').tooltip()},mouseleave:function(){$(".inner-call-option").remove()}},".contact-make-skype-call")}).error(function(a){console.log("error in fetching the default call widget name");console.log(a)})}function changeTooltipTo(a,b){$(a).tooltip("hide").attr("data-original-title",b).tooltip("fixTitle")}function removeFromCallOption(b){var a;$.each(default_call_option.callOption,function(c,d){if(d.name==b){a=c}});if(!a){return}default_call_option.callOption.splice(a,1)}function addtoCallOption(a){$.each(default_call_option.callOption,function(b,c){if(c.name==a.name){return}});default_call_option.callOption.push(a)}function containsOption(d,c,b){var a=-1;$.each(d,function(e,f){if(f[c]==b){a=e;return a}});return a}function sendTestCommand(){setTimeout(function(){if(!Pubnub){sendTestCommand();return}if(!Pubnub.is_connected_call){sendTestCommand();return}var d=new Image();var c=CURRENT_DOMAIN_USER.domain;var f=CURRENT_DOMAIN_USER.id;var e="testConnection";var b="";var a="";d.onload=function(g){console.log("test sucess");window.focus()};d.onerror=function(g){showCallNotyMessage("Executable file is not running")};d.src="http://localhost:33333/"+new Date().getTime()+"?command="+e+";number="+b+";callid="+a+";domain="+c+";userid="+f+";type=test?"},5000)}function sendCommandToClient(d,c){var d=d;var b="";var a="";if(c=="Skype"){sendMessageToSkypeClient(d,b,a)}else{sendMessageToBriaClient(d,b,a)}return}function replicateglobalCallVariable(){globalCallForActivity.callStatus=globalCall.callStatus;globalCallForActivity.callDirection=globalCall.callDirection;globalCallForActivity.callNumber=globalCall.callNumber;globalCallForActivity.callId=globalCall.callId;globalCallForActivity.contactedId=globalCall.contactedId;globalCallForActivity.requestedLogs=false}function resetglobalCallVariables(){globalCall.callDirection=null;globalCall.callStatus="Ideal";globalCall.callId=null;globalCall.callNumber=null;globalCall.lastReceived=null;globalCall.lastSent=null;globalCall.contactedId="";globalCall.contactedContact=null;if(globalCall.timeObject!=null){clearTimeout(globalCall.timeObject);globalCall.timeObject=null}}function resetglobalCallForActivityVariables(){globalCallForActivity.callDirection=null;globalCallForActivity.callStatus=null;globalCallForActivity.callId=null;globalCallForActivity.callNumber=null;globalCallForActivity.duration=0;globalCallForActivity.contactedId="";globalCallForActivity.answeredByTab=false}function resetCallLogVariables(){CallLogVariables.callActivitySaved=false;CallLogVariables.id=null;CallLogVariables.callType=null;CallLogVariables.status=null;CallLogVariables.callWidget=null;CallLogVariables.duration=null;CallLogVariables.phone=null;CallLogVariables.url=null;CallLogVariables.description=null;CallLogVariables.dynamicData=null;CallLogVariables.processed=false}function handleCallRequest(f){if((f||{}).callType=="Bria"){var c=containsOption(default_call_option.callOption,"name","Bria");if(c==-1){sendCommandToClient("notConfigured","Bria");return}if(f.state=="lastCallDetail"){if(f.direction=="Incoming"||f.direction=="inbound"){if(!globalCallForActivity.answeredByTab){return}}globalCallForActivity.duration=f.duration;var d={direction:f.direction,phone:globalCallForActivity.callNumber,status:globalCallForActivity.callStatus,duration:f.duration,contactId:globalCallForActivity.contactedId};var b=globalCallForActivity.callNumber;saveCallNoteBria(d);try{var a=$("#bria_contact_number").val();if(!a||a==""){a=agile_crm_get_contact_properties_list("phone")[0].value}if(a==b){getLogsForBria(b)}}catch(g){}return}else{if(f.state=="error"){closeCallNoty(true);resetglobalCallVariables();resetglobalCallForActivityVariables();return}else{if(f.state=="logs"){handleLogsForBria(f);return}else{if(f.state=="closed"){if(globalCall.calledFrom=="Bria"){showCallNotyMessage("Bria is not running");closeCallNoty(true);resetglobalCallVariables();resetglobalCallForActivityVariables()}return}}}}showBriaCallNoty(f);return}else{if((f||{}).callType=="Skype"){var c=containsOption(default_call_option.callOption,"name","Skype");if(c==-1){sendCommandToClient("notConfigured","Skype");return}if(f.state=="lastCallDetail"){if(f.direction=="Incoming"||f.direction=="inbound"){if(!globalCallForActivity.answeredByTab){return}}globalCallForActivity.duration=f.duration;console.log("message.direction : "+f.direction+"-----"+globalCallForActivity.callDirection);var d={direction:globalCallForActivity.callDirection,phone:globalCallForActivity.callNumber,status:globalCallForActivity.callStatus,duration:f.duration,contactId:globalCallForActivity.contactedId};var b=globalCallForActivity.callNumber;console.log("last called : "+d);saveCallNoteSkype(d);try{var a=$("#skype_contact_number").val();if(!a||a==""){a=agile_crm_get_contact_properties_list("phone")[0].value}if(a==b){getLogsForSkype(b)}}catch(g){}globalCallForActivity.requestedLogs=false;
return}else{if(f.state=="error"){closeCallNoty(true);resetglobalCallVariables();resetglobalCallForActivityVariables();return}else{if(f.state=="logs"){handleLogsForSkype(f);return}else{if(f.state=="closed"){if(globalCall.calledFrom=="Skype"){closeCallNoty(true);showCallNotyMessage("Skype is not running");resetglobalCallVariables();resetglobalCallForActivityVariables()}return}}}}showSkypeCallNoty(f);return}}}$("body").on("click","#downloadCallJar",function(a){a.preventDefault();window.location.href="https://s3.amazonaws.com/agilecrm/website/widgetCall.jar"});function checkForActiveCall(){var a=false;try{if(Twilio.Device.status()=="busy"){a=true}}catch(b){}try{if(globalCall.callStatus!="Ideal"){a=true}}catch(b){}return a}function closeCallNoty(a){if(!a){if(checkForActiveCall()){return}}$("#draggable_noty").hide();$(".draggable_noty_callScript","#draggable_noty").html("");$("#draggable_noty").removeClass("draggable-popup");if(dialled.using=="dialler"){$("#direct-dialler-div").show();dialled.using="default"}}function setTimerToCheckDialing(a){globalCall.timeObject=setTimeout(function(){if(globalCall.callStatus=="dialing"){closeCallNoty(true);var c=globalCall.contactedId;var b=globalCall.contactedContact;var d=globalCall.calledFrom;resetglobalCallVariables();resetglobalCallForActivityVariables();globalCall.calledFrom=d;globalCall.contactedId=c;globalCall.contactedContact=b}},20000)}function getPhoneWithSkypeInArray(c){var e=[];var b="phone";var f="skypePhone";for(var d=0,a=c.length;d<a;d++){if(c[d].name==b||c[d].name==f){if(c[d].value!=""||c[d].value!=null){e[e.length]=c[d].value}}}return e}function twilioIOSaveContactedTime(a){console.log("in IOSaveContactedTime");var b;if(a){b=a}else{b=agile_crm_get_contact().id}console.log("contact id = "+b);$.get("/core/api/widgets/twilio/save/time/?id="+b,function(c){console.log("processed In twilioIOSaveContactedTime");console.log("Results : "+c);console.log("result = "+c)}).error(function(c){console.log("Error - Results :"+c)})}function newCallLogVariables(a){if(!a.length>0){return}$.each(a,function(b,c){if(CallLogVariables.contains(c)){CallLogVariables[c.key]=c.value}})}$(function(){$("#skypeInfoModal").on("click","#skype_info_ok",function(a){a.preventDefault();$("#skypeInfoModal").modal("hide")});$("#skypeInfoModal").on("click","#skype_status_ok",function(a){a.preventDefault();$("#skypeInfoModal").modal("hide")})});function _getMessageSkype(m,l){var a=m.state;var c=m.number;var g=m.callId;var j=m.displayName;var m="";globalCallForActivity.justCalledId=g;try{var f=/^\s/;var d=f.test(c);if(d){c="+"+c.trimLeft()}}catch(h){}console.log("state--"+a+" number --"+c+"   skypeCallId"+g+"  displayName"+j);if(a=="ringing"){globalCall.callDirection="Incoming";globalCall.callStatus="Ringing";globalCall.calledFrom="Skype";globalCall.callId=g;globalCall.callNumber=c}else{if(a=="connected"){globalCall.callStatus="Connected"}else{if(a=="connecting"){globalCall.callDirection="Outgoing";globalCall.callStatus="Connecting";globalCall.callId=g;globalCall.callNumber=c}else{if(a=="failed"){if(globalCallForActivity.requestedLogs){return}globalCall.callStatus="Failed";globalCall.callId=g;globalCall.callNumber=c;replicateglobalCallVariable();resetglobalCallVariables();if(!g){consolee.log("call id not present...");resetglobalCallForActivityVariables();globalCallForActivity.requestedLogs=false;return}var b={command:"getLastCallDetail",number:globalCallForActivity.callNumber,callId:globalCallForActivity.callId};sendActionToClient(b)}else{if(a=="busy"){if(globalCallForActivity.requestedLogs){return}globalCall.callStatus="Busy";globalCall.callId=g;globalCall.callNumber=c;replicateglobalCallVariable();resetglobalCallVariables();if(!g){consolee.log("call id not present...");resetglobalCallForActivityVariables();globalCallForActivity.requestedLogs=false;return}var b={command:"getLastCallDetail",number:globalCallForActivity.callNumber,callId:globalCallForActivity.callId};sendActionToClient(b)}else{if(a=="refused"||a=="missed"){globalCall.callStatus="Missed";globalCall.callId=g;globalCall.callNumber=c;replicateglobalCallVariable();resetglobalCallVariables();if(!g){consolee.log("call id not present...");resetglobalCallForActivityVariables();globalCallForActivity.requestedLogs=false;return}var b={command:"getLastCallDetail",number:globalCallForActivity.callNumber,callId:globalCallForActivity.callId};sendActionToClient(b);return}else{if(a=="ended"){if(globalCall.callStatus&&globalCall.callStatus=="Connected"){globalCall.callStatus="Answered"}else{if(globalCall.callStatus&&globalCall.callStatus=="Connecting"){globalCall.callStatus="Busy"}else{if(globalCall.callStatus=="Failed"||globalCall.callStatus=="REFUSED"||globalCall.callStatus=="Ringing"||globalCall.callStatus=="Missed"){return}}}globalCall.callId=g;globalCall.callNumber=c;replicateglobalCallVariable();resetglobalCallVariables();if(!g){consolee.log("call id not present...");return}globalCallForActivity.requestedLogs=true;var b={command:"getLastCallDetail",number:globalCallForActivity.callNumber,callId:globalCallForActivity.callId};sendActionToClient(b)}}}}}}}}function saveCallActivitySkype(a){if(globalCallForActivity.justCalledId==globalCallForActivity.justSavedCalledIDForActivity){return}globalCallForActivity.justSavedCalledIDForActivity=globalCallForActivity.justCalledId;if(a.status=="Answered"){return}var b=a.contactId;if(!b){return}if(a.direction=="Outgoing"||a.direction=="outgoing"){$.post("/core/api/widgets/skype/savecallactivityById",{id:b,direction:a.direction,phone:a.phone,status:a.status,duration:a.duration})}else{$.post("/core/api/widgets/skype/savecallactivity",{direction:a.direction,phone:a.phone,status:a.status,duration:a.duration})}}function saveCallNoteSkype(n){if(globalCallForActivity.justCalledId==globalCallForActivity.justSavedCalledIDForNote){return}globalCallForActivity.justSavedCalledIDForNote=globalCallForActivity.justCalledId;if(!globalCallForActivity.callDirection||!globalCallForActivity.callStatus||!globalCallForActivity.callNumber){return}var f=globalCallForActivity.callStatus;var m=globalCallForActivity.callDirection;var e=globalCallForActivity.callNumber;var h=globalCallForActivity.callId;var d=globalCallForActivity.duration;var b=globalCallForActivity.contactedId;var k;var a;var j;resetglobalCallForActivityVariables();var c=m+" Call - "+f;if(m=="Incoming"){accessUrlUsingAjax("core/api/contacts/search/phonenumber/"+e,function(o){if(!o){resetCallLogVariables();if(f=="Answered"){var q={};q.url="/core/api/widgets/skype/";q.subject=c;q.number=e;q.callType="inbound";q.status="answered";q.duration=d;q.contId=null;q.contact_name="";q.widget="Skype";CallLogVariables.dynamicData=q}CallLogVariables.callWidget="Skype";CallLogVariables.callType="inbound";CallLogVariables.phone=e;CallLogVariables.duration=d;CallLogVariables.status=f;return showNewContactModal(e)}a=o.id;k=o;contact_name=getContactName(k);if(f=="Answered"){var q={};q.url="/core/api/widgets/skype/";q.subject=c;q.number=e;q.callType="inbound";q.status="answered";q.duration=d;q.contId=a;q.contact_name=contact_name;q.widget="Skype";showDynamicCallLogs(q)}else{var p={subject:c,message:"",contactid:a,phone:e,callType:"inbound",status:f,duration:0};autosaveNoteByUser(p,n,"/core/api/widgets/skype")}})}else{if(b){if(f=="Answered"){twilioIOSaveContactedTime(b);accessUrlUsingAjax("core/api/contacts/"+b,function(q){var o=q;if(o==null){return}contact_name=getContactName(o);var p={};p.url="/core/api/widgets/skype/";p.subject=c;p.number=e;p.callType="outbound-dial";p.status="answered";p.duration=d;p.contId=b;p.contact_name=contact_name;p.widget="Skype";showDynamicCallLogs(p)})}else{var l={subject:c,message:"",contactid:b,phone:e,callType:"outbound-dial",status:f,duration:0};autosaveNoteByUser(l,n,"/core/api/widgets/skype")}}else{resetCallLogVariables();if(f=="Answered"){var g={};g.url="/core/api/widgets/skype/";g.subject=c;g.number=e;g.callType="outbound-dial";g.status="answered";g.duration=d;g.contId=null;g.contact_name="";g.widget="Skype";CallLogVariables.dynamicData=g}CallLogVariables.callWidget="Skype";CallLogVariables.callType="outbound-dial";CallLogVariables.phone=e;CallLogVariables.duration=d;CallLogVariables.status=f;return showNewContactModal(e)}}}function getLogsForSkype(b){if(window.location.hash.indexOf("contact/")==-1){return}var a;var e={};e.error_message=_agile_get_translated_val("widgets","skype-contact-info")+" <a href='#contact-edit' class='text-info' style='color:#23b7e5'>"+_agile_get_translated_val("widgets","skype-invalid-number")+"</a>";e.num=agile_crm_get_contact_properties_list("phone");if($("#skype-logs-panel").length>0){$("#skype_logs_load").show()}else{getTemplate("skype-logs",e,undefined,function(f){if(!f){return}$("#Skype").html($(f));if(e.num.length==0){$("#skype_no_phone").html(e.error_message)}$("body").on("change","#skype_contact_number",function(g){$("#skype_logs_load").show();getLogsForSkype($("#skype_contact_number").val())})},"#Skype")}if(b){a=b}else{$("#skype_contact_number option:eq(0)").attr("selected","selected");a=$("#skype_contact_number option:selected").val()}if(e.num.length>0){if(!a){a=e.num[0].value}var d=globalCall.calledFrom;var c={command:"getLogs",number:a,callId:""};globalCall.calledFrom="Skype";sendActionToClient(c);globalCall.calledFrom=d}}function handleLogsForSkype(a){$("#skype_logs_load").hide();getTemplate("skype-logs-fetch",a.data,undefined,function(c){if(!c){return}var b=$(c);$("#skype-logs-panel").html(b);agileTimeAgoWithLngConversion($(".time-ago",b))},"#skype-logs-panel")}$(function(){$("#noteModal").on("hidden.bs.modal",function(a){console.log(CALL_CAMPAIGN.start+"  closeTwilioNoty "+CALL_CAMPAIGN.call_from_campaign);if(CALL_CAMPAIGN.last_clicked=="ADD-NOTE"){CALL_CAMPAIGN.last_clicked=null;return}if(($("#logCallModal").data("bs.modal")||{}).isShown!=true){if(CALL_CAMPAIGN.start){if(CALL_CAMPAIGN.call_status=="DISCONNECTED"){CALL_CAMPAIGN.state="START";if(CALL_CAMPAIGN.autodial){dialNextCallAutomatically()}else{dialNextCallManually()
}}}}});$("#logCallModal").on("hidden.bs.modal",function(a){console.log(CALL_CAMPAIGN.start+"  closeTwilioNoty "+CALL_CAMPAIGN.call_from_campaign);if(($("#noteModal").data("bs.modal")||{}).isShown!=true){if(CALL_CAMPAIGN.start){if(CALL_CAMPAIGN.call_status=="DISCONNECTED"){CALL_CAMPAIGN.state="START";if(CALL_CAMPAIGN.autodial){dialNextCallAutomatically()}else{dialNextCallManually()}}}}});$("#personModal").on("hidden.bs.modal",function(h){if(CALL_CAMPAIGN.start){if(CALL_CAMPAIGN.call_status=="DISCONNECTED"){CALL_CAMPAIGN.state="START";if(CALL_CAMPAIGN.autodial){dialNextCallAutomatically()}else{dialNextCallManually()}}}if(CallLogVariables.callWidget){if(CallLogVariables.dynamicData!=null){if(CallLogVariables.processed){return}}try{var g=CallLogVariables.callWidget.toLowerCase();var f=CallLogVariables.callType;var c=CallLogVariables.phone;var a=CallLogVariables.status;var d=CallLogVariables.duration;var b="/core/api/widgets/"+g+"/savecallactivity";$.post(b,{direction:f,phone:c,status:a,duration:d});resetCallLogVariables()}catch(h){}}});$("body").on("click","#timerValue",function(c){c.preventDefault();if(CALL_CAMPAIGN.start){return}var b=$(this).attr("value");var a=$(this).html();$("#call_campaign_timer").attr("value",b);$("#call_campaign_timer").html(a);CALL_CAMPAIGN.user_timer=b});$("body").on("click","#call_campaign_autodial",function(b){if(CALL_CAMPAIGN.start){return}var c=false;var a=$(this).val();$("#wrapUpDiv").hide();if(a=="autodial"){c=true;$("#wrapUpDiv").show()}CALL_CAMPAIGN.autodial=c});$("body").on("click","#bulk-close-call-campaign",function(a){a.preventDefault();console.log("Cancel call campaign");if(CALL_CAMPAIGN.callObject!=null){clearTimeout(CALL_CAMPAIGN.callObject);CALL_CAMPAIGN.callObject=null}Backbone.history.navigate("contacts",{trigger:true})});$("body").on("click","#bulk-start-call-campaign",function(g){try{g.preventDefault();if(CALL_CAMPAIGN.last_clicked=="start-bulk-campaign"){return}$("#bulk-start-call-campaign").attr("disabled","disabled");$("#bulk-start-call-campaign").html("Loading...");$("#call_campaign_autodial").attr("disabled","disabled");$("#addTag").attr("disabled","disabled");$("#rampTimeButton").attr("disabled","disabled");CALL_CAMPAIGN.user_timer=$("#call_campaign_timer").attr("value");var j=false;var c=$("input[name=call_campaign_autodial]:checked").val();if(c=="autodial"){j=true}CALL_CAMPAIGN.autodial=j;var a=$("#addTag").val().trim();if(a.length>0){if(!isValidTag(a,false)||(/^\s*$/).test(a)){console.log("not valid tag");$("#correctTag").modal("show");$("#bulk-start-call-campaign").removeAttr("disabled");$("#bulk-start-call-campaign").html("Start Campaign");$("#call_campaign_autodial").removeAttr("disabled");$("#addTag").removeAttr("disabled");$("#addTag").val("");if(CALL_CAMPAIGN.autodial==true){$("#rampTimeButton").removeAttr("disabled")}return}CALL_CAMPAIGN.tag=a;CALL_CAMPAIGN.has_tag=true}if(!Twilio_Start){var b=1000;CALL_CAMPAIGN.callObject=setTimeout(function f(){if(Twilio_Start){CALL_CAMPAIGN.last_clicked="start-bulk-campaign";var e=(CALL_CAMPAIGN.contact_id_list[0]);Backbone.history.navigate("contact/"+e,{trigger:true});CALL_CAMPAIGN.callObject=null;$(window).scrollTop(0)}else{b=b+1000;if(b<7000){CALL_CAMPAIGN.callObject=setTimeout(f,b)}else{$("#bulk-start-call-campaign").removeAttr("disabled");$("#bulk-start-call-campaign").html("Start Campaign");$("#call_campaign_autodial").removeAttr("disabled");$("#addTag").removeAttr("disabled");if(CALL_CAMPAIGN.autodial==true){$("#rampTimeButton").removeAttr("disabled")}$("#hitRefreshModel").modal("show")}}},b)}else{CALL_CAMPAIGN.last_clicked="start-bulk-campaign";var h=(CALL_CAMPAIGN.contact_id_list[0]);Backbone.history.navigate("contact/"+h,{trigger:true});$(window).scrollTop(0)}}catch(d){console.log("error in -start-call-campaign "+d.message);CALL_CAMPAIGN.last_clicked=null;$("#bulk-start-call-campaign").removeAttr("disabled");$("#bulk-start-call-campaign").html("Start Campaign");$("#call_campaign_autodial").removeAttr("disabled");$("#addTag").removeAttr("disabled");if(CALL_CAMPAIGN.autodial==true){$("#rampTimeButton").removeAttr("disabled")}}});$("body").on("click","#show-callcampaignModal",function(c){c.preventDefault();console.log("In show-callcampaignModal");if(CALL_CAMPAIGN.start){var b='<center><div class="alert alert-danger fade in" style="z-index:10000;margin-bottom:0px;margin-right:-4px;font-size: 14px;"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close"></a><strong>Alert!</strong> Call campaign is already running.</div></center>';var a=10000;showCampaignAlert(b,a);return}if(!Twilio_Start){$.getJSON("/core/api/widgets/TwilioIO",function(d){if(d==null){$("#twilioStateModal").modal("show");return}console.log("twilioio_widget");showSettingPage()}).error(function(d){console.log("twilioio_widget error");console.log(d);return});return}else{showSettingPage()}});$("body").on("click","#pause",function(a){a.preventDefault();console.log("Twilio mute from noty");$("#pauseDiv").hide();$("#resumeDiv").show();if(globalconnection){globalconnection.mute(true)}});$("body").on("click","#resume",function(a){a.preventDefault();console.log("Twilio unmute from noty");$("#resumeDiv").hide();$("#pauseDiv").show();if(globalconnection){globalconnection.mute(false)}});$("body").on("click","#stop",function(a){a.preventDefault();console.log("Twilio call noty_twilio_stop from noty");CALL_CAMPAIGN.last_clicked="STOP";$("#exitCampaignModal").modal("show")});$("body").on("click","#hangup",function(a){a.preventDefault();console.log("Twilio call hang up from noty");CALL_CAMPAIGN.last_clicked="HANGUP";if(CALL_CAMPAIGN.call_status=="DISCONNECTED"&&(($("#noteModal").data("bs.modal")||{}).isShown!=true)){CALL_CAMPAIGN.state="START";if(CALL_CAMPAIGN.autodial){dialNextCallAutomatically()}else{dialNextCallManually()}}Twilio.Device.disconnectAll()});$("body").on("click","#start",function(a){a.preventDefault();console.log("Twilio call noty_twilio_call from noty");if(CALL_CAMPAIGN.autodial){if(CALL_CAMPAIGN.callObject!=null){clearTimeout(CALL_CAMPAIGN.callObject);CALL_CAMPAIGN.callObject=null}if(CALL_CAMPAIGN.timeObject!=null){clearTimeout(CALL_CAMPAIGN.timeObject);CALL_CAMPAIGN.timeObject=null}CALL_CAMPAIGN.state="START";CALL_CAMPAIGN.last_clicked=null;CALL_CAMPAIGN.countdown_timer=0;twiliocall(CALL_CAMPAIGN.selected_number,getContactName(CALL_CAMPAIGN.current_contact))}else{if(CALL_CAMPAIGN.callObject!=null){return}makeCampaignCall()}});$("body").on("click","#noty-show-note",function(c){c.preventDefault();console.log("Twilio call noty-show-note from noty");CALL_CAMPAIGN.last_clicked="ADD-NOTE";var b=$("#noteForm");var a=Handlebars.compile('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="{{id}}">{{name}}</li>');$(".tags",b).html(a({name:CALL_CAMPAIGN.current_contact_name,id:CALL_CAMPAIGN.current_contact.id}));$("#noteForm").find("#description").focus();$("#noteModal").modal("show");agile_type_ahead("note_related_to",b,contacts_typeahead)});$("body").on("click",".noty_twilio_next",function(a){a.preventDefault();if(CALL_CAMPAIGN.call_status!="IDEAL"){$("#campaignNextModal").modal("show")}else{console.log("Twilio call noty_twilio_next from noty");CALL_CAMPAIGN.last_clicked="NEXT";dialNextCallAutomatically()}});$("body").on("click",".noty_twilio_skip",function(a){a.preventDefault();if(CALL_CAMPAIGN.current_contact_phonenumber.length!=0&&(Twilio.Device.status()=="busy"||CALL_CAMPAIGN.call_status=="CALLING")){$("#campaignSkipModal").modal("show")}else{console.log("Twilio call noty_twilio_skip from noty");if(CALL_CAMPAIGN.callObject!=null){clearTimeout(CALL_CAMPAIGN.callObject);CALL_CAMPAIGN.callObject=null}CALL_CAMPAIGN.last_clicked="SKIP";CALL_CAMPAIGN.state="START";dialNextCallAutomatically()}});$("body").on("click",".noty_twilio_previous",function(a){a.preventDefault();if(CALL_CAMPAIGN.call_status!="IDEAL"){$("#campaignPreviousModal").modal("show")}else{console.log("Twilio call noty_twilio_previous from noty");CALL_CAMPAIGN.last_clicked="PREVIOUS";CALL_CAMPAIGN.current_count=CALL_CAMPAIGN.current_count-2;dialNextCallAutomatically()}});$("body").on("click",".noty_add_phone",function(b){b.preventDefault();console.log("Twilio call noty_add_phone from noty");CALL_CAMPAIGN.last_clicked="ADD-PHONE";$(".noty_new_phone").html('<img src="'+updateImageS3Path("/img/ajax-loader.gif")+'">');CALL_CAMPAIGN.contact_update=true;var a=CALL_CAMPAIGN.current_contact;add_custom_fields_to_form(a,function(c){if(c.type=="COMPANY"){deserialize_contact(c,"continue-company")}else{deserialize_contact(c,"continue-contact")}$(".noty_new_phone").html("")},a.type)});$("body").on("click","#dialpad",function(a){a.preventDefault();a.stopPropagation();console.log("Twilio call dailpad from noty");$("#dialpad").hide();$("#campaign_dialpad_btns").show()});$("body").on("click","#campaign_dialpad_btns",function(a){a.stopPropagation()});$(document).on("click",function(a){if($("#campaign_dialpad_btns").length!=0){$("#campaign_dialpad_btns").hide();$("#dialpad").show()}});$("body").on("click","#exit_campaign_no",function(a){a.preventDefault();$("#exitCampaignModal").modal("hide")});$("body").on("click","#exit_campaign_yes",function(c){c.preventDefault();if(CALL_CAMPAIGN.start){$("#exitCampaignModal").modal("hide");if(CALL_CAMPAIGN.callObject!=null){clearTimeout(CALL_CAMPAIGN.callObject)}stopCallCampaign();var b='<center><div class="alert alert-success fade in" style="z-index:10000;margin-bottom:0px;margin-right:-4px;font-size: 14px;"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close"></a>You have successfully exited the call campaign.</div></center>';var a=10000;showCampaignAlert(b,a)}});$("body").on("click","#previous_contact_no",function(a){a.preventDefault();$("#campaignPreviousModal").modal("hide")});$("body").on("click","#previous_contact_yes",function(a){a.preventDefault();$("#campaignPreviousModal").modal("hide");console.log("Twilio call noty_twilio_previous from noty");CALL_CAMPAIGN.last_clicked="PREVIOUS";
CALL_CAMPAIGN.current_count=CALL_CAMPAIGN.current_count-2;if(CALL_CAMPAIGN.call_status=="CONNECTED"||Twilio.Device.status()=="busy"||CALL_CAMPAIGN.call_status=="CALLING"){Twilio.Device.disconnectAll()}});$("body").on("click","#next_contact_no",function(a){a.preventDefault();$("#campaignNextModal").modal("hide")});$("body").on("click","#skip_contact_no",function(a){a.preventDefault();$("#campaignSkipModal").modal("hide")});$("body").on("click","#twilio_state_skip",function(a){a.preventDefault();$("#twilioStateModal").modal("hide")});$("body").on("click","#twilio_state_add",function(a){a.preventDefault();$("#twilioStateModal").modal("hide");routeToPage("add-widget")});$("body").on("click","#info_onCall_ok",function(a){a.preventDefault();$("#alreadyOnCall").modal("hide")});$("body").on("click","#info_wait_ok",function(a){a.preventDefault();$("#pleaseWait").modal("hide")});$("body").on("click","#info_tag_ok",function(a){a.preventDefault();$("#correctTag").modal("hide")});$("body").on("click","#hitRefresh_ok",function(a){a.preventDefault();$("#hitRefreshModel").modal("hide")});$("body").on("click","#campaign_pauseCall",function(a){a.preventDefault();console.log("Twilio pause from noty");CALL_CAMPAIGN.last_clicked="PAUSE";$("#campaign_pauseCall").hide();$("#campaign_resumeCall").show();$("#callPauseText").show();$("#pauseCallDiv").tooltip("hide").attr("data-original-title","Resume current call.").tooltip("fixTitle").tooltip("show");if(CALL_CAMPAIGN.callObject!=null){clearTimeout(CALL_CAMPAIGN.callObject);CALL_CAMPAIGN.callObject=null}if(CALL_CAMPAIGN.timeObject!=null){clearTimeout(CALL_CAMPAIGN.timeObject);CALL_CAMPAIGN.timeObject=null}});$("body").on("click","#campaign_resumeCall",function(b){b.preventDefault();console.log("Twilio resume from noty");CALL_CAMPAIGN.last_clicked="RESUME";$("#campaign_resumeCall").hide();$("#campaign_pauseCall").show();$("#callPauseText").hide();$("#pauseCallDiv").tooltip("hide").attr("data-original-title","Pause current call.").tooltip("fixTitle").tooltip("show");var a=CALL_CAMPAIGN.countdown_timer*1000;Tick();CALL_CAMPAIGN.callObject=setTimeout(function(){CALL_CAMPAIGN.state="START";CALL_CAMPAIGN.last_clicked=null;twiliocall(CALL_CAMPAIGN.selected_number,getContactName(CALL_CAMPAIGN.current_contact))},a)});$("body").on("click","#next_contact_yes",function(a){a.preventDefault();$("#campaignNextModal").modal("hide");console.log("Twilio call noty_twilio_next from noty");CALL_CAMPAIGN.last_clicked="NEXT";if(CALL_CAMPAIGN.call_status=="CONNECTED"||Twilio.Device.status()=="busy"||CALL_CAMPAIGN.call_status=="CALLING"){Twilio.Device.disconnectAll()}});$("body").on("click","#skip_contact_yes",function(a){a.preventDefault();$("#campaignSkipModal").modal("hide");console.log("Twilio call noty_twilio_skip from noty");CALL_CAMPAIGN.last_clicked="SKIP";if(CALL_CAMPAIGN.callObject!=null){clearTimeout(CALL_CAMPAIGN.callObject)}if(CALL_CAMPAIGN.call_status=="CONNECTED"||Twilio.Device.status()=="busy"||CALL_CAMPAIGN.call_status=="CALLING"){Twilio.Device.disconnectAll()}});$("body").on("click","#reStartCampaign_ok",function(a){a.preventDefault();$("#startCampaignAgain").modal("hide")});window.onbeforeunload=function(){var a="You are currently running a call campaign. If you reload the page the current call campaign will be exited automatically";if(CALL_CAMPAIGN.start){return a}else{return}}});var Sip_Stack;var Sip_Register_Session;var Sip_Session_Call;var Config_Call;var Sip_Widget_Object;var User_Name;var User_Img;var User_Number;var User_ID;var SIP_Call_Noty_IMG="";var Contact_Link="";var Show_Add_Contact=false;var Is_Ignore=false;var CALL;var Notify_Call;var Sip_Start=false;var Sip_Updated=false;var No_Internet=false;var Sip_Audio;window.addEventListener("offline",function(a){No_Internet=true;sipUnRegister()},false);window.addEventListener("online",function(a){No_Internet=false;sipStart()},false);$(function(){sipStart()});function makeCall(a){if(Sip_Stack&&!Sip_Session_Call&&!tsk_string_is_null_or_empty(a)){Sip_Session_Call=Sip_Stack.newSession("call-audio",Config_Call);if(Sip_Session_Call.call(a)!=0){Sip_Session_Call=null;showCallNotyPopup("failed","error","Failed to make call.",false);return false}return true}else{if(Sip_Stack!=null&&Sip_Session_Call!=null){showAlertModal("on_call");return false}else{if(!Sip_Stack){showNotyPopUp("information","You are not register with SIP server, Please refresh the page.","top",5000);return false}}}}function hangupCall(){if(Sip_Session_Call!=null){stopRingTone();Sip_Session_Call.hangup({events_listener:{events:"*",listener:sipSessionEventsListener}})}if(Notify_Call){Notify_Call.cancel();Notify_Call=null}}function findContact(){console.log("FindContact. "+Sip_Session_Call.getRemoteUri());$.getJSON("/core/api/contacts/search/phonenumber/"+removeBracesFromNumber(Sip_Session_Call.getRemoteUri()),function(a){console.log(a);if(a!=null){User_ID=a.id;User_Name=getContactName(a);User_Number=removeBracesFromNumber(Sip_Session_Call.getRemoteUri());User_Img=getGravatar(a.properties,40);SIP_Call_Noty_IMG=addSipContactImg();if(CALL!=undefined){CALL.setText(SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Incoming call  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>')}}else{Show_Add_Contact=true}}).error(function(a){console.log("Find contact : "+a.responseText)})}$(function(){$("body").on("click",".show-dialler",function(a){a.preventDefault();getTemplate("dialler-page",{},undefined,function(f){if(!f){return}var b=100;var g=100;$("#direct-dialler-div").html($(f));$("#direct-dialler-div").css({left:b,top:g});$("#direct-dialler-div").show();var e=_agile_get_prefs("dial-default-widget");if(e){var d=e;var c=getIcon(d);$("#dialler-widget-name-span").html(c);$("#dialler-widget-name-span").attr("value",d)}$.each(default_call_option.callOption,function(j,k){var h=widgetCallName[k.name];$(".dialler-widget-name-"+h).show()});dialled.using="default";$("#direct-dialler-div").draggableTouch();$("#direct-dialler-div").bind("dragstart",function(h,j){flag=true}).bind("dragend",function(k,n){if(flag){flag=false;var j=$(window).height()-100;var m=$(this).css("top").split("px")[0];var l=$(window).height()-200;var h=200;if(m>j){$("#direct-dialler-div").animate({top:l,left:h},500)}}})},"#direct-dialler-div")});$("#agilecrm-container #direct-dialler-div").on("click",".clear-dialler",function(a){a.preventDefault();$("#dail_phone_number").val("");$("#clear-dialler").hide()});$("#agilecrm-container #direct-dialler-div").on("click",".dialler-widget-li",function(c){c.preventDefault();var a=$(this).find("a").html();var b=$(this).find("a").attr("value");$("#dialler-widget-name-span").html(a);$("#dialler-widget-name-span").attr("value",b);_agile_set_prefs("dial-default-widget",b)});$("#agilecrm-container #direct-dialler-div").on("click","#close-dialler",function(a){a.preventDefault();$("#direct-dialler-div").hide();dialled.using="default"});$("#agilecrm-container #direct-dialler-div").on("keydown","#dail_phone_number",function(a){if(a.which==13){$(".dial-number").trigger("click");$("#dialler-phone-number-form").submit()}});$("#agilecrm-container #direct-dialler-div").on("keyup","#dail_phone_number",function(b){var a=$("#dail_phone_number").val();if(!a){$("#clear-dialler").hide()}else{$("#clear-dialler").show()}});$("#agilecrm-container #direct-dialler-div").on("click",".dial-number",function(b){b.preventDefault();var d=$("#dail_phone_number").val();var c;var a=$("#dialler-widget-name-span").attr("value");if(!a){$("#diallerInfoModal").html(getTemplate("diallerInfoModal"));$(".dialler-modal-body").html("Please select a widget from the dropdown to dial.");$("#diallerInfoModal").modal("show");return}if(d.length<1){$("#diallerInfoModal").html(getTemplate("diallerInfoModal"));$(".dialler-modal-body").html("Please enter a number to dial.");$("#diallerInfoModal").modal("show");return}$("#dialler-phone-number-form").submit();if(checkForActiveCall()){alert("Already on call.");return}accessUrlUsingAjax("core/api/contacts/search/phonenumber/"+d,function(e){callToNumber(d,c,a,e,"dialler")})});$("body").on("click","#dialler_info_ok",function(a){a.preventDefault();$("#diallerInfoModal").modal("hide")});$("body #direct-dialler-div").on("click",".dial0",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","0");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial1",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","1");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial2",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","2");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial3",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","3");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial4",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","4");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial5",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","5");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial6",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","6");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial7",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","7");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial8",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","8");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial9",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","9");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial-star",function(a){a.preventDefault();insertValueInAt("#dail_phone_number","*");$("#clear-dialler").show()});$("body #direct-dialler-div").on("click",".dial-hash",function(a){a.preventDefault();
insertValueInAt("#dail_phone_number","#");$("#clear-dialler").show()})});function appendToText(a,d){var b=$(a);var c=b.val();return c+d}function callToNumber(g,f,c,a,b){dialled.using=b;if(dialled.using=="dialler"){$("#direct-dialler-div").hide()}try{if(c=="Twilio"){dialFromTwilio(g,f,a)}else{if(c=="Bria"){dialFromBria(g,f,a)}else{if(c=="Sip"){dialFromSip(g,f,a)}else{if(c=="Skype"){dialFromSkype(g,f,a)}}}}}catch(d){console.log("error occured in calltonumber function "+d);$("#direct-dialler-div").show();dialled.using="default"}}function dialFromTwilio(d,c,a){if(checkForActiveCall()){alert("Already on call.");return}var b="";TWILIO_CONTACT_ID=null;TWILIO_CONTACT=null;if(a){b=getContactName(a);TWILIO_CONTACT_ID=a.id;TWILIO_CONTACT=a}TWILIO_CALLTYPE="Outgoing";TWILIO_DIRECTION="outbound-dial";TWILIO_IS_VOICEMAIL=false;if(CALL_CAMPAIGN.start){if(CALL_CAMPAIGN.state=="PAUSE"){alert("Already on call");return}CALL_CAMPAIGN.state="PAUSE"}twiliocall(d,b,null,a)}function dialFromBria(j,h,a){var g="startCall";var c=j;var b="";if(checkForActiveCall()){$("#briaInfoModal").html(getTemplate("briaCallStatusModal"));$("#briaInfoModal").modal("show");return}var d={};d.command="startCall";d.number=j;d.callId="";try{resetglobalCallVariables();resetglobalCallForActivityVariables();globalCall.callStatus="dialing";globalCall.calledFrom="Bria";setTimerToCheckDialing("bria");if(!a){globalCall.contactedContact={};globalCall.contactedId=""}else{globalCall.contactedContact=a;globalCall.contactedId=a.id}sendActionToClient(d)}catch(f){}}function dialFromSkype(f,d,a){if(checkForActiveCall()){$("#skypeInfoModal").html(getTemplate("skypeCallStatusModal"));$("#skypeInfoModal").modal("show");return}var b={};b.command="startCall";b.number=f;b.callId="";try{resetglobalCallVariables();resetglobalCallForActivityVariables();globalCall.callStatus="dialing";globalCall.calledFrom="Skype";setTimerToCheckDialing("skype");if(!a){globalCall.contactedContact={};globalCall.contactedId=""}else{globalCall.contactedContact=a;globalCall.contactedId=a.id}sendActionToClient(b)}catch(c){}}function dialFromSip(c,b,a){if(makeCall(c)){if(a){User_Name=getContactName(a);User_Number=removeBracesFromNumber(c);User_Img=getGravatar(a.properties,40);User_ID=a.id;SIP_Call_Noty_IMG=addSipContactImg();Show_Add_Contact=false}else{User_Name="";User_Number=c;User_Img="";User_ID=null;SIP_Call_Noty_IMG="";Show_Add_Contact=true}showCallNotyPopup("outgoing","confirm",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><i class="icon icon-phone"></i><b>Calling  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false)}}function getIcon(b){var a="";if(b=="Twilio"){a="<img src='/widgets/twilio-small-logo.png' style='width: 20px; height: 20px; margin-right: 5px;' data-toggle='tooltip' data-placement='top' title='' data-original-title='Twilio' >Twilio"}else{if(b=="Sip"){a="<img src='/widgets/sip-logo-small.png' style='width: 20px; height: 20px; margin-right: 5px;' data-toggle='tooltip' data-placement='top' title='' data-original-title='Sip' >SIP"}else{if(b=="Bria"){a="<img src='/img/plugins/bria-call.png' style='width: 20px; height: 20px; margin-right: 5px;' data-toggle='tooltip' data-placement='top' title='' data-original-title='Bria' >Bria"}else{if(b=="Skype"){a="<img src='/img/plugins/skype-call.png' style='width: 24px; height: 24px; margin-right: 5px;' data-toggle='tooltip' data-placement='top' title='' data-original-title='Skype' >Skype"}}}}return a}function sipStackEventsListener(a){switch(a.type){case"started":sipLogin();break;case"failed_to_start":showCallNotyPopup("disconnected","error","SIP: There was an error registering your account. Please modify and try again.",5000);case"failed_to_stop":case"stopping":case"stopped":Sip_Start=false;Sip_Stack=null;Sip_Register_Session=null;Sip_Session_Call=null;User_Name=null;User_Number=null;User_Img=null;User_ID=null;SIP_Call_Noty_IMG="";Show_Add_Contact=false;stopRingTone();break;case"i_new_call":newIncomingCall(a);break;case"starting":break;case"m_permission_requested":break;case"m_permission_accepted":break;case"m_permission_refused":stopRingTone();showCallNotyPopup("mediaDeny","warning","SIP: Media stream permission denied.",5000);hangupCall();break;default:console.log("In sipStack event Listner. "+a.type);break}}function sipSessionEventsListener(b){switch(b.type){case"connecting":break;case"sent_request":break;case"connected":if(b.session==Sip_Register_Session){play_sound();showCallNotyPopup("register","information","SIP: You are now registered to make and receive calls successfully.",5000);if(window.webkitNotifications&&window.webkitNotifications.checkPermission()!=0){window.webkitNotifications.requestPermission()}}else{if(b.session==Sip_Session_Call){stopRingTone();showCallNotyPopup("connected","success",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>On call  </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false);if(Notify_Call){Notify_Call.cancel();Notify_Call=null}}}break;case"terminating":case"terminated":if(b.session==Sip_Register_Session){Sip_Start=false;Sip_Session_Call=null;Sip_Register_Session=null;User_Name=null;User_Number=null;User_Img=null;User_ID=null;SIP_Call_Noty_IMG="";Show_Add_Contact=false;if(Sip_Updated==true&&b.description=="Disconnecting..."){Sip_Updated=false;showCallNotyPopup("disconnected","warning","SIP : Terminated for modifications. Registering again...",5000)}else{if(No_Internet==true&&b.description=="Disconnecting..."){No_Internet=false;showCallNotyPopup("disconnected","error","SIP : Terminated because no internet connectivity.",5000)}else{showCallNotyPopup("disconnected","error","SIP : Terminated because "+b.description,5000)}}}else{if(b.session==Sip_Session_Call){Sip_Session_Call=null;stopRingTone();if(b.description=="Request Cancelled"){showCallNotyPopup("missedCall","error",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Missed call </b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',5000)}else{if(b.description=="PSTN calls are forbidden"){showCallNotyPopup("forbidden","error","SIP: PSTN calls are forbidden.",5000)}else{if(b.description=="Not acceptable here"){showCallNotyPopup("noresponce","error","SIP: Not acceptable here.",5000)}else{if(b.description=="Media stream permission denied"){showCallNotyPopup("permissiondenied","error","SIP: Media stream permission denied.",5000)}else{if(b.description=="Call terminated"){showCallNotyPopup("hangup","information",SIP_Call_Noty_IMG+'<span class="noty_contact_details"><b>Call ended with  <b>'+User_Number+'<br><a href="#'+Contact_Link+'" style="color: inherit;">'+User_Name+'</a><br></span><div class="clearfix"></div>',false)}}}}}if(dialled.using=="dialler"){$("#direct-dialler-div").show();dialled.using="default"}else{if(b.description=="Decline"){showCallNotyPopup("decline","error","Call Decline.",false)}}if(dialled.using=="dialler"){$("#direct-dialler-div").show();dialled.using="default"}else{if(b.description=="Request Timeout"){showCallNotyPopup("requestTimeout","error","SIP: Request Timeout.",false)}else{if(b.description=="Hackers Forbidden"){showCallNotyPopup("hackersForbidden","error","SIP: Hackers Forbidden.",5000)}else{if(b.description=="User not found"){showCallNotyPopup("userNotFound","error","SIP: User not found.",false)}}}}if(dialled.using=="dialler"){$("#direct-dialler-div").show();dialled.dialler="default"}else{if(b.description=="Call terminating..."){console.log("SIP : Terminated because "+b.description)}else{if(!Is_Ignore){showCallNotyPopup("disconnected","error","SIP : Terminated because "+b.description,5000)}}}if(dialled.using=="dialler"){$("#direct-dialler-div").show();dialled.using="default"}if(Show_Add_Contact==true){$("#personModal").modal("show");$("#personForm").find("#phone").val(User_Number)}User_Name=null;User_Number=null;User_Img=null;User_ID=null;SIP_Call_Noty_IMG="";Is_Ignore=false;Show_Add_Contact=false;if(Notify_Call){Notify_Call.cancel();Notify_Call=null}}}break;case"i_ao_request":if(b.session==Sip_Session_Call){var a=b.getSipResponseCode();if(a==180||a==183){startRingTone("ringbacktone")}}break;case"media_added":break;case"media_removed":break;case"i_request":break;case"o_request":break;case"cancelled_request":break;case"sent_request":break;case"transport_error":break;case"global_error":break;case"message_error":break;case"webrtc_error":break;case"m_early_media":stopRingTone();break;case"m_stream_audio_local_added":break;case"m_stream_audio_local_removed":break;case"m_stream_audio_remote_added":break;case"m_stream_audio_remote_removed":break;case"i_info":break;default:console.log("Sip Session event Listner. "+b.type);break}}function _agile_execute_callscriptrules(a){for(var b=0;b<a.length;b++){if(_agile_execute_callscriptrule(a[b])){console.log("condition applied");return}}$("#CallScript").html("<div class='wrapper-sm'>No matching call script found.</div>")}function _agile_execute_callscriptrule(d){var a=d.rules.length;for(var b=0;b<a;b++){var e=d.rules[b];if(!_agile_check_condition(e)){console.log("not matched: ");return false}}var c=replaceMergeFields(d.displaytext);$("#CallScript").html("<div class='wrapper-sm'><span class='text-base'>"+c+"</span></div>");return true}function replaceMergeFields(m){var u=m;var g=[];var n=/\{{(.*?)\}}/g;var h;while((h=n.exec(m))!=null){g.push(h[1])}var d=0;for(var f=0;f<g.length;f++){var o=g[f];if(g[f]=="score"){o="lead_score"}var c=_agile_contact.properties.length;for(var t=0;t<c;t++){if(_agile_contact.properties[t].name==g[f]){u=u.replace("{{"+g[f]+"}}",_agile_contact.properties[t].value);d++;break}else{if(_agile_contact[o]){u=u.replace("{{"+g[f]+"}}",_agile_contact[o]);d++;break}else{try{var q=g[f];q=q.split(".");var b=_agile_contact;if(q[0]=="owner"){for(var a=0;a<q.length;a++){b=b[q[a]]}}else{if(q[0]=="location"){q[0]="address";
if(_agile_contact.properties[t].name==q[0]){b=JSON.parse(_agile_contact.properties[t].value);for(var a=1;a<q.length;a++){b=b[q[a]]}}}}if(typeof b!="object"){u=u.replace("{{"+g[f]+"}}",b);d++;break}}catch(l){}}}}}while(d<g.length){var h;while((h=n.exec(u))!=null){u=u.replace(h[0],"");d++}}return u}function _agile_check_condition(a){switch(a.LHS){case"tags":switch(a.CONDITION){case"EQUALS":return _agile_rules.tags_in(a);case"NOTEQUALS":return _agile_rules.tags_out(a)}break;case"tags_time":return _agile_rules.tags_time(a);case"created_time":return _agile_rules.contact_time(a);case"title":switch(a.CONDITION){case"EQUALS":return _agile_rules.contact_properties_in(a);case"NOTEQUALS":return _agile_rules.contact_properties_out(a)}break;case"company":switch(a.CONDITION){case"EQUALS":return _agile_rules.contact_properties_in(a);case"NOTEQUALS":return _agile_rules.contact_properties_out(a)}break;case"lead_score":switch(a.CONDITION){case"IS_LESS_THAN":return _agile_rules.max_score(a);case"IS_GREATER_THAN":return _agile_rules.min_score(a);case"EQUALS":return _agile_rules.score(a)}break;case"visitor":switch(a.CONDITION){case"KNOWN":return _agile_rules.is_known_visitor(a);case"UNKNOWN":return _agile_rules.is_unknown_visitor(a)}break;case"owner_id":switch(a.CONDITION){case"EQUALS":return _agile_rules.owner_is(a);case"NOTEQUALS":return _agile_rules.owner_is_not(a)}break;default:switch(a.CONDITION){case"EQUALS":return _agile_rules.contact_properties_in(a);case"NOTEQUALS":return _agile_rules.contact_properties_out(a);case"MATCHES":return _agile_rules.contact_properties_match(a);case"NOT_CONTAINS":return _agile_rules.contact_properties_doesnot_match(a);default:return _agile_rules.custom_time(a)}}}var _agile_rules={tags_in:function(c){if(c.RHS&&_agile_contact){var b=_agile_contact.tags.length;for(var a=0;a<b;a++){if(c.RHS===_agile_contact.tags[a]){return true}}}},tags_out:function(d){if(!_agile_contact){return true}if(_agile_contact&&d.RHS){var b=0;var c=_agile_contact.tags.length;for(var a=0;a<c;a++){if(_agile_contact.tags[a]!==d.RHS){b++}}if(b==c&&b!==0&&c!==0){return true}}},tags_time:function(a){if(a.RHS&&_agile_contact){var k=a.RHS;var c=a.nested_lhs;var h=a.nested_rhs;var e=_agile_contact.tagsWithTime.length;for(var d=0;d<e;d++){if(k==_agile_contact.tagsWithTime[d].tag){var b=new Date().getTime();var g=(_agile_contact.tagsWithTime[d].createdTime);var f=(b-g);if((a.nested_condition=="LAST"&&(0<=f&&f<=(c*86400000)))||(a.nested_condition=="AFTER"&&(c<=g)&&((g-c)>=86400000))||(a.nested_condition=="BEFORE"&&(c>=g))||(a.nested_condition=="EQUALS"&&(0<=(g-c)&&(g-c)<=86400000))||(a.nested_condition=="BETWEEN"&&(c<=g&&g<=h))){return true}}}}},min_score:function(a){if(_agile_contact&&a.RHS&&_agile_contact.lead_score>a.RHS){return true}},max_score:function(a){if(_agile_contact&&a.RHS&&_agile_contact.lead_score<a.RHS){return true}},score:function(a){if(_agile_contact&&a.RHS&&_agile_contact.lead_score==a.RHS){return true}},referrer_is:function(a){if(a.RHS==document.referrer){return true}},referrer_matches:function(b){var a=document.referrer;if(a.indexOf(b.RHS)!==-1){return true}},referrer_not_matches:function(b){var a=document.referrer;if(a.indexOf(b.RHS)==-1){return true}},referrer_is_not:function(a){if(a.RHS!==document.referrer){return true}},page_view_is:function(a){if(a.RHS===document.location.href){return true}},page_view_is_not:function(a){if(a.RHS!==document.location.href){return true}},page_view_not_matches:function(b){var a=document.location.href;if(a.indexOf(b.RHS)==-1){return true}},page_view_matches:function(b){var a=document.location.href;if(a.indexOf(b.RHS)!==-1){return true}},contact_properties_in:function(c){if(_agile_contact&&c.RHS){var a=_agile_contact.properties.length;for(var b=0;b<a;b++){if(c.LHS==_agile_contact.properties[b].name&&c.RHS==_agile_contact.properties[b].value){return true}}}},contact_properties_out:function(d){if(_agile_contact&&d.RHS){var a=0;var b=_agile_contact.properties.length;for(var c=0;c<b;c++){if(d.LHS==_agile_contact.properties[c].name&&d.RHS!=_agile_contact.properties[c].value){return true}if(d.LHS!==_agile_contact.properties[c].name){a++}}if(a==b&&a!=0&&b!=0){return true}}},contact_time:function(f){if(_agile_contact&&f.RHS){var e=new Date().getTime();var c=(_agile_contact.created_time*1000);var a=(e-c);var d=f.RHS;var b=f.RHS_NEW;if((f.CONDITION=="LAST"&&(0<=a&&a<=(d*86400000)))||(f.CONDITION=="AFTER"&&(d<=c)&&((c-d)>=86400000))||(f.CONDITION=="BEFORE"&&(d>=c))||(f.CONDITION=="ON"&&(0<=(c-d)&&(c-d)<=86400000))||(f.CONDITION=="BETWEEN"&&(d<=c&&c<=b))){return true}}},custom_time:function(j){if(_agile_contact&&j.RHS){var f=j.RHS;var e=j.RHS_NEW;var a=_agile_contact.properties.length;for(var d=0;d<a;d++){if(j.LHS==(_agile_contact.properties[d].name+"_time")){var h=new Date().getTime();var c=_agile_contact.properties[d].value*1000;var b=(h-c);if((j.CONDITION=="LAST"&&(0<=b&&b<=(f*86400000)))||(j.CONDITION=="AFTER"&&(f<=c)&&((c-f)>=86400000))||(j.CONDITION=="BEFORE"&&(f>=c))||(j.CONDITION=="ON"&&(0<=(c-f)&&(c-f)<=86400000))||(j.CONDITION=="BETWEEN"&&(f<=c&&c<=e))){return true}}}}},owner_is:function(a){if(_agile_contact&&a.RHS&&_agile_contact.owner.id.toString()==a.RHS){return true}},owner_is_not:function(a){if(_agile_contact&&a.RHS&&_agile_contact.owner.id.toString()!==a.RHS){return true}},contact_properties_match:function(c){if(_agile_contact&&c.RHS){var a=_agile_contact.properties.length;for(var b=0;b<a;b++){if((c.LHS==_agile_contact.properties[b].name)&&_agile_contact.properties[b].value&&(_agile_contact.properties[b].value.indexOf(c.RHS)!==-1)){return true}}}},contact_properties_doesnot_match:function(e){if(_agile_contact&&e.RHS){var c=_agile_contact.properties.length;var b=0;for(var d=0;d<c;d++){if((e.LHS==_agile_contact.properties[d].name)&&_agile_contact.properties[d].value&&(_agile_contact.properties[d].value.indexOf(e.RHS)==-1)){return true}if(e.LHS!==_agile_contact.properties[d].name){b++}}if(b==c&&c!=0&&b!=0){return true}}},is_cart_empty:function(b){try{return(_agile_shopify_cart.item_count==0)}catch(a){}return false},is_cart_not_empty:function(b){try{return(_agile_shopify_cart.item_count!=0)}catch(a){}return false},cart_has_item:function(c){try{for(var a=0;a<_agile_shopify_cart.items.length;a++){if(c.RHS==_agile_shopify_cart.items[a].title){return true}}return false}catch(b){}return false},cart_value_greater_than:function(b){try{return((_agile_shopify_cart.total_price/100)>=b.RHS)}catch(a){}return false},cart_value_less_than:function(b){try{return((_agile_shopify_cart.total_price/100)<=b.RHS)}catch(a){}return false},is_mobile:function(b){try{return(_agile_is_mobile_browser()&&b.RHS=="MOBILE")}catch(a){}},is_not_mobile:function(b){try{return(!_agile_is_mobile_browser()&&b.RHS=="MOBILE")}catch(a){}},is_known_visitor:function(a){if(typeof _agile_email=="string"&&typeof _agile_contact!=="undefined"){return true}},is_unknown_visitor:function(a){if(typeof _agile_email!=="string"||typeof _agile_contact=="undefined"){return true}},once:function(a){if(!agile_read_cookie("agile-callscriptrules_v2")){return true}if(_agile_callscriptrule_get_cookie("agile-callscriptrules_v2",a.callscriptrule_id)){return false}},once_per_session:function(a){if(!agile_read_cookie("agile-session-callscriptrules_v2")){return true}if(_agile_callscriptrule_get_cookie("agile-session-callscriptrules_v2",a.callscriptrule_id)){return false}},max_of:function(b){if(!agile_read_cookie("agile-maxof-callscriptrules_v2")){return true}var a=_agile_callscriptrule_get_cookie("agile-maxof-callscriptrules_v2",b.callscriptrule_id);if(!a){return true}return(b.RHS>a.count)},once_every:function(c){if(!agile_read_cookie("agile-every-callscriptrules_v2")){return true}var a=_agile_callscriptrule_get_cookie("agile-every-callscriptrules_v2",c.callscriptrule_id);if(!a){return true}var b=a.time+c.RHS*1000*60;return(new Date().getTime()>b)},country_is:function(a){return(a.RHS==a.callscriptrule_country)},country_is_not:function(a){return(a.RHS!=a.callscriptrule_country)},ua_is:function(a){return(window.navigator.userAgent==a.RHS)},ua_is_not:function(a){return(window.navigator.userAgent!==a.RHS)},ua_contains:function(a){return(window.navigator.userAgent.indexOf(a.RHS)!=-1)},ua_not_contains:function(a){return(window.navigator.userAgent.indexOf(a.RHS)==-1)},everytime:function(a){return true}};function GiveCallScriptName(a,d){_agile_contact=a;CallScript_PLUGIN_NAME="CallScript";var b=null;if(App_Widgets.Catalog_Widgets_View){b=App_Widgets.Catalog_Widgets_View.collection.where({name:CallScript_PLUGIN_NAME})[0].toJSON()}else{if(window.location.hash.indexOf("#contact/")!=-1){b=agile_crm_get_widget(CallScript_PLUGIN_NAME)}else{$.getJSON("/core/api/widgets/CallScript",function(e){b=e;var f=GiveRulesInArray(b);return d(f)})}}if(b){var c=GiveRulesInArray(b);return d(c)}}function GiveRulesInArray(c){var f=[];if(c){if(c.prefs==undefined||c.prefs=="{}"){console.log("no rule defined");return f}var b=JSON.parse(c.prefs);var a=b.csrules;for(var e=0;e<a.length;e++){var d=a[e].name;f.push(d);console.log("name is "+d)}}return f}function GiveCallScriptText(c,a,e){if(!a){return"!@#"}_agile_contact=a;CallScript_PLUGIN_NAME="CallScript";var b=null;if(App_Widgets.Catalog_Widgets_View){b=App_Widgets.Catalog_Widgets_View.collection.where({name:CallScript_PLUGIN_NAME})[0].toJSON()}else{if(window.location.hash.indexOf("#contact/")!=-1){b=agile_crm_get_widget(CallScript_PLUGIN_NAME)}else{$.getJSON("/core/api/widgets/CallScript",function(g){b=g;var f=checkRuleAndDisplayValue(b,c);e(f)})}}if(b){var d=checkRuleAndDisplayValue(b,c);e(d)}}function checkRuleAndDisplayValue(d,a){var k="!@#";if(d){if(d.prefs==undefined||d.prefs=="{}"){console.log("no rule defined");return k}var b=JSON.parse(d.prefs);var f=b.csrules;for(var c=0;c<f.length;c++){var e=f[c].name;if(e==a){var h=f[c].displaytext;var g=replaceMergeFields(h);console.log("display text - "+g);k=g}}}return k}function showvalue(a){if(!a){return}GiveCallScriptName(a,function(b){if(b.length==0){$("#callScriptForm #callScriptText").val("No call script to display.")
}for(var c=0;c<b.length;c++){var d=new Option(b[c],b[c]);$("#callScriptForm #callScriptName").append(d)}$("body").on("change","#callScriptName",function(h){var g=$("#callScriptName").val();var f=$(".noty_call_callScript","#draggable_noty").data("contact");GiveCallScriptText(g,f,function(e){if(e=="!@#"){e="Please select a call script to display."}$("#callScriptForm #callScriptText").val(e)})})})}$(function(){});function initializeFbPageTabListners(a){$("#fbPageTab-listners").on("click","#facebookPageTabSave",function(h){h.preventDefault();if(!isValidForm($("#facebookPageTabSettingForm"))){return}var g=$("#facebookTabPage").val();var b=$("#facebookTabPage").find("option:selected").text();var c=$("#AgileFacebookAppId").val();var j=$("#formToUse").val();var d=$("#formToUse").find("option:selected").text();if($("#connectedFormHolder_"+g).length!=0){if(!confirm("Are you sure you want to update?")){return}}var f="facebookPageID="+g;f+="&facebookPageName="+b;f+="&facebookPageToken="+$("#facebookTabPage").find("option:selected").attr("data-token");f+="&formID="+j;f+="&formName="+d;$.ajax({url:"fbpage?action=SAVE_DETAILS",type:"POST",data:f,success:function(m,o,l){if(m=="true"){$("#formToUse").prop("selectedIndex",0);$("#facebookTabPage").prop("selectedIndex",0);if($("#fbFormsTable").length==0){$("#fbFormsHolder").html('<p class="font-bold">'+_agile_get_translated_val("admin-settings-integrations","current-facebook-pages")+'</p><table class="table" id="fbFormsTable"><tbody></tbody></table><div id="delStatusMessageHolder"></div>')}var e='<tr id="connectedFormHolder_'+g+'"><td colspan="3" style="padding-left:0px;"><a target="_blank" href="/form.jsp?id='+j+'" class="text-info">'+d+"</a> "+_agile_get_translated_val("admin-settings-integrations","form-has-been-added-to")+'<br><a target="_blank" href="https://www.facebook.com/pages/null/'+g+"?sk=app_"+c+'" class="text-info">'+b+"</a> "+_agile_get_translated_val("admin-settings-integrations","page")+'</td><td style="padding-top:18px;"><a href="#" data-pageid="'+g+'" id="connectedForm_'+j+'" class="deleteFacebookLinkedpage"><i class="icon-trash"></i></a></td></tr>';var n=_agile_get_translated_val("contacts-view","has-been-added-to");if($("#connectedFormHolder_"+g).length!=0){$("#connectedFormHolder_"+g).remove();n=_agile_get_translated_val("admin-settings-integrations","updated_in")}$("#fbFormsTable > tbody:last-child").append(e);var k=_agile_get_translated_val("campaigns","form")+" "+n+' <a target="_blank" class="text-info" href="https://www.facebook.com/pages/null/'+g+"?sk=app_"+c+'">'+_agile_get_translated_val("admin-settings-integrations","you-fb-page")+"</a><br>";$("#statusMessageHolder").html(k).show().fadeOut(10000);$("#facebookFormAddHolder").hide();$("#addFacebookFormLink").show()}else{$("#statusMessageHolder").html(_agile_get_translated_val("admin-settings-integrations","try-again"))}},error:function(e,l,k){}})});$("#fbPageTab-listners").on("click",".deleteFacebookLinkedpage",function(c){c.preventDefault();var b=$(this);showAlertModal("delete_facebook_linked_page","confirm",function(){var e=b.attr("data-pageid");var d=$("#facebookTabPage option[value='"+e+"']").attr("data-token");if(typeof d=="undefined"){setTimeout(function(){showAlertModal("delete_facebook_linked_page_error",undefined,function(){var g=$("#AddFormLinkFacebookAccount").attr("href");if(typeof g!="undefined"){window.location.href=g}})},1000)}else{var f="facebookPageID="+e;f+="&facebookPageToken="+d;$.ajax({url:"fbpage?action=DELETE_TAB",type:"POST",data:f,success:function(h,j,g){if(h=="true"){$("#connectedFormHolder_"+e).remove();$("#delStatusMessageHolder").html(_agile_get_translated_val("admin-settings-integrations","deleted-success")+"<br>").show().fadeOut(8000)}else{$("#delStatusMessageHolder").html(_agile_get_translated_val("admin-settings-integrations","try-again"))}},error:function(g,j,h){}})}})});$("#fbPageTab-listners").on("change","#formToUse",function(c){var b=$("#connectedForm_"+$(this).val()).attr("data-pageid");if(typeof b!="undefined"){$("#facebookTabPage").val(b)}});$("#fbPageTab-listners").on("click","#addFacebookFormLink",function(b){b.preventDefault();$("#facebookFormAddHolder").show();$(this).hide()});$("#fbPageTab-listners").on("click","#unlinkFacebookAccount",function(b){b.preventDefault();showAlertModal("unlink_facebook","confirm",function(){$.post("fbpage?action=UNLINK_ACCOUNT",function(c){window.location.reload()})})})}var CANCELED="Canceled";var SIGN_UP="Signup";var CAMPAIGN_TAG="Campaigns";var CODE_SETUP_TAG="Code setup";var IMPORT_TAG="Import";var SOCIAL_TAG="Social";var WIDGET_TAG="Widgets";var DOMAIN_COOKIE_FOR_WEBSITE="_agile_login_domain";var ACCOUNT_CANCELED_NOTE_SUBJECT="Account Canceled";var ACCOUNT_CANCELED_CUSTOM_FIELD_NAME="Cancel Reason";function our_domain_set_account(){if(LOCAL_SERVER){_agile.set_account("7n7762stfek4hj61jnpce7uedi","local")}else{_agile.set_account("fdpa0sc7i1putehsp8ajh81efh","our")}_agile.set_email(CURRENT_DOMAIN_USER.email);_agile.track_page_view()}function add_custom_fields_to_our_domain(a){add_init_tags(function(){get_new_custom_properties_to_add();add_referrar_info_as_note()})}function getDomainCustomField(){var a=getProperty(Agile_Contact.properties,"Domain");if(!a||a.value!=CURRENT_DOMAIN_USER.domain){return create_contact_custom_field("Domain",CURRENT_DOMAIN_USER.domain,"CUSTOM")}}function get_new_custom_properties_to_add(a){addLoggedInTime(function(){addDomain(a)})}function addDomain(b){var a=getDomainCustomField();if(!a){if(b&&typeof b==="function"){b()}return}property_request(a,b)}function addLoggedInTime(b){var a=new_current_loggedin_time();if(!a){processCallback(b);return}property_request(a,b)}function processCallback(a){if(a&&typeof a==="function"){a()}}function property_request(a,b){_agile.add_property(a,function(c){Agile_Contact=c;_agile_contact=c;processCallback(b)})}function add_init_tags(b){var a="";a=SIGN_UP;if(CURRENT_DOMAIN_USER.is_account_owner){a+=",Domain Owner"}add_miltiple_tags(a,b)}function add_miltiple_tags(b,e){var a=b.split(",");var d="";for(var c=0;c<a.length;c++){if(hasTagInContact(a[c])){continue}if(d.length>0){d+=","+a[c]}else{d+=a[c]}}if(d.length==0){if(e&&typeof(e)==="function"){e()}return}add_multiple_tags_request(d.trim(),e)}function add_multiple_tags_request(a,b){_agile.add_tag(a,function(c){Agile_Contact=c;if(b&&typeof(b)==="function"){b(c)}})}function new_current_loggedin_time(){var b=new Date();var a=b.getUTCMonth()+1+"/"+b.getUTCDate()+"/"+b.getUTCFullYear();console.log(parseInt(b.getTime()/1000));var d=getProperty(Agile_Contact.properties,"Last login");var f="";var c=true;if(d){var e=new Date(parseFloat(d.value)*1000);f=e.getUTCMonth()+1+"/"+e.getUTCDate()+"/"+e.getUTCFullYear();c=false}if(f&&f==a){return}d=create_contact_custom_field("Last login",parseInt(b.getTime()/1000),"CUSTOM");return d}function create_contact_custom_field(b,e,d,a){if(!b){return}var c={};c.name=b;c.value=e;c.subtype=d;console.log(e);return c}function add_account_canceled_info(b,c){var a=create_contact_custom_field(ACCOUNT_CANCELED_CUSTOM_FIELD_NAME,b.reason,"CUSTOM");_agile.add_property(a,function(d){add_tag_our_domain(CANCELED,function(f){if(b.reason_info){var e={};e.subject=ACCOUNT_CANCELED_NOTE_SUBJECT;e.description=b.reason_info;_agile.add_note(e,function(g){console.log(g);Agile_Contact=g;if(c&&typeof(c)==="function"){c()}});return}if(c&&typeof(c)==="function"){c()}})})}function add_referrar_info_as_note(){var e=_agile_get_prefs("_agile_utm_source");var b=_agile_get_prefs("_agile_utm_campaign");var a=_agile_get_prefs("_agile_utm_medium");var c=_agile_get_prefs("agile_reference_domain");if(e&&b&&a&&c){var d={};d.subject="Referrer";d.description="Source - "+e+"\n Campaign -  "+b+"\n Medium - "+a+"\n Reference Domain -"+c;_agile.add_note(d,function(f){console.log(f);_agile_delete_prefs("agile_reference_domain")})}}function add_timezone_tag(){var a=new Date();var b=a.getUTCHours();if(b>=3&&b<=15){add_tag_our_domain("GMT")}}function our_domain_sync(){try{our_domain_set_account();var b=_agile_get_prefs(DOMAIN_COOKIE_FOR_WEBSITE);if(!b||b!=CURRENT_DOMAIN_USER.domain){createCookieInAllAgileSubdomains(DOMAIN_COOKIE_FOR_WEBSITE,CURRENT_DOMAIN_USER.domain,365)}get_contact_from_our_domain(function(e){Agile_Contact=e;var c=getProperty(Agile_Contact.properties,"phone");var d=CURRENT_DOMAIN_USER.phone;if(d){if(!c){_agile.add_property(create_contact_custom_field("phone",d,"SYSTEM","home"),function(f){Agile_Contact=f;_agile_contact=f})}}add_custom_fields_to_our_domain();initWebrules()},function(h){var e=CURRENT_DOMAIN_USER.name;e=e.trim();var f=e.split(" ")[0].trim();var c=(f.length<e.length)?e.substring(f.length+1).trim():"";var d=CURRENT_DOMAIN_USER.email;var g=d.split("@")[1].split(".")[0];var j={email:CURRENT_DOMAIN_USER.email,first_name:f,last_name:c};if(CURRENT_DOMAIN_USER.phone){j.phone=CURRENT_DOMAIN_USER.phone}if(g!="yopmail"){_agile.create_contact(j,function(k){Agile_Contact=k;add_custom_fields_to_our_domain();initWebrules()})}})}catch(a){}}function get_contact_from_our_domain(a,b){agile_getContact(CURRENT_DOMAIN_USER.email,{success:function(c){Agile_Contact=c;if(a&&typeof(a)==="function"){a(c)}},error:function(c){if(b&&typeof(b)==="function"){b(c)}}})}function add_signup_tag(a){if(!Agile_Contact.tags||Agile_Contact.tags.indexOf(SIGN_UP)<0){add_tag_our_domain(SIGN_UP,function(b){add_custom_fields_to_our_domain();if(a&&typeof(a)==="function"){a()}});return}add_custom_fields_to_our_domain()}function setup_our_domain_sync(){our_domain_sync()}function checkTagAgile(a){console.log(Agile_Contact);if(Agile_Contact&&Agile_Contact.tags){return Agile_Contact.tags.indexOf(a)>-1}return false}function hasTagInContact(a){if(!a){return false}if(Agile_Contact&&(!Agile_Contact.tags||Agile_Contact.tags.indexOf(a)<0)){return false}return true}function add_tag_our_domain(a,b){if(hasTagInContact(a)){if(b&&typeof(b)==="function"){b(Agile_Contact)}return}_agile.add_tag(a,function(c){Agile_Contact=c;if(b&&typeof(b)==="function"){b(c)}})}function addTagAgile(a){try{if(checkTagAgile(a)){return
}_agile.add_tag(a,function(c){Agile_Contact=c;if(!checkTagAgile(a)){Agile_Contact.tags.push(a)}})}catch(b){}}function add_property(a,d,b,e){var c=getProperty(Agile_Contact.properties,a);if(c&&c.value==d&&b==c.type){e(Agile_Contact);return false}_agile.add_property(create_contact_custom_field(a,d,b),function(f){Agile_Contact=f;_agile_contact=f;if(e&&typeof e=="function"){e(f)}})}var GLOBAL_WEBRULE_FLAG;function initWebrules(){_agile_execute_web_rules();GLOBAL_WEBRULE_FLAG=true}function add_properties_from_popup(b,a){_agile.add_property(create_contact_custom_field("Company Size",a,"CUSTOM"),function(c){_agile.add_property(create_contact_custom_field("phone",b,"SYSTEM","home"),function(d){console.log(d);_agile_contact=d;console.log(_agile_contact);window.setTimeout(initWebrules,4000)})})}function add_created_user_info_as_note_to_owner(a,c){var b={};b.subject="User created";b.description=" Domain - "+a.domain+"\n User Email -  "+a.created_user_email;_agile.add_note(b,function(d){if(c&&typeof c=="function"){c(d)}},a.email)}function add_cancel_subscription_info_as_note_to_owner(a,c){var b={};b.subject="Subscription Cancelled";b.description=" Subscription cancelled by "+CURRENT_DOMAIN_USER.email;_agile.add_note(b,function(d){if(c&&typeof c=="function"){c(d)}},a)}function add_delete_user_info_as_note_to_owner(a,c){var b={};b.subject="User Deleted ";b.description=" One user deleted by "+CURRENT_DOMAIN_USER.email;_agile.add_note(b,function(d){if(c&&typeof c=="function"){c(d)}},a)}function add_refunded_info_as_note_to_owner(a,b,d){var c={};c.subject="Amount Refunded ";c.description="Amount $"+b+" refunded by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(e){if(d&&typeof d=="function"){d(e)}},a)}function add_password_change_info_as_note_to_owner(a,c){var b={};b.subject="Password Changed ";b.description=" Password changed by "+CURRENT_DOMAIN_USER.email;_agile.add_note(b,function(d){if(c&&typeof c=="function"){c(d)}},a)}function add_plan_change_info_as_note_to_owner(a,d,b,e,f){var c={};c.subject="Plan Changed ";c.description=" Plan changed to "+d+" ("+b+"*"+e+") by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(g){if(f&&typeof f=="function"){f(g)}},a)}$(function(){});function initialize_agile_domain_sync(){try{if(_agile){setup_our_domain_sync();return}head.js("stats/min/agile-min.js",function(){setup_our_domain_sync()})}catch(a){console.log()}}function add_cancel_subscription_info_as_note_to_owner(a,c){var b={};b.subject="Subscription Cancelled";b.description=" Subscription cancelled by "+CURRENT_DOMAIN_USER.email;_agile.add_note(b,function(d){if(c&&typeof c=="function"){c(d)}},a)}function add_delete_user_info_as_note_to_owner(a,c){var b={};b.subject="User Deleted ";b.description=" One user deleted by "+CURRENT_DOMAIN_USER.email;_agile.add_note(b,function(d){if(c&&typeof c=="function"){c(d)}},a)}function add_refunded_info_as_note_to_owner(a,b,d){var c={};c.subject="Amount Refunded ";c.description="Amount $"+b+" refunded by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(e){if(d&&typeof d=="function"){d(e)}},a)}function add_password_change_info_as_note_to_owner(a,c){var b={};b.subject="Password Changed ";b.description=" Password changed by "+CURRENT_DOMAIN_USER.email;_agile.add_note(b,function(d){if(c&&typeof c=="function"){c(d)}},a)}function add_plan_change_info_as_note_to_owner(a,d,b,e,f){var c={};c.subject="Plan Changed ";c.description=" Plan changed to "+d+" ("+b+"*"+e+") by "+CURRENT_DOMAIN_USER.email;_agile.add_note(c,function(g){if(f&&typeof f=="function"){f(g)}},a)}function update_contact_in_our_domain(a,b,f){console.log("update_contact_in_our_domain");if(!b||!b.email){processCallback(f);return}try{var c={email:b.email,};if(b.phone){c.phone=b.phone}if(CURRENT_DOMAIN_USER.email!=a){_agile.set_email(a)}_agile.update_contact(c,{success:function(e){console.log("success");processCallback(f)},error:function(e){console.log("error");processCallback(f)}})}catch(d){processCallback(f)}}var _BULK_CONTACTS=undefined;var current_view_contacts_count=0;var SELECT_ALL=false;var _BULKACTION_FILTER=undefined;var Contacts_Events_Collection_View=Base_Collection_View.extend({events:{"click .contact-type-image, .company-type-image":"navigateToProperContact",'mouseenter #companies-list-view-model-list > tr > td:not(":first-child")':"companiesDataPopoverEnter",'mouseleave #companies-list-view-model-list > tr > td:not(":first-child")':"companiesDataPopoverLeave"},navigateToProperContact:function(b){b.stopPropagation();var a=$(b.currentTarget).attr("id");if($(b.currentTarget).hasClass("contact-type-image")){Backbone.history.navigate("contact/"+a,{trigger:true})}else{Backbone.history.navigate("company/"+a,{trigger:true})}},companiesDataPopoverEnter:function(d){var c=d.pageX;c=c-100;var b=0;var a=$(d.currentTarget).parent();if($(d.currentTarget).hasClass("contact-type-custom-field-td")||$(d.currentTarget).hasClass("company-type-custom-field-td")||$(d.currentTarget).hasClass("contact-type-image")||$(d.currentTarget).hasClass("company-type-image")){return}popoverEnter(a,c,b,true)},companiesDataPopoverLeave:function(b){var a=$(b.currentTarget).parent();popout(a)}});$(function(){$("#deleteContactModal").on("click",".delete-confirmed",function(c){var b=$(this).attr("data");var a=App_Contacts.contactsListView.collection.get(b);a.url="core/api/contacts/"+b;a.destroy({success:function(e,d){Backbone.history.navigate("contacts",{trigger:true})}})})});var contacts_bulk_actions={change_owner:function(a){load_bulk_operations_template(function(){if(!canRunBulkOperations()){showModalConfirmation(_agile_get_translated_val("bulk-actions","change-owner"),_agile_get_translated_val("bulk-actions","no-pem-to-change-owners")+"<br/><br/> "+_agile_get_translated_val("deal-view","do-you-want-to-proceed"),show_bulk_owner_change_page,function(){return},function(){})}else{show_bulk_owner_change_page()}})},assign_to_campaigns:function(g){var a=get_contacts_bulk_ids();if(a.length===0){count=getAvailableContacts()}else{count=a.length}var d=true;if(!canRunBulkOperations()){d=false;showModalConfirmation(_agile_get_translated_val("bulk-actions","assign-campaign"),_agile_get_translated_val("bulk-actions","no-pem-to-update-contacts")+"<br/><br/>"+_agile_get_translated_val("deal-view","do-you-want-to-proceed"),show_bulk_campaign_assign_page,function(){},function(){return})}if(is_free_plan()&&has_more_than_limit()){d=false;showModalConfirmation(_agile_get_translated_val("contacts-view","add-to-campaign"),_agile_get_translated_val("bulk-actions","limit-on-contacts"),function(){Backbone.history.navigate("subscribe",{trigger:true})},function(){return},function(){return},_agile_get_translated_val("portlets","upgrade"),_agile_get_translated_val("contact-details","CLOSE"))}if(!canSendEmails(count)){d=false;var f=getPendingEmails()+getEmailCreditsCount();var b=_agile_get_translated_val("portlets","yes");var j=_agile_get_translated_val("portlets","no");var k="";var c=_agile_get_translated_val("bulk-actions","you-may")+' <a href="#subscribe" class="action text-info" data-dismiss="modal" subscribe="subscribe" action="deny">'+_agile_get_translated_val("plan-and-upgrade","purchase")+" </a>"+_agile_get_translated_val("bulk-actions","more-emails-to-action");var h=_agile_get_translated_val("bulk-actions","email-low-limit");if(f<=0){h=_agile_get_translated_val("bulk-actions","email-low-limit");b="";j=_agile_get_translated_val("reputation","Ok");k=_agile_get_translated_val("bulk-actions","emails-limit-reached")+" "+c}else{k=_agile_get_translated_val("billing","have-only")+" "+f+" "+_agile_get_translated_val("bulk-actions","emails-left-quota")+". "+c+" "+_agile_get_translated_val("bulk-actions","wanna-continue")+"<br/><br/>"+_agile_get_translated_val("deal-view","do-you-want-to-proceed")}showModalConfirmation(h,k,show_bulk_campaign_assign_page,function(e){if(!e){return}if($(e).attr("subscribe")){Backbone.history.navigate("subscribe",{trigger:true})}return},function(e){},b,j);return}else{if(d){show_bulk_campaign_assign_page()}}},add_tags:function(a){load_bulk_operations_template(function(){if(!canRunBulkOperations()){showModalConfirmation(_agile_get_translated_val("bulk-actions","add-tag"),_agile_get_translated_val("bulk-actions","add-tag")+"<br/><br/> "+_agile_get_translated_val("deal-view","do-you-want-to-proceed"),show_add_tag_bulkaction_form,function(){return},function(){return})}if(is_free_plan()&&has_more_than_limit()){continueAction=false;showModalConfirmation(_agile_get_translated_val("contacts-view","add-tags"),_agile_get_translated_val("bulk-actions","limit-on-contacts"),function(){Backbone.history.navigate("subscribe",{trigger:true})},function(){return},function(){return},_agile_get_translated_val("portlets","upgrade"),_agile_get_translated_val("contact-details","CLOSE"))}else{show_add_tag_bulkaction_form()}})},remove_tags:function(a){load_bulk_operations_template(function(){if(!canRunBulkOperations()){showModalConfirmation(_agile_get_translated_val("bulk-actions","remove-tag"),_agile_get_translated_val("bulk-actions","bulk-update-ur-contacts")+"<br/><br/> "+_agile_get_translated_val("deal-view","do-you-want-to-proceed"),show_remove_tag_bulkaction_form,function(){return},function(){return})}if(is_free_plan()&&has_more_than_limit()){continueAction=false;showModalConfirmation(_agile_get_translated_val("contacts-view","remove-tags"),_agile_get_translated_val("bulk-actions","limit-on-contacts"),function(){Backbone.history.navigate("subscribe",{trigger:true})},function(){return},function(){return},_agile_get_translated_val("portlets","upgrade"),_agile_get_translated_val("contact-details","CLOSE"))}else{show_remove_tag_bulkaction_form()}})},send_email:function(a){load_bulk_operations_template(function(){var d=get_contacts_bulk_ids();if(!canRunBulkOperations()){showModalConfirmation(_agile_get_translated_val("bulk-actions","bulk-email"),_agile_get_translated_val("bulk-actions","bulk-email-ur-contacts")+"<br/><br/> "+_agile_get_translated_val("deal-view","do-you-want-to-proceed"),function(){show_bulk_email_form(d)
},function(){return},function(){return})}if(has_more_than_limit()){showModalConfirmation(_agile_get_translated_val("contact-details","send-email"),_agile_get_translated_val("billing","not-send->25email"),function(){Backbone.history.navigate("workflows",{trigger:true})},function(){return},function(){return},_agile_get_translated_val("campaigns","go-to-campaign"),_agile_get_translated_val("contact-details","CLOSE"))}else{if(d.length===0){count=getAvailableContacts()}else{count=d.length}if(!canSendEmails(count)){var c=getPendingEmails()+getEmailCreditsCount();var j=_agile_get_translated_val("portlets","yes");var h=_agile_get_translated_val("portlets","no");var e="";var b=_agile_get_translated_val("contact-details","please")+'<a href="#subscribe" class="action text-info" data-dismiss="modal" subscribe="subscribe" action="deny">'+_agile_get_translated_val("menu","upgrade")+"</a>"+_agile_get_translated_val("billing","your-email-subscription");var g="<div>"+_agile_get_translated_val("billing","continue-send-emails")+", "+_agile_get_translated_val("contact-details","please")+'<a href="#subscribe" class="action text-info" data-dismiss="modal" subscribe="subscribe" action="deny"> '+_agile_get_translated_val("menu","upgrade")+"</a>  "+_agile_get_translated_val("billing","more")+".</div>";var f=_agile_get_translated_val("billing","not-enough-emails");if(c<=0){f=_agile_get_translated_val("campaigns","emails-limit");j="";h=_agile_get_translated_val("reputation","Ok");e="<div>"+_agile_get_translated_val("billing","email-quota-exceed")+"</div> "+g}else{e=_agile_get_translated_val("billing","remaining-email")+" "+c+" "+_agile_get_translated_val("billing","have-only")+" "+b+_agile_get_translated_val("billing","not-send-email")+" <br/><br/>"+_agile_get_translated_val("deal-view","do-you-want-to-proceed")}showModalConfirmation(f,e,show_bulk_email_form,function(k){if(!k){return}if($(k).attr("subscribe")){Backbone.history.navigate("subscribe",{trigger:true})}},function(k){},j,h);return}show_bulk_email_form(d)}})},export_contacts:function(c){c.preventDefault();if($("#contacts-export-csv-modal").size()!=0){$("#contacts-export-csv-modal").remove()}var a=get_contacts_bulk_ids();var b=0;if(a.length===0){b=getAvailableContacts()}else{b=a.length}getTemplate("contacts-export-csv-modal",{},undefined,function(e){if(!e){return}var d=$(e);d.modal("show");d.on("shown.bs.modal",function(){$("#contacts-export-csv-modal").on("click","#contacts-export-csv-confirm",function(h){h.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");$save_info=$('<img src="'+updateImageS3Path("img/1-0.gif")+'" height="18px" width="18px"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>'+_agile_get_translated_val("campaigns","email-will-be-sent-shortly")+"</i></small></span>");$(this).parent(".modal-footer").find(".contacts-export-csv-message").append($save_info);$save_info.show();var f="/core/api/contacts/export?action_type=EXPORT_CONTACTS_CSV";var g={};g.contact_ids=a;g.data=JSON.stringify(CURRENT_DOMAIN_USER);postBulkOperationData(f,g,undefined,undefined,function(){setTimeout(function(){d.modal("hide")},3000);$("body").find("#bulk-actions").css("display","none");$("body").find("#bulk-select").css("display","none");$("body").find("#bulk-action-btns button").addClass("disabled");$("table#contacts-table").find(".thead_check").removeAttr("checked");$("table#contacts-table").find(".tbody_check").removeAttr("checked");$(".grid-checkboxes").find(".thead_check").removeAttr("checked");$(".contacts-grid-view-temp").find(".tbody_check").removeAttr("checked")},"no_noty")})})},null)},export_companies:function(c){c.preventDefault();if($("#companies-export-csv-modal").size()!=0){$("#companies-export-csv-modal").remove()}var a=get_contacts_bulk_ids();var b=0;if(a.length===0){b=getAvailableContacts()}else{b=a.length}getTemplate("companies-export-csv-modal",{},undefined,function(e){if(!e){return}var d=$(e);d.modal("show");d.on("shown.bs.modal",function(){$("#companies-export-csv-modal").on("click","#companies-export-csv-confirm",function(h){h.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");$save_info=$('<img src="img/1-0.gif" height="18px" width="18px"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>'+_agile_get_translated_val("campaigns","email-will-be-sent-shortly")+"</i></small></span>");$(this).parent(".modal-footer").find(".companies-export-csv-message").append($save_info);$save_info.show();var f="/core/api/bulk/update?action_type=EXPORT_COMPANIES_CSV";var g={};g.contact_ids=a;g.data=JSON.stringify(CURRENT_DOMAIN_USER);postBulkOperationData(f,g,undefined,undefined,function(){setTimeout(function(){d.modal("hide")},3000);$("body").find("#bulk-actions").css("display","none");$("body").find("#bulk-select").css("display","none");$("table#companies,table#contacts-table").find(".thead_check").removeAttr("checked");$("table#companies,table#contacts-table").find(".tbody_check").removeAttr("checked")},"no_noty")})})},null)},select_contacts:function(d){d.preventDefault();SELECT_ALL=true;_BULK_CONTACTS=window.location.hash;var b="";var a=getAvailableContacts();var c=10000;if(company_util.isCompany()){if(localStorage.getItem("dynamic_company_filter")!=null||localStorage.getItem("company_filter")!=null){if(a>c){a=c+"+"}}b=" "+_agile_get_translated_val("contacts","select-all")+" "+a+" "+_agile_get_translated_val("contact-details","companies")+'. <a hrer="#" id="select-all-revert" class="c-p text-info">Select chosen companies only</a>'}else{if(localStorage.getItem("dynamic_contact_filter")!=null||localStorage.getItem("contact_filter")!=null){if(a>c){a=c+"+"}}b=" "+_agile_get_translated_val("contacts","select-all")+" "+a+" "+_agile_get_translated_val("contact-details","contacts")+'. <a hrer="#" id="select-all-revert" class="c-p text-info">Select chosen contacts only</a>'}$("body").find("#bulk-select").css("display","inline-block").html(b);$.each($(".tbody_check"),function(e,f){$(f).attr("checked","checked")})},};function show_bulk_owner_change_page(){var b,a=[];if(SELECT_ALL==true){b=getSelectionCriteria()}else{a=get_contacts_bulk_ids()}$("body").off("fill_owners").on("fill_owners",function(d){var c="<option value='{{id}}'>{{name}}</option>";fillSelect("ownerBulkSelect","/core/api/users/partial","domainUsers","no-callback ",c)});if(company_util.isCompany()){Backbone.history.navigate("company-bulk-owner",{trigger:true})}else{Backbone.history.navigate("bulk-owner",{trigger:true})}$("#changeOwnerToBulk").click(function(j){j.preventDefault();var c=$("#ownerBulkForm");if($(this).attr("disabled")=="disabled"||!isValidForm(c)){return}var g=$(this);disable_save_button(g);var d;var h=$("#ownerBulkSelect option:selected").prop("value");d="/core/api/bulk/update?action_type=CHANGE_OWNER&owner="+h;var f={};f.contact_ids=a;postBulkOperationData(d,f,c,undefined,function(e){enable_save_button(g)},_agile_get_translated_val("bulk-actions","owner-change-scheduled"))})}function show_bulk_campaign_assign_page(){load_bulk_operations_template(function(){var b=[];var a;if(SELECT_ALL==true){a=getSelectionCriteria()}else{b=get_contacts_bulk_ids()}console.log(a);$("body").off("fill_campaigns").on("fill_campaigns",function(d){var c="<option value='{{id}}'{{#if is_disabled}}disabled=disabled>{{name}} ("+_agile_get_translated_val("campaigns","disabled")+"){{else}}>{{name}}{{/if}}</option>";fillSelect("campaignBulkSelect","/core/api/workflows","workflow","no-callback ",c)});Backbone.history.navigate("bulk-campaigns",{trigger:true});$("#addBulkTocampaign").click(function(j){j.preventDefault();var c=$("#campaignsBulkForm");if($(this).attr("disabled")=="disabled"||!isValidForm(c)){return}var h=$(this);disable_save_button(h);var g=$("#campaignBulkSelect option:selected").prop("value");var d="/core/api/bulk/update?workflow_id="+g+"&action_type=ASIGN_WORKFLOW";var f={};f.contact_ids=b;postBulkOperationData(d,f,c,undefined,function(e){enable_save_button(h)},_agile_get_translated_val("campaigns","assigned"))})})}function show_add_tag_bulkaction_form(){var a=get_contacts_bulk_ids();if(company_util.isCompany()){Backbone.history.navigate("company-bulk-tags",{trigger:true})}else{Backbone.history.navigate("bulk-tags",{trigger:true})}setup_tags_typeahead();$("#addTagsToContactsBulk").click(function(k){k.preventDefault();var c=get_tags("tagsBulkForm");var g=$("#addBulkTags").val().trim();$("#addBulkTags").val("");if(g&&g.length>=0&&!(/^\s*$/).test(g)){var f=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="{{name}}">{{name}}<a class="close" id="remove_tag" tag="{{name}}">&times</a></li>');$("#addBulkTags").closest(".control-group").find("ul.tags").append(f({name:g}))}if(g!=""){c[0].value.push(g)}if(c[0].value.length>0){var j=true;$.each(c[0].value,function(e,l){if(!isValidTag(l,false)){j=false;return false}});if(!j){$(".invalid-tags").show().delay(6000).hide(1);return false}var h=$(this);disable_save_button(h);var b="/core/api/bulk/update?action_type=ADD_TAG";var d={};d.data=JSON.stringify(c[0].value);d.contact_ids=a;acl_util.canAddTag(d.data,function(e){postBulkOperationData(b,d,$("#tagsBulkForm"),undefined,function(l){enable_save_button(h);$.each(c[0].value,function(n,m){tagsCollection.add({tag:m})})},_agile_get_translated_val("contacts","add-tag-scheduled"))},function(e){enable_save_button(h)})}else{$("#addBulkTags").focus();$(".error-tags").show().delay(3000).hide(1);return}})}function show_remove_tag_bulkaction_form(){var a=get_contacts_bulk_ids();if(company_util.isCompany()){Backbone.history.navigate("company-bulk-tags-remove",{trigger:true})}else{Backbone.history.navigate("bulk-tags-remove",{trigger:true})}setup_tags_typeahead();$("#removeTagsToContactsBulk").click(function(j){j.preventDefault();var c=get_tags("tagsRemoveBulkForm");var g=$("#removeBulkTags").val().trim();$("#removeBulkTags").val("");if(g&&g.length>=0&&!(/^\s*$/).test(g)){var f=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="{{name}}">{{name}}<a class="close" id="remove_tag" tag="{{name}}">&times</a></li>');
$("#removeBulkTags").closest(".control-group").find("ul.tags").append(f({name:g}))}if(g!=""){c[0].value.push(g)}if(c[0].value.length>0){var h=$(this);disable_save_button(h);var b="/core/api/bulk/update?action_type=REMOVE_TAG";var d={};d.data=JSON.stringify(c[0].value);d.contact_ids=a;postBulkOperationData(b,d,$("#tagsRemoveBulkForm"),undefined,function(e){enable_save_button(h);$.each(c[0].value,function(l,k){tagsCollection.add({tag:k})})},_agile_get_translated_val("contacts","delete-tag-scheduled"))}else{$("#removeBulkTags").focus();$(".error-tags").show().delay(3000).hide(1);return}})}function show_bulk_email_form(a){var b=0;if(a&&a.length==0){a=get_contacts_bulk_ids()}$("body").off("fill_emails").on("fill_emails",function(d){var c=$("#emailForm");populate_send_email_details();setupTinyMCEEditor("textarea#email-body",false,undefined,function(){set_tinymce_content("email-body","")});if(a.length===0){b=getAvailableContacts()}else{b=a.length}c.find("div#bulk-count").css("display","inline-block");if(company_util.isCompany()){c.find("div#bulk-count p").html(_agile_get_translated_val("companies-view","selected")+" <b>"+b+_agile_get_translated_val("companies-view","Companies")+" </b> "+_agile_get_translated_val("companies-view","for-sending-email"))}else{c.find("div#bulk-count p").html(_agile_get_translated_val("companies-view","selected")+" <b>"+b+_agile_get_translated_val("companies-view","Contacts")+" </b> "+_agile_get_translated_val("companies-view","for-sending-email"))}c.find('input[name="to"]').closest(".control-group").attr("class","hidden");c.find("a#cc-link").closest(".control-group").attr("class","hidden");c.find(".form-actions a#sendEmail").removeAttr("id").attr("id","bulk-send-email");c.find(".form-actions a#send-email-close").removeAttr("id")});if(company_util.isCompany()){Backbone.history.navigate("company-bulk-email",{trigger:true})}else{Backbone.history.navigate("bulk-email",{trigger:true})}$("body #bulk-send-email").off("click");$("#bulk-send-email").click(function(h){h.preventDefault();if($(this).attr("disabled")){return}var c=$("#emailForm");if(!isValidForm(c)){return}disable_send_button($(this));save_content_to_textarea("email-body");var g=serializeForm("emailForm");var d="/core/api/bulk/update?action_type=SEND_EMAIL";var f={};f.contact_ids=a;f.data=JSON.stringify(g);var j=_agile_get_translated_val("campaigns","emails-queued")+" "+b+" "+_agile_get_translated_val("contact-details","contacts")+". "+_agile_get_translated_val("campaigns","emails-sent-shortly");if(company_util.isCompany()){j=_agile_get_translated_val("campaigns","emails-queued")+" "+b+" "+_agile_get_translated_val("contact-details","companies")+". "+_agile_get_translated_val("campaigns","emails-sent-shortly")}postBulkOperationData(d,f,c,null,function(){enable_send_button($("#bulk-send-email"))},j)})}function get_contacts_bulk_ids(){var a=[];if(SELECT_ALL==true){return a}var b=$("body").find(".showCheckboxes");if($(".grid-view").length!=0){$(b).find(".tbody_check").each(function(c,d){if($(d).is(":checked")){a.push($(d).parent().parent().parent("div").attr("id"))}});return a}$(b).find("tr .tbody_check").each(function(c,d){if($(d).is(":checked")){a.push($(d).closest("tr").data().get("id"))}});return a}function toggle_contacts_bulk_actions_dropdown(h,g,f){SELECT_ALL=false;_BULK_CONTACTS=undefined;if(f==="active-campaign"){toggle_active_contacts_bulk_actions_dropdown(h,g);return}var b=getAvailableContacts();console.log(_agile_get_prefs("contact_filter"));$("body").find("#bulk-select").css("display","none");if($(h).is(":checked")){var a=0;var d=0;var e=10000;if(company_util.isCompany()){$("#bulk-action-btns button").removeClass("disabled");a=App_Companies.companiesListView.collection.length;d=b;if(g&&d!=a){if(localStorage.getItem("dynamic_company_filter")!=null||localStorage.getItem("company_filter")!=null){if(a>e){a=e+"+"}if(d>e){d=e+"+"}}$("body").find("#bulk-select").css("display","block").html(_agile_get_translated_val("companies-view","selected")+" "+a+" "+_agile_get_translated_val("contact-details","companies")+". <a id='select-all-available-contacts' class='c-p text-info' href='#'>"+_agile_get_translated_val("contacts","select-all")+" "+d+" "+_agile_get_translated_val("contact-details","companies")+"</a>");$("#bulk-select").css("display","block")}}else{$("#bulk-action-btns button").removeClass("disabled");a=App_Contacts.contactsListView.collection.length;d=b;if(g&&b!=a){if(localStorage.getItem("dynamic_contact_filter")!=null||localStorage.getItem("contact_filter")!=null){if(a>e){a=e+"+"}if(d>e){d=e+"+"}}$("body").find("#bulk-select").css("display","block").html(_agile_get_translated_val("companies-view","selected")+" "+a+" "+_agile_get_translated_val("contact-details","contacts")+". <a id='select-all-available-contacts' class='c-p text-info' href='#'>"+_agile_get_translated_val("contacts","select-all")+" "+d+" "+_agile_get_translated_val("contact-details","contacts")+"</a>");$("#bulk-select").css("display","block")}}}else{if(g){if(company_util.isCompany()){$("#bulk-action-btns button").addClass("disabled");$("#companiesTabelView").removeClass("disabled")}else{$("#bulk-action-btns button").addClass("disabled");$("#contactTabelView").removeClass("disabled")}return}var c=0;$.each($(".tbody_check"),function(j,k){if($(k).is(":checked")){c++;return false}});if(c==0){$("#bulk-action-btns button").addClass("disabled")}}}function getAvailableContacts(){if(company_util.isCompany()&&App_Companies.companiesListView.collection.toJSON()[0]&&App_Companies.companiesListView.collection.toJSON()[0].count){current_view_contacts_count=App_Companies.companiesListView.collection.toJSON()[0].count;return current_view_contacts_count}else{if(App_Contacts.contactsListView.collection.toJSON()[0]&&App_Contacts.contactsListView.collection.toJSON()[0].count){current_view_contacts_count=App_Contacts.contactsListView.collection.toJSON()[0].count;return current_view_contacts_count}}return App_Contacts.contactsListView.collection.toJSON().length}function getSelectionCriteria(){var a=undefined;if(company_util.isCompany()){a=$(".filter-criteria",$(App_Companies.companiesListView.el)).attr("_filter")}else{a=$(".filter-criteria",$(App_Contacts.contactsListView.el)).attr("_filter")}if(a&&_BULK_CONTACTS=="#contacts"){return a}if(_BULK_CONTACTS=="#companies"){if(a){return a}else{return _agile_get_translated_val("menu","menu-companies")}}if(_BULK_CONTACTS){return _BULK_CONTACTS}}function postBulkOperationData(a,f,e,h,g,c){var d=f.contact_ids.length;var b=getDynamicFilters();if(b!=null){f.dynamic_filter=b}if(f.contact_ids&&f.contact_ids.length==0){console.log(f.contact_ids);console.log(getSelectionCriteria());if(b==null){a=a+"&filter="+encodeURIComponent(getSelectionCriteria())}console.log(a)}else{f.contact_ids=JSON.stringify(f.contact_ids)}f.tracker=Math.floor(Math.random()*(10000-1))+1;h=h!=undefined?h:"application/x-www-form-urlencoded";$.ajax({url:a,type:"POST",data:f,contentType:h,success:function(k){$save_info=$('<div style="display:inline-block"><small><p class="text-success"><i>'+_agile_get_translated_val("bulk-actions","task-scheduled")+".</i></p></small></div>");if(e!==undefined){var j=$(e).find(".form-actions");if(j.find(".text-success")){j.find(".text-success").parent().parent().remove()}j.append($save_info)}if(g&&typeof(g)==="function"){g(k)}if(!company_util.isCompany()){Backbone.history.navigate("contacts",{trigger:true})}else{Backbone.history.navigate("companies",{trigger:true})}if(c==="no_noty"){return}if(!c){showNotyPopUp("information",_agile_get_translated_val("bulk-actions","task-scheduled"),"top",5000);return}if(d>20||d==0){showNotyPopUp("information",c,"top",5000)}}})}function getDynamicFilters(){var a=null;if(company_util.isCompany()){if(!App_Companies.companiesListView||!App_Companies.companiesListView.post_data){return null}a=App_Companies.companiesListView.post_data.filterJson}else{if(!App_Contacts.contactsListView||!App_Contacts.contactsListView.post_data){return null}a=App_Contacts.contactsListView.post_data.filterJson}if(!a||a==null){return null}else{if(JSON.parse(a).rules.length>0){return a}else{return null}}}function bulkOperationContactsCount(){if(SELECT_ALL==true){return getAvailableContacts()}else{var a=get_contacts_bulk_ids();return a.length}}function has_more_than_limit(){if(bulkOperationContactsCount()>25){return true}return false}function load_bulk_operations_template(a){getTemplate("bulk-actions-company-owner",{},undefined,function(b){if(a){a()}},null)}function sort_tables(a){$.tablesorter.addParser({id:"priority",is:function(c){return false},format:function(c){return c.toLowerCase().replace(/high/,2).replace(/normal/,1).replace(/low/,0)},type:"numeric"});$.tablesorter.addParser({id:"time-ago",is:function(c){return false},format:function(e,f,c,d){var g=c.getElementsByTagName("time");if(g){return $(g).attr("value")}},type:"numeric"});$.tablesorter.addParser({id:"money",is:function(c){return false},format:function(d,e,c){return c.getAttribute("value")},type:"numeric"});var b=$(a).attr("id");if(b=="deal-list"){sort_deals(a);return}if(b=="document-list"){sort_documents(a);return}if(b=="case-list"){sort_cases(a);return}if(b=="schedule-updates"){sort_schedule_updates(a);return}if(b=="contact-filter-list"){sort_filters(a);return}basic_table_sort(a)}function basic_table_sort(a){$(a).tablesorter({headers:{0:{sorter:false}}})}function sort_tasks(a){$(a).tablesorter({headers:{0:{sorter:false},1:{sorter:false},2:{sorter:"text"},3:{sorter:"text"},4:{sorter:"priority"},5:{sorter:"time-ago"},6:{sorter:false}}})}function sort_deals(a){$(a).tablesorter({headers:{0:{sorter:false},1:{sorter:"text"},2:{sorter:false},3:{sorter:"money"},4:{sorter:"text"},5:{sorter:"time-ago"},6:{sorter:false}}})}function sort_documents(a){$(a).tablesorter({headers:{0:{sorter:false},1:{sorter:"text"},2:{sorter:false},3:{sorter:"time-ago"},4:{sorter:false}}})}function sort_cases(a){$(a).tablesorter({headers:{0:{sorter:false},1:{sorter:false},2:{sorter:"text"},3:{sorter:"time-ago"},4:{sorter:false},5:{sorter:"text"}}})
}function sort_schedule_updates(a){$(a).tablesorter({headers:{0:{sorter:false},1:{sorter:"text"},2:{sorter:"text"},3:{sorter:"time-ago"},4:{sorter:"text"}}})}function sort_filters(a){$(a).tablesorter({headers:{0:{sorter:false},1:{sorter:"text"},2:{sorter:false},}})}$(function(){$("body").on("agile_collection_loaded",function(f,d){var g=$("table:not(.ignore-collection)",d);if($(g).find("tbody").attr("route")){$(g).find("tbody").addClass("agile-edit-row")}if($(g).hasClass("onlySorting")){sort_tables(g);return}var e=$(d).find("table.showCheckboxes");$(e).removeClass("table-bordered");$(e).closest("div.data-block").removeClass("data-block");var c=$(e).find("tbody tr");var a=$(e).find("thead tr");var b=$(a).find(".thead_check");var h=$(c).find(".tbody_check");if(b.length==0&&!$(e).hasClass("no-header-checkbox")){$(a).prepend('<th style="width:5%;"><label class="i-checks i-checks-sm m-b-none"><input type="checkbox" class="thead_check" value=""><i></i></label></th>')}if(b.length==0&&$(e).hasClass("no-header-checkbox")){$(a).prepend('<th style="width:5%;"></th>')}if(h.length==0){$(c).prepend('<td class="v-middle checkbox" style="cursor:default;"><label class="i-checks i-checks-sm"><input type="checkbox" class="tbody_check" value=""><i></i></label></td>')}$(d).find("#delete-checked").remove();if(!$(g).hasClass("noDelete")){$(e).after('<div><div class="select-none"></div></div><footer class="panel-footer"><a href="#" class="btn btn-danger btn-sm" id="delete-checked"> '+_agile_get_translated_val("contact-details","delete")+"</a></footer>")}if($(g).hasClass("no-sorting")){console.log(g);return}sort_tables(g)});$("body").on("click",".thead_check",function(a){console.log($(this).is(":checked"));if(!$(this).is(":checked")){$(".tbody_check").prop("checked",false);if(Current_Route=="deals"){deal_bulk_actions.toggle_deals_bulk_actions_dropdown(undefined,true,$(this).parents("table").attr("id"))}else{if(Current_Route=="users"){toggle_admin_user_bulk_actions_delete(this,true,$(this).parents("table").attr("id"))}else{toggle_contacts_bulk_actions_dropdown(undefined,true,$(this).parents("table").attr("id"))}}}else{$(".tbody_check").prop("checked",true);$("#bulk-action-btns button").removeClass("disabled")}console.log($(this).is(":checked"));if(Current_Route=="deals"){deal_bulk_actions.toggle_deals_bulk_actions_dropdown(this,true,$(this).parents("table").attr("id"))}else{if(Current_Route=="users"){toggle_admin_user_bulk_actions_delete(this,true,$(this).parents("table").attr("id"))}else{toggle_contacts_bulk_actions_dropdown(this,true,$(this).parents("table").attr("id"))}}});$("body").on("click",".tbody_check",function(a){a.stopPropagation();if(Current_Route=="dashboards"){return}if(Current_Route=="deals"){deal_bulk_actions.toggle_deals_bulk_actions_dropdown(this,false,$(this).parents("table").attr("id"))}else{if(Current_Route=="users"){toggle_admin_user_bulk_actions_delete(this,true,$(this).parents("table").attr("id"))}else{toggle_contacts_bulk_actions_dropdown(this,false,$(this).parents("table").attr("id"))}}})});function append_checkboxes(c){if(Current_Route&&(Current_Route.indexOf("contacts/search")!=-1)){return}var b=$("tr:last > td.select_checkbox",c);if(b.length!=0){if(SELECT_ALL==true||(Current_Route=="deals"&&SELECT_ALL_DEALS==true)||SUBSCRIBERS_SELECT_ALL==true){$(".tbody_check",b).attr("checked","checked")}return}if(SELECT_ALL==true||(Current_Route=="deals"&&SELECT_ALL_DEALS==true)||SUBSCRIBERS_SELECT_ALL==true){$.each($("tr td:nth-child(1)",c).not(".checkbox"),function(d,e){$(this).closest("tr").prepend('<td class="checkbox"><label class="i-checks i-checks-sm"><input class="tbody_check" type="checkbox" checked="checked"/><i></i></label></td>')});var a=$(".grid-view-checkbox",c);if(a.length!=0){a.prop("checked","checked")}}else{$.each($("tr td:nth-child(1)",c).not(".checkbox"),function(d,e){$(this).closest("tr").prepend('<td class="checkbox"><label class="i-checks i-checks-sm"><input class="tbody_check" type="checkbox"/><i></i></label></td>')})}}var SCROLL_POSITION;$(function(){$("body").on("click",'.agile-edit-row > tr > td:not(":first-child")',function(c){c.preventDefault();var a=$(this).parents(".agile-edit-row").attr("route");if(a!="task/"){if($(this).closest("tr").find("[route]").length!=0){a=$(this).closest("tr").find("[route]").attr("route")}var b=$(this).closest("tr").find(".data").attr("data");if((c.ctrlKey||c.metaKey)&&(a!="workflow/"&&a!="webrule-edit/"&&a!="user-edit/"&&a!="ticket-group/")){window.open("#"+a+b,"_blank");return}if(a=="contact/"||a=="company/"){SCROLL_POSITION=window.pageYOffset}if(a=="contact/"){SCROLL_POSITION=window.pageYOffset}console.log(b);if(b){Backbone.history.navigate(a+b,{trigger:true})}}})});$(function(){$("body").on("click","#delete-checked, .delete-checked-contacts",function(b){b.preventDefault();var a=[];var e=[];var d=[];var f=false;var j=$("body").find(".showCheckboxes");$(j).find("tr .tbody_check").each(function(l,m){if($(m).is(":checked")&&!$(m).attr("disabled")){$(m).closest("tr").on("mouseenter",false);e.push(l);if(!$(m).closest("tr").hasClass("pseduo-row")){a.push($(m).closest("tr").data().get("id"));d.push($(m).closest("tr").data().toJSON());f=true}}});if(f){if(!hasScope("DELETE_CONTACT")){showModalConfirmation(_agile_get_translated_val("bulk-delete","bulk-delete"),_agile_get_translated_val("contacts","no-permission-to-delete"),function(){return},function(){return},function(){},_agile_get_translated_val("contact-details","cancel"),"")}else{if($(j).hasClass("show-delete-modal")){var k={};k.title=$(j).attr("data-bulk-delete-title");k.msg=$(j).attr("data-bulk-delete-msg");getTemplate("bulk-actions-delete-modal",k,undefined,function(l){if(!l){return}$("#ticketsModal").html($(l)).modal("show").on("shown.bs.modal",function(){$("#ticketsModal a.bulk-delete").off("click");$("#ticketsModal a.bulk-delete").click(function(m){console.log("tickets clicked");$("#ticketsModal").modal("hide");$(this).after('<img class="bulk-delete-loading" style="padding-right:5px;margin-bottom:15px" src= "img/21-0.gif"></img>');bulk_delete_operation($(j).attr("url"),a,e,j,undefined,d)})})});return}var g=DOCS_CONTACTS_BULK_DELETE_ERROR;if($(j).attr("id")=="task-list"){g=TASKS_CONTACTS_BULK_DELETE_ERROR}if(($(j).attr("id")=="document-list"||$(j).attr("id")=="task-list")&&!hasScope("EDIT_CONTACT")){showModalConfirmation(_agile_get_translated_val("bulk-delete","bulk-delete"),g,function(){bulk_delete_operation($(j).attr("url"),a,e,j,undefined,d)},function(){return})}if(!customize_bulk_delete(a,d)){return}if(($(j).attr("id")=="document-list"||$(j).attr("id")=="task-list")&&!hasScope("EDIT_CONTACT")){return}var h=_agile_get_translated_val("others","delete-warn");var c=$(this);showAlertModal(h,"confirm",function(){if($(j).attr("id")==="active-campaign"){h=_agile_get_translated_val("contacts","delete-contacts-from")+" "+$("#subscribers-campaign-name").text()+" "+_agile_get_translated_val("contact-details","campaign")+"?"}c.append('<img class="bulk-delete-loading" style="padding-right:5px;margin-bottom:15px" src= "'+updateImageS3Path("img/21-0.gif")+'"></img>');var l=$(j).attr("url");if(SELECT_ALL&&SELECT_ALL==true){if($(j).attr("id")=="contacts-table"||$(j).attr("id")=="companies"){var m=getDynamicFilters();if(m==null){l=l+"&filter="+encodeURIComponent(getSelectionCriteria())}}}if(SUBSCRIBERS_SELECT_ALL&&SUBSCRIBERS_SELECT_ALL==true){if($(j).attr("id")=="active-campaign"){l=l+"&filter=all-active-subscribers"}}bulk_delete_operation(l,a,e,j,undefined,d)},undefined,_agile_get_translated_val("bulk-delete","bulk-delete"))}}else{if($(this).attr("disabled")==="disabled"){return}$("body").find(".select-none").html('<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>'+_agile_get_translated_val("others","bulk-delete-no-select")+"</div>").show().delay(3000).hide(1)}});$("body").on("click","#delete-checked-grid",function(e){e.preventDefault();var b=[];var a=[];var f=[];var d=false;var c=$("body").find(".showCheckboxes");$(c).find(".tbody_check").each(function(g,h){if($(h).is(":checked")){console.log($(h).parent("div").attr("id"));a.push(g);console.log(a);if($(".grid-view").length!=0){b.push($(h).parent().parent().parent("div").attr("id"))}else{b.push($(h).closest("div").attr("id"))}if(Current_Route.indexOf("users")!=-1){f.push($(h).closest("div.data").parent("div").data().toJSON())}d=true}});if(d){if(!canRunBulkOperations()){showModalConfirmation(_agile_get_translated_val("bulk-delete","bulk-delete"),_agile_get_translated_val("contacts","no-previlige-to-delete")+"<br/><br/> "+_agile_get_translated_val("deal-view","do-you-want-to-proceed"),function(){if(!customize_bulk_delete(b,f)){return}bulk_delete_operation($(c).attr("url"),b,a,c,true,f)},function(){return},function(){})}else{showAlertModal("bulk_delete","confirm",function(){if(!customize_bulk_delete(b,f)){return}bulk_delete_operation($(c).attr("url"),b,a,c,true,f)})}}else{$("body").find(".select-none").html('<div class="alert alert-danger"><a class="close" data-dismiss="alert" href="#">&times;</a>'+_agile_get_translated_val("others","bulk-delete-no-select")+"</div>").show().delay(3000).hide(1)}});$("body").on("click","#deal-delete-checked",function(f){f.preventDefault();var c=[];var b=[];var g=[];var e=false;var d=$("body").find(".showCheckboxes");var a=0;$(d).find("tr .tbody_check").each(function(h,j){if($(j).is(":checked")){$(j).closest("tr").on("mouseenter",false);b.push(h);a++;if(!$(j).closest("tr").hasClass("pseduo-row")){c.push($(j).closest("tr").data().get("id"));g.push($(j).closest("tr").data().toJSON());e=true}}});if(e){if(!hasScope("DELETE_DEALS")){showModalConfirmation(_agile_get_translated_val("bulk-delete","bulk-delete"),_agile_get_translated_val("deal-view","persmission-to-delete-deals"),function(){return},function(){return},function(){},"Cancel","");return}if(!hasScope("EDIT_CONTACT")){showModalConfirmation(_agile_get_translated_val("bulk-delete","bulk-delete"),DEALS_CONTACTS_BULK_DELETE_ERROR,function(){if(!customize_bulk_delete(c,g)){return
}var h=$(d).attr("url");if(SELECT_ALL==true){if($(d).attr("id")=="contacts-table"||$(d).attr("id")=="companies"){var j=getDynamicFilters();if(j==null){h=h+"&filter="+encodeURIComponent(getSelectionCriteria())}}}if(SUBSCRIBERS_SELECT_ALL==true){if($(d).attr("id")=="active-campaign"){h=h+"&filter=all-active-subscribers"}}bulk_delete_operation(h,c,b,d,undefined,g)},function(){return},function(){})}else{showModalConfirmation(_agile_get_translated_val("bulk-delete","bulk-delete"),_agile_get_translated_val("contact-details","delete")+" "+a+" "+_agile_get_translated_val("deal-view","Deals?"),function(){if(!customize_bulk_delete(c,g)){return}var h=$(d).attr("url");if(SELECT_ALL&&SELECT_ALL==true){if($(d).attr("id")=="contacts-table"||$(d).attr("id")=="companies"){var j=getDynamicFilters();if(j==null){h=h+"&filter="+encodeURIComponent(getSelectionCriteria())}}}bulk_delete_operation(h,c,b,d,undefined,g)})}}else{if($(this).attr("disabled")==="disabled"){return}$("body").find(".select-none").html('<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>'+_agile_get_translated_val("others","bulk-delete-no-select")+"</div>").show().delay(3000).hide(1)}})});function customize_bulk_delete(a,b){if(Current_Route=="users"){$.each(b,function(d,c){if(c.is_admin){a.splice(a.indexOf(c.id),1)}});if(a.length==0){$("body").find(".select-none").html('<div class="alert alert-danger"><a class="close" data-dismiss="alert" href="#">&times;</a>'+_agile_get_translated_val("users","delete-user-error")+"</div>").show().delay(5000).hide(1);return false}}return true}function bulk_delete_operation(b,a,e,h,g,c){var j={};var d=a.length;if(!SELECT_ALL){j.ids=JSON.stringify(a)}var f=getDynamicFilters();if(f!=null){j.dynamic_filter=f}$.ajax({url:b,type:"POST",data:j,contentType:"application/x-www-form-urlencoded",success:function(){if(b=="core/api/tasks/bulk"){getDueTasksCount(function(q){var p=q;if(p==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}if(p!=0){$("#due_tasks_count").html(p)}else{$("#due_tasks_count").html("")}})}if(b=="core/api/dashboards/bulk"){if(App_Dashboards.dashboards_collection_view&&App_Dashboards.dashboards_collection_view.collection){$.each(a,function(q,p){App_Dashboards.dashboards_collection_view.collection.remove(p)})}if(CURRENT_USER_DASHBOARDS&&CURRENT_USER_DASHBOARDS.length>0){$.each(a,function(q,p){$.each(CURRENT_USER_DASHBOARDS,function(t,s){if(p==this.id){CURRENT_USER_DASHBOARDS.splice(t,1)}})})}}$(".bulk-delete-loading").remove();if(b=="core/api/users/bulk"&&!_billing_restriction.currentLimits.freePlan){var o;if(d>1){o=_agile_get_translated_val("users","deleted-users")}else{o=_agile_get_translated_val("users","deleted-user")}showNotyPopUp("information",o,"top",10000)}if(d>=100||d==0){if($(h).attr("id")=="contacts-table"){showNotyPopUp("information",_agile_get_translated_val("contacts","delete-process-info"),"top",5000);CONTACTS_HARD_RELOAD=true}if($(h).attr("id")=="companies"){showNotyPopUp("information",_agile_get_translated_val("companies","delete-process-info"),"top",5000);COMPANIES_HARD_RELOAD=true}}if(!g){var l=$(h).find("tbody");for(var m=0;m<e.length;m++){$(l).find("tr:eq("+e[m]+")").fadeOut(300,function(){$(this).remove()})}}else{for(var m=0;m<a.length;m++){$("."+a[m]).fadeOut(300,function(){$(this).remove()})}}try{if(App_Workflows.workflow_list_view&&Current_Route=="workflows"){for(m=0;m<a.length;m++){App_Workflows.workflow_list_view.collection.remove(a[m]);$(App_Workflows.workflow_list_view.el).find(a[m]).closest("tr").remove()}}}catch(n){}$(".thead_check").attr("checked",false);switch(b){case"core/api/tickets/groups/bulk":if(a.length==App_Ticket_Module.groupsCollection.collection.length){App_Ticket_Module.ticketGroups()}break;case"core/api/tickets/canned-messages/bulk":if(a.length==App_Ticket_Module.cannedResponseCollection.collection.length){App_Ticket_Module.cannedResponses()}break;case"core/api/tickets/filters/bulk":if(a.length==App_Ticket_Module.ticketFiltersList.collection.length){App_Ticket_Module.ticketFilters()}$.each(a,function(p,q){App_Ticket_Module.ticketFiltersList.collection.remove(q)});if(a.indexOf(Ticket_Filter_ID)!=-1){var k=App_Ticket_Module.ticketFiltersList.collection.at(0).toJSON();Ticket_Filter_ID=k.id}break;case"core/api/tickets/labels/bulk":if(a.length==Ticket_Labels.labelsCollection.collection.length){App_Ticket_Module.ticketLabels()}break}toggle_contacts_bulk_actions_dropdown(undefined,true,$(".thead_check").parents("table").attr("id"));if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){activate_timeline_tab();$.each(c,function(p,q){var s=$("#"+q.id);$("#timeline").isotope("remove",s)})}}})}function customize_delete_message(b){if(($(b).attr("id")=="document-list"||$(b).attr("id")=="task-list")&&!hasScope("EDIT_CONTACT")){return}var a=_agile_get_translated_val("others","delete-warn");if($(b).attr("id")==="active-campaign"){a=_agile_get_translated_val("contacts","delete-contacts-from")+$("#subscribers-campaign-name").text()+" "+_agile_get_translated_val("contact-details","campaign")+"?"}return true}var TAG_MODEL_VIEW=Backbone.View.extend({events:{"click .delete":"deleteItem","click .edit":"edit","delete-checked .agile_delete":"deleteItem","keypress .edit-input":"renameTag","blur .edit-input":"updateTag",mouseover:"showActionButtons",mouseout:"hideActionButtons","click .details":"showDetails","click #add-new-tag":"addNewTag",},initialize:function(){_.bindAll(this,"render","deleteItem","edit");this.model.bind("destroy",this.close,this);this.model.bind("change",this.render,this)},showDetails:function(c){c.preventDefault();var b=this;var a=$(".details",this.el);$.getJSON("core/api/tags/getstats/"+this.model.get("tag"),function(d){b.model.set("availableCount",d.availableCount);console.log(b.model.toJSON());$(b.el).find(".tag_tooltip").tooltip({title:b.model.get("availableCount")+" Contacts",placement:"right"}).on("mouseleave",function(){$(".tags-management #actions").hide()});$(b.el).find(".tag_tooltip").trigger("mouseover");$(b.el).find(".details").hide()})},renameTag:function(a){if(a.keyCode==13){$(a.currentTarget).blur()}},updateTag:function(j){if(this.model.get("tag")==this.input.val()){$("#tag-solid-state",this.el).show();$("#editing",this.el).hide();$(this.el).addClass("tag");return}if(!isValidTag(this.input.val(),true)){this.input.val(this.model.get("tag")).focus();return}var d=this.input.val().trim();var b=this.model.get("tag");var h=false;var g={};g.tag=d;var c=isMergeTag(g);var f="";if(c){f='<p>Tag "'+d+'" exists already. Do you want to merge "'+b+'" and "'+d+'" ?</p>'}else{f='<p>Rename tag "'+b+'" to "'+d+'" ?</p>'}var a=this;h=showModalConfirmation("Tag Management Action",f,function(){a.model.url="core/api/tags/bulk/rename?tag="+d;a.model.save([],{success:function(e){if(c){showNotyPopUp("information",getTemplate("js-merge-tags",{oldTag:b,newTag:d}),"top",5000)}else{showNotyPopUp("information",getTemplate("js-rename-tags",{oldTag:b,newTag:d}),"top",5000)}renameTags(d,b);App_Admin_Settings.tagManagement()}});if(c){a.remove();return}a.model.set("tag",a.input.val().trim());$(a.el).addClass("tag");if(isValidTag(a.input.val().trim(),false)){$(a.el).removeClass("error")}},function(){a.reset();return},function(){a.reset();return})},reset:function(){$("#tag-solid-state",this.el).show();$("#editing",this.el).hide();$(this.el).addClass("tag")},showActionButtons:function(a){a.preventDefault();$("#actions",this.el).show();$("a",this.el).popover("toggle")},hideActionButtons:function(a){a.preventDefault();$("#actions",this.el).hide();$(this.el).attr({"data-trigger":"click",});$(this.el).popover({trigger:"focus",hide:true})},addNewTag:function(a){a.preventDefault();$("#add-new-tag",this.el).addClass("hide");$("#new_tag_field_block",this.el).removeClass("hide")},deleteItem:function(b){b.preventDefault();var a=this;showModalConfirmation("Tag Management",'<p>Delete "'+this.model.get("tag")+'" tag ?</p>',function(){a.model.url="core/api/tags/bulk/delete?tag="+escape(a.model.get("tag"));a.model.set({id:a.model.get("tag")});a.model.destroy({success:function(c,d){showNotyPopUp("information",getTemplate("js-deleting-tags",{tag:a.model.get("tag")}),"top",5000);App_Admin_Settings.tagManagement()}})})},edit:function(a){a.preventDefault();$("#tag-solid-state",this.el).hide();$(this.el).removeClass("tag");$("#editing",this.el).show();addTagsDefaultTypeahead($("#editing",this.el));this.input.attr("width","100%").focus();this.input.val(this.model.get("tag"))},render:function(a){$(this.el).html(getTemplate(this.options.template,this.model.toJSON()));$(this.el).data(this.model);this.input=$(".edit-input",this.el);return this}});function append_tag_management(a){var e=new TAG_MODEL_VIEW({model:a,view:"inline",template:this.options.templateKey+"-model",tagName:"li",});console.log(e);var c=a.get("tag").charAt(0).toUpperCase();console.log($('div[tag-alphabet="'+encodeURI(c)+'"]',this.el));var d=e.render().el;$(d).addClass("tag bg-white").css("margin-top","10px");var f=a.get("tag");if(!isValidTag(f,false)){$(d).addClass("error")}var b=$('div[tag-alphabet="'+encodeURI(c)+'"] ul',this.el);console.log(b.length);if(b.length>0){$('div[tag-alphabet="'+encodeURI(c)+'"] ul',this.el).append($(d))}else{$(this.model_list_element).append("<div class='clearfix'></div>").append($(d))}}function initializeTagManagementListeners(){$("#admin-prefs-tabs-content").on("click","#add-new-tag",function(a){a.preventDefault();toggleAddTag(true)});$("#admin-prefs-tabs-content").on("keydown","#new_tag",function(a){console.log(a.which);if(a.which==0){blur_out_input_field(this);return}else{if(a.which!=13){return}}saveTag(this)})}function blur_out_input_field(a){var b=$(a).val().trim();if(b==""){toggleAddTag(false);return}saveTag(a)}function toggleAddTag(a){if(a){$("#add-new-tag").hide();$("#new_tag_field_block").show();$("#add_new_tag").removeAttr("disabled");$("#new_tag").focus();console.log($("#add_new_tag").attr("disabled"));
return}$("#add-new-tag").show();$("#new_tag_field_block").hide()}$("body").on("click","#add_new_tag",function(b){b.preventDefault();var a=$().val();blur_out_input_field("#new_tag")});function saveTag(f){var e=$(f).val();if($(f).attr("disabled")){return}if(!isValidTag(e,true)){$(f).focus();return}var g=App_Admin_Settings.tagsview1.collection.where({tag:e.trim()});if(g&&g.length>0){var d='<p>Tag "'+e.trim()+'" exists already. Please choose a different name.</p>';var c=this;r=showModalConfirmation("Tag Management Action",d,function(){return},function(){return},function(){return},"Ok");return}var a={};a.tag=e.trim();$(f).attr("disabled","disabled");var b=new BaseModel(a);b.url="core/api/tags";b.save([],{success:function(h){$(f).val("");$(f).removeAttr("disabled");toggleAddTag(false);showNotyPopUp("information",'New tag "'+b.get("tag")+'" created.',"top",5000);if(tagsCollection&&tagsCollection.models){tagsCollection.add(h.toJSON())}App_Admin_Settings.tagManagement()}});console.log(App_Admin_Settings);App_Admin_Settings.tagsview1.collection.add(b)}function isValidTag(a,e){var d="\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA793\uA7A0-\uA7AA\uA7F8-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC";var c="^["+d+"]["+d+" 0-9_-]*$";var b=new RegExp(c).test(a);if(e&&!b){showAlertModal("tag_name_restriction")}return b}function addTagsDefaultTypeaheadTagManagement(b){var a=[];if(!TAGS){var c=Backbone.Collection.extend({url:"/core/api/tags",sortKey:"tag"});tagsCollection=new c();tagsCollection.fetch({success:function(d){TAGS=tagsCollection.models;addTagsArrayasTypeaheadSource(tagsCollection.toJSON(),b)}});return}addTagsArrayasTypeaheadSourceTagManagement(tagsCollection.toJSON(),b)}function isMergeTag(a){console.log(App_Admin_Settings.tagsview1.collection.where({tag:a.tag}));return(App_Admin_Settings.tagsview1.collection.where({tag:a.tag}).length>0)}function addTagsArrayasTypeaheadSource(b,c){var a=[];$.each(b,function(d,e){a.push(e.tag.toString())});$("input",c).typeahead({source:a}).attr("placeholder","Enter Tag")}function showModalConfirmation(h,f,c,j,b,d,k){if(!d&&!k){d="Yes";k="No"}var e="";var g="";if(d){e='<a href="#" id="confirm" class="action btn btn-primary" action="confirm">'+d+"</a>"}if(k){g='<a  href="#" id="deny" class="btn btn-danger action" data-dismiss="modal" action="deny">'+k+"</a>"}var a=$('<div id="confirmation" class="modal fade in"><div class="modal-dialog"><div class="modal-content"><div class="modal-header" ><a href="#" data-dismiss="modal" class="close">&times;</a><h3>'+h+'</h3></div><div class="modal-body">'+f+'</div><div class="modal-footer"><div>'+g+e+"</div></div></div></div></div></div>");a.modal("show");a.focus();a.on("hidden.bs.modal",function(l){if(b&&typeof b=="function"){b()}});$(".action",a).click(function(m){m.preventDefault();var l=$(this).attr("action");a.modal("hide");if(l=="confirm"&&c&&typeof c=="function"){c();return}if(j&&typeof j=="function"){j(this)}})}function saveDealTag(b,g){var c;var f=b;if(!isValidTag(f,true)){$(field).focus();return}if(TAGS){var e;for(e=0;e<TAGS.length;e++){if(TAGS[e].attributes.tag==f){c=1;break}}}if(c==1){return}var a={};a.tag=f.trim();var d=new BaseModel(a);d.url="core/api/tags";d.save([],{success:function(h){if(tagsCollection&&tagsCollection.models){tagsCollection.add(h.toJSON())}if(g&&App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.get("id")){App_Deal_Details.dealDetailView.model.set(g.toJSON(),{silent:true});App_Deal_Details.dealDetailView.render(true)}}})}function saveDealTagsBulk(f){var b=[];var g;var a=false;var e;if(f&&f.length){for(g=0;g<f.length;g++){if(TAGS){var d;for(d=0;d<TAGS.length;d++){if(TAGS[d].attributes.tag==f[g]){a=true}}if(!a){b.push(f[g])}else{a=false}}else{b=f}}var c=JSON.stringify(b);if(c){var e="core/api/tags/AddbulkTags";$.ajax({type:"POST",contentType:"application/json",url:e,data:c,dataType:"json",success:function(){console.log(c);if(TAGS){var h=JSON.parse(c);for(g=0;g<h.length;g++){TAGS.push({entity_type:"tag",tag:h[g]})}}}})}}}function initWebstatsDateRange(){$("#activities_date_range").daterangepicker({ranges:{Today:["today","today"],Yesterday:["yesterday","yesterday"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 30 Days":[Date.today().add({days:-29}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})]},locale:{applyLabel:"Apply",clearLabel:"Clear",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",daysOfWeek:$.fn.datepicker.dates.en.daysExactMin,monthNames:$.fn.datepicker.dates.en.months,firstDay:parseInt(CALENDAR_WEEK_START_DAY)}},function(d,b){if(d&&b){$("#activities_date_range #range").html(d.toString("MMMM d, yyyy")+" - "+b.toString("MMMM d, yyyy"));VISITORS_HARD_RELOAD=true;App_VisitorsSegmentation.visitorssegmentation(getTimeWebstats(),true)}else{var c=Date.parse("today");var a=Date.today().add({days:parseInt(-6)});$("#activities_date_range #range").html(a.toString("MMMM d, yyyy")+" - "+c.toString("MMMM d, yyyy"));VISITORS_HARD_RELOAD=true;App_VisitorsSegmentation.visitorssegmentation(getTimeWebstats(),true);$(".daterangepicker > .ranges > ul > li.active").removeClass("active")}});$(".daterangepicker > .ranges > ul").on("click","li",function(a){$(".daterangepicker > .ranges > ul > li").each(function(){$(this).removeClass("active")});$(this).addClass("active")})}function getTimeWebstats(){var a=new Array();var b=$("#range").html().split("-");var d=new Date(b[0]).getTime();var e=$.trim(b[1]);e=e+" 23:59:59";var c=new Date(e).getTime();a[0]=d;a[1]=c;if(_agile_get_prefs("duration")!=null){_agile_delete_prefs("duration")}_agile_set_prefs("duration","start_time :"+d+",end_time :"+c);return a}function getFirstTimeWebstats(){var a=new Array();lastday=Date.today();lastday.setDate(new Date().getDate()-6);
var c=lastday.getTime();var d=new Date();var b=d.getTime();a[0]=c;a[1]=b;return a}function deserializeRhsFilters(c){var b=c.split(",");var d=new Date(Number(b[0].substr(b[0].indexOf(":")+1)));var a=new Date(Number(b[1].substr(b[1].indexOf(":")+1)));$("#activities_date_range #range").html(d.toString("MMMM d, yyyy")+" - "+a.toString("MMMM d, yyyy"))}function addModalEvent(a,b){$("#"+a).off("click",".new-segment");$("#"+a).on("click",".new-segment",{filter_list:b},function(f){f.preventDefault();if($("#save-new-type").prop("checked")==true){return}$("div.update-segment-name").toggle();$("div.choose-segment-filter").toggle();$("#save-new-type").prop("checked",true);var d=f.data.filter_list;var c=$(".update-segment-name input").val();if(!c||c){$.each(d,function(e){if(d[e].name==c){$("#segmentsModal #duplicate-name").removeClass("hide");$("#segmentsModal .save").addClass("disabled");return}})}});$("#"+a).off("click",".replace-segment");$("#"+a).on("click",".replace-segment",function(c){c.preventDefault();if(($("#save-replace-type").prop("checked")||$(".choose-segment-filter").prop("disabled"))==true){return}if(!$("#segmentsModal #duplicate-name").hasClass("hide")){$("#segmentsModal #duplicate-name").addClass("hide");$("#segmentsModal .save").removeClass("disabled")}$("div.update-segment-name").toggle();$("div.choose-segment-filter").toggle();$("#save-replace-type").prop("checked",true)});$("#"+a).on("click",".save",function(c){c.preventDefault();disable_save_button($("#segmentsModal .save"))});$("#"+a).on("change","#saveSegmentFilterForm .choose-segment-filter select",function(d){d.preventDefault();var c=$('[name="filter-collection"] option:selected').text();$('input[name="name"]',$("form#saveSegmentFilterForm")).val(c)});$("#"+a).on("blur",".update-segment-name input",{filter_list:b},function(f){f.preventDefault();var d=f.data.filter_list;var c=$(this).val();$.each(d,function(e){if(d[e].name==c){$("#segmentsModal #duplicate-name").removeClass("hide");$("#segmentsModal .save").addClass("disabled");return}})});$("#"+a).on("keyup",".update-segment-name input",function(c){c.preventDefault();if(!$("#segmentsModal #duplicate-name").hasClass("hide")){$("#segmentsModal #duplicate-name").addClass("hide");$("#segmentsModal .save").removeClass("disabled")}return})}function addEventFilter(a){$("#"+a).on("click",".segment-lilist",function(b){if(b.target.nodeName=="BUTTON"){setupSegmentFilterList("");return}b.preventDefault();var d=$(b.currentTarget);_agile_delete_prefs("dynamic_visitors_filter");_agile_delete_prefs("visitor_repeat_filter");var c=$(d).attr("id");_agile_set_prefs("visitor_filter",c);VISITORS_HARD_RELOAD=true;App_VisitorsSegmentation.visitorssegmentation();return});$("#"+a).on("mouseenter","li",function(b){$(this).find("#remove-segment-filter").removeClass("hide")});$("#"+a).on("mouseleave","li",function(b){$(this).find("#remove-segment-filter").addClass("hide")});$("#"+a).on("click","#remove-segment-filter",function(d){d.preventDefault();var c=$(this).attr("data");var b=$(this).attr("data-name");_agile_delete_prefs("dynamic_visitors_filter");$.ajax({url:"/core/api/web-stats/filters?Id="+c,type:"DELETE",contentType:"application/json"});if($("#filters-tour-step i span").text()==b){setupAnalyticsLhsFilters("");_agile_delete_prefs("visitor_filter")}return})}var segmentFilterList;function setupSegmentFilterList(a,c){var b;segmentFilterList=new Base_Collection_View({url:"/core/api/web-stats/filters",sort_collection:false,restKey:"SegmentFilter",templateKey:"segment-filter-list",individual_tag_name:"li",postRenderCallback:function(e,g){if(g.length==0){$("#filters-tour-step >button").addClass("disabled")}else{$("#filters-tour-step >button").removeClass("disabled")}addEventFilter("segment-filter-list-model-list");if(c){var f=g.get(c).attributes.name;if(_agile_get_prefs("visitor_filter")&&f!=$("#filters-tour-step button i span").text()){if(!_agile_get_prefs("visitor_repeat_filter")){deserializeLhsFilters($("#lhs-contact-filter-form"),g.get(c).attributes.segmentConditions)}else{_agile_set_prefs("visitor_filter",c)}}else{_agile_delete_prefs("dynamic_visitors_filter");_agile_set_prefs("visitor_filter",c)}if(f!=$("#filters-tour-step button i span").text()){var d='<span class="segment-filter-name" style= "padding-left:3px;">'+f+"</span>";$("#filters-tour-step").find("#segment-filter").append(d)}}else{$("#filters-tour-step").find("#segment-filter").find(".segment-filter-name").remove()}}});segmentFilterList.collection.fetch();$("#filter-list",a).html(segmentFilterList.render().el)}$(function(){$("body").on("click",".upload_s3",function(a){a.preventDefault();uploadImage("upload-container",$(this).closest("div"))});$("body").on("click",".upload_pic, .edit-pic",function(a){a.preventDefault();verifyUpdateImgPermission(function(b){if(b){uploadImage("contact-container")}})});$("body").on("click",".upload_prefs_s3",function(a){a.preventDefault();uploadImage("upload-in-modal")})});function uploadImage(g,e){var d=["contact/","company/","user-prefs"];var c=false;for(var b=0;b<d.length;b++){if(window.location.href.indexOf(d[b])>0){c=true}}var a="flatfull/upload-flatfull.jsp?id="+g;if(c){a+="&enable_crop=true"}var f=window.open(a,"name","height=310,width=500");if(window.focus){f.focus()}return false}function setImageURLInModal(b){var c="upload-in-modal";$("#"+c).find(".imgholder").html("");$("#"+c).find(".imgholder").html('<img class="m-b-none avatar-thumb" src="'+b+'" style="height:58px;width:58px;"/>');var a=$("#"+c).closest(".modal").attr("id");$("#"+a).find(".modal-body input[type='hidden']").val(b);$("#"+a).closest(".modal").modal("hide");$("#"+a).trigger("choose-image")}function setImageURL(a){var b="upload-container";$("#"+b).find(".imgholder").html("");$("#"+b).find(".imgholder").html('<img class="w-full" src="'+a+'"/>');$("#"+b).find("#upload_url").val(a)}function setContactImageURL(a){var b="contact-container";$("#"+b).find(".contact-image-view").html("");$("#"+b).find(".contact-image-view").html('<img src="'+a+'" class="upload_pic imgholder submit w-full img-circle" style="width:75px;height:75px;" type="submit" />');if($(".toggle-contact-image .contact-delete-option").length==0){$("#"+b).find(".toggle-contact-image").append('|<div style="float:right" class="contact-delete-option"><a name="Delete" value="Delete" onClick="deleteConfirmation();" class="tooltip_info" data-placement="bottom" data-toggle="tooltip" title="Delete"><i class="glyphicon glyphicon-trash" style="color:red"></i></a></div>');$("#"+b).find(".toggle-contact-image").find(".contact-edit-option").removeAttr("style");$("#"+b).find(".toggle-contact-image").find(".contact-edit-option").css("float","left")}$("#"+b).find("#upload_url").val(a);agile_crm_update_contact("image",a)}function deleteContactImage(){var a=window.location.href;var b=a.replace(/\/\s*$/,"").split("/");contactId=b[b.length-1];var a="/core/api/contacts/deleteContactImage?id="+contactId;$.ajax({type:"PUT",url:a,success:function(){var k=DEFAULT_GRAVATAR_url;var l='&d=404" ';var g="";try{var c=$("#contactName .contactFirstname").text();if(c.length>=2){g=c.substring(0,2)}else{g=c}}catch(m){console.log(m)}if(g.length==0){l="&d="+DEFAULT_GRAVATAR_url+'" '}var h="";h='onLoad="image_load(this)" onError="image_error(this)"_data-name="'+g;var d="https://secure.gravatar.com/avatar/"+Agile_MD5("")+".jpg?s=40"+l+h;var f="contact-container";$("#"+f).find(".contact-image-view").html("");$("#"+f).find(".contact-image-view").html('<img src="'+d+'" class="upload_pic imgholder submit w-full img-circle" style="width:75px;height:75px;"/>');if($(".toggle-contact-image .contact-delete-option").length>0){$("#"+f).find(".toggle-contact-image").empty();$("#"+f).find(".toggle-contact-image").append('<div style="float:left" class="contact-edit-option"><a name="Delete" class="tooltip_info  edit-pic" data-placement="bottom" data-toggle="tooltip" title="Change"><i class="glyphicon glyphicon-edit"></i></a></div>');$("#"+f).find(".toggle-contact-image").find(".contact-edit-option").css("margin-left","10px")}var n=App_Contacts.contactsListView.collection.get(contactId).get("properties");var j;for(j=0;j<n.length;j++){if(n[j].name=="image"){n.splice(j,1)}}var o=App_Contacts.contactDetailView.model;var p=o.toJSON()["properties"];for(j=0;j<p.length;j++){if(p[j].name=="image"){p.splice(j,1)}}},error:function(){console.log("An error occurred")}})}function deleteConfirmation(){var a;verifyUpdateImgPermission(function(b){if(b){showAlertModal("delete","confirm",function(){deleteContactImage()})}})}function verifyUpdateImgPermission(c){if(Current_Route&&Current_Route.indexOf("contact/")==0&&App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){var b=App_Contacts.contactDetailView.model.get("owner");if(b&&b.id!=CURRENT_DOMAIN_USER.id&&!hasScope("EDIT_CONTACT")){showModalConfirmation(_agile_get_translated_val("contacts","contact-update"),-_agile_get_translated_val("contacts","no-perm-to-update"),function(){return},function(){return},function(){},_agile_get_translated_val("contact-details","cancel"),"");if(c&&typeof c==="function"){return c(false)}}}if(Current_Route&&Current_Route.indexOf("company/")==0&&App_Companies.companyDetailView&&App_Companies.companyDetailView.model){var a=App_Companies.companyDetailView.model.get("owner");if(a&&a.id!=CURRENT_DOMAIN_USER.id&&!hasScope("EDIT_CONTACT")){showModalConfirmation(_agile_get_translated_val("companies","company-update"),_agile_get_translated_val("companies","no-perm-to-update"),function(){return},function(){return},function(){},_agile_get_translated_val("contact-details","cancel"),"");if(c&&typeof c==="function"){return c(false)}}}if(c&&typeof c==="function"){return c(true)}}var Template_Render_Image_Loader='<img class="loading" style="padding-right:5px;opacity:0.5;" src= "'+updateImageS3Path("/flatfull/img/ajax-loader-cursor.gif")+'"></img>';var Count_XHR_Call;var CONTACTS_ACLS_UPDATE_ERROR="You do not have permission to update this contact.";var DEALS_CONTACTS_BULK_DELETE_ERROR="Deals will not be deleted for contacts for which you do not have update permissions.<br/><br/> Do you want to proceed?";
var DEALS_CONTACTS_BULK_ARCHIVE_ERROR="Deals will not be archived for contacts for which you do not have update permissions.<br/><br/> Do you want to proceed?";var DEALS_CONTACTS_BULK_RESTORE_ERROR="Deals  will not be restored for contacts for which you do not have update permissions.<br/><br/> Do you want to proceed?";var DEALS_CONTACTS_BULK_TAGS_ERROR="Tags will not be added for contacts for which you do not have update permissions.<br/><br/> Do you want to proceed?";var DEALS_CONTACTS_BULK_UPDATE_ERROR="Deals will not be updated for contacts for which you do not have update permissions.<br/><br/> Do you want to proceed?";var DEALS_CONTACTS_BULK_OWNER_CHANGE_ERROR="Owner for deals will not be changed for contacts for which you do not have update permissions.<br/><br/> Do you want to proceed?";var DOCS_CONTACTS_BULK_DELETE_ERROR="Documents will not be deleted for contacts for which you do not have update permissions(s).<br/><br/> Do you want to proceed?";var DEALS_ARCHIVE_CONTACT_ACL_ERROR="Deal cannot be archived because you do not have permission to update associated contact(s).";var DEALS_RESTORE_CONTACT_ACL_ERROR="Deal cannot be restored because you do not have permission to update associated contact(s).";var TASKS_CONTACTS_BULK_DELETE_ERROR="Tasks will not be deleted for contacts for which you do not have update permissions.<br/><br/> Do you want to proceed?";var CONTACTS_ACTIVITY_ACL_DELETE_ERROR="cannot be deleted because you do not have permission to update associated contact(s).";var DOC_ACL_DETACH_ERROR="Document cannot be detached because you do not have permission to update associated contact(s).";function customize_isotope(){$.Isotope.prototype._spineAlignReset=function(){this.spineAlign={colA:0,colB:0,lastY:-60}};$.Isotope.prototype._spineAlignLayout=function(f){var a=this,d=this.spineAlign,c=Math.round(this.options.spineAlign&&this.options.spineAlign.gutterWidth)||0,e=Math.round(this.element.width()/2);Date.prototype.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];Date.prototype.getMonthName=function(){return this.monthNames[this.getMonth()]};var b=new Date();f.each(function(j,h){var l=$(this);l.removeClass("last").removeClass("top");if(j==f.length-1){l.addClass("last")}var o,n;if(l.hasClass("year-marker")){var g=l.width();o=e-(g/2);if(d.colA>=d.colB){n=d.colA;if(n==0){l.addClass("top");if(l.find(".year").text()==b.getMonthName()){l.find(".inner2").addClass("inner2-top");l.find(".inner2").removeClass("inner2");l.find(".year").text("Now")}}d.colA+=l.outerHeight(true);d.colB=d.colA}else{n=d.colB;if(n==0){l.addClass("top");if(l.find(".year").text()==b.getMonthName()){l.find(".inner2").addClass("inner2-top");l.find(".inner2").removeClass("inner2");l.find(".year").text("Now")}}d.colB+=l.outerHeight(true);d.colA=d.colB}}else{var p=((j+1)%4)+1;l.removeClass("color1").removeClass("color2").removeClass("color3").removeClass("color4");l.addClass("color"+p);l.removeClass("left").removeClass("right");var k=d.colB>=d.colB;if(k){l.addClass("right")}else{l.addClass("right")}o=k?e+(c/2):e+(c/2);n=k?d.colB:d.colB;if(n-d.lastY<=60){var m=60-Math.abs(n-d.lastY);l.find(".inner").css("marginTop",0);d.lastY=n+m}else{l.find(".inner").css("marginTop",0);d.lastY=n}d[(k?"colB":"colB")]+=l.outerHeight(true)}a._pushPosition(l,o,n)})};$.Isotope.prototype._spineAlignGetContainerSize=function(){var a={};a.height=this.spineAlign[(this.spineAlign.colB>this.spineAlign.colA?"colB":"colB")];return a};$.Isotope.prototype._spineAlignResizeChanged=function(){return true}}function configure_timeline(c){var b=0;customize_isotope();var d=$("#timeline",(c?c:App_Contacts.contactDetailView.el));var a="";d.isotope({itemSelector:".item",transformsEnabled:true,layoutMode:"spineAlign",spineAlign:{gutterWidth:56},getSortData:{timestamp:function(e){a=parseFloat(e.find(".timestamp").text());var f=parseFloat(e.find(".timestamp").text());if(!f){return 0}if((f/100000000000)>1){return f/1000}return f}},sortBy:"timestamp",sortAscending:false,itemPositionDataEnabled:true,onLayout:function(e){e.removeClass("special");setTimeout(function(){e.addClass("special");e.addClass(e.attr("id")+"");if(e.attr("id")!=undefined){e.addClass("special");e.addClass(e.attr("id")+"");var f=parseInt(e.height())+10;if(e.hasClass("color1")){$("head").append("<style>.post.right.color1.special:before{padding-bottom:"+f+"px;}</style>")}if(e.hasClass("color2")){$("head").append("<style>.post.right.color2.special:before{padding-bottom:"+f+"px;}</style>")}if(e.hasClass("color3")){$("head").append("<style>.post.right.color3.special:before{padding-bottom:"+f+"px;}</style>")}if(e.hasClass("color4")){$("head").append("<style>.post.right.color4.special:before{padding-bottom:"+f+"px;}</style>")}}},1000)}})}function load_timeline_details(b,d,c,a){noAnimationBruteForce=true;timeline_entity_loader.init(App_Contacts.contactDetailView.model.toJSON())}function add_entity_to_timeline(a){var b=[];b.push(a.toJSON());if(!timeline_collection_view){return}if(!timeline_collection_view.collection.get(a.get("id"))){timeline_collection_view.addItems(b);return}update_entity_template(a)}function update_entity_template(a){getTemplate("timeline1",[a.toJSON()],undefined,function(b){if(!b){return}$("#"+a.get("id"),$("#timeline",App_Contacts.contactDetailView.el)).html($(b).children())},"#"+a.get("id"),$("#timeline",App_Contacts.contactDetailView.el))}function removeItemFromTimeline(a){try{$("#timeline").isotope("remove",a,function(){$("#timeline").isotope("reLayout")})}catch(b){}}function addTagToTimelineDynamically(a,b){if(!timeline_collection_view||!timeline_collection_view.collection){return}$.each(b,function(d,c){if(c.tag==a){timeline_collection_view.collection.add(new BaseModel(c))}});console.log(b)}function timline_fetch_data(a,b){}var timeline_entity_loader={init:function(a){this.active_connections=0;MONTH_YEARS=[];var b=this;head.load(FLAT_FULL_PATH+"lib/isotope.pkgd.js",FLAT_FULL_PATH+"lib/jquery.event.resize.js",FLAT_FULL_PATH+"css/misc/agile-timline.css",function(){configure_timeline();timeline_collection_view=new timeline_view();console.log(b);b.load_other_timline_entities(a);timeline_collection_view.render(true)})},load_other_timline_entities:function(a){var b=a.id;this.load_related_entites(b);this.load_stats(a);this.load_campaign_logs(b);this.get_stats(getPropertyValue(a.properties,"email"),a,App_Contacts.contactDetailView.el)},load_reload_emails:function(a){divArr=$(".isotope-item");$.each(divArr,function(b,c){parentEMailDivId=divArr[b].id;childEMailDivId=parentEMailDivId+"-inner";if($("#"+childEMailDivId).length==0){childEMailDivId=parentEMailDivId+"\\/-inner";$("#"+parentEMailDivId).html($("#"+childEMailDivId).wrapAll("<div>").parent().html());$("#"+childEMailDivId).remove()}})},load_related_entites:function(c){var a=["deals","notes","cases","tasks","calls","events","tickets"];var b="core/api/contacts/related-entities/"+c;this.timline_fetch_data(b,function(e){var f=[];for(var d in a){if(e[a[d]].length==0){continue}f=f.concat(e[a[d]])}if(App_Contacts.contactDetailView.model.get("id")==c){timeline_collection_view.addItems(f)}})},load_stats:function(a){var b=getAllPropertyValuesByName(a.properties,"email",",");if(b){this.timline_fetch_data("core/api/emails/imap-email?e="+encodeURIComponent(b)+"&c=10&o=0",function(g){console.log(g);if(g&&g.emails){var k=[];$.each(g.emails,function(l,m){if(("errormssg" in m)||m.status==="error"){return}k.push(m)});if(App_Contacts.contactDetailView.model.get("id")!==a.id){return}var d=[];var f=timeline_entity_loader.getOpenedEmailsFromEmails(g.emails);if(f){d=f.concat(k)}if(d){timeline_collection_view.addItems(d)}}if(g&&g.emailPrefs){killAllPreviousRequests();var c=g.emailPrefs;var h=[];for(var e=0;e<c.length;e++){var j=$.ajax({url:c[e]+"&search_email="+encodeURIComponent(b),success:function(m){if(m){var l=[];$.each(m,function(n,o){if(("errormssg" in o)||o.status==="error"){return}l.push(o)});if(l.length>0){timeline_collection_view.addItems(l)}}},error:function(l){}});email_requests.push(j)}}})}},load_campaign_logs:function(b){var a="/core/api/campaigns/logs/contact/"+b+"?cursor=0&page_size=100";this.timline_fetch_data(a,function(d){if(!d||d.length==0){return}var c=[];$.each(d,function(f,e){if(e.log_type=="EMAIL_SENT"||e.log_type=="EMAIL_OPENED"||e.log_type=="EMAIL_CLICKED"||e.log_type=="SET_OWNER"||e.log_type=="SCORE"||e.log_type=="ADD_DEAL"||e.log_type=="TWEET"||e.log_type=="SMS_SENT"||e.log_type=="SMS_FAILED"||e.log_type=="SMS_LINK_CLICKED"||e.log_type=="EMAIL_REPLIED"){c.push(e)}});if(App_Contacts.contactDetailView.model.get("id")==b){timeline_collection_view.addItems(c)}})},timline_fetch_data:function(a,c){showTransitionBar();console.log(this.active_connections);++this.active_connections;var b=this;$.getJSON(a,function(d){console.log("success : "+b.active_connections);--b.active_connections;console.log("success : "+b.active_connections);if(c&&typeof c==="function"){c(d)}if(!b.active_connections){hideTransitionBar()}}).error(function(){--b.active_connections;if(!b.active_connections){hideTransitionBar()}})},getOpenedEmailsFromEmails:function(b){var a=[];$.each(b,function(d,c){if(c.email_opened_at&&c.email_opened_at!==0){var e={};e.createdTime=(c.email_opened_at)*1000;e.agile_email="agile_email";e.subject=c.subject;e.email_link_clicked_at=(c.email_link_clicked_at)*1000;e.trackerId=c.trackerId;a.push(e)}});return a},get_stats:function(b,a,c){var d=this;get_web_stats_count_for_domain(function(e){if(!(_agile_get_prefs("_agile_jsapi")!=null&&_agile_get_prefs("_agile_jsapi")=="true")&&(NO_WEB_STATS_SETUP&&e=="0")){$("#time-line",c).find(".loading-img-stats").remove();return}NO_WEB_STATS_SETUP=false;_agile_set_prefs("_agile_jsapi",true,500);var f=Backbone.Collection.extend({});d.timline_fetch_data("core/api/web-stats?e="+encodeURIComponent(b),function(j){d.statsCollection=new f(j);j=d.statsCollection;is_mails_fetched=true;is_logs_fetched=false;is_array_urls_fetched=false;$("#time-line",c).find(".loading-img-stats").remove();
if(j.toJSON()&&j.toJSON().length>0){var g=getPropertyValue(a.properties,"address");if(!g){var k={};if(j.toJSON()[0].city!=""){k.city=ucfirst(j.toJSON()[0].city);k.state=ucfirst(j.toJSON()[0].region);k.country=getCode(j.toJSON()[0].country);a.properties.push({name:"address",value:JSON.stringify(k)});var h=new Backbone.Model();h.url="core/api/contacts";h.save(a,{success:function(l){}})}}if(App_Contacts.contactDetailView.model.get("id")==a.id){timeline_collection_view.addItems(j.toJSON())}addTagAgile(CODE_SETUP_TAG)}})})}};