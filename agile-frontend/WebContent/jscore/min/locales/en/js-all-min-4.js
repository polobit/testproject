var Queue=(function(){function b(){}b.prototype.running=false;b.prototype.queue=[];b.prototype.running=false;b.prototype.add_function=function(e,d){var c=this;this.queue.push(function(){e(d)});if(!this.running){this.next()}return this};b.prototype.next=function(){var c=this.queue.shift();if(c){this.running=true;c()}};b.prototype.pop=function(){this.queue.pop()};return b})();$(function(){$("body").on("click","#tl-mail-popover",function(b){b.preventDefault();var c=$(this).closest("div").attr("data");$("#mail-in-detail").html("<div style='background:none;border:none;'>"+c+"</div>");$("#timelineMailModal").modal("show")});$("body").on("click","#tl-log-popover",function(c){c.preventDefault();var b=$(this).closest("div").attr("data");$("#log-in-detail").html("<div style='background:none;border:none;'>"+b+"</div>");$("#timelineLogModal").modal("show")});$("body").on("click","#tl-analytics-popover",function(c){c.preventDefault();var b=$(this).closest("div.body").html();var d=$(b).find("div.ellipsis-multi-line");$("#analytics-in-detail").html("<div'>"+$(d).html()+"</div>");$("#timelineAnalyticsModal").modal("show")});$("body").on("mouseenter","#tl-mail-to-popover",function(c){$(this).popover({template:'<div class="popover"><div class="arrow"></div><div class="popover-inner" style="padding:1px;width:340px;border-radius:2px"><div class="popover-content"><p></p></div></div></div>'});var b=$(this).text();$(this).attr("data-content",b);$(this).popover("show")});$("body").on("click","#timeline .item a.open-close",function(b){$(this).siblings(".body").slideToggle(function(){$("#timeline").isotope("reLayout")});$(this).parents(".post").toggleClass("closed");$("#expand-collapse-buttons a").removeClass("active");b.preventDefault()})});var monthArray=["January 31","February 28","March 31","April 30","May 31","June 30","July 31","August 31","September 30","October 31","November 30","December 31"];var MONTH_YEARS;function remove_loading_img(b){$("#time-line",b).find(".loading-img").remove()}function entity_created_month_year(b){if(b.entity_type=="event"&&b.start){return month_year=new Date(b.start*1000).getMonth()+"-"+new Date(b.start*1000).getFullYear()}if(b.created_time){return month_year=new Date(b.created_time*1000).getMonth()+"-"+new Date(b.created_time*1000).getFullYear()}if(b.createdTime){return month_year=new Date(b.createdTime).getMonth()+"-"+new Date(b.createdTime).getFullYear()}else{if(b.time){return month_year=new Date(b.time*1000).getMonth()+"-"+new Date(b.time*1000).getFullYear()}else{if(b.date_secs){return month_year=new Date(b.date_secs*1).getMonth()+"-"+new Date(b.date_secs*1).getFullYear()}}}}function getTimestamp(c,b){if((b%4)==0){monthArray[1]="February 29"}return Date.parse(monthArray[c]+", "+b)+86400000-1}var noAnimationBruteForce=true;var timeline_collection_view;var MONTH_YEARS;var month_years=[];var timeline_view=Backbone.View.extend({initialize:function(){_.bindAll(this,"render","appendItem","addItems");this.options.data=[];this.options.data.push(App_Contacts.contactDetailView.model.toJSON());console.log(App_Contacts.contactDetailView.model.toJSON().tagsWithTime);console.log(this.options.data);this.collection=new BaseCollection([],{});this.month_year_marker=[];this.month_year_marker_objects=[];configure_timeline_comparator(this.collection);this.collection.add(App_Contacts.contactDetailView.model.toJSON().tagsWithTime,{silent:true});this.collection.add(this.options.data,{silent:true});this.queue=new Queue;this.collection.bind("add",this.appendItem)},appendItem:function(c){if(c.get("entity_type")){if(c.get("entity_type")=="year-marker"){getTemplate("year-marker",c.toJSON(),"yes",function(e){$("#timeline",App_Contacts.contactDetailView.el).isotope("insert",$(e))});return}}this.collection.add(c,{silent:true});var b=[];b.push(c.toJSON());var d=getTemplate("timeline1",b,undefined,function(e){$("#timeline",App_Contacts.contactDetailView.el).isotope("insert",$(e))})},addItems:function(b){this.collection.add(b,{silent:true});this.buildTimlinePosts(b)},render:function(){this.buildTimlinePosts(this.collection.toJSON())},buildTimlinePosts:function(e){var d=e.length;if(!d){return}this.addToQueue(e);return;var c=0;while(c<d){var b=c+50;b=b>d?d:b;if(b==c){break}this.addToQueue(e.slice(c,b));c+=50}},addToQueue:function(b){this.queue.add_function(quedfunction,b)}});function quedfunction(c){var b;getTemplate("timeline1",c,undefined,function(d){$("#timeline",$(App_Contacts.contactDetailView.el)).isotope("insert",$(d),function(e){timeline_collection_view.queue.running=false;timeline_collection_view.queue.next()})})}function configure_timeline_comparator(b){b.comparator=function(f){var d=entity_created_month_year(f.toJSON());if(d){if(timeline_collection_view&&timeline_collection_view.month_year_marker.indexOf(d)==-1){timeline_collection_view.month_year_marker.push(d);var c=d.split("-");var g=getTimestamp(c[0],c[1])/1000;var e={year:monthArray[c[0]].split(" ")[0],timestamp:g,entity_type:"year-marker"};if(!b.where({year:monthArray[c[0]].split(" ")[0]})[0]){}b.add(e);console.log(e);timeline_collection_view.month_year_marker_objects.push(e)}}if(f.get("created_time")&&f.get("entity_type")!="event"){return f.get("created_time")}if(f.get("entity_type")=="event"){return f.get("start")}else{if(f.get("createdTime")){return f.get("createdTime")/1000}else{if(f.get("time")){return f.get("time")/1000}else{if(f.get("date_secs")){return f.get("date_secs")/1000}else{if(f.get("timestamp")){return g}}}}}return f.get("id")}}function initializeEmailTemplateAddListeners(){$("#prefs-tabs-content").on("click",".merge-field",function(c){c.preventDefault();var b=$(this).attr("name");var d=$("#email-template-html").val();var f=$("#email-template-html").data("wysihtml5");if(f){editor.focus();f.editor.composer.commands.exec("insertHTML","{{"+b+"}}")}});$("#prefs-tabs-content").on("click",".add-attachment-select",function(f){f.preventDefault();var d=$(this).closest("div");$(this).css("display","none");d.find(".attachment-document-select").css("display","inline");var b="<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}'>{{name}}</option>";fillSelect("attachment-select","core/api/documents","documents",function c(){d.find("#attachment-select option:first").after("<option value='new'>"+_agile_get_translated_val("others","upload-new-doc")+"</option>")},b,false,d);$("#enable_tracking").css("margin-top","-7px")});$("#prefs-tabs-content").on("click",".add-attachment-confirm",function(g){g.preventDefault();var d=$("#attachment-select").find(":selected").attr("network_type");var j=$("#attachment-select").find(":selected").attr("size");if(typeof d!=="undefined"&&d.toUpperCase()==="GOOGLE"){$(this).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>"+_agile_get_translated_val("documents","gd-error")+"</span>");$(this).css({border:"1px solid #df382c",outline:"none"})}else{if(j>=5242880){$(this).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>"+_agile_get_translated_val("documents","size-exceed-error")+"</span>");$(this).css({border:"1px solid #df382c",outline:"none"})}else{$("#attachment-select").closest("span").find(".attachment-status").find("span").fadeOut(0);$("#attachment-select").css({border:"1px solid #bbb"});var f=$(this).closest(".attachment-document-select").find("#attachment-select").val();var h=$(this);if(f==""){h.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>"+_agile_get_translated_val("validation-msgs","required")+"</span>");h.closest("span").find("span.save-status").find("span").fadeOut(5000);return}else{if(f=="new"){g.preventDefault();$(this).closest("form").find("#error").html("");var l=$(this).closest("form").attr("id");var c=$(this).find("a").attr("id");var k=window.open("upload-attachment.jsp?id="+l+"&t="+CURRENT_USER_PREFS.template+"&d="+CURRENT_DOMAIN_USER.domain,"name","height=310,width=500");if(window.focus){k.focus()}}else{if(f!=undefined&&f!=null){var b=$("#attachment-select option:selected").text();$("#emailForm").find("#eattachment").css("display","block");$("#emailForm").find("#attachment_id").find("#attachment_fname").text(b);$("#emailForm").find(".attachment-document-select").css("display","none");$("#emailForm").find("#eattachment_key").attr("name","document_key");$("#emailForm").find("#eattachment_key").attr("value",f)}}}}}$("#enable_tracking").css("margin-top","-47px")});$("#prefs-tabs-content").on("click",".add-attachment-cancel",function(f){f.preventDefault();var b=$("#emailForm").find("#attachment_id").attr("name");if(typeof b!==typeof undefined){if(b.toLowerCase()==="blob_key"){var c=$("#emailForm").find("#eattachment_key").attr("value");deleteBlob(c)}}$("#attachment-select").closest("span").find(".attachment-status").find("span").fadeOut(0);$("#attachment-select").css({border:"1px solid #bbb"});$("#attachment-select").find("option:first").attr("selected","selected");var d=$(this).closest("div");$("#emailForm").find(".attachment-document-select").css("display","none");$("#emailForm").find("#eattachment").css("display","none");$("#emailForm").find(".add-attachment-select").css("display","inline");$("#emailForm").find("#eattachment_key").attr("name","name");$("#emailForm").find("#eattachment_key").attr("value","value");$("#enable_tracking").css("margin-top","-7px")});$("#prefs-tabs-content").on("click",".add-tpl-attachment-confirm",function(b){b.preventDefault();if($(this).parent().find("select").val()=="new"){$("#uploadDocumentModal").modal("show");$("#GOOGLE",$("#uploadDocumentModal")).parent().hide()}else{if($(this).parent().find("select").val()!=""){$("#tpl-attachment-select").hide();$("#tpl-attachment-name").show();$("#attachment_id",$("#tpl-attachment-name")).val($(this).parent().find("select").val());$("#tpl_attachment_fname",$("#tpl-attachment-name")).html("<a href="+$(this).parent().find("option:selected").attr("url")+">"+$(this).parent().find("option:selected").text()+"</a>")
}else{if($(this).parent().find("select").val()==""){$("#attachment-select-required").show()}}}});$("#prefs-tabs-content").on("click",".add-tpl-attachment-cancel",function(b){b.preventDefault();$("#tpl-attachment-select").show();$("#tpl-attachment-name").hide();$(".add-attachment-select").show();$(".attachment-document-select").hide();$("#attachment_id",$("#tpl-attachment-name")).val("")});$("#prefs-tabs-content").on("change","#attachment-select",function(b){b.preventDefault();if($(this).val()==""){$("#attachment-select-required").show()}else{$("#attachment-select-required").hide()}});$("#uploadDocumentModal").on("hidden.bs.modal",function(b){$("#GOOGLE",$("#uploadDocumentModal")).parent().show()})}function setupHTMLEditor(b,c){head.js(LIB_PATH+"lib/wysihtml5-0.3.0-min.js",LIB_PATH+"lib/bootstrap-wysihtml5-min.js",function(){console.log("setting up text");console.log(b.html());if(!$(b).data("wysihtml5")){b.wysihtml5()}if(c){b.data("wysihtml5").editor.setValue(c,false)}})}var GLOBAL_MODAL_MESSAGES={global_delete:"Are you sure you want to delete?",global_error_title:"Error",global_validation_title:"Validation",global_error_message:"Error occured. Please try again"};var MODAL_MESSAGES={"delete":{title:"Delete",message:GLOBAL_MODAL_MESSAGES.global_delete},error:{title:"Error",message:"Error occured. Please Reload the page."},retry:{title:"Error",message:GLOBAL_MODAL_MESSAGES.global_error_message},delete_task:{title:"Delete Task",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_contact:{title:"Delete Contact",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_company:{title:"Delete Company",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_event:{title:_agile_get_translated_val("events","delete-event"),message:GLOBAL_MODAL_MESSAGES.global_delete},delete_opportunity:{title:"Delete Deal",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_custom_field:{title:"Delete Custom field",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_milestone:{title:"Delete Milestone",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_stream:{title:"Delete Stream",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_calendar_prefs:{title:"Delete Calendar Preferences",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_lost_reason:{title:"Delete Loss Reason",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_deal_source:{title:"Delete Deal Source",message:GLOBAL_MODAL_MESSAGES.global_delete},event_drop:{title:_agile_get_translated_val("events","update-event"),message:"Are you sure about this change?"},delete_user:{title:"Delete User",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_account:{title:"Delete Account",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_free_trial:{title:"Cancel Free Trial",message:"Are you sure you want to cancel your free trial?"},delete_subscription:{title:"Delete Subscription",message:"Are you sure you want to cancel this subscription ?"},delete_rule:{title:"Delete Rule",message:"Are you sure to delete a rule?"},delete_facebook_linked_page:{title:"Delete",message:"Are you sure you want to delete this Form from your Facebook page?"},delete_facebook_linked_page_error:{title:"Error",message:"To delete the Form from Page, Link your Facebook account which is associated to the Page."},delete_campaign_logs:{title:"Delete Campaign logs",message:"Are you sure you want to delete all logs?"},bulk_delete:{title:"Bulk Delete",message:GLOBAL_MODAL_MESSAGES.global_delete},delete_activity:{title:"Delete Activity",message:GLOBAL_MODAL_MESSAGES.global_delete},unlink_facebook:{title:"Unlink Facebook",message:"Are you sure you want to unlink your Facebook account ?"},regenerate_api_key:{title:"Regenerate API key",message:"Resetting the API Key will break all existing integrations you may have setup using the current key. Are you sure you want to reset the API key?"},delete_tweet:{title:"Delete Tweet",message:"Are you sure you want to delete this tweet?"},undow_retweet_status:{title:"Undow Retweet status",message:"Are you sure you want to undo retweet this status?"},activity_error:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:_agile_get_translated_val("category","name-error")},affiliate_error:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"User not registered with affiliate program."},user_deleted:{title:"Delete",message:"User Deleted"},download_error:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Error downloading a file!"},number_validation:{title:GLOBAL_MODAL_MESSAGES.global_validation_title,message:"Please enter a valid number."},freshbook_domain_error:{title:GLOBAL_MODAL_MESSAGES.global_validation_title,message:"Please Enter Domain Name only"},companies_merge_limit:{title:"Merge Companies",message:"Maximum of 2 companies can be merged at a time."},contacts_merge_limit:{title:"Merge Contacts",message:"you can merge maximum of 2 records at a time with master record."},empty_shop:{title:GLOBAL_MODAL_MESSAGES.global_validation_title,message:"Enter Shop name"},won_milestone_delete_error:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"â€˜Won' milestone cannot be changed now as the track already has deals."},lost_milestone_delete_error:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"'Lost' milestone cannot be changed now as the track already has deals."},multiple_conditions:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Sorry. You can't have multiple 'Between' conditions."},add_error:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Failed to add."},future_date:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Please select Date/Time in future."},select_plan:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Please select a plan to proceed"},change_plan:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Please change your plan to proceed"},social_access:{title:"Social Access",message:"You have to give access to your social account."},tag_name_restriction:{title:"Tag Validation",message:"Tag name should start with an alphabet and cannot contain special characters other than underscore and space."},on_call:{title:"Call",message:"Already on call."},appointment_time:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Please select appointment time."},slot_booking:{title:"Slot Booking",message:"Looks like this slot is booked already. Please try another one."},webrule_popup_limit:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Only one popup is allowed per webrule. You have already set a popup action for this webrule."},duplicate_widget:{title:"Duplicate Widget",message:"A widget with this name exists already. Please choose a different name"},no_twilio_numbers:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"You have no twilio numbers. Please buy or port a number in your Twilio account."},no_verified_num:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"You have no verified numbers. Please verify number in your Twilio account."},valid_details:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Please enter valid details."},valid_details_try_again:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Please try again with valid details."},active_connection:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"A connection is currently active."},enter_shop_name:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Enter Shop name"},name_not_valid:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Name not valid"},duplicate_workflow:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Please change the name and click on 'Create a Copy' again."},linkedin_invalid_url:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"URL provided for linkedin is not valid"},proper_amount:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"Please enter proper amount"},twitter_invalid_url:{title:GLOBAL_MODAL_MESSAGES.global_error_title,message:"URL provided for Twitter is not valid"},stripe_customfield_selection_error:{title:"Stripe Custom Field",message:"Please select one custom field to save the Stripe ID."}};var Document_Collection_Events=Base_Collection_View.extend({events:{'click #documents-model-list > tr > td:not(":first-child")':"onDocumentListSelect","click .documents-add":"onAddDocument",},onDocumentListSelect:function(b){if(b.target.parentElement.attributes[0].name!="href"&&b.target.parentElement.attributes[1].name!="href"){b.preventDefault();updateDocument($(b.currentTarget).closest("tr").data())}},onAddDocument:function(c){c.preventDefault();$("#uploadDocumentModal").html(getTemplate("upload-document-modal",{})).modal("show");var b=$("#uploadDocumentForm");agile_type_ahead("document_relates_to_contacts",b,contacts_typeahead);agile_type_ahead("document_relates_to_deals",b,deals_typeahead,false,null,null,"core/api/search/deals",false,true)},});var Document_Model_Events=Base_Model_View.extend({events:{"click #sort_menu > li":"documentsSort","click .documents-add":"onAddDocument",},documentsSort:function(d){d.preventDefault();var f=$(d.currentTarget);var c="",b=$("#sort_menu");if($(f).find("a").hasClass("sort-field")){b.find("li").not(f).find("a.sort-field i").addClass("display-none");$(f).find("a.sort-field i").removeClass("display-none")}else{b.find("li").not(f).find("a.order-by i").addClass("display-none");$(f).find("a.order-by i").removeClass("display-none")}c=b.find(".order-by i:not(.display-none)").closest(".order-by").attr("data");c+=b.find(".sort-field i:not(.display-none)").closest(".sort-field").attr("data");_agile_set_prefs("Documentssort_Key",c);this.model.set({sortKey:c})},onAddDocument:function(c){c.preventDefault();$("#uploadDocumentModal").html(getTemplate("upload-document-modal",{})).modal("show");var b=$("#uploadDocumentForm");agile_type_ahead("document_relates_to_contacts",b,contacts_typeahead);agile_type_ahead("document_relates_to_deals",b,deals_typeahead,false,null,null,"core/api/search/deals",false,true)},});$(function(){$("#uploadDocumentUpdateModal,#uploadDocumentModal").on("click",".link",function(c){c.preventDefault();
$(this).closest("form").find("#error").html("");var b=$(this).closest("form").attr("id");var f=$(this).find("a").attr("id");if(f&&f=="GOOGLE"){var d=window.open("upload-google-document.jsp?id="+b,"name","height=510,width=800")}else{if(f&&f=="S3"){var d=window.open("upload-custom-document.jsp?id="+b+"&t="+CURRENT_USER_PREFS.template+"&d="+CURRENT_DOMAIN_USER.domain,"name","height=310,width=500")}}if(window.focus){d.focus()}return false});$("#uploadDocumentUpdateModal,#uploadDocumentModal").on("click","#document_validate, #document_update_validate",function(f){f.preventDefault();var d=$(this).closest(".upload-document-modal").attr("id");var b=$(this).closest(".upload-document-modal").find("form").attr("id");var c=serializeForm(b);console.log(c);if(b=="uploadDocumentForm"){saveDocument(b,d,this,false,c)}else{saveDocument(b,d,this,true,c)}});$("#uploadDocumentModal").on("hidden.bs.modal",function(b){$("#GOOGLE",$("#uploadDocumentModal")).parent().show()})});function updateDocument(d){var c=d.toJSON();add_recent_view(new BaseModel(c));var b=$("#uploadDocumentUpdateModal");b.html(getTemplate("upload-document-update-modal",{}));b.modal("show");var e=$("#uploadDocumentUpdateForm");deserializeForm(c,$("#uploadDocumentUpdateForm"));$("#uploadDocumentUpdateForm").find("#"+c.network_type).closest(".link").find(".icon-ok").css("display","inline");$("#uploadDocumentUpdateForm").find("#"+c.network_type).closest(".link").css("background-color","#EDEDED");agile_type_ahead("document_relates_to_contacts",e,contacts_typeahead);agile_type_ahead("document_relates_to_deals",e,deals_typeahead,false,null,null,"core/api/search/deals",false,true)}function saveDocumentURL(c,d,f){f=f.split("?id=")[1];var b=f.split("&")[0];var e=c.split("?");if(c.match("agilecrm/panel/uploaded-logo/")){e=e[0];e=e.substring(e.lastIndexOf("/")+1)}else{e="Google"}$("#"+b).find("#extension").val(e);$("#"+b).find("#network_type").val(d);$("#"+b).find("#network_type").closest(".controls").find("div.link").css("background-color","#FFFFFF");$("#"+b).find("#network_type").closest(".controls").find(".icon-ok").css("display","none");$("#"+b).find("#"+d).closest(".link").find(".icon-ok").css("display","inline");$("#"+b).find("#"+d).closest(".link").css("background-color","#EDEDED");$("#"+b).find("#upload_url").val(c);$("#"+b).find("#size").val(CUSTOM_DOCUMENT_SIZE)}function saveDocument(b,j,h,g,e,f){if($(h).attr("disabled")){return}disable_save_button($(h));if(b){if(!isValidForm("#"+b)){enable_save_button($(h));return false}var c=$("#"+b).find("#upload_url").val();if(c==""){$("#"+b).find("#network_type").closest(".controls").find(".icon-ok").css("display","none");$("#"+b).find("#network_type").closest(".controls").find("div.link").css("background-color","#FFFFFF");$("#"+b).find("#error").html('<div class="alert alert-danger col-sm-offset-3 col-sm-7">Sorry! Document not attached properly.</div>');enable_save_button($(h));return}}var d=new Backbone.Model();d.url="core/api/documents";d.save(e,{success:function(l){CUSTOM_DOCUMENT_SIZE=0;enable_save_button($(h));if(b){$("#"+b).find("#network_type").val("");$("#"+b).find("#network_type").closest(".controls").find(".icon-ok").css("display","none");$("#"+b).find("#network_type").closest(".controls").find("div.link").css("background-color","#FFFFFF");$("#"+b).find("#upload_url").val("");$("#"+b).find("#extension").val("");$("#"+b).each(function(){this.reset()})}if(b){$("#"+j).modal("hide")}var k=l.toJSON();add_recent_view(new BaseModel(k));if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){$.each(k.contacts,function(n,m){if(m.id==App_Contacts.contactDetailView.model.get("id")){if(documentsView&&documentsView.collection){if(documentsView.collection.get(k.id)){documentsView.collection.get(k.id).set(new BaseModel(k))}else{documentsView.collection.add(new BaseModel(k),{sort:false});documentsView.collection.sort()}}return false}})}else{if(company_util.isCompany()){company_util.updateDocumentsList(k,true)}else{if(Current_Route=="documents"){if(g){App_Documents.DocumentCollectionView.collection.remove(e)}App_Documents.DocumentCollectionView.collection.add(l);App_Documents.DocumentCollectionView.render(true)}else{if(App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.id){$.each(k.deals,function(m,n){if(n.id==App_Deal_Details.dealDetailView.model.id){if(dealDocsView&&dealDocsView.collection){if(dealDocsView.collection.get(k.id)){dealDocsView.collection.get(k.id).set(new BaseModel(k))}else{dealDocsView.collection.add(new BaseModel(k),{sort:false});dealDocsView.collection.sort()}}return false}})}else{if(Current_Route=="email-template-add"||Current_Route.indexOf("email-template")==0||Current_Route.indexOf("emailbuilder")==0){$("#tpl-attachment-select").find("select").find("option:last").after("<option value="+k.id+" selected='selected'>"+k.name+"</option>");$(".add-tpl-attachment-confirm").trigger("click");App_Settings.navigate(Current_Route,{trigger:true})}else{App_Documents.navigate("documents",{trigger:true})}}}}}},error:function(l,k){if(!j){hideTransitionBar();enable_save_button($(h));if(!j&&e&&e.contact_ids){e.contact_ids.splice(e.contact_ids.indexOf(f),1)}if(!j&&e&&e.deal_ids&&App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.id){e.deal_ids.splice(e.deal_ids.indexOf(App_Deal_Details.dealDetailView.model.id),1)}var m=h.parent().find(".save-status");m.html("<i style='color:#B94A48;'>"+Handlebars.compile("{{name}}")({name:k.responseText})+"</i>");setTimeout(function(){m.html("")},2000);return}enable_save_button($(h));var m=$(".save-status",$("#"+j));m.html("<i style='color:#B94A48;'>"+Handlebars.compile("{{name}}")({name:k.responseText})+"</i>");setTimeout(function(){m.html("")},2000)}})}function saveAttachmentBlobKey(b,d){var c=$("#uploadAttachmentForm");$("#uploadAttachmentModal").modal("hide");$("#emailForm").find("#eattachment").css("display","block");$("#emailForm").find("#attachment_id").find("#attachment_fname").text(d);$("#emailForm").find("#eattachment_key").attr("value",b);$("#emailForm").find("#eattachment_key").attr("name","blob_key");$("#emailForm").find("#attachment-select").find("option:first").attr("selected","selected");var c=$("#emailForm").find(".attachment-document-select");$("#emailForm").find(".attachment-document-select").css("display","none");$("#emailForm").find("#agile_attachment_name").val(d)}function documentsCollection(b){App_Documents.DocumentCollectionView=new Document_Collection_Events({url:"core/api/documents",sort_collection:false,templateKey:"documents",cursor:true,page_size:20,individual_tag_name:"tr",order_by:b,postRenderCallback:function(d){includeTimeAgo(d);updateSortKeyTemplate(b,d);$("#documents_collection").html(c);$(".active").removeClass("active");$("#documentsmenu").addClass("active")},appendItemCallback:function(d){includeTimeAgo(d)}});App_Documents.DocumentCollectionView.collection.fetch();var c=App_Documents.DocumentCollectionView.render().el}function checkForAffiliateDetails(c,b){if(AFFILIATE_DETAILS){c();return}$.ajax({url:"core/api/affiliate_details",type:"GET",success:function(d){if(d&&d.id){AFFILIATE_DETAILS=d;c()}else{b()}}})}function getTimeFromDatePicker(){var c=$("#range").html().split("-");var f=getUTCMidNightEpochFromDate(new Date(c[0]));var j=new Date();f=f+(j.getTimezoneOffset()*60*1000);f=f/1000;var h=$.trim(c[1]);if(h){h=h+" 23:59:59"}var b=$("#status").find("option:selected").val();var e=getUTCMidNightEpochFromDate(new Date(h));e+=(((23*60*60)+(59*60)+59)*1000);e=e+(j.getTimezoneOffset()*60*1000);e=e/1000;var g={start:f,end:e};return g}function showCommission(b,d,c){getCommission(CURRENT_DOMAIN_USER.id,d,function(e){$("#aff-count",c).html(e.count);$("#aff-commission",c).html((e.commission/100).toFixed(2))})}function getCommission(c,d,e){var b="core/api/affiliate/total?startTime="+d.start+"&endTime="+d.end;if(c){b=b+"&userId="+c}$.ajax({url:b,type:"GET",success:function(f){if(e&&typeof(e=="function")){e(f)}}})}var ACCOUNT_STATS;function set_up_account_stats(c,d){var b=new Base_Model_View({url:"core/api/namespace-stats",template:"account-stats",postRenderCallback:function(e){ACCOUNT_STATS=b.model.toJSON();if(d&&typeof(d)==="function"){d(ACCOUNT_STATS)}}});$("#account-stats",c).html(b.render(true).el)}$(function(){$("#warning-deletion-feedback #confirm-delete-account").off("click");$("#warning-deletion-feedback").on("click","#confirm-delete-account",function(b){b.preventDefault();$(".modal-body").html(getRandomLoadingImg());$.ajax({type:"DELETE",url:"core/api/delete/account",success:function(){add_account_canceled_info(ACCOUNT_DELETE_REASON_JSON,function(c){$("#warning-deletion-feedback").modal("hide");$("#content").html(getRandomLoadingImg());window.location.href=window.location.href.split("#")[0]+"login"})}})});$("#content #cancel-account").off("click");$("#content").on("click","#cancel-account",function(b){b.preventDefault();$("#warning-deletion-feedback").html(getTemplate("warning-feedback",{})).modal("show")});$("#content #cancel-account-request").off("click");$("#content").on("click","#cancel-account-request",function(b){b.preventDefault();load_clickdesk_code();$("#send-cancellation").html(getTemplate("cancel-subscription-request",{date:$(this).attr("data")})).modal("show")});$("#send-cancellation #cancel-account-request-proceed").off("click");$("#send-cancellation").on("click","#cancel-account-request-proceed",function(b){b.preventDefault();getTemplate("send-cancellation-request",{},undefined,function(c){if(!c){return}$("#send-cancellation .modal-dialog").html($(c))},null)});$("#send-cancellation #account_cancel_chat_btn").off("click");$("#send-cancellation").on("click","#account_cancel_chat_btn",function(b){b.preventDefault();$(this).closest(".modal").modal("hide");CLICKDESK_LIVECHAT.show();cancellationFeatureUsedMail("Chat")});$("#send-cancellation #account_cancel_support_btn").off("click");$("#send-cancellation").on("click","#account_cancel_support_btn",function(b){cancellationFeatureUsedMail("Schedule a Demo")
});$("#send-cancellation #account_pause_btn").off("click");$("#send-cancellation").on("click","#account_pause_btn",function(b){b.preventDefault();var c=$("#pause_count").html();$.ajax({url:"core/api/subscription/pauseOrResumeSubscriptions?period="+c,type:"POST",success:function(){cancellationFeatureUsedMail("Account Pause");location.reload(true)},error:function(d){showNotyPopUp("warning",d.responseText,"top")}})});$("#send-cancellation #add").off("click");$("#send-cancellation").on("click","#add",function(c){c.preventDefault();var b=$("#pause_count").html();if(b<3){b++}$("#pause_count").html(b);if(b>1){$("#send-cancellation #month_id").html("months")}});$("#send-cancellation #minus").off("click");$("#send-cancellation").on("click","#minus",function(c){c.preventDefault();var b=$("#pause_count").html();if(b>1){b--}$("#send-cancellation #pause_count").html(b);if(b==1){$("#send-cancellation #month_id").html("month")}});$("body").on("click","#account_resume",function(b){b.preventDefault();$(this).attr("disabled","disabled").text("Resuming");$that=$(this);$.ajax({url:"core/api/subscription/pauseOrResumeSubscriptions?period=0",type:"POST",success:function(){showNotyPopUp("information","Welcome back! We are resuming services for your account, please wait for few seconds while we re-activate it.","top",30000);setTimeout(function(){window.location.reload(true)},30000)},error:function(c){$that.text("Resume").removeAttr("disabled");showNotyPopUp("warning",c.responseText,"top")}})})});$("#send-cancellation").on("click","#send-delete-request",function(j){j.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm($("#cancelation-request-form"))){return}disable_send_button($(this));var d=serializeForm("cancelation-request-form");var h={};h.reason_type=d.account_cancel_reason;var g=$("#account_cancel_reason").val();if(g=="Other"){h.reason=d.other_cancel_reason}h.likes_in_agile=d.agile_pros;h.advices=d.advices;var f=getTemplate("cancellation-description",h);var c="Cancellation Request";if(g=="Out of Business"){c=c+" (Subscription Cancelled)"}var b="core/api/emails/send-email?from="+encodeURIComponent(CURRENT_DOMAIN_USER.email)+"&to="+encodeURIComponent("care@agilecrm.com")+"&subject="+encodeURIComponent(c)+"&body="+encodeURIComponent(f);$.post(b,function(){$("#cancelation-request-form").each(function(){this.reset()});enable_send_button($("#send-delete-request"));$("#send-cancellation").modal("hide");add_tag_our_domain("Cancellation Request");var e={};e.subject="Cancellation Request";e.description=f;agile_addNote(e,"",CURRENT_DOMAIN_USER.email);if(g=="Out of Business"){$.ajax({url:"core/api/subscription/cancel/subscription",type:"GET",success:function(k){showNotyPopUp("information","Your subscription has been cancelled successfully.","top")}})}else{showNotyPopUp("information","Your cancellation request has been sent successfully.","top")}})});$("#send-cancellation").on("change","#account_cancel_reason",function(b){$("#other_cancel_reason").text("").removeClass("required");if($(this).val()=="Other"){$("#other_cancel_container").show();$("#other_cancel_reason").addClass("required")}else{$("#other_cancel_container").hide()}if($(this).val()=="Out of Business"){$("#send-delete-request").text("Cancel Subscription");$("#cancel_info_msg").show()}else{$("#send-delete-request").text("Send Request");$("#cancel_info_msg").hide()}});$("#warning-deletion-feedback").on("click","#warning-feedback-save",function(f){f.preventDefault();var d=$("#cancelation-feedback-form");if(!isValidForm(d)){return}var c=$("input[name=cancellation_reason]:checked");ACCOUNT_DELETE_REASON_JSON={};ACCOUNT_DELETE_REASON_JSON.reason=$(c).val();ACCOUNT_DELETE_REASON_JSON.reason_info=$("#account_delete_reason").val();$(".modal-body").html(getRandomLoadingImg());var b="";if(ACCOUNT_STATS){getTemplate("warning",ACCOUNT_STATS,undefined,function(e){if(!e){return}b=$(e)},null)}else{set_up_account_stats($("#warning-deletion-feedback"),function(e){getTemplate("warning",e,undefined,function(g){if(!g){return}b=$(g);$(".modal-body").css("padding",0).html($(".modal-body",$(b)));$(".modal-footer").html($(".modal-footer",$(b)).html())},null)});return}$(".modal-body").css("padding",0).html($(".modal-body",$(b)));$(".modal-footer").html($(".modal-footer",$(b)).html())});$("#warning-deletion-feedback").on("hidden.bs.modal",function(){ACCOUNT_DELETE_REASON_JSON=undefined});function cancellationFeatureUsedMail(c){if(!c){return}var b={};b.from=CURRENT_DOMAIN_USER.email;b.to="venkat@agilecrm.com";b.cc="mogulla@agilecrm.com";b.bcc="raja@agilecrm.com";b.subject="Cancellation Process Feature Used";b.body="Username: "+CURRENT_DOMAIN_USER.email+"<br>Domain: "+CURRENT_DOMAIN_USER.domain+"<br>Feature Used: "+c;sendEmail(b)}function getSubscription(f,e){if(!e){return null}if(!f){return null}if(typeof f!="object"){f=JSON.parse(f)}var g=f.subscriptions;if(!g){if(!f.subscription){return null}else{return f.subscription}return null}var c=false;if(e.subscription_id){c=true}for(var b=0;b<g.data.length;b++){var d=g.data[b];if(c){if(d.id!=e.subscription_id){continue}return d}else{if(d.plan.id==e.plan_id){return d}}}return null}function getSubscriptionWithAmount(f,e){var c=getSubscription(f,e);if(!c){return null}if(!c.plan){return c}var b=c.plan.amount/100;var d=c.quantity;c.total=b*d;return c}function getActiveCard(b){if(!b){return null}if(typeof b!="object"){b=JSON.parse(b)}return b.cards.data[0]}var plan_json={};var email_json={};var PLAN_DETAILS={getPlanPrice:function(b){return PLANS_COSTS_JSON[b]},getDiscountedPrice:function(c,b){var d=this.getPlanPrice(c);var e=PLANS_DISCOUNTS_JSON_NEW[c][b];return d*(100-e)/100},getDiscount:function(c,b){return PLANS_DISCOUNTS_JSON_NEW[c][b]}};var user_existing_plan_name="";var USER_CREDIRCARD_DETAILS={};var USER_BILLING_PREFS;var USER_DETAILS={getCurrentPlanName:function(b){if(b.plan.plan_type=="FREE"){return"free"}return b.plan.plan_type},getDomainName:function(b){if(b.plan.plan_type=="FREE"){return"free"}return b.domain_name},getCurrentPlanId:function(b){if(b.plan.plan_type=="FREE"){return"free"}return b.plan.plan_id},getPlanType:function(b){if(b.plan.plan_type=="FREE"){return"free"}if(b.plan.plan_type){if(b.plan.plan_type.split("_").length==1){return b.plan.plan_type}return b.plan.plan_type.split("_")[0]}return"LITE"},getPlanInterval:function(b){if(!b||!b.plan.plan_type||b.plan.plan_type=="FREE"){return"MONTHLY"}var c=b.plan.plan_type;if(c){return c.split("_")[1]}},getQuantity:function(b){if(!b||!b.plan||b.plan.plan_type=="FREE"){return 2}return b.plan.quantity},getPlanTypeByStripe:function(b){var c=JSON.parse(b.billingData);if(!c.subscription){return"free"}if(c.subscription.plan.name){if(c.subscription.plan.name.toUpperCase().replace(/\s/g,"").split("-").length==1){return c.subscription.plan.name.toUpperCase().replace(/\s/g,"").replace("-","_")}return c.subscription.plan.name.toUpperCase().replace(/\s/g,"").split("-")[0]}return"LITE"},getPlanIntervalByStripe:function(b){if(!b){return"MONTHLY"}var d=JSON.parse(b.billingData);if(!d.subscription||!d.subscription.plan.name){return"MONTHLY"}var c=d.subscription.plan.name;if(c){return d.subscription.plan.name.toUpperCase().replace(/\s/g,"").split("-")[1]}}};function load_slider(b){$("#users_select_slider",b).slider({from:1,to:20,step:1,skin:"plastic",onstatechange:function(c){$("#users_quantity",b).text(c);price=update_price();$("#users_total_cost",b).text((c*price).toFixed(2))}})}function setCost(b){return $("#users_total_cost").text(($("#users_quantity").text()*b).toFixed(2))}function update_price(){var b=$("#plan_type").val();if(_billing_restriction.currentLimits.planName=="FREE"){if(b=="starter"){$("#purchase-plan").text("Proceed to Pay")}else{if(IS_TRIAL&&IS_ALLOWED_TRIAL){$("#purchase-plan").text("Proceed to Trial")}else{$("#purchase-plan").text("Proceed to Pay")}}}else{$("#purchase-plan").text("Proceed to Pay")}return $("#"+b+"_plan_price").text()}function setPriceTemplete(c,d){var b="yearly",e="pro",f=1;if(c!="free"&&c!="super"){e=USER_DETAILS.getPlanType(USER_BILLING_PREFS);b=USER_DETAILS.getPlanInterval(USER_BILLING_PREFS);f=USER_DETAILS.getQuantity(USER_BILLING_PREFS);e=e.toLowerCase();b=b.toLowerCase()}if(IS_NEW_USER&&_plan_on_signup){f=_plan_on_signup.quantity}$(d).find("#"+e+"_plan_select").attr("checked","checked");$(d).find("."+b).addClass("plan-select");$(d).find("#users_select_slider").val(f);$(d).find("#billing_cycle").val(b);return d}function setPlan(d){try{var c="yearly",f="regular";if(IS_NEW_USER&&_plan_on_signup){f=_plan_on_signup.plan_type.toLowerCase();c="yearly"}else{if(d!="free"&&d!="super"){var b=getSubscription(d.billingData,d.plan);if(b||CURRENT_DOMAIN_USER.domain=="admin"){f=USER_DETAILS.getPlanTypeByStripe(USER_BILLING_PREFS);c=USER_DETAILS.getPlanIntervalByStripe(USER_BILLING_PREFS);f=f.toLowerCase();c=c.toLowerCase()}else{c="yearly";f="free"}}}$("#plan_type").val(f).trigger("change");$("#billing_cycle").val(c).trigger("change")}catch(e){console.log(e)}}function initializeSubscriptionListeners(){$("#subscribe_plan_change").off("click");$("#subscribe_plan_change").on("click",".plan-collection-in",function(d){$(this).find("[name='pro_vs_lite']").attr("checked","checked");var b="";$(".plan-collection-in").each(function(e,g){b=$(g).find("#plan_name").text().toLowerCase();$(g).find("span.plan-collection-icon").removeClass(b+"_selected")});b=$(this).find("#plan_name").text().toLowerCase();$(this).find("span.plan-collection-icon").addClass(b+"_selected");var c=$(this).find("[name='pro_vs_lite']").val();removeStyleForAPlan();var f=$(this).parent();addStyleForAPlan(f,null);$("#plan_type").val(f.attr("id").split("_")[0]);setCost(update_price())});$("#subscribe_plan_change #plans-panel").off("click").on("click","ul.tagsli a",function(g){g.preventDefault();$("ul.tagsli a").removeClass("plan-select");$(this).addClass("plan-select");var f=$(this).attr("class");f=f.replace("plan-select","");f=f.trim();for(var c in PLANS_COSTS_JSON){var b=PLANS_COSTS_JSON[c];var h=PLAN_DETAILS.getDiscount(c,f);
var d=b-((h/100)*b);$("#"+c+"_plan_price").html(d.toFixed(2))}setCost(update_price())});$("#subscribe_plan_change").on("change","#billing_cycle",function(j){j.preventDefault();var h=$(this).val();for(var c in PLANS_COSTS_JSON){var b=PLANS_COSTS_JSON[c];var k=PLAN_DETAILS.getDiscount(c,h);var d=b-((k/100)*b);$("#"+c+"_plan_price").html(d.toFixed(2))}var f=update_price();if(!f){return}var g=$("#user_quantity").val();$("#users_quantity").text(g);$("#users_total_cost").text((g*f).toFixed(2))});$("#subscribe_plan_change").on("change","#user_quantity",function(d){d.preventDefault();var b=$(this).val();price=update_price();$("#users_quantity").text(b);$("#users_total_cost").text((b*price).toFixed(2));var c=$("#user_quantity").val();(c&&c>1)?$("#users_quantity_text").text("users"):$("#users_quantity_text").text("user")});$("#subscribe_plan_change").on("change","#plan_type",function(c){var b=$(this).val();$("#"+b+"_plan > .plan-collection-in").click();if($(this).val()=="free"){$("#plans-panel .plan-collection-bot").css("opacity","0.5");setCost(update_price())}});$("#subscribe_plan_change").on("click","#purchase-email-plan",function(f){if(!email_validation($("#email-plan-form"))){f.preventDefault()}var g=$("#email-quantity").val();var b=$("#emails_total_cost").text();var d=$("#email_rate").text();var c=new Date();email_json.billingData=App_Subscription.subscribe_plan.model.toJSON()["billingData"];email_json.emailRate=d;email_json.emailCost=b;email_json.quantity=g});$("#subscribe_plan_change").on("click","#purchase-plan",function(t){t.preventDefault();if(!CURRENT_DOMAIN_USER.is_admin&&USER_BILLING_PREFS.billingData){showNotyPopUp("warning","Sorry. Only users with admin privileges can change the plan. Please contact your administrator for further assistance.","top");return}plan_json={};var b=$(this).html();$(this).text("Loading...");$(this).attr("disabled","disabled");var m=$("#user_quantity").val();var s=$("#users_total_cost").text();var d=$("#credit_amount").text();if(d==""){d=0}var g=$("#plan_type").val();if("pro"==g){g="enterprise"}var f="",n="";var h=$("#billing_cycle").val();if(!g||g=="free"){showAlertModal("select_plan");$(this).text(b).removeAttr("disabled");return false}if(h=="monthly"){cycle="Monthly";n=1;f=PLAN_DETAILS.getDiscount(g,"monthly")}else{if(h=="yearly"){cycle="Yearly";n=12;f=PLAN_DETAILS.getDiscount(g,"yearly")}else{if(h=="biennial"){cycle="biennial";n=24;f=PLAN_DETAILS.getDiscount(g,"biennial")}}}var r=[];var j=PLANS_COSTS_JSON[g];for(var u in PLANS_DISCOUNTS_JSON_NEW[g]){var c=PLAN_DETAILS.getDiscount(g,u);var q=PLAN_DETAILS.getDiscountedPrice(g,u);r[u]=q.toFixed(2)}user_existing_plan_name=USER_DETAILS.getCurrentPlanId(USER_BILLING_PREFS);var v=j+"-"+n;if(v.toLowerCase()+"-"+m==user_existing_plan_name+"-"+USER_DETAILS.getQuantity(USER_BILLING_PREFS)){showAlertModal("change_plan");$(this).text(b).removeAttr("disabled");return false}var o=new Date();if(_billing_restriction.currentLimits.planName=="FREE"){if(plan_name=="starter"){plan_json.date=o.setMonth(o.getMonth()+n)/1000}else{if(IS_TRIAL&&IS_ALLOWED_TRIAL){plan_json.date=o.setHours(o.getHours()+168)}else{plan_json.date=o.setMonth(o.getMonth()+n)/1000}}}else{plan_json.date=o.setMonth(o.getMonth()+n)/1000}plan_json.new_signup=is_new_signup_payment();plan_json.price=update_price();plan_json.cost=(s*n).toFixed(2);if(d>0){plan_json.costWithCredit=plan_json.cost;plan_json.credit=d;plan_json.cost=(plan_json.cost-d).toFixed(2)}plan_json.months=n;plan_json.plan=g;plan_json.plan_type=g.toUpperCase()+"_"+cycle.toUpperCase();plan_json.cycle=cycle;plan_json.billingData=App_Subscription.subscribe_plan.model.toJSON()["billingData"];delete plan_json.coupon_code;var k=$("#coupon_code").val();if(k){plan_json.coupon_code=k}if(cycle!="biennial"){plan_json.yearly_discount=([s*12]-[r.yearly*m*12]).toFixed(2);plan_json.bi_yearly_discount=([s*24]-[r.biennial*m*24]).toFixed(2)}if((USER_DETAILS.getPlanType(USER_BILLING_PREFS)+"-"+USER_DETAILS.getQuantity(USER_BILLING_PREFS)+"-"+USER_DETAILS.getPlanInterval(USER_BILLING_PREFS))==(g.toUpperCase()+"-"+m+"-"+cycle.toUpperCase())){showAlertModal("change_plan");$(this).text(b).removeAttr("disabled");return false}var p=(n>1)?PLANS_COSTS_JSON[g]+"-"+n:PLANS_COSTS_JSON[g];plan_json.plan_id=p;plan_json.discount=f;plan_json.quantity=m;plan_json.current_plan=USER_DETAILS.getCurrentPlanName(USER_BILLING_PREFS);plan_json.domain_name=USER_DETAILS.getDomainName(USER_BILLING_PREFS);if(IS_TRIAL){plan_json.trialStatus="apply"}if(!$.isEmptyObject(USER_CREDIRCARD_DETAILS)){plan_json.customer=JSON.parse(USER_CREDIRCARD_DETAILS)}var l=this;$.ajax({url:"/core/api/subscription/planRestrictions",type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(plan_json),success:function(x){var e=0;$(l).text(b).removeAttr("disabled");x.plan=g.substr(0,1).toUpperCase()+g.substr(1);if(x.is_more_users){e++;x.newCount=m;x.errorsCount=e;getTemplate("subscribe-error-modal",x,undefined,function(y){if(!y){return}$(y).modal("show")},null);return}else{if(x.is_allowed_plan){Backbone.history.navigate("purchase-plan",{trigger:true})}else{if(x.lines){$.each(JSON.parse(USER_BILLING_PREFS.billingData).subscriptions.data,function(y,z){if(z.plan.id.indexOf("email")==-1){if((s*n).toFixed(2)>z.quantity*(z.plan.amount/100)){plan_json.unUsedCost=x.lines.data[0].amount*(-1)/100;plan_json.remainingCost=x.lines.data[1].amount/100;plan_json.cost=(plan_json.remainingCost-plan_json.unUsedCost-d).toFixed(2)}else{plan_json.unUsedCost=undefined;plan_json.remainingCost=undefined}}})}else{var w=x.restrictions;w.plan=x.plan;if(w.contacts.count>w.contacts.limit){e++}if(w.webrules.count>w.webrules.limit){e++}if(w.users.count>w.users.limit){e++}if(w.workflows.count>w.workflows.limit){e++}if(w.triggers.count>w.triggers.limit){e++}if(e>=1){w.errorsCount=e;getTemplate("subscribe-error-modal",w,undefined,function(y){if(!y){return}$(y).modal("show")},null);return}}}}plan_json.date=x.nextPaymentAttempt;if(n==24){plan_json.date=plan_json.date+31557600}Backbone.history.navigate("purchase-plan",{trigger:true})},error:function(e){showNotyPopUp("warning",e.responseText,"top");$(l).text(b).removeAttr("disabled")}})});$("#subscribe_plan_change").on("click","#check_valid_coupon",function(f){var d=$("#coupon_code").val();if(!d){$("#coupon_code_container").find(".error").html("Invalid Coupon");return false}$("#coupon_code_container i").removeAttr("class");var b="icon-",c=$(this);checkValidCoupon(d,function(e){b+=(e)?"ok":"remove";$("#coupon_code_container i").removeAttr("class").addClass(b)})});$("#subscribe_plan_change").on("keyup","#email-quantity",function(c){var b=$(this).val();if(isNaN(b)){return}var d=b*1000;if(IS_HAVING_MANDRILL){if(d<5000){$("#emails_total_cost").html(b*0);$("#email_rate").html("$2")}else{$("#emails_total_cost").html(b*2);$("#email_rate").html("$2")}}else{if(d<5000){$("#emails_total_cost").html(b*0);$("#email_rate").html("$3")}else{if(d<100000){$("#emails_total_cost").html(b*3);$("#email_rate").html("$3")}else{if(d<1000000){$("#emails_total_cost").html((b*2.5).toFixed(2));$("#email_rate").html("$2.50")}else{if(d>=1000000){$("#emails_total_cost").html((b*1.5).toFixed(2));$("#email_rate").html("$1.50")}}}}}email_validation($("#email-plan-form"));jQuery.validator.addMethod("email_plan_minimum",function(f,e){if(this.optional(e)){return true}return parseInt(f)>=5}," Should purchase a minimum of 5000 emails.")});$("#subscribe_plan_change").on("click","#cancel_free_trial",function(b){b.preventDefault();showAlertModal("delete_free_trial","confirm",function(){$.ajax({url:"core/api/subscription/cancel/trial",type:"GET",success:function(c){if(c&&JSON.parse(c).is_success){add_tag_our_domain("Cancelled Trial");document.location.reload()}else{if(c){getTemplate("trial-error-modal",JSON.parse(c),undefined,function(d){if(!d){return}$(d).modal("show")},null)}}},error:function(){alert("Error occured, Please try again")}})})});$("#subscribe_plan_change").on("mouseenter",".show_limits",function(b){b.preventDefault();$(this).closest(".plan-collection-in").find(".plan_features").css("display","block")});$("#subscribe_plan_change").on("mouseleave",".show_limits",function(b){b.preventDefault();$(this).closest(".plan-collection-in").find(".plan_features").css("display","none")});$("#subscribe_plan_change").on("click","#cancel_email_plan",function(b){b.preventDefault();getTemplate("cancel-email-conformation-modal",{},undefined,function(c){if(!c){return}$(c).modal("show")},null)});$("#cancel_email_plan_conform").off("click");$("body").on("click","#cancel_email_plan_conform",function(b){b.preventDefault();$.ajax({url:"core/api/subscription/cancel/email",type:"GET",success:function(c){showNotyPopUp("information","Email subscription has been cancelled successfully.","top");setTimeout(function(){document.location.reload()},1000)},error:function(){showAlertModal("retry")}})});$("#purchase_credits").off("click");$("#email-content").on("click","#purchase_credits",function(b){b.preventDefault();getTemplate("purchase-credits-info-modal",{},undefined,function(c){if(!c){return}$("#purchase-credits-info-modal").html($(c)).modal("show")},null)});$("#purchase-credits-info-modal").on("keyup","#email_credits_count",function(c){var b=$(this).val();if(b==""){$("#total_credits_cost").html(b*10);return}if(isNaN(b)||b<0){return}$("#total_credits_cost").html(b*4)})}function is_new_signup_payment(){return IS_NEW_USER&&_plan_on_signup}function email_validation(b){$(b).validate({rules:{atleastThreeMonths:true,multipleEmails:true,email:true,phone:true},debug:true,errorElement:"span",errorClass:"help-inline",highlight:function(d,c){$(d).closest("#email_validation_container").addClass("single-error")},unhighlight:function(d,c){$(d).closest("#email_validation_container").removeClass("single-error")},errorPlacement:function(c,d){console.log(c);console.log($(d).closest("#email_validation_container").length);try{if($(d).closest("#email_validation_container").length){c.insertAfter($(d).closest("#email_validation_container"))
}else{c.insertAfter($(d).closest(d))}}catch(e){console.log(e)}}});return $(b).valid()}function emailClickEvent(){$("ul.nav.nav-tabs").removeClass("hide");$("#email").addClass("hide");$("#currentPlan").addClass("p-t-md");$("#usertab").removeClass("active");$("#emailtab").addClass("active");$("#users-content").removeClass("active");$("#email-content").addClass("active")}$(function(){$("#purchase_credits_conform").off("click");$("#purchase-credits-info-modal").on("click","#purchase_credits_conform",function(d){d.preventDefault();var b=$("#purchaseCreditsForm");if(!isValidForm(b)){return}$(this).attr("disabled","disabled").html("Processing...");var c=b.find("#email_credits_count").val();$.ajax({url:"core/api/subscription/purchaseEmailCredits?quantity="+c,type:"POST",success:function(e){b.closest(".modal").modal("hide");showNotyPopUp("information","Email credits have been added successfully.","top");setTimeout(function(){document.location.reload()},1000)},error:function(e){b.closest(".modal").modal("hide");showNotyPopUp("warning",e.responseText,"top")}})})});function addAsAffiliate(b){$.ajax({type:"POST",url:"/core/api/affiliate?am="+b,contentType:"application/json; charset=utf-8",dataType:"json",success:function(c){},error:function(){}})}var plan_json=[];var INTERVALS=["monthly","yearly","biennial"];var PLANS_COSTS_JSON={};PLANS_COSTS_JSON.starter="14.99";PLANS_COSTS_JSON.regular="49.99";PLANS_COSTS_JSON.pro="79.99";PLANS_COSTS_JSON.enterprise="79.99";var PLANS_DISCOUNTS_JSON={};PLANS_DISCOUNTS_JSON.monthly="0";PLANS_DISCOUNTS_JSON.yearly="20";PLANS_DISCOUNTS_JSON.biennial="40";var PLANS_DISCOUNTS_JSON_NEW={};PLANS_DISCOUNTS_JSON_NEW.starter={};PLANS_DISCOUNTS_JSON_NEW.starter.monthly="0";PLANS_DISCOUNTS_JSON_NEW.starter.yearly="33.355";PLANS_DISCOUNTS_JSON_NEW.starter.biennial="40";PLANS_DISCOUNTS_JSON_NEW.regular={};PLANS_DISCOUNTS_JSON_NEW.regular.monthly="0";PLANS_DISCOUNTS_JSON_NEW.regular.yearly="20";PLANS_DISCOUNTS_JSON_NEW.regular.biennial="40";PLANS_DISCOUNTS_JSON_NEW.pro={};PLANS_DISCOUNTS_JSON_NEW.pro.monthly="0";PLANS_DISCOUNTS_JSON_NEW.pro.yearly="18.75";PLANS_DISCOUNTS_JSON_NEW.pro.biennial="40";PLANS_DISCOUNTS_JSON_NEW.enterprise={};PLANS_DISCOUNTS_JSON_NEW.enterprise.monthly="0";PLANS_DISCOUNTS_JSON_NEW.enterprise.yearly="18.75";PLANS_DISCOUNTS_JSON_NEW.enterprise.biennial="40";function is_new_signup_payment(){return IS_NEW_USER&&_plan_on_signup}function initializeInvoicesListeners(){$("#invoice-details-holder").on("click","#invoice-model-list > tr",function(b){b.preventDefault();var c=$(this).find(".data").attr("data");if(c){Backbone.history.navigate("invoice/"+c,{trigger:true})}})}var _plan_restrictions={};$(function(){init_acl_restriction()});function init_acl_restriction(){_plan_restrictions={billing_restriction:_billing_restriction,plan:_billing_restriction.currentLimits,is_social_suite:[function(){return _plan_restrictions.plan.socialSuite},function(){return{message:"Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Regular or Pro plan to use this feature."}}],is_email_gateway_allowed:[function(){return _plan_restrictions.plan.emailGateway},function(){return{message:"Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Enterprise plan"}}],is_sms_gateway_allowed:[function(){return _plan_restrictions.plan.smsgateway},function(){return{message:"Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Regular or Pro plan"}}],is_ecommerce_sync_allowed:[function(){return _plan_restrictions.plan.ecommerceSync},function(){return{message:"Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Regular or Pro plan"}}],is_accounting_sync_allowed:[function(){return _plan_restrictions.plan.accountingSync},function(){return{message:"Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Regular or Pro plan"}}],is_ACL_allowed:[function(){return _plan_restrictions.plan.acl},function(){return{message:" Please <a href=\"#subscribe-plan\" class='c-p text-info'>upgrade</a> to Enterprise plan to use this feature. "}}],is_calling_widget:[function(){return _plan_restrictions.plan.callingWidget},function(){return{message:"Please <a href=\"#subscribe-plan\" class='c-p text-info'>upgrade</a> to Regular or Pro plan to use this feature. "}}],is_custom_widget:[function(){return _plan_restrictions.plan.customWidget},function(){return{message:"Please <a href=\"#subscribe-plan\" class='c-p text-info'>upgrade</a> to Regular or Pro plan."}}],online_appointment:[function(){return _plan_restrictions.plan.onlineAppointment},function(){return}],is_mobile_integration:[function(){return _plan_restrictions.plan.mobileIntegration},function(){}],is_google_sync:function(){return this.plan.googleSync},is_ecommerce_sync:function(){return this.plan.ecommerceSync},is_payment_sync:function(){return this.plan.paymentSync},is_activity_reports_enabled:[function(){return _plan_restrictions.plan.activityReports},function(){return{message:"Please <a href='#subscribe-plan' class='c-p text-info'>upgrade</a> to Enterprise plan"}}],is_cohort_reports_enabled:[function(){return _plan_restrictions.plan.cohortReports},function(){return{message:"Regular/Pro plan only"}}],process_widgets:function(e){var f=e.where({is_added:true});if(f&&f.length>=_plan_restrictions.plan.widgetsLimit){var d=e.where({is_added:false});for(var b=0;b<d.length;b++){d[b].set("allowedToAdd",false)}}else{if(f&&f.length==0){var d=e.where({allowedToAdd:false});for(var b=0;b<d.length;b++){d[b].set("allowedToAdd",true)}}}console.log(e);if(!this.is_calling_widget[0]()){var c=e.where({is_added:false,widget_type:"CALL"});if(c&&c.length){for(var b=0;b<c.length;b++){var g=c[b].get("widget_type");if(g=="CALL"){c[b].set("allowedToAdd",false)}}}}}};$("#content").on("click","._upgrade",function(c){c.preventDefault();var d=$(this).attr("id");if(!d){return}var b=$("."+d);if(!b||b.length==0){return}$(b).show().delay(3000).hide(1)})}function getDomainUserFromDeserialize(b){var c={};c.menu_scopes={};c.user_scopes={};c.menu_scopes.checked=true;c.menu_scopes.disabled=false;c.user_scopes.checked=true;c.user_scopes.disabled=false;if(!_plan_restrictions.is_ACL_allowed[0]()){c.menu_scopes.disabled=true;c.user_scopes.disabled=true;return c}if(b&&b.id){c.menu_scopes.checked=false;c.menu_scopes.disabled=false;c.user_scopes.checked=false;c.user_scopes.disabled=false}if(b!=null&&b.id&&b.is_admin){c.user_scopes.disabled=true}console.log(b);console.log(c);return c}var AGILE_COUPONS_JSON={},AGILE_COUPON_INVALID_MESSAGE="Coupon is either expired or invalid for the selected plan.";function showCouponCodeContainer(b){if(b){$("#content").find("#coupon_code_container").show()}b=(b)?"payment_selection_container":"payment_selection_container1";$("#"+b).remove()}function showCouponDiscountAmount(b,d){var c=$(".coupon_code_discount_amount",d);var e=b.cost;if(!e){return c.html("")}checkValidCoupon(b.coupon_code,function(g){var m=(!g)?{}:AGILE_COUPONS_JSON[b.coupon_code];var k=$(".coupon_code_discount_amount",d);var l="0%";if(!m||!(m.percentOff||m.amountOff)){k.find("#total_cost_with_discount").html(e);return k.find("#coupon_code_discount_percent").html("$0 ("+l+")")}var h=m.amountOff;if(h){e=e-(h/100);l="$"+(h/100)}var j=m.percentOff;if(!h&&j){var f=e*(j/100);e=e-f;l="$"+(f.toFixed(2))+" ("+j+"%)"}k.find("#total_cost_with_discount").html(e.toFixed(2));k.find("#coupon_code_discount_percent").html(l)})}function getCouponJSON(b,d){if(!b){return false}var c='<img src="'+updateImageS3Path("img/1-0.gif")+'" height="20px" width="20px" />';$("#coupon_code_container form i").before(c);$.get("corea/subscription/coupon/"+b,{},function(e){$("#coupon_code_container form img").remove();if(!e.id){AGILE_COUPONS_JSON[b]="null"}else{AGILE_COUPONS_JSON[e.id]=e}if(d){d(b)}})}function checkValidCoupon(b,c){if(!b){return c(false)}if(AGILE_COUPONS_JSON[b]){return c(AGILE_COUPONS_JSON[b]!="null")}console.log(AGILE_COUPONS_JSON[b]);getCouponJSON(b,function(d){checkValidCoupon(d,c)})}function getCouponJSON(b,d){if(!b){return false}var c='<img src="'+updateImageS3Path("img/1-0.gif")+'" height="20px" width="20px" />';$("#coupon_code_container form i").before(c);$.getJSON("core/api/subscription/coupon/"+b,{},function(e){console.log(e);$("#coupon_code_container form img").remove();if(!e.id){AGILE_COUPONS_JSON[b]="null"}else{AGILE_COUPONS_JSON[e.id]=e}if(d){d(b)}})}function showCouponStatus(b){var c='<img src="'+updateImageS3Path("img/1-0.gif")+'" height="15px" width="15px" />';$("#check_valid_coupon").remove(c)}function card_expiry(e){var g={};g[1]="01 (Jan)";g[2]="02 (Feb)";g[3]="03 (Mar)";g[4]="04 (Apr)";g[5]="05 (May)";g[6]="06 (Jun)";g[7]="07 (Jul)";g[8]="08 (Aug)";g[9]="09 (Sep)";g[10]="10 (Oct)";g[11]="11 (Nov)";g[12]="12 (Dec)";var b=$("#exp_month",e),f=new Date().getMonth()+1;for(var c=1;c<=12;c++){b.append($("<option value='"+c+"' "+(f===c?"selected":"")+">"+g[c]+"</option>"))}var b=$("#exp_year",e),d=new Date().getFullYear();for(var c=0;c<22;c++){b.append($("<option value='"+(c+d)+"' "+(c===0?"selected":"")+">"+(c+d)+"</option>"))}}function deserialize_card_details(c,b){$.each(c,function(e,f){var d;if(e.indexOf("name")!=-1){d=b.find('*[name="name"]')}else{if(e=="addressCountry"){d=b.find('*[name="address_country"]')}else{if(e=="addressState"){d=b.find('*[name="address_state"]')}else{if(e=="addressState"){d=b.find('*[name="address_state"]')}else{if(e=="addressLine1"){d=b.find('*[name="address_line1"]')}else{if(e=="addressLine2"){d=b.find('*[name="address_line2"]')}else{if(e=="addressZip"){d=b.find('*[name="address_zip"]')}}}}}}}if(d&&d.length>0){tag=d[0].tagName.toLowerCase();if(tag=="input"){$(d).val(f)}else{if(tag=="select"&&e=="addressCountry"){$("#country").val(f).prop("selected",true).trigger("change");$("#state").val(c.addressState).prop("selected",true).trigger("change")}}}})}var tpl_directory={loadTemplates:function(b,d){var c=[];$.each(b,function(f,e){c.push(load_urls_on_ajax_stop(CLOUDFRONT_PATH+"tpl/min/precompiled/locales/"+_LANGUAGE+"/"+e+".js?_="+_agile_get_file_hash(e+".js")))
});$.when.apply(null,c).done(d)}};$(function(){if(!HANDLEBARS_PRECOMPILATION){return}startFunctionTimer("loadtemplates");tpl_directory.loadTemplates(["contact-view","case","document","workflow","portlets","web-rules","landingpages","settings","admin","admin-settings","tickets"],function(){endFunctionTimer("loadtemplates")})});var notification_prefs;function downloadAndRegisterForNotifications(){getDueTasksCount(function(e){var d=e;if(d==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","inline-block")}if(d!=0){$("#due_tasks_count").html(d)}else{$("#due_tasks_count").html("")}});var c=Backbone.Model.extend({url:"core/api/notifications"});var b=new c();b.fetch({success:function(d){notification_prefs=d.toJSON();console.log(notification_prefs);getDomainFromCurrentUser()}})}function getDomainFromCurrentUser(){var b=CURRENT_DOMAIN_USER.domain;subscribeToPubNub(b,function(c){_setupNotification(c)})}function subscribeToPubNub(b){var c="https";load_urls_on_ajax_stop(c+"://pubnub.a.ssl.fastly.net/pubnub-3.4.min.js",function(){var d=PUBNUB.init({publish_key:"pub-c-e4c8fdc2-40b1-443d-8bb0-2a9c8facd274",subscribe_key:"sub-c-118f8482-92c3-11e2-9b69-12313f022c90",ssl:true,origin:"pubsub.pubnub.com"});d.ready();d.subscribe({channel:b,callback:function(f){console.log(f);if(f.type=="LOGIN_INSTANCE"){check_login_instance(f);return}if(f.type=="BULK_ACTIONS"){bulkActivitiesNoty("information",f);return}if(f.type&&f.type.indexOf("TICKET")!=-1){loadServiceLibrary(function(){Ticket_Utils.showNoty("information",f.message,"bottomRight",5000)});return}if(f.type=="EVENT_REMINDER"){if(CURRENT_DOMAIN_USER.email==f.useremail){getTemplate("event-notification",f,undefined,function(g){if(!g){return}showNoty("information",$(g),"bottomRight","EVENT_REMINDER",undefined,3000000)},null);return}}if(f.type=="CALL"){getTemplate("call-notification",f,undefined,function(g){if(!g){return}showNoty("information",$(g),"bottomRight","CALL")},null);return}if(f.type=="UNKNOWN_CALL"){getTemplate("unknown-call-notification",f,undefined,function(g){if(!g){return}showNoty("information",$(g),"bottomRight","UNKNOWN_CALL")},null);return}if(f.notification=="CAMPAIGN_NOTIFY"){var e=JSON.parse(f.custom_value);if(e.owner_id=="ALL"){getTemplate("campaign-notify",f,undefined,function(g){if(!g){return}showNoty("information",$(g),"bottomRight","CAMPAIGN_NOTIFY")},null)}if(e.owner_id==CURRENT_DOMAIN_USER.id){getTemplate("campaign-notify",f,undefined,function(g){if(!g){return}showNoty("information",$(g),"bottomRight","CAMPAIGN_NOTIFY")},null)}return}if(f.type=="IS_BROWSING"){get_contact_by_email(f.email,function(g){if(g){g.notification=f.type;g.custom_value=f.custom_value;f=g;_setupNotification(f)}});return}_setupNotification(f)},connect:function(){console.log("connected");publishLoginEvent(d)}})})}function _setupNotification(b){if(b.notification=="CONTACT_DELETED"){b.id=""}getTemplate("notify-html",b,undefined,function(d){if(!d){return}var c=$(d);notification_for_email_and_browsing(b,c);if("current_user_name" in b){if(notification_prefs.prefs.currentDomainUserName==b.current_user_name){return}}notification_for_contact_and_deal(b,c)},null)}function notification_for_email_and_browsing(b,c){if(b.notification=="CLICKED_LINK"||b.notification=="OPENED_EMAIL"||b.notification=="IS_BROWSING"){var d=get_option(b.notification);notification_based_on_type_of_contact(d,b,c,b.notification);return}}function notification_for_contact_and_deal(b,c){$.each(notification_prefs,function(e,f){if(e==b.notification.toLowerCase()){if(notification_prefs[e]){if((b.notification=="CONTACT_ADDED"||b.notification=="CONTACT_DELETED")&&b.type=="COMPANY"){var d=b.notification.replace("CONTACT","COMPANY");b.notification=d}showNoty("information",c,"bottomRight",b.notification)}}})}function is_assigned(b){var c=notification_prefs.prefs.currentDomainUserName;var d=b.owner_name;if(c==d){return true}return false}function is_assigned_and_starred(b){if(is_assigned(b)&&b.star_value>0){return true}return false}function get_option(b){switch(b){case"CLICKED_LINK":return notification_prefs.link_clicked;case"OPENED_EMAIL":return notification_prefs.email_opened;case"IS_BROWSING":return notification_prefs.browsing}}function notification_based_on_type_of_contact(d,b,e,c){switch(d){case"CONTACT_ASSIGNED":if(is_assigned(b)){showNoty("information",e,"bottomRight",c)}break;case"CONTACT_ASSIGNED_AND_STARRED":if(is_assigned_and_starred(b)){showNoty("information",e,"bottomRight",c)}break;case"ANY_CONTACT":showNoty("information",e,"bottomRight",c);break}}function check_browser_notification_settings(b){if(notify&&!notify.isSupported){$("#set-desktop-notification").css("display","none")}if(notify&&notify.isSupported&&notify.permissionLevel()==notify.PERMISSION_GRANTED){$("#set-desktop-notification").css("display","none");$("#desktop-notification-content").html(getTemplate("js-desktop-notifications-disable"))}if(notify&&notify.isSupported&&notify.permissionLevel()==notify.PERMISSION_DENIED){$("#set-desktop-notification").css("display","none");$("#desktop-notification-content").html(getTemplate("js-desktop-notifications-enable"))}$("#enable-notification",b).on("click",function(c){c.preventDefault();if($("#notification-enable-help-modal").length==0){getTemplate("notification-enable-help-modal",{},undefined,function(d){if(!d){return}$("body").append($(d))},null)}$("#notification-enable-help-modal").modal("show")});$("#disable-notification",b).on("click",function(c){c.preventDefault();if($("#notification-disable-help-modal").length==0){getTemplate("notification-disable-help-modal",{},undefined,function(d){if(!d){return}$("body").append($(d))},null)}$("#notification-disable-help-modal").modal("show")})}function showSwitchChanges(b){$("#control_notifications").off("change").on("change",function(){var c=$("#notification-switch").bootstrapSwitch("status");if(c){$(b).find("input[type=checkbox]").not("#control_notifications,#notification_sound").removeAttr("disabled");$(b).find("select").not("#control_notifications").removeAttr("disabled")}else{$(b).find("input[type=checkbox]").not("#control_notifications").attr("disabled","disabled");$(b).find("select").not("#control_notifications, #notification_sound").attr("disabled","disabled")}})}function showNoty(e,f,b,d,c,g){if(!g){g=30000}if(d!="EVENT_REMINDER"){if(d!="CAMPAIGN_NOTIFY"&&!notification_prefs.control_notifications){return}}if(notify&&notify.isSupported&&notify.permissionLevel()==notify.PERMISSION_GRANTED){if(d=="CALL"){show_desktop_notification($("span:eq(0)",f).attr("id"),$(f).find("#calling-contact-id").text(),$(f).find("#call-notification-text").text(),$(f).find("#calling-contact-id").attr("href"),$(f).find("#calling-contact-id").attr("href").split("/")[1]+"-CALL");return}if(d=="UNKNOWN_CALL"){show_desktop_notification($("span:eq(0)",f).attr("id"),$(f).find("#unknown-contact-name").text(),$(f).find("#unknown-call-notification-text").text(),$(f).find("#unknown-contact-name").attr("href"),$(f).find("#unknown-contact-name").attr("href").split("/")[2]+"-UNKNOWN_CALL");return}if(d=="CAMPAIGN_NOTIFY"){show_desktop_notification($("span:eq(0)",f).attr("id"),$(f).find("#campaign-contact-id").text(),$(f).find("#campaign-notify-text").text(),$(f).find("#campaign-contact-id").attr("href"),$(f).find("#campaign-contact-id").attr("href").split("/")[1]+"-CAMPAIGN_NOTIFY");return}if(d=="EVENT_REMINDER"){show_desktop_notification(getImageUrl(f,d),getNotificationType(d),getTextMessage(f),getId(f),getId(f).split("/")[1]+"-"+d,3000000);return}show_desktop_notification(getImageUrl(f,d),getNotificationType(d),getTextMessage(f),getId(f),getId(f).split("/")[1]+"-"+d);return}head.js(LIB_PATH+"lib/noty/jquery.noty.js",LIB_PATH+"lib/noty/layouts/bottomRight.js",LIB_PATH+"lib/noty/layouts/bottom.js",LIB_PATH+"lib/noty/themes/default.js",function(){var h=noty({text:f,layout:b,type:e,timeout:g,closeCallback:(c&&typeof c=="function")?c:undefined,callback:{onClose:function(){console.log(this);if(this.options.closeCallback&&typeof this.options.closeCallback=="function"){this.options.closeCallback()}}}});console.log(h);if(h.options.type=="information"){if(notification_prefs.notification_sound!="no_sound"){play_sound(notification_prefs.notification_sound)}}$(".noty_bar").on("click",function(){if(h.options.type=="information"){var j=$(this).find("a").attr("href");if(j){Backbone.history.navigate(j,{trigger:true})}}})})}function getTextMessage(d){var b;var c=$(d).find("#notification-type").text();if($(d).find("#notification-contact-id").text()!=""){b=$(d).find("#notification-contact-id").text();return b+" "+c}if($(d).find("#noty_text").text()!=""){b=$(d).find("#noty_text").text();return b}b=$(d).find("#notification-deal-id").text();return b+" "+c}function getNotificationType(b){if(b=="CONTACT_ADDED"||b=="COMPANY_ADDED"||b=="TAG_ADDED"||b=="DEAL_CREATED"){return"New "+ucfirst(b.split("_")[0])}if(b=="IS_BROWSING"){return ucfirst(b.split("_")[1])}return ucfirst(b.split("_")[0])+" "+ucfirst(b.split("_")[1])}function getId(b){if(($(b).find("#noty_text").text()!="")){return $(b).find("#noty_text").text()}if($(b).find("#notification-contact-id").text()!=""){return $(b).find("#notification-contact-id").attr("href")}return $(b).find("#notification-deal-id").attr("href")}function getImageUrl(c,b){if(b=="EVENT_REMINDER"){return"/img/eventreminder.png"}if($(c).find("#notification-contact-id").text()!=""){if(b==="COMPANY_ADDED"||b==="COMPANY_DELETED"){return $("span:eq(1)",c).attr("id")}return $("span:eq(0)",c).attr("id")}return"/img/deal.png"}function notification_play_button(){$("body").on("click","#notification-sound-play",function(c){c.preventDefault();var b=$("#notificationsForm #notification_sound").find(":selected").val();if(b=="no_sound"){return}play_sound(b)})}function get_contact_by_email(b,d){try{accessUrlUsingAjax("core/api/contacts/search/email/"+b,function(f){var e=f;console.log("**** responseJson ****");console.log(e);d(e)})}catch(c){return null}}$(function(){request_notification_permission()
});function show_desktop_notification(c,h,e,d,b,f){if(!f){f=30000}var g=notify.createNotification(h,{body:e,icon:c,tag:b,onClickCallback:function(){window.focus();Backbone.history.navigate(d,{trigger:true});g.close()}});setTimeout(function(){g.close()},f);if(!window.closed){if(notification_prefs.notification_sound!="no_sound"){play_sound(notification_prefs.notification_sound)}}}function request_notification_permission(){if(notify.permissionLevel()!=notify.PERMISSION_DEFAULT){return}$("body").on("click","#set-desktop-notification",function(){notify.requestPermission(function(){if(notify.permissionLevel()==notify.PERMISSION_GRANTED){$("#set-desktop-notification").css("display","none");$("#desktop-notification-content").html(getTemplate("js-desktop-notifications-disable"))}else{$("#set-desktop-notification").css("display","none");$("#desktop-notification-content").html(getTemplate("js-desktop-notifications-enable"))}})})}$(function(){$("body").on("click","#helpMail",function(c){c.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm($("#helpmailForm"))){return}disable_send_button($(this));var b=serializeForm("helpmailForm");b.from=CURRENT_DOMAIN_USER.email;b.body=b.body.replace(/\r\n/g,"<br/>");$.ajax({type:"POST",data:b,url:"core/api/emails/contact-us",success:function(){$("#helpmailForm").each(function(){this.reset()});$save_info=$('<span class="text-success" style="color:#008000; font-size:15px; display:inline-block"><i> Email Sent</i></span>');$("#msg").append($save_info);$save_info.show().delay(1000).fadeOut("slow",function(){enable_send_button($("#helpMail"));window.history.back()})},error:function(d){enable_send_button($("#helpMail"));$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+d.responseText+"</i></p></small></div>");$($("#helpMail")).closest(".form-actions",this.el).append($save_info);if(d.status!=406){$save_info.show().delay(10000).hide(1)}}})})});$(function(){$("#content").on("focusout","#email",function(d){d.preventDefault();var f=$("#email").val();if(f.length==0){$("#pic").css("display","none");changeProperty();return}var b=getPicByEmail(f,45);if(b!=undefined&&b!=null){var c=$('<img class="imgholder thumbnail person-img" onload="changeProperty()" style="display: inline;"  src="'+b+'"></img>');$("#pic").html(c).show();$("img").error(function(){$("#pic").css("display","none");changeProperty()})}})});function getPicByEmail(b,c){if(b){return"https://secure.gravatar.com/avatar/"+Agile_MD5(b)+".jpg?s="+c+"&d=404"}}$(function(){$("body").on("click",".voice-mail-add",function(b){b.preventDefault();$("#uploadVoiceMailModal").modal("show")});$("body").on("show.bs.modal","#uploadVoiceMailModal",function(b){$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error")});$("body").on("click",".addFileLink",function(c){c.preventDefault();$(this).closest("form").find("#error").html("");var b=$(this).closest("form").attr("id");var f=$(this).find("a").attr("id");if(f&&f=="S3"){var d=window.open("upload-voice-mail.jsp?id="+b+"&t="+CURRENT_USER_PREFS.template+"&d="+CURRENT_DOMAIN_USER.domain,"name","height=310,width=500")}if(window.focus){d.focus()}return false});$("body").on("click","#voicemail_validate",function(f){f.preventDefault();var d=$(this).closest(".voice-mail-modal").attr("id");var b=$(this).closest(".voice-mail-modal").find("form").attr("id");if(!isValidForm("#"+b)){return false}var c=serializeForm(b);if(b=="uploadVoiceMaiForm"){saveVoiceMail(b,d,this,c)}});$("#uploadVoiceMaiForm").submit(function(b){b.preventDefault()});$("body").on("click",".audioPlay",function(c){c.preventDefault();audio=$(this).find("audio");$(this).addClass("audioPause");$(this).removeClass("audioPlay");$(this).find("i").removeClass("icon-play");$(this).find("i").addClass("icon-stop");audio.trigger("play");var b=this;audio.bind("ended",function(){$(b).addClass("audioPlay");$(b).removeClass("audioPause");$(b).find("i").removeClass("icon-stop");$(b).find("i").addClass("icon-play")})});$("body").on("click",".audioPause",function(b){b.preventDefault();audio=$(this).find("audio");$(this).addClass("audioPlay");$(this).removeClass("audioPause");$(this).find("i").removeClass("icon-stop");$(this).find("i").addClass("icon-play");audio.trigger("pause");audio.prop("currentTime",0)})});function saveVoiceMailFileURL(c,d,g){g=g.split("?id=")[1];var b=g.split("&")[0];var f=c.split("?");if(c.match("audiofiles/")){f=f[0];f=f.substring(f.lastIndexOf("/")+1)}else{f=""}$("#"+b).find("#extension").val(f);$("#"+b).find("#network_type").val(d);var e=c.substring(0,c.indexOf("?"));$("#"+b).find("#upload_url").val(e);$(".addFileLink").empty();if(f!=""){$(".addFileLink").html(f)}}function saveVoiceMail(b,g,f,d){if($(f).attr("disabled")){return}disable_save_button($(f));if(b){if(!isValidForm("#"+b)){enable_save_button($(f));return false}var c=$("#"+b).find("#upload_url").val();if(c==""){$("#"+b).find("#error").html('<div class="alert alert-danger">Sorry! Voice file not uploaded properly.</div>');enable_save_button($(f));return}}var e=new Backbone.Model();e.url="core/api/voicemails";e.save(d,{success:function(h){App_VoiceMailRouter.VoiceMailCollectionView.collection.add(h);App_VoiceMailRouter.VoiceMailCollectionView.render(true);enable_save_button($(f));if(b){$("#"+b).find("#network_type").val("");$("#"+b).find("#upload_url").val("");$("#"+b).find("#extension").val("");$("#"+b).find(".addFileLink").empty();$("#"+b).find("#error").empty();$("#"+b).find(".addFileLink").html('<a href="#" id="S3"><i class="icon-plus-sign"></i> <span>Add File</span></a>');$("#"+b).each(function(){this.reset()});$("#"+g).modal("hide")}}})}function initializeDomainsearchListner(b){$("#domain-search-listners").on("click","#domain-search-results2",function(d){d.preventDefault(d);var c=$("#domainSearchText2").val();console.log(" in all -domain users.js "+c);$("#domainSearchText").val(c);Backbone.history.navigate("getDomainUserDetails/"+c,{trigger:true})});$("#domainSearchForm").submit(function(d){d.preventDefault(d);var c=$("#domainSearchText").val();console.log(" in all -domain users.js "+c);Backbone.history.navigate("getDomainUserDetails/"+c,{trigger:true})})}function initializeAdminpanelListner(b){$("#admin-panel-listners").on("click",".delete_user",function(d){d.preventDefault();var c=$(this);showAlertModal("delete_user","confirm",function(){var e=c.closest("a").attr("data");$.ajax({url:"/core/api/admin_panel/deleteuser?id="+e,type:"DELETE",success:function(f){add_delete_user_info_as_note_to_owner(email);showAlertModal("user_deleted",undefined,function(){location.reload(true)})},error:function(f){alert("error in deletion ")}})})});$("#admin-panel-listners").on("click","#all-domain-users-model-list > tr",function(d){d.preventDefault();var c=$(this).find(".data").attr("data");Backbone.history.navigate("getDomainUserDetails/"+c,{trigger:true})});$("#admin-panel-listners").on("click",".delete-namespace",function(d){d.preventDefault();var c=$(this).closest("a").attr("data");if(c!=""){showAlertModal("delete_account","confirm",function(){$("#content").html(getRandomLoadingImg());$.ajax({type:"DELETE",url:"core/api/admin_panel/deletedomain/"+c,success:function(e){alert("account deleted");Backbone.history.navigate("all-domain-users",{trigger:true})}})})}});$("#admin-panel-listners").on("click",".refundpopup",function(c){c.preventDefault();var g=$(this).attr("chargeid");var f=$(this).attr("totalamount");var d=$(this).attr("refundedAmount");$("#errormsg").html("");$("#amount").val(f-d);$("#hchargeid").val(g);$("#totamount").val(f);$("#partialrefund").button("reset");$("#refundModal").modal("show")});$("#partial-refund-footer").off("click").on("click","#partialrefund",function(d){d.preventDefault();if(!isValidForm($("#admin-partial-refund"))){return}$(this).button("loading");var c=$("#amount").val();var f=$(".totamount").val();var g=$("#hchargeid").val();if(parseFloat(c)<=0){$("#errormsg").html("Amount should be > 0").show().delay(1500).hide(1);$("#partialrefund").button("reset");return}if(parseFloat(c)>parseFloat(f)){$("#errormsg").html("Amount Should not exceed "+f).show().delay(1500).hide(1);$("#partialrefund").button("reset");return}c=100*c;c=parseInt(c.toPrecision(12));$.ajax({url:"/core/api/admin_panel/applypartialrefund?chargeid="+g+"&amount="+c,type:"GET",success:function(e){alert("successfully applied for refund");location.reload(true)},error:function(e){$("#partialrefund").button("reset");showNotyPopUp("information",_agile_get_translated_val("billing","error-occured"),"top")}})});$("#admin-panel-listners .unblock_user").off("click");$("#admin-panel-listners").on("click",".unblock_user",function(f){f.preventDefault();var d=$(this).attr("domain");var c=this;if(d){$.ajax({url:"/core/api/admin_panel/release_user?d="+d,type:"POST",success:function(g){showNotyPopUp("information","Domain released successfully.","top");$(c).closest("div").hide();var e={};e.from="care@agilecrm.com";e.cc="mogulla@agilecrm.com";e.to="venkat@agilecrm.com";e.subject="Domain released from Admin Panel";e.body="Domain: "+d;sendEmail(e)},error:function(e){showNotyPopUp("warning",e.responseText,"top")}})}});$("#admin-panel-listners").on("click","#delete_userplan",function(c){c.preventDefault();showAlertModal("delete_subscription","confirm",function(){var e=$("#delete_userplan").attr("sub_id");var d=$("#delete_userplan").attr("cus_id");$.ajax({url:"core/api/admin_panel/deletesubscription?subscription_id="+e+"&cus_id="+d,type:"DELETE",success:function(){add_cancel_subscription_info_as_note_to_owner(email);location.reload(true)},error:function(f){console.log(f)}})})});$("#admin-panel-listners").on("click","#delete_emailplan",function(c){c.preventDefault();showAlertModal("delete_subscription","confirm",function(){var e=$("#delete_emailplan").attr("sub_id");var d=$("#delete_emailplan").attr("cus_id");$.ajax({url:"core/api/admin_panel/deletesubscription?subscription_id="+e+"&cus_id="+d,type:"DELETE",success:function(){add_cancel_subscription_info_as_note_to_owner(email);
location.reload(true)},error:function(f){console.log(f)}})})});$("#admin-panel-listners").on("click","#unpause_mandrill",function(d){d.preventDefault();var c=$(this);showAlertModal("resume_mandrill","confirm",function(){var e=c.attr("domain");$.ajax({url:"core/api/admin_panel/resumeMandrill?domain="+e,type:"PUT",success:function(){location.reload(true)},error:function(f){console.log(f);showNotyPopUp("information",_agile_get_translated_val("billing","error-occured"),"top")}})})});$("#admin-panel-listners .check_affiliate").off("click");$("#admin-panel-listners").on("click",".check_affiliate",function(f){f.preventDefault();var d=$(this).attr(d);var c=$(this).attr("userId");$.ajax({url:"core/api/admin_panel/affiliateDetails?d="+d+"&id="+c,type:"GET",success:function(e){if(e&&e.id){getTemplate("affiliate-add-amount",{domain:d,userId:c},undefined,function(g){if(!g){return}$("#affiliateAddAmountModal").html($(g)).show()},"#content")}else{showAlertModal("affiliate_error")}},error:function(e){showNotyPopUp("error",e.responseText,"top")}})});$("#affiliateAddAmountModal #add_amount").off("click");$("#affiliateAddAmountModal").on("click","#add_amount",function(g){g.preventDefault();if(!isValidForm($("#affiliate-add-amount-form"))){return}$(this).attr("disabled","disabled");var f=$("#affiliateAddAmountModal").find("input[name='domain']");var d=$("#affiliateAddAmountModal").find("input[name='userId']");var c=$("#affiliateAddAmountModal").find("input[name='amount']");$.ajax({url:"core/api/admin_panel/affiliate/addAmount?d="+f+"&id="+d+"&amount="+c,type:"POST",success:function(e){showNotyPopUp("information","Amount added successfully","top");$("#affiliateAddAmountModal").hide()},error:function(e){showNotyPopUp("error",e.responseText,"top");$("#affiliateAddAmountModal").hide()}})})}function isRoute(b){if(!Current_Route){return false}return(Current_Route.indexOf(b)==0)}function isModalVisible(){return $(".modal").is(":visible")}$(function(){if(CURRENT_USER_PREFS.keyboard_shotcuts){enableKeyboardShotcuts();$(".show_shortcuts .shortcuts").addClass("enable")}$("body").on("click","#keyboard-shortcuts",function(b){b.preventDefault();getTemplate("shortcut-keys",{},undefined,function(c){if(!c){return}$(c).modal("show")},null)})});function enableKeyboardShotcuts(){head.js(LIB_PATH+"lib/mousetrap.min.js",function(){Mousetrap.bind("shift+n",function(){if(!isModalVisible()){addContactBasedOnCustomfields()}});Mousetrap.bind("shift+c",function(){if(!isModalVisible()){$("#companyModal").modal("show")}});Mousetrap.bind("shift+v",function(){if(!isModalVisible()){$("#activityModal").html(getTemplate("new-event-modal")).modal("show");highlight_event()}});Mousetrap.bind("shift+t",function(){if(!isModalVisible()){showTaskModal("")}});Mousetrap.bind("shift+d",function(){if(!isModalVisible()){show_deal()}setup_tags_typeahead()});Mousetrap.bind("shift+o",function(){if(!isModalVisible()){$("#noteModal").modal("show");var b=$("#noteForm");agile_type_ahead("note_related_to",b,contacts_typeahead)}});Mousetrap.bind("shift+p",function(){if(!isRoute("user-prefs")&&!isModalVisible()){App_Settings.navigate("user-prefs",{trigger:true})}});Mousetrap.bind("shift+a",function(){if(!isRoute("account-prefs")&&!isModalVisible()&&CURRENT_DOMAIN_USER.is_admin){App_Settings.navigate("account-prefs",{trigger:true})}});Mousetrap.bind("shift+l",function(){if(!isRoute("themeandlayout")&&!isModalVisible()){App_Settings.navigate("themeandlayout",{trigger:true})}});Mousetrap.bind("shift+u",function(){if(!isRoute("subscribe")&&!isModalVisible()){App_Settings.navigate("subscribe",{trigger:true})}});Mousetrap.bind("shift+r",function(){if(!isModalVisible()){window.open("https://www.agilecrm.com/product-updates",true)}});Mousetrap.bind("shift+h",function(){if(!isModalVisible()){window.open("https://www.agilecrm.com/support",true)}});Mousetrap.bind("shift+g",function(){if(!isModalVisible()){window.location.href="/login?sur=true"}});Mousetrap.bind("shift+e",function(){if(isRoute("contact/")&&!isModalVisible()){App_Contacts.navigate("contact-edit",{trigger:true})}});Mousetrap.bind("shift+m",function(){if(isModalVisible()){return}if(isRoute("contact/")){App_Contacts.navigate("send-email/"+getCurrentContactProperty("email"),{trigger:true})}else{App_Contacts.navigate("send-email",{trigger:true})}});Mousetrap.bind("/",function(b){if(isModalVisible()){return}document.getElementById("searchText").focus();if(b.preventDefault){b.preventDefault()}else{b.returnValue=false}});Mousetrap.bind("n",function(){if(isModalVisible()){return}if(isRoute("contact")){addContactBasedOnCustomfields()}else{if(isRoute("cases")){showCases()}else{if(isRoute("deals")){show_deal();setup_tags_typeahead()}else{if(isRoute("workflow")){App_Workflows.navigate("workflow-add",{trigger:true})}else{if(isRoute("report")){App_Reports.navigate("report-add",{trigger:true})}else{if(isRoute("tasks")){showTaskModal("")}else{if(isRoute("calendar")){$("#activityModal").html(getTemplate("new-event-modal")).modal("show");highlight_event()}}}}}}}})})}var Agile_GA_Event_Tracker={category:"Agile Dashboard",track_event:function(c){if(!c){return}var b=CURRENT_DOMAIN_USER.domain;b=(!b)?"localhost":b;try{_gaq.push(["_trackEvent",this.category,c,b])}catch(d){try{ga("b.send","event",this.category,c,b)}catch(d){}}}};$(function(){$("body").on("click",".ga-track-event",function(){var b=$(this).attr("data-ga-text");if(!b){return}Agile_GA_Event_Tracker.track_event(b)})});function track_with_save_success_model(d){try{var b=location.href;var c="";if(b.indexOf("newsletter")!=-1){c="Save Campaign in Newsletter"}else{if(b.indexOf("auto_responder")!=-1){c="Save Campaign in Autoresponder"}else{if(b.indexOf("webrule-add")!=-1){c="Web Rule Added"}else{if(b.indexOf("landing-page-add")!=-1){c="Landing Page Created"}}}}if(c){Agile_GA_Event_Tracker.track_event(c)}}catch(f){}}function agile_update_ga_track_page(b){if(!b){return}try{if(b.split("/").length>1){b=b.split("/")[0]}ga("b.set","page","/#"+b);ga("b.send","pageview")}catch(c){}}function addDetailsInCookie(f){console.log("In addDetailsInCookie");console.log($(f));var e=$(f).html();var h=$(f).attr("href");var g=null;var c=null;var d=null;var b=null;if($(f).closest("ul").attr("id")=="new-type-tasks"){g="task_criteria";d="task_criteria_forgroupview"}else{if($(f).closest("ul").attr("id")=="new-owner-tasks"){g="task_owner";d="task_owner_forgroupview"}}c=e+"_"+h;b=e+"_"+h;_agile_set_prefs(g,c);if(getCriteria()!="LIST"&&getCriteria()!="CALENDAR"){_agile_set_prefs(d,b)}}function readDetailsFromCookie(){console.log("In readDetailsFromCookie");var b=_agile_get_prefs("task_criteria");var c=_agile_get_prefs("task_owner");console.log(b+" "+c);withoutEventChangeDropDowns(b,c,undefined)}var TASKS_LIST_COLLECTION=null;var GROUPING_MAP={PRIORITY:{type:["HIGH","NORMAL","LOW"],searchKey:"priority_type"},CATEGORY:{type:["CALL","EMAIL","FOLLOW_UP","MEETING","MILESTONE","OTHER","SEND","TWEET"],searchKey:"type"},STATUS:{type:["YET_TO_START","IN_PROGRESS","COMPLETED"],searchKey:"status"},DUE:{type:["OVERDUE","TODAY","TOMORROW","LATER"],searchKey:"due"},OWNER:{type:[],searchKey:"taskOwner.name"}};var YET_TO_START="YET_TO_START";var IN_PROGRESS="IN_PROGRESS";var COMPLETED="COMPLETED";var flag=true;var FETCH_COUNTER=0;var IS_FECHING_DONE=false;$(function(){$(document).ready(function(){adjustHeightOfTaskListAndScroll()});$(window).resize(function(){adjustHeightOfTaskListAndScroll()})});function getUserDetails(b){$.getJSON("/core/api/users/partial",function(d){for(var c in d){GROUPING_MAP.OWNER.type[c]={name:d[c].name,id:d[c].id}}if(b&&typeof(b)==="function"){b()}}).error(function(c){console.log("get user err");console.log(c)})}function getHeadingForDueTask(b){var d=null;var c=get_due(b.due);if(c<0){return d="OVERDUE"}if(c==0){return d="TODAY"}if(c==1){return d="TOMORROW"}if(c>1){return d="LATER"}}function getNewDueDate(c){var b=new Date();if(c=="OVERDUE"){b.setDate(b.getDate()-1)}if(c=="TODAY"){(getGMTTimeFromDate(b)/1000)}if(c=="TOMORROW"){b.setDate(b.getDate()+1)}if(c=="LATER"){b.setDate(b.getDate()+2)}return(getGMTTimeFromDate(b)/1000)}function getNewDueDateBasedOnTime(g,c){var f=new Date();var e=new Date(c*1000);var b=e.getSeconds()+(60*e.getMinutes())+(60*60*e.getHours());console.log(b);if(g=="OVERDUE"){f.setDate(f.getDate()-1)}if(g=="TODAY"){(getGMTTimeFromDate(f)/1000)}if(g=="TOMORROW"){f.setDate(f.getDate()+1)}if(g=="LATER"){f.setDate(f.getDate()+2)}return(getGMTTimeFromDate(f)/1000)+b}function getProgressValue(b){if(b==YET_TO_START){return 0}else{if(b==COMPLETED){return 100}else{if(b==IN_PROGRESS){return 1}}}}function getTaskId(b){if($(b).hasClass("task-body")){return $(b).parent().attr("id")}else{return $(b).attr("data")}}function getTaskListId(b){return $(b).closest(".task-trello-list").attr("id")}function getTaskListOwnerId(b){return $(b).closest(".task-trello-list").find(".list-header").attr("ownerID")}function getCriteria(){var b=$("#new-type-tasks").data("selected_item");if(!b){b="DUE"}if(agile_is_mobile_browser()){b="LIST"}return b}function getTaskList(d,b,c){if(TASKS_LIST_COLLECTION){if(d=="OWNER"){return TASKS_LIST_COLLECTION.collection.where({heading:b,owner_id:parseInt(c)})}else{return TASKS_LIST_COLLECTION.collection.where({heading:b})}}return null}function getTaskFormId(b){var c=$(b).closest("form").attr("id");console.log(c);return c}function getArraySortOnCount(f,d,e){var c="/core/api/tasks/countoftype"+getParamsNew()+"&pending="+e;var b={};$.each(d,function(h,j){var g=c+"&type="+d[h];$.getJSON(g,function(k){b[k.type]=k.count;if(_.size(b)==d.length){sortArray(f,b,e)}}).error(function(k){console.log("get count err");console.log(k)})})}function sortArray(f,c,d){var e=[];var b=[];for(a in c){e.push([a,c[a]])}e.sort(function(h,g){return h[1]-g[1]});e.reverse();for(a in e){b.push(e[a][0])}createNestedCollection(f,b,d)}function getDetailsForCollection(){FETCH_COUNTER=0;IS_FECHING_DONE=false;var c=dropdownintelligence();var d=getCriteria();var b=$("#new-owner-tasks").data("selected_item");startMakingCollection(d,c)}function getParamsNew(){var c="?";
var d=getCriteria();if(d){c+=("&criteria="+d)}if(d=="DUE"){c+=("&start_time="+getNewDueDate("TODAY"));c+=("&end_time="+getNewDueDate("TOMORROW"))}var b=$("#new-owner-tasks").data("selected_item");if(b=="my-pending-tasks"){c+=("&pending="+true);c+=("&owner="+CURRENT_DOMAIN_USER.id);return c}if(b=="all-pending-tasks"){c+=("&pending="+true);b=""}if(b){c+=("&owner="+b)}else{if(b==undefined){c+=("&owner="+CURRENT_DOMAIN_USER.id)}}return c}function displaySettings(){displayTimeAgo($(".task-trello-list"));$(".listed-task").parent().addClass("task-striped");var b=getCriteria();if(b=="CATEGORY"){$(".new-task-type").remove();$(".new-task-owner").addClass("shift-up");$(".task-body").addClass("task-body-category")}if(b=="OWNER"){$(".new-task-owner").remove();$(".task-body").addClass("task-body-owner")}}function loadProgressSlider(b,c){head.load(LIB_PATH+"lib/jquery.slider.min.js",function(){$(".progress_slider",b).slider({from:0,to:100,step:1,skin:"round",onstatechange:function(d){changeProgress(d,$(".status",b).val(),b)}});if(c){c(b)}})}function changeStatus(c,b){var d;if(c==YET_TO_START){d=0}else{if(c==COMPLETED){d=100}else{if(c==IN_PROGRESS){d=1}}}changeProgress(d,c,b)}function changeProgress(d,c,b){$("#progress",b).val(d);showProgressSlider(d,c,b)}function showProgressSlider(d,c,b){if(d==100||c==COMPLETED){$(".status",b).val(COMPLETED);$("#progress",b).val(100);$("#is_complete",b).val(true)}else{$("#is_complete",b).val(false)}if(c==IN_PROGRESS){$(b).find(".progress-slider").css("display","block");if($(b).find(".jslider-label-to").is(":visible")){$(b).find(".jslider-label-to").hide()}}else{$(b).find(".progress-slider").css("display","none")}}function resetForm(b){$("#progress",b).val(0);$("#is_complete",b).val(false);$("#priority_type",b).val("NORMAL");$("#status",b).val(YET_TO_START);$(".progress_slider",b).slider("value",0)}function setForm(b){var c=$("#is_complete",b).val();if(c=="true"){showProgressSlider(100,COMPLETED,b)}else{showProgressSlider($("#progress",b).val(),$("#status",b).val(),b);$(".progress_slider",b).slider("value",$("#progress",b).val())}}function changeHeadingOfPage(b){$("#new-task-heading").html(b+'&nbsp<small class="tasks-count"></small>')}function removeLoadingIcon(b){if(b.owner_id){$("img[id='task-list-loading-img-"+b.heading+"-"+b.owner_id+"']").hide()}else{$("img[id='task-list-loading-img-"+b.heading+"-']").hide()}}function addTaskCount(d){if(!d.taskCollection){return}var b=d.taskCollection.at(0);if(!b){return}var c=b.get("count");displayTaskCount(c,d.heading,d.owner_id)}function displayTaskCount(c,d,b){if(c==0){c=""}if(b){$("span[id='task-count-"+d+"-"+b+"']").html(c);$("span[id='task-count-"+d+"-"+b+"']").attr("count",c)}else{$("span[id='task-count-"+d+"-']").html(c);$("span[id='task-count-"+d+"-']").attr("count",c)}}function changeTaskCount(e,b){var c=e.taskCollection.at(0);if(!c){return}var d=null;if(e.owner_id){d=$("span[id='task-count-"+e.heading+"-"+e.owner_id+"']").attr("count")}else{d=$("span[id='task-count-"+e.heading+"-']").attr("count")}if(d!=null){if(b){d++}else{d--}}else{d=1}displayTaskCount(d,e.heading,e.owner_id)}function dropdownintelligence(){changesOnCriteria();return changesOnOwner()}function changesOnCriteria(){var b=getCriteria();if(b=="OWNER"){$(".hide-on-status").show()}else{if(b=="STATUS"){$(".hide-on-owner").show();$(".hide-on-status").hide()}else{$(".hide-on-status").show();$(".hide-on-owner").show()}}}function changesOnOwner(){var b=$("#new-owner-tasks").data("selected_item");if(b=="all-pending-tasks"){$(".hide-on-pending").show();$(".hide-on-all-pending").hide();return true}else{if(b=="my-pending-tasks"||b==undefined){$(".hide-on-pending").hide();changeCriteriaToCategory();return true}else{if(b==CURRENT_DOMAIN_USER.id){$(".hide-on-pending").show();$(".hide-on-my-task").hide();changeCriteriaToCategory();return false}else{$(".hide-on-pending").show();return false}}}}function changeCriteriaToCategory(){var b=getCriteria();if(b!="OWNER"){return}$("#new-type-tasks").data("selected_item","CATEGORY");$("#new-type-tasks").closest(".btn-group").find(".selected_name").text("Category")}function adjustHeightOfTaskListAndScroll(){var b=$(window).height();$("#new-task-list-based-condition").height(b-155);$(".list-tasks").css("max-height",b-245)}function hideListViewAndShowLoading(){$("#new-task-list-based-condition").show();$("#task-list-based-condition").hide();$(".tasks-count").html("");var b=getCriteria();if(b&&b!="CALENDAR"){$("#task-calendar-based-condition").addClass("hide");$("#task-calendar-based-condition").html("");$("#calendarTasksButtons").addClass("hide")}$("#new-task-list-based-condition").html(LOADING_HTML)}function displayListView(){console.log("in displayListView");$("#new-task-list-based-condition").hide();$("#task-list-based-condition").show();$(".group-view").hide();$(".do-onclick-nothing").show();$(".list-view").hide();$(".calendar-view").show();$("#calendarTasksButtons").addClass("hide");var c=getParamsNew();var b=$("#new-owner-tasks").data("selected_item");if(b==undefined){c=c+"&pending="+true}console.log("url for list view: "+c);updateData(c)}function bindDropdownEvents(){$(".dropdown-menu").find(".group-view").on("click",function(b){b.stopImmediatePropagation()});$("ul#new-owner-tasks li a,ul#new-type-tasks .new-type-task").on("click",function(c){c.preventDefault();var b=$(this).html(),g=$(this).attr("href");var f=$(this).closest("ul").attr("id");if(f=="new-type-tasks"){$(this).closest("ul.main-menu").data("selected_item",g)}else{$(this).closest("ul").data("selected_item",g)}$(this).closest(".btn-group").find(".selected_name").text(b);var d=getCriteria();if(d&&d=="CALENDAR"&&!$(this).hasClass("calendar-view")){fullCalTasks.fullCalendar("refetchEvents");addDetailsInCookie(this);return}hideListViewAndShowLoading();if($(".type-task-button").hasClass("open")){$(".type-task-button").removeClass("open")}if(d=="CATEGORY"||d=="DUE"||d=="PRIORITY"){$(".list-view").css("display","");$(".calendar-view").css("display","")}if(TASKS_LIST_COLLECTION!=null){TASKS_LIST_COLLECTION.collection.reset()}addDetailsInCookie(this);setTimeout(function(){getDetailsForCollection()},2000)});$("ul#new-owner-tasks li a").on("click",function(){changeHeadingOfPage($("#new-owner-tasks").closest(".btn-group").find(".selected_name").html())})}function applyDetailsFromGroupView(){console.log("In applyDetailsFromGroupView");var b=_agile_get_prefs("task_criteria_forgroupview");var c=_agile_get_prefs("task_owner_forgroupview");console.log(b+" "+c);withoutEventChangeDropDowns(b,c,true);$(".group-view").hide();$(".do-onclick-nothing").show();$(".list-view").show();$(".calendar-view").show();var d=$("#new-owner-tasks").data("selected_item");addDetailsInCookie($("ul#new-owner-tasks").find("a[href="+d+"]"));addDetailsInCookie($("ul#new-type-tasks").find("a[href="+getCriteria()+"]"))}function withoutEventChangeDropDowns(b,e,c){console.log("In withoutEventChangeDropDowns");console.log(b+" "+e);if(b){var d=b.split("_");console.log(d);$("#new-type-tasks").data("selected_item",d[1]);$("#new-type-tasks").closest(".btn-group").find(".selected_name").text(d[0])}if(e){var d=e.split("_");console.log(d);$("#new-owner-tasks").data("selected_item",d[1]);$("#new-owner-tasks").closest(".btn-group").find(".selected_name").text(d[0])}if(!b&&!e&&c){$("#new-type-tasks").data("selected_item","DUE");$("#new-type-tasks").closest(".btn-group").find(".selected_name").text("Due")}changeHeadingOfPage($("#new-owner-tasks").closest(".btn-group").find(".selected_name").html());getDetailsForCollection()}function addTasklListDetails(c){console.log("In addTasklListDetails");console.log(c);if(!$(c).hasClass("list-bottom")){return}switch(getCriteria()){case"STATUS":$("#status",$("#taskForm")).val($(c).attr("heading"));changeStatus($(c).attr("heading"),$("#taskForm"));break;case"CATEGORY":$("#type",$("#taskForm")).val($(c).attr("heading"));break;case"OWNER":$("#owners-list",$("#taskForm")).val($(c).attr("ownerID"));break;case"DUE":var d=getNewDueDate($(c).attr("heading"));var b=getDateInFormatFromEpoc(d);$("#taskForm").find("input.date").val(b);break;case"PRIORITY":$("#priority_type",$("#taskForm")).val($(c).attr("heading"));break}}function displayCalendarView(){$(".calendar-view").hide();$(".group-view").hide();$(".do-onclick-nothing").show();$(".list-view").show();$("#new-task-list-based-condition").hide();$("#task-list-based-condition").hide();$("#task-calendar-based-condition").removeClass("hide");$("#calendarTasksButtons").removeClass("hide");var b=(!_agile_get_prefs("taskCalendarDefaultView_"+CURRENT_DOMAIN_USER.id))?"month":_agile_get_prefs("taskCalendarDefaultView_"+CURRENT_DOMAIN_USER.id);$("#"+b,$("#calendarTasksButtons")).addClass("bg-light");_agile_library_loader.load_fullcalendar_libs(function(){$("#task-calendar-based-condition").html("");getCalendarView();initilizeTasksCalendarViewListeners()})}function initialize_infinite_scrollbar(c,b){console.log("initialize_infinite_scrollbar");if(c==undefined||c==null){console.log("no elmnt");return}b.infiniScroll=new Backbone.InfiniScroll(b.collection,{target:c,untilAttr:"cursor",param:"cursor",strict:false,pageSize:b.page_size,success:function(e,d){console.log("in success");if(!e.last().get("cursor")){this.strict=true;b.infiniScroll.disableFetch()}displaySettings();$(b.infiniScroll.options.target.nextElementSibling).html("")},onFetch:function(){console.log("in fetch");$(b.infiniScroll.options.target.nextElementSibling).html('<div class="scroll-loading"> <img src="'+updateImageS3Path("/img/ajax-loader.gif")+'" style="margin-left: 44%;"> </div>')}})}function setCursor(f,d,e){console.log("In setCursor");if(!f.get("taskCollection")||f.get("taskCollection").length==0){return d}var c=f.get("taskCollection").length;var b=f.get("taskCollection").at(c-1).get("cursor");if(b){if(e=="dragged"||e==true){d.set({cursor:b})}else{if(d.attributes){d.attributes.cursor=b}else{d.cursor=b}}}return d}function editTask(e,d,g){console.log("editTask");var f;var b;if(g){f=getTaskList("OWNER",d,g)}else{f=getTaskList(null,d,null)
}if(f&&f.length){b=f[0].get("taskCollection").get(e).toJSON()}else{b=App_Calendar.allTasksListView.collection.get(e).toJSON()}if(!b){return}var c=b;c.taskListId=d;c.taskListOwnerId=g;$("#updateTaskModal").html(getTemplate("task-update-modal")).modal("show");loadProgressSlider($("#updateTaskForm"),function(h){deserializeForm(c,$("#updateTaskForm"));$(".update-task-timepicker").val(fillTimePicker(c.due));categories.getCategoriesHtml(c,function(j){$("#type",$("#updateTaskForm")).html(j);populateUsers("owners-list",$("#updateTaskForm"),c,"taskOwner",function(k){$("#updateTaskForm").find("#owners-list").html(k);if(c.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+c.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()})});showNoteOnForm("updateTaskForm",c.notes);displayTimeAgo($(".task-trello-list"))})}function updateTask(d,c,b){console.log("In updateTask");var g=getCriteria();var f=b[GROUPING_MAP[g].searchKey];if(g=="DUE"){f=getHeadingForDueTask(b)}if(g=="OWNER"&&parseInt(b.taskListOwnerId)==c.get("taskOwner").id){f=b.taskListId}if(b.taskListId!=undefined){if(f!=b.taskListId){changeTaskList(c,b,g,f,d);return}}if(d==true){var e;if(g=="OWNER"){e=getTaskList(g,b.taskListId,b.taskListOwnerId)}else{e=getTaskList(null,f,null)}if(!e){return}e[0].get("taskCollection").get(b.id).set(c);if(g=="OWNER"){$(".list-header[ownerID="+b.taskListOwnerId+"]").parent().find("#"+b.id).parent().html(getTemplate("task-model",c.toJSON()))}else{$("#"+f).find("#"+b.id).parent().html(getTemplate("task-model",c.toJSON()))}displaySettings();return}if(g=="OWNER"){addTaskToTaskList(f,c.toJSON(),g)}else{addTaskToTaskList(f,c,null)}}function changeTaskList(f,d,h,g,e){console.log("In changeTaskList");var c;if(h=="OWNER"){var b;if(d.taskListOwnerId){b=parseInt(d.taskListOwnerId)}else{b=d.taskOwner.id}if(!b){return}c=getTaskList(h,d.taskListId,b);g="taskOwner.name";$(".list-header[ownerID="+b+"]").parent().find("#"+d.id).remove()}else{c=getTaskList(null,d.taskListId,null);$("#"+d.taskListId).find("#"+d.id).remove()}if(!c){return}c[0].get("taskCollection").remove(c[0].get("taskCollection").get(d.id));addTaskToTaskList(g,f,e)}function completeTask(d,e,c){var j;var f;if(c){j=getTaskList("OWNER",e,c)}else{j=getTaskList(null,e,null)}if(j&&j.length){f=j[0].get("taskCollection").get(d).toJSON()}else{f=App_Calendar.allTasksListView.collection.get(d).toJSON()}if(!f){return}var k=f;if(k.status==COMPLETED||k.is_complete==true){return}var h=[];$.each(k.contacts,function(m,l){h.push(l.id)});var b=[];$.each(k.notes,function(l,m){b.push(m.id)});k.contacts=h;k.notes=b;k.is_complete=true;k.due=new Date(k.due).getTime();k.status=COMPLETED;k.progress=100;k.note_description="";if(k.taskOwner){k.owner_id=k.taskOwner.id}k.taskListId=e;if(c){k.taskListOwnerId=c}var g=new Backbone.Model();g.url="core/api/tasks";g.save(k,{success:function(l){getDueTasksCount(function(n){var m=n;if(m==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}if(m!=0){$("#due_tasks_count").html(m)}else{$("#due_tasks_count").html("")}});if(j&&j.length){updateTask(true,l,k)}else{App_Calendar.allTasksListView.collection.get(k).set(new BaseModel(l));App_Calendar.allTasksListView.render(true)}displaySettings()},error:function(m,l){showModalConfirmation("Complete Task",l.responseText,function(){return},function(){return},function(){return},"Cancel")}})}function startMakingCollection(c,b){console.log("in startMakingCollection");console.log(c+" "+b);if(c=="LIST"){displayListView();return}if(c=="CALENDAR"){displayCalendarView();return}hideListViewAndShowLoading();if(c=="OWNER"&&GROUPING_MAP[c].type.length==0){getUserDetails(function(d){findArrayForCollection(c,b)})}else{findArrayForCollection(c,b)}}function findArrayForCollection(c,b){if(c=="CATEGORY"){categories.getGroupingMap(function(d){GROUPING_MAP[c]=d;console.log("-------------------",d);createNestedCollection(c,GROUPING_MAP[c].type,b)})}else{createNestedCollection(c,GROUPING_MAP[c].type,b)}}function createNestedCollection(h,d,f){console.log("In createNestedCollection");initTaskListCollection();var c=null;if(h=="DUE"){c="/core/api/tasks/fordue"+getParamsNew()+"&pending="+f}else{c="/core/api/tasks/forcategory"+getParamsNew()+"&pending="+f}for(var e in d){var g;var b=null;if(h=="OWNER"){b=c+"&owner="+d[e].id;g={heading:d[e].name,owner_id:d[e].id,url:b,flag:true}}else{b=c+"&type="+d[e];g={heading:d[e],url:b,flag:true}}if(!g){return}TASKS_LIST_COLLECTION.collection.add(g)}$("#new-task-list-based-condition").html(TASKS_LIST_COLLECTION.render(true).el);fetchForNextTaskList()}function initTaskListCollection(){TASKS_LIST_COLLECTION=new Base_Collection_View({restKey:"task",templateKey:"new-tasks-lists",individual_tag_name:"div",className:"list-area-wrapper",sort_collection:false,postRenderCallback:function(b){$(".loading-img",b).remove();$(".loading",b).remove();adjustHeightOfTaskListAndScroll()}});TASKS_LIST_COLLECTION.appendItem=taskAppend}function taskAppend(c){var b=new Base_List_View({model:c,view:"inline",template:"new-tasks-lists-model",tagName:"div",className:"task-trello-list panel panel-default",id:c.get("heading")});var d=b.render().el;$("#new-tasks-lists-model-list",this.el).append(d);taskFetch(c)}function taskFetch(b){if(!b){return}var c=new Base_Collection_View({url:b.get("url"),templateKey:"task",individual_tag_name:"div",sort_collection:false,cursor:true,page_size:20,postRenderCallback:function(e){var d=false;if(b.has("owner_id")){d=$("div[id='list-tasks-"+b.get("heading")+"-"+b.get("owner_id")+"']")[0]}else{d=$("div[id='list-tasks-"+b.get("heading")+"']")[0]}if(d){removeLoadingIcon(b.toJSON());addTaskCount(b.toJSON());if(b.has("owner_id")){initialize_infinite_scrollbar($("div[id='list-tasks-"+b.get("heading")+"-"+b.get("owner_id")+"']")[0],c)}else{initialize_infinite_scrollbar($("div[id='list-tasks-"+b.get("heading")+"']")[0],c)}}}});c.collection.fetch({success:function(d){b.set("taskCollection",c.collection);if(b.has("owner_id")){$("div[id='list-tasks-"+b.get("heading")+"-"+b.get("owner_id")+"']").html(c.render(true).el)}else{$("div[id='list-tasks-"+b.get("heading")+"']").html(c.render(true).el)}adjustHeightOfTaskListAndScroll();displaySettings();setup_sortable_tasks()}})}function addTaskToTaskList(e,d,c){console.log("In addTaskToTaskList");var b;if(c=="OWNER"){b=getTaskList("OWNER",d.taskOwner.name,d.taskOwner.id);$(".task-list-loading-img-"+d.taskOwner.name+"-"+d.taskOwner.id,".task-trello-list").hide()}else{if((c=="dragged"||c==true)&&e=="taskOwner.name"){b=getTaskList("OWNER",d.get("taskOwner").name,d.get("taskOwner").id);$(".task-list-loading-img-"+d.get("taskOwner").name+"-"+d.get("taskOwner").id,".task-trello-list").hide()}else{b=getTaskList(null,e,null);$(".task-list-loading-img-"+e+"-",".task-trello-list").hide()}}if(!b){return}d=setCursor(b[0],d,c);if(c=="dragged"){b[0].get("taskCollection").add(d.toJSON(),{silent:true})}else{b[0].get("taskCollection").add(d);changeTaskCount(b[0].toJSON(),true)}displaySettings()}function deleteTask(c,b,f){var e;if(f){e=getTaskList("OWNER",b,f)}else{e=getTaskList(null,b,null)}if(e&&e.length){var d=e[0].get("taskCollection").get(c);d.url="/core/api/tasks/"+c;d.destroy({success:function(h,g){displayTimeAgo($(".task-trello-list"));changeTaskCount(e[0].toJSON(),false);getDueTasksCount(function(k){var j=k;if(j==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","inline-block")}if(j!=0){$("#due_tasks_count").html(j)}else{$("#due_tasks_count").html("")}})},error:function(h,g){updateTask(false,h,h.toJSON());TASKS_LIST_COLLECTION.render(true);showModalConfirmation("Delete Task",g.responseText,function(){return},function(){return},function(){return},"Cancel")}})}else{$.ajax({type:"DELETE",url:"core/api/tasks/"+c,async:false,dataType:"json",success:function(){App_Calendar.allTasksListView.collection.remove(c);App_Calendar.allTasksListView.render(true);var h=App_Calendar.allTasksListView.collection.length;var g=$("#tasks-list-template").find(".tasks-count").attr("data");if(g){g=g-1;$("#tasks-list-template").find(".tasks-count").removeAttr("data");$("#tasks-list-template").find(".tasks-count").attr("data",g);$("#tasks-list-template").find(".tasks-count").text("("+g+" "+_agile_get_translated_val("other","total")+")")}}})}}function fetchForNextTaskList(){if(IS_FECHING_DONE){return}var c=getCriteria();var b=GROUPING_MAP[c].type;if(FETCH_COUNTER<b.length){taskFetch(FETCH_COUNTER)}if(FETCH_COUNTER>=b.length){IS_FECHING_DONE=true}}$(function(){$("body").on("click",".task-add-note, .deal-add-note",function(c){c.preventDefault();var d=getTaskFormId(this);var b=this;getTemplate("note-form",{},undefined,function(e){if(!e){return}$("#forNoteForm","#"+d).html($(e));$(".deal-note-label").show()},$("#forNoteForm","#"+d))})});function showNoteOnForm(c,b){console.log("showNoteOnForm");$.each(b,function(d,e){getTemplate("notes-for-task",e,undefined,function(f){if(!f){return}$("#notes","#"+c).append($(f))},null)})}function get_notes(c){var b=$("#"+c+" .notes").map(function(){var d=[];$.each($(this).children(),function(e,f){d.push(($(f).attr("data")).toString())});return{name:$(this).attr("name"),value:d}}).get();return b}function setup_sortable_tasks(){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".task-model-list").sortable({connectWith:".task-model-list",cursor:"move",scroll:false,helper:"clone",placeholder:"ui-sortable-placeholder",forcePlaceholderSize:true,revert:true,start:function(c,b){b.placeholder.height(b.item.height())},beforeStop:function(b,c){if($(c.helper).closest(".task-trello-list").find(".list-header").attr("attr")===$(c.placeholder).closest(".task-trello-list").find(".list-header").attr("attr")){if($(c.helper).closest(".task-trello-list").find(".list-header").attr("ownerID")){if($(c.helper).closest(".task-trello-list").find(".list-header").attr("ownerID")===$(c.placeholder).closest(".task-trello-list").find(".list-header").attr("ownerID")){return false
}}else{return false}}},change:function(c,d){var b=$(".list-area-wrapper > div").width();var e=$(".list-area-wrapper > div").scrollLeft();if(c.pageX>(b*0.9)){$(".list-area-wrapper > div").scrollLeft(e+100)}else{if(c.pageX<(b*0.2)){$(".list-area-wrapper > div").scrollLeft(e-105)}}},update:function(b,c){if(c.sender==null){return}changeAfterDrop(b,c)}}).disableSelection()})}function changeAfterDrop(b,k){var o=k.item[0];var g=k.sender[0];var p=getTaskListId(g);var f=getTaskListId(o);var e=getTaskListOwnerId(g);var n=getTaskListOwnerId(o);var l=getCriteria();var j=false;if(l=="OWNER"&&e!=n){j=true}else{if(p!=f){j=true}}if(j){var d=GROUPING_MAP[l].searchKey;var h=$(o).find(".listed-task").attr("id");var m=getTaskList(l,p,e);var c=m[0].get("taskCollection").get(h).toJSON();updateDraggedTask(c,l,e,p,f,n,h,d);changeTaskCount(m[0].toJSON(),false)}}function updateDraggedTask(b,h,d,l,e,k,g,c){if(c=="due"){if(b.taskOwner){b.owner_id=b.taskOwner.id}b.due=getNewDueDateBasedOnTime(e,b.due)}else{if(c=="taskOwner.name"){b.owner_id=k;b.taskListOwnerId=d}else{if(b.taskOwner){b.owner_id=b.taskOwner.id}b[c]=e;if(c=="status"){b.progress=getProgressValue(e);if(e=="COMPLETED"){b.is_complete=true}else{b.is_complete=false}}}}b.taskListId=l;var j=[];$.each(b.contacts,function(n,m){j.push(m.id)});var f=[];$.each(b.notes,function(m,n){f.push(n.id)});b.contacts=j;b.notes=f;b.due=new Date(b.due).getTime();saveAfterDrop(b,h,e,k,g)}function saveAfterDrop(e,g,f,c,d){var b=new Backbone.Model();b.url="core/api/tasks";b.save(e,{success:function(j){updateTask("dragged",j,e);if(g=="OWNER"){$(".list-header[ownerID="+c+"]").parent().find("#"+d).parent().html(getTemplate("task-model",j.toJSON()))}else{$("#"+f).find("#"+d).parent().html(getTemplate("task-model",j.toJSON()))}displaySettings();var h=getTaskList(g,f,c);changeTaskCount(h[0].toJSON(),true);getDueTasksCount(function(l){var k=l;if(k==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","block")}if(k!=0){$("#due_tasks_count").html(k)}else{$("#due_tasks_count").html("")}})},error:function(j,h){showModalConfirmation("Update Task",h.responseText,function(){getDetailsForCollection()},function(){return},function(){return},"Cancel")}})}var Email_Template_Events=Base_Model_View.extend({events:{"click .merge-field":"onMergeFieldSelect","click .add-attachment-select":"onAddAttachmentSelect","click .add-attachment-confirm":"onAddAttachmentConfirm","click .add-attachment-cancel":"onAddAttachmentCancel","click .add-tpl-attachment-confirm":"onTemplateAddAttachmentConfirm","click .add-tpl-attachment-cancel":"onTemplateAddAttachmentCancel","change #attachment-select":"onChangedAttachment",},onMergeFieldSelect:function(c){c.preventDefault();var b=$(c.currentTarget).attr("name");var d=$("#email-template-html").val();var f=$("#email-template-html").data("wysihtml5");if(f){editor.focus();f.editor.composer.commands.exec("insertHTML","{{"+b+"}}")}},onAddAttachmentSelect:function(g){g.preventDefault();var b=$(g.currentTarget);var f=$(b).closest("div");$(b).css("display","none");f.find(".attachment-document-select").css("display","inline");var c="<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}'>{{name}}</option>";fillSelect("attachment-select","core/api/documents","documents",function d(){f.find("#attachment-select option:first").after("<option value='new'>"+_agile_get_translated_val("others","upload-new-doc")+"</option>")},c,false,f);$("#enable_tracking").css("margin-top","-7px")},onAddAttachmentConfirm:function(h){h.preventDefault();var f=$(h.currentTarget);var d=$("#attachment-select").find(":selected").attr("network_type");var k=$("#attachment-select").find(":selected").attr("size");if(typeof d!=="undefined"&&d.toUpperCase()==="GOOGLE"){$(f).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>"+_agile_get_translated_val("documents","gd-error")+"</span>");$(f).css({border:"1px solid #df382c",outline:"none"})}else{if(k>=5242880){$(f).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>"+_agile_get_translated_val("documents","size-exceed-error")+"</span>");$(f).css({border:"1px solid #df382c",outline:"none"})}else{$("#attachment-select").closest("span").find(".attachment-status").find("span").fadeOut(0);$("#attachment-select").css({border:"1px solid #bbb"});var g=$(f).closest(".attachment-document-select").find("#attachment-select").val();var j=$(f);if(g==""){j.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>"+_agile_get_translated_val("validation-msgs","required")+"</span>");j.closest("span").find("span.save-status").find("span").fadeOut(5000);return}else{if(g=="new"){h.preventDefault();$(f).closest("form").find("#error").html("");var m=$(f).closest("form").attr("id");var c=$(f).find("a").attr("id");var l=window.open("upload-attachment.jsp?id="+m+"&t="+CURRENT_USER_PREFS.template+"&d="+CURRENT_DOMAIN_USER.domain,"name","height=310,width=500");if(window.focus){l.focus()}}else{if(g!=undefined&&g!=null){var b=$("#attachment-select option:selected").text();$("#emailForm").find("#eattachment").css("display","block");$("#emailForm").find("#attachment_id").find("#attachment_fname").text(b);$("#emailForm").find(".attachment-document-select").css("display","none");$("#emailForm").find("#eattachment_key").attr("name","document_key");$("#emailForm").find("#eattachment_key").attr("value",g);$("#emailForm").find("#agile_attachment_name").attr("value",b);$("#emailForm").find("#agile_attachment_url").attr("value",$("#attachment-select option:selected").attr("url"))}}}}}$("#enable_tracking").css("margin-top","-47px")},onAddAttachmentCancel:function(g){g.preventDefault();var b=$(g.currentTarget);var c=$("#emailForm").find("#attachment_id").attr("name");if(typeof c!==typeof undefined){if(c.toLowerCase()==="blob_key"){var d=$("#emailForm").find("#eattachment_key").attr("value");deleteBlob(d)}}$("#attachment-select").closest("span").find(".attachment-status").find("span").fadeOut(0);$("#attachment-select").css({border:"1px solid #bbb"});$("#attachment-select").find("option:first").attr("selected","selected");var f=$(b).closest("div");$("#emailForm").find(".attachment-document-select").css("display","none");$("#emailForm").find("#eattachment").css("display","none");$("#emailForm").find(".add-attachment-select").css("display","inline");$("#emailForm").find("#eattachment_key").attr("name","name");$("#emailForm").find("#eattachment_key").attr("value","value");$("#emailForm").find("#agile_attachment_name").attr("value","");$("#emailForm").find("#agile_attachment_url").attr("value","");$("#enable_tracking").css("margin-top","-7px")},onTemplateAddAttachmentConfirm:function(c){c.preventDefault();var b=$(c.currentTarget);if($(b).parent().find("select").val()=="new"){$("#uploadDocumentModal").html(getTemplate("upload-document-modal",{})).modal("show");$("#GOOGLE",$("#uploadDocumentModal")).parent().hide()}else{if($(b).parent().find("select").val()!=""){$("#tpl-attachment-select").hide();$("#tpl-attachment-name").show();$("#attachment_id",$("#tpl-attachment-name")).val($(b).parent().find("select").val());$("#tpl_attachment_fname",$("#tpl-attachment-name")).html("<a href="+$(b).parent().find("option:selected").attr("url")+">"+$(b).parent().find("option:selected").text()+"</a>")}else{if($(b).parent().find("select").val()==""){$("#attachment-select-required").show()}}}},onTemplateAddAttachmentCancel:function(c){c.preventDefault();var b=$(c.currentTarget);$("#tpl-attachment-select").show();$("#tpl-attachment-name").hide();$(".add-attachment-select").show();$(".attachment-document-select").hide();$("#attachment_id",$("#tpl-attachment-name")).val("")},onChangedAttachment:function(c){c.preventDefault();var b=$(c.currentTarget);if($(b).val()==""){$("#attachment-select-required").show()}else{$("#attachment-select-required").hide()}},});function setupHTMLEditor(b,c){head.js(LIB_PATH+"lib/wysihtml5-0.3.0-min.js",LIB_PATH+"lib/bootstrap-wysihtml5-min.js",function(){console.log("setting up text");console.log(b.html());if(!$(b).data("wysihtml5")){b.wysihtml5()}if(c){b.data("wysihtml5").editor.setValue(c,false)}})}$(function(){$("#activityTaskModal,#activityModal,#updateActivityModal").on("click","#activityForm #allDay, #updateActivityForm #allDay",function(b){if($(this).is(":checked")){$("#activityForm #event-time-1").closest(".control-group").hide();$("#activityForm #event-date-2").closest(".row").hide()}else{$("#activityForm #event-time-1").closest(".control-group").show();$("#activityForm #event-date-2").closest(".row").show()}if($(this).is(":checked")){$("#updateActivityForm #update-event-time-1").closest(".control-group").hide();$("#updateActivityForm #update-event-date-2").closest(".row").hide()}else{$("#updateActivityForm #update-event-time-1").closest(".control-group").show();$("#updateActivityForm #update-event-date-2").closest(".row").show()}});$("#activityTaskModal,#activityModal").on("click","#task_event_validate",function(c){c.preventDefault();console.log(this);if($("#hiddentask").val()=="task"){save_task("taskForm","activityTaskModal",false,this)}else{var b=$("#activityModal").find("#current_div").val();save_event("activityForm","activityModal",false,this,b,function(d){eventCollectionView.collection.add(d.toJSON());eventCollectionView.collection.sort()})}})});function initializeActivitiesListner(b){$("#activities-listners").off();$("#activities-listners").on("click","ul#user-select li a, ul#entity_type li a",function(f){f.preventDefault();var d=$(this).html(),g=$(this).attr("href");$(this).closest("ul").data("selected_item",g);$(this).closest(".btn-group").find(".selected_name").text(d);var c=getActivityFilterParameters();renderActivityView(c)});$("#activities-listners").on("click","ul#entity_type li a",function(d){var f=$(this).html();var c=$(this).attr("href");buildActivityFilters(f,c,"entityDropDown");$(".activity-sub-heading").html(f)
});$("#activities-listners").on("click","ul#user-select li a",function(f){var d=$(this).html();var c=$(this).attr("href");buildActivityFilters(d,c,"userDropDown")});$("#activities-listners").on("click",".activity-event-edit",function(d){d.preventDefault();var c=$(this).closest("a").attr("data");getEventObject(c,function(e){update_event_activity(e)})});$("#activities-listners").on("click",".email-details",function(d){d.preventDefault();var c=$(this).closest("a").attr("data");getActivityObject(c,function(e){console.log(e);getTemplate("infoModal",e,undefined,function(g){if(!g){return}var f=$(g);f.modal("show")},null)})});$("#activities-listners").on("click",".ticket-activity-notes",function(c){c.preventDefault();var f=$(this).data("id");var d=activitiesview.collection.get(f).toJSON();getTemplate("ticket-activity-notes-modal",d,undefined,function(g){if(!g){return}var e=$(g);e.modal("show")},null)})}function getEventObject(c,b){$.ajax({type:"GET",url:"core/api/events/getEventObject/"+c,success:function(d){if(b&&typeof(b)==="function"){b(d)}}})}function getActivityObject(c,b){$.ajax({type:"GET",url:"core/api/activitylog/"+c,success:function(d){if(b&&typeof(b)==="function"){b(d)}}})}function update_event_activity(e){$("#updateActivityModal").html(getTemplate("update-activity-modal"));var d=e;deserializeForm(d,$("#updateActivityForm"));$(".update-start-timepicker").val(fillTimePicker(d.start));$(".update-end-timepicker").val(fillTimePicker(d.end));$("#updateActivityModal").modal("show");if(d.type=="WEB_APPOINTMENT"&&parseInt(d.start)>parseInt(new Date().getTime()/1000)){$("[id='event_delete']").attr("id","delete_web_event");web_event_title=d.title;if(d.contacts.length>0){var f=getPropertyValue(d.contacts[0].properties,"first_name");if(f==undefined){f=""}var c=getPropertyValue(d.contacts[0].properties,"last_name");if(c==undefined){c=""}web_event_contact_name=f+" "+c}}else{$("[id='delete_web_event']").attr("id","event_delete")}if(d.description){var b='<label class="control-label"><b>'+_agile_get_translated_val("misc-keys","description")+' </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div>';$("#event_desc").html(b);$("textarea#description").val(d.description)}else{var g='<div class="row-fluid"><div class="control-group form-group m-b-none"><a href="#" id="add_event_desctiption"><i class="icon-plus"></i> '+_agile_get_translated_val("misc-keys","add-description")+' </a><div class="controls event_discription hide"><textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div></div></div>';$("#event_desc").html(g)}populateUsersInUpdateActivityModal(d)}function getModal(){var b=App_Activity_log.activitiesview.collection.models[this];alert(b);console.log(b)}function updateactivity__task(c){var b=JSON.parse(c);$("#updateTaskModal").html(getTemplate("task-update-modal")).modal("show");loadProgressSlider($("#updateTaskForm"),function(d){deserializeForm(b,$("#updateTaskForm"));populateUsers("owners-list",$("#updateTaskForm"),b,"taskOwner",function(e){$("#updateTaskForm").find("#owners-list").html(e);if(b.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+b.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()});showNoteOnForm("updateTaskForm",b.notes)})}function updatedeals(d){var c=JSON.parse(d);console.log(c);add_recent_view(new BaseModel(c));var b=$("#opportunityUpdateForm");$("#opportunityUpdateForm")[0].reset();deserializeForm(c,$("#opportunityUpdateForm"));$("#opportunityUpdateModal").modal("show");agile_type_ahead("relates_to",b,contacts_typeahead);populateUsers("owners-list",b,c,"owner",function(e){b.find("#owners-list").html(e);if(c.owner){$("#owners-list",b).find("option[value="+c.owner.id+"]").attr("selected","selected");$("#owners-list",$("#opportunityUpdateForm")).closest("div").find(".loading-img").hide()}});populateTracks(b,undefined,c,function(e){populateMilestones(b,undefined,c.pipeline_id,c,function(f){b.find("#milestone").html(f);if(c.milestone){$("#milestone",b).find('option[value="'+c.milestone+'"]').attr("selected","selected")}$("#milestone",b).closest("div").find(".loading-img").hide()})});showNoteOnForm("opportunityUpdateForm",c.notes);add_custom_fields_to_form(c,function(f){var e=show_custom_fields_helper(f.custom_fields,[]);$("#custom-field-deals",b).html(fill_custom_fields_values_generic($(e),c.custom_data))},"DEAL")}function get_activity_created_time(c){var b=new Date();b.setHours(0,0,0,0);b=b.getTime()/1000;return Math.floor((c-b)/(24*3600))}function append_activity_log(b){var c=new Base_List_View({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"li",});var e=get_activity_created_time(b.get("time"));if(e==0){$("#earllier").show();$("#next-week-heading").addClass("ref-head");var d=$("#today-heading",this.el);$("#today-activity",this.el).append(c.render().el);$("#today-activity",this.el).parent("table").css("display","block");$("#today-activity",this.el).show();$("#today-heading",this.el).show()}if(e==-1){$("#earllier").show();$("#next-week-heading").addClass("ref-head");var d=$("#tomorrow-heading",this.el);$("#tomorrow-activity",this.el).append(c.render().el);$("#tomorrow-activity",this.el).parent("table").css("display","block");$("#tomorrow-activity",this.el).show();$("#tomorrow-heading",this.el).show()}if(e<-1){var d=$("#next-week-heading",this.el);$("#next-week-activity",this.el).append(c.render().el);$("#next-week-activity",this.el).parent("table").css("display","block");$("#next-week-activity",this.el).show();$("#next-week-heading",this.el).show()}}function getCalendarView(){App_Calendar.allTasksCalendarView={};var b=(!_agile_get_prefs("taskCalendarDefaultView_"+CURRENT_DOMAIN_USER.id))?"month":_agile_get_prefs("taskCalendarDefaultView_"+CURRENT_DOMAIN_USER.id);fullCalTasks=$("#task-calendar-based-condition").fullCalendar({monthNames:$.fn.datepicker.dates.en.months,monthNamesShort:$.fn.datepicker.dates.en.monthsShort,dayNames:$.fn.datepicker.dates.en.days,dayNamesShort:$.fn.datepicker.dates.en.daysShort,events:function(f,c,e){var d="core/api/tasks/calendar/";d+=getParamsNew();d+="&start_time="+f.getTime()/1000+"&end_time="+c.getTime()/1000;$.ajax({url:d,dataType:"json",success:function(h){if(h){var g=[];$.each(h,function(j,k){setCalendarTaskColors(k);g.push(k)});App_Calendar.allTasksCalendarView=new Base_Collection_View({data:g});e(App_Calendar.allTasksCalendarView.collection.toJSON())}hideTransitionBar()}})},header:{left:"prev",center:"title",right:"next"},defaultView:b,slotEventOverlap:false,viewDisplay:function(c){_agile_set_prefs("taskCalendarDefaultView_"+CURRENT_DOMAIN_USER.id,c.name,90);$(".fc-agenda-axis").addClass("bg-light lter")},loading:function(c){if(c){pushLoading();$("#loading_calendar_events").remove();$(".fc-header-left","#task-calendar-based-condition").append('<span id="loading_calendar_events" style="margin-left:5px;vertical-align:middle;padding-top: 5px;position: absolute;">Loading...</span>').show();$(".fc-header-left","#task-calendar-based-condition").show()}else{if(popLoading()<=0){$("#loading_calendar_events").hide();start_tour("calendar")}}$(".fc-agenda-axis").addClass("bg-light lter");$(".ui-resizable-handle").hide()},selectable:true,selectHelper:true,editable:true,theme:false,contentHeight:400,firstDay:CALENDAR_WEEK_START_DAY,firstHour:7,themeButtonIcons:{prev:"fc-icon-left-single-arrow",next:"fc-icon-right-single-arrow"},eventMouseover:function(c,l,n){b=(!_agile_get_prefs("taskCalendarDefaultView_"+CURRENT_DOMAIN_USER.id))?"month":_agile_get_prefs("taskCalendarDefaultView_"+CURRENT_DOMAIN_USER.id);var o="";var j="";if(c.contacts!=null){if(c.contacts.length>0){o+='<i class="icon-user text-muted m-r-xs"></i>'}for(var g=0;g<c.contacts.length;g++){if(c.contacts[g].entity_type=="contact_entity"){var r=getPropertyValue(c.contacts[g].properties,"last_name");if(r==undefined){r=""}if(c.contacts[g].type=="COMPANY"){o+='<a class="text-info" href="#company/'+c.contacts[g].id+'">'+getPropertyValue(c.contacts[g].properties,"name")+"</a>"}else{o+='<a class="text-info" href="#contact/'+c.contacts[g].id+'">'+getPropertyValue(c.contacts[g].properties,"first_name")+" "+r+"</a>"}}else{o+='<a class="text-info" href="#contact/'+c.contacts[g].id+'">'+getPropertyValue(c.contacts[g].properties,"name")+"</a>"}if(g!=c.contacts.length-1){o+=", "}}}var k="left";var q="";var p="";var d=300;if(c.meeting_type&&c.description){j='<i class="icon-comment-alt text-muted m-r-xs"></i><span>'+_agile_get_translated_val("events","meeting-type")+" - "+c.meeting_type+"</span><br/><span title="+c.description+">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+addDotsAtEnd(c.description)+"</span>"}else{if(c.description){j='<i class="icon-comment-alt text-muted m-r-xs"></i><span title='+c.description+">"+addDotsAtEnd(c.description)+"</span>"}}if(b=="month"){d=$(this).parents(".fc-view-month").find(".fc-widget-content").eq(0).width()*2;var f=l.currentTarget.offsetLeft+l.currentTarget.offsetWidth+10;var m=l.currentTarget.offsetTop;if($(this).parents(".fc-view-month").find(".fc-border-separate:visible").width()-f<d){f=l.currentTarget.offsetLeft-d-10;k="right"}if($(this).parents(".fc-view-month").find(".fc-border-separate:visible").width()-d-20<l.currentTarget.offsetWidth){f=((l.currentTarget.offsetLeft+l.currentTarget.offsetWidth+10)/2)-(d/2);m=l.currentTarget.offsetTop+l.currentTarget.offsetHeight+10;k="top"}if(c.type=="officeCalendar"){var p='<div class="fc-overlayw '+k+'" style="min-width:'+d+"px;max-width:"+d+"px;left:"+f+"px;top:"+m+'px;position:absolute;z-index:10;display:none;"><div class="panel bg-white b-a pos-rlt p-sm"><span class="arrow '+k+" "+q+'" style="top:11px;"></span><div class="m-b-sm"><div class="pull-left text-flow-ellipsis p-b-xs" style="width:100%;">'+c.title+'</div></div><div><i class="icon-clock text-muted m-r-xs"></i>'+c.start.format("dd-mmm-yyyy HH:MM")+'</div><div class="text-ellipsis">'+o+'</div><div class="text-ellipsis">'+j+"</div></div></div>";
$(this).after(p)}else{var p='<div class="fc-overlayw '+k+'" style="width:100%;min-width:'+d+"px;max-width:"+d+"px;left:"+f+"px;top:"+m+'px;position:absolute;z-index:10;display:none;"><div class="panel bg-white b-a pos-rlt p-sm"><span class="arrow '+k+" "+q+'" style="top:11px;"></span><div class="h4 font-thin m-b-sm"><div class="pull-left text-ellipsis p-b-xs" style="width:100%;">'+c.title+'</div></div><div class="line b-b b-light"></div><div><i class="icon-clock text-muted m-r-xs"></i>'+c.start.format("dd-mmm-yyyy HH:MM")+'<div class="pull-right" style="width:10%;"><img class="r-2x" src="'+c.eventOwner.pic+'" height="20px" width="20px" title="'+c.taskOwner.name+'"/></div></div><div class="text-ellipsis">'+o+'</div><div class="text-ellipsis">'+j+"</div></div></div>";$(this).after(p)}if($(this).parents(".fc-view-month").find(".fc-border-separate:visible").height()-l.currentTarget.offsetTop<$(this).parent().find(".fc-overlayw").height()){$(this).parent().find(".fc-overlayw").css("top",m-$(this).parent().find(".fc-overlayw").height()+l.currentTarget.offsetHeight+20+"px");$(this).parent().find(".fc-overlayw").find(".arrow").css("top",$(this).parent().find(".fc-overlayw").height()-31+"px")}if($(this).parents(".fc-view-month").find(".fc-border-separate:visible").width()-d-20<l.currentTarget.offsetWidth){$(this).parent().find(".fc-overlayw").find(".arrow").css("top","-9px")}if(($(this).parents(".fc-view-month").find(".fc-border-separate:visible").height()-l.currentTarget.offsetTop-l.currentTarget.offsetHeight-10<$(this).parent().find(".fc-overlayw").height()+10)&&($(".fc-border-separate:visible").width()-d-20<l.currentTarget.offsetWidth)){$(this).parent().find(".fc-overlayw").find(".arrow").removeClass("top").addClass("bottom");f=((l.currentTarget.offsetLeft+l.currentTarget.offsetWidth+10)/2)-(d/2);m=l.currentTarget.offsetTop-$(this).parent().find(".fc-overlayw").height()+10;$(this).parent().find(".fc-overlayw").css({top:m+"px",lef:f+"px"});$(this).parent().find(".fc-overlayw").find(".arrow").css("top",$(this).parent().find(".fc-overlayw").height()-22+"px")}}else{if(b=="agendaWeek"){d=$(".fc-view-agendaWeek").find(".fc-widget-content").eq(0).width()*2;var f=l.currentTarget.offsetLeft+l.currentTarget.offsetWidth+10;var m=l.currentTarget.offsetTop;if($(".fc-agenda-slots:visible").width()-f<d){f=l.currentTarget.offsetLeft-d-10;k="right"}if(c.type=="officeCalendar"){var p='<div class="fc-overlayw '+k+'" style="min-width:'+d+"px;max-width:"+d+"px;left:"+f+"px;top:"+m+'px;position:absolute;z-index:10;display:none;"><div class="panel bg-white b-a pos-rlt p-sm"><span class="arrow '+k+" "+q+'" style="top:11px;"></span><div class="m-b-sm"><div class="pull-left text-flow-ellipsis p-b-xs" style="width:100%;">'+c.title+'</div></div><div><i class="icon-clock text-muted m-r-xs"></i>'+c.start.format("dd-mmm-yyyy HH:MM")+'</div><div class="text-ellipsis">'+o+'</div><div class="text-ellipsis">'+j+"</div></div></div>";$(this).after(p)}else{var p='<div class="fc-overlayw '+k+'" style="width:100%;min-width:'+d+"px;max-width:"+d+"px;left:"+f+"px;top:"+m+'px;position:absolute;z-index:10;display:none;"><div class="panel bg-white b-a pos-rlt p-sm"><span class="arrow '+k+" "+q+'" style="top:11px;"></span><div class="h4 font-thin m-b-sm"><div class="pull-left text-ellipsis p-b-xs" style="width:100%;">'+c.title+'</div></div><div class="line b-b b-light"></div><div><i class="icon-clock text-muted m-r-xs"></i>'+c.start.format("dd-mmm-yyyy HH:MM")+'<div class="pull-right" style="width:10%;"><img class="r-2x" src="'+c.eventOwner.pic+'" height="20px" width="20px" title="'+c.taskOwner.name+'"/></div></div><div class="text-ellipsis">'+o+'</div><div class="text-ellipsis">'+j+"</div></div></div>";$(this).after(p)}if($(".fc-agenda-slots:visible").height()-l.currentTarget.offsetTop<$(this).parent().find(".fc-overlayw").height()){$(this).parent().find(".fc-overlayw").css("top",m-$(this).parent().find(".fc-overlayw").height()+l.currentTarget.offsetHeight+20+"px");$(this).parent().find(".fc-overlayw").find(".arrow").css("top",$(this).parent().find(".fc-overlayw").height()-31+"px")}}else{if(b=="agendaDay"){var f=l.currentTarget.offsetLeft;var m=l.currentTarget.offsetTop+l.currentTarget.offsetHeight+10;k="top";if($(".fc-agenda-slots:visible").width()-l.currentTarget.offsetLeft<d){f=l.currentTarget.offsetLeft-l.currentTarget.offsetWidth-($(".fc-agenda-slots:visible").width()-l.currentTarget.offsetLeft-l.currentTarget.offsetWidth)}if(c.type=="officeCalendar"){var p='<div class="fc-overlayw '+k+'" style="min-width:'+d+"px;max-width:"+d+"px;left:"+f+"px;top:"+m+'px;position:absolute;z-index:10;display:none;"><div class="panel bg-white b-a pos-rlt p-sm"><span class="arrow '+k+" "+q+'" style="top:11px;"></span><div class="m-b-sm"><div class="pull-left text-flow-ellipsis p-b-xs" style="width:100%;">'+c.title+'</div></div><div><i class="icon-clock text-muted m-r-xs"></i>'+c.start.format("dd-mmm-yyyy HH:MM")+'</div><div class="text-ellipsis">'+o+'</div><div class="text-ellipsis">'+j+"</div></div></div>";$(this).after(p)}else{try{var p='<div class="fc-overlayw '+k+'" style="width:100%;min-width:'+d+"px;max-width:"+d+"px;left:"+f+"px;top:"+m+'px;position:absolute;z-index:10;display:none;"><div class="panel bg-white b-a pos-rlt p-sm"><span class="arrow '+k+" "+q+'" style="top:11px;"></span><div class="h4 font-thin m-b-sm"><div class="pull-left text-ellipsis p-b-xs" style="width:100%;">'+c.title+'</div></div><div class="line b-b b-light"></div><div><i class="icon-clock text-muted m-r-xs"></i>'+c.start.format("dd-mmm-yyyy HH:MM")+'<div class="pull-right" style="width:10%;"><img class="r-2x" src="'+c.eventOwner.pic+'" height="20px" width="20px" title="'+c.taskOwner.name+'"/></div></div><div class="text-ellipsis">'+o+'</div><div class="text-ellipsis">'+j+"</div></div></div>";$(this).after(p)}catch(h){}}$(this).parent().find(".fc-overlayw").find(".arrow").css({top:"-9px",left:"11px"});if($(".fc-agenda-slots:visible").width()-l.currentTarget.offsetLeft<d){$(this).parent().find(".fc-overlayw").find(".arrow").css({top:"-9px",left:d-15+"px"})}if((l.currentTarget.offsetTop<$(this).parent().find(".fc-overlayw").height()+10)&&($(".fc-agenda-slots:visible").height()-l.currentTarget.offsetHeight<$(this).parent().find(".fc-overlayw").height()+10)){$(this).parent().find(".fc-overlayw").css("top",l.currentTarget.offsetTop+40+"px")}if((l.currentTarget.offsetTop>$(this).parent().find(".fc-overlayw").height()+10)&&($(".fc-agenda-slots:visible").height()-(l.currentTarget.offsetHeight+l.currentTarget.offsetTop)<$(this).parent().find(".fc-overlayw").height()+10)){$(this).parent().find(".fc-overlayw").find(".arrow").removeClass("top").addClass("bottom");$(this).parent().find(".fc-overlayw").find(".arrow").css("top",$(this).parent().find(".fc-overlayw").height()-22+"px");$(this).parent().find(".fc-overlayw").css("top",$(".fc-agenda-slots:visible").height()-l.currentTarget.offsetHeight-$(this).parent().find(".fc-overlayw").height()+7+"px");if($(".fc-agenda-slots:visible").width()-l.currentTarget.offsetLeft<d){$(this).parent().find(".fc-overlayw").css("left",l.currentTarget.offsetLeft-l.currentTarget.offsetWidth-($(".fc-agenda-slots:visible").width()-l.currentTarget.offsetLeft-l.currentTarget.offsetWidth)+"px")}}}}}$(l.currentTarget).css("z-index",9);if(c.allDay){$(l.currentTarget.parentElement).css("z-index",9)}$(this).parent().find(".fc-overlayw").show()},eventMouseout:function(e,d,c){$(this).parent().find(".fc-overlayw").remove();$(this).find(".ui-resizable-handle").hide();$(d.currentTarget).css("z-index",8);if(e.allDay){$(d.currentTarget.parentElement).css("z-index",8)}},eventAfterRender:function(f,e,c){$(".ui-resizable-handle").hide();f=renderEventBasedOnOwner(f);var d=new Date(f.start).getTime()/1000;var g=new Date(f.end).getTime()/1000;if(g-d==3600){$(e).height("")}$(e).find(".fc-event-bg").hide()},select:function(e,c,d){b=(!_agile_get_prefs("taskCalendarDefaultView_"+CURRENT_DOMAIN_USER.id))?"month":_agile_get_prefs("taskCalendarDefaultView_"+CURRENT_DOMAIN_USER.id);showTaskModal(this);$("#task-date-1").val(getDateInFormatFromEpoc(e.getTime()));if(b=="agendaDay"){head.js(CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){$(".new-task-timepicker").timepicker({timeFormat:"H:i",step:15});$(".new-task-timepicker").focus(function(){$("#activityTaskModal").css("overflow","hidden")});$(".new-task-timepicker").blur(function(){$("#activityTaskModal").css("overflow","auto")});if($(".new-task-timepicker").val()==""){$(".new-task-timepicker").val(get_hh_mm())}})}},eventDrop:function(g,d,c,f,e){showAlertModal("event_drop","confirm",function(){var h=$.extend(true,{},g);h.due=new Date(h.start).getTime()/1000;var l=h.contacts;var m=[];for(var k in l){m.push(l[k].id)}if(h.taskOwner){h.owner_id=h.taskOwner.id}h.contacts=m;var j=new Backbone.Model();j.url="core/api/tasks";j.save(h)},function(){e()})},eventClick:function(c){if(isNaN(c.id)){return}c.due=c.start.getTime()/1000;$("#updateTaskModal").html(getTemplate("task-update-modal")).modal("show");loadProgressSlider($("#updateTaskForm"),function(d){deserializeForm(c,$("#updateTaskForm"));$(".update-task-timepicker").val(fillTimePicker(c.due));categories.getCategoriesHtml(c,function(e){$("#type",$("#updateTaskForm")).html(e);populateUsers("owners-list",$("#updateTaskForm"),c,"taskOwner",function(f){$("#updateTaskForm").find("#owners-list").html(f);if(c.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+c.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()})});showNoteOnForm("updateTaskForm",c.notes);displayTimeAgo($(".task-trello-list"))})}})}function initilizeTasksCalendarViewListeners(){$("#content").on("click",".taskDayWeekMonth",function(){currentView=$(this).attr("id");fullCalTasks.fullCalendar("changeView",currentView);$(this).parent().find("button").each(function(){if($(this).attr("id")==currentView){$(this).addClass("bg-light")
}else{$(this).removeClass("bg-light")}});if(currentView=="agendaDay"||currentView=="agendaWeek"){fullCalTasks.fullCalendar("option","contentHeight",575)}else{fullCalTasks.fullCalendar("option","contentHeight",400)}})}function setCalendarTaskColors(c){var b;if(c.due){b=new Date(c.due*1000)}c.title=c.subject;c.start=c.due;c.end=c.due+55;if(b&&b.getHours()==0&&b.getMinutes()==0){c.end=c.due+1800}c.allDay=false;if(c.priority_type=="HIGH"){c.className="fc-b-l fc-b-2x fc-b-danger fc-border-height fc-event-month"}else{if(c.priority_type=="NORMAL"){c.className="fc-b-l fc-b-2x fc-b-info fc-border-height fc-event-month"}else{if(c.priority_type=="LOW"){c.className="fc-b-l fc-b-2x fc-b-warning fc-border-height fc-event-month"}}}if(c.is_complete==true||c.is_complete=="true"){c.backgroundColor="#fff"}else{c.backgroundColor="#ff6666"}c.color=""}function taskCalendarToday(){fullCalTasks.fullCalendar("today")}(function(e){var f={};var b;function g(){}function c(h){f[h]}function d(j,h){var k=false;if(f[j]){k=true}f[j]=function(n,l,m){m(h)};if(!k){e(b).fullCalendar("addEventSource",c(j))}}})(jQuery);$(document).ready(function(){$("body").on("click",".tasks-select",function(c){c.stopPropagation();if($(this).is(":checked")){var b=$(this).attr("data");complete_task(b,App_Calendar.tasksListView.collection,$(this).closest("tr"))}});$("#updateTaskModal #update_task_validate").off("click");$("#updateTaskModal").on("click","#update_task_validate",function(b){b.preventDefault();save_task("updateTaskForm","updateTaskModal",true,this)});$("body").on("click",".add-task",function(b){b.preventDefault();showTaskModal(this)});$("#updateTaskModal").on("shown.bs.modal",function(){var b=$("#updateTaskForm");agile_type_ahead("update_task_related_to",b,contacts_typeahead);agile_type_ahead("update_task_relates_to_deals",b,deals_typeahead,false,null,null,"core/api/search/deals",false,true);head.js(CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){$(".update-task-timepicker").timepicker({timeFormat:"H:i",step:15});$(".update-task-timepicker").focus(function(){$("#activityModal").css("overflow","hidden")});$(".update-task-timepicker").blur(function(){$("#activityModal").css("overflow","auto")});if($(".update-task-timepicker",b).val()==""){$(".update-task-timepicker",b).val(get_hh_mm())}});setForm(b)})});function activateSliderAndTimerToTaskModal(b){console.log("activateSliderAndTimerToTaskModal");head.js(CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){$(".new-task-timepicker").timepicker({timeFormat:"H:i",step:15})});if($(".new-task-timepicker").val()==""){$(".new-task-timepicker").val(get_hh_mm())}console.log("loadProgressSlider");loadProgressSlider($("#taskForm"));loadProgressSlider($("#updateTaskForm"));$("#update-task-date-1").datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});$("#updateTaskModal #update_task_validate").off("click");$("#updateTaskModal").on("click","#update_task_validate",function(c){c.preventDefault();save_task("updateTaskForm","updateTaskModal",true,this)})}function initializeTasksListeners(){activateSliderAndTimerToTaskModal();$("#tasks-list-template").on("mouseenter",".listed-task",function(b){$(this).find(".task-actions").css("display","block");$(this).find(".task-note-action").hide()});$("#tasks-list-template").on("mouseleave",".listed-task",function(b){$(this).find(".task-actions").css("display","none");$(this).find(".task-note-action").show()});$("#tasks-list-template").on("mouseenter","tr",function(b){$(this).find("#task-list-actions").removeClass("hidden")});$("#tasks-list-template").on("mouseleave","tr",function(b){$(this).find("#task-list-actions").addClass("hidden")});$("#tasks-list-template").on("click",".delete-task",function(c){var b=this;showAlertModal("delete_task","confirm",function(){if(!getTaskListId(b)&&$(b).parent().attr("data")){deleteTask(getTaskId(b),$(b).parent().attr("data"),parseInt(getTaskListOwnerId(b)));$(b).parentsUntil("tr").parent("tr").remove()}else{deleteTask(getTaskId(b),getTaskListId(b),parseInt(getTaskListOwnerId(b)))}})});$("#tasks-list-template").on("click",".is-task-complete",function(b){b.preventDefault();if(!confirm(_agile_get_translated_val("tasks","confirm-delete"))){return}if(!getTaskListId(this)&&$(this).parent().attr("data")){completeTask(getTaskId(this),$(this).parent().attr("data"),parseInt(getTaskListOwnerId(this)))}else{completeTask(getTaskId(this),getTaskListId(this),parseInt(getTaskListOwnerId(this)))}});$("#tasks-list-template").on("click",".edit-task",function(b){b.preventDefault();if(!getTaskListId(this)&&$(this).parent().attr("data")){editTask(getTaskId(this),$(this).parent().attr("data"),parseInt(getTaskListOwnerId(this)))}else{editTask(getTaskId(this),getTaskListId(this),parseInt(getTaskListOwnerId(this)))}});$("#tasks-list-template").on("click",".group-view",function(b){b.preventDefault();console.log("group-view event");applyDetailsFromGroupView()});$("#tasks-list-template").on("click",".tasks-list-image",function(c){c.preventDefault();var b=c.target.getAttribute("url");routeToPage(b);c.stopPropagation()});$("#tasks-list-template").on("click",".view-task-details",function(c){c.preventDefault();var b=$(this).parents(".agile-edit-row").attr("route");var d=$(this).siblings(".data").attr("data");if(d){Backbone.history.navigate(b+d,{trigger:true})}})}$("body").on("change",".status",function(){console.log("status change event");changeStatus($(this).val(),$(this).closest("form"))});function highlight_task(){$("#hiddentask").val("task");$("#task").css({color:"black"});$("#event").css({color:"red"});$("#relatedEvent").css("display","none");$("#relatedTask").css("display","block");if($("#activityForm").find("#event_related_to").closest(".controls").find("ul").children()){$("#taskForm").find("#task_related_to").closest(".controls").find("ul").html($("#activityForm").find("#event_related_to").closest(".controls").find("ul").children())}$("input.date").val(getDateInFormat(new Date()))}function save_task(h,c,g,f){if($(f).attr("disabled")){return}disable_save_button($(f));if(!isValidForm("#"+h)){enable_save_button($(f));return false}var e=serializeForm(h);if(!g){e.due=new Date(e.due).getTime()}if(g){if($("#"+h).find("ul#notes").length>0){var d=[];$("#"+h+" li.task-note").each(function(){d.push($(this).attr("data"))});console.log(d);e.notes=d}}var j=(e.task_ending_time).split(":");e.due=new Date((e.due)*1000).setHours(j[0],j[1])/1000;var b=new Backbone.Model();b.url="core/api/tasks";b.save(e,{success:function(n){enable_save_button($(f));$("#"+h).each(function(){this.reset()});$("#"+c).modal("hide");var l=n.toJSON();getDueTasksCount(function(q){var p=q;if(p==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","inline-block")}if(p!=0){$("#due_tasks_count").html(p)}else{$("#due_tasks_count").html("")}});if(Current_Route=="calendar"){if(g){App_Calendar.tasksListView.collection.remove(e)}if(!n.toJSON().is_complete&&n.toJSON().owner_id==CURRENT_DOMAIN_USER.id){App_Calendar.tasksListView.collection.add(n)}App_Calendar.tasksListView.render(true)}else{if(Current_Route=="tasks-old"){var k=$("#content").find(".type-task-button").find(".selected_name").text();var m=$("#content").find(".owner-task-button").find(".selected_name").text();if(g){App_Calendar.allTasksListView.collection.remove(e)}if((k=="All Categories"||k.toUpperCase()==e.type)&&(m==_agile_get_translated_val("tasks","All Tasks")||e.owner_id==CURRENT_DOMAIN_USER.id)){App_Calendar.allTasksListView.collection.add(n)}App_Calendar.allTasksListView.render(true)}else{if(Current_Route=="tasks"){var o=getCriteria();if(o=="LIST"){if(g){App_Calendar.allTasksListView.collection.get(e).set(new BaseModel(n))}App_Calendar.allTasksListView.render(true);return}if(o=="CALENDAR"){if(g){fullCalTasks.fullCalendar("removeEvents",l.id)}setCalendarTaskColors(l);if($("#new-owner-tasks").data("selected_item")=="all-pending-tasks"){if(l.is_complete==false||l.is_complete=="false"){fullCalTasks.fullCalendar("renderEvent",l)}}else{if($("#new-owner-tasks").data("selected_item")=="my-pending-tasks"){if((l.is_complete==false||l.is_complete=="false")&&l.taskOwner.id==CURRENT_DOMAIN_USER.id){fullCalTasks.fullCalendar("renderEvent",l)}}else{if($("#new-owner-tasks").data("selected_item")==CURRENT_DOMAIN_USER.id){if(l.taskOwner.id==CURRENT_DOMAIN_USER.id){fullCalTasks.fullCalendar("renderEvent",l)}}else{fullCalTasks.fullCalendar("renderEvent",l)}}}return}updateTask(g,n,e)}else{if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){$.each(l.contacts,function(q,p){if(p.id==App_Contacts.contactDetailView.model.get("id")){if(tasksView&&tasksView.collection){if(tasksView.collection.get(n.id)){tasksView.collection.get(n.id).set(new BaseModel(n))}else{tasksView.collection.add(new BaseModel(n),{sort:false});tasksView.collection.sort()}}add_entity_to_timeline(n);return false}})}else{if(App_Companies.companyDetailView&&Current_Route=="company/"+App_Companies.companyDetailView.model.get("id")){$.each(l.contacts,function(q,p){if(p.id==App_Companies.companyDetailView.model.get("id")){if(tasksView&&tasksView.collection){if(tasksView.collection.get(n.id)){tasksView.collection.get(n.id).set(new BaseModel(n))}else{tasksView.collection.add(new BaseModel(n),{sort:false});tasksView.collection.sort()}tasksView.render(true)}add_entity_to_timeline(n);return false}})}else{if(App_Portlets.currentPosition&&App_Portlets.tasksCollection&&App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)]&&(Current_Route==undefined||Current_Route=="dashboard")){if(g){App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)].collection.remove(e)}App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)].collection.add(n);App_Portlets.tasksCollection[parseInt(App_Portlets.currentPosition)].render(true)}else{if(App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.get("id")){$.each(l.deal_ids,function(p,q){if(q==App_Deal_Details.dealDetailView.model.get("id")){if(dealTasksView&&dealTasksView.collection){if(dealTasksView.collection.get(n.id)){dealTasksView.collection.get(n.id).set(new BaseModel(n))
}else{dealTasksView.collection.add(new BaseModel(n),{sort:false});dealTasksView.collection.sort()}}dealTasksView.render(true);return false}})}else{if(App_Calendar.allTasksListView){App_Calendar.allTasksListView.collection.remove(n.toJSON());App_Calendar.allTasksListView.collection.add(n.toJSON());App_Calendar.allTasksListView.render(true)}else{if(App_Calendar.tasksListView){App_Calendar.tasksListView.collection.remove(n.toJSON());App_Calendar.tasksListView.collection.add(n.toJSON());App_Calendar.tasksListView.render(true)}else{App_Tasks.navigate("task/"+l.id,{trigger:true})}}taskDetailView=n;getTemplate("task-detail",n.toJSON(),undefined,function(p){if(!p){return}$("#content").html($(p));task_details_tab.loadActivitiesView();initializeTaskDetailListeners()},"#content")}}}}}}}},error:function(l,k){if(k&&k.status==403){enable_save_button($(f));$("span.save-status",$("#"+c)).html("<i style='color:#B94A48;'>"+Handlebars.compile("{{name}}")({name:k.responseText})+"</i>");setTimeout(function(){$("span.save-status",$("#"+c)).html("")},4000)}}})}function get_due(c){var b=new Date();b.setHours(0,0,0,0);b=b.getTime()/1000;return Math.floor((c-b)/(24*3600))}function increaseCount(c){var b=c.find(".count").attr("count");b=b?parseInt(b)+1:1;c.find(".count").attr("count",b);c.find(".count").text("("+b+")");return b}function append_tasks(b){var c=new Base_List_View({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"tr",});var e=get_due(b.get("due"));if(e<0){var f=$("#overdue-heading",this.el);var d=increaseCount(f);if(d>5){return}$("#overdue",this.el).append(c.render().el);if(d==5){$("#overdue",this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>')}$("#overdue",this.el).find("tr:last").data(b);$("#overdue",this.el).parent("table").css("display","block");f.show();$("#overdue",this.el).show()}if(e==0){var f=$("#today-heading",this.el);var d=increaseCount(f);if(d>5){return}if($("#today > tr",this.el).length>4){return}$("#today",this.el).append(c.render().el);if(d==5){$("#today",this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>')}$("#today",this.el).find("tr:last").data(b);$("#today",this.el).parent("table").css("display","block");$("#today",this.el).show();$("#today-heading",this.el).show()}if(e==1){var f=$("#tomorrow-heading",this.el);var d=increaseCount(f);if(d>5){return}$("#tomorrow",this.el).append(c.render().el);if(d==5){$("#tomorrow",this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>')}$("#tomorrow",this.el).find("tr:last").data(b);$("#tomorrow",this.el).parent("table").css("display","block");$("#tomorrow",this.el).show();$("#tomorrow-heading",this.el).show()}if(e>1){var f=$("#next-week-heading",this.el);var d=increaseCount(f);if(d>5){return}$("#next-week",this.el).append(c.render().el);if(d==5){$("#next-week",this.el).append('<div style="float:right;padding-bottom:10px"><a href="#tasks">more</a></div>')}$("#next-week",this.el).find("tr:last").data(b);$("#next-week",this.el).parent("table").css("display","block");$("#next-week",this.el).show();$("#next-week-heading",this.el).show()}}function append_tasks_dashboard(b){var d=new Base_List_View({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"tr",});var e=get_due(b.get("due"));var c=b.get("is_complete");if(c==false&&e<=0){$("#dashboard1-tasks-model-list",this.el).append(d.render().el)}}function complete_task(c,h,f,j){var g=h.get(c).toJSON();var e=[];$.each(g.contacts,function(l,k){e.push(k.id)});console.log(g.notes);var b=[];$.each(g.notes,function(k,l){b.push(l.id)});console.log(b);g.notes=b;g.note_description="";g.contacts=e;g.is_complete=true;g.status="COMPLETED";g.progress=100;g.owner_id=g.taskOwner.id;var d=new Backbone.Model();d.url="/core/api/tasks";d.save(g,{success:function(l,k){if(!Current_Route){Current_Route="/"}if(Current_Route.indexOf("contact/")>-1){h.get(c).set(l)}else{h.remove(l)}getDueTasksCount(function(m){if(m==0){$(".navbar_due_tasks").css("display","none")}else{$(".navbar_due_tasks").css("display","inline-block")}if(m!=0){$("#due_tasks_count").html(m)}else{$("#due_tasks_count").html("")}});if(f){f.fadeOut(500)}if(j&&typeof(j)==="function"){j(l)}},error:function(l,k){showModalConfirmation("Complete Task","<span>"+k.responseText+"</span>",function(){return},function(){return},function(){return},"Cancel");return}})}function getDueTasksCount(b){accessUrlUsingAjax("core/api/tasks/overdue/uptotoday",function(c){if(!isNaN(c)){return b(c)}return b(0)})}function showTaskModal(c){$("#activityTaskModal").html(getTemplate("new-task-modal")).modal("show");var b=$("#taskForm");agile_type_ahead("task_related_to",b,contacts_typeahead);agile_type_ahead("task_relates_to_deals",b,deals_typeahead,false,null,null,"core/api/search/deals",false,true);highlight_task();categories.getCategoriesHtml(undefined,function(d){$("#type",b).html(d);populateUsers("owners-list",$("#taskForm"),undefined,undefined,function(e){$("#taskForm").find("#owners-list").html(e);$("#owners-list",b).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#taskForm")).closest("div").find(".loading-img").hide();addTasklListDetails(c)})})}$(function(){$("#updateActivityModal").on("click","#add_event_desctiption",function(b){b.preventDefault();$(".event_discription").removeClass("hide");$(this).hide();return});$("#activityModal").on("click","#add_event_desctiption",function(b){b.preventDefault();$(".event_discription").removeClass("hide");$(this).hide();return});$("#updateActivityModal").on("click","#update_event_validate",function(d){d.preventDefault();var c=$("#updateActivityModal").find("input[type='hidden']").val();var b=$("#updateActivityModal").find("#current_div").val();save_event("updateActivityForm","updateActivityModal",true,this,b,function(f){console.log(f);var e=eventCollectionView.collection.get(c);e.set(f.toJSON(),{merge:true});eventCollectionView.render(true)})});$("#updateActivityModal").on("click","#delete_web_event",function(c){c.preventDefault();if(hasScope("MANAGE_CALENDAR")||(CURRENT_DOMAIN_USER.id==App_Calendar.current_event.owner.id)){var b=$("#updateActivityForm input[name=id]").val();$("#updateActivityModal").modal("hide");$("#webEventCancelModel").modal("show");$("#cancel_event_title").html(_agile_get_translated_val("events","delete-event")+" &#39"+web_event_title+"&#39?");$("#event_id_hidden").html("<input type='hidden' name='event_id' id='event_id' value='"+b+"'/>")}else{$("#updateActivityModal").find("span.error-status").html('<div class="inline-block"><p class="text-base" style="color:#B94A48;"><i>'+_agile_get_translated_val("tasks","you-do-not-have-permission-to-delete-this-event")+"</i></p></div>");setTimeout(function(){$("#updateActivityModal").find("span.error-status").html("")},2000)}});$("#updateActivityModal").on("click","#event_delete",function(c){c.preventDefault();if($(this).attr("disabled")=="disabled"){return}var b=$(this);showAlertModal("delete_event","confirm",function(){var e=$("#updateActivityForm input[name=id]").val();disable_save_button(b);$.ajax({url:"core/api/events/"+e,type:"DELETE",success:function(){if(App_Portlets.currentPosition&&App_Portlets.todayEventsCollection&&App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)]){App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.remove(App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.get(e));App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].render(true)}else{if(App_Portlets.currentPortletName&&App_Portlets.currentPortletName=="Mini Calendar"){var f=new Date(parseInt($(".minical-portlet-event").attr("data-date")));f.setHours(0,0,0,0);_agile_set_prefs("current_date_calendar",f);$(".portlet_body_calendar").each(function(){var h=$(this);if(h.parents(".gs-w").attr("data-col")+h.parents(".gs-w").attr("data-row")==App_Portlets.currentPosition){App_Portlets.eventCalendar=h;$("#calendar_container",h).fullCalendar("refetchEvents");App_Portlets.refetchEvents=true}})}else{if(App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.get("id")){if(dealEventsView&&dealEventsView.collection){if(dealEventsView.collection.get(e)){dealEventsView.collection.remove(e);dealEventsView.render(true)}}}else{if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){if(eventsView&&eventsView.collection){if(eventsView.collection.get(e)){eventsView.collection.remove(e);eventsView.render(true)}}}}}}enable_save_button(b);$("#updateActivityModal").modal("hide");var g=$("#updateActivityModal").find("input[type='hidden']").val();$("#calendar_event").fullCalendar("removeEvents",g)},error:function(f){enable_save_button(b);$("#updateActivityModal").find("span.error-status").html('<div class="inline-block"><p class="text-base" style="color:#B94A48;"><i>'+f.responseText+"</i></p></div>");setTimeout(function(){$("#updateActivityModal").find("span.error-status").html("")},2000);console.log("-----------------",f.responseText)}});if(_agile_get_prefs("agile_calendar_view")){var d=eventCollectionView.collection.get(e);d.set(d,{remove:true});document.location.reload()}})});$("#webEventCancelModel").on("click","#cancel_delete",function(h){h.preventDefault();var g=$("#webEventCancelForm input[name=event_id]").val();var d=$(this).attr("action_parameter");if(d=="donotdelete"){$("#webEventCancelModel").modal("hide");return}var f=$("#webEventCancelForm textarea[name=appointment_cancel_reason]").val();var b=$(this);disable_save_button(b);$.ajax({url:"core/api/events/cancelwebevent/?eventid="+g+"&cancelreason="+f+"&action_parameter="+d,type:"DELETE",success:function(){if(App_Portlets.currentPosition&&App_Portlets.todayEventsCollection&&App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)]){App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.remove(App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.get(g));
App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].render(true)}else{if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){var e=eventsView.collection.get(g);eventsView.collection.remove(e);enable_save_button(b);$("#webEventCancelModel").modal("hide");contact_details_tab.load_events();return}}enable_save_button(b);$("#webEventCancelModel").modal("hide");$("#calendar_event").fullCalendar("removeEvents",g)}});if(_agile_get_prefs("agile_calendar_view")){var c=eventCollectionView.collection.get(g);c.set(c,{remove:true});document.location.reload()}})});function initializeEventListners(b){$("#icalModal").off("click");$("#icalModal").on("click","#send-ical-email",function(d){d.preventDefault();$("#icalModal").modal("hide");if($("#share-ical-by-email").size()!=0){$("#share-ical-by-email").remove()}var e=Backbone.Model.extend({url:"/core/api/users/current-user",restKey:"domainUser"});var c=new e();c.fetch({success:function(h){var f=h.toJSON();var g=$("#icalModal").find("#ical-feed").text();f.ical_url=g;getTemplate("share-ical-by-email",f,undefined,function(l){if(!l){return}var k=$(l);var j=$(k).find("textarea").val();j=j.replace(/<br\/>/g,"\r\n");$(k).find("textarea").val(j);k.modal("show");send_ical_info_email(k)},null)}})});$("#calendar-listers").on("click",".agendaDayWeekMonth",function(){currentView=$(this).attr("id");fullCal.fullCalendar("changeView",currentView);$(this).parent().find("button").each(function(){if($(this).attr("id")==currentView){$(this).addClass("bg-light")}else{$(this).removeClass("bg-light")}});if(currentView=="agendaDay"||currentView=="agendaWeek"){fullCal.fullCalendar("option","contentHeight",575)}else{fullCal.fullCalendar("option","contentHeight",400)}});$("#calendar-listers").on("click",".agendaDayWeekMonth",function(){currentView=$(this).attr("id");fullCal.fullCalendar("changeView",currentView);$(this).parent().find("button").each(function(){if($(this).attr("id")==currentView){$(this).addClass("bg-light")}else{$(this).removeClass("bg-light")}})});$("#calendar-listers").on("click",".add-event",function(c){c.preventDefault();$("#activityModal").html(getTemplate("new-event-modal")).modal("show");agile_type_ahead("event_relates_to_deals",$("#activityModal"),deals_typeahead,false,null,null,"core/api/search/deals",false,true);highlight_event();return});$("#calendar-listers").on("click",".calendar_check",function(f){createRequestUrlBasedOnFilter();var d=$(this).val();var c="";if(d=="agile"){if(this.checked==true){c=getOwnerIdsFromCookie(true);renderFullCalenarEvents(c)}else{removeFullCalendarEvents(CURRENT_DOMAIN_USER.id)}}if(d=="google"){if(this.checked==true){addGoogleCalendarEvents()}else{removeGoogleEventSource()}}if(d=="office"){if(this.checked==true){addOffice365CalendarEvents()}else{removeEventSource("office")}}});$("#calendar-listers").on("click",".calendar_user_check",function(f){createRequestUrlBasedOnFilter();var c=$(this).val();var d=$(this).attr("data");if(this.checked==true){renderFullCalenarEvents(c)}else{removeFullCalendarEvents(d)}});$("#calendar-listers").on("click",".select_all_users",function(c){if(this.checked){$(".calendar_user_check").each(function(){this.checked=true})}else{$(".calendar_user_check").each(function(){if($(this).val()!=CURRENT_AGILE_USER.id){this.checked=false}})}createRequestUrlBasedOnFilter();loadFullCalednarOrListView()})}$(function(){$("body").on("click","#show-activity",function(c){c.preventDefault();$("#activityModal").html(getTemplate("new-event-modal")).modal("show");highlight_event()});$("body").on("click","#chrome-extension",function(c){$("#chrome-extension-modal").html(getTemplate("chrome-modal"));$("#chrome-extension-modal").modal("show")});$("body").on("click",".betaAccess",function(d){$(".model-etensions").addClass("hide");console.log("inside the sending request for the betarequest");var c={};c.from=CURRENT_DOMAIN_USER.email;c.to="kiran@agilecrm.com";c.cc="narmada@invox.com";c.subject="Request for getting the Beta Access";c.body="Name: "+CURRENT_DOMAIN_USER.name+"<br>Useremail: "+CURRENT_DOMAIN_USER.email+"<br>Domain: "+CURRENT_DOMAIN_USER.domain;sendEmail(c);$("#betasuccess").removeClass("hide")});$("body").on("click","#betarequest",function(c){});$("body").on("click",".AndroidExtension",function(c){$(this).parents(".popover").popover("hide")});$("body").on("click",".chromeExtension",function(c){$(this).parents(".popover").popover("hide");c.stopPropagation();$("#chrome-extension-modal").addClass("hide");console.log("before the chrome installation");try{chrome.webstore.install("https://chrome.google.com/webstore/detail/eofoblinhpjfhkjlfckmeidagfogclib",function(e){console.log("installed")},function(d){console.log("not installed: "+d)})}catch(c){console.log(c)}console.log("after the chrome installation")});function b(c){agile_type_ahead("event_related_to",c,contacts_typeahead);agile_type_ahead("event_relates_to_deals",c,deals_typeahead,false,null,null,"core/api/search/deals",false,true);var e=new Date();var d=new Date(e);d.setHours(e.getHours()+3);head.js(CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){$(".new-task-timepicker").timepicker({timeFormat:"H:i",step:15})});$(".new-task-timepicker").focus(function(){$("#activityTaskModal").css("overflow","hidden")});$(".new-task-timepicker").blur(function(){$("#activityTaskModal").css("overflow","auto")});if($(".new-task-timepicker",c).val()==""){$(".new-task-timepicker",c).val(get_hh_mm())}$("#task-date-1",c).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});$("#task-date-1",c).datepicker("update")}$("#activityModal, #activityTaskModal").on("shown.bs.modal",function(){console.log("prem **** ");var c=$("#activityForm");b(c);c=$("#taskForm");b(c);activateSliderAndTimerToTaskModal(c)});$("#updateActivityModal").on("show.bs.modal",function(){var c=$("#updateActivityForm");agile_type_ahead("event_related_to",c,contacts_typeahead);agile_type_ahead("event_relates_to_deals",c,deals_typeahead,false,null,null,"core/api/search/deals",false,true);if($("#allDay",c).is(":checked")){$("#update-event-time-1",c).closest(".control-group").hide();$("#update-event-date-2",c).closest(".row").hide()}$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error")});$("#activityModal, #activityTaskModal, #updateActivityModal").on("shown.bs.modal",function(c){if($(c.target).hasClass("date")){return}$("input.date").each(function(d,e){$(e).datepicker("update")})});$("#activityModal, #activityTaskModal, #updateActivityModal").on("show.bs.modal",function(f){if($(f.target).hasClass("date")){return}$(".event_discription").addClass("hide");$("textarea#description").val("");$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error");if($("#activityForm").length>0){var d=$("#event-owners-list",$("#activityForm")).val();if(d==null){populateUsers("event-owners-list",$("#activityForm"),undefined,undefined,function(e){$("#activityForm").find("#event-owners-list").html(e);$("#event-owners-list",$("#activityForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#event-owners-list",$("#activityForm")).closest("div").find(".loading-img").hide()})}}var c=$("#event-date-1").datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true}).on("changeDate",function(e){var g;if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy")!=-1||CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy")!=-1){g=new Date(convertDateFromUKtoUS($("#event-date-2").val()))}else{g=new Date($("#event-date-2").val())}if(e.date.valueOf()>g.valueOf()){$("#event-date-2").val($("#event-date-1").val())}});$("#event-date-2").datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});$("#update-event-date-1").datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true}).on("changeDate",function(e){var g;if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy")!=-1||CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy")!=-1){g=new Date(convertDateFromUKtoUS($("#update-event-date-2").val()))}else{g=new Date($("#update-event-date-2").val())}if(e.date.valueOf()>g.valueOf()){$("#update-event-date-2").val($("#update-event-date-1").val())}});$("#update-event-date-2").datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});head.js(CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){$(".start-timepicker").timepicker({timeFormat:"H:i",step:15});$(".end-timepicker").timepicker({timeFormat:"H:i",step:15});$(".update-start-timepicker").timepicker({timeFormat:"H:i",step:15});$(".update-end-timepicker").timepicker({timeFormat:"H:i",step:15});$(".start-timepicker").blur(function(){$("#activityModal").css("overflow","auto")});$(".start-timepicker").focus(function(){$("#activityModal").css("overflow","hidden")});$(".end-timepicker").blur(function(){$("#activityModal").css("overflow","auto")});$(".end-timepicker").focus(function(){$("#activityModal").css("overflow","hidden")});$(".update-start-timepicker").blur(function(){$("#activityModal").css("overflow","auto")});$(".update-start-timepicker").focus(function(){$("#activityModal").css("overflow","hidden")});$(".update-end-timepicker").blur(function(){$("#activityModal").css("overflow","auto")});$(".update-end-timepicker").focus(function(){$("#activityModal").css("overflow","hidden")})});if($(".start-timepicker").val()==""){$(".start-timepicker").val(get_hh_mm())}if($(".end-timepicker").val()==""){$(".end-timepicker").val(get_hh_mm(true))}if($(".update-start-timepicker").val()==""){$(".update-start-timepicker").val(get_hh_mm())}if($(".update-end-timepicker").val()==""){$(".update-end-timepicker").val(get_hh_mm(true))}});$("#updateActivityModal").on("hidden.bs.modal",function(){if($(this).hasClass("in")){return
}$("#updateActivityForm").each(function(){this.reset()});$("#updateActivityForm").find("li").remove();$("#update-event-time-1").closest(".control-group").show();$("#update-event-date-2").closest(".row").show()});$("#activityTaskModal").on("hidden.bs.modal",function(){$("#taskForm").find("ul").remove();remove_validation_errors("activityTaskModal")});$("#activityModal").on("hidden.bs.modal",function(){$("#activityForm").find("ul").remove();remove_validation_errors("activityModal")});$("#webEventCancelModel").on("hidden.bs.modal",function(){$("#webEventCancelForm").each(function(){this.reset()})})});function highlight_event(){$("#hiddentask").val("event");$("#event").css({color:"black"});$("#task").css({color:"red"});$("#relatedTask").css("display","none");$("#relatedEvent").css("display","block");if($("#taskForm").find("#task_related_to").closest(".controls").find("ul").children()){$("#activityForm").find("#event_related_to").closest(".controls").find("ul").html($("#taskForm").find("#task_related_to").closest(".controls").find("ul").children())}$("input.date").val(getDateInFormat(new Date()))}function is_valid_range(b,f,e,c,d){if(f-b>=86400000){return true}else{if(b>f){$("#"+d).find(".invalid-range").html('<div class="alert alert-danger m-t-sm" style="margin-bottom:5px;"><a class="close" data-dismiss="alert" href="#">&times</a>'+_agile_get_translated_val("events","start-date-error")+"</div>");return false}else{if(parseInt(e[0])>parseInt(c[0])){$("#"+d).find(".invalid-range").html('<div class="alert alert-danger m-t-sm" style="margin-bottom:5px;"><a class="close" data-dismiss="alert" href="#">&times</a>'+_agile_get_translated_val("events","start-time-error")+"</div>");return false}else{if(parseInt(e[0])==parseInt(c[0])&&parseInt(e[1])>=parseInt(c[1])){$("#"+d).find(".invalid-range").html('<div class="alert alert-danger m-t-sm" style="margin-bottom:5px;"><a class="close" data-dismiss="alert" href="#">&times</a>'+_agile_get_translated_val("events","start-time-equals-error")+"</div>");return false}else{return true}}}}}function save_event(g,d,l,e,c,h){if($(e).attr("disabled")){return}disable_save_button($(e));if(!isValidForm("#"+g)){enable_save_button($(e));return false}var k=serializeForm(g);if(k.allDay){k.end=k.start;k.start_time="00:00";k.end_time="23:45"}if(!is_valid_range(k.start*1000,k.end*1000,(k.start_time).split(":"),(k.end_time).split(":"),d)){enable_save_button($(e));return}var b=(k.start_time).split(":");k.start=new Date(k.start*1000).setHours(b[0],b[1])/1000;var f=(k.end_time).split(":");k.end=new Date(k.end*1000).setHours(f[0],f[1])/1000;delete k.start_time;delete k.end_time;var j=new Backbone.Model();j.url="core/api/events";j.save(k,{success:function(o){enable_save_button($(e));$("#"+g).each(function(){this.reset()});$("#"+d).modal("hide");var n=o.toJSON();n=renderEventBasedOnOwner(n);if(App_Portlets.currentPortletName&&App_Portlets.currentPortletName=="Mini Calendar"&&c=="Mini Calendar"){$(".portlet_body_calendar").each(function(){var q=$(this);if(q.parents(".gs-w").attr("data-col")+q.parents(".gs-w").attr("data-row")==App_Portlets.currentPosition){if($(".minical-portlet-event",q).attr("data-date")!=undefined){var p=new Date(parseInt($(".minical-portlet-event",q).attr("data-date")));p.setHours(0,0,0,0);_agile_set_prefs("current_date_calendar",p)}else{var p=new Date(parseInt($(".minical-portlet-event-add",q).attr("data-date")));p.setHours(0,0,0,0);_agile_set_prefs("current_date_calendar",p)}App_Portlets.eventCalendar=q;$("#calendar_container",q).fullCalendar("refetchEvents");App_Portlets.refetchEvents=true}})}else{if(App_Portlets.currentPosition&&App_Portlets.todayEventsCollection&&App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)]&&c=="Events Dashlet"){if(l){App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.remove(k)}App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.add(o);App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].render(true)}else{if(Current_Route=="calendar"&&!_agile_get_prefs("agile_calendar_view")){if(l){$("#calendar_event").fullCalendar("removeEvents",k.id)}renderAddedEventToFullCalenarBasedOnCookie(n)}else{if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){$.each(n.contacts,function(r,q){if(q.id==App_Contacts.contactDetailView.model.get("id")){if(eventsView&&eventsView.collection){var p=o.get("owner_id");if(!p){p=o.get("owner").id}if(eventsView.collection.get(o.id)){if(hasScope("VIEW_CALENDAR")||CURRENT_DOMAIN_USER.id==p){eventsView.collection.get(o.id).set(new BaseModel(o))}}else{if(hasScope("VIEW_CALENDAR")||CURRENT_DOMAIN_USER.id==p){eventsView.collection.add(new BaseModel(o),{sort:false});eventsView.collection.sort()}}}return false}})}else{if(App_Companies.companyDetailView&&Current_Route=="company/"+App_Companies.companyDetailView.model.get("id")){$.each(n.contacts,function(r,q){if(q.id==App_Companies.companyDetailView.model.get("id")){if(eventsView&&eventsView.collection){var p=o.get("owner_id");if(!p){p=o.get("owner").id}if(eventsView.collection.get(o.id)){if(hasScope("VIEW_CALENDAR")||CURRENT_DOMAIN_USER.id==p){eventsView.collection.get(o.id).set(new BaseModel(o))}}else{if(hasScope("VIEW_CALENDAR")||CURRENT_DOMAIN_USER.id==p){eventsView.collection.add(new BaseModel(o),{sort:false});eventsView.collection.sort()}}eventsView.render(true)}return false}})}else{if(App_Portlets.currentPosition&&App_Portlets.todayEventsCollection&&App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)]&&(Current_Route==undefined||Current_Route=="dashboard")){if(l){App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.remove(k)}App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].collection.add(o);App_Portlets.todayEventsCollection[parseInt(App_Portlets.currentPosition)].render(true)}else{if(App_Portlets.currentPortletName&&App_Portlets.currentPortletName=="Mini Calendar"){if($(".minical-portlet-event").attr("data-date")!=undefined){var m=new Date(parseInt($(".minical-portlet-event").attr("data-date")));m.setHours(0,0,0,0);_agile_set_prefs("current_date_calendar",m)}else{var m=new Date(parseInt($(".minical-portlet-event-add").attr("data-date")));m.setHours(0,0,0,0);_agile_set_prefs("current_date_calendar",m)}$("#calendar_container").fullCalendar("refetchEvents");App_Portlets.refetchEvents=true}else{if(App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.get("id")){$.each(n.deal_ids,function(q,r){if(r==App_Deal_Details.dealDetailView.model.get("id")){if(dealEventsView&&dealEventsView.collection){var p=o.get("owner_id");if(!p){p=o.get("owner").id}if(dealEventsView.collection.get(o.id)){if(hasScope("VIEW_CALENDAR")||CURRENT_DOMAIN_USER.id==p){dealEventsView.collection.get(o.id).set(new BaseModel(o))}}else{if(hasScope("VIEW_CALENDAR")||CURRENT_DOMAIN_USER.id==p){dealEventsView.collection.add(new BaseModel(o),{sort:false});dealEventsView.collection.sort()}}}dealEventsView.render(true);return false}})}else{App_Calendar.navigate("calendar",{trigger:true})}}}}}}}}if(h&&typeof h==="function"){h(o)}},error:function(m,n){enable_save_button($(e));$("#"+d).find("span.error-status").html('<div class="inline-block"><p class="text-base" style="color:#B94A48;"><i>'+n.responseText+"</i></p></div>");setTimeout(function(){$("#"+d).find("span.error-status").html("")},2000);console.log("-----------------",n.responseText)}})}function get_hh_mm(d,e){var b=new Date().getHours();var c=new Date().getMinutes();if(c%15!=0){c=c-(c%15)}if(d){if(c=="30"){b=b+1;c=0}else{if(c=="45"){b=b+1;c=15}else{c=c+30}}}if(b<10){b="0"+b}if(c<10){c="0"+c}return b+":"+c}function fillTimePicker(d){if(d){var b=new Date(d*1000).getHours();var c=new Date(d*1000).getMinutes();if(b<10){b="0"+b}if(c<10){c="0"+c}return b+":"+c}}function populateUsersInUpdateActivityModal(b){populateUsers("event-owners-list",$("#updateActivityForm"),b,"eventOwner",function(c){$("#updateActivityForm").find("#event-owners-list").html(c);if(b.owner){$("#event-owners-list",$("#updateActivityForm")).find('option[value="'+b.owner.id+'"]').attr("selected","selected")}$("#event-owners-list",$("#updateActivityForm")).closest("div").find(".loading-img").hide()})}function changeEndTime(g,c){console.log("In changeEndTime");console.log(g);console.log(c);var f=/[a-zA-Z]/;for(var e=0;e<g.length;e++){if(f.test(g[e])){g[e]=0}else{if(!f.test(g[e])){g[e]=g[e].substring(0,2)}}}if(g[0]>c[0]||(g[0]==c[0]&&g[1]>=c[1])){var b=Number(g[0]);var d=Number(g[1]);if(d%15!=0){d=d-(d%15)}if(d=="30"){if(b==23){b=0}else{b=b+1}d=0}else{if(d=="45"){if(b==23){b=0}else{b=b+1}d=15}else{d=d+30}}if(b<10){b="0"+b}if(d<10){d="0"+d}console.log(b+":"+d);return b+":"+d}else{return c[0]+":"+c[1]}}function includeTimeAgo(b){agileTimeAgoWithLngConversion($("time",b))}function initOwnerslist(){$("body").on("click","ul#owner-tasks li a, ul#type-tasks li a",function(d){d.preventDefault();var c=$(this).html(),f=$(this).attr("href");$(this).closest("ul").data("selected_item",f);$(this).closest(".btn-group").find(".selected_name").text(c);var b=getParams();updateData(b)});$("body").on("click","ul#owner-tasks li a",function(b){$(".task-heading").html($(this).html()+'&nbsp<small class="tasks-count"></small> <span style="font-size: small;color: #525252;  background-color: rgb(255,255,204);  border: 1px solid rgb(211,211,211);border-radius: 3px;padding: 3px 5px 3px 5px;">Try our <a href="#tasks-new">new look</a></span>');pieTasks(getParams())});updateData(getParams()+"&owner="+CURRENT_DOMAIN_USER.id+"&pending="+true);pieTasks(getParams()+"&owner="+CURRENT_DOMAIN_USER.id+"&pending="+true)}var allTasksListView;function updateData(b){$("#task-list-based-condition").html(LOADING_HTML);this.App_Calendar.allTasksListView=new Base_Collection_View({url:"/core/api/tasks/based"+b,restKey:"task",sort_collection:false,templateKey:"tasks-list",cursor:true,page_size:25,individual_tag_name:"tr",postRenderCallback:function(c){$(".tasks-count").html(getCount(this.App_Calendar.allTasksListView.collection.toJSON()));
$(".tasks-count").attr("data",getTaskCount(this.App_Calendar.allTasksListView.collection.toJSON()));includeTimeAgo(c)},appendItemCallback:function(c){includeTimeAgo(c)}});this.App_Calendar.allTasksListView.collection.fetch();$("#task-list-based-condition").html(this.App_Calendar.allTasksListView.render().el)}function getParams(){var d="?";var c=$("#type-tasks").data("selected_item");if(c){d+=("&type="+c)}var b=$("#owner-tasks").data("selected_item");if(b=="my-pending-tasks"){d+=("&pending="+true);d+=("&owner="+CURRENT_DOMAIN_USER.id);return d}if(b){d+=("&owner="+b)}else{if(b==undefined){d+=("&owner="+CURRENT_DOMAIN_USER.id)}}return d}$(function(){$("body").on("click","#bulk-complete",function(e){e.preventDefault();var b=[];var f=[];var d=false;var c=$("body").find(".showCheckboxes");$(c).find("tr .tbody_check").each(function(g,h){if($(h).is(":checked")){$(h).closest("tr").on("mouseenter",false);b.push(g);f.push($(h).closest("tr").data().toJSON());d=true}});if(d){$(this).after('<img class="bulk-complete-loading" style="padding-right:5px;margin-bottom:15px" src= "'+updateImageS3Path("img/21-0.gif")+'"></img>');bulk_complete_operation("/core/api/tasks/bulk/complete",b,c,f)}else{$("body").find(".select-none").html('<div class="alert alert-danger"><a class="close" data-dismiss="alert" href="#">&times;</a>'+_agile_get_translated_val("bulk-actions","no-tasks-delete")+"</div>").show().delay(3000).hide(1)}getDueTasksCount(function(h){var g=h;if(g!=0){$("#due_tasks_count").html(g)}else{$("#due_tasks_count").html("")}})})});function bulk_complete_operation(b,c,d,e){var f=[];$.each(e,function(h,g){var j=g.taskContacts;g.contacts=[];$.each(j,function(l,k){g.contacts.push(k.id);f.push(g)});g.is_complete=true;g.owner_id=g.taskOwner.id});$.ajax({url:b,type:"POST",data:JSON.stringify(f),contentType:"application/json",success:function(){$(".bulk-complete-loading").remove();var g=$(d).find("tbody");for(var h=0;h<c.length;h++){$(g).find("tr:eq("+c[h]+")").find("div:lt(3)").css("text-decoration","line-through")}}})}
/*!
 * FullCalendar v1.6.4 Google Calendar Plugin
 * Docs & License: http://arshaw.com/fullcalendar/
 * (c) 2013 Adam Shaw
 */
function loadUserEventsfromGoogle(e,b,d){showLoadingOnCalendar(true);var c=load_events_from_google(function(f){if(!f){return}return agile_transform_options(f,e,b)});if(!c){showLoadingOnCalendar(false)}}function isDefined(b){return typeof b!=="undefined"}var isSet1=false;function _init_gcal_options(c){if(isSet1){return}var b=$.fullCalendar;b.sourceFetchers.push(_googleEventFetcher);isSet1=true}function _googleEventFetcher(c,e,b,d){if(c.dataType=="agile-gcal"){loadUserEventsfromGoogle(e,b);return{}}else{if(c.dataType=="agile-events"){addEventsToCalendar(c.events(e,b,function(f){}));return{}}}console.log("--------------- Events -----------------------");console.log(c.className);if($.isFunction(c.events)){return}return}function agile_transform_options(c,d,b){if(typeof gapi!="undefined"&&isDefined(gapi)&&isDefined(gapi.client)&&isDefined(gapi.client.calendar)){_fetchGCAndAddEvents(c,d,b);return}_load_gapi(function(){_fetchGCAndAddEvents(c,d,b);return})}function _load_gapi(b){head.js("https://apis.google.com/js/client.js","/lib/calendar/gapi-helper.js?t=27",function(){setupGC(b)})}function setupGC(c){var b=new gapi_helper_prototype();b.configure({scopes:"https://www.googleapis.com/auth/calendar",services:{calendar:"v3"}});b.when("calendarLoaded",c)}function _set_token_from_session(c){if(typeof gapi==="undefined"){_load_gapi(function(){get_google_calendar_prefs(function(d){gapi.auth.setToken({access_token:d.token,state:"https://www.googleapis.com/auth/calendar"});c()})});return}var b=gapi.auth.getToken();if(b==null||b.access_token==null){get_google_calendar_prefs(function(d){gapi.auth.setToken({access_token:d.token,state:"https://www.googleapis.com/auth/calendar"});c()});return}return c(gapi.auth.getToken())}function _resetGAPI(){if(typeof gapi!="undefined"){gapi.auth.setToken(undefined)}}function _fetchGoogleCalendarList(d,c){if(!c){c=0}try{_set_token_from_session(function(f){var e=gapi.client.calendar.calendarList.list();e.execute(function(g){if(!g||g.code=="401"){if(c<2){erase_google_calendar_prefs_cookie();gapi.auth.setToken(undefined);_set_token_from_session(function(){_fetchGoogleCalendarList(d,++c)});return}}else{d(g)}})});return}catch(b){}}function _fetchGCAndAddEvents(c,d,b){head.js("flatfull/lib/web-calendar-event/moment.min.js",function(){head.js("flatfull/lib/web-calendar-event/moment-timezone-with-data.js",function(){console.log(c);gapi.auth.setToken({access_token:c.token,state:"https://www.googleapis.com/auth/calendar"});if(!c.calendarIds){c.calendarIds=["primary"]}showLoadingOnCalendar(false);$.each(c.calendarIds,function(e,g){showLoadingOnCalendar(true);var f=gapi.client.calendar.events.list({calendarId:g,timeMin:ts2googleDate(d),timeMax:ts2googleDate(b),maxResults:10000,singleEvents:true});f.execute(function(m){var l=[];for(var k=0;k<m.items.length;k++){var j=google2fcEvent(m.items[k]);if(j){if(j.allDay==false){var h=new Date(j.start).toUTCString();var n=moment.tz(h,CURRENT_USER_PREFS.timezone);j.start=n.format();h=new Date(j.end).toUTCString();n=moment.tz(h,CURRENT_USER_PREFS.timezone);j.end=n.format()}}l.push(j);renderEventBasedOnOwner(j)}addEventSourceToCalendar("google_"+g,l);showLoadingOnCalendar(false)})})})})}function ts2googleDate(b){return $.fullCalendar.formatDate($.fullCalendar.parseDate(b),"u")}function google2fcEvent(b){var d={title:b.summary||"No title",start:b.start.date||b.start.dateTime,end:b.end.date||b.end.dateTime,allDay:b.start.date?true:false,google:b,className:"b-l b-2x b-dark b-b-l-r-2x b-t-l-r-2x fc_border_height",backgroundColor:"#fff",editable:false};if(d.allDay){var c;if(d.end.length>10){c=$.fullCalendar.parseDate(d.end);d.end=$.fullCalendar.formatDate(c,"yyyy-mm-dd")}else{c=new Date(d.end)}c.setDate(c.getDate()-1);d.end=c.format("yyyy-mm-dd")}return d}var popover_call;function isArray(b){return Object.prototype.toString.apply(b)==="[object Array]"}function load_events_from_google(j){var f;var d=JSON.parse(_agile_get_prefs("event-lhs-filters"));if(d){f=d[CURRENT_AGILE_USER.id]}if(!(f)){return}var h=false;if(f){var e=f.cal_type;var b=f.owner_ids;if(b&&b.length>0){$.each(b,function(k,l){if(l){if(l.id==CURRENT_AGILE_USER.id){h=true}}})}if(e){var g=e.length;if(g>0){var c=e.indexOf("google");if(c>=0){}else{return}}else{return}}else{return}}get_google_calendar_prefs(j)}function get_google_calendar_prefs(e){var d="_agile_google_calendar_prefs_"+CURRENT_DOMAIN_USER.id;var c=_agile_get_prefs(d);if(c&&c!="null"){var b=JSON.parse(c);if(b.expires_at-(2*60*1000)>=new Date().getTime()){return get_google_calendar_event_source(b,e)}erase_google_calendar_prefs_cookie()}$.getJSON("/core/api/calendar-prefs/refresh-token",function(f){if(!f){return}_agile_set_prefs(d,JSON.stringify(f));return get_google_calendar_event_source(f,e)})}function erase_google_calendar_prefs_cookie(){var b="_agile_google_calendar_prefs_"+CURRENT_DOMAIN_USER.id;_agile_delete_prefs(b);_agile_delete_prefs(b)}function get_calendar_ids_form_prefs(e){if(!e){return}var b=["primary"];if(e.prefs){try{var c;if(typeof e.prefs!="object"){c=JSON.parse(e.prefs)}else{c=e.prefs}if(c.fields!=null){b=c.fields}}catch(d){console.log(d)}}return b}function get_google_calendar_event_source(b,c){if(c&&typeof(c)==="function"){c({token:b.access_token,dataType:"agile-gcal",className:"agile-gcal",calendarIds:get_calendar_ids_form_prefs(b)})}return true}var fullCal;function showCalendar(d){_init_gcal_options(d);put_thirdparty_calendar_links();var b=(!_agile_get_prefs("calendarDefaultView"))?"month":_agile_get_prefs("calendarDefaultView");$("#"+b).addClass("bg-light");var c=400;if(b=="agendaDay"||b=="agendaWeek"){c=575}fullCal=$("#calendar_event").fullCalendar({monthNames:$.fn.datepicker.dates.en.months,monthNamesShort:$.fn.datepicker.dates.en.monthsShort,dayNames:$.fn.datepicker.dates.en.days,dayNamesShort:$.fn.datepicker.dates.en.daysShort,allDayText:"all-day",eventSources:[{events:function(e,j,p){var l;var o=JSON.parse(_agile_get_prefs("event-lhs-filters"));if(o){l=o[CURRENT_AGILE_USER.id]}var h="";if(l){var m=l.cal_type;var g=l.owner_ids;$.each(m,function(r,s){if(s=="agile"){g.push(CURRENT_AGILE_USER.id)}});var n=m.length;if(n>0){var q=m.indexOf("google");if(q>=0){}var q=m.indexOf("office");if(q>=0){addOffice365CalendarEvents()}var q=m.indexOf("agile");if(q>=0||(g&&g.length>0)){}else{p([]);return}}}var f={};f.startTime=e.getTime()/1000;f.endTime=j.getTime()/1000;console.log(f.startTime+" : "+f.endTime);_agile_set_prefs("fullcalendar_start_end_time",JSON.stringify(f));var k="/core/api/events?start="+e.getTime()/1000+"&end="+j.getTime()/1000;if(g&&g.length>0){$.each(g,function(r,s){addEventsToCalendar(k+"&owner_id="+s)})}},dataType:"agile-events"},{dataType:"agile-gcal",},],header:{left:"prev",center:"title",right:"next"},defaultView:b,slotEventOverlap:false,viewDisplay:function(e){_agile_set_prefs("calendarDefaultView",e.name,90);$(".fc-agenda-axis").addClass("bg-light lter")},loading:function(e){if(e){pushLoading();$("#loading_calendar_events").remove();$(".fc-header-left","#calendar_event").append('<span id="loading_calendar_events" style="margin-left:5px;vertical-align:middle;padding-top: 5px;position: absolute;">'+_agile_get_translated_val("tickets","loading")+"</span>").show();$(".fc-header-left","#calendar_event").show()}else{if(popLoading()<=0){$("#loading_calendar_events").hide();start_tour("calendar")}}$(".fc-agenda-axis").addClass("bg-light lter");$(".ui-resizable-handle").hide()},selectable:true,selectHelper:true,editable:true,theme:false,contentHeight:c,firstDay:CALENDAR_WEEK_START_DAY,firstHour:7,themeButtonIcons:{prev:"fc-icon-left-single-arrow",next:"fc-icon-right-single-arrow"},eventMouseover:function(e,l,m){b=(!_agile_get_prefs("calendarDefaultView"))?"month":_agile_get_prefs("calendarDefaultView");var n="";var j="";var k="left";var p="";var o="";var f=300;var h=$(this);var g=l.currentTarget;if(h.data("data_fetched")){e.contacts=h.data("data_fetched");
calendar_Popover(e,b,h,f,g,k,p,o,n,j);return}if(e.id!=undefined){popover_call=$.ajax({url:"/core/api/events/contacts-related?id="+e.id,dataType:"json",success:function(q){console.log(q);h.data("data_fetched",q);e.contacts=q;calendar_Popover(e,b,h,f,g,k,p,o,n,j)}})}else{calendar_Popover(e,b,h,f,g,k,p,o,n,j)}},eventMouseout:function(g,f,e){if(popover_call){popover_call.abort()}$(this).parent().find(".fc-overlayw").hide();$(this).parent().find(".fc-overlayw").remove();$(this).find(".ui-resizable-handle").hide();$(f.currentTarget).css("z-index",8);if(g.allDay){$(f.currentTarget.parentElement).css("z-index",8)}},eventAfterRender:function(h,g,e){$(".ui-resizable-handle").hide();h=renderEventBasedOnOwner(h);var f=new Date(h.start).getTime()/1000;var j=new Date(h.end).getTime()/1000;if(j-f==3600){$(g).height("")}if(h.type=="officeCalendar"){$(g).height("")}},select:function(g,e,f){$("#activityModal").html(getTemplate("new-event-modal")).modal("show");highlight_event();$("#task-date-1").val(getDateInFormat(g));$("#event-date-1").val(getDateInFormat(g));$("#event-date-2").val(getDateInFormat(e));if((g.getHours()==0)&&(e.getHours()==0)&&(e.getMinutes()==0)){$("#event-time-1").val("");$("#event-time-2").val("")}else{$("#event-time-1").val((g.getHours()<10?"0":"")+g.getHours()+":"+(g.getMinutes()<10?"0":"")+g.getMinutes());$("#event-time-2").val((e.getHours()<10?"0":"")+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes())}},eventDrop:function(g,f,e,j,h){if(!hasScope("MANAGE_CALENDAR")&&(CURRENT_DOMAIN_USER.id!=g.owner.id)){h();$("#moveEventErrorModal").html(getTemplate("move-event-error-modal")).modal("show");return}showAlertModal("event_drop","confirm",function(){g=revertEventColorBasedOnPriority(g);var m=$.extend(true,{},g);m.start=new Date(m.start).getTime()/1000;m.end=new Date(m.end).getTime()/1000;if(m.end==null||m.end==0){m.end=m.start}var n=m.contacts;var o=[];for(var k in n){o.push(n[k].id)}if(m.owner){m.owner_id=m.owner.id}delete m.contacts;delete m.owner;m;m.contacts=o;var l=new Backbone.Model();l.url="core/api/events";l.save(m,{error:function(q,p){showModalConfirmation(_agile_get_translated_val("events","update-event"),p.responseText,function(){h()},function(){return},function(){return},_agile_get_translated_val("contact-details","cancel"))}})},function(){h()})},eventClick:function(h){h=revertEventColorBasedOnPriority(h);if(isNaN(h.id)){return}$("#updateActivityModal").html(getTemplate("update-activity-modal")).modal("show");deserializeForm(h,$("#updateActivityForm"));$("#update-event-time-1").val((h.start.getHours()<10?"0":"")+h.start.getHours()+":"+(h.start.getMinutes()<10?"0":"")+h.start.getMinutes());$("#update-event-time-2").val((h.end.getHours()<10?"0":"")+h.end.getHours()+":"+(h.end.getMinutes()<10?"0":"")+h.end.getMinutes());var e="mm/dd/yyyy";$("#update-event-date-1").val(getDateInFormat(h.start));$("#update-event-date-2").val(getDateInFormat(h.end));if(h.allDay){$("#update-event-date-2").closest(".row").hide();$("#update-event-time-1").closest(".control-group").hide()}else{$("#update-event-time-1").closest(".control-group").show();$("#update-event-date-2").closest(".row").show()}if(h.type=="WEB_APPOINTMENT"&&parseInt(new Date(h.start).getTime()/1000)>parseInt(new Date().getTime()/1000)){$("[id='event_delete']").attr("id","delete_web_event");web_event_title=h.title;if(h.contacts.length>0){var j=getPropertyValue(h.contacts[0].properties,"first_name");if(j==undefined){j=""}var g=getPropertyValue(h.contacts[0].properties,"last_name");if(g==undefined){g=""}web_event_contact_name=j+" "+g}}else{$("[id='delete_web_event']").attr("id","event_delete")}if(h.description){var f='<label class="control-label"><b>'+_agile_get_translated_val("misc-keys","description")+' </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div>';$("#event_desc").html(f);$("textarea#description").val(h.description)}else{var k='<div class="row-fluid"><div class="control-group form-group m-b-none " id="addEventDescription"><a href="#" id="add_event_desctiption"><i class="icon-plus"></i> '+_agile_get_translated_val("misc-keys","add-description")+' </a><div class="controls event_discription hide"><textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div></div></div>';$("#event_desc").html(k)}App_Calendar.current_event=h;agile_type_ahead("event_relates_to_deals",$("#updateActivityModal"),deals_typeahead,false,null,null,"core/api/search/deals",false,true);populateUsersInUpdateActivityModal(h);return false}})}function showEventFilters(){$("#filter_options").show();if(_agile_get_prefs("agile_calendar_view")){$("#filter_options .calendar-view").hide()}else{$("#filter_options .list-view").hide()}if(_agile_get_prefs("event-filters")){var b=JSON.parse(_agile_get_prefs("event-filters"));$("#event-owner").val(b.owner_id);$("#event_type").val(b.type)}}function buildEventFilters(){$.getJSON("/core/api/users/agileusers",function(d){var b="",c="";if(d){$.each(d,function(f,e){if(CURRENT_DOMAIN_USER.id==e.domain_user_id){c="<option value="+e.id+">"+_agile_get_translated_val("others","me")+"</option>"}else{if(e.domainUser){b+="<option value="+e.id+">"+e.domainUser.name+"</option>"}}});b+='<option value="">'+_agile_get_translated_val("portlets","any")+"</option>"}$("#event-owner").html(c+b)})}function loadDefaultFilters(b){if(!_agile_get_prefs("event-filters")){$.getJSON("/core/api/users/current-agile-user",function(c){if(CURRENT_DOMAIN_USER.id==c.domain_user_id){var d={};d.owner_id=c.id.toString();d.type="";_agile_set_prefs("event-filters",JSON.stringify(d))}if(b){b()}})}}$(function(){$(document).mouseup(function(c){var b=$("#filter_options");if(!b.is(c.target)&&b.has(c.target).length===0){b.hide()}})});function changeView(b){currentView=b;fullCal.fullCalendar("changeView",b)}function today(){fullCal.fullCalendar("today")}function refreshcal(){fullCal.fullCalendar("refetchEvents")}function getCalendarUsersDetails(b){accessUrlUsingAjax("/core/api/users/agileusers",function(d){if(!d){return b(d)}var c=[];$.each(d,function(g,f){if(CURRENT_DOMAIN_USER.id==f.domain_user_id){CURRENT_AGILE_USER=f;return}if(f.domainUser){var e={};e.id=f.id;e.name=f.domainUser.name;e.domain_user_id=f.domainUser.id;if(hasScope("VIEW_CALENDAR")){c.push(e)}}});return b(c)})}function setUpStarRating(d){var c="";for(var b=0;b<5;b++){if(b<parseInt(d)){c=c.concat('<li style="display: inline;"><img src="'+updateImageS3Path("img/star-on.png")+'" alt="'+b+'"></li>');continue}c=c.concat('<li style="display: inline;"><img src="'+updateImageS3Path("img/star-off.png")+'" alt="'+b+'"></li>')}return c}function calendar_Popover(b,k,g,c,f,l,p,o,n,j){$(".fc-overlayw").hide();$(".fc-overlayw").remove();if(k=="month"){console.log("month");c=g.parents(".fc-view-month").find(".fc-widget-content").eq(0).width()*2;var d=f.offsetLeft+f.offsetWidth+10;var m=f.offsetTop;if(g.parents(".fc-view-month").find(".fc-border-separate:visible").width()-d<c){d=f.offsetLeft-c-10;l="right"}if(g.parents(".fc-view-month").find(".fc-border-separate:visible").width()-c-20<f.offsetWidth){d=((f.offsetLeft+f.offsetWidth+10)/2)-(c/2);m=f.offsetTop+f.offsetHeight+10;l="top"}var q={};q.leftorright=l;q.popover_min_width=c;q.popover_min_width=c;q.left=d;q.top=m;q.pullupornot=p;q.event=b;if(b.type=="officeCalendar"){g.after($(getTemplate("office-calendar-mouseover-popover",q)))}else{g.after($(getTemplate("calendar-mouseover-popover",q)))}g.parent().find(".fc-overlayw").show();g.find(".ui-resizable-handle").show();if(g.parents(".fc-view-month").find(".fc-border-separate:visible").height()-f.offsetTop<g.parent().find(".fc-overlayw").height()){g.parent().find(".fc-overlayw").css("top",m-g.parent().find(".fc-overlayw").height()+f.offsetHeight+20+"px");g.parent().find(".fc-overlayw").find(".arrow").css("top",g.parent().find(".fc-overlayw").height()-31+"px")}if(g.parents(".fc-view-month").find(".fc-border-separate:visible").width()-c-20<f.offsetWidth){g.parent().find(".fc-overlayw").find(".arrow").css("top","-9px")}if((g.parents(".fc-view-month").find(".fc-border-separate:visible").height()-f.offsetTop-f.offsetHeight-10<g.parent().find(".fc-overlayw").height()+10)&&(g.parents(".fc-view-month").find(".fc-border-separate:visible").width()-c-20<f.offsetWidth)){g.parent().find(".fc-overlayw").find(".arrow").removeClass("top").addClass("bottom");d=((f.offsetLeft+f.offsetWidth+10)/2)-(c/2);m=f.offsetTop-g.parent().find(".fc-overlayw").height()+10;g.parent().find(".fc-overlayw").css({top:m+"px",lef:d+"px"});g.parent().find(".fc-overlayw").find(".arrow").css("top",g.parent().find(".fc-overlayw").height()-22+"px")}}else{if(k=="agendaWeek"){console.log("agendaWeek");c=$(".fc-view-agendaWeek").find(".fc-widget-content").eq(0).width()*2;var d=f.offsetLeft+f.offsetWidth+10;var m=f.offsetTop;if($(".fc-agenda-slots:visible").width()-d<c){d=f.offsetLeft-c-10;l="right"}var q={};q.leftorright=l;q.popover_min_width=c;q.left=d;q.top=m;q.pullupornot=p;q.event=b;if(b.type=="officeCalendar"){g.after(getTemplate("week-office-calendar-mouseover-popover",q))}else{g.after(getTemplate("week-calendar-mouseover-popover",q))}g.parent().find(".fc-overlayw").show();g.find(".ui-resizable-handle").show();if($(".fc-agenda-slots:visible").height()-f.offsetTop<g.parent().find(".fc-overlayw").height()){g.parent().find(".fc-overlayw").css("top",m-g.parent().find(".fc-overlayw").height()+f.offsetHeight+20+"px");g.parent().find(".fc-overlayw").find(".arrow").css("top",g.parent().find(".fc-overlayw").height()-31+"px")}}else{if(k=="agendaDay"){console.log("agendaDay");var d=f.offsetLeft;var m=f.offsetTop+f.offsetHeight+10;l="top";if($(".fc-agenda-slots:visible").width()-f.offsetLeft<c){d=f.offsetLeft-f.offsetWidth-($(".fc-agenda-slots:visible").width()-f.offsetLeft-f.offsetWidth)}var q={};q.leftorright=l;
q.popover_min_width=c;q.left=d;q.top=m;q.pullupornot=p;q.event=b;if(b.type=="officeCalendar"){g.after(getTemplate("day-office-calendar-mouseover-popover",q))}else{try{g.after(getTemplate("day-calendar-mouseover-popover",q))}catch(h){}}g.parent().find(".fc-overlayw").show();g.find(".ui-resizable-handle").show();g.parent().find(".fc-overlayw").find(".arrow").css({top:"-9px",left:"11px"});if($(".fc-agenda-slots:visible").width()-f.offsetLeft<c){g.parent().find(".fc-overlayw").find(".arrow").css({top:"-9px",left:c-15+"px"})}if((f.offsetTop<g.parent().find(".fc-overlayw").height()+10)&&($(".fc-agenda-slots:visible").height()-f.offsetHeight<g.parent().find(".fc-overlayw").height()+10)){g.parent().find(".fc-overlayw").css("top",f.offsetTop+40+"px")}if((f.offsetTop>g.parent().find(".fc-overlayw").height()+10)&&($(".fc-agenda-slots:visible").height()-(f.offsetHeight+f.offsetTop)<g.parent().find(".fc-overlayw").height()+10)){g.parent().find(".fc-overlayw").find(".arrow").removeClass("top").addClass("bottom");g.parent().find(".fc-overlayw").css("top",m-g.parent().find(".fc-overlayw").height()-37+"px");g.parent().find(".fc-overlayw").find(".arrow").css("top",g.parent().find(".fc-overlayw").height()-3+"px");if($(".fc-agenda-slots:visible").width()-f.offsetLeft<c){g.parent().find(".fc-overlayw").css("left",f.offsetLeft-f.offsetWidth-($(".fc-agenda-slots:visible").width()-f.offsetLeft-f.offsetWidth)+"px")}}}}}$(f).css("z-index",9);if(b.allDay){$(f.parentElement).css("z-index",9)}}function append_contact_activities_log(b){var c=new Base_List_View({model:b,view:"inline",template:this.options.templateKey+"-model",tagName:"li",});var e=get_activity_created_time(b.get("time"));if(e==0){$("#earllier").show();$("#earlier-heading").addClass("ref-head");var d=$("#today-heading",this.el);$("#contact-activity-today-list-log-model-list",this.el).append(c.render().el);$("#contact-activity-today-list-log-model-list",this.el).parent("table").css("display","block");$("#contact-activity-today-list-log-model-list",this.el).show();$("#today-heading",this.el).show()}if(e==-1){$("#earllier").show();$("#earlier-heading").addClass("ref-head");var d=$("#tomorrow-heading",this.el);$("#contact-activity-yesterday-list-log-model-list",this.el).append(c.render().el);$("#contact-activity-yesterday-list-log-model-list",this.el).parent("table").css("display","block");$("#contact-activity-yesterday-list-log-model-list",this.el).show();$("#yesterday-heading",this.el).show()}if(e<-1){var d=$("#next-week-heading",this.el);$("#contact-activity-earlier-list-log-model-list",this.el).append(c.render().el);$("#contact-activity-earlier-list-log-model-list",this.el).parent("table").css("display","block");$("#contact-activity-earlier-list-log-model-list",this.el).show();$("#earlier-heading",this.el).show()}}function createRequestUrlBasedOnFilter(){var b=[];var d=[];var g=[];var c="";$(".calendar_check").each(function(){if(this.checked){b.push($(this).val())}});$(".calendar_user_check").each(function(){if(this.checked){d.push($(this).val());g.push($(this).attr("data"))}});if(_agile_get_prefs("agile_calendar_view")){c=$("#event_time").val()}var f=[];$.each(d,function(j,k){if($.inArray(k,f)===-1){f.push(k)}});d=f;var h={};h.cal_type=b;h.owner_ids=d;h.domain_user_ids=g;var e=JSON.parse(_agile_get_prefs("event-lhs-filters"));e[CURRENT_AGILE_USER.id]=h;_agile_set_prefs("event-lhs-filters",JSON.stringify(e))}function buildCalendarLhsFilters(){var j={};j.cal_type=["agile"];j.owner_ids=[];j.domain_user_ids=[];var h;var e=JSON.parse(_agile_get_prefs("event-lhs-filters"));var c={};if(e){h=e[CURRENT_AGILE_USER.id];if(!h){h=j;c[CURRENT_AGILE_USER.id]=j;_agile_set_prefs("event-lhs-filters",JSON.stringify(c))}else{c[CURRENT_AGILE_USER.id]=h}}else{h=j;c[CURRENT_AGILE_USER.id]=j;_agile_set_prefs("event-lhs-filters",JSON.stringify(c))}if(h){var g=h.cal_type;var d=h.owner_ids;var b=h.events_time;var f=h.event_type;if(g){$.each(g,function(k,l){$(".calendar_check").each(function(){if($(this).val()==l){this.checked=true}})})}if(d&&d.length>0){$.each(d,function(k,l){$(".calendar_user_check").each(function(){if($(this).val()==l){this.checked=true}})})}}}function loadFullCalednarOrListView(){if(_agile_get_prefs("agile_calendar_view")){var c;var b=JSON.parse(_agile_get_prefs("event-lhs-filters"));if(b){c=b[CURRENT_AGILE_USER.id]}if(c){if(c.event_type=="future"){_agile_set_prefs("agile_calendar_view","calendar_list_view_future")}else{_agile_set_prefs("agile_calendar_view","calendar_list_view")}}else{_agile_set_prefs("agile_calendar_view","calendar_list_view")}}if(!_agile_get_prefs("agile_calendar_view")){$("#calendar_event").html("");showCalendar()}else{loadAgileEvents();loadGoogleEvents()}}function checkBothCalWhenNoCalSelected(){var b=[];$(".calendar_check").each(function(){if(this.checked){b.push($(this).val())}});if(b&&b.length==0){$(".calendar_check").each(function(){this.checked=true});createRequestUrlBasedOnFilter();loadFullCalednarOrListView()}}function putGoogleCalendarLink(b){if(b){$("#google_cal").removeClass("hide");$("#google_cal_link").addClass("hide")}else{$("#google_cal").addClass("hide");$("#google_cal_link").removeClass("hide")}}function put_thirdparty_calendar_links(){putOfficeCalendarLink(false);putGoogleCalendarLink(false);$.getJSON("core/api/calendar-prefs/list",function(b){console.log(b);$.each(b,function(d,e){console.log(e);if(e.calendar_type=="GOOGLE"){putGoogleCalendarLink(true)}else{if(e.calendar_type=="OFFICE365"){var f=JSON.parse(_agile_get_prefs("event-lhs-filters"));f=f[CURRENT_AGILE_USER.id];var c=f.cal_type;var g=false;if(c.indexOf("office")>=0){g=true}else{g=false}$('input:checkbox[value="office"]').attr("checked",g);putOfficeCalendarLink(true)}}})})}function putOfficeCalendarLink(b){if(b){$("#office_cal").removeClass("hide");$("#office_cal_link").addClass("hide")}else{$("#office_cal").addClass("hide");$("#office_cal_link").removeClass("hide")}}function renderFullCalenarEvents(c){var d=JSON.parse(_agile_get_prefs("fullcalendar_start_end_time"));var b="/core/api/events?start="+d.startTime+"&end="+d.endTime;b+="&owner_id="+c;console.log("-----------------",b);addEventsToCalendar(b)}var functions={};function addEventsToCalendar(c){var b={};if(!c){return}showLoadingOnCalendar(true);$.getJSON(c,function(d){if(d&&d.length>0){$.each(d,function(e,f){console.log(f);if(!b[f.owner.id]){var g=[];b[f.owner.id]=g}f=renderEventBasedOnOwner(f);b[f.owner.id].push(f)})}console.log(b);$.each(b,function(f,e){console.log(f);addEventSourceToCalendar(f,e)});showLoadingOnCalendar(false)})}function addEventSourceToCalendar(c,b){$("#calendar_event").fullCalendar("removeEventSource",functions["event_"+c]);functions["event_"+c]=function(f,d,e){console.log(this);console.log("function : event_"+functions["event_"+c]);e(b)};$("#calendar_event").fullCalendar("addEventSource",functions["event_"+c]);b=[]}function removeGoogleEventSource(){$.each(functions,function(b,c){if(b.indexOf("event_google")==0){$("#calendar_event").fullCalendar("removeEventSource",functions[b])}})}function removeEventSource(b){$("#calendar_event").fullCalendar("removeEventSource",functions["event_"+b])}function addGoogleCalendarEvents(){addAsyncCalendarEvents(loadUserEventsfromGoogle)}function addOffice365CalendarEvents(){addAsyncCalendarEvents(loadOfficeEvents)}function addAsyncCalendarEvents(c){if(!c||typeof c!="function"){return}var b=function(f,d,e){c(f,d);e({});$("#calendar_event").fullCalendar("removeEventSource",b);return};$("#calendar_event").fullCalendar("addEventSource",b)}function removeFullCalendarEvents(b){if(!b){return}showLoadingOnCalendar(true);removeEventSource(b);$("#calendar_event").fullCalendar("removeEvents",function(d,c){if(d&&d.owner&&d.owner.id){return d.owner.id==b}else{return false}});showLoadingOnCalendar(false)}function getOwnerIdsFromCookie(c){var g;var d=JSON.parse(_agile_get_prefs("event-lhs-filters"));if(d){g=d[CURRENT_AGILE_USER.id]}var f="";if(g){var e=g.cal_type;var b=g.owner_ids;if(c&&b.length>=1){b=[]}b.push(CURRENT_AGILE_USER.id);if(b&&b.length>0){$.each(b,function(h,j){if(h>=1){f+=","}f+=j})}}return f}function loadGoogleEventsandRender(){var b=JSON.parse(_agile_get_prefs("fullcalendar_start_end_time"));$.getJSON("core/api/calendar-prefs/get",function(c){console.log(c);if(c){_agile_set_prefs("google_event_token",c.access_token);head.js("https://apis.google.com/js/client.js","/lib/calendar/gapi-helper.js?t=27",function(){setupGC(function(){gapi.auth.setToken({access_token:c.access_token,state:"https://www.googleapis.com/auth/calendar"});var d=new Date(b.startTime*1000);var e=d.toISOString();var g=new Date(b.endTime*1000);var h=g.toISOString();var f=gapi.client.calendar.events.list({calendarId:"primary",singleEvents:true,timeMin:e,timeMax:h});f.execute(function(l){if(l){for(var k=0;k<l.items.length;k++){var j=google2fcEvent(l.items[k]);if(j){$("#calendar_event").fullCalendar("renderEvent",j)}}}})})})}})}function renderAddedEventToFullCalenarBasedOnCookie(e){try{var k=false;var j=false;var f;var h=JSON.parse(_agile_get_prefs("event-lhs-filters"));if(h){f=h[CURRENT_AGILE_USER.id]}if(f){var g=f.cal_type;for(var b in g){if(g[b]=="agile"){j=true}}}if(e.owner.id==CURRENT_DOMAIN_USER.id&&j){k=true}if(f&&!k){var c=f.domain_user_ids;if(c&&c.length>0){$.each(c,function(l,m){if(m==e.owner.id){k=true}})}}if(k){$("#calendar_event").fullCalendar("renderEvent",e)}}catch(d){console.log("error")}}function renderEventBasedOnOwner(c){try{if(c.owner){if(c.owner.id==CURRENT_DOMAIN_USER.id){if(c.color=="red"||c.color=="#f05050"){c.className="fc-b-l fc-b-2x fc-b-danger fc-border-height fc-event-month"}else{if(c.color=="green"||c.color=="#bbb"){c.className="fc-b-l fc-b-2x fc-b-info fc-border-height fc-event-month"}else{if(c.color=="#36C"||c.color=="#23b7e5"||c.color=="blue"){c.className="fc-b-l fc-b-2x fc-b-warning fc-border-height fc-event-month"}}}c.color=""}else{if(c.color=="red"||c.color=="#f05050"){c.className="high fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month"}else{if(c.color=="green"||c.color=="#bbb"){c.className="low fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month"
}else{if(c.color=="#36C"||c.color=="#23b7e5"||c.color=="blue"){c.className="normal fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month"}}}c.color=""}}}catch(b){console.log("error")}return c}function revertEventColorBasedOnPriority(b){if(b.className=="fc-b-l,fc-b-2x,fc-b-danger,fc-border-height,fc-event-month"||b.className=="high,fc-b-l,fc-b-2x,fc-b-light,fc-border-height,fc-event-month"||b.className=="fc-b-l fc-b-2x fc-b-danger fc-border-height fc-event-month"||b.className=="high fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month"){b.color="red"}else{if(b.className=="fc-b-l,fc-b-2x,fc-b-info,fc-border-height,fc-event-month"||b.className=="low,fc-b-l,fc-b-2x,fc-b-light,fc-border-height,fc-event-month"||b.className=="fc-b-l fc-b-2x fc-b-info fc-border-height fc-event-month"||b.className=="low fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month"){b.color="green"}else{if(b.className=="fc-b-l,fc-b-2x,fc-b-warning,fc-border-height,fc-event-month"||b.className=="normal,fc-b-l,fc-b-2x,fc-b-light,fc-border-height,fc-event-month"||b.className=="fc-b-l fc-b-2x fc-b-warning fc-border-height fc-event-month"||b.className=="normal fc-b-l fc-b-2x fc-b-light fc-border-height fc-event-month"){b.color="#36C"}}}return b}var loadingCounter=0;function pushLoading(){if(loadingCounter<0){loadingCounter=0}loadingCounter++;return loadingCounter}function popLoading(){loadingCounter--;return loadingCounter}function showLoadingOnCalendar(b){if(b){pushLoading();$("#loading_calendar_events").remove();$("#user_calendars *").attr("disabled","disabled");$("#user_cal_sub *").attr("disabled","disabled");$("#user_calendars *").addClass("disable-cp");$("#user_cal_sub *").addClass("disable-cp");$(".fc-header-left","#calendar_event").append('<span id="loading_calendar_events" style="margin-left:5px;vertical-align:middle;padding-top: 5px;position: absolute;">'+_agile_get_translated_val("tickets","loading")+"</span>").show();$(".fc-header-left","#calendar_event").show()}else{if(popLoading()<=0){$("#loading_calendar_events").hide();$("#user_calendars *").removeAttr("disabled");$("#user_cal_sub *").removeAttr("disabled");$("#user_calendars *").removeClass("disable-cp");$("#user_cal_sub *").removeClass("disable-cp")}}}var ACTIVITY_FILTER="activity-filters-cookie";var ACTIVITY_FILTER_JSON={};function includeTimeAgo(b){agileTimeAgoWithLngConversion($("time",b))}function buildActivityFilters(b,d,c){if(c=="entityDropDown"){ACTIVITY_FILTER_JSON.entity=b;ACTIVITY_FILTER_JSON.entityId=d}else{if(c=="userDropDown"){ACTIVITY_FILTER_JSON.user=b;ACTIVITY_FILTER_JSON.userId=d}}_agile_set_prefs(ACTIVITY_FILTER,JSON.stringify(ACTIVITY_FILTER_JSON))}function renderActivityView(b){this.activitiesview=new Base_Collection_View({url:"/core/api/activitylog/getActivitiesOnSelectedCondition"+b,sortKey:"time",descending:true,templateKey:"activity-list-log",sort_collection:false,cursor:true,scroll_symbol:"scroll",page_size:20,individual_tag_name:"li",postRenderCallback:function(c){includeTimeAgo(c);initializeActivitiesListner(c);initializeEventListners(c);contactListener(c)},appendItemCallback:function(c){includeTimeAgo(c)}});activitiesview.appendItem=append_activity_log;this.activitiesview.collection.fetch();$("#activity-list-based-condition").html(this.activitiesview.render().el)}function getActivityFilterParameters(l,g){$("#activities_date_range").show();var e="?";var f=null;var b=null;var h=$("#activities_date_range #range").html().split("-");if(h){var j=getUTCMidNightEpochFromDate(_agile_date_utility.get_date_from_string($.trim(h[0])));var c=$.trim(h[1]);if(c){c=c+" 23:59:59"}var d=getUTCMidNightEpochFromDate(_agile_date_utility.get_date_from_string(c));d+=(((23*60*60)+(59*60)+59)*1000);e+=("start_time="+j+"&end_time="+d)}if(l){var k=JSON.parse(_agile_get_prefs(ACTIVITY_FILTER));if(k){f=k.userId;if(k.entityId){b=k.entityId;if(g){b="ALL";$("#activities_date_range").hide()}}else{if(g){b="ALL";$("#activities_date_range").hide()}else{b="ALL"}}}else{if(g){b="ALL";$("#activities_date_range").hide()}b="ALL"}if(f){e+=("&user_id="+f)}e+=("&entity_type="+b);return e}f=$("#user-select").data("selected_item");b=$("#entity_type").data("selected_item");document.location.hash="activities";if(f){e+=("&user_id="+f)}if(b=="TASK"){e+=("&entity_type="+b);return e}else{if(b=="DEAL"){e+=("&entity_type="+b);return e}else{if(b=="USER"){e+=("&entity_type="+b);return e}else{if(b=="EVENT"){e+=("&entity_type="+b);return e}else{if(b=="CONTACT"){e+=("&entity_type="+b);return e}else{if(b=="DOCUMENT"){e+=("&entity_type="+b);return e}else{if(b=="CALL"){e+=("&entity_type="+b);return e}else{if(b=="TICKET"){e+=("&entity_type="+b);return e}else{if(b=="CAMPAIGN"){e+=("&entity_type="+b);return e}else{e+=("&entity_type=ALL");return e}}}}}}}}}return e}function initActivitiesDateRange(){$("#activities_date_range").daterangepicker({ranges:{Today:["today","today"],Yesterday:["yesterday","yesterday"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 30 Days":[Date.today().add({days:-29}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})],"This Quarter":[Date.today().getMonth()<3?new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth():new Date(Date.today().setMonth(9)).moveToFirstDayOfMonth(),Date.today().getMonth()<3?new Date(Date.today().setMonth(2)).moveToLastDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(5)).moveToLastDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(8)).moveToLastDayOfMonth():new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()],"Last Quarter":[Date.today().getMonth()<3?new Date(Date.today().add({years:-1}).setMonth(9)).moveToFirstDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth():new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth(),Date.today().getMonth()<3?new Date(Date.today().add({years:-1}).setMonth(11)).moveToLastDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(2)).moveToLastDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(5)).moveToLastDayOfMonth():new Date(Date.today().setMonth(8)).moveToLastDayOfMonth()],"This Year":[new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth(),new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()],"Last Year":[new Date(Date.today().setMonth(0)).add({years:-1}).moveToFirstDayOfMonth(),new Date(Date.today().setMonth(11)).add({years:-1}).moveToLastDayOfMonth()]},locale:{applyLabel:"Apply",clearLabel:"Clear",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",daysOfWeek:$.fn.datepicker.dates.en.daysExactMin,monthNames:$.fn.datepicker.dates.en.months,firstDay:parseInt(CALENDAR_WEEK_START_DAY)}},function(e,c){if(e&&c){$("#activities_date_range #range").html(e.toString("MMMM d, yyyy")+" - "+c.toString("MMMM d, yyyy"));renderActivityView(getActivityFilterParameters())}else{var d=Date.parse("today");var b=Date.today().add({days:parseInt(-6)});$("#activities_date_range #range").html(b.toString("MMMM d, yyyy")+" - "+d.toString("MMMM d, yyyy"));renderActivityView(getActivityFilterParameters());$(".daterangepicker > .ranges > ul > li.active").removeClass("active")}});$(".daterangepicker > .ranges > ul").on("click","li",function(b){$(".daterangepicker > .ranges > ul > li").each(function(){$(this).removeClass("active")});$(this).addClass("active")})}var notesView;var contactRelatedView;var taskActivitiesView;var dealRelatedView;var task_details_tab={load_timeline:function(){$("div.tab-content",App_Tasks.taskDetailView.el).find("div.active").removeClass("active");$("#time-line",App_Tasks.taskDetailView.el).addClass("active");if($("#timeline",App_Tasks.taskDetailView.el).hasClass("isotope")){$("#timeline",App_Task.taskDetailView.el).isotope("reLayout",function(){});return}load_timeline_details(App_Tasks.taskDetailView.el,App_Tasks.taskDetailView.model.get("id"))},load_notes:function(){var b=taskDetailView.id;notesView=new Base_Collection_View({url:"/core/api/tasks/"+b+"/notes",restKey:"note",templateKey:"task_notes",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(c){agileTimeAgoWithLngConversion($(".note-created-time",c))}});notesView.collection.fetch();$("#task_tab_detail").find("#notes").html(notesView.el)},loadTaskRelatedContactsView:function(){var b=taskDetailView.id;contactRelatedView=new Base_Collection_View({url:"/core/api/tasks/"+b+"/contacts",templateKey:"task-related",individual_tag_name:"tr",sortKey:"created_time",descending:true,postRenderCallback:function(c){contactListener()}});contactRelatedView.collection.fetch();$("#task_tab_detail").find("#contacts").html(contactRelatedView.el)},loadActivitiesView:function(){var c=taskDetailView.toJSON();var b=c.domain;taskActivitiesView=new Base_Collection_View({url:"/core/api/activitylog/getActivityByEntityId?entity_id="+c.id+"",templateKey:"task-related-activity",individual_tag_name:"li",sortKey:"time",descending:true,cursor:true,page_size:25,postRenderCallback:function(d){agileTimeAgoWithLngConversion($(".event-created-time",d))}});taskActivitiesView.collection.fetch();$("#task_tab_detail").find("#activity").html(taskActivitiesView.el)},loadTaskRelatedDealsView:function(){var b=taskDetailView.id;dealRelatedView=new Base_Collection_View({url:"/core/api/tasks/"+b+"/deals",templateKey:"task-related-deals",individual_tag_name:"tr",sortKey:"created_time",descending:true,postRenderCallback:function(c){}});
dealRelatedView.collection.fetch();$("#task_tab_detail").find("#deals").html(dealRelatedView.el)},};var CONTENT_JSON={contacts:{title:"You do not have any contacts currently.",description:"Contacts are your customers or prospects that you interact with using Agile.",button_text:"Add Contacts",route:"#",modal_id:"personModal",image:updateImageS3Path("/img/clipboard.png")},filter_results:{title:"No contacts matching this criteria.",route:"#",image:updateImageS3Path("/img/clipboard.png")},filter_results_segments:{title:"There are no contacts for the selected filter. Try refining the filters and the date range.",route:"#",image:updateImageS3Path("/img/clipboard.png")},filter_results_companies:{title:"No companies matching this criteria.",route:"#",image:updateImageS3Path("/img/clipboard.png")},tag_results:{title:"No contacts available with this tag.",route:"#",image:updateImageS3Path("/img/clipboard.png")},companies:{title:"You do not have any companies currently.",description:"companies are prospects that you interact with using Agile.",button_text:"Add Companies",route:"#",modal_id:"companyModal",image:updateImageS3Path("/img/clipboard.png")},workflows:{title:"You do not have any Campaigns currently.",description:"Campaign or workflow is an intelligent sales and marketing automation process for sending your contacts relevant information at the right time.",button_text:"Add Campaign",route:"#workflow-templates",image:updateImageS3Path("/img/clipboard.png")},deals:{title:"No Deals Found.",description:"You either do not have any deals currently, or there are none matching the filter conditions.<br/> Deals are sales opportunities you track continuously throughout its lifecycle.",button_text:"Add Deal",route:"#",modal_id:"opportunityModal",image:updateImageS3Path("/img/clipboard.png")},reports:{title:"You do not have any reports currently.",description:"Reports are based on a variety of tags and filters and receive them periodically to constantly be in touch with your sales cycle and pipeline.",button_text:"Add Report",route:"#report-add",image:updateImageS3Path("/img/clipboard.png")},"activity-reports":{title:"You do not have any activity reports currently.",description:"Get a periodic  email digest of various activities by users in Agile.",button_text:"Add Report",route:"#activity-report-add",image:updateImageS3Path("/img/clipboard.png")},"campaign-reports":{title:"You do not have any campaign reports currently.",description:"Get a periodic  email digest of various campaign reports stats by users in Agile.",button_text:"Add Report",route:"#campaign-report-add",image:updateImageS3Path("/img/clipboard.png")},"contact-filters":{title:"You do not have any filters currently.",description:"Filters are used to sort contacts with a specific criteria to find patterns.",button_text:"Add Filter",route:"#contact-filter-add",image:updateImageS3Path("/img/clipboard.png")},"contact-views":{title:"You do not have any custom views currently.",description:"View is collection of different fields and the order in which you would like them to appear.",button_text:"Add View",route:"#contact-view-add",image:updateImageS3Path("/img/clipboard.png")},"no-tickets":{title:"You do not have any Tickets currently.",description:"Tickets can be problem, incident, question or task escalated by your customers. Set up email forwarding to receive tickets.",button_text:"Set up forwarding",route:"#ticket-groups",image:"/img/clipboard.png"},"no-ticket-filters":{title:"You do not have any Tickets Filters currently.",description:"Tickets Filters are set of conditions to view Tickets which satisfies conditions.",image:"/img/clipboard.png"},dashboard:{contacts:{title:"There is no recent activity.",description:"Perhaps, you may want to create a <a href='#' modal_id='personModal' class='modal-form'>new contact</a>.",icon:"icon-group icon-3x"},tasks:{title:"You have no tasks due",icon:"icon-edit icon-3x"},deals:{title:"No ongoing deals for you",icon:"icon-money icon-3x"},workflows:{title:"No campaign activity yet",description:"Campaigns help you automate your communication with your customers.<br/>You can create a <a href='#workflow-add'>new campaign</a>.",icon:"icon-sitemap icon-3x"}},"email-templates":{title:"You do not have any Email templates currently.",description:"Personalize and customize email templates for every scenario in the sales cycle.",button_text:"Add Email Template",route:"#emailbuilder-templates",image:updateImageS3Path("/img/clipboard.png")},"contact-activities":{title:"No Contact activity recorded yet.",description:"Web and Campaign activity of your contacts is shown here.",image:updateImageS3Path("/img/clipboard.png")},"contact-activities/All_Activities":{title:"No Contact activity recorded yet.",description:"Web and Campaign activity of your contacts is shown here.",image:updateImageS3Path("/img/clipboard.png")},"contact-activities/Page_Views":{title:"No web activity recorded yet.",image:updateImageS3Path("/img/clipboard.png")},"contact-activities/Email_Opened":{title:"No email opens recorded yet.",image:updateImageS3Path("/img/clipboard.png")},"contact-activities/Email_Clicked":{title:"No email clicks recorded yet.",image:updateImageS3Path("/img/clipboard.png")},"contact-activities/Unsubscribed":{title:"No unsubscriptions recorded yet.",image:updateImageS3Path("/img/clipboard.png")},"contact-activities/Spam_Reports":{title:"No spam reports recorded yet.",image:updateImageS3Path("/img/clipboard.png")},"contact-activities/Email_Hard_Bounced":{title:"No hard bouces recorded yet.",image:updateImageS3Path("/img/clipboard.png")},"contact-activities/Email_Soft_Bounced":{title:"No soft bounces recorded yet.",image:updateImageS3Path("/img/clipboard.png")},webpages:{title:"You do not have any Webpages currently.",description:"You can create a page easily by using our smart builder.",button_text:"Add Webpage",route:"#webpage-add",image:updateImageS3Path("/img/clipboard.png")},"deal-filters":{title:"You do not have any filters currently.",description:"Filters are used to sort deals with a specific criteria to find patterns.",button_text:"Add Filter",route:"#deal-filter-add",image:updateImageS3Path("/img/clipboard.png")},dashboards:{title:"There are no user-defined dashboards.",description:"User-defined dashboards allow users to configure multiple dashboards with different dashlets for various purposes.",button_text:"Add Dashboard",route:"#add-dashboard",image:updateImageS3Path("/img/clipboard.png")},};function fill_slate(g,d,c){var f=c;if(!f){f=window.location.hash.split("#")[1]}if(CONTENT_JSON[f]){var e="",b={};if((f=="contacts")&&_agile_get_prefs("company_filter")){e="empty-collection-model";b=CONTENT_JSON.companies}else{if((f=="filter_results")&&company_util.isCompany()){e="empty-collection-model";b=CONTENT_JSON.filter_results_companies}else{e="empty-collection-model";b=CONTENT_JSON[f]}}getTemplate(e,b,undefined,function(h){if(!h){return}$("#"+g,d).html($(h))},$("#"+g,d))}}function getContactPadcontentKey(b){if(!b){return}if(b.indexOf("tag")>0){return"tag_results"}if(b.indexOf("filter")>0){return"filter_results"}return"contacts"}function getSegmentPadcontentKey(b){if(!b){return}return"filter_results_segments"}function getCompanyPadcontentKey(b){if(!b){return}if(b.indexOf("tag")>0){return"tag_results"}if(b.indexOf("filter")>0){return"filter_results"}return"companies"}$(function(){$("body").on("click",".modal-form",function(b){b.preventDefault();var c=$(this).attr("modal_id");if(c=="opportunityModal"){show_deal()}else{if(c=="personModal"){addContactBasedOnCustomfields()}else{$("#"+c).modal("show")}}})});jQuery.validator.addMethod("lpdomain",function(c,b){if(c==""){return true}return/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+$/.test(c)},"Invalid domain.");jQuery.validator.addMethod("lpsubdomain",function(c,b){if(c==""){return true}return/^[a-zA-Z0-9-]+$/.test(c)},"Invalid sub domain.");jQuery.validator.addMethod("lpdirectorypath",function(c,b){if(c==""){return true}return/^(\/\w+)+[a-z0-9-.]+$/.test("/"+c)},"Invalid path.");var LandingPages_Top_Header_Modal_Events=Base_Model_View.extend({events:{"click #sort_menu > li":"LandingpageSort",},LandingpageSort:function(d){d.preventDefault();var f=$(d.currentTarget);var c="",b=$("#sort_menu");if($(f).find("a").hasClass("sort-field")){b.find("li").not(f).find("a.sort-field i").addClass("display-none");$(f).find("a.sort-field i").removeClass("display-none")}else{b.find("li").not(f).find("a.order-by i").addClass("display-none");$(f).find("a.order-by i").removeClass("display-none")}c=b.find(".order-by i:not(.display-none)").closest(".order-by").attr("data");c+=b.find(".sort-field i:not(.display-none)").closest(".sort-field").attr("data");_agile_set_prefs("landingpage_sort_menu",c);this.model.set({sortKey:c})}});var landingpage_collection_events=Base_Collection_View.extend({events:{},});function saveLandingPageToDataStore(c,b){if(isValidForm("#landingPageBuilderForm")){$(".saveLandingPageButton").prop("disabled",true);$(".saveLandingPageButtonText").html("Saving...");document.getElementById("landingPageBuilder").contentWindow.$(".icon-floppy-1:last").trigger("click");if(App_LandingPageRouter.LandingPageCollectionView){App_LandingPageRouter.LandingPageCollectionView.collection.fetch()}if(!c){if(typeof b!=="undefined"&&readData("landingpages-save-popup")!=="true"){getTemplate("landingpages-save-popup-modal",{id:b},undefined,function(d){$("#landingPagesSavePopup").html(d).modal("show");$("#popup-msg").fadeOut(8000)})}}}else{if(!$("#landingpagename").val().trim()){$("html, body").animate({scrollTop:$("body").offset().top},500)}}}function initializeLandingPageListeners(b){$("#landingpages-listeners").off();$("#landingpages-listeners").on("click",".saveLandingPageButton",function(c){c.preventDefault();saveLandingPageToDataStore(false,b);track_with_save_success_model(c.currentTarget)});$("#landingpages-listeners").on("click",".lpDeviceView",function(f){f.preventDefault();var d=$(this).data("trigger");
var g=document.getElementById("landingPageBuilder").contentWindow;if($(".lpPreviewView span").text()!=="Close"){g.$(d).trigger("click")}var c=$(this).data("deviceclass");g.$("#preview-frame").removeClass("xs-width sm-width md-width full-width");g.$("#preview-frame").addClass(c)});$("#landingpages-listeners").on("click",".lpPreviewView",function(d){d.preventDefault();var c=$(this).data("trigger");document.getElementById("landingPageBuilder").contentWindow.$(c).trigger("click");$(this).find("i").toggleClass("fa-eye fa-eye-slash");if($(this).find("i").hasClass("fa-eye")){document.getElementById("landingPageBuilder").contentWindow.$("#preview-closer").trigger("click")}if($(this).find("span").text()=="Close"){$(this).find("span").text("Preview")}else{$(this).find("span").text("Close")}document.getElementById("landingPageBuilder").contentWindow.$("#preview-closer").addClass("hidden")});$("#landingpages-listeners").on("click","#builderPageOptionsLink",function(c){c.preventDefault();$(this).find("i").toggleClass("icon-plus").toggleClass("icon-minus");$("#builderPageOptions").slideToggle("fast")});$("#landingpages-listeners").on("click","#landingPageSettingBtn",function(f){f.preventDefault();$("#landingPageSettingForm").validate({rules:{sub_domain:{required:true,lpsubdomain:true},domain:{required:true,lpdomain:true},directory_path:{required:false,lpdirectorypath:true}}});if(!$("#landingPageSettingForm").valid()){return}var d=$("#domain").val();var c=$(this).data("pageid");$.get("core/api/landingpages/has-rights-to-add-domain?domain="+d.toLowerCase(),function(g){if(g.result){var e=$("#landingPageSettingBtn").button("loading");landingPageSaveCnameSettings(c,"http://"+$("#sub_domain").val()+"."+d+"/"+$("#directory_path").val());e.button("reset")}else{landingPageShowAlertMessage("You cannot add this ("+d+") Domain. It is used in other agile CRM account.","alert-danger")}})});$("#landingpages-listeners").on("keyup","#sub_domain",function(c){$("#landingPageVerifyBtn").hide();if($("#cnameInstructionMessage").is(":hidden")){$("#cnameInstructionMessage").show()}$("#cnameHostVal").html($(this).val())});$("#landingpages-listeners").on("keyup","#domain",function(c){$("#landingPageVerifyBtn").hide()});$("#landingpages-listeners").on("click",".lpBuilderMenuItem",function(f){f.preventDefault();var g=document.getElementById("landingPageBuilder").contentWindow;var d=$(this).data("id");var c="#"+d+"AgileId";if($(this).hasClass("active")){g.$("#elements-container").hide();$(this).removeClass("active")}else{g.$("#elements-container").show();$(".lpBuilderMenuItem").removeClass("active");$(this).addClass("active")}g.$(c).trigger("click")});$("#landingpages-listeners").on("click",".lpCodeEditorMenuItem",function(c){c.preventDefault();document.getElementById("landingPageBuilder").contentWindow.$("#codeEditorAgileId").trigger("click")});$("#landingpages-listeners").on("click","#landingPageVerifyBtn",function(d){d.preventDefault();var c=document.getElementById("cname");if($("#cname").attr("href")!=""){$.get("core/api/landingpages/verifycname?domain="+c.hostname,function(e){if(e.result){landingPageShowAlertMessage("CNAME is correct. Found "+e.cnames[0],"alert-success")}else{if(typeof e.cnames!="undefined"&&typeof e.cnames[0]!="undefined"){landingPageShowAlertMessage("CNAME is incorrect. Found "+e.cnames[0],"alert-danger")}else{landingPageShowAlertMessage("CNAME is not found.","alert-danger")}}})}})}function onLandingPageSaved(b){b.id}function hideLandingPopup(){$("#landingPagesSavePopup").modal("hide")}function hideLandingpagePopup(){if($("#landingpages-save-popup").prop("checked")){storeData("landingpages-save-popup",true,10)}else{storeData("landingpages-save-popup",false,10)}}function onLandingPageBuilderLoad(){$("#landingPageBuilderMenuNav").show()}function landingPageShowAlertMessage(c,b){$("#statusMessageHolder").html('<div class="alert '+b+'" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+c+"</div>")}function landingPageSaveCnameSettings(d,e){var f={landing_page_id:d,cname:e.toLowerCase()};var b="post";var g="saved";var c=$("#cname_id").val();if(c){var b="put";f.id=c;g="updated"}$.ajax({type:b,url:"core/api/landingpages/custom-domain",data:JSON.stringify(f),dataType:"json",contentType:"application/json; charset=utf-8",success:function(h){if(h.isDuplicateCName){landingPageShowAlertMessage("Custom domain should be unique","alert-danger")}else{landingPageShowAlertMessage("Custom domain "+g+" successfully","alert-success");$("#cname_id").val(h.id);$("#cname").attr("href",e);$("#landingPageVerifyBtn").show()}},})}function formEmbedIFrameLoaded(c){if(c){var b=c.parentElement;if(b.className.indexOf("ui-draggable-dragging")==-1){var d=c.contentWindow.document;var f=d.getElementById("agileFormHolder");f.removeChild(d.getElementsByTagName("style")[0]);f.removeChild(d.getElementsByTagName("script")[0]);var e=f.innerHTML;e=e.replace('<div class="agile-custom-clear"></div>',"");b.innerHTML="";b.innerHTML=e}}}function landingpagesCollection(b){this.LandingPageCollectionView=new landingpage_collection_events({url:"core/api/landingpages",sort_collection:false,templateKey:"landingpages",cursor:true,page_size:20,individual_tag_name:"tr",global_sort_key:b,postRenderCallback:function(d){includeTimeAgo(d);$("#landingpages-list").html(c);$(".active").removeClass("active");$("#landing-pages-menu").addClass("active")},appendItemCallback:function(d){includeTimeAgo(d)}});this.LandingPageCollectionView.collection.fetch();var c=this.LandingPageCollectionView.render().el}function resetLandingPageButton(){$(".saveLandingPageButton").prop("disabled",false);$(".saveLandingPageButtonText").html("Save Page")}$("#content").on("click","#subscribe-ical",function(b){b.preventDefault();set_api_key()});function set_api_key(){var d=Backbone.Model.extend({url:"core/api/api-key"});var b=new d();var c=b.fetch({success:function(f){var e=f.get("api_key");set_url_domain(e)}})}function set_url_domain(c){var b=window.location.hostname.split(".")[0];set_url(c,b)}function set_url(d,c){var b="webcal://"+c+".agilecrm.com/ical/"+d;$("#ical-feed").attr("href",b);$("#ical-feed").text(b);console.log(b)}function send_ical_info_email(b){b.on("shown.bs.modal",function(c){$("#share-ical-by-email").on("click","#shareIcalMail",function(g){g.preventDefault();if(!isValidForm($("#shareIcalMailForm"))){return}var f=serializeForm("shareIcalMailForm");f.body=f.body.replace(/\r\n/g,"<br/>");var d="core/api/emails/send-email?from="+encodeURIComponent(f.from)+"&to="+encodeURIComponent(f.to)+"&subject="+encodeURIComponent(f.subject)+"&body="+encodeURIComponent(f.body);$save_info=$('<img src="'+updateImageS3Path("img/1-0.gif")+'" height="18px" width="18px"></img>&nbsp;&nbsp;<span><p class="text-success" style="color:#008000; font-size:15px; display:inline-block"> <i>'+_agile_get_translated_val("admin-settings-integrations","sending-emails")+"</i></p></span>");$("#msg",this.el).append($save_info);$save_info.show().delay(2000).fadeOut("slow");$.post(d,function(){b.modal("hide")})})})}$(function(){$("#scheduleModal").on("hidden.bs.modal",function(b){$("#edit").show();$("#charlength").hide();$("#specialchar").hide()});$("#scheduleModal").on("show.bs.modal",function(){var b=Backbone.Model.extend({url:"/core/api/users/current-user",restKey:"domainUser"});var c=new b();c.fetch({success:function(f){var e=f.toJSON();if($("#scheduleModal").size()>1){$("#scheduleModal").modal("hide").remove()}var g="https://"+e.domain+".agilecrm.com/calendar/"+e.schedule_id;var d="https://"+e.domain+".agilecrm.com/calendar/";$("#scheduleurl").attr("href",g);$("#hrefvalue").html(d);$("#schedule_id").html(e.schedule_id);$("#scheduleurl").removeClass("nounderline")}})})});$(function(){window.onhashchange=function(b){$(".daterangepicker").hide();$(".contact_popover").remove();$(".contact_popover").hide()}});function initFunnelCharts(b){initDateRange(b);if($("#frequency").length>0){$("#frequency").change(function(){b()})}fillSelect("filter","core/api/filters",undefined,function(){$("#filter").change(function(){b()})},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined,"All Contacts");if($("#type").length>0){$("#type").change(function(){b()})}fillSelect("owner","core/api/users/partial",undefined,function(){$("#owner").change(function(){b()})},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined,"All Owners");b()}function initReportsForCalls(b){initDateRange(b);b();if($("#frequency").length>0){$("#frequency").change(function(){b()})}$("#typeCall").change(function(){b()});fillSelect("users","core/api/users/partial",undefined,function(){$("#users").change(function(){b()})},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined,"All Users")}function showFunnelGraphs(b){console.log("Showing funnel logs");showFunnel("core/api/reports/funnel/"+b+getOptions(),"funnel-chart",_agile_get_translated_val("report-add","funnel-reports"),true)}function showGrowthGraphs(b){showAreaSpline("core/api/reports/growth/"+b+getOptions(),"growth-chart","","",true)}function showRatioGraphs(c,b){showLine("core/api/reports/ratio/"+c+"/"+b+"/"+getOptions(),"ratio-chart",_agile_get_translated_val("reports","ratio-analysis"),c+" vs "+b,true)}function initSalesCharts(c){initDateRange(c);if($("#frequency").length>0){$("#frequency").change(function(){c()})}fillSelect("track","/core/api/milestone/pipelines",undefined,function(){$("#track").change(function(){c()})},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined,"All Tracks");fillSelect("owner","core/api/users/partial",undefined,function(){$("#owner").change(function(){c()})},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined,"All Owners");var b=new Base_Collection_View({url:"/core/api/categories?entity_type=DEAL_SOURCE",sort_collection:false});b.collection.fetch({success:function(f){var d=f.toJSON();
var e='<option class="default-select" value="">'+_agile_get_translated_val("report-add","all-sources")+'</option><option class="default-select" value="1">'+_agile_get_translated_val("report-add","unknown")+"</option>";$.each(d,function(h,g){e+='<option class="default-select" value="'+g.id+'">'+g.label+"</option>"});$("#source",$("#content")).html(e);hideTransitionBar();$("#source").change(function(){c()})}});c()}function showDealsGrowthReport(){var l="";var e=$("#range").html().split("-");var f=getUTCMidNightEpochFromDate(new Date(e[0]));var h=new Date();f=f+(h.getTimezoneOffset()*60*1000);f=f/1000;var b=$.trim(e[1]);if(b){b=b+" 23:59:59"}var c=getUTCMidNightEpochFromDate(new Date(b));c+=(((23*60*60)+(59*60)+59)*1000);c=c+(h.getTimezoneOffset()*60*1000);c=c/1000;if($("#owner").length>0){var g=0;if($("#owner").val()!=""&&$("#owner").val()!="All Owners"){g=$("#owner").val()}l+=g}l+=("?min="+f+"&max="+c);if($("#frequency").length>0){var k=$("#frequency").val();l+=("&frequency="+k)}if($("#type").length>0){var j=$("#type").val();l+=("&type="+j)}showDealsGrowthgraph("core/api/opportunity/details/"+l,"deals-chart","","",true)}function highlightDatepickerOption(){var b=false;$(".daterangepicker > .ranges > ul").each(function(){if($(this).hasClass("active")){b=true}});if(!b){$(".daterangepicker > .ranges > ul > li").eq(2).addClass("active")}}function showsalesReportGraphs(){var m="";var g=$("#range").html().split("-");var h=getUTCMidNightEpochFromDate(new Date(g[0]));var c=$.trim(g[1]);if(c){c=c+" 23:59:59"}var e=getUTCMidNightEpochFromDate(new Date(c));var k=new Date();h=h+(k.getTimezoneOffset()*60*1000);e+=(((23*60*60)+(59*60)+59)*1000);e=e+(k.getTimezoneOffset()*60*1000);if($("#owner").length>0){var j=0;if($("#owner").val()!=""&&$("#owner").val()!="All Owners"){j=$("#owner").val()}m+=j}if($("#track").length>0){var f=0;if($("#track").val()!=""&&$("#track").val()!="All Tracks"){f=$("#track").val()}m+=("/"+f)}if($("#source").length>0){var b=0;if($("#source").val()!=""&&$("#source").val()!="All Sources"){b=$("#source").val()}m+=("/"+b)}m+=("?min="+h/1000+"&max="+e/1000);if($("#frequency").length>0){var l=$("#frequency").val();m+=("&frequency="+l)}var l=$("#frequency:visible").val();showDealAreaSpline("core/api/opportunity/stats/details/"+m,"revenue-chart","","",true,l)}function initUserReports(b){initDateRange(b);b();fillSelect("owner","core/api/users/partial",undefined,function(){$("#owner").change(function(){b()})},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined,"All Owners")}function showLossReasonGraphs(){var l="";var g=$("#range").html().split("-");var h=getUTCMidNightEpochFromDate(new Date(g[0]));var c=$.trim(g[1]);if(c){c=c+" 23:59:59"}var e=getUTCMidNightEpochFromDate(new Date(c));var k=new Date();h=h+(k.getTimezoneOffset()*60*1000);e+=(((23*60*60)+(59*60)+59)*1000);e=e+(k.getTimezoneOffset()*60*1000);if($("#owner").length>0){var j=0;if($("#owner").val()!=""&&$("#owner").val()!="All Owners"){j=$("#owner").val()}l+=j}if($("#track").length>0){var f=0;if($("#track").val()!=""&&$("#track").val()!="All Tracks"){f=$("#track").val()}l+=("/"+f)}if($("#source").length>0){var b=0;if($("#source").val()!=""&&$("#source").val()!="All Sources"){b=$("#source").val()}l+=("/"+b)}l+=("?min="+h/1000+"&max="+e/1000);pieforReports("core/api/opportunity/details/"+l,"lossreasonpie-chart","",true)}function showLossReasonGraphForUserReports(){var l="";var g=$("#range").html().split("-");var h=getUTCMidNightEpochFromDate(new Date(g[0]));var c=$.trim(g[1]);if(c){c=c+" 23:59:59"}var e=getUTCMidNightEpochFromDate(new Date(c));var k=new Date();h=h+(k.getTimezoneOffset()*60*1000);e+=(((23*60*60)+(59*60)+59)*1000);e=e+(k.getTimezoneOffset()*60*1000);if($("#owner").length>0){var j=0;if($("#owner").val()!=""&&$("#owner").val()!="All Owners"){j=$("#owner").val()}l+=j}var f=0;l+=("/"+f);var b=0;l+=("/"+b);l+=("?min="+h/1000+"&max="+e/1000);pieforReports("core/api/opportunity/details/"+l,"lossreasonpie-chart-users","",true)}function salesReportGraphForUserReports(){var m="";var g=$("#range").html().split("-");var h=getUTCMidNightEpochFromDate(new Date(g[0]));var c=$.trim(g[1]);if(c){c=c+" 23:59:59"}var e=getUTCMidNightEpochFromDate(new Date(c));var k=new Date();h=h+(k.getTimezoneOffset()*60*1000);e+=(((23*60*60)+(59*60)+59)*1000);e=e+(k.getTimezoneOffset()*60*1000);if($("#owner").length>0){var j=0;if($("#owner").val()!=""&&$("#owner").val()!="All Owners"){j=$("#owner").val()}m+=j}var f=0;m+=("/"+f);var b=0;m+=("/"+b);m+=("?min="+h/1000+"&max="+e/1000);var l="monthly";showDealAreaSpline("core/api/opportunity/stats/details/"+m,"revenue-chart-users","","",true,undefined)}function showWonPieChart(){var e="";var b=$("#range").html().split("-");var g=getUTCMidNightEpochFromDate(new Date(b[0]));var h=$.trim(b[1]);if(h){h=h+" 23:59:59"}var f=getUTCMidNightEpochFromDate(new Date(h));var j=new Date();g=g+(j.getTimezoneOffset()*60*1000);f+=(((23*60*60)+(59*60)+59)*1000);f=f+(j.getTimezoneOffset()*60*1000);if($("#owner").length>0){var c=0;if($("#owner").val()!=""&&$("#owner").val()!="All Owners"){c=$("#owner").val()}e+=c}e+=("?min="+g/1000+"&max="+f/1000);pieforReports("core/api/opportunity/wonDetails/"+e,"wonpie-chart","",true)}function initDateRange(b){initReportLibs(function(){$(".daterangepicker").remove();$("#reportrange").daterangepicker({ranges:{Today:["today","today"],Yesterday:["yesterday","yesterday"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 30 Days":[Date.today().add({days:-29}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})],"This Quarter":[Date.today().getMonth()<3?new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth():new Date(Date.today().setMonth(9)).moveToFirstDayOfMonth(),Date.today().getMonth()<3?new Date(Date.today().setMonth(2)).moveToLastDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(5)).moveToLastDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(8)).moveToLastDayOfMonth():new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()],"Last Quarter":[Date.today().getMonth()<3?new Date(Date.today().add({years:-1}).setMonth(9)).moveToFirstDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth():new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth(),Date.today().getMonth()<3?new Date(Date.today().add({years:-1}).setMonth(11)).moveToLastDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(2)).moveToLastDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(5)).moveToLastDayOfMonth():new Date(Date.today().setMonth(8)).moveToLastDayOfMonth()],"This Year":[new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth(),new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()],"Last Year":[new Date(Date.today().setMonth(0)).add({years:-1}).moveToFirstDayOfMonth(),new Date(Date.today().setMonth(11)).add({years:-1}).moveToLastDayOfMonth()]},locale:{applyLabel:"Apply",clearLabel:"Clear",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",daysOfWeek:$.fn.datepicker.dates.en.daysExactMin,monthNames:$.fn.datepicker.dates.en.months,firstDay:parseInt(CALENDAR_WEEK_START_DAY)}},function(e,c){if(e&&c){var d=Math.abs(e.getMonth()-c.getMonth()+(12*(e.getFullYear()-c.getFullYear())));$("#reportrange span").html(e.toString("MMMM d, yyyy")+" - "+c.toString("MMMM d, yyyy"));$("#week-range").html(c.add({days:-6}).toString("MMMM d, yyyy")+" - "+c.add({days:6}).toString("MMMM d, yyyy"))}else{$("#reportrange span").html(Date.today().add({days:-6}).toString("MMMM d, yyyy")+"-"+Date.today().toString("MMMM d, yyyy"));$(".daterangepicker > .ranges > ul > li").each(function(){$(this).removeClass("active")})}b()});$(".daterangepicker > .ranges > ul").on("click","li",function(c){$(".daterangepicker > .ranges > ul > li").each(function(){$(this).removeClass("active")});$(this).addClass("active")})})}function showRepPerformanceReport(){var e="";var b=$("#range").html().split("-");var g=getUTCMidNightEpochFromDate(new Date(b[0]));var h=$.trim(b[1]);if(h){h=h+" 23:59:59"}var f=getUTCMidNightEpochFromDate(new Date(h));var j=new Date();g=g+(j.getTimezoneOffset()*60*1000);f+=(((23*60*60)+(59*60)+59)*1000);f=f+(j.getTimezoneOffset()*60*1000);if($("#owner").length>0){var c=0;if($("#owner").val()!=""){c=$("#owner").val()}e+=c}e+=("?min="+g/1000+"&max="+f/1000);report_utility.getRepPerformanceLog("core/api/reports/repPerformance/"+e)}function initRepReports(b){initReportLibs(function(){$(".daterangepicker").remove();$("#reportrange").daterangepicker({ranges:{"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})],"This Quarter":[Date.today().getMonth()<3?new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth():new Date(Date.today().setMonth(9)).moveToFirstDayOfMonth(),Date.today().getMonth()<3?new Date(Date.today().setMonth(2)).moveToLastDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(5)).moveToLastDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(8)).moveToLastDayOfMonth():new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()],"Last Quarter":[Date.today().getMonth()<3?new Date(Date.today().add({years:-1}).setMonth(9)).moveToFirstDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth():new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth(),Date.today().getMonth()<3?new Date(Date.today().add({years:-1}).setMonth(11)).moveToLastDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(2)).moveToLastDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(5)).moveToLastDayOfMonth():new Date(Date.today().setMonth(8)).moveToLastDayOfMonth()],"This Year":[new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth(),new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()],"Last Year":[new Date(Date.today().setMonth(0)).add({years:-1}).moveToFirstDayOfMonth(),new Date(Date.today().setMonth(11)).add({years:-1}).moveToLastDayOfMonth()]},locale:{applyLabel:"Apply",clearLabel:"Clear",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",minViewMode:"month",dateLimit:"month",startDate:Date.today().moveToFirstDayOfMonth(),endDate:Date.today().moveToLastDayOfMonth(),daysOfWeek:$.fn.datepicker.dates.en.daysExactMin,monthNames:$.fn.datepicker.dates.en.months,firstDay:parseInt(CALENDAR_WEEK_START_DAY)}},function(e,c){if(e&&c){var d=Math.abs(e.getMonth()-c.getMonth()+(12*(e.getFullYear()-c.getFullYear())));
$("#reportrange span").html(e.toString("MMMM d, yyyy")+" - "+c.toString("MMMM d, yyyy"));$("#week-range").html(c.add({days:-6}).toString("MMMM d, yyyy")+" - "+c.add({days:6}).toString("MMMM d, yyyy"))}else{$("#reportrange span").html(Date.today().moveToFirstDayOfMonth().toString("MMMM d, yyyy")+"-"+Date.today().moveToLastDayOfMonth().toString("MMMM d, yyyy"));$(".daterangepicker > .ranges > ul > li").each(function(){$(this).removeClass("active")})}b()});$(".daterangepicker > .ranges > ul").on("click","li",function(c){$(".daterangepicker > .ranges > ul > li").each(function(){$(this).removeClass("active")});$(this).addClass("active")});$(".daterangepicker > .ranges > ul li:last-child").hide();$(".daterangepicker  .range_inputs").hide();$(".daterangepicker > .ranges > ul li:last-child").prev().removeClass("b-b")});fillSelect("owner","core/api/users/partial",undefined,function(){$('select[id="owner"]').find('option[value="'+CURRENT_DOMAIN_USER.id+'"]').attr("selected",true);b();$("#owner").change(function(){b()})},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined)}function initComparisonReports(b){initDateRange(b);fillSelect("pipeline_track","/core/api/milestone/pipelines",undefined,function(){$('select[id="pipeline_track"]').find('option[value=""]').remove();b();$("#pipeline_track").change(function(){b()})},'<option class="default-select" value="{{id}}">{{name}}</option>',false,undefined,"")}function showComparisonReportGraph(){url="/core/api/opportunity/conversionRate/0";url=url+getSelectedDates();if($("#pipeline_track").length>0){var b=0;if($("#pipeline_track").val()!=""){b=$("#pipeline_track").val();url+="&track-id="+b;BubbleChart(url,"comparison-chart","",true)}}}var _agile_contact;var _agile_webrules;var rules={tags_in:function(h,d){if(h.tags_in&&d){var c=0;var g=h.tags_in.length;var f=d.tags.length;if(g<=f){for(var e=0;e<g;e++){for(var b=0;b<f;b++){if(h.tags_in[e]===d.tags[b]){c++}}}}if(c==g&&c!==0&&g!==0){return true}}},tags_out:function(h,c){if(c&&h.tags_out){var g=0;var f=h.tags_out.length;var e=c.tags.length;for(var d=0;d<f;d++){for(var b=0;b<e;b++){if(c.tags[b]!==h.tags_out[d]){g++}}}if(g==f*e&&g!==0&&f!==0&&e!==0){return true}}},tags_time:function(n,b){if(n.tags_time&&b){var k=0;var e=n.tags_time.tags.length;var c=b.tagsWithTime.length;var m=new Date().getTime();if(e<=c){for(var l=0;l<e;l++){for(var g=0;g<c;g++){if(n.tags_time.tags[l]==b.tagsWithTime[g].tag){if((n.tags_time.condition=="LAST"&&(0<=(m-b.tagsWithTime[g].createdTime)&&(m-b.tagsWithTime[g].createdTime)<=(n.tags_time.time*86400000)))||(n.tags_time.condition=="BEFORE"&&(n.tags_time.time>=b.tagsWithTime[g].createdTime))||(n.tags_time.condition=="AFTER"&&(n.tags_time.time<=b.tagsWithTime[g].createdTime))||(n.tags_time.condition=="EQUALS"&&(n.tags_time.time<=b.tagsWithTime[g].createdTime&&b.tagsWithTime[g].createdTime<=(n.tags_time.time+86400000)))||(n.tags_time.condition=="BETWEEN"&&(n.tags_time.time_min<=b.tagsWithTime[g].createdTime&&b.tagsWithTime[g].createdTime<=n.tags_time.time_max))){k++}}}}}if(k==e&&k!==0&&e!==0){return true}}},min_score:function(c,b){if(b&&c.min_score&&b.lead_score>=c.min_score){return true}},max_score:function(c,b){if(b&&c.max_score&&b.lead_score<=c.max_score){return true}},referrer_is:function(b){if(b.referrer_is===document.referrer){return true}},referrer_matches:function(c){var b=document.referrer;if(b.indexOf(c.referrer_matches)!==-1){return true}},page_view_is:function(b){if(b.page_view_is===document.location.href){return true}},page_view_matches:function(c){var b=document.location.href;if(b.indexOf(c.page_view_matches)!==-1){return true}},session_type:function(b){if(b.session_type==="first"){return agile_session.new_session}if(b.session_type==="ongoing"){return !agile_session.new_session}},visit_type:function(b){if(b.visit_type==="repeat"){return !agile_guid.new_guid}if(b.visit_type==="first"){return agile_guid.new_guid}},contact_properties_in:function(h,d){if(d&&h.contact_properties_in){var c=0;var b=h.contact_properties_in.length;var e=d.properties.length;for(var g=0;g<b;g++){for(var f=0;f<e;f++){if(h.contact_properties_in[g].name===d.properties[f].name&&h.contact_properties_in[g].value===d.properties[f].value){c++}}}if(c==b&&c!==0&&b!==0){return true}}},contact_properties_out:function(m,c){if(c&&m.contact_properties_out){var j=0;var b=m.contact_properties_out.length;var d=c.properties.length;for(var f=0;f<b;f++){for(var e=0;e<d;e++){if(m.contact_properties_out[f].name===c.properties[e].name&&m.contact_properties_out[f].value!==c.properties[e].value){j++}}}if(j==b&&j!==0&&b!==0&&d!==0){return true}}},contact_time:function(f,b){if(b&&f.contact_time){var e=new Date().getTime();var d=(b.created_time*1000);var c=(e-d);if((f.contact_time.condition=="LAST"&&(0<=c&&c<=(f.contact_time.time*86400000)))||(f.contact_time.condition=="AFTER"&&(f.contact_time.time<=d))||(f.contact_time.condition=="BEFORE"&&(f.contact_time.time>=d))||(f.contact_time.condition=="ON"&&(f.contact_time.time<=d&&d<=(86400000+f.contact_time.time)))||(f.contact_time.condition=="BETWEEN"&&(f.contact_time.time_min<=d&&d<=f.contact_time.time_max))){return true}}}};function show_modal(d,e,c){var b=new SimpleModal(e);b.addButton("Ok","simple_modal_btn primary",function(){if(e.form_id&&(document.id(e.form_id))){var f={};var h=document.id("modal-form");for(var g=0;g<h.length;g++){if(h[g].name.toLowerCase()=="firstname"||h[g].name.toLowerCase()=="first_name"||h[g].name.toLowerCase()=="first name"||h[g].name.toLowerCase()=="name"||h[g].name.toLowerCase()=="first"){f.first_name=h[g].value}if(h[g].name.toLowerCase()=="lastname"||h[g].name.toLowerCase()=="last_name"||h[g].name.toLowerCase()=="last name"||h[g].name.toLowerCase()=="last"){f.last_name=h[g].value}if(h[g].name.toLowerCase().indexOf("email")!=-1){f.email=h[g].value}}_agile.create_contact(f,{success:function(j){_agile.set_email(f.email);_agile.add_tag("signup",{success:function(){console.log("tag added")},error:function(){console.log("error")}});console.log("success")},error:function(j){console.log("error")}})}this.hide()});if(e.show_btn_cancel){b.addButton("Cancel","simple_modal_btn")}b.show({model:"modal",title:d.title,contents:function(){if(e.form_id&&(document.id(e.form_id))){return"<form id=modal-form>"+document.id(e.form_id).innerHTML+"</form>"}else{return d.contents}},})}function show_noty(d,c,b){head.js("lib/noty/jquery.noty.js","/lib/noty/layouts/"+c.position+".js","lib/noty/themes/default-custom.js",function(){var e={};if(b&&typeof(b)==="function"){e.onClose=b}var f=noty({text:d,type:c.type,dismissQueue:c.dismiss_queue,layout:c.position,theme:c.theme,callback:e,timeout:2000})})}function execute_action(l,k,g,q,c,f,b,e,j,o,d,p,h){if(k.btn_ok){show_modal(l,k,g)}if(c.type){show_noty(q,c,f)}if(b.length!==0&&h){for(var n=0;n<b.length;n++){_agile.add_campaign({id:b[n]},{success:function(){console.log("campaign assigned")},error:function(){console.log("error in assigning campaign")}},h)}}if(d.length!==0&&h){_agile.add_tag(d.toString(),{success:function(){console.log("tags added")},error:function(){console.log("failed to add tags")}},h)}if(j&&h){_agile.add_score(j,{success:function(){console.log("score added")},error:function(){console.log("failed to add score")}},h)}if(e.length!==0&&h){for(var m=0;m<e.length;m++){_agile.unsubscribe_campaign({id:e[m]},{success:function(){console.log("unsubscribed")},error:function(){console.log("error in unsubscribing")}},h)}}if(o&&h){_agile.add_score(o,{success:function(){console.log("score")},error:function(){console.log("failed to subtract score")}},h)}if(p.length!==0&&h){_agile.remove_tag(p.toString(),{success:function(){console.log("tags removed")},error:function(){console.log("failed to remove tags")}},h)}}function perform_action(w,s,x,e,d,q,g,b,r,p,f,n,v,l){var o=0;var u=0;var h=0;for(var m in s){if(s.hasOwnProperty(m)){h++}}for(var c in w){o++;if(w.hasOwnProperty(c)&&rules[c](w)){u++}}var k;agile_getEmail({success:function(j){k=j.email;if(k=="null"||k==undefined){if(h==0){if(o==u&&o!==0&&u!==0){execute_action(x,e,d,q,g,b,r,p,f,n,v,l)}}}else{if(k){_agile.get_contact(k,{success:function(y){_agile_contact=y;var t=0;for(var z in s){if(s.hasOwnProperty(z)&&rules[z](s,_agile_contact)){t++}}if((h==0&&o!==0&&o==u)||(h!==0&&h==t&&o==0)||(h!=0&&h==t&&o==u&&o!==0)){execute_action(x,e,d,q,g,b,r,p,f,n,v,l,k)}},error:function(){if(h==0&&o!==0&&o==u){execute_action(x,e,d,q,g,b,r,p,f,n,v,l)}}})}}}})}function execute_webrules(){setTimeout(function(){_agile.web_rules({success:function(e){var d=_agile_webrules[i].rules.length;for(var c=0;c<d;c++){if(_agile_webrules[i].rules[c].LHS=="tags"){if(_agile_webrules[i].rules[c].CONDITION=="EQUALS"){webrules.tags_in=_agile_webrules[i].rules[c].RHS.replace(", ",",").split(",")}if(_agile_webrules[i].rules[c].CONDITION=="NOTEQUALS"){webrules.tags_out=_agile_webrules[i].rules[c].RHS.replace(", ",",").split(",")}}if(_agile_webrules[i].rules[c].LHS=="page"){if(_agile_webrules[i].rules[c].CONDITION=="EQUALS"){anon_webrules.page_view_is=_agile_webrules[i].rules[c].RHS}if(_agile_webrules[i].rules[c].CONDITION=="MATCHES"){anon_webrules.page_view_matches=_agile_webrules[i].rules[c].RHS}}if(_agile_webrules[i].rules[c].LHS=="visit"){if(_agile_webrules[i].rules[c].CONDITION=="FIRST_TIME"){anon_webrules.visit_type="first"}if(_agile_webrules[i].rules[c].CONDITION=="REPEAT"){anon_webrules.visit_type="repeat"}}if(_agile_webrules[i].rules[c].LHS=="referrer"){if(_agile_webrules[i].rules[c].CONDITION=="EQUALS"){anon_webrules.referrer_is=_agile_webrules[i].rules[c].RHS}if(_agile_webrules[i].rules[c].CONDITION=="MATCHES"){anon_webrules.referrer_matches=_agile_webrules[i].rules[c].RHS}}if(_agile_webrules[i].rules[c].LHS=="tags_time"&&_agile_webrules[i].rules[c].CONDITION=="EQUALS"){webrules.tags_time={};if(_agile_webrules[i].rules[c].nested_condition=="BETWEEN"){webrules.tags_time.tags=_agile_webrules[i].rules[c].RHS.replace(", ",",").split(",");webrules.tags_time.time_min=_agile_webrules[i].rules[c].nested_lhs;webrules.tags_time.time_max=_agile_webrules[i].rules[c].nested_rhs;
webrules.tags_time.condition=_agile_webrules[i].rules[c].nested_condition}if(_agile_webrules[i].rules[c].nested_condition=="BEFORE"||_agile_webrules[i].rules[c].nested_condition=="AFTER"||_agile_webrules[i].rules[c].nested_condition=="EQUALS"||_agile_webrules[i].rules[c].nested_condition=="NEXT"||_agile_webrules[i].rules[c].nested_condition=="LAST"){webrules.tags_time.tags=_agile_webrules[i].rules[c].RHS.replace(", ",",").split(",");webrules.tags_time.time=_agile_webrules[i].rules[c].nested_lhs;webrules.tags_time.condition=_agile_webrules[i].rules[c].nested_condition}}if(_agile_webrules[i].rules[c].LHS=="created_time"){webrules.contact_time={};if(_agile_webrules[i].rules[c].CONDITION=="BEFORE"||_agile_webrules[i].rules[c].CONDITION=="AFTER"||_agile_webrules[i].rules[c].CONDITION=="ON"||_agile_webrules[i].rules[c].CONDITION=="LAST"||_agile_webrules[i].rules[c].CONDITION=="NEXT"){webrules.contact_time.time=_agile_webrules[i].rules[c].RHS;webrules.contact_time.condition=_agile_webrules[i].rules[c].CONDITION}if(_agile_webrules[i].rules[c].CONDITION=="BETWEEN"){webrules.contact_time.time_max=_agile_webrules[i].rules[c].RHS_NEW;webrules.contact_time.time_min=_agile_webrules[i].rules[c].RHS;webrules.contact_time.condition=_agile_webrules[i].rules[c].CONDITION}}if(_agile_webrules[i].rules[c].LHS=="title"||_agile_webrules[i].rules[c].LHS=="company"||_agile_webrules[i].rules[c].LHS=="owner_id"){var b={};b.name=_agile_webrules[i].rules[c].LHS;b.value=_agile_webrules[i].rules[c].RHS;if(_agile_webrules[i].rules[c].CONDITION=="EQUALS"){if(!webrules.contact_properties_in){webrules.contact_properties_in=[]}webrules.contact_properties_in.push(b)}if(_agile_webrules[i].rules[c].CONDITION=="NOTEQUALS"){if(!webrules.contact_properties_out){webrules.contact_properties_out=[]}webrules.contact_properties_out.push(b)}}}perform_actions(e)},error:function(){console.log("error")}})},150)}function perform_actions(A,k){_agile_webrules=A;console.log(_agile_webrules);var n=_agile_webrules.length;for(var p=0;p<n;p++){var v={};var y={};var z={};var d={};var c;var b;var r={};var g={};var s=[];var q=[];var x=[];var m=[];var f;var o;console.log(_agile_webrules[p]);var h=_agile_webrules[p].actions.length;console.log();console.log(h);console.log(A);for(var j=0;j<h;j++){console.log(_agile_webrules[p].actions[j]);if(_agile_webrules[p].actions[j].action=="MODAL_POPUP"){if(_agile_webrules[p].actions[j].popup_pattern=="confirmation"){d.show_btn_cancel=true;z.title=_agile_webrules[p].actions[j].title;z.contents=_agile_webrules[p].actions[j].popup_text}if(_agile_webrules[p].actions[j].popup_pattern=="information"){d.show_btn_cancel=false;z.title=_agile_webrules[p].actions[j].title;z.contents=_agile_webrules[p].actions[j].popup_text;d.hideHeader=false}if(_agile_webrules[p].actions[j].popup_pattern=="form"){d.form_id=_agile_webrules[p].actions[j].title;d.hideHeader=true;d.show_btn_cancel=true}if(_agile_webrules[p].actions[j].popup_pattern=="custom_html"){var w=document.createElement("div");w.innerHTML=_agile_webrules[p].actions[j].popup_text;var A=w.childNodes[0].nodeValue;if(A){z.contents=A}else{z.contents=w.innerHTML}d.hideHeader=true;d.hideFooter=true}d.btn_ok="Subscribe";d.btn_cancel="Cancel";d.width=275;d.overlayOpacity=0.6;d.onAppend=function(){document.id("simple-modal").fade("hide");setTimeout((function(){document.id("simple-modal").fade("show")}),200);var e=new Fx.Tween(document.id("simple-modal"),{duration:0,link:"cancel",property:"top"}).start(-400,150)};c=function(){test("this_is_modal_callback")}}console.log(_agile_webrules[p].actions[j].action);if(_agile_webrules[p].actions[j].action=="CORNER_NOTY"&&_agile_webrules[p].actions[j].popup_pattern=="information"){if(_agile_webrules[p].actions[j].position=="RIGHT_BOTTOM"){g.position="bottomRight"}if(_agile_webrules[p].actions[j].position=="RIGHT_TOP"){g.position="topRight"}if(_agile_webrules[p].actions[j].position=="LEFT_BOTTOM"){g.position="bottomLeft"}if(_agile_webrules[p].actions[j].position=="LEFT_TOP"){g.position="topLeft"}if(_agile_webrules[p].actions[j].position=="TOP"){g.position="top"}if(_agile_webrules[p].actions[j].position=="BOTTOM"){g.position="bottom"}r=_agile_webrules[p].actions[j].popup_text;g.theme="defaultTheme";g.dismiss_queue="true";g.type="information";b=function(){test("this_is_noty_callback")}}if(_agile_webrules[p].actions[j].action=="ASSIGN_CAMPAIGN"){s.push(_agile_webrules[p].actions[j].RHS)}if(_agile_webrules[p].actions[j].action=="UNSUBSCRIBE_CAMPAIGN"){q.push(_agile_webrules[p].actions[j].RHS)}if(_agile_webrules[p].actions[j].action=="ADD_TAG"){x.push(_agile_webrules[p].actions[j].popup_pattern)}if(_agile_webrules[p].actions[j].action=="REMOVE_TAG"){m.push(_agile_webrules[p].actions[j].popup_pattern)}if(_agile_webrules[p].actions[j].action=="ADD_SCORE"){f=_agile_webrules[p].actions[j].popup_pattern}if(_agile_webrules[p].actions[j].action=="SUBTRACT_SCORE"){o=_agile_webrules[p].actions[j].popup_pattern}}if(!k){execute_action(z,d,c,r,g,b,s,q,f,o,x,m);return}perform_action(y,v,z,d,c,r,g,b,s,q,f,o,x,m)}}function test(b){console.log(b)}function chainWebRules(d,e,c,f){var b=$(d).clone();$("#campaign-actions",d).chained($("#action",d),function(){});$("#action-details",d).chained($("#action",d),function(){});$("#RHS_CALL_POPUOP",d).chained($("#action",d),function(){});$("#WEB_RULE_RHS",d).chained($("#action",d),function(k,h){var g=$("select",$(h));if(e){$.each(e,function(l,m){if(l=="actions"&&(m[0].action=="ASSIGN_CAMPAIGN"||m[0].action=="UNSUBSCRIBE_CAMPAIGN")){$(g).find("option[value="+m[0].RHS+"]").attr("selected","selected");return false}})}var j=$(".tags",h);if(j.length>0){addTagsDefaultTypeahead(h)}});$("#campaign",d).chained($("#action",d));$("#possition",d).chained($("#action",d));$("#timer",d).chained($("#delay",d));$("#delay",d).chained($("#action",d));$("#noty-message",d).chained($("#action",d),function(g,h){var j=$("select",g).val();$(h).show();$("#twilio_call_setup").hide();console.log(j);if(j=="MODAL_POPUP"||j=="CORNER_NOTY"||j=="CALL_POPUP"){if(j=="MODAL_POPUP"||j=="CALL_POPUP"){$("#tiny_mce_webrules_link",h).show()}if(j=="CALL_POPUP"){loadSavedTemplate("call/callpopup.html");$.ajax({url:"/core/api/sms-gateway/twilio",type:"GET",success:function(k){App_WebReports.isTwilioSMS=k},error:function(k){App_WebReports.isTwilioSMS=false}})}h.find(".web-rule-preview").show();return}else{if(j=="SITE_BAR"){loadSavedTemplate("bar/sitebar.html");$("#tiny_mce_webrules_link",h).show();h.find(".web-rule-preview").show();return}}h.find(".web-rule-preview").hide()});if(e&&e.actions){deserializeChainedSelect1($(d).find("form"),e.actions,b,e.actions[0])}scramble_input_names($(".reports-condition-table",b))}var Web_Rules_Event_View=Base_Model_View.extend({events:{"click .web-rule-multiple-add":"ruleMultipleAdd","click i.webrule-multiple-remove":"ruleMultipleRemove","click i.filter-contacts-web-rule-multiple-add":"webruleMultipleAdd","click i.filter-contacts-web-rule-multiple-remove":"webruleMultipleRemove","click .web-rule-preview":"webrulePreview","click #tiny_mce_webrules_link":"tinymceWebruleLink",},ruleMultipleAdd:function(b){b.preventDefault();getTemplate("webrules-add",{},undefined,function(g){if(!g){return}var h=$(g).find(".webrule-actions > div").clone();var f=$("#action select").length;for(var c=0;c<f;c++){var e=$($("#action select")[c]).val();if(e==="CALL_POPUP"||e==="MODAL_POPUP"||e==="SITE_BAR"){var d=$(h).find("#action select optgroup option");d[0].remove();d[2].remove();d[3].remove()}}chainWebRules($(h)[0],undefined,true);$(h).find("i.webrule-multiple-remove").css("display","inline-block");$(".webrule-actions").append(h)},null)},ruleMultipleRemove:function(b){$(b.currentTarget).closest(".chained-table > div").remove()},webruleMultipleAdd:function(c){var b=$(c.currentTarget);getTemplate("webrules-add",{},undefined,function(d){if(!d){return}var e=$(d).find(".web-rule-contact-condition-table tr").clone();scramble_input_names($(e));chainFilters(e,undefined,undefined,true);$(e).find("i.filter-contacts-web-rule-multiple-remove").css("display","inline-block");$(b).parents("tbody").append(e)},null)},webruleMultipleRemove:function(b){var c=$(b.currentTarget);$(c).closest("tr").remove()},webrulePreview:function(c){c.preventDefault();var b=$(c.currentTarget);_agile_require_js("https://s3.amazonaws.com/agilecrm/web-rules-static/agile-webrules-min-26-4.js",function(){var e=serializeChainedElement($(b).closest("table"));var d={};d.value=e.popup_text;e.popup_text=d;e.delay="IMMEDIATE";_agile_execute_action(e)})},tinymceWebruleLink:function(c){c.preventDefault();if(typeof $("#tinyMCEhtml_email").val()!="undefined"&&$("#tinyMCEhtml_email").val()!=""){if($(".custom_html").length>1){showAlertModal("webrule_popup_limit",undefined,function(){$($(c.currentTarget)).closest(".alert").remove()});return}loadTinyMCE("tinyMCEhtml_email");return}else{if($("#callwebrule-code").val()!==""&&$("#action select").val()=="CALL_POPUP"){if($(".custom_html").length>1){showAlertModal("webrule_popup_limit",undefined,function(){$($(c.currentTarget)).closest(".alert").remove()});return}loadTinyMCE("callwebrule-code");return}else{if($("#agile-bar-code").val()!==""&&$("#action select").val()=="SITE_BAR"){loadTinyMCE("agile-bar-code");return}}}var b="height=650, width=800,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes";var d=window.open("templates.jsp?id=tinyMCEhtml_email&t=web_rules","name",b);d.focus();return false},});$("#content").on("click",".addWebrule",function(b){openEmailTemplate(b);console.log($(this).text())});function loadTinyMCE(b){var c="height=650, width=800,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes";var d=window.open("cd_tiny_mce.jsp?id="+b,"name",c);if(window.focus){d.focus()}return false}function tinyMCECallBack(b,c){$("#"+b).val(c)}function getMergeFields(c,d){var b={"Select Merge Field":"","First Name":"{{first_name}}","Last Name":"{{last_name}}",Email:"{{email}}",Company:"{{company}}",Title:"{{title}}",Website:"{{website}}",Phone:"{{phone}}",City:"{{location.city}}",State:"{{location.state}}",Country:"{{location.country}}",Zip:"{{zip}}",Domain:"{{domain}}",Address:"{{location.address}}",Score:"{{score}}","Created Time":"{{created_time}}","Modified Time":"{{modified_time}}","Owner Name":"{{owner.name}}","Owner Email":"{{owner.email}}","Owner Phone":"{{owner.phone}}"};
get_webrules_custom_fields(function(f){console.log("Custom Fields are");console.log(f);var e=merge_webrules_jsons({},b,f);if(d){return d(e)}return e})}function get_webrules_custom_fields(c){var b=window.location.protocol+"//"+window.location.host;accessUrlUsingAjax(b+"/core/api/custom-fields",function(f){var d={},e=f;$.each(e,function(g,h){$.each(h,function(j,k){if(j=="field_label"){d[k]="{{["+k+"]}}"}})});if(c){c(d)}})}function merge_webrules_jsons(d,c,b){return $.extend(d,c,b)}function openEmailTemplate(c){if($("#tinyMCEhtml_email").val()!==""){if($(".custom_html").length>1){showAlertModal("webrule_popup_limit",undefined,function(){$($(c.currentTarget)).closest(".alert").remove()});return}}var b="height=650, width=800,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes";var d=window.open("templates.jsp?id=tinyMCEhtml_email&t=web_rules","name",b);if(window.focus){d.focus()}return false}function enableWebrulesSorting(b){$("#webrule-model-list").append("<tr class='pseduo-row' style='display:none;'><td></td><td></td><td></td><td></td></tr>");head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".webrule-sortable",b).sortable({axis:"y",forcePlaceholderSize:true,placeholder:"<tr><td></td></tr>",handle:".icon-move",containment:"#webrule-model-list",cursor:"move",forceHelperSize:true,scroll:false,items:"> tr",helper:function(f,c){var d=c.children();var g=c.clone();g.children().each(function(e){$(this).width(d.eq(e).width())});return g}});$(".webrule-sortable",b).on("sortstop",function(c,d){var e=[];$(".webrule-sortable > tr",b).each(function(g,h){if(!$(h).hasClass("pseduo-row")){var j=$(h).find(".data").attr("data");var f=App_WebReports.webrules.collection.get(j);f.set({position:g+1},{silent:true});e.push({id:f.get("id"),position:g+1})}});$.ajax({type:"POST",url:"/core/api/webrule/positions",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json"})})})}$(function(){$("#casesModal").on("show.bs.modal",function(b){add_custom_fields_to_form({},function(e){var d=show_custom_fields_helper(e.custom_fields,["modal"]);$("#custom-field-case",$("#casesModal")).html($(d));var c=$("#casesForm");$(".contact_input",c).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_contact_"+$(this).attr("id"),c),contacts_typeahead,undefined,"type=PERSON")});$(".company_input",c).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_company_"+$(this).attr("id"),c),contacts_typeahead,undefined,"type=COMPANY")})},"CASE")});$("#casesModal, #casesUpdateModal").on("shown.bs.modal",function(){$(".date_input").attr("placeholder",_agile_get_translated_val("contacts","select-date"));$(".date_input").datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true,});$("#close_date").datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true,})});$("#casesModal,#casesUpdateModal").on("click","#cases_validate",function(f){f.preventDefault();var d=$(this).closest(".cases-modal").attr("id");var b=$(this).closest(".cases-modal").find("form").attr("id");var c=serializeForm(b);savecases(b,d,this,c)})});function initializeCasesListeners(b){$("#cases-listners").off();$("#cases-listners").on("mouseenter","#cases-model-list > tr",function(){var e=$(this).find(".data").attr("data");var c=App_Cases.casesCollectionView.collection.get(e);var d=this;getTemplate("cases-detail-popover",c.toJSON(),undefined,function(h){if(!h){return}var f=$(h);$(d).popover({rel:"popover",trigger:"hover",placement:"right",container:"body","original-title":c.toJSON().name,content:f,html:true,});$(d).popover("show");var g=$(".popover").find("#cases_detail_popover-div");g.closest(".popover").addClass("cases_custom_popover")},null)});$("#cases-listners #cases-model-list > tr").off("mouseleave");$("#cases-listners").on("mouseleave","#cases-model-list > tr",function(){$(this).popover("hide")});$("#cases-listners .cases-add").off("click");$("#cases-listners").on("click",".cases-add",function(c){c.preventDefault();showCases()});$("#cases-listners #cases-model-list > tr > td:not(':first-child')").off("click");$("#cases-listners").on("click",'#cases-model-list > tr > td:not(":first-child")',function(c){c.preventDefault();updatecases($(this).closest("tr").data())})}function updatecases(d){$("#casesUpdateModal").html(getTemplate("cases-update-modal",{})).modal("show");var c=d.toJSON();add_recent_view(new BaseModel(c));var b=$("#casesUpdateForm");deserializeForm(c,b);agile_type_ahead("contacts-typeahead-input",b,contacts_typeahead);add_custom_fields_to_form(c,function(f){var e=show_custom_fields_helper(f.custom_fields,["modal"]);fill_custom_fields_values_generic($(e),c.custom_data);$("#custom-field-case",b).html(fill_custom_fields_values_generic($(e),c.custom_data));$(".contact_input",b).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_contact_"+$(this).attr("id"),b),contacts_typeahead,undefined,"type=PERSON")});$(".contact_input",b).each(function(){var g=$(this).attr("name");for(var h=0;h<c.custom_data.length;++h){if(c.custom_data[h].name==g){var j=$.parseJSON(c.custom_data[h].value);var k="";$.each(j,function(l,m){if(l!=j.length-1){k+=m+","}else{k+=m}});setReferenceContacts(g,b,j,k)}}});$(".company_input",b).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_company_"+$(this).attr("id"),b),contacts_typeahead,undefined,"type=COMPANY")});$(".company_input",b).each(function(){var g=$(this).attr("name");for(var h=0;h<c.custom_data.length;++h){if(c.custom_data[h].name==g){var j=$.parseJSON(c.custom_data[h].value);var k="";$.each(j,function(l,m){if(l!=j.length-1){k+=m+","}else{k+=m}});setReferenceContacts(g,b,j,k)}}})},"CASE");populateUsers("owners-list",b,c,"owner",function(e){b.find("#owners-list").html(e);if(c.owner){$("#owners-list",b).find("option[value="+c.owner.id+"]").attr("selected","selected")}})}function showCases(){$("#casesModal").html(getTemplate("cases-new-modal",{}));var b=$("#casesForm");agile_type_ahead("contacts-typeahead-input",b,contacts_typeahead);populateUsers("owners-list",b,undefined,undefined,function(c){$("#casesForm").find("#owners-list").html(c);$("#owners-list",$("#casesForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected")});$("#casesModal").modal("show")}function savecases(g,b,f,d){if($(f).attr("disabled")){return}disable_save_button($(f));if(!isValidForm("#"+g)){enable_save_button($(f));return false}var e=false;if(d.id===undefined){e=true}d.custom_data=serialize_custom_fields(g);var c=new Backbone.Model();c.url="core/api/cases";c.save(d,{success:function(j){enable_save_button($(f));$("#"+b).modal("hide");$("#"+g).each(function(){this.reset()});var h=j.toJSON();add_recent_view(new BaseModel(h));if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){if(casesView&&casesView.collection){if(casesView.collection.get(h.id)){casesView.collection.get(h.id).set(new BaseModel(h))}else{casesView.collection.add(new BaseModel(h),{sort:false});casesView.collection.sort()}}if(App_Contacts.contactDetailView.model.get("type")=="COMPANY"){activate_timeline_tab();fill_company_related_contacts(App_Contacts.contactDetailView.model.id,"company-contacts");return}$.each(h.contacts,function(l,k){if(k.id==App_Contacts.contactDetailView.model.get("id")){add_entity_to_timeline(j);return false}})}else{if(company_util.isCompany()){company_util.updateCasesList(h,true)}else{if(Current_Route=="cases"){if(e==true){App_Cases.casesCollectionView.collection.add(j)}else{App_Cases.casesCollectionView.collection.remove(d);App_Cases.casesCollectionView.collection.add(j)}App_Cases.casesCollectionView.render(true)}else{App_Calendar.navigate("cases",{trigger:true})}}}},error:function(j,h){enable_save_button($(f))}})}var _agile_month_short_names_localize={es:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],en:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"months-xs":["Jan","Feb","March","April","May","June","July","Aug","Sept","Oct","Nov","Dec"],};$.fn.datepicker.dates.en={days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],daysExact:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],daysShortExact:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa","Su"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:_agile_month_short_names_localize["months-xs"],today:"Today",daysExactShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],daysExactMin:["Su","Mo","Tu","We","Th","Fr","Sa"],};dateFormat.i18n={dayNames:$.fn.datepicker.dates.en.daysShortExact.concat($.fn.datepicker.dates.en.daysExact),monthNames:$.fn.datepicker.dates.en.monthsShort.concat($.fn.datepicker.dates.en.months)};var _agile_date_utility={get_date_from_string:function(b){if(!b){return null}return new Date(this.parseDate(b))},parseDate:function(b){return Date.parse(b)},};var dup_contacts1_array=[];$(function(){$("body").on("click","#duplicate-contacts-cancel",function(b){b.preventDefault();dup_contacts1_array.length=0;var c=App_Contacts.contactDetailView.model.toJSON();Backbone.history.navigate("contact/"+c.id,{trigger:true})});$("body").on("click","#contact-merge-cancel",function(b){b.preventDefault();dup_contacts1_array.length=0;var c=App_Contacts.contactDetailView.model.toJSON();Backbone.history.navigate("duplicate-contacts/"+c.id,{trigger:true})});$("body").on("click","#duplicate-contacts-checked-grid",function(e){e.preventDefault();var b=[];var f=[];var d=false;var c=$("body").find(".showCheckboxes");$(c).find(".tbody_check").each(function(g,h){if($(h).is(":checked")){dup_contacts1_array.push($(h).closest("tr").find("td.data").attr("data"));d=true}});if(d){if(dup_contacts1_array.length>2){showAlertModal("contacts_merge_limit",undefined,function(){dup_contacts1_array.length=0
});return}Backbone.history.navigate("merge-contacts",{trigger:true})}else{$("body").find(".select-none").html('<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>'+_agile_get_translated_val("contacts","merge-error")+"</div>").show().delay(3000).hide(1)}});$("body").on("click","#merge-contacts-model",function(d){d.preventDefault();var b=_agile_get_translated_val("contact-details","delete")+" 1 "+_agile_get_translated_val("contacts","single-duplicate-merge-confirm");if(dup_contacts1_array.length>1){b=_agile_get_translated_val("contact-details","delete")+dup_contacts1_array.length+" "+_agile_get_translated_val("contacts","duplicate-merge-confirm")}var c=$(this);showAlertModal(b,"confirm",function(){c.attr("disabled","disabled");$("#contact-merge-cancel").attr("disabled","disabled");$("#contact-merge-cancel").after('<img class="contact-merge-loading p-r-xs m-b"  src= "'+updateImageS3Path("img/21-0.gif")+'"></img>');var o=false;var l=[];var r=$("body").find("#merge-contacts-table");var h=$(r).find("tbody");var g=[];var k=[];var f=[];var s=[];var j=[];var p=[];var q=App_Contacts.contactDetailView.model;var n=JSON.parse(JSON.stringify(q.toJSON()));var e=q.id;console.log(q.toJSON());h.children().each(function(t,u){$(u).find("[type=radio]:checked").each(function(x,y){if($(y).attr("oid")!=e){var A=$(y).attr("field");var z=$(y).attr("data");var v=$(y).attr("fieldtype");if(typeof v!==typeof undefined&&v!==false){if(z){custom_field={};custom_field.name=A;custom_field.value=z;custom_field.type="CUSTOM";j.push(custom_field)}else{remove_field={};remove_field.name=A;remove_field.type="CUSTOM";p.push(remove_field)}}else{if(z){selected_field={};selected_field.name=A;selected_field.value=z;l.push(selected_field);if(A.toLowerCase()=="company"){var w=$(y).attr("company_id");q.set({contact_company_id:w})}}else{remove_field={};remove_field.name=A;remove_field.type="SYSTEM";p.push(remove_field)}}}});$(u).find("[type=checkbox]:checked").each(function(x,y){var A=$(y).attr("field");var z=$(y).attr("data");var w=$(y).attr("fieldtype");if(A==="email"){var v=$(y).attr("subtype");email={};email.value=z;if(v){email.subtype=v}k.push(email)}else{if(A==="website"){var v=$(y).attr("subtype");website={};website.value=z;if(v){website.subtype=v}f.push(website)}else{if(A==="phone"){var v=$(y).attr("subtype");phone={};phone.value=z;if(v){phone.subtype=v}g.push(phone)}else{if(A==="tags"){s.push(z)}}}}})});var m=n.properties;q.set({tags:s});merge_duplicate_contacts(q,m,l,j,p,f,k,g)},undefined,_agile_get_translated_val("contacts","delete-duplicates"))})});function merge_duplicate_contacts(r,o,n,m,q,b,l,c){for(var h=o.length-1;h>=0;h--){if(o[h].name.toLowerCase()==="email"||o[h].name.toLowerCase()==="website"||o[h].name.toLowerCase()==="phone"){o.splice(h,1)}}for(var h=0;h<q.length;h++){for(var f=0;f<o.length;f++){var p=o[f];if(p.name.toLowerCase()===q[h].name.toLowerCase()&&p.type.toLowerCase()===q[h].type.toLowerCase()){o.splice(f,1);break}}}for(var f=0;f<n.length;f++){var g=n[f];for(var e=0;e<o.length;e++){if(o[e].name.toLowerCase()===g.name.toLowerCase()){o[e].value=g.value;break}else{if(e==o.length-1){var d={};d.name=g.name;d.value=g.value;d.type="SYSTEM";o.push(d);break}}}}if(m.length>0){for(var h=0;h<m.length;h++){var g=m[h];for(var f=0;f<o.length;f++){if(o[f].name.toLowerCase()===g.name.toLowerCase()&&o[f].type==="CUSTOM"){o[f].value=g.value;break}else{if(f==o.length-1){if(m[h].value){var d={};d.name=m[h].name;d.value=m[h].value;d.type="CUSTOM";o.push(d);break}}}}}}if(l.length>0){for(var h=0;h<l.length;h++){var d={};d.name="email";d.value=l[h].value;d.type="SYSTEM";if(l[h].subtype){d.subtype=l[h].subtype}o.push(d)}}if(c.length>0){for(var h=0;h<c.length;h++){var d={};d.name="phone";d.value=c[h].value;d.type="SYSTEM";if(c[h].subtype){d.subtype=c[h].subtype}o.push(d)}}if(b.length>0){for(var h=0;h<b.length;h++){var d={};d.name="website";d.value=b[h].value;d.type="SYSTEM";if(b[h].subtype){d.subtype=b[h].subtype}o.push(d)}}r.set({properties:o});merge_related_entity_in_master_record(r,dup_contacts1_array)}function merge_related_entity_in_master_record(c,b){c.save({},{url:"/core/api/contacts/merge/"+b.toString(),success:function(){$(".contact-merge-loading").remove();CONTACTS_HARD_RELOAD=true;var d=c.toJSON().id;Backbone.history.navigate("contact/"+d,{trigger:true})}})}var dup_companies_array=[];$(function(){$("body").off("click","#duplicate-companies-cancel");$("body").on("click","#duplicate-companies-cancel",function(b){b.preventDefault();dup_companies_array.length=0;var c=App_Companies.companyDetailView.model.toJSON();Backbone.history.navigate("company/"+c.id,{trigger:true})});$("body").off("click","#companies-merge-cancel");$("body").on("click","#companies-merge-cancel",function(b){b.preventDefault();dup_companies_array.length=0;var c=App_Companies.companyDetailView.model.toJSON();Backbone.history.navigate("duplicate-company/"+c.id,{trigger:true})});$("body").off("click","#duplicate-companies-checked-grid");$("body").on("click","#duplicate-companies-checked-grid",function(e){e.preventDefault();var b=[];var f=[];var d=false;var c=$("body").find(".showCheckboxes");$(c).find(".tbody_check").each(function(g,h){if($(h).is(":checked")){dup_companies_array.push($(h).closest("tr").find("td.data").attr("data"));d=true}});if(d){if(dup_companies_array.length>2){showAlertModal("companies_merge_limit",undefined,function(){dup_companies_array.length=0});return}Backbone.history.navigate("merge-companies",{trigger:true})}else{$("body").find(".select-none").html('<div class="alert alert-danger m-t-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>'+_agile_get_translated_val("contacts","merge-error")+"</div>").show().delay(3000).hide(1)}});$("body").off("click","#merge-companies-model");$("body").on("click","#merge-companies-model",function(d){d.preventDefault();var b=_agile_get_translated_val("contacts","merge-confirm");var c=$(this);showAlertModal(b,"confirm",function(){c.attr("disabled","disabled");$("#companies-merge-cancel").attr("disabled","disabled");$("#companies-merge-cancel").after('<img class="companies-merge-loading p-r-xs m-b"  src= "'+updateImageS3Path("img/21-0.gif")+'"></img>');var o=false;var l=[];var r=$("body").find("#merge-companies-table");var h=$(r).find("tbody");var g=[];var k=[];var f=[];var s=[];var j=[];var p=[];var q=App_Companies.companyDetailView.model;var n=JSON.parse(JSON.stringify(q.toJSON()));var e=q.id;console.log(q.toJSON());h.children().each(function(t,u){$(u).find("[type=radio]:checked").each(function(x,y){if($(y).attr("oid")!=e){var A=$(y).attr("field");var z=$(y).attr("data");var v=$(y).attr("fieldtype");if(typeof v!==typeof undefined&&v!==false){if(z){custom_field={};custom_field.name=A;custom_field.value=z;custom_field.type="CUSTOM";j.push(custom_field)}else{remove_field={};remove_field.name=A;remove_field.type="CUSTOM";p.push(remove_field)}}else{if(z){selected_field={};selected_field.name=A;selected_field.value=z;l.push(selected_field);if(A.toLowerCase()=="company"){var w=$(y).attr("company_id");q.set({contact_company_id:w})}}else{remove_field={};remove_field.name=A;remove_field.type="SYSTEM";p.push(remove_field)}}}});$(u).find("[type=checkbox]:checked").each(function(x,y){var A=$(y).attr("field");var z=$(y).attr("data");var w=$(y).attr("fieldtype");if(A==="email"){var v=$(y).attr("subtype");email={};email.value=z;if(v){email.subtype=v}k.push(email)}else{if(A==="website"){var v=$(y).attr("subtype");website={};website.value=z;if(v){website.subtype=v}f.push(website)}else{if(A==="phone"){var v=$(y).attr("subtype");phone={};phone.value=z;if(v){phone.subtype=v}g.push(phone)}else{if(A==="tags"){s.push(z)}}}}})});var m=n.properties;q.set({tags:s});merge_duplicate_companies(q,m,l,j,p,f,k,g)},undefined,"Delete duplicate Companies")})});function merge_duplicate_companies(r,o,n,m,q,b,l,c){for(var h=o.length-1;h>=0;h--){if(o[h].name.toLowerCase()==="email"||o[h].name.toLowerCase()==="website"||o[h].name.toLowerCase()==="phone"){o.splice(h,1)}}for(var h=0;h<q.length;h++){for(var f=0;f<o.length;f++){var p=o[f];if(p.name.toLowerCase()===q[h].name.toLowerCase()&&p.type.toLowerCase()===q[h].type.toLowerCase()){o.splice(f,1);break}}}for(var f=0;f<n.length;f++){var g=n[f];for(var e=0;e<o.length;e++){if(o[e].name.toLowerCase()===g.name.toLowerCase()){o[e].value=g.value;break}else{if(e==o.length-1){var d={};d.name=g.name;d.value=g.value;d.type="SYSTEM";o.push(d);break}}}}if(m.length>0){for(var h=0;h<m.length;h++){var g=m[h];for(var f=0;f<o.length;f++){if(o[f].name.toLowerCase()===g.name.toLowerCase()&&o[f].type==="CUSTOM"){o[f].value=g.value;break}else{if(f==o.length-1){if(m[h].value){var d={};d.name=m[h].name;d.value=m[h].value;d.type="CUSTOM";o.push(d);break}}}}}}if(l.length>0){for(var h=0;h<l.length;h++){var d={};d.name="email";d.value=l[h].value;d.type="SYSTEM";if(l[h].subtype){d.subtype=l[h].subtype}o.push(d)}}if(c.length>0){for(var h=0;h<c.length;h++){var d={};d.name="phone";d.value=c[h].value;d.type="SYSTEM";if(c[h].subtype){d.subtype=c[h].subtype}o.push(d)}}if(b.length>0){for(var h=0;h<b.length;h++){var d={};d.name="website";d.value=b[h].value;d.type="SYSTEM";if(b[h].subtype){d.subtype=b[h].subtype}o.push(d)}}r.set({properties:o});merge_related_entity_in_master_record_companies(r,dup_companies_array)}function merge_related_entity_in_master_record_companies(c,b){c.save({},{url:"/core/api/contacts/companies/merge/"+b.toString(),success:function(){$(".companies-merge-loading").remove();COMPANIES_HARD_RELOAD=true;var d=c.toJSON().id;Backbone.history.navigate("company/"+d,{trigger:true})}})}$(function(){$("body").on("click","#freshbooks",function(f){f.preventDefault();var c=$("#freshbooks_url").val();var d=$("#freshbooks_apiKey").val();if(b(c)){$("#domainerror").removeClass("hide");$("#freshbooks_url").focus();$("#freshbooks_url").keypress(function(){$("#domainerror").addClass("hide")});return false}else{if(new RegExp("([a-zA-Z0-9]+://)?([a-zA-Z0-9_]+:[a-zA-Z0-9_]+@)?([a-zA-Z0-9.-]+\\.[A-Za-z]{2,4})(:[0-9]+)?(/.*)?").test(c)){showAlertModal("freshbook_domain_error",undefined,function(){$("#domainerror").removeClass("hide");
$("#freshbooks_url").focus();$("#freshbooks_url").keypress(function(){$("#domainerror").addClass("hide")})});return false}}if(b(d)){$("#apierror").removeClass("hide");$("#freshbooks_apiKey").focus();$("#freshbooks_apiKey").keypress(function(){$("#apierror").addClass("hide")});return false}else{if(d.length!=32){$("#apierror").removeClass("hide");$("#freshbooks_apiKey").focus();$("#freshbooks_apiKey").keypress(function(){$("#apierror").addClass("hide")});return false}}$.ajax({url:"core/api/freshbooks/save/"+d+"/"+c+"",success:function(g){if(g){console.log(g)}var e=window.location.hash;if(e=="#sync/freshbooks/setting"){window.location.reload()}else{if(e=="#sync/freshbooks"){DATA_SYNC_FORCE_FETCH=true;window.location=agileWindowOrigin()+"#sync/freshbooks/setting"}else{DATA_SYNC_FORCE_FETCH=true;window.location=agileWindowOrigin()+"#sync"}}}})});function b(c){return(!c||/^\s*$/.test(c))}function b(c){return(!c||/^\s*$/.test(c))}});$(function(){$("body").on("click","#zoho-import",function(b){b.preventDefault();var c=window.open("import_zoho.jsp","name","height=420,width=500");if(window.focus){c.focus()}return false});$("body").on("click","#zoho-prefs-delete",function(c){c.preventDefault();var b=$(this).attr("disabled");if(b){return}$(this).attr("disabled","disabled");$(this).after(getRandomLoadingImg());console.log(App_Widgets.zoho_sync.model.destroy({success:function(){App_Widgets.stripe_sync.model.clear();App_Widgets.stripe_sync.render(true)}}))})});$(function(){$("body").on("click","#import_salesforce",function(b){b.preventDefault();var c=window.open("import_salesforce.jsp?id=import_from_salesforce","name","height=420,width=500");if(window.focus){c.focus()}return false})});$(function(){});$(function(){});var Contacts_And_Companies_Events_View=Base_Model_View.extend({events:{"click #bulk-owner":"bulkActionAddOwner","click #bulk-campaigns":"bulkActionAssignToCampaign","click #bulk-tags":"bulkActionAddTags","click #bulk-tags-remove":"bulkActionRemoveTags","click #bulk-email":"bulkActionSendEmail","click #bulk-contacts-export":"bulkActionExportContacts","click #bulk-companies-export":"bulkActionExportCompanies","click #select-all-available-contacts":"bulkActionSelectAvailContacts","click #select-all-revert":"bulkActionRevertAvailContacts","click .default_company_filter":"bulkActionCompanyDefaultFilter","click #companies-filter":"bulkActionCompaniesFilter","click .company_static_filter":"bulkActionCompaniesStaticFilter","click #comp-sort-by-created_time-desc":"bulkActionCompaniesSortonTimeDesc","click #comp-sort-by-created_time-asc":"bulkActionCompaniesSortonTimeAsec","click .comp-sort-by-name":"bulkActionCompaniesSortByName","click #contact-actions-grid-delete":"contactActionsGridDelete","click .filter":"filterResults","click .default_filter":"defaultFilterResults","click .default_contact_remove_tag":"defaultContactRemoveTag","click .contacts-view":"toggleContactsView","click #contactTabelView":"toggleContactsListView","click .contactcoloumn":"addOrRemoveContactColumns","click .toggle-contact-filters":"toggleContactFilters","click #companiesTabelView":"toggleCompaniesListView","click .companycoloumn":"addOrRemoveCompanyColumns","click .toggle-company-filters":"toggleCompanyFilters",},bulkActionCompaniesSortByName:function(b){b.preventDefault();_agile_set_prefs("company_sort_field",$(b.currentTarget).attr("data"));COMPANIES_HARD_RELOAD=true;App_Companies.companies()},defaultContactRemoveTag:function(b){b.preventDefault();CONTACTS_HARD_RELOAD=true;_agile_delete_prefs("contacts_tag");contacts_view_loader.getContacts(App_Contacts.contactViewModel,$("#contacts-listener-container"));window.location.hash="contacts"},filterResults:function(b){contact_filters_util.filterResults(b)},defaultFilterResults:function(b){b.preventDefault();revertToDefaultContacts()},companyFilterResults:function(b){contact_filters_util.companyFilterResults(b)},contactActionsGridDelete:function(d){d.preventDefault();var c=$(d.currentTarget).attr("con_id");var b=App_Contacts.contactsListView.collection.get(c);$("#deleteGridContactModal").modal("show");$("#deleteGridContactModal").on("shown.bs.modal",function(){$("#deleteGridContactModal").off("click","#delete_grid_contact_yes");$("#deleteGridContactModal").on("click","#delete_grid_contact_yes",function(f){f.preventDefault();$.ajax({url:"core/api/contacts/"+c,type:"DELETE",success:function(){$("#deleteGridContactModal").modal("hide");App_Contacts.contactsListView.collection.remove(b);$("#"+b.id).parent().parent().parent().remove()}})});$("#deleteGridContactModal").on("click","#delete_grid_contact_no",function(f){f.preventDefault();if($(this).attr("disabled")){return}$("#deleteGridContactModal").modal("hide")})})},bulkActionCompanyDefaultFilter:function(b){b.preventDefault();company_list_view.revertToDefaultCompanies()},bulkActionCompaniesFilter:function(b){b.preventDefault();_agile_delete_prefs("company_filter");COMPANIES_HARD_RELOAD=true;companies_view_loader.getCompanies(App_Companies.companyViewModel,$("#companies-listener-container"));return},bulkActionCompaniesStaticFilter:function(c){c.preventDefault();_agile_delete_prefs("company_filter");_agile_delete_prefs("dynamic_company_filter");var d=$(c.currentTarget).attr("id");var b=$(c.currentTarget).attr("filter_type");_agile_set_prefs("company_filter",d);filter_name=$(c.currentTarget).attr("data");COMPANIES_HARD_RELOAD=true;companies_view_loader.getCompanies(App_Companies.companyViewModel,$("#companies-listener-container"));return},bulkActionCompaniesSortonTimeDesc:function(b){b.preventDefault();_agile_set_prefs("company_sort_field",$(b.currentTarget).attr("data"));COMPANIES_HARD_RELOAD=true;App_Companies.companies()},bulkActionCompaniesSortonTimeAsec:function(b){b.preventDefault();_agile_set_prefs("company_sort_field",$(b.currentTarget).attr("data"));COMPANIES_HARD_RELOAD=true;App_Companies.companies()},bulkActionAddOwner:function(b){b.preventDefault();contacts_bulk_actions.change_owner(b)},bulkActionAssignToCampaign:function(b){b.preventDefault();contacts_bulk_actions.assign_to_campaigns(b)},bulkActionAddTags:function(b){b.preventDefault();contacts_bulk_actions.add_tags(b)},bulkActionRemoveTags:function(b){b.preventDefault();contacts_bulk_actions.remove_tags(b)},bulkActionSendEmail:function(b){b.preventDefault();contacts_bulk_actions.send_email(b)},bulkActionExportContacts:function(b){b.preventDefault();contacts_bulk_actions.export_contacts(b)},bulkActionExportCompanies:function(b){b.preventDefault();contacts_bulk_actions.export_companies(b)},bulkActionSelectAvailContacts:function(b){b.preventDefault();contacts_bulk_actions.select_contacts(b)},bulkActionRevertAvailContacts:function(g){g.preventDefault();SELECT_ALL=false;_BULK_CONTACTS=undefined;var c="";var b=0;var d=0;var f=10000;if(company_util.isCompany()){b=App_Companies.companiesListView.collection.length;d=getAvailableContacts();if(localStorage.getItem("dynamic_company_filter")!=null||localStorage.getItem("company_filter")!=null){if(b>f){b=f+"+"}if(d>f){d=f+"+"}}c="Selected "+b+" companies. <a href='#'  id='select-all-available-contacts' class='c-p text-info'>Select all "+d+" companies</a>"}else{b=App_Contacts.contactsListView.collection.length;d=getAvailableContacts();if(localStorage.getItem("dynamic_contact_filter")!=null||localStorage.getItem("contact_filter")!=null){if(b>f){b=f+"+"}if(d>f){d=f+"+"}}c="Selected "+b+" contacts. <a href='#'  id='select-all-available-contacts' class='c-p text-info'>Select all "+d+" contacts</a>"}$("body").find("#bulk-select").html(c)},toggleContactsView:function(c){c.preventDefault();CONTACTS_HARD_RELOAD=true;var b=$(c.currentTarget).attr("data");if(b=="list"){_agile_delete_prefs("agile_contact_view");$("#contactTabelView").show()}else{if(b=="grid"){_agile_set_prefs("agile_contact_view","grid-view");$("#contactTabelView").hide()}}if(_agile_get_prefs("contacts_tag")){contacts_view_loader.getContacts(App_Contacts.contactViewModel,$("#contacts-listener-container"),_agile_get_prefs("contacts_tag"));return}$(".thead_check",$("#contacts-listener-container")).prop("checked",false);contacts_view_loader.getContacts(App_Contacts.contactViewModel,$("#contacts-listener-container"))},toggleContactsListView:function(b){if(_agile_get_prefs("contactTabelView")){_agile_delete_prefs("contactTabelView");$(b.currentTarget).find("i").removeClass("fa fa-ellipsis-h");$(b.currentTarget).find("i").addClass("fa fa-navicon")}else{_agile_set_prefs("contactTabelView","true");$(b.currentTarget).find("i").removeClass("fa fa-navicon");$(b.currentTarget).find("i").addClass("fa fa-ellipsis-h")}$(b.currentTarget).parent().parent().toggleClass("compact");$(".thead_check",$("#contacts-listener-container")).prop("checked",false);contacts_view_loader.getContacts(App_Contacts.contactViewModel,$("#contacts-listener-container"))},addOrRemoveContactColumns:function(d){d.preventDefault();var c=$(d.currentTarget).find("input");if(c.is(":checked")){c.prop("checked",false)}else{c.prop("checked",true)}var b=serializeForm("contact-static-fields");$.ajax({url:"core/api/contact-view-prefs",type:"PUT",contentType:"application/json",dataType:"json",data:JSON.stringify(b),success:function(e){App_Contacts.contactViewModel=e;contacts_view_loader.fetchHeadings(function(f){contacts_view_loader.getContacts(f,$("#contacts-listener-container"))})}})},toggleContactFilters:function(b){if(_agile_get_prefs("hide_contacts_lhs_filter")){_agile_delete_prefs("hide_contacts_lhs_filter");$(b.currentTarget).attr("data-original-title","Hide Filters").tooltip("hide")}else{_agile_set_prefs("hide_contacts_lhs_filter",true);$(b.currentTarget).attr("data-original-title","Show Filters").tooltip("hide")}if($("#contacts-lhs-filters-toggle",$("#contacts-listener-container")).is(":visible")){$("#contacts-lhs-filters-toggle",$("#contacts-listener-container")).hide("slow");_agile_set_prefs(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS,"hide")}else{$("#contacts-lhs-filters-toggle",$("#contacts-listener-container")).show("slow");_agile_set_prefs(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS,"show")
}},toggleCompaniesListView:function(b){if(_agile_get_prefs("companyTabelView")){_agile_delete_prefs("companyTabelView");$(b.currentTarget).find("i").removeClass("fa fa-ellipsis-h");$(b.currentTarget).find("i").addClass("fa fa-navicon")}else{_agile_set_prefs("companyTabelView","true");$(b.currentTarget).find("i").removeClass("fa fa-navicon");$(b.currentTarget).find("i").addClass("fa fa-ellipsis-h")}$(b.currentTarget).parent().toggleClass("compact");$(".thead_check",$("#companies-listener-container")).prop("checked",false);companies_view_loader.getCompanies(App_Companies.companyViewModel,$("#companies-listener-container"))},addOrRemoveCompanyColumns:function(c){c.preventDefault();var b=$(c.currentTarget).find("input");if(b.is(":checked")){b.prop("checked",false)}else{b.prop("checked",true)}var d=serializeForm("companies-static-fields");$.ajax({url:"core/api/contact-view-prefs/company",type:"PUT",contentType:"application/json",dataType:"json",data:JSON.stringify(d),success:function(e){App_Companies.companyViewModel=e;companies_view_loader.fetchHeadings(function(f){companies_view_loader.getCompanies(f,$("#companies-listener-container"))})}})},toggleCompanyFilters:function(b){if(_agile_get_prefs("companiesFilterStatus")=="display:none"){_agile_delete_prefs("companiesFilterStatus");$(b.currentTarget).attr("data-original-title","Hide Filters").tooltip("hide")}else{_agile_set_prefs("companiesFilterStatus","display:none");$(b.currentTarget).attr("data-original-title","Show Filters").tooltip("hide")}}});BLOB_KEY=undefined;var CONTACTS_IMPORT_VIEW=Base_Model_View.extend({events:{"click .upload-contacts-ele":"initializeImportButton","#import-cancel":"importCancel"},initializeImportButton:function(d){d.preventDefault();var b=d.target;var c=$(b).parents("form").children("#type").val();var f=window.open("upload-contacts.jsp?type="+c+"","name","height=310,width=500");if(window.focus){f.focus()}},importCancel:function(b){App_Contacts.importContacts.render(true)}});function initializeImportEvents(b){if(!b){b="content"}$("#"+b+" .upload").off("click");$("#"+b).on("click",".upload",function(d){var c=$(this).parents("form").children("#type").val();d.preventDefault();var f=window.open("upload-contacts.jsp?type="+c+"","name","height=310,width=500");if(window.focus){f.focus()}return false});$("#"+b+" #import-cancel").off("click");$("#"+b).on("click","#import-cancel",function(d){var c=$("#content").children().first();App_Contacts.importContacts.render(true)});$("#"+b+" #deal-cancel").off("click");$("#"+b).on("click","#deal-cancel",function(d){var c=$("#content").children().first();getTemplate("import-deals",{},undefined,function(e){if(!e){return}c.html($(e));initializeImportEvents(c.attr("id"))},c)});$("#"+b+" #import-contacts").off("click");$("#"+b).on("change",".contacts-import-select",function(c){importContactsValidate()});$("#"+b).on("click","#import-contacts",function(j){if($(this).attr("disabled")){return}if(!importContactsValidate()){return false}else{$(this).attr("disabled",true)}var g=[];var f={};var d=get_tags("import-contact-tags");console.log(d);var h=true;if(d!=undefined){$.each(d[0].value,function(e,k){if(!isValidTag(k,false)){h=false;return false}if(!f.tags){f.tags=[]}console.log(f);f.tags.push(k)})}if(!h){getTemplate("import-contacts-validation-message",upload_valudation_errors.invalid_tag,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}$(this).attr("disabled",true);$waiting=$('<div style="display:inline-block;padding-left:5px"><small><p class="text-success"><i><span id="status-message">'+_agile_get_translated_val("campaigns","please-wait")+"</span></i></p></small></div>");$waiting.insertAfter($("#import-cancel"));$("td.import-contact-fields").each(function(l,m){console.log(this);console.log(l);var o={};var e=$(this).find("select");console.log(e);var k=$(e).val();var n=$(e).find(":selected").attr("class")=="CUSTOM"?"CUSTOM":"SYSTEM";console.log("name :"+k+", type"+n);if(k.indexOf("properties_")!=-1){k=k.split("properties_")[1];o.type=n;if(k.indexOf("address-")!=-1){var p=k.split("-");k="address";o.subtype="home";o.type=n;console.log(p);o.value=p[1]}else{if(k.indexOf("-")!=-1){var p=k.split("-");k=p[1];var q=p[0];if(q=="GOOGLE"){o.subtype="GOOGLE-PLUS"}else{o.subtype=q;console.log($(e).attr("class"));o.type=n}}}if(!o.value){o.value=k}o.name=k;console.log(o);if(k.indexOf("_ignore_")!=-1){o={}}}else{o.name=k}g.push(o)});f.properties=g;f.type="PERSON";var c=f;console.log(c);$.ajax({type:"POST",url:"/core/api/contacts/import/"+BLOB_KEY+"/CONTACTS",data:JSON.stringify(c),contentType:"application/json",success:function(e){var k=$("#content").first();App_Contacts.importContacts.model.fetch({success:function(l){showNotyPopUp("information",_agile_get_translated_val("contacts","import-success"),"top",5000);addTagAgile(IMPORT_TAG);console.log(l)}})}})});$("#"+b+" #import-comp").off("click");$("#"+b).on("click","#import-comp",function(k){if($(this).attr("disabled")){return}var d={company_name_missing:{error_message:_agile_get_translated_val("companies","name-mandatory")},company_name_duplicated:{error_message:_agile_get_translated_val("companies","name-duplicated")},invalid_tag:{error_message:_agile_get_translated_val("tags","tag-name-error")}};var l=[];$(".import_contact_error").hide();company_count=0;$(".import-select").each(function(e,m){var n=$(m).val();if(n=="properties_name"){company_count+=1}});if(company_count==0){getTemplate("import-company-validation-message",d.company_name_missing,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}else{if(company_count>1){getTemplate("import-company-validation-message",d.company_name_duplicated,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}}var g={};var f=get_tags("import-contact-tags");console.log(f);var j=true;if(f!=undefined){$.each(f[0].value,function(e,m){if(!isValidTag(m,false)){j=false;return false}if(!g.tags){g.tags=[]}console.log(g);g.tags.push(m)})}if(!j){getTemplate("import-contacts-validation-message",d.invalid_tag,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}$(this).attr("disabled",true);$waiting=$('<div style="display:inline-block;padding-left:5px"><small><p class="text-success"><i><span id="status-message">'+_agile_get_translated_val("campaigns","please-wait")+"</span></i></p></small></div>");$waiting.insertAfter($("#import-cancel"));var h=[];$("td.import-contact-fields").each(function(n,o){console.log(this);console.log(n);var q={};var e=$(this).find("select");console.log(e);var m=$(e).val();var p=$(e).find(":selected").attr("class")=="CUSTOM"?"CUSTOM":"SYSTEM";console.log("name :"+m+", type"+p);if(m.indexOf("properties_")!=-1){m=m.split("properties_")[1];q.type=p;if(m.indexOf("address-")!=-1){var r=m.split("-");m="address";q.subtype="office";q.type=p;console.log(r);q.value=r[1]}else{if(m.indexOf("-")!=-1){var r=m.split("-");m=r[1];var s=r[0];if(s=="GOOGLE"){q.subtype="GOOGLE-PLUS"}else{q.subtype=s;console.log($(e).attr("class"));q.type=p}}}if(!q.value){q.value=m}q.name=m;console.log(q);if(m.indexOf("_ignore_")!=-1){q={}}}else{q.name=m}h.push(q)});g.properties=h;g.type="COMPANY";var c=g;console.log(c);$.ajax({type:"POST",url:"/core/api/upload/save?type=Companies&key="+BLOB_KEY,data:JSON.stringify(c),contentType:"application/json",success:function(e){var m=$("#content").first();App_Contacts.importContacts.render(true);showNotyPopUp("information",_agile_get_translated_val("misc-keys","companies-imported"),"top",5000)},})});$("#"+b+" #import-deals").off("click");$("#"+b).on("click","#import-deals",function(h){if($(this).attr("disabled")){return}var d={deal_name_missing:{error_message:_agile_get_translated_val("validation-msgs","deal_name_missing")},deal_duplicated:{error_message:_agile_get_translated_val("validation-msgs","deal_duplicated")},deal_value_duplicated:{error_message:_agile_get_translated_val("validation-msgs","deal_value_duplicated")},deal_track_duplicated:{error_message:_agile_get_translated_val("validation-msgs","deal_track_duplicated")},deal_milestone_duplicated:{error_message:_agile_get_translated_val("validation-msgs","deal_milestone_duplicated")},deal_related_contact_duplicated:{error_message:_agile_get_translated_val("validation-msgs","deal_related_contact_duplicated")},deal_probability_duplicated:{error_message:_agile_get_translated_val("validation-msgs","deal_probability_duplicated")},deal_close_date_duplicated:{error_message:_agile_get_translated_val("validation-msgs","deal_close_date_duplicated")},deal_note_duplicated:{error_message:_agile_get_translated_val("validation-msgs","deal_note_duplicated")},deal_description_duplicated:{error_message:_agile_get_translated_val("validation-msgs","deal_description_duplicated")},};var j=[];$(".import_contact_error").hide();deal_count=0,value_count=0,probability_count=0,milestone_count=0,track_count=0,close_date_count=0,related_count=0,note_count=0,description_count=0;$(".import-select").each(function(e,k){var l=$(k).val();if(l=="properties_name"){deal_count+=1}if(l=="properties_value"){value_count+=1}if(l=="properties_probability"){probability_count+=1}if(l=="properties_milestone"){milestone_count+=1}if(l=="properties_track"){track_count+=1}if(l=="properties_closeDate"){close_date_count+=1}if(l=="properties_relatedTo"){related_count+=1}if(l=="properties_description"){description_count+=1}});if(deal_count==0){getTemplate("import-deal-validation-message",d.deal_name_missing,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}else{if(deal_count>1){getTemplate("import-deal-validation-message",d.deal_duplicated,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}else{if(value_count>1){getTemplate("import-deal-validation-message",d.deal_value_duplicated,undefined,function(e){if(!e){return
}$("#import-validation-error").html($(e))},"#import-validation-error");return false}else{if(track_count>1){getTemplate("import-deal-validation-message",d.deal_track_duplicated,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}else{if(milestone_count>1){getTemplate("import-deal-validation-message",d.deal_milestone_duplicated,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}else{if(related_count>1){getTemplate("import-deal-validation-message",d.deal_related_contact_duplicated,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}else{if(probability_count>1){getTemplate("import-deal-validation-message",d.deal_probability_duplicated,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}else{if(close_date_count>1){getTemplate("import-deal-validation-message",d.deal_close_date_duplicated,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}else{if(description_count>1){getTemplate("import-deal-validation-message",d.deal_description_duplicated,undefined,function(e){if(!e){return}$("#import-validation-error").html($(e))},"#import-validation-error");return false}}}}}}}}}$(this).attr("disabled",true);$waiting=$('<div style="display:inline-block;padding-left:5px"><small><p class="text-success"><i><span id="status-message">'+_agile_get_translated_val("campaigns","please-wait")+"</span></i></p></small></div>");$waiting.insertAfter($("#import-cancel"));var g=[];var f={};$("td.import-contact-fields").each(function(l,m){console.log(this);console.log(l);var o={};var e=$(this).find("select");console.log(e);var k=$(e).val();var n=$(e).find(":selected").attr("class")=="CUSTOM"?"CUSTOM":"SYSTEM";console.log("name :"+k+", type"+n);if(k.indexOf("properties_")!=-1){k=k.split("properties_")[1];o.type=n;if(!o.value){o.value=k}o.name=k;console.log(o);if(k.indexOf("_ignore_")!=-1){o={}}}else{o.name=k}g.push(o)});f.properties=g;$waiting.find("#status-message").html(getRandomLoadingImg());var c=f;console.log(c);$.ajax({type:"POST",url:"/core/api/upload/save?type=Deals&key="+BLOB_KEY,data:JSON.stringify(c),contentType:"application/json",success:function(e){showNotyPopUp("information",_agile_get_translated_val("deals","import-success"),"top",5000);location.href=agileWindowOrigin()+"#deals"},})})}function importContactsValidate(){var h={first_name_missing:{error_message:_agile_get_translated_val("validation-msgs","first_name_missing")},last_name_missing:{error_message:_agile_get_translated_val("validation-msgs","last_name_missing")},email_missing:{error_message:_agile_get_translated_val("validation-msgs","email_missing")},first_name_duplicate:{error_message:_agile_get_translated_val("validation-msgs","first_name_duplicate")},last_name_duplicate:{error_message:_agile_get_translated_val("validation-msgs","last_name_duplicate")},company_duplicate:{error_message:_agile_get_translated_val("validation-msgs","company_duplicate")},job_title_duplicate:{error_message:_agile_get_translated_val("validation-msgs","job_title_duplicate")},invalid_tag:{error_message:_agile_get_translated_val("validation-msgs","invalid_tag")},};var b=[];$(".import_contact_error").hide();var l=0,d=0,k=0,c=0,e=0;$(".import-select").each(function(n,o){var p=$(o).val();if(p=="properties_first_name"){l+=1}else{if(p=="properties_last_name"){d+=1}else{if(p=="properties_company"){c+=0}else{if(p.indexOf("-email")!=-1){k+=1}else{if(p=="properties_title"){e+=1}}}}}});if(l==0){getTemplate("import-contacts-validation-message",h.first_name_missing,undefined,function(n){if(!n){return}$("#import-validation-error").html($(n));initializeImportEvents($firstDiv.attr("id"))},"#import-validation-error");return false}else{if(k==0){getTemplate("import-contacts-validation-message",h.email_missing,undefined,function(n){if(!n){return}$("#import-validation-error").html($(n))},"#import-validation-error");return false}else{if(l>1){getTemplate("import-contacts-validation-message",h.first_name_duplicate,undefined,function(n){if(!n){return}$("#import-validation-error").html($(n))},"#import-validation-error");return false}else{if(d>1){getTemplate("import-contacts-validation-message",h.last_name_duplicate,undefined,function(n){if(!n){return}$("#import-validation-error").html($(n))},"#import-validation-error");return false}else{if(c>1){getTemplate("import-contacts-validation-message",h.company_duplicate,undefined,function(n){if(!n){return}$("#import-validation-error").html($(n))},"#import-validation-error");return false}else{if(e>1){getTemplate("import-contacts-validation-message",h.job_title_duplicate,undefined,function(n){if(!n){return}$("#import-validation-error").html($(n))},"#import-validation-error");return false}}}}}}var g=[];var f={};var m=get_tags("import-contact-tags");var j=true;if(m!=undefined){$.each(m[0].value,function(n,o){if(!isValidTag(o,false)){j=false;return false}if(!f.tags){f.tags=[]}console.log(f);f.tags.push(o)})}if(!j){getTemplate("import-contacts-validation-message",h.invalid_tag,undefined,function(n){if(!n){return}$("#import-validation-error").html($(n))},"#import-validation-error");return false}return true}function parseCSV(b,c){BLOB_KEY=b;$("#upload_contacts").after(getRandomLoadingImg());$.getJSON("core/api/upload/process?blob-key="+b,function(e){var d;console.log(e);if(e==undefined){return}constructCustomfieldOptions(c,function(f,g){e.custom_fields=f.toJSON();var j="";if(c=="contacts"){j="import-contacts-2"}else{if(c=="company"){j="import-companies"}else{if(c=="deals"){j="import-deals2"}}}var h=$("#content").children().first();getTemplate(j,e,undefined,function(k){if(!k){return}h.html($(k));initializeImportEvents(h.attr("id"));setup_tags_typeahead()},h)})}).error(function(d){$save_info=$('<div style="display:inline-block;margin-left:5px"><small><p style="color:#B94A48; font-size:14px"><i>'+d.responseText+"</i></p></small></div>");$(".loading").remove();$("#upload_contacts").after($save_info);$save_info.show().delay(3500).hide(1)})}function constructCustomfieldOptions(b,d){var c;if(b=="contacts"){c=Backbone.Collection.extend({url:"core/api/custom-fields/byscope?scope=CONTACT"})}else{if(b=="company"){c=Backbone.Collection.extend({url:"core/api/custom-fields/byscope?scope=COMPANY"})}else{if(b=="deals"){c=Backbone.Collection.extend({url:"core/api/custom-fields/byscope?scope=DEAL"})}}}new c().fetch({success:function(f){var e="";$.each(f.toJSON(),function(g,h){e=e+'<option value ="'+h.field_label+'" id="'+h.field_type+'">'+h.field_label+"</option>"});if(d&&typeof(d)==="function"){d(f,e)}}})}function show_map(e){var b=App_Contacts.contactDetailView.model.toJSON();var c=getPropertyValue(b.properties,"address");if(!c){return}try{c=JSON.parse(c);if(!c){return}}catch(f){return}if(!c.address&&!c.city&&!c.state&&!c.country){return}var d=_agile_get_prefs("MAP_VIEW");if(d=="disabled"){$("#map_view_action").html("<i class='icon-plus text-sm c-p' title='"+_agile_get_translated_val("contact-details","show-map")+"' id='enable_map_view'></i>");return}try{if(google.maps){display_google_map()}}catch(f){load_gmap_script()}}function load_gmap_script(){var b=document.createElement("script");b.type="text/javascript";b.src="https://maps.googleapis.com/maps/api/js?&sensor=false&callback=display_google_map";document.body.appendChild(b)}function display_google_map(){var b=App_Contacts.contactDetailView.model.toJSON();var c=JSON.parse(getPropertyValue(b.properties,"address"));var d=new google.maps.Geocoder();if(!c.address){c.address=""}if(!c.city){c.city=""}if(!c.state){c.state=""}if(!c.country){c.country=""}if(!c.zip){c.zip=""}d.geocode({address:'"'+c.address+", "+c.city+", "+c.state+", "+getNormalCountryNameFromShortName(c.country)+", "+c.zip+'"'},function(h,g){if(g==google.maps.GeocoderStatus.OK){console.log(h);displayTimeZone(h);$("#map").css("display","block");var f={zoom:4,center:h[0].geometry.location,mapTypeId:google.maps.MapTypeId.ROADMAP};var j=new google.maps.Map(document.getElementById("map"),f);var e=new google.maps.Marker({map:j,position:h[0].geometry.location})}})}function getNormalCountryNameFromShortName(c){if(!c){return}var b={AF:"Afghanistan",AX:"Aland Islands",AL:"Albania",DZ:"Algeria",AS:"American Samoa",AD:"Andorra",AO:"Angola",AI:"Anguilla",AQ:"Antarctica",AG:"Antigua And Barbuda",AR:"Argentina",AM:"Armenia",AW:"Aruba",AU:"Australia",AT:"Austria",AZ:"Azerbaijan",BS:"Bahamas",BH:"Bahrain",BD:"Bangladesh",BB:"Barbados",BY:"Belarus",BE:"Belgium",BZ:"Belize",BJ:"Benin",BM:"Bermuda",BT:"Bhutan",BO:"Bolivia",BA:"Bosnia And Herzegovina",BW:"Botswana",BV:"Bouvet Island",BR:"Brazil",IO:"British Indian Ocean Territory",BN:"Brunei Darussalam",BG:"Bulgaria",BF:"Burkina Faso",BI:"Burundi",KH:"Cambodia",CM:"Cameroon",CA:"Canada",CV:"Cape Verde",KY:"Cayman Islands",CF:"Central African Republic",TD:"Chad",CL:"Chile",CN:"China",CX:"Christmas Island",CC:"Cocos (Keeling) Islands",CO:"Colombia",KM:"Comoros",CG:"Congo",CD:"Congo, Democratic Republic",CK:"Cook Islands",CR:"Costa Rica",CI:'Cote D"Ivoire',HR:"Croatia",CU:"Cuba",CY:"Cyprus",CZ:"Czech Republic",DK:"Denmark",DJ:"Djibouti",DM:"Dominica",DO:"Dominican Republic",EC:"Ecuador",EG:"Egypt",SV:"El Salvador",GQ:"Equatorial Guinea",ER:"Eritrea",EE:"Estonia",ET:"Ethiopia",FK:"Falkland Islands (Malvinas)",FO:"Faroe Islands",FJ:"Fiji",FI:"Finland",FR:"France",GF:"French Guiana",PF:"French Polynesia",TF:"French Southern Territories",GA:"Gabon",GM:"Gambia",GE:"Georgia",DE:"Germany",GH:"Ghana",GI:"Gibraltar",GR:"Greece",GL:"Greenland",GD:"Grenada",GP:"Guadeloupe",GU:"Guam",GT:"Guatemala",GG:"Guernsey",GN:"Guinea",GW:"Guinea-Bissau",GY:"Guyana",HT:"Haiti",HM:"Heard Island & Mcdonald Islands",VA:"Holy See (Vatican City State)",HN:"Honduras",HK:"Hong Kong",HU:"Hungary",IS:"Iceland",IN:"India",ID:"Indonesia",IR:"Iran, Islamic Republic Of",IQ:"Iraq",IE:"Ireland",IM:"Isle Of Man",IL:"Israel",IT:"Italy",JM:"Jamaica",JP:"Japan",JE:"Jersey",JO:"Jordan",KZ:"Kazakhstan",KE:"Kenya",KI:"Kiribati",KR:"Korea",KW:"Kuwait",KG:"Kyrgyzstan",LA:'Lao People"s Democratic Republic',LV:"Latvia",LB:"Lebanon",LS:"Lesotho",LR:"Liberia",LY:"Libyan Arab Jamahiriya",LI:"Liechtenstein",LT:"Lithuania",LU:"Luxembourg",MO:"Macao",MK:"Macedonia",MG:"Madagascar",MW:"Malawi",MY:"Malaysia",MV:"Maldives",ML:"Mali",MT:"Malta",MH:"Marshall Islands",MQ:"Martinique",MR:"Mauritania",MU:"Mauritius",YT:"Mayotte",MX:"Mexico",FM:"Micronesia, Federated States Of",MD:"Moldova",MC:"Monaco",MN:"Mongolia",ME:"Montenegro",MS:"Montserrat",MA:"Morocco",MZ:"Mozambique",MM:"Myanmar",NA:"Namibia",NR:"Nauru",NP:"Nepal",NL:"Netherlands",AN:"Netherlands Antilles",NC:"New Caledonia",NZ:"New Zealand",NI:"Nicaragua",NE:"Niger",NG:"Nigeria",NU:"Niue",NF:"Norfolk Island",MP:"Northern Mariana Islands",NO:"Norway",OM:"Oman",PK:"Pakistan",PW:"Palau",PS:"Palestinian Territory, Occupied",PA:"Panama",PG:"Papua New Guinea",PY:"Paraguay",PE:"Peru",PH:"Philippines",PN:"Pitcairn",PL:"Poland",PT:"Portugal",PR:"Puerto Rico",QA:"Qatar",RE:"Reunion",RO:"Romania",RU:"Russian Federation",RW:"Rwanda",BL:"Saint Barthelemy",SH:"Saint Helena",KN:"Saint Kitts And Nevis",LC:"Saint Lucia",MF:"Saint Martin",PM:"Saint Pierre And Miquelon",VC:"Saint Vincent And Grenadines",WS:"Samoa",SM:"San Marino",ST:"Sao Tome And Principe",SA:"Saudi Arabia",SN:"Senegal",RS:"Serbia",SC:"Seychelles",SL:"Sierra Leone",SG:"Singapore",SK:"Slovakia",SI:"Slovenia",SB:"Solomon Islands",SO:"Somalia",ZA:"South Africa",GS:"South Georgia And Sandwich Isl.",ES:"Spain",LK:"Sri Lanka",SD:"Sudan",SR:"Suriname",SJ:"Svalbard And Jan Mayen",SZ:"Swaziland",SE:"Sweden",CH:"Switzerland",SY:"Syrian Arab Republic",TW:"Taiwan",TJ:"Tajikistan",TZ:"Tanzania",TH:"Thailand",TL:"Timor-Leste",TG:"Togo",TK:"Tokelau",TO:"Tonga",TT:"Trinidad And Tobago",TN:"Tunisia",TR:"Turkey",TM:"Turkmenistan",TC:"Turks And Caicos Islands",TV:"Tuvalu",UG:"Uganda",UA:"Ukraine",AE:"United Arab Emirates",GB:"United Kingdom",US:"United States",UM:"United States Outlying Islands",UY:"Uruguay",UZ:"Uzbekistan",VU:"Vanuatu",VE:"Venezuela",VN:"Viet Nam",VG:"Virgin Islands, British",VI:"Virgin Islands, U.S.",WF:"Wallis And Futuna",EH:"Western Sahara",YE:"Yemen",ZM:"Zambia",ZW:"Zimbabwe"};
c=c.trim();if(b[c]){return b[c]}return c}function displayTimeZone(c){console.log("In displayTimeZone");var e;var d;var b=0;$.each(c[0].geometry.location,function(f,g){console.log(g);if(b==0){e=g}else{if(b==1){d=g}}b++});if(!e||!d){return}$.ajax({url:"/core/api/contacts/gettz/"+e()+"/"+d(),type:"GET",dataType:"text",success:function(f){if(f==null||f==""){return}$(".contacts-time").html(_agile_get_translated_val("misc-keys","local-time")+" : "+f);$("#contacts-local-time").show();$("#map_view_action").html("<i class='icon-minus text-sm c-p' title='"+_agile_get_translated_val("contact-details","hide-map")+"' id='disable_map_view'></i>")},error:function(f,h,g){console.log("jqXHR: "+f.status+"\ntextStatus: "+h+"\nerrorThrown: "+g)}})}function initializeImportListeners(){$("#prefs-tabs-content #xero_sync_prefs").off();$("#prefs-tabs-content").on("click","#xero_sync_prefs",function(f){f.preventDefault();var d=$(this).attr("disabled");if(d){return false}$(this).attr("disabled","disabled");$(this).text("Syncing");var c=serializeForm("quickbook-form");c.inProgress=true;App_Widgets.xero_import_settings.model.set(c,{silent:true});var b=App_Widgets.xero_import_settings.model.url;$(this).after(getRandomLoadingImg());App_Widgets.xero_import_settings.model.url=b+"?sync=true";App_Widgets.xero_import_settings.model.save({},{success:function(e){App_Widgets.xero_import_settings.render(true);App_Widgets.xero_import_settings.model.url=b;show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-init"),App_Widgets.xero_import_settings.el);showNotyPopUp("information",_agile_get_translated_val("misc-keys","sync-contacts-init"),"top",1000)}})});$("#prefs-tabs-content #xeroconnect").off();$("#prefs-tabs-content").on("click","#xeroconnect",function(c){var b=window.location.href;console.log(b);window.location="/scribe?service=xero&return_url="+encodeURIComponent(b);return false})}function show_success_message_after_save_button(c,b){$save_info=$('<div class="p-t-xs"><small><p style="color:#B94A48; font-size:14px" class="text-success"><i>'+c+"</i></p></small></div>");$(".form-actions",b).append($save_info);$save_info.show().delay(3000).hide(1)}function getEditDistance(d,c){if(d.length===0){return c.length}if(c.length===0){return d.length}var e=[];var g;for(g=0;g<=c.length;g++){e[g]=[g]}var f;for(f=0;f<=d.length;f++){e[0][f]=f}for(g=1;g<=c.length;g++){for(f=1;f<=d.length;f++){if(c.charAt(g-1)==d.charAt(f-1)){e[g][f]=e[g-1][f-1]}else{e[g][f]=Math.min(e[g-1][f-1]+1,Math.min(e[g][f-1]+1,e[g-1][f]+1))}}}return e[c.length][d.length]}function initializeCustomFieldsListeners(){$("#custom-fields-accordion").on("click",".fieldmodal",function(c){c.preventDefault();var b=$(this).attr("type");showCustomFieldModel({scope:b,position:$(this).parent().parent().find("table > tbody > tr").length+1})});$("#custom-fields-accordion").on("change",'#admin-settings-customfields-model-list > tr > td:not(":first-child")',function(c){c.preventDefault();var b=$(this).closest("tr").data();console.log(b);showCustomFieldModel(b.toJSON())});$("#custom-fields-accordion").on("click","#edit-custom-field",function(c){c.preventDefault();var b=$(this).closest("tr").data();console.log(b);showCustomFieldModel(b.toJSON())});$("#custom-fields-accordion").on("click","#delete-custom-field",function(c){c.preventDefault();var b=$(this);showAlertModal("delete_custom_field","confirm",function(){var e=b.closest("tr").data();console.log(e);var d=b;$.ajax({type:"DELETE",url:"/core/api/custom-fields/"+e.id,contentType:"application/json; charset=utf-8",success:function(f){if(e.get("scope")=="CONTACT"){App_Admin_Settings.contactCustomFieldsListView.collection.remove(e.id)}else{if(e.get("scope")=="COMPANY"){App_Admin_Settings.companyCustomFieldsListView.collection.remove(e.id)}else{if(e.get("scope")=="DEAL"){App_Admin_Settings.dealCustomFieldsListView.collection.remove(e.id)}else{if(e.get("scope")=="CASE"){App_Admin_Settings.caseCustomFieldsListView.collection.remove(e.id)}}}}d.closest("tr").remove()},dataType:"json"})})})}function showCustomFieldModel(d){var c=0;var b=false;b=!d.id;var e=new Base_Model_View({url:"/core/api/custom-fields",template:"custom-field-add-modal",data:d,modal:"#custom-field-add-modal",isNew:b,postRenderCallback:function(g){console.log($("#custom-field-add-modal",g));if(!c){c++;$("#custom-field-add-modal",g).modal("show")}var f=$("#custom-field-add-modal").width();$("#custom-field-add-modal").css("left","50%");$("#custom-field-add-modal").css("width",f);$("#custom-field-add-modal").css("margin",(f/2)*-1);bindCustomFiledChangeEvent(g)},saveCallback:function(f){console.log(f);var g;if(f.scope=="CONTACT"){g=App_Admin_Settings.contactCustomFieldsListView.collection.get(f.id)}else{if(f.scope=="COMPANY"){g=App_Admin_Settings.companyCustomFieldsListView.collection.get(f.id)}else{if(f.scope=="DEAL"){g=App_Admin_Settings.dealCustomFieldsListView.collection.get(f.id)}else{if(f.scope=="CASE"){g=App_Admin_Settings.caseCustomFieldsListView.collection.get(f.id)}}}}if(g){g.set(f)}else{if(f.scope=="CONTACT"){App_Admin_Settings.contactCustomFieldsListView.collection.add(f)}else{if(f.scope=="COMPANY"){App_Admin_Settings.companyCustomFieldsListView.collection.add(f);App_Admin_Settings.companyCustomFieldsListView.render(true)}else{if(f.scope=="DEAL"){App_Admin_Settings.dealCustomFieldsListView.collection.add(f);App_Admin_Settings.dealCustomFieldsListView.render(true)}else{if(f.scope=="CASE"){App_Admin_Settings.caseCustomFieldsListView.collection.add(f);App_Admin_Settings.caseCustomFieldsListView.render(true)}}}}}$("#custom-field-add-modal").modal("hide");$("body").removeClass("modal-open").css("padding-right","")},errorCallback:function(f){if(f.responseText.indexOf("Sorry")==0){$("#duplicate-custom-field-err").html("<i>"+f.responseText+"</i>");$("#duplicate-custom-field-err").removeClass("hide")}else{var g={};g.TEXTAREA="Text Area";g.TEXT="Text Field";g.DATE="Date Field";g.CHECKBOX="Checkbox";g.LIST="List";g.NUMBER="Number";g.FORMULA="Formula";g.CONTACT="Contact";g.COMPANY="Company";if($("#label",$("#textModalForm")).is(":disabled")){$("#duplicate-custom-field-type-err").html("<i>"+g[f.responseText]+" "+_agile_get_translated_val("customfields","label-exists")+"</i>")}else{$("#duplicate-custom-field-type-err").html("<i>"+g[f.responseText]+" "+_agile_get_translated_val("customfields","label-exists-1")+"</i>")}$("#duplicate-custom-field-type-err").removeClass("hide")}setTimeout(function(){$("#duplicate-custom-field-err").addClass("hide");$("#duplicate-custom-field-type-err").addClass("hide")},3000)}});$("#custom-field-modal").html(e.render(true).el);$("#custom-field-type").trigger("change")}function bindCustomFiledChangeEvent(b){$("#custom-field-add-modal",b).on("change","#custom-field-type",function(d){d.preventDefault();var c=$(this).val();if(c=="LIST"){$("#custom-field-data").hide();$("input",$("#custom-field-data")).removeAttr("name");$("#custom-field-list-values").show();$("input",$("#custom-field-list-values")).attr("name","field_data");$("#custom-field-formula-data").hide();$("textarea",$("#custom-field-formula-data")).removeAttr("name");$(".required-and-searchable").show();$("#searchable").prop("disabled",false)}else{if(c=="TEXTAREA"){$("#custom-field-data").show();$("input",$("#custom-field-data")).attr("name","field_data");$("#custom-field-list-values").hide();$("input",$("#custom-field-list-values")).removeAttr("name");$("#custom-field-formula-data").hide();$("textarea",$("#custom-field-formula-data")).removeAttr("name");$(".required-and-searchable").show();$("#searchable").prop("disabled",false)}else{if(c=="FORMULA"){$("#custom-field-data").hide();$("input",$("#custom-field-data")).removeAttr("name");$("#custom-field-list-values").hide();$("input",$("#custom-field-list-values")).removeAttr("name");$("#custom-field-formula-data").show();$("textarea",$("#custom-field-formula-data")).attr("name","field_data");$(".required-and-searchable").hide()}else{if(c=="CONTACT"||c=="COMPANY"){$("#searchable").prop("checked",true);$("#searchable").prop("disabled",true)}else{$("#custom-field-data").hide();$("#custom-field-list-values").hide();$("#custom-field-formula-data").hide();$(".required-and-searchable").show();$("#searchable").prop("disabled",false)}}}}})}function add_custom_fields_to_form(c,f,d){if(d==undefined||d=="CONTACT"){$("#content").html(LOADING_HTML)}var b="core/api/custom-fields/scope?scope="+(d==undefined?"CONTACT":d);var e=Backbone.Model.extend({url:b});new e().fetch({success:function(g){var h=[];$.each(g.toJSON(),function(j,k){h.push(k)});App_Contacts.custom_fields=h;c.custom_fields=h;if(f&&typeof(f)==="function"){f(c)}}})}function show_custom_fields_helper(d,b){var c="";var f=false;if(b.length>0){if(b[0]&&b[0]=="modal"){f=true}}var e="text";$.each(d,function(m,q){if(!q.field_type){return}var p="";var s="";var u="";var r="";var h="";var n="";var l="";var o="";var g=500;if(q.scope=="CONTACT"){p="col-sm-3 word-break-all";h="col-sm-10";n="col-sm-9 company_input";l="col-sm-3";r="col-sm-offset-3 modal-cbx-m-t"}else{if(q.scope=="COMPANY"){p="control-label col-sm-3 word-break-all";s="control-label col-sm-3 word-break-all";u="col-sm-7";n="company_input";o="col-sm-3";r="col-sm-offset-3 modal-cbx-m-t"}else{if(q.scope=="DEAL"){p="control-label col-sm-3 word-break-all";s="control-label col-sm-3 word-break-all";u="col-sm-7";o="col-sm-3";r="col-sm-offset-3 modal-cbx-m-t"}else{if(q.scope=="CASE"){p="control-label col-sm-3 word-break-all";s="control-label col-sm-3 word-break-all";u="col-sm-7";o="col-sm-3";r="col-sm-offset-3"}}}}if(q.field_type.toLowerCase()=="list"){var j=[],k='<option value="">Select</option>';if(q.field_data){j=q.field_data.split(";")}$.each(j,function(v,w){if(w!=""){k=k.concat('<option value="'+w+'">'+w+"</option>")}});if(q.is_required){if(f){c=c.concat('<div class="control-group form-group "><label class="control-label word-break-all '+s+'">'+q.field_label+'<span class="field_req">*</span></label><div class="controls '+u+'"><span><select class="'+q.field_type.toLowerCase()+" custom_field required form-control "+h+'" id='+q.id+' name="'+q.field_label+'">'+k+"</select></span></div></div>")
}else{c=c.concat('<div class="control-group form-group "><label class="control-label '+p+'">'+q.field_label+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+n+'"><select class="'+q.field_type.toLowerCase()+" custom_field required form-control "+h+'" id='+q.id+' name="'+q.field_label+'">'+k+"</select></div></div>")}}else{if(f){c=c.concat('<div class="control-group form-group "><label class="control-label word-break-all '+s+'">'+q.field_label+'</label><div class="controls '+u+'"><select class="'+q.field_type.toLowerCase()+" custom_field form-control "+h+'" id='+q.id+' name="'+q.field_label+'">'+k+"</select></div></div>")}else{c=c.concat('<div class="control-group form-group ">	<label class="control-label '+p+'">'+q.field_label+'</label><div class="controls col-sm-9 '+n+'"><select class="'+q.field_type.toLowerCase()+" custom_field form-control "+h+'" id='+q.id+' name="'+q.field_label+'">'+k+"</select></div></div>")}}return}else{if(q.field_type.toLowerCase()=="checkbox"){e="checkbox";if(q.scope=="DEAL"){if(q.is_required){if(f){c=c.concat('<div class="control-group form-group modal-cbx-m-t"><div class="checkbox '+r+' col-sm-6"><label class="i-checks i-checks-sm "><input type="'+e+'" class="'+q.field_type.toLowerCase()+'_input custom_field required" id='+q.id+' name="'+q.field_label+'" style="margin: 0px 5px;"><i></i>'+q.field_label+'</label><div class="field_req inline-block">*</div><span for="'+q.field_label+'" generated="true" class="help-inline"></span></div></div>')}else{c=c.concat('<div class="control-group form-group ">	<label class="i-checks i-checks-sm '+p+'"><span class="field_req">*</span><input type="'+e+'" class="'+q.field_type.toLowerCase()+'_input custom_field required" id='+q.id+' name="'+q.field_label+'" style="margin: 0px 5px;"><i></i>'+q.field_label+"</label></div>")}}else{if(f){c=c.concat('<div class="control-group form-group modal-cbx-m-t"><div class="checkbox '+r+' col-sm-6"><label class="i-checks i-checks-sm"><input type="'+e+'" class="'+q.field_type.toLowerCase()+'_input custom_field" id='+q.id+' name="'+q.field_label+'" style="margin: 0px 5px;"><i></i>'+q.field_label+"</label></div></div>")}else{c=c.concat('<div class="control-group form-group "><label class="i-checks i-checks-sm '+p+'"><input type="'+e+'" class="'+q.field_type.toLowerCase()+'_input custom_field" id='+q.id+' name="'+q.field_label+'" style="margin: 0px 5px;"><i></i>'+q.field_label+"</label></div>")}}return}if(q.is_required){if(f){c=c.concat('<div class="control-group form-group modal-cbx-m-t"><div class="checkbox '+r+' col-sm-6"><label class="i-checks i-checks-sm"><input type="'+e+'" class="'+q.field_type.toLowerCase()+'_input custom_field required" id='+q.id+' name="'+q.field_label+'"><i></i>'+q.field_label+'</label><div class="field_req inline-block">*</div><span for="'+q.field_label+'" generated="true" class="help-inline"></span></div></div>')}else{c=c.concat('<div class="control-group form-group ">	<label class="control-label '+o+" "+p+'">'+q.field_label+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+l+' m-t-xs"><label class="i-checks i-checks-sm"><input type="'+e+'" class="'+q.field_type.toLowerCase()+'_input custom_field required" id='+q.id+' name="'+q.field_label+'"><i></i></label></div></div>')}}else{if(f){c=c.concat('<div class="control-group form-group modal-cbx-m-t"><div class="checkbox '+r+' col-sm-6"><label class="i-checks i-checks-sm"><input type="'+e+'" class="'+q.field_type.toLowerCase()+'_input custom_field" id='+q.id+' name="'+q.field_label+'"><i></i>'+q.field_label+"</label></label></div></div>")}else{c=c.concat('<div class="control-group form-group "><label class="control-label '+o+" "+p+'">'+q.field_label+'</label><div class="controls col-sm-9 '+l+' m-t-xs"><label class="i-checks i-checks-sm"><input type="'+e+'" class="'+q.field_type.toLowerCase()+'_input custom_field" id='+q.id+' name="'+q.field_label+'"><i></i></label></div></div>')}}return}else{if(q.field_type.toLowerCase()=="textarea"){e="textarea";var t=3;if(q.field_data){t=parseInt(q.field_data)}if(q.is_required){if(f){c=c.concat('<div class="control-group form-group "><label class="control-label word-break-all '+s+'">'+q.field_label+'<span class="field_req">*</span></label><div class="controls '+u+'"><textarea rows="'+t+'" class="'+q.field_type.toLowerCase()+'_input custom_field required form-control resize-vertical field_length" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'"></textarea></div></div>')}else{c=c.concat('<div class="control-group form-group "><label class="control-label '+p+'">'+q.field_label+'<span class="field_req">*</span></label><div class="controls col-sm-9 '+n+'"><textarea rows="'+t+'" class="'+q.field_type.toLowerCase()+'_input custom_field required form-control resize-vertical field_length" id='+q.id+' name="'+q.field_label+'"  max_len="'+g+'"></textarea></div></div>')}}else{if(f){c=c.concat('<div class="control-group form-group "><label class="control-label word-break-all '+s+'">'+q.field_label+'</label><div class="controls '+u+'"><textarea rows="'+t+'" class="'+q.field_type.toLowerCase()+'_input custom_field form-control resize-vertical field_length" id='+q.id+' name="'+q.field_label+'"  max_len="'+g+'"></textarea></div></div>')}else{c=c.concat('<div class="control-group form-group "><label class="control-label '+p+'">'+q.field_label+'</label><div class="controls col-sm-9 '+n+'"><textarea rows="'+t+'" class="'+q.field_type.toLowerCase()+'_input custom_field form-control resize-vertical field_length" id='+q.id+' name="'+q.field_label+'"  max_len="'+g+'"></textarea></div></div>')}}return}else{if(q.field_type.toLowerCase()=="number"){e="number";if(q.is_required){if(f){c=c.concat('<div class="control-group form-group "><label class="control-label word-break-all '+s+'">'+q.field_label+'<span class="field_req">*</span></label><div class="controls custom-number-controls '+u+'"><input type="number" class="'+q.field_type.toLowerCase()+'_input custom_field required form-control field_length" id="'+q.id+'" name="'+q.field_label+'" value="0" max_len="'+g+'"></input></div></div>')}else{c=c.concat('<div class="control-group form-group ">	<label class="control-label '+p+'">'+q.field_label+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+l+' custom-number-controls"><input type="number" class="'+q.field_type.toLowerCase()+'_input custom_field required form-control field_length" id="'+q.id+'" name="'+q.field_label+'" value="0" max_len="'+g+'"></input></div></div>')}}else{if(f){c=c.concat('<div class="control-group form-group "><label class="control-label word-break-all '+s+'">'+q.field_label+'</label><div class="controls custom-number-controls '+u+'"><input type="number" class="'+q.field_type.toLowerCase()+'_input custom_field form-control field_length" id="'+q.id+'" name="'+q.field_label+'" value="0" max_len="'+g+'"></input></div></div>')}else{c=c.concat('<div class="control-group form-group ">	<label class="control-label '+p+'">'+q.field_label+'</label><div class="controls col-sm-9 '+l+' custom-number-controls"><input type="number" class="'+q.field_type.toLowerCase()+'_input custom_field form-control field_length" id="'+q.id+'" name="'+q.field_label+'" value="0" max_len="'+g+'"></input></div></div>')}}return}else{if(q.field_type.toLowerCase()=="formula"){return}else{if(q.field_type.toLowerCase()=="contact"){e="contact";if(q.is_required){if(f){c=c.concat('<div class="control-group form-group " id="custom_contact_'+q.id+'"><label class="control-label word-break-all col-sm-3">'+q.field_label+'<span class="field_req">*</span></label><div class="controls col-sm-7"><ul name="'+q.field_label+'" class="contacts tagsinput tags p-n m-n custom_contact"></ul><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field required_field form-control field_length typeahead typeahead_contacts" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'" placeholder="Contact Name"></div></div>')}else{c=c.concat('<div class="control-group form-group " id="custom_contact_'+q.id+'"><label class="control-label '+p+'">'+q.field_label+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+n+'"><ul name="'+q.field_label+'" class="contacts tagsinput tags p-n m-n custom_contact"></ul><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field required_field form-control field_length typeahead typeahead_contacts" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'" placeholder="Contact Name"></div></div>')}}else{if(f){c=c.concat('<div class="control-group form-group " id="custom_contact_'+q.id+'"><label class="control-label word-break-all col-sm-3">'+q.field_label+'</label><div class="controls col-sm-7"><ul name="'+q.field_label+'" class="contacts tagsinput tags p-n m-n custom_contact"></ul><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field form-control field_length typeahead typeahead_contacts" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'" placeholder="Contact Name"></div></div>')}else{c=c.concat('<div class="control-group form-group " id="custom_contact_'+q.id+'"><label class="control-label '+p+'">'+q.field_label+'</label><div class="controls col-sm-9 '+n+'"><ul name="'+q.field_label+'" class="contacts tagsinput tags p-n m-n custom_contact"></ul><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field form-control field_length typeahead typeahead_contacts" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'" placeholder="Contact Name"></div></div>')}}return}else{if(q.field_type.toLowerCase()=="company"){e="company";if(q.is_required){if(f){c=c.concat('<div class="control-group form-group " id="custom_company_'+q.id+'"><label class="control-label word-break-all col-sm-3">'+q.field_label+'<span class="field_req">*</span></label><div class="controls col-sm-7"><ul name="'+q.field_label+'" class="contacts tagsinput tags p-n m-n custom_company"></ul><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field required_field form-control field_length typeahead typeahead_contacts" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'" placeholder="Company Name"></div></div>')
}else{c=c.concat('<div class="control-group form-group " id="custom_company_'+q.id+'">	<label class="control-label '+p+'">'+q.field_label+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+n+'"><ul name="'+q.field_label+'" class="contacts tagsinput tags p-n m-n custom_company"></ul><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field required_field form-control field_length typeahead typeahead_contacts" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'" placeholder="Company Name"></div></div>')}}else{if(f){c=c.concat('<div class="control-group form-group " id="custom_company_'+q.id+'"><label class="control-label word-break-all col-sm-3">'+q.field_label+'</label><div class="controls col-sm-7"><ul name="'+q.field_label+'" class="contacts tagsinput tags p-n m-n custom_company"></ul><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field form-control field_length typeahead typeahead_contacts" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'" placeholder="Company Name"></div></div>')}else{c=c.concat('<div class="control-group form-group " id="custom_company_'+q.id+'"><label class="control-label '+p+'">'+q.field_label+'</label><div class="controls col-sm-9 '+n+'"><ul name="'+q.field_label+'" class="contacts tagsinput tags p-n m-n custom_company"></ul><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field form-control field_length typeahead typeahead_contacts" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'" placeholder="Company Name"></div></div>')}}return}}}}}}}if(q.is_required){if(f){c=c.concat('<div class="control-group form-group "><label class="control-label word-break-all '+s+'">'+q.field_label+'<span class="field_req">*</span></label><div class="controls '+u+'"><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field required form-control field_length" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'"></div></div>')}else{c=c.concat('<div class="control-group form-group ">	<label class="control-label '+p+'">'+q.field_label+' <span class="field_req">*</span></label><div class="controls col-sm-9 '+n+'"><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field required form-control field_length" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'"></div></div>')}}else{if(f){c=c.concat('<div class="control-group form-group "><label class="control-label word-break-all '+s+'">'+q.field_label+'</label><div class="controls '+u+'"><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field form-control field_length" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'"></div></div>')}else{c=c.concat('<div class="control-group form-group "><label class="control-label '+p+'">'+q.field_label+'</label><div class="controls col-sm-9 '+n+'"><input type="text" class="'+q.field_type.toLowerCase()+'_input custom_field form-control field_length" id='+q.id+' name="'+q.field_label+'" max_len="'+g+'"></div></div>')}}});return c}function show_custom_fields_helper_for_merge(c,d){var b="";$.each(c,function(k,l){var e=[];for(var h=0;h<d.length;h++){if(h===0){var n=false;e.push('<tr><td style="background-color:#f3f3f3">'+l.field_label+"</td>")}var q=d[h];for(var g=0;g<q.properties.length;g++){var o=q.properties[g];if(o.type=="CUSTOM"&&o.name==l.field_label){var m=o.value;if(m){n=true;if(l.field_type.toLowerCase()=="date"){try{m=new Date(o.value*1000).format("mm/dd/yyyy")}catch(f){}}if(h===0){var p='<td><input type="radio" name="'+l.field_label+'" class="'+l.field_type.toLowerCase()+'" checked="checked" fieldtype="custom" oid="'+q.id+'" id="'+l.id+'" field="'+l.field_label+'" data="'+m+'">'+m+"</td>";e.push(p);break}else{var p='<td><input type="radio" name="'+l.field_label+'" class="'+l.field_type.toLowerCase()+'" fieldtype="custom" oid="'+q.id+'" id="'+l.id+'" field="'+l.field_label+'" data="'+m+'">'+m+"</td>";e.push(p);break}}}else{if(g===q.properties.length-1){var p="<td></td>";e.push(p)}}}if(h===d.length-1){if(n){for(var h=0;h<e.length;h++){b=b.concat(e[h])}b=b.concat("</tr>")}e.length=0}}});return b}function fill_custom_field_values(c,b){console.log(b);$.each(b,function(d,e){if(e.type=="CUSTOM"){fill_custom_data(e,c)}});return $("<div>").append(c).html()}function fill_custom_fields_values_generic(c,b){$.each(b,function(d,e){fill_custom_data(e,c)});return $("<div>").append(c).html()}function fill_custom_data(h,g){if(!h.value){return}var c=$(g).find('*[name="'+h.name+'"]');console.log(c);if(!c[0]){return}console.log($(c[0]).hasClass("date_input"));var b=c[0].tagName.toLowerCase();var d=c.attr("type");console.log(h.value);console.log($(c[0]));if(b=="input"){if(d=="checkbox"&&h.value=="on"){c.attr("checked","checked");return}else{if($(c[0]).hasClass("date_input")){try{var f=new Date(h.value);if(f=="Invalid Date"){c.attr("value",getDateInFormatFromEpoc(h.value))}else{c.attr("value",getDateInFormat(f))}return}catch(e){}}}c.attr("value",h.value);console.log(c.val())}if(b=="textarea"){c.html(h.value)}if(b=="select"){if(h.value){c.find('option[value="'+h.value.trim()+'"]').attr("selected","selected")}}}function serialize_custom_fields(d){var c=$("#"+d).find(".custom_field");console.log(c.length);var b=[];$.each(c,function(e,g){name=$(g).attr("name");var f={};f.name=name;var h=$(g).attr("type");f.value=$(g).val();if(h=="checkbox"){f.value=$(g).is(":checked")?"on":"off"}if($(g).hasClass("date_input")&&($(g).val()!=undefined&&$(g).val().trim()!="")){if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy")!=-1||CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy")!=-1){f.value=en.dateFormatter({raw:"MM/dd/yyyy"})(new Date(convertDateFromUKtoUS(this.value)))}else{f.value=en.dateFormatter({raw:"MM/dd/yyyy"})(new Date(this.value))}}if(($(g).hasClass("contact_input")||$(g).hasClass("company_input"))&&isValidContactCustomField($(g).attr("id"))){var j=[];$('ul[name="'+name+'"]',$("#"+d)).find("li").each(function(k){j.push($(this).attr("data"))});f.value=JSON.stringify(j)}if(!f.value){return}b.push(f)});return b}function groupingCustomFields(c){var f="admin-settings-customfields-"+c.get("scope").toLowerCase();if(c.get("scope")=="CONTACT"){App_Admin_Settings.contactCustomFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields/scope/position?scope="+c.get("scope"),sortKey:"position",restKey:"customFieldDefs",templateKey:f,individual_tag_name:"tr",postRenderCallback:function(h){enableCustomFieldsSorting(h,"custom-fields-"+c.get("scope").toLowerCase()+"-tbody","admin-settings-customfields-"+c.get("scope").toLowerCase()+"-model-list");b(App_Admin_Settings.contactCustomFieldsListView.collection)}});function b(h){$.each(h,function(k,j){})}function e(h){addCustomFieldToSearch(h,h.get("scope"))}function g(h){removeCustomFieldFromSortOptions(h,h.get("scope"))}function d(h){updateCustomFieldToSearch(h,h.get("scope"))}App_Admin_Settings.contactCustomFieldsListView.collection.bind("add",e);App_Admin_Settings.contactCustomFieldsListView.collection.bind("remove",g);App_Admin_Settings.contactCustomFieldsListView.collection.bind("change",d);App_Admin_Settings.contactCustomFieldsListView.collection.fetch();$("#customfields-contacts-accordion",this.el).append($(App_Admin_Settings.contactCustomFieldsListView.render().el))}else{if(c.get("scope")=="COMPANY"){App_Admin_Settings.companyCustomFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields/scope/position?scope="+c.get("scope"),sortKey:"position",restKey:"customFieldDefs",templateKey:f,individual_tag_name:"tr",postRenderCallback:function(h){enableCustomFieldsSorting(h,"custom-fields-"+c.get("scope").toLowerCase()+"-tbody","admin-settings-customfields-"+c.get("scope").toLowerCase()+"-model-list")}});App_Admin_Settings.companyCustomFieldsListView.collection.fetch();$("#customfields-companies-accordion",this.el).append($(App_Admin_Settings.companyCustomFieldsListView.render().el))}else{if(c.get("scope")=="DEAL"){App_Admin_Settings.dealCustomFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields/scope/position?scope="+c.get("scope"),sortKey:"position",restKey:"customFieldDefs",templateKey:f,individual_tag_name:"tr",postRenderCallback:function(h){enableCustomFieldsSorting(h,"custom-fields-"+c.get("scope").toLowerCase()+"-tbody","admin-settings-customfields-"+c.get("scope").toLowerCase()+"-model-list")}});App_Admin_Settings.dealCustomFieldsListView.collection.fetch();$("#customfields-deals-accordion",this.el).append($(App_Admin_Settings.dealCustomFieldsListView.render().el))}else{if(c.get("scope")=="CASE"){App_Admin_Settings.caseCustomFieldsListView=new Base_Collection_View({url:"/core/api/custom-fields/scope/position?scope="+c.get("scope"),sortKey:"position",restKey:"customFieldDefs",templateKey:f,individual_tag_name:"tr",postRenderCallback:function(h){enableCustomFieldsSorting(h,"custom-fields-"+c.get("scope").toLowerCase()+"-tbody","admin-settings-customfields-"+c.get("scope").toLowerCase()+"-model-list")}});App_Admin_Settings.caseCustomFieldsListView.collection.fetch();$("#customfields-cases-accordion",this.el).append($(App_Admin_Settings.caseCustomFieldsListView.render().el))}}}}}function enableCustomFieldsSorting(b,c,d){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$("."+c).sortable({axis:"y",containment:"."+c,scroll:false,items:"tr",helper:function(h,f){var g=f.children();var j=f.clone();j.children().each(function(e){$(this).width(g.eq(e).width()+50);$(this).css("background","#f5f5f5");$(this).css("border-bottom","1px solid #ddd");$(this).css("max-width",(g.eq(e).width()+50)+"px")});return j},sort:function(e,f){f.helper.css("top",(f.helper.offset().top+f.item.offset().top)+"px")},forceHelperSize:true,placeholder:"<tr><td></td></tr>",forcePlaceholderSize:true,handle:".icon-move",cursor:"move",tolerance:"intersect"});$("."+c,b).on("sortstop",function(e,f){var g=[];$("#"+d+" > tr").each(function(h){var j=$(this).data().id;g.push({id:j,position:h+1})});$.ajax({type:"POST",url:"/core/api/custom-fields/positions",data:JSON.stringify(g),contentType:"application/json; charset=utf-8",dataType:"json"})
})})}var timer=undefined;$(function(){$("body").off("mouseover",".popover_contact");$("body").on("mouseover",".popover_contact",function(d){var c=d.pageX;var b=$(this);timer=setTimeout(function(){if(!insidePopover){$(".popover").remove();var e=$(b).attr("data");$.ajax({type:"GET",url:"/core/api/contacts/"+e,dataType:"json",success:function(f){if(f!=undefined){App_Contacts.contact_popover=new Backbone.Model(f);getTemplate("contacts-custom-view-popover",f,undefined,function(g){if(!g){return}$(b).popover({rel:"popover",trigger:"manual",placement:"auto right",html:"true",content:g,container:"body"});$(b).popover("show");$(".popover-content").html(g);$(".popover").addClass("contact_popover fadeInLeft  animated");addTagsTypeaheadLhs($("#addTagsForm-popover").find("#addTagsOnPopover"));attachEvents(b,App_Contacts.contact_popover);contact_list_starify(".popover",undefined)})}}})}},1000)});$("body").off("mouseout",".popover_contact");$("body").on("mouseout",".popover_contact",function(c){var b=$(this).parent();setTimeout(function(){if(!insidePopover){if($(".popover").length!=0){$(b).popover("hide");$(".popover").remove()}}},200);clearTimeout(timer)})});function contactListener(b){$("#contacts-list-view-model-list").off("mouseenter",'tr > td:not(":first-child")');$("#contacts-list-view-model-list").on("mouseenter",'tr > td:not(":first-child")',function(g){var f=g.pageX;f=f-100;var d=0;var c=$(this).parent();if($(this).hasClass("contact-type-custom-field-td")||$(this).hasClass("company-type-custom-field-td")||$(this).hasClass("contact-type-image")||$(this).hasClass("company-type-image")){return}popoverEnter(c,f,d,true)});$("#contacts-list-view-model-list").off("mouseleave",'tr > td:not(":first-child")');$("#contacts-list-view-model-list").on("mouseleave",'tr > td:not(":first-child")',function(){var c=$(this).parent();popout(c)});$(b).off("mouseenter","tr");$(b).on("mouseenter","tr",function(d){var c=$(this);popoverEnter(c,undefined,0,undefined)});$(b).off("mouseleave","tr");$(b).on("mouseleave","tr",function(){var c=$(this);popout(c)});$("#company-contacts-model-list").off("mouseenter","tr > td");$("#company-contacts-model-list").on("mouseenter","tr > td",function(f){var d=f.pageX;d=d-100;var c=$(this).parent();popoverEnter(c,d,0,undefined)});$("#company-contacts-model-list").off("mouseleave","tr > td");$("#company-contacts-model-list").on("mouseleave","tr > td",function(){var c=$(this).parent();popout(c)});$("#task-related-model-list").off("mouseenter","tr > td");$("#task-related-model-list").on("mouseenter","tr > td",function(f){var d=f.pageX;d=d-100;var c=$(this).parent();popoverEnter(c,d,0,undefined)});$("#task-related-model-list").off("mouseleave","tr > td");$("#task-related-model-list").on("mouseleave","tr > td",function(){var c=$(this).parent();popout(c)});$("#deal-related-model-list").off("mouseenter","tr > td");$("#deal-related-model-list").on("mouseenter","tr > td",function(f){var d=f.pageX;d=d-100;var c=$(this).parent();popoverEnter(c,d,0,undefined)});$("#deal-related-model-list").off("mouseleave","tr > td");$("#deal-related-model-list").on("mouseleave","tr > td",function(){var c=$(this).parent();popout(c)});$("#workflow-other-subscribers-model-list").off("mouseenter","td.data .table-resp");$("#workflow-other-subscribers-model-list").on("mouseenter","td.data .table-resp",function(f){var d=f.pageX;var c=$(this).parents("tr");d=d-100;if(insidePopover==true){insidePopover=false;$("time.campaign-started-time").timeago();$("time.campaign-completed-time").timeago()}popoverEnter(c,d,0,undefined,true)});$("#workflow-other-subscribers-model-list").off("mouseleave","td.data .table-resp");$("#workflow-other-subscribers-model-list").on("mouseleave","td.data .table-resp",function(){var c=$(this).parents("tr");popout(c)});$("#")}var insidePopover=false;function attachEvents(d,c,b,e){$(".popover").off("mouseenter",".popover-content");$(".popover").on("mouseenter",".popover-content",function(){insidePopover=true});$(".popover").off("mouseleave",".popover-content");$(".popover").on("mouseleave",".popover-content",function(){insidePopover=false;$(d).popover("hide");$(".popover").remove()});$(".popover").off("click","#add-score");$(".popover").on("click","#add-score",function(l){l.preventDefault();var j=$(this);var k=parseInt($("#lead-score",$(this).parents("#score")).text());var h;k=k+1;$("#lead-score",$(this).parents("#score")).text(k);$("#lead-score",$(this).parents("#score")).attr("title",k);if(b!=undefined){h=c.set("lead_score",k)}else{h=c.set("lead_score",k,{silent:true});h.trigger("popoverChange")}var g=h.toJSON();var f=new Backbone.Model();f.url="core/api/contacts";f.save(g,{success:function(m){}})});$(".popover").off("click","#minus-score");$(".popover").on("click","#minus-score",function(l){l.preventDefault();var k=$(this);var h;var j=parseInt($("#lead-score",$(this).parents("#score")).text());j=j-1;$("#lead-score",$(this).parents("#score")).text(j);$("#lead-score",$(this).parents("#score")).attr("title",j);if(b!=undefined){h=c.set("lead_score",j)}else{h=c.set("lead_score",j,{silent:true});h.trigger("popoverChange")}var g=h.toJSON();var f=new Backbone.Model();f.url="core/api/contacts";f.save(g,{success:function(m){}})});$(".popover").off("click","#lead-score");$(".popover").on("click","#lead-score",function(f){f.preventDefault();$("#contactscorebox").removeClass("hide");$("#lead-score").addClass("hide");$("#contactscorebox").val($("#lead-score").text());$("#contactscorebox").focus()});$(".popover").off("focusout","#contactscorebox");$(".popover").on("focusout","#contactscorebox",function(f){f.preventDefault();contactPopupScoreValue()});$(".popover").off("keyup","#contactscorebox");$(".popover").on("keyup","#contactscorebox",function(f){f.preventDefault();if(f.keyCode==13){contactPopupScoreValue()}});$(".popover").off("click","#company-minus-score");$(".popover").on("click","#company-minus-score",function(l){l.preventDefault();var k=$(this);var h;var j=parseInt($("#lead-score",$(this).parents("#score")).text());if(j<=0){return}j=j-1;$("#lead-score",$(this).parents("#score")).text(j);$("#lead-score",$(this).parents("#score")).attr("title",j);if(b!=undefined){h=c.set("lead_score",j)}else{h=c.set("lead_score",j,{silent:true});h.trigger("popoverChange")}var g=h.toJSON();var f=new Backbone.Model();f.url="core/api/contacts";f.save(g,{success:function(m){}})});$(".popover").off("click","#add-tags-popover");$(".popover").on("click","#add-tags-popover",function(g){g.preventDefault();var f=$(this);$(g.currentTarget).css("display","none");$("#addTagsForm-popover").css("display","table");$("#addTags-popover").focus();setup_tags_typeahead(function(h){json=c.toJSON();if($.inArray(h,json.tags)>=0){return}json.tagsWithTime.push({tag:h});saveEntity(json,"core/api/contacts",function(k){$("#addTagsForm-popover").css("display","none");$("#add-tags-popover").css("display","block");if(b!=undefined){c.set(k.toJSON())}else{c.set(k.toJSON(),{silent:true});c.trigger("popoverChange")}var j=[];$.each($("#added-tags-popover").children(),function(l,m){j.push($(m).html())});if($.inArray(h,j)==-1){$("#added-tags-popover").append('<span class="label bg-light dk text-tiny">'+h+"</span>")}});return})});$(".popover").off("click","#contact-add-tags-popover");$(".popover").on("click","#contact-add-tags-popover",function(j){j.preventDefault();var g=$(this);var h=get_new_tags("addTagsOnPopover");if(h){h=h.trim()}if(!h||h.length<=0||(/^\s*$/).test(h)){console.log(h);return}if(!isValidTag(h,true)){return}$("#add-tags-popover").css("display","block");$("#addTagsForm-popover").css("display","none");console.log(h);if(h){var f=c.toJSON();$("#addTagsForm-popover input").each(function(){$(this).val("")});if($.inArray(h,f.tags)>=0){return}acl_util.canAddTag(h.toString(),function(l){f.tagsWithTime.push({tag:h.toString()});var k=new Backbone.Model();k.url="core/api/contacts";k.save(f,{success:function(n){if(b!=undefined){c.set(n.toJSON())}else{c.set(n.toJSON(),{silent:true});c.trigger("popoverChange")}var m=[];$.each($("#added-tags-popover").children(),function(o,p){m.push($(p).html())});if($.inArray(j,m)==-1){$("#added-tags-popover").append('<span class="label bg-light dk text-tiny">'+h+"</span>")}console.log(h);tagsCollection.add(new BaseModel({tag:h}))},error:function(n,m){console.log(m);showAlertModal(m.responseText,undefined,undefined,undefined,"Error")}})})}});$(".popover").off("click","#contact-owner-popover");$(".popover").on("click","#contact-owner-popover",function(h){var g=$(this);h.preventDefault();var f="<li><a href='javascript:void(0)' class='contact-owner-list-popover' data='{{id}}'>{{name}}</a></li>";fillSelect("contact-detail-owner-popover","/core/api/users/partial","domainUsers",function(){$(g).css("display","none");$(g).parent().find("#change-owner-ul-popover").css("display","inline-block");if($(g).parent().find("#change-owner-ul-popover").css("display")=="inline-block"){$(g).parent().find(".loading").remove()}},f,true)});$(".popover").off("click",".contact-owner-list-popover");$(".popover").on("click",".contact-owner-list-popover",function(l){l.preventDefault();var k=$(this);var m=$(l.currentTarget);$("#change-owner-ul-popover").css("display","none");var f=$(m).attr("data");var h=$(m).text();var j=$("#contact-owner-popover").attr("data");if(f==j){$("#contact-owner-popover").css("display","inline-block");return}var g=new BaseModel();g.url="/core/api/contacts/change-owner/"+f+"/"+c.get("id");g.save(c.toJSON(),{success:function(n){$("#contact-owner-popover").text(h);$("#contact-owner-popover").attr("data",f);$("#contact-owner-popover").attr("title",h);$("#contact-owner-popover").css("display","inline-block");if(b!=undefined){c.set(n.toJSON())}else{c.set(n.toJSON(),{silent:true});c.trigger("popoverChange")}}})})}function contactPopupScoreValue(){var c=parseInt($("#contactscorebox").val());var e=$("#contactscorebox").val();var d=App_Contacts.contact_popover.toJSON();var f=((d.lead_score)?d.lead_score:0);if(((d.type=="PERSON"&&c!=f&&(e%1==0))||$("#contactscorebox").val()=="")||((d.type=="COMPANY"&&(c>0)&&c!=f&&(e%1==0))||$("#contactscorebox").val()=="")){if($("#contactscorebox").val()==""){c=0
}App_Contacts.contact_popover.set({lead_score:c},{silent:true});var d=App_Contacts.contact_popover.toJSON();var b=new Backbone.Model();b.url="core/api/contacts";b.save(d,{success:function(g){}})}if(d.type=="COMPANY"&&(isNaN(c)||c!=e||(c<0))){alert("Please enter a valid number.");c=f}else{if(isNaN(c)||c!=e){alert("Please enter a valid number.");c=f}else{if(c==f){c=f}}}$("#lead-score").attr("data-original-title",c);$("#lead-score").text(c).removeClass("hide");$("#contactscorebox").addClass("hide").val(c);$("#lead-score").attr("title",c)}function agile_crm_get_List_contact_properties_list(c){var b=App_Contacts.contact_popover;var e=b.get("properties");var d=[];$.each(e,function(f,g){if(g.name==c){d.push(g)}});return d}function contact_list_starify(c,b){head.js(LIB_PATH+"lib/jquery.raty.min.js",function(){var d=App_Contacts.contact_popover;if(App_Contacts.contact_popover&&App_Contacts.contact_popover.get("owner")&&!canEditContact(App_Contacts.contact_popover.get("owner").id)){$("#star",c).raty({readOnly:true,score:App_Contacts.contact_popover.get("star_value")});return}$("#star",c).raty({click:function(g,f){if(b!=undefined){App_Contacts.contact_popover.set({star_value:g})}else{App_Contacts.contact_popover.set({star_value:g},{silent:true});App_Contacts.contact_popover.trigger("popoverChange")}d=App_Contacts.contact_popover.toJSON();var e=new Backbone.Model();e.url="core/api/contacts";e.save(d,{success:function(h){}})},score:d.get("star_value")})})}function popoverEnter(c,e,d,b,f){timer=setTimeout(function(){if(!insidePopover){$(".popover").remove();App_Contacts.contact_popover=$(c).data();try{getTemplate("contacts-custom-view-popover",App_Contacts.contact_popover.toJSON(),undefined,function(h){if(!h){return}$(c).popover({rel:"popover",trigger:"manual",placement:"auto top",html:"true",content:h,container:"body"});$(c).popover("show");$(".popover").addClass("contact_popover fadeInLeft animated");$(".popover-content").html(h);if(e!=undefined){$(".popover").css("left",e+"px")}if(d!=undefined){if(window.innerHeight-$(c).offset().top+$(window).scrollTop()>=250){d=$(c).offset().top+20+"px"}else{d=$(c).offset().top-$(".popover").height()+"px"}$(".popover").css("top",d)}attachEvents(c,App_Contacts.contact_popover,b,f);contact_list_starify(".popover",b)});c.find(".data").attr("data")}catch(g){return false}}},1000)}function popout(b){setTimeout(function(){if(!insidePopover){if($(".popover").length!=0){$(b).popover("hide");$(".popover").remove()}}},200);clearTimeout(timer)}var CURRENT_VIEW_OBJECT;var CONTACTS_SORT_LIST={created_time:"Created Date",lead_score:"Score",star_value:"Star Value",first_name:"First Name",last_name:"Last Name",last_contacted:"Contacted Date",};var ifFromRender=false;function contactTableView(j,k,g,l,d){var h="contacts-list-view-model";var b=_agile_get_prefs("agile_contact_view");if(b){h="contacts-grid"}var e=new Base_List_View({model:j,template:h,tagName:g.options.individual_tag_name});e.model.unbind("change");e.renderRow=function(o,p){var n=g.options.modelData;var m=n.fields_set;var c=j.toJSON();var o=e.el;if(!b||window.location.hash=="#companies"){if(agile_is_mobile_browser()){getTemplate("contacts-custom-view-basic_info-mobile",c,undefined,function(q){if(!q){return}$(o).append($(q))},null)}else{if(p!=true){$(o).html($(o).find("td").first())}$.each(m,function(q,u){if(u.indexOf("CUSTOM_")!=-1){u=u.split("CUSTOM_")[1];var w=getCustomProperty(c.properties,u);var s={};if(!w){s.id=c.id;getTemplate("contacts-custom-view-custom",s,undefined,function(x){if(!x){return}$(o).append($(x))},null);return}if(isDateCustomField(k,w)){console.log("got true");s=w;s.id=c.id;getTemplate("contacts-custom-view-custom-date",s,undefined,function(x){if(!x){return}$(o).append($(x))},null)}else{if(isContactTypeCustomField(l,w)){var r=[];try{r=JSON.parse(w.value)}catch(t){console.log("no contact ids found");console.log(t.message)}var v="";$.each(r,function(x,y){v+=y+","});App_Contacts.referenceContactsCollection=new Base_Collection_View({url:"/core/api/contacts/references?references="+v,sort_collection:false});getTemplate("contacts-custom-view-custom-contact",{},undefined,function(x){if(!x){return}$(o).append($(x).attr("contact_id",c.id))},null);App_Contacts.referenceContactsCollection.collection.fetch({success:function(x){if(x&&x.length>0){getTemplate("contacts-custom-view-custom-contact",x.toJSON(),undefined,function(z){if(!z){return}$(o).find("td[contact_id="+c.id+"]").html($(z).html());var y=false;$(o).find("td[contact_id="+c.id+"]").find(".contact-type-image").each(function(A,B){if(A>3){y=true;$(this).remove()}});if(y){$(o).find("td[contact_id="+c.id+"]").find("div:first").append("<div class='m-t' style='font-size:20px;'>...</div>")}},null)}hideTransitionBar()}})}else{if(isCompanyTypeCustomField(d,w)){var r=[];try{r=JSON.parse(w.value)}catch(t){console.log("no contact ids found");console.log(t.message)}var v="";$.each(r,function(x,y){v+=y+","});App_Contacts.referenceContactsCollection=new Base_Collection_View({url:"/core/api/contacts/references?references="+v,sort_collection:false});getTemplate("contacts-custom-view-custom-company",{},undefined,function(x){if(!x){return}$(o).append($(x).attr("company_id",c.id))},null);App_Contacts.referenceContactsCollection.collection.fetch({success:function(x){if(x&&x.length>0){getTemplate("contacts-custom-view-custom-company",x.toJSON(),undefined,function(z){if(!z){return}$(o).find("td[company_id="+c.id+"]").html($(z).html());var y=false;$(o).find("td[company_id="+c.id+"]").find(".company-type-image").each(function(A,B){if(A>3){y=true;$(this).remove()}});if(y){$(o).find("td[company_id="+c.id+"]").find("div:first").append("<div class='m-t' style='font-size:20px;'>...</div>")}},null)}hideTransitionBar()}})}else{s=w;s.id=c.id;getTemplate("contacts-custom-view-custom",s,undefined,function(x){if(!x){return}$(o).append($(x))},null)}}}return}getTemplate("contacts-custom-view-"+u,c,undefined,function(x){if(!x){return}$(o).append($(x))},null)})}}else{getTemplate("contacts-grid-view-model",c,undefined,function(q){if(!q){return}$(o).append($(q))},null)}};e.render=function(c){isFromRender=true;this.renderRow(c,isFromRender)};e.model.bind("change",e.renderRow,e);e.render();$(("#"+g.options.templateKey+"-model-list"),g.el).append(e.el);$(("#"+g.options.templateKey+"-model-list"),g.el).find("tr:last").data(j);$(("#"+g.options.templateKey+"-model-list"),g.el).find("tr:last").data();var f=$(("#"+g.options.templateKey+"-model-list"),g.el).closest("table").find("tr:first").find("th:first").text();if(f=="Basic info"){$(("#"+g.options.templateKey+"-model-list"),g.el).closest("table").removeClass("contactsimage");$(("#"+g.options.templateKey+"-model-list"),g.el).closest("table").addClass("contactsimage")}}function isDateCustomField(b,d){var c=0;$.each(b,function(e,f){if(f.field_label==d.name){c++}});return c>0}function setupViews(c,b){getTemplate("contact-view-collection",{},undefined,function(e){if(!e){return}var d=$(e);$("#view-list",c).html(d);if(b){$("#view-list",c).find(".custom_view").append(b)}if(_agile_get_prefs("company_filter")||_agile_get_prefs("contact_filter_type")=="COMPANY"){$("#contact-view-model-list>li").css("display","none");$("#contact-view-model-list>li:first").css("display","list-item")}},$("#view-list",c));setUpContactSortFilters(c)}var COMPANY_CUSTOM_SORT_VIEW=undefined;function setUpCompanySortFilters(c){if(COMPANY_CUSTOM_SORT_VIEW){$("#contact-sorter",c).html(COMPANY_CUSTOM_SORT_VIEW.render(true).el);return}var b=COMPANY_SORT_FIELDS_VIEW.view();COMPANY_CUSTOM_SORT_VIEW=new b({data:sort_company_configuration.getCompanySortableFields(),templateKey:"contact-view-sort",sortPrefsName:"company_sort_field",individual_tag_name:"li",sort_collection:false,postRenderCallback:function(d){COMPANY_CUSTOM_SORT_VIEW.postProcess()}});COMPANY_CUSTOM_SORT_VIEW.init();$("#contact-sorter",c).html(COMPANY_CUSTOM_SORT_VIEW.render(true).el);getSearchableCustomFields("COMPANY",function(d){COMPANY_CUSTOM_SORT_VIEW.addAll(d)})}var CUSTOM_SORT_VIEW=undefined;function setUpContactSortFilters(c){if(CUSTOM_SORT_VIEW){$("#contact-sorter",c).html(CUSTOM_SORT_VIEW.render(true).el);return}var b=CONTACT_SORT_FIELDS_VIEW.view();CUSTOM_SORT_VIEW=new b({data:sort_configuration.getContactSortableFields(),templateKey:"contact-view-sort",sortPrefsName:"sort_by_name",individual_tag_name:"li",sort_collection:false,postRenderCallback:function(d){CUSTOM_SORT_VIEW.postProcess()}});CUSTOM_SORT_VIEW.init();$("#contact-sorter",c).html(CUSTOM_SORT_VIEW.render(true).el);getSearchableCustomFields("CONTACT",function(d){CUSTOM_SORT_VIEW.addAll(d)})}function setUpCompanyFields(b){var c=[];$("#companies-static-fields-group",b).html(getTemplate("companies-custom-fields"));$.ajax({type:"GET",url:"/core/api/custom-fields/",contentType:"application/json; charset=utf-8",success:function(e){console.log(e);for(var d=0;d<e.length;d++){if(e[d].scope=="COMPANY"){getTemplate("companies-custom-fields-append",e[d],undefined,function(f){if(!f){return}$("#custom-fields-group",b).append(f)})}}$.ajax({url:"core/api/contact-view-prefs/company",type:"GET",dataType:"json",success:function(g){var f=$("#companies-static-fields");deserializecontactsForm(g.fields_set,f);console.log(g)}})},dataType:"json"})}function addCustomFieldToSearch(b,c){var d;if(c=="COMPANY"){d=COMPANY_CUSTOM_SORT_VIEW}else{d=CUSTOM_SORT_VIEW}if(!d){return}if(!b){return}if(!b.get("searchable")){return}d.collection.add(b)}function updateCustomFieldToSearch(b,d){var e;if(d=="COMPANY"){e=COMPANY_CUSTOM_SORT_VIEW}else{e=CUSTOM_SORT_VIEW}if(!e){return}if(!b){return}var c=b.get("searchable");if(c){addCustomFieldToSearch(b,d)}else{removeCustomFieldFromSortOptions(b,d)}}function removeCustomFieldFromSortOptions(b,d){var e;if(d=="COMPANY"){e=COMPANY_CUSTOM_SORT_VIEW}else{e=CUSTOM_SORT_VIEW}if(!b){return}if(!e){return}var c=e.collection.get(b.get("id"));if(c){e.collection.remove(b.get("id"));e.render(true)}}function getSearchableCustomFields(b,c){if(!b){b="CONTACT"}$.getJSON("core/api/custom-fields/searchable/scope?scope="+b,function(d){if(c&&typeof c==="function"){c(d)
}})}function updateSelectedSortKey(d){var b=_agile_get_prefs("sort_by_name");$(".sort-field-check").addClass("display-none");$(".sort-by-check").addClass("display-none");if(b&&b!=null){var c=b.split("-");if(c[0]==""){$(".sort-by[data='-']").find("i").removeClass("display-none")}else{$(".sort-by[data='']").find("i").removeClass("display-none")}if(c.length>1){b=c[1]}$(".sort-field[data='"+b+"']").find("i").removeClass("display-none");printSortNameByData(b)}else{$(".sort-by[data='']").find("i").removeClass("display-none");$(".sort-field[data='created_time']").find("i").removeClass("display-none");printSortNameByData("created_time")}}function printSortNameByData(b){$(".contacts-toolbar").find(".sort-field-txt").html(CONTACTS_SORT_LIST[b])}function addClickEventsForSorting(b){$(".contacts-toolbar").on("click","a.sort-field",function(f){f.preventDefault();var d=$(this).attr("data");printSortNameByData(d);var c=_agile_get_prefs("sort_by_name");if(c!=undefined&&c!=null&&c[0]=="-"){d="-"+d}_agile_set_prefs("sort_by_name",d);CONTACTS_HARD_RELOAD=true;if(!App_Contacts.tag_id){App_Contacts.contacts(undefined,undefined,undefined,true);return}App_Contacts.contacts(App_Contacts.tag_id,undefined,undefined,true);return});$(".contacts-toolbar").on("click","a.sort-by",function(f){f.preventDefault();var c=$(this).attr("data");var d=_agile_get_prefs("sort_by_name");if(d==null||d==undefined){d="created_time"}if(d[0]=="-"){d=d.slice(1)}_agile_set_prefs("sort_by_name",c+d);CONTACTS_HARD_RELOAD=true;if(!App_Contacts.tag_id){App_Contacts.contacts(undefined,undefined,undefined,true);return}App_Contacts.contacts(App_Contacts.tag_id,undefined,undefined,true);return})}$(function(){$("body").on("click",".ContactView",function(b){b.preventDefault();if(App_Contacts.contactViewModel){App_Contacts.contactViewModel=undefined}if(App_Contacts.contact_custom_view){App_Contacts.contact_custom_view=undefined}var c=$(this).attr("id");_agile_set_prefs("contact_view",c);if(filter_id=_agile_get_prefs("contact_filter")){App_Contacts.customView(c,undefined,"core/api/filters/query/"+filter_id);return}if(_agile_get_prefs("company_filter")){App_Contacts.contacts();return}if(!App_Contacts.tag_id){App_Contacts.customView(c);return}App_Contacts.customView(c,undefined,"core/api/tags/"+App_Contacts.tag_id,App_Contacts.tag_id)});$("body").on("click",".DefaultView",function(b){b.preventDefault();if(company_util.isCompany()){return}_agile_delete_prefs("contact_view");_agile_delete_prefs("agile_contact_view");if(App_Contacts.contactViewModel){App_Contacts.contactViewModel=undefined}if(App_Contacts.contactsListView){App_Contacts.contactsListView=undefined}if(!App_Contacts.tag_id){App_Contacts.contacts();return}App_Contacts.contacts(App_Contacts.tag_id)});$("body").on("click",".GridView",function(b){b.preventDefault();_agile_delete_prefs("contact_view");_agile_set_prefs("agile_contact_view","grid_view");if(App_Contacts.contactsListView){App_Contacts.contactsListView=undefined}App_Contacts.contacts(undefined,undefined,true)})});function isContactTypeCustomField(b,d){var c=0;$.each(b,function(e,f){if(f.field_label==d.name&&f.field_type=="CONTACT"){c++}});return c>0}function isCompanyTypeCustomField(d,c){var b=0;$.each(d,function(e,f){if(f.field_label==c.name&&f.field_type=="COMPANY"){b++}});return b>0}var contacts_view_loader={fetchHeadings:function(c){if(!App_Contacts.contactViewModel){var b=new Backbone.Model();b.url="core/api/contact-view-prefs";b.fetch({success:function(d){App_Contacts.contactViewModel=d.toJSON();if(c&&typeof c==="function"){return c(App_Contacts.contactViewModel)}}})}else{if(c&&typeof c==="function"){return c(App_Contacts.contactViewModel)}}},getContacts:function(l,e,b){if(CONTACTS_HARD_RELOAD==true){App_Contacts.contactsListView=undefined;CONTACTS_HARD_RELOAD=false}var h=this;var c=this.getContactsUrl(b);var f=getContactPadcontentKey(c);var k=this.getContactsTemplateKey();var j=this.getContactsIndividualTagName();var d={filterJson:this.getPostData()};var g=this.getContactsSortKey();App_Contacts.contactDateFields=CONTACTS_DATE_FIELDS;App_Contacts.contactContactTypeFields=CONTACTS_CONTACT_TYPE_FIELDS;App_Contacts.contactCompanyTypeFields=CONTACTS_COMPANY_TYPE_FIELDS;if(!App_Contacts.contactsListView){App_Contacts.contactsListView=new Contacts_Events_Collection_View({url:c,modelData:l,sort_collection:false,templateKey:k,individual_tag_name:j,post_data:d,cursor:true,page_size:25,global_sort_key:g,slateKey:f,request_method:"POST",postRenderCallback:function(m,n){h.setUpContactView($("#content"));h.setupContactFilterName(m,b);if(CURRENT_DOMAIN_USER.domain=="fieldglobal"){head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$("time",m).timeago()})}if(App_Contacts.contactsListView.collection.models.length>0&&!App_Contacts.contactsListView.collection.models[0].get("count")){getAndUpdateCollectionCount("contacts",e)}else{contacts_view_loader.setUpContactsCount(e)}contactListener()},appendItemCallback:function(m){if(CURRENT_DOMAIN_USER.domain=="fieldglobal"){includeTimeAgo(m)}}});App_Contacts.contactsListView.collection.fetch();App_Contacts.contactsListView.appendItem=function(m){contactTableView(m,App_Contacts.contactDateFields,this,App_Contacts.contactContactTypeFields,App_Contacts.contactCompanyTypeFields)};$("#contacts-list-view",e).html(App_Contacts.contactsListView.render().el)}else{App_Contacts.contactsListView.options.modelData=l;App_Contacts.contactsListView.appendItem=function(m){contactTableView(m,App_Contacts.contactDateFields,this,App_Contacts.contactContactTypeFields,App_Contacts.contactCompanyTypeFields)};$("#contacts-list-view",e).html(App_Contacts.contactsListView.render(true).el)}},getContactsUrl:function(b){if(b){return"core/api/tags/list/"+decodeURI(b)}var c=_agile_get_prefs("contact_filter");if(c){return"core/api/filters/query/list/"+c}if(_agile_get_prefs("dynamic_contact_filter")){return"core/api/filters/filter/dynamic-filter"}return"/core/api/contacts/list"},setupContactFilterName:function(c,f){if(f){var b=Handlebars.compile('<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li  class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="m-l-xs pull-left">{{name}}</span><a class="close default_contact_remove_tag m-l-xs pull-left">&times</a></li></ul>');$(".filter-criteria",c).html(b({name:decodeURI(f)})).attr("_filter",f);return}var g=_agile_get_prefs("contact_filter");if(!g){$(".filter-criteria",c).html("");return}var e="My Contacts";if(g!="system-CONTACTS"&&contactFiltersListView&&contactFiltersListView.collection){var d=contactFiltersListView.collection.get(g);if(d){e=d.get("name")}}var b=Handlebars.compile('<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="inline-block m-r-xs v-middle">{{name}}</span><a class="close default_filter">&times</a></li></ul>');$(".filter-criteria",c).html(b({name:e})).attr("_filter",g)},getContactsSortKey:function(){var b=_agile_get_prefs("sort_by_name");if(b){return b}return"-created_time"},getContactsTemplateKey:function(){var b="contacts-list-view";if(_agile_get_prefs("agile_contact_view")){b="contacts-grid-view"}return b},getContactsIndividualTagName:function(){var b="tr";if(_agile_get_prefs("agile_contact_view")){b="div"}return b},getPostData:function(){var b=_agile_get_prefs("dynamic_contact_filter");if(b){return b}return""},setUpContactView:function(b){if(_agile_get_prefs("agile_contact_view")){$("#contacts-view-options",b).html("<a data-toggle='tooltip' data-placement='bottom' data-original-title='List View' class='btn btn-default btn-sm contacts-view' data='list'><i class='fa fa-list'  style='margin-right:3px'></i></a>");$("#contacts-grid-view-checkbox",b).show();$("#contacts-list-view-checkbox",b).hide();$("#contactTabelView",b).hide();$("#bulk-action-btns",b).css("border-bottom","1px solid #dee5e7");return}$("#contacts-view-options",b).html("<a data-toggle='tooltip' data-placement='bottom' data-original-title='Grid View' class='btn btn-default btn-sm contacts-view' data='grid'><i class='fa fa-th-large' style='margin-right:3px'></i></a>");$("#contacts-grid-view-checkbox",b).hide();$("#contacts-list-view-checkbox",b).show();$("#bulk-action-btns",b).css("border-bottom","0");return},setUpContactsCount:function(b){if(App_Contacts.contactsListView&&App_Contacts.contactsListView.collection){var c=0;if(App_Contacts.contactsListView.collection.models.length>0){c=App_Contacts.contactsListView.collection.models[0].attributes.count||App_Contacts.contactsListView.collection.models.length}var d;if(c>9999&&(_agile_get_prefs("contact_filter")||_agile_get_prefs("dynamic_contact_filter"))){d="<small> ("+10000+'+ Total) </small><span style="vertical-align: text-top; margin-left: 0px"><img border="0" src="'+updateImageS3Path("/img/help.png")+'"style="height: 10px; vertical-align: middle" rel="popover"data-placement="bottom" data-title="Lead Score"data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."id="element" data-trigger="hover"></span>'}else{d="<small> ("+c+" Total) </small>"}$("#contacts-count",b).html(d)}},buildContactsView:function(b,d){var c=this;this.setUpContactView(b);setupContactFilterList(b,d);setUpContactSortFilters(b);setupLhsFilters(b,false);setupContactFields(b);this.fetchHeadings(function(e){c.getContacts(e,b,d)})}};(function(b,d,e){var c=null;b.view=function(){if(c){return c}c=contact_sort_configuration.SORT_FIELDS_VIEW().extend({resetLocalStorage:function(f){_agile_delete_prefs(this.options.sortPrefsName)},updateLocalStorage:function(f){_agile_set_prefs(this.options.sortPrefsName,f)},sort_collection:function(f){COMPANIES_HARD_RELOAD=true;companies_view_loader.getCompanies(App_Companies.companyViewModel,d("#companies-listener-container"))}});return c}}(window.COMPANY_SORT_FIELDS_VIEW=window.COMPANY_SORT_FIELDS_VIEW||{},$));var agile_contact_sort_configuration=[buildProperty(_agile_get_translated_val("contacts-view","created_date"),"created_time"),buildProperty(_agile_get_translated_val("contacts-view","score"),"lead_score"),buildProperty(_agile_get_translated_val("contacts-view","star-value"),"star_value","-star_value"),buildProperty(_agile_get_translated_val("report-add","first-name"),"first_name"),buildProperty(_agile_get_translated_val("report-add","last-name"),"last_name"),buildProperty(_agile_get_translated_val("contacts-view","contacted_date"),"last_contacted")];
function buildProperty(b,c){var d={id:c,field_label:b,field_value:c,search_key:c};return d}var sort_configuration={getContactSortableFields:function(){return agile_contact_sort_configuration},getCustomFieldSortableFields:function(){}};var agile_company_sort_configuration=[buildProperty(_agile_get_translated_val("contacts-view","created_date"),"created_time"),buildProperty(_agile_get_translated_val("contacts-view","star-value"),"star_value"),buildProperty(_agile_get_translated_val("contacts-view","name"),"name"),buildProperty(_agile_get_translated_val("contacts-view","score"),"lead_score")];var sort_company_configuration={getCompanySortableFields:function(){return agile_company_sort_configuration},getCustomFieldSortableFields:function(){}};var agile_deal_sort_configuration=[buildProperty(_agile_get_translated_val("contacts-view","created_date"),"created_time"),buildProperty(_agile_get_translated_val("deal-view","close-date"),"closed_time"),buildProperty(_agile_get_translated_val("deal-view","won-date"),"won_time"),buildProperty(_agile_get_translated_val("deal-view","value"),"expected_value")];var sort_deal_configuration={getDealSortableFields:function(){return agile_deal_sort_configuration},getCustomFieldSortableFields:function(){}};(function(b,c,d){b.SORT_FIELDS_VIEW=function(h,f){h=h||{};f=f||{};var g={sortPrefsName:"sort_by_name",orderBy:"created_time",sortBy:"-",is_custom_field:false,isAlreadyselected:false,built_key:this.sortBy+this.orderBy,selectedModel:d,original_with_order:this.final_sort_key,};g.built_key=g.sortBy+g.orderBy;console.log(g);g=_.defaults(h,g);var e=function(j){};return Base_Collection_View.extend({events:{"click a.order-by":"orderBy"},init:function(k){this.options.sort_options=this.options.sort_options||{};this.options.sort_options=_.defaults(g,this.options.sort_options);var j=_agile_get_prefs(this.options.sortPrefsName);if(this.options.sort_options.selectedModel){this.setPropertiesByModel(this.options.sort_options.selectedModel)}else{this.setProperties(j)}this.preSelectFields()},postProcess:function(j){this.preSelectFields();if(this.options.sort_options.selectedModel){this.printSortNameByData(this.options.sort_options.selectedModel)}},setDefaults:function(){this.options.sort_options=_.defaults(g,this.options.sort_options);this.setProperties(this.options.sort_options.built_key)},setSortOrder:function(j){this.options.sortBy=j;this.updateLocalStorage(this.options.sortBy+this.options.sort_options.built_key)},setPropertiesByModel:function(j){var k=_.defaults({},g);k.orderBy=j.get("search_key");k.sortBy=this.options.sortBy;k.is_custom_field=j.get("scope")?true:false;if(k.is_custom_field){k.built_key=k.orderBy+"_AGILE_CUSTOM_"+j.get("field_type")}else{k.built_key=k.orderBy}k.selectedModel=j;k.isAlreadyselected=true;this.options.sort_options=_.defaults(k,this.options.sort_options);if(this.options.sortBy){this.updateLocalStorage(this.options.sortBy+this.options.sort_options.built_key)}else{this.updateLocalStorage(this.options.sort_options.built_key)}this.setDefault(j)},setProperties:function(n){if(!n||!n.trim()){return}var p=_.defaults({},g);var o="";var m="";var j=d;if(n[0]=="-"){o="-";m=n.split(/-(.+)/)[1]}else{o="";m=n}p.is_custom_field=false;if(m.indexOf("_AGILE_CUSTOM_")){var k=m.split("_AGILE_CUSTOM_");m=k[0];p.is_custom_field=true}p.orderBy=m;var l=this.collection.where({search_key:m});j=l.length>0?l[0]:j;this.options.sort_options=p;this.options.sortBy=o;if(j){this.setPropertiesByModel(j);this.setSortOrder(o)}},preSetProperties:function(j){},preSelectFields:function(j){c(".sort-by-check",this.el).addClass("display-none");if(this.options.sortBy=="-"){c(".order-by[data='-']",this.el).find("i").removeClass("display-none")}else{c(".order-by[data='']",this.el).find("i").removeClass("display-none")}},resetLocalStorage:function(j){},updateLocalStorage:function(j){_agile_set_prefs(this.options.sortPrefsName,j)},printSortNameByData:function(j){c(".contacts-toolbar",this.el).find(".sort-field-txt").html(j.get("field_label"))},orderBy:function(j){sort_by=c(j.currentTarget).attr("data");if(this.options.sortBy==sort_by){return}this.setSortOrder(sort_by);this.setSortOrder(sort_by);this.preSelectFields();this.sort_collection()},sort_collection_config:function(j){this.resetLocalStorage();if(!j){return}this.setPropertiesByModel(j);this.sort_collection()},setDefault:function(j){var k=this.collection.where({selected:true});if(k.length!=0){c.each(k,function(m,l){l.set("selected",false)})}if(!j){return}j.set("selected",true);this.printSortNameByData(j)},sort_collection:function(){},isMatchingEntity:function(j){if(this.options.sort_options.isAlreadyselected){return false}if(j.get("search_key")==this.options.sort_options.orderBy){return true}return false},addAll:function(l){var j=false;if(!l||l.length==0){}var m=this.collection;var k=this;c.each(l,function(n,o){if(k.options.sort_options.is_custom_field&&k.options.sort_options.orderBy==o.search_key&&!j){j=true}m.add(o)});if(this.options.sort_options.is_custom_field&&!j){this.setDefaults();this.sort_collection()}},appendItem:function(k,j){if(this.isMatchingEntity(k)){this.setPropertiesByModel(k)}var l=this.createListView(k).render().el;if(k.get("scope")){this.custom_field_element=c("#sort-divider",this.el);c("#custom-fields",this.el).removeClass("display-none");c(this.custom_field_element).before(l)}else{c(!this.system_field_element);this.system_field_element=c("#custom-fields",this.el);c(this.system_field_element).before(l)}},createListView:function(j){if(this.options.modelData){j.set(this.options.modelData)}var k=this.getListView();var l=new k({model:j,template:(this.options.templateKey+"-model"),tagName:this.options.individual_tag_name,collectionView:this});return l},getListView:function(){if(this.options.list_view){return this.options.list_view}this.options.list_view=Base_List_View.extend({events:{"click a.sort-field":"sort_collection_config",},sort_collection_config:function(k,j){k.preventDefault();console.log(j);this.options.collectionView.sort_collection_config(this.model)}});return this.options.list_view}})}}(window.contact_sort_configuration=window.contact_sort_configuration||{},$));function getSortFieldsConfig(){return SORT_FIELDS_VIEW}(function(c,d,e){var b=null;c.view=function(){if(b){return b}b=contact_sort_configuration.SORT_FIELDS_VIEW().extend({resetLocalStorage:function(f){_agile_delete_prefs("sort_by_name")},updateLocalStorage:function(f){_agile_set_prefs("sort_by_name",f)},sort_collection:function(f){CONTACTS_HARD_RELOAD=true;if(!App_Contacts.tag_id){contacts_view_loader.getContacts(App_Contacts.contactViewModel,d("#contacts-listener-container"));return}contacts_view_loader.getContacts(App_Contacts.contactViewModel,d("#contacts-listener-container"))}});return b}}(window.CONTACT_SORT_FIELDS_VIEW=window.CONTACT_SORT_FIELDS_VIEW||{},$));var companies_view_loader={fetchHeadings:function(c){if(!App_Companies.companyViewModel){var b=new Backbone.Model();b.url="core/api/contact-view-prefs/company";b.fetch({success:function(d){App_Companies.companyViewModel=d.toJSON();if(c&&typeof c==="function"){return c(App_Companies.companyViewModel)}}})}else{if(c&&typeof c==="function"){return c(App_Companies.companyViewModel)}}},getCompanies:function(l,e,b){if(COMPANIES_HARD_RELOAD==true){App_Companies.companiesListView=undefined;COMPANIES_HARD_RELOAD=false}var h=this;var c=this.getCompaniesUrl(b);var f=getCompanyPadcontentKey(c);var k=this.getCompaniesTemplateKey();var j=this.getCompaniesIndividualTagName();var d={filterJson:this.getPostData()};var g=this.getCompaniesSortKey();App_Companies.contactDateFields=COMPANY_DATE_FIELDS;App_Companies.contactContactTypeFields=COMPANIES_CONTACT_TYPE_FIELDS;App_Companies.contactCompanyTypeFields=COMPANIES_COMPANY_TYPE_FIELDS;if(!App_Companies.companiesListView){App_Companies.companiesListView=new Contacts_Events_Collection_View({url:c,modelData:l,sort_collection:false,templateKey:k,individual_tag_name:j,post_data:d,cursor:true,page_size:25,global_sort_key:g,slateKey:f,request_method:"POST",postRenderCallback:function(m,n){h.setupCompanyFilterName(m,b);if(App_Companies.companiesListView.collection.models.length>0&&!App_Companies.companiesListView.collection.models[0].get("count")){getAndUpdateCollectionCount("companies",e)}else{companies_view_loader.setUpCompaniesCount(e)}}});App_Companies.companiesListView.collection.fetch();App_Companies.companiesListView.appendItem=function(m){contactTableView(m,App_Companies.contactDateFields,this,App_Companies.contactContactTypeFields,App_Companies.contactCompanyTypeFields)};$("#companies-list-view",e).html(App_Companies.companiesListView.render().el)}else{App_Companies.companiesListView.options.modelData=l;App_Companies.companiesListView.appendItem=function(m){contactTableView(m,App_Companies.contactDateFields,this,App_Companies.contactContactTypeFields,App_Companies.contactCompanyTypeFields)};$("#companies-list-view",e).html(App_Companies.companiesListView.render(true).el)}},getCompaniesUrl:function(c){if(c){return"core/api/tags/list/"+decodeURI(c)}var b=_agile_get_prefs("company_filter");if(b){return"core/api/filters/query/list/"+b}if(_agile_get_prefs("dynamic_company_filter")){return"core/api/filters/filter/dynamic-filter"}return"/core/api/contacts/companies/list"},setupCompanyFilterName:function(d,g){if(g){var c=Handlebars.compile('<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li  class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="m-l-xs pull-left">{{name}}</span><a class="close default_company_remove_tag m-l-xs pull-left">&times</a></li></ul>');$(".filter-criteria",d).html(c({name:decodeURI(g)})).attr("_filter",g);return}var b=_agile_get_prefs("company_filter");if(!b){$(".filter-criteria",d).html("");return}var f="";if(App_Companies.companyFiltersListView&&App_Companies.companyFiltersListView.collection){var e=App_Companies.companyFiltersListView.collection.get(b);if(e){f=e.get("name");var c=Handlebars.compile('<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="inline-block m-r-xs v-middle">{{name}}</span><a class="close default_company_filter">&times</a></li></ul>');
$(".filter-criteria",d).html(c({name:f})).attr("_filter",b)}}},getCompaniesSortKey:function(){var b=_agile_get_prefs("company_sort_field");if(b){return b}return"-created_time"},getCompaniesTemplateKey:function(){return"companies-list-view"},getCompaniesIndividualTagName:function(){return"tr"},getPostData:function(){var b=_agile_get_prefs("dynamic_company_filter");if(b){return b}return""},setUpCompaniesCount:function(b){if(App_Companies.companiesListView&&App_Companies.companiesListView.collection){var c=0;if(App_Companies.companiesListView.collection.models.length>0){c=App_Companies.companiesListView.collection.models[0].attributes.count||App_Companies.companiesListView.collection.models.length}var d;if(c>9999&&(_agile_get_prefs("contact_filter")||_agile_get_prefs("dynamic_contact_filter"))){d="<small> ("+10000+'+ Total) </small><span style="vertical-align: text-top; margin-left: 0px"><img border="0" src="'+updateImageS3Path("/img/help.png")+'"style="height: 10px; vertical-align: middle" rel="popover"data-placement="bottom" data-title="Lead Score"data-content="Looks like there are over 10,000 results. Sorry we can\'t give you a precise number in such cases."id="element" data-trigger="hover"></span>'}else{d="<small> ("+c+" Total) </small>"}$("#contacts-count",b).html(d)}},buildCompaniesView:function(b,d){var c=this;company_list_view.init(b);setUpCompanySortFilters(b);setupLhsFilters(b,true);setUpCompanyFields(b);this.fetchHeadings(function(e){c.getCompanies(e,b,d)})}};var scrambled_index=0;function scramble_filter_input_names(b){$(b).find("input[type=text],input[type=number]").each(function(){$(this).attr("name","temp-"+scrambled_index);$(this).attr("id","temp-"+scrambled_index);scrambled_index+=1})}function setupLhsFilters(c,d){var b="<option value='{{id}}'>{{name}}</option>";if(d){getTemplate("companies-lhs-filters",{},undefined,function(e){if(!e){return}$("#lhs_filters_conatiner",c).html($(e));setTimeout(function(){fillSelect("owner_select","/core/api/users/partial",undefined,function(){if(!COMPANY_CUSTOM_FIELDS){$.getJSON("core/api/custom-fields/searchable/scope?scope=COMPANY",function(f){COMPANY_CUSTOM_FIELDS=f;loadCustomFiledsFilters(f,c,d);return})}else{loadCustomFiledsFilters(COMPANY_CUSTOM_FIELDS,c,d)}},b,false,$("#lhs_filters_conatiner",c))},500)},$("#lhs_filters_conatiner",c))}else{getTemplate("contacts-lhs-filters",{},undefined,function(e){if(!e){return}$("#lhs_filters_conatiner",c).html($(e));setTimeout(function(){fillSelect("owner_select","/core/api/users/partial",undefined,function(){fillSelect("campaign_select_master","/core/api/workflows",undefined,function(){$("#campaign_select_master").next(".loading").remove();$("#campaign_select").html($("#campaign_select_master").html());if(!SEARCHABLE_CONTACT_CUSTOM_FIELDS){$.getJSON("core/api/custom-fields/searchable/scope?scope=CONTACT",function(f){SEARCHABLE_CONTACT_CUSTOM_FIELDS=f;loadCustomFiledsFilters(f,c,d);return})}else{loadCustomFiledsFilters(SEARCHABLE_CONTACT_CUSTOM_FIELDS,c,d)}$('[data-toggle="tooltip"]').tooltip()},b,false,$("#lhs_filters_conatiner",c))},b,false,$("#lhs_filters_conatiner",c))},500)},$("#lhs_filters_conatiner",c))}}function loadCustomFiledsFilters(b,c,d){getTemplate("contacts-lhs-filters-custom",b,undefined,function(e){if(!e){return}$("#custom-filter-fields",c).html($(e));addTagsTypeaheadLhs($("#tags-lhs-filter-table",c).find("div.lhs-contact-filter-row").find("#RHS"));$("input.date",c).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});scramble_filter_input_names(c);if(d&&_agile_get_prefs("dynamic_company_filter")){deserializeLhsFilters($("#lhs-contact-filter-form"),_agile_get_prefs("dynamic_company_filter"))}if(!d&&_agile_get_prefs("dynamic_contact_filter")){deserializeLhsFilters($("#lhs-contact-filter-form"),_agile_get_prefs("dynamic_contact_filter"))}$.each(b,function(){if(this.field_type=="CONTACT"){var g=this.id;var f=function(j,h){if($("ul[id='in_"+g+"']",c).find("li[data="+j+"]").length==0){$("ul[id='in_"+g+"']",c).append('<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="'+j+'"><a class="text-white m-r-xs" href="#contact/'+j+'">'+h+'</a><a class="close" id="remove_contact_in_lhs">&times</a></li>');$("#in_"+g).parent().find("input").trigger("custom_blur")}};agile_type_ahead($("#in_"+this.id).parent().find("input").attr("id"),c,contacts_typeahead,f,"type=PERSON");var f=function(j,h){setTimeout(function(){$("#is_"+g).parent().find("input").attr("data",j);$("#is_"+g).parent().find("input").val(h);$("#is_"+g).parent().find("input").trigger("custom_blur")},10)};agile_type_ahead($("#is_"+this.id).parent().find("input").attr("id"),c,contacts_typeahead,f,"type=PERSON")}else{if(this.field_type=="COMPANY"){var g=this.id;var f=function(j,h){if($("ul[id='in_"+g+"']",c).find("li[data="+j+"]").length==0){$("ul[id='in_"+g+"']",c).append('<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="'+j+'"><a class="text-white m-r-xs" href="#company/'+j+'">'+h+'</a><a class="close" id="remove_contact_in_lhs">&times</a></li>');$("#in_"+g).parent().find("input").trigger("custom_blur")}};agile_type_ahead($("#in_"+this.id).parent().find("input").attr("id"),c,contacts_typeahead,f,"type=COMPANY");var f=function(j,h){setTimeout(function(){$("#is_"+g).parent().find("input").attr("data",j);$("#is_"+g).parent().find("input").val(h);$("#is_"+g).parent().find("input").trigger("custom_blur")},10)};agile_type_ahead($("#is_"+this.id).parent().find("input").attr("id"),c,contacts_typeahead,f,"type=COMPANY")}}})},$("#custom-filter-fields",c))}function submitLhsFilter(){var c=serializeLhsFilters($("#lhs-contact-filter-form"));var b=c.contact_type;if(b=="COMPANY"){_agile_delete_prefs("company_filter");_agile_delete_prefs("dynamic_company_filter");if(c!=null&&(c.rules.length>0||c.or_rules.length>0)){_agile_set_prefs("dynamic_company_filter",JSON.stringify(c))}COMPANIES_HARD_RELOAD=true;companies_view_loader.getCompanies(App_Companies.companyViewModel,$("#companies-listener-container"))}else{if(b=="VISITOR"){_agile_delete_prefs("visitor_filter");_agile_delete_prefs("dynamic_visitors_filter");if(c!=null&&c.rules.length>0){_agile_set_prefs("dynamic_visitors_filter",JSON.stringify(c))}VISITORS_HARD_RELOAD=true;App_VisitorsSegmentation.visitorssegmentation(getTimeWebstats(),true)}else{_agile_delete_prefs("contact_filter");_agile_delete_prefs("contact_filter_type");_agile_delete_prefs("dynamic_contact_filter");if(c!=null&&(c.rules.length>0||c.or_rules.length>0)){_agile_set_prefs("dynamic_contact_filter",JSON.stringify(c))}CONTACTS_HARD_RELOAD=true;contacts_view_loader.getContacts(App_Contacts.contactViewModel,$("#contacts-listener-container"))}}}function contactFiltersListeners(b){$('[data-toggle="tooltip"]').tooltip();if(!b){b="contacts-listener-container"}$("#"+b).off("click","a.filter-multiple-add-lhs");$("#"+b).on("click","a.filter-multiple-add-lhs",function(c){c.preventDefault();var f=$(this).data("name");var d=$("#"+f+"-lhs-filter-table").find("div.hide.master-"+f+"-add-div").clone();d.removeClass("hide").addClass("lhs-contact-filter-row");if(f=="tags"){addTagsTypeaheadLhs(d)}scramble_filter_input_names(d);$(d).appendTo("#"+f+"-lhs-filter-table");$("#"+f+"-lhs-filter-table").find("div.lhs-contact-filter-row:last").find("#RHS:visible").find(":not(input.date)").focus()});$("#"+b).off("click","i.filter-tags-multiple-remove-lhs");$("#"+b).on("click","i.filter-tags-multiple-remove-lhs",function(d){var c=$(this).parents(".lhs-contact-filter-row");$(c).find("#RHS").children().val("").trigger("blur").trigger("custom_blur").trigger("change").trigger("custom_change");$(this).closest("div.lhs-contact-filter-row").remove()});$("#"+b).off("click","a.clear-filter-condition-lhs");$("#"+b).on("click","a.clear-filter-condition-lhs",function(d){$(this).addClass("hide");var c=$(this).parents(".lhs-contact-filter-row");$(c).find("#RHS:not(.no-filter-action)").children().val("").attr("prev-val","");$(c).find("#RHS").children().val("").attr("prev-val","").attr("data","");$(c).find("#RHS_NEW").filter(visibleFilter).children().val("").attr("prev-val","");$(c).find('select[name="CONDITION"]').val($(c).find('select[name="CONDITION"] option:first').val()).attr("prev-val","");$(c).find('select[name="CONDITION"]').trigger("change");$(c).find("a#lhs-filters-header").find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o");$(c).find("a#lhs-filters-header").next().addClass("hide");if($(c).find("#RHS").find("ul.custom_contacts").find("li")){$(c).find("#RHS").find("ul.custom_contacts").find("li").remove()}if($(c).find("#RHS").find("ul.custom_companies").find("li")){$(c).find("#RHS").find("ul.custom_companies").find("li").remove()}submitLhsFilter()});$("#"+b).off("click","#clear-lhs-contact-filters");$("#"+b).on("click","#clear-lhs-contact-filters",function(c){c.preventDefault();console.log("clicked");if(_agile_get_prefs("dynamic_contact_filter")){_agile_delete_prefs("dynamic_contact_filter");CONTACTS_HARD_RELOAD=true;clearLhsFilters();contacts_view_loader.getContacts(App_Contacts.contactViewModel,$("#contacts-listener-container"))}});$("#"+b).off("click","#clear-lhs-company-filters");$("#"+b).on("click","#clear-lhs-company-filters",function(c){c.preventDefault();if(_agile_get_prefs("dynamic_company_filter")){_agile_delete_prefs("dynamic_company_filter");COMPANIES_HARD_RELOAD=true;clearLhsFilters();companies_view_loader.getCompanies(App_Companies.companyViewModel,$("#companies-listener-container"))}});$("#"+b).off("click","#clear-lhs-segmentation-filters");$("#"+b).on("click","#clear-lhs-segmentation-filters",function(c){c.preventDefault();_agile_delete_prefs("dynamic_visitors_filter");_agile_delete_prefs("duration");_agile_delete_prefs("visitor_filter");_agile_delete_prefs("visitor_repeat_filter");VISITORS_HARD_RELOAD=true;App_VisitorsSegmentation.visitorssegmentation()});$("#"+b).off("click","#lhs-filters-header");$("#"+b).on("click","#lhs-filters-header",function(c){c.preventDefault();$(this).find("i").toggleClass("fa-plus-square-o").toggleClass("fa-minus-square-o");
$(this).next().toggleClass("hide");$(this).next().find(".lhs-contact-filter-row:visible").find("#RHS").filter(visibleFilter).find(":not(input.date)").focus()});$("#"+b).off("change",'#lhs-contact-filter-form select[name="CONDITION"]');$("#"+b).on("change",'#lhs-contact-filter-form select[name="CONDITION"]',function(g){var d=$(this).val();if($(this).parent().find("div.condition_container."+d).find("#RHS").children().first().hasClass("custom_contacts")||$(this).parent().find("div.condition_container."+d).find("#RHS").children().first().hasClass("custom_companies")){$(this).parent().find("div.IN").removeClass("hide");$(this).parent().find("div.EQUALS").addClass("hide");$(this).parent().find("div.EQUALS").find("input").val("").attr("data","");return}if($(this).parent().find("div.condition_container."+d).find("#RHS").children().first().hasClass("custom_contact")||$(this).parent().find("div.condition_container."+d).find("#RHS").children().first().hasClass("custom_company")){$(this).parent().find("div.IN").addClass("hide");$(this).parent().find("div.EQUALS").removeClass("hide");if(!$(this).parent().find("div.EQUALS").find("input").val()){return}}$(this).parent().find("div.condition_container").addClass("hide");$(this).parent().find("div.condition_container."+d).removeClass("hide");$(this).parent().find("div.condition_container."+d).find("#RHS :not(input.date)").focus();var h=$(this).parent().find("div.condition_container."+d).find("#RHS").children().first().val();if($(this).parent().find("div.condition_container."+d).find("#RHS").children().first().hasClass("custom_contact")||$(this).parent().find("div.condition_container."+d).find("#RHS").children().first().hasClass("custom_company")){h=$(this).parent().find("div.condition_container."+d).find("#RHS").find("input").attr("data")}var f=false;var c="";if($(this).parent().find("div.condition_container."+d).find("#RHS_NEW")!=undefined){f=true;c=$(this).parent().find("div.condition_container."+d).find("#RHS_NEW").children().first().val()}if(h!=""&&(h!=undefined||d=="DEFINED"||d=="NOT_DEFINED")&&(!f||c!="")){submitLhsFilter()}});$("#"+b).off("custom_blur keyup","#lhs-contact-filter-form #RHS input.filters-tags-typeahead:not(.date)");$("#"+b).on("custom_blur keyup","#lhs-contact-filter-form #RHS input.filters-tags-typeahead:not(.date)",function(f){console.log("I am in blur "+$(this).val());if(f.type=="custom_blur"||f.type=="focusout"||f.keyCode=="13"){var g=$(this).attr("prev-val");var d=$(this).val().trim();if(g==d){return}else{$(this).attr("prev-val",d)}if($(this).parent().next().attr("id")=="RHS_NEW"){if($(this).parent().next().find("input").val()!=""&&d!=""){submitLhsFilter();$(this).blur()}}else{if(d==""){var c=$(this).parents(".lhs-contact-filter-row");$(c).find("a.clear-filter-condition-lhs").addClass("hide")}submitLhsFilter();$(this).blur()}}});$("#"+b).off("custom_blur","#lhs-contact-filter-form #RHS input.typeahead_contacts:not(.date)");$("#"+b).on("custom_blur","#lhs-contact-filter-form #RHS input.typeahead_contacts:not(.date)",function(d){console.log("I am in blur "+$(this).val());var f=$(this).attr("prev-val");var c=$(this).val().trim();$(this).attr("prev-val",c);submitLhsFilter();$(this).blur()});$("#"+b).off("click","#remove_contact_in_lhs");$("#"+b).on("click","#remove_contact_in_lhs",function(c){$(this).parent().remove();submitLhsFilter()});$("#"+b).off("blur keyup","#lhs-contact-filter-form #RHS input:not(.date,.filters-tags-typeahead,.typeahead_contacts)");$("#"+b).on("blur keyup","#lhs-contact-filter-form #RHS input:not(.date,.filters-tags-typeahead,.typeahead_contacts)",function(f){if(!$("#lhs_filters_segmentation #error-message").hasClass("hide")){$("#lhs_filters_segmentation #error-message").addClass("hide")}console.log("I am in blur "+$(this).val());if(f.type=="focusout"||f.keyCode=="13"){var g=$(this).attr("prev-val");var d=$(this).val().trim();if(g==d){return}else{$(this).attr("prev-val",d)}if($(this).parent().next().attr("id")=="RHS_NEW"){if($(this).parent().next().find("input").val()!=""&&d!=""){submitLhsFilter();$(this).blur()}}else{if(d==""){var c=$(this).parents(".lhs-contact-filter-row");$(c).find("a.clear-filter-condition-lhs").addClass("hide")}submitLhsFilter();$(this).blur()}}});$("#"+b).off("change keyup","#lhs-contact-filter-form #RHS input.date");$("#"+b).on("change keyup","#lhs-contact-filter-form #RHS input.date",function(f){if(f.type=="change"||f.keyCode=="13"){var g=$(this).attr("prev-val");var d=$(this).val().trim();if(g==d){return}else{$(this).attr("prev-val",d)}if($(this).parent().next().attr("id")=="RHS_NEW"){if($(this).parent().next().find("input").val()!=""&&d!=""){submitLhsFilter();$(this).blur()}}else{if(d==""){var c=$(this).parents(".lhs-contact-filter-row");$(c).find("a.clear-filter-condition-lhs").addClass("hide")}submitLhsFilter();$(this).blur()}}});$("#"+b).off("change","#lhs-contact-filter-form #RHS select");$("#"+b).on("change","#lhs-contact-filter-form #RHS select",function(f){if($(this).parent().next().attr("id")=="RHS_NEW"){if($(this).val()!=""&&$(this).parent().next().children().val()!=""){submitLhsFilter()}if($(this).val()==""&&$(this).parent().next().children().val()==""){var c=$(this).parents(".lhs-contact-filter-row");$(c).find("a.clear-filter-condition-lhs").addClass("hide");submitLhsFilter()}}else{var g=$(this).attr("prev-val");var d=$(this).val().trim();if(g==d){return}else{$(this).attr("prev-val",d)}if($(this).val()==""){var c=$(this).parents(".lhs-contact-filter-row");$(c).find("a.clear-filter-condition-lhs").addClass("hide")}submitLhsFilter()}$(this).blur()});$("#"+b).off("change","#lhs-contact-filter-form #RHS_NEW select");$("#"+b).on("change","#lhs-contact-filter-form #RHS_NEW select",function(c){if($(this).parent().prev().attr("id")=="RHS"){if($(this).val()!=""&&$(this).parent().prev().children().val()!=""){submitLhsFilter()}if($(this).val()==""&&$(this).parent().prev().children().val()==""){submitLhsFilter()}}else{submitLhsFilter()}$(this).blur()});$("#"+b).off("blur keyup","#lhs-contact-filter-form #RHS_NEW input:not(.date)");$("#"+b).on("blur keyup","#lhs-contact-filter-form #RHS_NEW input:not(.date)",function(d){if(d.type=="focusout"||d.keyCode=="13"){var f=$(this).attr("prev-val");var c=$(this).val().trim();if(f==c){return}else{$(this).attr("prev-val",c)}if($(this).parent().prev().attr("id")=="RHS"){if($(this).parent().prev().find("input").val()!=""){submitLhsFilter();$(this).blur()}}else{if(c!=""){submitLhsFilter();$(this).blur()}}}});$("#"+b).off("change keyup","#lhs-contact-filter-form #RHS_NEW input.date");$("#"+b).on("change keyup","#lhs-contact-filter-form #RHS_NEW input.date",function(d){if(d.type=="change"||d.keyCode=="13"){var f=$(this).attr("prev-val");var c=$(this).val().trim();if(f==c){return}else{$(this).attr("prev-val",c)}if($(this).parent().prev().attr("id")=="RHS"){if($(this).parent().prev().find("input").val()!=""){submitLhsFilter();$(this).blur()}}else{if(c!=""){submitLhsFilter();$(this).blur()}}}});$("#"+b).off("click","#contacts-left-filters-toggle");$("#"+b).on("click","#contacts-left-filters-toggle",function(c){c.preventDefault();if($("#contacts-lhs-filters-toggle").is(":visible")){$("#contacts-lhs-filters-toggle").hide("slow");_agile_set_prefs(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS,"hide")}else{$("#contacts-lhs-filters-toggle").show("slow");_agile_set_prefs(CONTACTS_DYNAMIC_FILTER_COOKIE_STATUS,"show")}});$("body").off("click","#companies-left-filters-toggle");$("body").on("click","#companies-left-filters-toggle",function(c){c.preventDefault();if($("#companies-lhs-filters-toggle").is(":visible")){$("#companies-lhs-filters-toggle").hide("slow");_agile_set_prefs("companiesFilterStatus","display:none");c.preventDefault()}else{$("#companies-lhs-filters-toggle").show("slow");_agile_set_prefs("companiesFilterStatus","");c.preventDefault()}});$("body").off("click","#segmentation-left-filters-toggle");$("body").on("click","#segmentation-left-filters-toggle",function(c){c.preventDefault();if($("#segmentation-lhs-filters-toggle").is(":visible")){$("#segmentation-lhs-filters-toggle").hide();_agile_set_prefs("segmentationFilterStatus","display:none");c.preventDefault()}else{$("#segmentation-lhs-filters-toggle").show();_agile_set_prefs("segmentationFilterStatus","");c.preventDefault()}});$("#"+b).on("click","#save-segment-filter",function(d){if(!_agile_get_prefs("dynamic_visitors_filter")&&!_agile_get_prefs("visitor_filter")){$("#error-message").removeClass("hide");return}d.preventDefault();var c=new Base_Model_View({template:"segment-save-filter-modal",url:"/core/api/web-stats/filters",postRenderCallback:function(e,f){addModalEvent("segmentsModal",f);if(!f[0]){$("#saveSegmentFilterForm .choose-segment-filter").prop("disabled",true);$("#saveSegmentFilterForm .replace-segment label").css("cursor","default");$("#saveSegmentFilterForm .replace-segment label").css("color","grey")}},saveCallback:function(e){$("#segmentsModal").modal("hide");setupSegmentFilterList("",e.id);$("body").removeClass("modal-open").animate({scrollTop:0},"slow")},prePersist:function(f){var g={};if(_agile_get_prefs("dynamic_visitors_filter")){g.segmentConditions=_agile_get_prefs("dynamic_visitors_filter").toString()}else{if(_agile_get_prefs("visitor_filter")){g.filter_id=_agile_get_prefs("visitor_filter");_agile_set_prefs("visitor_repeat_filter",true)}}var e=f.toJSON();if(e["save-type"]=="replace"){g.id=$('[name="filter-collection"]').val();if(f.attributes.name==""){f.attributes.name=$('[name="filter-collection"]').find("option:selected").text()}}f.set(g,{silent:true})}});$("#segmentsModal").html(c.render().el).modal("show")});$("#content").on("change","#tags-filter",function(){if(this.value=="DEFINED"||this.value=="NOT_DEFINED"){$(this).parent().removeAttr("style")}else{$(this).parent().css("min-height","90px")}})}function addTagsTypeaheadLhs(c){var b=[];if(!TAGS){var d=Backbone.Collection.extend({url:"/core/api/tags",sortKey:"tag"});tagsCollection=new d();tagsCollection.fetch({success:function(e){TAGS=tagsCollection.models;
addTagsTypeaheadLhsFilters(tagsCollection.toJSON(),c)}});return}addTagsTypeaheadLhsFilters(tagsCollection.toJSON(),c)}function addTagsTypeaheadLhsFilters(c,d){var b=[];$.each(c,function(e,f){if($.inArray(f.tag.toString(),b)==-1){b.push(f.tag.toString())}});$("input",d).typeahead({source:b,updater:function(e){console.log("I am in updater "+e);this.$element.val(e);this.$element.trigger("custom_blur");this.hide();return e}}).attr("placeholder","Enter Tag")}function bindChangeEvent(d){console.log("I am in change "+$(d).val());var e=$(d).attr("prev-val");var c=$(d).val().trim();if(e==c){return}else{$(d).attr("prev-val",c)}if($(d).parent().next().attr("id")=="RHS_NEW"){if($(d).parent().next().find("input").val()!=""&&c!=""){submitLhsFilter()}}else{if(c==""){var b=$(d).parents(".lhs-contact-filter-row");$(b).find("a.clear-filter-condition-lhs").addClass("hide")}submitLhsFilter()}}function setupAnalyticsLhsFilters(b){getTemplate("segmentation-lhs-filters",{},undefined,function(c){if(!c){return}$("#lhs_filters_segmentation",b).html($(c));$("input.date",b).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});setTimeout(function(){if(_agile_get_prefs("dynamic_visitors_filter")!=null){deserializeLhsFilters($("#lhs-contact-filter-form"),_agile_get_prefs("dynamic_visitors_filter"))}if(_agile_get_prefs("duration")!=null){deserializeRhsFilters(_agile_get_prefs("duration"))}},500);initWebstatsDateRange()},$("#lhs_filters_segmentation",b))}function clearLhsFilters(){$("#lhs-contact-filter-form")[0].reset();$(".filters-tags-typeahead",$("#lhs-contact-filter-form")).removeAttr("prev-val");$(".lhs-row-filter > a",$("#lhs-contact-filter-form")).each(function(){$(this).removeClass("bold-text");$(this).find("i").addClass("fa-plus-square-o").removeClass("fa-minus-square-o");$(this).siblings().addClass("hide")})}$(function(){$(".agile-menu > li").click(function(b){console.log("Collapsing before ul");$nav_collapse=$(this).closest(".nav-collapse");console.log($nav_collapse.attr("class"));if($nav_collapse.hasClass("collapse")){console.log("Collapsing");$nav_collapse.collapse("hide")}});$(window).load(function(){$("#top").click(function(){$("body, html").animate({scrollTop:0},300);return false})})});var DATA_SYNC_URL="core/api/contactprefs";var DataSync_Event_Modal_View=Base_Model_View.extend({events:{"click #import_shopify":"importShopify","change #sync-type":"googleContactsSyncTypeChange","click .save-contact-prefs":"syncGoogleContacts","click #stripe-import-prefs-delete":"importStripePrefsDelete","click #stripe_sync_prefs":"syncStripePrefs","click #shopify-setting":"syncShopify","click #quickbook_sync_prefs":"syncQuickbooks","click #freshbooks_sync_prefs":"syncFreshbooks","click #data-sync-type":"enableDataSyncWidget",},importShopify:function(g){g.preventDefault();var f=$(g.currentTarget);var h=$("#shop").val();if(h==""){showAlertModal("empty_shop",undefined,function(){$("#shop").focus()});return false}var d=agileWindowOrigin();g.preventDefault();var b=window.location.href;var c="/scribe?service_type=shopify&url=sync&window_opened=true&shop="+h+"&domain="+d+"";window.open(c+"&return_url="+encodeURIComponent(b),"dataSync","height=1000,width=500")},enableDataSyncWidget:function(f){f.preventDefault();var d=$(f.currentTarget);var c=$(d).attr("sync_type");if(c=="STRIPE"){var b=agileWindowOrigin()+"/#sync/stripe-import";window.open("/scribe?service=stripe_import&window_opened=true&return_url="+encodeURIComponent(b),"dataSync","height=1000,width=500");return false}else{if(c=="QUICKBOOK"){window.open("/OAuthServlet?service=quickbook-import&window_opened=true&return_url="+encodeURIComponent(window.location.href)+"quickbooks","dataSync","height=1000,width=500");return}else{if(c=="OFFICE365"){}}}},syncShopify:function(d){d.preventDefault();var c=$(d.currentTarget);$(c).attr("disabled","disabled");var b=serializeForm("shopify-contact-import-form");b.inProgress=true;getSyncModelFromName("SHOPIFY",function(g){if(g!=undefined){if(g.inProgress==true){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-in-progress"),App_Datasync.dataSync.el);setTimeout(function(){$(c).removeAttr("disabled")},3000);return false}}var f=new Backbone.Model(g);f.set(b,{silent:true});var e=DATA_SYNC_URL+"/SHOPIFY";f.url=e+"?sync=true";f.save({},{success:function(h){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-init"),App_Datasync.dataSync.el);setTimeout(function(){$(c).removeAttr("disabled")},3000);showNotyPopUp("information",_agile_get_translated_val("misc-keys","sync-contacts-init"),"top",1000)}})},true)},googleContactsSyncTypeChange:function(d){d.preventDefault();var c=$(d.currentTarget);var b=$(c).val();if(b=="AGILE_TO_CLIENT"||b=="TWO_WAY"){$("#sync_to_group_controlgroup").show();$("#my_contacts_sync_group").show();if(b=="AGILE_TO_CLIENT"){$("#sync_from_group_controlgroup").hide();return}$("#sync_from_group_controlgroup").show()}else{$("#sync_from_group_controlgroup").show();$("#sync_to_group_controlgroup").hide();$("#my_contacts_sync_group").hide()}},syncGoogleContacts:function(f){var d=$(f.currentTarget);var c=$(d).attr("disabled");if(!isValidForm("#google-contacts-import-form")){return}$(d).attr("disabled","disabled");var b=serializeForm("google-contacts-import-form");b.inProgress=true;getSyncModelFromName("GOOGLE",function(h){if(h.inProgress==true){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-in-progress"),App_Datasync.dataSync.el);setTimeout(function(){$(d).removeAttr("disabled")},3000);return false}var g=new Backbone.Model(h);g.set(b,{silent:true});var e=DATA_SYNC_URL+"/GOOGLE";g.url=e+"?sync=true";g.save({},{success:function(j){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-init"),App_Datasync.dataSync.el);setTimeout(function(){$(d).removeAttr("disabled")},3000);showNotyPopUp("information",_agile_get_translated_val("misc-keys","sync-contacts-init"),"top",1000)}})},true)},importStripePrefsDelete:function(d){d.preventDefault();var c=$(d.currentTarget);var b=$(c).attr("disabled");if(b){return}$(c).attr("disabled","disabled");getTemplate("admin-settings-import-stripe-contact-sync",{},undefined,function(e){if(!e){return}$("#prefs-tabs-content").find("#stripe").html($(e))})},syncStripePrefs:function(d){d.preventDefault();var c=$(d.currentTarget);$(c).attr("disabled","disabled");var b=serializeForm("stripe-prefs-form");b.inProgress=true;getSyncModelFromName("STRIPE",function(g){if(g.inProgress==true){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-in-progress"),App_Datasync.dataSync.el);setTimeout(function(){$(c).removeAttr("disabled")},3000);return false}var f=new Backbone.Model(g);f.set(b,{silent:true});var e=DATA_SYNC_URL+"/STRIPE";f.url=e+"?sync=true";f.save({},{success:function(h){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-init"),App_Datasync.dataSync.el);setTimeout(function(){$(c).removeAttr("disabled")},3000);showNotyPopUp("information",_agile_get_translated_val("misc-keys","sync-contacts-init"),"top",1000)}})},true)},syncQuickbooks:function(c){c.preventDefault();var b=$(c.currentTarget);$(b).attr("disabled","disabled");var d=serializeForm("quickbook-form");d.inProgress=true;getSyncModelFromName("QUICKBOOK",function(g){if(g.inProgress==true){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-in-progress"),App_Datasync.dataSync.el);setTimeout(function(){$(b).removeAttr("disabled")},3000);return false}var f=new Backbone.Model(g);f.set(d,{silent:true});var e=DATA_SYNC_URL+"/QUICKBOOK";f.url=e+"?sync=true";f.save({},{success:function(h){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-init"),App_Datasync.dataSync.el);setTimeout(function(){$(b).removeAttr("disabled")},3000);showNotyPopUp("information",_agile_get_translated_val("misc-keys","sync-contacts-init"),"top",1000)}})},true)},syncFreshbooks:function(d){d.preventDefault();var c=$(d.currentTarget);$(c).attr("disabled","disabled");var b=serializeForm("freshbooks-form");b.inProgress=true;getSyncModelFromName("FRESHBOOKS",function(g){if(g.inProgress==true){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-in-progress"),App_Datasync.dataSync.el);setTimeout(function(){$(c).removeAttr("disabled")},3000);return false}var f=new Backbone.Model(g);f.set(b,{silent:true});var e=DATA_SYNC_URL+"/FRESHBOOKS";f.url=e+"?sync=true";f.save({},{success:function(h){show_success_message_after_save_button(_agile_get_translated_val("misc-keys","sync-init"),App_Datasync.dataSync.el);setTimeout(function(){$(c).removeAttr("disabled")},3000);showNotyPopUp("information",_agile_get_translated_val("misc-keys","sync-contacts-init"),"top",1000)}})},true)}});var GoogleCalendar_Event_Modal_View=Base_Model_View.extend({events:{"click #sync-google-calendar":"syncGoogleCalendarEnable","click #sync-google-calendar-delete":"deleteGoogleCalendarPrefs",},syncGoogleCalendarEnable:function(c){c.preventDefault();var b=agileWindowOrigin()+"/#sync/calendar-setup";window.open("/scribe?service=google_calendar&window_opened=true&return_url="+encodeURIComponent(b),"dataSync","height=1000,width=500")},deleteGoogleCalendarPrefs:function(c){c.preventDefault();var b=$(this);showAlertModal("delete_calendar_prefs","confirm",function(){var e=$(c.currentTarget);var d=b.attr("disabled");if(d){return}$(e).attr("disabled","disabled");$(e).after(getRandomLoadingImg());App_Datasync.calendar_sync_google.model.url="/core/api/calendar-prefs/type/GOOGLE";App_Datasync.calendar_sync_google.model.destroy({success:function(){App_Datasync.calendar_sync_google.model.clear();App_Datasync.calendar_sync_google.render(true);erase_google_calendar_prefs_cookie();_resetGAPI()}})})}});function initZeroClipboard(g,d){try{ZeroClipboard.setDefaults({moviePath:"/lib/zeroclipboard/ZeroClipboard.swf",allowScriptAccess:"always"})}catch(f){console.log(f);
return false}var b=$("#"+d).text();var c=new ZeroClipboard();c.glue(document.getElementById(g));c.setText(b);c.options.id=g;$("#"+g).attr("data-clipboard-text",b);c.on("complete",function(e,h){var m=$(this).attr("id");var k=function(){$("#"+m).tooltip("hide").removeAttr("data-original-title")};var j=setTimeout(k,500);window.clearTimeout(j);if(!m){return false}var l=getTitleForClip(m);$("#"+m).attr({"data-placement":"bottom","data-original-title":l});$("#"+m).tooltip("show").off("mouseenter mouseleave");j=setTimeout(k,2000)})}function initZeroClipboard2(c,d){var b=new ZeroClipboard(c);b.on("ready",function(f){c.data("placement","top").attr("title",_agile_get_translated_val("misc-keys","cpy-to-clip")).tooltip()});b.on("copy",function(f){b.setText(d.attr("data-clipboard-text"))});b.on("aftercopy",function(g){var f=c.attr("data-copied-text")?c.attr("data-copied-text"):_agile_get_translated_val("misc-keys","clip-copied");c.attr("title",f).tooltip("fixTitle").tooltip("show").attr("title",_agile_get_translated_val("misc-keys","cpy-to-clip")).tooltip("fixTitle")});b.on("error",function(f){c.attr("title",f.message).tooltip("fixTitle").tooltip("show")})}function getTitleForClip(c){var b=_agile_get_translated_val("misc-keys","clip-code-copied");switch(c){case"copy_email_to_clip_button":b=_agile_get_translated_val("misc-keys","clip-email-copied");break;case"api_key_code_icon":b=_agile_get_translated_val("misc-keys","clip-email-copied");break;case"popup_clip_button":b=_agile_get_translated_val("misc-keys","clip-code-copied");break;case"url_clip_button":b=_agile_get_translated_val("misc-keys","clip-url-copied");break}return b}function loadZeroclipboard2(b){head.js("/lib/zeroclipboard2/ZeroClipboard.min.js",function(){if(b){b()}})}function gmap_initialize(d){console.log("Map API has been loaded.");var c=document.createElement("script");c.type="text/javascript";c.src="https://jawj.github.io/OverlappingMarkerSpiderfier/bin/oms.min.js";document.body.appendChild(c);google.maps.visualRefresh=true;var b={center:new google.maps.LatLng(39,22),zoom:7,mapTypeId:google.maps.MapTypeId.ROADMAP};window.map=new google.maps.Map(document.getElementById("google_map"),b);window.map.setZoom(2);window.gmap_marker_list=[];gmap_date_range(d,function(){var h=new Date();var f=new Date(h);f.setDate(h.getDate()-1);var g=f;var e=f;if(window.toDate!=undefined&&window.toDate!=""){e=window.toDate}else{window.toDate=e}if(window.fromDate!=undefined&&window.fromDate!=""){g=window.fromDate}else{window.fromDate=g}$("#gmap_date_range span").html(e.toString("MMMM d, yyyy")+" - "+g.toString("MMMM d, yyyy"));gmap_search_by_date($("#gmap_date_range span").text())})}function gmap_load_script(c){var b=document.createElement("script");b.type="text/javascript";b.src="https://maps.googleapis.com/maps/api/js?v=3&sensor=false&callback=gmap_initialize";document.body.appendChild(b)}function gmap_create_table_view(c){var b=new Base_Collection_View({url:c,templateKey:"gmap-table",individual_tag_name:"tr",cursor:true,page_size:25,sort_collection:false,postRenderCallback:function(d){console.log("post callback")}});b.collection.fetch();$("#gmap-table-view").html(b.el)}var isDateChanged=false;function gmap_date_range(c,d){var b=new Date();b.setDate(b.getDate()-1);$("#gmap_date_range",c).daterangepicker({ranges:{Today:["today","today"],Yesterday:["yesterday","yesterday"],"Last 7 Days":[Date.today().add({days:-6}),"today"],"Last 30 Days":[Date.today().add({days:-29}),"today"],"This Month":[Date.today().moveToFirstDayOfMonth(),Date.today().moveToLastDayOfMonth()],"Last Month":[Date.today().moveToFirstDayOfMonth().add({months:-1}),Date.today().moveToFirstDayOfMonth().add({days:-1})],"This Quarter":[Date.today().getMonth()<3?new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth():new Date(Date.today().setMonth(9)).moveToFirstDayOfMonth(),Date.today().getMonth()<3?new Date(Date.today().setMonth(2).moveToLastDayOfMonth()):(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(5)).moveToLastDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(8)).moveToLastDayOfMonth():new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()],"Last Quarter":[Date.today().getMonth()<3?new Date(Date.today().add({years:-1}).setMonth(9)).moveToFirstDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(3)).moveToFirstDayOfMonth():new Date(Date.today().setMonth(6)).moveToFirstDayOfMonth(),Date.today().getMonth()<3?new Date(Date.today().add({years:-1}).setMonth(11)).moveToLastDayOfMonth():(Date.today().getMonth()>=3&&Date.today().getMonth()<6)?new Date(Date.today().setMonth(2)).moveToLastDayOfMonth():(Date.today().getMonth()>=6&&Date.today().getMonth()<9)?new Date(Date.today().setMonth(5)).moveToLastDayOfMonth():new Date(Date.today().setMonth(8)).moveToLastDayOfMonth()],"This Year":[new Date(Date.today().setMonth(0)).moveToFirstDayOfMonth(),new Date(Date.today().setMonth(11)).moveToLastDayOfMonth()],"Last Year":[new Date(Date.today().setMonth(0)).add({years:-1}).moveToFirstDayOfMonth(),new Date(Date.today().setMonth(11)).add({years:-1}).moveToLastDayOfMonth()]}},function(f,e){window.toDate=f;window.fromDate=e;$("#gmap_date_range span").html(f.toString("MMMM d, yyyy")+" - "+e.toString("MMMM d, yyyy"));gmap_search_by_date($("#gmap_date_range span").text())});if(d&&typeof(d)=="function"){d()}$(".daterangepicker > .ranges > ul").on("click","li",function(f){$(".daterangepicker > .ranges > ul > li").each(function(){$(this).removeClass("active")});$(this).addClass("active")})}function gmap_search_by_date(b){isDateChanged=true;console.clear();var e=CURRENT_DOMAIN_USER.domain;var l="&";var f=b.split("-");var g=Date.parse($.trim(f[0])).valueOf();g=convertToUTCTime(g,"start");var c=Date.parse($.trim(f[1])).valueOf();c=convertToUTCTime(c,"end");l+=("start_date="+g+"&end_date="+c);var j=new Date();l+=("&time_zone="+j.getTimezoneOffset());var k="core/api/gmap/daterangebysession?user_domain="+encodeURIComponent(e)+l;var h="core/api/gmap/daterangebysession?user_domain="+encodeURIComponent(e)+l;if($("ul.nav-tabs li.active").attr("id")=="gmap-map-tab"){map.setZoom(2);$("#map-tab-waiting").fadeIn();setTimeout(function(){gmap_add_marker(h)},1000)}else{gmap_create_table_view(k)}$("li#gmap-table-tab").off().on("click",function(){window.pauseMap=true;if((!$(this).closest("ul").parent("div").find("div.tab-content").find("div#gmap-table-view").find("tbody").length||isDateChanged)&&!$(this).hasClass("active")){isDateChanged=false;gmap_create_table_view(k)}});$("li#gmap-map-tab").off().on("click",function(){window.pauseMap=false;if(isDateChanged&&!$(this).hasClass("active")){isDateChanged=false;map.setZoom(2);setTimeout(function(){gmap_add_marker(h)},1000)}else{$("#map-tab-waiting").fadeIn();getMarkers()}})}function convertToUTCTime(e,d){try{var f=new Date(e);if(d=="start"){f.setHours(0,0,0,0)}else{if(d=="end"){f.setHours(23,59,59,999)}}var c=new Date(f.getUTCFullYear(),f.getUTCMonth(),f.getUTCDate(),f.getUTCHours(),f.getUTCMinutes(),f.getUTCSeconds(),f.getUTCMilliseconds());return c.getTime()}catch(b){console.log("Error converting local  time to utc"+b)}}var INTERVAL=2000;var myLatlng=[];var marker=[];var markerStore={};var offSet=0;var limit=200;var url;var markerCluster;var infowindow;var oms;function getMarkers(){console.log(window.pauseMap);if(!window.pauseMap){$.getJSON(url+"&cursor="+offSet+"&page_size="+limit,function(b){if(b!=""){plotMarkers(b);offSet=offSet+limit;setTimeout(getMarkers,INTERVAL)}else{$("#map-tab-waiting").fadeOut()}})}else{$("#map-tab-waiting").fadeOut()}}function plotMarkers(n){for(var g=0;g<n.length;g++){if(!markerStore.hasOwnProperty(n[g].sid)){var h=(n[g].city_lat_long).split(",");myLatlng[g]=new google.maps.LatLng(h[0],h[1]);var b=n[g].parsedUserAgent.replace(/\\/g,"");var d;try{d=JSON.parse(b)}catch(e){console.log("Error in parsing json");continue}var m=normalize_os(d.os);var j=n[g].email;var l=gmap_set_icons(j,30);var k={url:l};if(j==undefined||j==""){j="Unknown Visitor"}var f="";f+='<div style="width:230px;min-height: 61px;background-color: #fff;">';f+='  <div style="float:left;">';f+="    ";f+='  <img alt="null" class="photo" src=\''+l+'\' style="width: 61px;border-radius:8px">';f+="  </div>";f+='  <div style="width: 230px;padding-left: 70px;">';f+='    <div class="emailLink" emailAttr='+j+' style="';f+="    margin: 7px 0px 0;";f+="    font-size: 14px;";f+="    white-space: nowrap;";f+="    text-overflow: ellipsis;";f+="    width: 100%;";f+="    overflow: hidden;";f+="    color: #363f44;";f+='"><a>'+j+"</a><br>"+timeSince(n[g].visit_time)+"<br>"+capitalizeFirstLetter(n[g].city)+" , "+n[g].country+"</div>";f+='    <p style="';f+="    margin: 3px 0 0px;float:right";f+='"><a href="#" style="';f+="    text-decoration: none;";f+="    color: #23b7e5;";f+="\"><img class='inline m-r-xs r r-2x' style='width:12px;' src='../../../img/web-stats/devices/"+d.device_type+".png'><img class='inline m-r-xs r r-2x' style='width:12px;' src='../../../img/web-stats/os/"+m+".png'><img class='inline m-r-xs r r-2x' style='width:12px;' src='../../../img/web-stats/browsers/"+d.browser_name+".png'></a>";f+="    </p>";f+="  </div>";f+="  </div>";marker[g]=new google.maps.Marker({position:myLatlng[g],map:map,draggable:false,icon:k,content:f});markerStore[n[g].sid]=marker[g];oms.addMarker(marker[g]);google.maps.event.addListener(marker[g],"click",function(){infowindow.setContent(this.content);infowindow.open(map,this)})}}if(markerCluster==undefined){markerCluster=new MarkerClusterer(map,marker,{maxZoom:15});google.maps.event.addListener(markerCluster,"click",function(o){var p=o.getMarkers();
if(c(p)){setTimeout(function(){google.maps.event.trigger(p[p.length-1],"click")},1000)}return true});function c(s){var o=0;var q=s[0].getPosition().lat();var p=s[0].getPosition().lng();for(var r=0;r<s.length;r++){if(s[r].getPosition().lat()===q&s[r].getPosition().lng()===p){o++}else{return false}}if(o==s.length){return true}else{if(o<s.length){return false}}}}else{markerCluster.addMarkers(marker,false)}google.maps.event.addListener(map,"click",function(){if(infowindow){infowindow.close()}})}$(document).on("click","div.emailLink",function(){var c=$(this).attr("emailAttr");if(c!=""&&c!=undefined){var b="core/api/contacts/search/email/"+c;$.getJSON(b,function(d){if(d!=""&&d!=undefined){var e=d.id;window.location.href="#contact/"+e}else{console.log("Response is empty");$("#noContactMessage").fadeIn();setTimeout(function(){$("#noContactMessage").fadeOut()},5000)}})}});function gmap_add_marker(b){google.maps.visualRefresh=true;var c={center:new google.maps.LatLng(39,22),zoom:2,mapTypeId:google.maps.MapTypeId.ROADMAP};window.map=new google.maps.Map(document.getElementById("google_map"),c);map.setOptions({minZoom:2});offSet=0;myLatlng=[];marker=[];markerStore={};markerCluster=undefined;infowindow=undefined;oms=undefined;infowindow=new google.maps.InfoWindow({maxWidth:230});oms=new OverlappingMarkerSpiderfier(map,{keepSpiderfied:true,nearbyDistance:40,legWeight:0});url=b;getMarkers(url)}$(document).on("click",".agile-row > tr > td",function(f){if($(this).hasClass("referer")){var c=$(this).find("a").attr("href");window.open(c)}else{var b=$(".agile-edit-row").attr("route");if($(this).closest("tr").find("[route]").length!=0){b=$(this).closest("tr").find("[route]").attr("route")}var d=$(this).closest("tr").find(".data-contact").attr("data");if(b=="contact/"||b=="company/"){SCROLL_POSITION=window.pageYOffset}console.log(d);if(d){Backbone.history.navigate(b+d,{trigger:true})}}});function capitalizeFirstLetter(b){return b.charAt(0).toUpperCase()+b.slice(1)}function gmap_set_icons(b,c){if(b==undefined||b==""){return LIB_PATH_FLATFULL+"images/anonymous_visitor.png"}return prepareLettergravatar(b)}function normalize_os(b){if(b===undefined||b.indexOf("_")===-1){return b}return b.split("_")[0]}function prepareLettergravatar(k){var b=["#1abc9c","#16a085","#f1c40f","#f39c12","#2ecc71","#27ae60","#e67e22","#d35400","#3498db","#2980b9","#e74c3c","#c0392b","#9b59b6","#8e44ad","#bdc3c7","#34495e","#2c3e50","#95a5a6","#7f8c8d","#ec87bf","#d870ad","#f69785","#9ba37e","#b49255","#b49255","#a94136"];try{var d={name:k,charCount:1,textColor:"#ffffff",height:32,width:32,fontSize:18,fontWeight:170,fontFamily:"HelveticaNeue-Light,Helvetica Neue Light,Helvetica Neue,Helvetica, Arial,Lucida Grande, sans-serif"};d.name=""+d.name;var l=d.name.substr(0,d.charCount).toUpperCase();var j=$('<text text-anchor="middle"></text>').attr({y:"50%",x:"50%",dy:"0.35em","pointer-events":"auto",fill:d.textColor,"font-family":d.fontFamily}).html(l).css({"font-weight":d.fontWeight,"font-size":d.fontSize+"px",});var m=null;if(l.length>1){m=Math.abs(Math.floor((((l.charCodeAt(0)-65)+(l.charCodeAt(1)-65))/2)%b.length))}else{m=Math.abs(Math.floor((l.charCodeAt(0)-65)%b.length))}var f=$("<svg></svg>").attr({xmlns:"http://www.w3.org/2000/svg","pointer-events":"none",width:d.width,height:d.height}).css({"background-color":b[m],width:d.width+"px",height:d.height+"px"});f.append(j);var g=window.btoa(unescape(encodeURIComponent($("<div>").append(f.clone()).html())));return"data:image/svg+xml;base64,"+g}catch(h){console.log("Error in letter gravatar function"+h)}}function timeSince(c){var d=new Date();try{var h="-";var e=new RegExp(h,"g");c=c.replace(e,"/");c=c.match(/[^:]+(\:[^:]+)?/g);d=new Date(c[0]+" UTC")}catch(f){console.log("Error in parsing date")}var g=Math.floor((new Date()-d)/1000);var b=Math.floor(g/31536000);if(b>1){return b+" years ago"}b=Math.floor(g/2592000);if(b>1){return b+" months ago"}b=Math.floor(g/86400);if(b>1){return b+" days ago"}b=Math.floor(g/3600);if(b>1){return b+" hours ago"}b=Math.floor(g/60);if(b>1){return b+" minutes ago"}return Math.floor(g)+" seconds ago"}var App_Contacts,App_Contact_Search,App_Contact_Bulk_Actions,App_Contact_Filters,App_Contact_Views,App_Workflows,App_Deals,App_Admin_Settings,App_Calendar,App_Settings,App_Reports,App_Cases,App_Subscription,App_Visitors,App_WebReports,App_Documents,App_Widgets,App_ShopifyApp,App_Portlets,App_VoiceMailRouter,App_Deal_Details,App_Forms,App_ACL,App_Webpages;var Collection_View={};$(function(){App_Contacts=new ContactsRouter();App_Contact_Views=new ContactViewsRouter();App_Contact_Filters=new ContactFiltersRouter();App_Contact_Bulk_Actions=new ContactBulkActionRouter();App_Contact_Search=new ContactSearchRouter();App_Workflows=new WorkflowsRouter();App_Deals=new DealsRouter();App_Admin_Settings=new AdminSettingsRouter();App_Settings=new SettingsRouter();App_Calendar=new CalendarRouter();App_Subscription=new SubscribeRouter();App_Reports=new ReportsRouter();App_Cases=new CasesRouter();App_Visitors=new VisitorsRouter();App_WebReports=new WebreportsRouter();App_Documents=new DocumentsRouter();App_Widgets=new WidgetsRouter();App_Configuration=new AgileConfigRouter();App_Adminpanel=new AdminPanelRouter();App_ReferelRouter=new ReferelRouter();App_Activity_log=new ActivitylogRouter();App_ShopifyApp=new ShopifyRouter();App_Deal_Details=new DealDetailsRouter();App_VoiceMailRouter=new VoiceMailRouter();App_Portlets=new PortletsRouter;App_Tasks=new TaskDetailsRouter();App_Forms=new FormsRouter();App_ACL=new ACLRestriction();App_FacebookPageTabRouter=new FacebookPageTabRouter();App_Companies=new CompaniesRouter();App_Datasync=new DataSyncRouter();App_Ticket_Module=new TicketsUtilRouter();App_LandingPageRouter=new LandingPageRouter();App_Dashboards=new DashboardsRouter();App_EmailBuilderRouter=new EmailBuilderRouter();App_VisitorsSegmentation=new VisitorsSegmentationRouter();App_Affiliate=new AffiliateRouter();Backbone.history.bind("all",currentRoute);Backbone.history.start()});var Current_Route;function currentRoute(c){endFunctionTimer("startbackbone");Current_Route=window.location.hash.split("#")[1];if(SCROLL_POSITION){var b=Current_Route;if(!b.match("contact")){SCROLL_POSITION=0}}agile_update_ga_track_page(Current_Route);activateInfiniScroll();SELECT_ALL=false;SUBSCRIBERS_SELECT_ALL=false;if(tour){tour.end();tour=null}if(GLOBAL_WEBRULE_FLAG){executeWebRulesOnRoute()}try{showPageBlockModal()}catch(d){}showUpgradeNoty();if(CURRENT_DOMAIN_USER){tight_acl.init_permissions()}}var CLICKDESK_Live_Chat=CLICKDESK_Live_Chat||{};function load_clickdesk_code(){if(CLICKDESK_CODE_LOADED){return}console.log("loading clickdesk..");CLICKDESK_CODE_LOADED=true;var c=document.createElement("script");c.type="text/javascript";c.async=true;c.src=glcpath+"livechat-new.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(c,b);CLICKDESK_Live_Chat.on_after_load=function(){agile_toggle_chat_option_on_status()}}function clickdesk_livechat_get_current_status(b){CLICKDESK_Live_Chat.onStatus(function(c){b(c)})}function agile_toggle_chat_option_on_status(){clickdesk_livechat_get_current_status(function(b){var c=$("#clickdesk_live_chat").closest("li");c.removeClass("none block");if(b=="online"){c.addClass("block")}else{c.addClass("none")}})}function executeWebRulesOnRoute(){if(typeof _agile_execute_action=="function"){_agile_webrules();return}}$(document).ready(function(){load_clickdesk_code();setTimeout(function(){$(".modal-header .close").html("&times;")},1000)});SUBSCRIBERS_SELECT_ALL=false;