var _agile_library_loader={load_fullcalendar_libs:function(a){head.js(LIB_PATH+"lib/jquery-ui.min.js",LIB_PATH+"lib/fullcalendar.min.js",function(){if(a){a()}})},localize_highcharts:function(){Highcharts.setOptions({lang:{contextButtonTitle:"Chart context menu",printChart:"Print chart",downloadJPEG:"Download JPEG image",downloadPDF:"Download PDF document",downloadPNG:"Download PNG image",downloadSVG:"Download SVG vector image",downloadXLS:"Download XLS",downloadCSV:"Download CSV",months:$.fn.datepicker.dates.en.months,shortMonths:$.fn.datepicker.dates.en.monthsShort,shortWeekdays:$.fn.datepicker.dates.en.daysExactMin,weekdays:$.fn.datepicker.dates.en.days,noData:"No data to display",numericSymbols:["k","M","G","T","P","E"],resetZoom:"Reset zoom",resetZoomTitle:"Reset zoom"}})},};function initChartsUI(a){initDateRange(a);a()}function showEmailGraphs(a){showBar("core/api/campaign-stats/email/reports/"+a+getOptions()+"&type=date","line-daily-chart",_agile_get_translated_val("reports","daily"),"Count",null);showBar("core/api/campaign-stats/email/reports/"+a+getOptions()+"&type=hour","line-hourly-chart",_agile_get_translated_val("reports","hourly"),"Count",null);showBar("core/api/campaign-stats/email/reports/"+a+getOptions()+"&type=day","line-weekly-chart",_agile_get_translated_val("reports","weekly"),"Count",null)}function getOptions(){var b="?";var a=$("#range").html().split("-");var e=getUTCMidNightEpochFromDate(new Date(a[0]));var g=$.trim(a[1]);if(g){g=g+" 23:59:59"}var c=getUTCMidNightEpochFromDate(new Date(g));c+=(((23*60*60)+(59*60)+59)*1000);b+=("start_time="+e+"&end_time="+c);var j=new Date();b+=("&time_zone="+j.getTimezoneOffset());if($("#frequency").length>0){var f=$("#frequency").val();b+=("&frequency="+f)}if($("#filter").length>0){var h=$("#filter").val();if(h!=""&&h!="ALL"){b+=("&filter="+h)}}return b}function get_email_table_reports(a){$("#email-table-reports").html(getRandomLoadingImg());$.getJSON("core/api/campaign-stats/email/table-reports/"+a+getOptions(),function(b){console.log(b);getTemplate("campaign-email-table-reports",b,undefined,function(c){if(!c){return}$("#email-table-reports").html($(c))},"#email-table-reports")})}function setupCharts(a){head.js(LIB_PATH+"lib/flot/highcharts-3.js",LIB_PATH+"lib/flot/highcharts-more.js",LIB_PATH+"lib/flot/solid-gauge.js",LIB_PATH+"lib/flot/highcharts-exporting.js?_=v1",LIB_PATH+"lib/flot/funnel.js",LIB_PATH+"lib/flot/highcharts-grid.js",LIB_PATH+"lib/flot/no-data-to-display.js",LIB_PATH+"lib/flot/export-csv.js",function(){_agile_library_loader.localize_highcharts();if(a&&typeof(a)==="function"){a()}})}function pie(c,a,b){var d;setupCharts(function(){fetchReportData(c,function(h){var j=[];var f=0;var e=0;$.each(h,function(m,l){f+=l;e++});console.log(h,f);$.each(h,function(m,l){var n=[];n.push(m);n.push(l/f*100);j.push(n)});console.log(j);var g=e>20?false:true;d=new Highcharts.Chart({chart:{renderTo:a,type:"pie",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,marginTop:50},colors:["#7266ba","#23b7e5","#27c24c","#fad733","#f05050"],title:{text:b},tooltip:{backgroundColor:null,borderWidth:0,borderRadius:0,headerFormat:"",useHTML:true,enabled:true,shadow:false,formatter:function(){var k='<div class="highcharts-tool-tip"><div class="tooltip-title" style="color:#333333!important;">'+this.point.name+'</div><div style="text-align:center;margin-top:7px;margin-left:-3px;color:#333333!important;"><b>'+(this.point.percentage).toFixed(2)+"%<b></div></div>";return k},message:"Hover over chart slices<br>for more information.",positioner:function(){return{x:15,y:23}},},legend:{itemWidth:75,},plotOptions:{pie:{animation:g,allowPointSelect:true,cursor:"pointer",borderWidth:0,dataLabels:{enabled:true,color:"#000000",connectorColor:"#000000",connectorWidth:0,formatter:function(){return"";if(this.percentage<=2){return""}return(this.percentage).toFixed(2)+" %"},distance:2},showInLegend:false,innerSize:"60%",size:"90%",shadow:false,borderWidth:0},series:{events:{mouseOver:function(){$(".tooltip-default-message").hide()},mouseOut:function(k){$(".tooltip-default-message").show()}},borderWidth:0}},series:[{type:"pie",name:"Tag",data:j,startAngle:90}],},function(k){k.renderer.image(updateImageS3Path("img/donut-tooltip-frame.png"),14,5,200,80).add();k.renderer.text(this.options.tooltip.message,50,40).attr("class","tooltip-default-message").add()})})})}function showBar(d,a,c,g,f,b){var e;$("#"+a).html("<div class='text-center v-middle opa-half'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>");setupCharts(function(){fetchReportData(d,function(m){var j=[];var p=[];var h=[];if(a!="calls-chart"){h=["#23b7e5","#27c24c","#7266ba","#fad733"]}else{h=["#27c24c","#23b7e5","#f05050","#7266ba","#fad733","#FF9900","#7AF168","#167F80","#0560A2","#D3E6C7","#7798BF","#B72030"]}h=b||h;var o=0;var n=$("#frequency:visible").val();var l;$.each(m,function(r,q){if(a!="calls-chart"&&a!="tickets-chart"){j.push(r)}if(l==undefined){var s=0;l=[];$.each(q,function(v,u){var t={};t.name=v;t.data=[];l[s++]=t})}$.each(q,function(v,u){var t=find_series_with_name(l,v);t.data.push(u)});p.push(r*1000);o++});var k=0;if(a=="calls-chart"||a=="tickets-chart"){$.each(m,function(r,q){dateRangeonXaxis(p,j,n,o,k);k++})}e=new Highcharts.Chart({chart:{renderTo:a,type:"column"},colors:h,title:{text:c},xAxis:{categories:j,tickPositioner:function(){if(this.options.categories.length>30){this.options.minTickInterval=Math.ceil(this.options.categories.length/10);if(this.options.minTickInterval==3){this.options.minTickInterval=4}}},labels:{overflow:"justify"}},yAxis:{allowDecimals:false,min:0,title:{text:g},stackLabels:{enabled:true,style:{fontWeight:"bold",color:(Highcharts.theme&&Highcharts.theme.textColor)||"gray"}}},legend:{align:"right",x:-52,verticalAlign:"top",y:0,floating:true,layout:"horizontal",backgroundColor:(Highcharts.theme&&Highcharts.theme.legendBackgroundColorSolid)||"white",borderColor:"#CCC",borderWidth:1,shadow:false},tooltip:{formatter:function(){if(a=="calls-chart"){return"<b>"+this.x+"</b><br/><font color="+this.series.color+">"+this.series.name+"</font>: "+this.y}else{return"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.y}},useHTML:true,},plotOptions:{column:{stacking:f,dataLabels:{enabled:true,color:(Highcharts.theme&&Highcharts.theme.dataLabelsColor)||"white"}},series:{borderWidth:0},},series:l,noData:{style:{fontSize:"14px",fontWeight:"normal",color:"#98A6AD"},},})})})}function find_series_with_name(c,a){for(var b=0;b<c.length;b++){if(c[b].name==a){return c[b]}}}function showLine(c,a,b,e,f){if(typeof f==="undefined"){}else{$("#"+a).html("<div class='text-center v-middle opa-half'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>")}var d;setupCharts(function(){if(reportDataRequest&&reportDataRequest.readyState==1&&reportDataRequest.state()=="pending"){reportDataRequest.abort()}fetchReportData(c,function(l){var n=[];var g=[];var h=0;var o=1;var q=$("#frequency:visible").val();var m;var k=[];$.each(l,function(s,r){k.push(s)});k.sort();var p={};$.each(k,function(r,s){p[""+s]=l[""+s]});$.each(p,function(s,r){if(m==undefined){var t=0;m=[];$.each(r,function(w,v){var u={};u.name=w;u.data=[];m[t++]=u})}$.each(r,function(w,v){var u=find_series_with_name(m,w);u.data.push(v)});g.push(s*1000);h++});var j=0;if(Math.ceil(h/10)>0){o=Math.ceil(h/10);if(o==3){o=4}}$.each(p,function(u,x){var s=new Date(u*1000);var A=new Date(g[j]);if(q!=undefined){if(q=="daily"){n.push(Highcharts.dateFormat("%e.%b",Date.UTC(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate()))+"")}else{if(q=="weekly"){if(j!=h-1){var y=new Date(g[j+1]);n.push(Highcharts.dateFormat("%e.%b",Date.UTC(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(y.getUTCFullYear(),y.getUTCMonth(),y.getUTCDate()-1)))}else{var r=new Date(Date.parse($.trim($("#range").html().split("-")[1])).valueOf());n.push(Highcharts.dateFormat("%e.%b",Date.UTC(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())))}}else{if(q=="monthly"){if(j!=h-1){var y=new Date(g[j+1]);var t=new Date();var w="";var z="";if(j!=0){if(t.getUTCFullYear()!=A.getUTCFullYear()){w=Highcharts.dateFormat("%b.%Y",Date.UTC(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate()))}else{w=Highcharts.dateFormat("%b",Date.UTC(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate()))}n.push(w)}else{if(t.getUTCFullYear()!=A.getUTCFullYear()){w=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate()))}else{w=Highcharts.dateFormat("%e.%b",Date.UTC(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate()))}if(t.getUTCFullYear()!=y.getUTCFullYear()){z=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(y.getUTCFullYear(),y.getUTCMonth(),y.getUTCDate()-1))}else{z=Highcharts.dateFormat("%e.%b",Date.UTC(y.getUTCFullYear(),y.getUTCMonth(),y.getUTCDate()-1))}n.push(w+" - "+z)}}else{var t=new Date();var w="";var z="";var r=new Date(Date.parse($.trim($("#range").html().split("-")[1])).valueOf());if(t.getUTCFullYear()!=A.getUTCFullYear()){w=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate()));z=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(r.getFullYear(),r.getMonth(),r.getDate()))}else{w=Highcharts.dateFormat("%e.%b",Date.UTC(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate()));z=Highcharts.dateFormat("%e.%b",Date.UTC(r.getFullYear(),r.getMonth(),r.getDate()))}n.push(w+" - "+z)}}}}j++}});d=new Highcharts.Chart({chart:{renderTo:a,type:"line",marginRight:130,marginBottom:50},title:{text:b,x:-20},xAxis:{categories:n,tickmarkPlacement:"on",minTickInterval:o,tickWidth:1},yAxis:{title:{text:e},plotLines:[{value:0,width:1,color:"#808080"}],min:0},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-10,y:100,borderWidth:0},series:m,})})})}function showFunnel(c,a,b,e){if(typeof e==="undefined"){}else{$("#"+a).html("<div class='text-center v-middle opa-half'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>")
}var d;setupCharts(function(){fetchReportData(c,function(g){var f=[];$.each(g,function(j,h){$.each(h,function(m,l){var k=[];k.push(m,l);f.push(k)})});console.log(f);d=new Highcharts.Chart({chart:{type:"funnel",marginRight:100,renderTo:a},title:{text:b,x:-50},plotOptions:{series:{dataLabels:{enabled:true,format:"<b>{point.name}</b> ({point.y:,.0f})",color:"#ccc",softConnector:true},neckWidth:"30%",neckHeight:"25%",borderWidth:0}},tooltip:{headerFormat:'<span style="font-size: 12px">{point.key}</span><br/>'},legend:{enabled:false},series:[{name:"Contacts",data:f}],noData:{style:{fontSize:"14px",fontWeight:"normal",color:"#98A6AD"},},})})})}function pieTags(b,c){var a="/core/api/tags/stats";if(c){a=a+"?reload=true"}$("#pie-tags-chart",b).html(getRandomLoadingImg());pie(a,"pie-tags-chart","")}function pieMilestones(){pie("/core/api/opportunity/stats/milestones?min=0&max=1543842319","pie-deals-chart","")}function pieMilestonesByPipeline(a){pie("/core/api/opportunity/stats/milestones/"+a+"?min=0&max=1543842319","pie-deals-chart","")}function pieTasks(a){pie("core/api/tasks/stats"+a,"pie-tasks-chart","")}function dealsLineChart(){var a=$("#frequency:visible").val();showDealAreaSpline("core/api/opportunity/stats/details?min=0&max=1543842319","total-pipeline-chart","Monthly Deals","Total Value",a)}function dealsLineChartByPipeline(a){var b=$("#frequency:visible").val();showDealAreaSpline("core/api/opportunity/stats/details/"+a+"?min=0&max=1543842319","total-pipeline-chart","Monthly Revenue - All Deals","Total Value",b)}var reportDataRequest;function fetchReportData(b,a){$("#plan-limit-error").hide();reportDataRequest=$.getJSON(b,function(c){if(a&&typeof(a)==="function"){a(c)}}).error(function(c){if(c.status!=406){return}if(a&&typeof(a)==="function"){a([])}$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+c.responseText+"</i></p></small></div>");$("#plan-limit-error").html($save_info).show()})}function showAreaSpline(c,a,b,e,f){if(typeof f==="undefined"){}else{$("#"+a).html("<div class='text-center v-middle opa-half'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>")}var d;setupCharts(function(){if(reportDataRequest&&reportDataRequest.readyState==1&&reportDataRequest.state()=="pending"){reportDataRequest.abort()}fetchReportData(c,function(l){var n=[];var g=[];var h=0;var o=1;var q=$("#frequency:visible").val();var m;var k=[];$.each(l,function(s,r){k.push(s)});k.sort();var p={};$.each(k,function(r,s){p[""+s]=l[""+s]});$.each(p,function(s,r){if(m==undefined){var t=0;m=[];$.each(r,function(w,v){var u={};u.name=w;u.data=[];m[t++]=u})}$.each(r,function(w,v){var u=find_series_with_name(m,w);u.data.push(v)});g.push(s*1000);h++});var j=0;if(Math.ceil(h/10)>0){o=Math.ceil(h/10);if(o==3){o=4}}$.each(p,function(t,s){var x=new Date(g[j]);if(q!=undefined){if(q=="daily"){n.push(Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))+"")}else{if(q=="weekly"){if(j!=h-1){var u=new Date(g[j+1]);n.push(Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()-1)))}else{var z=new Date(Date.parse($.trim($("#range").html().split("-")[1])).valueOf());n.push(Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate())))}}else{if(q=="monthly"){if(j!=h-1){var u=new Date(g[j+1]);var w=new Date();var y="";var r="";if(j!=0){if(w.getUTCFullYear()!=x.getUTCFullYear()){y=Highcharts.dateFormat("%b.%Y",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))}else{y=Highcharts.dateFormat("%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))}n.push(y)}else{if(w.getUTCFullYear()!=x.getUTCFullYear()){y=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))}else{y=Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()))}if(w.getUTCFullYear()!=u.getUTCFullYear()){r=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()-1))}else{r=Highcharts.dateFormat("%e.%b",Date.UTC(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()-1))}n.push(y+" - "+r)}}else{var w=new Date();var y="";var r="";var z=new Date(Date.parse($.trim($("#range").html().split("-")[1])).valueOf());if(w.getUTCFullYear()!=x.getUTCFullYear()){y=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()));r=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate()))}else{y=Highcharts.dateFormat("%e.%b",Date.UTC(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()));r=Highcharts.dateFormat("%e.%b",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate()))}n.push(y+" - "+r)}}}}j++}});d=new Highcharts.Chart({chart:{renderTo:a,type:"areaspline",marginRight:130,marginBottom:50},title:{text:b,x:-20},xAxis:{categories:n,tickmarkPlacement:"on",minTickInterval:o,tickWidth:1},yAxis:{allowDecimals:false,title:{text:e},plotLines:[{value:0,width:1,color:"#808080"}],min:0},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-10,y:100,borderWidth:0},series:m,})})})}function showDealAreaSpline(c,a,b,e,g,f){if(typeof g==="undefined"){}else{$("#"+a).html("<div class='text-center v-middle opa-half'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>")}var d;setupCharts(function(){fetchReportData(c,function(m){var o=[];var h=[];var n;var l=[];$.each(m,function(s,r){l.push(s)});l.sort();var q={};$.each(l,function(r,s){q[""+s]=m[""+s]});var p=1;var j=0;$.each(q,function(s,r){if(n==undefined){var t=0;n=[];$.each(r,function(w,v){var u={};u.name=w;u.data=[];n[t++]=u})}$.each(r,function(w,v){var u=find_series_with_name(n,w);u.data.push(v)});h.push(s*1000);j++});var k=0;$.each(q,function(u,y){var s=new Date(u*1000);var B=new Date(h[k]);if(a=="revenue-chart"){if(f!=undefined){if(f=="daily"){o.push(Highcharts.dateFormat("%e.%b",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))+"")}else{if(f=="weekly"){if(k!=j-1){var z=new Date(h[k+1]);o.push(Highcharts.dateFormat("%e.%b",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate()-1)))}else{var r=new Date(Date.parse($.trim($("#range").html().split("-")[1])).valueOf());o.push(Highcharts.dateFormat("%e.%b",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())))}}else{if(f=="monthly"||f=="yearly"){if(k!=j-1){var z=new Date(h[k+1]);var t=new Date();var w="";var A="";if(k!=0){if(f=="yearly"){w=Highcharts.dateFormat("%Y",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))}else{if(t.getFullYear()!=B.getFullYear()){w=Highcharts.dateFormat("%b.%Y",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))}else{w=Highcharts.dateFormat("%b",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))}}o.push(w)}else{var x=new Date(Date.parse($.trim($("#range").html().split("-")[0])).valueOf());if(t.getFullYear()!=B.getFullYear()){w=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()))}else{w=Highcharts.dateFormat("%e.%b",Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()))}A=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate()-1));o.push(w+" - "+A)}}else{var t=new Date();var w="";var x=new Date(Date.parse($.trim($("#range").html().split("-")[0])).valueOf());var A="";var r=new Date(Date.parse($.trim($("#range").html().split("-")[1])).valueOf());if(t.getFullYear()!=B.getFullYear()){if(k==0){w=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()))}else{w=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))}A=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(r.getFullYear(),r.getMonth(),r.getDate()))}else{if(k==0){w=Highcharts.dateFormat("%e.%b",Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()))}else{w=Highcharts.dateFormat("%e.%b",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))}A=Highcharts.dateFormat("%e.%b",Date.UTC(r.getFullYear(),r.getMonth(),r.getDate()))}o.push(w+" - "+A)}}else{if(f=="Quarterly"){if(k!=j-1){var z=new Date(h[k+1]);var t=new Date();var w="";var A="";if(k!=0){if(t.getFullYear()!=B.getFullYear()){o.push(Highcharts.dateFormat("%b.%y",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))+" - "+Highcharts.dateFormat("%b.%y",Date.UTC(z.getFullYear(),z.getMonth()-1,z.getDate())))}else{o.push(Highcharts.dateFormat("%b",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))+" - "+Highcharts.dateFormat("%b",Date.UTC(z.getFullYear(),z.getMonth()-1,z.getDate())))}}else{var x=new Date(Date.parse($.trim($("#range").html().split("-")[0])).valueOf());if(t.getFullYear()!=B.getFullYear()){w=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()))}else{w=Highcharts.dateFormat("%e.%b",Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()))}if(t.getFullYear()!=z.getFullYear()){A=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate()-1))}else{A=Highcharts.dateFormat("%e.%b",Date.UTC(z.getFullYear(),z.getMonth(),z.getDate()-1))}o.push(w+" - "+A)}}else{var t=new Date();var w="";var x=new Date(Date.parse($.trim($("#range").html().split("-")[0])).valueOf());var A="";var r=new Date(Date.parse($.trim($("#range").html().split("-")[1])).valueOf());if(t.getFullYear()!=B.getFullYear()){if(k==0){w=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()))}else{w=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))}A=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(r.getFullYear(),r.getMonth(),r.getDate()))}else{if(k==0){w=Highcharts.dateFormat("%e.%b",Date.UTC(x.getFullYear(),x.getMonth(),x.getDate()))}else{w=Highcharts.dateFormat("%e.%b",Date.UTC(B.getFullYear(),B.getMonth(),B.getDate()))
}A=Highcharts.dateFormat("%e.%b",Date.UTC(r.getFullYear(),r.getMonth(),r.getDate()))}o.push(w+" - "+A)}}}}}k++}}else{o.push(Highcharts.dateFormat("%b.%Y",Date.UTC(s.getFullYear(),s.getMonth(),s.getDate()))+"")}});if(Math.ceil((j-1)/10)>0){p=Math.ceil(j/10);if(p==3){p=4}}d=new Highcharts.Chart({chart:{renderTo:a,type:"areaspline",marginRight:130,marginBottom:50},title:{text:b,x:-20,style:{textTransform:"normal"}},xAxis:{categories:o,tickmarkPlacement:"on",minTickInterval:p},yAxis:{title:{text:e},plotLines:[{value:0,width:1,color:"#808080"}],min:0},tooltip:{formatter:function(){return'<div><div class="p-n">'+this.x+'</div><div class="p-n"><font color='+this.series.color+">"+this.series.name+"</font> : "+getCurrencySymbolForCharts()+""+getNumberWithCommasForCharts(this.y)+"</div></div>"},useHTML:true},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:-10,y:100,borderWidth:0},series:n,lang:{noData:"No Deals Found"},noData:{style:{fontSize:"14px",fontWeight:"normal",color:"#98A6AD"},position:{x:60,y:5},}})})})}function getCurrencySymbolForCharts(){var b=((CURRENT_USER_PREFS.currency!=null)?CURRENT_USER_PREFS.currency:"USD-$");var a=((b.length<4)?"$":b.substring(4,b.length));return a}function getNumberWithCommasForCharts(a){a=parseFloat(a);a=Math.round(a);if(a==0){return a}if(a){return a.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}}function showDealsGrowthgraph(c,a,b,e,f){if(typeof f==="undefined"){}else{$("#"+a).html("<div class='text-center v-middle opa-half'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>")}var d;setupCharts(function(){fetchReportData(c,function(l){var n=[];var g=[];var r=$("#type:visible").val();var q=$("#frequency:visible").val();var m;var s=[];var k=[];$.each(l,function(u,t){k.push(u)});k.sort();var p={};$.each(k,function(t,u){p[""+u]=l[""+u]});var o=1;var h=0;$.each(p,function(u,t){var x=[];x.push(u);var y=0;if(m==undefined){var w=0;m=[];$.each(t,function(A,z){var v={};v.name=A;v.data=[];m[w++]=v})}$.each(t,function(A,z){y=y+z;var v=find_series_with_name(m,A);v.data.push(z)});x.push(y);g.push(u*1000);h++;s.push(x)});var j=0;$.each(p,function(u,t){dateRangeonXaxis(g,n,q,h,j);j++});if(Math.ceil((h-1)/10)>0){o=Math.ceil(h/10);if(o==3){o=4}}if(m==undefined){chartRenderforIncoming(a,n,b,e,o,r,m,s)}else{$.ajax({type:"GET",url:"/core/api/categories?entity_type=DEAL_SOURCE",dataType:"json",success:function(t){$.each(t,function(u,w){for(var v=0;v<m.length;v++){if(m[v].name=="0"){m[v].name="Unknown"}else{if(w.id==m[v].name){m[v].name=w.label}}}});chartRenderforIncoming(a,n,b,e,o,r,m,s)}})}})})}function chartRenderforIncoming(c,f,a,b,h,j,e,k,g,d,l){if(g==undefined){g=-10}if(d==undefined){d=100}chart=new Highcharts.Chart({chart:{renderTo:c,type:"area",marginRight:50,marginBottom:50,events:{load:function(){console.log("load");if(l!=undefined){portlet_utility.toggle_chart_legends(this,l)}},redraw:function(){console.log("redraw");if(l!=undefined){portlet_utility.toggle_chart_legends(this,l)}}},},colors:["#7266ba","#23b7e5","#27c24c","#fad733","#f05050","#FF9900","#7AF168","#167F80","#0560A2","#D3E6C7"],title:{text:a,x:-20,style:{textTransform:"normal"}},xAxis:{categories:f,tickmarkPlacement:"on",minTickInterval:h},yAxis:{allowDecimals:false,title:{text:b},plotLines:[{value:0,width:1,color:"#808080"}],min:0},legend:{layout:"vertical",align:"right",verticalAlign:"top",x:g,y:d,borderWidth:0,labelFormatter:function(){if(this.name.length>12){return this.name.slice(0,12)+"..."}else{return this.name}}},plotOptions:{area:{stacking:"normal",lineColor:"#666666",lineWidth:1,marker:{lineWidth:1,lineColor:"#666666",fillColor:null}}},tooltip:{formatter:function(){if(j=="deals"){return'<div><div class="p-n">'+this.x+'</div><div class="p-n text-cap"><font color='+this.series.color+">"+this.series.name+"</font> : "+getNumberWithCommasForCharts(this.y)+'</div></div><div class="p-n">Total : '+getNumberWithCommasForCharts(k[this.point.x][1])+"</div>"}else{return'<div><div class="p-n">'+this.x+'</div><div class="p-n"><font color='+this.series.color+">"+this.series.name+"</font> : "+getCurrencySymbolForCharts()+""+getNumberWithCommasForCharts(this.y)+'</div></div><div class="p-n">Total : '+getCurrencySymbolForCharts()+""+getNumberWithCommasForCharts(k[this.point.x][1])+"</div>"}},useHTML:true},lang:{noData:"No Deals Found"},noData:{style:{fontSize:"14px",fontWeight:"normal",color:"#98A6AD"},position:{x:60,y:5},},series:e,})}function pieforReports(c,a,b,h,e){if(typeof h==="undefined"){}else{$("#"+a).html("<div class='text-center v-middle opa-half'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>")}var f;var d=[];var g=$("#frequency:visible").val();setupCharts(function(){fetchReportData(c,function(n){var o=[];var l=0;var k=0;$.each(n,function(q,p){var r=[];r.push(q);r.push(p.count);r.push(p.total);d.push(r);if(g=="Revenue"){l+=p.total}else{l+=p.count}k++});console.log(n,l);$.each(n,function(q,p){var r=[];r.push(q);if(g=="Revenue"){r.push(p.total/l*100)}else{r.push(p.count/l*100)}o.push(r)});console.log(o);var m=k>20?false:true;var j;if(a=="lossreasonpie-chart"||a=="lossreasonpie-chart-users"||e){j="/core/api/categories?entity_type=DEAL_LOST_REASON"}else{j="/core/api/categories?entity_type=DEAL_SOURCE"}if(o!=undefined&&o.length==0){createAPieChart(a,b,m,d,o)}else{$.ajax({type:"GET",url:j,dataType:"json",success:function(p){$.each(p,function(q,s){for(var r=0;r<o.length;r++){if(o[r][0]=="0"){o[r][0]="Unknown"}else{if(s.id==o[r][0]){o[r][0]=s.label}}}});createAPieChart(a,b,m,d,o)}})}})})}function createAPieChart(a,b,e,c,f){var d="90%";if(a=="lossreasonpie-chart-users"){d="50%"}chart=new Highcharts.Chart({chart:{renderTo:a,type:"pie",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:false,marginBottom:30,marginTop:20,marginLeft:70,marginRight:70},colors:["#7266ba","#23b7e5","#27c24c","#fad733","#f05050","#FF9900","#7AF168","#167F80","#0560A2","#D3E6C7"],title:{text:b},tooltip:{formatter:function(){return'<div><div class="p-n">'+this.series.name+"s: <b>"+getNumberWithCommasForCharts(c[this.point.x][1])+'</b></div></div><div class="p-n">Total Value: <b>'+getCurrencySymbolForCharts()+""+c[this.point.x][2].toLocaleString()+"</b></div>"},shared:true,useHTML:true,borderWidth:1,backgroundColor:"#313030",shadow:false,borderColor:"#000",borderRadius:3,style:{color:"#EFEFEF"}},legend:{itemWidth:75,},plotOptions:{pie:{animation:e,allowPointSelect:true,cursor:"pointer",borderWidth:0,dataLabels:{enabled:true,useHTML:true,formatter:function(){return'<div class="text-center text-cap"><span style="color:'+this.point.color+';display:block"><b>'+this.point.name+'</b></span><span style="color:'+this.point.color+'"><b>'+Math.round(this.point.percentage)+"%</b></span></div>"},distance:25},showInLegend:false,size:d,innerSize:"65%",shadow:false,borderWidth:0},series:{events:{mouseOver:function(){$(".tooltip-default-message").hide()},mouseOut:function(g){$(".tooltip-default-message").show()}},borderWidth:0}},series:[{type:"pie",name:"Deal",data:f,startAngle:90}],lang:{noData:"No Deals Found"},noData:{style:{fontSize:"14px",fontWeight:"normal",color:"#98A6AD"},position:{y:5},}})}function dateRangeonXaxis(a,g,j,c,d){var m=new Date(a[d]);if(j=="daily"){g.push(Highcharts.dateFormat("%e.%b",Date.UTC(m.getFullYear(),m.getMonth(),m.getDate()))+"")}else{if(j=="weekly"){if(d!=c-1){var k=new Date(a[d+1]);g.push(Highcharts.dateFormat("%e.%b",Date.UTC(m.getFullYear(),m.getMonth(),m.getDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(k.getFullYear(),k.getMonth(),k.getDate()-1)))}else{var b=new Date(Date.parse($.trim($("#range").html().split("-")[1])).valueOf());g.push(Highcharts.dateFormat("%e.%b",Date.UTC(m.getFullYear(),m.getMonth(),m.getDate()))+" - "+Highcharts.dateFormat("%e.%b",Date.UTC(b.getFullYear(),b.getMonth(),b.getDate())))}}else{if(j=="monthly"){if(d!=c-1){var k=new Date(a[d+1]);var e=new Date();var f="";var l="";if(d!=0){if(e.getFullYear()!=m.getFullYear()){f=Highcharts.dateFormat("%b.%Y",Date.UTC(m.getFullYear(),m.getMonth(),m.getDate()))}else{f=Highcharts.dateFormat("%b",Date.UTC(m.getFullYear(),m.getMonth(),m.getDate()))}g.push(f)}else{var h=new Date(Date.parse($.trim($("#range").html().split("-")[0])).valueOf());if(e.getFullYear()!=m.getFullYear()){f=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(h.getFullYear(),h.getMonth(),h.getDate()))}else{f=Highcharts.dateFormat("%e.%b",Date.UTC(h.getFullYear(),h.getMonth(),h.getDate()))}l=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(k.getFullYear(),k.getMonth(),k.getDate()-1));g.push(f+" - "+l)}}else{var e=new Date();var f="";var h=new Date(Date.parse($.trim($("#range").html().split("-")[0])).valueOf());var l="";var b=new Date(Date.parse($.trim($("#range").html().split("-")[1])).valueOf());if(e.getFullYear()!=m.getFullYear()){if(d==0){f=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(h.getFullYear(),h.getMonth(),h.getDate()))}else{f=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(m.getFullYear(),m.getMonth(),m.getDate()))}l=Highcharts.dateFormat("%e.%b.%Y",Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()))}else{if(d==0){f=Highcharts.dateFormat("%e.%b",Date.UTC(h.getFullYear(),h.getMonth(),h.getDate()))}else{f=Highcharts.dateFormat("%e.%b",Date.UTC(m.getFullYear(),m.getMonth(),m.getDate()))}l=Highcharts.dateFormat("%e.%b",Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()))}g.push(f+" - "+l)}}}}}function showGuage(a,f,e,b,g){if(typeof g==="undefined"){}else{$("#"+a).html("<div class='text-center v-middle opa-half'><img src='../flatfull/img/ajax-loader-cursor.gif' style='width:12px;height:10px;opacity:0.5;' /></div>")}var d;var c=[];if(f>e){c[0]=e}else{c[0]=f}setupCharts(function(){d=new Highcharts.Chart({chart:{type:"solidgauge",renderTo:a,marginBottom:50},title:null,pane:{center:["50%","85%"],size:"100%",startAngle:-90,endAngle:90,background:{backgroundColor:(Highcharts.theme&&Highcharts.theme.background2)||"#EEE",innerRadius:"60%",outerRadius:"100%",shape:"arc"}},tooltip:{formatter:function(){if(a=="amount_goals_chart"){return'<div><div class="p-n">Revenue: <b>'+getCurrencySymbolForCharts()+""+getNumberWithCommasForCharts(f)+'</b></div></div><div class="p-n">Goals set: <b>'+getCurrencySymbolForCharts()+""+getNumberWithCommasForCharts(e)+"</b></div>"
}else{return'<div><div class="p-n">Won Deals: <b>'+getNumberWithCommasForCharts(f)+'</b></div></div><div class="p-n">Goals set: <b>'+getNumberWithCommasForCharts(e)+"</b></div>"}},useHTML:true,},yAxis:{lineWidth:0,minorTickInterval:null,tickPixelInterval:null,tickInterval:e,tickWidth:0,maxColor:"#000000",title:{y:-150,text:b},labels:{y:16},min:0,max:e,gridLineWidth:0},plotOptions:{series:{dataLabels:{enabled:true,useHTML:true,borderWidth:0,y:-60,formatter:function(){var j=(f/e)*100;if(j>100){j=100}var h='<div class="text-center m-b-lg" style="font-size:20px">'+Math.round(j)+"%</div>";if(a=="amount_goals_chart"){h=h+'<div class="text-center"><span style="font-size:25px;color:black">'+getCurrencySymbolForCharts()+""+getNumberWithCommasForCharts(f)+"</span></div>"}else{h=h+'<div class="text-center"><span style="font-size:25px;color:black">'+getNumberWithCommasForCharts(f)+"</span></div>"}return h}},},},series:[{name:"Goal",data:c,}]})})}function showFunnelForConversion(a,c,d,b){setupCharts(function(){var e=[];$.each(b,function(h,g){var f=[];f.push(h,g);e.push(f)});console.log(e);chart=new Highcharts.Chart({chart:{type:"funnel",marginRight:100,renderTo:a},title:{text:c,x:-50},plotOptions:{series:{dataLabels:{enabled:true,format:"<b>{point.name}</b> ({point.y:,.0f})",color:"#ccc",softConnector:true},neckWidth:"30%",neckHeight:"25%",borderWidth:0}},tooltip:{formatter:function(){var f=0;if(this.point.x==0){f=100}if(this.point.x!=0&&e[this.point.x-1][1]!=0){f=(e[this.point.x][1]/e[this.point.x-1][1])*100}return'<div><div class="p-n">'+this.point.name+'</div><div class="p-n">'+this.series.name+": "+getNumberWithCommasForCharts(this.point.y)+'</div></div><div class="p-n">'+Math.round(f)+"%</div>"},shared:true,useHTML:true,},legend:{enabled:false},series:[{name:"Deals",data:e}],noData:{style:{fontSize:"14px",fontWeight:"normal",color:"#98A6AD"},},})})}function BubbleChart(c,a,b,e){var d;setupCharts(function(){fetchReportData(c,function(l){var g=["circle","triangle","square","diamond","triangle-down"];var n;var f=[];var h=0;var p=1;var m=[];var r=[];var o=0;var k=[];var j=[];$.each(l,function(t,s){k.push(s);$.each(s,function(v,u){j.push(v)})});j.sort();var q={};$.each(j,function(s,t){$.each(k,function(v,u){if(u[""+t]!=undefined){q[""+t]=u[""+t]}})});$.each(q,function(t,s){$.each(s,function(x,w){var v={};var u={};u.name=t;u.data=[];v.name=t;v.data=[];m[o]=v;r[o]=u;o++});$.each(s,function(y,x){var v=0;var w;var u=0;$.each(x,function(D,C){var B=find_series_with_name(m,t);var z=find_series_with_name(r,t);z.data.push(C);var A="";v=v+C;if(u==0){if(C!=0){A=100}else{A=0}}else{if(w!=0){A=(C*100)/w}else{A=0}}w=C;u++;B.data.push(A)})});if(n==undefined){n=[];$.each(s,function(v,u){$.each(u,function(x,w){n.push(x)})})}});if(n!=undefined){if(Math.ceil(n.length/10)>0){p=Math.ceil(n.length/10);if(p==3){p=4}}}d=new Highcharts.Chart({chart:{renderTo:a,type:"scatter",marginRight:130,marginBottom:80,inverted:true,},title:{text:b,x:-20},plotOptions:{series:{marker:{radius:6,}}},xAxis:{lineWidth:2,categories:n,tickmarkPlacement:"on",tickWidth:1,labels:{x:-20,formatter:function(){var t=this.value;var s=t.length>9?t.substring(0,9)+"...":t;return'<div style="width:50px; overflow:hidden" title="'+t+'">'+s+"</div>"},useHTML:true}},yAxis:{title:{text:"Percentage"},plotLines:[{value:0,width:1,color:"#808080"}],min:0,max:100},tooltip:{useHTML:true,formatter:function(){var t=this;var u;$.each(r,function(x,w){if(r[x]["name"]==t.series.name){u=r[x];return false}});var s=0;if(u.data[0]!=0){s=(u.data[this.point.x]/u.data[0])*100}return'<div><div class="p-n">'+this.x+'</div><div class="p-n text-cap"><font color='+this.series.color+">"+this.series.name+"</font>: <b>"+Math.round(this.point.y)+'%</b></div><div class="p-n">'+Math.round(s)+"% of <b>"+n[0]+'</b></div></div><div class="p-n">Deals: <b>'+getNumberWithCommasForCharts(u.data[this.point.x])+"</b></div>"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom",x:-10,borderWidth:0,},series:m,})})})}$("body").on("click",".agent-popup-alert-dismiss",function(a){_agile_set_prefs("CHORME_EXTENSION_DOWNLOAD",false);$("#chrome_extension").remove()});var dealrelatedView;var dealNotesView;var dealActivitiesView;var existingDealDocumentsView;var dealTasksView;var dealEventsView;var deal_details_tab={loadDealRelatedContactsView:function(){var a=App_Deal_Details.dealDetailView.model.id;if(a){dealrelatedView=new Base_Collection_View({url:"/core/api/opportunity/"+a+"/related_to",templateKey:"deal-related",individual_tag_name:"tr",sortKey:"created_time",cursor:true,descending:true,postRenderCallback:function(b){contactListener()}});dealrelatedView.collection.fetch();$("#dealrelated").html(dealrelatedView.el)}},load_deal_notes:function(){var a=App_Deal_Details.dealDetailView.model.id;if(a){dealNotesView=new Base_Collection_View({url:"/core/api/opportunity/"+a+"/notes",restKey:"note",templateKey:"deal-notes",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(b){agileTimeAgoWithLngConversion($(".note-created-time",b))}});dealNotesView.collection.fetch();$("#dealnotes").html(dealNotesView.el)}},load_deal_docs:function(){var a=App_Deal_Details.dealDetailView.model.id;if(a){dealDocsView=new Base_Collection_View({url:"/core/api/documents/opportunity/"+a+"/docs",restKey:"document",templateKey:"deal-docs",individual_tag_name:"li",sortKey:"uploaded_time",descending:true,postRenderCallback:function(b){agileTimeAgoWithLngConversion($(".document-created-time",b))}});dealDocsView.collection.fetch();$("#dealdocs").html(dealDocsView.el)}},load_deal_activities:function(){var a=App_Deal_Details.dealDetailView.model.id;if(a){dealActivitiesView=new Base_Collection_View({url:"/core/api/opportunity/"+a+"/activities",templateKey:"deal-detail-activities",individual_tag_name:"li",scroll_symbol:"scroll",sortKey:"time",descending:true,cursor:true,page_size:20,postRenderCallback:function(b){agileTimeAgoWithLngConversion($(".note-created-time",b))}});dealActivitiesView.collection.fetch();$("#dealactivities").html(dealActivitiesView.el)}},load_deal_tasks:function(){var a=App_Deal_Details.dealDetailView.model.id;if(a){dealTasksView=new Base_Collection_View({url:"/core/api/opportunity/"+a+"/tasks",restKey:"task",templateKey:"deal-tasks",individual_tag_name:"li",sortKey:"id",descending:true,postRenderCallback:function(b){agileTimeAgoWithLngConversion($(".task-created-time",b));$("li",b).each(function(){if($(this).find(".priority_type").text().trim()=="HIGH"){$(this).css("border-left","3px solid #f05050")}else{if($(this).find(".priority_type").text().trim()=="NORMAL"){$(this).css("border-left","3px solid #7266ba")}else{if($(this).find(".priority_type").text().trim()=="LOW"){$(this).css("border-left","3px solid #fad733")}}}})}});dealTasksView.collection.fetch();$("#dealtasks").html(dealTasksView.el)}},load_deal_events:function(){var a=App_Deal_Details.dealDetailView.model.id;if(a){dealEventsView=new Base_Collection_View({url:"/core/api/opportunity/"+a+"/events",restKey:"event",templateKey:"deal-events",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(b){agileTimeAgoWithLngConversion($(".event-created-time",b));$("li",b).each(function(){if($(this).find(".priority_type").text().trim()=="High"){$(this).css("border-left","3px solid #f05050")}else{if($(this).find(".priority_type").text().trim()=="Normal"){$(this).css("border-left","3px solid #7266ba")}else{if($(this).find(".priority_type").text().trim()=="Low"){$(this).css("border-left","3px solid #fad733")}}}})}});dealEventsView.collection.fetch();$("#dealevents").html(dealEventsView.el)}},};function existing_deal_document_attach(a,e){var b=existingDealDocumentsView.collection.get(a).toJSON();var c=App_Deal_Details.dealDetailView.model.id+"";if((b.deal_ids).indexOf(c)<0){b.deal_ids.push(c);saveDocument(null,null,e,false,b)}else{var d=_agile_get_translated_val("misc-keys","link-already");e.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>"+d+"</span>");e.closest("span").find("span.save-status").find("span").fadeOut(5000);return}}function initilizeDealNotesListeners(){$("#deal-note-modal").off("hidden.bs.modal");$("#deal-note-modal").on("hidden.bs.modal",function(){$("#dealnoteForm").find("li").remove();$("#from_task","#dealnoteForm").val("");$("#task_form","#dealnoteForm").val("");$("#subject","#dealnoteForm").val("");$("#description","#dealnoteForm").val("");remove_validation_errors("dealnoteModal")})}function saveDealNote(d,c,a,b){initilizeDealNotesListeners();console.log(b);var e=new Backbone.Model();e.url="core/api/opportunity/deals/notes";e.save(b,{success:function(f){enable_save_button($(a));d.each(function(){this.reset()});c.modal("hide");App_Deal_Details.dealDetailView.model=f;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+f.toJSON().id,{trigger:true})},error:function(f,g){enable_save_button($(a));c.find("span.error-status").html("<i style='color:#B94A48;'>"+g.responseText+"</i>");setTimeout(function(){c.find("span.error-status").html("")},2000);console.log("-----------------",g.responseText)}})}function saveDealUpdateNote(d,c,a,b){console.log(b);var e=new Backbone.Model();e.url="core/api/opportunity/deals/notes";e.save(b,{success:function(f){enable_save_button($(a));d.each(function(){this.reset()});c.modal("hide");App_Deal_Details.dealDetailView.model=f;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+f.toJSON().id,{trigger:true})},error:function(f,g){enable_save_button($(a));c.find("span.error-status").html("<i style='color:#B94A48;'>"+g.responseText+"</i>");setTimeout(function(){c.find("span.error-status").html("")},2000);console.log("-----------------",g.responseText)}})}function inlineDealNameChange(b){var c=$("#inline-input").val();var a=$("#deals-inline").text();name=c.trim();if(!name){$("#inline-input").addClass("error-inputfield");return}if(a!=name){name=name.trim();dealNameEdit(name)}else{$("#inline-input").addClass("hidden");
$("#deals-inline").removeClass("hidden");return}}var deal_tab_position_cookie_name="deal_tab_position";var id;var Deal_Modal_Event_View=Base_Model_View.extend({events:{'click #deal-details-tab a[href="#dealnotes"]':"openDealNotes",'click #deal-details-tab a[href="#dealrelated"]':"openDealContacts",'click #deal-details-tab a[href="#dealactivities"]':"openDealActivities",'click #deal-details-tab a[href="#dealdocs"]':"openDealDocs",'click #deal-details-tab a[href="#dealtasks"]':"openDealTasks",'click #deal-details-tab a[href="#dealevents"]':"openDealEvents","click #deal-owner":"showOwnerList","click #opportunity-actions-delete":"opportunityDelete","click .deal-edit-note":"dealNoteEdit","click .activity-delete":"deleteActivity","click #dealshow-note":"dealShowNoteModal","click .deal-owner-list":"openDealOwnersList","click .deal-add-contact":"addDealContact","click .deal-detail-edit-deal":"editDeal","click .deal-note":"showDealNote","click #dealdetail-archive":"dealArchive","click .deal-restore-detail-view":"dealRestoreView","click .document-edit-deal-tab":"dealDocumentEdit","click .document-unlink-deal-tab":"dealUnlinkDocument","click .add-deal-document-select":"dealDocumentsList","click .add-deal-document-confirm":"dealAddDocumentConfirm","click .add-deal-document-cancel":"dealAddDocumentCancel","click .deal-add-task":"dealAddtask","click .task-edit-deal-tab":"dealEditTask","click .deal-task-delete":"dealDeleteTask","click .complete-deal-task":"dealCompleteTask","click .deal-add-event":"dealAddEvent","click .event-edit-deal-tab":"dealEditEvent","click .deal-event-delete":"dealEditDelete","click .activity-delete":"deleteActivity","click #add-tags":"onAddDealTag","click .remove-tags":"onRemoveDealTag","click #deal-add-tags":"onAddDealTags","click #deals-inline":"dealInlineEdit","blur #inline-input":"dealinlineedit","keydown #inline-input":"dealNameChange"},dealinlineedit:function(a){inlineDealNameChange()},dealNameChange:function(a){if(a.keyCode==13){inlineDealNameChange()}},dealInlineEdit:function(a){a.preventDefault();$("#deals-inline").toggleClass("hidden");$("#inline-input").toggleClass("hidden");if(!$("#inline-input").hasClass("hidden")){$("#inline-input").focus()}},onAddDealTag:function(a){a.preventDefault();$(a.currentTarget).css("display","none");$("#addTagsForm").removeClass("hidden");$("#addTagsForm").css("display","block");$("#addTags").focus();setup_tags_typeahead()},onRemoveDealTag:function(f){f.preventDefault();var g=$(f.currentTarget);var a=$(g).attr("tag");var h=App_Deal_Details.dealDetailView.model.id;var b=App_Deal_Details.dealDetailView.model.toJSON();var c=g;$(g).unbind("click");var d=new Backbone.Model();d.url="core/api/opportunity/deleteDealTag?tag="+a+"&id="+h;d.save(b,{success:function(e){$(c).closest("li").parent("ul").find(".loading").remove();$(c).closest("li").remove();App_Deal_Details.dealDetailView.model.set(e.toJSON(),{silent:true});App_Deal_Details.dealDetailView.render(true)}})},onAddDealTags:function(c){c.preventDefault();var b=get_new_tags("addTags");if(b){b=b.trim()}if(!b||b.length<=0||(/^\s*$/).test(b)){console.log(b);return}if(!isValidTag(b,true)){return}$("#add-tags").css("display","block");$("#addTagsForm").css("display","none");console.log(b);if(b){var a=App_Deal_Details.dealDetailView.model.toJSON();var d=App_Deal_Details.dealDetailView.model.id;$("#addTagsForm input").each(function(){$(c.currentTarget).val("")});if($.inArray(b,a.tags)>=0){$("#addTagsForm").css("display","none");$("#add-tags").css("display","block");$("#addTags").val("");return}acl_util.canAddTag(b.toString(),function(e){a.tagsWithTime.push({tag:b.toString()});var f=new Backbone.Model();f.url="core/api/opportunity/AddDealTag?tag="+b+"&id="+d;f.save(a,{success:function(g){App_Deal_Details.dealDetailView.model.set(g.toJSON(),{silent:true});App_Deal_Details.dealDetailView.render(true);console.log(b);saveDealTag(b);tagsCollection.add(new BaseModel({tag:b}))},error:function(h,g){console.log(g);alert(g.responseText)}})})}},openDealNotes:function(a){a.preventDefault();save_deal_tab_position_in_cookie("dealnotes");deal_details_tab.load_deal_notes()},deleteActivity:function(a){a.preventDefault();Contact_Details_Tab_Actions.deleteActivity(a)},openDealContacts:function(a){a.preventDefault();save_deal_tab_position_in_cookie("dealrelated");deal_details_tab.loadDealRelatedContactsView()},openDealActivities:function(a){a.preventDefault();save_deal_tab_position_in_cookie("dealactivities");deal_details_tab.load_deal_activities()},openDealDocs:function(a){a.preventDefault();save_deal_tab_position_in_cookie("dealdocs");deal_details_tab.load_deal_docs()},openDealTasks:function(a){a.preventDefault();save_deal_tab_position_in_cookie("dealtasks");deal_details_tab.load_deal_tasks()},openDealEvents:function(a){a.preventDefault();save_deal_tab_position_in_cookie("dealevents");deal_details_tab.load_deal_events()},deleteActivity:function(a){a.preventDefault();Contact_Details_Tab_Actions.deleteActivity(a)},showOwnerList:function(a){a.preventDefault();fill_deal_owners(undefined,undefined,function(){if(hasScope("UPDATE_DEALS")||$(this).attr("data")==CURRENT_DOMAIN_USER.id){$("#deal-owner").css("display","none")}else{$("#deal_update_privileges_error_modal").modal("show")}$("#change-deal-owner-ul").css("display","inline-block");if($("#change-deal-owner-ul").css("display")=="inline-block"){$("#change-owner-element").find(".loading").remove()}})},opportunityDelete:function(a){a.preventDefault();showAlertModal("delete_opportunity","confirm",function(){var b=$(a.currentTarget);var c=$(b).closest(".deal_detail_delete").attr("data");$.ajax({url:"core/api/opportunity/"+c,type:"DELETE",success:function(d){Backbone.history.navigate("#deals",{trigger:true})},error:function(d){showAlertModal(d.responseText,undefined,undefined,undefined,"Error")}})})},dealNoteEdit:function(b){b.preventDefault();var c=$(b.currentTarget);var a=dealNotesView.collection.get($(c).attr("data"));console.log(a);deserializeForm(a.toJSON(),$("#dealnoteUpdateForm",$("#dealnoteupdatemodal")));fill_relation_deal($("#dealnoteUpdateForm"));$("#dealnoteupdatemodal").modal("show")},dealShowNoteModal:function(a){if(App_Deal_Details.dealDetailView.model.get("archived")==true){return}a.preventDefault();$("#deal-note-modal").modal("show")},openDealOwnersList:function(f){$("#change-deal-owner-ul").css("display","none");var g=$(f.currentTarget);var a=$(g).attr("data");var b=$(g).text();var d=$("#deal-owner").attr("data");if(a==d){show_deal_owner();return}var c=new BaseModel();c.url="/core/api/opportunity/change-owner/"+a+"/"+App_Deal_Details.dealDetailView.model.get("id");c.save(App_Deal_Details.dealDetailView.model.toJSON(),{success:function(e){$("#deal-owner").text(b);$("#deal-owner").attr("data",a);show_deal_owner();App_Deal_Details.dealDetailView.model=e;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+e.toJSON().id,{trigger:true})}})},addDealContact:function(a){a.preventDefault();console.log(App_Deal_Details.dealDetailView.model.toJSON());var b=App_Deal_Details.dealDetailView.model;updateDeal(b);$("#opportunityUpdateModal").addClass("focusRelatedTo")},editDeal:function(a){a.preventDefault();console.log(App_Deal_Details.dealDetailView.model.toJSON());var b=App_Deal_Details.dealDetailView.model;updateDeal(b);setup_tags_typeahead()},showDealNote:function(b){b.preventDefault();var a=$("#dealnoteForm");fill_relation_deal(a);$("#deal-note-modal").modal("show")},dealArchive:function(b){b.preventDefault();var a=App_Deal_Details.dealDetailView.model.toJSON();$("#archived-deal-id",$("#deal_archive_confirm_modal")).val(a.id);$("#archived-deal-milestone",$("#deal_archive_confirm_modal")).val(a.milestone);$("#deal_archive_confirm_modal").modal("show")},dealRestoreView:function(b){b.preventDefault();var a=App_Deal_Details.dealDetailView.model.toJSON();$("#restored-deal-id",$("#deal_restore_confirm_modal")).val(a.id);$("#restored-deal-milestone",$("#deal_restore_confirm_modal")).val(a.milestone);$("#deal_restore_confirm_modal").modal("show")},dealDocumentEdit:function(a){a.preventDefault();var b=$(a.currentTarget);var c=$(b).attr("data");updateDocument(dealDocsView.collection.get(c))},dealUnlinkDocument:function(d){d.preventDefault();var f=$(d.currentTarget);var g=$(f).attr("data");var b=dealDocsView.collection.get(g).toJSON();var c=App_Deal_Details.dealDetailView.model.id+"";b.deal_ids.splice(b.deal_ids.indexOf(c),1);var a=new Backbone.Model();a.url="core/api/documents";a.save(b,{success:function(e){dealDocsView.collection.remove(b);dealDocsView.render(true)},error:function(h,e){showModalConfirmation("Delete <span class='text-cap'>"+h.get("entity_type")+"</span>","<span>"+e.responseText.replace("attached","detached")+"</span>",function(){return},function(){return},function(){return},"Cancel");return}})},dealDocumentsList:function(d){d.preventDefault();var f=$(d.currentTarget);var c=$(f).closest("div");$(f).css("display","none");c.find(".deal-document-select").css("display","block");var a="<option value='{{id}}'>{{name}}</option>";fillSelect("document-select","core/api/documents","documents",function b(){var e=_agile_get_translated_val("misc-keys","add-new-doc");c.find("#document-select > option:first").after("<option value='new'>"+e+"</option><option style='font-size: 1pt; background-color: #EDF1F2;'disabled>&nbsp;</option>");c.find("#document-select > option:first").remove()},a,false,c)},dealAddDocumentConfirm:function(f){f.preventDefault();var k=$(f.currentTarget);var c=$(k).closest(".deal-document-select").find("#document-select").val();var g=$(k);if(c==""){var b=_agile_get_translated_val("validation-msgs","this-field-is-required");g.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>"+b+"</span>");g.closest("span").find("span.save-status").find("span").fadeOut(5000);return}else{if(c=="new"){$("#uploadDocumentModal").html(getTemplate("upload-document-modal",{})).modal("show");var a=$("#uploadDocumentForm");agile_type_ahead("document_relates_to_contacts",a,contacts_typeahead);
agile_type_ahead("document_relates_to_deals",a,deals_typeahead,false,null,null,"core/api/search/deals",false,true);var d=App_Deal_Details.dealDetailView.model.toJSON();var h=d.name;var j=Handlebars.compile('<li class="tag"  style="display: inline-block; vertical-align: middle; margin-right:3px;" data="{{id}}">{{name}}</li>');$(".deal_tags",a).html(j({name:h,id:d.id}))}else{if(c!=undefined&&c!=null){if(!existingDealDocumentsView){existingDealDocumentsView=new Base_Collection_View({url:"core/api/documents",restKey:"documents",});existingDealDocumentsView.collection.fetch({success:function(e){existing_deal_document_attach(c,g)}})}else{existing_deal_document_attach(c,g)}}}}},dealAddDocumentCancel:function(b){b.preventDefault();var c=$(b.currentTarget);var a=$(c).closest("div");a.find(".deal-document-select").css("display","none");a.find(".add-deal-document-select").css("display","inline")},dealAddtask:function(b){b.preventDefault();$("#activityTaskModal").html(getTemplate("new-task-modal")).modal("show");var a=$("#taskForm");highlight_task();fill_relation_deal_task(a);agile_type_ahead("task_related_to",a,contacts_typeahead);agile_type_ahead("task_relates_to_deals",a,deals_typeahead,false,null,null,"core/api/search/deals",false,true);categories.getCategoriesHtml(undefined,function(c){$("#type",a).html(c);populateUsers("owners-list",$("#taskForm"),undefined,undefined,function(d){$("#taskForm").find("#owners-list").html(d);$("#owners-list",a).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#taskForm")).closest("div").find(".loading-img").hide()})});activateSliderAndTimerToTaskModal()},dealEditTask:function(b){b.preventDefault();var c=$(b.currentTarget);var d=$(c).attr("data");var a=dealTasksView.collection.get(d).toJSON();$("#updateTaskModal").html(getTemplate("task-update-modal")).modal("show");loadProgressSlider($("#updateTaskForm"),function(e){deserializeForm(a,$("#updateTaskForm"));$(".update-task-timepicker").val(fillTimePicker(a.due));agile_type_ahead("task_relates_to_deals",e,deals_typeahead,false,null,null,"core/api/search/deals",false,true);categories.getCategoriesHtml(a,function(f){$("#type",e).html(f);populateUsers("owners-list",$("#updateTaskForm"),a,"taskOwner",function(g){$("#updateTaskForm").find("#owners-list").html(g);if(a.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+a.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()})});showNoteOnForm("updateTaskForm",a.notes)})},dealDeleteTask:function(b){b.preventDefault();var c=$(b.currentTarget);var a=$(c).parents("li").data();if(a&&(a.toJSON().type!="WEB_APPOINTMENT"||parseInt(a.toJSON().start)<parseInt(new Date().getTime()/1000))){showAlertModal("delete","confirm",function(){modelDelete(a,c,function(){if(dealTasksView&&dealTasksView.collection.length==0){$("#dealtasks").html(dealTasksView.render(true).el)}})});return}modelDelete(a,c,function(){if(dealTasksView&&dealTasksView.collection.length==0){$("#dealtasks").html(dealTasksView.render(true).el)}})},dealCompleteTask:function(b){b.preventDefault();var c=$(b.currentTarget);if($(c).is(":checked")){var d=$(c).attr("data");var a=c;complete_task(d,dealTasksView.collection,undefined,function(e){$(a).parent().siblings(".task-subject").css("text-decoration","line-through");console.log($(a).parents(".activity-text-block").css("background-color","#FFFAFA"));$(a).parent().replaceWith('<span style="margin-right:9px;"><i class="fa fa-check"></i></span>');dealTasksView.collection.add(e,{silent:true})})}},dealAddEvent:function(b){b.preventDefault();$("#activityModal").html(getTemplate("new-event-modal")).modal("show");var a=$("#activityForm");highlight_event();fill_relation_deal_task(a);agile_type_ahead("event_related_to",a,contacts_typeahead);agile_type_ahead("task_relates_to_deals",a,deals_typeahead,false,null,null,"core/api/search/deals",false,true)},dealEditEvent:function(f){f.preventDefault();var h=$(f.currentTarget);$("#updateActivityModal").html(getTemplate("update-activity-modal"));var j=$(h).attr("data");var c=dealEventsView.collection.get(j).toJSON();deserializeForm(c,$("#updateActivityForm"));$(".update-start-timepicker").val(fillTimePicker(c.start));$(".update-end-timepicker").val(fillTimePicker(c.end));$("#updateActivityModal").modal("show");if(c.type=="WEB_APPOINTMENT"&&parseInt(c.start)>parseInt(new Date().getTime()/1000)){$("[id='event_delete']").attr("id","delete_web_event");web_event_title=c.title;if(c.contacts.length>0){var d=getPropertyValue(c.contacts[0].properties,"first_name");if(d==undefined){d=""}var b=getPropertyValue(c.contacts[0].properties,"last_name");if(b==undefined){b=""}web_event_contact_name=d+" "+b}}else{$("[id='delete_web_event']").attr("id","event_delete")}if(c.description){var a='<label class="control-label"><b>'+_agile_get_translated_val("misc-keys","description")+' </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div>';$("#event_desc").html(a);$("textarea#description").val(c.description)}else{var g='<div class="row-fluid"><div class="control-group form-group m-b-none"><a href="#" id="add_event_desctiption"><i class="icon-plus"></i> '+_agile_get_translated_val("misc-keys","add-description")+' </a><div class="controls event_discription hide"><textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div></div></div>';$("#event_desc").html(g)}populateUsersInUpdateActivityModal(c)},dealEditDelete:function(c){c.preventDefault();var d=$(c.currentTarget);var b=$(d).parents("li").data();var a=b.get("owner_id");if(!a&&b.get("owner")){a=b.get("owner").id}if(!hasScope("MANAGE_CALENDAR")&&(CURRENT_DOMAIN_USER.id!=a)&&b.get("entity_type")&&b.get("entity_type")=="event"){$("#deleteEventErrorModal").html(getTemplate("delete-event-error-modal")).modal("show");return}if(b&&(b.toJSON().type!="WEB_APPOINTMENT"||parseInt(b.toJSON().start)<parseInt(new Date().getTime()/1000))){showAlertModal("delete","confirm",function(){modelDelete(b,d,function(){if(dealEventsView&&dealEventsView.collection.length==0){$("#dealevents").html(dealEventsView.render(true).el)}})});return}modelDelete(b,d,function(){if(dealEventsView&&dealEventsView.collection.length==0){$("#dealevents").html(dealEventsView.render(true).el)}})},});function save_deal_tab_position_in_cookie(b){var a=_agile_get_prefs(deal_tab_position_cookie_name);if(a==b){return}_agile_set_prefs(deal_tab_position_cookie_name,b)}function load_deal_tab(b,c){var a=_agile_get_prefs(deal_tab_position_cookie_name);if(a){if(a=="dealactivities"){$('#deal-details-tab a[href="#dealactivities"]',b).tab("show");deal_details_tab.load_deal_activities()}else{if(a=="dealrelated"){$('#deal-details-tab a[href="#dealrelated"]',b).tab("show");deal_details_tab.loadDealRelatedContactsView()}else{if(a=="dealnotes"){$('#deal-details-tab a[href="#dealnotes"]',b).tab("show");deal_details_tab.load_deal_notes()}else{if(a=="dealdocs"){$('#deal-details-tab a[href="#dealdocs"]',b).tab("show");deal_details_tab.load_deal_docs()}else{if(a=="dealtasks"){$('#deal-details-tab a[href="#dealtasks"]',b).tab("show");deal_details_tab.load_deal_tasks()}else{if(a=="dealevents"){$('#deal-details-tab a[href="#dealevents"]',b).tab("show");deal_details_tab.load_deal_events()}}}}}}}else{$('#deal-details-tab a[href="#dealactivities"]',b).tab("show");deal_details_tab.load_deal_activities()}}$(function(){$("#deal-note-modal").on("click","#dealnote_validate",function(b){b.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm("#dealnoteForm")){return}disable_save_button($(this));var a=serializeForm("dealnoteForm");console.log(a);saveDealNote($("#dealnoteForm"),$("#deal-note-modal"),this,a)});$("#dealnoteupdatemodal").on("click","#dealnote_update",function(b){b.preventDefault();if($(this).attr("disabled")){return}disable_save_button($(this));if(!isValidForm("#dealnoteUpdateForm")){enable_save_button($(this));return}var a=serializeForm("dealnoteUpdateForm");saveDealUpdateNote($("#dealnoteUpdateForm"),$("#dealnoteupdatemodal"),this,a)})});function initializeThemeSettingsListeners(){$("#theme-and-layout").on("click","#saveTheme",function(d){d.preventDefault();$(".theme-save-status").css("display","none");var c=$(this);if($(c).attr("disabled")){return}disable_save_button($(c));var a=$(this).closest("form").attr("id");if(!isValidForm("#"+a)){enable_save_button($(c));return false}var b=serializeForm(a);console.log("theme_info"+b);$.ajax({url:"/core/api/user-prefs/saveTheme",type:"PUT",data:b,success:function(){enable_save_button($(c))},error:function(){enable_save_button($(c))}})});$("#theme-and-layout").on("change","#menuPosition",function(a){CURRENT_USER_PREFS.menuPosition=$(this).val();$(".theme-save-status").css("display","inline");if($(this).val()=="top"){$(".app").addClass("app-aside-dock");$(".fixedicons#planView,.fixedicons#helpView").removeClass("fixedicons").addClass("dockedicons")}else{$(".app").removeClass("app-aside-dock");$(".dockedicons#planView,.dockedicons#helpView").removeClass("dockedicons").addClass("fixedicons");var b=$("#aside").offset();$(".fixedicons#planView,.fixedicons#helpView").css("left",b.left);if($(this).val()=="left"){$("#wrap").removeClass("app-aside-folded")}else{if($(this).val()=="leftcol"){$("#wrap").addClass("app-aside-folded")}}}});$("#theme-and-layout").on("change","#layout",function(a){CURRENT_USER_PREFS.layout=$(this).val();$(".theme-save-status").css("display","inline");if($(this).val()=="fluid"){$(".app").removeClass("container");var b=$("#aside").offset();$(".fixedicons#planView,.fixedicons#helpView").css("left",b.left)}else{if($(this).val()=="fixed"){$(".app").addClass("container");var b=$("#aside").offset();$(".fixedicons#planView,.fixedicons#helpView").css("left",b.left)
}}});$("#theme-and-layout").on("change","#animations",function(a){CURRENT_USER_PREFS.animations=$(this).is(":checked");$(".theme-save-status").css("display","inline");if($(this).is(":checked")){$("body").removeClass("disable-anim");$("#theme-and-layout").removeClass("custom-animated")}else{$("body").addClass("disable-anim")}});$("#theme-and-layout").on("change",".magicMenu input:radio",function(c){CURRENT_USER_PREFS.theme=$(this).val();$(".theme-save-status").css("display","inline");var b=$(this).attr("target-aside-class");var a=$(this).attr("target-logo-class");var d=$(this).attr("target-topbar-class");$(".app-aside,#navbar,.navbar-header, .grid_icon_center").removeClassPrefix("bg-").removeClass("dk").removeClass("dker").removeClass("b-r");$(".app-aside").addClass(b);$(".navbar-header").addClass(a);$("#navbar").addClass(d);$(".grid_icon_center").addClass(d)})}$(function(){$.fn.removeClassPrefix=function(a){this.each(function(c,d){var b=d.className.split(" ").filter(function(e){return e.trim().lastIndexOf(a,0)!==0});d.className=$.trim(b.join(" "))});return this}});$("#mobile-menu").on("click",function(){$("#aside").toggleClass("off-screen")});$("#mobile-menu-settings").on("click",function(){$("#navbar").toggleClass("show")});$("#app-aside-folded").on("click",function(a){a.preventDefault();$("#wrap").toggleClass("app-aside-folded");if($("#wrap").hasClass("app-aside-folded")){console.log("folded");$("#app-aside-folded i").removeClass("fa-dedent");$("#app-aside-folded i").addClass("fa-indent")}else{$("#app-aside-folded i").removeClass("fa-indent");$("#app-aside-folded i").addClass("fa-dedent")}$(".highcharts-container").each(function(b){$(this).parent().highcharts().reflow()})});function showTrailAlertMessage(){if($("#trial_alert_info .trial_message").text().indexOf("today")!=-1){$("#trial_alert_info").css("width","300px")}$("#trial_alert_info").show()}$(document).ready(function(){$(".trial_strip_close").click(function(f){$(this).closest("#trial_alert_info").hide();_agile_set_prefs("free_trial_time",parseInt(new Date().getTime()/1000))});$("#clickdesk_live_chat").click(function(f){f.preventDefault();$(this).closest(".dropdown").removeClass("open");CLICKDESK_LIVECHAT.show()});if(!agile_is_mobile_browser()&&USER_BILLING_PREFS.freeTrialStatus&&USER_BILLING_PREFS.freeTrialStatus=="TRIALING"&&USER_BILLING_PREFS.freeTrialEnd>parseInt(new Date().getTime()/1000)){var d=_agile_get_prefs("free_trial_time");var b=parseInt(new Date().getTime()/1000);if(!d){showTrailAlertMessage()}else{if(b-d>86400){showTrailAlertMessage()}}}$(".free_plan_strip_close").click(function(f){$(this).closest(".free_plan_alert").hide().removeAttr("id")});$("#addDescriptionLink").click(function(f){f.preventDefault();$(this).hide();$("#addDescriptionInfo").toggle()});$("#activityTaskModal").on("click","#taskDescriptionLink",function(f){f.preventDefault();$(this).hide();$("#taskDescriptionInfo").toggle()});$("#activityModal").on("click","#eventDescriptionLink",function(f){f.preventDefault();$(this).hide();$(".eventDescriptionInfo").toggle()});$("#contact-results li").click(function(){$("#mobile-menu-settings").trigger("click")});$(".aside-wrap").off("ul li");if(agile_is_mobile_browser()){$("body").on("click",".add-modal-mobile",function(){if($("#aside").hasClass("off-screen")){$("#mobile-menu").trigger("click")}});$("#search-menu-mobile").on("click touchstart",function(){$(".search-mobile").removeClass("hide");$(".add-modal-mobile , #search-menu-mobile").removeClass("visible-xs");$(".navbar-brand").addClass("hide")});$(".aside-wrap").on("touchstart","ul li",function(){$(".aside-wrap ul li").removeClass("active");$(this).addClass("active")});$(".aside-wrap").on("touchleave touchend","ul li",function(){setTimeout(function(){$(".aside-wrap ul li").removeClass("active")},500)})}if(($(window).width())<768){$(".content-tabs").tabCollapse();$(".nav-tabs a").click(function(f){f.preventDefault();$(this).tab("show")});$("#navbar").removeClass("bg-white-only");$("body").on("mousedown",".navi-wrap li a , #navbar li a",function(f){f.preventDefault();$(this).css("opacity","0.5")});$("body").on("mouseup",".navi-wrap li a , #navbar li a",function(f){f.preventDefault();$(this).css("opacity","1")});$("body").on("touchstart",".magicMenu .i-checks",function(f){f.preventDefault();$(this).find('input[type="radio"]').trigger("click")});$("body").on("touchstart",".i-checks",function(f){f.preventDefault();$(this).find('input[type="checkbox"]').trigger("click")});$("body").on("click","#mobile-menu-settings",function(){if($("#navbar").hasClass("show")){$("body").css("overflow-y","hidden")}else{$("body").css("overflow-y","auto")}});$(".agile-menu .fa-history").removeClass("text-md  text-muted");$("body").on("click",'#navbar li a:not(".dropdown-toggle")',function(){$("body").css("overflow-y","auto")});$("body").on("click",".navbar-brand",function(){$("#navbar").removeClass("show");$("#aside").removeClass("off-screen");$("body").css("overflow-y","auto")});$(".navi-wrap").on("click","li a",function(){$("#mobile-menu").delay(2000).trigger("click")});$("#mobile-menu-settings").on("click",function(){if($("#aside").hasClass("off-screen")){$("#aside").removeClass("off-screen")}});$("#searchText").keyup(function(f){if(f.which==13){$("#mobile-menu-settings").trigger("click")}});$("#searchForm").hover(function(){$("#advanced-search-filter").removeClass("hide")},function(){$("#advanced-search-filter").addClass("hide")});$("#mobile-menu").on("click",function(){if($("#navbar").hasClass("show")){$("#navbar").removeClass("show");$("body").css("overflow-y","auto")}});$("#navbar li a:not(.dropdown-menu)").on("click",function(){if($(this).hasClass("dropdown-toggle")){}else{$("#navbar").removeClass("show")}});$("#documentsmenu span").text("Documents")}$(".person").on("click",function(f){f.preventDefault();addContactBasedOnCustomfields()});$("#referrals_link").on("click",function(f){f.preventDefault();Agile_GA_Event_Tracker.track_event("Refer");load_facebook_lib_for_referrals();$.ajax({url:"core/api/refer",type:"GET",dataType:"json",success:function(e){REFER_DATA=e;getTemplate("refer-modal",{},undefined,function(g){if(!g){return}$("#referModal").html($(g));getTemplate("refer-modal-body",e,undefined,function(h){if(!h){return}$("#referModal").find(".modal-body").html($(h));$("#referModal").modal("show")},null)},null)}})});$("body").on("click",".betaAccess",function(g){$(".model-etensions").addClass("hide");console.log("inside the sending request for the betarequest");var f={};f.from=CURRENT_DOMAIN_USER.email;f.to="narmadha@agilecrm.com";f.subject="Request for getting the Beta Access";f.body="Name: "+CURRENT_DOMAIN_USER.name+"<br>Useremail: "+CURRENT_DOMAIN_USER.email+"<br>Domain: "+CURRENT_DOMAIN_USER.domain;sendEmail(f);$("#betasuccess").removeClass("hide")});$("body").on("click",function(f){$(".popover").each(function(){if((!$(this).is(f.target)&&$(this).has(f.target).length===0&&$(".popover").has(f.target).length===0&&!f.target.closest(".need_help"))||f.target.hasAttribute("rep")){$(this).popover("hide")}})});$("#advanced-search-fields-group a").on("click",function(e){var g=$(e.currentTarget),h=g.find("input");if(!h.closest("li").hasClass("disabled")){h.prop("checked",!h.is(":checked"))}var k=$("#advanced-search-fields-group a input"),f=k.not(h),m=f.closest("li");if(!h.prop("value")){f.prop("checked",h.is(":checked"))}else{var j=(k.not("[value='']").not(":checked").length==0);f.filter("[value='']").prop("checked",j)}$(e.target).blur();var n=k.not("[value='']");var l=k.not("[value='']").filter(":checked").map(function(){return $(this).prop("value")}).get();console.log(l);_agile_set_prefs("agile_search_filter_"+CURRENT_DOMAIN_USER.id,JSON.stringify(l));return false});var c=_agile_get_prefs("agile_search_filter_"+CURRENT_DOMAIN_USER.id),a=$("#advanced-search-fields-group a input");if(!c){c=[]}if(typeof(c)=="string"){c=JSON.parse(c)}$.each(c,function(e,f){a.filter("[value='"+f+"']").prop("checked",true)});if(c.length==0||a.not(":checked").length==1){a.filter("[value='']").closest("a").click()}$(".need_help").popover({placement:$(this).attr("data-placement"),html:true,container:"body"}).on("click",function(){initRolehandlers()}).on("show.bs.popover",function(g){var f=$(g.target);$(this).data("bs.popover").tip().addClass(f.data("custom-popover-class"))});$("#searchText").on("focus",function(){$(this).parent().find("label").toggleClass("active")});$("#searchText").on("blur",function(){$(this).parent().find("label").toggleClass("active")})});function initRolehandlers(){$(".grid_icon_center a.grid-icon-header").removeClass("agile-feature-item-blink");$(".menu-service-select[data-service-name='"+CURRENT_DOMAIN_USER.role+"']").addClass("active");$(".menu-service-select").unbind("click").click(function(g){g.preventDefault();var c=$(this).attr("data-service-name");if(!c){return}var b=$(this).attr("data-dashboard");if(!b){b="dashboard"}var a={};a.id=CURRENT_DOMAIN_USER.id;a.role=c;var d=Backbone.Model.extend({url:"/core/api/users/update-role"});new d().save(a,{success:function(h,e){console.log("success");console.log(h);CURRENT_DOMAIN_USER=h.toJSON()},error:function(h,e){console.log("error")}});$(this).parents(".popover").popover("hide");_agile_set_prefs("dashboard_"+CURRENT_DOMAIN_USER.id,b);var f=$("#due_tasks_count").text();f=f?f:"";$("#agile-menu-navigation-container").html(getTemplate(c.toLowerCase()+"-menu-items",{due_tasks_count:f}));Backbone.history.navigate("#navigate-dashboard",{trigger:true})})}function addContactBasedOnCustomfields(){$.ajax({url:"core/api/custom-fields/required/scope?scope=CONTACT",type:"GET",dataType:"json",success:function(a){if(a.length>0){Backbone.history.navigate("contact-add",{trigger:true})}else{$("#personModal").modal("show")}}})}function push_signup_plan(b){try{if(!window.ga){setTimeout(function(){push_signup_plan(b)},2000);return}ga("send","event","Dashboard","Signup",_plan_on_signup.plan_type,_plan_on_signup.quantity)}catch(a){console.error(a)}}function push_actual_plan(b){try{if(!window.ga){setTimeout(function(){push_actual_plan(b)
},2000);return}ga("send","event","Dashboard","Paid",b.plan_type,b.quantity)}catch(a){console.error(a)}}$(function(){try{if(IS_NEW_USER&&_plan_on_signup){push_signup_plan(_plan_on_signup)}}catch(a){console.log(a)}});$(function(){var e=null;var a=null;var f=null;var c=null;$("body").on("click",".selected_meeting_time",function(g){$("#details").empty();Selected_Time=$(this).attr("data");$(".show_slots").find("input:radio").prop("checked",false);$(this,["input:radio"]).prop("checked",true);appointmenttype=$('input[name="selected_meeting_time"]:checked').val();$(".activemin").removeClass("activemin");$(this).find(".minutes").addClass("activemin");$(".segment2").removeClass("me-disable");$(".segment2").fadeIn("slow");$("#one").addClass("green-bg").html('<i class="fa fa-check"></i>');b(".segment2");var h=typeof InstallTrigger!=="undefined";if(h){$("#datepick").DatePickerSetDate(current_date_mozilla,true)}$(".checkbox-main-grid").html('<img class="loading-img" src="'+updateImageS3Path("../../img/21-0.gif")+'" style="width: 40px;margin-left: 216px;"></img>');if(!selecteddate){selecteddate=new Date();CURRENT_DAY_OPERATION=true}if(selecteddate){get_slots(selecteddate,Selected_Time)}});$("#confirm").click(function(g){g.preventDefault();save_web_event("addEventForm",this)});$("body").on("click",".selected-slot",function(h){var g=$(this).attr("id");$(".selected-slot").each(function(){if($(this).attr("id")!=g){$(this).prop("checked",false)}});enableSegment3();$(".segment3").fadeIn("slow");$("#confirm").show();$("#two").addClass("green-bg").html('<i class="fa fa-check"></i>');b(".segment3")});$("body").on("click","#multi-user-avatar",function(j){$(".thumbnail").css("background","none");$(this).css("background","#4A90E2");$("#users_div").addClass("green-bg").html('<i class="fa fa-check"></i>');var h=$(this).attr("data");if(h!=User_Id){resetToPrevious();if(!d(mapobject)){SELECTED_DOMAIN_USER=mapobject[h];User_Id=SELECTED_DOMAIN_USER.id;Agile_User_Id=SELECTED_DOMAIN_USER.agile_user_id;User_Name=a=SELECTED_DOMAIN_USER.name;meeting_duration=SELECTED_DOMAIN_USER.meeting_durations;meeting_types=SELECTED_DOMAIN_USER.meeting_types;BUFFERTIME=SELECTED_DOMAIN_USER.buffer_time;if(meeting_types[0]!=""){$(".meetingtypes").show();$(".meetingtypes").empty();$(".meetingtypes").append("<option selected disabled>Meeting Type</option>");for(var g=0;g<meeting_types.length;g++){$(".meetingtypes").append("<option value='"+meeting_types[g]+"'>"+meeting_types[g]+"</option>")}}else{$(".meetingtypes").hide()}slot_details=SELECTED_DOMAIN_USER.slot_details;$(".show_slots").hide();getSlotDurations();$(".segment1").fadeIn("slow");$(".panel-body").height(parseInt(getPanelBodyMaxHeight())+26);b(".segment1")}}});$("#user_timezone").change(function(){SELECTED_TIMEZONE=$("#user_timezone").val();if(!selecteddate||!Selected_Time){return}$("#current_local_time").html("Current Time: "+getConvertedTimeFromEpoch(new Date().getTime()/1000));$(".checkbox-main-grid").html('<img class="loading-img" src="'+updateImageS3Path("../../img/21-0.gif")+'" style="width: 40px;margin-left: 216px;"></img>');get_slots(selecteddate,Selected_Time)});function b(g){console.log($(g).offset().top);$("body,html").animate({scrollTop:$(g).offset().top},1000)}function d(h){for(var g in h){if(h.hasOwnProperty(g)){return false}}return true}});function change_availability_date(b){var a=new Date(b);$(".availability").html("Availability on "+a.getDayName()+", "+a.getMonthName()+", "+a.getDate())}function getSlotDurations(){if(multiple_schedule_ids){fillSlotDetails();return}else{if(single_user_mapobject[User_Id].length>0){fillSlotDetails(single_user_mapobject[User_Id]);return}}var a="/core/api/webevents/calendar/getslotdetails?userid="+User_Id;$.getJSON(a,function(h){var c=h;var g=[];if(slot_array&&slot_array.length>0){for(var f=0;f<slot_array.length;f++){if((parseInt(slot_array[f])-1)<h.length&&parseInt(slot_array[f])!=0){g[f]=slot_array[f]}}if(g.length>0){slot_array=[];slot_array=g}else{$(".segment1").append('<div class="col-sm-12" align="center"><p class="lead" style="color: #777;font-size: 19px;text-align: center;font-weight:normal">Please enter valid slot number </p> </div>');return}}if(slot_array&&h.length>=slot_array.length&&slot_array.length>0){h=[];var d=0;for(var f=0;f<slot_array.length;f++){if((parseInt(slot_array[f])-1)<c.length){h[d]=c[parseInt(slot_array[f])-1];d++}}}if(h.length==3){for(var b in h){var e=JSON.parse(h[b]);$(".segment1").append('<div class="col-sm-4 show_slots"><p title="'+e.title+'" class="choose timeslot-view" data="'+e.time+'"><span class="minutes">'+e.time+" mins</span><br />"+addDotsAtEnd(e.title)+"</p></div>")}$(".segment1").append('<div class="clearfix"></div>')}if(h.length==2){for(var b in h){var e=JSON.parse(h[b]);$(".segment1").append('<div class="col-sm-5 col-md-4 show_slots" style="margin-left: 99px;"><p title="'+e.title+'" class="choose" data="'+e.time+'"><span class="minutes">'+e.time+" mins</span><br />"+addDotsAtEnd(e.title)+"</p></div>")}$(".segment1").append('<div class="clearfix"></div>')}if(h.length==1){for(var b in h){var e=JSON.parse(h[b]);$(".segment1").append('<div class="col-sm-12 show_slots" align="center"><p title="'+e.title+'" class="choose" data="'+e.time+'"><span class="minutes">'+e.time+" mins</span><br />"+addDotsAtEnd(e.title)+"</p></div>")}}})}function enableSegment3(){$(".me-disable").removeAttr("disabled");$(".me-disable").removeClass("me-disable")}function resetAll(){var b=new Date();var c=(b.getMonth()+1);if(c<10){c="0"+c}var a=b.getFullYear()+"-"+c+"-"+b.getDate();Selected_Date=a;$("#datepick").DatePickerSetDate(Selected_Date,true);change_availability_date(Selected_Date);$(".checkbox-main-grid").html("");document.getElementById("addEventForm").reset();Available_Slots=null}function get_slots(c,m){MIDNIGHT_START_TIME=null;MIDNIGHT_END_TIME=null;var j=getSelectedTimeFromDate(c);var e=SELECTED_TIMEZONE;var l=getEpochTimeFromDate(c);var k=new Date(c);var g=l+k.getSeconds()+(60*k.getMinutes())+(60*60*k.getHours());MIDNIGHT_START_TIME=j=getMidnightEpoch();MIDNIGHT_END_TIME=selected_epoch_end=j+86400;var f=getEpochTimeFromDate(k);k.setDate(k.getDate()+1);var b=getEpochTimeFromDate(k);var h=getTimezoneOffset();var a="/core/api/webevents/calendar/getslots?&user_id="+User_Id+"&date="+c+"&slot_time="+m+"&timezone_name="+e+"&epoch_time="+l+"&startTime="+j+"&endTime="+selected_epoch_end+"&agile_user_id="+Agile_User_Id+"&timezone="+h;$.getJSON(a,function(d){if(d.length==0){displayNoSlotsMsg();return}Available_Slots=d;displaySlots()})}function displayNoSlotsMsg(){$(".checkbox-main-grid").html("");var a=new Date(selecteddate);$(".availability").html("No slots available for "+a.getDayName()+", "+a.getMonthName()+", "+a.getDate())}function displaySlots(){var f=0,e=0,d=0;$(".checkbox-main-grid").html("");console.log(Available_Slots.length);var h=[];var b=new Date();if(BUFFERTIME==null){BUFFERTIME=single_user_mapobject.buffer_time}var c=b.getTime()+parseInt(BUFFERTIME);for(var l=0;l<Available_Slots.length;l++){if(Available_Slots[l][0]*1000>parseInt(c)){h.push(Available_Slots[l])}}console.log(h.length);Available_Slots="";Available_Slots=h;if(Available_Slots.length==0){displayNoSlotsMsg();return}change_availability_date(selecteddate);var a=Available_Slots.length/5;a++;var g=function(){var j="";for(f=0;f<=a;f++){if(d<Available_Slots.length){j=j+'<li><input class="selected-slot" type="checkbox" id="startTime_'+d+'"name="startTime_'+d+'" value="'+Available_Slots[d][0]+'" /><label for="'+Available_Slots[d][0]+'">'+getConvertedTimeFromEpoch(Available_Slots[d][0])+"</label></li>"}d++}return j};for(e=0;e<5;e++){$(".checkbox-main-grid").append('<li><ul class="checkbox-grid">'+g()+"<ul><li>")}}function isValid(a){$(a).validate();return $(a).valid()}function save_web_event(h,b){if(!isValid("#"+h)){$("#"+h).find("input").focus();return false}var c=$("#"+h).serializeArray();var e={};$.each(c,function(){if(e[this.name]){if(!e[this.name].push){e[this.name]=[e[this.name]]}e[this.name].push(this.value||"")}else{e[this.name]=this.value||""}});e.name=appointmenttype;e.slot_time=Selected_Time;e.domainUserId=User_Id;e.agileUserId=Agile_User_Id;e.selectedSlotsString=[];e.timezone=SELECTED_TIMEZONE;e.midnight_start_time=MIDNIGHT_START_TIME;e.midnight_end_time=MIDNIGHT_END_TIME;e.timezone_offset=getTimezoneOffset();var d=0;for(var a in e){if(a.indexOf("startTime")!=-1){var f=a.split("_");var j={};j.start=Available_Slots[f[1]][0];j.end=Available_Slots[f[1]][1];e.selectedSlotsString[d]=j;d++;var g=new Date(j.start*1000);e.date=g.toString()}}if(e.selectedSlotsString.length==0){showAlertModal("appointment_time");return false}$("#confirm").attr("disabled","disabled");$("#three").addClass("green-bg").html('<i class="fa fa-check"></i>');e.selectedSlotsString=JSON.stringify(e.selectedSlotsString);$.ajax({url:"/core/api/webevents/calendar/save",type:"PUT",contentType:"application/json; charset=utf-8",data:JSON.stringify(e),dataType:"",success:function(l){console.log(l);var m=JSON.parse(e.selectedSlotsString);var n=m[0];var p=convertToHumanDateUsingMoment("",n.start);$("#mainwrap").addClass("appointment-wrap");var o="/img/appointment_confirmation.png";var k='<div style="margin: 26px;font-size:15px;"><div id="info" ><h3 style="border-bottom: 1px solid #ddd;padding-bottom:8px;margin-bottom:15px;"><img style="margin-right: 8px;margin-top: -4px;" src='+o+"><b>Appointment Scheduled</b></h3><p >Your appointment ("+appointmenttype+") has been scheduled with <b>"+User_Name+"</b> for "+e.slot_time+" mins on "+p+'. </div><div class="row"><div class="col-md-12"><div class="row"><div class="col-md-12"><div class="left"><a class="btn btn-primary" id="create_new_appointment" style="margin-top:20px;">Schedule Another Appointment</a></div></div></div></div><div align="right" style="position: absolute;right: 280px;bottom: -80px;"><span style="display: inherit;font-style: italic; font-family: Times New Roman; font-size: 10px; padding-right: 71px;">Powered by</span> <a href="https://www.agilecrm.com?utm_source=powered-by&amp;medium=event_scheduler&amp;utm_campaign='+domainname+'" rel="nofollow" target="_blank"><img src="https://s3.amazonaws.com/agilecrm/panel/uploaded-logo/1383722651000?id=upload-container" alt="Logo for AgileCRM" style="border: 0;background: white;padding: 0px 10px 5px 2px;height: auto;width: 135px;"></a></div>';
resetAll();$(".container").html(k)},error:function(k){console.log(k);if(k.responseText=="slot booked"){alert("Looks like this slot is booked already. Please try another one.");get_slots(selecteddate,Selected_Time);$("#confirm").attr("disabled",false)}else{alert("Something went wrong as your appointment was not scheduled. Please try again :"+k.statusText);resetAll();location.reload(true)}}})}function convertToHumanDate(b,a){if(!b){b="ddd, mmmm d yyyy, h:MM TT"}if(!a){return}if((a/100000000000)>1){return new Date(parseInt(a)).format(b,0)}var c=new Date(parseInt(a)*1000).format(b);return c}function convertToHumanDateUsingMoment(c,b){if(!c){c="ddd, MMM DD YYYY, hh:mm A"}if(!b){return}var b=moment.unix(b);var a=b.tz(SELECTED_TIMEZONE).format(c);return a}$(function(){$("body").on("click","#create_new_appointment",function(a){location.reload(true)})});function addDotsAtEnd(b){if(b){if(b.length>10){var a=b.substr(0,10);a=a+"....";return a}}return b}function resetToPrevious(){$("#one").html("2");$("#two").html("3");$("#three").html("4");$("#two").removeClass("green-bg").html("3");$("#one").removeClass("green-bg").html("2");$("#three").removeClass("green-bg").html("4");$("#confirm").hide();$(".segment3").hide();$(".segment2").hide()}function fillSlotDetails(n){var f=data=slot_details;if(n){f=data=n}var h=[];if(slot_array&&slot_array.length>0){for(var e=0;e<slot_array.length;e++){if((parseInt(slot_array[e])-1)<data.length&&parseInt(slot_array[e])!=0){h[e]=slot_array[e]}}if(h.length>0){slot_array=[];slot_array=h}else{$(".segment1").append('<div class="col-sm-12" align="center"><p class="lead" style="color: #777;font-size: 19px;text-align: center;font-weight:normal">Please enter valid slot number </p> </div>');return}}if(slot_array&&data.length>=slot_array.length&&slot_array.length>0){data=[];var d=0;for(var e=0;e<slot_array.length;e++){if((parseInt(slot_array[e])-1)<f.length){data[d]=f[parseInt(slot_array[e])-1];d++}}}MEETING_DURATION_AND_NAMES=data=generateNewDataArray(data);var c=12/data.length;for(var g in data){var m=JSON.parse(data[g]);var b=m.meeting_names;var l="";for(var a in b){l+='<div class="radio"><label><input class="c-p selected_meeting_time" type="radio" data="'+m.time+'" name="selected_meeting_time" value="'+b[a]+'"><i></i>'+b[a]+"</label></div>"}var k='<div class="panel panel-default"><div class="panel-heading font-bold">'+m.time+' mins</div><div class="panel-body"><form class="bs-example form-horizontal"><div class="form-group" style="margin-left:7px;">'+l+"</div></form></div></div>";$(".segment1").append('<div class="col-sm-'+c+' show_slots"><p class="timeslot-view">'+k+"</p></div>")}if(multi_user_ids.length<2){$(".panel-body").height(parseInt(getPanelBodyMaxHeight())+26)}$(".segment1").append('<div class="clearfix"></div>')}function getPanelBodyMaxHeight(){var a=0;$(".panel-body").each(function(){var b=$(this).height();if(b>a){a=b}});return a}function generateNewDataArray(f){var a=[];for(var b in f){var e=JSON.parse(f[b]);var d=[];if(e.title.indexOf(",")>-1){d=e.title.split(",")}else{d.push(e.title)}if(d.length>0){var c={};c.time=e.time;c.meeting_names=d;a.push(JSON.stringify(c))}else{a.push(JSON.stringify(e))}}return a}function getEpochTimeFromDate(a){var b=new Date(a);return getGMTTimeFromDate(b)/1000}function getGMTTimeFromDate(b){var a=new Date();b=new Date(b.getFullYear(),b.getMonth(),b.getDate(),0,0,0);return b.getTime()}function GetTimezoneShort(b){if(b==null){return""}var e=b.toString();var c=e.split("(");if(c.length==2){var f=c[1].replace(")","");var d=f.split(" ");var a="";for(i=0;i<d.length;i++){a+=d[i].charAt(0).toUpperCase()}return a}}function createNormalTime(g){var b=0;var c=new Date(g*1000);var e=c.getHours();var f=c.getHours();var d=c.getMinutes();var a=new Array();if(e>12){f=e-12}else{if(e==0){f="12"}}if(f<10){a[b++]="0"}a[b++]=f;a[b++]=":";if(d<10){a[b++]="0"}a[b++]=d;if(e>=12){a[b++]=" pm"}else{a[b++]=" am"}return a.join("")}function getSelectedTimeFromDate(a){a=new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds());return a.getTime()}function getConvertedTimeFromEpoch(b){var a=moment.unix(b);var c=a.tz(SELECTED_TIMEZONE).format("hh:mm a");return c}function getNormalBusinessHouts(c){var b=c;c=c.split(":")[0];var a=b.split(":")[1];if(parseInt(c)==0||parseInt(c)==24){return"12:"+a+"am"}if(parseInt(c)>=12&&parseInt(c)<=23){return getNormalTimeAMPM(c)+":"+a+"pm"}else{return parseInt(c)+":"+a+"am"}}function getNormalTimeAMPM(b){var a={"12":"12","13":"1","14":"2","15":"3","16":"4","17":"5","18":"6","19":"7","20":"8","21":"9","22":"10","23":"11"};if(a[b]){return a[b]}else{return b}}function convertWeekDayToArray(a){if(parseInt(a)>=1&&parseInt(a)<=6){return parseInt(a)-1}if(parseInt(a)==0){return 6}}function getTimezoneOffset(a){return moment.tz.zone(SELECTED_TIMEZONE).offset(new Date().getTime())}function getMidnightEpoch(a){if(CURRENT_DAY_OPERATION==true){current_date_mozilla=getUnixTimeStampInSpecificTimezone()}if(!a){a=current_date_mozilla}var b=moment.tz(a,SELECTED_TIMEZONE).unix();return b}function getUnixTimeStampInSpecificTimezone(b){var a=moment().tz(SELECTED_TIMEZONE);a.set("hour",0);a.set("minute",0);a.set("second",0);a.set("millisecond",0);return a.valueOf()}function getTimeInVisitorTimezone(g,f,e){if(!f){f=$("#timezone-"+User_Id).html()}var b=moment().tz(f);var c=null;var d=null;var a=null;if(g){a=g.split(":")}if(a){c=a[0];d=a[1]}b.set("hour",parseInt(c));b.set("minute",parseInt(d));b.set("second",0);b.set("millisecond",0);if(e==true){return toTimeZoneFirstTimeLoading(b.valueOf())}return toTimeZone(b.valueOf())}function getTimeInVisitorTimezoneWhileLoading(c,a){var b=null;var d=null;if(c!="Today is holiday"){d=c.split("-")}if(d){b=getTimeInVisitorTimezone(d[0],a,true)+" - "+getTimeInVisitorTimezone(d[1],a,true)}else{b="Today is holiday"}return b}function toTimeZone(b,a){return moment.tz(b,SELECTED_TIMEZONE).format("hh:mm a")}function toTimeZoneFirstTimeLoading(b,a){return moment.tz(b,jstz.determine().name()).format("hh:mm a")}function getVisitorWhileLoading(){return jstz.determine().name()}function updateUserBusinessHoursInVisitorTimezone(c){if(!c){c=selecteddate}for(var a=0;a<=multi_user_ids.length-1;a++){var d=business_hours_array[a];var b=d[convertWeekDayToArray(new Date(c).getDay())];if(b.isActive){$("#workhours-"+multi_user_ids[a]).html(getTimeInVisitorTimezone(b.timeFrom)+" - "+getTimeInVisitorTimezone(b.timeTill))}else{$("#workhours-"+multi_user_ids[a]).html("No working hours")}}}var Is_Profile_Guider_Closed=false;var Profile_Settings={Email:"",};var Profile_Setup_Messages={};Profile_Setup_Messages.Welcome="Welcome to Agile - the next generation CRM. I will be your tour guide.<a href='#' id='noty-welcome-user' style='text-decoration: none;'> Let's get you started.";Profile_Setup_Messages.Email="Shake Hands. <a href='#email' style='text-decoration: none;'> Let's sync your emails first</a>. It's simple and secure.";Profile_Setup_Messages.User_invited="Emails will show up in the awesome timeline. It's time to invite your colleague";Profile_Setup_Messages.Share="Are you liking Agile? Spread the love.";var Initial_Total=65;var Profile_Info={Welcome:false,Email:false,total:Initial_Total};function calculate_profile(){var a=Agile_Contact.tags;if(!a||a.length==0){return Profile_Info}var c=Initial_Total;var b=true;$.each(Profile_Settings,function(d,e){var f=d.indexOf("_")!=-1?d.replace("_"," "):d;if(a.indexOf(f)!=-1){Profile_Info[d]=true;c=c+e;b=false;return}});if(!b){Profile_Info.Welcome=!b}Profile_Info.total=c;return Profile_Info}function set_profile_noty(){}function set_profile_noty1(){console.log(Agile_Contact);if(jQuery.isEmptyObject(Agile_Contact)){return}var a=calculate_profile();remove_profile_noty();$.each(a,function(c,d){console.log(a);if(d==false){var b={};b.message=Profile_Setup_Messages[c];b.route=Profile_Settings[c];show_noty_on_top_of_panel(b);return false}})}function show_noty_on_top_of_panel(a){if(Is_Profile_Guider_Closed){return}$("body").find("#wrap").find("#notify-container").remove();$("body").find("#wrap").find(".navbar-fixed-top").css("margin-top","0px");$("body").find("#wrap").find("#agilecrm-container").css("padding-top","60px");$("body").find("#wrap").find("#notify-container").remove();getTemplate("sticky-noty",a,undefined,function(b){if(!b){return}$("body").find("#wrap").prepend($(b));$("body").find("#wrap").find(".navbar-fixed-top").css("margin-top","34px");$("body").find("#wrap").find("#agilecrm-container").css("padding-top","96px")},null)}function remove_profile_noty(){$("body").find("#wrap").find("#notify-container").remove();$("body").find("#wrap").find(".navbar-fixed-top").css("margin-top","0px");$("body").find("#wrap").find("#agilecrm-container").css("padding-top","60px")}$(function(){$("#content").on("click","span.notify-close",function(a){Is_Profile_Guider_Closed=true;$(this).parent().slideUp("slow",function(){$("body").find("#wrap").find(".navbar-fixed-top").css("margin-top","0px");$("body").find("#wrap").find("#agilecrm-container").css("padding-top","60px")})});$("#content").on("click","#noty-welcome-user",function(a){a.preventDefault();delete Profile_Info.Welcome;set_profile_noty()})});function initToPubNub(b){if(Pubnub!=undefined){if(Pubnub!=null){if(b){b()}return}}var a="https";head.js(a+"://pubnub.a.ssl.fastly.net/pubnub-3.4.min.js",function(){Pubnub=PUBNUB.init({publish_key:"pub-c-e4c8fdc2-40b1-443d-8bb0-2a9c8facd274",subscribe_key:"sub-c-118f8482-92c3-11e2-9b69-12313f022c90",ssl:true,origin:"pubsub.pubnub.com",});subscribeClientChannel(b)})}function subscribeClientChannel(a){Pubnub.subscribe({channel:CURRENT_DOMAIN_USER.id+"_Channel",restore:false,message:function(d,b,c){try{if((d||{}).type=="call"){handleCallRequest(d)}else{handleMessage(d)}}catch(f){}},presence:function(d,b,c){console.log(d)},connect:function(){console.log("Agile crm Connected");Pubnub.is_connected_call=true;if(a){a()}},disconnect:function(b){console.log(b+" Disconnected")},reconnect:function(b){console.log(b+" Reconnected")},error:function(b){console.log(b+" Network Error")
},})}function sendMessage(a){console.log("publish_message publishJSON: ");console.log(a);if(a==null){return}Pubnub.publish({channel:"agile_crm_Channel",message:a,callback:function(b){if(b[0]){console.log("publish_message Successfully Sent!")}else{console.log("publish_message unsuccessfull to Sent!");showNotyPopUp("information","You are not connected with Twitter server or you have problem with connection!","top",5000);displayErrorInStream(a.stream);Register_Counter++;registerAll(Register_Counter)}}})}function storeData(a,b,c){if(typeof(Storage)!=="undefined"){if(islocalStorageHasSpace()){localStorage.setItem(a,b)}}else{createCookie(a,b,c)}}function readData(a){if(typeof(Storage)!=="undefined"){return localStorage.getItem(a)}else{return readCookie(a)}}function eraseData(a){if(typeof(Storage)!=="undefined"){return localStorage.removeItem(a)}else{return eraseCookie(a)}}function clearLocalStorage(){var a=new Date();var d=false;var b=1024*1024*5-unescape(encodeURIComponent(JSON.stringify(localStorage))).length;if(b<1242597){localStorage.clear();d=true}else{var c=localStorage.getItem("localStorageExpireDate");if(c){c=new Date(Date.parse(c));if(a>=c){localStorage.clear();d=true}}else{d=true}}if(d){var e=a.getDate()+30;a.setDate(e);localStorage.setItem("localStorageExpireDate",a)}}function islocalStorageHasSpace(){var a=false;var c=1242597;var b=1024*1024*5-unescape(encodeURIComponent(JSON.stringify(localStorage))).length;if(b){if(b>c){a=true}}else{a=true}return a}(function(a){clearLocalStorage();releaseAllAgileCookies()})(jQuery);function _agile_get_prefs(a){var b=readCookie(a);if(b!=null&&b!=undefined&&b!="null"){eraseCookie(a);storeData(a,b)}return readData(a)}function _agile_set_prefs(a,b,c){storeData(a,b,c)}function _agile_delete_prefs(a){eraseData(a)}function releaseAllAgileCookies(){if(_agile_get_prefs("agileReleasedAllCookies")){return}var b="JSESSIONID";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var e=a[d];while(e.charAt(0)==" "){e=e.substring(1,e.length)}if(e.indexOf(b)==0){continue}eraseCookie(e)}_agile_set_prefs("agileReleasedAllCookies","done")}function initializeTriggersListeners(){}function populate_milestones_in_trigger(a,c,b){a.find("select#"+c).closest("div.control-group").css("display","");$("select#"+c).after(getRandomLoadingImg());populateTrackMilestones(a,undefined,undefined,function(d){$(".loading").remove();if(b!==undefined){var e=b.split("_")[0];if(e!=" "&&isNaN(Number(e))){$.each(d,function(g,f){if(f.isDefault&&~f.milestones.indexOf(b)){b=f.id+"_"+b;return true}})}a.find("select#"+c).val(b).attr("selected","selected").trigger("change")}},"Select new milestone...","trigger-deal-milestone")}function populate_contact_filters_in_trigger(b,d,e){b.find("select#"+d).closest("div.control-group").css("display","");var c="<option value='{{id}}'>{{name}}</option>";fillSelect("contact-filter","/core/api/filters","workflow",function a(){if(e){$("#contact-filter",b).find("option[value="+e+"]").attr("selected","selected")}},c,false,undefined,"Select Contact filter")}function populate_stripe_events_in_trigger(b,a,c,d){b.find("select#"+a).closest("div.control-group").css("display","");b.find("#trigger-run-on-new-contacts").css("display","");if(d){b.find("#trigger-run-on-new-contacts").val(d)}if(c!==undefined){b.find("select#"+a).val(c).attr("selected","selected").trigger("change")}}function populate_shopify_events_in_trigger(a,b,c,d){a.find("select#"+b).closest("div.control-group").css("display","");a.find("#trigger-run-on-new-contacts").css("display","");if(d){a.find("#trigger-run-on-new-contacts").val(d)}if(c!==undefined){a.find("select#"+b).val(c).attr("selected","selected").trigger("change")}}function populate_inbound_mail_events_in_trigger(a,b,c){a.find("div#"+b).css("display","");a.find("#new-mail-trigger-run-on-new-contacts").css("display","");if(c){a.find("#new-mail-trigger-run-on-new-contacts").val(c)}}function populate_owners_in_trigger(a,b,d){a.find("select#"+b).closest("div.control-group").css("display","");var c="<option value='{{id}}'>{{name}}</option>";fillSelect(b,"/core/api/users/partial","users",function(){$("#"+b+" option:first").after('<option value="ANY">Any Owner</option>');if(d){$("#"+b,a).find("option[value="+d+"]").attr("selected","selected")}},c,false,undefined,"Select Event Owner")}function populate_call_trigger_options(a,b){a.find("div#CALL").closest("div.control-group").css("display","");if(b&&b.call_disposition){a.find("div#CALL select").find('option[value="'+b.call_disposition+'"]').attr("selected","selected").trigger("change")}}function populate_forms_in_trigger(a,c,b,e){a.find("#trigger-run-on-new-contacts").css("display","");if(e){a.find("#trigger-run-on-new-contacts").val(e)}a.find("select#"+c).closest("div.control-group").css("display","");var d="<option value='{{id}}'>{{formName}}</option>";fillSelect(c,"core/api/forms","forms",function(){if(b){$("#"+c,a).find("option[value="+b+"]").attr("selected","selected")}},d,false,undefined,"Select Form")}function show_triggers_of_each_workflow(a){if(App_Workflows.triggersCollectionView!=undefined&&App_Workflows.triggersCollectionView.collection.length!=0){append_triggers_to_workflow(a);return}App_Workflows.triggersCollectionView=new Base_Collection_View({url:"/core/api/triggers",restKey:"triggers",templateKey:"triggers",individual_tag_name:"tr"});App_Workflows.triggersCollectionView.collection.fetch({success:function(b){if(App_Workflows.triggersCollectionView==undefined||App_Workflows.triggersCollectionView.collection.length==0){$("#triggers-verification",a).css("display","block");return}append_triggers_to_workflow(a)}})}function append_triggers_to_workflow(a){$(".workflow-triggers",a).each(function(d,e){var c=App_Workflows.triggersCollectionView.collection.where({campaign_id:parseInt($(e).attr("workflow-id"))});var b=new BaseCollection(c,{});if(b.length!==0){getTemplate("workflow-triggers",{triggers:b.toJSON()},undefined,function(f){if(!f){return}$(e).html($(f))},$(e))}})}function show_email_tracking_campaigns(){$("form#addTriggerForm").find("select#email-tracking-campaign-id").closest("div.control-group").css("display","");var a="<option value='{{id}}'>{{name}}</option>";fillSelect("email-tracking-campaign-id","/core/api/workflows","workflow",function(){$("#email-tracking-campaign-id option:first").after('<option value="0">All</option>')},a,false)}function initializeTriggerEventListners(){$("#trigger-listener").on("click",".add-trigger",function(c){var a=c.target.getAttribute("data");var b=$("#campaign-id").val();App_Workflows.triggerAdd(b,a)})}function openVerifyEmailModal(b){if(window.parent.$("#workflow-verify-email").size()!=0){window.parent.$("#workflow-verify-email").remove()}var a=$(b).find(":selected").val();if(a=="verify_email"){window.parent.workflow_alerts("Verify a new From address",undefined,"workflow-verify-email-modal",function(c){c.on("shown.bs.modal",function(){$(this).find("input").focus();parent.send_verify_email()});c.on("hidden.bs.modal",function(f){var d=$(this).find("input").val();resetAndFillFromSelect(d)})})}resetAndFillFromSelect(a)}function rearrange_from_email_options(b,c){if(!c){return}var a=[];$.each(c,function(d,e){if(e.verified=="NO"){a.push(e.email)}});b.find("option").each(function(){var d=$(this).val();if(a.indexOf(d)!=-1){$(this).attr("unverified","unverified");$(this).text(d+" (unverified)")}})}function resetAndFillFromSelect(b){$("#from_email").empty();var a={};a[_agile_get_translated_val("others","add-new")]="verify_email";fetchAndFillSelect("core/api/account-prefs/verified-emails/all","email","email",undefined,a,$("#from_email"),"prepend",function(c,d){var e=c.find('option[value = "'+CURRENT_DOMAIN_USER.email+'"]').val();if(typeof(e)=="undefined"){c.find("option:first").before("<option value="+CURRENT_DOMAIN_USER.email+">"+CURRENT_DOMAIN_USER.email+"</option>")}if(b){c.val(b).attr("selected","selected")}else{c.val(CURRENT_DOMAIN_USER.email).attr("selected","selected")}rearrange_from_email_options(c,d)})}function fetchAndFillSelect(url,keyField,valField,appendNameField,options,selectContainer,arrange_type,callback){var selectOptionAttributes="";if(options!==undefined){$.each(options,function(key,value){if(key.indexOf("*")==0){key=key.substr(1);selectOptionAttributes+="<option selected='selected' value='"+value+"'>"+key+"</option>"}else{selectOptionAttributes+="<option value='"+value+"'>"+key+"</option>"}})}$.ajax({url:url,async:false,dataType:"json",success:function(data){$(selectContainer[0]).find("option").remove();if(selectOptionAttributes!==undefined){$(selectOptionAttributes).appendTo(selectContainer)}var array=eval(data);$.each(array,function(index,json){var key=eval("json."+keyField);var value=eval("json."+valField);var appendName=eval("json."+appendNameField);if(key!=undefined&&appendName!=undefined){key=appendName+" &lt;"+key+"&gt;"}if(key!=undefined&&value!=undefined){console.log(key);if(key.indexOf("*")==0){key=key.substr(1);option="<option selected value='"+value+"'>"+key+"</option>"}else{option="<option value='"+value+"'>"+key+"</option>"}if(arrange_type&&arrange_type=="prepend"){$(option).prependTo(selectContainer[0])}else{$(option).appendTo(selectContainer[0])}}});if(callback&&typeof(callback)==="function"){callback(selectContainer,data)}}})}function initializeTriggerListEventListners(b,a){$("#trigger-selector, #trigger-edit-selector").on("click","#trigger-cancel",function(c){c.preventDefault();if(!history){return}if($(this).closest("#trigger-edit-selector").length==0){Backbone.history.loadUrl()}else{history.back(-1)}});$("#trigger-selector, #trigger-edit-selector").on("change","#email-tracking-type",function(c){c.preventDefault();if($(this).val()=="ANY"||$(this).val()=="PERSONAL"){$("form#addTriggerForm").find("select#email-tracking-campaign-id").closest("div.control-group").css("display","none");return}show_email_tracking_campaigns()});$("#trigger-selector, #trigger-edit-selector").on("change","#trigger-type",function(d){d.preventDefault();var c=$(this).val();
if(c!=="DEAL_MILESTONE_IS_CHANGED"){$("form#addTriggerForm").find("select#trigger-deal-milestone").closest("div.control-group").css("display","none")}if(c!=="RUNS_HOURLY"||c!=="RUNS_DAILY"||c!=="RUNS_WEEKLY"||c!=="RUNS_MONTHLY"){$("form#addTriggerForm").find("select#contact-filter").closest("div.control-group").css("display","none")}if(c!=="STRIPE_CHARGE_EVENT"){$("form#addTriggerForm").find("select#trigger-stripe-event").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("select#trigger-stripe-event").val("");$("#trigger-run-on-new-contacts").css("display","none")}if(c!=="SHOPIFY_EVENT"){$("form#addTriggerForm").find("select#trigger-shopify-event").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("select#trigger-shopify-event").val("");$("#trigger-run-on-new-contacts").css("display","none")}if(c!=="INBOUND_MAIL_EVENT"){$("form#addTriggerForm").find("div#trigger-inbound-mail-event").css("display","none");$("#new-mail-trigger-run-on-new-contacts").css("display","none")}if(c!="EMAIL_OPENED"||c!="EMAIL_LINK_CLICKED"){$("form#addTriggerForm").find("select#email-tracking-type").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("#custom-link-clicked").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("select#email-tracking-campaign-id").closest("div.control-group").css("display","none")}if(c!="UNSUBSCRIBED"){$("form#addTriggerForm").find("select#email-tracking-campaign-id").closest("div.control-group").css("display","none")}if(c!="EVENT_IS_ADDED"){$("form#addTriggerForm").find("select#event-owner-id").closest("div.control-group").css("display","none");$("form#addTriggerForm").find("select#event-type").closest("div.control-group").css("display","none")}if(c!=="INBOUND_CALL"||c!=="OUTBOUND_CALL"){$("form#addTriggerForm").find("div#CALL").closest("div.control-group").css("display","none")}if(c!="FORM_SUBMIT"){$("form#addTriggerForm").find("select#trigger-form-event").closest("div.control-group").css("display","none");$("#trigger-run-on-new-contacts").css("display","none")}if(c=="TAG_IS_ADDED"||c=="TAG_IS_DELETED"){$("form#addTriggerForm").find("#trigger-custom-tags").closest("div.control-group").css("display","");addTagsDefaultTypeahead($("form#addTriggerForm").find("div#RHS"))}if(c=="RUNS_HOURLY"||c=="RUNS_DAILY"||c=="RUNS_WEEKLY"||c=="RUNS_MONTHLY"){populate_contact_filters_in_trigger($("form#addTriggerForm"),"contact-filter")}if(c=="ADD_SCORE"){$("form#addTriggerForm").find("#trigger-custom-score").closest("div.control-group").css("display","")}if(c=="DEAL_MILESTONE_IS_CHANGED"){populate_milestones_in_trigger($("form#addTriggerForm"),"trigger-deal-milestone")}if(c=="STRIPE_CHARGE_EVENT"){populate_stripe_events_in_trigger($("form#addTriggerForm"),"trigger-stripe-event")}if(c=="SHOPIFY_EVENT"){populate_shopify_events_in_trigger($("form#addTriggerForm"),"trigger-shopify-event")}if(c=="INBOUND_MAIL_EVENT"){populate_inbound_mail_events_in_trigger($("form#addTriggerForm"),"trigger-inbound-mail-event")}if(c=="EMAIL_OPENED"||c=="EMAIL_LINK_CLICKED"){$("form#addTriggerForm").find("#email-tracking-type").closest("div.control-group").css("display","");if(c=="EMAIL_LINK_CLICKED"){$("form#addTriggerForm").find("#custom-link-clicked").closest("div.control-group").css("display","")}}if(c=="EVENT_IS_ADDED"){$("form#addTriggerForm").find("select#event-type").closest("div.control-group").css("display","");populate_owners_in_trigger($("form#addTriggerForm"),"event-owner-id")}if(c=="INBOUND_CALL"||c=="OUTBOUND_CALL"){populate_call_trigger_options($("form#addTriggerForm"))}if(c=="FORM_SUBMIT"){populate_forms_in_trigger($("form#addTriggerForm"),"trigger-form-event")}if(c=="UNSUBSCRIBED"){show_email_tracking_campaigns()}})}var _AGILE_API_KEY="";function setGlobalAPIKey(a){if(_AGILE_API_KEY&&_AGILE_API_KEY!=""){if(a&&typeof(a)==="function"){a()}return}$.ajax({type:"GET",url:"/core/api/api-key",dataType:"json",success:function(b){if(b){console.log("Setting API KEY: "+b.api_key);_AGILE_API_KEY=b.api_key;if(a&&typeof(a)==="function"){a()}}}})}function getFormNameForTrigger(a,b){if(!a){return false}if(!b||!(typeof(b)==="function")){return false}$.ajax({type:"GET",url:"/core/api/forms/form?formId="+a,dataType:"json",success:function(c){b(c.formName)}})}function getFormNameCellIDForFormSubmitTriggers(a){return a+"_formNameField"}function campaignAlert(d){if(d==null){return}var c={};var b;var a="";if(d=="nodeLimit"){c=_billing_restriction.currentLimits;a="campaign-node-limit-modal"}if(d=="Empty"){c.title="No Twilio Number";c.message="The Twilio SMS gateway you configured does not have a purchased number. Please purchase a number from Twilio to start sending SMS.";a="SMSGateway-integration-alert-modal"}if(d=="Empty_Widget"){c.title="No Twilio Number";c.message="The Twilio integration you configured does not have a purchased number. Please purchase a number from Twilio to start calling.";a="CallWidget-integration-alert-modal"}if(d=="Unauthorised"){c.title="SMS Gateway not Configured";c.message="You need to enable SMS Gateway integration to use this option. Please enable it in Admin Settings -> Integrations";a="SMSGateway-integration-alert-modal"}if(d=="Unauthorised_Call_Widget"){c.title="Twilio Integration not Configured";c.message="You need to enable Twilio Integration to use this option. Please enable in Admin Settings -> Integrations";a="CallWidget-integration-alert-modal"}getTemplate(a,c,undefined,function(e){if(!e){return}$(e).modal("show")},null)}function workflow_alerts(d,b,a,e){var c={};c.title=d;c.message=b;getTemplate(a,c,undefined,function(g){if(!g){return}var f=$(g);f.modal("show");if(e&&typeof(e)==="function"){e(f)}},null)}function workflow_spam_alerts(c,d,a,e){var b={};b.title="Spam Result";b.score=d;b.reason=c;getTemplate(a,b,undefined,function(g){if(!g){return}var f=$(g);f.modal("show");if(e&&typeof(e)==="function"){e(f)}},null)}function send_verify_email(a){var b=$("#verify-email-form",a).find("input");b.off("keypress");b.on("keypress",function(c){if(c.type=="keypress"&&c.which!=13){return}c.preventDefault();$("#verify-email-send").trigger("click")});$("#verify-email-send",a).off("click");$("#verify-email-send",a).on("click",function(d){d.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm("#verify-email-form")){return}$(this).attr("disabled","disabled").text(_agile_get_translated_val("other","sending"));var c=serializeForm("verify-email-form");if(!c){return}$.ajax({url:"core/api/emails/verify-from-email",type:"POST",data:c,success:function(e){$("#verify-email-send").removeAttr("disabled");$("#verify-email-form").find("div.row div").hide();$("#verify-email-form").find("div.row input").val(c.email);$("#verify-email-form").find("div.row span#alert-msg").html("<p class='m-l'>Verification email sent to &#39;"+c.email+"&#39;. Please check your email and complete the verification process.</p>");$("#verify-email-send").removeAttr("href").removeAttr("id").off("click").attr("data-dismiss","modal").text("Done")},error:function(e){$("#verify-email-send").removeAttr("disabled");if(e.responseText=="Email not verified yet."){$("#verify-email-form").find("div.row div").hide();$("#verify-email-form").find("div.row input").val(c.email);$("#verify-email-form").find("div.row span#alert-msg").html("<p class='m-l'> &#39;"+c.email+"&#39; is not verified yet. Please check your email and complete the verification process.</p>");$("#verify-email-send").removeAttr("href").removeAttr("id").off("click").attr("data-dismiss","modal").text("Done");return}$("#workflow-verify-email").modal("hide")}})})}function unsubscribe_contact(){$("#unsubscribe").off("click");$("body").on("click","#unsubscribe",function(c){c.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm("#unsubscribe-form")){return}$(this).attr("disabled","disabled").text("Unsubscribing...");var b={},a=[];$("#campaigns-list option:selected").each(function(e,f){a.push($(this).val())});var d=[];$.each(App_Contacts.contactDetailView.model.toJSON()["unsubscribeStatus"],function(e,f){d.push(f.campaign_id)});a=a.filter(function(e){return d.indexOf(e)<0});if(!a||a.length==0){$("div#contact-detail-resubscribe-modal").modal("hide");return}b.campaign_id=a.join(",");b.contact_id=App_Contacts.contactDetailView.model.get("id");b.type="CURRENT";if(is_selected_all){b.type="ALL"}if(!b){return}$.ajax({url:"core/api/unsubscribe",type:"POST",data:b,success:function(e){$("#unsubscribe").removeAttr("disabled").text("Unsubscribe");unsubscribe_status_updated=true;$("div#contact-detail-resubscribe-modal").modal("hide");showNotyPopUp("information","Unsubscribed successfully.","top")},error:function(e){}})})}function resubscribe(){$(".resubscribe").off("click");$(".resubscribe").on("click",function(f){f.preventDefault();var a=$(event.target);if(!confirm("Are you sure to resubscribe "+$(this).attr("contact_name")+" to "+$(this).attr("campaign_name")+" campaign?")){return}var c=$(this).attr("data");var b={};b.id=App_Contacts.contactDetailView.model.get("id");b["workflow-id"]=c;if(c=="ALL"){var d=[];$.each(App_Contacts.contactDetailView.model.toJSON()["unsubscribeStatus"],function(e,g){d.push(g.campaign_id)});b["workflow-id"]=d.join(",")}$.ajax({url:"core/api/campaigns/resubscribe",type:"POST",data:b,success:function(e){unsubscribe_status_updated=true;a.closest("li").remove();$("ul#added-tags-ul").find("a[data='ALL']").closest("li").remove()},error:function(e){}})})}var unsubscribe_fill_select={};var Workflow_Model_Events=Base_Model_View.extend({events:{"click #save-workflow-top,#save-workflow-bottom,#duplicate-workflow-top,#duplicate-workflow-bottom":"saveCampaignClick","click #workflow-unsubscribe-option":"unsubscribeCampaign","click #workflow-designer-help":"helpCampaign","change #unsubscribe-action":"unsubscribeCampaignOptionSelect","change #disable-workflow":"saveCampaignClick","change .emailSelect,click .emailSelect":"fillDetails","click #campaign_access_level":"accessLevelChange",},fillDetails:function(d){console.log("fillDetails");
var b="";unsubscribe_fill_select.id="";var f=$(".emailSelect option:selected").prop("value");if(!f){return}var a=Backbone.Model.extend({url:"/core/api/email/templates/"+f,restKey:"emailTemplates"});var c=new a();c.fetch({success:(function(g){var e=g.toJSON();unsubscribe_fill_select.id=f;unsubscribe_fill_select.text=e.text})})},unsubscribeCampaignOptionSelect:function(f){f.preventDefault();var g=$(f.currentTarget);var b="Contact will not receive any further emails from any campaign (i.e., the 'Send Email' option will not work. However, other actions in campaign will work as expected)";var d="Contact will be removed from this campaign";var a="Prompts the user with options to either unsubscribe from this campaign or all communication";var c=$(this).closest("div.controls").parent().find("small");if($(g).val()=="UNSUBSCRIBE_FROM_ALL"){c.html(b)}if($(g).val()=="UNSUBSCRIBE_FROM_THIS_CAMPAIGN"){c.html(d)}if($(g).val()=="ASK_USER"){c.html(a)}},helpCampaign:function(a){a.preventDefault();getTemplate("workflow-designer-help-modal",{},undefined,function(b){if(!b){return}$("#workflow-designer-help-modal").html($(b)).modal("show");$("#workflow-designer-help-modal").on("hide.bs.modal",function(){$(this).html("")})},null)},unsubscribeCampaign:function(a){a.preventDefault();$(a.currentTarget).find("i").toggleClass("icon-plus").toggleClass("icon-minus");$("#workflow-unsubscribe-block").slideToggle("fast");showHide_UnsubscribeEmail_Status()},saveCampaignClick:function(w,t,f){w.preventDefault();var n=$(w.currentTarget);try{var y=$("iframe[id=designer]").contents().find("#paintarea .contextMenuForNode").length;var B=_billing_restriction.currentLimits;var s=B.campaignNodesLimit;if(y-1>s){$("#workflow-edit-msg").hide();$("#nodes-limit-reached").show();campaignAlert("nodeLimit");return}}catch(g){}var u=$(n);if(!window.frames.designer.checkWorkflowSize()){return}if($(n).attr("disabled")){return}if(!isValidForm("#workflowform")){$("#workflowform").find("span.help-inline").not(":hidden").prev("input").focus();return false}var k=window.frames.designer.serializePhoneSystem();if(!is_start_active(k)){var c='<span style="color: red;">Please connect the ’Start\' node to another node in the campaign</span>';$("#workflow-msg").html(c).show().fadeOut(3000);return false}var C=$("#workflow-name").val();var p=$("#unsubscribe-tag").val().trim();var q=$("#unsubscribe-action").val();var v=$("#unsubscribe-email").val().trim();var l=$("#unsubscribe-name").val().trim();var A="";if(unsubscribe_fill_select.id){A=unsubscribe_fill_select.id}var o=$(".is-disabled-top").attr("data");if(w.type=="change"&&o){o=!JSON.parse(o)}var h=false;var d=$("[id^='unsubscribe-email-']:checked").val();if(d!="undefined"&&d=="true"){h=true}var j={tag:p,action:q,unsubscribe_email:v,unsubscribe_name:l,unsubscribe_subject:A,is_unsubscribe_email_disabled:h};var r=$("#access_level").val();if(isNotValid(C)){showAlertModal("name_not_valid");return}disable_save_button($(n));track_with_save_success_model($(n));var z={};if(App_Workflows.workflow_model===undefined||$(n).attr("id")==="duplicate-workflow-top"||$(n).attr("id")==="duplicate-workflow-bottom"){create_new_workflow(w,C,k,j,u,t,o,undefined,r)}else{z=App_Workflows.workflow_model;var a=App_Workflows.workflow_model.previousAttributes();App_Workflows.workflow_model.set("name",C);App_Workflows.workflow_model.set("rules",k);App_Workflows.workflow_model.set("unsubscribe",j);App_Workflows.workflow_model.set("is_disabled",o);App_Workflows.workflow_model.set("access_level",r);App_Workflows.workflow_model.save({},{success:function(){enable_save_button(u);show_campaign_save(w);if(f){f()}try{add_tag_our_domain(CAMPAIGN_TAG)}catch(E){}$("#workflow-edit-msg").hide();if(w.type=="change"){var D=$(".is-disabled-top");var e=$("#disable-switch").bootstrapSwitch("status");if(o&&e){D.attr("data",true);$("#designer-tour").addClass("blur").removeClass("anti-blur");window.frames[1].$("#paintarea").addClass("disable-iframe").removeClass("enable-iframe");window.frames[1].$("#paintarea .nodeItem table>tbody").addClass("disable-iframe").removeClass("enable-iframe");show_campaign_save(w,"Campaign has been disabled successfully.","red")}else{D.attr("data",false);$("#designer-tour").addClass("anti-blur").removeClass("blur");window.frames[1].$("#paintarea").addClass("enable-iframe").removeClass("disable-iframe");window.frames[1].$("#toolbartabs").removeClass("disable-iframe");window.frames[1].$("#paintarea .nodeItem table>tbody").addClass("enable-iframe").removeClass("disable-iframe");show_campaign_save(w,"Campaign has been enabled successfully.")}}if($(n).attr("id")==="campaign_access_level"){if(r=="1"){show_campaign_save(w,"The Campaign is now Public.")}else{show_campaign_save(w,"The Campaign is now Private.")}}if(t&&t.navigate){Backbone.history.navigate("workflows",{trigger:true})}add_tag_our_domain(CAMPAIGN_TAG)},error:function(D,e,E){enable_save_button(u);App_Workflows.workflow_model.set(a);console.log(e);c=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+e.responseText+"</i></p></small></div>");$("#workflow-msg").html(c).show()}})}var A="";unsubscribe_fill_select.id="";var m=$(".emailSelect option:selected").prop("value");if(!m){return}var b=Backbone.Model.extend({url:"/core/api/email/templates/"+m,restKey:"emailTemplates"});var x=new b();x.fetch({success:(function(D){var e=D.toJSON();unsubscribe_fill_select.id=m;unsubscribe_fill_select.text=e.text}),error:(function(){unsubscribe_fill_select.id=m;A=unsubscribe_fill_select.id})})},accessLevelChange:function(b){console.log("change");var c=$("#access_level",this.el).val();if(c=="1"){c=CURRENT_DOMAIN_USER.id}else{c="1"}$("#access_level",this.el).val(c);var a=this;if(App_Workflows.workflow_model&&App_Workflows.workflow_model.get("id")){this.saveCampaignClick(b,undefined,function(){change_access_level(c,a.el)});return}change_access_level(c,this.el)}});function initializeLogReportHandlers(){$("#campaign-reports-select").change(function(b){b.preventDefault();var c=$(b.currentTarget);var a=$("#campaign-tabs .select").data("campaign-tab-active");if(a=="STATS"){Backbone.history.navigate("email-reports/"+$(c).val(),{trigger:true})}if(a=="SUBSCRIBERS"){Backbone.history.navigate("workflow/all-subscribers/"+$(c).val(),{trigger:true})}if(a=="LOGS"){Backbone.history.navigate("workflows/logs/"+$(c).val(),{trigger:true})}})}var Workflow_Reports_Events=Base_Collection_View.extend({events:{"click #delete_campaign_logs":"onDeleteAllCampaignLogs","click .log-filters":"onChangeLogFilter",},onDeleteAllCampaignLogs:function(b){b.preventDefault();var a=$("#logs-table").find("input.campaign").val();if(!a){return}showAlertModal("delete_campaign_logs","confirm",function(){$.ajax({url:"core/api/campaigns/logs/"+a,type:"DELETE",success:function(){App_Workflows.logsToCampaign(a)}})})},onChangeLogFilter:function(a){a.preventDefault();var c=$(a.currentTarget);var b=$(c).data("log-type");var d=$(c).data("campaign-id");App_Workflows.logsToCampaign(d,b,$(c).text())},});$(function(){$("body").on("click",".stop-propagation",function(a){a.stopPropagation()})});function create_new_workflow(h,b,m,k,l,c,a,g,f){var d={};d.name=b;d.rules=m;d.unsubscribe=k;d.is_disabled=a;d.was_disabled=g;d.access_level=f;var j=new Backbone.Model(d);App_Workflows.workflow_list_view.collection.create(j,{success:function(){enable_save_button(l);show_campaign_save(h);$("#workflow-edit-msg").hide();if(c&&c.navigate){Backbone.history.navigate("workflows",{trigger:true})}App_Workflows.workflow_model=j;if(Current_Route.indexOf("share-campaign")!=-1){App_Workflows.workflow_list_view=undefined}},error:function(n,e,o){enable_save_button(l);App_Workflows.workflow_list_view.collection.remove(j);if(e.status!=406){if(l.attr("id")==="duplicate-workflow-bottom"||l.attr("id")==="duplicate-workflow-top"){if(e.responseText==="Please change the given name. Same kind of name already exists."){showAlertModal("duplicate_workflow");return}}showAlertModal(e.responseText,undefined,undefined,undefined,"Error")}else{console.log(e);$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+e.responseText+"</i></p></small></div>");$("#workflow-msg").html($save_info).show()}}})}function fill_logs_slate(c,a){if(a==undefined){a="ALL"}var b={ALL:{title:"No logs for this campaign yet",image:updateImageS3Path("/img/clipboard.png")},EMAIL_SENT:{title:"No emails sent yet",image:updateImageS3Path("/img/clipboard.png")},EMAIL_SENDING_SKIPPED:{title:"No emails skipped yet",image:updateImageS3Path("/img/clipboard.png")},EMAIL_OPENED:{title:"No emails opened in this campaign",image:updateImageS3Path("/img/clipboard.png")},EMAIL_CLICKED:{title:"No emails clicked in this campaign",image:updateImageS3Path("/img/clipboard.png")},UNSUBSCRIBED:{title:"No one unsubscribed from this campaign",image:updateImageS3Path("/img/clipboard.png")},EMAIL_HARD_BOUNCED:{title:"No hard bounces seen for  this campaign",image:updateImageS3Path("/img/clipboard.png")},EMAIL_SOFT_BOUNCED:{title:"No soft bounces seen for this campaign",image:updateImageS3Path("/img/clipboard.png")},EMAIL_SPAM:{title:"No spam reports seen for this campaign",image:updateImageS3Path("/img/clipboard.png")}};getTemplate("empty-collection-model",b[a],undefined,function(d){if(!d){return}$("#"+c).html($(d))},"#"+c)}function show_campaign_save(d,c,a){var b;if(c){b='<span style="color: green;">'+c+"</span>"}else{b='<span style="color: green;">Campaign saved.</span>';showCampaignPopup(d)}if(a){b=$(b).css("color",a)}$("#workflow-msg").html(b).show().fadeOut(3000)}function is_start_active(d){var a=JSON.parse(d).nodes;var c=true;try{$.each(a,function(f,g){if(g.displayname=="Start"){var e=g.States;$.each(e,function(h,j){if(j.start=="hangup"){c=false;return true}})}})}catch(b){return c}return c}function populate_workflows_list(d,b,c){if(c==undefined){c="no-callback"}var a="<option value='{{id}}'>{{name}}</option>";fillSelect(d,"/core/api/workflows","workflow",c,a,undefined,b)}function shareCampaign(){$("#shareCampaign").remove();
getTemplate("share-campaign-modal",{},undefined,function(b){if(!b){return}var a=$(b);a.modal("show")},null)}function createJSON(){var a={};var c=$("#emailId").val();if(!isValidForm("#verify-email")){return}var b=serializeForm("verify-email");if(!b){return}a.receiverEmail=c;a.campaignId=App_Workflows.workflow_model.id;$.ajax({url:"/core/api/workflows/share?type=Workflow&id="+App_Workflows.workflow_model.id+"&recEmail="+a.receiverEmail,type:"GET",data:a,dataType:"json",contentType:"application/json",success:function(){$("#shareCampaign").modal("hide");showNotyPopUp("information","Campaign has been shared successfully.","top")},error:function(){$("#shareCampaign").modal("hide")}})}$("body").on("mouseenter","#workflows-model-list tr",function(a){$(this).find("#camp_history").removeClass("hide");$(this).find("#camp_reports").removeClass("hide")});$("body").on("mouseleave","#workflows-model-list tr",function(a){$(this).find("#camp_history").addClass("hide");$(this).find("#camp_reports").addClass("hide")});function showCampaignPopup(c){c.preventDefault();var d=$(c.currentTarget);var b=$(d).attr("id");var a=readData("campaign-save-popup");if(a!=="true"&&(b==="save-workflow-top"||b==="save-workflow-bottom"||b==="duplicate-workflow-top"||b==="duplicate-workflow-bottom")){while($("#workflow-save-popup").length){$("#workflow-save-popup").remove()}workflow_alerts("Next Action ","null","workflow-save-popup-modal",function(e){window.setTimeout(function(){$(e).find("#popup-msg").fadeOut(8000)},500)})}}function popupCampaignContact(){$("#workflow-save-popup").modal("hide");Backbone.history.navigate("#contacts",{trigger:true})}function popupCampaignTrigger(){$("#workflow-save-popup").modal("hide");Backbone.history.navigate("#trigger-add",{trigger:true})}function hideCampaignPopup(){if($("#campaign-save-popup").prop("checked")){storeData("campaign-save-popup",true,10)}else{storeData("campaign-save-popup",false,10)}}function initializeWorkflowsListeners(){}function change_access_level(b,a){if(b=="1"){$("#campaign_access_level span",a).text("Make Private");$("#campaign_access_level i",a).removeClass("icon-unlock");$("#campaign_access_level i",a).addClass("fa fa-lock")}else{$("#campaign_access_level span",a).text("Make Public");$("#campaign_access_level i",a).removeClass("fa fa-lock");$("#campaign_access_level i",a).addClass("icon-unlock")}}var Workflow_Top_Header_Model_Events=Base_Model_View.extend({events:{"click #sort_menu > li":"sortCollectionView"},sortCollectionView:function(c){c.preventDefault();var d=$(c.currentTarget);var b="",a=$("#sort_menu");if($(d).find("a").hasClass("sort-field")){a.find("li").not(d).find("a.sort-field i").addClass("display-none");$(d).find("a.sort-field i").removeClass("display-none")}else{a.find("li").not(d).find("a.order-by i").addClass("display-none");$(d).find("a.order-by i").removeClass("display-none")}b=a.find(".order-by i:not(.display-none)").closest(".order-by").attr("data");b+=a.find(".sort-field i:not(.display-none)").closest(".sort-field").attr("data");_agile_set_prefs("workflow_sort_key",b);this.model.set({sortKey:b})},});function showHide_UnsubscribeEmail_Status(b){var a=$("[id^='unsubscribe-email-']:checked").val();if(a!="undefined"&&a=="true"){$("#unsubscribe-email").attr("disabled",true);$("#unsubscribe-email").parent().parent().attr("style","pointerEvents:none; opacity: 0.4;")}else{$("#unsubscribe-email").removeAttr("disabled");$("#unsubscribe-email").parent().parent().removeAttr("style")}if(b){var c="You have unsaved changes. Click on ‘Save Campaign’ to save.";c='<span style="color: red;">'+c+"</span>";$("#unsubscribe-email_status-msg").html(c).show()}}$(function(){$("#content").on("click","#select-all-active-contacts",function(a){a.preventDefault();SUBSCRIBERS_SELECT_ALL=true;$("#content").find("#subscribers-bulk-select").css("display","block").html(_agile_get_translated_val("contacts","select-all")+" "+getAvailableActiveContacts()+' contacts. <a hrer="#" id="select-all-active-contacts-revert" class="text-info">Select chosen contacts only</a>');$.each($(".tbody_check"),function(b,c){$(c).attr("checked","checked")})});$("#content").on("click","#select-all-active-contacts-revert",function(a){a.preventDefault();SUBSCRIBERS_SELECT_ALL=false;$("#content").find("#subscribers-bulk-select").css("display","block").html("Selected "+App_Workflows.active_subscribers_collection.collection.length+" contacts. <a href='#' id='select-all-active-contacts' class='text-info'>Select all "+getAvailableActiveContacts()+" contacts</a>")})});function toggle_active_contacts_bulk_actions_dropdown(d,c){SUBSCRIBERS_SELECT_ALL=false;var a;if(d){a=getAvailableActiveContacts()}$("#content").find("#subscribers-bulk-select").css("display","none");if($(d).is(":checked")){$("#content").find("#subscribers-block").css("display","block");$("#subscribers-block").find("#remove-active-from-campaign").css("display","inline-block");if(c&&a!=App_Workflows.active_subscribers_collection.collection.length){$("#subscribers-block").find("#subscribers-bulk-select").css("display","block").html("Selected "+App_Workflows.active_subscribers_collection.collection.length+" contacts. <a id='select-all-active-contacts' class='text-info' href='#'>Select all "+a+" contacts</a>")}}else{if(c){$("#remove-active-from-campaign").css("display","none");return}var b=0;$.each($(".tbody_check"),function(e,f){if($(f).is(":checked")){b++;return false}});if(b==0){$("#remove-active-from-campaign").css("display","none")}}}function getAvailableActiveContacts(){if(App_Workflows.active_subscribers_collection.collection.toJSON()[0]&&App_Workflows.active_subscribers_collection.collection.toJSON()[0].count){var a=App_Workflows.active_subscribers_collection.collection.toJSON()[0].count;return a}return App_Workflows.active_subscribers_collection.collection.toJSON().length}function get_campaign_subscribers_collection(b,a,c){abortCountQueryCall();var d=new Base_Collection_View({url:a,templateKey:c,individual_tag_name:"tr",cursor:true,page_size:20,postRenderCallback:function(e){agileTimeAgoWithLngConversion($("time.campaign-started-time",e));agileTimeAgoWithLngConversion($("time.campaign-completed-time",e),function(){contactListener()});getAndUpdateCollectionCount("workflows",e,a)},appendItemCallback:function(e){$("time.campaign-started-time",e).timeago();$("time.campaign-completed-time",e).timeago()}});return d}function fill_subscribers_slate(c,a){var b={"active-subscribers":{title:"Campaign does not have any active subscriber",description:"You can add subscribers from Contacts tab - using the Bulk Actions option",button_text:"Add subscribers",route:"#contacts",image:updateImageS3Path("/img/clipboard.png")},"completed-subscribers":{title:"No contact assigned to this campaign",description:"You can add subscribers from Contacts tab - using the Bulk Actions option",button_text:"Add subscribers",route:"#contacts",image:updateImageS3Path("/img/clipboard.png")},"removed-subscribers":{title:"No contact removed from this campaign",description:"Removed subscribers are the contacts deleted from the active campaign",image:updateImageS3Path("/img/clipboard.png")},"all-subscribers":{title:"No current or past subscribers for this campaign",description:"You can add subscribers from Contacts tab - using the Bulk Actions option",button_text:"Add subscribers",route:"#contacts",image:updateImageS3Path("/img/clipboard.png")},"unsubscribe-subscribers":{title:"No unsubscriptions for this campaign",description:"Great! No one unsubscribed from this campaign",image:updateImageS3Path("/img/clipboard.png")},"hardbounced-subscribers":{title:"No hard bounces for this campaign",description:"Great! No email get hardbounced",image:updateImageS3Path("/img/clipboard.png")},"softbounced-subscribers":{title:"No soft bounces for this campaign",description:"Great! No email get softbounced",image:updateImageS3Path("/img/clipboard.png")},"spam-reported-subscribers":{title:"No one reported spam for this campaign",description:"Great! No one reported spam yet",image:updateImageS3Path("/img/clipboard.png")}};getTemplate("empty-collection-model",b[a],undefined,function(d){if(!d){return}$("#"+c).html($(d))},"#"+c)}var Agile_MD5=function(t){function M(b,a){return(b<<a)|(b>>>(32-a))}function L(k,b){var F,a,d,x,c;d=(k&2147483648);x=(b&2147483648);F=(k&1073741824);a=(b&1073741824);c=(k&1073741823)+(b&1073741823);if(F&a){return(c^2147483648^d^x)}if(F|a){if(c&1073741824){return(c^3221225472^d^x)}else{return(c^1073741824^d^x)}}else{return(c^d^x)}}function s(a,c,b){return(a&c)|((~a)&b)}function r(a,c,b){return(a&b)|(c&(~b))}function q(a,c,b){return(a^c^b)}function o(a,c,b){return(c^(a|(~b)))}function v(G,F,ab,aa,k,H,I){G=L(G,L(L(s(F,ab,aa),k),I));return L(M(G,H),F)}function f(G,F,ab,aa,k,H,I){G=L(G,L(L(r(F,ab,aa),k),I));return L(M(G,H),F)}function E(G,F,ab,aa,k,H,I){G=L(G,L(L(q(F,ab,aa),k),I));return L(M(G,H),F)}function u(G,F,ab,aa,k,H,I){G=L(G,L(L(o(F,ab,aa),k),I));return L(M(G,H),F)}function e(k){var G;var d=k.length;var c=d+8;var b=(c-(c%64))/64;var F=(b+1)*16;var H=Array(F-1);var a=0;var x=0;while(x<d){G=(x-(x%4))/4;a=(x%4)*8;H[G]=(H[G]|(k.charCodeAt(x)<<a));x++}G=(x-(x%4))/4;a=(x%4)*8;H[G]=H[G]|(128<<a);H[F-2]=d<<3;H[F-1]=d>>>29;return H}function C(c){var b="",d="",k,a;for(a=0;a<=3;a++){k=(c>>>(a*8))&255;d="0"+k.toString(16);b=b+d.substr(d.length-2,2)}return b}function K(b){b=b.replace(/\r\n/g,"\n");var a="";for(var k=0;k<b.length;k++){var d=b.charCodeAt(k);if(d<128){a+=String.fromCharCode(d)}else{if((d>127)&&(d<2048)){a+=String.fromCharCode((d>>6)|192);a+=String.fromCharCode((d&63)|128)}else{a+=String.fromCharCode((d>>12)|224);a+=String.fromCharCode(((d>>6)&63)|128);a+=String.fromCharCode((d&63)|128)}}}return a}var D=Array();var Q,h,J,w,g,Z,Y,X,W;var T=7,R=12,O=17,N=22;var B=5,A=9,z=14,y=20;var p=4,n=11,m=16,l=23;var V=6,U=10,S=15,P=21;t=K(t);D=e(t);Z=1732584193;Y=4023233417;X=2562383102;W=271733878;for(Q=0;Q<D.length;Q+=16){h=Z;J=Y;w=X;g=W;Z=v(Z,Y,X,W,D[Q+0],T,3614090360);W=v(W,Z,Y,X,D[Q+1],R,3905402710);X=v(X,W,Z,Y,D[Q+2],O,606105819);
Y=v(Y,X,W,Z,D[Q+3],N,3250441966);Z=v(Z,Y,X,W,D[Q+4],T,4118548399);W=v(W,Z,Y,X,D[Q+5],R,1200080426);X=v(X,W,Z,Y,D[Q+6],O,2821735955);Y=v(Y,X,W,Z,D[Q+7],N,4249261313);Z=v(Z,Y,X,W,D[Q+8],T,1770035416);W=v(W,Z,Y,X,D[Q+9],R,2336552879);X=v(X,W,Z,Y,D[Q+10],O,4294925233);Y=v(Y,X,W,Z,D[Q+11],N,2304563134);Z=v(Z,Y,X,W,D[Q+12],T,1804603682);W=v(W,Z,Y,X,D[Q+13],R,4254626195);X=v(X,W,Z,Y,D[Q+14],O,2792965006);Y=v(Y,X,W,Z,D[Q+15],N,1236535329);Z=f(Z,Y,X,W,D[Q+1],B,4129170786);W=f(W,Z,Y,X,D[Q+6],A,3225465664);X=f(X,W,Z,Y,D[Q+11],z,643717713);Y=f(Y,X,W,Z,D[Q+0],y,3921069994);Z=f(Z,Y,X,W,D[Q+5],B,3593408605);W=f(W,Z,Y,X,D[Q+10],A,38016083);X=f(X,W,Z,Y,D[Q+15],z,3634488961);Y=f(Y,X,W,Z,D[Q+4],y,3889429448);Z=f(Z,Y,X,W,D[Q+9],B,568446438);W=f(W,Z,Y,X,D[Q+14],A,3275163606);X=f(X,W,Z,Y,D[Q+3],z,4107603335);Y=f(Y,X,W,Z,D[Q+8],y,1163531501);Z=f(Z,Y,X,W,D[Q+13],B,2850285829);W=f(W,Z,Y,X,D[Q+2],A,4243563512);X=f(X,W,Z,Y,D[Q+7],z,1735328473);Y=f(Y,X,W,Z,D[Q+12],y,2368359562);Z=E(Z,Y,X,W,D[Q+5],p,4294588738);W=E(W,Z,Y,X,D[Q+8],n,2272392833);X=E(X,W,Z,Y,D[Q+11],m,1839030562);Y=E(Y,X,W,Z,D[Q+14],l,4259657740);Z=E(Z,Y,X,W,D[Q+1],p,2763975236);W=E(W,Z,Y,X,D[Q+4],n,1272893353);X=E(X,W,Z,Y,D[Q+7],m,4139469664);Y=E(Y,X,W,Z,D[Q+10],l,3200236656);Z=E(Z,Y,X,W,D[Q+13],p,681279174);W=E(W,Z,Y,X,D[Q+0],n,3936430074);X=E(X,W,Z,Y,D[Q+3],m,3572445317);Y=E(Y,X,W,Z,D[Q+6],l,76029189);Z=E(Z,Y,X,W,D[Q+9],p,3654602809);W=E(W,Z,Y,X,D[Q+12],n,3873151461);X=E(X,W,Z,Y,D[Q+15],m,530742520);Y=E(Y,X,W,Z,D[Q+2],l,3299628645);Z=u(Z,Y,X,W,D[Q+0],V,4096336452);W=u(W,Z,Y,X,D[Q+7],U,1126891415);X=u(X,W,Z,Y,D[Q+14],S,2878612391);Y=u(Y,X,W,Z,D[Q+5],P,4237533241);Z=u(Z,Y,X,W,D[Q+12],V,1700485571);W=u(W,Z,Y,X,D[Q+3],U,2399980690);X=u(X,W,Z,Y,D[Q+10],S,4293915773);Y=u(Y,X,W,Z,D[Q+1],P,2240044497);Z=u(Z,Y,X,W,D[Q+8],V,1873313359);W=u(W,Z,Y,X,D[Q+15],U,4264355552);X=u(X,W,Z,Y,D[Q+6],S,2734768916);Y=u(Y,X,W,Z,D[Q+13],P,1309151649);Z=u(Z,Y,X,W,D[Q+4],V,4149444226);W=u(W,Z,Y,X,D[Q+11],U,3174756917);X=u(X,W,Z,Y,D[Q+2],S,718787259);Y=u(Y,X,W,Z,D[Q+9],P,3951481745);Z=L(Z,h);Y=L(Y,J);X=L(X,w);W=L(W,g)}var j=C(Z)+C(Y)+C(X)+C(W);return j.toLowerCase()};var QUERY_RESULTS;var TYPEHEAD_TAGS={};var TYPEHEAD_EMAILS={};var TYPEHEAD_NAMES={};var TYPEHEAD_TYPE={};var TYPEHEAD_DEAL_RELATED_CONTACTS={};function agile_type_ahead(c,d,n,g,e,l,b,o,k,m,h,a){$("#"+c,d).attr("autocomplete","off");if(!b){b="core/api/search/"}var f={};if(!h){h=10}var j=$("#"+c,d).typeahead({timedelay:250,searchAJAXRequest:undefined,source:function(r,s){f={};var q=this;this.options.showLoading(this);var p="";if(a){e=a()}if(e&&e.length){p="&"+e}this.options.searchAJAXRequest=$.getJSON(b+"?q="+encodeURIComponent(r)+"&page_size="+h+""+p,function(w){var u=$("#"+c,d).val();if(r!=u){return}f=w;QUERY_RESULTS=w;if(w.length==0){var t="<b>No Results Found</b>";if(l&&l.length){t=l}if(t=="email-search"){q.$menu.hide();return}q.$menu.html('<div class="m-t-sm"><p align="center"   class="custom-color">'+t+"<p></div>");q.render();return}var v=[];if(n&&typeof(n)==="function"){v=n(w)}$.each(w,function(x,y){tag_name=v[x];TYPEHEAD_TAGS[tag_name]=y.id;TYPEHEAD_EMAILS[tag_name]=getContactEmail(y);TYPEHEAD_NAMES[tag_name]=getContactName(y);TYPEHEAD_DEAL_RELATED_CONTACTS[tag_name]=y.contacts;if(y.type=="PERSON"){TYPEHEAD_TYPE[tag_name]="#contact/"}else{if(y.type=="COMPANY"){TYPEHEAD_TYPE[tag_name]="#company/"}}});s(v)})},showLoading:function(p){p.$menu.empty();if(p.$element.attr("id")=="searchText"){p.$menu.css({width:300,"max-height":"calc(100vh - 50px)","overflow-y":"auto"});p.$menu.addClass("dashboard-search-scroll-bar")}else{p.$menu.css("width",300)}if(!$(p.$menu.find("li").last()).hasClass("loading-results")){p.$menu;p.$menu.html('<li class="divider"></li><li class="loading-results"><p align="center">'+LOADING_ON_CURSOR+"</p></li>");p.render()}},matcher:function(p){if(~p.toLowerCase().indexOf(this.query.toLowerCase())!=0){return ~p.toLowerCase().indexOf(this.query.toLowerCase())}else{return -1}},render:function(){var q=this;if(!f.length){this.show();return}items=buildcategorizedResultDropdown(f,q.options);items.css("overflow","hidden");this.$menu.html(items).show();this.shown=true;var p=$("#searchText").val();var r="";if(c=="searchText"){r='<li><a href="#contacts/search/'+p+'"><p align="center"><b>More...</b></p></a></li>'}$("body").find("#more-results").html(r);$(".modal-backdrop",$(".modal:visible")).height($(".modal-dialog",$(".modal:visible")).height()+$("ul.dropdown-menu",$(".modal:visible")).height());return this},updater:function(x){setTimeout(function(){$(".search-mobile").addClass("hide");$(".add-modal-mobile , #search-menu-mobile").addClass("visible-xs")},200);var w=true;var v=true;if(x){var r=x.substr(0,x.lastIndexOf("-"))}if(x){x=x.split(" ").join("")}if(g&&typeof(g)==="function"){if(!x){showSearchResults();return this.query}g(TYPEHEAD_TAGS[x],r);return}if(!x){return}if(o){$.each($("#"+c,d).closest("div.controls").find(".tags").children("li"),function(A,z){if($(z).attr("data")==TYPEHEAD_EMAILS[x]||~($(z).attr("data").indexOf(TYPEHEAD_EMAILS[x]))){v=false;return}});if(v&&(TYPEHEAD_EMAILS[x]!="No email")){var t=TYPEHEAD_EMAILS[x];var p=TYPEHEAD_NAMES[x];if(m&&t&&p&&Object.keys(TYPEHEAD_NAMES).length!=0){if(p.indexOf("<")!=-1||p.indexOf(">")!=-1){p=p.replace(/</g," ");p=p.replace(/>/g," ")}if(p.trim()!=t.trim()){t=p.trim()+" <"+t.trim()+">"}}$("#"+c,d).closest("div.controls").find(".tags").append(getTemplate("tag-item-li",get_tag_item_json(x,r,"email")))}}else{if(k){$.each($(".deal_tags",d).children("li"),function(A,z){if($(z).attr("data")==TYPEHEAD_TAGS[x]){w=false;return}});if(w){var q=get_tag_item_json(x,r,"deals");var s="";var y=q.related_contacts;$.each(y,function(A,z){var B=true;$.each($("ul.tags",d).children("li"),function(E,D){if($(D).attr("data")==z.id){B=false;return}});if(B){s+=z.id+" ";var C={};C.email_item=z.id;if(z.type=="PERSON"){C.type_item="#contact/"}else{if(z.type=="COMPANY"){C.type_item="#company/"}}C.tag_item=z.id;C.item=getContactName(z);$("ul.tags",d).append(getTemplate("tag-item-li",C))}});q.related_contact_ids=s;$(".deal_tags",d).append(getTemplate("tag-deal-item-li",q))}}else{var u=this.$menu.closest("div.controls").find(".tags");if(u.length==0){u=this.$menu.closest("div.control-group").find(".tags")}else{if(u.length==0){u=this.$menu.closest("div.form-group").find(".tags")}}$.each(u.children("li"),function(A,z){if($(z).attr("data")==TYPEHEAD_TAGS[x]){w=false;return}});if(w){u.append(getTemplate("tag-item-li",get_tag_item_json(x,r)))}}}$(".modal-backdrop",$(".modal:visible")).height($(".modal-dialog",$(".modal:visible")).height()+180)},keyup:function(t){switch(t.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:case 13:if(!this.shown){return}if(o&&!f.length){this.hide()}else{this.select()}break;case 27:if(!this.shown){return}this.hide();break;case 188:if(o){if(checkEmailValidation(($("#"+c,d).val()).slice(0,-1))){var s=true;var p=($("#"+c,d).val()).slice(0,-1);$.each($("#"+c,d).closest("div.controls").find(".tags").children("li"),function(v,u){if($(u).attr("data")==p||~($(u).attr("data").indexOf(p))){s=false;return}});if(s){var r={};r.email_item=p;r.item=p;$("#"+c,d).closest("div.controls").find(".tags").append(getTemplate("tag-item-li",r))}this.select()}else{this.hide()}}break;default:if(this.options.searchAJAXRequest!=null&&(this.options.searchAJAXRequest&&this.options.searchAJAXRequest.readystate!=4)){this.options.searchAJAXRequest.abort()}if(this.timer){clearTimeout(this.timer)}var q=this;f={};this.options.showLoading(q);this.timer=setTimeout(function(){q.lookup()},this.options.timedelay)}t.stopPropagation();t.preventDefault()},hide:function(){this.$menu.hide();this.shown=false;return this},blur:function(q){var p=this;q.stopPropagation();q.preventDefault();setTimeout(function(){if(!p.$menu.is(":focus")){p.hide()}},150)},minLength:2,})}$("body").on("click","#remove_tag",function(e){e.preventDefault();var a;var f=null;var b=false;if($(this).parent().attr("data-deal-related-contacts")){var c=$(this).parent().attr("data-deal-related-contacts").split(" ");var d=$(this).closest("form");$.each(c,function(g,h){$("li[data="+h+"]",d).remove()})}if($(this).hasClass("companyAddress")&&contact_company){$.each(contact_company.properties,function(){if(this.name=="address"&&this.subtype=="office"){f=JSON.parse(this.value)}});if(f){if(f.address&&$("#content #address").val()&&$("#content #address").val()!=f.address){b=true}else{if(f.city&&$("#content #city").val()&&$("#content #city").val()!=f.city){b=true}else{if(f.state&&$("#content #state").val()&&$("#content #state").val()!=f.state){b=true}else{if(f.zip&&$("#content #zip").val()&&$("#content #zip").val()!=f.zip){b=true}else{if(f.country&&$("#content #country").val()&&$("#content #country").val()!=f.country){b=true}}}}}if(!b){$("#content .address-type,#address,#city,#state,#zip,#country").val("")}}}$(this).parent().remove()});function contacts_typeahead(b){if(b==null){return}var a=[];$.each(b,function(d,c){var e;if(c.entity_type=="deal"){e=c.name+"-"+c.id}else{e=getContactName(c)+"-"+c.id}a.push(e.split(" ").join(""))});return a}function deals_typeahead(b){if(b==null){return}var a=[];$.each(b,function(c,e){var d;d=e.name.split(" ").join("")+"-"+e.id;a.push(d)});return a}function getContactEmail(a){var b=getPropertyValue(a.properties,"email");b=b!=undefined?b.trim():"";if(b.length){return b}else{return"No email"}}function checkEmailValidation(a){return/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/i.test(a)}function getContactName(b){var e="";if(!b.type||b.type=="PERSON"){var f=getPropertyValue(b.properties,"first_name");var c=getPropertyValue(b.properties,"last_name");c=c!=undefined?c.trim():"";f=f!=undefined?f.trim():"";e=(f+" "+c).trim()}else{if(b.type=="COMPANY"){var a=getPropertyValue(b.properties,"name");a=a!=undefined?a.trim():"";e=a.trim()}}if(e.length){return e}var d=getPropertyValue(b.properties,"email");d=d!=undefined?d.trim():"";if(d.length){return d}return"Company "+b.id}function buildcategorizedResultDropdown(a,b){var d=new Base_Collection_View({data:a,templateKey:"typeahead-contacts",individual_tag_name:"li",typeahead_options:b});
d.appendItem=appendItemInResult;var c=d.render(true).el;return $(c)}function appendItemInResult(d){var a=getContactName(d.toJSON())+"-"+d.id;var c=d.toJSON().entity_type;if(c&&c=="deal"){a=d.toJSON().name+"-"+d.id}var b=new Base_List_View({model:d,view:"inline",template:this.options.templateKey+"-model",tagName:"div",});i=$(this.options.typeahead_options.item).attr("data-data-value",a);i.addClass("typeahead-border");i.find("a").html(b.render(true).el);i.find("a").removeAttr("href");if(c){if(c=="contact_entity"){$("#contact-typeahead-heading",this.el).show();$("#contact-results",this.el).append(i)}if(c=="company_entity"){$("#company-typeahead-heading",this.el).show();$("#company-results",this.el).append(i)}if(c=="deal"){$("#deal-typeahead-heading",this.el).show();$("#deals-results",this.el).append(i)}if(c=="case"){$("#case-typeahead-heading",this.el).show();$("#case-results",this.el).append(i)}if(c=="document"){$("#document-typeahead-heading",this.el).show();$("#document-results",this.el).append(i)}if(c=="tickets"){$("#tickets-typeahead-heading",this.el).show();$("#ticket-results",this.el).append(i)}}}function get_tag_item_json(a,d,c){var b={};if(c=="email"){b.email_item=TYPEHEAD_EMAILS[a];b.type_item=TYPEHEAD_TYPE[a]}else{if(c=="deals"){b.email_item=TYPEHEAD_TAGS[a];b.type_item=TYPEHEAD_TYPE[a];b.related_contacts=TYPEHEAD_DEAL_RELATED_CONTACTS[a]}else{b.email_item=TYPEHEAD_TAGS[a];b.type_item=TYPEHEAD_TYPE[a]}}b.tag_item=TYPEHEAD_TAGS[a];b.item=d;console.log(b);return b}var TAGS;var tagsCollection;var isTagsTypeaheadActive;var tagsTemplate;var tagsCollectionView;function setup_tags_typeahead(b){var a=[];if(!TAGS){init_tags_collection();return}TAGS=tagsCollection.models;_(TAGS).each(function(d){var c=d.get("tag");if($.inArray(c,a)==-1){a.push(c)}});if(!$(".tags-typeahead").attr("placeholder")){$(".tags-typeahead").attr("placeholder","Separate tags with commas")}$(".tags-typeahead").attr("autocomplete","off");$(".tags-typeahead").typeahead({source:function(c,d){isTagsTypeaheadActive=false;(this.$menu).empty();d(a);if(this.$menu.find(".active").length>0){isTagsTypeaheadActive=true}},updater:function(c){if(!c||(/^\s*$/).test(c)){return}c=c.trim();if((this.$element).closest(".control-group").hasClass("save-tag")){var e=null;var h=null;var d="core/api/contacts";if(b!=undefined){b(c);return}if(App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.get("id")){e=App_Deal_Details.dealDetailView.model.toJSON();h=App_Deal_Details.dealDetailView.model.id;d="core/api/opportunity/AddDealTag?tag="+c+"&id="+h}else{if(company_util.isCompany()){e=App_Companies.companyDetailView.model.toJSON()}else{e=App_Contacts.contactDetailView.model.toJSON()}}if($.inArray(c,e.tags)>=0){$("#addTagsForm").css("display","none");$("#add-tags").css("display","block");$("#addTags").val("");return}e.tagsWithTime.push({tag:c});saveEntity(e,d,function(l){$("#addTagsForm").css("display","none");$("#add-tags").css("display","block");var j=[];$.each($("#added-tags-ul").children(),function(m,n){j.push($(n).attr("data"))});if(App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.get("id")){App_Deal_Details.dealDetailView.model.set(l.toJSON(),{silent:true});App_Deal_Details.dealDetailView.render(true);saveDealTag(c)}else{if(company_util.isCompany()){App_Companies.companyDetailView.model.set(l.toJSON(),{silent:true});if($.inArray(c,j)==-1){var k=Handlebars.compile('<li class="tag btn btn-xs btn-default m-r-xs m-b-xs inline-block" data="{{name}}"><span><a class="anchor m-r-xs" href="#tags/{{name}}" >{{name}}</a><a class="close remove-tags" id="{{name}}" tag="{{name}}">&times</a></span></li>');$("#added-tags-ul").append(k({name:c}));$.each(l.get("tagsWithTime"),function(m,n){if(n.tag==c){$("#added-tags-ul").find("li[data='"+c+"']").attr("title",epochToHumanDate("mmmm dd, yyyy 'at' hh:MM tt",n.createdTime))}})}}else{App_Contacts.contactDetailView.model.set(l.toJSON(),{silent:true});addTagToTimelineDynamically(c,l.get("tagsWithTime"));if($.inArray(c,j)==-1){var k=Handlebars.compile('<li class="tag btn btn-xs btn-default m-r-xs m-b-xs inline-block" data="{{name}}"><span><a class="anchor m-r-xs" href="#tags/{{name}}" >{{name}}</a><a class="close remove-tags" id="{{name}}" tag="{{name}}">&times</a></span></li>');$("#added-tags-ul").append(k({name:c}));$.each(l.get("tagsWithTime"),function(m,n){if(n.tag==c){$("#added-tags-ul").find("li[data='"+c+"']").attr("title",epochToHumanDate("mmmm dd, yyyy 'at' hh:MM tt",n.createdTime))}})}}}});return}else{if($(this.$element).closest(".control-group").hasClass("deal-filter-tag")){$(this.$element).closest(".control-group").find("#dealTagName").val(c)}}var g=[];$.each((this.$element).closest(".control-group").find("ul.tags").children("li"),function(k,j){g.push($(j).attr("data"))});if($.inArray(c,g)==-1){var f=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block"   data="{{name}}"><span class="m-r-xs v-middle">{{name}}</span><a class="close" id="remove_tag">&times</a></li>');(this.$element).closest(".control-group").find("ul.tags").append(f({name:c}))}}});$("body").on("keydown","#addTags",function(g){if(g.which==13&&!isTagsTypeaheadActive){g.preventDefault();var c=$(this).val().trim();var f=null;var h=null;var d=null;if(App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.get("id")){f=App_Deal_Details.dealDetailView.model.toJSON();h=App_Deal_Details.dealDetailView.model.id;d="core/api/opportunity/AddDealTag?tag="+c+"&id="+h}else{f=App_Contacts.contactDetailView.model.toJSON();d="core/api/contacts"}if(!c||c.length<=0||(/^\s*$/).test(c)){return}if(!isValidTag(c,true)){return false}$("#addTags").val("");c=c.trim();acl_util.canAddTag(c,function(j){if(!j){return}var e=[];$.each($("#added-tags-ul").children(),function(k,l){e.push($(l).attr("data"))});if($.inArray(c,e)!=-1){return}f.tagsWithTime.push({tag:c});saveEntity(f,d,function(l){if(App_Deal_Details.dealDetailView&&Current_Route=="deal/"+App_Deal_Details.dealDetailView.model.get("id")){saveDealTag(c,l)}else{App_Contacts.contactDetailView.model.set(l.toJSON(),{silent:true});addTagToTimelineDynamically(c,l.get("tagsWithTime"))}tagsCollection.add(new BaseModel({tag:c}));$("#addTagsForm").css("display","none");$("#add-tags").css("display","block");var k=Handlebars.compile('<li class="inline-block tag btn btn-xs btn-default m-r-xs m-b-xs" data="{{name}}" ><span><a class="anchor m-r-xs" href="#tags/{{name}}">{{name}}</a><a class="close remove-tags" id="{{name}}" tag="{{name}}">&times</a></span></li>');$("#added-tags-ul").append(k({name:c}));$.each(l.get("tagsWithTime"),function(m,n){if(n.tag==c){$("#added-tags-ul").find("li[data='"+c+"']").attr("title",epochToHumanDate("mmmm dd, yyyy 'at' hh:MM tt",n.createdTime))}})},function(l,k){console.log(k);showAlertModal(k.responseText,undefined,undefined,undefined,"Error")})})}});$(".tags-typeahead").bind("keydown",function(h){if($(this).hasClass("ignore-comma-keydown")){return}var c=$(this).val().trim();if(!c||c.length<=0||(/^\s*$/).test(c)){return}if(h.which==188&&c!=""){h.preventDefault();$(this).val("");var d=$(this).closest(".control-group").find("ul.tags");var g=true;d.find("li").each(function(e,j){if(j.getAttribute("data")==c){g=false;return false}});if(g){var f=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block"  data="{{name}}">{{name}}<a class="close m-l-xs" id="remove_tag" tag="{{name}}">&times</a></li>');d.append(f({name:c}))}}})}function setup_tags(a){if(!tagsCollection||!tagsCollectionView){init_tags_collection(a,function(b){$("#tagslist",a).html(b)});return}$("#tagslist",a).html(tagsCollectionView.render(true).el)}function get_tags(a){var e=$("#"+a+" .tags").map(function(){var f=[];if(!$(this).hasClass("custom_contact")&&!$(this).hasClass("custom_company")){$.each($(this).children(),function(g,h){f.push(($(h).attr("data")).toString())});return{name:$(this).attr("name"),value:f}}}).get();var b=$("#"+a+" input.tags-typeahead");if(b!=null){var d=$(b).val();if(d){d=d.trim();if(a=="opportunityForm"||a=="opportunityUpdateForm"){var c;for(c=0;c<e.length;c++){if(e[c].name=="tags"){e[c].value.push(d);break}}}else{e[0].value.push(d)}}}return e}function get_related_deals(a){var b=$("#"+a+" .deal_tags").map(function(){var c=[];$.each($(this).children(),function(d,e){c.push(($(e).attr("data")).toString())});return{name:$(this).attr("name"),value:c}}).get();return b}function get_new_tags(b){if(isValidField(b)){var a=$("#"+b).val();a=a.replace(/ +(?= )/g,"");a=a.replace(", "," ");a=a.replace(","," ");return a}}function init_tags_collection(b,c,a){a=a?a:"/core/api/tags";tagsCollectionView=new Base_Collection_View({url:a,sortKey:"tag",templateKey:"tags",});tagsCollectionView.appendItem=append_tag;tagsCollection=tagsCollectionView.collection;tagsCollectionView.collection.fetch({success:function(d){TAGS=tagsCollection.models;setup_tags_typeahead();if(c&&typeof(c)==="function"){c(tagsCollectionView.render(true).el)}}})}function append_tag(b){var a=b.get("tag");var c=a.charAt(0).toUpperCase();tag_encoded=encodeURIComponent(a);$('div[tag-alphabet="'+encodeURI(c)+'"]',this.el).append('<a href="#tags/'+tag_encoded+'" id="'+tag_encoded.replace(/ +/g,"")+'-in-list">'+a+"</a>&nbsp;")}function remove_tags(a){console.log("removed")}function renameTags(c,b){if(!tagsCollection||!tagsCollection.models){return}var d=tagsCollection.where({tag:b});if(d&&d.length){var a=d[0];a.set({tag:c})}}$(function(){$("body").on("click","#refresh-tags",function(a){a.preventDefault();$("#tagslist",App_Contacts.contactsListView.el).html(getRandomLoadingImg());init_tags_collection(App_Contacts.contactsListView.el,function(b){setup_tags(App_Contacts.contactsListView.el);pieTags(App_Contacts.contactsListView.el,true)},"core/api/tags?reload=true")});$("body").on("focusout",".contact-detail-addtags",function(b){b.preventDefault();var a=$(this).val();$("body").on("mousedown",function(d){d.preventDefault();
var c=d.target.id;if(!a&&c!="contact-add-tags"&&c!="addTags"){$("#addTagsForm").css("display","none");$("#add-tags").css("display","block")}})})});var Helcenter_Events={initializeStatuscheckbox:function(a){$(".article_status",a).off();$(".article_status",a).on("change",function(){var e="Do you want to publish the article";var c=$(this,a).closest("td").data("id");var b=$("."+c).is(":checked");if(!b){e="Do you want to save the article as draft"}var d=true;if(!b){d=false}showModalConfirmation("Status",e,function(){if(!App_Helpcenter_Module.articlesCollection){return}var g=new BaseModel();g.url="/core/api/knowledgebase/article/update-status/"+c;var f={};f={id:c,is_article_published:b};g.save(f,{success:function(h){if(App_Helpcenter_Module.articlesCollection.collection){var h=App_Helpcenter_Module.articlesCollection.collection.get(c);h.set({id:c,is_article_published:d},{silent:true})}}})},function(){if(!b){$("."+c,a).prop("checked","true")}else{$("."+c,a).removeAttr("checked")}},null)})},categorieDelete:function(a){$(".remove_categorie",a).on("click",function(b){b.preventDefault();var c=$(this).data("id");showModalConfirmation("Delete Category","Are you sure you want to delete Category ",function(){console.log(c);$.ajax({url:"/core/api/knowledgebase/categorie/"+c,type:"DELETE",contentType:"application/json",success:function(d){model=App_Helpcenter_Module.categoriesCollection.collection.get(c);model.destroy()}})},null,null,"Yes","No")})}};var Helpcenter_Base_Model=Base_Model_View.extend({events:{"click .removeComment":""},removeComment:function(a){a.preventDefault();Tickets_Rest.removeDuedate(a)},});Handlebars.registerHelper("epochToHumanDate",function(b,a){if(!b){b="mmm dd yyyy HH:MM:ss"}if(!a){return}if((a/100000000000)>1){return new Date(parseInt(a)).format(b,0)}return new Date(parseInt(a)*1000).format(b)});Handlebars.registerHelper("is_user_logged_in",function(a){if(IS_USER_LOGGED_IN){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("Commented_user",function(b,a){if(!b){return a.fn(this)}if(!USERINFO){return a.inverse(this)}if(b.id==USERINFO.userId){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("Admin_Commented_user",function(b,a){if(!b){return a.fn(this)}if(!USERINFO){return a.inverse(this)}if(b.id==USERINFO.userId||USERINFO.role=="ADMIN"){return a.fn(this)}return a.inverse(this)});Handlebars.registerHelper("replace_newline_with_br",function(b,a){if(!b){return""}b=b.trim();b=b.replace(/(?:\r\n|\r|\n)/g,"<br />");return b});(function(a,c,d){var b=null;a.view=function(){if(b){return b}b=contact_sort_configuration.SORT_FIELDS_VIEW().extend({resetLocalStorage:function(f){_agile_delete_prefs(this.options.sortPrefsName)},updateLocalStorage:function(e){_agile_set_prefs(this.options.sortPrefsName,e)},sort_collection:function(f){DEALS_HARD_RELOAD=true;if(_agile_get_prefs("agile_deal_view")){fetchDealsList()}else{startGettingDeals()}}});return b}}(window.DEAL_SORT_FIELDS_VIEW=window.DEAL_SORT_FIELDS_VIEW||{},$));function setupDealFilters(a){App_Deals.deal_filters=new Deals_Filter_Change_Events_Collection_View({url:"/core/api/deal/filters",templateKey:"deal-filter-list",sort_collection:false,individual_tag_name:"li",postRenderCallback:function(b){}});App_Deals.deal_filters.collection.fetch({success:function(b){if(a){return a(b)}else{setNewDealFilters(b)}}})}function setNewDealFilters(a){if($("#deal-list-filters",$("#opportunity-listners")).find("li").length==0){$("#deal-list-filters",$("#opportunity-listners")).html(App_Deals.deal_filters.render(true).el)}var b=_agile_get_prefs("deal-filter-name");if(b&&b!="my-deals"&&a.get(b)&&a.get(b).get("name")){$("#opportunity-listners").find("h3").find(".remove_deal_filter").parent().remove();$("#opportunity-listners").find("h3").find("small").after('<div class="inline-block tag btn btn-xs btn-primary m-l-xs"><span class="inline-block m-r-xs v-middle pull-left">'+a.get(b).get("name")+'</span><a class="close remove_deal_filter">×</a></div>');return}if(b&&b=="my-deals"){$("#opportunity-listners").find("h3").find(".remove_deal_filter").parent().remove();$("#opportunity-listners").find("h3").find("small").after('<div class="inline-block tag btn btn-xs btn-primary m-l-xs"><span class="inline-block m-r-xs v-middle pull-left">My Deals</span><a class="close remove_deal_filter">×</a></div>');return}$("#opportunity-listners").find("h3").find(".remove_deal_filter").parent().remove();setupDefaultDealFilters()}function setupDefaultDealFilters(){var a={};a.owner_id="";a.pipeline_id=_agile_get_prefs("agile_deal_track");a.milestone="";a.archived="false";a.value_filter="equals";_agile_set_prefs("deal-filters",JSON.stringify(a))}function getDealFilters(){var b={};if(_agile_get_prefs("deal-filter-name")){var g=_agile_get_prefs("deal-filter-name");if(g=="my-deals"){b=$.parseJSON(_agile_get_prefs("deal-filters"))}else{var f=App_Deals.deal_filters.collection.get(g);if(f){b=f.toJSON()}if(b){if((b.close_date_filter=="LAST"||b.close_date_filter=="NEXT")&&b.close_date_value){var e=b.close_date_value;var c=new Date();var a=new Date(c.getFullYear(),c.getMonth(),c.getDate(),0,0,0);if(b.close_date_filter=="LAST"){b.close_date_end=a.getTime()/1000;b.close_date_start=(a.getTime()-((e-1)*24*60*60*1000))/1000}else{if(b.close_date_filter=="NEXT"){b.close_date_start=a.getTime()/1000;b.close_date_end=(a.getTime()+(e*24*60*60*1000))/1000}}}b.filterOwner={}}}if(b&&!_agile_get_prefs("agile_deal_view")){var d=b;d.pipeline_id=_agile_get_prefs("agile_deal_track");d.milestone="";return JSON.stringify(d)}if(b&&_agile_get_prefs("agile_deal_view")){return JSON.stringify(b)}if(!b&&!_agile_get_prefs("agile_deal_view")){var d={};d.pipeline_id=_agile_get_prefs("agile_deal_track");return JSON.stringify(d)}return""}else{if(!_agile_get_prefs("agile_deal_view")){var d={};d.pipeline_id=_agile_get_prefs("agile_deal_track");d.value_filter="equals";d.archived="false";return JSON.stringify(d)}if(_agile_get_prefs("agile_deal_view")){var d={};d.value_filter="equals";d.archived="false";return JSON.stringify(d)}return""}}function percentCountAndAmount(b,c){$(".Count_goal").text(getNumberWithCommasForCharts(b));$(".Amount_goal").text(numberWithCommasAsDouble(c));var a;$("#deal-sources-table").find("td").each(function(d){var f=$(this).find(".count").val();var e=$(this).find(".amount").val();if(f!=""&&f!=0){a=Math.round((parseInt(f)*100)/(parseInt(b)));$(this).find(".count_percent").html(a+"%")}else{if($(this).find(".count_percent").html()!=""){$(this).find(".count_percent").html("")}}if(e!=""&&e!=0){a=Math.round((parseInt(e)*100)/(parseInt(c)));$(this).find(".amount_percent").html(a+"%")}else{if($(this).find(".amount_percent").html()!=""){$(this).find(".amount_percent").html("")}}})}function numberWithCommasAsDouble(a){if(a==0){return a}if(a){return a.toFixed(2).toString().replace(/\B(?=(?:\d{3})+(?!\d))/g,",").replace(".00","")}}function dealSourcesSorting(){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(".admin-settings-deal-sources-model-list").sortable({axis:"y",containment:".admin-settings-deal-sources-model-list",scroll:false,items:"tr",helper:function(c,a){var b=a.children();var d=a.clone();d.children().each(function(e){$(this).width(b.eq(e).width()+50);$(this).css("background","#f5f5f5");$(this).css("border-bottom","1px solid #ddd");$(this).css("max-width",(b.eq(e).width()+50)+"px");$(this).height(b.eq(e).height())});return d},sort:function(a,b){b.placeholder.height(b.helper.height())},forceHelperSize:true,placeholder:"<tr></tr>",forcePlaceholderSize:true,handle:".icon-move",cursor:"move",tolerance:"pointer"});$(".admin-settings-deal-sources-model-list",$("#deal-sources-table")).on("sortstop",function(b,c){var a=[];$("#admin-settings-deal-sources-model-list > tr").each(function(d){a[d]=$(this).data().id});$.ajax({type:"POST",url:"/core/api/categories/position",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",dataType:"json",success:function(d){$.each(a,function(e,f){$("#dealSourcesForm_"+f).find('input[name="order"]').val(e)})}})})})}function getDealSortFilter(){var a="-created_time";if(_agile_get_prefs("deal_sort_field")){a=_agile_get_prefs("deal_sort_field")}return a}var DEAL_CUSTOM_SORT_VIEW=undefined;function setUpDealSortFilters(b){if(DEAL_CUSTOM_SORT_VIEW){$("#deal-sorter",b).html(DEAL_CUSTOM_SORT_VIEW.render(true).el);return}var a=DEAL_SORT_FIELDS_VIEW.view();DEAL_CUSTOM_SORT_VIEW=new a({data:sort_deal_configuration.getDealSortableFields(),templateKey:"contact-view-sort",sortPrefsName:"deal_sort_field",individual_tag_name:"li",sort_collection:false,postRenderCallback:function(c){DEAL_CUSTOM_SORT_VIEW.postProcess()}});DEAL_CUSTOM_SORT_VIEW.init();$("#deal-sorter",b).html(DEAL_CUSTOM_SORT_VIEW.render(true).el)}function chainDealFilters(a,b,c){if(!OPPORTUNITY_CUSTOM_FIELDS){fillOpportunityCustomFieldsInFilters(a,function(){show_chained_fields(a,b,true);if(c&&typeof(c)==="function"){c()}});return}fillCustomFields(OPPORTUNITY_CUSTOM_FIELDS,a,undefined,false);show_chained_fields(a,b);if(c&&typeof(c)==="function"){c()}}function fillOpportunityCustomFieldsInFilters(a,b){$.getJSON("core/api/custom-fields/searchable/scope?scope=DEAL",function(c){console.log(c);OPPORTUNITY_CUSTOM_FIELDS=c;fillCustomFields(c,a,b,false)})}function chainFiltersForOpportunity(a,b,c){if(b){chainDealFilters($(a).find(".chained-table.opportunity.and_rules"),b.rules,undefined);chainDealFilters($(a).find(".chained-table.opportunity.or_rules"),b.or_rules,c)}else{chainDealFilters($(a).find(".chained-table.opportunity.and_rules"),undefined,undefined);chainDealFilters($(a).find(".chained-table.opportunity.or_rules"),undefined,c)}}function populateUsers(g,c,d,b,f){var a="<option value='{{id}}'>{{name}}</option>";fillSelect(g,"/core/api/users/partial","domainUser",function e(){if(d){if(d[b]){$("#"+g,c).find("option[value="+d[b].id+"]").attr("selected","selected")}}else{$("#"+g,c).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected")}if(f&&typeof(f)==="function"){f($("#"+g).html())}},a)
}function populateTrackMilestones(b,f,h,j,d,a,g,c){var e=new Base_Collection_View({url:"/core/api/milestone/pipelines"});if(!a){a="pipeline_milestone"}e.collection.fetch({success:function(n){var k=n.toJSON();var l='<option value="">Select...</option>';console.log(k);if(k.length==1&&!g){var m=k[0];$.each(m.milestones.split(","),function(o,q){var p={id:m.id,milestone:q};if(h&&m.id==h.pipeline_id&&q==h.milestone){l+=Handlebars.compile('<option value="{{id}}_{{milestone}}" selected="selected">{{milestone}}</option>')(p)}else{l+=Handlebars.compile('<option value="{{id}}_{{milestone}}">{{milestone}}</option>')(p)}});if(m.lost_milestone){l+=Handlebars.compile('<option value="{{id}}_{{lost_milestone}}" style="display:none;">{{lost_milestone}}</option>')({id:m.id,lost_milestone:m.lost_milestone})}if(!g){$("#"+a,b).closest(".control-group").find("label").html('Milestone<span class="field_req">*</span>')}}else{$.each(k,function(o,p){console.log(p.milestones,h);var q=[];l+='<optgroup label="'+p.name+'">';if(g&&h&&p.id==h.pipeline_id&&h.milestone=="ALL@MILESTONES"){l+=Handlebars.compile('<option selected="selected" value="{{id}}_ALL@MILESTONES">{{name}} - All</option>')({id:p.id,name:p.name})}else{if(g){l+=Handlebars.compile('<option value="{{id}}_ALL@MILESTONES">{{name}} - All</option>')({id:p.id,name:p.name})}}$.each(p.milestones.split(","),function(r,t){q.push($.trim(this));var s={id:p.id,milestone:t,name:p.name};if(h&&p.id==h.pipeline_id&&t==h.milestone){l+=Handlebars.compile('<option value="{{id}}_{{milestone}}" selected="selected">{{name}} - {{milestone}}</option>')(s)}else{l+=Handlebars.compile('<option value="{{id}}_{{milestone}}">{{name}} - {{milestone}}</option>')(s)}});if(p.lost_milestone){l+=Handlebars.compile('<option value="{{id}}_{{lost_milestone}}" style="display:none;">{{name}} - {{milestone}}</option>')({id:p.id,lost_milestone:p.lost_milestone,name:p.name})}l+="</optgroup>"});if(!g){$("#"+a,b).closest(".control-group").find("label").html('Track & Milestone<span class="field_req">*</span>')}}if(!g){$("#"+a,b).html(l);console.log("adding");$("#"+a,b).closest("div").find(".loading-img").hide()}else{$(g).html("<select class='form-control required' name='"+c+"'>"+l+"</select>")}hideTransitionBar();if(j&&typeof(j)==="function"){j(k)}}})}function populateTracks(b,e,c,f,d){var a=new Base_Collection_View({url:"/core/api/milestone/pipelines"});a.collection.fetch({success:function(j){hideTransitionBar();var g=j.toJSON();var h='<option value="">Select...</option>';console.log(g);if(g.length==1){h+=Handlebars.compile('<option value="{{id}}" selected="selected">{{name}}</option>')({id:g[0].id,name:g[0].name});milestone_util.showMilestonePopup(g[0])}else{milestone_util.isNotyVisible=false;$.each(g,function(k,m){var l={id:m.id,name:m.name};if(!m.name){m.name="Default"}if(c&&m.id==c.pipeline_id){h+=Handlebars.compile('<option value="{{id}}" selected="selected">{{name}}</option>')(l)}else{h+=Handlebars.compile('<option value="{{id}}">{{name}}</option>')(l)}milestone_util.showMilestonePopup(m)})}$("#pipeline",b).html(h);console.log("adding");$("#pipeline",b).closest("div").find(".loading-img").hide();if(f&&typeof(f)==="function"){f(g,h)}}})}function populateMilestones(d,g,c,e,h,f){var b=Backbone.Model.extend({url:"/core/api/milestone/"+c});var a=new b();a.fetch({success:function(l){var j=l.toJSON();var k=j.milestones;console.log("------",l);var m=[];$.each(k.split(","),function(){m.push($.trim(this))});if(g){fillMilestones("move",m);return}fillTokenizedSelect("pipeline_milestone",m,function(){if(e&&e.milestone){$("#pipeline_milestone",d).find('option[value="'+e.milestone+'"]').attr("selected","selected")}if(h&&typeof(h)==="function"){var n='<option value="">Select...</option>';$.each(m,function(o,p){n+=Handlebars.compile('<option value="{{element}}">{{element}}</option>')({element:p})});h($(n))}},f)}})}function setupDealsTracksList(b){var a="";if(!this.trackListView){this.trackListView=new Deals_Track_Change_Events_Collection_View({url:"/core/api/milestone/pipelines",templateKey:"opportunity-track-list",individual_tag_name:"li",postRenderCallback:function(c){var d=trackListView.collection.models;if(d&&d.length==1){milestone_util.showMilestonePopup(d[0].toJSON(),function(e){if(e){trackListView.collection.get(e.id).set(new BaseModel(e),{silent:true})}})}else{if(d){milestone_util.isNotyVisible=false;$.each(d,function(e,f){milestone_util.showMilestonePopup(f.toJSON(),function(g){if(g){trackListView.collection.get(g.id).set(new BaseModel(g),{silent:true})}})})}}$.each(d,function(e,f){console.log(f.toJSON());if(pipeline_id==0&&f.toJSON().isDefault){pipeline_id=f.id;console.log("default pipeline set.");_agile_set_prefs("agile_deal_track",pipeline_id)}if(f.id==pipeline_id){a=f.attributes.name}});$("#deals-new-list-view",$("#opportunity-listners")).hide();$("#deals-new-milestone-view",$("#opportunity-listners")).show();$("#deals-tracks",$("#opportunity-listners")).show();setTimeout(function(){$("#deals-tracks .filter-dropdown",$("#opportunity-listners")).append(Handlebars.compile("{{name}}")({name:a}))},100);startGettingDeals();setupTracksAndMilestones($("#opportunity-listners"));if(d.length<=1){$("#deals-tracks",b).hide()}}});this.trackListView.collection.fetch();$("#deals-tracks",b).append(this.trackListView.render().el)}else{$("#deals-tracks",b).append(this.trackListView.render(true).el)}}function copyCursor(b,a){var c=b[0].get("dealCollection");if(c.length>0&&c.at(c.length-1).get("cursor")){a.cursor=c.at(c.length-1).get("cursor")}return a}function appendCustomfields(b,c){if(!App_Deals.custom_fields_list){$.ajax({url:"core/api/custom-fields/scope?scope=DEAL",type:"GET",dataType:"json",success:function(d){App_Deals.custom_fields_list=d;if(!c){var e="";$.each(d,function(g,f){e+=Handlebars.compile("<th>{{label}}</th>")({label:f.field_label})});$(b).find("#deal-list thead tr").append(e)}appendCustomFiledsData(b,d)}})}else{if(!c){var a="";$.each(App_Deals.custom_fields_list,function(e,d){a+=Handlebars.compile("<th>{{label}}</th>")({label:d.field_label})});$(b).find("#deal-list thead tr").append(a)}appendCustomFiledsData(b,App_Deals.custom_fields_list)}}function appendCustomFiledsData(b,a){var c=App_Deals.opportunityCollectionView.collection.models;$(b).find("td.deal_custom_replace").remove();$(b).find("#opportunities-model-list tr").each(function(d,e){var f="";$.each(a,function(h,g){if(g.field_type=="DATE"){f+='<td class="deal_custom_replace"><div class="text-ellipsis" style="width:6em">'+dealCustomFieldValueForDate(g.field_label,c[d].attributes.custom_data)+"</div></td>"}else{if(g.field_type=="CONTACT"){f+='<td class="deal_custom_replace" deal_contact_id="'+Handlebars.compile("{{id}}")({id:c[d].attributes.id})+"_"+Handlebars.compile("{{id}}")({id:g.id})+'"></td>'}else{if(g.field_type=="COMPANY"){f+='<td class="deal_custom_replace" deal_company_id="'+Handlebars.compile("{{id}}")({id:c[d].attributes.id})+"_"+Handlebars.compile("{{id}}")({id:g.id})+'"></td>'}else{f+='<td class="deal_custom_replace"><div class="text-ellipsis" style="width:6em">'+dealCustomFieldValue(g.field_label,c[d].attributes.custom_data)+"</div></td>"}}}});$(this).append(f)});dealCustomFieldValueForContact(b,a,c)}function dealCustomFieldValue(a,c){var b="";$.each(c,function(d,e){if(e.name==a){b=e.value}});return b}function dealCustomFieldValueForDate(a,c){var b="";$.each(c,function(d,f){if(f.name==a){if(!f.value){return""}var e=new Date(f.value);if(e=="Invalid Date"){b=getDateInFormatFromEpoc(f.value)}else{b=en.dateFormatter({raw:getGlobalizeFormat()})(e)}}});return b}function dealCustomFieldValueForContact(b,a,d){var c="";$.each(d,function(e,f){$.each(f.get("custom_data"),function(g,j){if(isContactTypeCustomField(a,j)||isCompanyTypeCustomField(a,j)){var h=JSON.parse(j.value);$.each(h,function(k,l){if(App_Deals.dealContactTypeCustomFields&&App_Deals.dealContactTypeCustomFields.collection&&!App_Deals.dealContactTypeCustomFields.collection.get(l)){c+=l+","}else{if(!App_Deals.dealContactTypeCustomFields){c+=l+","}}})}})});App_Deals.referenceContactsCollection=new Base_Collection_View({url:"/core/api/contacts/references?references="+c,sort_collection:false});if(c){App_Deals.referenceContactsCollection.collection.fetch({success:function(e){if(e&&e.length>0){if(App_Deals.dealContactTypeCustomFields&&App_Deals.dealContactTypeCustomFields.collection){App_Deals.dealContactTypeCustomFields.collection.add(e.toJSON())}else{App_Deals.dealContactTypeCustomFields=new Base_Collection_View({data:e.toJSON()})}}setupContactTypeCustomFields(b,a,d);hideTransitionBar()}})}else{setupContactTypeCustomFields(b,a,d);hideTransitionBar()}}function setupContactTypeCustomFields(b,a,c){$.each(c,function(d,e){var g={};var f={};$.each(a,function(j,h){$.each(e.get("custom_data"),function(k,o){if(o.name==h.field_label&&h.field_type=="CONTACT"){var m=[];var l=JSON.parse(o.value);$.each(l,function(q,r){var p=App_Deals.dealContactTypeCustomFields.collection.get(r);if(p){m.push(p.toJSON())}});g[e.id+"_"+o.name]=m}if(o.name==h.field_label&&h.field_type=="COMPANY"){var n=[];var l=JSON.parse(o.value);$.each(l,function(q,r){var p=App_Deals.dealContactTypeCustomFields.collection.get(r);if(p){n.push(p.toJSON())}});f[e.id+"_"+o.name]=n}})});$.each(a,function(j,h){$.each(e.get("custom_data"),function(k,p){if(p.name==h.field_label&&(h.field_type=="CONTACT"||h.field_type=="COMPANY")){var o=g[e.id+"_"+p.name];var m="contacts-custom-view-custom-contact";var n="deal_contact_id";var l="contact-type-image";if(h.field_type=="COMPANY"){m="contacts-custom-view-custom-company";n="deal_company_id";l="company-type-image";o=f[e.id+"_"+p.name]}getTemplate(m,o,undefined,function(r){if(!r){return}$(b).find("td["+n+"="+e.id+"_"+h.id+"]").html($(r).html());var q=false;$(b).find("td["+n+"="+e.id+"_"+h.id+"]").find("."+l).each(function(s,t){if(s>2){q=true;$(this).remove()}});if(q){$(b).find("td["+n+"="+e.id+"_"+h.id+"]").find("div:first").append("<div class='m-t' style='font-size:20px;'>...</div>")}},null)}})})})}function populateLostReasons(b,c){if(!$("#deal_lost_reason",b).hasClass("hidden")){$("#deal_lost_reason",b).addClass("hidden")
}var a=new Base_Collection_View({url:"/core/api/categories?entity_type=DEAL_LOST_REASON",sortKey:"label"});a.collection.fetch({success:function(j){var d=j.toJSON();var h='<option value="">Select...</option>';console.log(d);$.each(d,function(l,m){if(c&&c.lost_reason_id==m.id){h+=Handlebars.compile('<option value="{{id}}" selected="selected">{{label}}</option>')({label:m.label,id:m.id});$("#deal_lost_reason",b).removeClass("hidden")}else{h+=Handlebars.compile('<option value="{{id}}">{{label}}</option>')({label:m.label,id:m.id})}});$("#lost_reason",b).html(h);console.log("adding");$("#lost_reason",b).closest("div").find(".loading-img").hide();hideTransitionBar();if($("#pipeline_milestone",b).length>0){var g=false;var f=$("#pipeline_milestone",b).val();if(f!=""){var e=f.substring(0,f.indexOf("_"));var k=f.substring(f.indexOf("_")+1,f.length+1);$("#pipeline_milestone",b).closest("form").find("#pipeline").val(e);$("#pipeline_milestone",b).closest("form").find("#milestone").val(k);console.log(e,"-----------",k);$("#pipeline_milestone",b).find("option").each(function(){if($(this).css("display")=="none"&&$(this).val()==f){g=true}})}if(g&&$("#lost_reason",$("#pipeline_milestone",b).closest(".modal")).find("option").length>1){$("#deal_lost_reason",$("#pipeline_milestone",b).closest(".modal")).removeClass("hidden")}else{$("#lost_reason",$("#pipeline_milestone",b).closest(".modal")).val("");$("#deal_lost_reason",$("#pipeline_milestone",b).closest(".modal")).addClass("hidden")}}else{if($("#lost_reason",b).find("option").length>1){$("#dealLostReasonModal").modal("show")}}}})}function populateDealSources(b,c){if(!$("#deal_deal_source",b).hasClass("hidden")){$("#deal_deal_source",b).addClass("hidden")}var a=new Base_Collection_View({url:"/core/api/categories?entity_type=DEAL_SOURCE",sort_collection:false});a.collection.fetch({success:function(f){var d=f.toJSON();var e='<option value="">Select...</option>';console.log(d);$.each(d,function(h,g){if(c&&c.deal_source_id==g.id){e+=Handlebars.compile('<option value="{{id}}" selected="selected">{{label}}</option>')({label:g.label,id:g.id});$("#deal_deal_source",b).removeClass("hidden")}else{e+=Handlebars.compile('<option value="{{id}}">{{label}}</option>')({label:g.label,id:g.id})}});$("#deal_source",b).html(e);console.log("adding");$("#deal_source",b).closest("div").find(".loading-img").hide();hideTransitionBar();if($("#deal_source",b).find("option").length>1){$("#deal_deal_source",b).removeClass("hidden")}}})}function fetchDealsList(c){var e=c;var d;if(!e&&App_Deals.deal_filters&&App_Deals.deal_filters.collection){e=App_Deals.deal_filters.collection}if(e.dealToFilter){d=e.dealToFilter}setNewDealFilters(e);var b="";var a="core/api/deal/filters/query/list/"+_agile_get_prefs("deal-filter-name")+"?order_by="+getDealSortFilter();if(d){a="core/api/deal/filters/query/list/tags/"+d+"?order_by="+getDealSortFilter();$("#opportunity-listners").find("#opp-header").after('<ul id="added-tags-ul" class="tagsinput inline v-top m-b-sm p-n" style="margin-left:10px;"><li class="inline-block tag btn btn-xs btn-primary" data='+d+"><span>"+d+'<a href="#deals" class="anchor close m-l-xs pull-right">×</a></span></li></ul>')}App_Deals.opportunityCollectionView=new Deals_Milestone_Events_Collection_View({url:""+a,templateKey:"opportunities",individual_tag_name:"tr",sort_collection:false,cursor:true,page_size:25,postRenderCallback:function(f){$("#deals-new-milestone-view",$("#opportunity-listners")).hide();$("#deals-tracks",$("#opportunity-listners")).hide();$("#deals-new-list-view",$("#opportunity-listners")).show();if(pipeline_id==1){pipeline_id=0}appendCustomfields(f,false);includeTimeAgo(f);initializeDealListners(f);contactListener();setTimeout(function(){$("#delete-checked",f).attr("id","deal-delete-checked")},500)},appendItemCallback:function(f){appendCustomfields(f,true);includeTimeAgo(f)}});App_Deals.opportunityCollectionView.collection.fetch();$(".new-collection-deal-list",$("#opportunity-listners")).html(App_Deals.opportunityCollectionView.render().el)}function setupMilestoneViewWidth(){var e=trackListView.collection.get(pipeline_id).toJSON();var b=e.milestones.split(",");var d=b.length;if(!d){return}var c=100/d;if(_agile_get_prefs("deal-milestone-view")){if(_agile_get_prefs("deal-milestone-view")=="compact"&&d>8){c=100/8}if(_agile_get_prefs("deal-milestone-view")=="fit"){$("#opportunities-by-paging-model-list",$("#opportunity-listners")).find(".milestone-column").css("min-width",0)}}else{if(d>5){c=100/5}}var a=$("#opportunities-by-paging-model-list",$("#opportunity-listners")).find(".milestone-column");a.each(function(f){if(f!=a.length-1){$(this).width((c-1)+"%")}else{$(this).width(c+"%")}})}function deleteDeal(g,f,e,c){var b=[];var a={};b.push(g);a.ids=JSON.stringify(b);var d=c;$.ajax({url:"core/api/opportunity/"+g,type:"DELETE",success:function(){IS_DEAL_DELETED=true;var q=DEALS_LIST_COLLECTION.collection.where({heading:f});if(!q){return}var l=q[0].get("dealCollection").get(g);var s=l.attributes.expected_value;var k=parseFloat($("#"+f.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))-parseFloat(s);$("#"+f.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(k));$("#"+f.replace(/ +/g,"")+"_count").text(parseInt($("#"+f.replace(/ +/g,"")+"_count").text())-1);var h=0;var m=parseInt($("#"+f.replace(/ +/g,"")+"_count").text());if(m==0){avg_new_deal_size=0}else{avg_new_deal_size=k/m}k=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(k);avg_new_deal_size=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(avg_new_deal_size);var r=f.replace(/ +/g,"");var j=getCurrencySymbolForCharts();$("#"+r+" .dealtitle-angular").removeAttr("data");var p=$("#pipeline-tour-step").children(".filter-dropdown").text();var n={dealTrack:p,heading:r,dealcount:k,avgDeal:avg_new_deal_size,symbol:j,dealNumber:m};var o=JSON.stringify(n);$("#"+r+" .dealtitle-angular").attr("data",o);q[0].get("dealCollection").remove(q[0].get("dealCollection").get(g));$(d).closest("li").css("display","none");pieMilestones();dealsLineChart()},error:function(h){if(h&&h.status==403){showModalConfirmation("Delete Deal",h.responseText,function(){return},function(){return},function(){return},"Cancel");return}$(".error-status",$("#opportunity-listners")).html(h.responseText);setTimeout(function(){$(".error-status",$("#opportunity-listners")).html("")},2000);console.log("-----------------",h.responseText)}})}function setupTracksAndMilestones(c){if(trackListView&&trackListView.collection){var a=trackListView.collection.models;var b=true;$.each(a,function(e,j){var d=j.toJSON();if(_agile_get_prefs("agile_deal_track")!=d.id.toString()&&d.milestones){var g="m-b-lg";if(e==a.length-1){g=""}if(b){$("#new-track-list-paging").find("#moving-tracks").html("<div style='font-size:18px;' class='m-t-xs'>Tracks & Milestones</div>");g+=" m-t-sm";b=false}$("#new-track-list-paging").find("#moving-tracks").append("<div class='"+g+" p-r'><div class='text-md m-b-xs'>"+d.name+"</div><div id='"+d.id+"' style='border: 1px solid #dee5e7;'></div></div>");var f=d.milestones.split(",");var h=100/f.length;$.each(f,function(m,p){var r="milestone-heading";var n="<span></span>";var l="";if(m==f.length-1){r="";n="";l="border-right:none!important;"}var q='<div class="milestone-column panel m-b-none b-n r-n panel-default" style="width: '+h+"%;min-width:0px;"+l+'"><div class="dealtitle-angular panel-heading c-p b-n update-drag-deal" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="{{milestone_name}}"><div class="'+r+' text-left text-ellipsis" data-track="{{track_id}}"><span class="miltstone-title text-base text-ellipsis inline-block v-bottom pull-left">{{milestone_name}}</span></div>'+n+"</div></div>";var k=Handlebars.compile(q);var o={milestone_name:p,track_id:d.id};$("#"+d.id,$("#new-track-list-paging")).append(k(o));$("[data-toggle=tooltip").tooltip()})}})}}var Deals_Milestone_Events_Collection_View=Base_Collection_View.extend({events:{"click .deal-edit":"dealEdit","click .deal-delete":"dealDelete","click .deal-archive":"dealArchive","click .deal-restore":"dealRestore","click #bulk_deals_owner_change":"bulkDealsOwnerChange","click #bulk_deals_milestone_change":"bulkDealsMilestoneChange","click #bulk_deals_add_tag_to_contacts":"bulkDealsAddTagToContacts","click #bulk_deals_add_campaign_to_contacts":"bulkDealsAddCampaignToContacts","click #bulk_deals_archive":"bulkDealsArchive","click #bulk_deals_restore":"bulkDealsRestore","click #bulk_deals_delete":"bulkDealsDelete","click #select-all-available-deals":"selectAllAvailableDeals","click #select-choosen-deals":"selectChoosenDeals"},dealEdit:function(c){c.preventDefault();var f=$(c.currentTarget).closest(".data").attr("id");var d=($(c.currentTarget).closest("ul").attr("milestone")).trim();var a;var b=DEALS_LIST_COLLECTION.collection.where({heading:d});if(!b){return}a=b[0].get("dealCollection").get(f).toJSON();if(a){updateDeal(a,true)}},dealDelete:function(c){c.preventDefault();var f=$(c.currentTarget).closest(".data").attr("id");var d=($(c.currentTarget).closest("ul").attr("milestone")).trim();var b=DEALS_LIST_COLLECTION.collection.where({heading:d});var a=c.currentTarget;if(b){if(!hasScope("DELETE_DEALS")){$("#deal_delete_privileges_error_modal").html(getTemplate("deal-delete-privileges-error-modal")).modal("show");return}else{showAlertModal("Delete","Confirm",function(){deleteDeal(f,d,b,a)});return}}else{showAlertModal("Delete","Confirm",function(){deleteDeal(f,d,b,a)});return}deleteDeal(f,d,b,a)},dealArchive:function(b){b.preventDefault();var a={};a.id=$(b.currentTarget).closest(".data").attr("id");a.milestone=($(b.currentTarget).closest("ul").attr("milestone")).trim();$("#deal_archive_confirm_modal").html(getTemplate("archive-deal"));$("#archived-deal-id",$("#deal_archive_confirm_modal")).val(a.id);$("#archived-deal-milestone",$("#deal_archive_confirm_modal")).val(a.milestone);$("#deal_archive_confirm_modal").modal("show")},dealRestore:function(b){b.preventDefault();
var a={};a.id=$(b.currentTarget).closest(".data").attr("id");a.milestone=($(b.currentTarget).closest("ul").attr("milestone")).trim();$("#deal_restore_confirm_modal").html(getTemplate("restore-deal"));$("#restored-deal-id",$("#deal_restore_confirm_modal")).val(a.id);$("#restored-deal-milestone",$("#deal_restore_confirm_modal")).val(a.milestone);$("#deal_restore_confirm_modal").modal("show")},bulkDealsOwnerChange:function(a){a.preventDefault();getTemplate("deal-owner-change-modal",{},undefined,function(b){if(!b){return}$("#deal_owner_change_modal").html($(b));if(!hasScope("EDIT_CONTACT")){$("#owners",$("#deal_owner_change_modal")).parent().before("<div class='control-group form-group col-md-12'>"+DEALS_CONTACTS_BULK_OWNER_CHANGE_ERROR+"</div>")}$("#deal_owner_change_modal").modal("show");populateUsers("owners-list-bulk",$(b),undefined,undefined,function(d,c){console.log(c);$("#deal_owner_change_modal").find("#owners-list-bulk").html(c);$("#owners-list-bulk",$("#deal_owner_change_modal")).closest("div").find(".loading").hide()});$("#deal_owner_change_modal").off("click","#deal-bulk-owner");$("#deal_owner_change_modal").on("click","#deal-bulk-owner",function(c){c.preventDefault();deal_bulk_actions.bulkOwnerChangeDeals()})},"#owners-list-bulk")},bulkDealsMilestoneChange:function(a){a.preventDefault();getTemplate("deal-mile-change-modal",{},undefined,function(b){if(!b){return}if(!hasScope("UPDATE_DEALS")&&hasScope("VIEW_DEALS")){showModalConfirmation("Bulk Update","You may not have permission to update some of the deals selected. Proceeding with this operation will update only the deals that you are permitted to update.<br/><br/> Do you want to proceed?",function(){$("#deal_mile_change_modal").html($(b)).modal("show")})}else{$("#deal_mile_change_modal").html($(b));if(!hasScope("EDIT_CONTACT")){$("#bulk_mile_Form",$("#deal_mile_change_modal")).children(":first").before("<div class='control-group form-group'>"+DEALS_CONTACTS_BULK_UPDATE_ERROR+"</div>")}$("#deal_mile_change_modal").modal("show")}populateTracks($(b),undefined,undefined,function(d,c){console.log(c);$("#deal_mile_change_modal").find("#pipeline-list-bulk").html(c);$("#pipeline-list-bulk",$("#deal_mile_change_modal")).closest("div").find(".loading").hide();$("#pipeline-list-bulk, #deal_mile_change_modal").trigger("change")});$("#deal_mile_change_modal").off("change","#pipeline-list-bulk");$("#deal_mile_change_modal").on("change","#pipeline-list-bulk",function(d){d.preventDefault();var c=$("#pipeline-list-bulk",$("#deal_mile_change_modal")).val();populateMilestones($(b),undefined,c,undefined,function(e){console.log(e);$("#deal_mile_change_modal").find("#milestone-list-bulk").html(e);$("#milestone-list-bulk",$("#deal_mile_change_modal")).closest("div").find(".loading").hide()})});$("#deal_mile_change_modal").off("click","#deal-bulk-mile");$("#deal_mile_change_modal").on("click","#deal-bulk-mile",function(c){c.preventDefault();deal_bulk_actions.bulkMilestoneChange($(c.currentTarget))})},"#pipeline-list-bulk")},bulkDealsAddTagToContacts:function(a){a.preventDefault();getTemplate("deal-contact-add-tag-modal",{},undefined,function(b){if(!b){return}$("#deal_contact_add_tag_modal").html($(b));if(!hasScope("EDIT_CONTACT")){$("#dealContactTagsBulkForm",$("#deal_contact_add_tag_modal")).children(":first").before("<div class='control-group form-group col-md-12'>"+DEALS_CONTACTS_BULK_TAGS_ERROR+"</div>")}$("#deal_contact_add_tag_modal").modal("show");setup_tags_typeahead();$("#deal_contact_add_tag_modal").off("click","#deal-contact-add-tag");$("#deal_contact_add_tag_modal").on("click","#deal-contact-add-tag",function(c){c.preventDefault();deal_bulk_actions.bulkAddDealContactTags($(c.currentTarget))})},"")},bulkDealsAddCampaignToContacts:function(a){a.preventDefault();getTemplate("deal-contact-add-camp-modal",{},undefined,function(b){if(!b){return}$("#deal_contact_add_camp_modal").html($(b)).modal("show");deal_bulk_actions.fillCampaignsList($("#workflows-list-bulk",$("#deal_contact_add_camp_modal")));$("#deal_contact_add_camp_modal").off("click","#deal-contact-add-camp");$("#deal_contact_add_camp_modal").on("click","#deal-contact-add-camp",function(c){c.preventDefault();deal_bulk_actions.bulkAddDealContactsToCamp($(c.currentTarget))})},"")},bulkDealsArchive:function(b){b.preventDefault();var a="deal-bulk-archive-modal";if(!hasScope("UPDATE_DEALS")&&hasScope("VIEW_DEALS")){a="deal-bulk-archive-acl-modal"}getTemplate(a,{},undefined,function(c){if(!c){return}if(!hasScope("UPDATE_DEALS")&&hasScope("VIEW_DEALS")){$("#deal_bulk_archive_acl_modal").html($(c)).modal("show")}else{$("#deal_bulk_archive_modal").html($(c));if(!hasScope("EDIT_CONTACT")){$(".modal-body",$("#deal_bulk_archive_modal")).html(DEALS_CONTACTS_BULK_ARCHIVE_ERROR)}$("#deal_bulk_archive_modal").modal("show")}$("#deal_bulk_archive_modal").off("click","#deal-bulk-archive");$("#deal_bulk_archive_modal").on("click","#deal-bulk-archive",function(d){d.preventDefault();deal_bulk_actions.bulkArchiveDeals(false)});$("#deal_bulk_archive_acl_modal").off("click","#deal-bulk-archive-acl");$("#deal_bulk_archive_acl_modal").on("click","#deal-bulk-archive-acl",function(d){d.preventDefault();deal_bulk_actions.bulkArchiveDeals(true)})},"")},bulkDealsRestore:function(b){b.preventDefault();var a="deal-bulk-restore-modal";if(!hasScope("UPDATE_DEALS")&&hasScope("VIEW_DEALS")){a="deal-bulk-restore-acl-modal"}getTemplate(a,{},undefined,function(c){if(!c){return}if(!hasScope("UPDATE_DEALS")&&hasScope("VIEW_DEALS")){$("#deal_bulk_restore_acl_modal").html($(c)).modal("show")}else{$("#deal_bulk_restore_modal").html($(c));if(!hasScope("EDIT_CONTACT")){$(".modal-body",$("#deal_bulk_restore_modal")).html(DEALS_CONTACTS_BULK_RESTORE_ERROR)}$("#deal_bulk_restore_modal").modal("show")}$("#deal_bulk_restore_modal").off("click","#deal-bulk-restore");$("#deal_bulk_restore_modal").on("click","#deal-bulk-restore",function(d){d.preventDefault();deal_bulk_actions.bulkRestoreDeals(false)});$("#deal_bulk_restore_acl_modal").off("click","#deal-bulk-restore-acl");$("#deal_bulk_restore_acl_modal").on("click","#deal-bulk-restore-acl",function(d){d.preventDefault();deal_bulk_actions.bulkRestoreDeals(true)})},"")},bulkDealsDelete:function(b){b.preventDefault();var a="deal-bulk-delete-modal";if(!hasScope("DELETE_DEALS")){a="deal-bulk-delete-acl-modal"}getTemplate(a,{},undefined,function(c){if(!c){return}if(!hasScope("DELETE_DEALS")){$("#deal_bulk_delete_acl_modal").html($(c)).modal("show");return}else{$("#deal_bulk_delete_modal").html($(c));if(!hasScope("EDIT_CONTACT")){$(".modal-body",$("#deal_bulk_delete_modal")).html(DEALS_CONTACTS_BULK_DELETE_ERROR)}$("#deal_bulk_delete_modal").modal("show")}$("#deal_bulk_delete_modal").off("click","#deal-bulk-delete");$("#deal_bulk_delete_modal").on("click","#deal-bulk-delete",function(d){d.preventDefault();deal_bulk_actions.bulkDeleteDeals(false)});$("#deal_bulk_delete_acl_modal").off("click","#deal-bulk-delete-acl");$("#deal_bulk_delete_acl_modal").on("click","#deal-bulk-delete-acl",function(d){d.preventDefault();deal_bulk_actions.bulkDeleteDeals(true)})},"")},selectAllAvailableDeals:function(a){a.preventDefault();SELECT_ALL_DEALS=true;deal_bulk_actions.getAvailableDeals(function(d){var c=d;var b=deal_bulk_actions.numberWithCommas(c);if(c>1000){b=deal_bulk_actions.numberWithCommas(c-1)+"+"}$("body").find("#bulk-select").html("Selected "+b+" deals. <a id='select-choosen-deals' href='#'>Select choosen deals only.</a>")})},selectChoosenDeals:function(a){a.preventDefault();SELECT_ALL_DEALS=false;deal_bulk_actions.getAvailableDeals(function(d){var c=d;var b=deal_bulk_actions.numberWithCommas(c);if(c>1000){b=deal_bulk_actions.numberWithCommas(c-1)+"+"}$("body").find("#bulk-select").html("Selected "+deal_bulk_actions.numberWithCommas(App_Deals.opportunityCollectionView.collection.length)+" deals. <a id='select-all-available-deals' class='text-info' href='#'>Select all "+b+" deals</a>")})}});var Deals_Track_Change_Events_Collection_View=Base_Collection_View.extend({events:{"click #opportunity-track-list-model-list a.pipeline":"dealTrackChange"},dealTrackChange:function(c){c.preventDefault();if(pipeline_id==$(c.currentTarget).attr("id")){return}_agile_set_prefs("agile_deal_track",$(c.currentTarget).attr("id"));if(_agile_get_prefs("deal-filters")){var b=$.parseJSON(_agile_get_prefs("deal-filters"));var a=$(c.currentTarget).attr("id");if(a=="1"){b.pipeline_id=""}else{b.pipeline_id=$(c.currentTarget).attr("id")}_agile_set_prefs("deal-filters",JSON.stringify(b))}pipeline_id=_agile_get_prefs("agile_deal_track");$("#milestone-view-track",$("#opportunity-listners")).html('<i class="icon-road m-r-xs"/>'+$(c.currentTarget).text());startGettingDeals();setupTracksAndMilestones($("#opportunity-listners"))}});var Deals_Filter_Change_Events_Collection_View=Base_Collection_View.extend({events:{"click .deal-filter":"filterChange","click .default_deal_filter":"defaultFilterChange"},filterChange:function(a){a.preventDefault();var c=$(a.currentTarget).attr("id");if(c==_agile_get_prefs("deal-filter-name")){return}var b;var d={};if(c=="my-deals"){d.owner_id=CURRENT_DOMAIN_USER.id;d.pipeline_id=_agile_get_prefs("agile_deal_track");d.milestone="";d.archived="false";d.value_filter="equals"}else{b=App_Deals.deal_filters.collection.get(c);d=b.toJSON();d.filterOwner={}}_agile_set_prefs("deal-filters",JSON.stringify(d));_agile_set_prefs("deal-filter-name",c);if(!_agile_get_prefs("agile_deal_view")){if(c&&c!="my-deals"){$("#opportunity-listners").find("h3").find(".remove_deal_filter").parent().remove();$("#opportunity-listners").find("h3").find("small").after('<div class="inline-block tag btn btn-xs btn-primary m-l-xs"><span class="inline-block m-r-xs v-middle pull-left">'+$(a.currentTarget).text()+'</span><a class="close remove_deal_filter">×</a></div>')}if(c&&c=="my-deals"){$("#opportunity-listners").find("h3").find(".remove_deal_filter").parent().remove();$("#opportunity-listners").find("h3").find("small").after('<div class="inline-block tag btn btn-xs btn-primary m-l-xs"><span class="inline-block m-r-xs v-middle pull-left">My Deals</span><a class="close remove_deal_filter">×</a></div>')
}startGettingDeals();setupTracksAndMilestones($("#opportunity-listners"))}else{fetchDealsList()}},defaultFilterChange:function(a){a.preventDefault();if(!_agile_get_prefs("deal-filter-name")){return}_agile_delete_prefs("deal-filter-name");_agile_delete_prefs("deal-filters");setupDefaultDealFilters();$("#opportunity-listners").find("h3").find(".remove_deal_filter").parent().remove();if(!_agile_get_prefs("agile_deal_view")){startGettingDeals();setupTracksAndMilestones($("#opportunity-listners"))}else{fetchDealsList()}}});var RELOAD_DEALS=false;var SELECT_ALL_DEALS=false;var DEALS_BULK_MESSAGE="Bulk operation is in progress. You will be notified when it is done.";var deal_bulk_actions={numberWithCommas:function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},postBulkActionDealsData:function(c,a,e,d){var b={};if(!SELECT_ALL_DEALS){b.ids=JSON.stringify(deal_bulk_actions.getDealsBulkIds())}b.filter=_agile_get_prefs("deal-filter-name");if(a){b.form=JSON.stringify(serializeForm(a))}console.log(b);$.ajax({url:c,type:"POST",data:b,contentType:"application/x-www-form-urlencoded",success:function(g){$save_info=$('<div style="display:inline-block"><small><p class="text-success"><i>'+_agile_get_translated_val("bulk-actions","task-scheduled")+".</i></p></small></div>");if(a!==undefined){var f=$("#"+a).find(".form-actions");if(f.find(".text-success")){f.find(".text-success").parent().parent().remove()}f.append($save_info)}RELOAD_DEALS=true;if(e&&typeof(e)==="function"){e(g)}if(d==="no_noty"){return}if(!d){showNotyPopUp("information",_agile_get_translated_val("bulk-actions","task-scheduled"),"top",5000);return}showNotyPopUp("information",d,"top",5000)}})},bulkRestoreDeals:function(b){var a="/core/api/opportunity/bulk/restore";deal_bulk_actions.postBulkActionDealsData(a,undefined,function(){if(b){$("#deal_bulk_restore_acl_modal").modal("hide")}else{$("#deal_bulk_restore_modal").modal("hide")}},DEALS_BULK_MESSAGE)},bulkArchiveDeals:function(b){var a="/core/api/opportunity/bulk/archive";deal_bulk_actions.postBulkActionDealsData(a,undefined,function(){if(b){$("#deal_bulk_archive_acl_modal").modal("hide")}else{$("#deal_bulk_archive_modal").modal("hide")}},DEALS_BULK_MESSAGE)},bulkOwnerChangeDeals:function(){var b=$("#owners-list-bulk",$("#deal_owner_change_modal")).val();var a="/core/api/opportunity/bulk/change-owner/"+b;deal_bulk_actions.postBulkActionDealsData(a,undefined,function(){$("#deal_owner_change_modal").modal("hide")},DEALS_BULK_MESSAGE)},bulkAddDealContactsToCamp:function(c){disable_save_button(c);var b=$("#workflows-list-bulk",$("#deal_contact_add_camp_modal")).val();var a="/core/api/opportunity/bulk/contacts/add-campaign/"+b;deal_bulk_actions.postBulkActionDealsData(a,undefined,function(){enable_save_button(c);$("#deal_contact_add_camp_modal").modal("hide")},DEALS_BULK_MESSAGE)},bulkAddDealContactTags:function(f){if(f.attr("disabled")){return}disable_save_button(f);var e="dealContactTagsBulkForm";var b=serializeForm(e).tags;if(b.length==0){$("#addBulkTags").focus();$(".error-tags").show().delay(3000).hide(1);enable_save_button(f);return false}if(b.length>0){var g=true;$.each(b,function(h,j){if(!isValidTag(j,false)){g=false;return false}});if(!g){$(".invalid-tags").show().delay(6000).hide(1);enable_save_button(f);return false}var d=$("#addBulkTags").val().trim();$("#addBulkTags").val("");if(d&&d.length>=0&&!(/^\s*$/).test(d)){var c=Handlebars.compile('<li class="tag" style="display: inline-block;" data="{{name}}">{{name}}<a class="close" id="remove_tag" tag="{{name}}">&times</a></li>');$("#addBulkTags").closest(".control-group").find("ul.tags").append(c({name:d}))}var a="/core/api/opportunity/bulk/contacts/add-tag";deal_bulk_actions.postBulkActionDealsData(a,e,function(){enable_save_button(f);$("ul.tagsinput",$("#deal_contact_add_tag_modal")).html("");$("#deal_contact_add_tag_modal").modal("hide")},DEALS_BULK_MESSAGE)}},bulkDeleteDeals:function(b){var a="/core/api/opportunity/bulk";deal_bulk_actions.postBulkActionDealsData(a,undefined,function(){if(b){$("#deal_bulk_delete_acl_modal").modal("hide")}else{$("#deal_bulk_delete_modal").modal("hide")}},DEALS_BULK_MESSAGE)},bulkMilestoneChange:function(c){if(c.attr("disabled")){return}disable_save_button(c);var b="bulk_mile_Form";if(!isValidForm("#"+b)){enable_save_button(c);return false}var a="/core/api/opportunity/bulk/change-milestone";deal_bulk_actions.postBulkActionDealsData(a,b,function(){enable_save_button(c);$("#deal_mile_change_modal").modal("hide")},DEALS_BULK_MESSAGE)},getAvailableDeals:function(d){if(App_Deals.opportunityCollectionView&&App_Deals.opportunityCollectionView.collection.length>0){var a=App_Deals.opportunityCollectionView.collection.models[0].toJSON();if(a.count&&d){return d(a.count)}}var b="";if(_agile_get_prefs("deal-filters")){b="&filters="+encodeURIComponent(getDealFilters())}var c=new Base_Model_View({url:"core/api/opportunity/based/count?pipeline_id="+pipeline_id+b,template:"",isNew:true});c.model.fetch({success:function(f){hideTransitionBar();var e=f.get("count")?f.get("count"):0;if(App_Deals.opportunityCollectionView.collection&&App_Deals.opportunityCollectionView.collection.models[0]){App_Deals.opportunityCollectionView.collection.models[0].set({count:e},{silent:true})}if(e&&d){return d(e)}if(!e&&d){return d(App_Deals.opportunityCollectionView.collection.length)}}})},getDealsBulkIds:function(){var b=0;var a=[];$.each($(".tbody_check",$("#opportunity-listners")),function(c,d){if($(d).is(":checked")){b++;a.push($(d).closest("tr").data().get("id"))}});console.log("Number of deals selected = ",b);return a},fillCampaignsList:function(a){$.ajax({url:"core/api/workflows",type:"GET",dataType:"json",success:function(c){var b="";$.each(c,function(e,d){var f='<option value="{{id}}">{{name}}</option></th>';if(d.is_disabled){f='<option value="{{id}}" disabled = disabled>{{name}} ('+_agile_get_translated_val("campaigns","disabled")+")</option>"}b+=Handlebars.compile(f)({id:d.id,name:d.name})});a.html(b);return c}})},toggle_deals_bulk_actions_dropdown:function(c,b,a){if(!_agile_get_prefs("agile_deal_view")){return}SELECT_ALL_DEALS=false;_BULK_DEALS=undefined;console.log("deal bulk actions.");deal_bulk_actions.getAvailableDeals(function(g){var f=g;if($(c).is(":checked")){$("body").find("#bulk-actions").css("display","inline-block");var e=deal_bulk_actions.numberWithCommas(f);if(f>1000){e=deal_bulk_actions.numberWithCommas(f-1)+"+"}if(b&&f!=App_Deals.opportunityCollectionView.collection.length){$("body").find("#bulk-select").show().html("Selected "+deal_bulk_actions.numberWithCommas(App_Deals.opportunityCollectionView.collection.length)+" deals. <a id='select-all-available-deals' class='text-info' href='#'>Select all "+e+" deals</a>")}}else{if(b){$("#bulk-actions,#bulk-select").css("display","none");return}else{if($("#bulk-select").is(":visible")){$("#bulk-select").css("display","none")}}var d=0;$.each($(".tbody_check"),function(h,j){if($(j).is(":checked")){d++;return false}});if(d==0){$("#bulk-actions").css("display","none")}}})}};$(function(){$(".deal_bulk_modal").on("show.bs.modal",function(){var a=this;deal_bulk_actions.getAvailableDeals(function(d){var c=d;var b=deal_bulk_actions.numberWithCommas(c);if(c>1000){b=deal_bulk_actions.numberWithCommas(c-1)+"+"}if(SELECT_ALL_DEALS){$(a).find("span.count").text(b)}else{$(a).find("span.count").text(deal_bulk_actions.numberWithCommas(deal_bulk_actions.getDealsBulkIds().length))}RELOAD_DEALS=false})});$(".deal_bulk_modal").on("hidden.bs.modal",function(a){if(RELOAD_DEALS){fetchDealsList()}$(this).find(".help-line").remove()})});$(function(){$("body").on("click",".deals-add",function(a){a.preventDefault();show_deal();setup_tags_typeahead()});$("#opportunityUpdateModal, #opportunityModal").off("click","#opportunity_archive");$("#opportunityUpdateModal, #opportunityModal").on("click","#opportunity_archive",function(a){a.preventDefault();$("#archived",$("#opportunityUpdateForm")).prop("checked","checked");$("#opportunityUpdateModal #opportunity_validate").trigger("click")});$("#opportunityUpdateModal, #opportunityModal").off("click","#opportunity_unarchive");$("#opportunityUpdateModal, #opportunityModal").on("click","#opportunity_unarchive",function(a){a.preventDefault();$("#archived",$("#opportunityUpdateForm")).removeAttr("checked");$("#opportunityUpdateModal #opportunity_validate").trigger("click")});$("#opportunityUpdateModal, #opportunityModal").off("click","#opportunity_validate");$("#opportunityUpdateModal, #opportunityModal").on("click","#opportunity_validate",function(f){f.preventDefault();var b={"#ee82ee":"VIOLET","#4b0082":"INDIGO","#0000ff":"BLUE","#00ff00":"GREEN","#ffff00":"YELLOW","#ff6600":"ORANGE","#ff0000":"RED","#000000":"BLACK","#ffffff":"WHITE","#808080":"GREY"};var d=$(this).closest(".opportunity-modal").attr("id");var k=$(this).closest(".opportunity-modal").find("form").attr("id");var g=$(this).closest(".opportunity-modal").find("form").find("#color1").val();var m=serializeForm(k);m.custom_data=serialize_custom_fields(k);m.colorName=b[g];var a;if(!a){a=k}var h=get_tags(a);var c;var n;for(c=0;c<h.length;c++){if(h[c].name=="tags"&&h[c].value!=""){n=h[c]}}if(n!=undefined&&n.length!=0){m.tags=[];var j=true;if(!m.tagsWithTime||m.tagsWithTime.length==0){$.each(n.value,function(e,o){if(!isValidTag(o,false)){j=false;return false}});m.tagsWithTime=[];$.each(n.value,function(e,o){m.tagsWithTime.push({tag:o})})}else{var l=[];$.each(n.value,function(e,o){var p=true;$.each(m.tagsWithTime,function(r,q){if(o==q.tag){l.push(q);p=false;return false}});if(p){l.push({tag:o});if(!isValidTag(o,false)){j=false;return false}}});m.tagsWithTime=l}if(!j){$(".invalid-tags-person").show().delay(6000).hide(1);enable_save_button($(saveBtn));return false}}console.log(m);if(k=="opportunityForm"){saveDeal(k,d,this,m,false)}else{saveDeal(k,d,this,m,true)}});$("#opportunity-listners").off("mouseenter","#opportunities-model-list > tr");$("#opportunity-listners").on("mouseenter","#opportunities-model-list > tr",function(d){var c=$(this).find(".data").attr("data");
var b=App_Deals.opportunityCollectionView.collection.get(c);var a=this;getTemplate("opportunity-detail-popover",b.toJSON(),undefined,function(f){if(!f){return}var e=$(f);console.log(e);console.log(a);$(a).popover({rel:"popover",trigger:"hover",placement:"right","original-title":b.toJSON().name,content:e,html:true,container:"body"});$("#opportunities-model-list > tr:last").popover({rel:"popover",trigger:"hover",placement:"top","original-title":b.toJSON().name,content:e,html:true,container:"body"});$(a).popover("show")},null)});$("#opportunity-listners").off("mouseleave","#opportunities-model-list > tr");$("#opportunity-listners").on("mouseleave","#opportunities-model-list > tr",function(a){$(this).popover("hide")});$("#opportunity-listners").off("click","#opportunities-model-list > tr, .hide-popover");$("#opportunity-listners").on("click","#opportunities-model-list > tr, .hide-popover",function(a){$(this).closest("tr").popover("hide")});$("#opportunity-listners").off("click","#close-deal");$("#opportunity-listners").on("click","#close-deal",function(a){a.preventDefault();window.history.back()})});function initializeDealListners(a){$("#opportunity-listners").off("change","#deal-cd-condition .deal-cd-value");$("#opportunity-listners").on("change","#deal-cd-condition .deal-cd-value",function(b){if(this.value=="BETWEEN"){$("#deal-cd-rhs").parent().removeClass("hide");$("#deal-cd-rhs-new").parent().removeClass("hide");$("#cd-value").parent().addClass("hide")}else{if(this.value=="ON"||(this.value=="AFTER"||this.value=="BEFORE")){$("#deal-cd-rhs").parent().removeClass("hide");$("#deal-cd-rhs-new").parent().addClass("hide");$("#cd-value").parent().addClass("hide")}else{if(this.value=="LAST"||this.value=="NEXT"){$("#cd-value").parent().removeClass("hide");$("#deal-cd-rhs-new").parent().addClass("hide");$("#deal-cd-rhs").parent().addClass("hide")}}}});$("#opportunity-listners").off("click",".deals-list-view");$("#opportunity-listners").on("click",".deals-list-view",function(b){b.preventDefault();if(_agile_get_prefs("agile_deal_view")){return}_agile_set_prefs("agile_deal_view","list_view");fetchDealsList()});$("#opportunity-listners").off("change","#pipeline");$("#opportunity-listners").on("change","#pipeline",function(c){var b=$(this).closest("form");if(!$(this).val()){$("#milestone",b).find('option[value!=""]').remove();$("#milestone",b).find('option[value=""]').text("Any");return}$("#milestone",b).closest("div").find(".loading-img").show();populateMilestones(b,undefined,$(this).val(),undefined,function(d){$("#milestone",b).html(d);$("#milestone",b).closest("div").find(".loading-img").hide()});if(b&&$(b).attr("id")=="dealsFilterForm"){setTimeout(function(){$("#milestone",b).find('option[value=""]').text("Any")},500)}});$("#opportunity-listners").off("change","#filter_pipeline");$("#opportunity-listners").on("change","#filter_pipeline",function(g){var f=$(this).closest("form");var c=$("#filter_pipeline",f).val();if(c){var b=Backbone.Model.extend({url:"/core/api/milestone/"+c});var d=new b();d.fetch({success:function(j){var h=j.toJSON();var e=h.milestones;milestonesList=e.split(",");$("#milestone").html("");if(milestonesList.length>1){$("#milestone",f).html('<option value="">Any</option>')}$.each(milestonesList,function(k,l){$("#milestone",f).append('<option value="'+l+'">'+l+"</option>")});$("#milestone",f).parent().find("img").hide();hideTransitionBar()}})}else{$("#milestone",f).html('<option value="">Any</option>')}});$("#opportunity-listners").off("click",".deals-pipelined-view");$("#opportunity-listners").on("click",".deals-pipelined-view",function(b){b.preventDefault();if(!_agile_get_prefs("agile_deal_view")){return}_agile_delete_prefs("agile_deal_view");setupDealsTracksList()});$("#opportunity-listners").off("click",".deals-export-csv");$("#opportunity-listners").on("click",".deals-export-csv",function(b){b.preventDefault();console.log("Exporting ...");$("body #deals-export-csv-modal").remove();getTemplate("deals-export-csv-modal",{},undefined,function(d){if(!d){return}var c=$(d);c.modal("show");c.on("shown.bs.modal",function(){$("#deals-export-csv-modal").on("click","#deals-export-csv-confirm",function(g){g.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");var f={};f.filter=getDealFilters();$save_info=$('<img src="'+updateImageS3Path("img/1-0.gif")+'" height="18px" width="18px" style="opacity:0.5;"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>'+_agile_get_translated_val("campaigns","email-will-be-sent-shortly")+"</i></small></span>");$(this).parent(".modal-footer").find(".deals-export-csv-message").append($save_info);$save_info.show();$.ajax({url:"/core/api/opportunity/export",type:"POST",data:f,success:function(){console.log("Exported!");c.modal("hide")}})})})},null)});$("#opportunity-listners").off("click",'#opportunities-model-list > tr > td:not(":first-child")');$("#opportunity-listners").on("click",'#opportunities-model-list > tr > td:not(":first-child")',function(b){b.preventDefault();$(".popover").remove();var c=$(this).closest("tr").data();if($(this).find(".contact-type-image").length>0||$(this).find(".company-type-image").length>0){return}if(b.ctrlKey||b.metaKey){window.open("#deal/"+c.id,"_blank");return}Backbone.history.navigate("deal/"+c.id,{trigger:true})});$("#opportunity-listners").off("click",".contact-type-image");$("#opportunity-listners").on("click",".contact-type-image",function(b){b.preventDefault();Backbone.history.navigate("contact/"+$(this).attr("id"),{trigger:true})});$("#opportunity-listners").off("click",".company-type-image");$("#opportunity-listners").on("click",".company-type-image",function(b){b.preventDefault();Backbone.history.navigate("company/"+$(this).attr("id"),{trigger:true})});$("#opportunity-listners").off("click",".deals-add");$("#opportunity-listners").on("click",".deals-add",function(b){b.preventDefault();show_deal();setup_tags_typeahead()});$("#opportunity-listners").off("change","#pipeline_milestone");$("#opportunity-listners").on("change","#pipeline_milestone",function(d){var c=$(this).val();var b=c.substring(0,c.indexOf("_"));var f=c.substring(c.indexOf("_")+1,c.length+1);$(this).closest("form").find("#pipeline").val(b);$(this).closest("form").find("#milestone").val(f);console.log(b,"-----------",f)});$("#opportunity-listners").off("click","#opportunities-model-list > tr, .hide-popover");$("#opportunity-listners").on("click","#opportunities-model-list > tr, .hide-popover",function(b){$(this).closest("tr").popover("hide")});$("#opportunity-listners").off("click","#deal-milestone-regular");$("#opportunity-listners").on("click","#deal-milestone-regular",function(b){b.preventDefault();if(!_agile_get_prefs("agile_deal_view")&&!_agile_get_prefs("deal-milestone-view")){return}if(!_agile_get_prefs("agile_deal_view")){_agile_delete_prefs("deal-milestone-view");setupMilestoneViewWidth();return}_agile_delete_prefs("deal-milestone-view");_agile_delete_prefs("agile_deal_view");setupDealsTracksList()});$("#opportunity-listners").off("click","#deal-milestone-compact");$("#opportunity-listners").on("click","#deal-milestone-compact",function(b){b.preventDefault();if(!_agile_get_prefs("agile_deal_view")&&_agile_get_prefs("deal-milestone-view")=="compact"){return}if(!_agile_get_prefs("agile_deal_view")){_agile_set_prefs("deal-milestone-view","compact");setupMilestoneViewWidth();return}_agile_set_prefs("deal-milestone-view","compact");_agile_delete_prefs("agile_deal_view");setupDealsTracksList()});$("#opportunity-listners").off("click","#deal-milestone-fit");$("#opportunity-listners").on("click","#deal-milestone-fit",function(b){b.preventDefault();if(!_agile_get_prefs("agile_deal_view")&&_agile_get_prefs("deal-milestone-view")=="fit"){return}if(!_agile_get_prefs("agile_deal_view")){_agile_set_prefs("deal-milestone-view","fit");setupMilestoneViewWidth();return}_agile_set_prefs("deal-milestone-view","fit");_agile_delete_prefs("agile_deal_view");setupDealsTracksList()});$("#opportunity-listners").off("change","#value_filter");$("#opportunity-listners").on("change","#value_filter",function(c){var b=$(this);b.find("option").each(function(){if($(this).val()==b.val()){$("."+$(this).val(),$("#deal-value-filter")).removeClass("hide")}else{$("."+$(this).val(),$("#deal-value-filter")).addClass("hide");$("."+$(this).val(),$("#deal-value-filter")).each(function(){$(this).find("input").val("")})}})});$("#opportunity-listners").off("click",".remove_deal_filter");$("#opportunity-listners").on("click",".remove_deal_filter",function(b){_agile_delete_prefs("deal-filter-name");_agile_delete_prefs("deal-filters");setupDefaultDealFilters();$("#opportunity-listners").find("h3").find(".remove_deal_filter").parent().remove();if(!_agile_get_prefs("agile_deal_view")){setupDealsTracksList()}else{fetchDealsList()}});$("#opportunity-listners").off("click",".deal-track-close");$("#opportunity-listners").on("click",".deal-track-close",function(b){var c=$("#moving-deal").attr("data-pos");$("#new-track-list-paging").hide();$("#new-opportunity-list-paging").show();$("#opportunities-header",$("#opportunity-listners")).show();revertDeal(DEAL_DRAG_EVENT,DEAL_DRAG_UI,c)});$("#opportunity-listners").off("click",".update-drag-deal");$("#opportunity-listners").on("click",".update-drag-deal",function(j){var g=$(this).position();g.left=parseInt(g.left)+(($(this).find("div:first").width()-50)/2)+"px";g.overflow="hidden";g.width="50px";$("#moved-deal",$("#new-track-list-paging")).find("li").eq(1).animate(g,700,function(){$("#moved-deal",$("#new-track-list-paging")).find("li").eq(1).css("overflow","hidden")});var h=$("#moving-deal").find("div:first").attr("id");var l=$("#moving-deal").attr("data-heading");var d=$(this).find("div:first").attr("data-track");var b=$(this).find("div:first").text().trim();var f=DEALS_LIST_COLLECTION.collection.where({heading:l});if(f){var c=f[0].get("dealCollection").get(h);if(c){var k=c.get("milestone");c.set({pipeline_id:d},{silent:true});
update_milestone(c,h,b,k,true,"",false);$("#"+k.replace(/ +/g,"")+"_count").text(parseInt($("#"+k.replace(/ +/g,"")+"_count").text())-1)}}setTimeout(function(){$("#new-track-list-paging").hide();$("#new-opportunity-list-paging").show();$("#opportunities-header",$("#opportunity-listners")).show()},800)})}function initializeMilestoneListners(a){$("#pipelineModal").off("click","#pipeline_validate");$("#pipelineModal").on("click","#pipeline_validate",function(f){f.preventDefault();if($(this).attr("disabled")){return}var d=$(this);disable_save_button($(this));if(!isValidForm("#pipelineForm")){enable_save_button(d);return false}var c=serializeForm("pipelineForm");console.log(c);var b=new Backbone.Model();b.url="/core/api/milestone/pipelines";b.save(c,{success:function(g,e){$("#pipelineModal").modal("hide");enable_save_button(d);App_Admin_Settings.milestones();$("body").removeClass("modal-open")},error:function(g,e){console.log(e,g);$("#pipelineModal").find(".save-status").html('<span style="color:red;">'+e.responseText+"</span>");setTimeout(function(){$("#pipelineModal").find(".save-status").html("")},5000);enable_save_button(d)}})})}var IS_DEAL_ARCHIVED=false;var IS_DEAL_RESTORED=false;var IS_DEAL_DELETED=false;var DEAL_DRAG_EVENT="";var DEAL_DRAG_UI="";function setup_deals_in_milestones(e){var b=false;var a=false;var d=false;var c=false;head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$("ul.milestones").sortable({connectWith:"ul",cursor:"move",containment:"#content",scroll:false,tolerance:"intersect",start:function(f,g){$("#dealActions").css("top",(($(window).height()+window.scrollY)-$("#dealActions").height()-70)+"px");if($("#deals-tracks").is(":visible")){$(".move-deal-action").show()}else{$(".move-deal-action").hide()}if($(g.item).find(".archived-deal").attr("data-archive")=="true"){$(".restore-deal-action",$("#dealActions")).show();$(".archive-deal-action",$("#dealActions")).hide()}else{$(".restore-deal-action",$("#dealActions")).hide();$(".archive-deal-action",$("#dealActions")).show()}$(".delete-deal-action",$("#dealActions")).show();$("#dealActions").show();b=false;a=false;d=false;$("#moving-deal").attr("data-heading",$(g.item).closest("ul").attr("milestone"));$("#moving-deal").attr("data-pos",$(g.item).attr("data-pos"));IS_DEAL_ARCHIVED=false;IS_DEAL_RESTORED=false;IS_DEAL_DELETED=false},stop:function(f,g){if($("#deals-tracks").is(":visible")){$(".move-deal-action").show()}else{$(".move-deal-action").hide()}$("#dealActions").hide()},change:function(g,h){var f=$("#"+e+" > div").width();var j=$("#"+e+" > div").scrollLeft();if(g.pageX>(f*0.9)){$("#"+e+" > div").scrollLeft(j+10)}else{if(g.pageX<(f*0.1)){$("#"+e+" > div").scrollLeft(j-15)}}},update:function(j,k){if(b||a||d||c){return}$("ul.milestones").sortable("disable");console.log(">>>>>>>>>>>>>>>>>> deals id");console.log(k);console.log(k.item[0]);console.log(k.item[0].id);var n=k.item[0].children[0].id;console.log("paging...",n);var h=$("#"+n).attr("data");console.log("old...",h);var l=DEALS_LIST_COLLECTION.collection.where({heading:h});if(!l){return}var g=l[0].get("dealCollection").get(n);var f=($("#"+n).closest("ul").attr("milestone")).trim();console.log("new...",f);if(g&&g.collection){App_Deals.dealModel=g;App_Deals.newMilestone=f;App_Deals.old_milestone=h;App_Deals.lost_reason_milesone_id=n;var m=new Base_Model_View({url:"/core/api/milestone/"+g.collection.get(n).get("pipeline_id"),template:""});m.model.fetch({success:function(p){var o=p.toJSON();console.log("jsonModel.lost_milestone----"+o.lost_milestone);console.log("newMilestone----"+f);console.log("old_milestone----"+h);if(o.lost_milestone==f&&f!=h){console.log("Success if block");App_Deals.deal_lost_reason_for_update="";populateLostReasons($("#dealLostReasonModal"),undefined);$("#deal_lost_reason",$("#dealLostReasonModal")).removeClass("hidden");$("#dealLostReasonModal > .modal-dialog > .modal-content > .modal-footer > a#deal_lost_reason_save").text("Save");$("#dealLostReasonModal > .modal-dialog > .modal-content > .modal-footer > a#deal_lost_reason_save").attr("disabled",false);$("#"+n).attr("data",f)}if(o.won_milestone==f&&f!=h){$("#deal_won_date_"+n).find("small").text(getDateInFormatFromEpoc(new Date().getTime()/1000));$("#deal_won_date_"+n).removeClass("hide")}else{if(o.won_milestone!=f&&f!=h){$("#deal_won_date_"+n).addClass("hide")}}hideTransitionBar()}})}if(g){update_milestone(g,n,f,h,true,"")}$("#"+n).attr("data",f)}});$("li.delete-deal-action").droppable({accept:".deal-color",hoverClass:"deal-actions-overlap",drop:function(h,n){$("li.ui-sortable-placeholder").hide();$(n.draggable).hide();b=true;var j=$(n.draggable).find(".data").attr("id");var g=($(n.draggable).closest("ul").attr("milestone")).trim();var o=DEALS_LIST_COLLECTION.collection.where({heading:g});var f=[];var k={};f.push(j);k.ids=JSON.stringify(f);var m=$("#moving-deal").attr("data-pos");var l=this;if(o){if(!hasScope("DELETE_DEALS")){$("#deal_delete_privileges_error_modal").html(getTemplate("deal-delete-privileges-error-modal")).modal("show");return}else{showAlertModal("delete","confirm",function(){deleteDeal(j,g,o,l)},function(){if(!IS_DEAL_DELETED){revertDeal(h,n,m)}});return}}else{showAlertModal("delete","confirm",function(){deleteDeal(j,g,o,l)},function(){if(!IS_DEAL_DELETED){revertDeal(h,n,m)}});return}}});$("li.archive-deal-action").droppable({accept:".deal-color",hoverClass:"deal-actions-overlap",drop:function(g,h){$("li.ui-sortable-placeholder",$("#opportunity-listners")).hide();$(h.draggable).hide();a=true;var f={};f.id=$(h.draggable).find(".data").attr("id");f.milestone=($(h.draggable).closest("ul").attr("milestone")).trim();$("#deal_archive_confirm_modal").html(getTemplate("archive-deal"));$("#archived-deal-id",$("#deal_archive_confirm_modal")).val(f.id);$("#archived-deal-milestone",$("#deal_archive_confirm_modal")).val(f.milestone);$("#deal_archive_confirm_modal").modal("show");var j=$("#moving-deal").attr("data-pos");$("#deal_archive_confirm_modal").off("hidden.bs.modal");$("#deal_archive_confirm_modal").on("hidden.bs.modal",function(){if(!IS_DEAL_ARCHIVED){revertDeal(g,h,j)}})}});$("li.restore-deal-action").droppable({accept:".deal-color",hoverClass:"deal-actions-overlap",drop:function(g,h){$("li.ui-sortable-placeholder",$("#opportunity-listners")).hide();$(h.draggable).hide();c=true;var f={};f.id=$(h.draggable).find(".data").attr("id");f.milestone=($(h.draggable).closest("ul").attr("milestone")).trim();$("#deal_restore_confirm_modal").html(getTemplate("restore-deal"));$("#restored-deal-id",$("#deal_restore_confirm_modal")).val(f.id);$("#restored-deal-milestone",$("#deal_restore_confirm_modal")).val(f.milestone);$("#deal_restore_confirm_modal").modal("show");var j=$("#moving-deal").attr("data-pos");$("#deal_restore_confirm_modal").off("hidden.bs.modal");$("#deal_restore_confirm_modal").on("hidden.bs.modal",function(){if(!IS_DEAL_RESTORED){revertDeal(g,h,j)}})}});$("li.move-deal-action").droppable({accept:".deal-color",hoverClass:"deal-actions-overlap",drop:function(h,j){d=true;DEAL_DRAG_EVENT=h;DEAL_DRAG_UI=j;$("#new-track-list-paging",$("#opportunity-listners")).show();$("#new-opportunity-list-paging",$("#opportunity-listners")).hide();$("#opportunities-header",$("#opportunity-listners")).hide();$("#moving-deal",$("#opportunity-listners")).html("<li>"+$(j.draggable).html()+"</li>");var k=$("#moving-deal").attr("data-heading");var g=$(j.draggable).find("div:first").attr("id");var l=DEALS_LIST_COLLECTION.collection.where({heading:k});if(l){var f=l[0].get("dealCollection").get(g);$("#moved-deal").html("<li>Deal:</li><li><div class='text-ellipsis'>"+f.get("name")+"</div></li>")}$(j.draggable).remove();$("li.ui-sortable-placeholder").remove();if($("#deals-tracks").is(":visible")){$(".move-deal-action").show()}else{$(".move-deal-action").hide()}$("#dealActions").hide()}})})}function update_milestone(e,c,a,d,g,b,k){var h=e.toJSON();console.log(h);h.milestone=a;h.lost_reason_id=b;var f=[];$.each(h.notes,function(l,m){f.push(m.id)});console.log(f);h.notes=f;if(h.note_description){delete h.note_description}if(!h.close_date||h.close_date==0){h.close_date=null}if(h&&h.owner){h.owner_id=h.owner.id}var j=new Backbone.Model();j.url="/core/api/opportunity";j.save(h,{success:function(m,l){console.log("moved deal----",m);if(g){update_deal_collection(m.toJSON(),c,a,d,k)}$("ul.milestones").sortable("enable")},error:function(m,l){$("ul.milestones").sortable("enable");if(l&&(l.responseText=="Deal not saved properly."||l.responseText=="Deal not updated properly."||l&&l.status==403)){showModalConfirmation("Deals",l.responseText,function(n){App_Deals.deals()},"","","Cancel","")}}})}function update_deal_collection(k,m,r,w,h){var j=DEALS_LIST_COLLECTION.collection.where({heading:w});if(!j){return}try{if(w!=r&&h!=false){var u=k.expected_value;var g=parseFloat($("#"+w.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))-parseFloat(u);var a=parseFloat($("#"+r.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))+parseFloat(u);if($("#"+r.replace(/ +/g,"")+"_count").text()!="1000+"){if(parseInt($("#"+r.replace(/ +/g,"")+"_count").text())+1>1000){$("#"+r.replace(/ +/g,"")+"_count").text(parseInt($("#"+r.replace(/ +/g,"")+"_count").text())+"+")}else{$("#"+r.replace(/ +/g,"")+"_count").text(parseInt($("#"+r.replace(/ +/g,"")+"_count").text())+1)}}if($("#"+w.replace(/ +/g,"")+"_count").text()!="1000+"){$("#"+w.replace(/ +/g,"")+"_count").text(parseInt($("#"+w.replace(/ +/g,"")+"_count").text())-1)}$("#"+r.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(a));$("#"+w.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(g));var n=0;var q=parseInt($("#"+w.replace(/ +/g,"")+"_count").text());if(q==0){n=0}else{n=g/q}var e=0;var b=parseInt($("#"+r.replace(/ +/g,"")+"_count").text());if(b==0){e=0}else{e=a/b}g=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(g);n=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(n);a=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(a);
e=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(e);var l=w.replace(/ +/g,"");var p=r.replace(/ +/g,"");var o=getCurrencySymbolForCharts();var t=$("#pipeline-tour-step").children(".filter-dropdown").text();$("#"+l+" .dealtitle-angular").removeAttr("data");$("#"+p+" .dealtitle-angular").removeAttr("data");var v={dealTrack:t,heading:l,dealcount:g,avgDeal:n,symbol:o,dealNumber:q};var d=JSON.stringify(v);$("#"+l+" .dealtitle-angular").attr("data",d);var f={dealTrack:t,heading:p,dealcount:a,avgDeal:e,symbol:o,dealNumber:b};var s=JSON.stringify(f);$("#"+p+" .dealtitle-angular").attr("data",s)}}catch(c){console.log(c)}j[0].get("dealCollection").remove(j[0].get("dealCollection").get(m));j=DEALS_LIST_COLLECTION.collection.where({heading:r});if(!j){return}j[0].get("dealCollection").add(copyCursor(j,k),{silent:true})}function setup_milestones(a){head.js(LIB_PATH+"lib/jquery-ui.min.js",function(){$(a).find("tbody").each(function(b){var c=$(this).closest("form").find('input[name="id"]').val();$(this).sortable({containment:"#milestone-values-"+c,items:"tr",helper:function(g,d){var f=d.children();var h=d.clone();h.children().each(function(e){$(this).width(f.eq(e).width());console.log("-----------"+f.eq(e).width());$(this).css("background","#f5f5f5");$(this).css("border-bottom","1px solid #ddd")});return h},start:function(d,e){$.each(e.item.children(),function(f,g){e.helper.children().eq(f).width(e.helper.children().eq(f).width()-$(this).width())});e.helper.width(e.helper.width())},sort:function(d,e){e.helper.css("top",(e.helper.offset().top+e.item.offset().top)+"px")},forceHelperSize:true,placeholder:"<tr><td></td></tr>",forcePlaceholderSize:true,handle:".icon-move",cursor:"move",tolerance:"intersect",update:function(d,e){console.log($(e.item).attr("data"));fill_ordered_milestone($(e.item).closest("form").attr("id"))}})})})}function capitalize_string(a){a=a.trim().replace(/\b[a-z]/g,function(b){return b.toUpperCase()});return a}function fill_ordered_milestone(b){var a;$("#"+b).find("tbody").find("tr").each(function(c,d){if($(d).is(":visible")){if(a!=undefined){a=a+","+capitalize_string(($(d).attr("data")).toString())}else{a=capitalize_string(($(d).attr("data")).toString())}}});if(a&&a.charAt((a.length)-1)==","){a=a.slice(0,-1)}$("#"+b).find('input[name="milestones"]').val(a);$("#admin-settings-milestones-model-list").find("form").each(function(d){var e=serializeForm($(this).attr("id"));console.log("---------",e);App_Admin_Settings.pipelineGridView.collection.get(e.id).set("milestones",e.milestones,{silent:true});var c=new Backbone.Model();c.url="/core/api/milestone";c.save(e)})}function revertDeal(c,d,e){var b=$(d.draggable).find("div:first").attr("data");if(b){var a=$("#"+b.replace(/ +/g,"")+"-list-container").find("ul").find("li:visible");if(a.length>0){if(a.length==parseInt(e)){a.eq(parseInt(e)-1).after($(d.draggable))}else{a.eq(parseInt(e)).before($(d.draggable))}}else{$("#"+b.replace(/ +/g,"")+"-list-container").find("ul").append($(d.draggable))}$("#"+b.replace(/ +/g,"")+"-list-container").find("ul").find("li").show()}}var opportunity_filter_name;var OPPORTUNITY_DYNAMIC_FILTER_COOKIE_STATUS="toggle_dynamic_filter_"+CURRENT_DOMAIN_USER.id;var OPPORTUNITY_TRACK_MILESTONES;function setOportunityChainFilterValidations(a){a.find("input").each(function(){var b=$(this).closest("td").siblings("td.lhs-block").find("select#LHS").val();if(b=="expected_value"||b=="probability"){$(this).addClass("number");$(this).attr("min","0");var c="1000000000000";if(b=="probability"){c="100"}$(this).attr("max",c)}})}SEARCHABLE_OPPORTUNITY_CUSTOM_FIELDS=undefined;OPPORTUNITY_CUSTOM_FIELDS=undefined;var Opportunity_Filters_Event_View=Base_Model_View.extend({events:{"click .filter-opportunities-multiple-add":"opportunitiesFilterMultipleAdd","click i.filter-opportunities-multiple-remove":"opportunitiesFilterRemove","click .filter-opportunities-multiple-add-or-rules":"opportunitiesFilterAddOrRules","change #LHS > select":"onLhsChanged","change #condition > select":"onConditionChanged","change .lhs_chanined_parent":"onParentLHSChanged"},opportunitiesFilterMultipleAdd:function(b){b.preventDefault();var c=$(b.currentTarget);var a=c;getTemplate("filter-deals",{},undefined,function(d){if(!d){return}var e=$($(d).find(".chained-table.opportunity")[0]).find("tr").clone();$(e).removeClass("hide");scramble_input_names($(e));chainDealFilters(e,undefined,undefined,undefined,undefined,true);$(e).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(a).prev("table").find("tbody").append(e)},null)},opportunitiesFilterRemove:function(a){var b=$(a.currentTarget);$(b).closest("tr").remove()},opportunitiesFilterAddOrRules:function(b){b.preventDefault();var c=$(b.currentTarget);var a=c;getTemplate("filter-deals",{},undefined,function(d){if(!d){return}var e=$($(d).find(".chained-table.opportunity")[1]).find("tr").clone();$(e).removeClass("hide");scramble_input_names($(e));chainDealFilters(e,undefined,undefined,undefined,undefined,true);$(e).find("i.filter-contacts-multiple-remove").css("display","inline-block");$(a).prev("table").find("tbody").append(e)},null)},onLhsChanged:function(f){f.preventDefault();var g=$(f.currentTarget);var a=$(g).closest("td").siblings("td.rhs-block").find("#RHS");var b=$(g).find("option:selected").val();if(b=="expected_value"||b=="probability"){a.find("input").addClass("number");a.find("input").attr("min","0");var d="1000000000000";if(b=="probability"){d="100"}a.find("input").attr("max",d)}else{a.find("input").removeClass("number")}if(b=="track_milestone"){$(g).closest("td").siblings("td.track-milestone-error").removeClass("hide");var c=a.find("input").attr("name");populateTrackMilestones(undefined,undefined,undefined,undefined,undefined,undefined,a,c)}else{$(g).closest("td").siblings("td.track-milestone-error").addClass("hide")}if(b=="archived"){var c=a.find("input").attr("name");a.html(getTemplate("js-deal-filters",{field_name:c}))}},onConditionChanged:function(h){h.preventDefault();var j=$(h.currentTarget);var a=$(j).closest("td").siblings("td.rhs-block").find("#RHS");if($(j).find("option:selected").hasClass("tags")){var c=$(j).parents().closest("tr").find("div#RHS");addTagsDefaultTypeahead(c)}if($(j).closest("tr").find("td.lhs-block").find("option:selected").attr("field_type")=="CONTACT"){var f=j;var b=function(k,e){setTimeout(function(){$("input",$(f).closest("tr").find("td.rhs-block")).val(e);$("input",$(f).closest("tr").find("td.rhs-block")).attr("data",k)},10)};$("input",$(j).closest("tr").find("td.rhs-block")).attr("id",$(j).closest("tr").find("td.lhs-block").find("option:selected").attr("id"));$("input",$(j).closest("tr").find("td.rhs-block")).attr("placeholder","Contact Name");$("input",$(j).closest("tr").find("td.rhs-block")).addClass("contact_custom_field");agile_type_ahead($("input",$(j).closest("tr").find("td.rhs-block")).attr("id"),$(j).closest("tr").find("td.rhs-block"),contacts_typeahead,b,"type=PERSON")}if($(j).closest("tr").find("td.lhs-block").find("option:selected").attr("field_type")=="COMPANY"){var f=j;var g=function(k,e){setTimeout(function(){$("input",$(f).closest("tr").find("td.rhs-block")).val(e);$("input",$(f).closest("tr").find("td.rhs-block")).attr("data",k)},10)};$("input",$(j).closest("tr").find("td.rhs-block")).attr("id",$(j).closest("tr").find("td.lhs-block").find("option:selected").attr("id"));$("input",$(j).closest("tr").find("td.rhs-block")).attr("placeholder","Company Name");$("input",$(j).closest("tr").find("td.rhs-block")).addClass("company_custom_field");agile_type_ahead($("input",$(j).closest("tr").find("td.rhs-block")).attr("id"),$(j).closest("tr").find("td.rhs-block"),contacts_typeahead,g,"type=COMPANY")}if($(j).closest("td").siblings("td.lhs-block").find("select#LHS").val()=="track_milestone"){$(j).closest("td").siblings("td.track-milestone-error").removeClass("hide");var d=a.find("input").attr("name");populateTrackMilestones(undefined,undefined,undefined,undefined,undefined,undefined,a,d)}},onParentLHSChanged:function(b){b.preventDefault();var c=$(b.currentTarget);if(($(c).val()).indexOf("tags")!=-1){var a=$(c).closest("tr").find("div#RHS");addTagsDefaultTypeahead(a)}}});function startGettingDeals(){console.log("------started-----",pipeline_id);var c=trackListView.collection.get(pipeline_id).toJSON().milestones;if(c.trim().length==0){var b='<div class="slate" style="margin:0px;"><div class="slate-content"><div class="box-left"><img alt="Clipboard" src="'+updateImageS3Path("/img/clipboard.png")+'"></div><div class="box-right"><h3>You have no milestones defined</h3><br><a href="#milestones" class="btn"><i class="icon icon-plus-sign"></i> Add Milestones</a></div></div></div>';$("#new-opportunity-list-paging").html(b);return}if(_agile_get_prefs("agile_deal_track")){if(_agile_get_prefs("agile_deal_track")!=pipeline_id){_agile_set_prefs("agile_deal_track",pipeline_id)}}var d=trackListView.collection.get(pipeline_id).toJSON();var a=d.milestones.split(",");console.log(a);createDealsNestedCollection(pipeline_id,a,d)}function createDealsNestedCollection(e,d,g){console.log("In createNestedCollection");initDealListCollection(d);var b="/core/api/deal/filters/query/grid/"+_agile_get_prefs("deal-filter-name")+"?pipeline_id="+e+"&order_by="+getDealSortFilter();for(var c in d){var f;var a=b+"&milestone="+d[c];f={heading:d[c],url:a};if(g.won_milestone==d[c]){f.won_milestone=g.won_milestone}else{if(g.lost_milestone==d[c]){f.lost_milestone=g.lost_milestone}}if(!f){return}DEALS_LIST_COLLECTION.collection.add(f)}DEALS_LIST_COLLECTION.appendItem=dealAppend;$("#new-opportunity-list-paging").html(DEALS_LIST_COLLECTION.render(true).el);initializeDealsListeners()}function initDealListCollection(a){DEALS_LIST_COLLECTION=new Deals_Milestone_Events_Collection_View({restKey:"deal",templateKey:"opportunities-by-paging",individual_tag_name:"div",sort_collection:false,postRenderCallback:function(c){$(".loading-img",c).remove();$(".loading",c).remove();var d=a.length;if(!d){return}var b=(100/d);if(_agile_get_prefs("deal-milestone-view")){if(_agile_get_prefs("deal-milestone-view")=="compact"&&d>8){b=100/8
}if(_agile_get_prefs("deal-milestone-view")=="fit"){$("#opportunities-by-paging-model-list",c).find(".milestone-column").css("min-width",0)}}else{if(d>5){b=100/5}}$("#opportunities-by-paging-model-list",c).find(".milestone-column").width(b+"%");$(".mark-won, .mark-lost",c).tooltip()}})}function dealAppend(a){milestonesCollectionView(a,this.el,function(){dealsFetch(a)})}function milestonesCollectionView(a,d,e){var c=new Base_List_View({model:a,view:"inline",template:"opportunities-by-paging-model",tagName:"div",className:"milestone-column panel m-b-none  b-n r-n panel-default",id:a.get("heading").replace(/ +/g,"")});var b=c.render().el;$("#opportunities-by-paging-model-list > div",d).append(b);return e()}function dealsFetch(a){if(!a){return}var b="deals-by-paging";if(!_agile_get_prefs("deal-milestone-view")){b="deals-by-paging-relax"}var c=new Base_Collection_View({url:a.get("url"),templateKey:b,individual_tag_name:"li",sort_collection:false,cursor:true,page_size:20,postRenderCallback:function(d){$(d).find("ul li").each(function(e){$(this).addClass("deal-color");$(this).addClass($(this).find("input").attr("class"));$(this).attr("data-pos",e)});$("ul.milestones",d).attr("milestone",a.get("heading"));if(!_agile_get_prefs("agile_deal_view")){deal_infi_scroll($("#"+a.get("heading").replace(/ +/g,"")+"-list-container")[0],c)}includeTimeAgo(d)}});c.collection.fetch({success:function(e){a.set("dealCollection",c.collection);$("#"+a.get("heading").replace(/ +/g,"")+"-list-container").html(c.render(true).el);console.log($("#"+a.get("heading").replace(/ +/g,"")).find("img.loading_img").length);$("#"+a.get("heading").replace(/ +/g,"")).find("img.loading_img").hide();var f=a.get("heading");$("a.deal-notes").tooltip();setup_deals_in_milestones("opportunities-by-paging-model-list");var d=0;if(e&&e.models&&e.models[0]){d=e.models[0].get("count")}if(d>1000){$("#"+a.get("heading").replace(/ +/g,"")+"_count").text("1000+")}else{$("#"+a.get("heading").replace(/ +/g,"")+"_count").text(d)}if(d<=1000){dealTotalCountForPopover(f)}}})}function deal_infi_scroll(b,a){console.log("initialize_infinite_scrollbar",b);if(b==undefined||b==null){console.log("no elmnt");return}console.log(a);a.infiniScroll=new Backbone.InfiniScroll(a.collection,{target:b,untilAttr:"cursor",param:"cursor",strict:false,pageSize:a.page_size,success:function(d,c){console.log("in success");if(!d.last().get("cursor")){this.strict=true;a.infiniScroll.disableFetch()}$(a.infiniScroll.options.target).find(".scroll-loading").remove();includeTimeAgo($(a.infiniScroll.options.target));$("a.deal-notes").tooltip();$(c).each(function(){$("#"+this.id).parent("li").addClass("deal-color");$("#"+this.id).parent("li").addClass(this.colorName)})},onFetch:function(){console.log("in fetch");$(a.infiniScroll.options.target).append('<div class="scroll-loading"> <img src="'+updateImageS3Path("/img/ajax-loader-cursor.gif")+'" style="margin-left: 44%;"> </div>')}})}function initializeDealsListeners(){$("#opportunity-listners").off("mouseenter",".milestone-column > .dealtitle-angular");$("#opportunity-listners").on("mouseenter",".milestone-column > .dealtitle-angular",function(){var d=$(this).attr("data");if(d&&$("#"+$(this).parent().attr("id")+"_count").text()!="1000+"){var b=$(this).siblings().find(".milestones").attr("milestone");var a=JSON.parse(d);a.heading=b;var c=this;getTemplate("deal-detail-popover",a,undefined,function(f){if(!f){return}var e=$(f);$(c).popover({rel:"popover",trigger:"manual",placement:"bottom",content:e,html:"true"});$(c).popover("show");$(".popover-content").html(e);$(".dealtitle-angular + .popover > .arrow").remove();$(".dealtitle-angular + .popover").css("top","35px");$(".dealtitle-angular + .popover > .popover-content").css("padding","0px");$(".dealtitle-angular + .popover ").css("border-radius","0px")})}});$("#opportunity-listners").off("mouseleave",".milestone-column > .dealtitle-angular");$("#opportunity-listners").on("mouseleave",".milestone-column > .dealtitle-angular",function(){$(this).popover("hide");$(this).popover("destroy")})}function dealTotalCountForPopover(d){console.log("------popover pipeline id-----",pipeline_id);if(_agile_get_prefs("agile_deal_track")){if(_agile_get_prefs("agile_deal_track")!=pipeline_id){_agile_set_prefs("agile_deal_track",pipeline_id)}}var e=trackListView.collection.get(pipeline_id).toJSON();var b=e.milestones.split(",");console.log(b);var c;var a="/core/api/deal/filters/query/total/"+_agile_get_prefs("deal-filter-name")+"?pipeline_id="+pipeline_id+"&order_by="+getDealSortFilter()+"&milestone="+d;c={heading:d,url:a};if(e.won_milestone==d){c.won_milestone=e.won_milestone}else{if(e.lost_milestone==d){c.lost_milestone=e.lost_milestone}}$.ajax({type:"GET",url:a,success:function(j){if(j){var q=JSON.parse(j);var l=q.total;var m=$("#"+q.milestone.replace(/ +/g,"")+"_count").text();var h=3;var r=q.milestone.replace(/ +/g,"");var k;$("#"+q.milestone.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(l));var f=0;if(m==0){f=0}else{f=l/m}var p=$("#pipeline-tour-step").children(".filter-dropdown").text();l=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(l);var g=getCurrencySymbolForCharts();f=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(f);var n={dealTrack:p,heading:r,dealcount:l,avgDeal:f,symbol:g,dealNumber:m};var o=JSON.stringify(n);$("#"+r+" .dealtitle-angular").attr("data",o)}else{dealTotalCountForPopover(d)}},error:function(){console.log("An error occurred")}})}function dealsCountFetch(a,c){if(!a){return}var b=new Base_Model_View({url:a.get("url").replace("/based","/based/count"),template:"",isNew:true});b.model.fetch({success:function(e){var d=e.get("count")?e.get("count"):0;if(d>1000){$("#"+a.get("heading").replace(/ +/g,"")+"_count").text((d-1)+"+")}else{$("#"+a.get("heading").replace(/ +/g,"")+"_count").text(d)}if(c){return c(d)}}})}var Sources_Loss_Reasons_Events_Collection_View=Base_Collection_View.extend({events:{"click .add_deal_source":"dealSourceAdd","keypress #deal_source_name":"dealSourceAddWithEnterBtn","click .deal-source-edit":"dealSourceEdit","keypress .update_deal_source":"dealSourceUpdateWithEnterBtn","click .updates_deal_source":"dealSourceUpdate","click .deal-source-delete":"dealSourceDelete","click .add_lost_reason":"lossReasonAdd","keypress .lost_reason_name":"lossReasonAddWithEnterBtn","click .lost-reason-edit":"lossReasonEdit","keypress .update_lost_reason":"lossReasonUpdateWithEnterBtn","click .updates_lost_reason":"lossReasonUpdate","click .lost-reason-delete":"lossReasonDelete","click .goalSave":"goalSave","keypress .count":"goalCount","keypress .amount":"goalAmount","click .show_milestone_field":"showMilestoneField"},dealSourceAdd:function(d){d.preventDefault();if($("#deal_source_name").val().trim()==""){$("#deal_source_name_error").show();return false}if(!categories.isValid($("#deal_source_name").val().trim())){$("#deal_source_chars_error").show();return false}var c=serializeForm("dealSourcesForm");if(App_Admin_Settings.dealSourcesView&&App_Admin_Settings.dealSourcesView.collection){var a=0;$.each(App_Admin_Settings.dealSourcesView.collection.models,function(f,e){if(e.get("order")>a){a=e.get("order")}});c.order=a+1}var b=new BaseModel();b.url="core/api/categories";b.save(c,{success:function(f){var e=f.toJSON();App_Admin_Settings.dealSourcesView.collection.add(new BaseModel(e));$(".show_field").find("#deal_source_name").val("");$(".show_field").hide();$(".show_deal_source_add").show()},error:function(f,e){if(e.status==400&&e.responseText=="Source with this name already exists."){$("#deal_source_existed_error").show()}}})},dealSourceAddWithEnterBtn:function(b){$("#deal_source_name_error").hide();$("#deal_source_existed_error").hide();$("#deal_source_chars_error").hide();if(b.keyCode==13){b.preventDefault();var a=$(this).closest("form");a.find(".add_deal_source").click()}},dealSourceEdit:function(a){$(a.currentTarget).closest("tr").find(".deal_source_name_div").hide();$(a.currentTarget).closest("tr").find(".deal_source_name_input").show()},dealSourceUpdateWithEnterBtn:function(c){if(c.which==13){c.preventDefault();if($(c.currentTarget).val().trim()==""){$("#deal_source_name_error_"+$(c.currentTarget).attr("id")).show();return false}if(!categories.isValid($(c.currentTarget).val().trim())){$("#deal_source_chars_error_"+$(c.currentTarget).attr("id")).show();return false}var b=serializeForm("dealSourcesForm_"+$(c.currentTarget).attr("id"));var a=new BaseModel();a.url="core/api/categories";a.save(b,{success:function(e){var d=e.toJSON();App_Admin_Settings.dealSourcesView.collection.get(d).set(new BaseModel(d));$(".deal_source_name_input").hide();$(".deal_source_name_div").show()},error:function(e,d){if(d.status==400&&d.responseText=="Source with this name already exists."){$("#deal_source_existed_error").show()}}})}else{$("#deal_source_name_error_"+$(c.currentTarget).attr("id")).hide();$("#deal_source_existed_error_"+$(c.currentTarget).attr("id")).hide();$("#deal_source_chars_error_"+$(c.currentTarget).attr("id")).hide()}},dealSourceUpdate:function(c){c.preventDefault();if($(c.currentTarget).parent().find("input:text").val().trim()==""){$("#deal_source_name_error_"+$(c.currentTarget).parent().find("input:text").attr("id")).show();return false}if(!categories.isValid($(c.currentTarget).parent().find("input:text").val().trim())){$("#deal_source_chars_error_"+$(c.currentTarget).parent().find("input:text").attr("id")).show();return false}var b=serializeForm("dealSourcesForm_"+$(c.currentTarget).parent().find("input:text").attr("id"));var a=new BaseModel();a.url="core/api/categories";a.save(b,{success:function(e){var d=e.toJSON();App_Admin_Settings.dealSourcesView.collection.get(d).set(new BaseModel(d));$(".deal_source_name_input").hide();$(".deal_source_name_div").show()},error:function(e,d){if(d.status==400&&d.responseText=="Source with this name already exists."){$("#deal_source_existed_error").show()}}})},dealSourceDelete:function(b){b.preventDefault();
var a=$(b.currentTarget);showAlertModal("delete_deal_source","confirm",function(){var d=serializeForm(a.closest("form").attr("id"));var c=new BaseModel();c.url="core/api/categories/"+d.id;c.set({id:d.id});c.destroy({success:function(f){var e=f.toJSON();App_Admin_Settings.dealSourcesView.collection.remove(new BaseModel(e));a.closest("tr").remove()},error:function(f,e){}})})},lossReasonAdd:function(c){c.preventDefault();if($("#lost_reason_name").val().trim()==""){$("#lost_reason_name_error").show();return false}if(!categories.isValid($("#lost_reason_name").val().trim())){$("#lost_reason_chars_error").show();return false}var b=serializeForm("lostReasonsForm");var a=new BaseModel();a.url="core/api/categories";a.save(b,{success:function(e){var d=e.toJSON();App_Admin_Settings.dealLostReasons.collection.add(new BaseModel(d));$(".show_field").find("#lost_reason_name").val("");$(".show_field").hide();$(".show_lost_reason_add").show()},error:function(e,d){if(d.status==400&&d.responseText=="Reason with this name already exists."){$("#lost_reason_existed_error").show()}}})},lossReasonAddWithEnterBtn:function(b){$("#lost_reason_name_error").hide();$("#lost_reason_existed_error").hide();$("#lost_reason_chars_error").hide();if(b.keyCode==13){b.preventDefault();var a=$(this).closest("form");a.find(".add_lost_reason").click()}},lossReasonEdit:function(a){a.preventDefault();$(a.currentTarget).closest("tr").find(".lost_reason_name_div").hide();$(a.currentTarget).closest("tr").find(".lost_reason_name_input").show()},lossReasonUpdateWithEnterBtn:function(c){if(c.which==13){c.preventDefault();if($(c.currentTarget).val().trim()==""){$("#lost_reason_name_error_"+$(c.currentTarget).attr("id")).show();return false}if(!categories.isValid($(c.currentTarget).val().trim())){$("#lost_reason_chars_error_"+$(c.currentTarget).attr("id")).show();return false}var b=serializeForm("lostReasonsForm_"+$(c.currentTarget).attr("id"));var a=new BaseModel();a.url="core/api/categories";a.save(b,{success:function(e){var d=e.toJSON();App_Admin_Settings.dealLostReasons.collection.get(d).set(new BaseModel(d));$(".lost_reason_name_input").hide();$(".lost_reason_name_div").show()},error:function(e,d){if(d.status==400&&d.responseText=="Reason with this name already exists."){$("#lost_reason_existed_error").show()}}})}else{$("#lost_reason_name_error_"+$(c.currentTarget).attr("id")).hide();$("#lost_reason_existed_error_"+$(c.currentTarget).attr("id")).hide();$("#lost_reason_chars_error_"+$(c.currentTarget).attr("id")).hide()}},lossReasonUpdate:function(c){if($(c.currentTarget).parent().find("input:text").val().trim()==""){$("#lost_reason_name_error_"+$(c.currentTarget).parent().find("input:text").attr("id")).show();return false}if(!categories.isValid($(c.currentTarget).parent().find("input:text").val().trim())){$("#lost_reason_chars_error_"+$(c.currentTarget).parent().find("input:text").attr("id")).show();return false}var b=serializeForm("lostReasonsForm_"+$(c.currentTarget).parent().find("input:text").attr("id"));var a=new BaseModel();a.url="core/api/categories";a.save(b,{success:function(e){var d=e.toJSON();App_Admin_Settings.dealLostReasons.collection.get(d).set(new BaseModel(d));$(".lost_reason_name_input").hide();$(".lost_reason_name_div").show()},error:function(e,d){if(d.status==400&&d.responseText=="Reason with this name already exists."){$("#lost_reason_existed_error").show()}}})},lossReasonDelete:function(b){b.preventDefault();var a=$(b.currentTarget);showAlertModal("delete_lost_reason","confirm",function(){var d=serializeForm(a.closest("form").attr("id"));var c=new BaseModel();c.url="core/api/categories/"+d.id;c.set({id:d.id});c.destroy({success:function(f){var e=f.toJSON();App_Admin_Settings.dealLostReasons.collection.remove(new BaseModel(e));a.closest("tr").remove()},error:function(f,e){}})})},goalSave:function(f){f.preventDefault();var a=true;var c=$(this);var b=[];var g=$("#goal_duration span").html();if(window.navigator.userAgent.indexOf("Mozilla")!=-1&&window.navigator.userAgent.indexOf("Chrome")==-1){g="01 "+g}g=new Date(g);var h=getUTCMidNightEpochFromDate(g);$("#deal-sources-table").find("tr").not(":first").each(function(e){if(($(this).find(".amount").val().trim())!=""&&((parseFloat($(this).find(".amount").val().trim())<0)||!(/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/).test($(this).find(".amount").val()))){$(this).find("#goal_amount_error").show();a=false;return false}if(($(this).find(".count").val().trim())!=""&&((parseFloat($(this).find(".count").val().trim())<0)||!(/^[0-9]*$/).test($(this).find(".count").val()))){$(this).find("#goal_count_error").show();a=false;return false}if($(this).find("#goal_amount_error").is(":visible")){$(this).find("#goal_amount_error").hide()}if($(this).find("#goal_count_error").is(":visible")){$(this).find("#goal_count_error").hide()}var d={};if($(this).attr("id")!=null&&($(this).attr("data")==h/1000)){d.id=$(this).attr("id")}d.domain_user_id=$(this).find(".goal").attr("id");d.amount=$(this).find(".amount").val().trim();d.count=$(this).find(".count").val().trim();d.start_time=h/1000;b.push(d)});if(a){$(".goalSave").attr("disabled","disabled");$(".Count_goal").text(0);$(".Amount_goal").text(0);$.ajax({type:"POST",url:"/core/api/goals",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json",success:function(k){console.log(k);var j=0;var d=0;$("#deal-sources-table").find("tr").not(":first").each(function(e){var l=$(this);$.each(k,function(m,n){if(n.domain_user_id==l.find(".goalid").attr("id")){l.attr("id",n.id);l.attr("data",n.start_time)}});if(l.find(".count").val().trim()!=""){j=j+parseInt(l.find(".count").val())}if(l.find(".amount").val().trim()!=""){d=d+parseFloat(l.find(".amount").val())}});percentCountAndAmount(j,d);$save_info=$('<div style="display:inline-block"><small><p class="text-info"><i>Changes Saved</i></p></small></div>');$(".Goals_message").html($save_info);$save_info.show();setTimeout(function(){$(".Goals_message").empty();$(".goalSave").removeAttr("disabled")},500)}})}},goalCount:function(a){$(a.currentTarget).siblings("#goal_count_error").hide()},goalAmount:function(a){$(a.currentTarget).siblings("#goal_amount_error").hide()},showMilestoneField:function(b){b.preventDefault();var a=$(b.currentTarget).closest("form");console.log("New Milestone to - ",a.attr("id"));$(b.currentTarget).closest("div").css("display","none");a.find(".show_field").css("display","block");a.find(".add_new_milestone").focus()}});(function(j,g,c){j.HARD_RELOAD_MILESTONES=false;var a="<i title='Make Milestone Won' class='task-action icon icon-like'></i>";var b="<i title='Make Milestone Won' class='task-action icon icon-dislike'></i>";j.wonMsg="Deals with this milestone are considered as Won.";j.lostMsg="Deals with this milestone are considered as Lost.";var l=getTemplate("js-deal-reports");j.isNotyVisible=true;j.showMilestonePopup=function(n,o){if(!(n.lost_milestone&&n.won_milestone)||n.won_milestone.length==0||n.lost_milestone.length==0){d(n,function(p){if(!(p.lost_milestone&&p.won_milestone)){j.showMilestoneNoty();j.isNotyVisible=true}if(o&&typeof o==="function"){return o(p)}})}};j.showMilestoneNoty=function(){if(Current_Route.indexOf("deal")==0){if(Nagger_Noty){g.noty.closeAll()}}if(j.isNotyVisible){return}if(Nagger_Noty&&g("#"+Nagger_Noty).length>0){return}setTimeout(function(){showNotyPopUp("warning",l,"topCenter","none",function(){g.noty.close(Nagger_Noty);Nagger_Noty=null;Backbone.history.navigate("milestones",{trigger:true})});setTimeout(function(){g.noty.closeAll()},10000)},4000);j.isNotyVisible=true};var k=function(n,q){var p="core/api/milestone/won";var o={};o.pipeline_id=n.id;o.milestone=n.won_milestone;g.ajax({url:p,type:"POST",data:o,contentType:"application/x-www-form-urlencoded",success:function(r){if(q){q()}}})};var f=function(n,q){var p="core/api/milestone/lost";var o={};o.pipeline_id=n.id;o.milestone=n.lost_milestone;g.ajax({url:p,type:"POST",data:o,contentType:"application/x-www-form-urlencoded",success:function(r){if(q){q()}}})};var d=function(n,p){var o=n.milestones.split(",");g.each(o,function(q,r){if(r.toUpperCase()=="WON"&&(n.won_milestone==c||n.won_milestone.length==0)&&r!=n.lost_milestone){n.won_milestone=r;k(n)}else{if(r.toUpperCase()=="LOST"&&(n.lost_milestone==c||n.lost_milestone.length==0)&&r!=n.won_milestone){n.lost_milestone=r;f(n)}}});if(p){p(n)}};j.savePipelineForm=function(p,q){var o=serializeForm(p);console.log("---------",o);var n=new Backbone.Model();n.url="/core/api/milestone";n.save(o,{success:function(s,r){if(j.HARD_RELOAD_MILESTONES){App_Admin_Settings.milestones()}if(q){q(r)}},error:function(s,r){console.log(r)}})};var h=function(p){var o=p.closest("tr").attr("data");if(o!=c&&o.length>0){var q=p.closest("form").attr("id");g("#"+q).find('input[name="won_milestone"]').val(o);var n=p.closest("tr");if(n.find("i.mark-lost").length>0){n.find("i.mark-lost").remove();n.find(".milestone-lost").removeClass("disabled");g("#"+q).find('input[name="lost_milestone"]').val("")}j.savePipelineForm(q,function(r){g("#"+q+" .milestone-won").removeClass("disabled");g("#"+q+" i.mark-won").remove();n.find(".milestone-name-block").append("<i data-toogle='tooltip' title='"+j.wonMsg+"' class='icon-like mark-won m-l-sm'></i>");n.find("a.milestone-won").addClass("disabled");g(".mark-won",n).tooltip();App_Admin_Settings.pipelineGridView.collection.get(r.id).set("won_milestone",r.won_milestone,{silent:true})})}};var e=function(o){var q=o.closest("tr").attr("data");if(q!=c&&q.length>0){var p=o.closest("form").attr("id");g("#"+p).find('input[name="lost_milestone"]').val(q);var n=o.closest("tr");if(n.find("i.mark-won").length>0){n.find("i.mark-won").remove();n.find(".milestone-won").removeClass("disabled");g("#"+p).find('input[name="won_milestone"]').val("")}j.savePipelineForm(p,function(r){g("#"+p+" .milestone-lost").removeClass("disabled");g("#"+p+" i.mark-lost").remove();n.find(".milestone-name-block").append("<i data-toogle='tooltip' title='"+j.lostMsg+"' class='icon-dislike mark-lost m-l-sm'></i>");
n.find("a.milestone-lost").addClass("disabled");g(".mark-lost",n).tooltip();App_Admin_Settings.pipelineGridView.collection.get(r.id).set("lost_milestone",r.lost_milestone,{silent:true})})}};var m=function(n){g("#milestone-listner").on("click",".milestone-won",function(q){q.preventDefault();var o=g(this).parents(".milestones-table").attr("data");var p=g.ajax({type:"GET",url:"core/api/opportunity/numberOfDeals?id="+o,async:false,dataType:"json"}).responseText;if(p=="success"){showAlertModal("won_milestone_delete_error");return}if(!g(this).hasClass("disabled")){h(g(this))}});g("#milestone-listner").on("click",".milestone-lost",function(q){q.preventDefault();var o=g(this).parents(".milestones-table").attr("data");var p=g.ajax({type:"GET",url:"core/api/opportunity/numberOfDeals?id="+o,async:false,dataType:"json"}).responseText;if(p=="success"){showAlertModal("lost_milestone_delete_error");return}if(!g(this).hasClass("disabled")){e(g(this))}});g(".milestone-won, .milestone-lost, .mark-won, .mark-lost, .milestone-delete",n).tooltip()};j.init=function(n){m()}}(window.milestone_util=window.deal_bulk_actions||{},$));$(function(){$("#opportunityModal, #opportunityUpdateModal").on("show.bs.modal",function(){$("#"+this.id).find(".alert").css("display","none");$("#"+this.id).find(".error").removeClass("error")});$("#opportunityModal, #opportunityUpdateModal").on("shown.bs.modal",function(){$(".date_input").attr("placeholder",_agile_get_translated_val("contacts","select-date"));$(".date_input").datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true}).datepicker("update");$("input.date").each(function(a,b){$(b).datepicker("update")})});$("#opportunityModal").on("hidden.bs.modal",function(){$("#opportunityForm").find("li").remove();remove_validation_errors("opportunityModal");$("#opportunityModal #forNoteForm").html("");$(".deal-add-note",$("#opportunityModal")).show();$(".deal-note-label").hide();$("#color1",$("#opportunityModal")).attr("value","#FFFFFF")});$("#opportunityUpdateModal").on("hidden.bs.modal",function(){$("#opportunityUpdateForm").find("li").remove();remove_validation_errors("opportunityUpdateModal");$("#opportunityUpdateModal #forNoteForm").html("");$(".deal-add-note",$("#opportunityUpdateModal")).show();$("#deal-note-label").hide()});$("body").on("click","#dashboard-opportunities-model-list > tr",function(a){a.preventDefault();var b=$(this).closest("tr").data();Backbone.history.navigate("deal/"+b.id,{trigger:true})});$("body").on("click","#deal-quick-archive",function(f){f.preventDefault();if($(this).attr("disabled")){return}disable_save_button($(this));var j=$("#archived-deal-id",$("#deal_archive_confirm_modal")).val();var h=$("#archived-deal-milestone",$("#deal_archive_confirm_modal")).val();var c;var d;if(Current_Route!="deals"){c=App_Deal_Details.dealDetailView.model.toJSON()}else{d=DEALS_LIST_COLLECTION.collection.where({heading:h});if(!d){return}c=d[0].get("dealCollection").get(j).toJSON()}c.archived=true;var b=$(this);var a=[];$.each(c.notes,function(e,k){a.push(k.id)});c.notes=a;if(c.note_description){delete c.note_description}if(!c.close_date||c.close_date==0){c.close_date=null}if(c&&c.owner){c.owner_id=c.owner.id}var g=new Backbone.Model();g.url="/core/api/opportunity";g.save(c,{success:function(p,o){IS_DEAL_ARCHIVED=true;if(Current_Route!="deals"){$("#deal_archive_confirm_modal").modal("hide");App_Deal_Details.dealDetailView.model=p;App_Deal_Details.dealDetailView.render(true);$("body").removeClass("modal-open");Backbone.history.navigate("deal/"+p.toJSON().id,{trigger:true});return}if(removeArchive(o)){d[0].get("dealCollection").remove(d[0].get("dealCollection").get(j));$("#"+j).parent().remove()}else{$("#"+j+" .deal-options").find(".deal-archive").remove();$("#"+j+" .deal-options").find(".deal-edit").remove();$("#"+j+" .deal-options").prepend('<a title="Restore" class="deal-restore" style="cursor:pointer;text-decoration:none;"> <i style="width: 0.9em!important;" class="icon-mail-reply"></i> </a>')}console.log("archived deal----",p);pieMilestones();enable_save_button(b);$("#deal_archive_confirm_modal").modal("hide");var v=p.attributes.expected_value;var l=p.attributes.milestone;try{var t=parseFloat($("#"+l.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))-parseFloat(v);$("#"+l.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(t));$("#"+l.replace(/ +/g,"")+"_count").text(parseInt($("#"+l.replace(/ +/g,"")+"_count").text())-1);var e=0;var q=parseInt($("#"+l.replace(/ +/g,"")+"_count").text());if(q==0){avg_old_deal_size=0}else{avg_old_deal_size=t/q}t=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(t);avg_old_deal_size=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(avg_old_deal_size);var u=$("#pipeline-tour-step").children(".filter-dropdown").text();var n=l.replace(/ +/g,"");var k=getCurrencySymbolForCharts();var r={dealTrack:u,heading:n,dealcount:t,avgDeal:avg_old_deal_size,symbol:k,dealNumber:q};var s=JSON.stringify(r);$("#"+n+" .dealtitle-angular").removeAttr("data");$("#"+n+" .dealtitle-angular").attr("data",s)}catch(m){console.log(m)}dealsLineChart();update_deal_collection(p.toJSON(),j,h,h)},error:function(e,k){if(k&&k.status==403&&!hasScope("EDIT_CONTACT")){k.responseText=DEALS_ARCHIVE_CONTACT_ACL_ERROR}enable_save_button(b);$("#deal_archive_confirm_modal").find("span.error-status").html('<div class="inline-block"><p class="text-base" style="color:#B94A48;"><i>'+k.responseText+"</i></p></div>");setTimeout(function(){$("#deal_archive_confirm_modal").find("span.error-status").html("")},2000);console.log("-----------------",k.responseText)}})});$("body").on("click","#deal-quick-restore",function(f){f.preventDefault();var j=$("#restored-deal-id",$("#deal_restore_confirm_modal")).val();var h=$("#restored-deal-milestone",$("#deal_restore_confirm_modal")).val();var c;var d;if($(this).attr("disabled")){return}disable_save_button($(this));if(Current_Route!="deals"){c=App_Deal_Details.dealDetailView.model.toJSON()}else{d=DEALS_LIST_COLLECTION.collection.where({heading:h});if(!d){return}c=d[0].get("dealCollection").get(j).toJSON()}c.archived=false;var b=$(this);var a=[];$.each(c.notes,function(e,k){a.push(k.id)});c.notes=a;if(c.note_description){delete c.note_description}if(!c.close_date||c.close_date==0){c.close_date=null}if(c&&c.owner){c.owner_id=c.owner.id}var g=new Backbone.Model();g.url="/core/api/opportunity";g.save(c,{success:function(l,k){IS_DEAL_RESTORED=true;if(Current_Route!="deals"){$("#deal_restore_confirm_modal").modal("hide");App_Deal_Details.dealDetailView.model=l;App_Deal_Details.dealDetailView.render(true);$("body").removeClass("modal-open");Backbone.history.navigate("deal/"+l.toJSON().id,{trigger:true});return}if(removeArchive(k)){d[0].get("dealCollection").remove(d[0].get("dealCollection").get(j));$("#"+j).parent().remove()}else{$("#"+j+" .deal-options").find(".deal-restore").remove();var e='<a title="Archive" class="deal-archive" style="cursor:pointer;text-decoration:none;"> <i style="width: 0.9em!important;" class="icon-archive"></i> </a>';e+='<a title="Edit" class="deal-edit" style="cursor:pointer;text-decoration:none;"> <i style="width: 0.9em!important;" class="icon-pencil"></i> </a>';$("#"+j+" .deal-options").prepend(e)}console.log("archived deal----",l);pieMilestones();enable_save_button(b);$("#deal_restore_confirm_modal").modal("hide");dealsLineChart();update_deal_collection(l.toJSON(),j,h,h)},error:function(e,k){if(k&&k.status==403&&!hasScope("EDIT_CONTACT")){k.responseText=DEALS_RESTORE_CONTACT_ACL_ERROR}enable_save_button(b);$("#deal_restore_confirm_modal").find("span.error-status").html('<div class="inline-block"><p class="text-base" style="color:#B94A48;"><i>'+k.responseText+"</i></p></div>");setTimeout(function(){$("#deal_restore_confirm_modal").find("span.error-status").html("")},2000);console.log("-----------------",k.responseText)}})});$("#opportunity-listners").on("click",".deal-archive",function(b){b.preventDefault();var a={};a.id=$(this).closest(".data").attr("id");a.milestone=($(this).closest("ul").attr("milestone")).trim();$("#archived-deal-id",$("#deal_archive_confirm_modal")).val(a.id);$("#archived-deal-milestone",$("#deal_archive_confirm_modal")).val(a.milestone);$("#deal_archive_confirm_modal").modal("show")});$("body").on("click",".deal-restore",function(b){b.preventDefault();var a={};a.id=$(this).closest(".data").attr("id");a.milestone=($(this).closest("ul").attr("milestone")).trim();$("#restored-deal-id",$("#deal_restore_confirm_modal")).val(a.id);$("#restored-deal-milestone",$("#deal_restore_confirm_modal")).val(a.milestone);$("#deal_restore_confirm_modal").modal("show")});$("body").on("change","#pipeline_milestone",function(d){var b=$(this).val();var a=b.substring(0,b.indexOf("_"));var f=b.substring(b.indexOf("_")+1,b.length+1);$(this).closest("form").find("#pipeline").val(a);$(this).closest("form").find("#milestone").val(f);console.log(a,"-----------",f);var c=false;$(this).find("option").each(function(){if($(this).css("display")=="none"&&$(this).val()==b){c=true}});if(c&&$("#lost_reason",$(this).closest(".modal")).find("option").length>1){$("#lost_reason",$(this).closest(".modal")).val("");$("#deal_lost_reason",$(this).closest(".modal")).removeClass("hidden")}else{$("#lost_reason",$(this).closest(".modal")).val("");$("#deal_lost_reason",$(this).closest(".modal")).addClass("hidden")}});$("body").on("click","#deal_lost_reason_save",function(c){c.preventDefault();$(this).attr("disabled",true);$(this).text("Saving...");var b=DEALS_LIST_COLLECTION.collection.where({heading:App_Deals.newMilestone});var a=b[0].get("dealCollection").get(App_Deals.lost_reason_milesone_id);a.collection.get(App_Deals.lost_reason_milesone_id).set({lost_reason_id:$(this).closest(".modal").find("form").find("#lost_reason").val()});update_milestone(App_Deals.dealModel,App_Deals.lost_reason_milesone_id,App_Deals.newMilestone,App_Deals.old_milestone,false,$(this).closest(".modal").find("form").find("#lost_reason").val());
$("#dealLostReasonModal").modal("hide")})});function updateDeal(h,c){var g=(c?h:h.toJSON());add_recent_view(new BaseModel(g));var a=$("#opportunityUpdateForm");$("#opportunityUpdateForm")[0].reset();deserializeForm(g,$("#opportunityUpdateForm"));if($("#color1",a).is(":hidden")){$(".colorPicker-picker",a).remove();$("#color1",a).colorPicker()}$(".colorPicker-palette").find("input").attr("disabled","disabled");var b={VIOLET:"#ee82ee",INDIGO:"#4b0082",BLUE:"#0000ff",GREEN:"#00ff00",YELLOW:"#ffff00",ORANGE:"#ff6600",RED:"#ff0000",BLACK:"#000000",WHITE:"#ffffff",GREY:"#808080"};var e=b[g.colorName];if(!e){e="#808080"}$("#color1",a).attr("value",e);$(".colorPicker-picker",a).css("background-color",e);$("#tags-new-person",a).val("");if(g.tagsWithTime&&g.tagsWithTime.length){var d;for(d=0;d<g.tagsWithTime.length;d++){var f=g.tagsWithTime[d].tag;$("#tags_source_deal_modal",a).find(".tags").append('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="'+f+'"><span class="m-r-xs v-middle">'+f+'</span><a class="close" id="remove_tag">&times</a></li>')}}$("#opportunityUpdateModal").modal("show");if(g.archived){$("#opportunity_archive").hide();$("#opportunity_unarchive").show()}else{$("#opportunity_unarchive").hide();$("#opportunity_archive").show()}agile_type_ahead("relates_to",a,contacts_typeahead);populateUsers("owners-list",a,g,"owner",function(j){a.find("#owners-list").html(j);if(g.owner){$("#owners-list",a).find("option[value="+g.owner.id+"]").attr("selected","selected")}$("#owners-list",$("#opportunityUpdateForm")).closest("div").find(".loading-img").hide()});populateTrackMilestones(a,undefined,g,function(j){});$("#close_date",a).datepicker("remove");$("#close_date",a).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});showNoteOnForm("opportunityUpdateForm",g.notes);add_custom_fields_to_form(g,function(k){var j=show_custom_fields_helper(k.custom_fields,["modal"]);$("#custom-field-deals",a).html(fill_custom_fields_values_generic($(j),g.custom_data));$(".contact_input",a).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_contact_"+$(this).attr("id"),a),contacts_typeahead,undefined,"type=PERSON")});$(".contact_input",a).each(function(){var l=$(this).attr("name");for(var m=0;m<g.custom_data.length;++m){if(g.custom_data[m].name==l){var n=$.parseJSON(g.custom_data[m].value);var o="";$.each(n,function(p,q){if(p!=n.length-1){o+=q+","}else{o+=q}});setReferenceContacts(l,a,n,o)}}});$(".company_input",a).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_company_"+$(this).attr("id"),a),contacts_typeahead,undefined,"type=COMPANY")});$(".company_input",a).each(function(){var l=$(this).attr("name");for(var m=0;m<g.custom_data.length;++m){if(g.custom_data[m].name==l){var n=$.parseJSON(g.custom_data[m].value);var o="";$.each(n,function(p,q){if(p!=n.length-1){o+=q+","}else{o+=q}});setReferenceContacts(l,a,n,o)}}})},"DEAL");populateLostReasons(a,g);populateDealSources(a,g);setup_tags_typeahead()}function show_deal(){$("#opportunityForm")[0].reset();var a=$("#opportunityForm");if($("#color1",a).is(":hidden")){$(".colorPicker-picker",a).remove();$("#color1",a).colorPicker()}$(".colorPicker-palette").find("input").attr("disabled","disabled");$("#opportunityModal").modal("show");add_custom_fields_to_form({},function(c){var b=show_custom_fields_helper(c.custom_fields,["modal"]);$("#custom-field-deals",$("#opportunityModal")).html($(b));$(".contact_input",a).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_contact_"+$(this).attr("id"),a),contacts_typeahead,undefined,"type=PERSON")});$(".company_input",a).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_company_"+$(this).attr("id"),a),contacts_typeahead,undefined,"type=COMPANY")})},"DEAL");populateUsers("owners-list",a,undefined,undefined,function(b){$("#opportunityForm").find("#owners-list").html(b);$("#owners-list",$("#opportunityForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#opportunityForm")).closest("div").find(".loading-img").hide()});agile_type_ahead("relates_to",a,contacts_typeahead);populateTrackMilestones(a,undefined,undefined,function(b){console.log(b);$.each(b,function(c,d){if(d.isDefault){var e=d.id+"_";if(d.milestones.length>0){e+=d.milestones.split(",")[0];$("#pipeline_milestone",a).val(e);$("#pipeline",a).val(d.id);$("#milestone",a).val(d.milestones.split(",")[0])}}})});populateLostReasons(a,undefined);populateDealSources(a,undefined);$("#close_date",a).datepicker("remove");$("#close_date",a).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true})}function checkPipeline(a){var b=0;if(_agile_get_prefs("agile_deal_track")){b=_agile_get_prefs("agile_deal_track")}if(b==a){return true}return false}function removeArchive(c){var a=false;if(_agile_get_prefs("deal-filters")){var b=$.parseJSON(_agile_get_prefs("deal-filters")).archived;if(b=="false"&&c.archived==true){return true}else{if(b=="true"&&c.archived==false){return true}else{return false}}}else{return a}}function saveDeal(h,a,g,c,f){if($(g).attr("disabled")){return}disable_save_button($(g));if(!isValidForm("#"+h)){var b=$("#"+h).closest(".modal");var e=$("#"+h).find(".single-error").first();b.scrollTop(e.offset().top-b.offset().top+b.scrollTop());enable_save_button($(g));return false}if(c.close_date==0){c.close_date=null}var d=new Backbone.Model();d.url="core/api/opportunity";d.save(c,{success:function(O){enable_save_button($(g));$("#"+a).modal("hide");$("#"+h).each(function(){this.reset()});var x=O.toJSON();if(x.tags&&x.tags.length){saveDealTagsBulk(x.tags)}add_recent_view(new BaseModel(x));if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){$.each(x.contacts,function(S,R){if(R.id==App_Contacts.contactDetailView.model.get("id")){if(dealsView&&dealsView.collection){var Q=x.owner_id;if(!Q){Q=x.owner.id}if(hasScope("VIEW_DEALS")||CURRENT_DOMAIN_USER.id==Q){if(x.archived==true){dealsView.collection.remove(x.id);dealsView.collection.sort()}else{if(dealsView.collection.get(x.id)){dealsView.collection.get(x.id).set(new BaseModel(x));$("#"+x.id).closest("li").removeAttr("class");$("#"+x.id).closest("li").addClass("deal-color");$("#"+x.id).closest("li").addClass(x.colorName)}else{dealsView.collection.add(new BaseModel(x),{sort:false});dealsView.collection.sort()}}}if(!hasScope("VIEW_DEALS")&&CURRENT_DOMAIN_USER.id!=Q&&f){dealsView.collection.remove(x.id);dealsView.collection.sort()}}add_entity_to_timeline(O);return false}})}else{if(App_Companies.companyDetailView&&Current_Route=="company/"+App_Companies.companyDetailView.model.get("id")){company_util.updateDealsList(x,true,f)}else{if(Current_Route=="deals"){if(!_agile_get_prefs("agile_deal_view")){var G=x.milestone;if(f){var z=x.id;var P=$("#"+z).attr("data");$("#"+x.id).parent().removeClass();$("#"+x.id).parent().addClass(x.colorName);$("#"+x.id).parent().addClass("deal-color");var v=DEALS_LIST_COLLECTION.collection.where({heading:P});if(!v){return}var E=v[0].get("dealCollection").get(z).attributes.expected_value;v[0].get("dealCollection").remove(v[0].get("dealCollection").get(z));if(!checkPipeline(x.pipeline_id)){console.log("removing the deal");$("#"+P.replace(/ +/g,"")).find("#"+z).parent().remove();try{var u=parseFloat($("#"+P.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))-parseFloat(E);$("#"+P.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(u));if($("#"+P.replace(/ +/g,"")+"_count").text()!="1000+"){$("#"+P.replace(/ +/g,"")+"_count").text(parseInt($("#"+P.replace(/ +/g,"")+"_count").text())-1)}var H=0;var F=parseInt($("#"+P.replace(/ +/g,"")+"_count").text());if(F==0){H=0}else{H=u/F}u=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(u);H=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(H);var L=$("#pipeline-tour-step").children(".filter-dropdown").text();var C=getCurrencySymbolForCharts();var n=P.replace(/ +/g,"");var t={dealTrack:L,heading:n,dealcount:u,avgDeal:H,symbol:C,dealNumber:F};var B=JSON.stringify(t);$("#"+n+" .dealtitle-angular").removeAttr("data");$("#"+n+" .dealtitle-angular").attr("data",B)}catch(q){console.log(q)}}else{if(G!=P){v=DEALS_LIST_COLLECTION.collection.where({heading:G});if(!v){return}v[0].get("dealCollection").add(copyCursor(v,x));$("#"+P.replace(/ +/g,"")).find("#"+z).parent().remove();try{var M=x.expected_value;var u=parseFloat($("#"+P.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))-parseFloat(E);var m=parseFloat($("#"+G.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))+parseFloat(M);$("#"+G.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(m));$("#"+P.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(u));if($("#"+G.replace(/ +/g,"")+"_count").text()!="1000+"){if(parseInt($("#"+G.replace(/ +/g,"")+"_count").text())+1>1000){$("#"+G.replace(/ +/g,"")+"_count").text(parseInt($("#"+G.replace(/ +/g,"")+"_count").text())+"+")}else{$("#"+G.replace(/ +/g,"")+"_count").text(parseInt($("#"+G.replace(/ +/g,"")+"_count").text())+1)}}if($("#"+P.replace(/ +/g,"")+"_count").text()!="1000+"){$("#"+P.replace(/ +/g,"")+"_count").text(parseInt($("#"+P.replace(/ +/g,"")+"_count").text())-1)}var A=0;var F=parseInt($("#"+P.replace(/ +/g,"")+"_count").text());if(F==0){A=0}else{A=u/F}var r=0;var o=parseInt($("#"+G.replace(/ +/g,"")+"_count").text());if(o==0){r=0}else{r=m/o}u=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(u);A=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(A);m=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(m);r=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(r);var y=P.replace(/ +/g,"");var D=G.replace(/ +/g,"");var C=getCurrencySymbolForCharts();var L=$("#pipeline-tour-step").children(".filter-dropdown").text();$("#"+y+" .dealtitle-angular").removeAttr("data");
$("#"+D+" .dealtitle-angular").removeAttr("data");var N={dealTrack:L,heading:y,dealcount:u,avgDeal:A,symbol:C,dealNumber:F};var p=JSON.stringify(N);$("#"+y+" .dealtitle-angular").attr("data",p);var s={dealTrack:L,heading:D,dealcount:m,avgDeal:r,symbol:C,dealNumber:o};var J=JSON.stringify(s);$("#"+D+" .dealtitle-angular").attr("data",J)}catch(q){console.log(q)}}else{v=DEALS_LIST_COLLECTION.collection.where({heading:G});if(!v){return}v[0].get("dealCollection").add(copyCursor(v,x),{silent:true});console.log("Updating html - ",x);var I="deals-by-paging-model";if(!_agile_get_prefs("deal-milestone-view")){I="deals-by-paging-relax-model"}$("#"+G.replace(/ +/g,"")).find("#"+z).parent().html(getTemplate(I,x));try{var M=x.expected_value;var K=parseFloat($("#"+P.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))-parseFloat(E);var m=parseFloat(K)+parseFloat(M);$("#"+G.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(m));var r=0;var o=parseInt($("#"+G.replace(/ +/g,"")+"_count").text());if(o==0){r=0}else{r=m/o}m=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(m);r=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(r);var D=G.replace(/ +/g,"");var C=getCurrencySymbolForCharts();var L=$("#pipeline-tour-step").children(".filter-dropdown").text();var t={dealTrack:L,heading:D,dealcount:m,avgDeal:r,symbol:C,dealNumber:o};var B=JSON.stringify(t);$("#"+D+" .dealtitle-angular").removeAttr("data");$("#"+D+" .dealtitle-angular").attr("data",B)}catch(q){console.log(q)}}}if(removeArchive(x)){console.log("removing the deal when archived");$("#"+P.replace(/ +/g,"")).find("#"+z).parent().remove();try{if($("#"+P.replace(/ +/g,"")+"_count").text()!="1000+"){$("#"+P.replace(/ +/g,"")+"_count").text(parseInt($("#"+P.replace(/ +/g,"")+"_count").text())-1)}var M=x.expected_value;var m=parseFloat($("#"+P.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))-parseFloat(M);$("#"+P.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(m));var r=0;var o=parseInt($("#"+P.replace(/ +/g,"")+"_count").text());if(o==0){r=0}else{r=m/o}m=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(m);r=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(r);var D=P.replace(/ +/g,"");var C=getCurrencySymbolForCharts();var L=$("#pipeline-tour-step").children(".filter-dropdown").text();var t={dealTrack:L,heading:D,dealcount:m,avgDeal:r,symbol:C,dealNumber:o};var B=JSON.stringify(t);$("#"+D+" .dealtitle-angular").removeAttr("data");$("#"+D+" .dealtitle-angular").attr("data",B)}catch(q){console.log(q)}}}else{if(checkPipeline(x.pipeline_id)){var k=x.owner_id;if(!k){k=x.owner.id}if(!hasScope("VIEW_DEALS")&&CURRENT_DOMAIN_USER.id!=k){return}var v=DEALS_LIST_COLLECTION.collection.where({heading:G});if(!v){return}var j=$.parseJSON(_agile_get_prefs("deal-filters"));console.log(x.owner.id.toString()!=j.owner_id,x.owner.id.toString(),j.owner_id);if(j.owner_id.length>0&&x.owner.id.toString()!=j.owner_id){return}console.log(j.archived!="all"&&x.archived!=j.archived,x.archived);if(j.archived){console.log(j.archived);if(j.archived!="all"&&x.archived.toString()!=j.archived){return}}v[0].get("dealCollection").add(copyCursor(v,x));try{var l=x.expected_value;var w=parseFloat($("#"+G.replace(/ +/g,"")+"_totalvalue").text().replace(/\,/g,""))+parseFloat(l);$("#"+G.replace(/ +/g,"")+"_totalvalue").text(portlet_utility.getNumberWithCommasAndDecimalsForPortlets(w));if($("#"+G.replace(/ +/g,"")+"_count").text()!="1000+"){if(parseInt($("#"+G.replace(/ +/g,"")+"_count").text())+1>1000){$("#"+G.replace(/ +/g,"")+"_count").text(parseInt($("#"+G.replace(/ +/g,"")+"_count").text())+"+")}else{$("#"+G.replace(/ +/g,"")+"_count").text(parseInt($("#"+G.replace(/ +/g,"")+"_count").text())+1)}}var r=0;var o=parseInt($("#"+G.replace(/ +/g,"")+"_count").text());if(o==0){r=0}else{r=w/o}w=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(w);r=portlet_utility.getNumberWithCommasAndDecimalsForPortlets(r);var D=G.replace(/ +/g,"");$("#"+D+" .dealtitle-angular").removeAttr("data");var C=getCurrencySymbolForCharts();var L=$("#pipeline-tour-step").children(".filter-dropdown").text();var t={dealTrack:L,heading:D,dealcount:w,avgDeal:r,symbol:C,dealNumber:o};var B=JSON.stringify(t);$("#"+D+" .dealtitle-angular").attr("data",B)}catch(q){console.log(q)}}}includeTimeAgo($("#"+G.replace(/ +/g,"")));$("a.deal-notes").tooltip();$("#"+x.id).parent().addClass(x.colorName);$("#"+x.id).parent().addClass("deal-color")}else{var k=x.owner_id;if(!k){k=x.owner.id}if(!hasScope("VIEW_DEALS")&&CURRENT_DOMAIN_USER.id!=k){return}if(f){App_Deals.opportunityCollectionView.collection.remove(c)}if(App_Deals.opportunityCollectionView.collection.length>0){O.attributes.cursor=App_Deals.opportunityCollectionView.collection.last().toJSON().cursor}App_Deals.opportunityCollectionView.collection.add(O);App_Deals.opportunityCollectionView.render(true)}}else{if(Current_Route==undefined||Current_Route=="dashboard"){if(App_Portlets.currentPosition&&App_Portlets.pendingDeals&&App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)]){if(f){App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)].collection.remove(c)}if(c.milestone!="Won"&&c.milestone!="Lost"){App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)].collection.add(O)}App_Portlets.pendingDeals[parseInt(App_Portlets.currentPosition)].render(true)}if(App_Portlets.currentPosition&&App_Portlets.dealsWon&&App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)]){if(f){App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)].collection.remove(c)}App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)].collection.add(O);App_Portlets.dealsWon[parseInt(App_Portlets.currentPosition)].render(true)}}else{App_Deal_Details.dealDetailView.model=O;App_Deal_Details.dealDetailView.render(true);Backbone.history.navigate("deal/"+O.toJSON().id,{trigger:true})}}}}},error:function(j,k){enable_save_button($(g));$("#"+a).find("span.error-status").html("<i style='color:#B94A48;'>"+k.responseText+"</i>");setTimeout(function(){$("#"+a).find("span.error-status").html("")},2000);console.log("-----------------",k.responseText)}})}var Track_And_Milestone_Events_Collection_View=Base_Collection_View.extend({events:{"click .add-pipeline":"pipelineAdd","click .pipeline-edit":"pipelineEdit","click .pipeline-delete":"pipelineDelete","click .milestone-delete":"milestoneDelete","click .show_milestone_field":"showMilesoneField","click .add_milestone":"addMilestone","keypress .add_new_milestone":"addMilestoneWithEnterBtn"},pipelineAdd:function(a){a.preventDefault();$("#pipelineForm input").val("");$("#pipelineForm input#milestones").val("New,Prospect,Proposal,Won,Lost");$("#pipelineForm input#won_milestone").val("Won");$("#pipelineForm input#lost_milestone").val("Lost");$("#pipelineModal").find(".save-status").html("")},pipelineEdit:function(b){b.preventDefault();var c=$(b.currentTarget).attr("id");var a=App_Admin_Settings.pipelineGridView.collection.get(c).toJSON();deserializeForm(a,$("#pipelineForm"))},pipelineDelete:function(b){b.preventDefault();var c=$(b.currentTarget).attr("id");var a=$(b.currentTarget).attr("data");$("#track-name").text(a);$("body").on("click","#pipeline-delete-confirm",function(f){f.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");var d=$(this);$save_info=$('<img src="'+updateImageS3Path("img/1-0.gif")+'" height="18px" width="18px" style="opacity:0.5;"></img>&nbsp;&nbsp;<span><small class="text-success" style="font-size:15px; display:inline-block"><i>Deleting track.</i></small></span>');$(this).parent(".modal-footer").find(".pipeline-delete-message").append($save_info);$save_info.show();$.ajax({url:"/core/api/milestone/pipelines/"+c,type:"DELETE",success:function(){console.log("Deleted!");$("#pipeline-delete-modal").modal("hide");if(_agile_get_prefs("agile_deal_track")&&_agile_get_prefs("agile_deal_track")==c){_agile_delete_prefs("agile_deal_track")}if(_agile_get_prefs("deal-filters")){var e=$.parseJSON(_agile_get_prefs("deal-filters"));if(e.pipeline_id=c){_agile_delete_prefs("deal-filters")}}App_Admin_Settings.milestones();$("body").removeClass("modal-open");$save_info.hide();d.removeAttr("disabled")},error:function(g,e,h){console.log(g);$save_info.hide();$("#pipeline-delete-modal").find(".pipeline-delete-message").text(g.responseText);d.removeAttr("disabled")}})})},milestoneDelete:function(b){b.preventDefault();var a=$(b.currentTarget);showAlertModal("delete_milestone","confirm",function(){var c=a.closest("form");if(a.closest("tr").find(".mark-won").length>0){c.find('input[name="won_milestone"]').val("")}else{if(a.closest("tr").find(".mark-lost").length>0){c.find('input[name="lost_milestone"]').val("")}}a.closest("tr").css("display","none");fill_ordered_milestone(a.closest("form").attr("id"))})},showMilesoneField:function(b){b.preventDefault();var a=$(b.currentTarget).closest("form");console.log("New Milestone to - ",a.attr("id"));$(b.currentTarget).closest("div").css("display","none");a.find(".show_field").css("display","block");a.find(".add_new_milestone").focus()},addMilestone:function(d){d.preventDefault();var b=$(d.currentTarget).closest("form");var a=b.find(".add_new_milestone").val().trim();if(b.find(".add_new_milestone").val().trim()==""){$("#new_milestone_name_error_"+b.attr("id").split("milestonesForm_")[1]).show();return false}if(!(/^[a-zA-Z0-9-_ ]*$/).test(b.find(".add_new_milestone").val().trim())){$("#new_milestone_chars_error_"+b.attr("id").split("milestonesForm_")[1]).show();return false}b.find(".show_field").css("display","none");b.find(".show_milestone_field").closest("div").css("display","inline-block");if(!a||a.length<=0||(/^\s*$/).test(a)){return}if(a!=""){d.preventDefault();b.find(".add_new_milestone").val("");var c=b.find("tbody");var f=true;c.find("tr").each(function(e,g){if($(g).is(":visible")&&g.getAttribute("data").toLowerCase()==a.toLowerCase()){f=false;return false
}});if(f){c.append(getTemplate("js-new-milestone",{new_milestone:a}));fill_ordered_milestone(b.attr("id"))}}},addMilestoneWithEnterBtn:function(b){var a=$(b.currentTarget).closest("form");$("#new_milestone_name_error_"+a.attr("id").split("milestonesForm_")[1]).hide();$("#new_milestone_existed_error_"+a.attr("id").split("milestonesForm_")[1]).hide();$("#new_milestone_chars_error_"+a.attr("id").split("milestonesForm_")[1]).hide();if(b.keyCode==13){var a=$(b.currentTarget).closest("form");a.find(".add_milestone").click()}},});var Calendar_Sync_Settings_View=Base_Model_View.extend({events:{"click .save":"save_calendar_prefs","click .delete":"delete_calendar_prefs",},options:{errorCallback:function(a){$(".tab-content").removeClass("c-progress");showNotyPopUp("error","Invalid Details","bottomRight",1000)}},save_calendar_prefs:function(b,a){b.preventDefault();$(".tab-content").addClass("c-progress");this.options.prePersist=this.prePersist;this.options.saveCallback=this.saveCallback;this.save(b)},saveCallback:function(a){App_Datasync.dataSync();Backbone.history.navigate("sync");$(".tab-content").removeClass("c-progress")},delete_calendar_prefs:function(c,b){c.preventDefault();var a=this;showAlertModal("delete_calendar_prefs","confirm",function(){if(a.model.get("calendar_type")=="OFFICE365"){a.model.destroy({success:function(){a.model.clear()}});var g=JSON.parse(_agile_get_prefs("event-lhs-filters"));if(g){var k=g[CURRENT_AGILE_USER.id];if(k){g=k}var d=g.cal_type;if(d){var e=d.indexOf("office");if(e>=0){var j="office";var h="light";g.cal_type=$.grep(d,function(l){return l!=j});var f=JSON.parse(_agile_get_prefs("event-lhs-filters"));f[CURRENT_AGILE_USER.id]=g;_agile_set_prefs("event-lhs-filters",JSON.stringify(f))}}}}})},prePersist:function(a){if(!a||!a.get("prefs")){return}a.set("prefs",JSON.stringify(a.get("prefs")),{silent:true});console.log(a)},show_loading:function(a){this.model.destroy()}});function load_imap_folders(e,c){var f=c.id;var b="<option {{selected}}>{{name}}</option>";fillSelect("imap-folders-multi-select","/core/api/imap/"+f+"/imap-folders","folders",function d(){$("#imap-folders-multi-select .default-select",e).remove()},b,false,e);var a=$(".imap-folders-settings-click",e).closest("div");$(".imap-folders-settings-click",e).css("display","none");a.find(".imap-folders-settings-txt").css("display","none");a.find(".imap-folders-select").css("display","inline")}function load_gmail_widgets(a){gmailListView1=new Settings_Collection_Events({url:"core/api/social-prefs/GMAIL/list",templateKey:"settings-social-prefs",individual_tag_name:"div",postRenderCallback:function(d){var c=gmailListView1.collection.length;if((c<a&&!HAS_EMAIL_ACCOUNT_LIMIT_REACHED)||c===0){var b={service:"Gmail",return_url:encodeURIComponent(window.location.href)};getTemplate("settings-social-prefs-model",b,undefined,function(e){if(!e){return}$("#prefs-tabs-content").find("#social-prefs").append($(e))},null)}updateTimeOut()}});gmailListView1.collection.fetch();App_Settings.gmailListView=gmailListView1;$("#prefs-tabs-content").find("#social-prefs").html(App_Settings.gmailListView.el)}function load_imap_widgets(a){imapListView1=new Settings_Collection_Events({url:"core/api/imap/",templateKey:"settings-imap-access",individual_tag_name:"div",postRenderCallback:function(d){var c=imapListView1.collection.length;if((c<a&&!HAS_EMAIL_ACCOUNT_LIMIT_REACHED)||c===0){var b={};getTemplate("settings-imap-access-model",b,undefined,function(e){if(!e){return}$("#prefs-tabs-content").find("#imap-prefs").append($(e))},null)}updateTimeOut()}});imapListView1.collection.fetch();App_Settings.imapListView=imapListView1;$("#prefs-tabs-content").find("#imap-prefs").html(App_Settings.imapListView.el)}function load_office365_widgets(a){officeListView1=new Settings_Collection_Events({url:"core/api/office/",templateKey:"settings-office-access",individual_tag_name:"div",postRenderCallback:function(d){var c=officeListView1.collection.length;if((c<a&&!HAS_EMAIL_ACCOUNT_LIMIT_REACHED)||c===0){var b={};getTemplate("settings-office-access-model",b,undefined,function(e){if(!e){return}$("#prefs-tabs-content").find("#office-prefs").append($(e))},null)}updateTimeOut()}});officeListView1.collection.fetch();App_Settings.officeListView=officeListView1;$("#prefs-tabs-content").find("#office-prefs").html(App_Settings.officeListView.el)}function updateTimeOut(a){setTimeout(function(){$("#all-email-settings-prefs .col-md-4 .panel").each(function(){if($(this).height()>EMAIL_PREFS_WIDGET_SIZE){EMAIL_PREFS_WIDGET_SIZE=$(this).height()}});$("#all-email-settings-prefs .col-md-4 .panel").each(function(){$(this).height(EMAIL_PREFS_WIDGET_SIZE)})},1000)}function load_imap_properties(b,f){var h=b.id;var g="<option value='{{id}}' {{selected}}>{{name}}</option>";var d=$(".imap-share-settings-select",f).closest("div");fillSelect("imap-share-user-select","core/api/imap/shared-to-users?id="+h,"users",function c(){$("#imap-share-user-select .default-select",f).remove();$(".imap-share-select .loading",f).hide()},g,false,d);var a=$(".imap-folders-settings-click",f).closest("div");var e="<option {{selected}}>{{name}}</option>";fillSelect("imap-folders-multi-select","core/api/imap/"+h+"/imap-folders","folders",function c(){$("#imap-folders-multi-select .default-select",f).remove()},e,false,a)}var Settings_Modal_Events=Base_Model_View.extend({onGmailShareOptionsSelect:function(d){d.preventDefault();var g=$(d.currentTarget);var f=$(g).attr("oid");var c=$(g).closest("div");$(g).css("display","none");c.find(".gmail-share-select").css("display","inline");c.find(".gmail-share-settings-txt").css("display","none");var a="<option value='{{id}}' {{selected}}>{{name}}</option>";fillSelect("gmail-share-user-select","core/api/social-prefs/shared-to-users?id="+f,"users",function b(){$("#gmail-share-user-select .default-select",c).remove()},a,false,c)},onGmailShareOptionsCancel:function(c){if(c.target.parentElement.attributes[0].name!="href"&&c.target.parentElement.attributes[1].name!="href"){c.preventDefault();var d=$(c.currentTarget);var b=$(d).closest("div");var a=$(d).attr("name");b.find(".gmail-share-select").css("display","none");b.find(".gmail-share-settings-select").css("display","inline");b.find(".gmail-share-settings-txt").css("display","inline")}},onImapShareOptionsSelect:function(d){d.preventDefault();var g=$(d.currentTarget);var f=$(g).attr("oid");var c=$(g).closest("div");$(g).css("display","none");c.find(".imap-share-settings-txt").css("display","none");c.find(".imap-share-select").css("display","inline");var a="<option value='{{id}}' {{selected}}>{{name}}</option>";fillSelect("imap-share-user-select","core/api/imap/shared-to-users?id="+f,"users",function b(){$("#imap-share-user-select .default-select",c).remove()},a,false,c)},onImapShareOptionsCancel:function(c){c.preventDefault();var d=$(c.currentTarget);var b=$(d).closest("div");var a=$(d).attr("name");b.find("#imap-share-user-select").empty();b.find(".imap-share-select").css("display","none");b.find(".imap-share-settings-select").css("display","inline");b.find(".imap-share-settings-txt").css("display","inline")},onImapFoldersOptionsSelect:function(d){d.preventDefault();var g=$(d.currentTarget);var c=$(g).closest("div");var f=$(g).attr("oid");$(g).css("display","none");c.find(".imap-folders-select").css("display","inline");var a="<option {{selected}}>{{name}}</option>";fillSelect("imap-folders-multi-select","core/api/imap/"+f+"/imap-folders","folders",function b(){$("#imap-folders-multi-select .default-select",c).remove()},a,false,c)},onImapFoldersOptionsCancel:function(b){b.preventDefault();var c=$(b.currentTarget);var a=$(c).closest("div");a.find("#imap-folders-multi-select").empty();a.find(".imap-folders-select").css("display","none");a.find(".imap-folders-settings-click").css("display","inline")},onOfficeShareOptionsSelect:function(d){d.preventDefault();var g=$(d.currentTarget);var c=$(g).closest("div");$(g).css("display","none");var f=$(g).attr("oid");c.find(".office-share-settings-txt").css("display","none");c.find(".office-share-select").css("display","inline");var a="<option value='{{id}}' {{selected}}>{{name}}</option>";fillSelect("office-share-user-select","core/api/office/shared-to-users?id="+f,"users",function b(){$("#office-share-user-select .default-select",c).remove()},a,false,c)},onOfficeShareOptionsCancel:function(c){c.preventDefault();var d=$(c.currentTarget);var b=$(d).closest("div");var a=$(d).attr("name");b.find(".office-share-select").css("display","none");b.find(".office-share-settings-select").css("display","inline");b.find(".office-share-settings-txt").css("display","inline")},events:{"click .gmail-share-settings-select":"onGmailShareOptionsSelect","click .gmail-share-settings-cancel":"onGmailShareOptionsCancel","click .imap-share-settings-select":"onImapShareOptionsSelect","click .imap-share-settings-cancel":"onImapShareOptionsCancel","click .imap-folders-settings-click":"onImapFoldersOptionsSelect","click .imap-folders-settings-cancel":"onImapFoldersOptionsCancel","click .office-share-settings-select":"onOfficeShareOptionsSelect","click .office-share-settings-cancel":"onOfficeShareOptionsCancel",},});var Settings_Collection_Events=Base_Collection_View.extend({events:{"click #gmail-prefs-delete":"onGmailPrefsDelete","click #office-prefs-delete,#imap-prefs-delete":"onImapOfficePrefsDelete",},onGmailPrefsDelete:function(b){b.preventDefault();var d=$(b.currentTarget);var a=$(d);var c=$(a).attr("oid");if($(a).attr("disabled")){return}showAlertModal("delete","confirm",function(){disable_save_button($(a));$.ajax({url:"/core/api/social-prefs/delete/"+c,type:"DELETE",success:function(){enable_save_button($(a));App_Settings.email();return}})})},onImapOfficePrefsDelete:function(b){b.preventDefault();var d=$(b.currentTarget);var a=$(d);var c=$(a).attr("oid");if($(a).attr("disabled")){return}showAlertModal("delete","confirm",function(){disable_save_button($(a));var e=$(a).attr("name");$.ajax({url:"/core/api/"+e+"/delete/"+c,type:"DELETE",success:function(){enable_save_button($(a));
App_Settings.email();return}})})},});$(function(){$("#content").on("click","#email-gateway-delete",function(a){a.preventDefault();showAlertModal("delete","confirm",function(){$.ajax({url:"core/api/email-gateway",type:"DELETE",success:function(){if(App_Admin_Settings.email_gateway&&App_Admin_Settings.email_gateway.model){var b=App_Admin_Settings.email_gateway.model.toJSON();if(b.email_api=="MANDRILL"){$.getJSON("core/api/email-gateway/delete-webhook?api_key="+b.api_key+"&type="+b.email_api,function(c){console.log(c)})}else{if(b.email_api==="MAILGUN"){$.getJSON("core/api/email-gateway/delete-webhook?api_key="+b.api_key+"&type="+b.email_api+"&api_user="+b.api_user,function(c){console.log(c)})}}}location.reload(true)}})})});$("#content").on("click","#sms-gateway-delete",function(a){a.preventDefault();var b=$(this).attr("data");showAlertModal("delete","confirm",function(){$.ajax({url:"core/api/widgets/integrations/"+b,type:"DELETE",success:function(){location.reload(true)}})})});$("#prefs-tabs-content .widgets_inner ul li").off("click");$("#prefs-tabs-content").on("click",".widgets_inner ul li",function(){var a=$(this).find("a").attr("href").split("#");_agile_set_prefs("widget_tab",a[1]);Backbone.history.navigate("add-widget",{trigger:true})})});function loadip_access_events(){$(".blocked-panel-ip-delete").on("click",function(b){b.preventDefault();var d=$(this).closest("form");var c=$(this).closest("tr").find("input").val();var f=$(this).closest("form").find('input[name="id"]').val();var a=$(this);showAlertModal("delete","confirm",function(){$.ajax({url:"core/api/allowedips/delete_ip?id="+f+"&ip="+c,type:"DELETE",success:function(){a.closest("tr").remove()},error:function(e){console.log(e)}})})});$(".upsert-ip").on("click",function(b){var a={};if(element_has_attr($(this),"data-position")){a.position=$(this).attr("data-position");a.ip=$(this).closest("tr").find("input").val()}$("#ipaccess-modal").html(getTemplate("add-new-ip",a)).modal("show");$("#ip-add").on("click",function(g){var d=$(this).closest("form");if(!isValidForm(d)){return}var f=$("#iplist").val();if(element_has_attr($(this),"data-position")){var c=$(this).attr("data-position");$(".iptable tbody tr").eq(c).find("input").val(f)}else{$(".newip").val(f)}d.trigger("reset");$(".newip").closest("form").find(".save").trigger("click");$("#ipaccess-modal").html(getTemplate("add-new-ip",{})).modal("hide")})})}function element_has_attr(b,c){var a=$(b).attr(c);return(typeof a!==typeof undefined&&a!==false)}var Agile_Tour={};function create_tour_steps(a){Agile_Tour.contacts=[{element:"#contacts",title:"Contact & Account Management",content:"View your contacts, leads and accounts (companies) all at one place.<br/>",placement:"bottom",el:a,backdrop:true},{element:"#filters-tour-step",title:"Companies (Accounts)",content:"Accounts are stored as Companies in Agile.<br/><br/> You can switch between contacts and companies  here.<br/>",placement:"bottom",el:a,backdrop:true},{element:"#tags",title:"Tags",content:"Tags help you effectively manage your contacts and companies.<br/><br/> For eg: you can add a lead tag to your contacts for leads.<br/>",placement:"right",el:a,backdrop:true}];Agile_Tour["contact-details"]=[{element:"#contact-tab-content",title:"Facebook-Style Timeline",content:"Notice the awesome timeline with dates, emails exchanged, social messages & site visits.<br/>",placement:"right",el:a,backdrop:true},{element:"#score",container:"#score",title:"Score your leads",content:"Assign lead scores for every contact to keep high quality leads swimming on top. <br/><br/> Use workflows to automate the process based on user behavior.<br/>",placement:"bottom",el:a,backdrop:true},{element:"#widgets",title:"Widgets & Integrations",content:"Get more information about the contact from social media, helpdesk tickets, chats, and from billing systems.<br/>",placement:"left",el:a,backdrop:true,},];Agile_Tour.calendar=[{element:"#calendar_event",title:"Calendar Events",content:"Events are time based such as meetings.<br/> They show up in calendar.<br/>",placement:"left",backdrop:true,},{element:".todo-block",title:"To Do Tasks",content:"Tasks are like to-dos. Result oriented.<br/><br/> You can assign a category such as call, email.<br/>",placement:"right",backdrop:true,},{element:"#subscribe-ical",title:"Calendar Sync",content:"You can sync your Agile calendar with  Outlook, Google calendar or your mobile phone.<br/>",placement:"top",backdrop:true,},];Agile_Tour.workflows=[{element:"#learn-workflows",title:"Learn about Campaigns",content:"Our customers love campaign workflows. You would too!<br/><br/>  <p class='text-error'><strong>Take a few mins and learn more about campaigns.</strong></p>",placement:"left",el:a,backdrop:true,},{element:"#add-trigger",title:"Triggers",content:"Create conditions to trigger your campaigns automatically. <br/><br/> <strong>Eg:</strong> when a tag is added or when a contact reaches a score.<br/>",placement:"bottom",el:a,backdrop:true,}]}var tour;function start_tour(a,b){if((1+1)==2){return}if(!a){a=Current_Route}console.log(tour);if(tour&&tour._options){var c=tour._current;console.log(c);console.log(tour._options.name);console.log(a+"-tour");if(tour._options.name!=a+"-tour"){tour.end();tour=undefined}else{tour.end();tour.setCurrentStep(c);tour.start(true);return}}tour=undefined;var d=false;if(!b){if(d){return}initiate_tour(a,b);d=true}$("body").on("agile_collection_loaded","body",function(f,e){if(d){return}initiate_tour(a,e);d=true})}function initiate_tour(a,b){var c=_agile_get_prefs("agile_tour");if(!c){return}if(!a){if(!Current_Route){return}a=Current_Route}c=JSON.parse(JSON.parse(c));tourStatus=c[a];if(!tourStatus){return}if($.isEmptyObject(Agile_Tour)){create_tour_steps(b)}if(Agile_Tour[a]){head.load(CSS_PATH+"css/bootstrap-tour.min.css","lib/bootstrap-tour-agile.min.js",function(){tour=new Tour({name:a+"-tour",debug:true,useLocalStorage:true,endOnLast:true,onEnd:function(d){$("."+a+"-tour").remove();delete c[a];if($.isEmptyObject(c)){_agile_delete_prefs("agile_tour");return}_agile_set_prefs("agile_tour",JSON.stringify(JSON.stringify(c)))}});tour.addSteps(Agile_Tour[a]);tour.setCurrentStep(0);tour.start(true)})}}function reinitialize_tour_on_current_route(){console.log(tour);var b=_agile_get_prefs("agile_tour");var a=Current_Route;if(Current_Route.indexOf("contact/")!=-1){a="contact-details"}if(b){b=JSON.parse(JSON.parse(b));if(b[a]==true){return}_agile_delete_prefs(a+"-tour_current_step")}else{b={}}b[a]=true;console.log(JSON.stringify(b));_agile_delete_prefs(a+"-tour_current_step");_agile_set_prefs("agile_tour",JSON.stringify(JSON.stringify(b)));initiate_tour(a)}$(function(){$("#agile-page-tour").click(function(a){a.preventDefault();reinitialize_tour_on_current_route()})});function initializeRegenerateKeysListeners(){$(".prettyprint").css({padding:"9px 15px; ",border:"none"});$("#api_key_generate_icon").on("click",function(a){a.preventDefault();regenerate_api_key("core/api/api-key/key")});$("#jsapi_key_generate_icon").off("click").on("click",function(a){a.preventDefault();regenerate_api_key("core/api/api-key/jskey")})}function update_admin_settings_api_key_template(){$.ajax({url:"core/api/api-key",type:"GET",dataType:"json",success:function(a){getTemplate("admin-settings-api-key-model",a,undefined,function(b){if(!b){return}$("#admin-prefs-tabs-content").html($(b));prettify_api_add_events()},null)}})}function regenerate_api_key(a){showAlertModal("regenerate_api_key","confirm",function(){$.ajax({url:a,type:"POST",success:function(){update_admin_settings_api_key_template()}})})}function prettify_api_add_events(){prettyPrint();initializeRegenerateKeysListeners();$("#update_allowed_domains").off("click");$("#update_allowed_domains").on("click",function(d){d.preventDefault();$(this).attr("disabled","disabled");var b=get_allowed_domains();var c=$("#new_allowed_domain").val();if(!c||is_duplicate_allowed_domain(c,b)){$(this).removeAttr("disabled");return}b=b?b+", "+c:c;put_allowed_domains(b)});$("#webhook_accordian").on("click",function(b){b.preventDefault();if($("#webhook-accordian-template").html()!=""){return}setTimeout(function(){App_Admin_Settings.webhookSettings()},500)});$("sendgrid-dkim_accordian").off("click");$("#sendgrid-dkim_accordian").on("click",function(c){c.preventDefault();var b=new Base_Model_View({url:"/core/api/emails/sendgrid/permission",template:"admin-setting-sendgrid-whitelabel-permission",postRenderCallback:function(d){if($("#sendgrid-dkim-restriction-template").html().search("undefined")==-1){$("#get_whitelabel_key").attr("disabled",true);$("#validate_whitelabel").attr("disabled",true);$("#whitelabel-domain").attr("disabled",true)}else{$("#get_whitelabel_key").attr("disabled",false);$("#validate_whitelabel").attr("disabled",false);$("#whitelabel-domain").attr("disabled",false);$("#sendgrid-dkim-restriction-template").html("")}console.log($("#sendgrid-dkim-restriction-template").html()+"hhh")}});$("#sendgrid-dkim-restriction-template").html(b.render().el);return});$("#js-security_accordian").on("click",function(b){b.preventDefault();if($("#js-security-accordian-template").html()!=""){return}setTimeout(function(){App_Admin_Settings.jsSecuritySettings()},500)});$("#sso-login_accordian").on("click",function(b){b.preventDefault();if($("#sso-login-accordian-template").html()!=""){return}setTimeout(function(){App_Admin_Settings.ssoLoginSettings()},500)});$(".allowed-domain-delete").off("click");$(".allowed-domain-delete").on("click",function(c){c.preventDefault();$(this).closest("tr").remove();var b=get_allowed_domains();put_allowed_domains(b)});$("#get_my_ip").on("click",function(b){$("#new_blocked_ip").val(USER_IP_ADDRESS);$("#ip_error_message").addClass("hide");$("#empty_ip_message").addClass("hide")});$("#update_blocked_ips").off("click");$("#update_blocked_ips").on("click",function(d){d.preventDefault();$("#ip_error_message").addClass("hide");$("#empty_ip_message").addClass("hide");$(this).attr("disabled","disabled");var c=get_blocked_ips();
var b=$("#new_blocked_ip").val();if(!b||is_duplicate_blocked_ip(b,c)||!is_valid_ip(b)){$(this).removeAttr("disabled");if(is_duplicate_blocked_ip(b,c)){$("#ip_error_message").removeClass("hide")}else{$("#empty_ip_message").removeClass("hide")}return}c=c?c+", "+b:b;put_blocked_ips(c);$("#ip_error_message").addClass("hide");$("#empty_ip_message").addClass("hide")});$(".blocked-ip-delete").off("click");$(".blocked-ip-delete").on("click",function(c){c.preventDefault();$(this).closest("tr").remove();var b=get_blocked_ips();put_blocked_ips(b)});$("#get_whitelabel_key").off("click");$("#get_whitelabel_key").on("click",function(c){c.preventDefault();$("#sendgrid-whitelabel-key-template").html("");var d=$("#whitelabel-domain").val();var b=/^[a-z0-9-\.]+\.[a-z]{2,4}/;if(!b.test(d)){$("#empty_domain_message").removeClass("hide")}else{$("#empty_domain_message").addClass("hide");getSendgridWhitelabel(d)}});$("#validate_whitelabel").off("click");$("#validate_whitelabel").on("click",function(c){c.preventDefault();$("#sendgrid-whitelabel-key-template").html("");var d=$("#whitelabel-domain").val();var b=/^[a-z0-9-\.]+\.[a-z]{2,4}/;if(!b.test(d)){$("#empty_domain_message").removeClass("hide")}else{$("#empty_domain_message").addClass("hide");validateSendgridWhitelabel(d)}});try{if(ACCOUNT_PREFS.plan.plan_type.split("_")[0]=="PRO"||ACCOUNT_PREFS.plan.plan_type.split("_")[0]=="ENTERPRISE"){$("#tracking-webrules, .tracking-webrules-tab").hide()}else{$("#tracking-webrules-whitelist, .tracking-webrules-whitelist-tab").hide()}}catch(a){$("#tracking-webrules-whitelist, .tracking-webrules-whitelist-tab").hide()}}function getSendgridWhitelabel(b){var a=new Base_Model_View({url:"/core/api/emails/sendgrid/whitelabel?emailDomain="+b,template:"admin-setting-sendgrid-whitelabel",});$("#sendgrid-whitelabel-key-template").html(a.render().el)}function validateSendgridWhitelabel(b){var a=new Base_Model_View({url:"/core/api/emails/sendgrid/whitelabel/validate?emailDomain="+b,template:"admin-setting-sendgrid-whitelabel-validate",});$("#sendgrid-whitelabel-key-template").html(a.render().el)}function load_urls_on_ajax_stop(a,b){if(!isActive()){setTimeout(function(){load_urls_on_ajax_stop(a,b)},5000);return}head.js(a,function(){if(b&&typeof b=="function"){b()}})}function loadMiscScriptsWithTimeOut(){if(loadMiscScripts){setTimeout(loadMiscScripts,10000);return}try{setTimeout(loadMiscScriptsWithTimeOut,3000)}catch(a){console.log(a)}}function loadMiscScripts(){load_analytics_code();load_urls_on_ajax_stop("stats/min/agile-min.js?_="+_agile_get_file_hash("agile-min.js"),function(){initialize_agile_domain_sync();_agile_execute_web_rules()});if(!agile_is_mobile_browser()){load_urls_on_ajax_stop("lib/user-voice.js",function(){})}downloadAndRegisterForNotifications()}$(function(){setTimeout(loadMiscScriptsWithTimeOut,10000)});function isActive(){if($.active>0){return false}return true}function load_analytics_code(){(function(d,e,j,h,f,c,b){d.GoogleAnalyticsObject=f;d[f]=d[f]||function(){(d[f].q=d[f].q||[]).push(arguments)},d[f].l=1*new Date();c=e.createElement(j),b=e.getElementsByTagName(j)[0];c.async=1;c.src=h;b.parentNode.insertBefore(c,b)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-44894190-1","auto");ga("send","pageview");ga("create","UA-75813054-1",{name:"b"});ga("b.send","pageview")}$(function(){$("#choose-avatar-modal").on("click",".thumb-avatar-wrapper",function(c){c.preventDefault();var a=$(this).closest(".modal").attr("id");var b=$(this).find("img").attr("src");$(this).closest(".modal-body").find("input[type='hidden']").val(b);$(this).closest(".modal").modal("hide");$(this).trigger("choose-image")});$("#choose-avatar-modal").on("choose-image",".thumb-avatar-wrapper",function(b){var a=$(this).attr("src");if(a){$("input[name='custom_image']").val(a);setImageURL(a)}});$("#content").on("choose-image","#choose-avatar-test",function(b){$("#choose-avatar-modal").closest(".modal").modal("hide");var a=$(this).find("tbody").find("input[type='hidden']").val();if(a){$("input[name='custom_image']").val(a);setImageURL(a)}});$("#choose-avatar-modal").on("show.bs.modal",function(a){$("#choose-avatar-modal").html($("#choose-avatar-test").html())})});function choose_random_avatar(){var a=["https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/86.png","https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/72.png","https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/17.png","https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/5.png","https://d1gwclp1pmzk26.cloudfront.net/img/gravatar/3.png"];var b=Math.floor((Math.random()*a.length));return a[b]}function setup_dashboard(a){show_dashboard_subscription_details(a);show_dashboard_contacts(a);show_dashboard_tasks(a);show_dashboard_deals(a);show_dashboard_workflows(a);initBlogSync()}function initBlogSync(){head.js(LIB_PATH+"lib/jquery.feeds.min.js",function(){$("#blog_sync_container").feeds({feeds:{blog:"https://www.agilecrm.com/blog/feed/"},max:3,entryTemplate:function(a){return'<strong><a href="'+a.link+'" title = "'+a.title+'" target="_blank" >'+a.title+'</a></strong><div class="text-xs l-h-xs m-b-xs text-light">'+new Date(a.publishedDate).format("mmm d, yyyy")+'</div><p class="p-t-xs m-b">'+a.contentSnippet.replace("<a",'<a target="_blank"')+"</p>"}})})}function show_dashboard_contacts(b){var a=new Base_Collection_View({url:"core/api/contacts/recent?page_size=5",restKey:"contacts",templateKey:"dashboard-contacts",individual_tag_name:"tr",sort_collection:false,});a.collection.fetch();$("#recent-contacts",b).html(a.render().el)}function show_dashboard_tasks(b){var a=new Base_Collection_View({url:"/core/api/tasks/my/dashboardtasks",restKey:"task",sortKey:"due",templateKey:"dashboard1-tasks",individual_tag_name:"tr",postRenderCallback:function(c){agileTimeAgoWithLngConversion($(".task-due-time",c))}});a.appendItem=append_tasks_dashboard;a.collection.fetch();$("#my-tasks").html(a.el)}function show_dashboard_deals(a){var b=new Base_Collection_View({url:"core/api/opportunity/my/upcoming-deals",restKey:"opportunity",templateKey:"dashboard-opportunities",individual_tag_name:"tr",page_size:5,sortKey:"created_time",descending:true,postRenderCallback:function(c){agileTimeAgoWithLngConversion($(".deal-close-time",c))}});b.collection.fetch();$("#my-deals").html(b.el)}function show_dashboard_workflows(a){var b=new Base_Collection_View({url:"/core/api/campaigns/logs/recent?page_size=5",restKey:"workflow",templateKey:"dashboard-campaign-logs",individual_tag_name:"tr",page_size:10,sortKey:"time",descending:true,postRenderCallback:function(c){agileTimeAgoWithLngConversion($("time.log-created-time",c))}});b.collection.fetch();$("#my-logs").html(b.el)}function show_dashboard_subscription_details(b){var a=new Base_Model_View({url:"core/api/subscription",template:"dashboard-account-info",});a.model.fetch({success:function(c){if(!$.isEmptyObject(c.toJSON())){$("#subscription-stats").html(a.render(true).el);return}$.get("core/api/users/count",function(d){var e={};e.users_count=d;e.plan="free";console.log(e);getTemplate("user-billing",e,undefined,function(f){if(!f){return}$("#subscription-stats").html($(f))},"#subscription-stats")})}})}$(function(){$("body").on("click","#dashboard-contacts-model-list > tr, #dashboard-campaign-logs-model-list > tr",function(a){var b=$(this).find(".data").attr("data");App_Contacts.navigate("contact/"+b,{trigger:true})})});function setup_dashboardTimeline(a){if(!a){a="core/api/timeline/contact"}head.js(LIB_PATH+"lib/storyjs-embed.js",function(){createStoryJS({type:"default",width:"1170",height:"350",source:a,embed_id:"my-timeline",js:"lib/timeline-min.js",css:"css/dashboard-timeline.css"})})}$(function(){$("#referModal").on("click","ul li",function(b){var a=$(this).attr("id");if(a==undefined){return}switch(a){case"write_blog":$("#referModal").find(".modal-body").html(getTemplate("refer-blog",{}));Agile_GA_Event_Tracker.track_event("Write a blog (Ref)");return;case"refer_friends":$("#referModal").modal("hide");Agile_GA_Event_Tracker.track_event("Refer Friends (Ref)");window.location="#refer-friends";return;case"share_on_fb":if($.inArray("facebook_share",REFER_DATA.usedReferTypes)!=-1){return}Agile_GA_Event_Tracker.track_event("Share on Facebook (Ref)");shareOnFacebook();return;case"follow_on_twitter":if($.inArray("twitter_follow",REFER_DATA.usedReferTypes)!=-1){return}Agile_GA_Event_Tracker.track_event("Follow on Twitter (Ref)");var c=window.open("cd_twitter.jsp?referral_type=follow","twitter","height=700,width=700,location=1");if(window.focus){c.focus()}return;case"tweet_about_us":if($.inArray("twitter_tweet",REFER_DATA.usedReferTypes)!=-1){return}Agile_GA_Event_Tracker.track_event("Tweet about us (Ref)");$("#referModal").find(".modal-body").html(getTemplate("refer-tweet",{}));return;default:return}});$("#referModal").on("click","#blogMail",function(c){c.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm($("#blogmailForm"))){return}disable_send_button($(this));var b=serializeForm("blogmailForm");var a=$(this);b.body="Username: "+CURRENT_DOMAIN_USER.email+"<br>Domain: "+CURRENT_DOMAIN_USER.domain+"<br>Blog URL: "+b.body;b.body=b.body.replace(/\r\n/g,"<br/>");$.ajax({type:"POST",data:b,url:"core/api/emails/contact-us",success:function(){enable_send_button(a);trackReferrals("blogpost");showNotyPopUp("information","Your submission is successful.","top")},error:function(d){enable_send_button(a);showNotyPopUp("warning",data.responseText,"top")}})});$("#referModal").on("click","#refer_by_tweet",function(a){a.preventDefault();if($(this).attr("disabled")){return}var b=window.open("cd_twitter.jsp?referral_type=tweet","twitter","height=700,width=700,location=1");if(window.focus){b.focus()}});$("#referModal").on("click","#go_to_referrals",function(a){a.preventDefault();$("#referModal").find(".modal-body").html(getTemplate("refer-modal-body",REFER_DATA))});$("#referModal").on("click","#refered_users",function(a){$("#referModal").modal("hide")})});function shareOnFacebook(){console.log("clicked");
FB.getLoginStatus(function(a){if(a.status==="connected"){openFacebookModal()}else{console.log("login");FB.login(function(b){if(b.authResponse){openFacebookModal()}},{scope:"email"})}})}function openFacebookModal(){var a={method:"feed",message:"We're using ClickDesk live chat and help desk software to increase sales, conversions and customer happiness :)",link:"https://www.agilecrm.com",name:"CRM, Sales and Marketing Automation Software",caption:"www.agilecrm.com.com",description:"All-in-one powerful and affordable Customer Relationship Management (CRM) software with sales and marketing automation for small businesses. Sign up now!",picture:"https://doxhze3l6s7v9.cloudfront.net/beta/static/images/agilecrm-logo.jpg",display:"dialog"};console.log(a);FB.ui(a,function(b){console.log(b);if(!b||!b.post_id){console.log("post was not shared");return}trackReferrals("facebook");addRefeferCredits("facebook")})}function addRefeferCredits(a){$.ajax({url:"core/api/refer/share_on_fb",type:"POST",success:function(b){REFER_DATA.usedReferTypes.push("facebook_share");console.log("Emails added")},error:function(){console.log("Error occured")}})}function load_facebook_lib_for_referrals(){head.js("https://connect.facebook.net/en_US/all.js",function(){window.fbAsyncInit=function(){FB.init({appId:"827039704106675",status:true,cookie:true,xfbml:true,oauth:true})};window.onload=function(){FB.Canvas.setAutoResize()}})}function trackReferrals(a){$("#referModal").find(".modal-body").html(getTemplate("refer-modal-body",REFER_DATA));if(a==undefined){return}switch(a){case"facebook":showNotyPopUp("information","Your submission is successful.","top");$("#share_on_fb").css("cursor","not-allowed");$("#share_on_fb .refer-checked").removeClass("hide");sendReferralTrackMail("Shared on facebook");REFER_DATA.usedReferTypes.push("facebook_share");return;case"follow":showNotyPopUp("information","You are following Agile CRM on Twitter. Congratulations!","top");$("#follow_on_twitter").css("cursor","not-allowed");$("#follow_on_twitter .refer-checked").removeClass("hide");sendReferralTrackMail("Following on twitter");REFER_DATA.usedReferTypes.push("twitter_follow");return;case"tweet":showNotyPopUp("information","Your tweet has been posted successfully.","top");$("#tweet_about_us").css("cursor","not-allowed");$("#tweet_about_us .refer-checked").removeClass("hide");sendReferralTrackMail("Tweet");REFER_DATA.usedReferTypes.push("twitter_tweet");return;default:return}}function sendReferralTrackMail(b,c){var a={};a.from=CURRENT_DOMAIN_USER.email;a.cc="venkat@agilecrm.com";a.bcc="mogulla@agilecrm.com";a.to="shreyansh@agilecrm.com";a.subject="Referrals feature used";a.body="Username: "+CURRENT_DOMAIN_USER.email+"<br>Domain: "+CURRENT_DOMAIN_USER.domain+"<br>Type: "+b;sendEmail(a)}var CONTACT_CUSTOM_FIELDS=undefined;function setupTinyMCEEditor(b,d,c,f){if(b===undefined){console.log("selector is undefined...");return}$("#loading-editor").html(getRandomLoadingImg());var a="bullist numlist | outdent indent blockquote | forecolor backcolor | merge_fields | preview | code";if(d){a="bullist numlist | outdent indent blockquote | forecolor backcolor | preview | code"}var e=["textcolor link image preview code fullpage"];if(!c){c=e}if(typeof(tinymce)==="undefined"){head.js("/js/designer/tinymce/tinymce.min.js",function(){get_custom_fields(function(g){if(typeof(tinymce)==="undefined"){console.log("Reloading script...");if(confirm("Unable to load editor. Click OK to Reload.")){location.reload()}return}$(b).css("display","");$("#loading-editor").html("");tinymce.init({mode:"exact",selector:b,plugins:c,menubar:false,toolbar1:"bold italic underline | alignleft aligncenter alignright alignjustify | link image | formatselect | fontselect | fontsizeselect",toolbar2:a,valid_elements:"*[*]",toolbar_items_size:"small",browser_spellcheck:true,relative_urls:false,convert_urls:false,gecko_spellcheck:true,forced_root_block:false,extended_valid_elements:"*[*]",setup:function(h){h.addButton("merge_fields",{type:"menubutton",text:"Merge Fields",icon:false,menu:set_up_merge_fields(h)})},language:get_tinymce_supported_language(),});setTimeout(function(){if(f!=undefined&&typeof(f)==="function"){f()}},500)})});return}if(b.indexOf("#")!==-1){b=b.split("#")[1]}tinymce.settings.toolbar2=a;tinymce.settings.plugins=c;reinitialize_tinymce_editor_instance(b,f)}function set_tinymce_content(a,c){try{if(typeof(tinymce)!=="undefined"){tinymce.get(a).setContent(c)}}catch(b){console.log("error occured while setting content...");console.log(b)}}function save_content_to_textarea(a){try{if(typeof(tinymce)!=="undefined"){tinymce.get(a).save()}}catch(b){console.log("error occured while saving content to textarea...");console.log(b)}}function trigger_tinymce_save(){try{if(typeof(tinymce)!=="undefined"){tinymce.triggerSave()}}catch(a){console.log("error occured while triggering tiny save...");console.log(a)}}function reinitialize_tinymce_editor_instance(a,c){try{remove_tinymce_editor_instance(a);setTimeout(function(){$("#loading-editor").html("");$("#"+a).css("display","");tinymce.EditorManager.execCommand("mceAddEditor",true,a);if(c!=undefined&&typeof(c)==="function"){c()}$(".mce-tinymce").css("display","")},100)}catch(b){console.log("error occured while reinitializing tinymce...");console.log(b)}}function remove_tinymce_editor_instance(a){try{for(var b=0;b<tinymce.editors.length;b++){tinyMCE.remove(tinyMCE.editors[b])}}catch(c){console.log("error occured while removing tinymce editor instance...");console.log(c)}}function set_up_merge_fields(a){var c=[];var b;if(App_Contacts.contactDetailView!=undefined&&App_Contacts.contactDetailView.model!=undefined){b=get_contact_json_for_merge_fields()}$.each(get_merge_field_objs(),function(f,g){var e={};e.text=f;var d=[];$.each(g,function(j,k){var h={};h.text=j;h.onclick=function(){if(Current_Route==="bulk-email"||Current_Route==="send-email"||Current_Route.indexOf("email-template")!=-1||Current_Route.indexOf("emailbuilder")!=-1){a.insertContent(k)}else{var m=Handlebars.compile(k);var l;try{l=m(b)}catch(n){console.log("error.....");k="{{["+j+"]}}";m=Handlebars.compile(k);l=m(b)}a.insertContent(l+"")}};d.push(h)});e.menu=d;c.push(e)});console.log(c);return c}function get_merge_fields(d){var b={"First Name":"{{first_name}}","Last Name":"{{last_name}}",Score:"{{score}}",Email:"{{email}}",Company:"{{company}}",Title:"{{title}}",Address:"{{location.address}}",City:"{{location.city}}",State:"{{location.state}}",Country:"{{location.country}}","Owner Name":"{{owner.name}}","Owner Email":"{{owner.email}}","Owner Phone":"{{owner.phone}}","Calendar URL":"{{owner.calendar_url}}"};if(!d){var c=get_custom_merge_fields();var a=merge_jsons({},b,c);return a}else{get_custom_merge_fields(function(f){var e=merge_jsons({},b,f);return d(e)})}}function get_merge_field_objs(){var a={"First Name":"{{first_name}}","Last Name":"{{last_name}}",Score:"{{score}}",Email:"{{email}}",Company:"{{company}}",Title:"{{title}}",Address:"{{location.address}}",City:"{{location.city}}",State:"{{location.state}}",Country:"{{location.country}}","Owner Name":"{{owner.name}}","Owner Email":"{{owner.email}}","Owner Phone":"{{owner.phone}}","Calendar URL":"{{owner.calendar_url}}"};var c=get_custom_merge_fields();var b={Contact:a};if(c&&!$.isEmptyObject(c)){b.Custom=c}if(Current_Route.indexOf("emailbuilder-add")==-1&&Current_Route.indexOf("email-template-add")==-1&&Current_Route.indexOf("emailbuilder/")==-1&&Current_Route.indexOf("email-template/")==-1){return b}var d={"Ticket Id":"{{ticket_id}}",Subject:"{{subject}}","Requester Name":"{{requester_name}}","Requester Email":"{{requester_email}}",Priority:"{{priority}}",Status:"{{status}}","Ticket Comments":"{{{ticket_comments}}}",Footer:"{{{ticket_footer}}}",Group:"{{group_name}}",Assignee:"{{agent_name}}"};b.Ticket=d;return b}function get_custom_fields(a){if(CONTACT_CUSTOM_FIELDS!=undefined){if(a){return a(CONTACT_CUSTOM_FIELDS)}return CONTACT_CUSTOM_FIELDS}accessUrlUsingAjax("/core/api/custom-fields/scope?scope=CONTACT",function(b){CONTACT_CUSTOM_FIELDS=b;if(a){return a(CONTACT_CUSTOM_FIELDS)}return CONTACT_CUSTOM_FIELDS})}function get_custom_merge_fields(c){var a={};if(!c){var b=get_custom_fields();$.each(b,function(d,e){a[e.field_label]="{{"+e.field_label+"}}"});return a}else{get_custom_fields(function(d){$.each(d,function(e,f){a[f.field_label]="{{"+f.field_label+"}}"});return c(a)})}}function merge_jsons(c,b,a){return $.extend(c,b,a)}function get_contact_json_for_merge_fields(){if(App_Contacts.contactDetailView!=undefined&&App_Contacts.contactDetailView.model!=undefined){var e=App_Contacts.contactDetailView.model.toJSON();var c=get_property_JSON(e);try{c.score=e.lead_score;var a=get_custom_field_labels_by_type(get_custom_fields(),"DATE");for(var b in a){c[a[b]]=get_formatted_date(c[a[b]])}c.id=e.id;if(c.address){c.location=JSON.parse(c.address)}}catch(d){console.log("Error occured while parsing json");console.log(d)}return merge_jsons({},{owner:e.owner},c)}}function add_square_brackets_to_merge_fields(c){var b=c.match(/{{[a-zA-Z0-9 ]*[a-zA-Z0-9 ]}}/g);if(b){for(var a=0;a<b.length;a++){c=c.replace(b[a],"{{["+b[a].match(/{{(.*?)}}/)[1]+"]}}")}}return c}function get_custom_field_labels_by_type(c,b){var a=[];$.each(c,function(d,e){if(e.field_type==b){a.push(e.field_label)}});return a}function get_formatted_date(c,g){if(!c){return}var h=undefined;if((c/100000000000)>1){h=new Date(parseInt(c))}else{h=new Date(parseInt(c)*1000)}var b=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");var a=h.getDate();var f=h.getMonth();var e=h.getFullYear();return a+" "+b[f]+" "+e}function register_focus_on_tinymce(b){var a=$("iframe#"+b+"_ifr").contents()[0];if(!a){return}$(a).on("click",function(c){c.preventDefault();$(this).find("body").focus()})}function get_tinymce_supported_language(){var a="en_US";if(_LANGUAGE=="es"){a="es"}return a}$(function(){$("body").on("click",".enable-element-full-screen",function(a){a.preventDefault();document.addEventListener("fullscreenchange",Detection);
document.addEventListener("webkitfullscreenchange",Detection);document.addEventListener("mozfullscreenchange",Detection);document.addEventListener("MSFullscreenChange",Detection);screenfull.toggle()})});function Detection(){var a=document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement;if(a){$("#toggle-fullscreen-icon").attr("class","fa fa-compress ")}else{$("#toggle-fullscreen-icon").attr("class","fa fa-expand")}}$("body").on("click",".fullscreenelement",function(c){var b=$(this).attr("targetFullscreenElement");if(!b){b="#content"}$("#aside").toggleClass("hide");var a=$(b)[0];$(a).toggleClass("fullscreenwidjet");$("#toggle-screen-icon",$(b)[0]).attr("class","fa fa-"+($(a).hasClass("fullscreenwidjet")?"compress":"expand"))});
/*!
* screenfull
* v3.0.0 - 2015-11-24
* (c) Sindre Sorhus; MIT License
*/
(function(){var a=typeof module!=="undefined"&&module.exports;var b=typeof Element!=="undefined"&&"ALLOW_KEYBOARD_INPUT" in Element;var c=(function(){var k;var j;var e=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]];var h=0;var f=e.length;var g={};for(;h<f;h++){k=e[h];if(k&&k[1] in document){for(h=0,j=k.length;h<j;h++){g[e[0][h]]=k[h]}return g}}return false})();var d={request:function(f){var e=c.requestFullscreen;f=f||document.documentElement;if(/5\.1[\.\d]* Safari/.test(navigator.userAgent)){f[e]()}else{f[e](b&&Element.ALLOW_KEYBOARD_INPUT)}},exit:function(){document[c.exitFullscreen]()},toggle:function(e){if(this.isFullscreen){this.exit()}else{$("#content").css("height",100+"vh");this.request(e)}},raw:c};if(!c){if(a){module.exports=false}else{window.screenfull=false}return}Object.defineProperties(d,{isFullscreen:{get:function(){return Boolean(document[c.fullscreenElement])}},element:{enumerable:true,get:function(){return document[c.fullscreenElement]}},enabled:{enumerable:true,get:function(){return Boolean(document[c.fullscreenEnabled])}}});if(a){module.exports=d}else{window.screenfull=d}})();var REPORT;$(function(){$("body").on("mouseover",".highcharts-container",function(a){$(this).find(".highcharts-button").show()});$("body").on("mouseout",".highcharts-container",function(a){$(this).find(".highcharts-button").hide()})});function initializeReportsListeners(){$("#reports-listerners-container").on("click","#reports-email-now",function(b){b.stopPropagation();var c=$(this).attr("data");var a="core/api/reports/send/"+c;$("#report-send-confirmation").find("input").attr("data",a);$("#report-send-confirmation").modal("show");initializeReportSendConfirm()});$("#reports-listerners-container").on("click","#reports-campaign-email-now",function(b){b.stopPropagation();var c=$(this).attr("data");var a="core/api/campaignReports/send/"+c;$("#report-send-confirmation").find("input").attr("data",a);$("#report-send-confirmation").modal("show");initializeReportSendConfirm()});$("#reports-listerners-container").on("click","#campaign_id",function(a){a.preventDefault();a.stopPropagation();$.ajax({url:"/core/api/workflows?page_size=1",type:"GET",dataType:"json",accept:{json:"application/json",xml:"application/xml"},success:function(b){if(b[0]){window.document.location="#email-reports/"+b[0].id;$(window).scrollTop(0)}else{window.document.location="#workflows"}return},error:function(b){showAlertModal("retry",undefined,function(){window.document.location="#reports"})}})});$("#reports-listerners-container").on("click","#report-instant-results",function(a){a.stopPropagation()});$("#reports-listerners-container").on("change","#frequency, #duration",function(b){var a=$(this).attr("id")=="duration"?"contact":"activity";updateWeekDayReportVisibility($(this).val(),a)});$("#reports-listerners-container").on("click","#report-dashlat-navigate",function(a){a.preventDefault();Backbone.history.navigate("add-dashlet",{trigger:true})});$("#reports-listerners-container").on("click","#activity_advanced",function(b){b.preventDefault();var a=$("#activity_advanced span i");a.toggleClass("fa-minus").toggleClass("fa-plus")});$("#reports-listerners-container").on("click","#report_advanced",function(b){b.preventDefault();var a=$("#report_advanced span i");a.toggleClass("fa-minus").toggleClass("fa-plus")});$(".col-md-3").on("mouseenter",".show_screenshot",function(a){$(".show_screenshot").popover()});$(".tab-pane").on("click",".report-go",function(b){var a=$(this).parents(".tab-pane").attr("id");a=$('a[href="#'+a+'"]').parents(".maintab").find("a").attr("href").substring(1);_agile_set_prefs("reports_tab",a);return});$("#reports-listerners-container").off("click","#reports-tab-container>div>ul>li");$("#reports-listerners-container").on("click","#reports-tab-container>div>ul>li",function(b){var a=$(this).find(".sub-nav-tab").is(":visible");if($(".reports_tab_content").is(":visible")){$(".reports_tab_content").hide()}$(".sub-nav-tab").hide();if(a){$(this).find(".sub-nav-tab").hide()}else{$(this).find(".sub-nav-tab").show()}});$("#reports-listerners-container").off("mouseenter",".sub-nav-tab");$("#reports-listerners-container").on("mouseenter",".sub-nav-tab",function(b){$(".reports_tab_content").show();var a=$(this).offset().top;a=a-130;$(".reports_tab_content").css("top",a+"px")});$("#reports-listerners-container").off("mouseleave","#reports-tab-container");$("#reports-listerners-container").on("mouseleave","#reports-tab-container",function(a){$(".reports_tab_content").hide();$(".nav-tabs .active").removeClass("active")});$("#reports-listerners-container").off("mouseover",".reports_tab_content");$("#reports-listerners-container").on("mouseover",".reports_tab_content",function(a){$(".reports_tab_content").hide()});$("#reports-listerners-container").off("mouseover",".sub-nav-tab a");$("#reports-listerners-container").on("mouseover",".sub-nav-tab a",function(b){var a=$(this).attr("href").substring(1);$(".sub-nav-tab a").removeClass("active");$(".tab-pane").removeClass("active");$(this).addClass("active");$("#"+a).addClass("active")});$("#reports-listerners-container").off("click",".sub-nav-tab li");$("#reports-listerners-container").on("click",".sub-nav-tab li",function(f){f.preventDefault();f.stopPropagation();var a=$("a",$(this)).attr("href").substring(1);var c=$("._upgrade","#"+a).attr("id");var g=$("."+c,"#"+a);if(g.length!=0){$("#reportsUpgradeModal").html(getTemplate("upgradeModal"));var d=g.clone();$(".modal-body","#reportsUpgradeModal").html(d);$(d,".modal-body").show();$(".text-info",d).addClass("upgrade_close");$("#reportsUpgradeModal").modal("show")}var b=($("#"+a).find("a:not(.text-info)").attr("href")||$("#"+a).find("a#call-activity-link").attr("id"));if(b!=undefined){$("#"+a).find("a").trigger("click");if(b=="call-activity-link"||b=="#"){return}b=b.substring(1);Backbone.history.navigate(b,{trigger:true})}});$("#reportsUpgradeModal").on("click",".upgrade_close",function(a){$("#reportsUpgradeModal").modal("hide")})}function reportsContactTableView(b,a,c){getTemplate("contacts-custom-view-custom",{},undefined,function(j){var h=c.options.modelData;var e=h.fields_set;var d=b.toJSON();var g="";var f=c.options.individual_tag_name;var k=c.options.templateKey;$.each(e,function(l,m){if(m.indexOf("custom_")!=-1){m=m.split("custom_")[1];var n=getProperty(d.properties,m);if(!n){n={}}if(isDateCustomField(a,n)){g+=getTemplate("contacts-custom-view-custom-date",n)}else{g+=getTemplate("contacts-custom-view-custom",n)}return}if(m.indexOf("properties_")!=-1){m=m.split("properties_")[1]}g+=getTemplate("contacts-custom-view-"+m,d)});$(("#"+k+"-model-list"),c.el).append("<"+f+">"+g+"</"+f+">");$(("#"+k+"-model-list"),c.el).find("tr:last").data(b)},null)}function deserialize_multiselect(c,b,a){$("#reports-listerners-container").html(b);if(!c.fields_set){return}$.each(c.fields_set,function(d,e){if(a!==true){$("#multipleSelect",b).multiSelect("select",e)}});$(".ms-selection",b).children("ul").addClass("multiSelect").attr("name","fields_set").attr("id","fields_set").sortable()}function getEpochTimeFromReport(c,m,l){var a=new Array();var k=new Date();var f,g;if(c){a=c.toString().split(":");f=a[0];g=a[1]}if(l=="DAILY"){var e=new Date();var b=e.getDate();e.setDate(b+1);e.setHours(f);e.setMinutes(g);return(e.getTime())/1000}if(l=="WEEKLY"){var e=new Date();var j=e.getDay();var b=e.getDate();if(m>j){b+=(parseInt(m)-j)}else{b=(b-(j-parseInt(m)))+7}e.setDate(b);e.setHours(f);e.setMinutes(g);return(e.getTime())/1000}if(l=="MONTHLY"){var e=new Date();var b=e.getDate();var h=e.getMonth();if(m>b){h=h}else{h=h+1}e.setMonth(h);e.setDate(m);e.setHours(f);e.setMinutes(g);return(e.getTime())/1000}}function getNextMonthEppoch(c,j,h){var a=new Array();var e,f;if(c){a=c.toString().split(":");e=a[0];f=a[1]}var d=new Date();var b=d.getDate();var g=d.getMonth();if(j>b){g=g+1}else{g=g+2}d.setMonth(g);d.setDate(j);d.setHours(e);d.setMinutes(f);return(d.getTime())/1000}function updateWeekDayReportVisibility(e,d){var b="none",c="none",a="none";if(e=="DAILY"){a="block"}else{if(e=="WEEKLY"){c="block";a="block"}else{if(e=="MONTHLY"){a="block";b="block"}}}$("#"+d+"_report_weekday").css("display",c);$("#"+d+"_report_day").css("display",b);$("#"+d+"_report_time").css("display",a)}$(function(){$("body").on("click","a#call-activity-link",function(b){var c="Calls";var a="CALL";buildActivityFilters(c,a,"entityDropDown");App_Activity_log.navigate("activities",{trigger:true})})});function initializeActivityReportsListeners(){$("body").on("hidden.bs.modal","#activityReportModal",function(a){$("#users-list, #activity-type-list").multiSelect("deselect_all")
});$("#reports-listerners-container").on("click","#activity-reports-email-now",function(c){c.preventDefault();c.stopPropagation();var d=$(this).attr("data");var b=Math.floor(Date.now()/1000);var a="/core/api/activity-reports/email/"+d+"?end_time="+b;$("#report-send-confirmation").find("input").attr("data",a);$("#report-send-confirmation").modal("show");initializeReportSendConfirm()});$("#reports-listerners-container").on("click","#activity-type-list-select-all",function(a){a.preventDefault();$("#activity-type-list").multiSelect("select_all")});$("#reports-listerners-container").on("click","#activity-type-list-select-none",function(a){a.preventDefault();$("#activity-type-list").multiSelect("deselect_all")});$("#reports-listerners-container").on("click","#users-list-select-all",function(a){a.preventDefault();$("#users-list").multiSelect("select_all")});$("#reports-listerners-container").on("click","#users-list-select-none",function(a){a.preventDefault();$("#users-list").multiSelect("deselect_all")})}function initializeReportSendConfirm(){$("#report-send-confirm").click(function(b){b.preventDefault();$(".report-message").html(getRandomLoadingImg());var a=$("#report-send-confirmation").find("input").attr("data");if($(this).attr("disabled")){return}$(this).attr("disabled","disabled");$.get(a,function(c){console.log("sending email");$save_info=$('<div style="display:inline-block"><small><p class="text-success"><i>Report will be sent shortly</i></p></small></div>');$(".report-message").html($save_info);$save_info.show();setTimeout(function(){$("#report-send-confirmation").modal("hide");$(".report-message").empty();$("#report-send-confirm").removeAttr("disabled")},2000)}).fail(function(c){$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+c.responseText+"</i></p></small></div>");$(".report-message").html($save_info);$save_info.show();setTimeout(function(){$("#report-send-confirmation").modal("hide");$(".report-message").empty();$("#report-send-confirm").removeAttr("disabled")},2000)})})}var report_utility={load_activities:function(a){fillSelect("users-list","/core/api/users/partial","domainUser",function(){loadActivityReportLibs(function(){$("#activity-type-list, #users-list",a).multiSelect();$("#ms-activity-type-list .ms-selection",a).children("ul").addClass("multiSelect").attr("name","activity").attr("id","activity_type");$("#ms-users-list .ms-selection",a).children("ul").addClass("multiSelect").attr("name","user_ids").attr("id","user_ids");++count;if(count>0){$("#reports-listerners-container").html(a)}$(".activity_time_timepicker",a).timepicker({timeFormat:"H:i ",step:30});$(".activity_time_timepicker").focus(function(){$("#activityModal").css("overflow","hidden")});$(".activity_time_timepicker").blur(function(){$("#activityModal").css("overflow","auto")});$(".activity_time_timepicker",a).val("09:00");$("#report_timezone",a).val(ACCOUNT_PREFS.timezone)})},'<option value="{{id}}">{{name}}</option>',true,a)},edit_activities:function(b,a){var c=a.frequency;$("#activity-type-list, #users-list",b).multiSelect();$("#ms-activity-type-list .ms-selection",b).children("ul").addClass("multiSelect").attr("name","activity").attr("id","activity_type");$("#ms-users-list .ms-selection",b).children("ul").addClass("multiSelect").attr("name","user_ids").attr("id","user_ids");$("#reports-listerners-container").html(b);$.each(a.user_ids,function(e,d){$("#users-list").multiSelect("select",d);console.log("select user---",d)});$.each(a.activity,function(d,e){$("#activity-type-list").multiSelect("select",e);console.log("select activity-------",e)});$("#ms-activity-type-list .ms-selection").children("ul").addClass("multiSelect").attr("name","activity").attr("id","activity_type");$("#ms-users-list .ms-selection").children("ul").addClass("multiSelect").attr("name","user_ids").attr("id","user_ids");if(a.report_timezone==null){$("#report_timezone").val(ACCOUNT_PREFS.timezone)}updateWeekDayReportVisibility(c,"activity");$(".activity_time_timepicker").timepicker({timeFormat:"H:i ",step:30});$(".activity_time_timepicker").focus(function(){$("#activityModal").addClass("overflow-hidden")});$(".activity_time_timepicker").blur(function(){$("#activityModal").removeClass("overflow-hidden")})},load_contacts:function(a){fillSelect("custom-fields-optgroup","core/api/custom-fields/scope?scope=CONTACT",undefined,function(){loadActivityReportLibs(function(){$("#multipleSelect",a).multiSelect({selectableOptgroup:true});$(".ms-selection",a).children("ul").addClass("multiSelect").attr("name","fields_set").attr("id","fields_set").sortable();++count;if(count>1){$("#reports-listerners-container").html(a)}$(".report_time_timepicker",a).timepicker({timeFormat:"H:i ",step:30});$(".report_time_timepicker").focus(function(){$("#activityModal").css("overflow","hidden")});$(".report_time_timepicker").blur(function(){$("#activityModal").css("overflow","auto")});$(".report_time_timepicker",a).val("09:00");$("#report_timezone",a).val(ACCOUNT_PREFS.timezone)})},'<option value="custom_{{field_label}}">{{field_label}}</option>',true,a);head.js(LIB_PATH+"lib/jquery-ui.min.js",LIB_PATH+"lib/agile.jquery.chained.min.js?_="+_agile_get_file_hash("agile.jquery.chained.min.js"),function(){scramble_input_names($(a).find("div#report-settings"));chainFiltersForContact(a,undefined,function(){++count;if(count>1){$("#reports-listerners-container").html(a)}})})},edit_contacts:function(c,b,a){console.log(c);console.log(b.toJSON());$("#multipleSelect",c).multiSelect({selectableOptgroup:true});++count;if(count>1){deserialize_multiselect(b.toJSON(),c,a)}setTimeout(function(){$(".report_time_timepicker").timepicker({timeFormat:"H:i ",step:30});$(".report_time_timepicker").focus(function(){$("#activityModal").css("overflow","hidden")});$(".report_time_timepicker").blur(function(){$("#activityModal").css("overflow","auto")});var d=b.toJSON().duration;updateWeekDayReportVisibility(d,"contact");if(b.toJSON().report_timezone==null){$("#report_timezone").val(ACCOUNT_PREFS.timezone)}},1000)},call_reports:function(e,y,j){var t="calls-chart";if(y=="timebased"){showBar(e,t,null,"","");return}var m=[];var g=[];var b=[];var o=[];var p=[];var h=[];var d=[];var q=[];var v=[];var k=[];var f=[];var x=[];var u=[];var s=[];var c=[];var n=[];var l=[];var r=[];var w=parseInt($("#"+t).parent().attr("data-sizey"));var a=50*w;if(w==2||w==3){a+=50}$("#"+t).html("<div class='text-center v-middle opa-half' style='margin-top:"+a+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");portlet_graph_data_utility.fetchPortletsGraphData(e,function(O){if(O.status==403){$("#"+t).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");return}m=O.answeredCallsCountList;g=O.busyCallsCountList;b=O.failedCallsCountList;o=O.voiceMailCallsCountList;p=O.missedCallsCountList;h=O.inquiryCallsCountList;d=O.interestCallsCountList;q=O.noInterestCallsCountList;v=O.incorrectReferralCallsCountList;f=O.meetingScheduledCallsCountList;k=O.newOpportunityCallsCountList;x=O.queuedCallsCountList;u=O.callsDurationList;s=O.totalCallsCountList;c=O.domainUsersList;n=O.domainUserImgList;pieGraphRegions=["Answered Calls","Busy Calls","Failed Calls","Voice Mail Calls","Missed","Inquiry","Interest","No Interest","Incorrect Referral","Meeting Scheduled","New Opportunity","Other"];var J=[];var K="";var I;if(y=="pie-graph"){var D=0;var H=[];$.each(m,function(T,S){D+=S});H.push(D);var Q=0;$.each(g,function(S,T){Q+=T});H.push(Q);var L=0;$.each(b,function(S,T){L+=T});H.push(L);var B=0;$.each(o,function(S,T){B+=T});H.push(B);var P=0;$.each(p,function(S,T){p+=T});H.push(P);var E=0;$.each(h,function(S,T){E+=T});H.push(E);var N=0;$.each(d,function(T,S){N+=S});H.push(N);var R=0;$.each(q,function(S,T){R+=T});H.push(R);var A=0;$.each(v,function(S,T){A+=T});H.push(A);var M=0;$.each(f,function(S,T){M+=T});H.push(M);var C=0;$.each(k,function(T,S){C+=S});H.push(C);var F=0;$.each(x,function(S,T){F+=T});H.push(F);portlet_graph_utility.callsByPersonPieGraph(t,pieGraphRegions,H);return}if(j=="number-of-calls"){var z={};z.name="Answered";z.data=m;J[0]=z;z={};z.name="Busy";z.data=g;J[1]=z;z={};z.name="Failed";z.data=b;J[2]=z;z={};z.name="Voicemail";z.data=o;J[3]=z;z={};z.name="Missed ";z.data=p;J[4]=z;z={};z.name="Inquiry";z.data=h;J[5]=z;z={};z.name="Interest";z.data=d;J[6]=z;z={};z.name="No Interest";z.data=q;J[7]=z;z={};z.name="Incorrect Referral";z.data=v;J[8]=z;z={};z.name="Meeting Scheduled";z.data=f;J[9]=z;z={};z.name="New Opportunity";z.data=k;J[10]=z;z={};z.name="Other";z.data=x;J[11]=z;K="Total Calls";I=["green","blue","red","violet"]}else{if(j=="average-calls"){var z={};z.name="Average Call Duration";$.each(u,function(S,U){if(U>0){var T=U/m[S];r.push(T);l.push(T/60)}else{r.push(0);l.push(0)}});z.data=l;z.showInLegend=false;J[0]=z;K="Average Call Duration (Sec)";I=["green"]}else{var z={};z.name="Total Call Duration";var G=[];$.each(u,function(S,T){if(T>0){G[S]=T/60}else{G[S]=0}});z.data=G;z.showInLegend=false;J[0]=z;K="Calls Duration (Sec)";I=["green"]}}portlet_graph_utility.callsPerPersonBarGraph(t,c,J,s,u,K,I,n,undefined,r)});return},user_reports:function(d){var s="calls-chart-user";var l=[];var g=[];var b=[];var n=[];var o=[];var h=[];var e=[];var p=[];var u=[];var j=[];var f=[];var w=[];var t=[];var r=[];var c=[];var m=[];var k=[];var q=0;var v=parseInt($("#"+s).parent().attr("data-sizey"));var a=50*v;if(v==2||v==3){a+=50}$("#"+s).html("<div class='text-center v-middle opa-half' style='margin-top:"+a+"px'><img src='"+updateImageS3Path("../flatfull/img/ajax-loader-cursor.gif")+"' style='width:12px;height:10px;opacity:0.5;' /></div>");portlet_graph_data_utility.fetchPortletsGraphData(d,function(E){if(E.status==403){$("#"+s).html("<div class='portlet-error-message'><i class='icon-warning-sign icon-1x'></i>&nbsp;&nbsp;Sorry, you do not have the privileges to access this.</div>");
return}l=E.answeredCallsCountList;g=E.busyCallsCountList;b=E.failedCallsCountList;n=E.voiceMailCallsCountList;t=E.callsDurationList;r=E.totalCallsCountList;c=E.domainUsersList;m=E.domainUserImgList;o=E.missedCallsCountList;h=E.inquiryCallsCountList;e=E.interestCallsCountList;p=E.noInterestCallsCountList;u=E.incorrectReferralCallsCountList;f=E.meetingScheduledCallsCountList;j=E.newOpportunityCallsCountList;w=E.queuedCallsCountList;t=E.callsDurationList;r=E.totalCallsCountList;c=E.domainUsersList;m=E.domainUserImgList;pieGraphRegions=["Answered Calls","Busy Calls","Failed Calls","Voice Mail Calls","Missed","Inquiry","Interest","No Interest","Incorrect Referral","Meeting Scheduled","New Opportunity","Other"];var F=[];var N="";var z;var y=0;var B=[];$.each(l,function(P,O){y+=O});B.push(y);var C=0;$.each(g,function(O,P){C+=P});B.push(C);var J=0;$.each(b,function(O,P){J+=P});B.push(J);var L=0;$.each(n,function(O,P){L+=P});B.push(L);var D=0;$.each(o,function(O,P){o+=P});B.push(D);var A=0;$.each(h,function(O,P){A+=P});B.push(A);var H=0;$.each(e,function(P,O){H+=O});B.push(H);var x=0;$.each(p,function(O,P){x+=P});B.push(x);var I=0;$.each(u,function(O,P){I+=P});B.push(I);var M=0;$.each(f,function(O,P){M+=P});B.push(M);var K=0;$.each(j,function(P,O){K+=O});B.push(K);var G=0;$.each(w,function(O,P){G+=P});B.push(G);if(t[0]!=0){q=t[0]/l[0]}$(".avg-duration").html("Average Time Spent on Call:"+portlet_utility.getPortletsTimeConversion(Math.round(q)));portlet_graph_utility.callsByPersonPieGraph(s,pieGraphRegions,B)})},Goal_report:function(d){var e="count_goals_chart";var c="amount_goals_chart";var b=["#ffffff","#27C24C"];var a=["#ffffff","#fad733"];portlet_graph_data_utility.fetchPortletsGraphData(d,function(f){if(f.goalCount==0){$("#"+e).html('<div class="portlet-error-message" style=" font-size: 14px;font-style: normal;padding-top: 174px;padding-bottom : 203px">No Deals Goals set  </div>')}else{showGuage(e,f.dealcount,f.goalCount,"Won Deals","",true)}if(f.goalAmount==0){$("#"+c).html('<div class="portlet-error-message" style="font-size: 14px;font-style: normal;padding-top: 174px;padding-bottom : 203px">No Amount Goals set </div>')}else{showGuage(c,f.dealAmount,f.goalAmount,"Revenue","",true)}})},conversion_report:function(a){portlet_graph_data_utility.fetchPortletsGraphData(a,function(c){console.log(c);var b=[];$.each(c,function(e,d){$.each(d,function(f,g){$.each(g,function(j,h){var l=0;$.each(h,function(n,k){l=l+k});if(l>0){var m='<div id="'+j+'" class="conversion_track col-sm-4 panel wrapper"></div>';$(".converionsPipeline").append(m);showFunnelForConversion(j,j,true,h)}})})});if($(".converionsPipeline").children().length!=0){$(".converionsPipeline").parents(".row").find(".bg-primary").show()}})},getRepPerformanceLog:function(a){fetchReportData(a,function(b){if(b.length!=0){console.log("Inside RepPerform");getTemplate("report-user-data",b,undefined,function(f){if(!f){return}$("#rep-performance-reports").html($(f));showLossReasonGraphForUserReports();var e="/core/api/portlets/goals/";var c;if($("#owner").length>0){if($("#owner").val()!=""){c=$("#owner").val();e=e+c}}e=e+getSelectedDates()+"&time_zone="+(new Date().getTimezoneOffset());report_utility.Goal_report(e);var d="/core/api/opportunity/conversionRate/"+c+getSelectedDates();report_utility.conversion_report(d)},"#rep-performance-reports")}else{$("#rep-performance-reports").html('<div style="padding-left:50%;color:#98A6AD">No Data to display</div>')}})},loadReportsTemplate:function(a){if(!tight_acl.checkPermission("REPORT")){return}getTemplate("report-categories",{},undefined,function(d){if(!d){return}$("#content").html($(d));preloadImages(["flatfull/img/reports_images/Growth-graph.png","flatfull/img/reports_images/ratio.png","flatfull/img/reports_images/funnel-graph.png","flatfull/img/reports_images/Campaign-stats.png","flatfull/img/reports_images/Calls-By-User.png","flatfull/img/reports_images/averageofcall.png","flatfull/img/reports_images/user-activities-call.png","flatfull/img/reports_images/Incoming-Deals.png","flatfull/img/reports_images/Lost-Deal-Analysis.png","flatfull/img/reports_images/Revenue.png","flatfull/img/reports_images/Sales-forecast.png","flatfull/img/reports_images/User-reports.png","flatfull/img/reports_images/Call-Outcomes.png","flatfull/img/reports_images/contact.png","flatfull/img/reports_images/user-activities.png","flatfull/img/reports_images/Daily-reports.png","flatfull/img/reports_images/Call_Report_Time.png","flatfull/img/reports_images/Rep_Performance.png","flatfull/img/reports_images/Comparison_Report.png",]);initializeReportsListeners();hideTransitionBar();$(".active").removeClass("active");$("#reportsmenu").addClass("active");var b=$('a[href="'+window.location.hash+'"]').parents(".tab-pane").attr("id");if(b!=undefined){b=$('a[href="#'+b+'"]').parents(".maintab").find("a").attr("href").substring(1);_agile_set_prefs("reports_tab",b)}var c=_agile_get_prefs("reports_tab");$(".sub-nav-tab",$('#reports-tab-container a[href="#'+c+'"]').parent()).show();$('#reports-tab-container a[href="#'+c+'"]').parent().addClass("report-selected");$('[data-toggle="tooltip"]').tooltip();a()},"#content")}};function initReportLibs(a){head.load(LIB_PATH+"lib/date-charts-en.js",LIB_PATH+"lib/date-range-picker.js?_="+_agile_get_file_hash("date-range-picker.js"),function(){a()})}function loadActivityReportLibs(a){head.js(LIB_PATH+"lib/jquery.multi-select.js",CSS_PATH+"css/businesshours/jquerytimepicker.css",LIB_PATH+"lib/businesshours/jquerytimepicker.js",function(){a()})}function getSelectedDates(){var b="?";var a=$("#range").html().split("-");var d=new Date(a[0]).getTime()/1000;var e=$.trim(a[1]);if(e){e=e+" 23:59:59"}var c=new Date(e).getTime()/1000;b+=("start-date="+d+"&end-date="+c);return b}function initializeChartReportsListeners(){$("#reports-listerners-container").on("click",".report-chorts",function(h){h.preventDefault();var g=$(this).parents("form");if(!isValidForm($(g))){return false}var d=serializeForm($(g).attr("id"));var f=d.report_chart_type;var c="";if(d.tags&&isArray(d.tags)){$.each(d.tags,function(j,e){if(j==0){c+=e}else{c+=", "+e}})}console.log(c);if(f=="GROWTH"){Backbone.history.navigate("report-growth/"+c,{trigger:true});return}else{if(f=="FUNNEL"){Backbone.history.navigate("report-funnel/"+c,{trigger:true});return}else{if(f=="RATIO"){var b=d.tag1;var a=d.tag2;Backbone.history.navigate("report-ratio/"+b+"/"+a,{trigger:true});return}}}})}function sendEmailAttachmentListeners(a){if(!a){a="send-email-listener-container"}$("#"+a).on("click",".add-attachment-select",function(f){f.preventDefault();var d=$(this).closest("div");$(this).css("display","none");d.find(".attachment-document-select").css("display","inline");var b="<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}' url='{{url}}'>{{name}}</option>";fillSelect("attachment-select","core/api/documents","documents",function c(){d.find("#attachment-select option:first").after("<option value='new'>"+_agile_get_translated_val("others","upload-new-doc")+"</option>")},b,false,d)});$("#"+a).on("click",".add-attachment-confirm",function(g){g.preventDefault();var d=$("#attachment-select").find(":selected").attr("network_type");var j=$("#attachment-select").find(":selected").attr("size");if(typeof d!=="undefined"&&d.toUpperCase()==="GOOGLE"){$(this).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>"+_agile_get_translated_val("documents","gd-error")+"</span>")}else{if(j>=5242880){$(this).closest("span").find(".attachment-status").html("<span style='color:#df382c;margin-top:10px; display:block'>"+_agile_get_translated_val("documents","size-exceed-error")+"</span>")}else{$("#attachment-select").closest("span").find(".attachment-status").find("span").fadeOut(0);$("#attachment-select").css({border:"1px solid #bbb"});var f=$(this).closest(".attachment-document-select").find("#attachment-select").val();var h=$(this);if(f==""){h.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>"+_agile_get_translated_val("validation-msgs","required")+"</span>");h.closest("span").find("span.save-status").find("span").fadeOut(5000);return}else{if(f=="new"){g.preventDefault();$(this).closest("form").find("#error").html("");var l=$(this).closest("form").attr("id");var c=$(this).find("a").attr("id");var k=window.open("upload-attachment.jsp?id="+l+"&t="+CURRENT_USER_PREFS.template+"&d="+CURRENT_DOMAIN_USER.domain,"name","height=310,width=500");if(window.focus){k.focus()}}else{if(f!=undefined&&f!=null){var b=$("#attachment-select option:selected").text();$("#emailForm").find("#eattachment").css("display","block");$("#emailForm").find("#attachment_id").find("#attachment_fname").html("<a href="+$("#attachment-select option:selected").attr("url")+">"+b+"</a>");$("#emailForm").find(".attachment-document-select").css("display","none");$("#emailForm").find("#eattachment_key").attr("name","document_key");$("#emailForm").find("#eattachment_key").attr("value",f);$("#emailForm").find("#agile_attachment_name").attr("value",b);$("#emailForm").find("#agile_attachment_url").attr("value",$("#attachment-select option:selected").attr("url"))}}}}}});$("#"+a).on("click",".add-attachment-cancel",function(f){f.preventDefault();var b=$("#emailForm").find("#attachment_id").attr("name");if(typeof b!==typeof undefined){if(b.toLowerCase()==="blob_key"){var c=$("#emailForm").find("#eattachment_key").attr("value");deleteBlob(c)}}$("#attachment-select").closest("span").find(".attachment-status").find("span").fadeOut(0);$("#attachment-select").css({border:"1px solid #bbb"});$("#attachment-select").find("option:first").attr("selected","selected");var d=$(this).closest("div");$("#emailForm").find(".attachment-document-select").css("display","none");$("#emailForm").find("#eattachment").css("display","none");$("#emailForm").find(".add-attachment-select").css("display","inline");$("#emailForm").find("#eattachment_key").attr("name","name");$("#emailForm").find("#eattachment_key").attr("value","value");
$("#emailForm").find("#agile_attachment_name").attr("value","");$("#emailForm").find("#agile_attachment_url").attr("value","");$("#enable_tracking").css("margin-top","-7px")})}function deleteBlob(a){$.ajax({url:"/core/api/emails/send-email/delete-blob/"+a,type:"GET",success:function(){},error:function(b){}})}var contact_detail_tab_actions={add_task:function(b){$("#activityTaskModal").html(getTemplate("new-task-modal")).modal("show");var a=$("#taskForm");highlight_task();fill_relation(a);agile_type_ahead("task_related_to",a,contacts_typeahead);agile_type_ahead("task_relates_to_deals",a,deals_typeahead,false,null,null,"core/api/search/deals",false,true);categories.getCategoriesHtml(undefined,function(c){$("#type",a).html(c);populateUsers("owners-list",$("#taskForm"),undefined,undefined,function(d){$("#taskForm").find("#owners-list").html(d);$("#owners-list",a).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#taskForm")).closest("div").find(".loading-img").hide()})});activateSliderAndTimerToTaskModal()},add_event:function(b){$("#activityModal").html(getTemplate("new-event-modal")).modal("show");var a=$("#activityForm");highlight_event();fill_relation(a);agile_type_ahead("event_related_to",a,contacts_typeahead);agile_type_ahead("task_relates_to_deals",a,deals_typeahead,false,null,null,"core/api/search/deals",false,true)},add_note:function(b){console.log("execution");var c=$(b.currentTarget);var a=$("#noteForm");fill_relation(a);if(!$(c).attr("data-toggle")){$("#noteModal").modal("show")}agile_type_ahead("note_related_to",a,contacts_typeahead)},add_to_campaign:function(c){var d=$(c.currentTarget);var b=App_Contacts.contactDetailView.model.id;var a="<option value='{{id}}'{{#if is_disabled}}disabled=disabled>{{name}} ("+_agile_get_translated_val("campaigns","disabled")+"){{else}}>{{name}}{{/if}}</option>";if($(d).hasClass("contact-add-campaign")){$("body").off("fill_campaigns_contact").on("fill_campaigns_contact",function(e){fillSelect("campaign-select","/core/api/workflows","workflow","no-callback ",a)});Backbone.history.navigate("add-campaign",{trigger:true})}if($(this).hasClass("add-to-campaign")){$(this).css("display","none");$(".show_campaigns_list").css("display","block");Backbone.history.navigate("add-campaign",{trigger:true})}if($(d).hasClass("add-to-campaign")){$(d).css("display","none");$(".show_campaigns_list").css("display","inline-block");fillSelect("campaign-select","/core/api/workflows","workflow","no-callback ",a)}$("#subscribe-contact-campaign, #add-to-campaign").click(function(m){m.preventDefault();var p;if($(this).attr("id")==="subscribe-contact-campaign"){p=$("#contactCampaignForm")}if($(this).attr("id")==="add-to-campaign"){p=$("#add-to-campaign-form")}if(!isValidForm(p)){return}if($(this).attr("disabled")=="disabled"){return}var l=$(this);disable_save_button(l);var j=$(this).attr("id");var f=$("#campaign-select option:selected").prop("value");var k=$("#campaign-select option:selected").text();if(is_subscriber_active(f)){var n=App_Contacts.contactDetailView.model.get("properties");var h="Contact";if(n){h=getPropertyValue(n,"first_name")}var o=h+" "+_agile_get_translated_val("campaigns","contact-active-in-campaign")+" '"+k+"'.";showNotyPopUp("information",o,"top",10000);enable_save_button(l);return}var g="/core/api/campaigns/enroll/"+agile_crm_get_contact()["id"]+"/"+f;$.ajax({url:g,type:"GET",success:function(){enable_save_button(l);if(j==="add-to-campaign"){CONTACT_ASSIGNED_TO_CAMPAIGN=true;$(".show_campaigns_list").css("display","none");$(".add-to-campaign").css("display","inline-block");$('#contactDetailsTab a[href="#campaigns"]').trigger("click");return}Backbone.history.navigate("contact/"+agile_crm_get_contact()["id"],{trigger:true})}})});$("#contact-close-campaign, #cancel-to-add-campaign").click(function(h){h.preventDefault();if($(this).attr("id")==="cancel-to-add-campaign"){var f=$("#add-to-campaign-form");var g=$("form#add-to-campaign-form").validate();g.resetForm();f.find("div.controls").removeClass("single-error");$(".show_campaigns_list").css("display","none");$(".add-to-campaign").css("display","inline-block");return}Backbone.history.navigate("contact/"+b,{trigger:true})})},};function fill_relation(d){var a=null;if(company_util.isCompany()){a=App_Companies.companyDetailView.model.toJSON()}else{a=App_Contacts.contactDetailView.model.toJSON()}var c=getContactName(a);var b=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="{{id}}">{{name}}</li>');$(".tags",d).html(b({name:c,id:a.id}))}function is_subscriber_active(e){var b=App_Contacts.contactDetailView.model;if(!b){return false}var a=App_Contacts.contactDetailView.model.toJSON();var d=a.campaignStatus;if(!d){return false}for(var c=0;c<d.length;c++){if(d[c].status==e+"-ACTIVE"){return true}}return false}var existingDocumentsView;var comp_addr_prop;var contact_details_documentandtasks_actions={edit_task:function(b){var c=$(b.currentTarget);var d=$(c).attr("data");var a=tasksView.collection.get(d).toJSON();$("#updateTaskModal").html(getTemplate("task-update-modal")).modal("show");loadProgressSlider($("#updateTaskForm"),function(e){deserializeForm(a,$("#updateTaskForm"));$(".update-task-timepicker").val(fillTimePicker(a.due));categories.getCategoriesHtml(a,function(f){$("#type",$("#updateTaskForm")).html(f);populateUsers("owners-list",$("#updateTaskForm"),a,"taskOwner",function(g){$("#updateTaskForm").find("#owners-list").html(g);if(a.taskOwner){$("#owners-list",$("#updateTaskForm")).find("option[value="+a.taskOwner.id+"]").attr("selected","selected")}$("#owners-list",$("#updateTaskForm")).closest("div").find(".loading-img").hide()})});showNoteOnForm("updateTaskForm",a.notes)})},edit_event:function(f){var h=$(f.currentTarget);$("#updateActivityModal").html(getTemplate("update-activity-modal"));var j=$(h).attr("data");var c=eventsView.collection.get(j).toJSON();deserializeForm(c,$("#updateActivityForm"));$(".update-start-timepicker").val(fillTimePicker(c.start));$(".update-end-timepicker").val(fillTimePicker(c.end));$("#updateActivityModal").modal("show");if(c.type=="WEB_APPOINTMENT"&&parseInt(c.start)>parseInt(new Date().getTime()/1000)){$("[id='event_delete']").attr("id","delete_web_event");web_event_title=c.title;if(c.contacts.length>0){var d=getPropertyValue(c.contacts[0].properties,"first_name");if(d==undefined){d=""}var b=getPropertyValue(c.contacts[0].properties,"last_name");if(b==undefined){b=""}web_event_contact_name=d+" "+b}}else{$("[id='delete_web_event']").attr("id","event_delete")}if(c.description){var a='<label class="control-label"><b>'+_agile_get_translated_val("misc-keys","description")+' </b></label><div class="controls"><textarea id="description" name="description" rows="3" class="input form-control" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div>';$("#event_desc").html(a);$("textarea#description").val(c.description)}else{var g='<div class="row-fluid"><div class="control-group form-group m-b-none"><a href="#" id="add_event_desctiption"><i class="icon-plus"></i> '+_agile_get_translated_val("misc-keys","add-description")+' </a><div class="controls event_discription hide"><textarea id="description" name="description" rows="3" class="input form-control w-full col-md-8" placeholder="'+_agile_get_translated_val("misc-keys","add-description")+'"></textarea></div></div></div>';$("#event_desc").html(g)}populateUsersInUpdateActivityModal(c)},complete_task:function(b){var c=$(b.currentTarget);if($(c).is(":checked")){var d=$(c).attr("data");var a=c;complete_task(d,tasksView.collection,undefined,function(e){$(a).parent().siblings(".task-subject").css("text-decoration","line-through");console.log($(a).parents(".activity-text-block").css("background-color","#FFFAFA"));$(a).parent().replaceWith('<span style="margin-right:9px;"><i class="fa fa-check"></i></span>');tasksView.collection.add(e,{silent:true})})}},add_deal:function(g){var h=$(g.currentTarget);var d=$("#opportunityForm");if($("#color1",d).is(":hidden")){$(".colorPicker-picker",d).remove();$("#color1",d).colorPicker()}var f="#FFFFFF";$("#color1",d).attr("value",f);$(".colorPicker-picker",d).css("background-color",f);$(".colorPicker-palette").find("input").attr("disabled","disabled");$("#opportunityModal").modal("show");add_custom_fields_to_form({},function(j){var e=show_custom_fields_helper(j.custom_fields,["modal"]);$("#custom-field-deals",$("#opportunityModal")).html($(e));$(".contact_input",d).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_contact_"+$(this).attr("id"),d),contacts_typeahead,undefined,"type=PERSON")});$(".company_input",d).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_company_"+$(this).attr("id"),d),contacts_typeahead,undefined,"type=COMPANY")})},"DEAL");populateUsers("owners-list",d,undefined,undefined,function(e){$("#opportunityForm").find("#owners-list").html(e);$("#owners-list",$("#opportunityForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");$("#owners-list",$("#opportunityForm")).closest("div").find(".loading-img").hide()});agile_type_ahead("relates_to",d,contacts_typeahead);populateTrackMilestones(d,undefined,undefined,function(e){console.log(e);$.each(e,function(j,k){if(k.isDefault){var l=k.id+"_";if(k.milestones.length>0){l+=k.milestones.split(",")[0];$("#pipeline_milestone",d).val(l);$("#pipeline",d).val(k.id);$("#milestone",d).val(k.milestones.split(",")[0])}}})});populateLostReasons(d,undefined);populateDealSources(d,undefined);$("#close_date",d).datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});var a=null;if(company_util.isCompany()){a=App_Companies.companyDetailView.model.toJSON()}else{a=App_Contacts.contactDetailView.model.toJSON()}var c=getContactName(a);var b=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="{{id}}">{{name}}</li>');$("#contactTypeAhead .tags",d).html(b({name:c,id:a.id}))
},add_case:function(b){var c=$(b.currentTarget);$("#casesModal").html(getTemplate("cases-new-modal",{}));var a=$("#casesForm");populateUsers("owners-list",a,undefined,undefined,function(g){$("#casesForm").find("#owners-list").html(g);$("#owners-list",$("#casesForm")).find("option[value="+CURRENT_DOMAIN_USER.id+"]").attr("selected","selected");agile_type_ahead("contacts-typeahead-input",a,contacts_typeahead);var d=null;if(company_util.isCompany()){d=App_Companies.companyDetailView.model.toJSON()}else{d=App_Contacts.contactDetailView.model.toJSON()}var f=getContactName(d);var e=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="{{id}}">{{name}}</li>');$(".tags",a).html(e({name:f,id:d.id}));$("#casesModal").modal("show")})},add_contact:function(b){var a={};if(Current_Route.indexOf("company")>-1){a=App_Companies.companyDetailView.model.toJSON()}else{a=App_Contacts.contactDetailView.model.toJSON()}contact_company=a;forceCompany.name=getContactName(a);forceCompany.id=a.id;forceCompany.doit=true;comp_addr_prop=null;$.each(contact_company.properties,function(){if(this.name=="address"&&this.subtype=="office"){comp_addr_prop=JSON.parse(this.value)}});$.ajax({url:"core/api/custom-fields/scope?scope=CONTACT",type:"GET",dataType:"json",success:function(c){if(c.length>0){Backbone.history.navigate("contact-add",{trigger:true});setTimeout(function(){$("#continueform").find("ul[name=contact_company_id]").html('<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="'+forceCompany.id+'"><span><a class="text-white m-r-xs" href="#contact/'+forceCompany.id+'">'+forceCompany.name+'</a><a class="close text-white" id="remove_tag">×</a></span></li>');console.log(comp_addr_prop);if(comp_addr_prop){$("#content .address-type").val("office");if(comp_addr_prop.address){$("#content #address").val(comp_addr_prop.address)}if(comp_addr_prop.city){$("#content #city").val(comp_addr_prop.city)}if(comp_addr_prop.state){$("#content #state").val(comp_addr_prop.state)}if(comp_addr_prop.zip){$("#content #zip").val(comp_addr_prop.zip)}if(comp_addr_prop.country){$("#content #country").val(comp_addr_prop.country)}$("#content #remove_tag").addClass("companyAddress")}},800)}else{$("#personModal").modal("show")}}})},add_document:function(f){$("#uploadDocumentModal").html(getTemplate("upload-document-modal",{})).modal("show");var d=$("#uploadDocumentForm");agile_type_ahead("document_relates_to_contacts",d,contacts_typeahead);agile_type_ahead("document_relates_to_deals",d,deals_typeahead,false,null,null,"core/api/search/deals",false,true);var a=null;if(company_util.isCompany()){a=App_Companies.companyDetailView.model.toJSON()}else{a=App_Contacts.contactDetailView.model.toJSON()}var c=getContactName(a);var b=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="{{id}}">{{name}}</li>');$(".tags",d).html(b({name:c,id:a.id}))},document_unlink:function(d){var f=$(d.currentTarget);var g=$(f).attr("data");var b=documentsView.collection.get(g).toJSON();var c="";if(company_util.isCompany()){c=App_Companies.companyDetailView.model.id+""}else{c=App_Contacts.contactDetailView.model.id+""}b.contact_ids.splice(b.contact_ids.indexOf(c),1);var a=new Backbone.Model();a.url="core/api/documents";a.save(b,{success:function(e){documentsView.collection.remove(b);documentsView.render(true)},error:function(h,e){if(e&&e.status==403){showModalConfirmation(_agile_get_translated_val("documents","detach-document"),DOC_ACL_DETACH_ERROR,function(){return},function(){return},function(){return},_agile_get_translated_val("contact-details","cancel"))}}})},show_document_list:function(d){var f=$(d.currentTarget);var c=$(f).closest("div");$(f).css("display","none");if(agile_is_mobile_browser()){c.find(".contact-document-select").css("display","block")}else{c.find(".contact-document-select").css("display","inline")}var a="<option value='{{id}}'>{{name}}</option>";fillSelect("document-select","core/api/documents","documents",function b(){var e=_agile_get_translated_val("misc-keys","add-new-doc");c.find("#document-select > option:first").after("<option value='new'>"+e+"</option><option style='font-size: 1pt; background-color: #EDF1F2;'disabled>&nbsp;</option>");c.find("#document-select > option:first").remove()},a,false,c)},add_selected_document:function(h){var j=$(h.currentTarget);var a=$(j).closest(".contact-document-select").find("#document-select").val();var g=$(j);if(a==""){g.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>"+_agile_get_translated_val("validation-msgs","required")+"</span>");g.closest("span").find("span.save-status").find("span").fadeOut(5000);return}else{if(a=="new"){$("#uploadDocumentModal").html(getTemplate("upload-document-modal",{})).modal("show");var f=$("#uploadDocumentForm");agile_type_ahead("document_relates_to_contacts",f,contacts_typeahead);agile_type_ahead("document_relates_to_deals",f,deals_typeahead,false,null,null,"core/api/search/deals",false,true);var b=null;if(company_util.isCompany()){b=App_Companies.companyDetailView.model.toJSON()}else{b=App_Contacts.contactDetailView.model.toJSON()}var d=getContactName(b);var c=Handlebars.compile('<li class="tag btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="{{id}}">{{name}}</li>');$(".tags",f).html(c({name:d,id:b.id}))}else{if(a!=undefined&&a!=null){if(!existingDocumentsView){existingDocumentsView=new Base_Collection_View({url:"core/api/documents",restKey:"documents",});existingDocumentsView.collection.fetch({success:function(e){existing_document_attach(a,g)}})}else{existing_document_attach(a,g)}}}}},};function existing_document_attach(a,e){var b=existingDocumentsView.collection.get(a).toJSON();var d=null;if(company_util.isCompany()){d=App_Companies.companyDetailView.model.id+""}else{d=App_Contacts.contactDetailView.model.id+""}if((b.contact_ids).indexOf(d)<0){b.contact_ids.push(d);saveDocument(null,null,e,false,b,d)}else{var c=_agile_get_translated_val("misc-keys","link-already");e.closest("span").find(".save-status").html("<span style='color:red;margin-left:10px;'>"+c+"</span>");e.closest("span").find("span.save-status").find("span").fadeOut(5000);hideTransitionBar();return}}$(function(){$("#logCallModal").on("hidden.bs.modal",function(d){var b=$("#callWidgetName",$("#phoneLogForm")).val();if(CallLogVariables.callActivitySaved||b==""){resetCallLogVariables();return}var a={};var c=CallLogVariables.callType;if(c=="outbound-dial"||c=="Outgoing"||c=="outgoing"){a.url=CallLogVariables.url+"savecallactivityById"}else{a.url=CallLogVariables.url+"savecallactivity"}a.id=CallLogVariables.id;a.callType=CallLogVariables.callType;a.number=CallLogVariables.phone;a.status=CallLogVariables.status;a.duration=CallLogVariables.duration;a.widget=CallLogVariables.callWidget;saveLogPhoneActivity(a);resetCallLogVariables()});$("#logCallModal").on("click","#logPhone_number_option",function(c){var b=$(this).parents("form").attr("id");if($("#"+b+" #logPhone_number_error").is(":visible")){$("#"+b+" #logPhone_number_error").hide()}var a=$(this).attr("value");var d=$(this).html();$("#"+b+" #contact_logPhone_number").html(d);$("#"+b+" #contact_logPhone_number").attr("value",a)});$("#logCallModal").on("click","#statusValue",function(c){var b=$(this).parents("form").attr("id");var a=$(this).attr("value");var d=$(this).html();$("#"+b+" #callStatus").html(d);$("#"+b+" #callStatus").attr("value",a);if(a=="busy"||a=="failed"||a=="missed"){$("#hour").attr("disabled","disabled");$("#min").attr("disabled","disabled");$("#sec").attr("disabled","disabled")}else{$("#hour").removeAttr("disabled");$("#min").removeAttr("disabled");$("#sec").removeAttr("disabled")}});$("#logCallModal").on("click","#validate-logPhone",function(k){k.preventDefault();if($(this).attr("disabled")){return}var c;var g;if($(this).attr("action")=="update"){c="phoneLogForm_update";g="phoneLogModal_update"}else{c="phoneLogForm";g="logCallModal"}var b=serializeForm(c);if(!isValidForm("#"+c)){return}if(!b.subject){$("#"+c+" #logPhone_subject_error").show().delay(5000).hide(1);return}if($("#"+c+" #contact_logPhone_number").attr("value")==""){$("#"+c+" #logPhone_number_error").show().delay(5000).hide(1);return}if($("#"+c+" #callStatus").attr("value")==""){$("#"+c+" #logPhone_status_error").show().delay(5000).hide(1);return}if($("#"+c+" #logPhone_relatedto_tag").children().length==0){$("#"+c+" #log_relatedto_error").show().delay(5000).hide(1);return}b.status=$("#"+c+" #callStatus").attr("value");var f=b.hour;var a=b.min;var d=b.sec;var j=0;if(b.status=="busy"||b.status=="failed"||b.status=="missed"){j=0}else{if(!f||!a||!d){$("#"+c+" #logPhone_duration_error1").show().delay(5000).hide(1);return}if(isNaN(f)||isNaN(a)||isNaN(d)){$("#"+c+" #logPhone_duration_error1").show().delay(5000).hide(1);return}else{if(f<0){$("#"+c+" #logPhone_duration_error1").show().delay(5000).hide(1);return}else{if(a>59||a<0||d>59||d<0){$("#"+c+" #logPhone_duration_error").show().delay(5000).hide(1);return}}f=parseInt(f);a=parseInt(a);d=parseInt(d);j=(f*3600)+(a*60)+(d*1);if(b.status=="answered"||b.status=="inquiry"||b.status=="interest"||b.status=="new opportunity"||b.status=="meeting scheduled"){if(j<=0){$("#"+c+" #logPhone_duration_error2").show().delay(5000).hide(1);return}}}}disable_save_button($(this));b.phone=$("#"+c+" #contact_logPhone_number").attr("value");b.duration=j;console.log(b);saveLogPhone($("#"+c),$("#"+g),this,b)});$("body").on("click",".edit-logPhone",function(f){f.preventDefault();console.log($(this).attr("data"));var b=notesView.collection.get($(this).attr("data"));try{var d={};b=b.toJSON();var a=b.contacts[0];var c=getContactName(a);phone=getPhoneWithSkypeInArray(a.properties);d.num=phone;d.action="edit";$("#logCallModal").html(getTemplate("phoneLogModal",d));deserializeForm(b,$("#phoneLogForm","#logCallModal"));$("#phoneLogForm #contact_logPhone_number").html(b.phone);$("#phoneLogForm #contact_logPhone_number").attr("value",b.phone);$("#phoneLogForm #contact_logPhone_number").removeClass("add_logPhone");
$("#phoneLogForm #contact_logPhone_number").css({cursor:"auto",color:"#777"});$("#phoneLogForm #callStatus").attr("value",b.status);$("#phoneLogForm #callStatus").html(toTitleCase(b.status));if(b.status=="busy"||b.status=="failed"||b.status=="missed"){$("#phoneLogForm #hour").attr("disabled","disabled");$("#phoneLogForm #min").attr("disabled","disabled");$("#phoneLogForm #sec").attr("disabled","disabled")}$("#logCallModal").modal("show");agile_type_ahead("call_related_to",$("#phoneLogForm","#logCallModal"),contacts_typeahead)}catch(f){$("#logCallModal").modal("hide");console.log("an error has occured")}});$("body").on("click",".show-logPhone",function(d){d.preventDefault();try{var c={};var a=null;if(company_util.isCompany()){a=App_Companies.companyDetailView.model.toJSON()}else{a=App_Contacts.contactDetailView.model.toJSON()}name=getContactName(a);phone=getPhoneWithSkypeInArray(a.properties);c.num=phone;c.action="add";$("#logCallModal").html(getTemplate("phoneLogModal",c));$("#phoneLogForm #logPhone_relatedto_tag").html('<li class="btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="'+a.id+'">'+name+"</li>");$("#phoneLogForm #saveActivity").val("true");$("#logCallModal").modal("show");var b=$("#phoneLogForm");agile_type_ahead("call_related_to",b,contacts_typeahead)}catch(d){$("#logCallModal").modal("hide");console.log("an error has occured")}});$("#logCallModal").on("click",".add_logPhone",function(a){a.preventDefault();$(".add_logPhone_span","#phoneLogForm").hide();$("#contact-add-phone-span","#phoneLogForm").show()});$("#logCallModal").on("click",".contact_phone_add",function(f){f.preventDefault();var a;var d=false;var b=$("#phoneLogForm #contact_phone").val().trim();if(!b){$("#phoneLogForm #logPhone_number_error").show().delay(5000).hide(1);return}var g=property_JSON("phone","phoneLogForm #contact_phone");g.subtype="";if(company_util.isCompany()){a=App_Companies.companyDetailView.model.toJSON()}else{a=App_Contacts.contactDetailView.model.toJSON();d=true}a.properties.push(g);var c=new BaseModel();c.url="core/api/contacts";c.save(a,{success:function(e){console.log("contact "+e);$("#contact-add-phone-span").hide();$("#contact_logPhone_number").attr("value",g.value);$(".add_logPhone_span","#phoneLogForm").show();$("#contact_logPhone_number").html(g.value);if(d){App_Contacts.contactDetailView.model=e}else{App_Companies.companyDetailView.model=e}$("#phoneLogForm #contact_logPhone_number").removeClass("add_logPhone");$("#phoneLogForm #contact_logPhone_number").css({cursor:"auto",color:"#777"})}})})});function saveLogPhone(e,d,b,a){console.log(a);$(".logPhone-save-status").html("");var c=new Backbone.Model();c.url="core/api/notes";c.save(a,{success:function(j){enable_save_button($(b));e.each(function(){this.reset()});var h=j.toJSON();try{var g;if(CallLogVariables.id){g=CallLogVariables.id}else{g=agile_crm_get_contact()}if($("#saveActivity",e).val()=="true"){try{var f={};f.url="/core/api/notes/save_logPhoneActivity";f.id=g.id;f.callType=h.callType;f.number=h.phone;f.status=h.status;f.duration=h.duration;f.widget=$("#callWidgetName",e).val();CallLogVariables.callActivitySaved=true;saveLogPhoneActivity(f)}catch(k){console.log("activities not saved AS CONTACT NOT FOUND")}}else{try{var g;if(CallLogVariables.id){g=CallLogVariables.id}else{g=agile_crm_get_contact()}var f={};f.url="/core/api/notes/update_logPhoneActivity?note_id="+h.id+"&subject="+h.subject;f.id=g.id;f.callType=h.callType;f.number=h.phone;f.status=h.status;f.duration=h.duration;f.widget=$("#callWidgetName",e).val();CallLogVariables.callActivitySaved=true;saveLogPhoneActivity(f)}catch(k){console.log("activities not saved AS CONTACT NOT FOUND")}}if(h.status=="answered"||h.status=="inquiry"||h.status=="interest"||h.status=="no interest"||h.status=="incorrect referral"||h.status=="voicemail"||h.status=="new opportunity"||h.status=="meeting scheduled"){if(!$("#callWidgetName",e).val()){twilioIOSaveContactedTime(g.id)}}}catch(k){}d.modal("hide");if(notesView&&notesView.collection){console.log(notesView.collection.toJSON());if(notesView.collection.get(h.id)){notesView.collection.get(h.id).set(new BaseModel(h))}else{notesView.collection.add(new BaseModel(h),{sort:false});notesView.collection.sort()}}if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){if(h.contacts[0].id==App_Contacts.contactDetailView.model.get("id")){add_entity_to_timeline(j);return false}}},error:function(g,f){if(f&&f.status==403){enable_save_button($(b));$("span.save-status",d).html('<div class="inline-block"><p class="text-base" style="color:#B94A48;"><i>'+Handlebars.compile("{{name}}")({name:f.responseText})+"</i></p></div>");setTimeout(function(){$("span.save-status",d).html("")},2000);return}$(".logPhone-save-status").html("Could not save. Please try again");console.log("error");enable_save_button($(b))}})}function toTitleCase(a){return a.replace(/(?:^|\s)\w/g,function(b){return b.toUpperCase()})}function saveLogPhoneActivity(a){var b=a.callType;if(b=="outbound-dial"||b=="Outgoing"||b=="outgoing"){$.post(a.url,{id:a.id,direction:b,phone:a.number,status:a.status,callWidget:a.widget,duration:a.duration})}else{$.post(a.url,{direction:b,phone:a.number,status:a.status,callWidget:a.widget,duration:a.duration})}}function showDynamicCallLogs(b){try{console.log("parameter send"+b);var a={};a.num=[b.number];a.action="add";$("#logCallModal").html(getTemplate("phoneLogModal",a));$("#phoneLogForm #callStatus").attr("value",b.status);$("#phoneLogForm #callStatus").html(toTitleCase(b.status));$("input[name=callType][value="+b.callType+"]").attr("checked","checked");$("#logCallModal").modal("show");$("#phoneLogForm #subject").val(b.subject);var d=getTimeInArray(b.duration);$("#phoneLogForm #sec").val(d.pop());$("#phoneLogForm #min").val(d.pop());$("#phoneLogForm #hour").val(d.pop());$("#phoneLogForm #callWidgetName").val(b.widget);$("#phoneLogForm #saveActivity").val("true");$("#phoneLogForm #logPhone_relatedto_tag").html('<li class="btn btn-xs btn-primary m-r-xs m-b-xs inline-block" data="'+b.contId+'">'+b.contact_name+"</li>");CallLogVariables.description=$("#agilecrm-container #call-noty-notes").val();if(CallLogVariables.description){$("#phoneLogForm #description").val(CallLogVariables.description.trim())}$("#phoneLogForm").find("#description").focus();agile_type_ahead("call_related_to",$("#phoneLogForm","#logCallModal"),contacts_typeahead);CallLogVariables.callActivitySaved=false;CallLogVariables.id=b.contId;CallLogVariables.callType=b.callType;CallLogVariables.status=b.status;CallLogVariables.callWidget=b.widget;CallLogVariables.duration=b.duration;CallLogVariables.phone=b.number;CallLogVariables.url=b.url}catch(c){$("#logCallModal").modal("hide");console.log("an error has occured")}}var Agile_Old_Hash;$(function(){$(window).on("hashchange",function(d){var c=d.originalEvent.oldURL;if(!c){return}Agile_Old_Hash=c.split("#")[1]});$("body").on("click",".edit-note",function(f){f.preventDefault();console.log($(this).attr("data"));var d=notesView.collection.get($(this).attr("data"));console.log(d);$("#noteUpdateModal").remove();var c=$("#noteModal").clone();$("#noteForm > fieldset",c).prepend('<input name="id" type="hidden"/>');$("#noteForm > fieldset",c).prepend('<input name="created_time" type="hidden"/>');$("#noteForm",c).parent().parent().find(".modal-header > h3").html('<i class="icon-edit"></i>&nbsp;'+_agile_get_translated_val("modals","edit-note"));$("#noteForm",c).attr("id","noteUpdateForm");c.attr("id","noteUpdateModal");agile_type_ahead("note_related_to",$("#noteUpdateForm",c),contacts_typeahead);$("#note_validate",c).attr("id","note_update");deserializeForm(d.toJSON(),$("#noteUpdateForm",c));c.modal("show")});$("body").on("click","#note_update",function(d){d.preventDefault();if($(this).attr("disabled")){return}disable_save_button($(this));if(!isValidForm("#noteUpdateForm")){enable_save_button($(this));return}if($("#noteUpdateForm #note_relatedto_tag").children().length==0){$("#noteUpdateForm #note_relatedto_error").show().delay(5000).hide(1);enable_save_button($(this));return}var c=serializeForm("noteUpdateForm");b($("#noteUpdateForm"),$("#noteUpdateModal"),this,c)});$("body").on("click","#note_validate",function(d){d.preventDefault();if($(this).attr("disabled")){return}if(!isValidForm("#noteForm")){return}if($("#noteForm #note_relatedto_tag").children().length==0){$("#noteForm #note_relatedto_error").show().delay(5000).hide(1);return}disable_save_button($(this));var c=serializeForm("noteForm");console.log(c.from_task);if(c.from_task=="true"){saveNoteOfTask($("#noteForm"),$("#noteModal"),this,c)}else{b($("#noteForm"),$("#noteModal"),this,c)}});$("body").on("click","#show-note",function(d){d.preventDefault();$("#noteModal").modal("show");var c=$("#noteForm");agile_type_ahead("note_related_to",c,contacts_typeahead)});$("#noteModal").on("hidden.bs.modal",function(){$("#noteForm").find("li").remove();$("#noteForm",$("#noteModal")).each(function(){this.reset()});remove_validation_errors("noteModal")});function b(f,e,c,d){console.log(d);var g=new Backbone.Model();g.url="core/api/notes";g.save(d,{success:function(k){enable_save_button($(c));f.each(function(){this.reset()});e.modal("hide");var j=k.toJSON();console.log(j);if(notesView&&notesView.collection){console.log(notesView.collection.toJSON());if(notesView.collection.get(j.id)){notesView.collection.get(j.id).set(new BaseModel(j))}else{notesView.collection.add(new BaseModel(j),{sort:false});notesView.collection.sort()}}if(App_Contacts.contactDetailView&&Current_Route=="contact/"+App_Contacts.contactDetailView.model.get("id")){var h=false;if(notesView&&notesView.collection&&j.contacts&&j.contacts.length==0){notesView.collection.remove(j.id);notesView.collection.sort()}$.each(j.contacts,function(m,l){if(l.id==App_Contacts.contactDetailView.model.get("id")){add_entity_to_timeline(k);h=true;return false}});if(!h){notesView.collection.remove(j.id);notesView.collection.sort()}}},error:function(j,h){if(h&&h.status==403){enable_save_button($(c));
$("span.save-status",e).html("<i style='color:#B94A48;'>"+Handlebars.compile("{{name}}")({name:h.responseText})+"</i>");setTimeout(function(){$("span.save-status",e).html("")},4000)}}})}function a(d){disable_save_button($(d));var c=serializeForm("noteForm");console.log(c.from_task);if(c.from_task=="true"){saveNoteOfTask($("#noteForm"),$("#noteModal"),d,c)}else{b($("#noteForm"),$("#noteModal"),d,c)}}});var contact_tab_position_cookie_name="contact_tab_position_"+CURRENT_DOMAIN_USER.id;var company_tab_position_cookie_name="company_tab_position_"+CURRENT_DOMAIN_USER.id;var CONTACT_ASSIGNED_TO_CAMPAIGN=false;var NO_WEB_STATS_SETUP=true;var email_server_type="agilecrm";var email_server_type_cookie_name="email_server_type_"+CURRENT_DOMAIN_USER.id;function fill_company_related_contacts(b,a,c){$("#"+a).html(LOADING_HTML);var d=new Base_Collection_View({url:"core/api/contacts/related/"+b,templateKey:"company-contacts",individual_tag_name:"tr",cursor:true,page_size:25,sort_collection:false,scroll_target:(c?$("#infinite-scroller-company-details",c):"#infinite-scroller-company-details"),postRenderCallback:function(e){contactListener()}});d.collection.fetch();if(c){$("#"+a,$(c)).html(d.render().el)}else{$("#"+a,App_Companies.companyDetailView.el).html(d.render().el)}}var Contact_Details_Tab_Actions={openTimeLine:function(a){save_contact_tab_position_in_cookie("timeline");contact_details_tab.load_timeline()},onEmailSubjectClick:function(b){var c=$(b.currentTarget);var a=$(c).attr("href");var d=$(c).attr("id");$(".collapse-"+d).hide();$(a).collapse("toggle");$(a).on("hidden.bs.collapse",function(){$(".collapse-"+d).show()})},showPageViews:function(a){$(a.currentTarget).closest(".activity-text-block").find("#complete-webstats").toggle()},removeActiveCampaigns:function(a){var b=$(a.currentTarget);showAlertModal(_agile_get_translated_val("campaigns","sure-remove-active")+" "+$(b).attr("contact_name")+_agile_get_translated_val("calendar","from")+$(b).attr("campaign_name")+-_agile_get_translated_val("contact-details","campaign")+" ?","confirm",function(){var f=$(b).closest("span#active-campaign");var c=f.attr("data");var e;if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model){e=App_Contacts.contactDetailView.model.get("id")}var d="core/api/workflows/remove-active-subscriber/"+c+"/"+e;$.ajax({url:d,type:"DELETE",success:function(l){var j=App_Contacts.contactDetailView.model.toJSON();var k=j.campaignStatus;if(k!==undefined){for(var h=0,g=k.length;h<g;h++){if(c===k[h].campaign_id){k.splice(h,1);break}}}f.remove()}})},undefined,_agile_get_translated_val("campaigns","remove-active-campaign"))},showNotes:function(a){save_contact_tab_position_in_cookie("notes");contact_details_tab.load_notes()},showEvents:function(a){save_contact_tab_position_in_cookie("events");contact_details_tab.load_events()},replyToEmail:function(d){var h=$(d.currentTarget);var g=$(h).data("from");var f=$(h).closest("#email-reply-div");var c=f.find(".to-emails").data("to");var k=f.find(".cc-emails").data("cc");var b=f.find(".bcc-emails").data("bcc");var j=contact_details_tab.configured_sync_email;var a;if(j){a=j}if(a&&c){c=get_emails_to_reply(g+", "+c,a)}if(a&&k){k=get_emails_to_reply(k,a)}if(a&&b){b=get_emails_to_reply(b,a)}App_Contacts.navigate("send-email");reply_email=c;reply_email=reply_email.replace(/(, $)/g,"");if(k){k=k.replace(/(, $)/g,"")}if(b){b=b.replace(/(, $)/g,"")}App_Contacts.sendEmail(reply_email,"Re: "+f.find(".email-subject").text(),'<p></p><blockquote style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex;">'+f.find(".email-body").html()+"</blockquote>",k,b)},deleteActivity:function(d){var f=$(d.currentTarget);var c=$(f).parents("li").data();var b=c.get("owner_id");if(!b&&c.get("owner")){b=c.get("owner").id}if(!b&&Current_Route.indexOf("deal/")==0&&App_Deal_Details.dealDetailView&&App_Deal_Details.dealDetailView.model){b=App_Deal_Details.dealDetailView.model.get("owner").id}if(!hasScope("DELETE_DEALS")&&c.get("entity_type")&&c.get("entity_type")=="deal"){$("#deal_delete_privileges_error_modal").html(getTemplate("deal-delete-privileges-error-modal")).modal("show");return}if(c.get("entity_type")&&c.get("entity_type")=="note"&&Current_Route.indexOf("deal/")==0&&c.get("domainOwner")&&!hasScope("UPDATE_DEALS")&&(CURRENT_DOMAIN_USER.id!=b)){$("#deal_update_privileges_error_modal").html(getTemplate("deal-update-privileges-error-modal")).modal("show");return}if(!hasScope("MANAGE_CALENDAR")&&(CURRENT_DOMAIN_USER.id!=b)&&c.get("entity_type")&&c.get("entity_type")=="event"){$("#deleteEventErrorModal").html(getTemplate("delete-event-error-modal")).modal("show");return}var a=$(f).attr("id");if(c&&c.toJSON().type!="WEB_APPOINTMENT"||parseInt(c.toJSON().start)<parseInt(new Date().getTime()/1000)){showAlertModal("delete","confirm",function(){modelDelete(c,f,function(){removeItemFromTimeline($("#"+a,$("#timeline")))})});return}modelDelete(c,f)},};function get_property_JSON(c){var b=c.properties;var a={};$.each(b,function(d,e){a[this.name]=this.value});console.log(a);return a}function populate_send_email_details(b){if(CURRENT_DOMAIN_USER&&CURRENT_DOMAIN_USER.name){$("#emailForm",b).find('input[name="from_name"]').val(CURRENT_DOMAIN_USER.name.replace(/&#x73;+/g,"s"))}if(CURRENT_DOMAIN_USER&&CURRENT_DOMAIN_USER.email){$("#emailForm",b).find('input[name="from"]').val(CURRENT_DOMAIN_USER.email.replace(/&#x73;+/g,"s"))}var a="<option value='{{id}}'> {{#if name}}{{name}}{{else}}{{subject}}{{/if}}</option>";fillSelect("sendEmailSelect","/core/api/email/templates","emailTemplates",undefined,a,false,b,_agile_get_translated_val("other","fill-from-template"))}function activate_timeline_tab(){$("#contactDetailsTab").find("li.active").removeClass("active");$("#contactDetailsTab li:first-child").addClass("active");$("div.tab-content").find("div.active").removeClass("active");$("div.tab-content > div:first-child").addClass("active");if(App_Contacts.contactDetailView.model.get("type")=="COMPANY"){fill_company_related_contacts(App_Contacts.contactDetailView.model.id,"company-contacts")}}function activate_company_contact_tab(){$("#contactDetailsTab").find("li.active").removeClass("active");$("#contactDetailsTab li:first-child").addClass("active");$("div.tab-content").find("div.active").removeClass("active");$("div.tab-content > div:first-child",App_Companies.companyDetailView.el).addClass("active");if(App_Companies.companyDetailView.model.get("type")=="COMPANY"){fill_company_related_contacts(App_Companies.companyDetailView.model.id,"company-contacts")}}function disable_send_button(a){a.css("min-width",a.width()+"px").attr("disabled","disabled").attr("data-send-text",a.text()).text("Sending...")}function enable_send_button(a){a.text(a.attr("data-send-text")).removeAttr("disabled data-send-text")}function get_web_stats_count_for_domain(a){accessUrlUsingAjax("core/api/web-stats/JSAPI-status",function(b){if(a){a(b)}})}function save_contact_tab_position_in_cookie(b){var a=_agile_get_prefs(contact_tab_position_cookie_name);if(a==b){return}_agile_set_prefs(contact_tab_position_cookie_name,b)}function save_company_tab_position_in_cookie(b){var a=_agile_get_prefs(company_tab_position_cookie_name);if(a==b){return}_agile_set_prefs(company_tab_position_cookie_name,b)}function load_contact_tab(b,c){timeline_collection_view=null;var a=_agile_get_prefs(contact_tab_position_cookie_name);if(a==null||a==undefined||a==""){a="timeline"}if(a=="timeline"&&agile_is_mobile_browser()){return}$('#contactDetailsTab a[href="#'+a+'"]',b).tab("show");if(!a||a=="timeline"){activate_timeline_tab();contact_details_tab.load_timeline();return}if(contact_details_tab["load_"+a]){$(".tab-content",b).find("#"+a).addClass("active");contact_details_tab["load_"+a]()}}function load_company_tab(b,c){var a=_agile_get_prefs(company_tab_position_cookie_name);if(a==null||a==undefined||a==""){a="contacts"}if(a=="contacts"&&agile_is_mobile_browser()){return}$('#contactDetailsTab a[href="#company-'+a+'"]',b).tab("show");if(!a||a=="contacts"){activate_company_contact_tab();company_detail_tab.load_fill_company_related_contacts;return}if(company_detail_tab["load_company_"+a]){$(".tab-content",b).find("#company-"+a).addClass("active");company_detail_tab["load_company_"+a]()}}function get_emails_to_reply(f,b){var e=f.split(",");f="";for(var d=0,a=e.length;d<a;d++){var c=e[d].match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi);if(b&&c==b||!c){continue}if(c==CURRENT_DOMAIN_USER.email){continue}f+=c;if(d<a-1){f+=", "}}return f}function save_email_server_type_in_cookie(b){if(b){var a=_agile_get_prefs(email_server_type_cookie_name);if(a===b){return}_agile_set_prefs(email_server_type_cookie_name,b,30)}}function initializeSendEmailListeners(){$("#send-email-listener-container").on("change",".emailSelect",function(c){c.preventDefault();$("#emailForm").find(".error").removeClass("error");$("#emailForm").find(".help-inline").css("display","none");var d=$(".emailSelect option:selected").prop("value");if(!d){$("#emailForm").find('input[name="subject"]').val("");set_tinymce_content("email-body","");$("#emailForm").find('textarea[name="message"]').val("");$(".add-attachment-cancel").trigger("click");$("#eattachment_error").hide();return}var a=Backbone.Model.extend({url:"/core/api/email/templates/"+d,restKey:"emailTemplates"});var b=new a();b.fetch({success:function(h){var j=h.toJSON();var l=j.subject;var n=j.text;if(Current_Route!=="bulk-email"&&Current_Route!=="send-email"){var o=get_contact_json_for_merge_fields();var m;try{m=Handlebars.compile(l);l=m(o)}catch(g){l=add_square_brackets_to_merge_fields(l);m=Handlebars.compile(l);l=m(o)}try{m=Handlebars.compile(n);n=m(o)}catch(g){n=add_square_brackets_to_merge_fields(n);m=Handlebars.compile(n);n=m(o)}}$("#emailForm").find('input[name="subject"]').val(l);set_tinymce_content("email-body",n);if(j.attachment_id&&Current_Route!="bulk-email"&&Current_Route!="company-bulk-email"){var f=$(".add-attachment-select").closest("div");$(".add-attachment-select").hide();f.find(".attachment-document-select").css("display","inline");
var e="<option value='{{id}}' network_type='{{titleFromEnums network_type}}' size='{{size}}' url='{{url}}'>{{name}}</option>";fillSelect("attachment-select","core/api/documents","documents",function k(){f.find("#attachment-select option:first").after("<option value='new'>"+_agile_get_translated_val("others","upload-new-doc")+"</option>");$("#attachment-select").find("option[value="+j.attachment_id+"]").attr("selected","selected");$(".add-attachment-confirm").trigger("click")},e,false,f)}else{if(j.attachment_id&&(Current_Route=="bulk-email"||Current_Route=="company-bulk-email")){$(".add-attachment-select").hide();$("#eattachment_error").show()}else{if(!j.attachment_id&&(Current_Route=="bulk-email"||Current_Route=="company-bulk-email")){$(".add-attachment-select").hide();$("#eattachment_error").hide()}else{if(!j.attachment_id){$(".add-attachment-cancel").trigger("click");$("#eattachment_error").hide()}}}}}})});$("#send-email-listener-container").on("click","#sendEmail",function(j){j.preventDefault();if($(this).attr("disabled")){return}var c=$("#emailForm");if(!isValidForm(c)){return}var b=$("#attachment-select").find(":selected").attr("network_type");if(b){if(b.toUpperCase()==="GOOGLE"){return}}save_content_to_textarea("email-body");var d=serializeForm("emailForm");d.from=$(".email").find(":selected").val();if((d.contact_to_ids).join()){d.to+=((d.to!="")?",":"")+(d.contact_to_ids).join()}if((d.contact_cc_ids).join()){d.cc+=((d.cc!="")?",":"")+(d.contact_cc_ids).join()}if((d.contact_bcc_ids).join()){d.bcc+=((d.bcc!="")?",":"")+(d.contact_bcc_ids).join()}if(d.to==""||d.to==null||d.to==undefined){$save_info=$('<span style="display:inline-block;color:#df382c;">'+_agile_get_translated_val("validation-msgs","required")+"</span>");$("#emailForm").find("#to").closest(".controls > div").append($save_info);$("#emailForm").find("#to").focus();$save_info.show().delay(3000).hide(1);enable_send_button($("#sendEmail"));return}if(!isValidForm($("#emailForm"))){return}try{var a=d.to.split(",").length;var h=10;if(d.cc){a=d.cc.split(",").length+a}if(d.bcc){a=d.bcc.split(",").length+a}if(a>h){showAlertModal("Maximum limit of sending emails at once exceeded.",undefined,function(){},function(){},"Alert");return}}catch(g){}var f=$(this);if(hasScope("EDIT_CONTACT")){emailSend(f,d)}else{showModalConfirmation(_agile_get_translated_val("contact-details","send-email"),_agile_get_translated_val("campaigns","no-perm-send-emails")+"<br/><br/> "+_agile_get_translated_val("deal-view","do-you-want-to-proceed"),function(){emailSend(f,d)},function(){return},function(){})}});$("#send-email-listener-container").on("click","#send-email-close",function(a){a.preventDefault();window.history.back()});$("#send-email-listener-container").on("click","#cc-link, #bcc-link",function(a){a.preventDefault();$(this).hide();if($(this).attr("id")==="cc-link"){$("#email_cc").closest(".control-group").show();if($(this).parent().find("#bcc-link").css("display")==="none"){$(this).closest(".control-group").hide()}return}if($(this).parent().find("#cc-link").css("display")==="none"){$(this).closest(".control-group").hide()}$("#email_bcc").closest(".control-group").show()});$("#send-email-listener-container").on("click","#from_email_link",function(a){a.preventDefault();$(this).closest(".control-group").hide();$("#from_email").closest(".control-group").show();$("#from_name").closest(".control-group").show();return})}function emailSend(b,a){disable_send_button(b);$.ajax({type:"POST",data:JSON.stringify(a),dataType:"json",contentType:"application/json",url:"core/api/emails/contact/send-email",success:function(){enable_send_button($("#sendEmail"));window.history.back()},error:function(c){enable_send_button($("#sendEmail"));$save_info=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+c.responseText+"</i></p></small></div>");$($("#sendEmail")).closest(".form-actions",this.el).append($save_info);if(c.status!=406){$save_info.show().delay(10000).hide(1)}}})}function modelDelete(d,k,j){if(d&&d.collection){d.collection.remove(d)}if(d&&d.toJSON().type=="WEB_APPOINTMENT"&&parseInt(d.toJSON().start)>parseInt(new Date().getTime()/1000)){web_event_title=d.toJSON().title;if(d.toJSON().contacts.length>0){var e=getPropertyValue(d.toJSON().contacts[0].properties,"first_name");if(e==undefined){e=""}var g=getPropertyValue(d.toJSON().contacts[0].properties,"last_name");if(g==undefined){g=""}web_event_contact_name=e+" "+g}$("#webEventCancelModel").modal("show");$("#cancel_event_title").html(_agile_get_translated_val("events","delete-event")+" &#39"+web_event_title+"&#39");$("#event_id_hidden").html("<input type='hidden' name='event_id' id='event_id' value='"+b+"'/>");return}var b=$(k).attr("id");var h=$(k).attr("url");if(!h){return}var a=[];var c={};a.push(b);c.ids=JSON.stringify(a);var f=k;$.ajax({url:h,type:"POST",data:c,success:function(m){if((Current_Route.indexOf("contact/")==0||Current_Route.indexOf("company/")==0)&&!m){return}if((Current_Route.indexOf("contact/")==0||Current_Route.indexOf("company/")==0)&&m){var l=false;$.each(m,function(n,o){if(Current_Route.indexOf("contact/")==0&&App_Contacts.contactDetailView.model.get("id")&&o==App_Contacts.contactDetailView.model.get("id")){l=true}else{if(Current_Route.indexOf("company/")==0&&App_Companies.companyDetailView.model.get("id")&&o==App_Companies.companyDetailView.model.get("id")){l=true}}});if(Current_Route.indexOf("contact/")==0&&!App_Contacts.contactDetailView.model.get("id")){l=true}else{if(Current_Route.indexOf("company/")==0&&!App_Companies.companyDetailView.model.get("id")){l=true}}if(!l){showModalConfirmation(_agile_get_translated_val("contact-details","delete")+" <span class='text-cap'>"+d.get("entity_type")+"</span>",'<span class="text-cap">'+d.get("entity_type")+"</span> "+CONTACTS_ACTIVITY_ACL_DELETE_ERROR,function(){return},function(){return},function(){return},_agile_get_translated_val("contact-details","cancel"));return}}$(f).parents(".activity").parent().fadeOut(400,function(){$(k).remove()});if(j&&typeof(j)==="function"){j()}},error:function(l){showModalConfirmation("Delete <span class='text-cap'>"+d.get("entity_type")+"</span>","<span>"+l.responseText+"</span>",function(){return},function(){return},function(){return},"Cancel");return}})}var forceCompany={};$(function(){$("#personModal").off("show.bs.modal");$("#personModal").on("show.bs.modal",function(b){if(forceCompany.doit==true){var a=Handlebars.compile('<li class="tag"  style="display: inline-block;" data="{{id}}"><a href="#contact/{{id}}" id="contact_company_autofilled">{{name}}</a></li>');$("#personForm [name='contact_company_id']").html(a({name:forceCompany.name,id:forceCompany.id}));$("#personForm #contact_company").hide();forceCompany.doit=false}else{$("#personForm [name='contact_company_id']").html("");$("#personForm #contact_company").show();$("#personForm #contact_company").val("");$("#personForm input").val("")}});$("#companyModal").on("show.bs.modal",function(a){var b=a.target;add_custom_fields_to_form({},function(d){var c=show_custom_fields_helper(d.custom_fields,["modal"]);$("#custom-field-deals",$(b)).html(c);$(".date_input",$(b)).attr("placeholder",_agile_get_translated_val("contacts","select-date"));$(".date_input",$(b)).datepicker({format:CURRENT_USER_PREFS.dateFormat,autoclose:true});$(".contact_input",$("#companyModal")).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_contact_"+$(this).attr("id"),$("#companyModal")),contacts_typeahead,undefined,"type=PERSON")});$(".company_input",$("#companyModal")).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_company_"+$(this).attr("id"),$("#companyModal")),contacts_typeahead,undefined,"type=COMPANY")})},"COMPANY")});$("#personModal").on("shown.bs.modal",function(b){setup_tags_typeahead();var a=$("#personForm #contact_company").css("display");if(a!="none"){var c=function(f,e){var d=Handlebars.compile('<li class="tag"  style="display: inline-block;" data="{{id}}"><a href="#contact/{{id}}" id="contact_company_autofilled">{{name}}</a></li>');$("#personForm [name='contact_company_id']").html(d({name:e,id:f}));$("#personForm #contact_company").hide()};agile_type_ahead("contact_company",$("#personForm"),contacts_typeahead,c,"type=COMPANY","<b>"+_agile_get_translated_val("others","no-results")+"</b> <br/> "+_agile_get_translated_val("others","add-new-one"))}});$("body").on("click",'#personForm [name="contact_company_id"] a.close',function(a){$("#personForm #contact_company").show()});$("body").on("click","#person_validate",function(a){serialize_and_save_continue_contact(a,"personForm","personModal",false,true,this,"tags_source_person_modal")});$("body").on("click","#import-link",function(a){Backbone.history.navigate("import",{trigger:true})});$("body").on("click","#company_validate",function(a){serialize_and_save_continue_contact(a,"companyForm","companyModal",false,false,this)});$("#personModal").on("hidden.bs.modal",function(){$("#personModal").find(".alert").hide();remove_validation_errors("personModal");$("#personModal input").val("")});$("#companyModal").on("hidden.bs.modal",function(){remove_validation_errors("companyModal");$("#companyModal input").val("")});$("body").on("click",".hideCurrentModal",function(a){$(this).closest(".modal").hide();if($("body").hasClass("modal-open")){$("body").removeClass("modal-open")}});$("#tutorialModal").on("hidden.bs.modal",function(c){var a=$("#tutorialModal iframe").parent();var b=a.html();a.html(" ");a.html(b)})});function remove_validation_errors(a){$("#"+a).find("div.control-group").removeClass("error");$("#"+a).find("div.control-group").removeClass("success");$("#"+a).find("span.help-inline").remove()}function show_error(b,e,a,f){var c=$("#"+b);var d=$("#"+e);if(c.css("display")!=="none"){c.find("."+a).html('<div class="alert alert-danger" ><a class="close" data-dismiss="alert" href="#">&times</a>'+f+"</div>").show()}else{if(d.css("display")!=="none"){d.find("."+a).html('<div class="alert alert-danger" ><a class="close" data-dismiss="alert" href="#">&times</a>'+f+"</div>").show()
}}}function show_error_in_formactions(b,f,a,g){var d=$("#"+b);var e=$("#"+f);var c=$('<div style="display:inline-block"><small><p style="color:#B94A48; font-size:14px"><i>'+g+"</i></p></small></div>");if(d.css("display")!=="none"){d.find("."+a).html(c).show().delay(3000).hide(1)}else{if(e.css("display")!=="none"){e.find("."+a).html(c).show().delay(3000).hide(1)}}}function serialize_and_save_continue_contact(A,x,b,c,C,k,B){A.preventDefault();var h=$("#"+x);if($(k).attr("disabled")||!isValidForm(h)){var m=$(k).closest("form").find(".single-error").first();var o=h;$("body").scrollTop(m.offset().top-o.offset().top+o.scrollTop());return}disable_save_button($(k));var j=[];var q=$("#"+x+" input[name=id]").val();var w=$("#"+x+" #Manual_delete").val();var f=$("#"+x+" input[name=source]").attr("data");var D=$("#"+x+" input[name=created_time]").val();var v=$("#"+x+" #city").val();var g=$("#"+x+" #state").val();var u=$("#"+x+" #country").val();var z=$("#"+x+" #zip").val();var n={};var j=[];if(q){if(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model!=null&&App_Contacts.contactDetailView.model.get("id")==q){n=App_Contacts.contactDetailView.model.toJSON()}else{if(App_Contacts.contactsListView&&App_Contacts.contactsListView.collection.get(q)!=null){n=App_Contacts.contactsListView.collection.get(q).toJSON()}else{if(App_Contacts.contact_custom_view&&App_Contacts.contact_custom_view.collection.get(q)!=null){n=App_Contacts.contact_custom_view.collection.get(q).toJSON()}}}}if(company_util.isCompany()&&q){if(App_Companies.companyDetailView&&App_Companies.companyDetailView.model!=null&&App_Companies.companyDetailView.model.get("id")==q){n=App_Companies.companyDetailView.model.toJSON()}else{if(App_Companies.companiesListView&&App_Companies.companiesListView.collection.get(q)!=null){n=App_Companies.companiesListView.collection.get(q).toJSON()}}}var E;var t=$("#"+x).find(".custom_field");var d=[];var a=true;$.each(t,function(H,I){var K=$(I).attr("id"),e=$(I).attr("name");d.push(e);if($(I).hasClass("contact_input")||$(I).hasClass("company_input")){if($(I).hasClass("required_field")){if($(this).parent().find("ul").find("li").length==0){$(this).parent().append('<span for="fname" generated="true" class="help-inline">'+_agile_get_translated_val("validation-msgs","required")+"</span>");var J=this;setTimeout(function(){$(J).parent().find("span").remove()},1500);a=false}}if(isValidContactCustomField(K)){j.push(custom_Property_JSON(e,"CUSTOM",x))}}else{if(isValidField(K)){j.push(custom_Property_JSON(e,"CUSTOM",x))}}});if(!a){enable_save_button($(k));return}if(C){E="continue-contact";n.type="PERSON";if(f){n.source=f}if(isValidField(x+" #fname")){j.push(property_JSON("first_name",x+" #fname"))}if(isValidField(x+" #lname")){j.push(property_JSON("last_name",x+" #lname"))}if(isValidField(x+" #image")){j.push(property_JSON("image",x+" #image"))}if(isValidField(x+" #handle")){j.push({name:"website",value:$("#handle").val(),subtype:"TWITTER"})}var l=$("#"+x+" [name='contact_company_id']").find("li");if(l&&l.length){var G=$(l.get(0)).attr("data");var r=$(l.get(0)).find("a:first").text();n.contact_company_id=G;j.push({type:"SYSTEM",name:"company",value:r})}else{if(isValidField(x+" #contact_company")){if(h.find("#contact_company").prop("value").length>100){show_error(b,x,"duplicate-email",_agile_get_translated_val("companies","name-length-error"));enable_save_button($(k));return}n.contact_company_id=null;j.push(property_JSON("company",x+" #contact_company"))}else{n.contact_company_id=null}}if(isValidField(x+" #email")){j.push(property_JSON("email",x+" #email"))}if(isValidField(x+" #phone")){j.push(property_JSON("phone",x+" #phone"))}if(isValidField(x+" #job_title")){j.push(property_JSON("title",x+" #job_title"))}if(B===undefined||!B||B.length<=0){B=x}var p=get_tags(B);if(p!=undefined&&p.length!=0){n.tags=[];var y=true;if(!n.tagsWithTime||n.tagsWithTime.length==0){$.each(p[0].value,function(e,H){if(!isValidTag(H,false)){y=false;return false}});n.tagsWithTime=[];$.each(p[0].value,function(e,H){n.tagsWithTime.push({tag:H})})}else{var s=[];$.each(p[0].value,function(e,H){var I=true;$.each(n.tagsWithTime,function(K,J){if(H==J.tag){s.push(J);I=false;return false}});if(I){s.push({tag:H});if(!isValidTag(H,false)){y=false;return false}}});n.tagsWithTime=s}if(!y){$(".invalid-tags-person").show().delay(6000).hide(1);enable_save_button($(k));return false}}if(n.contact_company_id){$.ajax({url:"/core/api/contacts/"+n.contact_company_id,type:"GET",dataType:"json",success:function(e){if(e){contact_company=e;return serialize_contact_properties_and_save(A,x,n,j,b,c,C,k,B,q,D,d,E,e)}},error:function(){console.log("company fetch failed.");return serialize_contact_properties_and_save(A,x,n,j,b,c,C,k,B,q,D,d,E)}})}else{return serialize_contact_properties_and_save(A,x,n,j,b,c,C,k,B,q,D,d,E)}}else{E="continue-company";n.type="COMPANY";if(isValidField("company_name")){var F=h.find("#company_name").prop("value");if(F.length>100){show_error(b,x,"duplicate-email",_agile_get_translated_val("companies","name-length-error"));enable_save_button($(k));return}if(!q){isCompanyExist(F,function(e){if(e){show_error(b,x,"duplicate-email",_agile_get_translated_val("companies","name-exists"));enable_save_button($(k));return}else{j.push(property_JSON("name",x+" #company_name"));return serialize_contact_properties_and_save(A,x,n,j,b,c,C,k,B,q,D,d,E)}});return}else{j.push(property_JSON("name",x+" #company_name"));return serialize_contact_properties_and_save(A,x,n,j,b,c,C,k,B,q,D,d,E)}}}}function serialize_contact_properties_and_save(v,t,k,g,b,c,y,j,x,o,z,f,A,n){if(isValidField(t+" #company_url")){g.push(property_JSON("url",t+" #company_url"))}if(x===undefined||!x||x.length<=0){x=t}var l=get_tags(x);if(l!=undefined&&l.length!=0){k.tags=[];var u=true;if(!k.tagsWithTime||k.tagsWithTime.length==0){$.each(l[0].value,function(e,B){if(!isValidTag(B,false)){u=false;return false}});k.tagsWithTime=[];$.each(l[0].value,function(e,B){k.tagsWithTime.push({tag:B})})}else{var q=[];$.each(l[0].value,function(e,B){var C=true;$.each(k.tagsWithTime,function(E,D){if(B==D.tag){q.push(D);C=false;return false}});if(C){q.push({tag:B});if(!isValidTag(B,false)){u=false;return false}}});k.tagsWithTime=q}if(!u){$(".invalid-tags-person").show().delay(6000).hide(1);enable_save_button($(j));return false}}$("#"+t+" div.multiple-template").each(function(C,D){if($(D).attr("data")=="address"){var F={};var e;$.each($(D).find(":input,select"),function(H,G){if($(G).val()==undefined||$(G).val().length==0){return}if($(G).attr("name")=="address-type"){e=$(G).val()}else{F[$(G).attr("name")]=$(G).val()}if($(G).attr("name")=="country"){F.countryname=$(G).find("option:selected").text()}});if($.isEmptyObject(F)){return}g.push({name:$(D).attr("data"),value:JSON.stringify(F),subtype:e})}else{var E=$(D).find("input");var B=$(D).find("select");if(E.val()==undefined||E.val().trim().length==0){return}if(!$(D).find("input").parents("div.controls").hasClass("hide")){g.push({name:$(D).attr("data"),value:E.val(),subtype:B.val()})}}});if(k.properties){var m=g;$.each(k.properties,function(B,e){$.each(m,function(D,C){if(C.name==e.name){return false}else{if(D==(m.length-1)&&f.indexOf(e.name)==-1&&e.type=="CUSTOM"&&e.name=="image"){g.push(e)}}})})}if(n){var d=null;$.each(n.properties,function(){if(this.name=="address"&&this.subtype=="office"){d=this.value}});if(d){var r=false;$.each(g,function(e,B){console.log(e);if(e=="address"){r=true;return false}});if(!r){var h=$(v.target).attr("id");if(h=="person_validate"||h=="continue-contact"){console.log(d);g.push({name:"address",value:d,subtype:"office"})}}}}var p=[];p.push({name:"properties",value:g});for(var s=0;s<p.length;++s){k[p[s].name]=p[s].value}if(o!=null){k.id=o}k.created_time=z;var a=v.currentTarget.id;var w=new BaseModel();w.url="core/api/contacts";w.save(k,{success:function(F){_agile_delete_prefs("Agile_linkedin_matches_"+F.get("id"));_agile_delete_prefs("Agile_twitter_matches_"+F.get("id"));enable_save_button($(j));if(y){add_contact_to_view(App_Contacts.contactsListView,F,k.id)}else{add_contact_to_view(App_Companies.companiesListView,F,k.id)}if(l!=undefined&&l.length!=0){$.each(l[0].value,function(J,e){console.log(tagsCollection);tagsCollection.add(new BaseModel({tag:e}))})}$("#"+b).find("img.person-img").remove();if(c){add_custom_fields_to_form(F.toJSON(),function(e){console.log(e);deserialize_contact(e,A)},F.toJSON()["type"])}else{if(y){if(App_Contacts.contactDetailView){App_Contacts.contactDetailView.model=F}if(!CALL_CAMPAIGN.start&&Current_Route!="contact/"+F.id){App_Contacts.navigate("contact/"+F.id,{trigger:true})}}else{var E=F.toJSON();if(App_Contacts.contactsListView){var C=App_Contacts.contactsListView.collection.where({contact_company_id:""+E.id});$.each(C,function(J,e){$.each(e.get("properties"),function(K,L){if(L.name=="company"&&L.type=="SYSTEM"){$.each(E.properties,function(N,M){if(M.name=="name"&&M.type=="SYSTEM"){L.value=M.value}})}})})}if(App_Companies.companyDetailView){App_Companies.companyDetailView.model=F}if(Current_Route!="company/"+F.id){App_Companies.navigate("company/"+F.id,{trigger:true})}}}if(CallLogVariables.dynamicData!=null){CallLogVariables.processed=true}$("#"+b).modal("hide");$("#"+t).each(function(){this.reset()});$(".tagsinput",$("#"+b)).empty();try{if(a!="continue-contact"){if(CallLogVariables.dynamicData!=null){var H=F.toJSON();var B=CallLogVariables.dynamicData;B.contact_name=getContactName(H);B.contId=H.id;showDynamicCallLogs(B)}}}catch(G){}if(CALL_CAMPAIGN.start){var I=$("#continueform input[name=id]").val();if(CALL_CAMPAIGN.contact_update){CALL_CAMPAIGN.current_count=CALL_CAMPAIGN.current_count-1;CALL_CAMPAIGN.contact_update=false;dialNextCallAutomatically();Backbone.history.loadUrl("contact/"+I);$(window).scrollTop(0);return}else{var D=CALL_CAMPAIGN.contact_id_list[CALL_CAMPAIGN.current_count];if(I==D){CALL_CAMPAIGN.current_count=CALL_CAMPAIGN.current_count-1;dialNextCallAutomatically()}}if(Current_Route!="contact/"+I){Backbone.history.navigate("contact/"+I,{trigger:true})
}$(window).scrollTop(0)}},error:function(B,e){enable_save_button($(j));if(e.status==400){var C=e.responseText.split("|")[1];if(!C){C=""}show_error(b,t,"duplicate-email",e.responseText)}else{if(e.status==403){if(t=="companyForm"){show_error_in_formactions(b,t,"form-action-error",_agile_get_translated_val("companies","no-perm-to-add"))}else{if(t=="continueCompanyForm"){show_error_in_formactions(b,t,"form-action-error",_agile_get_translated_val("companies","no-perm-to-update"))}else{show_error_in_formactions(b,t,"form-action-error",e.responseText)}}}else{show_error(b,t,"duplicate-email",e.responseText)}}}});return k}function deserialize_contact(a,b){getTemplate(b,a,undefined,function(f){if(!f){return}var d=$("#content").html($(f));$(".date_input").attr("placeholder",_agile_get_translated_val("contacts","select-date"));$(".date_input").datepicker({format:CURRENT_USER_PREFS.dateFormat,weekStart:CALENDAR_WEEK_START_DAY,autoclose:true});setup_tags_typeahead();$.each(a.properties,function(h,j){if(j.type=="CUSTOM"&&j.name!="website"){return}$($("#"+d.attr("id")+" div.multiple-template."+j.name).closest("div.controls.second")).remove();var g=$("#"+d.attr("id")+" div.multiple-template."+j.name);fill_multi_options(g,j)});var e=function(h,g){$("#content [name='contact_company_id']").html('<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="'+h+'"><span><a class="text-white m-r-xs" href="#contact/'+h+'">'+g+'</a><a class="close" id="remove_tag">&times</a></span></li>');$("#content #contact_company").hide();if(h){$.ajax({url:"/core/api/contacts/"+h,type:"GET",dataType:"json",success:function(j){if(j){console.log(j);contact_company=j;var k=null;$.each(contact_company.properties,function(){if(this.name=="address"&&this.subtype=="office"){k=JSON.parse(this.value)}});if(k){$("#content .address-type").val("office");if(k.address){$("#content #address").val(k.address)}if(k.city){$("#content #city").val(k.city)}if(k.state){$("#content #state").val(k.state)}if(k.zip){$("#content #zip").val(k.zip)}if(k.country){$("#content #country").val(k.country)}}}}})}};agile_type_ahead("contact_company",$("#content"),contacts_typeahead,e,"type=COMPANY","<b>"+_agile_get_translated_val("others","no-results")+"</b> <br/> "+_agile_get_translated_val("others","add-new-one"));if(a.contact_company_id&&a.contact_company_id.length>0){for(var c=0;c<a.properties.length;++c){if(a.properties[c].name=="company"){$("#content #contact_company").hide();$("#content [name='contact_company_id']").html('<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="'+a.contact_company_id+'"><span><a class="text-white m-r-xs" href="#contact/'+a.contact_company_id+'">'+a.properties[c].value+'</a><a class="close" id="remove_tag">&times</a></span></li>')}}}$(".contact_input",$("#content")).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_contact_"+$(this).attr("id"),$("#content")),contacts_typeahead,undefined,"type=PERSON")});$(".contact_input",$("#content")).each(function(){var g=$(this).attr("name");for(var h=0;h<a.properties.length;++h){if(a.properties[h].name==g){var j=$.parseJSON(a.properties[h].value);var k="";$.each(j,function(l,m){if(l!=j.length-1){k+=m+","}else{k+=m}});setReferenceContacts(g,$("#content"),j,k)}}});$(".company_input",$("#content")).each(function(){agile_type_ahead($(this).attr("id"),$("#custom_company_"+$(this).attr("id"),$("#content")),contacts_typeahead,undefined,"type=COMPANY")});$(".company_input",$("#content")).each(function(){var g=$(this).attr("name");for(var h=0;h<a.properties.length;++h){if(a.properties[h].name==g){var j=$.parseJSON(a.properties[h].value);var k="";$.each(j,function(l,m){if(l!=j.length-1){k+=m+","}else{k+=m}});setReferenceContacts(g,$("#content"),j,k)}}});initializeEditContactListeners($("form",$("#content")).attr("id"))},"#content")}function fill_multi_options(a,c){if(c.type=="CUSTOM"&&c.name!="website"){return}if(c.name=="address"){var b=JSON.parse(c.value);$.each($(a).find(":input,select"),function(h,f){var g=$(f).attr("name");if(g=="address-type"){$(f).val(c.subtype)}else{$(f).val(b[g])}if(g=="country"&&!$(f).val()){var j=Handlebars.compile("<span class='country-mismatch-error' style='color:#B94A48; font-size:14px'><i>Country {{country}} doesn’t match with our standard records. Please update the country using the dropdown.</i></span>");$(f).after(j(b))}})}else{var e=$(a).parents("div.control-group");var d=e.children().siblings("div.controls:first").clone().removeClass("hide");$(d).find("input").val(c.value).attr("name",c.value);$(d).find("select").val(c.subtype);d.appendTo(e)}}function custom_Property_JSON(b,e,a){var c={};c.name=b;c.type=e;var h=$("#"+a).find('*[name="'+b+'"]');var d=h.attr("type"),g;console.log(d);if(d=="checkbox"){g=h.is(":checked")?"on":"off"}else{if(h.hasClass("date_input")){if(CURRENT_USER_PREFS.dateFormat.indexOf("dd/mm/yy")!=-1||CURRENT_USER_PREFS.dateFormat.indexOf("dd.mm.yy")!=-1){g=new Date(convertDateFromUKtoUS(h.val())).getTime()/1000}else{g=new Date(h.val()).getTime()/1000}}else{if(h.hasClass("contact_input")||h.hasClass("company_input")){var f=[];$('ul[name="'+b+'"]',$("#"+a)).find("li").each(function(){f.push($(this).attr("data"))});g=JSON.stringify(f)}else{g=h.val()}}}c.value=g;return c}$(function(){$("body").on("click",'#content [name="contact_company_id"] a.close',function(b){$("#content #contact_company").show();$("#content [name='contact_company_id']").html("");if(contact_company){var a=false;var c=null;$.each(contact_company.properties,function(){if(this.name=="address"&&this.subtype=="office"){c=JSON.parse(this.value)}});if(c){if(c.address&&$("#content #address").val()&&$("#content #address").val()!=c.address){a=true}else{if(c.city&&$("#content #city").val()&&$("#content #city").val()!=c.city){a=true}else{if(c.state&&$("#content #state").val()&&$("#content #state").val()!=c.state){a=true}else{if(c.zip&&$("#content #zip").val()&&$("#content #zip").val()!=c.zip){a=true}else{if(c.country&&$("#content #country").val()&&$("#content #country").val()!=c.country){a=true}}}}}if(!a){$("#content .address-type,#address,#city,#state,#zip,#country").val("")}}}});$("body").on("click","a.multiple-add",function(a){a.preventDefault();$(this).parents("div.control-group").append($(this).parents().siblings("div.controls:first").clone().removeClass("hide").addClass("col-sm-offset-3"))});$("body").on("click","a.multiple-remove",function(a){a.preventDefault();$(this).closest("div.multiple-template").remove()});$("#continue-contact").click(function(a){serialize_and_save_continue_contact(a,"personForm","personModal",true,true,this,"tags_source_person_modal")});$("body").on("click","#update",function(a){serialize_and_save_continue_contact(a,"continueform","personModal",false,true,this,"tags_source_continue_contact")});$("body").on("click","#close",function(a){a.preventDefault();var b=$("#continueform input[name=id]").val();if(CALL_CAMPAIGN.start&&CALL_CAMPAIGN.contact_update){CALL_CAMPAIGN.contact_update=false;Backbone.history.loadUrl("#contact/"+b);$(window).scrollTop(0);return}if(b){Backbone.history.navigate("contact/"+b,{trigger:true})}});$("#continue-company").click(function(a){serialize_and_save_continue_contact(a,"companyForm","companyModal",true,false,this)});$("body").on("click","#company-update",function(a){serialize_and_save_continue_contact(a,"continueCompanyForm","companyModal",false,false,this,"tags_source_continue_company")})});function add_contact_to_view(c,a,b){if(!c){return}if(a.get("type")=="COMPANY"){a.set({entity_type:"company_entity"},{silent:true});if(c.collection.get(a.id)!=null){c.collection.get(a.id).set(a)}else{if(company_util.isCompany()){add_model_cursor(c.collection,a)}else{if(b){COMPANIES_HARD_RELOAD=true}}}}else{if(!_agile_get_prefs("company_filter")){if(!_agile_get_prefs("contact_filter")){if(c.collection.get(a.id)!=null){c.collection.get(a.id).set(a)}else{add_model_cursor(c.collection,a)}}else{CONTACTS_HARD_RELOAD=true}}}}function add_model_cursor(b,a){if(b.models.length>=1){b.add(a,{at:b.models.length-1})}else{b.add(a)}if(b.at(0).attributes.count){b.at(0).attributes.count+=1}}function isCompanyExist(a,b){$.get("core/api/contacts/company/validate?companyName="+a,function(c){if(c=="true"){b(true);return}b(false)})}function setReferenceContacts(a,d,b,c){App_Contacts.referenceContactsCollection=new Base_Collection_View({url:"/core/api/contacts/references?references="+c,sort_collection:false});App_Contacts.referenceContactsCollection.collection.fetch({success:function(e){if(e&&e.length>0){$.each(b,function(g,j){var h=getPropertyValue(e.get(j).get("properties"),"first_name");var f=getPropertyValue(e.get(j).get("properties"),"last_name");if(f){h+=" "+f}if(h){$("ul[name='"+a+"']",d).append('<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="'+j+'"><a class="text-white m-r-xs" href="#contact/'+j+'">'+h+'</a><a class="close" id="remove_tag">&times</a></li>')}else{$("ul[name='"+a+"']",d).append('<li class="inline-block tag btn btn-xs btn-primary m-r-xs m-b-xs" data="'+j+'"><a class="text-white m-r-xs" href="#company/'+j+'">'+getPropertyValue(e.get(j).get("properties"),"name")+'</a><a class="close" id="remove_tag">&times</a></li>')}})}hideTransitionBar()}})}function initializeEditContactListeners(a){$("#"+a).on("change","#country",function(b){b.preventDefault();$(".country-mismatch-error").hide()})}var notesView;var dealsView;var eventsView;var tasksView;var casesView;var documentsView;var campaignsView;var mailsView;var mailAccountsView_company;var mailAccountsView;var email_errors_divs=[];var email_requests=[];var contact_details_tab={load_timeline:function(){$("div.tab-content",App_Contacts.contactDetailView.el).find("div.active").removeClass("active");$("#time-line",App_Contacts.contactDetailView.el).addClass("active");if($("#timeline",App_Contacts.contactDetailView.el).hasClass("isotope")){$("#timeline",App_Contacts.contactDetailView.el).isotope("reLayout",function(){});return}load_timeline_details(App_Contacts.contactDetailView.el,App_Contacts.contactDetailView.model.get("id"))
},load_notes:function(){var a=App_Contacts.contactDetailView.model.id;notesView=new Base_Collection_View({url:"/core/api/contacts/"+a+"/notes",restKey:"note",templateKey:"notes",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(b){agileTimeAgoWithLngConversion($(".note-created-time",b));contact_detail_page_infi_scroll($("#contact-dtl",App_Contacts.contactDetailView.el),notesView)},appendItemCallback:function(b){includeTimeAgo(b)}});notesView.collection.fetch();$("#notes",App_Contacts.contactDetailView.el).html(notesView.el)},load_events:function(){var a=App_Contacts.contactDetailView.model.id;eventsView=new Base_Collection_View({url:"/core/api/contacts/"+a+"/events",restKey:"event",templateKey:"contact-events",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(b){agileTimeAgoWithLngConversion($(".event-created-time",b));$("li",b).each(function(){if($(this).find(".priority_type").text().trim()=="High"){$(this).css("border-left","3px solid #f05050")}else{if($(this).find(".priority_type").text().trim()=="Normal"){$(this).css("border-left","3px solid #7266ba")}else{if($(this).find(".priority_type").text().trim()=="Low"){$(this).css("border-left","3px solid #fad733")}}}})}});eventsView.collection.fetch();$("#events",App_Contacts.contactDetailView.el).html(eventsView.el)},load_documents:function(){id=App_Contacts.contactDetailView.model.id;documentsView=new Base_Collection_View({url:"/core/api/documents/contact/"+id+"/docs",restKey:"document",templateKey:"contact-documents",individual_tag_name:"li",sortKey:"uploaded_time",descending:true,postRenderCallback:function(a){agileTimeAgoWithLngConversion($(".document-created-time",a))}});documentsView.collection.fetch();$("#documents",App_Contacts.contactDetailView.el).html(documentsView.el)},load_tasks:function(){id=App_Contacts.contactDetailView.model.id;tasksView=new Base_Collection_View({url:"/core/api/contacts/"+id+"/tasks",restKey:"task",templateKey:"contact-tasks",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(a){agileTimeAgoWithLngConversion($(".task-created-time",a));$("li",a).each(function(){if($(this).find(".priority_type").text().trim()=="HIGH"){$(this).css("border-left","3px solid #f05050")}else{if($(this).find(".priority_type").text().trim()=="NORMAL"){$(this).css("border-left","3px solid #7266ba")}else{if($(this).find(".priority_type").text().trim()=="LOW"){$(this).css("border-left","3px solid #fad733")}}}})}});tasksView.collection.fetch();$("#tasks",App_Contacts.contactDetailView.el).html(tasksView.el)},load_deals:function(){id=App_Contacts.contactDetailView.model.id;dealsView=new Base_Collection_View({url:"core/api/contacts/"+id+"/deals",restKey:"opportunity",templateKey:"deals",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(a){agileTimeAgoWithLngConversion($(".deal-created-time",a));$(a).find("ul li").each(function(){$(this).addClass("deal-color");$(this).addClass($(this).find("input").attr("class"))})}});dealsView.collection.fetch();$("#deals",App_Contacts.contactDetailView.el).html(dealsView.el)},load_cases:function(){id=App_Contacts.contactDetailView.model.id;casesView=new Base_Collection_View({url:"core/api/contacts/"+id+"/cases",restKey:"cases",templateKey:"cases-contact",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(a){agileTimeAgoWithLngConversion($(".deal-created-time",a))}});casesView.collection.fetch();$("#cases",App_Contacts.contactDetailView.el).html(casesView.el)},load_mail:function(g,f){killAllPreviousRequests();$("#mail #mails-span",App_Contacts.contactDetailView.el).remove();$("#mails",App_Contacts.contactDetailView.el).html("");if(typeof mailsView!=="undefined"){mailsView.render=null;mailsView.collection=null}var c=App_Contacts.contactDetailView.model;var h=c.toJSON();var d=getAllPropertyValuesByName(h.properties,"email",",");if(!d){show_no_email_alert();return}var e=this;var j=true;var a=true;if(f&&g){if($("#has_email_configured",App_Contacts.contactDetailView.el).html()==="true"){j=true}else{j=false}if(f!=="all"){fetchMails(e,j,g,f,d)}else{var b=mailAccountsView.model.toJSON();fetchAllMails(e,j,b,d)}}else{loadMailTabView(e,f,g,d)}},load_stats:function(){var a=App_Contacts.contactDetailView.model;var c=a.toJSON();var b=getAllPropertyValuesByName(c.properties,"email",",");if(!b){$("#stats",App_Contacts.contactDetailView.el).html('<div class="alert alert-danger m-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>'+_agile_get_translated_val("contact-details","sorry-this-contact-has-no-email-to-get-the-stats")+"</div>");return}get_web_stats_count_for_domain(function(e){if(!(_agile_get_prefs("_agile_jsapi")!=null&&_agile_get_prefs("_agile_jsapi")=="true")&&(NO_WEB_STATS_SETUP&&e=="0")){$("#stats",App_Contacts.contactDetailView.el).html('<h4 class="webstats-msg space-normal  wrapper-sm font-normal m-none"><p>'+_agile_get_translated_val("contact-details","you-have-not-yet-setup-the-javascript-api-on-your website")+"</p><p>"+_agile_get_translated_val("contact-details","please")+' <a href="#analytics-code">'+_agile_get_translated_val("contact-details","set-it-up")+"</a> "+_agile_get_translated_val("contact-details","to-see-the-contacts-site-visits-here")+"</p></h4>");return}addTagAgile(CODE_SETUP_TAG);var d=new Base_Collection_View({url:"core/api/web-stats?e="+encodeURIComponent(b),templateKey:"stats",individual_tag_name:"li",postRenderCallback:function(g){agileTimeAgoWithLngConversion($(".stats-created-time",g));var f=$("#stats-model-list").find("li")[0];if(f){$(f).find("#show-page-views").trigger("click")}}});d.collection.fetch();d.collection.comparator=function(f){if(f.get("created_time")){return -f.get("created_time")}};console.log($("#stats",App_Contacts.contactDetailView.el));$("#stats",App_Contacts.contactDetailView.el).html(d.render().el)})},load_campaigns:function(){$("#campaigns",App_Contacts.contactDetailView.el).html("");getCampaignContact(function(){campaignsView=new Base_Collection_View({url:"/core/api/campaigns/logs/contact/"+App_Contacts.contactDetailView.model.id,restKey:"logs",templateKey:"campaigns",individual_tag_name:"li",cursor:true,page_size:20,sort_collection:false,postRenderCallback:function(a){$("#unsubscribe-modal",a).off("click");$("#unsubscribe-modal",a).on("click",function(b){b.preventDefault();show_resubscribe_modal()});agileTimeAgoWithLngConversion($("time.log-created-time",a));contact_detail_page_infi_scroll($("#contact-dtl",App_Contacts.contactDetailView.el),campaignsView)},appendItemCallback:function(a){includeTimeAgo(a)}});campaignsView.collection.fetch({success:function(){checkContactUpdated()}});$("#campaigns",App_Contacts.contactDetailView.el).html(campaignsView.el)})},load_tickets:function(){loadServiceLibrary(function(){Tickets_Rest.loadTicketsByContactId(App_Contacts.contactDetailView.model.id)})}};function loadMailTabView(e,f,h,d){var j=true;var b=true;var c="";var g="";var a="";mailAccountsView=new Base_Model_View({url:"core/api/emails/synced-accounts",template:"email-account-types",change:false,postRenderCallback:function(l){c=mailAccountsView.model.toJSON();if(c.hasEmailAccountsConfigured){j=true}else{j=false}if(c.hasSharedEmailAccounts){b=true}else{b=false}var k=fetch_mailserverurl_from_cookie(c);if(k&&k.length==4){h=k[0];g=k[1];f=k[2];a=k[3];if(a){email_server_type=a}}if(!f||!h||!a||(!j&&!b)){f="agile";g='<i class="icon-cloud" style="margin-right:4px;font-size: 1.2em"></i>Agile';email_server_type="agilecrm"}if(f==="all"||h==="all"){fetchAllMails(e,j,c,d)}else{fetchMails(e,j,h,f,d)}if(j||b){if(g){$("#email-type-select",App_Contacts.contactDetailView.el).html(g)}$("#mail-account-types",App_Contacts.contactDetailView.el).css("display","block")}}});$("#mail-account-types",App_Contacts.contactDetailView.el).html(mailAccountsView.render().el)}function fetchMails(d,c,f,a,b){$("#mail",App_Contacts.contactDetailView.el).append('<span id="mails-span"> <img class="mails-loading p-r-xs m-b m-l-sm pull-left"  src= "'+updateImageS3Path("/img/ajax-loader-cursor.gif")+'"></img></span>');this.configured_sync_email="";var e=true;if(a==="agile"){f="core/api/emails/agile-emails?search_email="+encodeURIComponent(b);email_server_type="agilecrm";e=false}else{f=f+"&search_email="+encodeURIComponent(b)}mailsView=new Base_Collection_View({url:f,cursor:e,page_size:10,templateKey:"email-social",sort_collection:true,sortKey:"date_secs",descending:true,individual_tag_name:"li",postRenderCallback:function(g){$("#mail",App_Contacts.contactDetailView.el).find("#no-email").css("display","block");agileTimeAgoWithLngConversion($(".email-sent-time",g));if(email_server_type!="agilecrm"){d.configured_sync_email=email_server_type}if(!c){$("#email-prefs-verification",App_Contacts.contactDetailView.el).css("display","block")}contact_detail_page_infi_scroll($("#contact-dtl",App_Contacts.contactDetailView.el),mailsView);$("#mail #mails-span",App_Contacts.contactDetailView.el).remove()}});mailsView.collection.fetch();$("#mails",App_Contacts.contactDetailView.el).html(mailsView.render().el)}function fetchAllMails(f,d,e,c){var b=[];var a=e.fetchUrls;$("#contact-dtl",App_Contacts.contactDetailView.el).unbind("scroll");loadAllMailsView(f,d,b);fetchMailsFromAllAccounts(f,d,a,c)}function fetchMailsFromAllAccounts(f,c,a,b){var e=0;if(a){if(a.length>0){$("#mail-account-types",App_Contacts.contactDetailView.el).prepend('<span id="mails-span"> <img class="all-mails-loading p-r-xs m-b m-l-sm pull-left"  src= "'+updateImageS3Path("/img/ajax-loader-cursor.gif")+'"></img></span>');$("#mail-account-types",App_Contacts.contactDetailView.el).find(".all-mails-loading").css("display","block")}for(var d=0;d<a.length;d++){var g=$.ajax({url:a[d]+"&search_email="+encodeURIComponent(b),success:function(h){e++;if(h){if(ifNoError(h[0])){if(!mailsView){setTimeout(function(){mailsView.collection.add(h);mailsView.render(true);showTransitionBar()
},5000)}else{mailsView.collection.add(h);mailsView.render(true)}}if(e===a.length){showMailsInfoMessages()}}},error:function(h){e++;if(e===a.length){showMailsInfoMessages(h)}}});email_requests.push(g)}}}function loadAllMailsView(c,b,a){if(typeof mailsView!=="undefined"){mailsView.render=null;mailsView=null}this.configured_sync_email="";mailsView=new Base_Collection_View({data:a,templateKey:"email-social",sort_collection:true,sortKey:"date_secs",descending:true,individual_tag_name:"li",postRenderCallback:function(d){agileTimeAgoWithLngConversion($(".email-sent-time",d));if(email_server_type!="agilecrm"){c.configured_sync_email=email_server_type}if(!b){$("#email-prefs-verification",App_Contacts.contactDetailView.el).css("display","block")}}});$("#mails",App_Contacts.contactDetailView.el).html(mailsView.render(true).el)}function fetch_mailserverurl_from_cookie(f){var d=_agile_get_prefs(email_server_type_cookie_name);var k="";var g=[];if(d){var n=d.split("|");if(n){if(n.length===2){var j=n[0];var l=n[1];var e="";var a=false;if(j&&l){if(l.toLowerCase()==="all"){g[0]="all";g[1]="All Mail";g[2]="all";g[3]="all"}else{if(l.toLowerCase()==="google"){var h=false;if(typeof f.gmailUserNames!=="undefined"&&f.hasOwnProperty("gmailUserNames")){for(var c=0;c<f.gmailUserNames.length;c++){if(f.gmailUserNames[c]===j){h=true;break}}}if(typeof f.sharedGmailUserNames!=="undefined"&&f.hasOwnProperty("sharedGmailUserNames")){for(var c=0;c<f.sharedGmailUserNames.length;c++){if(f.sharedGmailUserNames[c]===j){h=true;a=true;break}}}if(h){k="core/api/social-prefs/google-emails?from_email="+j;e='<i class="icon-google-plus" style="margin-right:4px;font-size: 1.2em"></i>'+j;if(a){e=e+" ("+_agile_get_translated_val("contact-details","shared")+")"}}}else{if(l.toLowerCase()==="imap"){var b=false;if(typeof f.imapUserNames!=="undefined"&&f.hasOwnProperty("imapUserNames")){for(var c=0;c<f.imapUserNames.length;c++){if(f.imapUserNames[c]===j){b=true;break}}}if(typeof f.sharedImapUserNames!=="undefined"&&f.hasOwnProperty("sharedImapUserNames")){for(var c=0;c<f.sharedImapUserNames.length;c++){if(f.sharedImapUserNames[c]===j){b=true;a=true;break}}}if(b){k="core/api/imap/imap-emails?from_email="+j;e='<i class="icon-envelope-alt" style="margin-right:4px;font-size: 1.2em"></i>'+j;if(a){e=e+" ("+_agile_get_translated_val("contact-details","shared")+")"}}}else{if(l.toLowerCase()==="exchange"){var m=false;if(typeof f.exchangeUserNames!=="undefined"&&f.hasOwnProperty("exchangeUserNames")){for(var c=0;c<f.exchangeUserNames.length;c++){if(f.exchangeUserNames[c]===j){m=true;break}}}if(typeof f.sharedExchangeUserNames!=="undefined"&&f.hasOwnProperty("sharedExchangeUserNames")){for(var c=0;c<f.sharedExchangeUserNames.length;c++){if(f.sharedExchangeUserNames[c]===j){m=true;a=true;break}}}if(m){k="core/api/office/office365-emails?from_email="+j;e='<i class="icon-windows" style="margin-right:4px;font-size: 1.2em"></i>'+j;if(a){e=e+" ("+_agile_get_translated_val("contact-details","shared")+")"}}}}}}if(k){g[0]=k;g[1]=e;g[2]=l;g[3]=j}}}}}return g}function contact_detail_page_infi_scroll(b,a){console.log("initialize_infinite_scrollbar",b);b.unbind("scroll");if(b==undefined||b==null){console.log("no elmnt");return}console.log(a);a.infiniScroll=new Backbone.InfiniScroll(a.collection,{target:b,untilAttr:"cursor",param:"cursor",strict:false,pageSize:a.page_size,success:function(d,c){console.log("in success");if(!d.last().get("cursor")){this.strict=true;a.infiniScroll.disableFetch()}$(a.infiniScroll.options.target).find(".scroll-loading").remove()},onFetch:function(){console.log("in fetch");$(a.infiniScroll.options.target).append('<div class="scroll-loading"> <img src="'+updateImageS3Path("/img/ajax-loader-cursor.gif")+'" style="margin-left: 44%;"> </div>')}})}function showMailsInfoMessages(){showMailsErrorMessages();if(mailsView.collection.length>20){if(($("#all-emails-info",App_Contacts.contactDetailView.el).length===0)){$("#mails",App_Contacts.contactDetailView.el).append('<div id="all-emails-info" class="alert alert-info">'+_agile_get_translated_val("mails","show-mails-error")+" </div>")}}$("#mail-account-types",App_Contacts.contactDetailView.el).find(".all-mails-loading").remove();$("#mail",App_Contacts.contactDetailView.el).find("#no-email").css("display","block")}function showMailsErrorMessages(){for(var a=0;a<email_errors_divs.length;a++){$("#mails",App_Contacts.contactDetailView.el).prepend(email_errors_divs[a])}email_errors_divs=[]}function ifNoError(b){if(b&&"errormssg" in b&&"owner_email" in b){var a='<div class="alert alert-danger" > <a href="#" class="close" data-dismiss="alert">&times;</a><span class="text-dark">Unable to fetch emails from account "'+b.owner_email+'" Error:'+b.errormssg+"</span>";email_errors_divs.push(a);return false}return true}function killAllPreviousRequests(){for(var a=0;a<email_requests.length;a++){var b=email_requests[a];b.abort()}email_requests=[]}function show_no_email_alert(){$("#mail",App_Contacts.contactDetailView.el).html('<div class="alert alert-danger m-t-sm m-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>Sorry! this contact has no email to get the mails</div>')}function show_resubscribe_modal(){getTemplate("contact-detail-resubscribe-modal",{},undefined,function(b){if(!b){return}unsubscribe_status_updated=false;if($("div#contact-detail-resubscribe-modal").size()!=0){$("div#contact-detail-resubscribe-modal").remove()}var a=$(b).modal("show");a.on("shown.bs.modal",function(d){var c=$(b);$(this).find(".modal-body").css({width:"auto",height:"auto","max-height":"100%"});fillSelect("campaigns-list","/core/api/workflows","workflow",function(g){$("#campaigns-list",c).empty();email_workflows_list=get_email_workflows(g.toJSON());var f=Handlebars.compile("{{#each this}}<option value='{{@key}}'>{{this}}</option>{{/each}}");var e=f(email_workflows_list);$("#campaigns-list",c).append(e);$("#campaigns-list",c).parent().find(".loading").remove();head.js(LIB_PATH+"lib/bootstrap-multiselect/bootstrap-multiselect.min.js",CSS_PATH+"css/bootstrap-multiselect/bootstrap-multiselect.css",function(){is_selected_all=false;$("#campaigns-list",c).multiselect({onInitialized:function(h,j){$(j).find("button").css({width:"252px"});$(j).find("span").addClass("pull-left");$(j).find("b.caret").addClass("pull-right m-t-sm")},nonSelectedText:"Select Campaign",selectAllValue:"ALL",includeSelectAllOption:true,maxHeight:125,disableIfEmpty:true,buttonText:function(h){if(h.length==0){return"Select Campaign"}return h.length+" selected"},onSelectAll:function(h){is_selected_all=h;unsubscribe_contact();return},onChange:function(h,j){if(!h){return}if(h.val()=="ALL"&&j){is_selected_all=true;unsubscribe_contact();return}is_selected_all=false;unsubscribe_contact()},onDropdownShow:function(j){var h=$(j.currentTarget).find(".dropdown-menu li label");h.css({width:"250px","white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis"})}});getCampaignContact(function(h){getTemplate("contact-detail-unsubscribe-campaigns-list",{},undefined,function(j){$("#unsubscribe-campaigns-list",c).html(j);$("div#contact-detail-resubscribe-modal .modal-body").html(c.find("form"));var k=$('[data-toggle="tooltip"]').tooltip();k.on("shown.bs.tooltip",function(){$(this).next(".tooltip").css({"padding-right":"2px"})})})});unsubscribe_contact();resubscribe(c)})},"<option value='{{id}}'>{{name}}</option>",true,c)});a.on("hidden.bs.modal",function(c){if(typeof unsubscribe_status_updated!="undefined"&&unsubscribe_status_updated){contact_details_tab.load_campaigns()}})},null)}function get_email_workflows(l){if(!l){return}var c={};for(var f=0,g=l.length;f<g;f++){var h=l[f];var k=JSON.parse(h.rules);var a=k.nodes;for(var e=0,b=a.length;e<b;e++){var d=a[e];if((d.NodeDefinition["name"]=="Send Email"||d.NodeDefinition["name"]=="Send E-mail")&&d.NodeDefinition["workflow_tasklet_class_name"]=="com.campaignio.tasklets.agile.SendEmail"){c[h.id]=h.name;break}}}return c}function getCampaignContact(a){if(!(App_Contacts.contactDetailView&&App_Contacts.contactDetailView.model)){return}if(CONTACT_ASSIGNED_TO_CAMPAIGN){CONTACT_ASSIGNED_TO_CAMPAIGN=false;$.ajax({type:"GET",url:"/core/api/contacts/"+App_Contacts.contactDetailView.model.get("id"),dataType:"json",success:function(b){App_Contacts.contactDetailView.model.set(b);a(b)}});return}a(App_Contacts.contactDetailView.model.toJSON())}function starify(a){head.js(LIB_PATH+"lib/jquery.raty.min.js",function(){var b=App_Contacts.contactDetailView.model;if(App_Contacts.contactDetailView.model.get("owner")&&!canEditContact(App_Contacts.contactDetailView.model.get("owner").id)){$("#star",a).raty({readOnly:true,score:App_Contacts.contactDetailView.model.get("star_value")});return}$("#star",a).raty({click:function(e,d){App_Contacts.contactDetailView.model.set({star_value:e},{silent:true});b=App_Contacts.contactDetailView.model.toJSON();var c=new Backbone.Model();c.url="core/api/contacts";c.save(b,{success:function(f){}})},score:b.get("star_value")})})}function checkContactUpdated(){var a=App_Contacts.contactDetailView.model;var d=a.id;var c=a.attributes.updated_time;queueGetRequest("contact_queue"+d,"/core/api/contacts/"+d+"/isUpdated?updated_time="+c,"",function e(g){if(g=="true"){var h=Backbone.Model.extend({url:function(){return"/core/api/contacts/"+d}});var f=new h();f.id=id;f.fetch({success:function(k){var j=a.attributes.updated_time;var l=f.attributes.updated_time;if(j!=l){App_Contacts.contactDetailView.model.set(f)}}});$("#refresh_contact").show()}},function b(f){})}function inlineCompanyNameChange(b){console.log("inlineCompanyNameChange");var a=$("#company-inline-input").val();companyname=a.trim();console.log(companyname);if(!companyname){$("#company-inline-input").addClass("error-inputfield");return}companyname=companyname.trim();if(agile_crm_is_model_property_changed("name",companyname)){agile_crm_update_contact("name",companyname)}$("#company-inline-input").addClass("hidden");$("#company-name-text").text(companyname).removeClass("hidden");$("#company-name-text").addClass("text-capitalize ");
$("#company-inline-input").removeClass("error-inputfield")}function inlineNameChange(c,b){var f=$("#Contact-input-firstname").val();var a=$("#Contact-input-lastname").val();firstName=f.trim();lastName=a.trim();if(!firstName){$("#Contact-input-firstname").addClass("error-inputfield");return}if(agile_crm_is_model_property_changed("first_name",firstName)){var d=App_Contacts.contactDetailView.model.toJSON().id;agile_crm_update_contact("first_name",firstName,function(e){if(d!=e.id){return}$("#Contact-input").addClass("hidden");$("#contactName").text(firstName+" "+lastName).removeClass("hidden");$("#contactName").addClass("text-capitalize ");$("#Contact-input-firstname").removeClass("error-inputfield");$("#Contact-input-lastname").removeClass("error-inputfield");return})}if(agile_crm_is_model_property_changed("last_name",lastName)){agile_crm_update_contact("last_name",lastName,function(e){if(d!=e.id){return}$("#Contact-input").addClass("hidden");$("#contactName").text(firstName+" "+lastName).removeClass("hidden");$("#contactName").addClass("text-capitalize ");$("#Contact-input-firstname").removeClass("error-inputfield");$("#Contact-input-lastname").removeClass("error-inputfield");return})}$("#Contact-input").addClass("hidden");$("#contactName").text(firstName+" "+lastName).removeClass("hidden");$("#contactName").addClass("text-capitalize ");$("#Contact-input-firstname").removeClass("error-inputfield");$("#Contact-input-lastname").removeClass("error-inputfield")}function fill_owners(b,c,d){var a="<li><a href='javascript:void(0)' class='contact-owner-list' data='{{id}}'>{{name}}</a></li>";if(company_util.isCompany()){a="<li><a href='javascript:void(0)' class='company-owner-list' data='{{id}}'>{{name}}</a></li>"}fillSelect("contact-detail-owner","/core/api/users/partial","domainUsers",d,a,true)}function show_owner(){$(".contact-owner-pic").css("visibility","visible");$("#contact-owner").css("display","inline-block")}function qr_load(){head.js(LIB_PATH+"lib/downloadify.min.js",LIB_PATH+"lib/swfobject.js",function(){Downloadify.create("downloadify",{filename:function(){return agile_crm_get_contact_property("first_name")+".vcf"},data:function(){return $("#qr_code").attr("data")},onError:function(){showAlertModal("download_error")},transparent:false,swf:"media/downloadify.swf",downloadImage:"img/download.png",width:36,height:30,transparent:true,append:false})})}function contact_detail_view_navigation(h,g,b){console.log("collection >>>>>>>>>>>>>>>>");console.log(d);var d=g.collection;var c=d.length;var f=d.indexOf(d.get(h));var a;var e;if(c<=f+5){g.infiniScroll.fetchNext()}if(c>1&&f<c&&d.at(f+1)&&d.at(f+1).has("id")){e=d.at(f+1).id}if(c>0&&f!=0&&d.at(f-1)&&d.at(f-1).has("id")){a=d.at(f-1).id}if(a!=null){$(".navigation",b).append('<a style="float:left;" href="#contact/'+a+'" class="" onclick="clearContactWidetQueues('+h+')"><i class="icon icon-chevron-left"></i></a>')}if(e!=null){$(".navigation",b).append('<a style="float:right;" href="#contact/'+e+'" class="" onclick="clearContactWidetQueues('+h+')"><i class="icon icon-chevron-right"></i></a>')}}function clearContactWidetQueues(a){if(!a||!document.ajaxq){return}queueClear("_widgets_"+a);queueClear("widgets_"+a);queueClear("widget_queue_"+a)}$(function(){$("body").on("mouseenter",".tooltip_info",function(a){$(this).tooltip({html:true});$(this).tooltip("show")});$("#score").children().attr("unselectable","on")});var Contact_Details_Model_Events=Base_Model_View.extend({events:{"click #change-owner-element>#contact-owner":"onChangeOwner","click .contact-owner-list":"onChangeOwnerSelected","click #change-owner-element>.contact-owner-add":"onAddContactOwner","click #contact-actions-delete":"onContactDetailsDelete","click .remove-tags":"onRemoveContactTag","click #add-tags":"onAddContactTag","click #contact-add-tags":"onAddContactTags","click #disable_map_view":"onDisableMapView","click #enable_map_view":"onEnableMapView","click #add":"onAddScore","click #minus":"onRemoveScore","click #lead-contactscore":"onGetScorebox","focusout #scorebox":"getScore","keyup  #scorebox":"scoreValEnter","click #lead-cscore":"onCompanyGetScorebox","focusout #cscorebox":"getCompanyScore","keyup  #cscorebox":"enterCompanyScore","click #cadd":"onCaddScore","click #cminus":"onCremoveScore","click .email-subject":"onEmailSubjectClick","click #show-page-views":"openPageViews","click .remove-active-campaign":"onRemoveCampaigns",'click #contactDetailsTab a[href="#timeline"]':"onTimeLineOpen",'click #contactDetailsTab a[href="#notes"]':"openNotes",'click #contactDetailsTab a[href="#events"]':"openEvents",'click #contactDetailsTab a[href="#documents"]':"openDocuments",'click #contactDetailsTab a[href="#tasks"]':"openTasks",'click #contactDetailsTab a[href="#deals"]':"openDeals",'click #contactDetailsTab a[href="#cases"]':"openCases",'click #contactDetailsTab a[href="#mail"]':"openMails",'click #contactDetailsTab a[href="#stats"]':"openWebStats",'click #contactDetailsTab a[href="#campaigns"]':"openCampaigns",'click #contactDetailsTab a[href="#tickets"]':"openTickets","click .agile-emails":"openEmails","click #email-reply":"repltToEmails","click .activity-delete":"deleteActivity","click #action_refresh_contact":"reloadContact","click .contact-add-task":"addTask","click .contact-add-event":"addEvent","click .contact-add-note":"addNote","click .contact-add-campaign,.add-to-campaign":"addToCampaign","click .task-edit-contact-tab":"editTask","click .event-edit-contact-tab":"editEvent","click .complete-task":"completeTask","click .contact-add-deal":"addDeal","click .deal-edit-contact-tab":"editDeal","click .contact-add-case":"addCase","click .cases-edit-contact-tab":"editCase","click .contact-add-contact":"addContact","click .contact-add-document":"addDocument","click .document-edit-contact-tab":"editDocument","click .document-unlink-contact-tab":"unlinkDocument","click .add-document-select":"listDocuments","click .add-document-cancel":"cancelDocuments","click .add-document-confirm":"addSelectedDocument","click #contacts-inner-tabs #next":"tabViewNext","click #contacts-inner-tabs #prev":"tabViewPrev","click #contactName":"togglehiddenfield","keydown #Contact-input-firstname":"contactNameChange","keydown  #Contact-input-lastname":"contactNameChange","blur #Contact-input":"contact_inline_edit",'click #contactDetailsTab a[href="#company-contacts"]':"listCompanyContacts",'click #contactDetailsTab a[href="#company-deals"]':"listCompanyDeals",'click #contactDetailsTab a[href="#company-cases"]':"listCompanyCases",'click #contactDetailsTab a[href="#company-notes"]':"listCompanyNotes",'click #contactDetailsTab a[href="#company-documents"]':"listCompanyDocuments",'click #contactDetailsTab a[href="#company-events"]':"listCompanyEvents",'click #contactDetailsTab a[href="#company-tasks"]':"listCompanyTasks",'click #contactDetailsTab a[href="#company-mail"]':"listCompanyMails","click #company-add-tags":"addCompanytags","keydown #companyAddTags":"companyAddTags","click #company-actions-delete":"companyDelete","click .company-owner-list":"companyOwnerList","click .remove-company-tags":"removeCmpanyTags","click #contact-actions-grid-delete":"contactActionsGridDelete","click #company-name-text ":"toggleinline_company","blur #company-Input input ":"companyInlineEdit","keydown #company-inline-input":"companyNameChange"},contact_inline_edit:function(a){console.log("harsha")},contactNameChange:function(a){if(a.keyCode==13){inlineNameChange(a)}},togglehiddenfield:function(a){$("#contactName").toggleClass("hidden");$("#Contact-input").toggleClass("hidden");console.log(this);if(!$("#Contact-input").hasClass("hidden")){$("#Contact-input-lastname").focus()}},companyNameChange:function(a){if(a.keyCode==13){inlineCompanyNameChange(a)}},toggleinline_company:function(a){$("#company-inline-input").toggleClass("hidden");$("#company-name-text").toggleClass("hidden");if(!$("#company-inline-input").hasClass("hidden")){$("#company-inline-input").focus()}},companyInlineEdit:function(a){inlineCompanyNameChange(a)},contactActionsGridDelete:function(c){c.preventDefault();var b=$(c.currentTarget).attr("con_id");var a=App_Contacts.contactsListView.collection.get(b);$("#deleteGridContactModal").modal("show");$("#deleteGridContactModal").on("shown.bs.modal",function(){$("#deleteGridContactModal").on("click","#delete_grid_contact_yes",function(d){d.preventDefault();$.ajax({url:"core/api/contacts/"+b,type:"DELETE",success:function(){$("#deleteGridContactModal").modal("hide");App_Contacts.contactsListView.collection.remove(a);if(App_Contacts.contact_custom_view){App_Contacts.contact_custom_view.collection.remove(a)}CONTACTS_HARD_RELOAD=true;App_Contacts.contacts()}})});$("#deleteGridContactModal").on("click","#delete_grid_contact_no",function(d){d.preventDefault();if($(this).attr("disabled")){return}$("#deleteGridContactModal").modal("hide")})})},reloadContact:function(c){var d=App_Contacts.contactDetailView.model.id;var b=Backbone.Model.extend({url:function(){return"/core/api/contacts/"+this.id}});var a=new b();a.id=d;a.fetch({success:function(e){App_Contacts.contactDetails(d,a);$("#refresh_contact").hide()}})},openEmails:function(c){c.preventDefault();var f=$(c.currentTarget);var a=$(f).attr("email-server");var b=$(f).attr("data-url");if(Current_Route&&Current_Route.indexOf("company/")==0){$("#email-type-select",App_Companies.companyDetailView.el).html($(f).html())}else{$("#email-type-select",App_Contacts.contactDetailView.el).html($(f).html())}email_server_type=$(f).attr("email-server-type");if(a&&b&&(a!="agile")){b=b.concat(email_server_type)}var d=email_server_type+"|"+a;save_email_server_type_in_cookie(d);if(Current_Route&&Current_Route.indexOf("company/")==0){company_detail_tab.load_company_mail(b,a)}else{contact_details_tab.load_mail(b,a)}},repltToEmails:function(a){a.preventDefault();Contact_Details_Tab_Actions.replyToEmail(a)},deleteActivity:function(a){a.preventDefault();Contact_Details_Tab_Actions.deleteActivity(a)},openMails:function(a){a.preventDefault();
email_server_type="agilecrm";save_contact_tab_position_in_cookie("mail");contact_details_tab.load_mail()},openWebStats:function(a){a.preventDefault();save_contact_tab_position_in_cookie("stats");contact_details_tab.load_stats()},openCampaigns:function(a){a.preventDefault();save_contact_tab_position_in_cookie("campaigns");contact_details_tab.load_campaigns()},openTickets:function(a){a.preventDefault();save_contact_tab_position_in_cookie("tickets");contact_details_tab.load_tickets()},openDeals:function(a){a.preventDefault();save_contact_tab_position_in_cookie("deals");contact_details_tab.load_deals()},openCases:function(a){a.preventDefault();save_contact_tab_position_in_cookie("cases");contact_details_tab.load_cases()},openTasks:function(a){a.preventDefault();save_contact_tab_position_in_cookie("tasks");contact_details_tab.load_tasks()},openDocuments:function(a){a.preventDefault();save_contact_tab_position_in_cookie("documents");contact_details_tab.load_documents()},onTimeLineOpen:function(a){a.preventDefault();Contact_Details_Tab_Actions.openTimeLine(a)},onEmailSubjectClick:function(a){a.preventDefault();Contact_Details_Tab_Actions.onEmailSubjectClick(a)},openPageViews:function(a){a.preventDefault();Contact_Details_Tab_Actions.showPageViews(a)},onRemoveCampaigns:function(a){a.preventDefault();Contact_Details_Tab_Actions.removeActiveCampaigns(a)},openNotes:function(a){a.preventDefault();Contact_Details_Tab_Actions.showNotes(a)},openEvents:function(a){a.preventDefault();Contact_Details_Tab_Actions.showEvents(a)},onChangeOwner:function(b){b.preventDefault();var c=$(b.currentTarget).attr("data");var a=_agile_get_translated_val("contact-details","no-perm-to-update");if(c!=CURRENT_DOMAIN_USER.id&&!hasScope("EDIT_CONTACT")){showModalConfirmation(_agile_get_translated_val("contact-details","owner-changed"),a,function(){return},function(){return},function(){},_agile_get_translated_val("contact-details","cancel"),"");return}fill_owners(undefined,undefined,function(){$("#contact-owner").css("display","none");$("#change-owner-ul").css("display","inline-block");if($("#change-owner-element > #change-owner-ul").css("display")=="inline-block"){$("#change-owner-element").find(".loading").remove()}})},onChangeOwnerSelected:function(f){f.preventDefault();var g=$(f.currentTarget);$("#change-owner-ul").css("display","none");var a=$(g).attr("data");var c=$(g).text();var d=$("#contact-owner").attr("data");if(a==d){show_owner();return}var b=new BaseModel();b.url="/core/api/contacts/change-owner/"+a+"/"+App_Contacts.contactDetailView.model.get("id");b.save(App_Contacts.contactDetailView.model.toJSON(),{success:function(e){$("#contact-owner").text(c);$("#contact-owner").attr("data",a);show_owner();App_Contacts.contactDetailView.model=e}})},onContactDetailsDelete:function(a){a.preventDefault();showAlertModal("delete_contact","confirm",function(){App_Contacts.contactDetailView.model.url="core/api/contacts/"+App_Contacts.contactDetailView.model.id;App_Contacts.contactDetailView.model.destroy({success:function(c,b){Backbone.history.navigate("contacts",{trigger:true})}})})},onRemoveContactTag:function(f){f.preventDefault();var g=$(f.currentTarget);var b=$(g).attr("tag");removeItemFromTimeline($("#"+b.replace(/ +/g,"")+"-tag-timeline-element",$("#timeline")).parent(".inner"));console.log($(g).closest("li").parent("ul").append(getRandomLoadingImg()));var c=App_Contacts.contactDetailView.model.toJSON();c=delete_contact_tag(c,b);var d=g;$(g).unbind("click");var a=new Backbone.Model();a.url="core/api/contacts";a.save(c,{success:function(e){$(d).closest("li").parent("ul").find(".loading").remove();$(d).closest("li").remove();App_Contacts.contactDetailView.model.set(e.toJSON(),{silent:true});$.ajax({url:"core/api/opportunity/based/tags?tag="+b,type:"GET",success:function(h){console.log(h);if(h=="fail"){$.ajax({url:"core/api/tags/"+b,type:"DELETE",success:function(){if(tagsCollection){tagsCollection.remove(tagsCollection.where({tag:b})[0])}}})}}})}})},onAddContactTag:function(a){a.preventDefault();$(a.currentTarget).css("display","none");$("#addTagsForm").css("display","block");$("#addTags").focus();setup_tags_typeahead()},onAddContactTags:function(c){c.preventDefault();var b=get_new_tags("addTags");if(b){b=b.trim()}if(!b||b.length<=0||(/^\s*$/).test(b)){console.log(b);return}if(!isValidTag(b,true)){return}$("#add-tags").css("display","block");$("#addTagsForm").css("display","none");console.log(b);if(b){var a=App_Contacts.contactDetailView.model.toJSON();$("#addTagsForm input").each(function(){$(c.currentTarget).val("")});if($.inArray(b,a.tags)>=0){return}acl_util.canAddTag(b.toString(),function(e){a.tagsWithTime.push({tag:b.toString()});var d=new Backbone.Model();d.url="core/api/contacts";d.save(a,{success:function(h){addTagToTimelineDynamically(b,h.get("tagsWithTime"));var f=[];$.each($("#added-tags-ul").children(),function(j,k){f.push($(k).attr("data"))});App_Contacts.contactDetailView.model.set(h.toJSON(),{silent:true});if($.inArray(b,f)==-1){var g=Handlebars.compile('<li  class="tag inline-block btn btn-xs btn-default m-r-xs m-b-xs" style="color:#363f44" data="{{name}}"><span><a class="anchor m-r-xs custom-color" style="color:#363f44" href="#tags/{{name}}" >{{name}}</a><a class="close remove-tags" id="{{name}}" tag="{{name}}">&times</a></span></li>');$("#added-tags-ul").append(g({name:b}));$.each(h.get("tagsWithTime"),function(j,k){if(k.tag==b){$("#added-tags-ul").find("li[data='"+b+"']").attr("title",epochToHumanDate("mmmm dd, yyyy 'at' hh:MM tt",k.createdTime))}})}console.log(b);tagsCollection.add(new BaseModel({tag:b}))},error:function(g,f){console.log(f);showAlertModal(f.responseText,undefined,undefined,undefined,"Error")}})})}},onAddContactOwner:function(a){a.preventDefault();fill_owners(undefined,undefined,function(){$(".contact-owner-add").css("display","none");$("#change-owner-ul").css("display","inline-block");$("#change-owner-ul").addClass("open");if($("#change-owner-element > #change-owner-ul").css("display")=="inline-block"){$("#change-owner-element").find(".loading").remove()}})},onDisableMapView:function(a){a.preventDefault();_agile_set_prefs("MAP_VIEW","disabled");$("#map").css("display","none");$("#contacts-local-time").hide();$("#map_view_action").html("<i class='icon-plus text-sm c-p' title='"+_agile_get_translated_val("contact-details","show-map")+"' id='enable_map_view'></i>")},onEnableMapView:function(a){a.preventDefault();_agile_set_prefs("MAP_VIEW","enabled");if(company_util.isCompany()){company_util.show_map()}else{show_map()}},onAddScore:function(d){d.preventDefault();var c=parseInt($("#lead-contactscore").text());c=c+1;$("#lead-contactscore").text(c);$("#lead-contactscore").attr("title",c);App_Contacts.contactDetailView.model.set({lead_score:c},{silent:true});var b=App_Contacts.contactDetailView.model.toJSON();var a=new Backbone.Model();a.url="core/api/contacts";a.save(b,{success:function(e){}})},scoreValEnter:function(a){a.preventDefault();if(a.keyCode==13){this.updateScoreValue()}},onGetScorebox:function(a){a.preventDefault();$("#scorebox").removeClass("hide");$("#lead-contactscore").addClass("hide");$("#scorebox").val($("#lead-contactscore").text());$("#scorebox").focus()},getScore:function(a){a.preventDefault();this.updateScoreValue()},enterCompanyScore:function(a){a.preventDefault();if(a.keyCode==13){this.updateCompanyScoreValue()}},onCompanyGetScorebox:function(a){a.preventDefault();$("#cscorebox").removeClass("hide");$("#lead-cscore").addClass("hide");$("#cscorebox").val($("#lead-cscore").text());$("#cscorebox").focus()},getCompanyScore:function(a){a.preventDefault();this.updateCompanyScoreValue()},onCaddScore:function(d){d.preventDefault();var c=parseInt($("#lead-cscore").text());c=c+1;$("#lead-cscore").text(c);App_Companies.companyDetailView.model.set({lead_score:c},{silent:true});var b=App_Companies.companyDetailView.model.toJSON();var a=new Backbone.Model();a.url="core/api/contacts";a.save(b,{success:function(e){}})},onRemoveScore:function(d){d.preventDefault();var c=parseInt($("#lead-contactscore").text());c=c-1;$("#lead-contactscore").text(c);$("#lead-contactscore").attr("title",c);App_Contacts.contactDetailView.model.set({lead_score:c},{silent:true});var b=App_Contacts.contactDetailView.model.toJSON();var a=new Backbone.Model();a.url="core/api/contacts";a.save(b,{success:function(e){}})},onCremoveScore:function(d){d.preventDefault();var c=parseInt($("#lead-cscore").text());if(c<=0){return}c=c-1;$("#lead-cscore").text(c);App_Companies.companyDetailView.model.set({lead_score:c},{silent:true});var b=App_Companies.companyDetailView.model.toJSON();var a=new Backbone.Model();a.url="core/api/contacts";a.save(b,{success:function(e){}})},addTask:function(a){a.preventDefault();contact_detail_tab_actions.add_task(a)},addEvent:function(a){a.preventDefault();contact_detail_tab_actions.add_event(a)},addNote:function(a){a.preventDefault();contact_detail_tab_actions.add_note(a)},addToCampaign:function(a){a.preventDefault();contact_detail_tab_actions.add_to_campaign(a)},editTask:function(a){a.preventDefault();contact_details_documentandtasks_actions.edit_task(a)},editEvent:function(a){a.preventDefault();contact_details_documentandtasks_actions.edit_event(a)},completeTask:function(a){a.preventDefault();contact_details_documentandtasks_actions.complete_task(a)},addDeal:function(a){a.preventDefault();contact_details_documentandtasks_actions.add_deal(a);setup_tags_typeahead()},editDeal:function(a){a.preventDefault();var b=$(a.currentTarget).attr("data");updateDeal(dealsView.collection.get(b))},addCase:function(a){a.preventDefault();contact_details_documentandtasks_actions.add_case(a)},editCase:function(a){a.preventDefault();var b=$(a.currentTarget).attr("data");updatecases(casesView.collection.get(b))},addContact:function(a){a.preventDefault();contact_details_documentandtasks_actions.add_contact(a)},addDocument:function(a){a.preventDefault();contact_details_documentandtasks_actions.add_document(a)},editDocument:function(a){a.preventDefault();
var b=$(a.currentTarget).attr("data");updateDocument(documentsView.collection.get(b))},unlinkDocument:function(a){a.preventDefault();contact_details_documentandtasks_actions.document_unlink(a)},listDocuments:function(a){a.preventDefault();contact_details_documentandtasks_actions.show_document_list(a)},cancelDocuments:function(b){b.preventDefault();var a=$("#documents");a.find(".contact-document-select").css("display","none");a.find(".add-document-select").css("display","inline-block")},addSelectedDocument:function(a){a.preventDefault();contact_details_documentandtasks_actions.add_selected_document(a)},tabViewNext:function(b){console.log("next clicked");var a=$("#contactDetailsTab");a.animate({scrollLeft:(a.scrollLeft()+270)},1000)},tabViewPrev:function(b){console.log("prev clicked");var a=$("#contactDetailsTab");a.animate({scrollLeft:(a.scrollLeft()-270)},1000)},listCompanyContacts:function(a){a.preventDefault();save_company_tab_position_in_cookie("contacts");fill_company_related_contacts(App_Companies.companyDetailView.model.id,"company-contacts")},listCompanyDeals:function(a){a.preventDefault();save_company_tab_position_in_cookie("deals");company_detail_tab.load_company_deals()},listCompanyCases:function(a){a.preventDefault();save_company_tab_position_in_cookie("cases");company_detail_tab.load_company_cases()},listCompanyNotes:function(a){a.preventDefault();save_company_tab_position_in_cookie("notes");company_detail_tab.load_company_notes()},listCompanyDocuments:function(a){a.preventDefault();save_company_tab_position_in_cookie("documents");company_detail_tab.load_company_documents()},listCompanyEvents:function(a){a.preventDefault();save_company_tab_position_in_cookie("events");company_detail_tab.load_company_events()},listCompanyTasks:function(a){a.preventDefault();save_company_tab_position_in_cookie("tasks");company_detail_tab.load_company_tasks()},listCompanyMails:function(a){a.preventDefault();email_server_type="agilecrm";save_company_tab_position_in_cookie("mail");company_detail_tab.load_company_mail()},addCompanytags:function(a){a.preventDefault();company_detail_tab.addTagsToCompany()},companyAddTags:function(a){if(a.which==13&&!isTagsTypeaheadActive){company_detail_tab.addTagsToCompany()}},companyDelete:function(a){a.preventDefault();company_detail_tab.deleteCurrentCompany()},companyOwnerList:function(a){var b=$(a.currentTarget);$("#change-owner-ul").css("display","none");company_detail_tab.changeOwner($(b))},removeCmpanyTags:function(f){f.preventDefault();var g=$(f.currentTarget);var b=$(g).attr("tag");console.log($(g).closest("li").parent("ul").append(getRandomLoadingImg()));var c=App_Companies.companyDetailView.model.toJSON();c=delete_contact_tag(c,b);var d=g;$(g).unbind("click");var a=new Backbone.Model();a.url="core/api/contacts";a.save(c,{success:function(e){$(d).closest("li").parent("ul").find(".loading").remove();$(d).closest("li").remove();App_Companies.companyDetailView.model.set(e.toJSON(),{silent:true});$.ajax({url:"core/api/opportunity/based/tags?tag="+b,type:"GET",success:function(h){console.log(h);if(h=="fail"){$.ajax({url:"core/api/tags/"+b,type:"DELETE",success:function(){if(tagsCollection){tagsCollection.remove(tagsCollection.where({tag:b})[0])}}})}}})}})},updateScoreValue:function(){var b=parseInt($("#scorebox").val());var d=$("#scorebox").val();var c=App_Contacts.contactDetailView.model.toJSON();var e=((c.lead_score)?c.lead_score:0);if((b!=e&&(d%1==0))||$("#scorebox").val()==""){if($("#scorebox").val()==""){b=0}App_Contacts.contactDetailView.model.set({lead_score:b},{silent:true});var c=App_Contacts.contactDetailView.model.toJSON();var a=new Backbone.Model();a.url="core/api/contacts";a.save(c,{success:function(f){}})}if(isNaN(b)||b!=decemialcheck){showAlertModal("number_validation",undefined,function(){b=e;setleadScoreStyles(b)});return}else{if(b==e){b=e}}setleadScoreStyles(b)},updateCompanyScoreValue:function(){var b=parseInt($("#cscorebox").val());var d=$("#cscorebox").val();var c=App_Companies.companyDetailView.model.toJSON();var e=((c.lead_score)?c.lead_score:0);if((b!=e&&(d%1==0)&&(b>=0))||$("#cscorebox").val()==""){if($("#cscorebox").val()==""){b=0}App_Companies.companyDetailView.model.set({lead_score:b},{silent:true});var c=App_Companies.companyDetailView.model.toJSON();var a=new Backbone.Model();a.url="core/api/contacts";a.save(c,{success:function(f){}})}if(isNaN(b)||b!=decemialcheck||(b<0)){showAlertModal("number_validation",undefined,function(){b=e;setleadScoreStyles(b)});return}else{if(b==e){b=e}}setleadScoreStyles(b)}});$(function(){$("body").on("mouseenter","#element",function(a){a.preventDefault();$(this).popover({template:'<div class="popover" style="width:400px"><div class="arrow"></div><div class="popover-inner"><div class="popover-content"><p></p></div></div></div>'});$(this).popover("show")});$("body").on("mouseenter","#element-title",function(a){a.preventDefault();$(this).popover("show")})});function checkCompanyUpdated(){var a=App_Companies.companyDetailView.model;var d=a.id;var c=a.attributes.updated_time;queueGetRequest("contact_queue"+d,"/core/api/contacts/"+d+"/isUpdated?updated_time="+c,"",function e(g){if(g=="true"){var h=Backbone.Model.extend({url:function(){return"/core/api/contacts/"+d}});var f=new h();f.id=id;f.fetch({success:function(k){var j=a.attributes.updated_time;var l=f.attributes.updated_time;if(j!=l){App_Companies.companyDetailView.model.set(f)}}});$("#refresh_contact").show()}},function b(f){})}function epochToHumanDate(c,a){if(!c){c="mmm dd yyyy HH:MM:ss"}if(!a){return}if((a/100000000000)>1){console.log(new Date(parseInt(a)).format(c));return new Date(parseInt(a)).format(c,0)}var e="";try{e=new Date(parseInt(a)*1000).format(c)}catch(b){console.log("Invalid date for custom field.")}return e}function setleadScoreStyles(a){$("#lead-score").attr("data-original-title",a);$("#lead-score").text(a).removeClass("hide");$("#scorebox").addClass("hide").val(a);$("#lead-score").attr("title",a)}(function(c,a,b){c.isCompany=function(){if(App_Companies.companyDetailView&&Current_Route=="company/"+App_Companies.companyDetailView.model.get("id")){return true}if(App_Companies.companies&&Current_Route=="companies"){return true}if(Current_Route&&Current_Route.indexOf("company")>-1){return true}return false};c.updateDocumentsList=function(d,e){a.each(d.contacts,function(g,f){if(f.id==App_Companies.companyDetailView.model.get("id")){if(documentsView&&documentsView.collection){if(documentsView.collection.get(d.id)){documentsView.collection.get(d.id).set(new BaseModel(d))}else{documentsView.collection.add(new BaseModel(d),{sort:false});documentsView.collection.sort()}}return false}})};c.updateCasesList=function(e,d){if(casesView&&casesView.collection){if(casesView.collection.get(e.id)){casesView.collection.get(e.id).set(new BaseModel(e))}else{casesView.collection.add(new BaseModel(e),{sort:false});casesView.collection.sort()}}};c.updateDealsList=function(h,e,f){var g=App_Companies.companyDetailView.model.toJSON();var d=h.owner_id;if(!d){d=h.owner.id}a.each(h.contacts,function(k,j){if(j.id==g.id){if(hasScope("VIEW_DEALS")||CURRENT_DOMAIN_USER.id==d){if(dealsView&&dealsView.collection){if(h.archived==true){dealsView.collection.remove(h.id);dealsView.collection.sort()}else{if(dealsView.collection.get(h.id)){dealsView.collection.get(h.id).set(new BaseModel(h));a("#"+h.id).closest("li").removeAttr("class");a("#"+h.id).closest("li").addClass("deal-color");a("#"+h.id).closest("li").addClass(h.colorName)}else{dealsView.collection.add(new BaseModel(h),{sort:false});dealsView.collection.sort()}}}}if(!hasScope("VIEW_DEALS")&&CURRENT_DOMAIN_USER.id!=d&&f){dealsView.collection.remove(h.id);dealsView.collection.sort()}return false}})};c.displayGoogleMap=function(d){if(d==b){d=App_Companies.companyDetailView.model.toJSON()}var e=JSON.parse(getPropertyValue(d.properties,"address"));var f=new google.maps.Geocoder();if(!e.address){e.address=""}if(!e.city){e.city=""}if(!e.state){e.state=""}if(!e.country){e.country=""}if(!e.zip){e.zip=""}f.geocode({address:'"'+e.city+", "+e.state+", "+getNormalCountryNameFromShortName(e.country)+", "+e.zip+'"'},function(k,j){if(j==google.maps.GeocoderStatus.OK){console.log(k);displayTimeZone(k);a("#map").css("display","block");var h={zoom:4,center:k[0].geometry.location,mapTypeId:google.maps.MapTypeId.ROADMAP};var l=new google.maps.Map(document.getElementById("map"),h);var g=new google.maps.Marker({map:l,position:k[0].geometry.location})}})};c.agile_crm_get_company_properties_list=function(d){var g=App_Companies.companyDetailView.model;var f=g.get("properties");var e=[];a.each(f,function(h,j){if(j.name==d){e.push(j)}});return e};c.show_map=function(h){var e=App_Companies.companyDetailView.model.toJSON();var d=getPropertyValue(e.properties,"address");if(!d){return}try{d=JSON.parse(d)}catch(j){return}if(!d.address&&!d.city&&!d.state&&!d.country){return}var g=_agile_get_prefs("MAP_VIEW");if(g=="disabled"){a("#map_view_action",h).html("<i class='icon-plus text-sm c-p' title='"+_agile_get_translated_val("contact-details","show-map")+"' id='enable_map_view'></i>");return}try{if(google.maps){displayGoogleMap(e)}}catch(j){var f=document.createElement("script");f.type="text/javascript";f.src="https://maps.googleapis.com/maps/api/js?&sensor=false&callback=company_util.displayGoogleMap";document.body.appendChild(f)}};c.starify=function(d){head.js(LIB_PATH+"lib/jquery.raty.min.js",function(){var e=App_Companies.companyDetailView.model;if(App_Companies.companyDetailView.model.get("owner")&&!canEditContact(App_Companies.companyDetailView.model.get("owner").id)){a("#star",d).raty({readOnly:true,score:App_Companies.companyDetailView.model.get("star_value")});return}a("#star",d).raty({click:function(h,g){App_Companies.companyDetailView.model.set({star_value:h},{silent:true});e=App_Companies.companyDetailView.model.toJSON();var f=new Backbone.Model();f.url="core/api/contacts";f.save(e,{success:function(j){}})},score:e.get("star_value")})})}}(window.company_util=window.company_util||{},$));
(function(g,d,f){function c(j,h){getTemplate("company-view-collection",{},f,function(l){if(!l){return}var k=d(l);d("#view-list",j).html(k);e(d("#view-list",j))},d("#view-list",j))}var e=function(k){var h=_agile_get_prefs("company_sort_field");if(h&&h!=null){var l="-asc";if(h.indexOf("-")==0){h=h.substring(1);l="-desc"}var j="comp-sort-by-"+h+l;d(k).find("#"+j).addClass("bold-text")}};var b;var a=function(h,j){if(j){d(".filter-criteria",h).html('<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li  class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="m-l-xs pull-left">'+decodeURI(j)+'</span><a class="close default_contact_remove_tag m-l-xs pull-left">&times</a></li></ul>').attr("_filter",j)}setTimeout(function(){var l=null;App_Companies.companyFiltersListView=new Base_Collection_View({url:"/core/api/filters?type=COMPANY",sort_collection:false,restKey:"ContactFilter",templateKey:"company-filter-list",individual_tag_name:"li",sort_collection:false,no_transition_bar:true,postRenderCallback:function(n){contactFiltersListeners("lhs_filters_conatiner");var o;if(o=_agile_get_prefs("company_filter")){l=o;if(App_Companies.companyFiltersListView.collection.get(o)){o=App_Companies.companyFiltersListView.collection.get(o).toJSON().name}n.find(".filter-dropdown").append(Handlebars.compile("{{name}}")({name:o}))}if(!o){return}var m=Handlebars.compile('<ul id="added-tags-ul" class="tagsinput p-n m-b-sm m-t-sm m-l-sm"><li class="inline-block tag btn btn-xs btn-primary" data="developer"><span class="inline-block m-r-xs v-middle">{{name}}</span><a class="close default_company_filter">&times</a></li></ul>');d(".filter-criteria",h).html(m({name:o}));if(l){d(".filter-criteria",h).attr("_filter",l)}else{d(".filter-criteria",h).attr("_filter",o)}}});App_Companies.companyFiltersListView.collection.fetch();var k=App_Companies.companyFiltersListView.render().el;d("#filter-list",h).html(App_Companies.companyFiltersListView.render().el)},500)};g.revertToDefaultCompanies=function(){_agile_delete_prefs("company_filter");_agile_delete_prefs("dynamic_company_filter");COMPANIES_HARD_RELOAD=true;companies_view_loader.getCompanies(App_Companies.companyViewModel,d("#companies-listener-container"))};g.init=function(h){a(h);c(h)}}(window.company_list_view=window.company_list_view||{},$));(function(l,h,f){l.activateCurrentTab=function(q){h("#contact-tab-content .tab-pane").removeClass("active");q.addClass("active")};l.changeOwner=function(u){var q=u.attr("data");var s=u.text();var t=h("#contact-owner").attr("data");if(q==t){show_owner();return}var r=new BaseModel();r.url="/core/api/contacts/change-owner/"+q+"/"+App_Companies.companyDetailView.model.get("id");r.save(App_Companies.companyDetailView.model.toJSON(),{success:function(v){h("#contact-owner").text(s);h("#contact-owner").attr("data",q);show_owner();App_Companies.companyDetailView.model=v}})};l.deleteCurrentCompany=function(){showAlertModal("delete_company","confirm",function(){App_Companies.companyDetailView.model.url="core/api/contacts/"+App_Companies.companyDetailView.model.id;App_Companies.companyDetailView.model.destroy({success:function(r,q){Backbone.history.navigate("companies",{trigger:true})}})})};l.addTagsToCompany=function(){var r=get_new_tags("companyAddTags");if(r){r=r.trim()}if(!r||r.length<=0||(/^\s*$/).test(r)){console.log(r);return}if(!isValidTag(r,true)){return}h("#add-tags").css("display","block");h("#addTagsForm").css("display","none");console.log(r);if(r){var q=App_Companies.companyDetailView.model.toJSON();h("#addTagsForm input").each(function(){h(this).val("")});if(h.inArray(r,q.tags)>=0){return}acl_util.canAddTag(r.toString(),function(t){q.tagsWithTime.push({tag:r.toString()});var s=new Backbone.Model();s.url="core/api/contacts";s.save(q,{success:function(w){addTagToTimelineDynamically(r,w.get("tagsWithTime"));var u=[];h.each(h("#added-tags-ul").children(),function(x,y){u.push(h(y).attr("data"))});App_Companies.companyDetailView.model.set(w.toJSON(),{silent:true});if(h.inArray(r,u)==-1){var v=Handlebars.compile('<li  class="tag inline-block btn btn-xs btn-default m-r-xs" style="color:#363f44" data="{{name}}"><span><a class="anchor m-r-xs custom-color" style="color:#363f44" href="#tags/{{name}}" >{{name}}</a><a class="close remove-company-tags" id="{{name}}" tag="{{name}}">&times</a></span></li>');h("#added-tags-ul").append(v({name:r}));h.each(w.get("tagsWithTime"),function(x,y){if(y.tag==r){h("#added-tags-ul").find("li[data='"+r+"']").attr("title",epochToHumanDate("mmmm dd, yyyy 'at' hh:MM tt",y.createdTime))}})}console.log(r);tagsCollection.add(new BaseModel({tag:r}))}})})}};l.load_company_deals=function(){id=App_Companies.companyDetailView.model.id;dealsView=new Base_Collection_View({url:"core/api/contacts/"+id+"/deals",restKey:"opportunity",templateKey:"deals",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(q){agileTimeAgoWithLngConversion(h(".deal-created-time",q));h(q).find("ul li").each(function(){h(this).addClass("deal-color");h(this).addClass(h(this).find("input").attr("class"))})}});dealsView.collection.fetch();h("#company-deals",App_Companies.companyDetailView.el).html(dealsView.el);l.activateCurrentTab(h("#company-deals"))};l.load_company_cases=function(){id=App_Companies.companyDetailView.model.id;casesView=new Base_Collection_View({url:"core/api/contacts/"+id+"/cases",restKey:"cases",templateKey:"cases-contact",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(q){agileTimeAgoWithLngConversion(h(".deal-created-time",q))}});casesView.collection.fetch();h("#company-cases",App_Companies.companyDetailView.el).html(casesView.el);l.activateCurrentTab(h("#company-cases"))};l.load_company_notes=function(){var q=App_Companies.companyDetailView.model.id;notesView=new Base_Collection_View({url:"/core/api/contacts/"+q+"/notes",restKey:"note",templateKey:"notes",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(r){agileTimeAgoWithLngConversion(h(".note-created-time",r));j(h("#infinite-scroller-company-details",App_Companies.companyDetailView.el),notesView)},appendItemCallback:function(r){includeTimeAgo(r)}});notesView.collection.fetch();h("#company-notes",App_Companies.companyDetailView.el).html(notesView.render().el);l.activateCurrentTab(h("#company-notes"))};l.load_company_documents=function(){id=App_Companies.companyDetailView.model.id;documentsView=new Base_Collection_View({url:"/core/api/documents/contact/"+id+"/docs",restKey:"document",templateKey:"contact-documents",individual_tag_name:"li",sortKey:"uploaded_time",descending:true,postRenderCallback:function(q){agileTimeAgoWithLngConversion(h(".document-created-time",q))}});documentsView.collection.fetch();h("#company-documents",App_Companies.companyDetailView.el).html(documentsView.render().el);l.activateCurrentTab(h("#company-documents"))};l.load_company_events=function(){id=App_Companies.companyDetailView.model.id;eventsView=new Base_Collection_View({url:"/core/api/contacts/"+id+"/events",restKey:"event",templateKey:"contact-events",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(q){agileTimeAgoWithLngConversion(h(".event-created-time",q));h("li",q).each(function(){if(h(this).find(".priority_type").text().trim()=="High"){h(this).css("border-left","3px solid #f05050")}else{if(h(this).find(".priority_type").text().trim()=="Normal"){h(this).css("border-left","3px solid #7266ba")}else{if(h(this).find(".priority_type").text().trim()=="Low"){h(this).css("border-left","3px solid #fad733")}}}})}});eventsView.collection.fetch();h("#company-events",App_Companies.companyDetailView.el).html(eventsView.render().el);l.activateCurrentTab(h("#company-events"))};l.load_company_tasks=function(){id=App_Companies.companyDetailView.model.id;tasksView=new Base_Collection_View({url:"/core/api/contacts/"+id+"/tasks",restKey:"task",templateKey:"contact-tasks",individual_tag_name:"li",sortKey:"created_time",descending:true,postRenderCallback:function(q){agileTimeAgoWithLngConversion(h(".task-created-time",q));h("li",q).each(function(){if(h(this).find(".priority_type").text().trim()=="HIGH"){h(this).css("border-left","3px solid #f05050")}else{if(h(this).find(".priority_type").text().trim()=="NORMAL"){h(this).css("border-left","3px solid #7266ba")}else{if(h(this).find(".priority_type").text().trim()=="LOW"){h(this).css("border-left","3px solid #fad733")}}}})}});tasksView.collection.fetch();h("#company-tasks",App_Companies.companyDetailView.el).html(tasksView.render().el);l.activateCurrentTab(h("#company-tasks"))};l.load_company_mail=function(w,v){k();h("#company-mail #company-mails-span",App_Companies.companyDetailView.el).remove();h("#company-mails",App_Companies.companyDetailView.el).html("");if(typeof mailsView!=="undefined"){mailsView.render=null;mailsView.collection=null}var t=App_Companies.companyDetailView.model;var x=t.toJSON();var u=getAllPropertyValuesByName(x.properties,"email",",");if(!u){o();return}var r=this;var y=true;var q=true;if(v&&w){if(h("#has_email_configured",App_Companies.companyDetailView.el).html()==="true"){y=true}else{y=false}if(v!=="all"){g(r,y,w,v,u)}else{var s=mailAccountsView_company.model.toJSON();e(r,y,s,u)}}else{m(r,v,w,u)}};function m(s,v,x,u){var y=true;var r=true;var t="";var w="";var q="";mailAccountsView_company=new Base_Model_View({url:"core/api/emails/synced-accounts",template:"email-company-account-types",change:false,postRenderCallback:function(A){t=mailAccountsView_company.model.toJSON();if(t.hasEmailAccountsConfigured){y=true}else{y=false}if(t.hasSharedEmailAccounts){r=true}else{r=false}var z=c(t);if(z&&z.length==4){x=z[0];w=z[1];v=z[2];q=z[3];if(q){email_server_type=q}}if(!v||!x||!q||(!y&&!r)){v="agile";w='<i class="icon-cloud" style="margin-right:4px;font-size: 1.2em"></i>Agile';email_server_type="agilecrm"}if(v==="all"||x==="all"){e(s,y,t,u)}else{g(s,y,x,v,u)}if(y||r){if(w){h("#email-type-select",App_Companies.companyDetailView.el).html(w)
}h("#company-mail-account-types",App_Companies.companyDetailView.el).css("display","block")}}});h("#company-mail-account-types",App_Companies.companyDetailView.el).html(mailAccountsView_company.render().el)}function g(t,s,v,q,r){h("#company-mail",App_Companies.companyDetailView.el).append('<span id="company-mails-span"> <img class="mails-loading p-r-xs m-b m-l-sm pull-left"  src= "'+updateImageS3Path("/img/ajax-loader-cursor.gif")+'"></img></span>');this.configured_sync_email="";var u=true;if(q==="agile"){v="core/api/emails/agile-cemails?search_email="+encodeURIComponent(r);email_server_type="agilecrm";u=false}else{v=v+"&search_email="+encodeURIComponent(r)}mailsView=new Base_Collection_View({url:v,cursor:u,page_size:10,templateKey:"email-social-company",sort_collection:true,sortKey:"date_secs",descending:true,individual_tag_name:"li",postRenderCallback:function(w){h("#company-mail",App_Companies.companyDetailView.el).find("#no-email").css("display","block");agileTimeAgoWithLngConversion(h(".email-sent-time",w));if(email_server_type!="agilecrm"){t.configured_sync_email=email_server_type}if(!s){h("#email-prefs-verification",App_Companies.companyDetailView.el).css("display","block")}j(h("#infinite-scroller-company-details",App_Companies.companyDetailView.el),mailsView);h("#company-mail #company-mails-span",App_Companies.companyDetailView.el).remove()}});mailsView.collection.fetch();h("#company-mails",App_Companies.companyDetailView.el).html(mailsView.render().el)}function e(v,t,u,s){var r=[];var q=u.fetchUrls;h("#contact-dtl",App_Companies.companyDetailView.el).unbind("scroll");b(v,t,r);p(v,t,q,s)}function p(v,s,q,r){var u=0;if(q){if(q.length>0){h("#company-mail-account-types",App_Companies.companyDetailView.el).prepend('<span id="company-mails-span"> <img class="all-mails-loading p-r-xs m-b m-l-sm pull-left"  src= "'+updateImageS3Path("/img/ajax-loader-cursor.gif")+'"></img></span>');h("#company-mail-account-types",App_Companies.companyDetailView.el).find(".all-mails-loading").css("display","block")}for(var t=0;t<q.length;t++){var w=h.ajax({url:q[t]+"&search_email="+encodeURIComponent(r),success:function(x){u++;if(x){if(a(x[0])){if(!mailsView){setTimeout(function(){mailsView.collection.add(x);mailsView.render(true);showTransitionBar()},5000)}else{mailsView.collection.add(x);mailsView.render(true)}}if(u===q.length){d()}}},error:function(x){u++;if(u===q.length){d(x)}}});email_requests.push(w)}}}function b(s,r,q){if(typeof mailsView!=="undefined"){mailsView.render=null;mailsView=null}this.configured_sync_email="";mailsView=new Base_Collection_View({data:q,templateKey:"email-social-company",sort_collection:true,sortKey:"date_secs",descending:true,individual_tag_name:"li",postRenderCallback:function(t){agileTimeAgoWithLngConversion(h(".email-sent-time",t));if(email_server_type!="agilecrm"){s.configured_sync_email=email_server_type}if(!r){h("#email-prefs-verification",App_Companies.companyDetailView.el).css("display","block")}}});h("#company-mails",App_Companies.companyDetailView.el).html(mailsView.render(true).el)}function c(v){var t=_agile_get_prefs(email_server_type_cookie_name);var z="";var w=[];if(t){var C=t.split("|");if(C){if(C.length===2){var y=C[0];var A=C[1];var u="";var q=false;if(y&&A){if(A.toLowerCase()==="all"){w[0]="all";w[1]="All Mail";w[2]="all";w[3]="all"}else{if(A.toLowerCase()==="google"){var x=false;if(typeof v.gmailUserNames!=="undefined"&&v.hasOwnProperty("gmailUserNames")){for(var s=0;s<v.gmailUserNames.length;s++){if(v.gmailUserNames[s]===y){x=true;break}}}if(typeof v.sharedGmailUserNames!=="undefined"&&v.hasOwnProperty("sharedGmailUserNames")){for(var s=0;s<v.sharedGmailUserNames.length;s++){if(v.sharedGmailUserNames[s]===y){x=true;q=true;break}}}if(x){z="core/api/social-prefs/google-emails?from_email="+y;u='<i class="icon-google-plus" style="margin-right:4px;font-size: 1.2em"></i>'+y;if(q){u=u+" ("+_agile_get_translated_val("contact-details","shared")+")"}}}else{if(A.toLowerCase()==="imap"){var r=false;if(typeof v.imapUserNames!=="undefined"&&v.hasOwnProperty("imapUserNames")){for(var s=0;s<v.imapUserNames.length;s++){if(v.imapUserNames[s]===y){r=true;break}}}if(typeof v.sharedImapUserNames!=="undefined"&&v.hasOwnProperty("sharedImapUserNames")){for(var s=0;s<v.sharedImapUserNames.length;s++){if(v.sharedImapUserNames[s]===y){r=true;q=true;break}}}if(r){z="core/api/imap/imap-emails?from_email="+y;u='<i class="icon-envelope-alt" style="margin-right:4px;font-size: 1.2em"></i>'+y;if(q){u=u+" ("+_agile_get_translated_val("contact-details","shared")+")"}}}else{if(A.toLowerCase()==="exchange"){var B=false;if(typeof v.exchangeUserNames!=="undefined"&&v.hasOwnProperty("exchangeUserNames")){for(var s=0;s<v.exchangeUserNames.length;s++){if(v.exchangeUserNames[s]===y){B=true;break}}}if(typeof v.sharedExchangeUserNames!=="undefined"&&v.hasOwnProperty("sharedExchangeUserNames")){for(var s=0;s<v.sharedExchangeUserNames.length;s++){if(v.sharedExchangeUserNames[s]===y){B=true;q=true;break}}}if(B){z="core/api/office/office365-emails?from_email="+y;u='<i class="icon-windows" style="margin-right:4px;font-size: 1.2em"></i>'+y;if(q){u=u+" ("+_agile_get_translated_val("contact-details","shared")+")"}}}}}}if(z){w[0]=z;w[1]=u;w[2]=A;w[3]=y}}}}}return w}function j(r,q){console.log("initialize_infinite_scrollbar",r);r.unbind("scroll");if(r==f||r==null){console.log("no elmnt");return}console.log(q);q.infiniScroll=new Backbone.InfiniScroll(q.collection,{target:r,untilAttr:"cursor",param:"cursor",strict:false,pageSize:q.page_size,success:function(t,s){console.log("in success");if(!t.last().get("cursor")){this.strict=true;q.infiniScroll.disableFetch()}h(q.infiniScroll.options.target).find(".scroll-loading").remove()},onFetch:function(){console.log("in fetch");h(q.infiniScroll.options.target).append('<div class="scroll-loading"> <img src="'+updateImageS3Path("/img/ajax-loader-cursor.gif")+'" style="margin-left: 44%;"> </div>')}})}function d(){n();if(mailsView.collection.length>20){if((h("#all-emails-info",App_Companies.companyDetailView.el).length===0)){h("#company-mails",App_Companies.companyDetailView.el).append('<div id="all-emails-info" class="alert alert-info">'+_agile_get_translated_val("mails","show-mails-error")+" </div>")}}h("#company-mail-account-types",App_Companies.companyDetailView.el).find(".all-mails-loading").remove();h("#company-mail",App_Companies.companyDetailView.el).find("#no-email").css("display","block")}function n(){for(var q=0;q<email_errors_divs.length;q++){h("#company-mails",App_Companies.companyDetailView.el).prepend(email_errors_divs[q])}email_errors_divs=[]}function a(r){if(r&&"errormssg" in r&&"owner_email" in r){var q='<div class="alert alert-danger" > <a href="#" class="close" data-dismiss="alert">&times;</a><span class="text-dark">Unable to fetch emails from account "'+r.owner_email+'" Error:'+r.errormssg+"</span>";email_errors_divs.push(q);return false}return true}function k(){for(var q=0;q<email_requests.length;q++){var r=email_requests[q];r.abort()}email_requests=[]}function o(){h("#company-mail",App_Companies.companyDetailView.el).html('<div class="alert alert-danger m-t-sm m-sm"><a class="close" data-dismiss="alert" href="#">&times;</a>'+_agile_get_translated_val("mails","mo-mails-error")+"</div>")}}(window.company_detail_tab=window.company_detail_tab||{},$));function updateFormsDB(){if(CURRENT_DOMAIN_USER.is_forms_updated){return}$.getJSON("/core/api/forms",{},function(c){var a=0;for(var b=0;b<c.length;b++){if(!c[b].formHtml){a++;createIframe(c[b].id)}}console.log("No. of old forms : "+a);if(a==0){$.get("/core/api/users/formsupdated",{},function(d){console.log("All forms are updated.")})}})}function createIframe(b){var a=document.createElement("iframe");a.style.display="none";a.src="form.jsp?id="+b;document.body.appendChild(a)}function updateAgileFormDB(a){$.ajax({type:"POST",url:"core/api/forms",async:true,contentType:"application/json",data:JSON.stringify(a),success:function(){}})}$(function(){updateFormsDB()});var IPCHECK=["183.83.0.113","117.247.178.90","117.247.109.22","117.247.109.20"];function check_login_instance(b){current_user_id=get_current_user_id();console.log(b);if(b.id&&b.id==current_user_id){JSESSIONID=readCookie("JSESSIONID");console.log(JSESSIONID);session_id_in_message=b.session_id;var c=b.CURRENTIP;var a=b.LOGIN_FROM_PANEL;if(session_id_in_message==JSESSIONID){return}if($.inArray(CURRENTIP,IPCHECK)!=-1&&LOGIN_FROM_PANEL=="true"){return}if(c!=undefined&&a!=undefined&&$.inArray(c,IPCHECK)!=-1&&a=="true"){return}if(b.login_time<get_current_user_loggedin_time()){return}if(agile_is_mobile_browser()){return}b.email=get_current_user_email();createCookie("_multiple_login",JSON.stringify(b),0.0025);window.location="/login?ml=true"}}function get_current_user_loggedin_time(){var a=CURRENT_DOMAIN_USER.info_json_string;a=JSON.parse(a);return a.logged_in_time}function get_current_user_id(){return CURRENT_DOMAIN_USER.id}function get_current_user_email(){return CURRENT_DOMAIN_USER.email}function publishLoginEvent(b){if(agile_is_mobile_browser()){return}var a={};a.type="LOGIN_INSTANCE";a.id=CURRENT_DOMAIN_USER.id;a.session_id=readCookie("JSESSIONID");a.login_time=get_current_user_loggedin_time();a.userAgent=getBrowserDetails();a.CURRENTIP=CURRENTIP;a.LOGIN_FROM_PANEL=LOGIN_FROM_PANEL;console.log(getBrowserDetails());b.publish({channel:CURRENT_DOMAIN_USER.domain,message:a,callback:function(c){console.log(c)}})}function getBrowserDetails(){var h=navigator.appVersion;var e=navigator.userAgent;var f=navigator.appName;var g=""+parseFloat(navigator.appVersion);var c=parseInt(navigator.appVersion,10);var j,a,b;if((a=e.indexOf("Opera"))!=-1){f="Opera";g=e.substring(a+6);if((a=e.indexOf("Version"))!=-1){g=e.substring(a+8)}}else{if((a=e.indexOf("MSIE"))!=-1){f="Microsoft Internet Explorer";g=e.substring(a+5)}else{if((a=e.indexOf("Chrome"))!=-1){f="Chrome";g=e.substring(a+7)}else{if((a=e.indexOf("Safari"))!=-1){f="Safari";g=e.substring(a+7);if((a=e.indexOf("Version"))!=-1){g=e.substring(a+8)
}}else{if((a=e.indexOf("Firefox"))!=-1){f="Firefox";g=e.substring(a+8)}else{if((j=e.lastIndexOf(" ")+1)<(a=e.lastIndexOf("/"))){f=e.substring(j,a);g=e.substring(a+1);if(f.toLowerCase()==f.toUpperCase()){f=navigator.appName}}}}}}}if((b=g.indexOf(";"))!=-1){g=g.substring(0,b)}if((b=g.indexOf(" "))!=-1){g=g.substring(0,b)}c=parseInt(""+g,10);if(isNaN(c)){g=""+parseFloat(navigator.appVersion);c=parseInt(navigator.appVersion,10)}var d="Unknown OS";if(navigator.appVersion.indexOf("Win")!=-1){d="Windows"}if(navigator.appVersion.indexOf("Mac")!=-1){d="MacOS"}if(navigator.appVersion.indexOf("X11")!=-1){d="UNIX"}if(navigator.appVersion.indexOf("Linux")!=-1){d="Linux"}var k={};k.browser_name=f;k.full_version=g;k.major_version=c;k.app_name=navigator.appName;k["navigator.userAgent"]=navigator.userAgent;k.OSName=d;return k}var account_stats_integrations={loadAccountStats:function(a){$.ajax({url:"core/api/namespace-stats/getdomainstats",type:"GET",success:function(b){console.log(b);getTemplate("account-stats-new",b,undefined,function(c){if(!c){return}$(a).find("#account-stats-new").html($(c))},$(a).find("#account-stats-new"))},error:function(b){console.log("error");console.log(b)}})},loadEmailStats:function(a){$.ajax({url:"core/api/emails/email-stats",type:"GET",success:function(b){console.log(b);getTemplate("email-stats-new",b,undefined,function(c){if(!c){return}$(a).find("#email-stats-new").html($(c))},$(a).find("#email-stats-new"))},error:function(b){console.log("error");console.log(b)}})},loadSMSStats:function(a){$.ajax({url:"core/api/sms-gateway/SMSlogs",type:"GET",success:function(b){console.log(b);if(b){b=JSON.parse(b)}getTemplate("sms-stats-new",b,undefined,function(c){if(!c){return}$(a).find("#sms-stats-new").html($(c))},$(a).find("#sms-stats-new"))},error:function(b){console.log("error");console.log(b)}})},loadSyncTab:function(a){getTemplate("sync-stats-new",{},undefined,function(b){if(!b){return}$(a).find("#sync-stats-new").html($(b))},$(a).find("#sync-stats-new"))}};function initializeStatsListners(a){$('#email-stats-listners a[href="#account-stats-new"]').on("click",function(b){b.preventDefault();$(a).find("#account-stats-new").html(LOADING_ON_CURSOR);account_stats_integrations.loadAccountStats(a)});$('#email-stats-listners a[href="#email-stats-new"]').on("click",function(b){b.preventDefault();$(a).find("#email-stats-new").html(LOADING_ON_CURSOR);account_stats_integrations.loadEmailStats(a)});$('#email-stats-listners a[href="#sms-stats-new"]').on("click",function(b){b.preventDefault();$(a).find("#sms-stats-new").html(LOADING_ON_CURSOR);account_stats_integrations.loadSMSStats(a)});$('#email-stats-listners a[href="#sync-stats-new"]').on("click",function(b){b.preventDefault();$(a).find("#sync-stats-new").html(LOADING_ON_CURSOR);account_stats_integrations.loadSyncTab(a)})}function syncAppData(){showModalConfirmation(_agile_get_translated_val("datasync","update-data"),_agile_get_translated_val("datasync","update-data-confirm"),function(){var a=CURRENT_DOMAIN_USER.domain;$.ajax({url:"core/api/custom-fields/syncappdata?domain="+a,type:"GET",success:function(b){console.log(b);var d="";var c=_agile_get_translated_val("reputation","Ok");if(b=="success"){showModalConfirmation(_agile_get_translated_val("datasync","update-data"),_agile_get_translated_val("datasync","update-request-scheduled"),function(){return},function(){return},d,c)}else{if(b=="limitReached"){showModalConfirmation(_agile_get_translated_val("datasync","update-data"),_agile_get_translated_val("datasync","update-request-scheduled-error"),function(){return},function(){return},d,c)}else{showModalConfirmation(_agile_get_translated_val("datasync","update-data"),_agile_get_translated_val("datasync","sync-error"),function(){return},function(){return},d,c)}}},error:function(b){console.log("error");console.log(b)}})},function(){return},function(){return},_agile_get_translated_val("reputation","Ok"),_agile_get_translated_val("contact-details","cancel"))}function syncAppDatatoDeals(){showModalConfirmation("Update Data","This will update your data. Do you want to continue?",function(){var a=CURRENT_DOMAIN_USER.domain;$.ajax({url:"core/api/custom-fields/syncappdataforDeals?domain="+a,type:"GET",success:function(b){console.log(b);var d="";var c="Ok";if(b=="success"){showModalConfirmation("Update Data","Update request is successfully scheduled.",function(){return},function(){return},d,c)}else{if(b=="limitReached"){showModalConfirmation("Update Data","Update is allowed only once a month. Please try later.",function(){return},function(){return},d,c)}else{showModalConfirmation("Update Data","There seems to be an issue. Please try again later.",function(){return},function(){return},d,c)}}},error:function(b){console.log("error");console.log(b)}})},function(){return},function(){return},_agile_get_translated_val("reputation","Ok"),_agile_get_translated_val("contact-details","cancel"))}function get_blocked_ips(){var c=$("#blocked_ips_list").children();var a="";for(var b=0;b<c.length;b++){a=a?a+", "+$(c[b]).attr("data"):$(c[b]).attr("data")}return a}function put_blocked_ips(a){$.ajax({url:"/core/api/api-key/blocked-ips?blocked_ips="+encodeURIComponent(a),method:"PUT",success:function(c){$("#blocked_ips_list").empty();var b=Handlebars.helpers.blocked_ips_list(c.blocked_ips);$("#blocked_ips_list").append(b);$(".blocked-ip-delete").on("click",function(f){f.preventDefault();$(this).closest("tr").remove();var d=get_blocked_ips();put_blocked_ips(d)});$("#update_blocked_ips").removeAttr("disabled");$("#new_blocked_ip").val("")}})}function is_duplicate_blocked_ip(b,a){a=a.split(",");for(var c in a){a[c]=a[c].trim();if(a[c]==b){return true}}return false}function is_valid_ip(b){b=b.replace(/\*/g,"0");var a=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;return a.test(b)}function load_admin_account_prefs(b){var a=new Base_Model_View({url:"/core/api/account-prefs",template:"admin-settings-account-prefs"});b.find("#admin-account-prefs").html(a.render().el)}function load_account_email_activity(a){var b=new Base_Model_View({url:"core/api/emails/email-activity",template:"admin-settings-email-activity",});a.find("#account-email-activity").html(b.render().el)}function modalAlert(a,c,d){if(a==undefined||c==undefined||d==undefined){return}var b={};b.title=d;b.message=c;getTemplate(a,b,undefined,function(f){if(!f){return}var e=$(f);e.modal("show")},null);return}function initializeIntegrationsTabListeners(b,a){$("#admin-prefs-tabs-content .integrations_inner ul li").off("click");$("#admin-prefs-tabs-content").on("click",".tab-container ul li",function(){var c=$(this).find("a").attr("href").split("#");_agile_set_prefs(b,c[1]);Backbone.history.navigate(a,{trigger:true})})}function bindAdminChangeAction(a,b){$('input[name="is_admin"]',a).on("change",function(f){var d=$(this).is(":checked");if(_plan_restrictions.is_ACL_allowed[0]()||checkForACLExceptionalUsers()){if(d==false){$("input[type=checkbox]",$('div[name="newscopes"]',a)).removeAttr("disabled")}else{$("input[type=checkbox]",$('div[name="newscopes"]',a)).prop("checked","checked").attr("disabled","disabled")}$("#calendar-privilege",a).trigger("change");$("#deals-privilege",a).trigger("change")}else{if(d==true){$("input[type=checkbox]",$('div[name="newscopes"]',a)).prop("checked","checked");$("input[type=checkbox]",$('div[name="newMenuScopes"]',a)).prop("checked","checked")}}});$("input[type=checkbox]",$('div[name="newscopes"]',a)).on("change",function(d){if(!this.checked){$(this).removeAttr("checked")}});var c=$('input[value="IMPORT_CONTACTS"]',a);if(!c){return}if(b&&b.scopes){if(jQuery.inArray("IMPORT_CONTACTS",b.scopes)>=0){$('input[value="CREATE_CONTACT"]',a).attr("checked","checked").attr("disabled","disabled")}}c.on("change",function(d){var f=$(this).is(":checked");if(f==true){$('input[value="CREATE_CONTACT"]',a).attr("checked","checked").attr("disabled","disabled")}else{$('input[value="CREATE_CONTACT"]',a).removeAttr("disabled")}});$("#deals-privilege",a).off("change");$(a).on("change","#deals-privilege",function(d){if(!$('input[name="is_admin"]',a).is(":checked")){if(!$(this).is(":checked")){$('input[value="VIEW_DEALS"]',a).attr("disabled","disabled");$('input[value="CREATE_DEALS"]',a).attr("disabled","disabled");$('input[value="UPDATE_DEALS"]',a).attr("disabled","disabled");$('input[value="DELETE_DEALS"]',a).attr("disabled","disabled")}else{if(_plan_restrictions.is_ACL_allowed[0]()){$('input[value="VIEW_DEALS"]',a).removeAttr("disabled");$('input[value="CREATE_DEALS"]',a).removeAttr("disabled");$('input[value="UPDATE_DEALS"]',a).removeAttr("disabled");$('input[value="DELETE_DEALS"]',a).removeAttr("disabled")}}}});$("#calendar-privilege",a).off("change");$(a).on("change","#calendar-privilege",function(d){if(!$('input[name="is_admin"]',a).is(":checked")){if(!$(this).is(":checked")){$('input[value="VIEW_CALENDAR"]',a).attr("disabled","disabled");$('input[value="MANAGE_CALENDAR"]',a).attr("disabled","disabled")}else{if(_plan_restrictions.is_ACL_allowed[0]()){$('input[value="VIEW_CALENDAR"]',a).removeAttr("disabled");$('input[value="MANAGE_CALENDAR"]',a).removeAttr("disabled")}}}})}function checkForACLExceptionalUsers(){var a=["savourychef","organicleads","cutrone","sunsationalswimschoo","aviation","mybandmarket","grupocsi"];if($.inArray(CURRENT_DOMAIN_USER.domain,a)!=-1){return true}else{return false}};