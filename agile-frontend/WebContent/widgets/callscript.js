$(function(){CallScript_PLUGIN_NAME="CallScript";CALLSCRIPT_LOGS_LOAD_IMAGE='<center><img id="logs_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';if(App_Widgets.Catalog_Widgets_View){var c=App_Widgets.Catalog_Widgets_View.collection.where({name:CallScript_PLUGIN_NAME})[0].toJSON()}else{var c=agile_crm_get_widget(CallScript_PLUGIN_NAME)}CallScript_Plugin_Id=c.id;if(c.prefs==undefined||c.prefs=="{}"){$("#CallScript").html("Welcome to CallScript");return}var d=JSON.parse(c.prefs);_agile_contact=agile_crm_get_contact();_agile_execute_callscriptrules(d.csrules)});function _agile_execute_callscriptrules(d){for(var c=0;c<d.length;c++){if(_agile_execute_callscriptrule(d[c])){console.log("condition applied");return}}$("#CallScript").html("No matching call script found.")}function _agile_execute_callscriptrule(i){var g=i.rules.length;for(var f=0;f<g;f++){var h=i.rules[f];if(!_agile_check_condition(h)){console.log("not matched: ");return false}}var j=replaceMergeFields(i.displaytext);$("#CallScript").html(j);return true}function replaceMergeFields(m){var i=m;var o=[];var k=/\{{(.*?)\}}/g;var n;while((n=k.exec(m))!=null){o.push(n[1])}var q=0;for(var p=0;p<o.length;p++){var r=_agile_contact.properties.length;for(var j=0;j<r;j++){if(_agile_contact.properties[j].name==o[p]){i=i.replace("{{"+o[p]+"}}",_agile_contact.properties[j].value);q++}}}while(q!=o.length){var n;while((n=k.exec(i))!=null){i=i.replace(n[0],"");q++}}return i}function _agile_check_condition(b){switch(b.LHS){case"tags":switch(b.CONDITION){case"EQUALS":return _agile_rules.tags_in(b);case"NOTEQUALS":return _agile_rules.tags_out(b)}break;case"tags_time":return _agile_rules.tags_time(b);case"created_time":return _agile_rules.contact_time(b);case"title":switch(b.CONDITION){case"EQUALS":return _agile_rules.contact_properties_in(b);case"NOTEQUALS":return _agile_rules.contact_properties_out(b)}break;case"company":switch(b.CONDITION){case"EQUALS":return _agile_rules.contact_properties_in(b);case"NOTEQUALS":return _agile_rules.contact_properties_out(b)}break;case"lead_score":switch(b.CONDITION){case"IS_LESS_THAN":return _agile_rules.max_score(b);case"IS_GREATER_THAN":return _agile_rules.min_score(b);case"EQUALS":return _agile_rules.score(b)}break;case"visitor":switch(b.CONDITION){case"KNOWN":return _agile_rules.is_known_visitor(b);case"UNKNOWN":return _agile_rules.is_unknown_visitor(b)}break;case"owner_id":switch(b.CONDITION){case"EQUALS":return _agile_rules.owner_is(b);case"NOTEQUALS":return _agile_rules.owner_is_not(b)}break;default:switch(b.CONDITION){case"EQUALS":return _agile_rules.contact_properties_in(b);case"NOTEQUALS":return _agile_rules.contact_properties_out(b);case"MATCHES":return _agile_rules.contact_properties_match(b);case"NOT_CONTAINS":return _agile_rules.contact_properties_doesnot_match(b);default:return _agile_rules.custom_time(b)}}}var _agile_rules={tags_in:function(f){if(f.RHS&&_agile_contact){var d=_agile_contact.tags.length;for(var e=0;e<d;e++){if(f.RHS===_agile_contact.tags[e]){return true}}}},tags_out:function(g){if(!_agile_contact){return true}if(_agile_contact&&g.RHS){var e=0;var h=_agile_contact.tags.length;for(var f=0;f<h;f++){if(_agile_contact.tags[f]!==g.RHS){e++}}if(e==h&&e!==0&&h!==0){return true}}},tags_time:function(r){if(r.RHS&&_agile_contact){var j=r.RHS;var p=r.nested_lhs;var k=r.nested_rhs;var n=_agile_contact.tagsWithTime.length;for(var o=0;o<n;o++){if(j==_agile_contact.tagsWithTime[o].tag){var q=new Date().getTime();var l=(_agile_contact.tagsWithTime[o].createdTime);var m=(q-l);if((r.nested_condition=="LAST"&&(0<=m&&m<=(p*86400000)))||(r.nested_condition=="AFTER"&&(p<=l)&&((l-p)>=86400000))||(r.nested_condition=="BEFORE"&&(p>=l))||(r.nested_condition=="EQUALS"&&(0<=(l-p)&&(l-p)<=86400000))||(r.nested_condition=="BETWEEN"&&(p<=l&&l<=k))){return true}}}}},min_score:function(b){if(_agile_contact&&b.RHS&&_agile_contact.lead_score>b.RHS){return true}},max_score:function(b){if(_agile_contact&&b.RHS&&_agile_contact.lead_score<b.RHS){return true}},score:function(b){if(_agile_contact&&b.RHS&&_agile_contact.lead_score==b.RHS){return true}},referrer_is:function(b){if(b.RHS==document.referrer){return true}},referrer_matches:function(c){var d=document.referrer;if(d.indexOf(c.RHS)!==-1){return true}},referrer_not_matches:function(c){var d=document.referrer;if(d.indexOf(c.RHS)==-1){return true}},referrer_is_not:function(b){if(b.RHS!==document.referrer){return true}},page_view_is:function(b){if(b.RHS===document.location.href){return true}},page_view_is_not:function(b){if(b.RHS!==document.location.href){return true}},page_view_not_matches:function(c){var d=document.location.href;if(d.indexOf(c.RHS)==-1){return true}},page_view_matches:function(c){var d=document.location.href;if(d.indexOf(c.RHS)!==-1){return true}},contact_properties_in:function(f){if(_agile_contact&&f.RHS){var e=_agile_contact.properties.length;for(var d=0;d<e;d++){if(f.LHS==_agile_contact.properties[d].name&&f.RHS==_agile_contact.properties[d].value){return true}}}},contact_properties_out:function(g){if(_agile_contact&&g.RHS){var f=0;var e=_agile_contact.properties.length;for(var h=0;h<e;h++){if(g.LHS==_agile_contact.properties[h].name&&g.RHS!=_agile_contact.properties[h].value){return true}if(g.LHS!==_agile_contact.properties[h].name){f++}}if(f==e&&f!=0&&e!=0){return true}}},contact_time:function(i){if(_agile_contact&&i.RHS){var j=new Date().getTime();var l=(_agile_contact.created_time*1000);var h=(j-l);var k=i.RHS;var g=i.RHS_NEW;if((i.CONDITION=="LAST"&&(0<=h&&h<=(k*86400000)))||(i.CONDITION=="AFTER"&&(k<=l)&&((l-k)>=86400000))||(i.CONDITION=="BEFORE"&&(k>=l))||(i.CONDITION=="ON"&&(0<=(l-k)&&(l-k)<=86400000))||(i.CONDITION=="BETWEEN"&&(k<=l&&l<=g))){return true}}},custom_time:function(k){if(_agile_contact&&k.RHS){var m=k.RHS;var n=k.RHS_NEW;var j=_agile_contact.properties.length;for(var o=0;o<j;o++){if(k.LHS==(_agile_contact.properties[o].name+"_time")){var l=new Date().getTime();var p=_agile_contact.properties[o].value*1000;var g=(l-p);if((k.CONDITION=="LAST"&&(0<=g&&g<=(m*86400000)))||(k.CONDITION=="AFTER"&&(m<=p)&&((p-m)>=86400000))||(k.CONDITION=="BEFORE"&&(m>=p))||(k.CONDITION=="ON"&&(0<=(p-m)&&(p-m)<=86400000))||(k.CONDITION=="BETWEEN"&&(m<=p&&p<=n))){return true}}}}},owner_is:function(b){if(_agile_contact&&b.RHS&&_agile_contact.owner.id.toString()==b.RHS){return true}},owner_is_not:function(b){if(_agile_contact&&b.RHS&&_agile_contact.owner.id.toString()!==b.RHS){return true}},contact_properties_match:function(f){if(_agile_contact&&f.RHS){var e=_agile_contact.properties.length;for(var d=0;d<e;d++){if((f.LHS==_agile_contact.properties[d].name)&&_agile_contact.properties[d].value&&(_agile_contact.properties[d].value.indexOf(f.RHS)!==-1)){return true}}}},contact_properties_doesnot_match:function(f){if(_agile_contact&&f.RHS){var h=_agile_contact.properties.length;var a=0;for(var g=0;g<h;g++){if((f.LHS==_agile_contact.properties[g].name)&&_agile_contact.properties[g].value&&(_agile_contact.properties[g].value.indexOf(f.RHS)==-1)){return true}if(f.LHS!==_agile_contact.properties[g].name){a++}}if(a==h&&h!=0&&a!=0){return true}}},is_cart_empty:function(c){try{return(_agile_shopify_cart.item_count==0)}catch(d){}return false},is_cart_not_empty:function(c){try{return(_agile_shopify_cart.item_count!=0)}catch(d){}return false},cart_has_item:function(f){try{for(var e=0;e<_agile_shopify_cart.items.length;e++){if(f.RHS==_agile_shopify_cart.items[e].title){return true}}return false}catch(d){}return false},cart_value_greater_than:function(c){try{return((_agile_shopify_cart.total_price/100)>=c.RHS)}catch(d){}return false},cart_value_less_than:function(c){try{return((_agile_shopify_cart.total_price/100)<=c.RHS)}catch(d){}return false},is_mobile:function(c){try{return(_agile_is_mobile_browser()&&c.RHS=="MOBILE")}catch(d){}},is_not_mobile:function(c){try{return(!_agile_is_mobile_browser()&&c.RHS=="MOBILE")}catch(d){}},is_known_visitor:function(b){if(typeof _agile_email=="string"&&typeof _agile_contact!=="undefined"){return true}},is_unknown_visitor:function(b){if(typeof _agile_email!=="string"||typeof _agile_contact=="undefined"){return true}},once:function(b){if(!agile_read_cookie("agile-callscriptrules_v2")){return true}if(_agile_callscriptrule_get_cookie("agile-callscriptrules_v2",b.callscriptrule_id)){return false}},once_per_session:function(b){if(!agile_read_cookie("agile-session-callscriptrules_v2")){return true}if(_agile_callscriptrule_get_cookie("agile-session-callscriptrules_v2",b.callscriptrule_id)){return false}},max_of:function(c){if(!agile_read_cookie("agile-maxof-callscriptrules_v2")){return true}var d=_agile_callscriptrule_get_cookie("agile-maxof-callscriptrules_v2",c.callscriptrule_id);if(!d){return true}return(c.RHS>d.count)},once_every:function(f){if(!agile_read_cookie("agile-every-callscriptrules_v2")){return true}var e=_agile_callscriptrule_get_cookie("agile-every-callscriptrules_v2",f.callscriptrule_id);if(!e){return true}var d=e.time+f.RHS*1000*60;return(new Date().getTime()>d)},country_is:function(b){return(b.RHS==b.callscriptrule_country)},country_is_not:function(b){return(b.RHS!=b.callscriptrule_country)},ua_is:function(b){return(window.navigator.userAgent==b.RHS)},ua_is_not:function(b){return(window.navigator.userAgent!==b.RHS)},ua_contains:function(b){return(window.navigator.userAgent.indexOf(b.RHS)!=-1)},ua_not_contains:function(b){return(window.navigator.userAgent.indexOf(b.RHS)==-1)},everytime:function(b){return true}};