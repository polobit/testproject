$(function(){CallScript_PLUGIN_NAME="CallScript";CALLSCRIPT_LOGS_LOAD_IMAGE='<center><img id="logs_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';if(App_Widgets.Catalog_Widgets_View){var c=App_Widgets.Catalog_Widgets_View.collection.where({name:CallScript_PLUGIN_NAME})[0].toJSON()}else{var c=agile_crm_get_widget(CallScript_PLUGIN_NAME)}CallScript_Plugin_Id=c.id;if(c.prefs==undefined||c.prefs=="{}"){$("#CallScript").html("Welcome to CallScript");return}var d=JSON.parse(c.prefs);_agile_contact=agile_crm_get_contact();_agile_execute_callscriptrules(d.csrules)});function _agile_execute_callscriptrules(d){for(var c=0;c<d.length;c++){if(_agile_execute_callscriptrule(d[c])){console.log("condition applied");return}}$("#CallScript").html("No matching call script found.")}function _agile_execute_callscriptrule(i){var g=i.rules.length;for(var f=0;f<g;f++){var h=i.rules[f];if(!_agile_check_condition(h)){console.log("not matched: ");return false}}var j=replaceMergeFields(i.displaytext);$("#CallScript").html(j);return true}function replaceMergeFields(m){var i=m;var o=[];var k=/\{{(.*?)\}}/g;var n;while((n=k.exec(m))!=null){o.push(n[1])}var q=0;for(var p=0;p<o.length;p++){var r=_agile_contact.properties.length;for(var j=0;j<r;j++){if(_agile_contact.properties[j].name==o[p]){i=i.replace("{{"+o[p]+"}}",_agile_contact.properties[j].value);q++}}}while(q!=o.length){var n;while((n=k.exec(i))!=null){i=i.replace(n[0],"");q++}}return i}function _agile_check_condition(b){switch(b.LHS){case"tags":switch(b.CONDITION){case"EQUALS":return _agile_rules.tags_in(b);case"NOTEQUALS":return _agile_rules.tags_out(b)}break;case"tags_time":return _agile_rules.tags_time(b);case"created_time":return _agile_rules.contact_time(b);case"title":switch(b.CONDITION){case"EQUALS":return _agile_rules.contact_properties_in(b);case"NOTEQUALS":return _agile_rules.contact_properties_out(b)}break;case"company":switch(b.CONDITION){case"EQUALS":return _agile_rules.contact_properties_in(b);case"NOTEQUALS":return _agile_rules.contact_properties_out(b)}break;case"lead_score":switch(b.CONDITION){case"IS_LESS_THAN":return _agile_rules.max_score(b);case"IS_GREATER_THAN":return _agile_rules.min_score(b);case"EQUALS":return _agile_rules.score(b)}break;case"visitor":switch(b.CONDITION){case"KNOWN":return _agile_rules.is_known_visitor(b);case"UNKNOWN":return _agile_rules.is_unknown_visitor(b)}break;case"owner_id":switch(b.CONDITION){case"EQUALS":return _agile_rules.owner_is(b);case"NOTEQUALS":return _agile_rules.owner_is_not(b)}break;default:switch(b.CONDITION){case"EQUALS":return _agile_rules.contact_properties_in(b);case"NOTEQUALS":return _agile_rules.contact_properties_out(b);case"MATCHES":return _agile_rules.contact_properties_match(b);case"NOT_CONTAINS":return _agile_rules.contact_properties_doesnot_match(b);default:return _agile_rules.custom_time(b)}}}var _agile_rules={tags_in:function(d){if(d.RHS&&_agile_contact){var e=_agile_contact.tags.length;for(var f=0;f<e;f++){if(d.RHS===_agile_contact.tags[f]){return true}}}},tags_out:function(e){if(!_agile_contact){return true}if(_agile_contact&&e.RHS){var g=0;var f=_agile_contact.tags.length;for(var h=0;h<f;h++){if(_agile_contact.tags[h]!==e.RHS){g++}}if(g==f&&g!==0&&f!==0){return true}}},tags_time:function(r){if(r.RHS&&_agile_contact){var j=r.RHS;var p=r.nested_lhs;var k=r.nested_rhs;var n=_agile_contact.tagsWithTime.length;for(var o=0;o<n;o++){if(j==_agile_contact.tagsWithTime[o].tag){var q=new Date().getTime();var l=(_agile_contact.tagsWithTime[o].createdTime);var m=(q-l);if((r.nested_condition=="LAST"&&(0<=m&&m<=(p*86400000)))||(r.nested_condition=="AFTER"&&(p<=l)&&((l-p)>=86400000))||(r.nested_condition=="BEFORE"&&(p>=l))||(r.nested_condition=="EQUALS"&&(0<=(l-p)&&(l-p)<=86400000))||(r.nested_condition=="BETWEEN"&&(p<=l&&l<=k))){return true}}}}},min_score:function(b){if(_agile_contact&&b.RHS&&_agile_contact.lead_score>b.RHS){return true}},max_score:function(b){if(_agile_contact&&b.RHS&&_agile_contact.lead_score<b.RHS){return true}},score:function(b){if(_agile_contact&&b.RHS&&_agile_contact.lead_score==b.RHS){return true}},referrer_is:function(b){if(b.RHS==document.referrer){return true}},referrer_matches:function(c){var d=document.referrer;if(d.indexOf(c.RHS)!==-1){return true}},referrer_not_matches:function(c){var d=document.referrer;if(d.indexOf(c.RHS)==-1){return true}},referrer_is_not:function(b){if(b.RHS!==document.referrer){return true}},page_view_is:function(b){if(b.RHS===document.location.href){return true}},page_view_is_not:function(b){if(b.RHS!==document.location.href){return true}},page_view_not_matches:function(c){var d=document.location.href;if(d.indexOf(c.RHS)==-1){return true}},page_view_matches:function(c){var d=document.location.href;if(d.indexOf(c.RHS)!==-1){return true}},contact_properties_in:function(d){if(_agile_contact&&d.RHS){var f=_agile_contact.properties.length;for(var e=0;e<f;e++){if(d.LHS==_agile_contact.properties[e].name&&d.RHS==_agile_contact.properties[e].value){return true}}}},contact_properties_out:function(e){if(_agile_contact&&e.RHS){var h=0;var g=_agile_contact.properties.length;for(var f=0;f<g;f++){if(e.LHS==_agile_contact.properties[f].name&&e.RHS!=_agile_contact.properties[f].value){return true}if(e.LHS!==_agile_contact.properties[f].name){h++}}if(h==g&&h!=0&&g!=0){return true}}},contact_time:function(g){if(_agile_contact&&g.RHS){var h=new Date().getTime();var j=(_agile_contact.created_time*1000);var l=(h-j);var i=g.RHS;var k=g.RHS_NEW;if((g.CONDITION=="LAST"&&(0<=l&&l<=(i*86400000)))||(g.CONDITION=="AFTER"&&(i<=j)&&((j-i)>=86400000))||(g.CONDITION=="BEFORE"&&(i>=j))||(g.CONDITION=="ON"&&(0<=(j-i)&&(j-i)<=86400000))||(g.CONDITION=="BETWEEN"&&(i<=j&&j<=k))){return true}}},custom_time:function(l){if(_agile_contact&&l.RHS){var n=l.RHS;var o=l.RHS_NEW;var k=_agile_contact.properties.length;for(var p=0;p<k;p++){if(l.LHS==(_agile_contact.properties[p].name+"_time")){var m=new Date().getTime();var g=_agile_contact.properties[p].value*1000;var j=(m-g);if((l.CONDITION=="LAST"&&(0<=j&&j<=(n*86400000)))||(l.CONDITION=="AFTER"&&(n<=g)&&((g-n)>=86400000))||(l.CONDITION=="BEFORE"&&(n>=g))||(l.CONDITION=="ON"&&(0<=(g-n)&&(g-n)<=86400000))||(l.CONDITION=="BETWEEN"&&(n<=g&&g<=o))){return true}}}}},owner_is:function(b){if(_agile_contact&&b.RHS&&_agile_contact.owner.id.toString()==b.RHS){return true}},owner_is_not:function(b){if(_agile_contact&&b.RHS&&_agile_contact.owner.id.toString()!==b.RHS){return true}},contact_properties_match:function(d){if(_agile_contact&&d.RHS){var f=_agile_contact.properties.length;for(var e=0;e<f;e++){if((d.LHS==_agile_contact.properties[e].name)&&_agile_contact.properties[e].value&&(_agile_contact.properties[e].value.indexOf(d.RHS)!==-1)){return true}}}},contact_properties_doesnot_match:function(f){if(_agile_contact&&f.RHS){var h=_agile_contact.properties.length;var a=0;for(var g=0;g<h;g++){if((f.LHS==_agile_contact.properties[g].name)&&_agile_contact.properties[g].value&&(_agile_contact.properties[g].value.indexOf(f.RHS)==-1)){return true}if(f.LHS!==_agile_contact.properties[g].name){a++}}if(a==h&&h!=0&&a!=0){return true}}},is_cart_empty:function(c){try{return(_agile_shopify_cart.item_count==0)}catch(d){}return false},is_cart_not_empty:function(c){try{return(_agile_shopify_cart.item_count!=0)}catch(d){}return false},cart_has_item:function(d){try{for(var f=0;f<_agile_shopify_cart.items.length;f++){if(d.RHS==_agile_shopify_cart.items[f].title){return true}}return false}catch(e){}return false},cart_value_greater_than:function(c){try{return((_agile_shopify_cart.total_price/100)>=c.RHS)}catch(d){}return false},cart_value_less_than:function(c){try{return((_agile_shopify_cart.total_price/100)<=c.RHS)}catch(d){}return false},is_mobile:function(c){try{return(_agile_is_mobile_browser()&&c.RHS=="MOBILE")}catch(d){}},is_not_mobile:function(c){try{return(!_agile_is_mobile_browser()&&c.RHS=="MOBILE")}catch(d){}},is_known_visitor:function(b){if(typeof _agile_email=="string"&&typeof _agile_contact!=="undefined"){return true}},is_unknown_visitor:function(b){if(typeof _agile_email!=="string"||typeof _agile_contact=="undefined"){return true}},once:function(b){if(!agile_read_cookie("agile-callscriptrules_v2")){return true}if(_agile_callscriptrule_get_cookie("agile-callscriptrules_v2",b.callscriptrule_id)){return false}},once_per_session:function(b){if(!agile_read_cookie("agile-session-callscriptrules_v2")){return true}if(_agile_callscriptrule_get_cookie("agile-session-callscriptrules_v2",b.callscriptrule_id)){return false}},max_of:function(c){if(!agile_read_cookie("agile-maxof-callscriptrules_v2")){return true}var d=_agile_callscriptrule_get_cookie("agile-maxof-callscriptrules_v2",c.callscriptrule_id);if(!d){return true}return(c.RHS>d.count)},once_every:function(d){if(!agile_read_cookie("agile-every-callscriptrules_v2")){return true}var f=_agile_callscriptrule_get_cookie("agile-every-callscriptrules_v2",d.callscriptrule_id);if(!f){return true}var e=f.time+d.RHS*1000*60;return(new Date().getTime()>e)},country_is:function(b){return(b.RHS==b.callscriptrule_country)},country_is_not:function(b){return(b.RHS!=b.callscriptrule_country)},ua_is:function(b){return(window.navigator.userAgent==b.RHS)},ua_is_not:function(b){return(window.navigator.userAgent!==b.RHS)},ua_contains:function(b){return(window.navigator.userAgent.indexOf(b.RHS)!=-1)},ua_not_contains:function(b){return(window.navigator.userAgent.indexOf(b.RHS)==-1)},everytime:function(b){return true}};