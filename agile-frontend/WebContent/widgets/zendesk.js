function setupZendeskAuth(){$("#Zendesk").html(ZENDESK_UPDATE_LOAD_IMAGE);console.log("In Zendesk Auth");$("#Zendesk").html(getTemplate("zendesk-login",{}));$("#save_prefs").die().live("click",function(b){b.preventDefault();if(!isValidForm($("#zendesk_login_form"))){return}saveZendeskPrefs()})}function saveZendeskPrefs(){var b={};b.zendesk_username=$("#zendesk_username").val();b.zendesk_password=$("#zendesk_password").val();b.zendesk_url=$("#zendesk_url").val();agile_crm_save_widget_prefs(ZENDESK_PLUGIN_NAME,JSON.stringify(b),function(a){showZendeskProfile()})}function showZendeskProfile(){$("#Zendesk").html(ZENDESK_UPDATE_LOAD_IMAGE);if(!Email){zendeskError(ZENDESK_PLUGIN_NAME,"Please provide email for this contact");return}getTicketsFromZendesk(function(b){console.log("zendesk profile : "+b);showTicketsInZendesk(b);registerClickEventsInZendesk()})}function getTicketsFromZendesk(e){queueGetRequest("widget_queue","/core/api/widgets/zendesk/profile/"+Zendesk_Plugin_Id+"/"+Email,"json",function f(a){if(e&&typeof(e)==="function"){e(a)}},function d(a){$("#tickets_load").remove();zendeskError(ZENDESK_PLUGIN_NAME,a.responseText)})}function showTicketsInZendesk(f){$("#Zendesk").html(getTemplate("zendesk-profile",f));var h;var i;try{h=JSON.parse(f.all_tickets);i=h.splice(0,5)}catch(g){i=f.all_tickets}var j=$(getTemplate("zendesk-ticket-stream",i));$("#all_tickets_panel").html(j);head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",j).timeago()});$("#more_tickets").die().live("click",function(a){a.preventDefault();if(!h){return}showMoreTickets(h.splice(0,5))})}function showMoreTickets(c){$("#spinner-tickets").show();if(c.length==0){$("#spinner-tickets").hide();zendeskStreamError("tickets-error-panel","No more tickets");return}var d=$(getTemplate("zendesk-ticket-stream",c));$("#all_tickets_panel").append(d);$("#spinner-tickets").hide();head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",d).timeago()})}function showTicketById(d,c){d.headline="Ticket "+c;d.desc_len=d.description.length>200;$("#zendesk_showModal").remove();$("#content").append(getTemplate("zendesk-ticket-show",d));$("#zendesk_showModal").modal("show")}function registerClickEventsInZendesk(){$("#ticket_update").die().live("click",function(d){d.preventDefault();var c=$(this).attr("update_id");updateTicketInZendesk(c)});$("#ticket_show").die().live("click",function(f){f.preventDefault();var d=JSON.parse($(this).attr("data-attr"));var e=$(this).attr("ticket_id");showTicketById(d,e)})}function addTicketToZendesk(){var d={};d.headline="Add Ticket";d.info="Add ticket in Zendesk";d.name=agile_crm_get_contact_property("first_name")+" "+agile_crm_get_contact_property("last_name");d.email=Email;$("#zendesk_messageModal").remove();var c=getTemplate("zendesk-message",d);$("#content").append(c);$("#zendesk_messageModal").modal("show");$("#send_request").click(function(a){a.preventDefault();if($("#send_request").attr("disabled")){return}if(!isValidForm($("#zendesk_messageForm"))){return}$("#send_request").attr("disabled",true);sendRequestToZendesk("/core/api/widgets/zendesk/add/"+Zendesk_Plugin_Id,"zendesk_messageForm","zendesk_messageModal","add-ticket-error-panel")})}function updateTicketInZendesk(f){var d={};d.headline="Update Ticket";d.info="Updates Ticket No "+f+" in Zendesk";d.id=f;$("#zendesk_messageModal").remove();var e=getTemplate("zendesk-message",d);$("#content").append(e);$("#zendesk_messageModal").modal("show");$("#send_request").click(function(a){a.preventDefault();if($("#send_request").attr("disabled")){return}if(!isValidForm($("#zendesk_messageForm"))){return}$("#send_request").attr("disabled",true);sendRequestToZendesk("/core/api/widgets/zendesk/update/"+Zendesk_Plugin_Id,"zendesk_messageForm","zendesk_messageModal","add-ticket-error-panel")})}function sendRequestToZendesk(h,g,f,e){$.post(h,$("#"+g).serialize(),function(a){$("#"+f).find("span.save-status").html("sent");setTimeout(function(){$("#"+f).modal("hide")},2000)}).error(function(a){$("#"+f).modal("hide");zendeskStreamError(e,a.responseText)})}function zendeskError(e,f){var d={};d.message=f;$("#"+e).html(getTemplate("zendesk-error",d))}function zendeskStreamError(c,d){zendeskError(c,d);$("#"+c).show();$("#"+c).fadeOut(10000)}$(function(){ZENDESK_PLUGIN_NAME="Zendesk";ZENDESK_UPDATE_LOAD_IMAGE='<center><img id="tickets_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';var b=agile_crm_get_widget(ZENDESK_PLUGIN_NAME);console.log("In Zendesk");console.log(b);Zendesk_Plugin_Id=b.id;Email=agile_crm_get_contact_property("email");console.log("Email: "+Email);if(b.prefs==undefined){setupZendeskAuth();return}showZendeskProfile();$("#add_ticket").die().live("click",function(a){a.preventDefault();addTicketToZendesk()});$(".zendesk_ticket_hover").live("mouseenter",function(a){$(this).find(".zendesk_tab_link").show()});$(".zendesk_ticket_hover").live("mouseleave",function(a){$(".zendesk_tab_link").hide()})});