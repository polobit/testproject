$(function(){TwilioIO_PLUGIN_NAME="TwilioIO";TWILIOIO_LOGS_LOAD_IMAGE='<center><img id="logs_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';var b=agile_crm_get_widget(TwilioIO_PLUGIN_NAME);console.log("In twilioio_widget");console.log(b);TwilioIO_Plugin_Id=b.id;console.log("Plugin prefs in Twilio: "+b.prefs);var a=JSON.parse(b.prefs);TwilioIONumbers=agile_crm_get_contact_properties_list("phone");console.log("TwilioIONumbers");console.log(TwilioIONumbers);TwilioIOContactImg=agile_crm_get_contact_properties_list("image");console.log("TwilioIOContactImg");console.log(TwilioIOContactImg);showListOfContactNumbers();$("#twilioio_more_call_logs").die().live("click",function(f){f.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled",true);var d=$(this).attr("page");var c=$(this).attr("pageToken");var g=$("#contact_number").val();$(this).append('<img src="img/ajax-loader.gif" style="margin-left: 10px;"></img>');if(!g){g=TwilioIONumbers[0].value}getNextLogs(g,d,c)})});function showListOfContactNumbers(){console.log("In showListOfContactNumbers");if(TwilioIONumbers.length==0){twilioIOError(TwilioIO_PLUGIN_NAME,"There is no phone number associated with this contact. <a href='#contact-edit'>Add phone number</a>");return}var a={};a.to=TwilioIONumbers;$("#TwilioIO").html(getTemplate("twilioio-profile",a));getTwilioIOLogs(TwilioIONumbers[0].value);$("#contact_number").die().live("change",function(b){$("#twilio-logs-panel").html(TWILIOIO_LOGS_LOAD_IMAGE);var c=$("#contact_number").val();getTwilioIOLogs(c)})}function getTwilioIOLogs(b){console.log("In getTwilioIOLogs:"+b);if(b==""||!b){twilioIOError(TwilioIO_PLUGIN_NAME,"There is no phone number associated with this contact. <a href='#contact-edit'>Add phone number</a>");return}var a=$("#twilio-logs-panel li")[0];if(!$(a).hasClass("row-fluid")){$("#twilio-logs-panel").html(TWILIOIO_LOGS_LOAD_IMAGE)}$.get("/core/api/widgets/twilio/call/logs/"+TwilioIO_Plugin_Id+"/"+b,function(d){console.log("In TwilioIO logs ");var c=JSON.parse(d);var e=c.splice(0,1)[0];var f=$(getTemplate("twilio-logs",c));$("#twilio-logs-panel").html(f);head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",f).timeago()});addMoreButton(e);$("#record_sound_play").die().live("click",function(h){h.preventDefault();if(audio!=null){audio.pause();$(".icon-stop").addClass("icon-play");$(".icon-stop").removeClass("icon-stop")}var g="https://api.twilio.com"+$(this).attr("sound_url");console.log("Twilio sound URL: "+g);play_sound(g,"true");$(this).addClass("icon-stop");$(this).removeClass("icon-play")});$(".icon-stop").die().live("click",function(g){g.preventDefault();audio.pause();audio=null;$(this).addClass("icon-play");$(this).removeClass("icon-stop")})}).error(function(c){$("#logs_load").remove();twilioIOError("twilio-logs-panel",c.responseText)})}function addMoreButton(a){if(!a){return}$(".widget_tab_footer").remove();$("#twilioio_more_call_logs").remove();if(a.page){$("#twilio-logs-panel").append('<div class="widget_tab_footer" align="center" style="float:none"><a href="#" id="twilioio_more_call_logs" page="'+a.page+'" pageToken="'+a.pageToken+'" style="margin-bottom: 10px;"  title="Click to see more call logs">Show More</a></div>')}}function getNextLogs(c,b,a){console.log("In getNextLogs:"+c);$.get("/core/api/widgets/twilio/call/nextlogs/"+TwilioIO_Plugin_Id+"/"+c+"/"+b+"/"+a,function(e){console.log("In TwilioIO next logs ");var d=JSON.parse(e);var f=d.splice(0,1)[0];var g=$(getTemplate("twilio-logs",d));$("#twilio-logs-panel").append(g);head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",g).timeago()});addMoreButton(f)}).error(function(d){$("#twilioio_more_call_logs").html("Retry...");$("#twilioio_more_call_logs").attr("disabled",false)})}function twilioIOError(c,b){console.log("In TwilioIO error template");var a={};a.message=b;$("#"+c).html(getTemplate("twilio-error",a))};