$(function(){TwilioIO_PLUGIN_NAME="TwilioIO";TWILIOIO_LOGS_LOAD_IMAGE='<center><img id="logs_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';var c=agile_crm_get_widget(TwilioIO_PLUGIN_NAME);console.log("In twilioio_widget");console.log(c);TwilioIO_Plugin_Id=c.id;console.log("Plugin prefs in Twilio: "+c.prefs);var d=JSON.parse(c.prefs);TwilioIONumbers=agile_crm_get_contact_properties_list("phone");console.log("TwilioIONumbers");console.log(TwilioIONumbers);TwilioIOContactImg=agile_crm_get_contact_properties_list("image");console.log("TwilioIOContactImg");console.log(TwilioIOContactImg);showListOfContactNumbers();$("#twilioio_more_call_logs").die().live("click",function(b){b.preventDefault();if($(this).attr("disabled")){return}$(this).attr("disabled",true);var e=$(this).attr("page");var h=$(this).attr("pageToken");var a=$("#contact_number").val();$(this).append('<img src="img/ajax-loader.gif" style="margin-left: 10px;"></img>');if(!a){a=TwilioIONumbers[0].value}getNextLogs(a,e,h)})});function showListOfContactNumbers(){console.log("In showListOfContactNumbers");if(TwilioIONumbers.length==0){twilioIOError(TwilioIO_PLUGIN_NAME,"There is no phone number associated with this contact. <a href='#contact-edit'>Add phone number</a>");return}var b={};b.to=TwilioIONumbers;$("#TwilioIO").html(getTemplate("twilioio-profile",b));getTwilioIOLogs(TwilioIONumbers[0].value);$("#contact_number").die().live("change",function(a){$("#twilio-logs-panel").html(TWILIOIO_LOGS_LOAD_IMAGE);var d=$("#contact_number").val();getTwilioIOLogs(d)})}function getTwilioIOLogs(c){console.log("In getTwilioIOLogs:"+c);if(c==""||!c){twilioIOError(TwilioIO_PLUGIN_NAME,"There is no phone number associated with this contact. <a href='#contact-edit'>Add phone number</a>");return}var d=$("#twilio-logs-panel li")[0];if(!$(d).hasClass("row-fluid")){$("#twilio-logs-panel").html(TWILIOIO_LOGS_LOAD_IMAGE)}$.get("/core/api/widgets/twilio/call/logs/"+TwilioIO_Plugin_Id+"/"+c,function(g){console.log("In TwilioIO logs ");var h=JSON.parse(g);var b=h.splice(0,1)[0];var a=$(getTemplate("twilio-logs",h));$("#twilio-logs-panel").html(a);head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",a).timeago()});addMoreButton(b);$("#record_sound_play").die().live("click",function(e){e.preventDefault();if(audio!=null){audio.pause();$(".icon-stop").addClass("icon-play");$(".icon-stop").removeClass("icon-stop")}var f="https://api.twilio.com"+$(this).attr("sound_url");console.log("Twilio sound URL: "+f);play_sound(f,"true");$(this).addClass("icon-stop");$(this).removeClass("icon-play")});$(".icon-stop").die().live("click",function(e){e.preventDefault();audio.pause();audio=null;$(this).addClass("icon-play");$(this).removeClass("icon-stop")})}).error(function(a){$("#logs_load").remove();twilioIOError("twilio-logs-panel",a.responseText)})}function addMoreButton(b){if(!b){return}$(".widget_tab_footer").remove();$("#twilioio_more_call_logs").remove();if(b.page){$("#twilio-logs-panel").append('<div class="widget_tab_footer" align="center" style="float:none"><a href="#" id="twilioio_more_call_logs" page="'+b.page+'" pageToken="'+b.pageToken+'" style="margin-bottom: 10px;"  title="Click to see more call logs">Show More</a></div>')}}function getNextLogs(f,d,e){console.log("In getNextLogs:"+f);$.get("/core/api/widgets/twilio/call/nextlogs/"+TwilioIO_Plugin_Id+"/"+f+"/"+d+"/"+e,function(c){console.log("In TwilioIO next logs ");var h=JSON.parse(c);var b=h.splice(0,1)[0];var a=$(getTemplate("twilio-logs",h));$("#twilio-logs-panel").append(a);head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",a).timeago()});addMoreButton(b)}).error(function(a){$("#twilioio_more_call_logs").html("Retry...");$("#twilioio_more_call_logs").attr("disabled",false)})}function twilioIOError(f,d){console.log("In TwilioIO error template");var e={};e.message=d;$("#"+f).html(getTemplate("twilio-error",e))};