function showMatchedPeople(f){var g=getMatchingPeople(f);if(typeof g.errors=="undefined"){var h=g.items;if(h.length==0){if(searchDetails.keywords&&searchDetails.keywords!=""){displayError(WIDGET_NAME,"<p class='a-dotted' style='margin-bottom:0px;'>No matches found for <a href='#' class='peoplesearch'>"+searchDetails.keywords+"</a>",true)}else{displayError(WIDGET_NAME,"<p class='a-dotted' style='margin-bottom:0px;'>No matches found. <a href='#' class='peoplesearch'>Modify search</a>",true)}return}var e;if(searchDetails.keywords&&searchDetails.keywords!=""){e="<div><p class='a-dotted'>Search results for <a href='#' class='peoplesearch'>"+searchDetails.keywords+"</a></p>"}else{e="<div><p class='a-dotted'>Search results. <a href='#' class='peoplesearch'>Modify search</a></p>"}e=e.concat(getTemplate("googleplus-search-result",h));e=e+"</div>";$("#"+WIDGET_NAME).html(e)}else{return}}function showGooglePlusProfile(e){var d={};if(typeof PROFILE_DATA[""+e]=="undefined"){d=getGooglePlusUserDetails(e)}else{d=PROFILE_DATA[""+e]}var d=getGooglePlusUserDetails(e);if(typeof d.errors=="undefined"){var f;f=getTemplate("googleplus-profile",d);$("#"+WIDGET_NAME).html(f);showGooglePlusPosts(e)}else{return}}function showGooglePlusPosts(e,d){var f={};if(typeof d!="undefined"){f=getGooglePlusPosts(e,d)}else{f=getGooglePlusPosts(e)}if(typeof d!="undefined"){$("#gplus_social_stream").append(getTemplate("googleplus-posts",f));$("#gplusstreammore").attr("ntoken",f.nextPageToken)}else{$("#gpostscontainer").html(getTemplate("googleplus-profile-tabs",f));if(!f.items.length){$("#recentPostsText").html('<div style="text-align: center;font-size: 13px;padding: 5px 0 6px 0;">No Posts.</div>')}}head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago").timeago()})}function getGooglePlusUserDetails(f){var h="https://www.googleapis.com/plus/v1/people/"+f;var j="fields=aboutMe%2CcurrentLocation%2CdisplayName%2Cdomain%2Cgender%2Cid%2Cimage%2CisPlusUser%2Coccupation%2Corganizations%2CplacesLived%2Curl";var g=googlePlusApiCall(h,j);var i=g.error;if(typeof i!="undefined"){if(i.code==401&&i.message=="Invalid Credentials"){refreshAccessToken()}else{displayError(WIDGET_NAME,i.message);return}}else{return g}return googlePlusApiCall(h,j)}function getGooglePlusPosts(k,j){var g="https://www.googleapis.com/plus/v1/people/"+k+"/activities/public";var i="fields=id%2Citems(actor(displayName%2Cid%2Cimage%2Curl)%2Cid%2Ckind%2Clocation%2Cobject(actor%2Cattachments(content%2CdisplayName%2Cid%2Cimage%2CobjectType%2Cthumbnails%2Curl)%2Ccontent%2Cid%2CobjectType%2CoriginalContent%2Curl)%2Cpublished%2Ctitle%2Cupdated%2Curl%2Cverb)%2CnextPageToken%2CselfLink%2Cupdated&maxResults=4";if(typeof j!="undefined"){i+="&pageToken="+j}var l=googlePlusApiCall(g,i);var h=l.error;if(typeof h!="undefined"){if(h.code==401&&h.message=="Invalid Credentials"){refreshAccessToken()}else{displayError(WIDGET_NAME,h.message);return}}else{return l}return googlePlusApiCall(g,i)}function getMatchingPeople(i){var g="https://www.googleapis.com/plus/v1/people";var j="query="+i+"&maxResults=20";var f=googlePlusApiCall(g,j);var h=f.error;if(typeof h!="undefined"){if(h.code==401&&h.message=="Invalid Credentials"){refreshAccessToken()}else{displayError(WIDGET_NAME,h.message);return}}else{return f}return googlePlusApiCall(g,j)}function refreshAccessToken(){var b="reqType=googleplusrefresh&widgetId="+pluginId+"&refreshToken="+widgetPref.refresh_token+"&code_token="+widgetPref.code_token;$.ajax({type:"POST",url:"/scribe",async:false,data:b,success:function(f,e,a){widgetDetails=getWidgetDetails();widgetPref=JSON.parse(widgetDetails.prefs)},error:function(a,e,f){}})}function getWidgetDetails(){return $.parseJSON($.ajax({url:"core/api/widgets/GooglePlus",async:false,dataType:"json"}).responseText)}function googlePlusApiCall(e,f){var d=$.ajax({type:"GET",url:e,async:false,data:f+"&access_token="+widgetPref.access_token,dataType:"json"});return $.parseJSON(d.responseText)}function displayError(g,h,e){var f={};f.message=h;f.disable_check=e;$("#"+g).html(getTemplate("googleplus-error-panel",f))}$(function(){WIDGET_NAME="GooglePlus";LODING_IMAGE='<div id="tweet_load"><center><img  src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center></div>';PROFILE_DATA={};widgetDetails=agile_crm_get_widget(WIDGET_NAME);pluginId=widgetDetails.id;widgetPref=JSON.parse(widgetDetails.prefs);searchDetails={};var b="";if(agile_crm_get_contact_property("first_name")){b=b+agile_crm_get_contact_property("first_name")}if(agile_crm_get_contact_property("last_name")){b=b+" "+agile_crm_get_contact_property("last_name")}searchDetails.keywords=b.trim();contactGooglePlusId=agile_crm_get_contact_property_by_subtype("website","GOOGLE-PLUS");if(typeof contactGooglePlusId=="undefined"){showMatchedPeople(searchDetails.keywords)}else{showGooglePlusProfile(contactGooglePlusId)}$("#GooglePlus_plugin_delete").die().live("click",function(a){a.preventDefault();contactGooglePlusId=agile_crm_get_contact_property_by_subtype("website","GOOGLE-PLUS");agile_crm_delete_contact_property_by_subtype("website","GOOGLE-PLUS",contactGooglePlusId,function(d){showMatchedPeople(searchDetails.keywords)})});$(".peoplesearch").die().live("click",function(a){a.preventDefault();$("#"+WIDGET_NAME).html(getTemplate("googleplus-modified-search",searchDetails))});$("#gpsearchbtn").die().live("click",function(d){d.preventDefault();if(!isValidForm($("#gpsearchform"))){return}var a=$("#searchkeywords").val();$("#spinner-search").show();searchDetails.keywords=a;showMatchedPeople(searchDetails.keywords)});$("#searchkeywords").die().live("keypress",function(a){if(a.keyCode==13){a.preventDefault();$("#gpsearchbtn").trigger("click")}});$("#gpsearchclose").die().live("click",function(a){showMatchedPeople(searchDetails.keywords);a.preventDefault()});$(".GoogleplusDisplayPic").die().live("mouseover",function(a){profileID=$(this).attr("id");$(this).popover({placement:"left"});$(this).popover("show");$("#"+profileID).die().live("click",function(e){e.preventDefault();$(this).popover("hide");var g=[{name:"website",value:profileID,subtype:"GOOGLE-PLUS"}];if(!agile_crm_get_contact_property("image")){var h=$(this).attr("src");g.push({name:"image",value:h})}agile_crm_update_contact_properties(g);contactGooglePlusId=profileID;showGooglePlusProfile(profileID)})});$("#gplusstreammore").die().live("click",function(d){d.preventDefault();var a=$(this).attr("ntoken");if(a==""){$("#gplusstreammore").html("No more posts.");return}$("#spinnerspan").show();showGooglePlusPosts(contactGooglePlusId,a);$("#spinnerspan").hide()})});