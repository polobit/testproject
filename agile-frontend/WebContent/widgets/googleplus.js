function showMatchedPeople(f){var g=getMatchingPeople(f);if(typeof g.errors=="undefined"){var h=g.items;if(h.length==0){if(searchDetails.keywords&&searchDetails.keywords!=""){displayError(WIDGET_NAME,"<p class='a-dotted' style='margin-bottom:0px;'>No matches found for <a href='#' class='peoplesearch'>"+searchDetails.keywords+"</a>",true)}else{displayError(WIDGET_NAME,"<p class='a-dotted' style='margin-bottom:0px;'>No matches found. <a href='#' class='peoplesearch'>Modify search</a>",true)}return}var e;if(searchDetails.keywords&&searchDetails.keywords!=""){e="<div><p class='a-dotted'>Search results for <a href='#' class='peoplesearch'>"+searchDetails.keywords+"</a></p>"}else{e="<div><p class='a-dotted'>Search results. <a href='#' class='peoplesearch'>Modify search</a></p>"}e=e.concat(getTemplate("googleplus-search-result",h));e=e+"</div>";$("#"+WIDGET_NAME).html(e)}else{return}}function showGooglePlusProfile(f){var e={};if(typeof PROFILE_DATA[""+f]=="undefined"){e=getGooglePlusUserDetails(f)}else{e=PROFILE_DATA[""+f]}var e=getGooglePlusUserDetails(f);if(typeof e.errors=="undefined"){var d;d=getTemplate("googleplus-profile",e);$("#"+WIDGET_NAME).html(d);showGooglePlusPosts(f)}else{return}}function showGooglePlusPosts(f,e){var d={};if(typeof e!="undefined"){d=getGooglePlusPosts(f,e)}else{d=getGooglePlusPosts(f)}if(typeof e!="undefined"){$("#gplus_social_stream").append(getTemplate("googleplus-posts",d));$("#gplusstreammore").attr("ntoken",d.nextPageToken)}else{$("#gpostscontainer").html(getTemplate("googleplus-profile-tabs",d));if(!d.items.length){$("#recentPostsText").html('<div style="text-align: center;font-size: 13px;padding: 5px 0 6px 0;">No Posts.</div>')}}head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago").timeago()})}function getGooglePlusUserDetails(h){var j="https://www.googleapis.com/plus/v1/people/"+h;var g="fields=aboutMe%2CcurrentLocation%2CdisplayName%2Cdomain%2Cgender%2Cid%2Cimage%2CisPlusUser%2Coccupation%2Corganizations%2CplacesLived%2Curl";var i=googlePlusApiCall(j,g);var f=i.error;if(typeof f!="undefined"){if(f.code==401&&f.message=="Invalid Credentials"){refreshAccessToken()}else{displayError(WIDGET_NAME,f.message);return}}else{return i}return googlePlusApiCall(j,g)}function getGooglePlusPosts(i,h){var k="https://www.googleapis.com/plus/v1/people/"+i+"/activities/public";var g="fields=id%2Citems(actor(displayName%2Cid%2Cimage%2Curl)%2Cid%2Ckind%2Clocation%2Cobject(actor%2Cattachments(content%2CdisplayName%2Cid%2Cimage%2CobjectType%2Cthumbnails%2Curl)%2Ccontent%2Cid%2CobjectType%2CoriginalContent%2Curl)%2Cpublished%2Ctitle%2Cupdated%2Curl%2Cverb)%2CnextPageToken%2CselfLink%2Cupdated&maxResults=4";if(typeof h!="undefined"){g+="&pageToken="+h}var j=googlePlusApiCall(k,g);var l=j.error;if(typeof l!="undefined"){if(l.code==401&&l.message=="Invalid Credentials"){refreshAccessToken()}else{displayError(WIDGET_NAME,l.message);return}}else{return j}return googlePlusApiCall(k,g)}function getMatchingPeople(f){var i="https://www.googleapis.com/plus/v1/people";var g="query="+f+"&maxResults=20";var h=googlePlusApiCall(i,g);var j=h.error;if(typeof j!="undefined"){if(j.code==401&&j.message=="Invalid Credentials"){refreshAccessToken()}else{displayError(WIDGET_NAME,j.message);return}}else{return h}return googlePlusApiCall(i,g)}function refreshAccessToken(){var b="reqType=googleplusrefresh&widgetId="+pluginId+"&refreshToken="+widgetPref.refresh_token+"&code_token="+widgetPref.code_token;$.ajax({type:"POST",url:"/scribe",async:false,data:b,success:function(f,e,a){widgetDetails=getWidgetDetails();widgetPref=JSON.parse(widgetDetails.prefs)},error:function(a,e,f){}})}function getWidgetDetails(){return $.parseJSON($.ajax({url:"core/api/widgets/GooglePlus",async:false,dataType:"json"}).responseText)}function googlePlusApiCall(f,d){var e=$.ajax({type:"GET",url:f,async:false,data:d+"&access_token="+widgetPref.access_token,dataType:"json"});return $.parseJSON(e.responseText)}function displayError(g,h,e){var f={};f.message=h;f.disable_check=e;$("#"+g).html(getTemplate("googleplus-error-panel",f))}$(function(){WIDGET_NAME="GooglePlus";LODING_IMAGE='<div id="tweet_load"><center><img  src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center></div>';PROFILE_DATA={};widgetDetails=agile_crm_get_widget(WIDGET_NAME);pluginId=widgetDetails.id;widgetPref=JSON.parse(widgetDetails.prefs);searchDetails={};var b="";if(agile_crm_get_contact_property("first_name")){b=b+agile_crm_get_contact_property("first_name")}if(agile_crm_get_contact_property("last_name")){b=b+" "+agile_crm_get_contact_property("last_name")}searchDetails.keywords=b.trim();contactGooglePlusId=agile_crm_get_contact_property_by_subtype("website","GOOGLE-PLUS");if(typeof contactGooglePlusId=="undefined"){showMatchedPeople(searchDetails.keywords)}else{showGooglePlusProfile(contactGooglePlusId)}$("#GooglePlus_plugin_delete").die().live("click",function(a){a.preventDefault();contactGooglePlusId=agile_crm_get_contact_property_by_subtype("website","GOOGLE-PLUS");agile_crm_delete_contact_property_by_subtype("website","GOOGLE-PLUS",contactGooglePlusId,function(d){showMatchedPeople(searchDetails.keywords)})});$(".peoplesearch").die().live("click",function(a){a.preventDefault();$("#"+WIDGET_NAME).html(getTemplate("googleplus-modified-search",searchDetails))});$("#gpsearchbtn").die().live("click",function(d){d.preventDefault();if(!isValidForm($("#gpsearchform"))){return}var a=$("#searchkeywords").val();$("#spinner-search").show();searchDetails.keywords=a;showMatchedPeople(searchDetails.keywords)});$("#searchkeywords").die().live("keypress",function(a){if(a.keyCode==13){a.preventDefault();$("#gpsearchbtn").trigger("click")}});$("#gpsearchclose").die().live("click",function(a){showMatchedPeople(searchDetails.keywords);a.preventDefault()});$(".GoogleplusDisplayPic").die().live("mouseover",function(a){profileID=$(this).attr("id");$(this).popover({placement:"left"});$(this).popover("show");$("#"+profileID).die().live("click",function(e){e.preventDefault();$(this).popover("hide");var g=[{name:"website",value:profileID,subtype:"GOOGLE-PLUS"}];if(!agile_crm_get_contact_property("image")){var h=$(this).attr("src");g.push({name:"image",value:h})}agile_crm_update_contact_properties(g);contactGooglePlusId=profileID;showGooglePlusProfile(profileID)})});$("#gplusstreammore").die().live("click",function(d){d.preventDefault();var a=$(this).attr("ntoken");if(a==""){$("#gplusstreammore").html("No more posts.");return}$("#spinnerspan").show();showGooglePlusPosts(contactGooglePlusId,a);$("#spinnerspan").hide()})});