function setupTwitterOAuth(){$("#Twitter",agile_crm_get_current_view()).html(TWITTER_UPDATE_LOAD_IMAGE);var a=window.location.href;var b="/scribe?service=twitter&return_url="+encodeURIComponent(a)+"&plugin_id="+encodeURIComponent(Twitter_Plugin_Id);$("#Twitter",agile_crm_get_current_view()).html("<div class='widget_content' style='border-bottom:none;line-height: 160%;' >Engage with contacts in real time based on what they tweet.<p style='margin: 10px 0px 5px 0px;'><a class='btn' href=\""+b+"\" style='text-decoration:none;'>Link Your Twitter</a></p></div>")}function showTwitterMatchingProfiles(b){var a=agile_crm_get_contact_property("image");if(search_string){Twitter_search_details.keywords=search_string}else{var c="";if(agile_crm_get_contact_property("first_name")){c=c+agile_crm_get_contact_property("first_name")}if(agile_crm_get_contact_property("last_name")){c=c+" "+agile_crm_get_contact_property("last_name")}Twitter_search_details.keywords=c.trim()}if(b.length==0){if(Twitter_search_details.keywords&&Twitter_search_details.keywords!=""){twitterMainError(TWITTER_PLUGIN_NAME,"<p class='a-dotted' style='margin-bottom:0px;font-size:13px;'>No matches found for <a href='#' class='twitter_modify_search'>"+Twitter_search_details.keywords+"</a>",true)}else{twitterMainError(TWITTER_PLUGIN_NAME,"<p class='a-dotted' style='margin-bottom:0px;font-size:13px;'>No matches found. <a href='#' class='twitter_modify_search'>Modify search</a>",true)}return}var d;if(Twitter_search_details.keywords&&Twitter_search_details.keywords!=""){d="<div style='padding:0px 0px'><p class='a-dotted' style='margin-bottom:0px 0px 6px;font-size:13px;'>Search results for <a href='#' class='twitter_modify_search'>"+Twitter_search_details.keywords+"</a></p>"}else{d="<div style='padding:0px 0px'><p class='a-dotted' style='margin-bottom:0px 0px 6px;font-size:13px;'>Search results. <a href='#' class='twitter_modify_search'>Modify search</a></p>"}d=d.concat(getTemplate("twitter-search-result",b));d=d+"</div>";$("#Twitter",agile_crm_get_current_view()).html(d);$(".twitterImage").die().live("mouseover",function(){Twitter_id=$(this).attr("id");$(this).popover({placement:"left"});$(this).popover("show");$("#"+Twitter_id).die().live("click",function(i){i.preventDefault();$(this).popover("hide");console.log("on click in search");var f="@"+$(this).attr("screen_name");web_url=f;console.log(f);var h=[{name:"website",value:f,subtype:"TWITTER"}];if(!a){var g=$(this).attr("src");h.push({name:"image",value:g})}if(!agile_crm_get_contact_property("title")){var e=$(this).attr("summary");h.push({name:"title",value:e})}console.log(h);agile_crm_update_contact_properties(h);showTwitterProfile(Twitter_id)})})}function getTwitterMatchingProfiles(){$("#Twitter",agile_crm_get_current_view()).html(TWITTER_UPDATE_LOAD_IMAGE);var a=agile_crm_get_contact()["id"];var d=localStorage.getItem("Agile_twitter_matches_"+a);if(!d){queueGetRequest("widget_queue","core/api/widgets/social/match/"+Twitter_Plugin_Id+"/"+a,"json",function b(e){localStorage.setItem("Agile_twitter_matches_"+a,JSON.stringify(e));showTwitterMatchingProfiles(e)},function c(e){$("#tweet_load").remove();twitterMainError(TWITTER_PLUGIN_NAME,e.responseText)})}else{showTwitterMatchingProfiles(JSON.parse(d))}}function getModifiedTwitterMatchingProfiles(){if(!isValidForm($("#twitter-search_form"))){return}$("#spinner-twitter-search").show();search_string=$("#twitter_keywords").val();$.get("core/api/widgets/social/modified/match/twitter/"+Twitter_Plugin_Id+"/"+search_string,function(a){$("#spinner-twitter-search").hide();search_data=a;showTwitterMatchingProfiles(a)},"json").error(function(a){$("#spinner-twitter-search").remove();twitterMainError(TWITTER_PLUGIN_NAME,a.responseText)})}function getTwitterIdByUrl(c,b){var a;console.log("Twitter given URL "+c);getProperURL(c,function(e){a=e});console.log("Twitter URL "+a);var d={};d.web_url=a;fetchTwitterIdFromUrl(d,function(e){if(!e){alert("URL provided for Twitter is not valid ");getTwitterMatchingProfiles();agile_crm_delete_contact_property_by_subtype("website","TWITTER",c);return}if(b&&typeof(b)==="function"){b(e)}},function(f){var e="Sorry, that page doesn't exist!";console.log(f.responseText.substring(0,e.length));if(f.responseText.substring(0,e.length)===e){alert(f.responseText);console.log("Twitter URL "+c);agile_crm_delete_contact_property_by_subtype("website","TWITTER",c.toString());return}twitterMainError(TWITTER_PLUGIN_NAME,f.responseText)})}function getProperURL(c,b){var a;if(c.indexOf("https://twitter.com/")==-1&&c.indexOf("http://twitter.com/")==-1){if(c.indexOf("@")==0){a="https://twitter.com/"+c.substring(1)}else{a="https://twitter.com/"+c}}else{if(c.indexOf("http://twitter.com/")!=-1){a=c.replace("http://twitter.com/","https://twitter.com/")}else{a=c}}if(b&&typeof(b)==="function"){b(a)}}function fetchTwitterIdFromUrl(b,c,a){queuePostRequest("widget_queue","/core/api/widgets/social/getidbyurl/"+Twitter_Plugin_Id,b,function(d){if(c&&typeof(c)==="function"){c(d)}},function(d){if(a&&typeof(a)==="function"){a(d)}})}function showTwitterProfile(c){$("#Twitter",agile_crm_get_current_view()).html(TWITTER_UPDATE_LOAD_IMAGE);var a;var b;$.get("/core/api/widgets/social/profile/"+Twitter_Plugin_Id+"/"+c,function(e){if(!e){return}$("#Twitter_plugin_delete").show();Twitter_current_profile_user_name=e.name;Twitter_current_profile_screen_name=e.screen_name;a=e.is_connected;Twitter_current_update_id=e.current_update_id;$("#Twitter",agile_crm_get_current_view()).html(getTemplate("twitter-profile",e));if(e.is_connected){$("#twitter_unfollow").show()}else{if(!e.is_follow_request_sent){$("#twitter_follow").show()}else{$("#twitter_follow").text("Follow Request Sent").attr("disabled","disabled").show()}}if(e.updateStream&&e.updateStream.length!=0){$("#twitter_refresh_stream").show();b=e.updateStream;var d=$(getTemplate("twitter-update-stream",e.updateStream));head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",d).timeago()});$("#twitter_social_stream").append(d);return}$("#twitter_current_activity").show()},"json").error(function(d){$("#tweet_load").remove();twitterMainError(TWITTER_PLUGIN_NAME,d.responseText)});registerClickEventsInTwitter(c,a,b)}function registerClickEventsInTwitter(c,a,b){$(".twitter_stream").die().live("click",function(d){d.preventDefault();var e=$("ul#twitter_social_stream").find("li#twitter_status:last").attr("status_id");console.log(e);if(!Twitter_current_update_id){return}if(!e){if(a){tweetError("tweet-error-panel","This member doesn't share his/her tweets");return}tweetError("tweet-error-panel","Member does not share his/her tweets. Follow him/her and try");return}$("#spinner-tweets").show();var f=this;$(this).removeClass("twitter_stream");anyFiveNetworkUpdates(c,e,b,f)});$("#twitter_less").die().live("click",function(d){d.preventDefault();if($(this).attr("less")=="true"){$(this).attr("less","false");if($("ul#twitter_social_stream").find("div#twitter_update").length!=0){$("#twitter_current_activity").hide()}$(this).text("Show Less..");$("#twitter_refresh_stream").show()}else{$(this).attr("less","true");$(this).text("Show More..");$("#twitter_current_activity").show();$("#twitter_refresh_stream").hide()}});$("#twitter_refresh_stream").die().live("click",function(d){d.preventDefault();$("#twitter_social_stream",agile_crm_get_current_view()).html(TWITTER_UPDATE_LOAD_IMAGE);allNetworkUpdates(c,b)})}function anyFiveNetworkUpdates(c,a,b,d){$.getJSON("/core/api/widgets/social/updates/more/"+Twitter_Plugin_Id+"/"+c+"/"+a+"/5",function(e){$("#spinner-tweets").hide();$(d).addClass("twitter_stream");$("#twitter_refresh_stream").show();if(e.length==0){tweetError("tweet-error-panel","No more updates available");if(b.length>3){$("#twitter_stream").hide();$("#twitter_less").show()}return}$("#twitter_social_stream").append(getTemplate("twitter-update-stream",e));$(".time-ago",$("#twitter_social_stream")).timeago();$("#twitter_current_activity").hide()}).error(function(e){$("#spinner-tweets").hide();$(d).addClass("twitter_stream");tweetError("tweet-error-panel",e.responseText)})}function getFirstFiveNetworkUpdates(a){$.getJSON("/core/api/widgets/social/updates/more/"+Twitter_Plugin_Id+"/"+a+"/"+Twitter_current_update_id+"/5",function(b){$("#twitter_social_stream",agile_crm_get_current_view()).html(getTemplate("twitter-update-stream",b));$("#twitter_current_activity").hide();$("#twitter_refresh_stream").show();$(".time-ago",$("#twitter_social_stream")).timeago();if(b.length==0){$("#twitter_stream").hide();$("#twitter_current_activity").show();$("#twitter_less").show();return}}).error(function(b){$("#twitter_refresh_stream").show();tweetError("twitter-error-panel",b.responseText)})}function allNetworkUpdates(a,b){$.getJSON("/core/api/widgets/social/updates/"+Twitter_Plugin_Id+"/"+a,function(c){$("#tweet_load").remove();$("#twitter_social_stream",agile_crm_get_current_view()).html(getTemplate("twitter-update-stream",c));$(".time-ago",$("#twitter_social_stream")).timeago();if(c.length==0){$("#twitter_stream").hide();$("#twitter_less").show();return}$("#twitter_stream").show();$("#twitter_less").hide();$("#twitter_current_activity").hide()}).error(function(c){$("#tweet_load").remove();$("#twitter_stream").show();$("#twitter_less").hide();if(b&&b.length!=0){$("#twitter_social_stream",agile_crm_get_current_view()).html(getTemplate("twitter-update-stream",b))}$(".time-ago",$("#twitter_social_stream")).timeago();tweetError("tweet-error-panel",c.responseText)})}function sendFollowRequest(a){$.post("/core/api/widgets/social/connect/"+Twitter_Plugin_Id+"/"+a,function(b){if(b=="true"){$("#twitter_follow").hide();$("#twitter_unfollow").show()}else{$("#twitter_follow").text("Follow Request Sent").attr("disabled","disabled").show();return}if(!Twitter_current_update_id){return}getFirstFiveNetworkUpdates(a)}).error(function(b){if(b.responseText.indexOf("401:Authentication credentials")!=0){b.responseText="Only confirmed followers have access to "+Twitter_current_profile_user_name+' Tweets and complete profile. Click the "Follow" button to send a follow request.'}tweetError("twitter-error-panel",b.responseText)})}function sendUnfollowRequest(a){$.get("/core/api/widgets/social/disconnect/"+Twitter_Plugin_Id+"/"+a,function(b){$("#twitter_follow").show();$("#twitter_unfollow").hide()}).error(function(b){tweetError("twitter-error-panel",b.responseText)})}function sendTwitterMessage(c,a){var d={};d.headline="Direct Message";d.info="Send message to "+Twitter_current_profile_user_name.toUpperCase()+" on Twitter";$("#twitter_messageModal").remove();var b=getTemplate("twitter-message",d);$("#content").append(b);$("#twitter_messageModal").on("shown",function(){head.js(LIB_PATH+"lib/bootstrap-limit.js",function(){$(".twit-message-limit").limit({maxChars:125,counter:"#twitter-counter"});$("#twitter_messageModal").find("#twit-message").focus()})});$("#twitter_messageModal").modal("show");$("#send_request").click(function(e){e.preventDefault();if(!isValidForm($("#twitter_messageForm"))){return}$(this).text("Saving..");sendRequest("/core/api/widgets/social/message/"+Twitter_Plugin_Id+"/"+c,"twitter_messageForm","twitter_messageModal")})}function tweetInTwitter(c){var a={};a.headline="Tweet";a.info="Tweet to "+Twitter_current_profile_user_name.toUpperCase()+" on Twitter";a.description="@"+Twitter_current_profile_screen_name;$("#twitter_messageModal").remove();var b=getTemplate("twitter-message",a);$("#content").append(b);$("#twitter_messageModal").on("shown",function(){head.js(LIB_PATH+"lib/bootstrap-limit.js",function(){$(".twit-tweet-limit").limit({maxChars:125,counter:"#twitter-counter"});$("#twitter_messageModal").find("#twit-tweet").focus()})});$("#twitter_messageModal").modal("show");$("#send_request").click(function(d){d.preventDefault();if(!isValidForm($("#twitter_messageForm"))){return}$(this).text("Saving..");sendRequest("/core/api/widgets/social/tweet/"+Twitter_Plugin_Id,"twitter_messageForm","twitter_messageModal")})}function sendRequest(a,b,c){$.post(a,$("#"+b).serialize(),function(d){setTimeout(function(){$("#"+c).modal("hide")},2000)}).error(function(d){$("#"+c).remove();tweetError("twitter-error-panel",d.responseText)})}function retweetTheTweet(c,b,a){$.get("/core/api/widgets/social/reshare/"+Twitter_Plugin_Id+"/"+c+"/"+b,function(d){$(a).css("color","green")}).error(function(d){tweetError("tweet-error-panel",d.responseText)})}function getFollowerIdsInTwitter(a,b){$.getJSON("/core/api/widgets/social/followers/"+Twitter_Plugin_Id+"/"+a,function(c){if(!c){return}if(b&&typeof(b)==="function"){b(c)}}).error(function(d){$("#tweet_load").remove();if(d.responseText.indexOf("401:Authentication credentials")!=-1){var c="Only confirmed followers have access to "+Twitter_current_profile_user_name+' Tweets, Followers, Following and complete profile. Click the "Follow" button to send a follow request.';twitterMainError("twitter_follower_panel",c,true);$("#twitter_follower_panel").css("padding","0px");return}tweetError("follower-error-panel",d.responseText)})}function getFollowingIdsInTwitter(a,b){$.getJSON("/core/api/widgets/social/following/"+Twitter_Plugin_Id+"/"+a,function(c){if(!c){return}if(b&&typeof(b)==="function"){b(c)}}).error(function(d){$("#tweet_load").remove();if(d.responseText.indexOf("401:Authentication credentials")!=-1){var c="Only confirmed followers have access to "+Twitter_current_profile_user_name+' Tweets, Followers, Following and complete profile. Click the "Follow" button to send a follow request.';twitterMainError("twitter_following_panel",c,true);$("#twitter_following_panel").css("padding","0px");return}tweetError("following-error-panel",d.responseText)})}function getListOfProfilesByIDsinTwitter(c,b,d){var a={};a.twitter_ids=JSON.stringify(c);$.post("/core/api/widgets/social/profile/list/"+Twitter_Plugin_Id,a,function(e){if(!e){$("#tweet_load").remove();return}if(b&&typeof(b)==="function"){b(e)}},"json").error(function(e){if(d&&typeof(d)==="function"){d(e)}})}function tweetError(b,a,c){twitterMainError(b,a,c);$("#"+b).show();$("#"+b).fadeOut(10000)}function twitterMainError(b,a,d){var c={};c.message=a;c.disable_check=d;$("#"+b,agile_crm_get_current_view()).html(getTemplate("twitter-error-panel",c))}$(function(){TWITTER_PLUGIN_NAME="Twitter";TWITTER_UPDATE_LOAD_IMAGE='<div id="tweet_load"><center><img  src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center></div>';Twitter_current_profile_user_name="";Twitter_current_update_id="";Twitter_current_profile_screen_name="";console.log(c);console.log(a);var c=undefined;var a=undefined;search_string=undefined;search_data=undefined;Twitter_search_details={};web_url="";Twitter_id="";var b=agile_crm_get_widget(TWITTER_PLUGIN_NAME);console.log("In Twitter");console.log(c);console.log(a);console.log(b);Twitter_Plugin_Id=b.id;if(b.prefs==undefined){setupTwitterOAuth();return}web_url=agile_crm_get_contact_property_by_subtype("website","TWITTER");console.log(web_url);if(web_url){getTwitterIdByUrl(web_url,function(d){Twitter_id=d;showTwitterProfile(Twitter_id)})}else{getTwitterMatchingProfiles()}$("#Twitter_plugin_delete").die().live("click",function(d){d.preventDefault();agile_crm_delete_contact_property_by_subtype("website","TWITTER",web_url,function(e){console.log("In twitter delete callback");getTwitterMatchingProfiles()})});$("#twitter_message").die().live("click",function(d){d.preventDefault();sendTwitterMessage(Twitter_id)});$("#twitter_follow").die().live("click",function(d){d.preventDefault();if($(this).attr("disabled")){return}sendFollowRequest(Twitter_id)});$("#twitter_unfollow").die().live("click",function(d){d.preventDefault();sendUnfollowRequest(Twitter_id)});$("#twitter_unfollow").live("mouseenter",function(){$("#twitter_unfollow").text("Unfollow");$("#twitter_unfollow").addClass("btn-danger");$("#twitter_unfollow").removeClass("btn-primary")});$("#twitter_unfollow").live("mouseleave",function(){$("#twitter_unfollow").text("Following");$("#twitter_unfollow").addClass("btn-primary");$("#twitter_unfollow").removeClass("btn-danger")});$(".twitter_retweet").die().live("click",function(e){e.preventDefault();var d=$(this).attr("id");console.log(d);retweetTheTweet(d,"optional",this)});$("#twitter_tweet").die().live("click",function(d){d.preventDefault();tweetInTwitter(Twitter_id)});$(".twitter_modify_search").die().live("click",function(d){d.preventDefault();Twitter_search_details.plugin_id=Twitter_Plugin_Id;$("#Twitter",agile_crm_get_current_view()).html(getTemplate("twitter-modified-search",Twitter_search_details))});$("#twitter_search_btn").die().live("click",function(d){d.preventDefault();getModifiedTwitterMatchingProfiles()});$("#twitter_search_close").die().live("click",function(d){d.preventDefault();if(search_data){showTwitterMatchingProfiles(search_data)}else{getTwitterMatchingProfiles()}});$("#twitter_followers").die().live("click",function(d){d.preventDefault();if(c&&c.length!=0){return}console.log("In twit folowers");console.log(c);c=[];$("#twitter_follower_panel",agile_crm_get_current_view()).html(TWITTER_UPDATE_LOAD_IMAGE);getFollowerIdsInTwitter(Twitter_id,function(e){c=e;console.log(e);if(e.length==0){$("#twitter_follower_panel",agile_crm_get_current_view()).html(Twitter_current_profile_user_name+" doesn't have any followers yet");return}var f=c.splice(0,20);console.log(f);getListOfProfilesByIDsinTwitter(f,function(g){$("#twitter_follower_panel",agile_crm_get_current_view()).html(getTemplate("twitter-follower-following",g));$(".twitterImage").die().live("mouseover",function(){var h=$(this).attr("id");$("#"+h).popover({placement:"left"});$("#"+h).popover("show")})},function(g){c=undefined;$("#tweet_load").remove();tweetError("follower-error-panel",g.responseText)})})});$("#more_followers").die().live("click",function(e){e.preventDefault();if(!c){return}$("#spinner-followers").show();console.log(c);var d=c.splice(0,20);console.log(d);getListOfProfilesByIDsinTwitter(d,function(f){$("#spinner-followers").hide();$("#twitter_follower_panel").append(getTemplate("twitter-follower-following",f))},function(f){$("#spinner-followers").hide();tweetError("follower-error-panel",f.responseText)})});$("#twitter_following").die().live("click",function(d){d.preventDefault();if(a&&a.length!=0){return}a=[];$("#twitter_following_panel",agile_crm_get_current_view()).html(TWITTER_UPDATE_LOAD_IMAGE);getFollowingIdsInTwitter(Twitter_id,function(e){a=e;console.log(e.length);if(e.length==0){$("#twitter_following_panel",agile_crm_get_current_view()).html(Twitter_current_profile_user_name+" isn't following anyone yet");return}var f=a.splice(0,20);console.log(f);getListOfProfilesByIDsinTwitter(f,function(g){$("#twitter_following_panel",agile_crm_get_current_view()).html(getTemplate("twitter-follower-following",g));$(".twitterImage").die().live("mouseover",function(){var h=$(this).attr("id");$("#"+h).popover({placement:"left"});$("#"+h).popover("show")})},function(g){a=undefined;$("#tweet_load").remove();tweetError("following-error-panel",g.responseText)})})});$("#more_following").die().live("click",function(e){e.preventDefault();if(!a){return}$("#spinner-following").show();var d=a.splice(0,20);console.log(d);getListOfProfilesByIDsinTwitter(d,function(f){$("#spinner-following").hide();$("#twitter_following_panel").append(getTemplate("twitter-follower-following",f))},function(f){$("#spinner-following").hide();tweetError("following-error-panel",f.responseText)})})});