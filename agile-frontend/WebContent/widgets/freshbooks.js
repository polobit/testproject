function setUpFreshbooksAuth(){$("#FreshBooks").html(FRESHBOOKS_LOGS_LOAD_IMAGE);$("#FreshBooks").html(getTemplate("freshbooks-login",{}));$("#freshbooks_save_token").die().live("click",function(a){a.preventDefault();if(!isValidForm($("#freshbooks_login_form"))){return}savefreshBooksPrefs()})}function savefreshBooksPrefs(){var a={};a.freshbooks_apiKey=$("#freshbooks_apiKey").val();a.freshbooks_url=$("#freshbooks_url").val();agile_crm_save_widget_prefs(FRESHBOOKS_PLUGIN_NAME,JSON.stringify(a),function(b){showFreshBooksClient()})}function showFreshBooksClient(){$("#FreshBooks").html(FRESHBOOKS_LOGS_LOAD_IMAGE);if(!Email){freshBooksError(FRESHBOOKS_PLUGIN_NAME,"Please provide email for this contact");return}queueGetRequest("widget_queue","/core/api/widgets/freshbooks/clients/"+FreshBooks_Plugin_id+"/"+Email,"json",function b(c){console.log("In FreshBooks clients");console.log(c);if(!c){return}$("#FreshBooks").html(getTemplate("freshbooks-profile",c));if(!c.client){return}if(isArray(c.client)){getInvoicesOfClient(c.client[0].client_id)}else{getInvoicesOfClient(c.client.client_id)}},function a(c){console.log("In FreshBooks clients error ");console.log(c);$("#freshbooks_invoice_load").remove();freshBooksError("FreshBooks",c.responseText)})}function getInvoicesOfClient(a){$.get("/core/api/widgets/freshbooks/invoices/"+FreshBooks_Plugin_id+"/"+a,function(c){var b=$(getTemplate("freshbooks-invoice",c));head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",b).timeago()});$("#freshbooks_invoice_panel").html(b)},"json").error(function(b){freshBooksError("freshbooks_invoice_panel",b.responseText)})}function addClientToFreshBooks(c,b){var a=agile_crm_get_contact_property("company");var d="/core/api/widgets/freshbooks/add/client/"+FreshBooks_Plugin_id+"/"+c+"/"+b+"/"+Email;d+="/"+a;$.get(d,function(e){console.log("In FreshBooks add client ");console.log(e);if(e.status=="ok"){showFreshBooksClient()}},"json").error(function(e){freshBooksError("FreshBooks",e.responseText)})}function freshBooksError(c,b){var a={};a.message=b;$("#"+c).html(getTemplate("freshbooks-error",a))}$(function(){FRESHBOOKS_PLUGIN_NAME="FreshBooks";FRESHBOOKS_LOGS_LOAD_IMAGE='<center><img id="freshbooks_invoice_load" src="img/ajax-loader-cursor.gif" style="margin-top: 14px;margin-bottom: 10px;"></img></center>';var b=agile_crm_get_widget(FRESHBOOKS_PLUGIN_NAME);console.log("In FreshBooks");console.log(b);FreshBooks_Plugin_id=b.id;Email=agile_crm_get_contact_property("email");console.log("Email: "+Email);if(b.prefs==undefined){setUpFreshbooksAuth();return}showFreshBooksClient();var c=agile_crm_get_contact_property("first_name");var a=agile_crm_get_contact_property("last_name");$("#freshbooks_add_client").die().live("click",function(d){d.preventDefault();addClientToFreshBooks(c,a,Email)})});