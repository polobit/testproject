function setupStripeOAuth(){$("#Stripe").html(STRIPE_PROFILE_LOAD_IMAGE);var d=window.location.href;console.log("In Stripe OAuth");var c="/scribe?service=stripe&return_url="+encodeURIComponent(d)+"&plugin_id="+encodeURIComponent(Stripe_Plugin_Id);$("#Stripe").html('<div class="widget_content" style="border-bottom:none;line-height: 160%;">See the contact\'s subscriptions history and payments from your Stripe account.<p style="margin: 10px 0px 5px 0px;"></p><a class="btn" href='+c+">Link Your Stripe</a></div>")}function setUpStripeCustomField(b){$.get("/core/api/custom-fields/type/scope?scope=CONTACT&type=TEXT",function(a){b.custom_fields=a;$("#Stripe").html(getTemplate("stripe-custom-field",b))},"json").error(function(a){stripeError(Stripe_PLUGIN_NAME,a.responseText)});$("#save_stripe_name").die().live("click",function(a){a.preventDefault();var d=$("#stripe_custom_field_name").val();if(!d){return}b.stripe_field_name=d;agile_crm_save_widget_prefs(Stripe_PLUGIN_NAME,JSON.stringify(b),function(c){showStripeProfile(d)})})}function showStripeProfile(c){$("#Stripe").html(STRIPE_PROFILE_LOAD_IMAGE);var d=agile_crm_get_contact_property(c);console.log("Stripe customer id "+d);if(!d){$("#stripe_contact_id_save").die().live("click",function(a){a.preventDefault();if(!isValidForm($("#stripe_contact_id_form"))){return}d=$("#stripe_contact_id").val();agile_crm_save_contact_property(c,"",d,"CUSTOM");showStripeProfile(c);return});$("#Stripe").html("<div><form class='widget_content' style='border-bottom:none;margin-bottom:5px;' id='stripe_contact_id_form' name='stripe_contact_id_form' method='post'><fieldset><p>Please provide the Stripe customer id for this contact</p><div class='control-group' style='margin-bottom:0px'><div class='controls'><input type='text' class='required' name='stripe_contact_id' style='width:90%' id='stripe_contact_id' placeholder='Stripe customer id' onkeydown='if (event.keyCode == 13) { event.preventDefault(); }'></input></div></div><a href='#' class='btn' id='stripe_contact_id_save'>Save</a></fieldset></form></div>");return}getStripeProfile(d,function(a){var b=$(getTemplate("stripe-profile",a));head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",b).timeago()});$("#Stripe").html(b)})}function getStripeProfile(e,g){queueGetRequest("widget_queue","/core/api/widgets/stripe/"+Stripe_Plugin_Id+"/"+e,"json",function h(a){console.log("In Stripe profile");console.log(a);if(g&&typeof(g)==="function"){g(a)}},function f(a){stripeError(Stripe_PLUGIN_NAME,a.responseText)})}function stripeError(e,f){var d={};d.message=f;$("#"+e).html(getTemplate("stripe-error",d))}$(function(){Stripe_PLUGIN_NAME="Stripe";STRIPE_PROFILE_LOAD_IMAGE='<center><img id="stripe_profile_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';var f=agile_crm_get_widget(Stripe_PLUGIN_NAME);console.log("In Stripe");console.log(f);Stripe_Plugin_Id=f.id;if(f.prefs==undefined){setupStripeOAuth();return}var d=JSON.parse(f.prefs);console.log(d);var e=d.stripe_field_name;if(!e){setUpStripeCustomField(d);return}showStripeProfile(e)});