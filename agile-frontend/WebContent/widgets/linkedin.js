$(function(){LINKEDIN_PLUGIN_NAME="Linkedin";LINKEDIN_UPDATE_LOAD_IMAGE='<div id="status_load"><center><img  src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center></div>';Linkedin_current_profile_user_name="";Stream_Data=[];Experience_data="";Shared_Connections=[];past_search_input=undefined;past_search_data=undefined;Search_details={};linkedin_web_url="";var a=agile_crm_get_widget(LINKEDIN_PLUGIN_NAME);console.log("In LinkedIn");console.log(a);LinkedIn_Plugin_Id=a.id;if(a.prefs==undefined){setupLinkedinOAuth();return}Linkedin_id="";linkedin_web_url=agile_crm_get_contact_property_by_subtype("website","LINKEDIN");console.log(linkedin_web_url);if(linkedin_web_url){getLinkedinIdByUrl(linkedin_web_url,function(b){Linkedin_id=b;showLinkedinProfile(Linkedin_id)})}else{getLinkedinMatchingProfiles()}$("#Linkedin_plugin_delete").die().live("click",function(b){b.preventDefault();agile_crm_delete_contact_property_by_subtype("website","LINKEDIN",linkedin_web_url,function(c){console.log("In linkedin delete callback");getLinkedinMatchingProfiles()})});$("#linkedin_message").die().live("click",function(b){b.preventDefault();sendLinkedInMessage(Linkedin_id)});$("#linkedin_connect").die().live("click",function(b){b.preventDefault();sendLinkedInAddRequest(Linkedin_id)});$(".linkedin_share").die().live("click",function(c){c.preventDefault();var b=$(this).attr("id");reSharePost(b,"optional",this)});$("#linkedin_experience").die().live("click",function(b){b.preventDefault();if(Experience_data||Experience_data!=""){return}getExperienceOfPerson(Linkedin_id)});$("#linkedin_shared_connections").die().live("click",function(b){b.preventDefault();if(Shared_Connections.length!=0){return}getLinkedInSharedConnections(Linkedin_id)});$("#linkedin_update_tab").die().live("click",function(b){b.preventDefault();if(Stream_Data.length!=0){return}getFirstFiveLinkedInNetworkUpdates(Linkedin_id)});$(".linkedin_modify_search").die().live("click",function(b){b.preventDefault();Search_details.plugin_id=LinkedIn_Plugin_Id;$("#Linkedin").html(getTemplate("linkedin-modified-search",Search_details))});$("#linkedin_search_btn").die().live("click",function(b){b.preventDefault();getModifiedLinkedinMatchingProfiles()});$("#linkedin_search_close").die().live("click",function(b){b.preventDefault();if(past_search_data){showLinkedinMatchingProfiles(past_search_data)}else{getLinkedinMatchingProfiles()}});$(".experience_li").live("mouseenter",function(b){$(this).find(".show-summary").show()});$(".experience_li").live("mouseleave",function(b){$(this).find(".show-summary").hide()});$(".show-summary").die().live("click",function(c){c.preventDefault();var b=$(this).attr("href");var d=$(this).attr("id");$("#"+d).text("Less");$(".summary-expand-"+d).hide();$(b).collapse("toggle");$(b).on("hidden",function(){$(".summary-expand-"+d).show();$("#"+d).text("More")})})});function setupLinkedinOAuth(){$("#Linkedin").html(LINKEDIN_UPDATE_LOAD_IMAGE);var a=window.location.href;var b="/scribe?service=linkedin&return_url="+encodeURIComponent(a)+"&plugin_id="+encodeURIComponent(LinkedIn_Plugin_Id);$("#Linkedin").html("<div class='widget_content' style='border-bottom:none;line-height: 160%;' >Build professional relationships with contacts and keep a tab on their business interests.<p style='margin: 10px 0px 5px 0px;' ><a class='btn' href=\""+b+"\" style='text-decoration: none;'>Link Your LinkedIn</a></p></div>")}function showLinkedinMatchingProfiles(b){var a=agile_crm_get_contact_property("image");if(past_search_input){Search_details.keywords=past_search_input}else{var c="";if(agile_crm_get_contact_property("first_name")){c=c+agile_crm_get_contact_property("first_name")}if(agile_crm_get_contact_property("last_name")){c=c+" "+agile_crm_get_contact_property("last_name")}Search_details.keywords=c.trim()}if(b.length==0){if(Search_details.keywords&&Search_details.keywords!=""){linkedinMainError(LINKEDIN_PLUGIN_NAME,"<p class='a-dotted' style='margin-bottom:0px;'>No matches found for <a href='#search' class='linkedin_modify_search'>"+Search_details.keywords+"</a></p>",true)}else{linkedinMainError(LINKEDIN_PLUGIN_NAME,"<p class='a-dotted' style='margin-bottom:0px;'>No matches found. <a href='#search' class='linkedin_modify_search'>Modify search</a></p>",true)}return}Search_details.search_results=b;$("#Linkedin").html(getTemplate("linkedin-search-result",Search_details));$(".linkedinImage").die().live("mouseover",function(){Linkedin_id=$(this).attr("id");$(this).popover({placement:"left"});$(this).popover("show");$("#"+Linkedin_id).die().live("click",function(h){h.preventDefault();$(this).popover("hide");console.log("on click in search");var f=$(this).attr("url");linkedin_web_url=f;console.log("LinkedIn URL: "+f);var g=[{name:"website",value:f,subtype:"LINKEDIN"}];if(!a){if($(this).attr("is_gravatar_pic")=="false"){var e=$(this).attr("src");g.push({name:"image",value:e})}}if(!agile_crm_get_contact_property("title")){var d=$(this).attr("summary");g.push({name:"title",value:d})}agile_crm_update_contact_properties(g);showLinkedinProfile(Linkedin_id)})})}function getLinkedinMatchingProfiles(){$("#Linkedin").html(LINKEDIN_UPDATE_LOAD_IMAGE);var b=agile_crm_get_contact()["id"];var a=localStorage.getItem("Agile_linkedin_matches_"+b);if(!a){queueGetRequest("widget_queue","/core/api/widgets/social/match/"+LinkedIn_Plugin_Id+"/"+b,"json",function(c){if(islocalStorageHasSpace()){localStorage.setItem("Agile_linkedin_matches_"+b,JSON.stringify(c))}showLinkedinMatchingProfiles(c)},function(c){$("#status_load").remove();linkedinMainError(LINKEDIN_PLUGIN_NAME,c.responseText)})}else{showLinkedinMatchingProfiles(JSON.parse(a))}}function getModifiedLinkedinMatchingProfiles(){if(!isValidForm($("#linkedin-search_form"))){return}$("#spinner-linked-search").show();past_search_input=$("#linkedin_keywords").val();$.post("/core/api/widgets/social/modified/match/linkedin/"+LinkedIn_Plugin_Id,$("#linkedin-search_form").serialize(),function(a){$("#spinner-linked-search").hide();past_search_data=a;showLinkedinMatchingProfiles(a)},"json").error(function(a){$("#spinner-linked-search").remove();linkedinMainError(LINKEDIN_PLUGIN_NAME,a.responseText)})}function showLinkedinProfile(a){$("#Linkedin").html(LINKEDIN_UPDATE_LOAD_IMAGE);var b;$.get("/core/api/widgets/social/profile/"+LinkedIn_Plugin_Id+"/"+a,function(c){if(!c){return}Linkedin_current_profile_user_name=c.name;b=c.is_connected;if(c.picture==null){c.picture="https://contactuswidget.appspot.com/images/pic.png"}$("#Linkedin").html(getTemplate("linkedin-profile",c));if(c.searchResult){showExperienceInLinkedIn(c.searchResult)}},"json").error(function(c){$("#status_load").remove();if(c.responseText=="Invalid member id {private}"){linkedinMainError(LINKEDIN_PLUGIN_NAME,"Member doesn't share his information for third party applications");return}linkedinMainError(LINKEDIN_PLUGIN_NAME,c.responseText)});registerEventsInLinkedIn(a,b,Stream_Data)}function showExperienceInLinkedIn(a){var b="";if((!a.three_current_positions||a.three_current_positions.length==0)&&(!a.three_past_positions||a.three_past_positions.length==0)){$("#linkedin_experience_panel").html('<div class="widget_content">Work status unavailable</div>');return}Experience_data=a;if(a.three_current_positions){b=b.concat(getTemplate("linkedin-experience",a.three_current_positions))}if(a.three_past_positions){b=b.concat(getTemplate("linkedin-experience",a.three_past_positions))}$("#linkedin_experience_panel").html(b)}function registerEventsInLinkedIn(c,a,b){$(".linkedin_stream").die().live("click",function(d){d.preventDefault();var e=$("ul#linkedin_social_stream").find("li#linkedin_status:last").attr("update_time");if(!e){if(a){linkedinError("status-error-panel","This person does not share his/her updates");return}linkedinError("status-error-panel","Member does not share his/her updates. Get connected");return}$("#spinner-status").show();var f=this;$(this).removeClass("twitter_stream");getAnyFiveNetworkUpdatesInLinkedIn(c,e,b,f)});$("#linkedin_less").die().live("click",function(d){d.preventDefault();if($(this).attr("less")=="true"){$(this).attr("less","false");$(this).text("See Less..");$("#linkedin_current_activity").hide();$("#linkedin_refresh_stream").show();return}$(this).attr("less","true");$(this).text("See More..");$("#linkedin_current_activity").show();$("#linkedin_refresh_stream").hide()});$("#linkedin_refresh_stream").die().live("click",function(d){d.preventDefault();$("#linkedin_social_stream").html(LINKEDIN_UPDATE_LOAD_IMAGE);getAllRecentNetworkUpdatesInLinkedIn(c,b)})}function getFirstFiveLinkedInNetworkUpdates(a){$(".linkedin_current_activity",$("#Linkedin")).hide();$("#linkedin_social_stream").html(LINKEDIN_UPDATE_LOAD_IMAGE);$.getJSON("/core/api/widgets/social/updates/index/"+LinkedIn_Plugin_Id+"/"+a+"/0/5",function(b){$("#status_load").remove();if(b&&b.length!=0){$("#linkedin_social_stream").html(getTemplate("linkedin-update-stream",b));$("#linkedin_refresh_stream").show();Stream_Data=b;head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",$("#linkedin_social_stream")).timeago()});return}$(".linkedin_current_activity",$("#Linkedin")).show()}).error(function(b){$("#status_load").remove();linkedinMainError("linkedin_social_stream",b.responseText)})}function getAllRecentNetworkUpdatesInLinkedIn(a,b){$.getJSON("/core/api/widgets/social/updates/"+LinkedIn_Plugin_Id+"/"+a,function(c){$("#status_load").remove();$("#linkedin_social_stream").html(getTemplate("linkedin-update-stream",c));head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",$("#linkedin_social_stream")).timeago()});if(c.length==0){$("#linkedin_stream").hide();$("#linkedin_less").show();return}$("#linkedin_stream").show();$("#linkedin_less").hide()}).error(function(c){$("#status_load").remove();if(b){$("#linkedin_social_stream").html(getTemplate("linkedin-update-stream",b))}linkedinError("status-error-panel",c.responseText)})}function getAnyFiveNetworkUpdatesInLinkedIn(c,a,b,d){$.getJSON("/core/api/widgets/social/updates/more/"+LinkedIn_Plugin_Id+"/"+c+"/0/5/1262304000/"+a,function(e){$("#spinner-status").hide();$(d).addClass("linkedin_stream");if(e.length==0){linkedinError("status-error-panel","No more updates available");$("#linkedin_refresh_stream").show();if(b.length>3){$("#linkedin_stream").hide();$("#linkedin_less").show()}return}$("#linkedin_social_stream").append(getTemplate("linkedin-update-stream",e));$(".time-ago",$("#linkedin_social_stream")).timeago();$("#linkedin_current_activity").hide();$("#linkedin_refresh_stream").show()}).error(function(e){$("#spinner-status").hide();$(d).addClass("linkedin_stream");linkedinError("status-error-panel",e.responseText)})}function sendLinkedInAddRequest(c){var a={};a.headline="Connect";a.info="Connect to "+Linkedin_current_profile_user_name+" on Linkedin";a.description="I'd like to add you to my professional network on LinkedIn.";$("#linkedin_messageModal").remove();var b=getTemplate("linkedin-message",a);$("#content").append(b);$("#linkedin_messageModal").on("shown",function(){head.js(LIB_PATH+"lib/bootstrap-limit.js",function(){$(".linkedin_connect_limit").limit({maxChars:275,counter:"#linkedin_counter"});$("#linkedin_messageModal").find("#link-connect").focus()})});$("#linkedin_messageModal").modal("show");$("#send_linked_request").click(function(d){d.preventDefault();if(!isValidForm($("#linkedin_messageForm"))){return}$(this).text("Saving..");sendRequestToLinkedIn("/core/api/widgets/social/connect/"+LinkedIn_Plugin_Id+"/"+c,"linkedin_messageForm","linkedin_messageModal")})}function sendLinkedInMessage(c){var a={};a.headline="Send Message";a.info="Send message to "+Linkedin_current_profile_user_name+" on LinkedIn";$("#linkedin_messageModal").remove();var b=getTemplate("linkedin-message",a);$("#content").append(b);$("#linkedin_messageModal").modal("show");$("#send_linked_request").click(function(d){d.preventDefault();if(!isValidForm($("#linkedin_messageForm"))){return}$(this).text("Saving..");sendRequestToLinkedIn("/core/api/widgets/social/message/"+LinkedIn_Plugin_Id+"/"+c,"linkedin_messageForm","linkedin_messageModal")})}function sendRequestToLinkedIn(a,b,c){$.post(a,$("#"+b).serialize(),function(d){setTimeout(function(){$("#"+c).modal("hide")},2000)}).error(function(d){$("#"+c).remove();linkedinError("linkedin-error-panel",d.responseText)})}function reSharePost(c,b,a){$.get("/core/api/widgets/social/reshare/"+LinkedIn_Plugin_Id+"/"+c+"/"+b,function(d){$(a).css("color","green");$(a).text("Shared")}).error(function(d){linkedinError("linkedin-error-panel",d.responseText)})}function getLinkedinIdByUrl(c,b){var a={};a.web_url=c;queuePostRequest("widget_queue","/core/api/widgets/social/getidbyurl/"+LinkedIn_Plugin_Id,a,function(d){if(!d){alert("URL provided for linkedin is not valid ");getLinkedinMatchingProfiles();agile_crm_delete_contact_property_by_subtype("website","LINKEDIN",c);return}if(b&&typeof(b)==="function"){b(d)}},function(d){if(d.responseText.indexOf("Public profile URL is not correct")!=-1){alert("URL provided for linkedin is not valid "+d.responseText);agile_crm_delete_contact_property_by_subtype("website","LINKEDIN",c);return}linkedinMainError(LINKEDIN_PLUGIN_NAME,d.responseText)})}function getExperienceOfPerson(a){$("#linkedin_experience_panel").html(LINKEDIN_UPDATE_LOAD_IMAGE);$.get("/core/api/widgets/social/experience/"+LinkedIn_Plugin_Id+"/"+a,function(b){showExperienceInLinkedIn(b)}).error(function(b){$("#status_load").remove();Experience_data=undefined;linkedinMainError("linkedin_experience_panel",b.responseText)})}function getLinkedInSharedConnections(a){$("#linkedin_shared_panel").html(LINKEDIN_UPDATE_LOAD_IMAGE);$.get("/core/api/widgets/social/shared/connections/"+LinkedIn_Plugin_Id+"/"+a,function(c){var b="<div style='padding:10px'>";if(c.length==0){$("#linkedin_shared_panel").html("<div style='padding: 10px;line-height:160%;'>No shared connections</div>");return}Shared_Connections=c;$.each(c,function(d,e){if(e.picture==null){e.picture="https://contactuswidget.appspot.com/images/pic.png"}b=b.concat(getTemplate("linkedin-shared",e))});b=b+"</div>";$("#linkedin_shared_panel").html(b);$(".linkedinSharedImage").die().live("mouseover",function(){$(this).popover({placement:"left"});$(this).popover("show")})}).error(function(b){$("#status_load").remove();linkedinMainError("linkedin_shared_panel",b.responseText)})}function grantAccessToLinkedIn(b){$("#Linkedin").html(LINKEDIN_UPDATE_LOAD_IMAGE);var c=window.location.href;var a="/scribe?service=linkedin&return_url="+encodeURIComponent(c)+"&plugin_id="+encodeURIComponent(LinkedIn_Plugin_Id);$("#Linkedin").html("<div class='widget_content' style='border-bottom:none;line-height: 160%;' >"+b+"<p style='margin: 10px 0px 5px 0px;' ><a class='btn' href=\""+a+"\" style='text-decoration: none;'>Regrant Access</a></p></div>")}function linkedinError(b,a,c){linkedinMainError(b,a,enable_check);$("#"+b).show();$("#"+b).fadeOut(10000)}function linkedinMainError(b,a,d){if(a=="Access granted to your linkedin account has expired."){grantAccessToLinkedIn(a);return}var c={};c.message=a;c.disable_check=d;$("#"+b).html(getTemplate("linkedin-error-panel",c))};