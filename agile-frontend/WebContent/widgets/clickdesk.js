function setupClickDeskAuth(){$("#ClickDesk").html(CLICKDESK_UPDATE_LOAD_IMAGE);console.log("In ClickDesk Auth");$("#ClickDesk").html(getTemplate("clickdesk-login",{}));$("#save_clickdesk_prefs").die().live("click",function(b){b.preventDefault();if(!isValidForm($("#clickdesk_login_form"))){return}saveClickDeskPrefs()})}function saveClickDeskPrefs(){var b={};b.clickdesk_username=$("#clickdesk_username").val();b.clickdesk_api_key=$("#clickdesk_api_key").val();agile_crm_save_widget_prefs(CLICKDESK_PLUGIN_NAME,JSON.stringify(b),function(a){showClickDeskProfile()})}function showClickDeskProfile(){$("#ClickDesk").html(CLICKDESK_UPDATE_LOAD_IMAGE);if(!Email){clickDeskError(CLICKDESK_PLUGIN_NAME,"Please provide email for this contact");return}getChats(function(b){showChats(b)});Tickets_clicked=false;$("#clickdesk_tickets").die().live("click",function(b){b.preventDefault();if(Tickets_clicked){return}getClickDeskTickets(0,function(a){showClickDeskTickets(a)});Tickets_clicked=true})}function getChats(d){queueGetRequest("widget_queue","/core/api/widgets/clickdesk/chats/"+ClickDesk_Plugin_Id+"/"+Email+"/0","json",function e(a){if(!a){return}if(d&&typeof(d)==="function"){d(a)}registerClickEventsInChat(a)},function f(a){$("#chats_load").remove();clickDeskError("ClickDesk",a.responseText)})}function showChats(b){$("#ClickDesk").html(getTemplate("clickdesk-profile",b));if(b.length==0){$("#clickdesk_chats_panel").html('<li class="sub_header_li">No chats</li>');return}$("#clickdesk_chats_panel").html(getTemplate("clickdesk-chat-stream",b));head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",$("#clickdesk_chats_panel")).timeago()})}function registerClickEventsInChat(b){$("#clickdesk_chat_show").die().live("click",function(d){d.preventDefault();var a=JSON.parse($(this).attr("data-attr"));showChatModal(a)});$("#more_chats_link").die().live("click",function(a){a.preventDefault();if(!b.length>=5){clickDeskStreamError("clickdesk-chats-error-panel","No more chats");return}var d=$("#chats ul li").length;console.log("offset in more chats: "+d);getMoreChats(d,function(c){showMoreChats(c)})})}function showChatModal(b){$("#clickdesk_chat_showModal").remove();$("#content").append(getTemplate("clickdesk-show-chat",b));$(".time-ago",$("#clickdesk_chat_showModal")).timeago();$("#clickdesk_chat_showModal").modal("show")}function getMoreChats(d,c){$("#spinner-clickdesk-chats").show();$.get("/core/api/widgets/clickdesk/chats/"+ClickDesk_Plugin_Id+"/"+Email+"/"+d,function(a){if(c&&typeof(c)==="function"){c(a)}},"json").error(function(a){$("#spinner-clickdesk-chats").hide();clickDeskStreamError("clickdesk-chats-error-panel",a.responseText)})}function showMoreChats(b){$("#spinner-clickdesk-chats").hide();if(b.length==0){clickDeskStreamError("clickdesk-chats-error-panel","No more chats");return}$("#clickdesk_chats_panel").append(getTemplate("clickdesk-chat-stream",b));$(".time-ago",$("#clickdesk_chats_panel")).timeago()}function getClickDeskTickets(d,c){$("#clickdesk_tickets_panel").html(CLICKDESK_UPDATE_LOAD_IMAGE);$.get("/core/api/widgets/clickdesk/tickets/"+ClickDesk_Plugin_Id+"/"+Email+"/"+d,function(a){if(!a){return}if(c&&typeof(c)==="function"){c(a)}registerEventsInTickets(a)},"json").error(function(a){$("#chats_load").remove();if(d==0){Tickets_clicked=false}clickDeskError("clickdesk_tickets_panel",a.responseText)})}function showClickDeskTickets(b){if(b.length==0){$("#clickdesk_tickets_panel").html('<li class="sub_header_li">No tickets</li>');return}$("#clickdesk_tickets_panel").html(getTemplate("clickdesk-ticket-stream",b));head.js(LIB_PATH+"lib/jquery.timeago.js",function(){$(".time-ago",$("#clickdesk_tickets_panel")).timeago()})}function registerEventsInTickets(b){$("#clickdesk_ticket_show").die().live("click",function(a){a.preventDefault();var d=JSON.parse($(this).attr("data-attr"));showTicketModal(d)});$("#more_tickets_link").die().live("click",function(a){a.preventDefault();if(!b.length>=5){clickDeskStreamError("clickdesk-tickets-error-panel","No more tickets");return}var d=$("#c_tickets ul li").length;console.log("offset "+d);getMoreTickets(d,function(c){showMoreTickets(c)})})}function showTicketModal(b){$("#clickdesk_ticket_showModal").remove();$("#content").append(getTemplate("clickdesk-show-ticket",b));$(".time-ago",$("#clickdesk_ticket_showModal")).timeago();$("#clickdesk_ticket_showModal").modal("show")}function getMoreTickets(d,c){$("#spinner-clickdesk-tickets").show();$.get("/core/api/widgets/clickdesk/tickets/"+ClickDesk_Plugin_Id+"/"+Email+"/"+d,function(a){if(c&&typeof(c)==="function"){c(a)}},"json").error(function(a){$("#spinner-clickdesk-tickets").hide();clickDeskStreamError("clickdesk-tickets-error-panel",a.responseText)})}function showMoreTickets(b){$("#spinner-clickdesk-tickets").hide();if(b.length==0){clickDeskStreamError("clickdesk-tickets-error-panel","No more tickets");return}$("#clickdesk_tickets_panel").append(getTemplate("clickdesk-ticket-stream",b));$(".time-ago",$("#clickdesk_tickets_panel")).timeago()}function clickDeskError(d,e){var f={};f.message=e;$("#"+d).html(getTemplate("clickdesk-error",f))}function clickDeskStreamError(c,d){clickDeskError(c,d);$("#"+c).show();$("#"+c).fadeOut(10000)}$(function(){CLICKDESK_PLUGIN_NAME="ClickDesk";CLICKDESK_UPDATE_LOAD_IMAGE='<center><img id="chats_load" src="img/ajax-loader-cursor.gif" style="margin-top: 10px;margin-bottom: 14px;"></img></center>';var b=agile_crm_get_widget(CLICKDESK_PLUGIN_NAME);console.log("In ClickDesk");console.log(b);ClickDesk_Plugin_Id=b.id;Email=agile_crm_get_contact_property("email");console.log("Email: "+Email);if(b.prefs==undefined){setupClickDeskAuth();return}showClickDeskProfile();$(".clickdesk_ticket_hover").live("mouseenter",function(a){$(this).find(".clickdesk_ticket_tab_link").show()});$(".clickdesk_ticket_hover").live("mouseleave",function(a){$(".clickdesk_ticket_tab_link").hide()});$(".clickdesk_chat_hover").live("mouseenter",function(a){$(this).find(".clickdesk_chat_tab_link").show()});$(".clickdesk_chat_hover").live("mouseleave",function(a){$(".clickdesk_chat_tab_link").hide()})});